define("DS/DMUPlayMarkup/DMUMarkupImport",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.importData=function(t,r){t&&r&&e&&(e.isImporting(!0),r.fillObjectAttributes(e,t,e),r.registerForPostImport(e))},this.afterImport=function(){e&&(e.fireEvent("onDMUObjectInitialized",{dmuObject:e}),setTimeout(function(){e.isImporting(!1),e.fireEvent("onDMUMarkupLoaded",{dmuObject:e})},10))}}})}),define("DS/DMUPlayMarkup/DMUMarkup",["require","exports","DS/DMUPlayMarkup/DMUMarkupImport","DS/DMUBaseExperience/DMUOccurrenceOverloader","DS/Visualization/Node3D","UWA/Utils","DS/DMUBaseExperience/DMUObject","DS/DMUBaseExperience/DMUContextManager"],function(e,t,r,i,n,l,a,s){"use strict";let o=[{name:"sID",type:"string",JSONname:"id"},{name:"sType",type:"string",JSONname:"type",defaultValue:"Markup"},{name:"sName",type:"string",JSONname:"Name",defaultValue:"Markup"},{name:"sDescription",type:"string",JSONname:"Description",defaultValue:""},{name:"sCurrentSlideId",type:"string",JSONname:"CurrentSlideId"},{name:"sPreviewElementUuid",type:"string",JSONname:"PreviewElementUuid"},{name:"lSlides",type:"listObjects",JSONname:"Slides",defaultValue:[]},{name:"lComments",type:"listObjects",JSONname:"Comments",defaultValue:[]},{name:"lFormats",type:"listObjects",JSONname:"Formats",defaultValue:[]},{name:"lOccOverloaders",type:"listObjects",JSONname:"OccurenceOverloaders",defaultValue:[]},{name:"oLinksManager",type:"object",JSONname:"LinksManager",defaultValue:null}];return class extends a{constructor(e,t){super(e,t),this.addParameters(o);let a,u,c,g,d=this,m=null,f=null,p=!1,h=!1,O=new n;function D(e,t,r,i){e.getType()===t&&(d.set({attribute:r,value:e,mode:"addValue",index:i}),e.getNode()&&d.getNode().addChild(e.getNode()))}function M(e,t,r){if(e.getType()===t){let t=d.getAttribute(r);if(t){for(let r=0;r<t.length;r++)if(t[r]===e){t[r].getNode()&&d.getNode().removeChild(t[r].getNode()),t.splice(r,1);break}d.setAttribute(r,t),e.remove()}}}function b(e){let t=[],r=d.getAttribute(e);if(r)for(let e=0;e<r.length;e++)t.push(r[e]);return t}O.getDMUType=function(){return"DMUMarkup"},this.setNode(O);let v=this.setAttribute;this.setAttribute=function(e,t){let r=t;if(p)if(("lSlides"===e||"lFormats"===e)&&r&&Array.isArray(r))for(let e=r.length-1;e>=0;e--)r[e]&&r[e].getNode?r[e].getNode()&&d.getNode().addChild(r[e].getNode()):r.splice(e,1);else"oLinksManager"===e&&(a&&a.remove(),a=r);v(e,r)},this.addSlide=function(e,t){D(e,"DMUSlide","lSlides",t)},this.addFormat=function(e,t){D(e,"DMUFormat","lFormats",t)},this.addComment=function(e,t){D(e,"DMUComment","lComments",t)},this.addOccurrenceOverloader=function(e){D(e,"DMUOccurrenceOverloader","lOccOverloaders")},this.getSlides=function(){return b("lSlides")},this.getFormats=function(){return b("lFormats")},this.getComments=function(){return b("lComments")},this.getOccurrenceOverloaders=function(){return b("lOccOverloaders")},this.setMaturityState=(e=>{g=e}),this.getMaturityState=(()=>g),this.removeSlide=function(e){e===m&&(m=null),M(e,"DMUSlide","lSlides")},this.deleteSlide=function(e){d.fireEvent("onDMUSlideDelete",{dmuObject:e.object}),d.removeSlide(e.object)},this.removeFormat=function(e){e===f&&(f=null);let t,r=e.getAttribute("sID")||"",i=d.getSlides();for(let e=0;e<i.length;e++)(t=i[e].getAttribute("sPointedFormats"))&&-1!==t.indexOf(r)&&i[e].setAttribute("sPointedFormats",[]);M(e,"DMUFormat","lFormats")},this.removeComment=function(e){M(e,"DMUComment","lComments")},this.removeOccurrenceOverloader=function(e){M(e,"DMUOccurrenceOverloader","lOccOverloaders")},this.setDirtyFlag=function(e){let t=!1;d.getParent()&&u&&(t=!d.getParent().getRestrictions(u.getParent())["Reply"===u.getParent().getType()?"reply":"markup"].canEdit),d.isImporting()||t||(h=e)},this.isDirty=function(){return h};let S=this.setVisibleFlag;this.setVisibleFlag=function(e,t){if(e!==d.isVisible()||t){let r=d.getCurrentSlide();r&&r.setVisibleFlag(e);let i=d.getOccurrenceOverloaders();for(let t=0;t<i.length;t++)i[t].setVisibleFlag(e);S(e,t)}};let y=this.setActiveFlag;this.setActiveFlag=function(e){if(e!==d.getActiveFlag()){let t,r=d.getOccurrenceOverloaders();for(t=0;t<r.length;t++)r[t].setActiveFlag(e);for(r=d.getSlides(),t=0;t<r.length;t++)r[t].setActiveFlag(e);for(r=d.getFormats(),t=0;t<r.length;t++)r[t].setActiveFlag(e);y(e)}};let U,A=0;this.computeNewID=function(){let e,t,r=[d],i=d.getSlides();for(r=r.concat(i),e=0;e<i.length;e++)r=(r=r.concat(i[e].getDMUObjects())).concat(i[e].getDMUObjects("DMUComment"));for(i=d.getFormats(),r=r.concat(i),e=0;e<i.length;e++)r=r.concat(i[e].getDMUObjects());for(r=r.concat(d.getOccurrenceOverloaders()),e=0;e<r.length;e++)if(r[e]){let i=r[e].getAttribute("sID");(t=parseFloat("string"==typeof i?i:""))>A&&(A=t)}if(a)for(;a.getChildWithID(A.toString());)A++;return(++A).toString()},this.isImporting=function(e){return"boolean"==typeof e&&p!==e&&((p=e)||d.refreshNode(),d.fireEvent(p?"onDMUMarkupImportStarts":"onDMUMarkupImportEnds",{dmuObject:d})),p},this.initAuthoringData=function(){if(-1!==s.getAuthoringFeatureTypes().indexOf("Markup")){let e="DS/DMUPersistence/DMUMarkupContextualBar";window.require([e],function(e){U=new e,d.getContextualMenuCommandList=U.getContextualMenuCommandList,d.getSharedContextualMenuCommandList=U.getSharedContextualMenuCommandList,U.register({frmWindow:d.getFrameWindow(),type:d.getType()})})}},this.removeAuthoringData=function(){d.getSharedContextualMenuCommandList=null,d.getContextualMenuCommandList=null,U&&U.unregister({frmWindow:d.getFrameWindow(),type:d.getType()})};let C=new r(d);this.importData=C.importData,this.afterImport=C.afterImport,this.initAuthoringData();let F=this.refreshNode;this.refreshNode=function(){if(d.getNode()&&!d.isImporting()){d.getNode().setName(d.getAttribute("sName"));let e,t=d.getSlides();for(e=0;e<t.length;e++)t[e].refreshNode();for(t=d.getFormats(),e=0;e<t.length;e++)t[e].refreshNode();for(t=d.getOccurrenceOverloaders(),e=0;e<t.length;e++)t[e].refreshNode();F()}},this.computeNewName=function(e){if(!e||!e.object)return"";let t=e.object.getAttribute("sParentSlideID"),r="parenthesis"===e.separator?"(":".",i="parenthesis"===e.separator?")":"",n=t&&"DMUSlide"===e.object.getType()?0:1,l=e.prefix+(e.noSuffixIfPossible?"":r+n+i),a=Boolean(!t),s=function(t){var s;let o=(null===(s=d.getAttribute(t))||void 0===s?void 0:s.slice())||[];if(a&&"lSlides"===t){let t=d.getParent().getValidation()?d.getParent().getValidation().getMarkups():[];t.length&&t.forEach(t=>{let r=t.getReplies();r.length&&r.forEach(t=>{(t.getRepRef().getMarkupContent()?t.getRepRef().getMarkupContent().getSlides():[]).forEach(t=>{t.getAttribute("sParentSlideID")===e.object.getAttribute("sUuid")&&o.push(t)})})})}let u,c,g=[e.object.getAttribute("sName")];for(u=0;u<o.length;u++)if(e.object.getType()===o[u].getType())g.push(o[u].getAttribute("sName"));else if(o[u].getDMUObjects){let t=o[u].getDMUObjects(e.object.getType());for(c=0;c<t.length;c++)g.push(t[c].getAttribute("sName"))}for(a&&"lSlides"===t&&(n-=1);-1!==g.indexOf(l);)n++,l=e.prefix+r+n+i};return s("lSlides"),s("lFormats"),s("lOccOverloaders"),l},this.getDMUObjectFromPathElement=function(e){if(!e)return;let t,r=e.getLastElement(!0);if(d.getNode()===r)return d;let i=function(t){let i,n=d.getAttribute(t)||[];for(let t=0;t<n.length;t++){if(n[t].getNode&&n[t].getNode()===r)return n[t];if(n[t].getDMUObjectFromPathElement&&(i=n[t].getDMUObjectFromPathElement(e)))return i}};return(t=i("lSlides"))?t:(t=i("lFormats"))?t:(t=i("lComments"))?t:t=i("lOccOverloaders")};let N=this.setReadOnly;this.setReadOnly=function(e){let t=e||Boolean(u&&!u.isWebMarkup()),r=d.getAttribute("lSlides")||[];r=(r=(r=r.concat(d.getAttribute("lFormats")||[])).concat(d.getAttribute("lComments")||[])).concat(d.getAttribute("lOccOverloaders")||[]);for(let e=0;e<r.length;e++)r[e].setReadOnly(t);a&&a.setReadOnly(t),N(t)},this.getOccurence=function(e,t){let r=d.getAttribute("oLinksManager");if(r)return r.getOccurrence(e,t)},this.getOrCreateOccurrenceOverloader=function(t,r){let n,a=d.getOccurence(t,r);if(a){let s=d.getAttribute("lOccOverloaders")||[];for(let e=0;!n&&e<s.length;e++)if(s[e].isOverloading(t)){n=s[e];break}!n&&r&&((n=new i(e,d)).setAttributes([{name:"sName",value:d.computeNewName({object:n,prefix:"DMUOccurrenceOverloader"})},{name:"sID",value:d.computeNewID()},{name:"sUuid",value:l.getUUID()}]),n.setOccurrence(a),d.addOccurrenceOverloader(n))}return n},this.removeOccurrenceOverloaderIfNeeded=function(e){if(e){let t=!0,r=d.getAttribute("lSlides")||[];r=r.concat(d.getAttribute("lFormats")||[]);for(let i=0;i<r.length;i++)if(r[i].getOverloadForTarget(e)){t=!1;break}t&&d.removeOccurrenceOverloader(e)}};let I=this.remove;this.remove=function(){d.setActiveFlag(!1),a=m=u=null,I(),d.getApplicativeContext()&&d.getApplicativeContext().PIM&&d.fireEvent("onDMUApplicativeContextClean",{applicativeContext:d.getApplicativeContext().PIM}),c=null},this.setCurrentSlide=function(e){if(e){let t=m,r=f;t&&t.isDisplayed()&&t.setDisplayedFlag(!1),r&&r.isDisplayed()&&r.setDisplayedFlag(!1),"DMUSlide"===e.getType()?((m=e)&&m.setDisplayedFlag(!0),d.setAttribute("sCurrentSlideId",e.getAttribute("sID"))):(f=e)&&f.setDisplayedFlag(!0)}else m&&(m.setDisplayedFlag(!1),m=null,d.setAttribute("sCurrentSlideId","")),f&&(f.setDisplayedFlag(!1),f=null);d.fireEvent("onDMUCurrentSlideChanged",{dmuObject:d})},this.getCurrentSlide=function(){let e=d.getParent().getUIManager(),t=!!e&&e.getFormatEditionModeFlag();return!t&&m&&m.isDisplayed()?m:t&&f&&f.isDisplayed()?f:null},this.setMarkupOwner=function(e){u=e},this.getMarkupOwner=function(){return u},this.setApplicativeContext=(e=>{c=e}),this.getApplicativeContext=(()=>c);let j=this.makeDirty.bind(this);this.makeDirty=(()=>{let e=!1;d.getParent()&&u&&(e=!d.getParent().getRestrictions(u.getParent())["Reply"===u.getParent().getType()?"reply":"markup"].canEdit),d.isReadOnly()||e||(j(),d.setDirtyFlag(!0))})}}});