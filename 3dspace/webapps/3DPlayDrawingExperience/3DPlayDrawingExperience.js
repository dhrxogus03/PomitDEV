define("DS/3DPlayDrawingExperience/DrawingAnnotationManager",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/3DPlayAnnotationUtils/AnnotationAbbreviations","DS/3DPlayAnnotation3D/AnnotationShapes","DS/3DPlayAnnotation3D/AnnotationUtils","DS/Visualization/PathElement"],function(e,t,n,i,o,r,a,s,h){"use strict";var l=null,c=null,d=null,p=function(e,t){var n=e;t&&(n.duration=t),n.distanceToTarget=n.targetDistance,l.getViewpoint().moveTo(n),c.render()},u=function(){var e=l.getViewpoint();if(e)return{eyePosition:e.getEyePosition(),targetDistance:e.getTargetDistance()}},g=function(e,t){var n=e||Date.now(),o=t||u();return{id:n,eyePosition:o.eyePosition instanceof i.Vector3?o.eyePosition:new i.Vector3(o.eyePosition.x,o.eyePosition.y,o.eyePosition.z),targetDistance:o.targetDistance,annotList:o.annotList||[]}};return e.extend({init:function(e){this._parent(e),this._annotCount=0,l=e.frameWindow,c=l.getViewer(),d=l.experience,this.frameWindow=e.frameWindow,this.exp=this.frameWindow.experience,this._rootNode=this.exp.getRootBag(),this._annotGroupNode=new n("annotGroupNode"),this._rootNode.add(this._annotGroupNode),this.AnnotationAbbreviations=new r,this.sheetList=[]},getVisibleAndOnModelAnnotationGroups:function(){return this.exp.getCurrentSheet().annotVpList},getAnnotationBag:function(){return this._annotGroupNode},getModel:function(){var e=this.exp.getCurrentSheet();if(e)return e.node},deleteAllAnnotations:function(){for(var e=0;e<this.sheetList.length;e++){for(var t=this.sheetList[e].annotVpList,n=0;n<t.length;n++){var i=t[n].annotList;for(let e=0;e<i.length;e++)this._annotGroupNode.remove(i[e].repBag),i[e].dispose();t[n]=[]}this.sheetList[e].annotVpList=[]}this.sheetList=[],this.frameWindow.getViewer().render(),this.exp&&this.exp.publish("3DPLAY/ANNONATION/NOTINSESSION",{})},dispose:function(){this.deleteAllAnnotations(),this._rootNode.remove(this._annotGroupNode),this._annotGroupNode=void 0,this._model=void 0,this._rootNode=void 0,this.exp=void 0,this.frameWindow=void 0},addAnnotViewpointToList:function(e){return this.exp.getCurrentSheet().index},setSheetViewpointFromInfo:function(e,t,n){if(t)this.exp.setCurrentSheet(e,function(){p(t,400)}.bind(this),t.viewerBackgroundEnvInfo);else{this.exp.setCurrentSheet(e);let t=this.createAnnotPathElementArrayForViewpoint(n);this.exp.frmWindow._viewpoint.reframeOn(void 0,t)}},createAnnotPathElementArrayForViewpoint:function(e){let t=e.annotList,n=[];for(let e=0;e<t.length;e++){let i=[],o=t[e].repBag;for(i.unshift(o);0!=o.parents.length&&(o=o.parents[0],i.unshift(o),"RootBag"!=o.name););let r=new h(i);n.push(r)}return n},hideAnnotationsOfCurrentSheet:function(){for(var e=this.exp.getCurrentSheet().annotVpList,t=0;t<e.length;t++){let n=e[t].annotList;for(let e=0;e<n.length;e++)n[e].repBag.setVisibility(!1)}},showAnnotationsOfCurrentSheet:function(){for(var e=this.exp.getCurrentSheet().annotVpList,t=0;t<e.length;t++){let n=e[t].annotList;for(let e=0;e<n.length;e++)n[e].repBag.setVisibility(!0)}},deleteAnnotationWithID:function(e){for(var t=this.sheetList,n=!1,i=0;i<t.length;i++){for(var o=t[i],r=o.annotVpList,a=0;a<r.length;a++){let t=r[a].annotList;for(let i=0;i<t.length;i++)if(t[i].id===e){this._annotGroupNode.remove(t[i].repBag),t[i].dispose(),t.splice(i,1),n=!0,this._annotCount-=1;break}if(0==t.length){r.splice(a,1);break}}if(0==o.annotVpList.length&&this.sheetList.splice(i,1),0===this._annotCount&&this.exp&&this.exp.publish("3DPLAY/ANNONATION/NOTINSESSION",{}),n)return}},getAnnotationWithID:function(e){let t=this.sheetList;for(let n=0;n<t.length;n++){let i=t[n].annotVpList;for(let t=0;t<i.length;t++){let n=i[t].annotList;for(let t=0;t<n.length;t++)if(n[t].id===e)return n[t]}}},getAnnotationTypeWithID:function(e){var t="";let n=this.getAnnotationWithID(e);return n&&(t=n.type),t},changeAnnotPropertyWithID:function(e,t){let n=this.getAnnotationWithID(e);n&&t.color&&(n.graphicalProp.color=t.color)},getAnnotColorWithID:function(e){let t=this.getAnnotationWithID(e);if(t)return t.graphicalProp.color},setLowlightAnnotationID:function(e){let t=this.getAnnotationWithID(e);t&&("text"===t.type?t.repBag.children[0].mesh3js.material.setValues({color:"#A9A9A9"}):t.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new i.Color("#A9A9A9")))},addToAnnotGroupNode:function(e,t,n){var i=t||this.exp.getCurrentSheet(),o=!1;let r=!1;for(var a=0;a<this.sheetList.length;a++)if(i.index===this.sheetList[a].index){o=!0;break}o||this.sheetList.push(i);let s=n;s||(s=this.getCurrentAnnotViewpoint());for(let e=0;e<i.annotVpList.length;e++)if(i.annotVpList[e].id==s.id){r=!0;break}r||i.annotVpList.push(s),s.annotList.push(e),this._annotGroupNode.addChild(e.repBag),this.exp.getCurrentSheet().index!==i.index&&e.repBag.setVisibility(!1),this.frameWindow.getViewer().render(),this._annotCount+=1,this._annotCount>=1&&this.exp.sheets.length>1&&this.exp&&this.exp.publish("3DPLAY/ANNONATION/INSESSION",{})},getCurrentAnnotViewpoint:function(){var e=u(),t=null;let n=this.exp.getCurrentSheet().index;for(var i=0;i<this.sheetList.length;i++)if(n==this.sheetList[i].index){let n=this.sheetList[i].annotVpList;for(var o=0;o<n.length;o++)if(s._areAlmostSameBasicViewpoints(n[o],e)){t=n[o];break}}return t||(t=g()),t},saveAnnotationsToJSON:function(e,t){var n={ver:"1.0",sheets:[]};t&&(n.options=t);for(var i=0;i<this.sheetList.length;i++){var o=this.sheetList[i].annotVpList;let t=[];for(var r=0;r<o.length;r++){let n=[];o[r].annotList.forEach(function(t){e&&e!==t.id||n.push(t.getJSON())}),n.length>0&&t.push({annotList:n,id:o[r].id,eyePosition:o[r].eyePosition.clone(),targetDistance:o[r].targetDistance})}t.length>0&&n.sheets.push({id:this.sheetList[i].id,annotVpList:t,index:this.sheetList[i].index})}var a=this.AnnotationAbbreviations.processJSON(n,"minify");return a=JSON.stringify(a)},compareAnnotViewpointWithCurrent:function(e){var t,n=!1,i=u(),o=this.sheetList;for(let n=0;n<o.length;n++){let i=o[n].annotVpList;for(let n=0;n<i.length;n++){let o=i[n].annotList;for(let r=0;r<o.length;r++)if(o[r].id===e){t=i[n];break}if(t)break}if(t)break}return t&&s._areAlmostSameBasicViewpoints(t,i)&&(n=!0),n},updateViewPointOfInputAnnotation:function(e,t=200){var n;let i=this.sheetList;for(let t=0;t<i.length;t++){let o=i[t].annotVpList;for(let t=0;t<o.length;t++){let i=o[t].annotList;for(let r=0;r<i.length;r++)if(i[r].id===e){n=o[t];break}if(n)break}if(n)break}n&&p(n,t)},repaintAnnotation:function(e,t){let n=this.getAnnotationWithID(e);var o;if(n)return o=1==t?"#00BFFF":n.graphicalProp.color,"text"===n.type?n.repBag.children[0].mesh3js.material.setValues({color:new i.Color(o)}):n.repBag.children[0].mesh3js.material.updatePDSFXUniform("Color",new i.Color(o)),void d.publish("3DPLAY/ANNONATION/UPDATE",{})},drawAnnotationsFromJSON:function(e,t){t&&this.deleteAllAnnotations();var n=JSON.parse(e);if(n.ver){for(var i=this.AnnotationAbbreviations.processJSON(n,"expand"),o=i.sheets,r=0;r<o.length;r++){for(var s=this.exp.getSheet(o[r].index),h=!1,l=0;l<this.sheetList.length;l++)if(s.index===this.sheetList[l].index){h=!0;break}h||this.sheetList.push(s);for(let e=0;e<o[r].annotVpList.length;e++){let t=o[r].annotVpList[e],n=t.id,i=t.annotList,h={eyePosition:t.eyePosition,targetDistance:t.targetDistance},l=g(n,h);s.annotVpList.push(l);let d={frameWindow:this.frameWindow,annotationManager:this},p=null;for(var c=0;c<i.length;c++){switch(i[c].type){case"circle":p=new a.circle(d);break;case"ellipse":p=new a.ellipse(d);break;case"line":p=new a.line(d);break;case"rectangle":case"square":p=new a.rectangle(d);break;case"triangle":p=new a.triangle(d);break;case"unknownOpen":p=new a.unknownOpen(d);break;case"text":p=new a.text(d);break;case"arrow":p=new a.arrow(d);break;case"curvedArrow":p=new a.curvedArrow(d);break;case"doubleHeadedArrow":p=new a.doubleHeadedArrow(d);break;case"curvedDoubleHeadedArrow":p=new a.curvedDoubleHeadedArrow(d);break;default:p=new a.unknownOpen(d)}p.createFromJSON(i[c]),p.draw(),this.addToAnnotGroupNode(p,s,l)}}}i.options&&this.setSheetViewpointFromInfo(i.options.sheetIndex,i.options)}else console.log("3DPlay: Invalid annotation JSON!")}})}),define("DS/3DPlayDrawingExperience/CmdScrollSheet",["DS/ApplicationFrame/Command"],function(e){"use strict";return e.extend({init:function(e){for(var t in this._parent(e,{isAsynchronous:!1}),e.arguments)"ScrollSheet"==e.arguments[t].ID&&(this.scrollDir=e.arguments[t].Value);var n=this;this._exp=this.getFrameWindow().experience,this.loadingCompletedToken=this._exp.subscribe("ASSET/LOADINGFINISHED/",function(){n._exp&&n._exp.sheets&&n._exp.sheets.length>1?n.enable():n.disable()})},execute:function(){"Previous"===this.scrollDir?this._exp.scrollToPreviousSheet():"Next"===this.scrollDir&&this._exp.scrollToNextSheet()},_destroy:function(){this._exp&&(this._exp.unsubscribe(this.loadingCompletedToken),this.loadingCompletedToken=void 0,this._exp=void 0,this._parent())}})}),define("DS/3DPlayDrawingExperience/CmdScale",["UWA/Core","DS/ApplicationFrame/Command"],function(e,t){"use strict";var n=[25,50,75,100,125,150,200,300,400,500];return t.extend({init:function(e){for(var t in this._parent(e,{isAsynchronous:!1}),e.arguments)"Scale"==e.arguments[t].ID&&(this.scaleMode=e.arguments[t].Value)},execute:function(){var e=this.getFrameWindow();if(e&&e.experience){var t=e.experience.getZoomScale(),n=this.getScale(t);e.experience.setZoomScale(n)}},getScale:function(e){var t;if(t=e>500?500:e<25?25:e,"+"==this.scaleMode)for(var i=0;i<n.length-1;++i){if(e<n[i]){t=n[i];break}if(e===n[i]){t=n[++i];break}}else for(var o=n.length-1;o>=1;--o){if(e>n[o]){t=n[o];break}if(e===n[o]){t=n[--o];break}}return t}})});var t=["DS/PADUtils/PADUtilsServices"];define("DS/3DPlayDrawingExperience/3DPlayDrawingExperience",["DS/3DPlayExperienceModule/PlayExperience3D","DS/SVGLoader/SVGNode","DS/WebSystem/Settings","DS/3DPlay/3DPlay","DS/WebSystem/Nls","DS/CoreEvents/Events","DS/3DPlayDrawingExperience/DrawingAnnotationManager","DS/WebUtils/ContextedSingleton","DS/WebUtils/ProbesManager","i18n!DS/3DPlay/assets/nls/3DPlay"].concat(t),function(e,t,n,i,o,r,a,s,h,l,c){"use strict";var d;return e.extend({init:function(e){this._parent(e),e.workbenchs=[],e.workbenchs.unshift({name:"3DPlayDocumentViewerPrint",module:"3DPlay2DExperience"}),e.workbenchs.unshift({name:"3DPlayDrawingExperience",module:"3DPlayDrawingExperience"}),d=this,this.loadingCompletedToken=this.subscribe("ASSET/LOADINGFINISHED",function(){d.sheetCameraDistance=d.frmWindow.getViewpoint().getTargetDistance(),d.zoomScale=100,d.annotationManager=new a({frameWindow:d.frmWindow,context:d.ctx}),s.add(d.ctx,"ANNOTATION_MANAGER",d.annotationManager)}),this.viewpointChangedToken=r.subscribe({event:"/VISU/"},function(e){if(d.sheetCameraDistance&&d.zoomScale&&("@onViewpointEndMove"===e.eventType||"@onViewpointChange"===e.eventType)){var t=d.frmWindow.getViewpoint().getTargetDistance();d.zoomScale=Math.floor(d.sheetCameraDistance/t*100)}})},getSheet:function(e){return this.sheets.length>0&&e<this.sheets.length?this.sheets[e]:void console.log("Invalid sheet index!!!")},onPreCreate:function(){this._parent(),this.mabModel={speeddial:[{id:"AnnotationCommands",rsc:"3DPlay/3DPlayExperience3D"},{id:"Reframe",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"}],sections:[{id:"ScaleP",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"ScaleM",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Previous",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Next",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience",nls:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"AnnotationTour",rsc:"3DPlay/3DPlayExperience3D",nls:"3DPlay/3DPlayExperience3D"},{id:"Print2DRealSize",rsc:"3DPlay2DExperience/3DPlay2DExperience",nls:"3DPlay2DExperience/3DPlay2DExperience"}]},this._hasLightbox||(this.mabModel.speeddial.push({id:"Share",icon:"3DPlay/assets/icons/32/I_3DSHAREShare.png",flyout:[]}),this._iOS,this.mabModel.speeddial[2].flyout=[{id:"ShareTo3DSwYm",rsc:"3DPlay/3DPlay"},{id:"ShareDownload",rsc:"3DPlay/3DPlay"},{id:"SharePrint",rsc:"3DPlay/3DPlay"}])},dispose:function(){this.viewpointChangedToken&&(r.unsubscribe(this.viewpointChangedToken),this.viewpointChangedToken=void 0),this.loadingCompletedToken&&(this.unsubscribe(this.loadingCompletedToken),this.loadingCompletedToken=void 0),this.annotationManager&&(this.annotationManager=void 0),d=void 0,this._parent()},loadModel:function(e){"V6Drawing"===e.asset.type&&e.asset.backup_type&&(e.asset.type=e.asset.backup_type,e.asset.backup_type=void 0),"V6Drawing"===e.asset.dtype&&e.asset.backup_dtype&&(e.asset.dtype=e.asset.backup_dtype,e.asset.backup_dtype=void 0);var t=e.asset.physicalid;e&&(this.onModelLoadingStarted(),c.updatePlatformId(e.asset.tenant),this.loadingAsset.Load_Infra=h.createProbe("Load_Infra").begin(),this.pad3DViewer.getController().getAttributes({ids:[t],attributes:["svg"],callbacks:{onComplete:function(e){if(e[t]&&e[t].svg&&""!==e[t].svg){d.loadingAsset.Load_Infra.end();var n=new XMLHttpRequest;n.onprogress=function(e){d.loadingAsset.size=0!==e.total?e.total:e.loaded},n.onload=h.createFunctionProbe("Download",d._loadSvg),n.open("GET",e[t].svg,!0),n.send(null)}else i.displayNotification({ctx:d.ctx,msg:l.LoadingError_NO_2D_GEOMETRY})},onFailure:function(){i.displayNotification({ctx:d.ctx,msg:l.LoadingError_NO_2D_GEOMETRY})}}}))},_loadSvg:function(e){d.loadingAsset.Load_Session=h.createProbe("Load_Session").begin();var i=d.frmWindow.experience.getRootBag(),o=new DOMParser;d.rawSVG=e.currentTarget.responseText;var r=o.parseFromString(e.currentTarget.responseText,"image/svg+xml"),a=r.children?r.children[0]:r.childNodes[1],s=!1,l=0;d.sheets=[],d.currentSheetIndex=0;for(var c=function(e,t){var n=this;this.id=e,this.index=e,this.node=t,this.annotVpList=[],this.onClickCB=function(){d.setCurrentSheet(n.index)}},p=a.children?a.children:a.childNodes,u=0;u<p.length;u++)if("svg"===p[u].nodeName){s=!0;var g=new t(p[u],p[u].id);i.addChild(g),d.sheets.push(new c(l,g)),l++}if(!s){g=new t(a,0);i.addChild(g),d.sheets.push(new c(u,g))}n.get("3DPlay.ShowLeftPanelForDrawings")&&require(["DS/3DPlayUtils/LeftPanel"],function(e){d.listOfSheets=new e({items:d.sheets,container:d.frmWindow.getUIFrame()})}),d.updateView(),d.modelLoader.onLoadedCB()},getSource:function(){return this.rawSVG},getCurrentSheetIndex:function(){return this.currentSheetIndex},getNumberOfSheets:function(){return this.sheets.length},scrollToNextSheet:function(){this.currentSheetIndex<this.sheets.length-1&&(this.annotationManager.hideAnnotationsOfCurrentSheet(),this.currentSheetIndex=this.currentSheetIndex+1,this.annotationManager.showAnnotationsOfCurrentSheet(),this.updateView())},scrollToPreviousSheet:function(){this.currentSheetIndex>0&&(this.annotationManager.hideAnnotationsOfCurrentSheet(),this.currentSheetIndex=this.currentSheetIndex-1,this.annotationManager.showAnnotationsOfCurrentSheet(),this.updateView())},setCurrentSheet:function(e){e>=0&&e<this.sheets.length&&(this.annotationManager.hideAnnotationsOfCurrentSheet(),this.currentSheetIndex=e,this.annotationManager.showAnnotationsOfCurrentSheet(),this.updateView())},getCurrentSheet:function(){return this.sheets[this.currentSheetIndex]},setZoomScale:function(e){this.zoomScale=e;var t=this.frmWindow.getViewpoint(),n=100*this.sheetCameraDistance/this.zoomScale;t.moveTo({distanceToTarget:n,duration:200}),this.frmWindow.getViewer().render()},getZoomScale:function(){return this.zoomScale},updateView:function(){for(var e=0;e<this.sheets.length;e++)e===this.currentSheetIndex?this.sheets[e].node.setVisibility(!0):this.sheets[e].node.setVisibility(!1);this.frmWindow.getViewer().render()},onPostCreate:function(){var e=this.frmWindow.getViewer();this.pad3DViewer.displayStatusBar(!1),e.setPicking({activated:!1,trapSelection:!1,displayHL:!1}),e.setPrePicking({activated:!1,displayHL:!1}),e.set2DMode(!0),this._parent()}})}),define("DS/3DPlayDrawingExperience/3DPlayDrawingPreview",["DS/3DPlayDrawingExperience/3DPlayDrawingExperience"],function(e){"use strict";return e.extend({init:function(e){this._parent(e),e.workbenchs=[],e.workbenchs.unshift({name:"3DPlayDrawingPreview",module:"3DPlayDrawingExperience"})},dispose:function(){this._parent()},onPreCreate:function(){this.args.visu={picking:!1},this._parent();var e=this;this.args.ui={keepActionbarClosed:!0,onActionBarReady:function(){e&&e.frmWindow&&(e.frmWindow.getActionBar().close(),e=void 0)}},this.mabModel={speeddial:[{id:"Reframe",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Previous",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"},{id:"Next",rsc:"3DPlayDrawingExperience/3DPlayDrawingExperience"}]}}})});