/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORelationsControlCenter/ENORelCCSettings",["text!DS/SNNavigationMap/assets/SNNavigationMap.settings.json","UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","DS/WAFData/WAFData","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/SNNavigationMap/utils/MapSecurityCtxConverter","DS/SNNavigationMap/utils/ProbesUtils","i18n!DS/ENORelationsControlCenter/assets/nls/ENORelCC_internal"],function(e,t,n,s,i,l,o,a,r,h,p,c){"use strict";return t.singleton(s,{name:"enorelcc_settings",options:{},_logger:null})}),define("DS/ENORelationsControlCenter/utils/PromisesManager",["UWA/Class","UWA/Promise","DS/WAFData/WAFData","i18n!DS/ENORelationsControlCenter/assets/nls/ENORelCC_internal","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen"],function(e,t,n,s,i,l){"use strict";return e.extend({init:function(e){this._debug=e.debugMode||!1,this._notifManager=i,l.setNotificationManager(this._notifManager)},createPromise:function(t){this._debug&&(t.params.debug=!0),t.params.label="RelationsControlCenter";var i=JSON.stringify(t.params),l=this;return new e.Promise(function(e,o){n.authenticatedRequest(t.url,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:i,onComplete:e,timeout:t.timeout,onFailure:function(e){console.log(e),t.noErrorMsg||l._notifManager.addNotif({level:"error",message:s.get("generic"),sticky:!0}),o(e)},onTimeout:function(e){console.log(e),l._notifManager.addNotif({level:"error",msg:Nls.get("timeout"),subtitle:Nls.get("verifyConnection"),sticky:!0}),o(e)}})})}})}),define("DS/ENORelationsControlCenter/views/RelationSetsDefView",["UWA/Core","UWA/Class","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Iconbar","DS/Controls/Expander","DS/Controls/ComboBox","DS/WUXAutoComplete/AutoComplete","DS/Controls/Button","DS/Controls/ButtonGroup","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/UIKIT/Spinner","DS/UIKIT/Mask","DS/UIKIT/SuperModal","DS/UIKIT/Form","DS/Handlebars/Handlebars4","DS/SNNavigationMap/MapSettings","text!DS/ENORelationsControlCenter/assets/templates/relSetsDef.html","text!DS/ENORelationsControlCenter/assets/templates/defRelSetByApp.html","i18n!DS/ENORelationsControlCenter/assets/nls/ENORelCC_internal"],function(e,t,n,s,i,l,o,a,r,h,p,c,d,u,_,f,m,g,R,S,C){"use strict";return n.extend({name:"relationsets-view",_touchMode:!0,className:function(){return this.getClassNames("-container")},setup:function(e){this.container.inject(e.renderTo),this._buildSkeleton(this.container),this.container.show()},render:function(e){this._model=e,this._model.relation_sets.forEach(e=>{void 0===e.nlsLabel&&(e.nlsLabel=C.get(e.name))}),this._model.relation_sets.sort((e,t)=>e.nlsLabel.localeCompare(t.nlsLabel)),this._refreshView()},_refreshView:function(){this._refreshProfileCombobox(),this._refreshRelAutoComplete(),this._refreshRolesAutoComplete(),this._refreshUsrGrpAutoComplete(),this._refreshRelByApp(),this.setRelSet(),this._refreshDefRelSetCombobox(),this.setApp(),this.disableRelSetApply(),this.disableRelDefApply(),this.disableRelSetCancel(),this.disableRelDefCancel()},_buildSkeleton:function(e){this.relSetExpander||(this.relSetExpander=new l({header:C.get("RelationsSets"),body:this._getRelSetsContent(),style:"filled-separate"}).inject(e),this.relSetExpander.expand()),this.defRelSetByAppExpander||(this.defRelSetByAppExpander=new l({header:C.get("DefaultRelSetByApp"),body:this._getDefRelSetByAppContent(),style:"filled-separate"}).inject(e),this.defRelSetByAppExpander.expand())},_getRelSetsContent:function(){if(!this._relSetsContainer){const t=m.compile(R),n={relationsset:C.get("RelationsSet"),includedrelations:C.get("IncludedRelations"),availableFor:C.get("AvailableFor"),applications:C.get("Applications"),availableFor_Roles:C.get("AvailableFor_Roles"),availableFor_UserGroups:C.get("AvailableFor_UserGroups")},s=t.call(null,n);this._relSetsContainer=e.createElement("div",{class:"relSets-container",html:s});let i={container:this._relSetsContainer.getElement(".relSetscombobox-container"),selectedIndex:0};this._setUpRelSetComboBox(i),this._setUpIconBar(this._relSetsContainer.getElement(".relSets-iconbar-container")),this._setUpRelAutoComplete(this._relSetsContainer.getElement(".relSetsAutocomplete-container")),this._setUpRolesAutoComplete(this._relSetsContainer.getElement(".roles-container")),this._setUpUsrGrpAutoComplete(this._relSetsContainer.getElement(".usrGrp-container")),this._setUpAppAutoComplete(this._relSetsContainer.getElement(".applications-container")),this._setUpFooter(this._relSetsContainer.getElement(".footer-container"))}return this._relSetsContainer},_setUpRelSetComboBox:function(e){let t=e.container;const n=new p;let s={elementsTree:n,nbDisplayedElements:n.getRoots().length,enableSearchFlag:!0,actionOnClickFlag:!1,selectedIndex:0,touchMode:this._touchMode,multiSelFlag:!1};this._profileCombobox=new o(s),this._profileCombobox.addEventListener("change",this._handleProfileChange.bind(this)),this._profileCombobox.inject(t)},_refreshProfileCombobox:function(){var e=this._model.relation_sets,t=this._profileCombobox.elementsTree;t.prepareUpdate(),t.removeRoots();for(var n=0;n<e.length;n++){var s={label:e[n].nlsLabel,grid:{name:e[n].name,selectable:!0}},i=new c(s);t.addRoot(i)}t.pushUpdate()},setRelSet:function(){for(var e=this._model.relation_sets,t=0,n=void 0!==this._model.lastUsed.profile?this._model.lastUsed.profile:"",s=0;s<e.length;s++)if(n===e[s].name){t=s;break}this._profileCombobox.selectedIndex!==t?this._profileCombobox.selectedIndex=t:this._handleProfileChange()},_handleProfileChange:function(){this.enableDisableDeletebtn(),this.updateRelSetUI();let e=this._getSelectedProfile();this.dispatchEvent("saveProfileInSession",e),this._getCurrentRelSet().custom?this.disableRelSetReset():this.dispatchEvent("ENORelCC_EnableDisableRelSetResetBtn",e)},updateRelSetUI:function(){var e=this.getSelectedRelationsModel(this._relAutoComplete.elementsTree),t=this.getRolesForProfile(this._rolesAutoComplete.elementsTree),n=this.getUsrGrpsForProfile(this._usrGrpAutocomplete.elementsTree),s=this.getAppForProfile(this._appAutoComplete.elementsTree);this._relAutoComplete.selectedItems=e,this._rolesAutoComplete.selectedItems=t,this._usrGrpAutocomplete.selectedItems=n,this._appAutoComplete.selectedItems=s},enableDisableDeletebtn:function(){this._isCustomRelSet(this._getSelectedProfile())?(this.toolBar.menu.enableItem("DeleteRelSet"),this.toolBar.menu.enableItem("RenameRelSet")):(this.toolBar.menu.disableItem("DeleteRelSet"),this.toolBar.menu.disableItem("RenameRelSet"))},_isCustomRelSet:function(e){if(this._model&&this._model.relation_sets){let t=this._model.relation_sets.find(t=>0==t.name.localeCompare(e));if(t&&t.custom)return!0}return!1},_getSelectedModels:function(e,t){for(var n=this._getSelectedProfile(),s=this._model.relation_sets,i=[],l=0;l<s.length;l++)if(s[l].name===n){"relations"===t?i=s[l].relations:"roles"===t?i=s[l].roles:"userGroups"===t?i=s[l].userGroups:"applications"===t&&(i=s[l].applications);break}var o=i.map(function(e){return e.name}),a=[];return e.search({match:function(e){return!!(("relations"!==t||"children"===e.nodeModel.getAttributeValue("structureType"))&&o.indexOf(e.nodeModel.getAttributeValue("name"))>-1&&-1===a.indexOf(e.nodeModel.getAttributeValue("name")))&&(a.push(e.nodeModel.getAttributeValue("name")),!0)}})},getSelectedRelationsModel:function(e){return this._getSelectedModels(e,"relations")},getRolesForProfile:function(e){return this._getSelectedModels(e,"roles")},getUsrGrpsForProfile:function(e){return this._getSelectedModels(e,"userGroups")},getAppForProfile:function(e){return this._getSelectedModels(e,"applications")},_setUpIconBar:function(e){var t=this,n=[{name:"CreateNewRelSet",fonticon:"plus",text:C.get("CreateNewRelSet"),handler:function(){t._onCreateClick()}},{name:"DuplicateRelSet",fonticon:"duplicate",text:C.get("Duplicate"),handler:function(){t._onDuplicateClick()}},{name:"RenameRelSet",fonticon:"pencil",text:C.get("RenameRelSet"),handler:function(){t._onRenameClick()}},{name:"DeleteRelSet",fonticon:"trash",text:C.get("DeleteRelSet"),handler:function(){t._onDeleteClick()}}];this.toolBar=new i({renderTo:e,items:n})},_setUpRelAutoComplete:function(e){var t=new p({name:"Relations",shouldBeSelected:function(e){return"parent"!==e.getAttributeValue("structureType")}});this._relAutoComplete=new a({elementsTree:t,allowFreeInputFlag:!1,multiSearchMode:!0,fireOnlyFromUIInteractionFlag:!0,selectedItems:[],touchMode:this._touchMode}),this._relAutoComplete.inject(e),this._relAutoComplete.addEventListener("change",this._handleAutocompletechange.bind(this))},_refreshRelAutoComplete:function(){if(this._relAutoComplete){var e=this._getRelTree(this._model.allrelations),t=this._relAutoComplete.elementsTree;t.prepareUpdate(),t.removeRoots(),t.loadModel(e),t.pushUpdate()}},_handleAutocompletechange:function(e){this.enableRelSetApply(),this.enableRelSetCancel();for(var t=e.dsModel.selectedItems,n=this._model.relation_sets,s=this._getSelectedProfile(),i=0;i<n.length;i++)if(n[i].name===s){var l=this._getValuesFromModels(t);"Relations"===e.dsModel.elementsTree.options.name?n[i].relations=l:"Roles"===e.dsModel.elementsTree.options.name?n[i].roles=l:"UserGroups"===e.dsModel.elementsTree.options.name?n[i].userGroups=l:"Applications"===e.dsModel.elementsTree.options.name&&(n[i].applications=l);break}},_getValuesFromModels:function(e){var t=[];return e.forEach(function(e){t.push({name:e.getAttributeValue("name")})}),t},onRelSetResetSuccess:function(){this.updateRelSetUI(),this.disableRelSetReset(),this.dispatchEvent("removeLoader")},onRelSetApplySuccess:function(){let e=this._getSelectedProfile();this.disableRelSetApply(),this.disableRelSetCancel(),this.dispatchEvent("ENORelCC_EnableDisableRelSetResetBtn",e)},_updateRelSetOnModelOptions:function(e){for(var t=this._model.relation_sets,n=0;n<t.length;n++)if(t[n].name===e.name){t[n].relations=e.relations;break}},_updateRelSetView:function(){var e=this._relAutoComplete.elementsTree,t=this._getCurrentRelSet().relations.map(function(e){return e.name}),n=e.search({match:function(e){return"children"===e.nodeModel.getAttributeValue("structureType")&&t.indexOf(e.nodeModel.getAttributeValue("name"))>-1}});this._relAutoComplete.selectedItems=n},_getCurrentRelSet:function(){for(var e=this._getSelectedProfile(),t=this._model.relation_sets,n=0;n<t.length;n++)if(t[n].name===e)return t[n];return[]},createNewRelSet:function(e){this._addNewProfileInCombobox(e),this._addNewDefRelSetCombobox(e),this.dispatchEvent("removeLoader")},dupNewRelSet:function(e){this._addNewProfileInCombobox(e),this._addNewDefRelSetCombobox(e),this.dispatchEvent("removeLoader")},renameRelSet:function(e){this._updateProfileInCombobox(e),this._updateDefRelSetCombobox(e),this.dispatchEvent("removeLoader")},_deleteRelSet:function(){var e=this._getSelectedProfile();this.dispatchEvent("ENORelCC_DeleteRelSet",e)},deleteRelSet:function(e){this._removeFromProfileCombobox(e),this._removeFromDefRelSetCombobox(e),this.dispatchEvent("removeLoader")},_removeFromProfileCombobox:function(e){for(var t=this._profileCombobox.elementsTree,n=t.getRoots(),s=-1,i=0;i<n.length;i++)if(n[i].getAttributeValue("name")===e){n[i],s=i;break}s>-1&&(t.prepareUpdate(),t.removeRoot(s),t.pushUpdate()),this._profileCombobox.selectedIndex--},_addNewProfileInCombobox:function(e){var t=this._profileCombobox.elementsTree,n={label:e.nlsLabel,grid:{name:e.name,selectable:!0}},s=new c(n);t.prepareUpdate(),t.addRoot(s,1),t.pushUpdate(),1===this._profileCombobox.selectedIndex?(this._profileCombobox.selectedIndex++,this._profileCombobox.selectedIndex--):this._profileCombobox.selectedIndex=1},_updateProfileInCombobox:function(e){this._profileCombobox.elementsTree.getNthRoot(this._profileCombobox.selectedIndex).setLabel(e.nlsLabel),this._profileCombobox.selectedIndex++,this._profileCombobox.selectedIndex--},_onCreateClick:function(){this._newCreateModal("create")},_onDuplicateClick:function(){this._newCreateModal("dup")},_onRenameClick:function(){this._newRenameModal()},_onDeleteClick:function(){this._newDeleteModal()},_newCreateModal:function(t){var n=this,s=new _({className:"newrelset-relationsetmodal",animate:!0,events:{onHide:function(e){s.destroy()}}}),i={fields:[{type:"text",required:!0,pattern:"^[_ A-Za-z0-9]+$",value:"",placeholder:C.get("NewRelSet_MyCustomRelationSet"),name:"inputval"}],events:{onSubmit:function(e){if(n.isNlsLabelExistInRelSet(e.inputval)){var i=C.get("RelSetAlreadyExistMessage").format(e.inputval);a.setContent(i),o.getParent().classList.add("has-error")}else{var l={name:n._generateUUID(),nlsLabel:e.inputval,relations:"create"===t?[]:n._getDupValues("relations"),custom:!0,roles:"create"===t?[{name:"CSV"}]:n._getDupValues("roles"),userGroups:"create"===t?[]:n._getDupValues("userGroups"),applications:"create"===t?[]:n._getDupValues("applications")};"create"===t?n.dispatchEvent("ENORelCC_CreateNewRelSet",l):(l.dupFrom=n._getSelectedProfile(),n.dispatchEvent("ENORelCC_DuplicateNewRelSet",l)),s.modals.current.hide()}},onInvalid:function(){var e="";e=0===o.value.trim().length?C.get("NewRelSet_EmptyProfileErr"):(e=C.get("NewRelSet_SpecialCharErr")).concat(" !@#$%^&*()+=-[]\\';,./{}|\":<>?"),a.setContent(e)}}},l=new f(i),o=l.elements.container.getElement("input"),a=(e.createElement("p",{html:C.get("NewRelSet_Title")}).inject(o,"before"),e.createElement("div",{class:"profilenameerror",html:""}));let r=C.get("DupRelSet"),h=C.get("Duplicate");"create"===t&&(r=C.get("CreateNewRelSet"),h=C.get("NewRelSet_OkBtn")),s.dialog({body:l,title:r,buttons:[{className:"primary",value:h,action:function(){l.submit()}},{value:C.get("NewRelSet_CancelBtn"),action:function(){s.modals.current.hide()}}]}),s.modals.current.elements.body&&s.modals.current.getBody().addContent(a),o.addEventListener("click",function(e){this.focus()})},_newRenameModal:function(){var t=this,n=this._getCurrentRelSet(),s=n.nlsLabel,i=new _({className:"newrelset-relationsetmodal",animate:!0,events:{onHide:function(e){i.destroy()}}}),l={fields:[{type:"text",required:!0,pattern:"^[_ A-Za-z0-9]+$",value:s,placeholder:C.get("NewRelSet_MyCustomRelationSet"),name:"inputval"}],events:{onSubmit:function(e){if(t.isNlsLabelExistInRelSet(e.inputval)){var s=C.get("RelSetAlreadyExistMessage").format(e.inputval);r.setContent(s),a.getParent().classList.add("has-error")}else{var l={name:n.name,nlsLabel:e.inputval};t.dispatchEvent("ENORelCC_RenameRelSet",l),i.modals.current.hide()}},onInvalid:function(){var e="";e=0===a.value.trim().length?C.get("NewRelSet_EmptyProfileErr"):(e=C.get("NewRelSet_SpecialCharErr")).concat(" !@#$%^&*()+=-[]\\';,./{}|\":<>?"),r.setContent(e)}}},o=new f(l),a=o.elements.container.getElement("input"),r=(e.createElement("p",{html:C.get("NewRelSet_Title")}).inject(a,"before"),e.createElement("div",{class:"profilenameerror",html:""}));i.dialog({body:o,title:C.get("RenameRelSet"),buttons:[{className:"primary renamerelset-okbtn",value:C.get("RenameRelSet_OkBtn"),action:function(){o.submit()}},{value:C.get("NewRelSet_CancelBtn"),action:function(){i.modals.current.hide()}}]}),i.modals.current.elements.body&&i.modals.current.getBody().addContent(r);let h=document.querySelector(".newrelset-relationsetmodal button.renamerelset-okbtn");h.classList.add("disabled"),h.setAttribute("disabled",""),a.addEventListener("click",function(e){this.focus()}),a.addEventListener("keyup",function(e){let t=document.querySelector(".newrelset-relationsetmodal button.renamerelset-okbtn");0==a.value.localeCompare(s)?(t.classList.add("disabled"),t.setAttribute("disabled","")):(t.classList.remove("disabled"),t.removeAttribute("disabled"))})},_newDeleteModal:function(){var e=this,t=this._getCurrentRelSet().nlsLabel,n=new _({animate:!0}),s=C.get("DeleteRelSet"),i=C.get("DeleteRelSetMessage").format(t);n.confirm(i,s,function(t){t&&e._deleteRelSet()})},_newRelSetResetModal:function(){var e=this,t=e._getCurrentRelSet(),n=t.nlsLabel||C.get(t.name),s=t.name,i=new _({animate:!0}),l=C.get("ResetRelSet"),o=C.get("ResetRelSetMessage").format(n);i.confirm(o,l,function(t){t&&e.dispatchEvent("ENORelCC_ResetRelSet",s)})},_getDupValues:function(e){var t;return"relations"===e?t=this._relAutoComplete.selectedItems:"roles"===e?t=this._rolesAutoComplete.selectedItems:"userGroups"===e?t=this._usrGrpAutocomplete.selectedItems:"applications"===e&&(t=this._appAutoComplete.selectedItems),this._getValuesFromModels(t)},_generateUUID:function(){return g.getUserID()+"_"+(Math.floor(1e3*Math.random())+Date.now())},_setUpRolesAutoComplete:function(e){var t=new p({name:"Roles"});this._rolesAutoComplete=new a({elementsTree:t,allowFreeInputFlag:!1,multiSearchMode:!0,fireOnlyFromUIInteractionFlag:!0,selectedItems:[],touchMode:this._touchMode}),this._rolesAutoComplete.addEventListener("change",this._handleAutocompletechange.bind(this)),this._rolesAutoComplete.inject(e)},_refreshRolesAutoComplete:function(){var e=this._model.roles,t=this._rolesAutoComplete.elementsTree;t.prepareUpdate(),t.removeRoots();for(var n=0;n<e.length;n++){var s={label:e[n].label,value:e[n].name,grid:{name:e[n].name}},i=new c(s);t.addRoot(i)}t.pushUpdate()},_setUpAppAutoComplete:function(e){var t=new p({name:"Applications"});this._appAutoComplete=new a({elementsTree:t,allowFreeInputFlag:!1,multiSearchMode:!0,fireOnlyFromUIInteractionFlag:!0,selectedItems:[],touchMode:this._touchMode}),this._appAutoComplete.addEventListener("change",this._handleAutocompletechange.bind(this)),this._appAutoComplete.inject(e)},_setUpUsrGrpAutoComplete:function(e){var t=new p({name:"UserGroups"});this._usrGrpAutocomplete=new a({elementsTree:t,allowFreeInputFlag:!1,fireOnlyFromUIInteractionFlag:!0,selectedItems:[],multiSearchMode:!0,touchMode:this._touchMode}),this._usrGrpAutocomplete.addEventListener("change",this._handleAutocompletechange.bind(this)),this._usrGrpAutocomplete.inject(e)},_refreshUsrGrpAutoComplete:function(){var e=this._model.userGroups,t=this._usrGrpAutocomplete.elementsTree;t.prepareUpdate(),t.removeRoots();for(var n=0;n<e.length;n++){var s={label:e[n].label,value:e[n].name,grid:{name:e[n].name}},i=new c(s);t.addRoot(i)}t.pushUpdate()},_setUpFooter:function(e){this._relSetApplyButton=new s({value:C.get("SaveRelSetButton"),className:"primary"}).inject(e),this._relSetApplyButton.addEvent("onClick",this._onRelSetSaveClick.bind(this)),this._relSetResetButton=new s({value:C.get("ResetRelSet")}).inject(e),this._relSetResetButton.addEvent("onClick",this._onRelSetResetClick.bind(this)),this._relSetCancelButton=new s({value:C.get("CancelRelSetButton")}).inject(e),this._relSetCancelButton.addEvent("onClick",this._onRelSetCancelClick.bind(this))},_onRelSetSaveClick:function(){this.dispatchEvent("ENORelCC_ApplyChanges",[this._model.relation_sets])},_onRelSetResetClick:function(){this._newRelSetResetModal()},_onRelSetCancelClick:function(){this.dispatchEvent("ENORelCC_CancelRelSetChanges"),this.disableRelSetCancel()},_getRelTree:function(e){var t=[],n=[],s=[];for(var i in e){let a;if(e.hasOwnProperty(i)){for(var l in t=[],a=e[i])if(a.hasOwnProperty(l)){s=[],a[l].forEach(function(e){s.push({label:C.get(e.id),grid:{name:e.id,structureType:"children"}})});var o=a[l].nlsLabel||l;t.push({label:o,grid:{structureType:"parent"},children:s})}n.push({label:C.get(i),grid:{structureType:"parent"},children:t})}}return n},_getRelTreeV2:function(e){},_getSelectedProfile:function(){if(!this._profileCombobox){return this._model.relation_sets[0].name}var e=this._profileCombobox.elementsTree.getRoots()[this._profileCombobox.selectedIndex];if(e)return e.getAttributeValue("name")},_getDefRelSetByAppContent:function(){if(!this._defRelSetByAppContent){var t=m.compile(S),n={application:C.get("Application"),defaultrelset:C.get("DefaultRelSet"),favorite:C.get("RelationsSetdefinition"),recents:C.get("Relationsdefinition")},s=t.call(null,n);this._defRelSetByAppContent=e.createElement("div",{class:"defRelSetByApp-container",html:s}),this._setUprelByAppCombobox(this._defRelSetByAppContent.getElement(".appCombobox-container")),this._setUpDefRelSetCombobox(this._defRelSetByAppContent.getElement(".defRelSet-container")),this._setUpDefFooter(this._defRelSetByAppContent.getElement(".relByAppFooter-container"))}return this._defRelSetByAppContent},_setUprelByAppCombobox:function(e){var t=new p,n={elementsTree:t,nbDisplayedElements:t.getRoots().length,enableSearchFlag:!0,actionOnClickFlag:!1,selectedIndex:0,touchMode:this._touchMode,multiSelFlag:!1};this._appCombobox=new o(n),this._appCombobox.addEventListener("change",this._handleAppChange.bind(this)),this._appCombobox.inject(e)},_refreshRelByApp:function(){var e=Object.keys(this._model.relation_apps).map(e=>({name:e,nlsLabel:C.get(e)})).sort((e,t)=>e.nlsLabel.localeCompare(t.nlsLabel)),t=this._appCombobox.elementsTree;this._refreshAppDoc(e,t),t=this._appAutoComplete.elementsTree,this._refreshAppDoc(e,t)},_refreshAppDoc:function(e,t){t.prepareUpdate(),t.removeRoots(),e.forEach(e=>{var n={label:e.nlsLabel,value:e.name,grid:{name:e.name,selectable:!0}},s=new c(n);t.addRoot(s)}),t.pushUpdate()},setApp:function(){var e=0,t=this._appCombobox.elementsTree.getRoots(),n=void 0!==this._model.lastUsed.defApp?this._model.lastUsed.defApp:"";for(let s=0;s<t.length;s++)if(t[s].getAttributeValue("name")===n){e=s;break}this._appCombobox.selectedIndex!==e?this._appCombobox.selectedIndex=e:this._handleAppChange()},_handleAppChange:function(){let e=this._getSelectedApp(),t=this._getSelectedDefRelSet(),n=this._model.relation_apps[e];t!==n&&this._changeDefaultToNewRelSet(n),this.dispatchEvent("saveDefAppInSession",e),this.dispatchEvent("ENORelCC_EnableDisableRelAppsResetBtn",e)},_changeDefaultToNewRelSet:function(e){let t=this._defRelSetCombobox.elementsTree.getRoots();for(let n=0;n<t.length;n++)if(t[n].getAttributeValue("name")===e)return void(this._defRelSetCombobox.selectedIndex=n)},_getSelectedApp:function(){if(this._appCombobox){let e=this._appCombobox.elementsTree.getRoots()[this._appCombobox.selectedIndex];if(e)return e.getAttributeValue("name")}},_setUpDefRelSetCombobox:function(e){let t=new p,n={elementsTree:t,nbDisplayedElements:t.getRoots().length,enableSearchFlag:!0,actionOnClickFlag:!1,selectedIndex:0,touchMode:this._touchMode,multiSelFlag:!1};this._defRelSetCombobox=new o(n),this._defRelSetCombobox.addEventListener("change",this._handleDefRelSetChange.bind(this)),this._defRelSetCombobox.inject(e)},_refreshDefRelSetCombobox:function(){let e,t=this._model.relation_sets,n=this._defRelSetCombobox.elementsTree;n.prepareUpdate(),n.removeRoots();for(let s=0;s<t.length;s++){let i={label:e=void 0!==t[s].nlsLabel?t[s].nlsLabel:C.get(t[s].name),value:t[s].name,grid:{name:t[s].name,selectable:!0}},l=new c(i);n.addRoot(l)}n.pushUpdate()},_handleDefRelSetChange:function(){let e=this._getSelectedApp();this._model.relation_apps[e]!==this._getSelectedDefRelSet()?(this.enableRelDefApply(),this.enableRelDefCancel()):(this.disableRelDefApply(),this.disableRelDefCancel())},_getSelectedDefRelSet:function(){if(this._defRelSetCombobox){let e=this._defRelSetCombobox.elementsTree.getRoots()[this._defRelSetCombobox.selectedIndex];if(e)return e.getAttributeValue("name")}},_setUpDefFooter:function(e){this._relDefApplyButton=new s({value:C.get("SaveRelSetButton"),className:"primary"}).inject(e),this._relDefApplyButton.addEvent("onClick",this._onDefApplyClick.bind(this)),this._relDefResetButton=new s({value:C.get("ResetRelSet")}).inject(e),this._relDefResetButton.addEvent("onClick",this._onRelAppsReset.bind(this)),this._relDefCancelButton=new s({value:C.get("CancelRelSetButton")}).inject(e),this._relDefCancelButton.addEvent("onClick",this._onRelDefCancelClick.bind(this))},_onRelAppsReset:function(){let e=this._getSelectedApp();this.dispatchEvent("ENORelCC_ResetRelApps",e)},_onRelDefCancelClick:function(){this.dispatchEvent("ENORelCC_CancelRelAppChanges"),this.disableRelDefCancel()},onRelAppsResetSuccess:function(){this.updateViewForAppsReset(),this.disableRelDefReset()},updateViewForAppsReset:function(){let e=this._getSelectedApp(),t=this._getSelectedDefRelSet(),n=this._model.relation_apps[e];t!==n?this._changeDefaultToNewRelSet(n):(this.disableRelDefApply(),this.disableRelDefCancel())},_onDefApplyClick:function(){let e=this._getSelectedApp(),t=this._getSelectedDefRelSet();this._model.relation_apps[e]=t,this.dispatchEvent("ENORelCC_ApplyAppsChanges",[this._model.relation_apps])},onRelAppsApplySuccess:function(){let e=this._getSelectedApp();this.disableRelDefApply(),this.disableRelDefCancel(),this.dispatchEvent("ENORelCC_EnableDisableRelAppsResetBtn",e)},_addNewDefRelSetCombobox:function(e){let t={label:e.nlsLabel,value:e.name,grid:{name:e.name,selectable:!0}},n=new c(t);this._defRelSetCombobox.elementsTree.addRoot(n)},_updateDefRelSetCombobox:function(e){this._defRelSetCombobox.elementsTree.getRoots().find(t=>0==e.name.localeCompare(t.options.grid.name)).setLabel(e.nlsLabel),this._defRelSetCombobox.selectedIndex++,this._defRelSetCombobox.selectedIndex--},_removeFromDefRelSetCombobox:function(e){let t,n=this._defRelSetCombobox.elementsTree,s=n.getRoots(),i=-1;for(let n=0;n<s.length;n++)if(s[n].getAttributeValue("name")===e){t=s[n],i=n;break}i>-1&&(n.prepareUpdate(),n.removeRoot(i),n.pushUpdate()),this._handleAppChange()},isNlsLabelExistInRelSet(e){return void 0!==this._profileCombobox.elementsTree.getRoots().find(t=>0==t.getLabel().localeCompare(e))},enableRelSetApply:function(){this._relSetApplyButton.enable()},disableRelSetApply:function(){this._relSetApplyButton.disable()},enableRelDefApply:function(){this._relDefApplyButton.enable()},disableRelDefApply:function(){this._relDefApplyButton.disable()},enableRelSetReset:function(){this._relSetResetButton.enable()},disableRelSetReset:function(){this._relSetResetButton.disable()},enableRelDefReset:function(){this._relDefResetButton.enable()},disableRelDefReset:function(){this._relDefResetButton.disable()},enableRelSetCancel:function(){this._relSetCancelButton.enable()},disableRelSetCancel:function(){this._relSetCancelButton.disable()},enableRelDefCancel:function(){this._relDefCancelButton.enable()},disableRelDefCancel:function(){this._relDefCancelButton.disable()},destroy:function(){this.container=null,this._parent()}})}),define("DS/ENORelationsControlCenter/views/ENORelCCAppMainView",["UWA/Core","UWA/Class","UWA/Class/View","DS/UIKIT/Mask","DS/Handlebars/Handlebars4","DS/ENORelationsControlCenter/views/RelationSetsDefView","i18n!DS/ENORelationsControlCenter/assets/nls/ENORelCC_internal","text!DS/ENORelationsControlCenter/assets/templates/homepageright.html","css!DS/ENORelationsControlCenter/ENORelationsControlCenter"],function(e,t,n,s,i,l,o,a){"use strict";return n.extend({name:"enorelcc-app-view",className:function(){return this.getClassNames("-container")},setup:function(e){this._initialize()},_initialize:function(){this._initSubViews()},_initSubViews:function(){this._setUpHomePage(),this._setUpRelSetView()},_setUpHomePage:function(){const t=i.compile(a).call();e.createElement("div",{class:"ENORipe-rightside-container",html:t}).inject(this.container)},_setUpRelSetView:function(){let e=this,t=this.getElement(".ENORipe-View-Container");this.relSetView=new l({renderTo:t}),[{name:"ENORelCC_ApplyChanges",addLoader:!0},{name:"ENORelCC_ApplyAppsChanges",addLoader:!0},{name:"ENORelCC_ResetRelSet",addLoader:!0},{name:"ENORelCC_ResetAllRelSet",addLoader:!0},{name:"ENORelCC_CreateNewRelSet",addLoader:!0},{name:"ENORelCC_DuplicateNewRelSet",addLoader:!0},{name:"ENORelCC_RenameRelSet",addLoader:!0},{name:"ENORelCC_DeleteRelSet",addLoader:!0},{name:"ENORelCC_ResetRelApps",addLoader:!0},{name:"ENORelCC_ResetAllRelApps",addLoader:!0},{name:"ENORelCC_CancelRelSetChanges",addLoader:!0},{name:"ENORelCC_CancelRelAppChanges",addLoader:!0},{name:"saveProfileInSession",addLoader:!1},{name:"saveDefAppInSession",addLoader:!1},{name:"ENORelCC_EnableDisableRelSetResetBtn",addLoader:!1},{name:"ENORelCC_EnableDisableRelAppsResetBtn",addLoader:!1}].forEach(e=>{this.listenTo(this.relSetView,e.name,this._forwardEvts.bind(this,e))}),this.listenTo(this.relSetView,"removeLoader",function(){e.removeLoader()})},render:function(e){return this.container.show(),this.relSetView.render(e),this},_forwardEvts:function(e,t){e.addLoader&&this.addLoader(),Array.isArray(t)&&(t=[t]),this.dispatchEvent(e.name,t)},addLoader:function(){s.mask(this.container)},removeLoader:function(e){s.unmask(this.container)},destroy:function(){this.stopListening(this.relSetView),this.container=null,this._parent()}})}),define("DS/ENORelationsControlCenter/ENORelCCApp",["UWA/Class","UWA/Core","UWA/Promise","DS/ENORelationsControlCenter/utils/PromisesManager","DS/WAFData/WAFData","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/ENORelationsControlCenter/views/ENORelCCAppMainView","DS/SNNavigationMap/utils/RelationsServices","DS/SNNavigationMap/MapSettings","DS/SNNavigationMap/utils/ProbesUtils","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/SNNavigationMap/utils/NlsManager","i18n!DS/ENORelationsControlCenter/assets/nls/ENORelCC_internal"],function(e,t,n,s,i,l,o,a,r,h,p,c,d,u){"use strict";return e.extend({_model:{},_groupedRelations:{},init:function(e){var n=this;t.merge(u,d.getNls()),this._widget=e.widget||null,this.container=e.renderTo||null,this._PM=new s({debugMode:"1"===h.getOption("debug_me")}),this._notifManager=l,o.setNotificationManager(this._notifManager),this._widgetId=this._widget.id,h.appInitializationPromised().then(function(){h.addCredentialPreferenceToWidget().then(n._getAndParseAllInfos.bind(n)).then(()=>{n._updateOptions(),n._initMainView(),n._updateWidgetHeader()},e=>{e.showMsg&&n._notifManager.addNotif({level:"error",message:u.get(e.msg),sticky:!0})})}),h.setLang(e.lang)},_getAndParseAllInfos:function(){var e=this,t=h.getUserID(),s="platform="+h.getCurrentTenantName()+"&user="+t,l=h.get3DAppsUrl()+"/resources/AppsMngt/user/roles?"+s,o=new n((t,n)=>{i.authenticatedRequest(l,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",onComplete:function(n){e._parseAllRoles(JSON.parse(n)),t()},onFailure:function(e){t(),console.log(e)},onTimeout:function(e){t(),console.log(e)}})}),a=new n((t,n)=>{let s=h.get3DSearchUrl()+"/search",l={};e._currentSrchRqst&&e._currentSrchRqst.cancel(),e._debug&&(l.debug=!0),l.label=e._getSearchLabel(),l.select_predicate=["ds6w:label"],l.query="type:group",l.tenant=h.getCurrentTenantName(),l.nresults=100,l.with_synthesis_attribute=!1,l.with_synthesis=!1,l=JSON.stringify(l),e._currentSrchRqst=i.authenticatedRequest(s,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",data:l,onComplete:function(n){e._currentSrchRqst=null,n=JSON.parse(n),e._parseUserGroups(n),t()},onFailure:function(t){e._currentSrchRqst=null,console.log(t),n(t)},onTimeout:function(t){e._currentSrchRqst=null,console.log(t),n(t)}})}),p=r.getSettingsAndRelSets(!0).then(function(t){let n=t[0],s=t[1],i=t[2];e._parseSettings(n).then(e._getAppsNls.bind(e)).then(function(){e._activeProfiles||(e._parsePatterns(s),e._parseRelations(i))})});return n.all([o,a,p])},_parseSettings:function(e){return new n((t,n)=>{e.notexist||void 0===e.relation_apps?this._initSettingsPage().then(e=>{e&&(this._settings=JSON.parse(e)),t()}):(this._settings=e,t())})},_initSettingsPage:function(){let e=this;return new n(function(t,n){e._getSelectedSC().then(function(e){i.authenticatedRequest(h.get3DSpaceUrl()+"/resources/enorelcc/cc_services/relsettingsinit?tenant="+h.getCurrentTenantName(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e},method:"POST",onComplete:t,onFailure:function(e){console.log(e),n(e)},onTimeout:function(e){console.log(e),n(e)}})})})},_parsePatterns:function(e){if(e){const s=JSON.parse(e);this.autoModeProfile={name:"AutoModeProfile"},this.autoModeProfile.relations=s.patterns?s.patterns:[];for(var t=this.autoModeProfile.relations.length;t--;)this.autoModeProfile.relations[t].name.contains("v6_structure_roots")&&this.autoModeProfile.relations.splice(t,1);return new n(function(e,t){e()})}},_parseRelations:function(e){if(e){let s=JSON.parse(e);this.autoModeProfile&&s.profiles.unshift(this.autoModeProfile),this._activeProfiles=s.profiles;for(let e=0;e<this._activeProfiles.length;e++)this._activeProfiles[e].userGroups=this._getDefaultUserGroups(),this._activeProfiles[e].roles=this._getDefaultRoles(),this._activeProfiles[e].applications&&0!==this._activeProfiles[e].applications.length||(this._activeProfiles[e].applications=this._getDefaultApplications());var t=this._activeProfiles[0];return new n((e,n)=>{let s={};for(let e=0;e<this._activeProfiles.length;e++)(t=this._activeProfiles[e])&&(s[t.name]=this._splitRelations(t.relations));let i=Object.keys(s).sort((e,t)=>u.get(e).localeCompare(u.get(t)));this._groupedRelations={},i.forEach(e=>{this._groupedRelations[e]=s[e]}),e()})}},_getDefaultUserGroups:function(){return[]},_getDefaultApplications:function(){return[]},_getDefaultRoles:function(){return[{name:"CSV"}]},_getAppsNls:function(){var e=this,t=Object.keys(this._settings.relation_apps);return new n(function(n,s){e._appNls?n():c.getAppsInfo({data:t,onComplete:function(t){e._appNls=t,t.forEach(function(e){u[e.id]=e.title}),n()}})})},_splitRelations:function(e){let n,s,i={},l=null,o=!1,a={},r=[],h="",p=!1,c=!1,d={},_=[],f=[];this.isGrouping=!1,e.forEach(e=>{f.push(e.name)});for(let R=0;R<e.length;R++)if(n=e[R].name,!(_.indexOf(n)>-1)){h=this._getMainRelName(n),!1===this.isGrouping&&(p=-1!==f.indexOf(h.concat("_to")),c=-1!==f.indexOf(h.concat("_from")),p&&c&&(this.isGrouping=!0)),e[R].showdetail&&"done"!==d[h]?(d[h]="done",l={id:"details_"+h,relationName:u.get("showPub"),value:o}):l=null,o=!1,i={id:n,relationName:u[n],value:void 0},r=u.get(h);var m=h+"_to",g=h+"_from";if(f.indexOf(m)>-1?s=u[m+"_short"]||u[m]:f.indexOf(g)>-1&&(s=u[g+"_short"]||u[g]),h.contains("v6_cad_document_externalreference"));t.is(a[r],"array")||(a[r]=[]),i.id.contains("_from")?"v6_repreplink_from"===i.id?a[r].splice(1,0,i):a[r].unshift(i):a[r].push(i),a[r].title=u[h+"_short"]||u[h]||h,a[r].nlsLabel=s||u[h+"_short"]||u[h]||h,l&&a[r].unshift(l),_.push(n)}return a},_getMainRelName:function(e){let t="";return t="_to"===e.substr(e.length-3)?e.substr(0,e.length-3):e.substr(0,e.length-5)},_parseAllRoles:function(e){if(this._allRoles=[],e&&e.data){let t;e=e.data;for(let n=0;n<e.length;n++)t={name:e[n].trigram,label:e[n].name+" ("+e[n].trigram+")"},"CSV"===e[n].trigram&&(this._CSVRole={name:e[n].trigram}),this._allRoles.push(t)}},_updateOptions:function(){this._updateModelRelSet(),this._updateModelRelApps(),this._updateModelOptions()},_updateModelRelSet:function(){let e=[];this._model.relation_sets=[];let t=this._settings.relation_sets,n=[];t.length>0&&(n=t.map(e=>e.name));let s={},i=-1;for(let l=0;l<this._activeProfiles.length;l++)s=-1!==(i=n.indexOf(this._activeProfiles[l].name))?t[i]:this._activeProfiles[l],e.push(s);for(let n=0;n<t.length;n++)t[n].custom&&(t[n].applications||(t[n].applications=[]),e.splice(n,0,t[n]));this._model.relation_sets=JSON.parse(JSON.stringify(e))},_updateModelRelApps:function(){let e={};for(let t in this._settings.relation_apps)this._settings.relation_apps.hasOwnProperty(t)&&(e[t]=this._settings.relation_apps[t]);this._model.relation_apps=JSON.parse(JSON.stringify(e))},_updateModelOptions:function(){this._model.lastUsed={profile:this._getLastUsed("Profile"),defApp:this._getLastUsed("DefApp")},this._model.allrelations=this._groupedRelations,this._model.roles=this._allRoles,this._model.userGroups=this._userGroups},_initMainView:function(){this.homePage?this.homePage.render(this._model):(this.homePage=new a({platformId:h.getPlatformId(),lang:h.getLang(),widgetId:this._widgetId}),this.homePage.addEvent("ENORelCC_ApplyChanges",this._applyChanges.bind(this)),this.homePage.addEvent("ENORelCC_ResetRelSet",this._resetRelSet.bind(this)),this.homePage.addEvent("ENORelCC_ResetAllRelSet",this._resetAllRelSet.bind(this)),this.homePage.addEvent("ENORelCC_CancelRelSetChanges",this._cancelAllRelSetChanges.bind(this)),this.homePage.addEvent("ENORelCC_CreateNewRelSet",this._createNewRelSet.bind(this)),this.homePage.addEvent("ENORelCC_DuplicateNewRelSet",this._dupNewRelSet.bind(this)),this.homePage.addEvent("ENORelCC_RenameRelSet",this._renameRelSet.bind(this)),this.homePage.addEvent("ENORelCC_DeleteRelSet",this._deleteRelSet.bind(this)),this.homePage.addEvent("ENORelCC_ApplyAppsChanges",this._applyAppsChanges.bind(this)),this.homePage.addEvent("ENORelCC_ResetRelApps",this._resetRelApps.bind(this)),this.homePage.addEvent("ENORelCC_ResetAllRelApps",this._resetAllRelApps.bind(this)),this.homePage.addEvent("ENORelCC_CancelRelAppChanges",this._cancelAllRelAppChanges.bind(this)),this.homePage.addEvent("saveProfileInSession",function(e){this._saveValuesInSession("Profile",e)}.bind(this)),this.homePage.addEvent("saveDefAppInSession",function(e){this._saveValuesInSession("DefApp",e)}.bind(this)),this.homePage.addEvent("ENORelCC_EnableDisableRelSetResetBtn",this.enableDisableRelSetResetBtn.bind(this)),this.homePage.addEvent("ENORelCC_EnableDisableRelAppsResetBtn",this.enableDisableRelAppsResetBtn.bind(this)),this.homePage.render(this._model),this.container.setContent(this.homePage))},_deleteRelSet:function(e){let t=-1;for(let n=0;n<this._settings.relation_sets.length;n++)if(this._settings.relation_sets[n].name===e){t=n;break}t>-1&&this._settings.relation_sets.splice(t,1),r.getResetRelApps().then(n=>{let s=n.relation_apps,i=this._settings.relation_apps;for(let t in i)i.hasOwnProperty(t)&&i[t]===e&&(i[t]=s[t],this._model.relation_apps[t]=s[t]);this._updateRelSettings(this._settings).then(()=>{t=-1;for(let n=0;n<this._model.relation_sets.length;n++)if(this._model.relation_sets[n].name===e){t=n;break}t>-1&&this._model.relation_sets.splice(t,1),this._showNotif({level:"info",msg:u.get("UpdateSuccess")}),this.homePage.relSetView.deleteRelSet(e)})})},_newRelSet:function(e,t){this._settings.relation_sets.push(JSON.parse(JSON.stringify(e))),this._updateRelSettings(this._settings).then(()=>{this._model.relation_sets.push(e),"create"===t?this.homePage.relSetView.createNewRelSet(e):this.homePage.relSetView.dupNewRelSet(e),this.homePage.removeLoader(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")})})},_createNewRelSet:function(e){this._newRelSet(e,"create"),this._trackUsage("ENORECC-NewRelSet",e.nlsLabel,1)},_dupNewRelSet:function(e){this._newRelSet(e,"dup");let t=e.nlsLabel+":"+e.dupFrom;this._trackUsage("ENORECC-DuplicateRelSet",t,1)},_renameRelSet:function(e){let t=this,n=this._settings.relation_sets.find(t=>0==e.name.localeCompare(t.name));for(var s in e)0!=s.localeCompare(e.name)&&(n[s]=e[s]);this._updateRelSettings(this._settings).then(function(){let n=t._model.relation_sets.find(t=>0==e.name.localeCompare(t.name));for(var s in e)0!=s.localeCompare(e.name)&&(n[s]=e[s]);t.homePage.relSetView.renameRelSet(e),t.homePage.removeLoader(),t._showNotif({level:"info",msg:u.get("UpdateSuccess")})})},_resetRelSet:function(e){let t,n=-1,s=-1;for(let s=0;s<this._model.relation_sets.length;s++)if(this._model.relation_sets[s].name===e){t=this._model.relation_sets[s],n=s;break}for(let t=0;t<this._settings.relation_sets.length;t++)if(this._settings.relation_sets[t].name===e){s=t;break}if(t.custom)this._updateOnReset(n,JSON.parse(JSON.stringify(this._settings.relation_sets[s])));else{let t=JSON.parse(JSON.stringify(this._getRelSetFromActiveProfiles(e)));s>-1?(this._settings.relation_sets.splice(s,1),this._updateRelSettings(this._settings).then(()=>{this._updateOnReset(n,t)})):this._updateOnReset(n,t)}},_resetAllRelSet:function(){let e=!1,t=this._settings.relation_sets.length;for(;t--;)this._settings.relation_sets[t].custom||(this._settings.relation_sets.splice(t,1),e=!0);var n=this._getAllResetRelSet();e?this._updateRelSettings(this._settings).then(()=>{this._model.relation_sets=n,this.homePage.relSetView.onRelSetResetSuccess(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")})}):(this._model.relation_sets=n,this.homePage.relSetView.onRelSetResetSuccess(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")}))},_cancelAllRelSetChanges:function(){this._updateModelRelSet(),this.homePage.relSetView.updateRelSetUI(),this.homePage.removeLoader(),this._showNotif({level:"info",msg:u.get("CancelMsg")})},_getAllResetRelSet:function(){let e=[];for(let t=0;t<this._activeProfiles.length;t++)e.push(this._activeProfiles[t]);for(let t=0;t<this._settings.relation_sets.length;t++)this._settings.relation_sets[t].custom&&e.splice(1,0,this._settings.relation_sets[t]);return JSON.parse(JSON.stringify(e))},_updateOnReset:function(e,t){this._model.relation_sets[e]=t,this.homePage.relSetView.onRelSetResetSuccess(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")})},_getRelFromModel:function(e){let t=this._model.relation_sets;for(let n=0;n<t.length;n++)if(t[n].name===e)return t[n]},_getRelFromSettings:function(e){let t=this._settings.relation_sets;for(let n=0;n<t.length;n++)if(t[n].name===e)return t[n].relations;return[]},_getRelSetFromActiveProfiles:function(e){for(let t=0;t<this._activeProfiles.length;t++)if(this._activeProfiles[t].name===e)return this._activeProfiles[t];return[]},_applyChanges:function(e){let t=this._getDifferenceFromServer(e);this.trackRelSetChanges(t),this._settings.relation_sets=t,this._updateRelSettings(this._settings).then(()=>{this.homePage.removeLoader(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")}),this.homePage.relSetView.onRelSetApplySuccess()})},_getDifferenceFromServer:function(e){let t=[];for(let n=0;n<e.length;n++)e[n].custom?t.push(e[n]):this._isDifferentFromServer(e[n],this._activeProfiles)&&t.push(e[n]);return JSON.parse(JSON.stringify(t))},_getDifferenceFromSettings:function(e){let t=[],n=this._settings.relation_sets.map(e=>e.name);for(let s=0;s<e.length;s++)n.includes(e[s].name)?this._isDifferentFromServer(e[s],this._settings.relation_sets)&&t.push(e[s]):t.push(e[s]);return t},_isDifferentFromServer:function(e,t){for(let n=0;n<t.length;n++)if(t[n].name===e.name){if(this._isDifferent(e.relations,t[n].relations))return!0;if(this._isDifferent(e.roles,t[n].roles))return!0;if(this._isDifferent(e.userGroups,t[n].userGroups))return!0;if(this._isDifferent(e.applications,t[n].applications))return!0}return!1},_isDifferent:function(e,t){if(e.length!==t.length)return!0;let n=t.map(e=>e.name);for(let t=0;t<e.length;t++)if(-1===n.indexOf(e[t].name))return!0;return!1},_applyAppsChanges:function(e){this.trackAppChanges(e),this._settings.relation_apps=JSON.parse(JSON.stringify(e)),this._updateRelSettings(this._settings).then(()=>{this.homePage.relSetView.onRelAppsApplySuccess(),this.homePage.removeLoader(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")})})},_getRelAppChanges:function(e,t){let n=[],s="";for(let i in t)t.hasOwnProperty(i)&&e[i]!==t[i]&&(s=i+":"+t[i],n.push(s));return n},_resetRelApps:function(e){r.getResetRelApps().then(t=>{let n=t.relation_apps;this._settings.relation_apps[e]=n[e],this._model.relation_apps[e]=n[e],this._doResetRelApps()})},_resetAllRelApps:function(){h._getResetRelApps().then(e=>{let t=e.relation_apps;this._settings.relation_apps=JSON.parse(JSON.stringify(t)),this._updateModelRelApps(),this._doResetRelApps()})},_cancelAllRelAppChanges:function(){this._updateModelRelApps(),this.homePage.relSetView.updateViewForAppsReset(),this.homePage.removeLoader(),this._showNotif({level:"info",msg:u.get("CancelMsg")})},_doResetRelApps:function(){this._updateRelSettings(this._settings).then(()=>{this.homePage.relSetView.onRelAppsResetSuccess(),this.homePage.removeLoader(),this._showNotif({level:"info",msg:u.get("UpdateSuccess")})})},enableDisableRelSetResetBtn:function(e){for(let t=0;t<this._settings.relation_sets.length;t++)if(!this._settings.relation_sets[t].custom&&this._settings.relation_sets[t].name===e)return void this.homePage.relSetView.enableRelSetReset();this.homePage.relSetView.disableRelSetReset()},enableDisableRelAppsResetBtn:function(e){r.getResetRelApps().then(t=>{let n=t.relation_apps;this._settings.relation_apps[e]!==n[e]?this.homePage.relSetView.enableRelDefReset():this.homePage.relSetView.disableRelDefReset()})},_getLastUsed:function(e){let t=this._getValuesInSession(e);return t||(t="Profile"===e?"In_App_Product_Relations":"ENOPSTE_AP",this._saveValuesInSession(e,t)),t},_saveValuesInSession:function(e,t){this._widget.setValue(e,t),localStorage.setItem(e,t)},_getValuesInSession:function(e){let t;return this._widget&&(t=this._widget.getValue(e)),t||(t=localStorage.getItem(e)),t},_updateRelSettings:function(e){let t=this;return new n(function(n,s){t._getSelectedSC().then(function(t){i.authenticatedRequest(h.get3DSpaceUrl()+"/resources/enorelcc/cc_services/updaterelsettings?tenant="+h.getCurrentTenantName(),{headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t},method:"POST",data:JSON.stringify(e),onComplete:n,onFailure:function(e){console.log(e),s(e)},onTimeout:function(e){console.log(e),s(e)}})})})},_getSelectedSC:function(){let e;return new n(function(t,n){sessionStorage.getItem("Map_selectedSecurityContext")?(e=sessionStorage.getItem("Map_selectedSecurityContext"))?(e=JSON.parse(e),t(e)):n():h._getListOfSecurityContext().then(function(){(e=sessionStorage.getItem("Map_selectedSecurityContext"))?(e=JSON.parse(e),t(e)):n()})})},_showNotif:function(e){this._notifManager.addNotif({level:e.level,message:e.msg,title:e.title?e.title:"",subtitle:e.subtitle?e.subtitle:"",sticky:!1})},_getSearchLabel:function(){return"ENORELCC_"+h.getUserID()+"_"+Date.now()},_parseUserGroups:function(e){if(this._userGroups=[],e.results)for(let n=0;n<e.results.length;n++){let s=e.results[n];if(s.attributes){var t={};for(let e=0;e<s.attributes.length;e++)"resourceid"===s.attributes[e].name&&(t.name=s.attributes[e].value),"ds6w:label"===s.attributes[e].name&&(t.label=s.attributes[e].value);void 0!==t.name&&this._userGroups.push(t)}}},_updateWidgetHeader:function(){widget.setTitle(" ("+h.getCurrentTenantLabel()+")")},onEndEditPref:function(){let e=this._getWidgetValue("selected_tenant");if(e!==h.getCurrentTenantName()){this._needToConfirmPlatformChange=!0,h.setCurrentTenant(e);let t={tenantChange:!0};this._refreshApp(t)}},_getWidgetValue:function(e){if(this._widget)return this._widget.getValue(e)},onRefresh:function(e){this._refreshApp(e)},_refreshApp:function(e){let t=this;this.homePage&&this.homePage.addLoader(),this._getAndParseAllInfos().then(function(){t._updateOptions(),t._initMainView(),t._updateWidgetHeader(),e&&(e.firedFromWidgetMenu?t._showNotif({level:"info",msg:u.get("RefreshDone")}):e.tenantChange&&(t._needToConfirmPlatformChange=!1,t._showNotif({level:"info",msg:u.get("PlatformChangeSuccess")+" "+h.getCurrentTenantName()}))),t.homePage.removeLoader()})},trackAppChanges:function(e){const t=this._getRelAppChanges(this._settings.relation_apps,e);t.forEach(e=>{this._trackUsage("ENORECC-AppDefaultRelSet",e,1)})},trackRelSetChanges:function(e){try{this._getDifferenceFromSettings(e).forEach(e=>{if(this._trackUsage("ENORECC-ModifyRelSet",e.name,1),e.roles.length>1){let t=e.roles.map(e=>e.name).join(","),n=e.name+":"+t;this._trackUsage("ENORECC-ModifyRoles",n,1)}if(e.userGroups.length>1){let t=e.userGroups.map(e=>e.name).join(","),n=e.name+":"+t;this._trackUsage("ENORECC-ModifyUserGroups",n,1)}if(e.applications.length>1){let t=e.applications.map(e=>e.name).join(","),n=e.name+":"+t;this._trackUsage("ENORECC-ModifyApplications",n,1)}})}catch(e){console.log(e)}},_trackUsage:function(e,t){p.trackUsage(e,t,1,{appID:"ENORECC_AP"})},onResize:function(){}})});