define("DS/MPFCheckoutPage/phoneNumber/PhoneNumberInput",["DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressFormComponent/AddressTextInput","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n){"use strict";const a=i.Events,o=i.extend({setup({billingAddressHelper:i,cart:a,psp:o,address:c}){e.requiredOfPrototype(a,t,"options.cart must be a CartModel"),e.requiredOfPrototype(o,s,"options.psp must be a PspModel"),e.requiredOfPrototype(c,r,"options.address must be a AddressModel"),this.billingAddressHelper=i,this.psp=o,this._parent({address:c,fieldName:r.Fields.PHONE_NUMBER,fieldLabel:n.get("phoneNumber"),isReadOnly:a.isPaymentComplete(),type:"tel"})},render({countryConstraints:e}){if(this._parent({countryConstraints:e}),!this.psp.isCcAvenue()&&this.billingAddressHelper.isCompanyBuyer()){this.container.getElement("span.mpf-label").addContent({tag:"div",class:"mpf-label-comment",text:n.get("forSupportPurposesOnly")})}return this.isValid()&&this.removeError(),this},destroy(){this.billingAddressHelper=null,this.psp=null,this._parent(),this.container=null}});return o.Events=a,o}),define("DS/MPFCheckoutPage/billingAddress/VatIdRules",["DS/MPFServices/MarketplaceServices"],function(e){"use strict";const t={AUS:{vatIdLabel:"businessNumber",showNoVatIdToggle:!0},CAN:{vatIdLabel:"businessNumber"},CHE:{showVatIdInput:!1},DZA:{vatIdLabel:"nifNumber",required:!0},DEFAULT:{vatIdLabel:"taxRegistrationId",required:!1,showVatIdInput:!0,showNoVatIdToggle:!1,showSpecialEconomicZoneToggle:!1},EU:{vatIdLabel:"vatRegistrationId",showNoVatIdToggle:!0},IND:{vatIdLabel:"gstId",showNoVatIdToggle:!0},JPN:{showVatIdInput:!1},MAR:{vatIdLabel:"iceNumber",required:!0},USA:{vatIdLabel:"employerIdentificationNumber"}};return class{static getCountryRules({service:s,country:r,countries:i}){"DEFAULT"!==r&&!t[r]&&i.isEuropeanCountry(r)&&(r="EU");const n={...t.DEFAULT,...t[r]};return s!==e.MAKE&&s!==e.ENGINEERING||(n.required=!0),n}}}),define("DS/MPFCheckoutPage/billingAddress/BillingAddressHelper",["DS/MPFServices/MarketplaceServices","DS/MPFUtils/StorageUtils","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCartModel/CartModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCountryModel/CountryCollection"],(e,t,s,r,i,n,a,o,c,d,l)=>{"use strict";return class{constructor({service:t,person:r,cart:n,buyerType:o,isBuyerTypeEditable:h,company:p,personAddresses:u,companyAddresses:m,countries:y,addressFactory:g}){s.requiredOfPrototype(r,i,"options.person must be a PersonModel"),s.requiredOfPrototype(n,a,"options.cart must be a CartModel"),s.requiredOfPrototype(u,c,"options.personAddresses must be an AddressCollection"),s.requiredOfPrototype(g,d,"options.addressFactory must be an AddressFactory"),s.requiredOfType(t,"string","options.service must be a MarketplaceServices instance"),s.requiredOfType(h,"boolean","options.isBuyerTypeEditable must be a boolean"),this.service=t,this.person=r,this.company=p,this.cart=n,this.personAddresses=u,this.companyAddresses=m,this.addressFactory=g,this._isBuyerTypeEditable=h,this.buyerType=o||this.deduceBuyerType(),this.service===e.CLICK_AND_BUY&&(s.requiredOfPrototype(y,l,"options.countries must be a CountryCollection"),this.countries=y)}pushCompanyAddress(e){this.companyAddresses.push(e)}pushPersonalAddress(e){this.personAddresses.push(e)}isBillingInfoComplete(){const e=this.getBuyerType(),t=this.isBuyerTypeEditable(),s=this.hasValidBillingAddress();if(e===r.COMPANY||t){if(this.company){const e=!!this.company.getName(),t=!!this.company.getCountry(),r=this._validateTaxRegistrationId(),i=e&&t&&r;return s&&i}return!1}return s}_validateTaxRegistrationId(){let t;const s=this.company.getTaxRegistrationId(),r=this.getSelectedAddress(),i=this.company.getCountry()||r&&r.getCountry(),a=["USA","CAN","JPN"].indexOf(i)>-1,o=this.service===e.CLICK_AND_BUY,c=this.service===e.SUBSCRIPTIONS,d=this.service===e.INNOVATE;return t=!!(this.service===e.IFWELOOP||c&&this.cart.isIfweloopOrder()||(o||c||d)&&(a||this.company.hasNoVatId()))||!!s&&!this.company.validate(n.Fields.TAX_REGISTRATION_ID)}getBuyerType(){return this.buyerType||this.deduceBuyerType()}deduceBuyerType(){const e=this.cart.get(a.Fields.BILL_TO);return e&&this.companyAddresses&&this.companyAddresses.get(e)?r.COMPANY:r.INDIVIDUAL}setBuyerType(e){this.buyerType=e}isCompanyBuyer(){return this.buyerType===r.COMPANY}isBuyerTypeEditable(){return this._isBuyerTypeEditable}getBuyer(){const e=this.getSelectedAddress();return e&&e.isCompanyAddress?this.company:this.person}getSelectedAddress(){const e=this.cart.get(a.Fields.BILL_TO);if(e){const t=this.companyAddresses&&this.companyAddresses.get(e);return t?(t.isCompanyAddress=!0,t):this.personAddresses.get(e)}}createBillingAddress(e={}){return e[o.Fields.IS_BILL_TO]="TRUE",e[o.Fields.IS_SHIP_TO]="TRUE",this.isCompanyBuyer()?this._createCompanyAddress(e):this._createMeAddress(e)}_createCompanyAddress(e){return this.addressFactory.createModel(d.Types.COMPANY,{[o.Fields.COUNTRY]:this.company&&this.company.getCountry()||"DEFAULT",...e},{isCompanyAddress:!0,parentResourceId:this.company&&this.company.get("id")})}_createMeAddress(e){return this.addressFactory.createModel(d.Types.ME,e)}getValidBillingAddresses({forceBuyerTypeFiltering:e=!1}={}){const t=[];if((this.buyerType===r.INDIVIDUAL||this.isBuyerTypeEditable()&&!e)&&this.personAddresses.forEach(e=>{e.isBillTo()&&t.push(e)}),(this.buyerType===r.COMPANY||this.isBuyerTypeEditable()&&!e)&&this.company&&this.companyAddresses){const e=this.company.getCountry();this.companyAddresses.forEach(s=>{!s.isBillTo()||e&&s.getCountry()!==e||(s.isCompanyAddress=!0,t.push(s))})}return t}async patchBillingAddress(s,r={}){const i=this.cart.getState();if(i===a.States.PENDING_PAYMENT?await this.cart.savePromise({[a.Fields.STATE]:a.States.SUBMITTED},{patch:!0}):i!==a.States.SAVED_DRAFT&&i!==a.States.DRAFT||(r[a.Fields.STATE]=a.States.SUBMITTED),await this.cart.savePromise({[a.Fields.BILL_TO]:s.get("id"),...r},{patch:!0}),this.buyerType=this.deduceBuyerType(),this.service===e.CLICK_AND_BUY){const e=s.getCountry(),r=this.countries.find(t=>t.getIso3()===e),i=r&&r.getIso2();this._hasCountryChanged=this.hasCountryChanged(i),t.storeCountry(this.service,i)}}hasCountryChanged(e){return e!==t.getStoredCountry(this.service)}mustDisplayCountryChangeInfo(){return!0===this._hasCountryChanged&&(this._hasCountryChanged=!1,!0)}hasValidBillingAddress(){const e=this.cart.get(a.Fields.BILL_TO);return!!e&&!!this.getValidBillingAddresses().find(t=>t.get("id")===e)}async patchDefaultCartBillingAddress(){const e=this.cart.getState();if(this.hasValidBillingAddress())e!==a.States.SAVED_DRAFT&&e!==a.States.DRAFT||await this.cart.savePromise({[a.Fields.STATE]:a.States.SUBMITTED},{patch:!0});else{let e;const t=this.getValidBillingAddresses(),s=this.cart.get(a.Fields.SHIP_TO),r=s&&t.find(e=>e.get("id")===s);if(e=r||t.length>0&&t[t.length-1])return this.patchBillingAddress(e)}}numberOfAddresses(){return this.getValidBillingAddresses().length}async createCompanyWithAddress({companySearch:e,company:t,address:s}){e.set(n.Fields.NO_VAT_ID,e.getTaxRegistrationId()?"FALSE":"TRUE"),e.set(n.Fields.BILL_TO_ADDRESS,s.omit()),t.set(e.omit(n.Fields.MATCHING_COMPANIES,"address")),await(t.isNew()?t.savePromise():t.savePromise(this.company.getPendingChanges(),{patch:!0}));const r=this.addressFactory.createModel(d.Types.COMPANY,this.company.getBillToAddress(),{parse:!0});this.pushCompanyAddress(r),await this.patchBillingAddress(r)}async deleteAddress({addressToDelete:e,forceBuyerTypeFiltering:t=!1}={}){this.buyerType===r.INDIVIDUAL||this.isBuyerTypeEditable()&&!t?await this.personAddresses.get(e.id).destroyPromise():(this.buyerType===r.COMPANY||this.isBuyerTypeEditable()&&!t)&&await this.companyAddresses.get(e.id).destroyPromise()}}}),define("DS/MPFCheckoutPage/IconLink",["UWA/Class/View","DS/UIKIT/Spinner","DS/MPFServices/ObjectService"],function(e,t,s){"use strict";const r=Object.freeze({ON_CLICK:"onClick"}),i=e.extend({className:"mpf-icon-link",domEvents:{click:"_onClick"},setup({text:e,icon:s}={}){this.text=e,this.icon=s,this.spinner=new t},load(e=!0){e?this.spinner.show():this.spinner.hide()},render(){return this.container.setContent([this.spinner,{tag:"span",class:"fonticon fonticon-"+this.icon},{tag:"a",text:this.text}]),this},destroy(){this._parent(),this.container=null},_onClick(){this.dispatchEvent(r.ON_CLICK)}});return i.Events=r,i}),define("DS/MPFCheckoutPage/CheckoutSection",["UWA/Class/View","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/MPFServices/ObjectService"],function(e,t,s,r){"use strict";const i=Object.freeze({NEXT_SECTION:"nextSection",EDIT_SECTION:"editSection",MASK_PAGE:"onMaskPage"}),n=Object.freeze({READ:"read",WRITE:"write",DISABLED:"disabled"}),a=e.extend({className:"mpf-checkout-section",setup({title:e,index:t,className:s,alertHideDelay:i=4e3}={}){r.requiredOfType(e,"string","options.title must be a string"),r.requiredOfType(t,"number","options.index must be a number"),this.title=e,this.index=t,this.container.addClassName(s),this.alert=this._createAlert({alertHideDelay:i})},isComplete(){},load:()=>Promise.resolve(),renderAdditionalHeaderContent({state:e}){},renderReadMode(){},renderWriteMode(){},renderHeader({state:e,...t}){return{tag:"div",class:"mpf-checkout-section-header",html:[{tag:"div",class:"mpf-section-number",text:this.index+1},{tag:"div",class:"mpf-header-main-column",html:[{tag:"div",class:"mpf-section-title",text:this.title},this.renderAdditionalHeaderContent({state:e,...t})]}]}},renderLink:({text:e,icon:t,onClick:s,className:r})=>({tag:"a",class:"mpf-link"+(r?" "+r:""),html:[{tag:"span",class:"fonticon fonticon-"+t},{tag:"span",class:"mpf-link-text",text:e}],events:{click:s}}),render({editIndex:e,...t}){let s=n.DISABLED;e>this.index?s=n.READ:e===this.index&&(s=n.WRITE);const r=[this.alert,this.renderHeader({state:s,...t})];return s===n.READ?(r.push(this._renderBody(this.renderReadMode(t))),this.container.removeClassName("mpf-disabled")):s===n.WRITE?(r.push(this._renderBody(this.renderWriteMode(t))),this.container.removeClassName("mpf-disabled")):this.container.addClassName("mpf-disabled"),this.container.setContent(r),this},toEditMode(){this.dispatchEvent(i.EDIT_SECTION,{index:this.index})},next(){this.dispatchEvent(i.NEXT_SECTION)},showError(e){this.alert.add({className:"error",message:e}).show()},mask(){s.mask(this.container)},unmask(){s.unmask(this.container)},maskPage(e){this.dispatchEvent(i.MASK_PAGE,[!0,e])},unmaskPage(){this.dispatchEvent(i.MASK_PAGE,!1)},scrollIntoView(){this.container.scrollIntoView({behavior:"smooth",block:"nearest"})},destroy(){this.alert=null,this._parent(),this.container=null},_renderBody:e=>({tag:"div",class:"mpf-checkout-section-body",html:e}),_createAlert:({alertHideDelay:e})=>new t({autoHide:!0,closable:!0,visible:!1,hideDelay:e})});return a.Events=i,a.States=n,a}),define("DS/MPFCheckoutPage/payment/CardTokenTile",["UWA/Class/View","UWA/Core","UWA/Event","DS/WebappsUtils/WebappsUtils","DS/MPFServices/ObjectService","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a){"use strict";const o=Object.freeze({ON_SELECT:"onSelect",OPEN_DELETE_MODAL:"openDeleteModal"}),c=e.extend({className:"mpf-card-token-tile",domEvents:{click:"_onClick"},setup({creditCardToken:e,isSelected:t=!1}={}){i.requiredOfPrototype(e,n,"options.creditCardToken must be a PaymentCardTokenModel"),this.creditCardToken=e,this._isSelected=t},render({selectedCard:e}){return this.container.setContent([{tag:"div",class:"mpf-card-type-and-number",html:[{tag:"span",class:"fonticon fonticon-credit-card"},{tag:"span",text:`${this.creditCardToken.getCardType().toUpperCase()}: xxxx-xxxx-xxxx-${this.creditCardToken.getCardNumber()}`}]},{tag:"div",class:"mpf-card-holder",text:this.creditCardToken.getCardName()},{tag:"div",class:(this.creditCardToken.isExpired()," mpf-expired"),text:`${this.creditCardToken.getCardExpMonth()}/${this.creditCardToken.getCardExpYear()}`},this._createDeleteSection()]),e===this.creditCardToken?this.container.addClassName("mpf-selected"):this.container.removeClassName("mpf-selected"),this},destroy(){this.creditCardToken=null,this._parent(),this.container=null},_createDeleteSection(){return t.createElement("div",{class:"mpf-delete-section",html:this.creditCardToken.isDefaultPaymentMethod()?t.createElement("div",{class:"mpf-used-for-renewal",text:"Used for renewal"}):this._createDeleteLink()})},_createDeleteLink(){return t.createElement("a",{class:"mpf-delete-link",html:[{tag:"span",class:"fonticon fonticon-trash"},a.get("delete")],events:{click:this._openDeleteModal.bind(this)}})},_openDeleteModal(e){s.stopPropagation(e),this.dispatchEvent(o.OPEN_DELETE_MODAL)},_onClick(){this.dispatchEvent(o.ON_SELECT,{creditCardToken:this.creditCardToken})}});return c.Events=o,c}),define("DS/MPFCheckoutPage/payment/CcAvenueTile",["UWA/Class/View","DS/UIKIT/Spinner","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFCartModel/CartModel","DS/WebappsUtils/WebappsUtils","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o){"use strict";const c=Object.freeze({}),d=Object.freeze({LOADING:"loading",LOADED:"loaded",LOADING_ERROR:"loadingError"}),l=e.extend({className:"mpf-cc-avenue-tile mpf-payment-method-tile mpf-selected",setup({cart:e,paymentHelper:s,service:r,paymentResultUrl:i}={}){this.cart=e,this.paymentHelper=s,this.service=r,this.paymentResultUrl=i||this._createDefaultPaymentResultUrl(),this.state=this.cart.getState()!==n.States.PENDING_PAYMENT?d.LOADING:d.LOADED,this.spinner=new t({spin:!0,visible:!0})},render(){let e;return this.state===d.LOADING?(e=[this.spinner],this._patchInPendingPayment()):this.state===d.LOADED?this.service===i.SUBSCRIPTIONS?(e=[this.spinner],window.open(this.cart.getPaymentUrl(),"_self")):e=[this._renderIframe()]:e=this._renderLoadingErrorMessage(),this.container.setContent([this._renderHeader(),{tag:"div",class:"mpf-payment-method-tile-body",html:e}]),this},destroy(){this.paymentHelper=null,this._parent(),this.container=null},async _patchInPendingPayment(){try{await this.paymentHelper.saveQuote(),await this.paymentHelper.patchCartPaymentState({paymentResultUrl:this.paymentResultUrl}),this.state=d.LOADED,this.render()}catch(e){console.error(e),this.state=d.LOADING_ERROR,this.render()}},_renderHeader(){return{tag:"div",class:"mpf-payment-method-tile-header",html:[new s({className:"primary",value:"ccavenue",label:o.get("ccAvenue"),checked:!0}),{tag:"div",class:"mpf-icon-container",html:this._renderIcons()}]}},_renderIcons(){return[{tag:"img",class:"mpf-bank-card-icon mpf-upi-icon",src:this._getImageSourceFor("UnifiedPaymentsInterface_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-inb-icon",src:this._getImageSourceFor("IndianNetBanking_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-dinersclub-icon",src:this._getImageSourceFor("DinersClub_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-rupay-icon",src:this._getImageSourceFor("RuPay_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-visa-icon",src:this._getImageSourceFor("VISA_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-master-card-icon",src:this._getImageSourceFor("MasterCard_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-amex-card-icon",src:this._getImageSourceFor("AmericanExpress-2_512px.png")}]},_getImageSourceFor:e=>a.getWebappsAssetUrl("MPFCheckoutPage","graphics/")+e,_renderIframe(){return{tag:"iframe",src:this.cart.getPaymentUrl(),height:"435px",width:this.container.getDimensions().innerWidth}},_renderLoadingErrorMessage:()=>({tag:"div",class:"alert-message alert-error alert-has-icon mpf-loading-error-message",html:[{tag:"span",class:"icon fonticon"},{tag:"span",text:o.get("unableToLoadPaymentInterfaceError")}]}),_createDefaultPaymentResultUrl(){const e=new URL(window.location.href);return e.pathname+="/payment-result",e.toString()}});return l.Events=c,l}),define("DS/MPFCheckoutPage/orderSummary/MarketingModal",["UWA/Class/View","UWA/Core","DS/UIKIT/Modal","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFCartModel/CartItemModel","DS/MPFPortfolioModel/PortfolioHelper","DS/MPFClickAndBuyComponent/MarketingPortfolioPage"],(e,t,s,r,i,n,a,o)=>{"use strict";return e.extend({className:"mpf-marketing-modal",setup(e={}){this.item=e.item,this.modal=this._createModal()},render(){return this.container.setContent(this.modal),this._setModalBody(),this},show(){this.modal.show()},destroy(){this.modal.destroy(),this.item=null,this._parent(),this.container=null},_createModal(){return new s({className:"mpf-marketing-offer",header:{tag:"h4",text:this.item.name},events:{onHide:this.destroy.bind(this)},visible:!1})},_setModalBody(){r.mask(this.modal.getBody());const e=this.item.trigram;return a.getPortfolioRoleFromCompass(e.split("-")[0]).then(s=>{if(t.is(s.description)){const e=new o({portfolioInfo:s});r.unmask(this.modal.getBody()),this.modal.setBody(e.render())}else{const s=t.createElement("iframe",{src:"https://www.3ds.com/role/inapp/"+e+"/"});this.modal.setBody(s)}}).catch(()=>{r.unmask(this.modal.getBody())})}})}),define("DS/MPFCheckoutPage/payment/CouponInput",["UWA/String","DS/UIKIT/Input/Text","DS/MPFView/AsyncValidationTextInput","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n){"use strict";const a=Object.freeze({ON_STATE_CHANGE:"onStateChange"}),o=s.extend({className(){return this._parent()+" mpf-coupon-input"},setup({cart:e,...t}={}){this.cart=e,this._parent({...t,model:this.cart,fieldLabel:n.get("couponCode")})},destroy(){this.cart=null,this._parent(),this.container=null},_getInitialState(){const e=this.cart.getCoupon();let t;return"object"==typeof e?(t=e.validity&&!0===e.validity.isValid?s.States.VALID:s.States.INVALID,t=s.States.VALID):t=s.States.VALID,t},async _onChange(){this.changeState(s.States.LOADING);const t=this.input.getValue();try{let r;await this.cart.savePromise({[i.Fields.COUPON]:t},{patch:!0}),""===t?(r=!1,this.cart.unset(i.Fields.COUPON),this.changeState(s.States.VALID)):(r=!0,this._showSuccessStyle()),this.dispatchEvent(a.ON_STATE_CHANGE,{isCouponApplied:r})}catch(t){this.cart.unset(i.Fields.COUPON),await this.cart.savePromise({[i.Fields.COUPON]:""},{patch:!0});const r=t&&t.response;let o;o="Error.CouponCampaignClosed"===(r&&r.errorCode)?n.get("expiredCoupon"):r&&r.errorMsg?r.errorMsg:n.get("invalidCoupon"),this.changeState(s.States.INVALID,{errorMessage:o||e.format(n.get("invalidField"),this.fieldLabel)}),this.dispatchEvent(a.ON_STATE_CHANGE,{isCouponApplied:!1})}},_createInput(){const e=this.cart.getCoupon();return new t({name:i.Fields.COUPON,value:e?e.tokenUsed:"",className:s.States.DEFAULT,disabled:this.disabled,events:{onChange:this._onChange.bind(this)}})}});return o.Events=a,o}),define("DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsHelper",["DS/MPFServices/MarketplaceServices","DS/MPFShopModel/ShopServiceModel","DS/MPFTCContractModel/TCContractModel","DS/MPFTCContractModel/TCContractFactory","DS/MPFTCContractModel/SoftwareAgreementFactory","DS/MPFTcDocumentModel/TCDocumentFactory"],function(e,t,s,r,i,n){"use strict";return class{constructor({cart:e,shop:t,service:s,billingAddressHelper:r,tcContractFactory:i,tcDocumentFactory:n,softwareAgreementFactory:a}){this.cart=e,this.shop=t,this.service=s,this.billingAddressHelper=r,this.tcContractFactory=i,this.tcDocumentFactory=n,this.softwareAgreementFactory=a}fetchTcContracts({types:e}){return this.tcContracts=this.tcContractFactory.createCollection(r.Types.TERMS_AND_CONDITIONS),this.tcContracts.fetchPromise({type:e})}fetchTcDocument({type:e}){return this.tcDocumentFactory.createModel(e).fetchPromise()}fetchClosa(){return this.softwareAgreement=this.softwareAgreementFactory.createModel(i.Types.AGREEMENTS),this.softwareAgreement.fetchPromise({cartId:this.cart.get("id")})}saveTermsOfUseContract(e){return e.getCurrentState()===s.STATUS.draft?e.savePromise({[s.FIELDS.CURRENT_STATE]:s.STATUS.inEffect},{patch:!0}):Promise.resolve()}saveClosaContract({buyer:e}){return this.tcContractFactory.createModel(r.Types.EXISTING_DOCUMENT,{documentID:this.softwareAgreement.get("id"),currentState:s.STATUS.inEffect,consumerID:e.get("id"),cartItemID:this.cart.getItems()[0].get("id")}).savePromise()}_getContractType(){let t;return this.service===e.CLICK_AND_BUY&&(t=s.TcTypes.CLICKNBUY_TC),t}findContract({docType:e,buyer:t,shopOwnerId:r}){const i=t.get("id");for(let t=this.tcContracts.length-1;t>=0;t--){const n=this.tcContracts.at(t);if(n.getConsumerID()===i&&n.getDocumentType()===e&&(!r||n.getSupplierID()===r)&&n.getCurrentState()!==s.STATUS.archived&&n.getSigningRevision()===n.getActiveRevision())return n}}needsScSignature(){return!!this.scContract&&this.scContract.getCurrentState()===s.STATUS.draft}async signContracts(){const e=[];this.needsScSignature()&&e.push(this.scContract.savePromise({[s.Fields.CURRENT_STATE]:s.STATUS.inEffect},{patch:!0}))}async fetchScContractAndDoc(){let e=await this.tcContractFactory.createModel(r.Types.CUSTOM_TC_SELLER,null,{parentResourceId:this.cart.get("id")}).fetchPromise();if(!e||!e.getDocumentID()){const i=await this.tcContractFactory.createCollection(r.Types.CONSUMED_CONTRACTS).fetchPromise(),n=this.billingAddressHelper.getBuyer().get("id"),a=this.shop.get("owner").match(/[A-Z0-9]{32}$/)[0];if(e=i.find(e=>e.getConsumerID()===n&&e.getDocumentType()===s.DOCUMENT_TYPES.DEFAULT_SALES_CONDITIONS&&e.getSupplierID()===a&&e.getCurrentState()!==s.STATUS.archived&&e.getSigningRevision()===e.getActiveRevision()))e.dataProxy=this.tcContractFactory.getDataProxy(r.Types.CONTRACTS);else{const i=this.shop.getService(this.service)[t.Fields.CONTRACT_DOCUMENTS];i&&i.length>0&&(e=this.tcContractFactory.createModel(r.Types.EXISTING_DOCUMENT,{[s.Fields.DOCUMENT_ID]:i[0].id,[s.Fields.SUPPLIER_ID]:a,[s.Fields.CONSUMER_ID]:n,[s.Fields.CURRENT_STATE]:s.STATUS.draft}),await e.savePromise())}}if(e&&!e.isNew()){this.scContract=e;const t=this.tcDocumentFactory.createModel(n.Types.DOCUMENTS,{id:e.getDocumentID()});return await t.fetchPromise(),[e,t]}return[]}}}),define("DS/MPFCheckoutPage/orderSummary/CartItemList",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r){"use strict";const i=Object.freeze({}),n=Object.freeze({COLLAPSED:"collapsed",EXPANDED:"expanded"}),a=e.extend({className:"mpf-cart-item-list",setup({cart:e,state:r=n.COLLAPSED,className:i}={}){t.requiredOfPrototype(e,s,"options.cart must be a CartModel"),this.cart=e,this.state=r,i&&this.container.addClassName(i)},render(){return this.container.setContent([{tag:"div",class:"mpf-title-line",html:[{tag:"span",class:"fonticon fonticon-expand-"+(this.state===n.EXPANDED?"down":"right")},{tag:"span",text:`${r.get("items")} (${this.calculateNumberItems()})`}],events:{click:this._toggleExpand.bind(this)}},this.state===n.EXPANDED&&this.renderTable()]),this},renderTable(){},calculateNumberItems(){},destroy(){this.cart=null,this._parent(),this.container=null},_toggleExpand(){this.state=this.state===n.COLLAPSED?n.EXPANDED:n.COLLAPSED,this.render()}});return a.Events=i,a.States=n,a}),define("DS/MPFCheckoutPage/CheckoutStateMachine",["UWA/Class","UWA/Class/Events"],function(e,t){"use strict";const s=Object.freeze({}),r=e.extend(t,{init({sections:e}){this.sections=e},async loadDataAndGenerateEditIndex(){let e=1,t=!0;for(;e<=this.sections.length&&!0===t;){const s=this.sections[e];await s.load(),(t=s.isComplete())&&++e}this.editIndex=e},getEditIndex(){return this.editIndex},setEditIndex(e){if(!(e<this.editIndex))throw Error('Argument "index" bigger or equal to current editIndex.');this.editIndex=e},destroy(){this.sections=null}});return r.Events=s,r}),define("DS/MPFCheckoutPage/CheckoutTracker",["DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","DS/MPFCartModel/CartModelHelper"],function(e,t,s,r){"use strict";const i=Object.freeze({ADDRESS_PRE_CREATION:"/checkout/AddressCreation/PreCreation"}),n=Object.freeze({FORM_ERROR:"FormError",NEXT:"Next",EDIT:"Edit",PAYMENT_COMPLETED:"PaymentCompleted",PAYMENT_DECLINED:"PaymentDeclined",QUOTE_DOWNLOADED:"QuoteDownloaded",PAYMENT_INITIATED:"PaymentInitiated",BACK_TO_CART:"BackToCart"}),a=Object.freeze({PAYMENT_CARD_TOKEN:"UsePaymentCardToken",BANK_TRANSFER:"UseBankTransfer",PAYMENT_CARD:"UsePaymentCard",PAY_U:"UsePayU",COUPON:"UseCoupon"});class o{constructor({person:e,cart:t,billingAddressHelper:s,service:r}){this.person=e,this.cart=t,this.billingAddressHelper=s,this.service=r}sendPage({url:s,title:i}){const n=e.createPageBuilder({url:s}).setTitle(i);r.addTrackerInformation(n,this.cart),n.addDimension(t.MARKETPLACE_SERVICE,this.service).addDimension(t.BUYER_TYPE,this.billingAddressHelper.getBuyerType().name).addDimension(t.BUYER_ID,this.person.get("id")).send()}sendEvent(i,{label:n,token:a,paymentType:o,psp:c}={}){const d=e.createEventBuilder({category:s.CHECKOUT,action:i}).setLabel(n);r.addTrackerInformation(d,this.cart),d.addDimension(t.MARKETPLACE_SERVICE,this.service).addDimension(t.BUYER_TYPE,this.billingAddressHelper.getBuyerType().name).addDimension(t.BUYER_ID,this.person.get("id")).addDimension(t.PSP,c).addDimension(t.PAYMENT_CARD_TOKEN,a).addDimension(t.PAYMENT_METHOD,o).send()}}return o.Urls=i,o.Events=n,o.PaymentTypes=a,o}),define("DS/MPFCheckoutPage/DeleteModal",["UWA/Class/View","UWA/Core","DS/UIKIT/Alert","DS/UIKIT/Modal","DS/UIKIT/Input/Button","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n){"use strict";const a=Object.freeze({DELETION:"deletion",CANCEL_DELETION:"cancelDeletion"}),o=e.extend({className:"mpf-delete-modal",setup({isCardDeletion:e}={}){this.isCardDeletion=!0===e,this.deleteButton=this._createDeleteButton(),this.alert=this._createAlert(),this.overlay=this._createOverlay(),this.modal=this._createModal({deleteButton:this.deleteButton,alert:this.alert})},render(){return this.container.setContent([this.overlay,this.modal]),this},show(){this.overlay.show(),this.modal.show()},hide(){this.modal.hide()},showError(e){this.alert.add({message:e,className:"error"}).show()},showLoader(e=!0){this.deleteButton.load(e)},destroy(){this.stopListening(),this.deleteButton.destroy(),this.modal.destroy(),this.deleteButton=null,this.modal=null,this._parent(),this.container=null},_createAlert:()=>new s({visible:!1,autoHide:!0,hideDelay:6e3}),_createDeleteButton(){return new i({className:"error",value:n.get("delete"),events:{onClick:this._addressDeletion.bind(this)}})},_addressDeletion(){this.dispatchEvent(a.DELETION)},_createOverlay(){const e=t.createElement("div",{class:"modal-overlay"});return e.hide(),e},_createModal({deleteButton:e,alert:t}){return new r({className:"mpf-delete-modal",closable:!0,overlay:!0,header:[{tag:"h4",text:this.isCardDeletion?n.get("deleteCard"):n.get("deleteAddress")}],body:[t,{tag:"div",text:this.isCardDeletion?n.get("confirmDeletionCard"):n.get("confirmDeletionAddress")}],footer:e,events:{onHide:()=>{this.overlay.hide(),this.dispatchEvent(a.CANCEL_DELETION)}}})}});return o.Events=a,o}),define("DS/MPFCheckoutPage/payment/PaymentHelper",["DS/MPFServices/MarketplaceServices","DS/MPFCartModel/CartModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPspModel/PspModel","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFVirtualIbanModel/VirtualIbanFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/MPFCartPaymentModel/WaitForPaymentFactory"],function(e,t,s,r,i,n,a,o,c){"use strict";const d=new Map;d.set("3DS-EUR",r.Platform.STRIPE_EU),d.set("3DS-GBP",r.Platform.STRIPE_EU),d.set("3DS-AUD",r.Platform.STRIPE_AUSTRALIA),d.set("3DS-JPY",r.Platform.STRIPE_JAPAN);return class{constructor({cart:e,phase:t,psp:s,cartQuote:r,paymentCardTokenFactory:i,virtualIbanFactory:n,purchaseOrderFactory:a,purchaseOrderDocumentFactory:o,waitForPaymentFactory:c,billingAddressHelper:d,service:l}){this.cart=e,this.phase=t,this.psp=s,this.cartQuote=r,this.virtualIbanFactory=n,this.paymentCardTokenFactory=i,this.purchaseOrderFactory=a,this.purchaseOrderDocumentFactory=o,this.waitForPaymentFactory=c,this.billingAddressHelper=d,this.service=l}async loadData(){this.creditCardTokens=this._createCardTokens({cart:this.cart,paymentCardTokenFactory:this.paymentCardTokenFactory,service:this.service}),this.purchaseOrder=this.purchaseOrderFactory.createModel(n.Types.CART_PURCHASE_ORDER,null,{parentResourceId:this.cart.get("id")});const s=this.isCartPaid()&&this.cart.getPaymentMethod()===t.PaymentMethods.DEFERRED_BANK_TRANSFER;return await Promise.all([this.psp.fetchPromise(),this.creditCardTokens.fetchPromise(),s&&this.purchaseOrder.fetchPromise()]),this.creditCardTokens.parentResourceId&&this.creditCardTokens.forEach(e=>{e.parentResourceId=this.creditCardTokens.parentResourceId}),this.billingAddressHelper.isCompanyBuyer()||this.creditCardTokens.reset(this.creditCardTokens.filter(e=>!e.getCardBelongsToCompanyId())),this.hasBankTransferOption()&&[e.CLICK_AND_BUY,e.INNOVATE,e.IFWELOOP,e.SUBSCRIPTIONS].includes(this.service)&&(this.virtualIbans=this.virtualIbanFactory.createCollection(a.Types.COMPANY,[],{parentResourceId:this.cart.getCompanyID()}),await this.virtualIbans.fetchPromise({currency:this.cart.getCurrency()})),this.service===e.MAKE&&(this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(o.Types.CART_PURCHASE_ORDER_DOCUMENT,null,{parentResourceId:this.cart.get("id")})),{psp:this.psp,creditCardTokens:this.creditCardTokens,purchaseOrder:this.purchaseOrder,purchaseOrderDocument:this.purchaseOrderDocument,virtualIbans:this.virtualIbans}}async getCreditCardTokens(){return this.creditCardTokens=this._createCardTokens({cart:this.cart,paymentCardTokenFactory:this.paymentCardTokenFactory,service:this.service}),this.creditCardTokens=await this.creditCardTokens.fetchPromise(),this.creditCardTokens.parentResourceId&&this.creditCardTokens.forEach(e=>{e.parentResourceId=this.creditCardTokens.parentResourceId}),this.creditCardTokens}isCartPaid(){if(this.service!==e.ENGINEERING){const e=this.cart.getState();return e===t.States.PAYMENT_COMPLETE||e===t.States.PAYMENT_ACCEPTED}}usesPaymentPageRedirection(){return this.psp.usesPaymentPageRedirection()}async patchPaymentMethod(){await this.cart.savePromise({[t.Fields.PAYMENT_METHOD]:this.cart.getPaymentMethod()},{patch:!0})}async patchCartPaymentState({selectedToken:e,saveCardToken:s,stripeToken:r,paymentResultUrl:i}={}){const n=this.cart.getState(),a={};n!==t.States.PENDING_PAYMENT&&n!==t.States.PAYMENT_INITIATED&&n!==t.States.PAYMENT_REFUSED&&(a[t.Fields.STATE]=t.States.PENDING_PAYMENT),e&&(a.CreditCardTokenId=e.getCardId()),s&&(a.CreditCardTokenMultiUse="1"),r&&(a.payment_token=r.id),i&&(a.cartContextUrl=i);try{await this.cart.savePromise(a,{patch:!0})}catch(e){if(!e.response||"error.pastenddate"!==e.response.errorCode||a[t.Fields.STATE]!==t.States.PENDING_PAYMENT)throw e;await this.cart.savePromise({[t.Fields.STATE]:t.States.SUBMITTED,[t.Fields.BILL_TO]:this.cart.get(t.Fields.BILL_TO)},{patch:!0}),await this.cart.savePromise(a,{patch:!0})}}async payByInvoice({file:e,uploadLater:s=!1}={}){const r=this.cart.getPendingChanges();await this.cart.savePromise({[t.Fields.PAYMENT_METHOD]:this.cart.getPaymentMethod()},{patch:!0}),await this.saveQuote(),s?await this.cart.savePromise({[t.Fields.BLOCKED]:"TRUE"},{patch:!0,partialRefresh:!0}):(e&&this.purchaseOrderDocument&&(await this.purchaseOrderDocument.saveFile(e),this.purchaseOrder.setDocumentId(this.purchaseOrderDocument.id)),this.purchaseOrder.getNumber()&&await this.purchaseOrder.savePromise(),await this.cart.savePromise({...r,[t.Fields.STATE]:t.States.PAYMENT_ACCEPTED},{patch:!0}))}async saveQuote(){await this.cartQuote.fetchPromise(),await this.cartQuote.savePromise({[s.Fields.STATE]:"ACCEPTED"},{patch:!0})}waitForPaymentCompletion(){let t;return this.service!==e.ENGINEERING&&(t=this.waitForPaymentFactory.createModel(c.Types.CART,null,{parentResourceId:this.cart.get("id")})),t.fetchPromise()}getPlatform(){const e=this.psp&&this.psp.getCountryPlatform();if(e)return e;{const e=this.virtualIbans&&this.virtualIbans.first(),t=e&&e.getExternalReference();return d.get(t)||r.Platform.STRIPE_US}}showCouponSection(){return this.service===e.MAKE&&this.psp.getPsp()===r.Psp.STRIPE}isRecurringPurchase(){return(this.service===e.CLICK_AND_BUY||this.service===e.SUBSCRIPTIONS||this.service===e.INNOVATE||this.service===e.IFWELOOP)&&!this.cart.hasEduItems()}hasBankTransferOption(){return this.psp.isBankTransferEnabled()&&this.billingAddressHelper.isCompanyBuyer()}isBankTransferDisabled(){return this.psp.doesPriceExceedBtMax({price:this.cart.getGrossAmountTotal()})}getTotalPrice(){return this.service===e.ENGINEERING?this.phase.getTotalGrossAmount():parseFloat(this.cart.getGrossAmountTotal())}getTotalPriceMinusCoupon(){if(this.service===e.ENGINEERING)return this.phase.getTotalGrossAmount();{const e=this.cart.getCoupon();return e?parseFloat(e.totalToPay):parseFloat(this.cart.getGrossAmountTotal())}}_createCardTokens({cart:e,paymentCardTokenFactory:t,service:s}){let r,n;if(this.billingAddressHelper.isCompanyBuyer()){r=i.Types.COMPANY;const e=this.billingAddressHelper.getBuyer().get("id");e&&(n={parentResourceId:e})}else r=i.Types.ME;return t.createCollection(r,[],n)}async deleteCard({cardToDelete:e}={}){await e.destroyPromise()}}}),define("DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsSection",["UWA/Core","UWA/Event","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/MPFCheckoutPage/CheckoutSection","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsHelper","DS/MPFCheckoutPage/IconLink","DS/MPFCheckoutPage/CheckoutTracker","i18n!DS/MPFCheckoutPage/assets/nls/TermsAndConditions"],function(e,t,s,r,i,n,a,o,c,d,l,h){"use strict";const p=Object.freeze({...i.Events}),u=Object.freeze({ACKNOWLEDGMENT:"Acknowledgment",LINK:"CheckoutLink"}),m=i.extend({setup({index:e,className:t,cart:s,termsAndConditionsHelper:r,billingAddressHelper:i,tracker:d}={}){n.requiredOfPrototype(s,a,"options.cart must be a CartModel"),n.requiredOfPrototype(r,c,"options.termsAndConditionsHelper must be a TermsAndConditionsHelper"),n.requiredOfPrototype(i,o,"options.billingAddressHelper must be a BillingAddressHelper"),this.cart=s,this.termsAndConditionsHelper=r,this.billingAddressHelper=i,this.tracker=d,this._parent({title:h.get("termsAndConditions"),className:"mpf-terms-and-conditions-section"+(t?" "+t:""),index:e})},isComplete(){},load(){},renderContent(){},saveContracts(){},shouldPaymentSectionBeDisplayed(){},async save(){s.mask(this.container);try{await this.saveContracts(),s.unmask(this.container),this.tracker.sendEvent(l.Events.NEXT,{label:"TermsAndConditionsSection"}),this.dispatchEvent(i.Events.NEXT_SECTION)}catch(e){s.unmask(this.container),console.error(e),this.showError(h.get("unabletoSaveAgreement"))}},onToggleChange(){this.shouldPaymentSectionBeDisplayed()&&(this.tracker.sendEvent(u.ACKNOWLEDGMENT),this.save())},createLink:({href:t,text:s,trackerLabel:r})=>e.createElement("a",{target:"_blank",href:t,text:s,"data-tracker-label":r}),renderWriteMode(){return[this.renderContent({isWriteMode:!0})]},renderReadMode(){return[this.renderContent({isWriteMode:!1})]},destroy(){this.stopListening(),this.cart=null,this.termsAndConditionsHelper=null,this.billingAddressHelper=null,this._parent(),this.container=null}});return m.Events=p,m.TrackerEvents=u,m}),define("DS/MPFCheckoutPage/termsAndConditions/IfweloopTermsAndConditionsSection",["DS/UIKIT/Input/Toggle","DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsSection","i18n!DS/MPFCheckoutPage/assets/nls/TermsAndConditions"],function(e,t,s){"use strict";const r=Object.freeze({}),i=t.extend({setup(e){this._parent({className:"mpf-ifweloop-terms-and-conditions",...e}),this.toggle=this._createToggle(),this.isAccepted=!1},isComplete(){return this.isAccepted},load:()=>!0,renderContent({isWriteMode:e}){return e?this.toggle.enable():this.toggle.disable(),[{tag:"div",class:"mpf-toggle-and-text",html:[this.toggle,{tag:"div",class:"mpf-ifweloop-tnc-text",html:"coucou"}]}]},async saveContracts(){await this.termsAndConditionsHelper.saveClosaContract({buyer:this.billingAddressHelper.getBuyer()}),this.isAccepted=!0},shouldPaymentSectionBeDisplayed(){return this.toggle.isChecked()},destroy(){this.toggle=null,this._parent()},_createToggle(){return new e({type:"switch",className:"primary",value:"",events:{onChange:this.onToggleChange.bind(this)}})}});return i.Events=r,i}),define("DS/MPFCheckoutPage/payment/PaymentMethodTile",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCheckoutPage/payment/PaymentHelper","DS/MPFUtils/FormatUtils","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o,c){"use strict";const d=Object.freeze({ON_SELECTED:"onSelected",LOAD:"load",ON_PAYMENT_DONE:"onPaymentDone",ON_ERROR:"onError"}),l=t.extend({className:"mpf-payment-method-tile",setup({cart:e,paymentHelper:t,paymentMethod:s,title:r,buttonLabel:o=c.get("confirmOrder"),className:d,isDisabled:l=!1}={}){i.requiredOfPrototype(e,n,"options.cart must be a CartModel"),i.requiredOfPrototype(t,a,"options.paymentHelper must be a PaymentHelper"),i.requiredOfType(s,"string","options.paymentMethod must be a string"),i.requiredOfType(r,"string","options.title must be a string"),this.cart=e,this.paymentMethod=s,this.paymentHelper=t,this.title=r,this._isDisabled=l,this.toggle=this._createToggle({isDisabled:l}),this.confirmButton=this._createConfirmButton({buttonLabel:o}),d&&this.container.addClassName(d)},renderIcons(){},renderBody(){},pay:()=>Promise.resolve(),enablePaymentButton(){this.confirmButton.enable()},disablePaymentButton(){this.confirmButton.disable()},disable(e=!0){this._isDisabled=e,this.toggle.setDisabled(e)},render(){const e=this.paymentHelper.isCartPaid(),t=this._isSelected(),s=[{tag:"div",class:this._getHeaderClassName({isCartPaid:e,isSelected:t}),html:[this.toggle,{tag:"div",class:"mpf-icon-container",html:this.renderIcons({isSelected:t})}],events:{click:()=>{e||this._isSelected()||this._isDisabled||(this.cart.setPaymentMethod(this.paymentMethod),this.dispatchEvent(d.ON_SELECTED))}}}];return t?(this.toggle.check(),this.container.addClassName("mpf-selected"),s.push({tag:"div",class:"mpf-payment-method-tile-body",html:this.renderBody()}),s.push({tag:"div",class:"mpf-payment-method-tile-footer",html:this.renderFooter()})):(this.toggle.uncheck(),this.container.removeClassName("mpf-selected")),this.container.setContent(s),this},renderFooter(){return[{tag:"div",class:"mpf-total-container",html:[{tag:"span",class:"mpf-total-label",text:c.get("orderTotal")},{tag:"span",class:"mpf-total-price",text:o.formatPrice(this.paymentHelper.getTotalPriceMinusCoupon(),{currency:this.cart.getCurrency()})}]},this.confirmButton]},destroy(){this.cart=null,this._parent(),this.container=null},_isSelected(){const e=this.cart.getPaymentMethod();return e&&e===this.paymentMethod},_getHeaderClassName({isCartPaid:e,isSelected:t}){let s="mpf-payment-method-tile-header";return e||t||this._isDisabled?this._isDisabled&&(s+=" mpf-disabled"):s+=" mpf-clickable",s},_createToggle({isDisabled:e}){return new s({className:"primary",value:this.title,label:this.title,disabled:e})},_createConfirmButton({buttonLabel:t}){return new r({className:"primary",value:t,events:{onClick:async()=>{this.dispatchEvent(d.LOAD);try{await this.pay(),!this.paymentHelper.usesPaymentPageRedirection()&&this.dispatchEvent(d.ON_PAYMENT_DONE)}catch(t){console.error(t&&t.response?t.response:t);const s=t&&t.response&&t.response.errorMsg,r=t&&t.response&&t.response.errorCode||t&&t.decline_code||t&&t.code;let i;i=s&&"Error.BankTransferNotAllowed"===r?s:"insufficient_funds"===r?c.get("insufficientFundsError"):"expired_card"===r?c.get("expiredCardError"):c.get("paymentErrorMessage",{link:e.createElement("a",{href:"https://www.3ds.com/online-store/support-form/",target:"_blank",text:c.get("support")}).outerHTML}),this.dispatchEvent(d.ON_ERROR,{errorCode:r,message:i})}}}})}});return l.Events=d,l}),define("DS/MPFCheckoutPage/billingAddress/TaxIdInput",["UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressModel","DS/MPFCountryModel/CountryCollection","DS/MPFView/AsyncValidationTextInput","DS/MPFCheckoutPage/billingAddress/VatIdRules","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d){"use strict";const l=Object.freeze({ON_CHANGE:"onChange"}),h=e.extend({className:"mpf-tax-id-input mpf-entry-v2",setup({company:e,companyFactory:t,address:o,countries:c,service:d}={}){s.requiredOfPrototype(e,r,"company must be a CompanyModel"),s.requiredOfPrototype(t,i,"companyFactory must be a CompanyFactory"),s.requiredOfPrototype(o,n,"address must be an AddressModel"),s.requiredOfPrototype(c,a,"countries must be a CountryCollection"),this.company=e,this.companyFactory=t,this.address=o,this.countries=c,this.service=d,this.textInput=this._createTextInput(),this.noVatIdToggle=this._createNoVatIdToggle(),this.specialEconomicZoneToggle=this._createSpecialEconomicZoneToggle(),this.showVatIdInput=!1},render(){return this.container.setContent([this.textInput.render(),{tag:"div",class:"mpf-toggles-tile",html:[this.noVatIdToggle,this.specialEconomicZoneToggle]}]),this.applyCountryFormat(),this},isValid(){const e=this.textInput.isValid(),t=this.noVatIdToggle.isChecked();return!this.showVatIdInput||this.showVatIdInput&&(e||t)},isNoVatIdToggleChecked(){return this.noVatIdToggle.isChecked()},isSpecialEconomicZoneChecked(){return this.specialEconomicZoneToggle.isChecked()},destroy(){this.stopListening(),this.textInput.destroy(),this.textInput=null,this.noVatIdToggle=null,this.company=null,this.companyFactory=null,this.address=null,this._parent(),this.container=null},applyCountryFormat(){this.textInput.reset(),this.noVatIdToggle.uncheck();const e=c.getCountryRules({country:this.address.getCountry(),countries:this.countries,service:this.service});if(this.showVatIdInput=e.showVatIdInput,this.showVatIdInput){const t=d.get(e.vatIdLabel);if(this.textInput.setLabel(t),e.showNoVatIdToggle){this.textInput.setRequired(!0),this.noVatIdToggle.isChecked()?this.textInput.disable():this.textInput.enable();const s=e.noVatIdToggleLabel?d.get(e.noVatIdToggleLabel):d.get("noVatId+Label",{label:t});this.noVatIdToggle.setValue(s),this.noVatIdToggle.show()}else this.textInput.enable(),this.textInput.setRequired(e.required),this.noVatIdToggle.hide();e.showSpecialEconomicZoneToggle?this.specialEconomicZoneToggle.show():this.specialEconomicZoneToggle.hide(),this.container.show()}else this.container.hide()},_onVatIdToggleChange(){this.noVatIdToggle.isChecked()?(this.textInput.reset(),this.textInput.setRequired(!1),this.textInput.disable()):(this.textInput.setRequired(!0),this.textInput.enable()),this.dispatchEvent(l.ON_CHANGE)},async _checkVatId(){if(this.company.getTaxRegistrationId()){const e=this.companyFactory.createModel(i.Types.CHECK_VAT,{[r.Fields.NAME]:"VAT IT test",[r.Fields.COUNTRY]:this.company.getCountry()||this.address.getCountry(),[r.Fields.VAT_ID]:this.company.getTaxRegistrationId()});return await e.savePromise(null),{isValid:!0===e.get("valid"),errorMessage:e.get("message")}}return{isValid:!0}},_createTextInput(){const e=new o({model:this.company,fieldName:r.Fields.TAX_REGISTRATION_ID,fieldLabel:d.get("taxRegistrationId"),asyncValidation:this._checkVatId.bind(this),required:!0,useModelValidation:!1});return this.listenTo(e,o.Events.VALIDATION_STATE_CHANGE,this.dispatchEvent.bind(this,l.ON_CHANGE)),e},_createNoVatIdToggle(){return new t({className:"primary mpf-toggle",type:"checkbox",value:d.get("noVatId+Label",{label:d.get("taxRegistrationId")}),events:{onChange:this._onVatIdToggleChange.bind(this)}})},_createSpecialEconomicZoneToggle:()=>new t({className:"primary mpf-toggle",type:"checkbox",value:d.get("specialEconomicZone")})});return h.Events=l,h}),define("DS/MPFCheckoutPage/payment/BankTransferTile",["UWA/Core","DS/UIKIT/Popover","DS/WebappsUtils/WebappsUtils","DS/MPFUtils/StorageUtils","DS/MPFCheckoutPage/payment/PaymentMethodTile","DS/MPFCartModel/CartModel","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a){"use strict";const o=i.extend({setup({cart:e,paymentHelper:t,className:s}={}){this.cart=e,this.paymentHelper=t,this._parent({cart:e,paymentHelper:t,paymentMethod:n.PaymentMethods.DEFERRED_BANK_TRANSFER,className:"mpf-bank-transfer-tile"+(s?" "+s:""),title:a.get("paymentViaInvoice"),isDisabled:this.paymentHelper.isBankTransferDisabled()})},renderIcons(){return[this.paymentHelper.isBankTransferDisabled()&&this._renderDisabledIcon(),{tag:"img",class:"mpf-bank-transfer-icon",src:s.getWebappsAssetUrl("MPFCheckoutPage","graphics/BankTransfer_512px.png")}]},renderBody(){},async pay(){},destroy(){this.cart=null,this.paymentHelper=null,this._parent(),this.container=null},_renderDisabledIcon(){const s=e.createElement("span",{class:"mpf-disabled-info-icon fonticon fonticon-info"});return this.popover=new t({target:s,trigger:"hover touch",position:"left",body:a.get("btPaymentPriceTooHighInfo",{amount:parseFloat(this.psp.getBankTransferThreshold()).toLocaleString(r.getLanguageCookie(),{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})})}),s}});return o.Events=i.Events,o}),define("DS/MPFCheckoutPage/termsAndConditions/MakeTermsAndConditionsSection",["DS/UIKIT/Input/Toggle","DS/MPFTCContractModel/TCContractModel","DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsSection","i18n!DS/MPFCheckoutPage/assets/nls/TermsAndConditions"],function(e,t,s,r){"use strict";const i=Object.freeze(),n=s.extend({setup(e){this.shop=e.shop,this._parent({className:"mpf-make-terms-and-conditions",...e}),this.toggle=this._createToggle(),this.isAccepted=!1},async load(){[this.scContract,this.scDocument]=await this.termsAndConditionsHelper.fetchScContractAndDoc()},isComplete(){return this.isAccepted&&(!this.scContract||this.scContract.getCurrentState()===t.STATUS.inEffect)},renderContent({isWriteMode:e}){return e?this.toggle.enable():(this.isComplete()?this.toggle.check():this.toggle.uncheck(),this.toggle.disable()),[this.toggle,this._renderText()]},shouldPaymentSectionBeDisplayed(){return this.toggle.isChecked()},async saveContracts(){await this.termsAndConditionsHelper.signContracts(),this.isAccepted=!0},destroy(){this.toggle=null,this.tcDocument=null,this.softwareAgreement=null,this.tcContract=null,this.ppContract=null,this.shop=null,this._parent()},_renderText(){return{tag:"div",class:"mpf-sales-conditions-label",html:[this.scDocument?r.get("agreeSalesConditionsProvidedBy",{salesConditions:this.createLink({href:this.scDocument.getDocUrl(),text:r.get("salesConditionsLabel")}),shopName:this.shop.getName()}):r.get("agreeQuotation")]}},_createToggle(){return new e({type:"switch",className:"primary",value:"",events:{onChange:()=>{this.isChecked=this.toggle.isChecked(),this.onToggleChange()}}})}});return n.Events=i,n}),define("DS/MPFCheckoutPage/phoneNumber/PhoneNumberSection",["UWA/Core","DS/UIKIT/Input/Button","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFAddressModel/AddressModel","DS/MPFConstraintModel/ConstraintModel","DS/MPFAddressModel/AddressFactory","DS/MPFCheckoutPage/CheckoutSection","DS/MPFCheckoutPage/IconLink","DS/MPFCheckoutPage/phoneNumber/PhoneNumberInput","DS/MPFCheckoutPage/CheckoutTracker","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage","css!DS/MPFCheckoutPage/MPFCheckoutPage"],(e,t,s,r,i,n,a,o,c,d,l,h)=>{"use strict";return o.extend({setup(e){this._parent({title:h.get("contact"),className:"mpf-phone-number-section",index:e.index}),this.billingAddressHelper=e.billingAddressHelper,this.person=e.person,this.psp=e.psp,this.cart=e.cart,this.addressFactory=e.addressFactory,this.tracker=e.tracker,this.editLink=this._createEditLink(),this.fullName=this._createFullName(),this.saveButton=this._createSaveButton(),this.cancelButton=this._createCancelButton(),this.phoneNumberField=this._createPhoneNumberField()},async load(){this.address=this.addressFactory.createModel(a.Types.ADDRESS,{id:this.cart.get(r.Fields.BILL_TO)}),await Promise.all([this.psp.fetchPromise(),this.address.fetchPromise()])},renderAdditionalHeaderContent({state:e}){if(e===o.States.READ)return this.editLink.render()},renderReadMode(){const e=this.person.getPhoneNumber();return[this.fullName,{tag:"p",class:"mpf-line",html:[{tag:"span",class:"mpf-label",text:h.get("phoneNumber")+h.get(":")},{tag:"span",class:"mpf-value"+(e?"":" mpf-italic"),text:this.person.getPhoneNumber()||h.get("notAvailable")}]}]},renderWriteMode(){const e=this.address.getCountry(),t=this.addressFactory.addressesConstraints.get(e).clone();if(this.psp.isCcAvenue()){t.get(i.Fields.PHONE_NUMBER).set(n.Fields.REQUIRED,!0)}const s=this.person.getPhoneNumber(),r=!this.psp.isCcAvenue()||s;return this.phoneNumberField.address.set({[i.Fields.PHONE_NUMBER]:s,[i.Fields.COUNTRY]:this.address.getCountry()}),[this.fullName,this.phoneNumberField.render({countryConstraints:t}),{tag:"div",class:"mpf-button-container",html:[r&&this.cancelButton,this.saveButton]}]},isComplete(){const e=this.person.getPhoneNumber();return e&&e.length>0||!this.psp.isCcAvenue()},destroy(){this.stopListening(),this.phoneNumberField.destroy(),this.editLink.destroy(),this.phoneNumberField=null,this.editLink=null,this.fullName=null,this.saveButton=null,this.cancelButton=null,this.person=null,this.psp=null,this.cart=null,this.address=null,this.addressFactory=null,this.tracker=null,this._parent(),this.container=null},_onChange(){this.phoneNumberField.isValid()?this.saveButton.enable():this.saveButton.disable()},_createEditLink(){const e=new c({text:h.get("edit"),icon:"pencil"});return this.listenTo(e,c.Events.ON_CLICK,()=>{this.tracker.sendEvent(l.Events.EDIT,{label:"phoneNumberSection"}),this.toEditMode()}),e},_createFullName(){return e.createElement("p",{class:"mpf-line mpf-full-name",text:this.person.getFullName()})},_createPhoneNumberField(){const e=this.addressFactory.createModel(a.Types.ADDRESS,{[i.Fields.PHONE_NUMBER]:this.person.getPhoneNumber()}),t=new d({billingAddressHelper:this.billingAddressHelper,cart:this.cart,psp:this.psp,address:e});return this.listenTo(t,d.Events.ON_CHANGE,this._onChange.bind(this)),t},_createSaveButton(){return new t({value:h.get("save"),className:"primary",disabled:!0,events:{onClick:this.onSave.bind(this)}})},_createCancelButton(){return new t({value:h.get("cancel"),events:{onClick:this.next.bind(this)}})},async onSave(){try{await this.person.savePromise({[s.Fields.PHONE_NUMBER]:this.phoneNumberField.getValue()},{patch:!0}),await this.person.fetchPromise(),this.next()}catch(e){this.showError(h.get("errorPhoneNumberSave"))}}})}),define("DS/MPFCheckoutPage/payment/SelectedCardTokenTile",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFCheckoutPage/payment/PaymentHelper","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","DS/MPFStripeComponent/StripePaymentHelper","DS/MPFStripeComponent/StripeBadge","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o,c){"use strict";const d=Object.freeze({}),l=e.extend({className:"mpf-selected-card-token-tile",setup({cart:e,paymentHelper:n,psp:a}){t.requiredOfPrototype(e,s,"options.cart must be a CartModel"),t.requiredOfPrototype(n,i,"options.paymentHelper must be a PaymentHelper"),t.requiredOfPrototype(a,r,"options.psp must be a PspModel"),this.cart=e,this.paymentHelper=n,this.psp=a,this.badge=new o},render({token:e}){t.requiredOfPrototype(e,n,"options.token must be a PaymentCardTokenModel"),this.token=e;const s=e.isExpired();return this.container.setContent([s&&this._renderCardExpiryMessage(),{tag:"div",class:"mpf-column-container",html:[{tag:"div",class:"mpf-left-column",html:[{tag:"div",class:"mpf-card-name-line",text:e.getCardName()},{tag:"div",class:"mpf-card-number-line",html:[{tag:"span",class:"fonticon fonticon-credit-card"},{tag:"span",text:`${e.getCardType().toUpperCase()}: **** **** **** - ${e.getCardNumber()}`}]},{tag:"div",class:"mpf-card-expiry-date-line"+(s?" mpf-expired":""),html:[{tag:"span",class:"mpf-label",text:c.get("expiry")},{tag:"span",class:"mpf-expiry-date",text:e.getCardExpMonth()+"/"+e.getCardExpYear()}]}]},{tag:"div",class:"mpf-right-column",html:[this.badge.render()]}]}]),this},async pay(){if(this.psp.getPsp()===r.Psp.STRIPE&&this.psp.isScaEnabled()){"function"!=typeof Stripe&&await this._loadStripe(),this.stripe||(this.stripe=Stripe(this.psp.getPublicKey()));const e=await this.stripe.handleCardPayment(this.cart.getPaymentIntentSecret(),{payment_method:this.token.getPaymentMethodId()});if(e.error)return Promise.reject(e.error)}},destroy(){this.cart=null,this.paymentHelper=null,this.psp=null,this.token=null,this.stripe=null,this._parent(),this.container=null},_loadStripe(){return new Promise((e,t)=>{const s=a.createStripeScriptTag({onLoad:e,onError:t});this.container.addContent(s)})},_renderCardExpiryMessage:()=>({tag:"div",class:"alert-message alert-warning alert-has-icon mpf-cart-expiry-message",html:[{tag:"span",class:"icon fonticon"},{tag:"span",text:c.get("cardExpiryMessage")}]})});return l.Events=d,l}),define("DS/MPFCheckoutPage/payment/CabBankTransferTile",["UWA/Core","DS/MPFCheckoutPage/payment/BankTransferTile","DS/MPFServices/MarketplaceServices","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFView/FieldTextInputV2","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o,c){"use strict";const d=t.extend({setup({cart:e,psp:t,virtualIbans:s,purchaseOrder:i,paymentHelper:n,tracker:a,service:o}={}){this.psp=t,this.virtualIbans=s,this.purchaseOrder=i,this.service=o,this.tracker=a,this._parent({cart:e,paymentHelper:n,paymentMethod:r.PaymentMethods.DEFERRED_BANK_TRANSFER,className:"mpf-cab-bank-transfer-tile"}),this.textInput=this._createTextInput()},renderBody(){return[this._renderText(),this._renderBankAccountInfo(),this.textInput.render(),this._renderInfoSentence()]},async pay(){this.tracker.sendEvent(a.Events.PAYMENT_INITIATED,{paymentType:a.PaymentTypes.BANK_TRANSFER}),await this.paymentHelper.payByInvoice()},destroy(){this.cart=null,this.psp=null,this.virtualIbans=null,this.paymentHelper=null,this._parent(),this.container=null},_renderText:()=>({tag:"div",html:[{tag:"p",text:c.get("cabBankTransferInfo_1")},{tag:"p",html:c.get("cabBankTransferInfo_2",{bold3D:e.createElement("b",{text:"3D"}).outerHTML})},{tag:"p",text:c.get("cabBankTransferInfo_3")}]}),_renderBankAccountInfo(){function e(e){return{tag:"span",class:"mpf-bank-account-info-label",text:e}}function t(e){return{tag:"span",class:"mpf-bank-account-info-value",text:e}}const s=this.paymentHelper.getPlatform(),r=this.virtualIbans.first(),n=s===i.Platform.STRIPE_EU||s===i.Platform.STRIPE_GB,a=n?c.get("iban"):c.get("accountNumber"),o=n?r.getIban():r.getAccountNumber(),d=s===i.Platform.STRIPE_US;return{tag:"div",class:"mpf-bank-account-info",content:[e(c.get("accountName")),t(r.getAccountName()),e(c.get("swiftbic")),t(r.getBic()),e(c.get("bankName"),r.getBankName()),t(r.getBankName()),e(a),t(o),d&&e(c.get("routingNumber")),d&&t(r.getRoutingNumber())]}},_createTextInput(){const e=new o({model:this.purchaseOrder,fieldName:n.Fields.NUMBER,fieldLabel:c.get("yourReferenceToMentionOnInvoice"),readOnly:this.paymentHelper.isCartPaid(),dynamicValidation:!0,maxlength:30,placeholder:c.get("yourReference"),required:this.service!==s.IFWELOOP&&this.service!==s.CLICK_AND_BUY});return this.listenTo(e,o.Events.UPDATE,()=>{e.isValid()?this.enablePaymentButton():this.disablePaymentButton()}),e},_renderInfoSentence(){if(this.service===s.CLICK_AND_BUY)return{tag:"p",html:c.get("cabBankTransferInfo_4",{bold3D:e.createElement("b",{text:"3D"}).outerHTML})}}});return d.Events=t.Events,d}),define("DS/MPFCheckoutPage/billingAddress/BillingAddressForm",["UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/MPFUtils/StorageUtils","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFCompanyModel/CompanyDataProxy","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressFactory","DS/MPFCountryModel/CountryCollection","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFBuyer/BuyerType","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFPersonComponent/PersonNameForm","DS/MPFCompanyComponent/CompanyNameInput","DS/MPFCompanyComponent/CompanyTaxRegistrationIdInput","DS/MPFCheckoutPage/billingAddress/TaxIdInput","DS/MPFAddressFormComponent/AddressFormComponentV3","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m,y,g,C,P,S,T,A){"use strict";const E=Object.freeze({CANCEL:"cancel",ADDRESS_SAVED:"addressSaved",ON_ERROR:"onError",ON_BACKGROUND_VALIDATION:"onBackgroundValidation"}),M=e.extend({className:"mpf-billing-address-form mpf-horizontal",setup({service:e,person:t,company:s,companyFactory:r,addressFactory:n,countries:a,billingAddressHelper:l,tracker:m}={}){i.requiredOfPrototype(t,o,"person must be a PersonModel"),i.requiredOfPrototype(r,d,"companyFactory must be a CompanyFactory"),i.requiredOfPrototype(n,h,"addressFactory must be a AddressFactory"),i.requiredOfPrototype(a,p,"countries must be a CountryCollection"),i.requiredOfPrototype(l,u,"billingAddressHelper must be a BillingAddressHelper"),s&&(i.requiredOfPrototype(s,c,"company must be a CompanyModel"),this.company=s),this.service=e,this.person=t,this.companyFactory=r,this.addressFactory=n,this.countries=a,this.billingAddressHelper=l,this.tracker=m,this.buyerTypeInput=this._createBuyerTypeInput(),this.cancelButton=this._createCancelButton(),this.nextButton=this._createNextButton()},render({isNewAddress:e}){const t=this.billingAddressHelper.getSelectedAddress();this.address=e||!t?this.billingAddressHelper.createBillingAddress():t,this._destroyExistingForms(),this.buyerForm=this._createBuyerForm(),this.addressForm=this._createAddressForm(),this.taxIdInput=this.billingAddressHelper.isCompanyBuyer()&&this._createTaxIdInput();const s=this.billingAddressHelper.getValidBillingAddresses().length>0;this.nextButton.setValue(s?A.get("save"):A.get("next"));const r=this.billingAddressHelper.isBillingInfoComplete();return this.container.setContent([this._renderOptionalInfoMessage(),this.billingAddressHelper.isBuyerTypeEditable()&&this.buyerTypeInput.render(),this.buyerForm.render(),this.addressForm.render(),this.taxIdInput?this.taxIdInput.render():"",{tag:"div",class:"mpf-address-form-footer",html:[this.nextButton,r&&this.cancelButton]}]),this._computeBackgroundValidation(),this},destroy(){this.stopListening(),this.buyerTypeInput.destroy(),this._destroyExistingForms(),this.nextButton.destroy(),this.cancelButton&&this.cancelButton.destroy(),this.buyerTypeInput=null,this.addressForm=null,this.taxIdInput=null,this.nextButton=null,this.cancelButton=null,this.billingAddressHelper=null,this.person=null,this.company=null,this.address=null,this.countries=null,this.companyFactory=null,this._parent(),this.container=null},_destroyExistingForms(){this.buyerForm&&(this.stopListening(this.buyerForm),this.buyerForm.destroy()),this.addressForm&&(this.stopListening(this.addressForm),this.addressForm.destroy()),this.taxIdInput&&(this.stopListening(this.taxIdInput),this.taxIdInput.destroy())},_onBuyerTypeChange(e){let t;"company"===e?(this.company.isNew()&&this.company.unset(c.Fields.TAX_REGISTRATION_ID),t=m.COMPANY):t=m.INDIVIDUAL,this.billingAddressHelper.setBuyerType(t),this.buyerForm.destroy(),this.buyerForm=this._createBuyerForm(),this.render()},validate(){const e=this.addressForm.isValid();return(this.billingAddressHelper.isCompanyBuyer()?this.buyerForm.validate().isValid&&this.taxIdInput.isValid():this.buyerForm.validate())&&e},_computeBackgroundValidation(){const e=!this.billingAddressHelper.isCompanyBuyer()||this.buyerForm.isValid()&&this.taxIdInput.isValid(),t=this.addressForm.isValid();e&&t?this.nextButton.enable():this.nextButton.disable(),this.dispatchEvent(E.ON_BACKGROUND_VALIDATION)},async _save(){if(this.tracker.sendEvent("Next",{label:"NewTenantBillingAddressForm"}),this.validate()){const e=this.billingAddressHelper.isCompanyBuyer();e&&(p.isIndia(this.address.getCountry())?(this.address.set(l.Fields.GST_ID,this.company.getTaxRegistrationId()),this.address.set(l.Fields.SPECIAL_ECONOMIC_ZONE,this.taxIdInput.isSpecialEconomicZoneChecked()?"TRUE":"FALSE")):(this.address.unset(l.Fields.GST_ID,{silent:!0}),this.address.unset(l.Fields.SPECIAL_ECONOMIC_ZONE,{silent:!0})),p.isIndia(this.company.getCountry())&&(this.company.unset(c.Fields.TAX_REGISTRATION_ID,{silent:!0}),this.company.unset(c.Fields.SPECIAL_ECONOMIC_ZONE,{silent:!0})),this.company.getCountry()||this.company.set(c.Fields.COUNTRY,this.address.getCountry())),t.mask(this.container);try{let s;e?(this.company.isNew()?await this.company.savePromise():(this.company.dataProxy instanceof a||(this.company.dataProxy=this.companyFactory.getDataProxy(d.Types.COMPANY)),await this.company.savePromise(this.company.getPendingChanges(),{patch:!0})),s=this.company.get("id")):s=this.person.get("id"),this.address.setParentResourceId(s),await this.address.savePromise(),e?this.billingAddressHelper.pushCompanyAddress(this.address):this.billingAddressHelper.pushPersonalAddress(this.address),await this.billingAddressHelper.patchBillingAddress(this.address),t.unmask(this.container),this.tracker.sendEvent("Billing.SaveSuccess"),this.dispatchEvent(E.ADDRESS_SAVED)}catch(e){console.error(e),t.unmask(this.container),this.dispatchEvent(E.ON_ERROR,A.get("unableToSaveAddress"))}}},_renderOptionalInfoMessage(){if("ja"===r.getCookie("swymlang"))return{tag:"div",class:"alert-message alert-warning alert-has-icon",html:[{tag:"span",class:"icon fonticon"},{tag:"span",text:""}]}},_createBuyerTypeInput(){const e=new y({model:this.billingAddressHelper.isCompanyBuyer()?this.company:this.person,readOnly:!this.billingAddressHelper.isBuyerTypeEditable()});return this.listenTo(e,y.Events.ON_CHANGE,this._onBuyerTypeChange.bind(this)),e},_createBuyerForm(){return this._destroyBuyerForm(),this.billingAddressHelper.isCompanyBuyer()?this._createCompanyNameInput():this._createPersonForm()},_destroyBuyerForm(){this.companyForm&&(this.stopListening(this.companyForm),this.companyForm.destroy(),this.companyForm=null),this.personForm&&(this.stopListening(this.personForm),this.personForm.destroy(),this.personForm=null)},_createPersonForm(){return new g({model:this.person,readOnly:!0,required:!0,horizontalLayout:!0})},_createCompanyNameInput(){const e=new C({model:this.company,required:!0,readOnly:""!==this.company.getName(),dynamicValidation:!0});return this.listenTo(e,C.Events.UPDATE,this._computeBackgroundValidation.bind(this)),e},_createAddressForm(){const e=this.billingAddressHelper.isCompanyBuyer(),t=this.billingAddressHelper.numberOfAddresses()>0,s=!e&&t?this.billingAddressHelper.getValidBillingAddresses()[0].getCountry():e&&this.company.getCountry(),r=new T({address:this.address,addressConstraints:this.addressFactory.addressesConstraints,countries:this.countries,isCountryReadOnly:s,preSetCountry:s,showPhoneNumber:!1,phoneNumberMention:!1});return this.listenTo(r,T.Events.ON_VALIDATION_STATE_CHANGE,this._computeBackgroundValidation.bind(this)),r},_createTaxIdInput(){let e;return this.company.getTaxRegistrationId()&&this.company.getDrupalId()?e=new P({model:this.company,required:!0,readOnly:!0}):(e=new S({company:this.company,companyFactory:this.companyFactory,address:this.address,countries:this.countries,service:this.service}),this.listenTo(e,S.Events.ON_CHANGE,this._computeBackgroundValidation.bind(this))),e},_createCancelButton(){return new s({className:"default",value:A.get("cancel"),events:{onClick:this.dispatchEvent.bind(this,E.CANCEL)}})},_createNextButton(){return new s({className:"primary",value:0===this.billingAddressHelper.numberOfAddresses()?A.get("next"):A.get("save"),disabled:!0,events:{onClick:this._save.bind(this)}})}});return M.Events=E,M}),define("DS/MPFCheckoutPage/payment/UnifiedPaymentsInterfaceTile",["DS/MPFCheckoutPage/payment/PaymentMethodTile","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r){"use strict";const i=e.extend({setup({cart:e,paymentHelper:t}={}){this._parent({cart:e,paymentHelper:t,paymentMethod:s.PaymentMethods.UNIFIED_PAYMENTS_INTERFACE,title:r.get("unifiedPaymentsInterface"),className:"mpf-unified-payments-interface-tile"})},renderBody:()=>[{tag:"div",class:"mpf-payu-redirection-message",text:r.get("payuRedirectionMessage")}],async pay(){await this.paymentHelper.patchCartPaymentState(),window.location.assign(this.cart.getPaymentUrl())}});return i.Events=e.Events,i}),define("DS/MPFCheckoutPage/termsAndConditions/CnbTermsAndConditionsSection",["DS/UIKIT/Input/Toggle","DS/MPFTCContractModel/TCContractModel","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFCartModel/CartModel","DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsSection","i18n!DS/MPFCheckoutPage/assets/nls/TermsAndConditions"],function(e,t,s,r,i,n){"use strict";const a=Object.freeze(),o=i.extend({setup(e){this._parent(e),this.toggle=this._createToggle(),this.isChecked=!1},isComplete(){return this._areTcContractSigned()&&this.isChecked},load(){return Promise.all([this.termsAndConditionsHelper.fetchTcDocument({type:s.Types.CLICKNBUY_TC}),this.termsAndConditionsHelper.fetchTcContracts({types:[t.TcTypes.CLICKNBUY_TC,t.TcTypes.DATA_PRIVACY]}),this.termsAndConditionsHelper.fetchClosa()]).then(([e,s,r])=>{this.tcDocument=e,this.softwareAgreement=r,this.tcContract=this.termsAndConditionsHelper.findContract({docType:t.DOCUMENT_TYPES.CLICKNBUY_TC,buyer:this.billingAddressHelper.getBuyer()}),this.ppContract=this.termsAndConditionsHelper.findContract({docType:t.DOCUMENT_TYPES.DATA_PRIVACY,buyer:this.billingAddressHelper.getBuyer()})})},renderContent({isWriteMode:e}){return e?this.toggle.enable():(this._areTcContractSigned()?this.toggle.check():this.toggle.uncheck(),this.toggle.disable()),[this._renderToggleContainer(this.toggle),this._renderText()]},shouldPaymentSectionBeDisplayed(){return this.toggle.isChecked()},async saveContracts(){return this.cart.getState()!==r.States.SUBMITTED&&await this.cart.savePromise({[r.Fields.STATE]:r.States.SUBMITTED},{patch:!0}),Promise.all([this.termsAndConditionsHelper.saveTermsOfUseContract(this.tcContract),this.termsAndConditionsHelper.saveTermsOfUseContract(this.ppContract),this.termsAndConditionsHelper.saveClosaContract({buyer:this.billingAddressHelper.getBuyer()})])},destroy(){this.toggle=null,this.tcDocument=null,this.softwareAgreement=null,this.tcContract=null,this.ppContract=null,this._parent()},_areTcContractSigned(){return this.tcContract.getCurrentState()===t.STATUS.inEffect&&this.ppContract.getCurrentState()===t.STATUS.inEffect},_renderToggleContainer:e=>({tag:"div",class:"mpf-toggle-container",html:[e,{tag:"div",class:"mpf-toggle-label",text:n.get("iAcknowledgeThat")}]}),_renderText(){const e=[{tag:"li",text:n.get("allBillingInformationIsCorrect")},{tag:"li",text:this.billingAddressHelper.isCompanyBuyer()?n.get("authorizedToRepresentCompany"):n.get("consentAccess")},{tag:"li",html:n.get("agreeTermsAndConditions",{termsAndConditions:this.createLink({href:this.tcDocument.getDocUrl(),text:n.get("termsAndConditionsLabel"),trackerLabel:"GeneralCondition"}).outerHTML,privacyPolicy:this.createLink({href:"https://discover.3ds.com/privacy-policy ",text:n.get("privacyPolicy"),trackerLabel:"PrivacyPolicy"}).outerHTML})},{tag:"li",html:n.get("agreeClosa",{closa:this.createLink({href:this.softwareAgreement.getUrl(),text:this.cart.isBeDev()?n.get("businessExperiencePartnerAgreement"):n.get("closaLabel"),trackerLabel:"Closa"}).outerHTML})}];return this.cart.hasMakerItems()&&e.splice(1,0,{tag:"li",text:n.get("iAmAMakerOrHobbyist")}),{tag:"ul",html:[e],events:{click:e=>{if("A"===e.target.tagName){const t=e.target.dataset.trackerLabel;this.tracker&&this.tracker.sendEvent(i.TrackerEvents.LINK,{label:t})}}}}},_createToggle(){return new e({type:"switch",className:"primary",value:"",events:{onChange:()=>{this.isChecked=this.toggle.isChecked(),this.onToggleChange()}}})}});return o.Events=a,o}),define("DS/MPFCheckoutPage/payment/MakeBankTransferTile",["DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFCheckoutPage/payment/BankTransferTile","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadForm","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a){"use strict";const o=Object.freeze({...i.Events}),c=Object.freeze({UPLOAD_LATER:"uploadLater",UPLOAD_NOW:"uploadNow",NO_SELECTION:"noSelection"}),d=i.extend({setup({cart:e,purchaseOrder:s,purchaseOrderDocument:i,paymentHelper:n,service:a}={}){t.requiredOfPrototype(s,r,"options.purchaseOrder must be a PurchaseOrderModel"),this._parent({cart:e,paymentHelper:n,className:"mpf-make-bank-transfer-tile"}),this.state=c.NO_SELECTION,this.uploadForm=this._createUploadForm({purchaseOrder:s,purchaseOrderDocument:i,service:a})},renderBody(){return this._setPaymentButtonState(),[{tag:"p",text:a.get("confirmDeferredPaymentMessage")},{tag:"a",href:"/faq/proceed-to-deferred-payment",text:a.get("learnMoreAboutDeferredPayment"),target:"_blank"},this._createUploadNowToggle(),this.state===c.UPLOAD_NOW&&this._renderUploadFormContainer(),this._createUploadLaterToggle(),this.state===c.UPLOAD_LATER&&this._renderUploadLaterSection()]},async pay(){if(this.state===c.UPLOAD_NOW){if(!this.uploadForm.validate())throw Error("Invalid form");const e=this.uploadForm.getSelectedFile();await this.paymentHelper.payByInvoice({file:e})}else await this.paymentHelper.payByInvoice({uploadLater:!0})},destroy(){this._parent(),this.container=null},_isValid(){return this.state===c.UPLOAD_NOW?this.uploadForm.isValid():this.state===c.UPLOAD_LATER},_setPaymentButtonState(){this._isValid()?this.enablePaymentButton():this.disablePaymentButton()},_createUploadNowToggle(){return new e({type:"switch",label:a.get("uploadPurchaseOrderNow"),checked:this.state===c.UPLOAD_NOW,events:{onChange:()=>{this.state=c.UPLOAD_NOW,this.render()}}})},_createUploadLaterToggle(){return new e({type:"switch",label:a.get("uploadPurchaseOrderLater"),checked:this.state===c.UPLOAD_LATER,events:{onChange:()=>{this.state=c.UPLOAD_LATER,this.render()}}})},_createUploadForm({purchaseOrder:e,purchaseOrderDocument:t,service:s}){const r=new n({model:e,cart:this.cart,purchaseOrderDocument:t,service:s});return this.listenTo(r,n.Events.ON_CHANGE,()=>{this._setPaymentButtonState()}),r},_renderUploadFormContainer(){return{tag:"div",class:"mpf-upload-form-container mpf-horizontal",html:[this.uploadForm.render()]}},_renderUploadLaterSection(){}});return d.Events=o,d}),define("DS/MPFCheckoutPage/orderSummary/CnbCartItemList",["DS/UIKIT/Mask","DS/MPFAmdLazyLoader/AmdLazyLoader","DS/MPFUtils/StorageUtils","DS/MPFCheckoutPage/orderSummary/CartItemList","i18n!DS/MPFCheckoutPage/assets/nls/OrderSummary"],function(e,t,s,r,i){"use strict";const n=Object.freeze({REVIEW_ITEMS:"ReviewItems",ROLE_INFO:"RoleInfoCheckout"});return r.extend({setup(e={}){this.tracker=e.tracker,this._parent({...e,className:"mpf-cnb-item-list"})},renderTable(){const{normalItems:e,bundles:t}=this._sortItems();return[{tag:"div",class:"mpf-cnb-item-list-container",html:[{tag:"div",class:"mpf-cnb-item-list-header",html:this._createHeaderItems()},{tag:"div",class:"mpf-cnb-item-list-body",html:[...e.map(e=>this._createNormalItemLine(e)),...Object.keys(t).map(e=>this._createBundleLine(t[e]))]}]}]},calculateNumberItems(){let e=0;const{normalItems:t,bundles:s}=this._sortItems();return t.forEach(t=>{e+=parseInt(t.getQuantity())}),Object.keys(s).forEach(t=>{e+=parseInt(s[t][0].getQuantity())}),e},_sortItems(){const e=[],t={};return this.cart.getItems().forEach(s=>{const r=s.getOfferId();r?Array.isArray(t[r])?t[r].push(s):t[r]=[s]:e.push(s)}),{normalItems:e,bundles:t}},_numberToPrice(e){return e.toLocaleString(s.getLanguageCookie(),{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})},_createNormalItemLine(e){return this._createLine({name:e.getProductDisplayName(),trigram:e.getProductTrigram(),pricingStructure:e.getLicensingSchemeWord(),quantity:parseInt(e.getQuantity()),unitPrice:parseFloat(e.getUnitNetAmount())})},_createBundleLine(e){const t=e[0];return{tag:"div",class:"mpf-bundle-offer",html:[this._createLine({name:t.getTitle(),pricingStructure:t.getLicensingSchemeWord(),quantity:parseInt(t.getOfferQuantity()),unitPrice:parseFloat(t.getUnitNetAmount())}),{tag:"div",class:"mpf-bundle-content",html:e.map(e=>this._createBundleItemLine(e))}]}},_createLine({name:e,quantity:t,pricingStructure:s,unitPrice:r,trigram:i}){const n=i&&"DS"===i.slice(0,2);return{tag:"div",class:"mpf-item-line",html:[{tag:"div",class:"mpf-line-cell mpf-name-container",html:[{tag:"div",class:"mpf-name",html:[e,i&&{tag:"span",class:"fonticon fonticon-info",events:{click:this._displayMarketingModal.bind(this,{name:e,trigram:i})}}]},n&&{tag:"div",class:"mpf-product-trigram",text:i}]},{tag:"div",class:"mpf-line-cell mpf-pricing-structure",text:s},{tag:"div",class:"mpf-line-cell mpf-quantity",text:t},{tag:"div",class:"mpf-line-cell mpf-unit-price",text:this._numberToPrice(r)},{tag:"div",class:"mpf-line-cell mpf-price",text:this._numberToPrice(r*t)}]}},_createBundleItemLine(e){return{tag:"div",class:"mpf-bundle-item",html:[{tag:"span",text:e.getProductDisplayName()},{tag:"span",class:"fonticon fonticon-info",events:{click:this._displayMarketingModal.bind(this,{name:e.getProductDisplayName(),trigram:e.getProductTrigram()})}}]}},_createHeaderItems:()=>[{tag:"div",class:"mpf-header-cell mpf-name",text:i.get("products")},{tag:"div",class:"mpf-header-cell mpf-pricing-structure",text:i.get("pricingStructure")},{tag:"div",class:"mpf-header-cell mpf-quantity",text:i.get("quantity")},{tag:"div",class:"mpf-header-cell mpf-unit-price",text:i.get("unitPriceTax")},{tag:"div",class:"mpf-header-cell mpf-price",text:i.get("priceTax")}],_displayMarketingModal(t){return e.mask(this.container),this.tracker.sendEvent(n.ROLE_INFO,{label:t.name}),this._createMarketingModal(t).then(t=>{e.unmask(this.container),this.container.addContent(t),t.render().show()})},_createMarketingModal:e=>t.getInstance().get(["DS/MPFCheckoutPage/orderSummary/MarketingModal"]).then(([t])=>new t({item:e})),_toggleExpand(){this.state===r.States.COLLAPSED&&this.tracker.sendEvent(n.REVIEW_ITEMS,{label:this.calculateNumberItems().toString()}),this._parent()}})}),define("DS/MPFCheckoutPage/termsAndConditions/InnovateTermsAndConditionsSection",["DS/UIKIT/Input/Toggle","DS/MPFTCContractModel/TCContractModel","DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsSection","DS/MPFTCContractModel/TCContractFactory","i18n!DS/MPFCheckoutPage/assets/nls/TermsAndConditions"],function(e,t,s,r,i){"use strict";const n=Object.freeze({}),a=s.extend({setup(e){this._parent(e),this.toggle=this._createToggle(),this.isAccepted=!1},isComplete(){return this.isAccepted},async load(){[this.scContract,this.scDocument]=await this.termsAndConditionsHelper.fetchScContractAndDoc()},renderContent({isWriteMode:e}){return e?this.toggle.enable():(this.scContract&&this.scContract.getCurrentState()!==t.STATUS.inEffect?this.toggle.uncheck():this.toggle.check(),this.toggle.disable()),[this._renderToggleContainer(this.toggle),this._renderText()]},async saveContracts(){await this.termsAndConditionsHelper.signContracts(),this.isAccepted=!0},shouldPaymentSectionBeDisplayed(){return this.toggle.isChecked()},destroy(){this.toggle=null,this.scDocument=null,this._parent()},_renderToggleContainer:e=>({tag:"div",class:"mpf-toggle-container",html:[e,{tag:"div",class:"mpf-toggle-label",text:i.get("iAcknowledgeThat")}]}),_renderText(){return{tag:"ul",html:[[{tag:"li",text:i.get("allBillingInformationIsCorrect")},{tag:"li",text:i.get("authorizedToRepresentCompany")},{tag:"li",html:this.scDocument?i.get("agreeSalesConditions",{salesConditions:this.createLink({href:this.scDocument.getDocUrl(),text:this.cart.getShopName()+" "+i.get("salesConditionsLabel")}).outerHTML}):i.get("agreeQuotation")}]]}},_createToggle(){return new e({type:"switch",className:"primary",value:"",events:{onChange:()=>{this.isChecked=this.toggle.isChecked(),this.onToggleChange()}}})}});return a.Events=n,a}),define("DS/MPFCheckoutPage/billingAddress/CompanySearchList",["UWA/Class/View","UWA/Core","DS/UIKIT/Scroller","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCartModel/CartModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCountryModel/CountryCollection","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFAddressFormComponent/AddressCard","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m){"use strict";const y=Object.freeze({ADDRESS_SELECTED:"address_selected",CANCEL:"cancel",ON_ERROR:"onError"}),g=e.extend({className:"mpf-company-search-list",setup({tracker:e,company:t,companySearch:s,companyFactory:r,addressFactory:i,countries:a,billingAddressHelper:o}={}){n.requiredOfPrototype(t,c,"company must be a CompanyModel"),n.requiredOfPrototype(r,d,"companyFactory must be a CompanyFactory"),n.requiredOfPrototype(i,l,"addressFactory must be an AddressFactory"),n.requiredOfPrototype(a,h,"countries must be a CountryCollection"),n.requiredOfPrototype(o,p,"billingAddressHelper must be a BillingAddressHelper"),this.tracker=e,this.company=t,this.companySearch=s,this.companyFactory=r,this.addressFactory=i,this.countries=a,this.billingAddressHelper=o},render(){return this._destroySubcomponents(),this.nextButton=this._createNextButton(),this.cancelButton=this._createCancelButton(),this.matchingCompaniesCards=this._getMatchingCompaniesCards(),this.newCompanyCard=this._createNewCompanyCard(),this.selectedCompany="",this.selectedAddressCard="",this.container.setContent([{tag:"div",class:"mpf-company-selection-info",text:m.get("companySelectionInfo")},this._createMatchingCompaniesSection({cards:this.matchingCompaniesCards}),this._createNewCompanySection({card:this.newCompanyCard}),this._createFooter({nextButton:this.nextButton,cancelButton:this.cancelButton})]),this},destroy(){this._destroySubcomponents(),this.nextButton=null,this.me=null,this.company=null,this.countries=null,this.matchingCompaniesSection=null,this.newCompanySection=null,this._parent(),this.container=null},_destroySubcomponents(){this.stopListening(),this.newCompanyCard&&(this.newCompanyCard.destroy(),this.newCompanyCard=null),this.matchingCompaniesCards&&(this.matchingCompaniesCards.forEach(e=>{e.destroy()}),this.matchingCompaniesCards=null),this.nextButton&&this.nextButton.destroy()},async _save(){this.tracker.sendEvent(a.Events.NEXT,{label:"CompanySearchList"});const e=this.selectedAddressCard.getLegalEntity(),t=this.selectedAddressCard.getAddress();i.mask(this.container);try{await this.billingAddressHelper.createCompanyWithAddress({companySearch:e,company:this.company,address:t}),i.unmask(this.container),this.dispatchEvent(y.ADDRESS_SELECTED)}catch(e){let t;i.unmask(this.container),console.error(e),t=e.options&&e.options.request?-1!==e.options.request.xhr.response.indexOf("Error.MismatchAttribute")?"errorAttributeMismatch":-1!==e.options.request.xhr.response.indexOf("Error.NonRomanForbidden")?"errorNonRomanForbidden":"unableToSaveSelection":"unableToSaveSelection",this.dispatchEvent(y.ON_ERROR,m.get(t))}},_createMatchingCompaniesSection({cards:e}){const r=t.createElement("div",{class:"mpf-matching-companies-list",html:e.map(e=>e.render())});let i;return e.length>1?(i=new s({element:r}),r.setStyle("height","350px")):i=r,t.createElement("div",{class:"mpf-matching-companies-section",html:[{tag:"div",class:"mpf-billing-address-list-subtitle",text:m.get("selectCompany")},i]})},_createNewCompanySection:({card:e})=>t.createElement("div",{class:"mpf-new-company-section",html:[{tag:"div",class:"mpf-billing-address-list-subtitle",text:m.get("keepEntry")},e.render()]}),_createFooter:({nextButton:e,cancelButton:s})=>t.createElement("div",{class:"mpf-billing-address-list-footer",html:[e,s]}),_onCardSelection(e){this.selectedAddressCard!==e&&(this.selectedAddressCard&&this.selectedAddressCard.unselect(),this.selectedAddressCard=e,this.selectedAddressCard.select(),this.nextButton.enable())},_getMatchingCompaniesCards(){return this.companyFactory.createCollection(d.Types.MATCHING_COMPANIES,this.companySearch.getMatchingCompanies(),{parse:!0,addressFactory:this.addressFactory}).map(e=>{const t=e.getBillToAddress(),s=this.countries.getCountryWithIso3(t.getCountry()),r=s&&s.getName(),i=new u({legalEntity:e,country:r,address:t,showTaxId:!0});return this.listenTo(i,u.Events.ON_SELECTED,this._onCardSelection.bind(this,i)),i})},_createNewCompanyCard(){const e=this.billingAddressHelper.createBillingAddress(this.companySearch.get("address")),t=this.countries.getCountryWithIso3(e.getCountry()),s=t&&t.getName(),r=new u({legalEntity:this.companySearch,country:s,address:e,showTaxId:!0});return this.listenTo(r,u.Events.ON_SELECTED,this._onCardSelection.bind(this,r)),r},_createNextButton(){return new r({className:"primary",value:m.get("next"),disabled:!0,events:{onClick:this._save.bind(this)}})},_createCancelButton(){return new r({className:"default",value:m.get("cancel"),events:{onClick:this.dispatchEvent.bind(this,y.CANCEL)}})}});return g.Events=y,g}),define("DS/MPFCheckoutPage/payment/CouponTile",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFUtils/StorageUtils","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCheckoutPage/payment/CouponInput","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o,c,d){"use strict";const l=Object.freeze({LOAD:"load",ON_CHANGE:"onChange",ON_PAYMENT_DONE:"onPaymentDone",ON_ERROR:"onError"}),h=Object.freeze({COLLAPSED:"collapsed",EXPANDED:"expanded"}),p=t.extend({className:"mpf-coupon-tile mpf-payment-method-tile",setup({cart:e,paymentHelper:t,tracker:s,isSelected:r=!1}={}){i.requiredOfPrototype(e,n,"options.cart must be a CartModel"),this.cart=e,this.paymentHelper=t,this.tracker=s,this.textInput=this._createTextInput(),this.infoContainer=this._createInfoContainer(),this.footer=this._createFooter(),this.paymentButton=this._createPaymentButton(),this.state=this._getInitialState({isSelected:r}),this._isCouponApplied=!!this.cart.getCoupon()},render(){return this.state===h.EXPANDED?(this._renderCouponInfo(),this._renderFooter(),this.container.setContent([this._renderHeader(),{tag:"div",class:"mpf-coupon-tile-body mpf-payment-method-tile-body",html:[this.textInput.render(),this.infoContainer]},this.footer]),this.container.addClassName("mpf-selected")):(this.container.setContent([this._renderHeader()]),this.container.removeClassName("mpf-selected")),this},async pay(){this.tracker.sendEvent(o.Events.PAYMENT_INITIATED,{paymentType:o.PaymentTypes.COUPON}),this.dispatchEvent(l.LOAD);try{await this.cart.savePromise({[n.Fields.STATE]:n.States.PENDING_PAYMENT},{patch:!0}),await this.paymentHelper.saveQuote(),await this.paymentHelper.waitForPaymentCompletion(),this.dispatchEvent(l.ON_PAYMENT_DONE)}catch(e){console.error(e),this.dispatchEvent(l.ON_ERROR,d.get("paymentErrorMessage"))}},destroy(){this.stopListening(),this.textInput.destroy(),this._parent(),this.container=null},_onStateChange({isCouponApplied:e}){e!==this._isCouponApplied?(this._isCouponApplied=e,this.dispatchEvent(l.ON_CHANGE,{isCouponApplied:e})):this._renderCouponInfo()},_renderHeader(){const e=!this.paymentHelper.isCartPaid();return{tag:"div",class:"mpf-payment-method-tile-header mpf-coupon-tile-header"+(e?" mpf-clickable":""),html:[new r({className:"primary",type:"checkbox",value:d.get("useCoupon"),checked:this.state===h.EXPANDED,disabled:this.paymentHelper.isCartPaid()}),{tag:"span",class:"fonticon fonticon-ticket"}],events:{click:async()=>{e&&(this.state=this.state===h.COLLAPSED?h.EXPANDED:h.COLLAPSED,this.state===h.COLLAPSED&&this.cart.getCoupon()?(this.dispatchEvent(l.LOAD),await this.cart.savePromise({[n.Fields.COUPON]:""},{patch:!0}),this.cart.unset(n.Fields.COUPON),this._onStateChange({isCouponApplied:!1})):this.render())}}}},_renderCouponInfo(){const e=[],t=this.cart.getCoupon();if(t){const s=a.getLanguageCookie();e.push(this._createInfoLine(d.get("commercialCampaign"),t.commercialName)),t.endDate&&e.push(this._createInfoLine(d.get("expiryDate"),new Date(t.endDate).toLocaleDateString(s))),t.campaignAmount&&e.push(this._createInfoLine(d.get("couponValue"),parseFloat(t.campaignAmount).toLocaleString(s,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"}))),this.paymentHelper.isCartPaid()||(this._isCouponValid(t)||e.push({tag:"div",class:"mpf-coupon-info-line mpf-coupon-error",text:d.get("invalidCoupon")}),this._hasCouponExpired(t)&&e.push({tag:"div",class:"mpf-coupon-info-line mpf-coupon-error",text:d.get("expiredCoupon")}),parseFloat(t.campaignAmount)>parseFloat(t.amount)&&e.push({tag:"div",class:"mpf-coupon-info-line mpf-coupon-info",text:d.get("couponValueExceedsOrderValue")}))}this.infoContainer.setContent(e),e.length>0?this.infoContainer.removeClassName("mpf-hidden"):this.infoContainer.addClassName("mpf-hidden")},_renderFooter(){const e=[];if(this.state===h.EXPANDED){const t=this.cart.has(n.Fields.COUPON)?parseFloat(this.cart.getCoupon().totalToPay):this.cart.getGrossAmountTotal();e.push({tag:"div",class:"mpf-total-container",html:[{tag:"span",class:"mpf-total-label",text:d.get("totalToPay")},{tag:"span",class:"mpf-total-price",text:t.toLocaleString(a.getLanguageCookie(),{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})}]}),0!==t||this.paymentHelper.isCartPaid()||e.push(this.paymentButton)}this.footer.setContent(e)},_isCouponValid:e=>e&&e.validity&&!0===e.validity.isValid,_hasCouponExpired(e){const t=new Date;return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())>new Date(e.endDate)},_createInfoLine:(e,t)=>({tag:"div",class:"mpf-coupon-info-line",html:[{tag:"span",class:"mpf-coupon-info-label",text:e},{tag:"span",class:"mpf-coupon-info-value",text:t}]}),_createTextInput(){const e=new c({cart:this.cart});return this.listenTo(e,c.Events.ON_STATE_CHANGE,this._onStateChange.bind(this)),e},_createPaymentButton(){return new s({className:"primary",value:d.get("confirmOrder"),events:{onClick:this.pay.bind(this)}})},_createInfoContainer:()=>e.createElement("div",{class:"mpf-coupon-info"}),_createFooter:()=>e.createElement("div",{class:"mpf-coupon-footer mpf-payment-method-tile-footer"}),_getInitialState({isSelected:e}){return this.cart.getCoupon()||e?h.EXPANDED:h.COLLAPSED}});return p.Events=l,p}),define("DS/MPFCheckoutPage/orderSummary/QuoteTile",["UWA/Core","UWA/Class/View","DS/MPFCartModel/CartModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCheckoutPage/IconLink","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c){"use strict";const d=Object.freeze({ON_ERROR:"onError"}),l=t.extend({className:"mpf-quote-tile",setup({cart:e,cartQuote:t,tracker:i,service:o}={}){n.requiredOfPrototype(e,s,"options.cart must be a CartModel"),n.requiredOfPrototype(t,r,"options.cartQuote must be a CartQuoteModel"),n.requiredOfPrototype(i,a,"options.tracker must be a CheckoutTracker"),n.requiredOfType(o,"string","options.service must be a MarketplaceServices instance"),this.cart=e,this.cartQuote=t,this.tracker=i,this.service=o,this.link=this._createLink()},render(){const t=this._getPlatform();return this.container.setContent([{tag:"div",class:"mpf-left-column",html:[{tag:"div",class:"mpf-name",text:this._getSellerName()},{tag:"div",class:"mpf-platform",html:t?c.get("deliveryOnPlatform+Name",{name:t,bold3D:e.createElement("b",{text:"3D"}).outerHTML}):c.get("deliveryOnNewPlatform",{bold3D:e.createElement("b",{text:"3D"}).outerHTML})}]},{tag:"div",html:[this.link.render()]}]),this},destroy(){this.link.destroy(),this.link=null,this.cart=null,this.cartQuote=null,this._parent(),this.container=null},_getPlatform(){const e=this.cart.getOnlineInstance();if(e)return e;return this.cart.getItems()[0].getOnlineInstance()},_getSellerName(){return this.service===i.CLICK_AND_BUY||this.service===i.IFWELOOP?"Dassault Systmes":this.cart.getShopName()},_createLink(){const e=new o({icon:"download",text:c.get("quote")});return this.listenTo(e,o.Events.ON_CLICK,async()=>{e.load();try{await this.cartQuote.fetchPromise(),e.load(!1),window.open(this.cartQuote.getUrl()),this.tracker.sendEvent(a.Events.QUOTE_DOWNLOADED)}catch(t){e.load(!1),console.error(t),this.dispatchEvent(d.ON_ERROR,{message:c.get("unableToDownloadQuote")})}}),e}});return l.Events=d,l}),define("DS/MPFCheckoutPage/billingAddress/CompanySearchForm",["UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/MPFUtils/StorageUtils","DS/MPFServices/ObjectService","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCompanyModel/CompanyModel","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFAddressModel/AddressModel","DS/MPFCountryModel/CountryCollection","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFView/FieldTextInputV2","DS/MPFAddressFormComponent/AddressFormComponentV3","DS/MPFCheckoutPage/billingAddress/TaxIdInput","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m,y){"use strict";const g=Object.freeze({TO_COMPANY_SELECTION:"toCompanySelection",COMPANY_SELECTED:"companySelected",ON_ERROR:"onError"}),C=e.extend({className:"mpf-company-search-form mpf-horizontal",setup({tracker:e,company:t,companySearch:s,companyFactory:r,addressFactory:n,countries:d,billingAddressHelper:p,service:u}={}){i.requiredOfPrototype(s,a,"companySearch must be a CompanyModel"),i.requiredOfPrototype(r,o,"companyFactory must be a CompanyFactory"),i.requiredOfPrototype(n,c,"addressFactory must be an AddressFactory"),i.requiredOfPrototype(d,l,"countries must be a CountryCollection"),i.requiredOfPrototype(p,h,"billingAddressHelper must be a BillingAddressHelper"),this.tracker=e,this.company=t,this.companySearch=s,this.billingAddressHelper=p,this.address=this.billingAddressHelper.createBillingAddress(),this.companyNameInput=this._createCompanyNameInput(),this.addressForm=this._createAddressForm({addressFactory:n,countries:d}),this.taxIdInput=this._createTaxIdInput({countries:d,companyFactory:r,service:u}),this.nextButton=this._createNextButton()},render(){return this.container.setContent([this._renderOptionalInfoMessage(),this.companyNameInput.render(),this.addressForm.render(),this.taxIdInput.render(),{tag:"div",class:"mpf-company-search-form-footer",html:this.nextButton}]),this.taxIdInput.isValid()||this.nextButton.disable(),this},validate(){const e=this.addressForm.isValid(),t=this.companyNameInput.validate().isValid,s=this.taxIdInput.isValid();return e&&t&&s},destroy(){this.stopListening(),this.addressForm.destroy(),this.taxIdInput.destroy(),this.addressForm=null,this.taxIdInput=null,this.companyNameInput=null,this.company=null,this.companySearch=null,this.address=null,this.companyFactory=null,this.tracker=null,this.billingAddressHelper=null,this._parent(),this.container=null},_doBackgroundValidation(){const e=this.addressForm.isValid(),t=this.companyNameInput.isValid(),s=this.taxIdInput.isValid();return e&&t&&s},_onCountryChange(){this.companySearch.setCountry(this.address.getCountry()),this.taxIdInput.applyCountryFormat(),this._onChange()},_onChange(){this._doBackgroundValidation()?this.nextButton.enable():this.nextButton.disable()},async _save(){if(this.validate()){this.tracker.sendEvent(n.Events.NEXT,{label:"CompanySearchForm"}),l.isIndia(this.address.getCountry())?(this.address.set(d.Fields.GST_ID,this.companySearch.getTaxRegistrationId()),this.address.set(d.Fields.SPECIAL_ECONOMIC_ZONE,this.taxIdInput.isSpecialEconomicZoneChecked()?"TRUE":"FALSE")):(this.address.unset(d.Fields.GST_ID,{silent:!0}),this.address.unset(d.Fields.SPECIAL_ECONOMIC_ZONE,{silent:!0})),l.isIndia(this.companySearch.getCountry())&&(this.companySearch.unset(a.Fields.TAX_REGISTRATION_ID,{silent:!0}),this.companySearch.unset(a.Fields.SPECIAL_ECONOMIC_ZONE,{silent:!0})),this.companySearch.set({[a.Fields.NO_VAT_ID]:this.taxIdInput.isNoVatIdToggleChecked(),address:this.address.omit()}),t.mask(this.container);try{await this.companySearch.savePromise(null,{}),0===this.companySearch.getMatchingCompanies().length?(await this.billingAddressHelper.createCompanyWithAddress({companySearch:this.companySearch,company:this.company,address:this.address}),t.unmask(this.container),this.dispatchEvent(g.COMPANY_SELECTED)):(t.unmask(this.container),this.dispatchEvent(g.TO_COMPANY_SELECTION,{companySearch:this.companySearch}))}catch(e){console.error(e),t.unmask(this.container);let s="";if(e&&e.options&&e.options.request&&e.options.request.xhr&&400===e.options.request.xhr.status)try{s=JSON.parse(e.options.request.xhr.responseText)}catch(e){console.warn(e)}else s=new Error(y.get("unableToSaveCompany"));this.dispatchEvent(g.ON_ERROR,s)}}else this.tracker.sendEvent(n.Events.FORM_ERROR,"Error label")},_renderOptionalInfoMessage(){if("ja"===r.getCookie("swymlang"))return{tag:"div",class:"alert-message alert-warning alert-has-icon",html:[{tag:"span",class:"icon fonticon"},{tag:"span",text:""}]}},_createCompanyNameInput(){const e=new p({model:this.companySearch,fieldName:a.Fields.NAME,fieldLabel:y.get("companyName"),required:!0,dynamicValidation:!0});return this.listenTo(e,p.Events.UPDATE,this._onChange.bind(this)),e},_createAddressForm({addressFactory:e,countries:t}){const s=new u({address:this.address,addressConstraints:e.addressesConstraints,countries:t,showPhoneNumber:!1,phoneNumberMention:!1});return this.listenTo(s,u.Events.ON_VALIDATION_STATE_CHANGE,this._onChange.bind(this)),this.listenTo(s,u.Events.ON_COUNTRY_CHANGE,this._onCountryChange.bind(this)),s},_createTaxIdInput({countries:e,companyFactory:t,service:s}){const r=new m({company:this.companySearch,address:this.address,companyFactory:t,countries:e,service:s});return this.listenTo(r,m.Events.ON_CHANGE,this._onChange.bind(this)),r},_createNextButton(){return new s({className:"primary",value:y.get("next"),disabled:!0,events:{onClick:this._save.bind(this)}})}});return C.Events=g,C}),define("DS/MPFCheckoutPage/payment/ConfirmFreeOrderSection",["DS/UIKIT/Input/Button","DS/MPFCheckoutPage/CheckoutSection","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCheckoutPage/payment/PaymentHelper","DS/MPFUtils/StorageUtils","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o){"use strict";const c=Object.freeze({PAYMENT_DONE:"paymentDone"}),d=t.extend({setup({tracker:e,paymentHelper:t,index:a,cart:c}={}){s.requiredOfPrototype(e,i,"options.tracker must be a CheckoutTracker"),s.requiredOfPrototype(t,n,"options.paymentHelper must be a PaymentHelper"),s.requiredOfPrototype(c,r,"options.cart must be a CartModel"),this.tracker=e,this.paymentHelper=t,this.cart=c,this._parent({title:o.get("orderConfirmation"),className:"mpf-confirm-free-order-section",index:a})},isComplete(){return this.paymentHelper.isCartPaid()},renderWriteMode(){return[{tag:"div",class:"mpf-price-container",html:[{tag:"div",class:"mpf-price-label",text:o.get("totalToPay")},{tag:"div",class:"mpf-price",text:this.paymentHelper.getTotalPrice().toLocaleString(a.getLanguageCookie(),{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})}]},new e({className:"primary",value:o.get("confirmOrder"),events:{onClick:this._confirmOrder.bind(this)}})]},destroy(){this.tracker=null,this.paymentHelper=null,this.cart=null,this._parent(),this.container=null},async _confirmOrder(){this.cart.set(r.Fields.STATE,r.States.PENDING_PAYMENT),this.mask();try{await this.cart.savePromise({[r.Fields.STATE]:r.States.PENDING_PAYMENT},{patch:!0}),await this.paymentHelper.saveQuote(),await this.paymentHelper.waitForPaymentCompletion(),this.unmask(),this.dispatchEvent(c.PAYMENT_DONE)}catch(e){this.unmask(),console.error(e),this.showError(o.get("unableToConfirmOrder"))}}});return d.Events=c,d}),define("DS/MPFCheckoutPage/payment/CardTokenList",["UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFCheckoutPage/payment/CardTokenTile","DS/MPFCheckoutPage/payment/PaymentHelper","DS/MPFCheckoutPage/DeleteModal","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o){"use strict";const c=Object.freeze({ADD_CARD:"addCard",ON_SELECT:"onSelect"}),d=e.extend({className:"mpf-card-token-list",setup({creditCardTokens:e,selectedToken:t,paymentHelper:i}={}){s.requiredOfPrototype(e,r,"options.creditCardTokens must be a PaymentCardTokenCollection"),s.requiredOfPrototype(i,n,"options.paymentHelper must be a PaymentHelper"),this.cardTiles=e.map(e=>this._createCardTile(e)),this.paymentHelper=i,this.addCardButton=this._createAddCardButton(),this.deleteModal=new a({isCardDeletion:!0})},render({initialToken:e,selectedToken:t}){return e&&(this._initialToken=e,this._selectedToken=null),t&&(this._selectedToken=t),this.container.setContent([this.deleteModal.render(),...this.cardTiles.map(e=>e.render({selectedCard:this._selectedToken||this._initialToken})),this.addCardButton]),this},saveSelection(){const e=this.getSelectedToken();return Promise.resolve(e)},getSelectedToken(){return this._selectedToken},isValid(){return this._selectedToken&&this._selectedToken!==this._initialToken},destroy(){this.stopListening(),this.cardTiles&&this.cardTiles.forEach(e=>{e.destroy()}),this.cardTiles=null,this._selectedToken=null,this._parent(),this.container=null},_showDeleteModal({creditCardToken:e}){this.stopListening(this.deleteModal),this.listenTo(this.deleteModal,a.Events.DELETION,this._deleteCard.bind(this,{creditCardToken:e})),this.deleteModal.show()},_createCardTile(e){const t=new i({creditCardToken:e});return this.listenTo(t,i.Events.ON_SELECT,({creditCardToken:e})=>{e!==this._selectedToken&&(this.render({selectedToken:e}),this.dispatchEvent(c.ON_SELECT,{token:e}))}),this.listenTo(t,i.Events.OPEN_DELETE_MODAL,this._showDeleteModal.bind(this,{creditCardToken:e})),t},_createAddCardButton(){return new t({value:o.get("addCard"),className:"default mpf-add-card-button",icon:"plus",events:{onClick:this.dispatchEvent.bind(this,c.ADD_CARD)}})},async _deleteCard({creditCardToken:e}){this.deleteModal.showLoader(!0);try{await this.paymentHelper.deleteCard({cardToDelete:e});const t=await this.paymentHelper.getCreditCardTokens();this.cardTiles=t.map(e=>this._createCardTile(e)),this.deleteModal.showLoader(!1),this.deleteModal.hide(),this.render({initialToken:this._initialToken})}catch(e){console.error(e),this.deleteModal.showLoader(!1),this.deleteModal.showError(o.get("unableToDeleteCreditCard"))}}});return d.Events=c,d}),define("DS/MPFCheckoutPage/orderSummary/MakeCartItemList",["DS/MPFServices/MarketplaceServices","DS/MPFCheckoutPage/orderSummary/CartItemList","DS/MPFCartModel/CartItemModel","DS/MPFView/ResponsiveTable","DS/MPFUtils/FormatUtils","i18n!DS/MPFCheckoutPage/assets/nls/OrderSummary"],function(e,t,s,r,i,n){"use strict";const a=Object.freeze({}),o=new Map;o.set("MP3DP_PrintRequest",n.get("baselineRequest")),o.set("MP_DeliveryServiceRequest",n.get("delivery")),o.set("MP3DP_FinishRequest",n.get("finish")),o.set("MP_AdditionalServiceRequest",n.get("additionalService")),o.set("MP_QuoteRequest",n.get("pricePerQuote"));const c=t.extend({setup({cart:t,service:s=e.MAKE}={}){this.service=s,this._parent({className:"mpf-make-cart-item-list",cart:t})},renderTable(){const e=this.cart.getItems(),t=this.cart.getCurrency();function i(e){return e===s.Types.MAKE_REQUEST?1:0}const a=e.sort((e,t)=>i(t.getType())-i(e.getType()));return new r({headerCells:[{tag:"div",text:n.get("item")},{tag:"div",text:n.get("quantity")},{tag:"div",class:"mpf-align-right",text:n.get("unitPriceTax")},{tag:"div",class:"mpf-align-right",text:n.get("taxes")},{tag:"div",class:"mpf-align-right",text:n.get("totalAmountWithTaxes")}],rows:a.map(e=>this._renderRow(e,t))}).render()},calculateNumberItems(){const e=this.cart.getItems();let t=0;return e.forEach(e=>{e.getType()===s.Types.MAKE_REQUEST&&(t+=parseInt(e.getQuantity()))}),t},_renderRow:(e,t)=>[{tag:"div",text:o.get(e.getType())},{tag:"div",text:parseInt(e.getQuantity())},{tag:"div",class:"mpf-align-right",text:i.formatPrice(e.getUnitNetAmount(),{currency:t})},{tag:"div",class:"mpf-align-right",text:i.formatPrice(e.getUnitTaxesAmount(),{currency:t})},{tag:"div",class:"mpf-align-right",text:i.formatPrice(e.getTotalGrossAmount(),{currency:t})}]});return c.Events=a,c}),define("DS/MPFCheckoutPage/billingAddress/BillingAddressList",["UWA/Class/View","UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFAddressFormComponent/AddressCard","DS/MPFCheckoutPage/DeleteModal","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m,y){"use strict";const g=Object.freeze({ADDRESS_SELECTED:"address_selected",CANCEL:"cancel",ON_ERROR:"onError",ADD_ADDRESS:"add_address"}),C=e.extend({className:"mpf-billing-address-list",setup({service:e,person:t,company:s,countries:r,billingAddressHelper:i,tracker:n}={}){a.requiredOfPrototype(t,d,"person must be a PersonModel"),a.requiredOfPrototype(r,h,"countries must be a CountryCollection"),a.requiredOfPrototype(i,p,"billingAddressHelper must be a BillingAddressHelper"),a.requiredOfPrototype(n,c,"options.tracker must be a CheckoutTracker"),s&&(a.requiredOfPrototype(s,l,"company must be a CompanyModel"),this.company=s),this.service=e,this.person=t,this.countries=r,this.billingAddressHelper=i,this.tracker=n,this.selectedAddressCard=null,this.addAddressButton=this._createAddAddressButton(),this.cancelButton=this._createCancelButton(),this.saveButton=this._createSaveButton(),this.deleteModal=new m},render(){return this._destroyCards(),this.addressCards=this._createAddressCards(),this.container.setContent([this.deleteModal.render(),this._createBillingAddressListSection({addressCards:this.addressCards}),(this.service===n.CLICK_AND_BUY||this.service===n.MAKE)&&{tag:"div",class:"mpf-add-address-button",html:this.addAddressButton},{tag:"div",class:"mpf-billing-address-list-footer",html:[this.saveButton,this.cancelButton]}]),this},_createBillingAddressListSection({addressCards:e}){const s=t.createElement("div",{class:"mpf-billing-address-list-addresses",html:e.map(e=>e.render()),styles:{height:e.length>2?"350px":""}});return t.createElement("div",{class:"mpf-billing-address-list-section",html:e.length>2?new i({element:s}):s})},destroy(){this.stopListening(),this._destroyCards(),this._destroyButtons(),this.deleteModal&&this.deleteModal.destroy(),this.deleteModal=null,this.person=null,this.company=null,this._parent(),this.container=null},_destroyCards(){this.addressCards&&this.addressCards.forEach(e=>{this.stopListening(e),e.destroy()}),this.addressCards=null},_destroyButtons(){[this.addAddressButton,this.saveButton,this.cancelButton].forEach(e=>{e&&e.destroy(),e=null})},async _save(){this.tracker.sendEvent("Next",{label:"NewTenantBillingAddressList"}),r.mask(this.container);const e=this.selectedAddressCard.getAddress();try{await this.billingAddressHelper.patchBillingAddress(e),r.unmask(this.container),this.tracker.sendEvent("Billing.SaveSuccess"),this.dispatchEvent(g.ADDRESS_SELECTED)}catch(e){console.error(e);const t=Object.prototype.isPrototypeOf.call(Error.prototype,e)&&e.message.length>0?e.message:y.get("errorBillingInfo");this.dispatchEvent(g.ON_ERROR,y.get(t)),r.unmask(this.container)}},_createAddressCards(){const e=this.billingAddressHelper.getSelectedAddress(),t=this.billingAddressHelper.getValidBillingAddresses(),s=this.service===n.CLICK_AND_BUY&&(this.billingAddressHelper.isCompanyBuyer()||t.length>1),r=1===t.length;return t.map(t=>{const i=this.countries.getCountryWithIso3(t.getCountry()),n=i&&i.getName(),a=new u({legalEntity:t.isCompanyAddress?this.company:this.person,country:n,address:t,showDeleteLink:s,noToggle:r,showTaxId:!0});return e===t&&(this.selectedAddressCard=a,this.selectedAddressCard.select(),this.saveButton.enable()),this.listenTo(a,u.Events.ON_SELECTED,()=>{this.selectedAddressCard!==a&&(this.selectedAddressCard&&this.selectedAddressCard.unselect(),this.selectedAddressCard=a,this.selectedAddressCard.select(),this.saveButton.enable())}),this.listenTo(a,u.Events.OPEN_DELETE_MODAL,this._showDeleteModal.bind(this,{address:t})),a})},_showDeleteModal({address:e}){this.stopListening(this.deleteModal),this.listenTo(this.deleteModal,m.Events.DELETION,this._deleteAddress.bind(this,{address:e})),this.deleteModal.show()},_createAddAddressButton(){return new s({className:"default",value:y.get("addAddress"),icon:"fonticon-plus",events:{onClick:this.dispatchEvent.bind(this,g.ADD_ADDRESS)}})},_createSaveButton(){return new s({className:"primary",value:y.get("save"),disabled:!this.selectedAddressCard,events:{onClick:this._save.bind(this)}})},_createCancelButton(){return new s({className:"default",value:y.get("cancel"),events:{onClick:this.dispatchEvent.bind(this,g.CANCEL)}})},async _deleteAddress({address:e}){const t=this.selectedAddressCard.getAddress();try{if(await this.billingAddressHelper.deleteAddress({addressToDelete:e}),this.stopListening(this.deleteModal),this.deleteModal.hide(),e===t)if(1===this.addressCards.length)this.dispatchEvent(g.ADD_ADDRESS);else{const t=this.addressCards.find(t=>t.getAddress().id!==e.id);await this._saveAfterDelete(t.getAddress())}else t!==this.billingAddressHelper.getSelectedAddress()&&await this._saveAfterDelete(t);this.render()}catch(e){console.error(e);const t=Object.prototype.isPrototypeOf.call(Error.prototype,e)&&e.message.length>0?e.message:y.get("errorBillingInfo");this.dispatchEvent(g.ON_ERROR,y.get(t))}},async _saveAfterDelete(e){r.mask(this.container);try{await this.billingAddressHelper.patchBillingAddress(e),r.unmask(this.container)}catch(e){console.error(e);const t=Object.prototype.isPrototypeOf.call(Error.prototype,e)&&e.message.length>0?e.message:y.get("errorBillingInfo");this.dispatchEvent(g.ON_ERROR,y.get(t)),r.unmask(this.container)}}});return C.Events=g,C}),define("DS/MPFCheckoutPage/orderSummary/OrderSummarySection",["DS/MPFCheckoutPage/CheckoutSection","DS/MPFUtils/StorageUtils","DS/MPFUtils/FormatUtils","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCartModel/CartModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCheckoutPage/orderSummary/QuoteTile","DS/MPFCheckoutPage/orderSummary/CnbCartItemList","DS/MPFCheckoutPage/orderSummary/MakeCartItemList","DS/MPFCheckoutPage/IconLink","i18n!DS/MPFCheckoutPage/assets/nls/OrderSummary"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m){"use strict";const y=Object.freeze({...e.Events,BACK_TO_CART:"backToCart"}),g=Object.freeze({BACK_TO_CART:"BackToCart"}),C=e.extend({setup({index:e,cart:t,cartQuote:s,person:r,company:l,billingAddressHelper:h,tracker:p,service:u,resetCartState:y}={}){i.requiredOfPrototype(t,a,"options.cart must be a CartModel"),i.requiredOfPrototype(s,o,"options.cartQuote must be a CartQuoteModel"),i.requiredOfPrototype(r,c,"options.person must be a PersonModel"),i.requiredOfPrototype(p,n,"options.tracker must be a CheckoutTracker"),i.requiredOfType(u,"string","options.service must be a string"),l&&(i.requiredOfPrototype(l,d,"company must be a CompanyModel"),this.company=l),this.cart=t,this.cartQuote=s,this.person=r,this.billingAddressHelper=h,this.tracker=p,this.service=u,this.resetCartState=y,this._parent({title:m.get("orderSummary"),className:"mpf-order-summary-section",index:e}),this.countryChangeInfo=this._createCountryChangeInfo(),this.quoteTile=this._createQuoteTile(),this.itemList=this._createItemList(),this.backToCartLink=this._createBackToCartLink()},isComplete:()=>!0,renderAdditionalHeaderContent(){return this.backToCartLink.render()},renderReadMode(){return[this.billingAddressHelper.mustDisplayCountryChangeInfo()&&this.countryChangeInfo,this.quoteTile.render(),this.itemList.render(),this._renderFooter()]},destroy(){this.stopListening(),this.itemList.destroy(),this.quoteTile.destroy(),this.backToCartLink.destroy(),this.itemList=null,this.quoteTile=null,this.backToCartLink=null,this.cart=null,this.cartQuote=null,this._parent(),this.container=null},async _patchCartState(){const e=this.service===r.CLICK_AND_BUY,t=this.service===r.SUBSCRIPTIONS&&this.cart.isSelfOrder(),s=this.service===r.INNOVATE,i=t||e&&!this.cart.isRenewal()||this.cart.isDirectPurchase()||s?a.States.DRAFT:a.States.SUBMITTED;this.cart.getState()!==i&&await this.cart.savePromise({[a.Fields.STATE]:i},{patch:!0})},_createCountryChangeInfo:()=>({tag:"div",class:"alert-message alert-primary alert-has-icon mpf-country-change-message",html:[{tag:"span",class:"icon fonticon"},{tag:"span",text:m.get("countryChangeInfoMessage")}]}),_createQuoteTile(){const e=new l({cart:this.cart,cartQuote:this.cartQuote,service:this.service,person:this.person,company:this.company,tracker:this.tracker});return this.listenTo(e,l.Events.ON_ERROR,({message:e})=>{this.showError(e)}),e},_createItemList(){return this.service===r.MAKE?new p({cart:this.cart}):new h({cart:this.cart,tracker:this.tracker})},_renderFooter(){return{tag:"div",class:"mpf-summary-footer",html:[this._renderFooterLine(m.get("subtotal"),this.cart.getNetAmountTotal()),this._renderFooterLine(m.get("taxes"),this._renderTotalTaxValue()),this._renderFooterLine(m.get("orderTotal"),this._renderTotalGrossValue(),{renderBold:!0})]}},_renderTotalTaxValue(){const e=parseFloat(this.cart.getTaxesAmountTotal()),t=parseFloat(this.cart.getNetAmountTotal());return this.cart.get(a.Fields.BILL_TO)||0===t?e:m.get("taxesCalculatedWithBillingAddress")},_renderTotalGrossValue(){const e=parseFloat(this.cart.getGrossAmountTotal()),t=parseFloat(this.cart.getNetAmountTotal());return this.cart.get(a.Fields.BILL_TO)||0===t?e:m.get("totalNotYetAvailable")},_renderFooterLine(e,t,{renderBold:r}={}){const i="string"==typeof t&&isNaN(parseFloat(t));return{tag:"div",class:"mpf-footer-line",html:[{tag:"span",text:e,class:"mpf-label"},{tag:i?"i":"span",text:i?t:s.formatPrice(parseFloat(t),{currency:this.cart.getCurrency()}),class:r?"mpf-value mpf-bold":"mpf-value"}]}},_createBackToCartLink(){const e=new u({icon:"back",text:m.get("backToCart")});return this.listenTo(e,u.Events.ON_CLICK,async()=>{this.maskPage();try{this.resetCartState&&await this._patchCartState(),this.unmaskPage(),this.tracker.sendEvent(g.BACK_TO_CART),this.dispatchEvent(y.BACK_TO_CART)}catch(e){this.unmaskPage(),this.showError(m.get("unableToResetCart"))}}),e}});return C.Events=y,C}),define("DS/MPFCheckoutPage/billingAddress/BillingAddressSection",["DS/MPFCheckoutPage/CheckoutSection","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCartModel/CartModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCountryModel/CountryCollection","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFCheckoutPage/billingAddress/CompanySearchForm","DS/MPFCheckoutPage/billingAddress/CompanySearchList","DS/MPFCheckoutPage/billingAddress/BillingAddressForm","DS/MPFCheckoutPage/billingAddress/BillingAddressList","DS/MPFAddressFormComponent/AddressCard","DS/MPFCheckoutPage/IconLink","i18n!DS/MPFCheckoutPage/assets/nls/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m,y,g,C){"use strict";const P=Object.freeze({...e.Events}),S=Object.freeze({COMPANY_SEARCH_FORM:"companySearchForm",COMPANY_SEARCH_LIST:"companySearchList",ADDRESS_FORM:"addressForm",ADDRESS_LIST:"addressList"}),T=e.extend({setup(e){t.requiredOfPrototype(e.tracker,r,"options.tracker must be a CheckoutTracker"),t.requiredOfPrototype(e.cart,i,"options.cart must be a CartModel"),t.requiredOfPrototype(e.person,n,"options.person must be a PersonModel"),t.requiredOfPrototype(e.companyFactory,o,"options.companyFactory must be a CompanyFactory"),t.requiredOfPrototype(e.addressFactory,c,"options.addressFactory must be a AddressFactory"),t.requiredOfPrototype(e.countries,d,"options.countries must be a CountryCollection"),t.requiredOfPrototype(e.billingAddressHelper,l,"options.billingAddressHelper must be a BillingAddressHelper"),t.requiredOfType(e.service,"string","options.service must be a MarketplaceServices instance"),t.requiredOfType(e.index,"number","options.index must be a number"),e.company&&(t.requiredOfPrototype(e.company,a,"options.company must be a CompanyModel"),this.company=e.company),e.companySearch&&(t.requiredOfPrototype(e.companySearch,a,"options.companySearch must be a CompanyModel"),this.companySearch=e.companySearch),this.tracker=e.tracker,this.person=e.person,this.company=e.company,this.countries=e.countries,this.billingAddressHelper=e.billingAddressHelper;const h=e.service===s.CLICK_AND_BUY&&!e.cart.hasMakerItems()&&!e.cart.hasEduItems()&&e.company.isNew();this.page=h?S.COMPANY_SEARCH_FORM:S.ADDRESS_FORM,this._parent({title:C.get("billingAddress"),className:"mpf-billing-address-section",index:e.index}),h&&(this.companySearchForm=this._createCompanySearchForm(e),this.companySearchList=this._createCompanySearchList(e)),this.addressForm=this._createAddressForm(e),this.addressList=this._createAddressList(e),this.addressCard=null,this.editLink=this._createEditLink()},isComplete(){return this.billingAddressHelper.isBillingInfoComplete()},renderAdditionalHeaderContent({state:t}){if(t===e.States.READ)return this.editLink.render()},renderWriteMode(e){let t;switch(this.page){case S.COMPANY_SEARCH_FORM:t=this.companySearchForm;break;case S.COMPANY_SEARCH_LIST:t=this.companySearchList;break;case S.ADDRESS_FORM:t=this.addressForm;break;case S.ADDRESS_LIST:t=this.addressList}return[t.render(e)]},renderReadMode(){this.addressCard&&this.addressCard.destroy();const e=this.billingAddressHelper.getSelectedAddress(),t=this.countries.getCountryWithIso3(e.getCountry()),s=t&&t.getName();return this.addressCard=new y({legalEntity:e.isCompanyAddress?this.company:this.person,country:s,address:e,readOnly:!0}),[this.addressCard.render()]},destroy(){this.stopListening(),this.companySearchForm&&this.companySearchForm.destroy(),this.companySearchList&&this.companySearchList.destroy(),this.addressForm&&this.addressForm.destroy(),this.addressList&&this.addressList.destroy(),this.addressCard&&this.addressCard.destroy(),this.editLink&&this.editLink.destroy(),this.companySearchForm=null,this.companySearchList=null,this.addressForm=null,this.addressList=null,this.addressCard=null,this.editLink=null,this.person=null,this.company=null,this.countries=null,this.billingAddressHelper=null,this._parent(),this.container=null},_changePage(e,t){this.page!==e&&(this.page=e,this.render({editIndex:this.index,...t}))},_createCompanySearchForm(e){const t=new h({tracker:e.tracker,company:e.company,companySearch:e.companySearch,companyFactory:e.companyFactory,addressFactory:e.addressFactory,countries:e.countries,billingAddressHelper:e.billingAddressHelper,service:this.service});return this.listenTo(t,h.Events.TO_COMPANY_SELECTION,this._changePage.bind(this,S.COMPANY_SEARCH_LIST)),this.listenTo(t,h.Events.COMPANY_SELECTED,this.next.bind(this)),this.listenTo(t,h.Events.ON_ERROR,e=>this.showError(e)),t},_createCompanySearchList(e){const t=new p({tracker:e.tracker,company:e.company,companySearch:e.companySearch,companyFactory:e.companyFactory,addressFactory:e.addressFactory,countries:e.countries,billingAddressHelper:e.billingAddressHelper});return this.listenTo(t,p.Events.ADDRESS_SELECTED,this.next.bind(this)),this.listenTo(t,p.Events.CANCEL,this._changePage.bind(this,S.COMPANY_SEARCH_FORM)),this.listenTo(t,p.Events.ON_ERROR,e=>this.showError(e)),t},_createAddressForm(e){const t=new u({tracker:e.tracker,service:e.service,person:e.person,company:e.company,companyFactory:e.companyFactory,addressFactory:e.addressFactory,countries:e.countries,billingAddressHelper:e.billingAddressHelper});return this.listenTo(t,u.Events.ADDRESS_SAVED,this.next.bind(this)),this.listenTo(t,u.Events.CANCEL,this._changePage.bind(this,S.ADDRESS_LIST)),this.listenTo(t,u.Events.ON_ERROR,e=>this.showError(e)),t},_createAddressList(e){const t=new m({service:e.service,person:e.person,company:e.company,countries:e.countries,billingAddressHelper:e.billingAddressHelper,tracker:e.tracker});return this.listenTo(t,m.Events.ADD_ADDRESS,this._changePage.bind(this,S.ADDRESS_FORM,{isNewAddress:!0})),this.listenTo(t,m.Events.ADDRESS_SELECTED,this.next.bind(this)),this.listenTo(t,m.Events.CANCEL,this.next.bind(this)),this.listenTo(t,m.Events.ON_ERROR,e=>this.showError(e)),t},_createEditLink(){const e=new g({text:C.get("edit"),icon:"pencil"});return this.listenTo(e,g.Events.ON_CLICK,()=>{this.tracker.sendEvent(r.Events.EDIT,{label:"BillingAddressSection"}),this.page=S.ADDRESS_LIST,this.toEditMode()}),e}});return T.Pages=S,T.Events=P,T}),define("DS/MPFCheckoutPage/payment/CreditCardPaymentTile",["DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Button","DS/WebappsUtils/WebappsUtils","DS/MPFCheckoutPage/payment/PaymentMethodTile","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFStripeComponent/StripeCreditCardForm","DS/MPFCheckoutPage/payment/CardTokenList","DS/MPFCheckoutPage/payment/SelectedCardTokenTile","DS/MPFCheckoutPage/IconLink","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o,c,d,l,h){"use strict";const p=Object.freeze({FORM:"form",LIST:"list",SHOW_SELECTION:"showSelection"}),u=r.extend({setup({person:e,cart:t,phase:s,psp:r,creditCardTokens:i,paymentHelper:n,tracker:o}={}){if(this.person=e,this.cart=t,this.phase=s,this.psp=r,this.creditCardTokens=i,this.paymentHelper=n,this.tracker=o,this._parent({cart:t,paymentHelper:n,paymentMethod:a.PaymentMethods.BANK_CARD,title:h.get("bankCard"),className:"mpf-credit-card-payment-tile"}),this.creditCardTokens.size()>0){const e=this.creditCardTokens.find(e=>e.isDefaultPaymentMethod());this._selectedToken=e||this.creditCardTokens.first(),this.state=p.SHOW_SELECTION}else this.state=p.FORM;this.saveCardToggle=this._createSaveCardToggle(),this.form=this._createStripeCreditCardForm(),this.list=this._createTokenList({selectedToken:this._selectedToken}),this.selectedCardTile=this._createSelectedCardTokenTile(),this.editLink=this._createEditLink(),this.saveButton=this._createSaveButton()},renderIcons({isSelected:e}){const t=[{tag:"img",class:"mpf-bank-card-icon mpf-visa-icon",src:this._getImageSourceFor("VISA_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-master-card-icon",src:this._getImageSourceFor("MasterCard_512px.png")},{tag:"img",class:"mpf-bank-card-icon mpf-amex-card-icon",src:this._getImageSourceFor("AmericanExpress-2_512px.png")}];return e&&this.state===p.SHOW_SELECTION&&t.push(this.editLink.render()),t},renderBody(){let e;return this.state===p.SHOW_SELECTION?e=[this.selectedCardTile.render({token:this._selectedToken}),this.paymentHelper.isRecurringPurchase()&&this._renderToggleContainer(this.saveCardToggle)]:this.state===p.FORM?e=[this.form.render(),this._renderToggleContainer(this.saveCardToggle)]:(e=[this.list.render({initialToken:this._selectedToken})],this.list.isValid()?this.saveButton.enable():this.saveButton.disable()),this._setPaymentButtonState(),e},renderFooter(){if(this.state===p.LIST)return[this.saveButton,new t({value:h.get("cancel"),events:{onClick:()=>{this.state=p.SHOW_SELECTION,this.render()}}})];if(this.state===p.FORM&&this.creditCardTokens.size()>0){const e=this._parent();return e.splice(1,0,new t({value:h.get("back"),events:{onClick:()=>{this.state=p.LIST,this.render()}}})),e}return this._parent()},async pay(){const e=this.saveCardToggle.isChecked();if(await this.paymentHelper.patchPaymentMethod(),this.state===p.SHOW_SELECTION)this._sendPaymentInititationTrackerEvent(i.PaymentTypes.PAYMENT_CARD_TOKEN),await this.paymentHelper.patchCartPaymentState({selectedToken:this._selectedToken,saveCardToken:e}),await this.paymentHelper.saveQuote(),await this.selectedCardTile.pay();else if(this._sendPaymentInititationTrackerEvent(i.PaymentTypes.PAYMENT_CARD),this.psp.isScaEnabled())await this.paymentHelper.patchCartPaymentState({saveCardToken:e}),await this.paymentHelper.saveQuote(),await this.form.pay();else{await this.paymentHelper.saveQuote();const{token:t}=await this.form.pay();await this.paymentHelper.patchCartPaymentState({saveCardToken:e,stripeToken:t})}await this.paymentHelper.waitForPaymentCompletion()},destroy(){this.stopListening(),this.form.destroy(),this.list.destroy(),this.editLink.destroy(),this.form=null,this.list=null,this.editLink=null,this.cart=null,this.psp=null,this.paymentHelper=null,this._parent(),this.container=null},_sendPaymentInititationTrackerEvent(e){this.tracker.sendEvent(i.Events.PAYMENT_INITIATED,{paymentType:e})},_isValid(){const e=!this.paymentHelper.isRecurringPurchase()||this.saveCardToggle.isChecked();let t;return(t=this.state===p.FORM?this.form.isValid():!!this._selectedToken&&!this._selectedToken.isExpired())&&e},_setPaymentButtonState(){this._isValid()?this.enablePaymentButton():this.disablePaymentButton()},_getImageSourceFor:e=>s.getWebappsAssetUrl("MPFCheckoutPage","graphics/")+e,_renderToggleContainer:e=>({tag:"div",class:"mpf-outer-toggle-container",html:[{tag:"div",class:"mpf-inner-toggle-container",html:e}]}),_createStripeCreditCardForm(){const e=new o({person:this.person,cart:this.cart,phase:this.phase,psp:this.psp,stripeContainerSelector:"body"});return this.listenTo(e,o.Events.ON_VALIDATION_STATE_CHANGE,this._setPaymentButtonState.bind(this)),e},_createSelectedCardTokenTile(){return new d({cart:this.cart,psp:this.psp,paymentHelper:this.paymentHelper})},_createTokenList({selectedToken:e}){const t=new c({creditCardTokens:this.creditCardTokens,selectedToken:e,paymentHelper:this.paymentHelper});return this.listenTo(t,c.Events.ADD_CARD,()=>{this.state=p.FORM,this.render()}),this.listenTo(t,c.Events.ON_SELECT,()=>{this.list.isValid()?this.saveButton.enable():this.saveButton.disable()}),t},_createSaveCardToggle(){const t=this.paymentHelper.isRecurringPurchase()?h.get("understandRecurringMsg"):h.get("saveCC");return new e({type:"checkbox",value:t,className:"primary",events:{onClick:this._setPaymentButtonState.bind(this)}})},_createEditLink(){const e=new l({text:h.get("edit"),icon:"pencil"});return this.listenTo(e,l.Events.ON_CLICK,()=>{this.state=p.LIST,this.render()}),e},_createSaveButton(){return new t({className:"primary",value:h.get("save"),disabled:!this._isValid(),events:{onClick:async()=>{try{this._selectedToken=await this.list.saveSelection(),this.state=p.SHOW_SELECTION,this.render()}catch(e){console.error(e)}}}})}});return u.Events=r.Events,u}),define("DS/MPFCheckoutPage/payment/PaymentSection",["DS/MPFCheckoutPage/CheckoutSection","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFPersonModel/PersonModel","DS/MPFCheckoutPage/payment/PaymentHelper","DS/MPFCheckoutPage/payment/PaymentMethodTile","DS/MPFCheckoutPage/payment/CouponTile","DS/MPFCheckoutPage/payment/CreditCardPaymentTile","DS/MPFCheckoutPage/payment/CabBankTransferTile","DS/MPFCheckoutPage/payment/MakeBankTransferTile","DS/MPFCheckoutPage/payment/UnifiedPaymentsInterfaceTile","DS/MPFCheckoutPage/payment/CcAvenueTile","i18n!DS/MPFCheckoutPage/assets/nls/Payment"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m,y){"use strict";const g=Object.freeze({...e.Events,PAYMENT_DONE:"paymentDone"}),C=e.extend({setup({tracker:e,paymentHelper:s,index:n,cart:c,person:d,service:l,paymentResultUrl:h}={}){t.requiredOfPrototype(e,r,"options.tracker must be a CheckoutTracker"),t.requiredOfPrototype(c,i,"options.cart must be a CartModel"),t.requiredOfPrototype(s,o,"options.paymentHelper must be a PaymentHelper"),t.requiredOfPrototype(d,a,"options.person must be a PersonModel"),t.requiredOfType(n,"number","options.index must be a number"),t.requiredOfType(l,"string","options.service must be a string"),this.tracker=e,this.cart=c,this.paymentHelper=s,this.person=d,this.service=l,this.paymentResultUrl=h,this._parent({title:y.get("payment"),className:"mpf-payment-section",index:n,alertHideDelay:6e3})},isComplete(){return this.paymentHelper.isCartPaid()},load(){return this.paymentHelper.loadData().then(({psp:e,creditCardTokens:t,purchaseOrder:r,purchaseOrderDocument:i,virtualIbans:n})=>{this.psp=e,this.creditCardTokens=t,this.purchaseOrder=r,this.purchaseOrderDocument=i,this.virtualIbans=n,this._destroyTiles(),this.couponTile=this._createCouponTile(),this.psp.isCcAvenue()?this.ccAvenueTile=this._createCcAvenueTile():(this.ccTile=this._createCcTile(),this.paymentHelper.hasBankTransferOption()&&this.service!==s.INNOVATE&&(this.btTile=this._createBtTile()),this.psp.isPayU()&&(this.upiTile=this._createUpiTile()))})},renderAdditionalHeaderContent({state:t}){if(t===e.States.DISABLED)return{tag:"div",class:"mpf-payment-icons",html:[{tag:"span",class:"fonticon fonticon-credit-card"}]}},renderWriteMode(){const e=this.psp.getPaymentMethod(),t=this.paymentHelper.getTotalPriceMinusCoupon(),s=[];return this.paymentHelper.showCouponSection()&&s.push(this.couponTile),t>0&&(this.psp.isCcAvenue()?s.push(this.ccAvenueTile):(e.includes(n.PaymentMethod.CREDIT_CARD)&&s.push(this.ccTile),this.btTile&&e.includes(n.PaymentMethod.BANK_TRANSFER)&&s.push(this.btTile),this.upiTile&&e.includes(n.PaymentMethod.UNIFIED_PAYMENTS_INTERFACE)&&s.push(this.upiTile))),s.map(e=>e.render())},destroy(){this._destroyTiles(),this.paymentHelper=null,this.cart=null,this.psp=null,this.creditCardTokens=null,this.virtualIbans=null,this._parent(),this.container=null},_onError({errorCode:e,message:t}){this.unmaskPage(),"Error.BankTransferNotAllowed"===e&&//! temporary solution, remove once resolved at back end
this._onBankTransferLimitError(),this.showError(t),this.tracker.sendEvent(r.Events.PAYMENT_DECLINED)},_onPaymentDone(){this.unmaskPage(),this.tracker.sendEvent(r.Events.PAYMENT_COMPLETED),this.dispatchEvent(g.PAYMENT_DONE)},_onBankTransferLimitError(){
//! Deactivate the bank transfer tile after patch error: Temporary solution until backend does not return BT method anymore
const e=this.psp.getPaymentMethod().find(e=>e!==n.PaymentMethod.BANK_TRANSFER);e&&(this.cart.setPaymentMethod(e),this.btTile.disable(),this.render({editIndex:this.index}))},_destroyTiles(){this.couponTile&&(this.stopListening(this.couponTile),this.couponTile.destroy(),this.couponTile=null),this.ccTile&&(this.stopListening(this.ccTile),this.ccTile.destroy(),this.ccTile=null),this.btTile&&(this.stopListening(this.btTile),this.btTile.destroy(),this.btTile=null),this.upiTile&&(this.stopListening(this.upiTile),this.upiTile.destroy(),this.upiTile=null)},_createCouponTile(){const e=new d({cart:this.cart,paymentHelper:this.paymentHelper,tracker:this.tracker});return this.listenTo(e,d.Events.LOAD,()=>this.mask()),this.listenTo(e,d.Events.ON_CHANGE,()=>{this.unmask(),this.render({editIndex:this.index})}),e},_createCcTile(){const e=new l({person:this.person,cart:this.cart,phase:this.phase,psp:this.psp,creditCardTokens:this.creditCardTokens,paymentHelper:this.paymentHelper,tracker:this.tracker});return this._addPaymentTileListeners(e),e},_createBtTile(){let e;const t={cart:this.cart,psp:this.psp,purchaseOrder:this.purchaseOrder,purchaseOrderDocument:this.purchaseOrderDocument,virtualIbans:this.virtualIbans,paymentHelper:this.paymentHelper,service:this.service,tracker:this.tracker};return e=this.service===s.MAKE?new p(t):new h(t),this._addPaymentTileListeners(e),e},_createUpiTile(){const e=new u({cart:this.cart,paymentHelper:this.paymentHelper});return this._addPaymentTileListeners(e),e},_createCcAvenueTile(){const e=new m({cart:this.cart,paymentHelper:this.paymentHelper,service:this.service,paymentResultUrl:this.paymentResultUrl});return this._addPaymentTileListeners(e),e},_addPaymentTileListeners(e){this.listenTo(e,c.Events.ON_SELECTED,this.render.bind(this,{editIndex:this.index})),this.listenTo(e,c.Events.ON_ERROR,this._onError.bind(this)),this.listenTo(e,c.Events.ON_PAYMENT_DONE,this._onPaymentDone.bind(this)),this.listenTo(e,c.Events.LOAD,this.maskPage.bind(this,y.get("paymentInProgress")))}});return C.Events=g,C}),define("DS/MPFCheckoutPage/CheckoutPage",["UWA/Class/View","DS/UIKIT/Mask","DS/MPFCartModel/CartModel","DS/MPFServices/MarketplaceServices","DS/MPFCheckoutPage/CheckoutStateMachine","DS/MPFCheckoutPage/CheckoutTracker","DS/MPFCheckoutPage/CheckoutSection","DS/MPFCheckoutPage/orderSummary/OrderSummarySection","DS/MPFCheckoutPage/billingAddress/BillingAddressSection","DS/MPFCheckoutPage/termsAndConditions/CnbTermsAndConditionsSection","DS/MPFCheckoutPage/termsAndConditions/InnovateTermsAndConditionsSection","DS/MPFCheckoutPage/termsAndConditions/MakeTermsAndConditionsSection","DS/MPFCheckoutPage/payment/PaymentSection","DS/MPFCheckoutPage/payment/ConfirmFreeOrderSection","DS/MPFCheckoutPage/phoneNumber/PhoneNumberSection","css!DS/MPFCheckoutPage/MPFCheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m){"use strict";const y=Object.freeze({BACK_TO_CART:"backToCart",PAYMENT_DONE:"paymentDone"}),g=e.extend({className:"mpf-checkout-page",setup(e){this.cart=e.cart,this.psp=e.psp,this.service=e.service,this.isBusinessExperienceByDS=!0===e.isBusinessExperienceByDS,this.tracker=this._createTracker(e),this.sections=[this._createOrderSummarySection({...e,index:0}),this._createBillingAddressSection({...e,index:1}),this._createPhoneNumberSection({...e,index:2}),this._createTermsAndConditionsSection({...e,index:3}),this._createPaymentSection({...e,index:4})],this.stateMachine=this._createStateMachine({sections:this.sections}),this.tracker.sendPage({url:"/checkout",title:"Checkout Page"})},async load(){this.showLoader(!0),await this.stateMachine.loadDataAndGenerateEditIndex(),this.showLoader(!1)},showLoader(e=!0,s){e?t.mask(this.container,s):t.unmask(this.container)},render(){const e=this.stateMachine.getEditIndex();return this.container.setContent(this.sections.map(t=>t.render({editIndex:e}))),this},destroy(){this.stopListening(),this.sections.map(e=>e.destroy()),this.stateMachine.destroy(),this.sections=null,this.stateMachine=null,this.cart=null,this.service=null,this._parent(),this.container=null},_next(){this.load().then(()=>{this.render(),this._scrollToActiveSection()})},_editSection({index:e}){this.stateMachine.setEditIndex(e),this.render()},_scrollToActiveSection(){const e=this.stateMachine.getEditIndex(),t=this.sections[e];t&&t.scrollIntoView()},_createOrderSummarySection({index:e,cart:t,cartQuote:s,service:r,person:i,company:n,billingAddressHelper:a,resetCartState:c}){const d=new o({tracker:this.tracker,cart:t,cartQuote:s,service:r,person:i,company:n,index:e,billingAddressHelper:a,resetCartState:c});return this._addSectionListener(d),this.listenTo(d,o.Events.BACK_TO_CART,this.dispatchEvent.bind(this,y.BACK_TO_CART)),d},_createBillingAddressSection(e){const t=new c({service:e.service,tracker:this.tracker,index:e.index,cart:e.cart,person:e.person,company:e.company,companySearch:e.companySearch,companyFactory:e.companyFactory,addressFactory:e.addressFactory,countries:e.countries,billingAddressHelper:e.billingAddressHelper});return this._addSectionListener(t),t},_createPhoneNumberSection(e){const t=new m({index:e.index,billingAddressHelper:e.billingAddressHelper,person:e.person,psp:e.psp,cart:e.cart,addressFactory:e.addressFactory,tracker:this.tracker});return this._addSectionListener(t),t},_createTermsAndConditionsSection({termsAndConditionsHelper:e,billingAddressHelper:t,index:s,cart:i,service:n}){let a;const o={tracker:this.tracker,termsAndConditionsHelper:e,billingAddressHelper:t,index:s,cart:i};switch(n){case r.CLICK_AND_BUY:case r.SUBSCRIPTIONS:case r.IFWELOOP:a=new d(o);break;case r.INNOVATE:a=this.isBusinessExperienceByDS?new d(o):new l(o);break;case r.MAKE:a=new h(o);break;default:console.error("No T&C section available!")}return this._addSectionListener(a),a},_createPaymentSection({index:e,cart:t,person:s,psp:r,paymentHelper:i,service:n,paymentResultUrl:a}){const o={tracker:this.tracker,index:e,cart:t,person:s,psp:r,paymentHelper:i,service:n,paymentResultUrl:a};let c;return c=0===parseFloat(t.getNetAmountTotal())?new u(o):new p(o),this._addSectionListener(c),this.listenTo(c,p.Events.PAYMENT_DONE,this.dispatchEvent.bind(this,y.PAYMENT_DONE)),c},_addSectionListener(e){this.listenTo(e,a.Events.MASK_PAGE,this.showLoader.bind(this)),this.listenTo(e,a.Events.NEXT_SECTION,this._next.bind(this)),this.listenTo(e,a.Events.EDIT_SECTION,this._editSection.bind(this))},_createStateMachine:({sections:e})=>new i({sections:e}),_createTracker:({person:e,cart:t,psp:s,billingAddressHelper:r,service:i})=>new n({person:e,cart:t,psp:s,billingAddressHelper:r,service:i})});return g.Events=y,g}),define("DS/MPFCheckoutPage/CheckoutPageFactory",["DS/MPFConnector/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFPersonModel/PersonFactory","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCompanyModel/CompanyFactory","DS/MPFShopModel/ShopFactory","DS/MPFShopModel/ShopModel","DS/MPFAddressModel/AddressFactory","DS/MPFCountryModel/CountryFactory","DS/MPFCountryModel/CountryModel","DS/MPFPspModel/PspFactory","DS/MPFCartQuoteModel/CartQuoteFactory","DS/MPFBuyer/BuyerType","DS/MPFCheckoutPage/billingAddress/BillingAddressHelper","DS/MPFCheckoutPage/termsAndConditions/TermsAndConditionsHelper","DS/MPFCheckoutPage/payment/PaymentHelper","DS/MPFCheckoutPage/CheckoutPage"],function(e,t,s,r,i,n,a,o,c,d,l,h,p,u,m,y,g,C,P,S,T){"use strict";class A{static async createComponent({cartId:r,connector:i,service:n,resetCartState:a=!0,paymentResultUrl:c}){i=i||await e.fetchPromise({service:n});const d=s.getInstance(i),[l,p,u,g,A,E,M,_,D,f,F,I,v,k,b,N]=await d.getFactories([s.Types.PERSON,s.Types.CART,s.Types.COMPANY,s.Types.SHOP,s.Types.ADDRESS,s.Types.COUNTRY,s.Types.PSP,s.Types.CART_QUOTE,s.Types.TC_CONTRACT,s.Types.TC_DOCUMENT,s.Types.SOFTWARE_AGREEMENT,s.Types.VIRTUAL_IBAN,s.Types.PAYMENT_CARD_TOKEN,s.Types.PURCHASE_ORDER,s.Types.PURCHASE_ORDER_DOCUMENT,s.Types.WAIT_FOR_PAYMENT]),[{person:O,cart:L,shop:B,company:x,companySearch:R,companyAddresses:w,isBuyerTypeEditable:H},U,V]=await Promise.all([this._fetchMeCartShopCompanyWithAddresses({cartId:r,personFactory:l,cartFactory:p,companyFactory:u,shopFactory:g,addressFactory:A,paymentCardTokenFactory:v,service:n}),A.createCollection(h.Types.ME).fetchPromise(),this._fetchCountries({countryFactory:E,service:n})]),q=n===t.INNOVATE&&await o.isBusinessExperienceByDS(L),Y=_.createModel(y.Types.CART_QUOTE,null,{parentResourceId:r}),K=M.createModel(m.Types.CART_PSP,null,{parentResourceId:r}),W=this._getBuyerType({person:O,cart:L,company:x,companyAddresses:w,service:n}),G=new C({buyerType:W,isBuyerTypeEditable:H,person:O,cart:L,company:x,companyAddresses:w,personAddresses:U,countries:V,addressFactory:A,service:n}),j=new P({cart:L,shop:B,billingAddressHelper:G,tcContractFactory:D,tcDocumentFactory:f,softwareAgreementFactory:F,service:n}),Q=new S({cart:L,psp:K,cartQuote:Y,paymentCardTokenFactory:v,virtualIbanFactory:I,purchaseOrderFactory:k,purchaseOrderDocumentFactory:b,waitForPaymentFactory:N,billingAddressHelper:G,service:n});await G.patchDefaultCartBillingAddress();const z=new T({person:O,psp:K,cart:L,cartQuote:Y,company:x,companySearch:R,companyFactory:u,shop:B,addressFactory:A,countries:V,service:n,billingAddressHelper:G,termsAndConditionsHelper:j,paymentHelper:Q,isBusinessExperienceByDS:q,resetCartState:a,paymentResultUrl:c});return await z.load(),z}static async _fetchMeCartShopCompanyWithAddresses({cartId:e,personFactory:s,cartFactory:i,companyFactory:o,shopFactory:c,addressFactory:d,service:l}){const[h,p]=await Promise.all([s.createModel(r.Types.ME).fetchPromise(),i.createModel(n.Types.CART,{id:e}).fetchPromise({expand:[a.Expands.CART_ITEMS]})]),u=l===t.CLICK_AND_BUY&&!p.hasEduItems()&&!p.hasMakerItems(),[m,{company:y,companySearch:g,companyAddresses:C,isBuyerTypeEditable:P}]=await Promise.all([this._fetchShop({shopFactory:c,cart:p,service:l}),this._fetchCompanyWithAddresses({personFactory:s,companyFactory:o,addressFactory:d,person:h,cart:p,service:l,isClickAndBuyForCompanies:u})]);return{person:h,cart:p,company:y,companySearch:g,companyAddresses:C,shop:m,isBuyerTypeEditable:P}}static _fetchShop({shopFactory:e,cart:t,service:s}){if(!this._isCloudLicensePurchase(s))return e.createModel(d.Types.SHOP,{id:t.getShopId()}).fetchPromise({expand:[l.Expands.SHOP_SERVICES]})}static async _fetchCompanyWithAddresses({companyFactory:e,addressFactory:s,person:r,cart:i,service:n,isClickAndBuyForCompanies:a}){const o=this._isCloudLicensePurchase(n)||n===t.INNOVATE?i.getCompanyID():r.getCompanyId();let d,l,p;const u=this._isBuyerTypeEditable({cart:i,service:n});return(o||a||u)&&(e.addressFactory=s,o?(d=e.createModel(c.Types.COMPANY,{id:o}),await d.fetchPromise(),p=d.addresses):a?(l=e.createModel(c.Types.MATCHING_COMPANIES),d=e.createModel(c.Types.ME),p=s.createCollection(h.Types.COMPANY)):u&&(d=e.createModel(c.Types.COMPANY),p=s.createCollection(h.Types.COMPANY))),{company:d,companySearch:l,companyAddresses:p,isBuyerTypeEditable:u}}static async _fetchCountries({countryFactory:e,service:s}){if(s===t.CLICK_AND_BUY){const[t,s]=await Promise.all([e.createCollection(p.Types.BUYER).fetchPromise(),e.createCollection(p.Types.GENERIC_BUSINESS).fetchPromise()]),r=s.pluck(u.Fields.ISO2);return e.createCollection(p.Types.BUYER,t.filter(e=>r.includes(e.getIso2())))}return e.createCollection(p.Types.BUYER).fetchPromise()}static _getBuyerType({cart:e,person:s,company:r,companyAddresses:n,service:o}){let c;const d=e.get(a.Fields.SHIP_TO);return c=d?n&&n.find(e=>e.get("id")===d)?g.COMPANY:g.INDIVIDUAL:!r||e.hasEduItems()||e.hasMakerItems()?g.INDIVIDUAL:g.COMPANY,o===t.CLICK_AND_BUY&&s.set(i.Fields.BUYER_TYPE,c),c}static _isBuyerTypeEditable({cart:e,service:s}){return!e.get(a.Fields.SHIP_TO)&&s===t.MAKE}static _isCloudLicensePurchase(e){return e===t.IFWELOOP||e===t.CLICK_AND_BUY||e===t.SUBSCRIPTIONS}}return A.Events=T.Events,A});