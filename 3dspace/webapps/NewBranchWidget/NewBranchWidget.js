define("DS/NewBranchWidget/NewBranchWidget",["UWA/Controls/Abstract","DS/ENO6WPlugins/jQuery","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleControls/CredentialList","DS/LifecycleControls/DelayedMask","DS/LifecycleServices/DefaultCredential","DS/LifecycleServices/HTMLTemplating","DS/WAFData/WAFData","DS/LifecycleServices/WebReq","DS/WebToWinInfra/WebToWinCom","DS/WebInWinHelper/WebInWinHelper","DS/UIKIT/Input/Button","DS/Controls/ComboBox","DS/Controls/Editor","DS/Controls/LineEditor","DS/LifecycleControls/CommandDialog","DS/LifecycleControls/DataGridViewContainer","DS/LifecycleControls/InputValidation","DS/LifecycleCmd/MessageMediator","DS/WidgetServices/WidgetServices","DS/LifecycleServices/NewBranchObjectProp","DS/LifecycleServices/LifecycleAlert","DS/ErrorWidget/ErrorWidget","DS/Windows/ImmersiveFrame","DS/DuplicateWidget/AdvancedDuplicateTree","DS/DuplicateWidget/ExpandReqBuilder","DS/DuplicateWidget/expandTree/expand","DS/LifecycleCmd/SelectionUtil","DS/ENOCollabToolsUI/tracker/ENOCollabTracker","DS/ENOCollabToolsUI/tracker/ENOCollabTrackerBackEnd","DS/LifecycleServices/Utils","css!DS/NewBranchWidget/NewBranchWidget","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/NewBranchWidget/assets/nls/NewBranchWidgetNls","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","i18n!DS/WidgetServicesUI/assets/nls/i18nWidgetService"],function(e,t,i,n,a,s,r,o,c,l,d,h,u,m,p,g,v,f,b,_,y,w,S,C,E,A,L,D,I,P,j,T,k,W,N,B,x,O){"use strict";return e.extend({init:function(e,t,n){this.odtmode=!1,this.wintop=!1,this.auto_execute=!1,this.force_multiple_selection_ui=!1,this.without_cred=!1,this.hasCredentials=!1,this.dup_string="",this.selectionList=[],this.objectsList=[],this.intentsList=[],this.isThereLinearData=!1,this.nbDisplayedObjects=0,this.context={},this.tenant=null,this.folderId=null,this.wintop_ChangeActionId=null,this.initBL_already_called=!1,this.objectsListTable=null,this.objectProp=null,this.intentsListSel=null,this.dupStringDiv=null,this.dupStringInput=null,this.commentInput=null,this._parent(n),this.commandManager=new i,this.content=UWA.createElement("div",{class:"newbranch_content dlg_cmd_content"}),this.container=UWA.createElement("div",{class:"newbranch_container"}),this.content.inject(this.container),this.useAdvancedBranch=!1,this.roots=[],this.providerIdSet=new Set,this.updateCSWarning=k.debounce(this._updateCollabSpaceWarning.bind(this),200),this.addEvent("AdvancedUIModeChanged",()=>{this.updateCSWarning()}),this.isTargetCSPrivate=!1,this._getIsTargetCSPrivate=(()=>this.isTargetCSPrivate),n&&n.odtmode&&(this.odtmode=!0),n&&n.without_cred&&(this.without_cred=!0),n&&n.wintop&&(this.wintop=!0,this.without_cred=!0,u.initTenant(this),u.getServices(this),this.webToWinCom_Socket=h.createSocket({socket_id:"WebInWin_NewBranchWidget_Socket_"+Math.floor(1e5*Math.random()+1)}),void 0!==this.options.serverUrl&&this.options.serverUrl.length>0&&(void 0!==this.options.serverUrl[0].platformId&&(this.tenant=this.options.serverUrl[0].platformId),a.setTenant(this.tenant)),n.hasOwnProperty("ChangeActionId")&&(this.wintop_ChangeActionId=n.ChangeActionId),"TRUE"===n.ENOVIA_ForceNewBranchMultiple&&(this.force_multiple_selection_ui=!0),"TRUE"===n.ODT_MODE&&(this.wintop_odt_mode=!0),"TRUE"===n.auto_execute&&(this.auto_execute=!0),n.hasOwnProperty("dup_string")&&(this.dup_string=n.dup_string),this.footerDiv=UWA.createElement("div",{class:"newbranch_footer modal-footer"}),this.footerDiv.inject(this.container),this.container.addClassName("column_flex_container"),this.container.addClassName("webinwin_lc_command_dialog"))},initDatafromWin:function(e){var t=[];e.forEach(function(e){var i=e.physicalId,n=e.name,a={physicalid:i,name:n,displayName:n};t.push(a)}),console.log("initDatafromWin / selection size: "+e.length),console.log("initDatafromWin / tenant: "+this.tenant),this.executeCmd(t)},onRefresh:function(){console.log("onRefresh called from win")},onResize:function(){console.log("onResize called from win")},_CloseWebInWinPanel:function(){this.wintop&&(console.log("CloseWebInWinPanel"),this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"ClosePanel",notif_parameters:"ClosePanel",recordable:!0},"lf_web_in_win"))},_setWaitingResponse:function(){void 0!==this.widget&&null!==this.widget?this.widget.body.style.cursor="wait":document.body.style.cursor="wait"},_setEndWaitingResponse:function(){void 0!==this.widget&&null!==this.widget?this.widget.body.style.cursor="default":document.body.style.cursor="default"},_onComplete:function(){},_onCompleteWithoutClose:function(){},_onOk:function(){},_onCancel:function(){},_getUniqueListBy:function(e,t){return[...new Map(e.map(e=>[e[t],e])).values()]},_isMIB:function(e){return!!e&&(!(!e.physicalid||!e.physicalid.startsWith("cid:"))||!(!e.module&&!e.contenturl))},_displayAsMultiSelPanel:function(){return this.nbDisplayedObjects>1||this.force_multiple_selection_ui},_WafDataPromise:function(e,t,i){var s=i||this._securityContext;return new Promise((i,r)=>{var o=a.get3DSpaceWSUrl(this.tenant,e,null);l.authenticatedRequest(o,{method:"POST",type:"json",headers:a.getHeaders(s),timeout:6e5,data:JSON.stringify(t),onComplete:function(e){i(e)},onFailure:function(e,t){console.log("PREPARE BRANCH Failure..."+e),r(n.parseWebServiceError(e,t))},ontimeout:function(){console.log("PREPARE BRANCH A connection timeout occured."),r(N.timeout)}})})},_NewBranchWafDataPromise:function(e,t,i){return new Promise((n,a)=>{this._WafDataPromise("/resources/lifecycle/newbranch/"+e,t,i).then(e=>{if("failure"===e.status&&e.hasOwnProperty("report")){var t=e.report;t.length>0&&t[0].hasOwnProperty("message")?a(t[0].message):a()}else n(e)}).catch(e=>{console.log("PREPARE BRANCH Failure..."+object),a(e)})})},executeCmd:function(e,t,i){null==t&&(t={}),null==i&&(i=function(){});var n=this;this.trackerEventBeginTime=Date.now(),this._onComplete=function(){i(),this.wintop&&this._CloseWebInWinPanel()},this._onCompleteWithoutClose=function(){i()},t.hasOwnProperty("context")&&(this.context=t.context),console.log("executeCmd / tenant: "+this.tenant);try{if(0===(e=this._getUniqueListBy(e,"physicalid")).length)throw N.noObject;e.forEach(function(e){if(!(e.objectId||e.physicalid))throw N.epmtyPhysicalId;null===n.tenant&&(console.log("executeCmd / setting tenant from selection: "+e.tenant),n.tenant=e.tenant,n.commandManager.setTenant(n.tenant))}),this.selectionList=e}catch(e){throw console.log("executeCmd / "+e),e}this.folderId=t.targetFolderId;try{if(void 0!==a.getActiveFolder){var r=a.getActiveFolder();void 0!==r.id&&null!==r.id&&""!==r.id&&(this.folderId=r.id,require(["DS/PlatformAPI/PlatformAPI"],function(e){e.publish("FolderEditor.ActiveFolderCallBack",{id:r.id,label:r.label})}))}}catch(e){this.folderId=t.targetFolderId}var c=o.loadDefaultContexCredential({tenant:this.tenant,context:this.context}),l=new Promise((e,t)=>{s.loadCredentials(n.tenant).then(t=>{s.filterCredentialsEx(n.tenant,t,"branch").then(i=>{this.allCredentials=i;let n=i.filter(e=>!e.isFiltered).map(e=>{let i=t.filter(t=>t.ctx===e.secCtx);return{displayName:i?i[0].displayName:e.secCtx,ctx:e.secCtx,isPrivate:e.isPrivate}});n.length>0?(n=n.sort((e,t)=>e.displayName.localeCompare(t.displayName,void 0,{numeric:!0,sensitivity:"base"})),this.hasCredentials=!0,e(n)):e([])}).catch(t=>{console.error("Failed to call credential filter svc, error:",t),e()})})});UWA.Promise.all([c,l]).then(([e,t])=>{n._securityContext=e||"",console.log("executeCmd / security context: "+n._securityContext),UWA.is(t,"array")?n._userCredentials=t:(n._userCredentials=[],console.error("Missing credentials"),n.showError(B.errCredFilterSvc)),n._verifyAndSetObjects()}).catch(e=>{throw console.log("executeCmd / "+e),e})},executeOk:function(){this._onOk()},cancel:function(){this._onCancel()},_verifyAndSetObjects:function(){var e=this;console.log("before PREPARE BRANCH"),this._setWaitingResponse(),this._NewBranchWafDataPromise("prepare_newbranch_completesel",{data:this.selectionList}).then(t=>{var i=t.results;if(!Array.isArray(i)||0===i.length)throw N.objectNotFound;if(e.nbDisplayedObjects=0,i.forEach(function(t){if(!(t.objectId||t.physicalid))throw N.epmtyPhysicalId;1==t.visible&&e.nbDisplayedObjects++}),e.nbDisplayedObjects<=0)throw N.objectNotFound;if(e.objectsList=i,this._computeRoots(),e.objectsList.forEach(t=>{t.isRoot&&e.roots.push(t.physicalid)}),e.roots.length<1&&e.selectionList.forEach(function(t){e.roots.push(t.physicalid)}),i.some(t=>e._isMIB(t))||e.wintop)return t;var n=[];return e.roots.forEach(function(e){n.push({physicalid:e})}),this._WafDataPromise("/resources/lifecycle/duplicate/capabilites",{data:n,enableProto:!0,validateInput:!0,command:"branch"})}).then(t=>{if(t.providers&&(e.providerIdSet=new Set([].concat(...t.providers.filter(e=>e.capabilities.find(e=>"84a058e4-4e05-4fc3-8c2f-ed137631d5ae"==e.id)).map(e=>e.objectIds)))),Array.isArray(t.validationFailures)&&t.validationFailures.length>0){for(var i of t.validationFailures){var n=i.objects.map(e=>e.pid);this.objectsList=this.objectsList.filter(e=>!n.includes(e.physicalid)),this.selectionList=this.selectionList.filter(e=>!n.includes(e.physicalid)),this.roots=this.roots.filter(e=>!n.includes(e))}if(0===this.objectsList.length)throw t.validationFailures[0].errorMessage;this.showNotification(B.notSupportedRemoved)}e.nbDisplayedObjects=0,this.objectsList.forEach(function(t){1==t.visible&&e.nbDisplayedObjects++})}).then(()=>{var t=[];return e.objectsList.forEach(function(e){var i=e.objectId||e.physicalid;t.push(i)}),console.log("executeCmd / pids size: "+t.length),Promise.all([n.getAllowedSemanticsPromise(t,e.context,{nlsintents:!0,scope:"branch"}),this._NewBranchWafDataPromise("prepare_newbranch_checkavailability",{data:e.objectsList})])}).then(([t,i])=>{if(console.log("executeCmd / getAllowedSemanticsPromise done"),n.isBaselineMode(void 0,t)&&"ConfiguredBaseline"!==e.selectionList[0].type){if(e.selectionList.length>1)throw e._setEndWaitingResponse(),N.multipleSelectionObjectsNotSupported;e._setEndWaitingResponse(),require(["DS/HistoryExplorer/HistoryDialog"],function(i){(new i).executeCmd(e.selectionList,{getAllowedSemanticsResponse:t,context:e.context,name:"history_command"},()=>{e._onComplete()})})}else{var a=t.allowedSemantics;if(!Array.isArray(a)||0==a.length)throw N.objectNotFound;var s=["PS","S","F","D"];a.forEach(e=>{if(!Array.isArray(e.semantic))throw N.objectNotFound;var t=[];s.forEach(i=>{e.semantic.includes(i)&&t.push(i)}),s=t});var r=t.intents;if(!Array.isArray(r)||0==r.length)throw N.objectNotFound;var o=new Map;r.forEach(e=>{o.set(e.short,e)});var c=[];s.forEach(e=>{var t=o.get(e);t&&c.push({operation:t.id,nls:t.title})}),e.intentsList=c;var l=new Map;a.forEach(e=>{l.set(e.id,e)});var d=i.results;if(!Array.isArray(d)||0==d.length)throw N.objectNotFound;if(!Array.isArray(c)||0==c.length)throw N.noValidIntent;e.isThereLinearData=!1;var h=!0;if(d.forEach(t=>{var i=t.objectId||t.physicalid;if(!i)throw N.epmtyPhysicalId;var n=l.get(i);if(!n)throw N.objectNotFound;var a=n.semantic;Array.isArray(a)&&(t.availableSemantic=a);var s=n.mode;t.nlvCompatible=!0,Array.isArray(s)&&s.includes("linear")&&(t.nlvCompatible=!1,e.isThereLinearData=!0),"No"===t.EvolutionAvailability&&(console.log("type "+t.type+" is not valid for New Branch (EvolutionAvailability===No)"),h=!1),"Yes"===t.EvolutionAvailability||t.nlvCompatible||(console.log("type "+t.type+" is not valid for New Branch (EvolutionAvailability is no set while type is not NLV)"),h=!1)}),!h)throw 1==d.length?N.evolutionAvailabilityFalseMonoSelection:N.evolutionAvailabilityFalseMultiSelection;e.objectsList=d,e._prepareDataForDisplay()}}).catch(t=>{e._setEndWaitingResponse();let i=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,n={UXName:"NewBranch",models:e.selectionList,actionStatus:"failure",actionTime:i};e.trackerEvent=j.createInitActionEvent(n),j.checkAndTrackPageEvent(e.trackerEvent),console.log("executeCmd / prepare new branch error "+t),e.showErrorThenComplete(t)})},_prepareDataForDisplay:function(){var e=this;a.get3DSpaceBaseUrl(this.tenant);this._NewBranchWafDataPromise("prepare_attributeslist",{data:this.objectsList,attributes:["type","current","branch.current","name","attribute[PLMEntity.V_Name]","Title","attribute[Title]","attribute[PLMReference.V_versionComment]","branch.description","type.kindof[PLMReference]","imageUrl"]}).then(e=>{var t=e.results;if(!Array.isArray(t)||0===t.length)throw N.objectNotFound;return t.forEach(function(e){e.hasOwnProperty("attribute[PLMEntity.V_Name]")&&!e["attribute[PLMEntity.V_Name]"]&&delete e["attribute[PLMEntity.V_Name]"],e.hasOwnProperty("Title")&&!e.Title&&delete e.Title,e.hasOwnProperty("attribute[Title]")&&!e["attribute[Title]"]&&delete e["attribute[Title]"]}),this.objectsList=t,this.objectsList.forEach(function(e){e.current_internal=e.current}),this._displayAsMultiSelPanel()||this._isMIB(this.objectsList[0])?void 0:(this.initBL_already_called=!0,this._WafDataPromise("/resources/lifecycle/duplicate/initialize_objects",{data:this.objectsList,operationDetail:"NewEvolution"}))}).then(e=>{var t=new Map;e&&Array.isArray(e.results)&&e.results.forEach(e=>{e.objectId&&Array.isArray(e.attrs)&&e.attrs.length>0&&t.set(e.objectId,e.attrs)}),this.objectsList.forEach(e=>{var i=e.objectId||e.physicalid,n=t.get(i);Array.isArray(n)&&n.length>0&&(e.modifiedAttributes||(e.modifiedAttributes={}),n.forEach(t=>{t.name&&t.value&&(e.modifiedAttributes[t.name]=t.value)}))});var i=[];return this.objectsList.forEach(function(e){var t=e.objectId||e.physicalid;i.push(t)}),this._displayAsMultiSelPanel()?void 0:n.getVersionNumberProposalPromise(i,this.intentsList.length>0?this.intentsList[0].operation:"",null,this.context)}).then(e=>{var t=new Map;return e&&Array.isArray(e.addRequests)&&e.addRequests.forEach(e=>{t.set(e.copyId,e.code)}),this.objectsList.forEach(e=>{var i=e.objectId||e.physicalid,n=t.get(i);n&&(e.proposedRevision=n)}),this._displayAsMultiSelPanel()?{results:this.objectsList}:this._NewBranchWafDataPromise("prepare_newbranch_maskattributes",{data:this.objectsList})}).then(e=>{var t=e.results;if(!Array.isArray(t)||0===t.length)throw N.objectNotFound;this.objectsList=t,this._setEndWaitingResponse(),console.log("PREPARE BRANCH finished"),this._showCommandUI()}).catch(t=>{this._setEndWaitingResponse();let i=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,n={UXName:"NewBranch",models:e.selectionList,actionStatus:"failure",actionTime:i};e.trackerEvent=j.createInitActionEvent(n),j.checkAndTrackPageEvent(e.trackerEvent),console.log("PREPARE BRANCH Failure..."+t),this.showErrorThenComplete(t)})},_computeRoots:function(){var e=this;let t=new Map;if(!this.wintop){let e=new P;t=e.getAppSelectionRootsPerIds(this.context)}let i=new Set;t.forEach(e=>i.add(e.getID()));let n=!0;this.objectsList.length<=1&&(n=!1),n=n&&this.objectsList.every(e=>!e.visible||t.has(e.physicalid)||e.parentid&&t.has(e.parentid)),this.objectsList.forEach(function(a){if(n)a.physicalid&&i.has(a.physicalid)?a.isRoot=!0:a.isRoot=!1,a.physicalid&&t.has(a.physicalid)&&(a.rootid=t.get(a.physicalid).getID()),a.parentid&&t.has(a.parentid)&&(a.rootid=t.get(a.parentid).getID());else if(a.physicalid){var s=!1;e.selectionList.forEach(function(e){a.physicalid==e.physicalid&&(s=!0)}),s&&!a.parentid?a.isRoot=!0:a.isRoot=!1}else a.isRoot=!1})},_showCommandUI:function(){var e=this,t=this.content,i="";if(this._displayAsMultiSelPanel())this.objectsList.forEach(e=>{e["attribute[PLMEntity.V_Name]"]&&(e.name=e["attribute[PLMEntity.V_Name]"]),e["attribute[Title]"]&&(e.name=e["attribute[Title]"]),e.Title&&(e.name=e.Title)}),this.content.classList.add("css_grid_container"),this.dgvContainer=new b({idName:"dgvContainer",clickToShowDGV:!1},e.objectsList),this.dgvContainer.inject(t,"top"),i=" - "+this.nbDisplayedObjects+" "+N.multipleSelectionObjects,this.container&&this.container.addClassName("multiSel");else{var n=!1;this.objectsList.forEach(t=>{var i=this._isMIB(t),a="",s="",r="",o=!0;t["attribute[PLMEntity.V_Name]"]&&(a="attribute[PLMEntity.V_Name]"),t["attribute[PLMEntity.V_Name]"]&&(s="PLMEntity.V_Name"),t["attribute[PLMEntity.V_Name]"]&&(r=t["attribute[PLMEntity.V_Name]"]),t.Title&&(a="Title"),t.Title&&(s="Title"),t.Title&&(r=t.Title),t.computedLabel&&t.computedLabel.selectable&&(a=t.computedLabel.selectable),t.computedLabel&&t.computedLabel.path&&(s=t.computedLabel.path),t.computedLabel&&t.computedLabel.value&&t.computedLabel.value.length>=1&&(r=t.computedLabel.value[0]);var c=[];if(t.hasOwnProperty("attributes_mask")&&(c=t.attributes_mask),c.forEach(function(e){e.selectable==a&&!0===e.readOnly&&(o=!1)}),!i&&a&&(n=!0),console.log("showTitle: "+n),n&&(console.log("title selectable: "+a),console.log("title path: "+s),console.log("title value: "+r),console.log("title editable: "+o)),t.modifiedAttributes||(t.modifiedAttributes={}),t.volatileAttributes||(t.volatileAttributes={}),n&&o&&s&&!t.modifiedAttributes.hasOwnProperty(s)&&e.dup_string&&(t.modifiedAttributes[s]=e.dup_string+r),t.hasOwnProperty("attributes_mask")||(t.attributes_mask=[]),"TRUE"!==t["type.kindof[PLMReference]"]||i||t.attributes_mask.push({selectable:"attribute[PLMReference.V_versionComment]",path:"PLMReference.V_versionComment",readOnly:!1,maxlength:256,multiline:!0,nls:x.LifecycleObjectList_versionComment}),i&&(t.attributes_mask.push({selectable:"description",path:"description",readOnly:!1,maxlength:256,multiline:!0,nls:x.LifecycleObjectList_versionComment}),t.attributes_mask.push({selectable:"branchTitle",path:"branchTitle",readOnly:!1,maxlength:256,nls:B.BranchTitle})),!e.without_cred){var l=["noCredentials"],d=[B.noCredentials];e._userCredentials&&e._userCredentials.length>0&&(l=e._userCredentials.map(e=>e.ctx),d=e._userCredentials.map(e=>e.displayName));var h=l[0];l.indexOf(e._securityContext)>=0&&(h=e._securityContext),t.attributes_mask.push({selectable:"credentials",path:"credentials",readOnly:!1,value:h,nls:B.credentials,authorizedValues:l,authorizedValuesNLS:d,onAttributeValueChanged:function(){e._onCredentialSeletionChangedMonoSel()},volatile:!0}),t.volatileAttributes.credentials=h,this.isTargetCSPrivate=this._getIsCSPrivateFromSecCtx(h)}});var a={className:"newbranch_prop is-mobile simpbranch-option",data_rec_id:"newbranch_prop_rec-id",showTitle:n,showProposedRevision:!0,editable:!0,identifier:"LifecycleNewBranchWidget"};if(this.objectProp=new S(a),this.objectProp.inject(t),!this.wintop&&this.intentsList.length<=1&&this.providerIdSet.size>0){let i=new UWA.createElement("div",{id:"advbranch-content",class:"advanced-content"});i.setStyle("height","100%"),i.setStyle("display","none"),i.inject(t);let n=new UWA.createElement("div",{text:B.NewBranchAdvanced,id:"expander",class:"advbranch-expander"});n.addEventListener("click",function(){e.useAdvancedBranch=!0,e._openAdvancedBranchTree()}),n.inject(t),this.hasCredentials||(n.style.pointerEvents="none")}if(this.objectProp.setObject(this.objectsList[0],this.intentsList.length>1||!this.isThereLinearData?this.intentsList:null,null),this.objectProp.addEvent("onAttributeValidationError",e=>{e.forEach(e=>{this.showNotificationInDialog(e)})}),this.objectProp.addEvent("onIntentChanged",function(){e._onItentSeletionChangedMonoSel()}),Array.isArray(this.selectionList)&&this.selectionList.length&&this.selectionList[0].name){let e=this.selectionList[0].revision?" "+this.selectionList[0].revision:"";i=" - "+this.selectionList[0].name+e}}var s=!0,r=!1,o=!1;this.objectsList.forEach(e=>{e.physicalid&&!e.physicalid.startsWith("cid:")&&(s=!1),e.physicalid&&e.physicalid.startsWith("cid:")&&(r=!0),(e.module||e.contenturl)&&(r=!0),"TRUE"===e["type.kindof[PLMReference]"]&&(o=!0)});var l=!1;if(this._displayAsMultiSelPanel()&&(o||r)){UWA.createElement("div",{class:"comment_label simpbranch-option",text:x.LifecycleObjectList_versionComment}).inject(t),this.commentInput=(t=>{let i=new g({placeholder:O["Enter a text"],widthInCharNumber:45,newLineMode:"enter"});return i.addEventListener("change",function(){t.forEach(function(e){e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes["PLMReference.V_versionComment"]=i.value}),i.getContent().setAttribute("title",i.value)}),i.addEventListener("uncommittedChange",function(){i.getContent().setAttribute("title",i.valueToCommit);var t=e._checkVersionCommentValue(i.valueToCommit);t&&e.showNotificationInDialog(t)}),i.getContent().addClassName("comment_input simpbranch-option"),i})(e.objectsList),this.commentInput.inject(t),l=!0}var d=!1;if(this._displayAsMultiSelPanel()&&this.isThereLinearData&&!s){new UWA.Element("text",{text:B.Prefix,class:"newbranch_dupstring_title simpbranch-option"}).inject(t);var h=UWA.createElement("div",{class:"newbranch_dupstring_input simpbranch-option"});h.inject(t),this.dupStringInput=new v({}),this.dupStringInput.getContent().addClassName("newbranch_dupstring_input_ed"),this.dupStringInput.inject(h),""!==this.dup_string&&(this.dupStringInput.value=this.dup_string),d=!0}this._displayAsMultiSelPanel()&&s&&(new UWA.Element("text",{text:B.BranchTitle,class:"newbranch_branchtitle simpbranch-option"}).inject(t),this.branchTitleInput=(e=>{let t=new v({});return t.getContent().addClassName("newbranch_branchtitle_input simpbranch-option"),t.addEventListener("change",function(){e.forEach(function(e){e.modifiedAttributes||(e.modifiedAttributes={}),e.modifiedAttributes.branchTitle=t.value}),t.getContent().setAttribute("title",t.value)}),t.addEventListener("uncommittedChange",function(){t.getContent().setAttribute("title",t.valueToCommit)}),t})(e.objectsList),this.branchTitleInput.inject(t));var u=!1;if(this._displayAsMultiSelPanel()&&(this.intentsList.length>1||!this.isThereLinearData)){new UWA.Element("div",{class:"newbranch_intentslist_text",text:B.IntentSelection}).inject(t);var _=[];this.intentsList.forEach(function(e){_.push({labelItem:e.nls,valueItem:e.operation})}),this.intentsListSel=new p({elementsList:_,selectedIndex:0,enableSearchFlag:!1}),this.intentsListSel.inject(t),this.intentsListSel.addEventListener("change",function(){e.dispatchEvent("onIntentChangedForODT")}),u=!0}if(this.wintop){let i=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,n={UXName:"NewBranch",models:this.objectsList,actionStatus:"success",actionTime:i};this._displayAsMultiSelPanel()?n.UXMode="ListView":n.UXMode="ObjectView",this.intentsList.length>1&&(n.pv19=this.intentsList.length),this.trackerEvent=j.createInitActionEvent(n),j.checkAndTrackPageEvent(this.trackerEvent);var w=new m({value:B.BtnOK,name:"NewBranchButtonOk",className:"default medium primary"}),C=new m({value:B.BtnCancel,name:"NewBranchButtonCancel",className:"default medium"});w.inject(this.footerDiv),C.inject(this.footerDiv),this._onOkPromise=function(){return new Promise(t=>{var i=e._checkBeforeExecute();null!=i&&i.length>0&&(e.showNotificationInDialog(i[0]),t()),w.setDisabled(),C.setDisabled(),this._setWaitingResponse(),this.trackerEventBeginTime=Date.now(),e._executeNewBranch().then(i=>{i.messageToDisplay=N.newBranchSuccessfulWin,e._setEndWaitingResponse(),t(i)},i=>{e._setEndWaitingResponse(),t(i)})})},this._onOkPromiseFromWin=function(){return new Promise(e=>{this._onOkPromise().then(t=>{var i=JSON.stringify(t);e(i),this._onCompleteWithoutClose()})})},this._onOk=function(){w.setDisabled(),C.setDisabled(),e.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"dispatchWinAction",notif_parameters:{action:"WebToWinAction_OnOKButton",data:{ExecuteSync:"_onOkPromiseFromWin",timeout:1e6}}},"lf_web_in_win")},this._onCancel=function(){w.setDisabled(),C.setDisabled(),e._onComplete()},w.addEvents({onClick:function(){e._onOk()}}),C.addEvents({onClick:function(){e._onCancel()}}),setTimeout(()=>{t.style.minHeight="127px";let i=t.querySelector(".EditProp_MainContain");i&&(i.style.minHeight=""),this.auto_execute?(console.log("launching automatically execution of the command"),w.dispatchEvent("onClick")):e.dispatchEvent("onReady")},10)}else{this.rootGrid=UWA.createElement("div",{class:"lcm-branch-root-grid"}),t.inject(this.rootGrid);let n=UWA.createElement("div",{class:"lcm-cspace-warn-root"});n.inject(this.rootGrid),UWA.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-attention lcm-cspace-warn-icon"}).inject(n);let a=UWA.createElement("div",{class:"lcm-cspace-warn-msg"});a.innerText=N.selectedCSNotPrivate,a.inject(n);var A=new f;let s=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,r={UXName:"NewBranch",models:this.objectsList,actionStatus:"success",actionTime:s};this._displayAsMultiSelPanel()?r.UXMode="ListView":r.UXMode="ObjectView",this.intentsList.length>1&&(r.pv19=this.intentsList.length),this.trackerEvent=j.createInitActionEvent(r),j.checkAndTrackPageEvent(this.trackerEvent),this._onOk=function(){if(!this.useAdvancedBranch){var t=e._checkBeforeExecute();if(null!=t&&t.length>0)return e.showNotificationInDialog(t[0]),A._okButton&&A._okButton.setDisabled(!1),A._cancelButton&&A._cancelButton.setDisabled(!1),void(A._closeButton&&(A._closeButton.disabled=!1))}this._setWaitingResponse(),this.trackerEventBeginTime=Date.now(),e._executeNewBranch().then(t=>{y.dispatchEvent("onModification",t),e._setEndWaitingResponse(),e._onComplete(),A.destroy()},()=>{e._setEndWaitingResponse(),e._onComplete(),A.destroy()})},this._onCancel=function(){e._onComplete(),A.destroy()};var L=A.create(this.rootGrid,{title:B.CommandDialogTitle+i,OKBtnText:B.BtnOK,closeButton:!0,resizable:!0,powerMaximize:!0,imageUrl:this.selectionList[0].imageUrl||"",onOk:function(){e._onOk()},onClose:function(){e._onCancel()}});this.dialog=L,this.commandDialog=A,this.commandDialog.addEvent("widget-maxmized-changed",function(t){t&&e.useAdvancedBranch&&e.commandDialog.maximize(!0)}),this.commandDialog&&this.commandDialog.setPowermaximizeVisibility(!1),this._displayAsMultiSelPanel()&&L.elements.container.addClassName("multiSel"),this.without_cred||this._userCredentials&&0!=this._userCredentials.length||A._okButton&&A._okButton.setDisabled(),L.inject(widget.body);var D=L.getContent();D||(D=widget.body),this.errorOverlay=new E(this,D,{className:"newbranch_errorManager"});var I=this._displayAsMultiSelPanel(),P=0;c.isTouchMode()&&(P+=I?70:40);var T=I?600:646,k=320+(l?41:0)+(d?29:0)+(u?29:0)+24*(this.nbDisplayedObjects-2)+P;!I&&this.objectProp&&(k=this.objectProp.getComputedMinHeight()+163+28+P);var W=k;L.setNewSize({width:T,height:k}),setTimeout(()=>{let i=t.querySelector(".EditProp_MainContain");if(i&&(i.style.minHeight=""),L.setMinSize(530,W),!this.without_cred&&this._displayAsMultiSelPanel()&&(this.credCombo=this._createCredentialSelector({widget:this,dialog:L,isMultisel:!0}),this.credCombo.addEventListener("change",e=>{console.log("Credentials changed:"+this.credCombo.currentLabel),console.log("isPrivate:"+this.credCombo.value.isPrivate),this.updateCSWarning()}),this._getIsTargetCSPrivate=(()=>this.credCombo.value.isPrivate),this.intentsList.length<=1&&!this.objectsList.some(t=>e._isMIB(t)))){let i=new UWA.createElement("div",{id:"advbranch-content",class:"advanced-content"});i.setStyle("height","100%"),i.setStyle("display","none"),i.inject(t);let n=new UWA.createElement("div",{text:B.NewBranchAdvanced,class:"advbranch-expander advanced_multisel",id:"expander"});n.addEventListener("click",function(){e.useAdvancedBranch=!0,e._openAdvancedBranchTree()}),n.inject(t),this.hasCredentials||(n.style.pointerEvents="none")}e.updateCSWarning(),e.dispatchEvent("onReady")},10)}},_checkTitleValue:function(){var e=this.objectsList.map(e=>e.name).reduce(function(e,t){return e.length>t.length?e:t});if((this.dupStringInput._myInput.value+e).length>100){var t=require("i18n!DS/EditPropWidget/assets/nls/langEditProp"),i="Title error";return t&&(i=t.replace(t.get("MaxLengthAttribute"),{label:x.LifecycleObjectList_title,value:100})),{code:"ERROR",eventID:"warning",message:i}}return null},_openAdvancedBranchTree:function(){var e=this,i=UWA.extendElement(this.content.querySelector("#advbranch-content"));this.immersiveFrame=this.immersiveFrame||this._createImmersiveFrame(i);var n=UWA.extendElement(this.content.querySelector(".immersive-frame-parent"));this.treeInputValidation&&this.treeInputValidation.inputValidator.updateValidation(),this.treeInputValidation=this.treeInputValidation||this._createTreeInputValidator(this.dialog),this.expandReqBuilder=this.expandReqBuilder||new D(this.context,"branch"),this._delayedMask||(this._delayedMask=new r(n,1e3,B.loadingText)),this.advancedBranchTree=this.advancedBranchTree||this._createAdvancedBranchTree(i);var a=UWA.extendElement(e.content.querySelector("#collapser"));a||((a=new UWA.createElement("div",{text:B.NewBranchBasic,id:"collapser",class:"advbranch-expander"})).setStyle("display","none"),a.addEventListener("click",function(){e.useAdvancedBranch=!1,e._closeAdvancedBranchTree(e.dialog)}),a.inject(i)),this.dialog.elements.container.classList.add("advanced-mode"),t(this.dialog.elements.container).find(".simpbranch-option").slideUp(150),t(this.dialog.elements.container).find("#dgvContainer").slideUp(150);var s=UWA.extendElement(e.content.querySelector("#expander"));i.setStyle("display","block"),s.setStyle("display","none"),a.setStyle("display","block"),"function"==typeof this.dialog._handleWidgetResize&&this.dialog._handleWidgetResize(),this._adjustDialogSizeLarge(this.dialog),this.dialog.centerIt(),this.updateCSWarning()},_closeAdvancedBranchTree:function(){this.dialog.elements.container.classList.remove("advanced-mode"),t(this.dialog.elements.container).find(".simpbranch-option").slideDown(150),t(this.dialog.elements.container).find("#dgvContainer").slideDown(150),UWA.extendElement(this.content.querySelector("#advbranch-content")).setStyle("display","none"),UWA.extendElement(this.content.querySelector("#expander")).setStyle("display","block"),this._adjustDialogSizeSmall(this.dialog),this.dialog.centerIt();var e=this.dialog.elements.footer.querySelector(".btn-primary");e&&(e.disabled=!1),this.updateCSWarning()},_createImmersiveFrame:function(e){if(this.immersiveFrame)return this.immersiveFrame;var t=new A({identifier:"4046f1f2-6823-11e9-a923-1681be663d3e"});t.dockingElements.forEach(function(e){e._properties.side.value===WUXDockAreaEnum.TopDockArea||e._properties.side.value==WUXDockAreaEnum.BottomDockArea?e._properties.dockingZoneSize.value=120:e._properties.side.value!==WUXDockAreaEnum.LeftDockArea&&e._properties.side.value!=WUXDockAreaEnum.RightDockArea||(e._properties.dockingZoneSize.value=230)});var i=UWA.createElement("div",{class:"immersive-frame-parent"});return i.inject(e),t.inject(i),t},_createAdvancedBranchTree:function(e){var t=this;if(this.trackerEventBeginTime=Date.now(),!t.trackerEvent){let e={UXName:"NewBranch",numberObjects:0};t.trackerEvent=j.createInitActionEvent(e)}var i=new L({inputValidator:this.treeInputValidation,tenant:this.tenant,showError:this.showError.bind(this),identifier:"branch"});i.addEvent("expandingStructure",function(e){var i=t.dialog.elements.footer.querySelector(".btn-primary");i&&(i.disabled=!0)});let n=this._getOrCreateTreeLoader();return i.loadUI({parentElement:e,immersiveFrame:this.immersiveFrame,securityContext:this._securityContext,treeLoader:n}),i.addEvent("onTreeListCreated",function(e){t._delayedMask&&t._delayedMask.unmask(),i.treeList.onInitialUpdateView().then(function(){t.treeInputValidation.inputValidator.updateValidation(),t.dispatchEvent("AdvancedUICreated",i);let e=t.trackerEventBeginTime?Date.now()-t.trackerEventBeginTime:0,n={UXMode:"Advanced",numberObjects:i.getTreeData().length,actionStatus:"success",actionTime:e};t.trackerEvent=j.createInitActionEvent(n,t.trackerEvent),j.checkAndTrackPageEvent(t.trackerEvent)}),i.translationService.translationFailure&&t.showNotification("Translation failed")}),i},_getOrCreateTreeLoader:function(){return this.treeLoader?this.treeLoader:(this.treeLoader=new I({roots:this.roots,context:this.context,tenant:this.tenant,providerIdSet:this.providerIdSet,objectsList:this.objectsList,expandReqBuilder:new D(this.context,"branch"),getAuthoringMode:this._getAuthoringMode.bind(this)}),this.treeLoader)},_createTreeInputValidator:function(){var e={inputValidator:new _,validators:this._getInputValidators()};e.inputValidator.setCustomCSS({inputCSS:"tree-invalid-input",infoIconCSS:"tree-info-icon-invalid-input"}),e.haveIllegalChars=(()=>{});var t=this.dialog.getContainer?this.dialog.getContainer():this.dialog.elements?this.dialog.elements.container:null;return this.okBtn=t.querySelector(".btn-primary"),this.okBtn&&e.inputValidator.addSubmitElement(this.okBtn),e},_getInputValidators:function(){return[{name:"maxChars",validate:function(e){return e.length<=100},getErrorInfo:function(e){return B.branchTooLongTitle}}]},_getAuthoringMode:function(){if(this.context&&"function"==typeof this.context.isIndexMode)return UWA,Promise.resolve(!this.context.isIndexMode());var e=this;return new UWA.Class.Promise(function(t,i){widget&&n.isInPSEditorWidget(widget)?e._getPADSession().then(function(e){var i=!0;e&&(i=e.determineAuthoredFlag()),t(i)}):t(!0)})},_getPADSession:function(){return this.hasRequestedPADSession?UWA.Class.Promise.resolve(this.PADSession):this.getPADSessionPromise()},getPADSessionPromise:function(){var e=this;return new UWA.Class.Promise(function(t,i){require(["DS/PADUtils/PADSession"],function(i){e.hasRequestedPADSession=!0,e.PADSession=i,t(e.PADSession)},function(i){e.hasRequestedPADSession=!0,e.PADSession=null,t(e.PADSession)})})},_adjustDialogSizeLarge:function(e){if(!this.dialog.isMaximized){var t=this._loadSize("advBranchLarge"),i=this._getCurrentSize(e);this._storeSize("advBranchSmall",i),e.setNewSize(t?{width:t.width,height:t.height}:{width:2*i.width,height:480}),this.commandDialog&&this.commandDialog.isWidgetMaximized()&&this.commandDialog.maximize(!0)}},_adjustDialogSizeSmall:function(e){if(!this.dialog.isMaximized){var t=this._loadSize("advBranchSmall"),i=this._getCurrentSize(e);this._storeSize("advBranchLarge",i),e.setNewSize(i?{width:t.width,height:t.height}:{})}},_getCurrentSize:function(e){var t=e.getModalBodySize();return t.height=e.getContainerHeight(),t},_loadSize:function(e){var t=widget.getValue(e);return t?JSON.parse(t):null},_storeSize:function(e,t){widget.getValue(e)||widget.addPreference({name:e,type:"hidden",defaultValue:"{}"}),widget.setValue(e,JSON.stringify(t))},_getSelectedSecurityContext:function(){return this.credCombo?this.credCombo.value.ctx:this.objectsList.length>=1&&this.objectsList[0].volatileAttributes&&this.objectsList[0].volatileAttributes.credentials?this.objectsList[0].volatileAttributes.credentials:this.without_cred?this._securityContext:"noCredentials"},_createCredentialSelector:({widget:e,dialog:t,isMultisel:i})=>{var n=t.elements.footer.querySelector(".btn-primary");n&&(n.disabled=!0);let a=t.elements.body.querySelector(".newbranch_grid_container");a||(a=t.elements.body.querySelector(".newbranch_content"));let s=UWA.createElement("div",{class:"newbranch_credsel_container is-mobile"});i||s.addClassName("newbranch_single_sel"),UWA.createElement("div",{class:"newbranch_credsel_label simpbranch-option",text:B.credentials}).inject(a);let r=new p({elementsList:[B.loadingText],enableSearchFlag:void 0,actionOnClickFlag:void 0,displayStyle:void 0});r.getContent().wuxControl=r,r.getContent().addClassName("newbranch_credsel_combo simpbranch-option"),i||r.getContent().addClassName("newbranch_single_sel"),r.inject(a);var o=e;if(!!(o._userCredentials&&o._userCredentials.length>0)){var l=o._userCredentials.map(e=>({labelItem:e.displayName,valueItem:e}));r.elementsList=l;let e=l.filter(e=>e.valueItem.ctx==o._securityContext);1==e.length&&(r.value=e[0].valueItem),n.disabled=!1}else{let e=[{labelItem:B.noCredentials,valueItem:{ctx:B.noCredentials}}];r.elementsList=e,r.value=e[0].labelItem}return c._setTouchAttribute(t.elements.body),e.dispatchEvent("CredentialUiCreated",r),r},_getIsCSPrivateFromSecCtx:function(e){let t=this.allCredentials.filter(t=>t.secCtx==e).map(e=>e.isPrivate);return 1==t.length&&t[0]},_onCredentialSeletionChangedMonoSel:function(){console.log("Credential changed callback");var e=this;this._setWaitingResponse();var t=this.objectsList[0].volatileAttributes.credentials;this.isTargetCSPrivate=this._getIsCSPrivateFromSecCtx(t),Promise.resolve().then(()=>this.initBL_already_called?this._WafDataPromise("/resources/lifecycle/duplicate/initialize_objects",{data:this.objectsList,operationDetail:"NewEvolution"},t):void 0).then(t=>{e._setEndWaitingResponse();var i=new Map;if(t&&Array.isArray(t.results)&&t.results.forEach(e=>{e.objectId&&Array.isArray(e.attrs)&&e.attrs.length>0&&i.set(e.objectId,e.attrs)}),this.objectsList.forEach(e=>{var t=e.objectId||e.physicalid,n=i.get(t);Array.isArray(n)&&n.length>0&&(e.modifiedAttributes||(e.modifiedAttributes={}),n.forEach(t=>{t.name&&t.value&&(e.modifiedAttributes[t.name]=t.value)}))}),null!==e.objectProp){var n=e.objectProp.getIntent();e.objectProp.setObject(e.objectsList[0],e.intentsList.length>1||!e.isThereLinearData?e.intentsList:null,n)}this.updateCSWarning(),console.log("Credential changed done")}).catch(t=>{e._setEndWaitingResponse(),console.log("Credential changed Failure..."+t),e.showErrorThenComplete(t)})},_onItentSeletionChangedMonoSel:function(){console.log("Branch intent changed callback");var e=this;this._setWaitingResponse();var t=[];this.objectsList.forEach(function(e){var i=e.objectId||e.physicalid;t.push(i)});var i="";null!==this.objectProp&&(i=this.objectProp.getIntent()),n.getVersionNumberProposalPromise(t,i,null,this.context).then(t=>{e._setEndWaitingResponse();var i=new Map;if(!t.addRequests||!Array.isArray(t.addRequests))throw N.objectNotFound;if(t.addRequests.forEach(e=>{i.set(e.copyId,e.code)}),e.objectsList.forEach(e=>{var t="";e.physicalid&&(t=e.physicalid),e.objectId&&(t=e.objectId);var n=i.get(t);n&&(e.proposedRevision=n)}),null!==e.objectProp){var n=e.objectProp.getIntent();e.objectProp.setObject(e.objectsList[0],e.intentsList.length>1||!e.isThereLinearData?e.intentsList:null,n)}console.log("Branch intent changed callback done"),e.dispatchEvent("onIntentChangedForODT")}).catch(t=>{e._setEndWaitingResponse(),console.log("Branch intent changed Failure..."+t),e.showErrorThenComplete(t)})},_checkVersionCommentValue:function(e){if(e&&e.length>256){var t=require("i18n!DS/EditPropWidget/assets/nls/langEditProp"),i="checkVersionCommentValue error";return t&&(i=t.replace(t.get("MaxLengthAttribute"),{label:x.LifecycleObjectList_versionComment,value:256})),{code:"ERROR",eventID:"warning",message:i}}return null},_checkBeforeExecute:function(){var e=this,t=[];if(null!=this.objectProp&&(t=this.objectProp.getErrors()),this._displayAsMultiSelPanel()&&this.dupStringInput&&this.dupStringInput.value&&this.dupStringInput.value.length>0){var i=e._checkTitleValue();i&&t.push(i)}return this.objectsList.forEach(function(i){if(i.modifiedAttributes&&i.modifiedAttributes["PLMReference.V_versionComment"]){var n=e._checkVersionCommentValue(i.modifiedAttributes["PLMReference.V_versionComment"]);n&&t.push(n)}}),t},_computeRequest:function(){return this.useAdvancedBranch?this._computeAdvRequest():this._computeBasicRequest()},_computeBasicRequest:function(){var e={data:[]};return this.objectsList.forEach(function(t){var i={physicalid:t.physicalid};t.modifiedAttributes&&Object.getOwnPropertyNames(t.modifiedAttributes).length&&(i.modifiedAttributes=t.modifiedAttributes),t.rootid&&(i.rootid=t.rootid),t.parentid&&(i.parentid=t.parentid),e.data.push(i)}),this.objectProp&&!this._displayAsMultiSelPanel()?(e.intent=this.objectProp.getIntent(),e.prefix=""):(this.intentsListSel&&(e.intent=this.intentsListSel.currentValue),this.dupStringInput&&(e.prefix=this.dupStringInput.value)),this.folderId&&(e.folderid=this.folderId),this.initBL_already_called&&(e.initBL_already_called=!0),e},_computeAdvRequest:function(){var e={},t=this._getOrCreateTreeLoader().nodeToRoot,i=this._getOrCreateTreeLoader().filteredRoots;e.data=this.advancedBranchTree.getTreeData(),e.usingAdvanced=!0,e.checkReusable=!1;var n=this.objectsList[0];for(var a of(null!==this.folderId&&(e.folderid=this.folderId),e.data))i.has(a.physicalid)?a.filterSpec=JSON.stringify(i.get(a.physicalid)):t.has(a.physicalid)&&(a.rootid=t.get(a.physicalid)),n.modifiedAttributes&&n.modifiedAttributes["PLMReference.V_versionComment"]&&"duplicate"!==a.operation&&(a.versionComment=n.modifiedAttributes["PLMReference.V_versionComment"]);return e},showNotificationInDialog:function(e){this.wintop?this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e.message},recordable:!0},"lf_web_in_win"):"ERROR"===e.code?null!=this.errorOverlay?this.errorOverlay.addError(e.message,e.customClass):this.showError(e.message):null!=this.errorOverlay?this.errorOverlay.addWarning(e.message,e.customClass):this.showNotification(e.message)},showNotification:function(e,t){if(t||(t={}),this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e},recordable:!0},"lf_web_in_win");else{var i={eventID:"primary",msg:e,sticky:t.sticky||!1,category:"NewBranch"};C.displayNotification(i),console.log(e)}},showSuccess:function(e){if(this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:e},recordable:!0},"lf_web_in_win");else{var t={eventID:"success",msg:e,category:"NewBranch"};C.displayNotification(t),console.log(e)}},showError:function(e,t){if(t=t||{},this.wintop)this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"error",message:e},recordable:!0},"lf_web_in_win");else{var i={eventID:"error",msg:t.title||t.subtitle?t.submessage:e,title:t.title,subtitle:t.subtitle,category:"NewBranch"};C.displayNotification(i),console.log(e)}},showErrorThenComplete:function(e,t){e&&this.showError(e,t),this.wintop_odt_mode&&console.log("showErrorThenComplete called in ODT MODE"),setTimeout(()=>{this._onComplete()},this.wintop_odt_mode?1e3:void 0)},_executeNewBranch:function(){var e=this;return new Promise((t,i)=>{var s=e._computeRequest();let r="";if(r=e._displayAsMultiSelPanel()?"ListView":e.useAdvancedBranch?"Advanced":"ObjectView",e.trackerNumberObjects=s.data?s.data.length:0,!e.trackerEvent){let t={UXName:"NewBranch",numberObjects:e.trackerNumberObjects};e.trackerEvent=j.createInitActionEvent(t)}var o={UXName:"NewBranch"};o.isWebInWin=e.wintop,e.options&&e.options.client_app_domain&&(o.client_app_domain=e.options.client_app_domain),e.options&&e.options.client_app_name&&(o.client_app_name=e.options.client_app_name),T.enrichRequestWithMetricsWebInWin(s,o);s.notificationTimeout=600,console.log("before NEW BRANCH");var c=JSON.stringify(s),d=a.get3DSpaceWSUrl(e.tenant,"/resources/lifecycle/newbranch/execute_newbranch",null),h=e._getSelectedSecurityContext();l.authenticatedRequest(d,{method:"POST",headers:function(t){var i=a.getHeaders(t);return e.wintop&&e.wintop_ChangeActionId&&(i["DS-Change-Authoring-Context"]="pid:"+e.wintop_ChangeActionId),i}(h),timeout:6e5,onComplete:function(n){if(console.log("NEW BRANCH: COMPLETED"),n&&"failure"===n.status){var a=[];if(n.report&&n.report.length>0){var s=[];e.selectionList.forEach(function(e){s[e.physicalid]=e.displayName}),n.report.forEach(function(t){if(t.hasOwnProperty("physicalids")){for(var i="",n=0;n<t.physicalids.length;n++){var r=t.physicalids[n];s.hasOwnProperty(r)&&(i+=s[r],n===t.physicalids.length-1?i+=":\n":i+=",\n")}i+=t.error,a.push({severity:"error",message:i})}else if("NonLinearVersioning.Error.MakeCloneAccess"===t.enoversioning_errornumber){var o=N.newBranchFailed;if(1==e.nbDisplayedObjects&&Array.isArray(e.selectionList)&&e.selectionList.length&&e.selectionList[0].name){let t=e.selectionList[0].revision?" "+e.selectionList[0].revision:"",i=e.selectionList[0].name+t;o=N.replace(N.newBranchFailedTitleSingleSel,{dispName:i})}var c={title:o,subtitle:N.verifyCredentials,submessage:N.lackingBranchingAccessRole};a.push({severity:"error",message:t.error,opts:c})}else a.push({severity:"error",message:t.error})})}else a.push({severity:"error",message:N.newBranchFailed});a.forEach(t=>{console.log(t.message),e.wintop||e.showError(t.message,t.opts)});let t=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,o={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"failure",actionTime:t};return e.trackerEvent=j.createValidationEventFromEvent(o,e.trackerEvent),j.checkAndTrackPageEvent(e.trackerEvent),void i({errors:a})}console.log(N.newBranchSuccessful),e.wintop||e.showSuccess(N.newBranchSuccessful);var o=[];n.report&&n.report.length>0&&n.report.forEach(e=>{e.warning&&o.push({severity:"warning",message:e.warning})}),o.forEach(t=>{console.log(t.message),e.wintop||e.showNotification(t.message)});var c={created:[],deleted:[],modified:[]};c.context=e.context,c.warnings=o;var l=[];e.objectsList.forEach(function(e){e.hasOwnProperty("isRoot")&&!e.isRoot||(l[e.physicalid]=!0)}),n.results.forEach(function(t){var i=null;if(t.hasOwnProperty("derivedfromphysicalid")&&(i=t.derivedfromphysicalid),l.hasOwnProperty(i)){var n={physicalid:t.physicalid,sourceObjectId:i,operation:"Branch"},a=[e.folderId];n.folders=a,c.refreshFolder=!0,c.created.push(n)}});let d=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,h={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"success",actionTime:d};Array.isArray(n.results)&&(h.pv16=n.results.length),e.trackerEvent=j.createValidationEventFromEvent(h,e.trackerEvent),j.checkAndTrackPageEvent(e.trackerEvent),t(c)},data:c,onTimeout:function(t){e.wintop||e.showNotification(B.notificationTimeoutInfo,{sticky:!0}),console.log("Timeout error");let n=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,a={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"running_on_backend",actionTime:n};e.trackerEvent=j.createValidationEventFromEvent(a,e.trackerEvent),j.checkAndTrackPageEvent(e.trackerEvent),i({errors:[{severity:"error",message:B.notificationTimeoutInfo}]})},onFailure:function(t,a){n.showWebServiceError(t,a,function(n,a){if(a){e.wintop||e.showNotification(B.notificationTimeoutInfo,{sticky:!0}),console.log(B.notificationTimeoutInfo),console.log(t);let n=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,a={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"running_on_backend",actionTime:n};e.trackerEvent=j.createValidationEventFromEvent(a,e.trackerEvent),j.checkAndTrackPageEvent(e.trackerEvent),i({errors:[{severity:"error",message:B.notificationTimeoutInfo}]})}else{e.wintop||e.showError(B.NewBranchFailed+"<br>"+n),console.log("Failed to retrieve data from the server"),console.log(t);let a=e.trackerEventBeginTime?Date.now()-e.trackerEventBeginTime:0,s={UXMode:r,numberObjects:e.trackerNumberObjects,actionStatus:"failure",actionTime:a};e.trackerEvent=j.createValidationEventFromEvent(s,e.trackerEvent),j.checkAndTrackPageEvent(e.trackerEvent),i({errors:[{severity:"error",message:B.NewBranchFailed+"\n"+n}]})}},!0)},type:"json"})})},_getProjects:async function(e){let t=await this._getSelectedSecurityContext(),i={data:e,attributes:["project"]},n=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/product/attributeList",null),s=await d.post(n,JSON.stringify(i),{securityContext:t}),r=s.results.filter(e=>!this.warningInfoData.allCS.includes(e.project)).map(e=>e.project);return console.log("Unknown projects: "+r),await this._updateCSLists(r),s},_updateCSLists:async function(e){if(0==e.length)return;let t=await this._getSelectedSecurityContext(),i={CollabSpaces:[...new Set(e)]},n=a.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/util/getCSState",null),s=(await d.post(n,JSON.stringify(i),{securityContext:t})).data.filter(e=>!e.IsError),r=s.filter(e=>e.IsPrivate).map(e=>e.CSRole);this.warningInfoData.allCS=this.warningInfoData.allCS.concat(s.map(e=>e.CSRole)),this.warningInfoData.privatCS=this.warningInfoData.privatCS.concat(r)},_getStructureObjectsInPrivateCS:async function(){let e=await this._getSelectedSecurityContext(),t=await this._getOrCreateTreeLoader().expand(e),i=[],n=[],a=[];if(t.assemblies.forEach(e=>{n=n.concat(e.nodes.filter(e=>null!=e.project&&!this.warningInfoData.allCS.includes(e.project)).map(e=>({project:e.project})))}),console.log(n.length+" unknown collab spaces found"),await this._updateCSLists(n.map(e=>e.project)),t.assemblies.forEach(e=>{a=a.concat(e.nodes.filter(e=>this.warningInfoData.privatCS.includes(e.project)).map(e=>e.physicalid)),i=i.concat(e.nodes.filter(e=>null==e.project).map(e=>({physicalid:e.physicalid})))}),i.length>0){let e=(await this._getProjects(i)).results.filter(e=>this.warningInfoData.privatCS.includes(e.project)).map(e=>e.physicalid);a=a.concat(e)}return a},_getCSWarningsEnabled:async function(){let e=await this._getSelectedSecurityContext(),t=await d.get("/resources/lifecycle/util/getExpression",{tenant:this.tenant,securityContext:e,params:{expression:"LifecycleConfidentialityEnabled"}});return!!t.result&&"true"==t.result},_showCSWarning:function(e){e?this.rootGrid&&this.rootGrid.addClassName("lcm-branch-root-grid-warning-visible"):this.rootGrid&&this.rootGrid.removeClassName("lcm-branch-root-grid-warning-visible")},_updateCollabSpaceWarning:async function(){console.log("_updateCollabSpaceWarning");let e=this._getIsTargetCSPrivate(),t=this.useAdvancedBranch?"advanced":"basic";if(this.warningInfoData||(this.warningInfoData={isTargetCSPrivate:e,mode:"basic",warningVisible:!1,initialized:!1},this.warningInfoData.enabled=await this._getCSWarningsEnabled(),this.warningInfoData.enabled&&(this.warningInfoData.allCS=this.allCredentials.map(e=>e.cs),this.warningInfoData.privatCS=this.allCredentials.filter(e=>e.isPrivate).map(e=>e.cs),console.log("Private CS list:"+this.warningInfoData.privatCS))),!this.warningInfoData.enabled)return void console.log("Disabled - exiting");if(this.warningInfoData.initialized&&this.warningInfoData.isTargetCSPrivate===e&&this.warningInfoData.mode===t)return void console.log("State unchanged - exiting");console.log("Target is private:"+e),console.log("UI mode:"+t);var i=this.dialog.elements.footer.querySelector("button.btn-primary");let n=!1;if("advanced"==t){if(!this.warningInfoData.objectsInPrivateCS)try{i.disabled=!0,this.warningInfoData.objectsInPrivateCS=await this._getStructureObjectsInPrivateCS(this.warningInfoData.privatCS),i.disabled=!1,console.log("Num objects in private CS: "+this.warningInfoData.objectsInPrivateCS.length)}catch(e){console.log("error loading tree:"+e)}n=this.warningInfoData.objectsInPrivateCS&&this.warningInfoData.objectsInPrivateCS.length>0&&!e}else{if(!this.warningInfoData.rootsInPrivateCS){i.disabled=!0;let e=new r(this.rootGrid,1e3,B.loadingText),t=await this._getProjects(this.objectsList.map(e=>({physicalid:e.physicalid})));e.unmask(),console.log("projects:"+t),this.warningInfoData.rootsInPrivateCS=t.results.filter(e=>this.warningInfoData.privatCS.includes(e.project)),console.log("Num roots in private CS:"+this.warningInfoData.rootsInPrivateCS.length),i.disabled=!1}n=this.warningInfoData.rootsInPrivateCS.length>0&&!e}n!=this.warningInfoData.warningVisible&&(n?(console.log("Show CS warning"),this._showCSWarning(!0)):(console.log("Remove CS warning"),this._showCSWarning(!1))),n&&"advanced"==t&&!this.warningInfoData.setAdvObjs&&(this.advancedBranchTree.setObjsInPrivateCS(n?this.warningInfoData.objectsInPrivateCS:[]),this.warningInfoData.setAdvObjs=!0),this.warningInfoData.isTargetCSPrivate=e,this.warningInfoData.warningVisible=n,this.warningInfoData.mode=t,this.warningInfoData.initialized=!0}})});