define("DS/ENOGantt/View/FindResource",["UWA/Class","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Data/ResourceStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore","DS/ENOProjectMgmtCommonComponents/utils/ProjectMgmtCloneModel","DS/ENOProjectMgmtModels/Collections/Persons","DS/ENOProjectMgmtModels/Models/Person"],function(e,t,a,r,n,o,s,i){var d;try{d=e.extend({init:function(e){let t=UWA.clone(e||{},!1);that=this,that.viewCollection=t.viewCollection;new a({viewCollection:that.viewCollection});that.resourceStore=Ext.create("DS.ENOGantt.Data.ResourceStore",{storeId:"resourceStore"}),Ext.define("DS.ENOGantt.View.FindResource",{extend:"Ext.form.field.ComboBox",xtype:"dpmfindresourceview",store:that.resourceStore,displayField:"title",emptyText:App.Nls["emxProgramCentral.Gantt.ResourceUtilization.FindResource.PlaceholderText"],typeAhead:!1,minChars:3,hideLabel:!0,hideTrigger:!0,width:"100%",anchor:"100%",displayField:"Name",valueField:"UserName",queryCaching:!1,listeners:{beforequery:function(e){var t=e.query;if(t){return!/([\\\"\#\$\@\%\*\,\/\?\<\>\[\]\|\:\']+(\s[\\\"\#\$\@\%\*\,\?\\\\\<\>\[\]\|\:\']+)?)/.test(t)}return!1},select:function(e,t,a){that.assignResource(t),e.clearValue()}}})},assignResource:function(e){var t=this,a=Ext.ComponentQuery.query("#dpmprojectgantt")[0],d=Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0],l=e.get("Id");if(a.resourceStore.getModelById(l))return Ext.Msg.alert(App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Header"],App.Nls["emxProgramCentral.Gantt.ResourceUtilization.AddAssignment.Alert.Body"].replace("{PERSON_NAME}",e.get("Name")),Ext.emptyFn),void combo.clearValue();var c=d.context,u=c.get("Id"),m=c.get("TaskProjectId"),g=a.taskStore.getModelById(m),S=g.get("StartDate").getTime(),p=g.get("EndDate").getTime();this.data={taskId:u,resourceId:l,taskProjectId:m,projectStart:S,projectEnd:p};let f=App.Infra.contextInfo,D=f.getAllTasks(),h=f.id===u?f:D.get(u),E=h.get("assignees")||new s,T=new i({id:l});E.add(T),h.set("assignees",E),UWA.extend(h._changed,{objectId:h.id});let v=n.getAssignResourceToTaskUrl();var x=function(e){let n,o=t.data.taskProjectId,s=t.data.projectStart,i=t.data.projectEnd,d=(t.data.taskId,t.data.resourceId),l=e.assignees;l&&l.forEach(e=>{e.id===d&&(n=e)});data.length;var c=[],u=[],m=[];if(n){if(n.FirstName=n.firstname,n.LastName=n.lastname,n.Name=n.name,delete n.firstname,delete n.lastname,delete n.name,n.calendar&&n.calendar.length>0){n.hasCalendar=!0;var g=n.calendar[0].id}var S=n.WorkTime;n.WorkTime=S?parseFloat(S)/60:parseFloat("8.0");var p=n.Id;if(""==g||null==g)g="Custom:"+p;n.CalendarId=g,c.push(n);var f=n.Assignments;if(f&&f.length>0)for(var D=f[0],h=(D.contextUser,1);h<f.length;h++){var E=f[h],T=E,v=E.relelements;r.convertToGanttKeyValues(T),r.convertToGanttKeyValues(v);var x=new Date(T.StartDate),I=new Date(T.EndDate),k=r.stdTimezoneOffset(x),y=x.getTimezoneOffset();if(x=x.getTime(),I=I.getTime(),k!==y&&(x+=60*(y-k)*1e3,I+=60*(y-k)*1e3),!(x<s||I>i)){var N={};N.TaskId=T.TaskId;var w=a.taskStore.getModelById(N.TaskId);N.isReadOnly=!1,w&&"TRUE"!=w.data.hasEditAccess&&(N.isReadOnly=!0);var C=E.type;if(D[C]&&(N.icon=D[C]),N.Id=v.Id,N.Units=v.allocation,N.ResourceId=p,T.TaskProjectId==o)N.Type="Internal";else{var A={};N.Type="External",A.Id=T.TaskId,A.Name=T.Name,A.PercentDone=T.PercentDone,A.Duration=T.Duration,T.StartDate&&(T.StartDate=Ext.Date.format(new Date(T.StartDate),"c")),T.EndDate&&(T.EndDate=Ext.Date.format(new Date(T.EndDate),"c")),A.StartDate=T.StartDate,A.EndDate=T.EndDate,A.expanded=!0,m.push(A)}u.push(N)}}}var R=a.taskStore.data.items[0],M=m.length;if(M>0)for(var O=0;O<M;O++){var P=m[O],j=P.Id;if(null==a.taskStore.getModelById(j)&&"root"!=P.Name){P.visible=!1,P.Id=j,P.Rollup=!1,P.ReadOnly=!0,P.ExternalTask=!0,P.expanded=!0;var F=Ext.create("DS.ENOGantt.Data.TaskModel",P);App.Infra.ExtTaskArray.push(F),R.addTaskBelow(F),R.nextSibling="",a.taskStore.commitChanges()}}u.length;c.length>0&&a.taskStore.resourceStore.add(c),u.length>0&&a.taskStore.assignmentStore.add(u),a.taskStore.resourceStore.commitChanges(),a.taskStore.assignmentStore.commitChanges(),a.taskStore.commitChanges(),a.taskStore.filterBy(function(e){return!e.get("ExternalTask")})};if(window.isODTRunning)"GET",dataObj="",Ext.Ajax.request({url:getAssignResourceToTaskUrl,async:!1,success:function(e){e=JSON.parse(e.responseText.trim()),x(e)}});else{let e=a.crudManager.viewCollection,t=e.getFieldsAndIncludeParamsForDataModelDetails({}),r=new o(h);window.Widget||(donotShowMessage=!0),e.processSaveDataModel(r,{fields:t.fields+","+v.fields,include:t.include+","+v.include,isNew:!1,donotShowMessage:donotShowMessage,customParams:v.customParams,onComplete:function(e){x(JSON.parse(JSON.stringify(e)))}})}}})}catch(e){console.log("::::::::error")}return d});