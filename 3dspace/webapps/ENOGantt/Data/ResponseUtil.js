define("DS/ENOGantt/Data/ResponseUtil",["UWA/Utils","DS/ENOGantt/GanttConstants","DS/Foundation2/FoundationV2Data","DS/ENOProjectMgmtModels/Collections/Tasks","DS/ENOProjectMgmtModels/Collections/Calendars","DS/ENOProjectMgmtModels/Models/Task","DS/ENOProjectMgmtModels/Models/FieldsDefinition"],function(e,t,a,n,r,s,o){"use strict";var d={},i=[],l={},c={},p={},u={To6WFieldMap:{icon:"typeicon","current.access[modify]":"modifyAccess",Policy:"policy",Type:"nlsType",Name:"title",Id:"objectId",State:"state",PercentDone:"percentComplete",StartDate:"estimatedStartDate",EndDate:"dueDate",Duration:"estimatedDurationInputValue",DurationUnit:"estimatedDurationInputUnit",ConstraintType:"constraintType",ConstraintDate:"constraintDate",TaskSequenceId:"sequenceOrder",LagTime:"lagTime",Lag:"lagTimeInputValue",LagUnit:"lagTimeUnitValue",Type:"dependencyType",TaskProjectId:"taskProjectId",CriticalTask:"criticalTask",Status:"status",SourceId:"sourceId",ScheduleFrom:"scheduleFrom",Owner:"owner",FreeFloat:"freeFloat",TotalFloat:"totalFloat",ExpectedEndDate:"expectedEndDate",Color:"color",Pattern:"pattern",Symbol:"symbol",Note:"notes",Description:"description"},ToGanttFieldMap:{typeicon:"icon",modifyAccess:"current.access[modify]",policy:"Policy",nlsType:"Type",title:"Name",objectId:"Id",state:"State",percentComplete:"PercentDone",estimatedStartDate:"StartDate",dueDate:"EndDate",estimatedDurationInputValue:"Duration",estimatedDurationInputUnit:"DurationUnit",constraintType:"ConstraintType",constraintDate:"ConstraintDate",sequenceOrder:"TaskSequenceId",lagTimeInputValue:"Lag",lagTimeInputUnit:"LagUnit",dependencyType:"Type",taskProjectId:"TaskProjectId",criticalTask:"CriticalTask",status:"Status",sourceId:"SourceId",scheduleFrom:"ScheduleFrom",owner:"Owner",expectedEndDate:"ExpectedEndDate",freeFloat:"FreeFloat",totalFloat:"TotalFloat",color:"Color",pattern:"Pattern",symbol:"Symbol",notes:"Note",description:"Description"},convertToGanttKeyValues:function(e){for(var t in e)if(t&&(App.Infra.CustomeColumnDataIndex.includes(t)&&(e[t]=this.formatDate(e[t])),e.hasOwnProperty(t))){var a,n=App.Infra.isCustomizedEnvironment;!n||"actualStartDate"!==t&&"actualFinishDate"!==t&&"actualDuration"!==t?n||"forecastStartDate"!==t&&"forecastFinishDate"!==t&&"forecastDuration"!==t?a=this.ToGanttFieldMap[t]:"forecastStartDate"===t?a="BaselineStartDate":"forecastFinishDate"===t?a="BaselineEndDate":"forecastDuration"===t&&(a="BaselineDuration"):"actualStartDate"===t?a="BaselineStartDate":"actualFinishDate"===t?a="BaselineEndDate":"actualDuration"===t&&(a="BaselineDuration"),a&&(e[a]=e[t],delete e[t])}},convertTo6WKeyValues:function(e){for(var t in e)if(t&&(App.Infra.CustomeColumnDataIndex.includes(t)&&(e[t]=this.getFormattedDate(new Date(e[t]))),e.hasOwnProperty(t))){var a,n=App.Infra.isCustomizedEnvironment;!n||"BaselineStartDate"!==t&&"BaselineEndDate"!==t&&"BaselineDuration"!==t?n||"BaselineStartDate"!==t&&"BaselineEndDate"!==t&&"BaselineDuration"!==t?a=this.To6WFieldMap[t]:"BaselineStartDate"===t?a="forecastStartDate":"BaselineEndDate"===t?a="forecastFinishDate":"BaselineDuration"===t&&(a="forecastDuration"):"BaselineStartDate"===t?a="actualStartDate":"BaselineEndDate"===t?a="actualFinishDate":"BaselineDuration"===t&&(a="actualDuration"),a&&(e[a]=e[t],delete e[t])}},mergeRelDataToBusData:function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])},filterTaskForStatusReport:function(e,t){var a,n=t.taskStore.store.toArray(),r=[],s=e.tasks?e.tasks.rows:e,o=enoviaServer.objectId,d=[];if(enoviaServer.initGantt)for(var i=1;i<n.length;i++)a=n[i].data.Id,d.push(a);else void 0!==o&&(d=o.split(","));for(var l=0;l<s.length;l++)if(a=s[l].Id,-1!==d.indexOf(a)&&r.push(s[l]),s[l].children.length>0){var c=this.filterTaskForStatusReport(s[l].children,t);r=r.concat(c)}return r},formatAssignees:function(e){for(var t=[],a=0,n=e.length;a<n;a++){var r=e[a].fullname;t.push(r)}return t.join()},setLastSequence:function(e){var t=e.TaskProjectId;if(t){if(t&&(d[t]||(d[t]={}),e.TaskSequenceId))if(void 0===d[t].LastSequence)d[t].LastSequence=e.TaskSequenceId;else{var a=parseInt(d[t].LastSequence),n=parseInt(e.TaskSequenceId);(void 0===a||n>a)&&(d[t].LastSequence=e.TaskSequenceId)}}else{if(d[e.Id]){var r=d[e.Id].LastSequence;e.LastSequence=r}d[e.Id]=e}},formatDate:function(e){return e},getEnglishType:function(e){var t=e.type||e.Type,a="Task";void 0!==t&&(t=t.split(" ").join(""),a=App.Infra.DerivativeTypes[t]);return a},isEqualObject:function(e,t){var a=!0;for(let n in e)if(n){if(e[n]===t[n])continue;a=!1;break}return a},mergeExternalDep:function(e,t){for(var a=t.length-1;a>=0;a--){for(var n=t[a],r=!0,s=e.length-1;s>=0;s--){var o=e[s];if(o.predProjectName===n.predProjectName&&o.From===n.From&&o.To===n.To){if(r=!1,this.isEqualObject(n,o))continue;t[a]=o,e.splice(s,1)}}r&&t.splice(a,1)}if(e.length>0)for(var d=0;d<e.length;d++)t.push(e[d]);return t},setRawExternalDependency:function(e,t,a){var n=e.get("ExternalRawDependencies");(n={}).updated=[],n.added=[],n.removed=[];for(var r=0;r<a.length;r++){for(var s=a[r],o=!0,d=t.length-1;d>=0;d--){var i=t[d];i.predProjectName===s.predProjectName&&i.From===s.From&&i.To===s.To&&i.Type===s.Type&&i.Lag===s.Lag&&i.LagUnit===s.LagUnit&&(o=!1)}o&&n.removed.push(s)}if(t.length>0)for(var l=0;l<t.length;l++)n.added.push(t[l]);e.set("ExternalRawDependencies",n)},formatCalendarData:function(e){var t=[];return e&&e.forEach(e=>{e.Id=e.id,e.name=e.name,e.HoursPerDay=parseFloat(e.workHoursPerDay)/60;var a=[],n=e.workweek,r=0;n&&n.forEach((t,n)=>{var s=t.workdayType;"Non Working"===s&&void 0===e.WeekendFirstDay?e.WeekendFirstDay=n:"Non Working"===s?e.WeekendSecondDay=n:void 0===e.WeekendSecondDay?e.WeekendSecondDay=e.WeekendFirstDay:void 0===e.WeekendFirstDay&&void 0===e.WeekendSecondDay&&(e.WeekendsAreWorkdays=!0);var o=t.workingHours;o&&""!==o||(o="0000-0000");for(var d=[],i=o.split(","),l=0;l<i.length;l++){var c=i[l].split("-"),p=c[0].substr(0,2)+":"+c[0].substr(2,2)+"-"+(c[1].substr(0,2)+":"+c[1].substr(2,2));d.push(p)}"Working"===s?(r++,a.push({Type:"WEEKDAY",Weekday:n,IsWorkingDay:!0,Availability:d})):a.push({Type:"WEEKDAY",Weekday:n,IsWorkingDay:!1})}),e.DaysPerWeek=r,delete e.id,delete e.workHoursPerDay,delete e.workweek,e.Days={rows:a},t.push(e)}),t},formatDependencies:function(e,t){for(var a=new Array,n=t.TaskProjectId,r=new Array,s=e.length,o=0;o<s;o++){var d=e[o],l=d;l.Id=d.relId,this.convertToGanttKeyValues(l);var c=l.predTaskSeqNumber;c&&(l.predTaskSeqNumber=parseInt(c)),l.predecessorTaskName=d.title;var p=l.Type,u=t.TaskSequenceId;u&&(l.taskSeqNumber=parseInt(u)),l.successorTaskName=t.Name;var D=l.predTaskSeqNumber,f=l.predProjectName,g=l.predProjectId,h=l.Lag,T=l.LagUnit,m="",v=!0;if(f&&!i.includes(f)?(m=f+":",v=!1):f&&i.includes(f)&&n!==g?m=f+":":delete l.predProjectName,m=m+D+":"+p+"+"+h+" "+T,v||(l.isExtDep=!0,r.push(l)),void 0!==p){switch(p){case"SS":p="0";break;case"SF":p="1";break;case"FS":p="2";break;case"FF":p="3"}l.Type=p}v&&a.push(l)}return r.sort(),t.ExternalDependencies=r,a},formatDeliverableForStatusReport:function(e){for(var t=[],a=0;a<e.length;a++){var n=e[a],r={};r.Id=n.id;var s=n;r.Name=s.name,r.leaf=!0,t.push(r)}return t},getsourceIdData:function(e,t){var a=[];if((a=t?e:e.relateddata.tasks).length>0)for(var n=0,r=a.length;n<r;n++){var s=a[n];this.convertToGanttKeyValues(s);var o=s.SourceId;if(p[o]=s,a[n].children.length>0){var d=this.getsourceIdData(a[n].children,!0);this.mergeRelDataToBusData(p,d)}}return p},populateProjectNames:function(e){e&&e.forEach(e=>{var t=this.getEnglishType(e);this.isProjectType(t)&&i.push(e.name||e.title),e.tasks&&e.tasks.length>0&&this.populateProjectNames(e.tasks)})},loadFormat:function(e,a){var n=e[0],r=enoviaServer.viewId||App.Infra.ViewId;if(r===App.Infra.Views.VIEW_STATUS_REPORT){if(n.tasks&&n.tasks.length&&(e=[],e=n.tasks),!window.isODTRunning&&null!=e)for(var s=e.length,o=0;o<s;o++)e[o].CalendarId=App.Infra.projectDataElements.CalendarId}else a||(n.expanded="true",n.FreeFloat="0.0",n.TotalFloat="0.0",this.setProjectModel(n),"Project Start Date"===n.scheduleFrom?n.ScheduleBackwards=!1:n.ScheduleBackwards=!0,window.isODTRunning&&(n.expanded="true"),n.tasks&&n.tasks.length&&(n.children=[],n.children=n.tasks));var d=e.length;a||this.populateProjectNames(e);var i=new Array,l=new Array,c=(new Array,[]),u=[];for(o=0;o<d;o++){var D=e[o],f=D.id,g=D;this.convertToGanttKeyValues(g),g.Id=f;var h=D.children;if(h&&h.length>0){var T=this.loadFormat(h,!0);App.Infra.isCustomizedEnvironment&&(T.predActualStartDate.sort(),T.predActualEndDate.sort(),g.BaselineStartDate=T.predActualStartDate[0],g.BaselineEndDate=T.predActualEndDate[T.predActualEndDate.length-1]),g.children=T.tasks.rows,l=l.concat(T.dependencies.rows)}else g.children=[];g.hasEditAccess=g["current.access[modify]"],g.ReadOnly="TRUE"!=g.hasEditAccess;var m=g.isSummaryTask;let a=this.getEnglishType(g);m&&"true"==m.toLowerCase()&&r!=App.Infra.Views.VIEW_STATUS_REPORT?g.leaf=!1:g.leaf="ProjectTemplate"!=a&&"ProjectSpace"!=a&&"ProjectConcept"!=a&&"Experiment"!=a,this.setLastSequence(g);var v=g.isTypeGate,y=g.isTypeMilestone;g.Rollup="TRUE"==v||"TRUE"==y;var I=g.ConstraintType?g.ConstraintType:g.defaultConstraintType;I&&("assoonaspossible"==(I=(I=I.replace(/ /g,"")).toLowerCase())&&(I=""),"TRUE"!=g.kindOfProjectSpace&&"TRUE"!=g.kindOfExperiment&&"TRUE"!=g.kindOfProjectConcept&&null!=g.ConstraintType&&""!=g.ConstraintType&&(g.ConstraintType=I));var S=g.Policy;if(-1!=t.OOTBPolicyList.indexOf(S)&&void 0!==App.Nls[g.State]&&(g.State=App.Nls[g.State]),g.ExternalDependencies=[],App.Infra.expandStatus[f]&&(g.expanded=!0),App.Infra.isCustomizedEnvironment){var k=p[g.SourceId];if(e.length>1&&k){var E=k.StartDate,A=k.EndDate;g.BaselineStartDate=this.formatDate(E),g.BaselineEndDate=this.formatDate(A)}else g.BaselineStartDate=this.formatDate(g.BaselineStartDate),g.BaselineEndDate=this.formatDate(g.BaselineEndDate);r!=App.Infra.Views.VIEW_EXPERIMENT_VERSUS_PROJECT&&r!=App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE&&r!=App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE2&&(g.BaselineStartDate&&""!=g.BaselineStartDate||(g.BaselineStartDate=g.StartDate),g.BaselineEndDate&&""!=g.BaselineEndDate||(g.predictiveActualFinishDate?(g.predictiveActualFinishDate=this.formatDate(g.predictiveActualFinishDate),g.BaselineEndDate=g.predictiveActualFinishDate):g.BaselineEndDate=g.EndDate),c.push(g.BaselineStartDate),u.push(g.BaselineEndDate));var P=App.Nls["emxProgramCentral.DurationUnits.Days"];g.BaselineDuration=g.BaselineDuration+" "+P.toLowerCase()}var F=g.TaskSequenceId;if(F&&(g.TaskSequenceId=parseInt(F)),g.EnglishType=this.getEnglishType(D),g.ExternalProjectDepRawData=[],D.assignees&&r!=App.Infra.Views.VIEW_STATUS_REPORT&&D.assignees.length>0){var C=this.formatAssignees(D.assignees);g.Assignee=C}if(D.deliverables&&D.deliverables.length>0&&r==App.Infra.Views.VIEW_STATUS_REPORT&&!enoviaServer.initGantt){var w=this.formatDeliverableForStatusReport(D.deliverables,g);g.leaf=!1,g.children=w}if(i.push(g),D.predecessors&&r!=App.Infra.Views.VIEW_STATUS_REPORT){var x=this.formatDependencies(D.predecessors,g);l=l.concat(x)}}return{success:!0,tasks:{rows:i},dependencies:{rows:l},calendars:{rows:App.Infra.calendarData},predActualStartDate:c,predActualEndDate:u}},isProjectType:function(e){return"ProjectTemplate"===e||"ProjectSpace"===e||"ProjectConcept"===e||"Experiment"===e||"ProjectBaseline"===e},syncFormat:function(e,a,n,r){if(!a){for(var s=r.taskStore.store.toArray(),o=0,d=s.length;o<d;o++){var p=s[o].data.EnglishType;this.isProjectType(p)&&i.push(s[o].data.Name)}var u=e;if(u&&u.tasks&&u.tasks.length>0&&(u.children=[],u.children=u.children.concat(u.tasks)),u&&u.performRollup&&u.performRollup.length>0){var D=u.performRollup,f=r.getTaskStore().collect("Id");if(D&&D.length){for(var g=D.length-1;g>=0;g--){var h=D[g].id;f.indexOf(h)<0&&D.splice(g,1)}u.children=u.children.concat(D)}}}var T=new Array,m=[],v=[],y=[],I=[],S=[];if(n&&n.contextTaskId&&S.push(n.contextTaskId),n&&n.deletedTaskArray&&(m=m.concat(n.deletedTaskArray)),e){var k=[],E=(C=e).children;if(E&&E.length>0)for(var A=[],P=[],F=0;F<E.length;F++){var C,w=!0;if("RemovedTasks"==(ae=(C=E[F]).id)){k=C.children;for(d=0;d<k.length;d++){var x=k[d];m.push(x)}}else{var B=!0,U=C;if(U){if(C.tempId)U.PhantomId=c.TaskPhantomId,delete c.TaskPhantomId;else{var j=(r=Ext.ComponentQuery.query("#dpmprojectgantt")[0].crudManager).taskStore.store.getModelById(ae);0==App.Infra.Load.Level||j||(w=!1)}var N=C.relelements;this.mergeRelDataToBusData(U,N),this.convertToGanttKeyValues(U),U.Id=ae;var b=C.tasks;if(b&&b.length>0){var W=this.syncFormat({children:b},!0);App.Infra.isCustomizedEnvironment&&(W.predActualStartDate.sort(),W.predActualEndDate.sort(),U.BaselineStartDate=W.predActualStartDate[0],U.BaselineEndDate=W.predActualEndDate[W.predActualEndDate.length-1]),T=T.concat(W.tasks.rows)}B=U.isSummaryTask;let e=this.getEnglishType(U);B&&"true"==B.toLowerCase()?U.leaf=!1:U.leaf="ProjectTemplate"!=e&&"ProjectSpace"!=e&&"ProjectConcept"!=e&&"Experiment"!=e;var L=U.TaskSequenceId;if(L&&(U.TaskSequenceId=parseInt(L)),""==U.ConstraintDate)U.ConstraintType="";else{var R=U.ConstraintType;if(R&&(R=(R=R.replace(/ /g,"")).toLowerCase()),"assoonaspossible"==R&&(R=""),"muststarton"!=U.ConstraintType&&"mustfinishon"!=U.ConstraintType){R=""}U.ConstraintType=R,U.ConstraintDate=this.formatDate(U.ConstraintDate)}var O=U.Policy;if(-1!=t.OOTBPolicyList.indexOf(O)&&void 0!==App.Nls[U.State]&&(U.State=App.Nls[U.State]),App.Infra.isCustomizedEnvironment){U.StartDate=this.formatDate(U.StartDate),U.EndDate=this.formatDate(U.EndDate),U.BaselineStartDate=this.formatDate(U.BaselineStartDate),U.BaselineEndDate=this.formatDate(U.BaselineEndDate),U.BaselineStartDate&&""!=U.BaselineStartDate||(U.BaselineStartDate=U.StartDate),U.BaselineEndDate&&""!=U.BaselineEndDate||(U.predictiveActualFinishDate?(U.predictiveActualFinishDate=this.formatDate(U.predictiveActualFinishDate),U.BaselineEndDate=U.predictiveActualFinishDate):U.BaselineEndDate=U.EndDate),A.push(U.BaselineStartDate),P.push(U.BaselineEndDate);var M=App.Nls["emxProgramCentral.DurationUnits.Days"];U.BaselineDuration=U.BaselineDuration+" "+M.toLowerCase()}U.EnglishType=this.getEnglishType(C),w&&T.push(U)}}if(n&&n.removedDepArray&&(y=n.removedDepArray),C.relateddata){if(C.predecessors&&C.predecessors.length>0){var V=r.taskStore.store,_=C.id,q=V.getModelById(C.Id),G=q.get("TaskProjectId"),K=C.predecessors,z=new Array,H=new Array;for(o=0;o<K.length;o++){(x=K[o]).Id=K[o].relId,this.convertToGanttKeyValues(x);x.To;var Y=x.Type,J=x.predTaskSeqNumber,$=x.Lag,Q=x.LagUnit,X=x.predProjectName,Z=x.predProjectId,ee=!0;X&&!i.includes(X)?ee=!1:X&&i.includes(X)&&G!=Z?te=X+":":delete x.predProjectName,te=te+J+":"+Y+"+"+$+" "+Q;var te=J+":"+Y+"+"+$+" "+Q;z.push(te);var ae=K[o].id;if("SS"==x.Type?x.Type="0":"SF"==x.Type?x.Type="1":"FS"==x.Type?x.Type="2":"FF"==x.Type&&(x.Type="3"),ee){var ne=x.To,re=x.From,se=x.$PhantomId,oe=ne+"-"+re;(se=l[oe])&&(delete l[oe],x.$PhantomId=se),v.push(x)}else x.isExtDep=!0,H.push(x)}if(q){var de=q.get("ExternalDependencies"),ie=this.mergeExternalDep(H,de);_=C.Id;T.push({Id:_,ExternalDependencies:ie})}z.sort()}if(C.assignees){var le=C.assignees;for(o=0;o<le.length;o++){(x=le[o]).Id=le[o].relId,this.convertToGanttKeyValues(x),I.push(x)}}}}}return{success:!0,tasks:{rows:T,removed:m},dependencies:{rows:v,removed:y},assignments:{rows:I,removed:S},resources:{rows:[],removed:[]},predActualStartDate:A,predActualEndDate:P}},getFormattedDate:function(e){return e instanceof Date?Ext.Date.format(e,"Y-m-d\\TH:i:s"):e},get6WTaskDataSkeleton:function(){return{dataelements:{},id:"",updateAction:"",children:[],relelements:{},relateddata:{predecessors:[]}}},get6WDependencyDataSkeleton:function(e){return{id:"",updateAction:e,relelements:{}}},formatDeletedTaskModelData:function(e,t,a,n){for(var r=e.taskStore.store.getRemovedRecords(),s=[],d={},i=0,l=r.length;i<l;i++){var c=r[i],p=c.id;let e=c.data.lastParentId;s.push({Id:p});let t={};t.lastParentId=e;var u=c.data.EnglishType;"ProjectSpace"!==u&&"ProjectConcept"!==u&&"Experiment"!==u||(t.isDisconnect=!0),d[p]=t}let D=App.Infra.contextInfo;t&&t.length&&t.forEach(e=>{var t=e.Id;let a=d[t].lastParentId;if(a){let e=D.id===a?D:n.get(a),r=e.get("tasks"),s=r.get(t);s.performDeleteOnDisconnect=o.isTaskType(s.get("type")),r.remove(t),e.set("tasks",r),UWA.extend(e._changed,{objectId:e.id})}})},formatAssignment6WData:function(e,t,a,n){var r=e.taskStore.store.assignmentStore;let s=App.Infra.contextInfo;if(t.updated)for(var o=t.updated,d=0,i=o.length;d<i;d++){let e=o[d],t=e.Id,a=e.Units,i=r.getModelById(t),c=i.get("ResourceId");var l=i.get("TaskId");let p,u=s.id===l?s:n.get(l),D=u.get("assignees");D&&D.forEach(e=>{e.id===c&&(p=e)}),p&&(p.set({allocation:""+a}),UWA.extend(u._changed,{objectId:u.id}))}if(t.removed){let e=t.removed;for(let o=0,d=t.removed.length;o<d;o++){let d=t.removed[o].TaskId;if(a.includes(d))continue;let i=s.id===d?s:n.get(d),l=i.get("assignees"),c=(e=r.removed)[0].get("ResourceId");l.remove(c),i.set("assignees",l),UWA.extend(i._changed,{objectId:i.id})}}},formatNewTaskData:function(e,t,a,n,r){return this.convertTo6WKeyValues(e),UWA.extend(e,{tempId:t,type:a}),r?UWA.extend(e,{nextTaskId:n}):UWA.extend(e,{previousTaskId:n}),new s(e)},formatAddedTaskModelData:function(e,t,a){this.formatTaskDataForSync(e,t,"added");var n=e.taskStore.store,r=e.transport.sync.params.extraParam;let s,o=App.Infra.contextInfo,d=t.length,i=[];return t&&t.forEach(e=>{e.Duration=""+e.Duration;var t=e.PhantomId;e.Name||delete e.Name,c.TaskPhantomId=t;var l=r[t],p=l.addTaskAbove,u=l.type;let D,f,g=p?l.selectedTaskId:e.parentId,h=n.getModelById(g);if(p){D=g,h.parentNode.get("Type")&&(f=h.parentNode.get("Id"))}else{var T=h.childNodes.length;f=g,T>d&&(D=h.childNodes[T-(d+1)].id)}if(f){s=o.id===f?o:a.get(f);let n=this.formatNewTaskData(e,t,u,D,p);i.push(n)}}),{childObjs:i,parentModel:s,isNew:!0}},formatUpdateTaskDataForRightIndent:function(e,t,a,r,s){let o=r.id===e?r:s.get(e);var d=a.getModelById(t);"Project Space"===d.get("Type")&&(t=d.previousSibling.id),o.set({operation:"IndentationAndDragDrop"});let i=r.id===t?r:s.get(t),l=i.get("tasks")||new n;l&&(l.add(o),i.set("tasks",l)),i&&UWA.extend(i._changed,{objectId:i.id})},formatUpdateTaskDataForLeftIndent:function(e,t,a,r,s){var o=a.getModelById(e);let d,i,l=r.id===e?r:s.get(e);t&&null!==o.nextSibling?d=o.nextSibling.id:null!==o.previousSibling?i=o.previousSibling.id:null!==o.nextSibling?d=o.nextSibling.id:i=o.parentNode.id,l.set({operation:"IndentationAndDragDrop",nextTaskId:d,previousTaskId:i});let c=r.id===t?r:s.get(t),p=c.get("tasks")||new n;p&&(p.add(l),c.set("tasks",p)),c&&UWA.extend(c._changed,{objectId:c.id})},formatUpdateTaskDataForDragDrop:function(e,t,a,r){let s,o=e.Id,d=e.parentId,i="",l="",c=t.getModelById(o),p=a.id===o?a:r.get(o);if(!0===e.leaf&&1==e.Duration){p&&(this.convertTo6WKeyValues(e),p.set(e));let t=c.parentNode.get("Id"),n=a.id===t?a:r.get(t);n&&UWA.extend(n._changed,{objectId:n.id})}if("Active"===e.State){p&&(this.convertTo6WKeyValues(e),p.set(e));let t=c.parentNode.get("Id"),n=a.id===t?a:r.get(t);n&&UWA.extend(n._changed,{objectId:n.id})}else if(d?(i="True",s=d):s=c.parentNode.id,"root"!==s){let e,t;"True"===i&&(l="IndentationAndDragDrop"),d&&null!==c.nextSibling?e=c.nextSibling.id:null!==c.previousSibling?t=c.previousSibling.id:null!==c.nextSibling?e=c.nextSibling.id:t=c.parentNode.id,p.set({operation:l,isOnlyResequencing:"isOnlyResequencing",nextTaskId:e,previousTaskId:t});let o=a.id===s?a:r.get(s),u=o.get("tasks")||new n;u&&(u.remove(p),u.add(p),o.set("tasks",u)),o&&UWA.extend(o._changed,{objectId:o.id})}else{p&&(this.convertTo6WKeyValues(e),p.set(e));let t=c.parentNode.get("Id"),n=a.id===t?a:r.get(t);n&&UWA.extend(n._changed,{objectId:n.id})}},formatUpdateTaskModelData:function(e,t,a){!0===e.transport.sync.params.DragDrop&&t.sort(function(e,t){return e.index<t.index?-1:e.index>t.index?1:0}),this.formatTaskDataForSync(e,t,"updated");var n=e.taskStore.store;let r=App.Infra.contextInfo;return t&&t.length&&t.forEach(t=>{let s=t.Id,o=r.id===s?r:a.get(s),d=n.getModelById(s);if("Complete"!==o.get("state")&&(!0!==e.transport.sync.params.DragDrop||100!=o.get("percentComplete")))if(t.Duration&&(t.Duration=""+t.Duration),void 0!==t.PercentDone&&(t.PercentDone=""+t.PercentDone),e.transport.sync.params.RightIndent&&t.parentId)this.formatUpdateTaskDataForRightIndent(s,t.parentId,n,r,a);else if(e.transport.sync.params.LeftIndent&&t.parentId)this.formatUpdateTaskDataForLeftIndent(s,t.parentId,n,r,a);else if(e.transport.sync.params.DragDrop)this.formatUpdateTaskDataForDragDrop(t,n,r,a);else{let e=d.parentNode.get("Id"),n=r.id===e?r:a.get(e);o&&(this.convertTo6WKeyValues(t),o.set(t)),n&&UWA.extend(n._changed,{objectId:n.id})}}),r},appendUpdatedPredecessorModelData:function(e,t,a,n,r){var s=t.updated,o=e.taskStore.store.dependencyStore,d={};for(let e=0,t=s.length;e<t;e++){var i=s[e],l=i.isExtDep?i:o.getModelById(i.Id).data,c=l.To;void 0!==i.Lag?i.LagTime=""+i.Lag:i.LagTime=""+l.Lag,void 0!==i.LagUnit?i.LagTime=i.LagTime+" "+i.LagUnit:i.LagTime=i.LagTime+" "+l.LagUnit;var p=l.From;n.includes(c)||n.includes(p)||("0"==i.Type?i.Type="SS":"1"==i.Type?i.Type="SF":"2"==i.Type?i.Type="FS":"3"==i.Type&&(i.Type="FF"),this.convertTo6WKeyValues(i),UWA.extend(i,{id:l.From}),d.hasOwnProperty(c)?d[c].push(i):d[c]=[i])}if(s.length>0)for(var u=0,D=a.length;u<D;u++){var f=a[u].objectId;if(d[f]&&d[f].length>0){let e=r.get(f).get("predecessors");d[f].forEach(t=>{e.get(t.id).set(t)}),UWA.extend(r.get(f)._changed,{objectId:f}),delete d[f]}}},appendPredecessorModelData:function(e,t,a,n,r){if(t.updated&&this.appendUpdatedPredecessorModelData(e,t,a,n,r,r),t.removed){var s=t.removed;for(let e=0,t=s.length;e<t;e++){let t=s[e],a=t.To,n=t.From,o=r.get(a);o.get("predecessors").remove(n),UWA.extend(o._changed,{objectId:o.id})}}if(t.added){for(var o=t.added,d={},i=0,c=o.length;i<c;i++){var p=o[i],u=p.To,D=p.From;if(null!=p.Lag&&(p.LagTime=""+p.Lag),null!=p.LagUnit&&(p.LagTime=p.Lag+" "+p.LagUnit),!n.includes(u)&&!n.includes(D)){var f=p.$PhantomId;l[h=u+"-"+D]=f,"0"==p.Type?p.Type="SS":"1"==p.Type?p.Type="SF":"2"==p.Type?p.Type="FS":"3"==p.Type&&(p.Type="FF"),this.convertTo6WKeyValues(p),UWA.extend(p,{id:D}),d.hasOwnProperty(u)?d[u].push(p):d[u]=[p]}}for(let e=0,t=a.length;e<t;e++){var g=a[e].objectId;if(d[g]&&d[g].length>0){let e=r.get(g),t=e.get("predecessors")||e.createRelatedDataItems();d[g].forEach(e=>{t.add(e)}),UWA.extend(r.get(g)._changed,{objectId:g}),delete d[g]}}}for(var h in d)if(d.hasOwnProperty(h)){d[h];let e=r.get(h),t=e.get("predecessors")||e.createRelatedDataItems();d[h].forEach(e=>{t.add(e)}),UWA.extend(e._changed,{objectId:h})}},formatLeafTaskDataForSyncUpdated:function(e,t){if(e.ConstraintType||e.ConstraintDate){var a=e.ConstraintType;"startnoearlierthan"===a||"startnolaterthan"===a?e.EndDate&&delete e.EndDate:"finishnoearlierthan"===a&&e.StartDate&&delete e.StartDate,e.StartDate&&(e.StartDate=this.getFormattedDate(new Date(e.StartDate))),e.EndDate&&(e.EndDate=this.getFormattedDate(new Date(e.EndDate)))}else delete e.StartDate,delete e.EndDate;delete e.ConstraintType,delete e.ConstraintDate,e.TaskProjectId=t.get("TaskProjectId")},formatTaskDataForSyncUpdated:function(e,t){for(var a=t.length-1;a>=0;a--){var n=t[a];if(void 0===e.transport.sync.params.DragDrop&&delete n.index,n.parentId&&e.getTaskStore().getModelById(n.Id).data.State===App.Nls.Active&&e.getTaskStore().getModelById(n.parentId).data.State!==App.Nls.Active&&t.push({Id:n.parentId,State:"Active"}),n.StartDate||n.EndDate||n.Duration){var r=n.Id,s=e.taskStore.store.getModelById(r);0==App.Infra.Load.Level||s||(console.log("Updated:"+t[a]),delete t[a]),n.ConstraintDate&&!n.ConstraintType&&(n.ConstraintType=s.get("ConstraintType")),!0===n.leaf&&0!==s.modified.Duration&&(delete n.StartDate,delete n.EndDate,delete n.Duration),s&&(!1===s.get("leaf")&&(delete n.StartDate,delete n.EndDate,delete n.Duration),e.transport.sync.params.RightIndent||e.transport.sync.params.LeftIndent||e.transport.sync.params.DragDrop||!1!==s.get("leaf")?this.formatLeafTaskDataForSyncUpdated(n,s):(n.ConstraintType||n.ConstraintDate||null===n.ConstraintDate&&""===n.ConstraintType)&&(delete n.ConstraintType,delete n.ConstraintDate))}else(n.ConstraintType||n.ConstraintDate||null===n.ConstraintDate&&""===n.ConstraintType)&&(delete n.ConstraintType,delete n.ConstraintDate)}},formatTaskDataForSyncAdded:function(e,a){for(var n=e.transport.sync.params.extraParam,r=0;r<a.length;r++){var s=a[r],o=n[s.PhantomId];if(s.addTaskAbove=o.addTaskAbove,s.type=o.type,!0===s.addTaskAbove&&(s.selectedTaskId=o.selectedTaskId),s.StartDate&&(s.StartDate=this.getFormattedDate(new Date(s.StartDate))),s.EndDate&&(s.EndDate=this.getFormattedDate(new Date(s.EndDate))),s.ConstraintDate&&(s.ConstraintDate=this.getFormattedDate(new Date(s.ConstraintDate))),s.ConstraintType){var d=t.constraintType;s.ConstraintType=d[s.ConstraintType]}}},formatTaskDataForSync:function(e,t,a){"updated"===a&&this.formatTaskDataForSyncUpdated(e,t),"added"===a&&this.formatTaskDataForSyncAdded(e,t)},getCriticalTasksArray:function(e,t){for(var a=new Array,n=e.length,r=0;r<n;r++){var s=e[r],o=s.id,d=s.isOverallCritical;if(d&&"TRUE"===d.toUpperCase()){var i=t.getModelById(o);i&&a.push(i)}var l=s.children;if(l&&l.length>0){var c=this.getCriticalTasksArray(l,t);a=a.concat(c)}}return a},getGanttTableColumnArray:function(e){var t=Ext.ComponentQuery.query("#dpmprojectgantt")[0],a=[];if(t)for(var n=t.columns,r=0;r<n.length;r++){var s=n[r];if((!s||1!=s.hidden||e)&&(a.push(s),n[r].columns))for(var o=n[d].columns,d=0,i=o.length;d<i;d++){var l=o[d];a.push(l)}}return a},stdTimezoneOffset:function(e){var t=new Date(e.getFullYear(),0,1),a=new Date(e.getFullYear(),6,1);return Math.max(t.getTimezoneOffset(),a.getTimezoneOffset())},setProjectModel:function(e){e.TaskType="DS.ENOGantt.Data.ProjectModel",e.AllowDependencies=!0},getUpdatedTaskModels:function(e,t){let a=t.tasks,n=App.Infra.contextInfo,r=n.getAllTasks();var s=[];let o=[];if(a){if((o=a.updated)&&this.formatUpdateTaskModelData(e,o,r),a.added){var d=a.added;return this.formatAddedTaskModelData(e,d,r)}if(a.removed){let a=t.tasks.removed;this.formatDeletedTaskModelData(e,a,s,r)}if(o)for(var i=0;i<o.length;i++)if(o[i].ExternalRawDependencies){var l=o[i].ExternalRawDependencies;if(t.dependencies?(t.dependencies.updated||(t.dependencies.updated=[]),t.dependencies.added||(t.dependencies.added=[]),t.dependencies.removed||(t.dependencies.removed=[])):(t.dependencies={},t.dependencies.added=[],t.dependencies.updated=[],t.dependencies.removed=[]),l.updated){var c=t.dependencies.updated;t.dependencies.updated=c.concat(l.updated)}if(l.added){var p=t.dependencies.added;t.dependencies.added=p.concat(l.added)}if(l.removed){var u=t.dependencies.removed;t.dependencies.removed=u.concat(l.removed)}delete o[i].ExternalRawDependencies,delete o[i].ExternalDependencies}}if(t.dependencies&&this.appendPredecessorModelData(e,t.dependencies,o,s,r),t.assignments){var D=t.assignments;this.formatAssignment6WData(e,D,s,r)}return n},resetChangedAttributes:function(){let e=App.Infra.contextInfo.getAllTasks();e&&e.forEach(e=>{e.resetChangedAttrs()})},loadCalendarData:function(e){return new UWA.Promise(function(t,a){if(!App.Infra.calendarData){(new r).fetch({refresh:!0,ignoreDefinition:!0,fields:e.fields,include:e.include,customParams:e.customParams,onComplete:function(e){App.Infra.calendarData=[];let a=u.formatCalendarData(JSON.parse(JSON.stringify(e)));a&&(App.Infra.calendarData=a),t()}})}})}};return u});