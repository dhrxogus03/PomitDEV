define("DS/ENOGantt/Data/CrudManager",["UWA/Class","DS/PlatformAPI/PlatformAPI","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Ven/Bryntum","DS/ENOGantt/Data/TaskStore","DS/ENOGantt/Data/ResponseUtil","DS/ENOGantt/URLStore","DS/ENOProjectMgmtModels/Utils/StorageDataUtil","DS/ENOProjectMgmtModels/Collections/Tasks","DS/ENOProjectMgmtCommonComponents/utils/ProjectMgmtCloneModel"],function(e,t,a,n,o,r,s,l,i,d){"use strict";return e.extend({init:function(e){let t=UWA.clone(e||{},!1);var a=new o({viewCollection:t.viewCollection});a=a.getStore(),Ext.define("DS.ENOGantt.Data.CrudManager",{extend:"Gnt.data.CrudManager",parentView:t.parentView,viewCollection:t.viewCollection,autoLoad:!1,taskStore:a,prepareRemoved:function(e){for(var t,a=[],n=0,o=e.length;n<o;n++)(t={})[e[n].idProperty]=e[n].getId(),"Gnt.model.Dependency"==e[n].$className&&(t.To=e[n].get("To"),t.From=e[n].get("From")),"Gnt.model.Assignment"==e[n].$className&&(t.TaskId=e[n].get("TaskId")),a.push(t);return a},sendRequest:function(){var e=this,t="live",a=e.transport.sync.params;a&&a.AddRemoveTask&&(t="");var n={rollup:t},o=arguments[0].success,l=JSON.parse(arguments[0].data).type,p="GET";let c=s.getTaskRepositoryURL(l,n,this.transport.load.url);var u,m={};let f,g,S,v=!1;if("sync"===l){if(u={},p="PUT",m=this.getChangeSetPackage(),v=Boolean(m.tasks&&m.tasks.removed),m.tasks)if(void 0===m.tasks.updated)m.tasks.updated={},m.tasks.updated[1]={Id:e.getTaskStore().data.items[0].data.Id};else{for(var A=e.getTaskStore().getRoot().childNodes[0].data.Id,C=m.tasks.updated,D=!1,E=0,I=C.length;E<I;E++){if(C[E].Id===A){D=!0;break}}0==D&&(m.tasks.updated[C.length]={Id:A})}g=r.getUpdatedTaskModels(this,m,this.viewCollection),f=(S=UWA.is(g.isNew,"function")?g.isNew():g.isNew)?g.parentModel:g,u.csrf={name:App.csrf.name,value:App.csrf.value}}u=this.encode(u);if(App.Infra.ViewId!=App.Infra.Views.VIEW_STATUS_REPORT||App.Infra.LoadStatusActualData||enoviaServer.initGantt)if("PUT"===p){let t=f?new d(f):void 0;this.viewCollection.processSaveDataModel(t,{fields:c.fields,include:c.include,isNew:S,isDisconnectModel:v,childObjs:g.childObjs,parentModel:g.parentModel,customParams:c.customParams,donotShowMessage:!window.Widget,doNotCache:!0,onComplete:function(t){e.callbackFunc(JSON.parse(JSON.stringify(t)),o),v&&e.parentView.homeView.dispatchEvent("closePropertyPanel")},onFailure:function(t,a){e.callbackFunc(JSON.parse(JSON.stringify(a)))}})}else{let t=App.Infra.contextInfo;this.viewCollection.getDataModelDetails({model:t,fields:c.fields,include:c.include,customParams:c.customParams,doNotCache:!0,refresh:this.isExpandCall}).then(function(t){e.viewCollection.handleTabViewOnComplete(),delete e.isExpandCall,e.callbackFunc(t.dataForRendering(),o)},function(t){delete e.isExpandCall})}else{(new i).fetch({idList:enoviaServer.objectId,refresh:!0,fields:c.fields,include:c.include,customParams:c.customParams,onComplete:function(t){e.callbackFunc(JSON.parse(JSON.stringify(t)),o)}})}},callbackFunc:function(e,t){var a=this;if(window.isODTRunning&&(this.type=window.ODT.type?window.ODT.type:"GET",delete window.ODT.type),e.error){null!=App.Infra.Load.Level&&0!=App.Infra.Load.Level&&(App.Infra.Load.Level=App.Infra.Load.Level+1),a.activeRequests={};var o="";o=e.error===App.Nls["emxProgramCentral.Gantt.Task.Duration.Limit"]?(o=App.Nls["emxProgramCentral.Gantt.Task.Duration.Limit"]).replace(/\\n/g,"\n"):(o=App.Nls["emxProgramCentral.Gantt.ServerSideFailure"]).replace(/\\n/g,"\n"),alert(o),a.load()}else{var s=e,i=e.csrf;if(i&&(App.csrf=i),a.loaded&&a.activeRequests.sync){var d=Ext.ComponentQuery.query("#dpmprojectgantt")[0],p=d.taskStore.scheduleByConstraints,c=d.taskStore.checkDependencyConstraint,u=d.taskStore.checkPotentialConflictConstraint;d.taskStore.scheduleByConstraints=!1,d.taskStore.checkDependencyConstraint=!1,d.taskStore.checkPotentialConflictConstraint=!1;try{var m=a.transport.sync.params,f=r.syncFormat(s,!1,m,a);a.transport.sync.params={};var g=a.encode(f);t.call(a,g);var S=a.taskStore.store.data.items[0];0!=S.data.PercentDone&&S.data.State===App.Nls.Create&&(S.data.State=App.Nls.Active,a.commit()),100===S.data.PercentDone&&(S.data.State=App.Nls.Review,a.commit()),App.Infra.contextInfo.unset("performRollup"),r.resetChangedAttributes(),window.isIFWE&&(S.previousValues.EndDate||S.previousValues.StartDate)&&(App.ContextModel.model.set({estimatedFinishDate:S.data.EndDate,estimatedStartDate:S.data.StartDate}),delete S.previousValues.StartDate,delete S.previousValues.EndDate,App.ContextModel.model.resetChangedAttrs(),l.set(App.ContextModel.model.id,App.ContextModel.model),App.ContextModel.updateDetailsDisplay()),(m&&m.AddRemoveTask||m&&m.AddRemoveDep||m&&m.LeftIndent||m&&m.RightIndent||m&&m.DragDrop)&&(App.Infra.loadProjectSelectable||(App.Infra.loadProjectSelectable=!0),null!=App.Infra.Load.Level&&0!=App.Infra.Load.Level&&(App.Infra.Load.Level=App.Infra.Load.Level+1),a.isExpandCall=!0,a.load())}catch(e){console.log("Error after sync... "+e)}finally{d.taskStore.scheduleByConstraints=p,d.taskStore.checkDependencyConstraint=c,d.taskStore.checkPotentialConflictConstraint=u}}else{if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT){if(!App.Infra.LoadStatusActualData&&!enoviaServer.initGantt){var v={};v.tasks=s,s=v}}else if(s.length>1){var A=s[1];r.getsourceIdData(A),s.splice(1,1)}var C=r.loadFormat([s]);if(App.Infra.LoadStatusActualData){var D=r.filterTaskForStatusReport(C,a);C.tasks.rows=D,delete App.Infra.LoadStatusActualData}console.timeEnd("loadFormat");g=a.encode(f);if(t.call(a,C,g),a.taskStore.store.autoNormalizeNodes=!0,a.taskStore.store.dependenciesCalendar=App.Infra.depLagCalendar,null==App.Infra.ProjectCalendar||""==App.Infra.ProjectCalendar){var E=a.taskStore.store.data.items[0].get("CalendarId");if(null==E||""==E){var I=new n.data.calendar.BusinessTime({name:"General",calendarId:"General"});a.taskStore.store.setCalendar(I)}else{I=a.getStore("calendars").getCalendar(E);a.taskStore.store.setCalendar(I)}App.Infra.ProjectCalendar=I}if((App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT||1==App.Infra.ReadOnly)&&null==a.taskStore.store.data.items[0].getBaselineEndDate()){var h=Ext.getCmp("View");h.isDisabled()||h.disable()}var w=App.Infra.ViewId;if(w==App.Infra.Views.VIEW_EXPERIMENT_VERSUS_PROJECT||w==App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE||w==App.Infra.Views.VIEW_BASELINE_VERSUS_CURRENT_BASELINE2){var k=a.getTaskStore().collect("BaselineStartDate");k.sort(function(e,t){return(e=new Date(e))-(t=new Date(t))});var T=a.getTaskStore().collect("BaselineEndDate");T.sort(function(e,t){return(e=new Date(e))-(t=new Date(t))}),S.setBaselineStartDate(k[0]),S.setBaselineEndDate(T[T.length-1]),a.commit()}if(a.transport.load.resolve)console.log("Reolve in CRUD"),(0,a.transport.load.resolve)(),delete a.transport.load.resolve;console.timeEnd("call"),App.Infra.loadProjectSelectable&&(App.Infra.loadProjectSelectable=!1)}}(a.transport.load.resolve||window.ODT&&window.ODT.resolve)&&((a.transport.load.resolve||window.ODT.resolve)(),delete a.transport.load.resolve)},transport:{load:{method:"GET",url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:6e4}},sync:{url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:6e4},params:{}}}});var p=Ext.create("DS.ENOGantt.Data.CrudManager");p.on("sync",function(e,t){if(window.isODTRunning&&this.commit(),null!=t&&t.error)alert(t.error),this.reject();else{if(t.assignments)if(t.assignments.rows.length>0||t.assignments.removed.length>0||t.resources.rows.length>0||t.resources.removed.length>0)Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0].getStore().commitChanges(),this.commit();this.hasChanges()?(console.log("============SYNC CALLED========"),this.commit()):this.commit();var a=Ext.getCmp("tBarActionSaveAll"),n=Ext.getCmp("tBarActionResetAll"),o=Ext.getCmp("tBarActionUndo"),r=Ext.getCmp("tBarActionRedo");a.isDisabled()&&n.isDisabled()&&o.isDisabled()&&r.isDisabled()||(a.disable(),n.disable(),o.disable(),r.disable())}Ext.ComponentQuery.query("#dpmprojectgantt")[0].undoManager.start()}),p.on("haschanges",function(e,t){var a=Ext.getCmp("tBarActionSaveAll"),n=Ext.getCmp("tBarActionResetAll"),o=Ext.getCmp("tBarActionUndo");(a.isDisabled()||n.isDisabled()||o.isDisabled())&&(a.enable(),n.enable(),o.enable())}),p.on("nochanges",function(e,t){var a=Ext.getCmp("tBarActionSaveAll"),n=Ext.getCmp("tBarActionResetAll"),o=Ext.getCmp("tBarActionUndo"),r=Ext.getCmp("tBarActionRedo");if(a&&n&&!(a.isDisabled()&&n.isDisabled()&&o.isDisabled()&&r.isDisabled())&&(a.disable(),n.disable(),o.disable(),!0===App.Infra.OnReset)){if(null!=r)if(!r.isDisabled())r.disable(),Ext.ComponentQuery.query("#dpmprojectgantt")[0].undoManager.redoQueue=[];delete App.Infra.OnReset}}),p.on("beforeload",function(e,t,a){var n=Ext.ComponentQuery.query("#dpmprojectgantt")[0];n.rendered&&n.setLoading({msg:App.Infra.LoadText||n.L("loadingText")})}),p.on("beforesync",function(e,t){var a=Ext.ComponentQuery.query("#dpmprojectgantt")[0];a.undoManager.stop(),a.rendered&&a.setLoading({msg:"load"===t.type?a.L("loadingText"):a.L("savingText")})}),this.crudManager=p}})});