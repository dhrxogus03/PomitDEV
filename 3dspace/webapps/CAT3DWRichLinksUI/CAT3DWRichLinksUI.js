define("DS/CAT3DWRichLinksUI/CAT3DWLinkPlaceholderHtmlView",["UWA/Class","DS/CAT3DWInfraUI/CAT3DWCanvasServices"],function(t,e){"use strict";var n=t.extend({init:function(t){this._mainContainerClassName="link-placeholder-view",this._mainContainer=null,this._viewParams=t},getCanvasFromImage:function(t){var n=(new e).createCanvas({width:t.width,height:t.height,tag:"LinkPlaceholderHtmlViewCanvas"}),i=n.getContext("2d");return i.fillStyle="white",i.fillRect(0,0,t.width,t.height),i.drawImage(t,0,0,t.width,t.height),n}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWLinkPlaceholderHtmlView",n)}),define("DS/CAT3DWRichLinksUI/CAT3DWLinkFullHtmlView",["UWA/Class","DS/VENWebHtml2Canvas/Html2Canvas","css!DS/CAT3DWRichLinksUI/CAT3DWRichLinksUI","i18n!DS/CAT3DWRichLinksUI/assets/nls/CAT3DWLinkFullHtmlView"],function(t,e,n,i){"use strict";var s=t.extend({init:function(t){this._mainContainerClassName="link-full-view",this._mainContainer=null,this._viewParams=t,this._swymV3=t.swymv3},getHTML:function(){return new Promise(async function(t,e){this._mainContainer||await this._build(this._viewParams),t(this._mainContainer)}.bind(this))},getCanvas:function(){return new Promise(async function(t,n){var i=new e,s=await this.getHTML();document.body.append(s),i.htmlToCanvas(s,{onclone:function(t){var e=t.getElementsByClassName(this._mainContainerClassName);e&&(e[e.length-1].style.opacity="1")}.bind(this),allowTaint:!0,useCORS:!0,scale:2}).then(function(e){this.clean(),t(e)}.bind(this)).catch(function(){this.clean(),n()}.bind(this))}.bind(this))},clean:function(){this._mainContainer.remove(),this._mainContainer=null},_build:function(t){return new Promise(async function(e,n){t||console.warn("[CAT3DWLinkFullHtmlView : no params to build link view]"),this._mainContainer=new UWA.Element("div",{class:this._mainContainerClassName}),this._swymV3&&this._mainContainer.addClassName("swymv3");var s=new UWA.Element("div",{class:"linkfull-header-container"}).inject(this._mainContainer),a=new UWA.Element("div",{class:"linkfull-body-container"}).inject(this._mainContainer),o=new UWA.Element("div",{class:"linkfull-title-container"}).inject(s),r=new UWA.Element("div",{class:"linkfull-subtitle-container"}).inject(a),c=new UWA.Element("div",{class:"linkfull-message-container"}).inject(a),l=this._getFonticon(t.type),h=(new UWA.Element("div",{class:"preview-icon",html:{tag:"span",class:"fonticon "+l.name},styles:{color:l.color,"background-color":l.bkcolor}}).inject(o),new UWA.Element("div",{class:"preview-title",text:t.title}).inject(o),[{tag:"span",text:i.get("authorPrep")+" "},{tag:"a",class:"author",text:t.author}]);t.community&&(h.push({tag:"span",text:" "+i.get("communityPrep")+" "}),h.push({tag:"a",class:"community",text:t.community}));new UWA.Element("div",{class:"preview-author-community",html:h}).inject(r);var u=new UWA.Element("div",{class:"preview-message"}).inject(c);u.innerHTML=t.message;var m=u.getElementsByTagName("img");if(!m.length)return void e();if(t.images)for(let e=0;e<m.length;e++)m[e].dataset.mediaId&&(m[e].src=t.images[m[e].dataset.mediaId].url);let d=setInterval(()=>{let t=!0;for(let e=0;e<m.length;e++)if(!m[e].complete){t=!1;break}t&&(clearInterval(d),d=void 0,e())},10)}.bind(this))},_getFonticon:function(t){switch(t){case"posts":case"post":return{name:"fonticon-newspaper",color:this._swymV3?"#3d3d3d":"white",bkcolor:this._swymV3?"white":"#adadad"};case"idea":return{name:"fonticon-lightbulb",color:this._swymV3?"#00b8de":"white",bkcolor:this._swymV3?"white":"#00b8de"};case"iquestion":return{name:this._swymV3?"fonticon-comment-question ":"fonticon-i-question",color:this._swymV3?"#e7b401":"white",bkcolor:this._swymV3?"white":"#ea4f37"};case"wiki":return{name:"fonticon-book-open",color:this._swymV3?"#00aa86":"white",bkcolor:this._swymV3?"white":"#00aa86"};default:return{name:"fonticon-globe",color:this._swymV3?"#3d3d3d":"#77797c",bkcolor:"white"}}}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWLinkFullHtmlView",s)}),define("DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils",["UWA/Class","DS/CAT3DWInfra/CAT3DWPlateformServices","DS/CAT3DWInfra/CAT3DWUrlServices","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices"],function(t,e,n,i){"use strict";var s=t.extend({init:function(t){this._platformId=t.platformId,this._platformUrl=t.platformUrl;var e=t.appName;this._uwarequestor=UWA.Data,!e&&UWA.Data.proxies.ajax.contains("netvibes")&&window.parent&&window.parent.UWA&&window.parent.UWA.Data&&window.parent.UWA.Data.proxies&&(this._uwarequestor=window.parent.UWA.Data),this._debugMode=t.debugMode,this._urlService=new n,this._swymMediaServices=new i({platformId:this._platformId})},isHTTPLinkFormat:function(t){var e=t.trim();return!(!e.startsWith("http://")&&!e.startsWith("https://"))&&this.isLinkFormat(e)},isLinkFormat:function(t){return!(!this._urlService.isValidHttpUrl(t)||t.contains(" "))},processLink:function(t){return new Promise(function(e,n){this._debugMode&&console.time("[CAT3DWLinkProcessingUtils] Process link : "+t);var i=this.formatLink(t),a=function(n){this._debugMode&&console.timeEnd("[CAT3DWLinkProcessingUtils] Process link : "+t),e(n)}.bind(this);this.getLinkType(i).then(this.getContentType.bind(this)).then(function(t){t.type===s.LINK_INTERNAL?this.getPlatformContent(t).then(function(t){a(t)}).catch(function(t){t.type=s.LINK_EXTERNAL,this.getWebContent(t).then(function(t){a(t)}).catch(function(t){a(t)})}.bind(this)):t.type===s.LINK_EXTERNAL&&this.getWebContent(t).then(function(t){a(t)}).catch(function(t){a(t)})}.bind(this))}.bind(this))},formatLink:function(t){var e=t.trim();return e.startsWith("//")&&(e="https:"+e),e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e),e},getLinkType:function(t){return new Promise(function(e,n){this._getPlatformUrl().then(function(n){var i=!1,a=t.startsWith(n);if(!a){var o=null!==t.match("#app:X3DMCTY_AP")&&2===t.match(/content:url=(.*?(?=&))/i).length&&t.match(/content:url=(.*?(?=&))/i)[1].replace(/%3A/g,":").replace(/%2F/g,"/").replace(/%2e/g,".");i=n&&n===o}e(i||a?{url:t,type:s.LINK_INTERNAL}:{url:t,type:s.LINK_EXTERNAL})}.bind(this)).catch(function(n){e({url:t,type:s.LINK_EXTERNAL})}.bind(this))}.bind(this))},getContentType:function(t){return new Promise(function(e,n){if(t.type===s.LINK_EXTERNAL)t.content_type=s.CONTENT_UNKNOWN,e(t);else if(t.type===s.LINK_INTERNAL){var i,a,o=t.url;o.contains("#app")?(a=o.match(/contentType=([^&]*)/i)[1],i=o.match(/contentId=([^&]*)/i)[1]):o.contains("post")?(a=s.CONTENT_POST,i=o.match(/post:([^/]{0,})/i)[1]):o.contains("iquestion")?(a=s.CONTENT_QUESTION,i=o.match(/iquestion:([^/]{0,})/i)[1]):o.contains("question")?(a=s.CONTENT_QUESTION,i=o.match(/question:([^/]{0,})/i)[1]):o.contains("ideation")?(a=s.CONTENT_IDEA,i=o.match(/ideation:([^/]{0,})/i)[1]):o.contains("idea")?(a=s.CONTENT_IDEA,i=o.match(/idea:([^/]{0,})/i)[1]):o.contains("wikitree")?(a=s.CONTENT_WIKI,i=o.match(/wikitree:([^/]{0,})/i)[1]):o.contains("wiki")?(a=s.CONTENT_WIKI,i=o.match(/wiki:([^/]{0,})/i)[1]):o.contains("media")?(a=s.CONTENT_MEDIA,i=o.match(/media:([^/]{0,})/i)[1]):o.contains("survey")?(a=s.CONTENT_SURVEY,i=o.match(/survey:([^/]{0,})/i)[1]):o.contains("wedo")?(a=s.CONTENT_WEDO,i=o.match(/wedo:([^/]{0,})/i)[1]):(a=s.CONTENT_UNKNOWN,i=null),t.content_type=a,t.content_id=i,e(t)}})},getPlatformContent:function(t){return new Promise(function(n,i){if(t.content_type===s.CONTENT_UNKNOWN)return delete t.content_id,void i(t);this._getPlatformUrl().then(e.getCsrfToken.bind(this)).then(function(a){e.search({url:a.url,token:a.token,legacyFormat:!1,query:"#all",contentType:t.content_type,refineUsingQuery:'id:"'+t.content_id+'"',nresults:1,start:0}).then(async function(o){if(0!==o.nhits){var r=o.hits[0].metas;t.content={};for(var c=0;c<r.length;c++){if("id"===r[c].name&&t.content_id!==r[c].value)return t.content_type=s.CONTENT_UNKNOWN,delete t.content_id,void i(t);"title"===r[c].name&&(t.content.title=r[c].value),"name"===r[c].name&&(t.content.author=r[c].value),"ds6w_58_community"===r[c].name&&(t.content.community=r[c].value),"ds6w_58_description"===r[c].name&&(t.content.description=r[c].value),"preview_media_type"===r[c].name&&t.content_type===s.CONTENT_MEDIA&&(t.content.mediaType=r[c].value),"preview_media_id"===r[c].name&&r[c].value&&(t.content.thumbnail_id=r[c].value)}var l=function(){return new Promise(function(e,n){t.content.thumbnail_id?this._swymMediaServices.getMedia({mediaId:t.content.thumbnail_id}).then(function(n){t.content.thumbnail_url=n.previewurl,t.content.thumbnail_published=parseInt(n.published),e()}).catch(function(){e()}.bind(this)):e()}.bind(this))}.bind(this),h=function(){return new Promise(function(n,i){var o={},r="";if(t.content_type===s.CONTENT_POST)r="/api/post/get",o.community_post_id=t.content_id;else if(t.content_type===s.CONTENT_QUESTION)r="/api/question/get",o.iQuestions_id=t.content_id;else if(t.content_type===s.CONTENT_IDEA)r="/api/idea/get",o.id=t.content_id;else{if(t.content_type!==s.CONTENT_WIKI)return void n();r="/api/wiki/get",o.id=t.content_id}e.callPlatformWebService({url:a.url,params:o,api:r,token:a.token,returnPromise:!1,onSuccessCB:function(e){if(t.content_type===s.CONTENT_QUESTION?t.content.message=e.result.question:t.content.message=e.result.message,!e.result.thumbnails_infos.length)return void n();let i=[],a=e.result.thumbnails_infos;for(let t=0;t<a.length;t++)!0===a[t].user_access&&"processed"===a[t].preview_media_processing_status&&i.push({mediaId:a[t].media_id});this._swymMediaServices.getMedias(i,function(){}).then(async function(e){t.content.images_infos={};for(let n=0;n<e.length;n++){var i=e[n].mediaId.split("media:")[1];t.content.images_infos[i]={url:e[n].previewurl,published:parseInt(e[n].published)}}n()}.bind(this)).catch(function(){n()}.bind(this))}.bind(this),onFailCB:function(){n()}})}.bind(this))}.bind(this);await l(),await h(),n(t)}else t.content_unauthorized=!0,t.content_type=s.CONTENT_UNKNOWN,delete t.content_id,i(t)}.bind(this)).catch(function(){t.content_type=s.CONTENT_UNKNOWN,delete t.content_id,i(t)}.bind(this))}.bind(this)).catch(function(){t.content_type=s.CONTENT_UNKNOWN,delete t.content_id,i(t)}.bind(this))}.bind(this))},getWebContent:function(t){return new Promise(function(e,n){var i={};i.url=t.url,i.responseType="text",i.requestor=this.getUWARequestor(),i.proxy="ajax",this.requestExternalUrl(i).then(function(n){t.content={};var s=n.headers.get("content-type");if(s.match(/text\/html/g)||s.match(/application\/xhtml/g)){var a=(new DOMParser).parseFromString(n.data,"text/html"),o=a.getElementsByTagName("meta");a.getElementsByTagName("link");t.content.title=a.title,t.content.description=null;var r=null;if(o){o.description&&(t.content.description=o.description.content);for(let e=0;e<o.length;e++)!t.content.title&&o[e].getAttribute("property")&&"og:title"===o[e].getAttribute("property")&&(t.content.title=o[e].getAttribute("content")),!t.content.description&&o[e].getAttribute("property")&&"og:description"===o[e].getAttribute("property")&&(t.content.description=o[e].getAttribute("content")),o[e].getAttribute("property")&&"og:image"===o[e].getAttribute("property")&&(r=o[e].getAttribute("content"))}}var c=new URL(i.url);t.content.hostname=c.hostname,t.content.title||(t.content.title=c.hash),r?this._getImageBlobExternalUrl(r).then(function(n){t.content.thumbnail_blob_url=n,e(t)}.bind(this)).catch(function(){e(t)}.bind(this)):e(t)}.bind(this)).catch(function(){t.notreachable=!0,n(t)}.bind(this))}.bind(this))},requestExternalUrl:function(t){return new Promise(function(e,n){var i=t.requestor,s=t.proxy,a=t.responseType?t.responseType:"text",o=null;o=s?i.proxifyUrl(t.url,{proxy:s}):t.url,i.request(o,{proxy:s,timeout:1e4,type:a,onComplete:function(t,n){var i=new Headers(n);e({data:t,requestedUrl:o,headers:i})}.bind(this),onTimeout:function(t){t&&console.warn(t),n(new Error("[CAT3DWLinkProcessingUtils] requestExternalUrl() timeout"))}.bind(this),onFailure:function(t){n(new Error("[CAT3DWLinkProcessingUtils] requestExternalUrl() failed"))}.bind(this)})}.bind(this))},getUWARequestor:function(){return this._uwarequestor},_getImageBlobExternalUrl:function(t){return new Promise(function(e,n){this.getLinkType(t).then(function(t){var i={};i.url=t.url,i.responseType="blob",i.requestor=this.getUWARequestor(),i.proxy="ajax",this.requestExternalUrl(i).then(function(t){if(t.data&&t.data.type.includes("image/")){var i=URL.createObjectURL(t.data);e(i)}else n()}.bind(this)).catch(function(){n()})}.bind(this))}.bind(this))},_getPlatformUrl:function(){return this._platformUrl?new Promise(function(t){t(this._platformUrl)}.bind(this)):new Promise(function(t,n){e.get3DSwym(this._platformId).then(function(e){this._platformUrl=e,t(this._platformUrl)}.bind(this)).catch(function(t){n(t)}.bind(this))}.bind(this))}});return s.LINK_INTERNAL="internal",s.LINK_EXTERNAL="external",s.CONTENT_UNKNOWN="unknown",s.CONTENT_POST="posts",s.CONTENT_QUESTION="iquestion",s.CONTENT_IDEA="idea",s.CONTENT_WIKI="wiki",s.CONTENT_MEDIA="media",s.CONTENT_SURVEY="survey",s.CONTENT_WEDO="WeDo",s}),define("DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView",["UWA/Class","DS/VENWebHtml2Canvas/Html2Canvas","DS/WebappsUtils/WebappsUtils","css!DS/CAT3DWRichLinksUI/CAT3DWRichLinksUI","i18n!DS/CAT3DWRichLinksUI/assets/nls/CAT3DWRichLinkHtmlView"],function(t,e,n,i,s){"use strict";var a=t.extend({init:function(t){this._mainContainerClassName="rich-link-preview",this._mainContainer=null,this._viewParams=t,this._swymV3=t.swymv3,this._viewParams.thumbnail||"internal"!==this._viewParams.linktype||(this._viewParams.thumbnail=n.getWebappsAssetUrl("CAT3DWInfra","placeholders/xl_thumb_default_community.png"))},getHTML:function(){return this._mainContainer||this._build(this._viewParams),this._mainContainer},getCanvas:function(){return new Promise(function(t,n){var i=new e,s=this.getHTML();document.body.append(s),i.htmlToCanvas(s,{onclone:function(t){var e=t.getElementsByClassName(this._mainContainerClassName);e&&(e[e.length-1].style.opacity="1")}.bind(this),allowTaint:!0,useCORS:!0,scale:2}).then(function(e){this.clean(),t(e)}.bind(this)).catch(function(){this.clean(),n()}.bind(this))}.bind(this))},clean:function(){this._mainContainer.remove(),this._mainContainer=null},_build:function(t){t||console.warn("[CAT3DWRichLinkHTMLView : no params to build link view]"),this._mainContainer=new UWA.Element("div",{class:this._mainContainerClassName});var e=new UWA.Element("div",{class:"preview-image-container"}).inject(this._mainContainer),n=new UWA.Element("div",{class:"preview-data-container"}).inject(this._mainContainer);if(t.thumbnail)new UWA.Element("img",{class:"preview-thumbnail",src:t.thumbnail}).inject(e);if(t.favicon&&!t.type)new UWA.Element("img",{class:"preview-favicon",src:t.favicon}).inject(e);else{var i=this._getFonticon(t.type,t.mediaType);new UWA.Element("div",{class:"preview-icon",html:{tag:"span",class:"fonticon "+i.name},styles:{color:i.color,"background-color":i.bkcolor}}).inject(e)}if(t.title)new UWA.Element("span",{class:"preview-title",text:this._truncate(t.title,80)}).inject(n);if(t.url||t.author||t.community){var a=new UWA.Element("div",{class:"preview-domain"}).inject(n);if(t.author){let e=[{tag:"span",text:s.get("authorPrep")+" "},{tag:"a",text:t.author}];t.community&&(e.push({tag:"span",text:" "+s.get("communityPrep")+" "}),e.push({tag:"a",text:t.community}));new UWA.Element("div",{class:"preview-author-community",html:e}).inject(a)}else if(t.url||t.hash){var o=t.hash?t.hash:t.url;new UWA.Element("a",{text:o}).inject(a)}}if(t.description)new UWA.Element("span",{class:"preview-description",text:this._truncate(t.description,150)}).inject(n)},_truncate:function(t,e){return t.length>e?t.substr(0,e-1)+"...":t},_getFonticon:function(t,e){switch(t){case"posts":case"post":return{name:"fonticon-newspaper",color:this._swymV3?"#3d3d3d":"white",bkcolor:this._swymV3?"white":"#adadad"};case"idea":return{name:"fonticon-lightbulb",color:this._swymV3?"#00b8de":"white",bkcolor:this._swymV3?"white":"#00b8de"};case"iquestion":return{name:this._swymV3?"fonticon-comment-question ":"fonticon-i-question",color:this._swymV3?"#e7b401":"white",bkcolor:this._swymV3?"white":"#ea4f37"};case"survey":return{name:"fonticon-clipboard",color:this._swymV3?"#e87b00":"white",bkcolor:this._swymV3?"white":"#e87b00"};case"WeDo":return{name:"fonticon-task",color:this._swymV3?"#005686":"white",bkcolor:this._swymV3?"white":"#005686"};case"media":var n=e;return"sketch"===e&&(n="app-3dsketch"),"whiteboard"===e&&(n="app-whiteboard"),"document"===e&&(n="doc"),"animatedPicture"===e&&(n="picture-animated"),"3d_model"===e&&(n="cube"),"story"===e&&(n="app-3dstory"),{name:"fonticon-"+n,color:this._swymV3?"#70036b":"white",bkcolor:this._swymV3?"white":"#70036b"};case"wiki":return{name:"fonticon-book-open",color:this._swymV3?"#00aa86":"white",bkcolor:this._swymV3?"white":"#00aa86"};default:return{name:"fonticon-globe",color:this._swymV3?"#3d3d3d":"#77797c",bkcolor:"white"}}}});return UWA.namespace("DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView",a)});