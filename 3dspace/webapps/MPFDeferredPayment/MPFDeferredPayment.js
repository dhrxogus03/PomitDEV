define("DS/MPFDeferredPayment/DeferredPaymentNoticeHelper",["DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel"],function(e,t){"use strict";const r={isPhaseWaitingForPurchaseOrder:function(e,r){const s="buyer"===r,n=!!e.getPurchaseOrderId(),a=e.getState()===t.States.PENDING_PAYMENT;return s&&!n&&a},isPhaseWaitingForInvoice:function(t,r,s){const n="seller"===s,a=!!r.getBuyerInvoiceNumber(),i=t.getState(),o=i===e.States.READY||i===e.SHIPPED||i===e.States.DELIVERED;return n&&!a&&o},isPhaseWaitingForProceedToPayement:function(e,r){const s="buyer"===r,n=!!e.getBuyerInvoiceNumber();return s&&n&&e.getState()!==t.States.PAYMENT_COMPLETE}};return r}),define("DS/MPFDeferredPayment/DeferredPaymentNotices",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFDeferredPayment/DeferredPaymentNoticeHelper","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadNoticeComponent","DS/MPFInvoiceModel/InvoiceDocumentFactory","DS/MPFInvoiceComponent/InvoiceUploadNoticeComponent","DS/MPFInvoiceComponent/ProceedToPaymentNoticeComponent","DS/MPFServices/ObjectService"],function(e,t,r,s,n,a,i,o,c,h,P,u,d,m,p,l,y,D){"use strict";const O=Object.freeze({HIDDEN:"hidden",UPLOAD_PURCHASE_ORDER:"uploadPurchaseOrder",UPLOAD_INVOICE:"UPLOAD_INVOICE",PROCEED_TO_PAYMENT:"PROCEED_TO_PAYMENT"}),C=Object.freeze({PURCHASE_ORDER_UPLOADED:"purchaseOrderUploaded"}),E=r.extend({className:"mpf-deferred-payment-notices",setup:function(e={}){D.requiredOfPrototype(this.model,i,"options.model must be a CartModel"),this.cart=this.model,this.isPaymentPerPhase=e.isPaymentPerPhase,this.isPaymentPerPhase?(this.cartPhases=e.cartPhases,this.cartPhase=e.cartPhase,this.cartPayment=e.cartPayment):this.listenTo(this.cart,"onChange",this.update),D.requiredOfPrototype(e.purchaseOrderFactory,u,"options.purchaseOrderFactory must be a PurchaseOrderFactory"),D.requiredOfPrototype(e.purchaseOrderDocumentFactory,d,"options.purchaseOrderDocumentFactory must be a PurchaseOrderDocumentFactory"),D.requiredOfPrototype(e.invoiceDocumentFactory,p,"options.invoiceDocumentFactory must be a InvoiceDocumentFactory"),this.userRole=e.userRole,this.showExplanationLink=e.showExplanationLink,this.stateMachine=this._createStateMachine(),this.uploadPurchaseOrderComponent=null,this.uploadInvoiceComponent=null,this.proceedToPaymentComponent=null,this.purchaseOrderFactory=e.purchaseOrderFactory,this.purchaseOrderDocumentFactory=e.purchaseOrderDocumentFactory,this.invoiceDocumentFactory=e.invoiceDocumentFactory,this.update(),n.subscribe("MPFDeferredPaymentNotices",this._onMessage.bind(this))},render:function(){if(null===this.container)return;const e=this.stateMachine.getState();return e===O.HIDDEN&&this.container.setContent(),e===O.UPLOAD_PURCHASE_ORDER?this.container.setContent(this.uploadPurchaseOrderComponent.render()):e===O.UPLOAD_INVOICE?this.container.setContent(this.uploadInvoiceComponent.render()):e===O.PROCEED_TO_PAYMENT&&this.container.setContent(this.proceedToPaymentComponent.render()),this},destroy:function(){this.stopListening(),n.unsubscribe("MPFDeferredPaymentNotices"),this.uploadPurchaseOrderComponent&&this.uploadPurchaseOrderComponent.destroy(),this.uploadInvoiceComponent&&this.uploadInvoiceComponent.destroy(),this.uploadPurchaseOrderComponent=null,this.uploadInvoiceComponent=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this._parent(),this.container=null},update:function(){let e,r,s,n;return"DBT"===(this.isPaymentPerPhase?this.cartPayment&&this.cartPayment.getPaymentMethod():this.cart.getPaymentMethod())?(this.isPaymentPerPhase&&!this.cartPhase||(r=this._isWaitingForInvoice(),s=this._isWaitingForPurchaseOrder(),n=this._isWaitingForProceedToPayement()),r?e=this._toUploadInvoiceState():s?e=this._toUploadPurchaseOrderState():n?e=this._toProceedToPaymentState():this.stateMachine.changeState(O.HIDDEN)):this.stateMachine.changeState(O.HIDDEN),t.cast(e).then(this.render.bind(this))},_onMessage:function(e){return e&&"update"===e.event&&this.isPaymentPerPhase?(s.mask(this.container),this.cartPhases.fetchPromise().then(()=>{if(this.cartPhase=this.cartPhases.getActivePhase(),this.cartPhase)return this.cartPayment.setParentResourceId(this.cartPhase.id),this.cartPayment.fetchPromise()}).then(this.update.bind(this)).finally(()=>{s.unmask(this.container)})):Promise.resolve()},_onPurchaseOrderUploaded:function(){this._onMessage({event:"update"}).then(()=>{this.dispatchEvent(C.PURCHASE_ORDER_UPLOADED),n.publish("MPPurchaseOrderUploaded",{event:"refresh"})})},_isWaitingForInvoice:function(){let e;return e=this.isPaymentPerPhase?P.isPhaseWaitingForInvoice(this.cartPhase,this.cartPayment,this.userRole):o.isWaitingForInvoice(this.cart,this.userRole)},_isWaitingForPurchaseOrder:function(){let e;return e=this.isPaymentPerPhase?P.isPhaseWaitingForPurchaseOrder(this.cartPayment,this.userRole):o.isWaitingForPurchaseOrder(this.cart,this.userRole)},_isWaitingForProceedToPayement:function(){let e;return e=this.isPaymentPerPhase?P.isPhaseWaitingForProceedToPayement(this.cartPayment,this.userRole):o.isWaitingForProceedToPayement(this.cart,this.userRole)},_createStateMachine:function(){return new a({state:O.HIDDEN,states:[O.HIDDEN,O.UPLOAD_PURCHASE_ORDER,O.UPLOAD_INVOICE,O.PROCEED_TO_PAYMENT],transitions:[{from:O.HIDDEN,to:O.UPLOAD_PURCHASE_ORDER},{from:O.UPLOAD_PURCHASE_ORDER,to:O.HIDDEN},{from:O.HIDDEN,to:O.UPLOAD_INVOICE},{from:O.UPLOAD_INVOICE,to:O.HIDDEN},{from:O.HIDDEN,to:O.PROCEED_TO_PAYMENT},{from:O.PROCEED_TO_PAYMENT,to:O.HIDDEN}]})},_getPurchaseOrder:function(){let e;return this.isPaymentPerPhase?(this.purchaseOrder=this.purchaseOrderFactory.createModel(u.Types.PAYMENT_PURCHASE_ORDER,{}),this.purchaseOrder.setParentResourceId(this.cartPayment.id)):(this.purchaseOrder=this.purchaseOrderFactory.createModel(u.Types.CART_PURCHASE_ORDER,{}),(e=this.cart.getPurchaseOrderId())&&this.purchaseOrder.set("id",e),this.purchaseOrder.setParentResourceId(this.cart.id)),this.purchaseOrder.fetchPromise()},_createPurchaseOrderDocument:function(){return this.isPaymentPerPhase?(this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(d.Types.PAYMENT_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.setParentResourceId(this.cartPayment.id)):(this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(d.Types.CART_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.setParentResourceId(this.cart.id)),this.purchaseOrderDocument},_toUploadPurchaseOrderState:function(){return this._getPurchaseOrder().then(()=>{this.uploadPurchaseOrderComponent||(this.purchaseOrderDocument||this._createPurchaseOrderDocument(),this.uploadPurchaseOrderComponent=new m({model:this.purchaseOrder,purchaseOrderDocument:this.purchaseOrderDocument,cart:this.cart,cartPayment:this.cartPayment,showExplanationLink:this.showExplanationLink,isPaymentPerPhase:this.isPaymentPerPhase}),this.listenTo(this.uploadPurchaseOrderComponent,m.Events.PURCHASE_ORDER_UPLOADED,this._onPurchaseOrderUploaded.bind(this))),this.stateMachine.changeState(O.UPLOAD_PURCHASE_ORDER)})},_createInvoiceDocument:function(){this.isPaymentPerPhase?(this.invoiceDocument=this.invoiceDocumentFactory.createModel(p.Types.PAYMENT_INVOICE_DOCUMENT),this.invoiceDocument.parentResourceId=this.cartPayment.id):(this.invoiceDocument=this.invoiceDocumentFactory.createModel(p.Types.CART_INVOICE_DOCUMENT),this.invoiceDocument.parentResourceId=this.cart.id)},_toUploadInvoiceState:function(){return this._getPurchaseOrder().then(()=>{this.uploadInvoiceComponent||(this.invoiceDocument||this._createInvoiceDocument(),this.uploadInvoiceComponent=new l({model:this.cart,cartPayment:this.cartPayment,invoiceDocument:this.invoiceDocument,purchaseOrder:this.purchaseOrder,showExplanationLink:this.showExplanationLink,isPaymentPerPhase:this.isPaymentPerPhase})),this.stateMachine.changeState(O.UPLOAD_INVOICE),this.listenTo(this.uploadInvoiceComponent,l.Events.INVOICE_UPLOADED,this._onMessage.bind(this,{event:"update"}))})},_toProceedToPaymentState:function(){this.proceedToPaymentComponent||(this.proceedToPaymentComponent=new y({showExplanationLink:this.showExplanationLink})),this.stateMachine.changeState(O.PROCEED_TO_PAYMENT)}});return E.Events=C,E}),define("DS/MPFDeferredPayment/DeferredPaymentNoticesFactory",["UWA/Class","UWA/Promise","DS/MPFServices/ObjectService","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFCartModel/CartFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFCartModel/CartModel","DS/MPFDeferredPayment/DeferredPaymentNotices"],function(e,t,r,s,n,a,i,o,c,h){"use strict";const P=e.extend({init:function(e={}){this.options=e,r.requiredOfType(this.options.cartId,"string","options.cartId must a string"),r.requiredOfType(this.options.userRole,"string","options.userRole must a string"),this.cartId=this.options.cartId,this.userRole=this.options.userRole,this.showExplanationLink=this.options.showExplanationLink,this.isPaymentPerPhase=!0===this.options.isPaymentPerPhase,this.connector=this.options.connector,this.purchaseOrderFactory=null,this.purchaseOrderDocumentFactory=null,this.invoiceDocumentFactory=null,this.cartFactory=null,this.cartPhaseFactory=null,this.cartPaymentFactory=null,this.cart=null,this.cartPhase=null,this.cartPayment=null},_getConnector:function(){let e;return(e=this.connector?t.resolve(this.connector):s.fetchPromise(this.options)).then(e=>{this.connector=e})},_getFactories:function(){return n.getInstance(this.connector).getFactories([n.Types.PURCHASE_ORDER,n.Types.PURCHASE_ORDER_DOCUMENT,n.Types.INVOICE_DOCUMENT,n.Types.CART,n.Types.CART_PHASE,n.Types.CART_PAYMENT]).then(e=>{this.purchaseOrderFactory=e[0],this.purchaseOrderDocumentFactory=e[1],this.invoiceDocumentFactory=e[2],this.cartFactory=e[3],this.cartPhaseFactory=e[4],this.cartPaymentFactory=e[5]})},_getModels:function(){let e;return e=this.isPaymentPerPhase?t.all([this._getCart(),this._getCartPhases()]).then(this._getCartPayment.bind(this)):this._getCart()},_getCart:function(){return this.cart=this.cartFactory.createModel(a.Types.CART),this.cart.set("id",this.cartId),this.cart.fetchPromise({expand:[c.Expands.CART_ITEMS]}).then(e=>{this.cart=e})},_getCartPhases:function(){const e=this.cartPhaseFactory.createCollection(i.Types.CART_CART_PHASE);return e.setParentResourceId(this.cartId),e.fetchPromise().then(e=>{this.cartPhases=e})},_getCartPayment:function(){let e;this.cartPayment=this.cartPaymentFactory.createModel(o.Types.CART_PHASE_CART_PAYMENT);const r=this.cartPhases.getActivePhase();return r?(this.cartPayment.setParentResourceId(r.id),e=this.cartPayment.fetchPromise()):e=t.resolve(),e},_getConfig:function(){const e={purchaseOrderFactory:this.purchaseOrderFactory,purchaseOrderDocumentFactory:this.purchaseOrderDocumentFactory,invoiceDocumentFactory:this.invoiceDocumentFactory,userRole:this.userRole,showExplanationLink:this.showExplanationLink,isPaymentPerPhase:this.isPaymentPerPhase};return this.isPaymentPerPhase&&(e.cartPhases=this.cartPhases,e.cartPhase=this.cartPhases.getActivePhase(),e.cartPayment=this.cartPayment),e.model=this.cart,e},getOptions:function(){return this._getConnector().then(this._getFactories.bind(this)).then(this._getModels.bind(this)).then(this._getConfig.bind(this))},build:function(){return this.getOptions().then(function(e){return new h(e)})}});return P.fromCart=function(e){return new P(e).build()},P.fromCartOptions=function(e){return new P(e).getOptions()},P});