define("DS/ExperienceKernel/ExperienceKernel",["DS/ExperienceKernel/EKBinaryHelpers"],function(t){"use strict";return"undefined"!=typeof EK?EK:function(){const e={};e.window="undefined"!=typeof window?window:void 0,e.defaultsOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:void 0,webSocketPort:2097,pool:"browser",ssl:!1,canDisconnectFromHypervisor:!0,onText:function(){return!0},onBinary:function(){return!0},onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onDisconnect:function(){},onError:function(t){e.window.console.error(t)},authentication:function(t,i,n){e.defaultAuthentication(t,i,n)}}),e.defaultsMultiplexerOptions=Object.freeze({onText:function(){return!0},onBinary:function(){return!0},join:function(){return!0}}),e.defaultsStoreOptions=Object.freeze({hypervisorIp:"127.0.0.1",hypervisorUrl:void 0,webSocketPort:2097,ssl:!1,canDisconnectFromHypervisor:!0,distant:!1,onHypervisorConnect:function(){},onHypervisorDisconnect:function(){},onError:function(t){e.window.console.error(t)},authentication:function(t,i,n){e.defaultAuthentication(t,i,n)}}),e.Status=Object.freeze({pending:0,connected:1,disconnected:2}),e.WebSocket=function(t){this.ws=null,this.monitor=null,this.callback=function(){return!0},this.onopen=[],this.onclose=[],this.inputs=[],this.outputs=[],this.waitingOutputs=[],this.connected=!1,this.waitRelease=!0===t};var i=Object.freeze({version:1}),n=Object.freeze({hypervisor:-2}),s=Object.freeze({noConstraint:0,onlyMyHypervisor:1,notMyHypervisor:2,preferMyHypervisor:3,identifier:5}),o=Object.freeze({none:0,channelRename:2,resultsSend:3,resultsAnswer:4,resultsAnswerEnd:5,resultsInterrupt:7,onDisconnect:8,subscribe:9,unsubscribe:10}),r=Object.freeze({GetFromWeb:9,SnapshotFromWeb:11,PutFromWeb:15,CommitFromWeb:17,LastSnapshotFromWeb:28,CreateObserverFromWeb:33,ReadKeysFromWeb:34,CreateKeysFromWeb:35,GetLocalMasterIdentifierFromWeb:38,DeleteObserverFromWeb:39,NotifyObserverFromWeb:40,StoreNodeDisconnectFromWeb:41});function a(t){for(var e=Object(t),i=1;i<arguments.length;++i){var n=arguments[i];if(void 0!==n)for(var s in n)n.hasOwnProperty(s)&&(e[s]=n[s])}return e}function h(t){if(t.hasOwnProperty("onHypervisorConnect")||t.hasOwnProperty("onHypervisorDisconnect")){if(!0===t.canDisconnectFromHypervisor)throw new Error("Invalid options combination. Do not set canDisconnectFromHypervisor to true with onHypervisorConnect and/or onHypervisorDisconnect");void 0===t.canDisconnectFromHypervisor&&e.window.console.warn("Disabling canDisconnectFromHypervisor because of onHypervisorConnect/onHypervisorDisconnect callbacks"),t.canDisconnectFromHypervisor=!1}}var u,c,p={index:0,uniqueId:0,getTimestamp:function(t){var e=new Date,i=Math.floor(e.getTime()/1e3),n=Math.floor(1e3*e.getMilliseconds());return function(t){return t!==o.channelRename&&t!==o.resultsAnswerEnd&&t!==o.resultsInterrupt}(t)?{sec:i,usec:n,index:this.index++}:{sec:i,usec:n}},getUniqueId:function(){return++this.uniqueId}};function l(t,e,i,n,s,o,r,a,h){var u=e;u.type=o,u.headerType=r,u.isBinary=s,u.uniqueId=i,u.hypervisorId=a.hypervisorId,u.id=a.id,u.eventId=h,u.pool=a.pool,t.sendText(JSON.stringify(u)),t.sendBinary(n)}function d(t,e,i,n,s){var o=p.getTimestamp(i);o.type=i,o.uniqueId=e,o.hypervisorId=n.hypervisorId,o.id=n.id,o.hresult=s,t.sendText(JSON.stringify(o))}function f(t,e){return t===o.none||t===o.channelRename||t===o.onDisconnect||t===o.subscribe||t===o.unsubscribe?e?8:1:t===o.resultsSend||t===o.resultsAnswer||t===o.resultsAnswerEnd||t===o.resultsInterrupt?e?8:4:-1}function y(t,e,i){var n=void 0!==i,s=f(t,n),o=new Uint8Array(s),r=new DataView(o.buffer);return s>=4&&void 0!==e&&r.setInt32(0,16777215&e),o[0]=t,n&&(o[0]|=64,r.setInt32(4,i)),o}function w(t,i,n){if(!t.ws||2!==t.ws.readyState&&3!==t.ws.readyState||(t.ws=null),!t.ws)return!1;"string"!=typeof n&&(i[0]|=128);var s=[i];return void 0!==n&&s.push(n),t.ws.send(new e.window.Blob(s)),!0}function v(t,e,i,n,s,r){i=i||o.none;var a=function(){var o=y(i,n,s);return w(t,o,e)};if(t.waitRelease&&!r)t.waitingOutputs.unshift(a);else{if(t.connected)return a();t.outputs.unshift(a)}return!0}function m(t,e,i){return function(){return t(e+" occurred during request to 3DPassport\n"+i)}}function g(t,i,n,s,o){if(i&&t&&t.waitingCredentials){var r=function(t){throw new Error(t)},a=n,h=r;if(s&&t.timeoutInSeconds){h=function(t){clearTimeout(u),r(t)},a=function(t,e){clearTimeout(u),n(t,e)};var u=e.window.setTimeout(function(){var t="Provided authentication callback for a web node from pool "+s.pool+" didn't called onSuccess or onError in time";b(s.wsHypervisor,{_:"clientRejected",hypervisorId:o.hypervisorId,id:o.id}),s.onError(t)},1e3*t.timeoutInSeconds)}return i({forWho:t.from,passportURL:t.passportURL},a,h),!0}return!1}function b(t,e){return t&&t.sendMessage(JSON.stringify(e))}function M(t,e){return v(t,JSON.stringify(e),void 0,void 0,void 0,!0)}function S(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])}e.WebSocket.prototype.flushMessages=function(){for(;this.outputs.length;){this.outputs.pop()()}},e.WebSocket.prototype.connect=function(t,i){var n;this.connected=!1,this.name=i;try{n=new e.window.WebSocket(t)}catch(i){n={close:function(){},readyState:0,url:t},e.window.setTimeout(function(){this.ws.readyState=3,this.ws.onclose()}.bind(this),1)}this.ws=n,this.ws.binaryType="arraybuffer",this.ws.onopen=function(){this.connected=!0,this.flushMessages(),this.onopen.forEach(function(t){t()}),null===this.ws&&n.close()}.bind(this),this.ws.onclose=function(){var t=this.connected;t&&this.flushMessages(),this.ws=null,this.onclose.forEach(function(e){e(t)})}.bind(this),this.ws.onmessage=function(t){0!==t.data.byteLength&&(this.inputs.push(t.data),1===this.inputs.length&&a())}.bind(this);var s=function(t,e,i,n){var s=e===o.resultsSend;this.monitor&&0!==n&&d(this.monitor,n,2,this.name);var r=this.callback(t,i,s);s&&v(this,void 0,o.resultsAnswerEnd,i),this.monitor&&0!==n&&d(this.monitor,n,3,this.name,Number(r)),this.inputs.shift(),a()}.bind(this),r=function(t,e){this.monitor&&0!==e&&d(this.monitor,e,2,this.name),this.callbackResultsEnd(t),this.monitor&&0!==e&&d(this.monitor,e,3,this.name,0),this.inputs.shift(),a()}.bind(this),a=function(){var t=this.inputs[0];if(t){var i=new Uint8Array(t),n=63&i[0],a=64==(64&i[0]),h=f(n,a),u=-1,c=new DataView(t);n!==o.resultsSend&&n!==o.resultsAnswer&&n!==o.resultsAnswerEnd||(u=16777215&c.getInt32(0));var d=a?c.getInt32(4):0,y=t.slice(h),w=128==(128&i[0]);if(this.monitor){a||(d=-p.getUniqueId());var v=p.getTimestamp(n);l(this.monitor,v,d,y,w,1,n,this.name)}if(n===o.resultsAnswerEnd)r(u,d);else if(w)s(y,n,u,d);else{var m=new e.window.FileReader;m.onload=function(t){s(t.target.result,n,u,d)},m.readAsText(new e.window.Blob([y]))}}}.bind(this)},e.WebSocket.prototype.close=function(){this.monitor=null,this.ws&&0!==this.ws.readyState&&this.ws.close(),this.ws=null},e.WebSocket.prototype.release=function(){for(this.waitRelease=!1;this.waitingOutputs.length;)this.outputs.unshift(this.waitingOutputs.pop());this.connected&&this.flushMessages()},e.WebSocket.prototype.sendMessage=function(t,e,i,n){return v(this,t,e,i,n)},e.defaultServiceURL="EXECFWK",e.defaultAuthentication=function(t,i,n){var s=t.passportURL+"/login?service="+e.defaultServiceURL+"&xrequestedwith=xmlhttprequest",o=new XMLHttpRequest;o.open("GET",s,!0),o.setRequestHeader("Accept","application/json"),o.withCredentials=!0,o.onloadend=function(s){if(s.currentTarget&&s.currentTarget.responseText)try{var o=JSON.parse(s.currentTarget.responseText).access_token;if(o)return i(e.defaultServiceURL,o)}catch(t){}return n("Invalid response from 3DPassport (click on this URL to check it)\n"+t.passportURL+"\nThe response:\n"+s)},o.ontimeout=m(n,"A timeout",t.passportURL),o.onabort=m(n,"An abort",t.passportURL),o.onerror=m(n,"An error",t.passportURL),o.send(null)},e.WebSocket.prototype.channelRename=function(t,e,i,n){var s=function(){var s=y(o.channelRename);t._="setPool",g(i,e,function(t,e){this.key.subMessage={_:"proxyValidate",serviceURL:t,serviceTicket:e},w(this.ws,this.header,JSON.stringify(this.key)),this.ws.release()}.bind({ws:this,header:s,key:t}),n,this.name)||(w(this,s,JSON.stringify(t)),this.release())}.bind(this);this.outputs.push(s)},e.WebSocket.prototype.onMessage=function(t){this.callback=t},e.WebSocket.prototype.onMessageResultsEnd=function(t){this.callbackResultsEnd=t},e.WebSocket.prototype.onOpen=function(t){this.ws&&1===this.ws.readyState?t():this.onopen.push(t)},e.WebSocket.prototype.onClose=function(t){this.ws&&3===this.ws.readyState?t(this.connected):this.onclose.push(t)};var k=function(t,e){this.index=0,this.nodes=[],this.timeout=0,this.url=t,this.checkSentMessages=e};k.prototype.init=function(t){this.buffer=t.response,200===t.status&&(this.dataView=new DataView(this.buffer),this.version=this.dataView.getUint8(0),this.offset=1)},k.prototype.reset=function(){e.window.clearTimeout(this.timeout),this.timeout=0},k.prototype.addNode=function(t){return void 0===this.buffer?u("Missing EK.replayIsReady call"):void 0===this.version?u("Record file not found: "+this.url):this.version!==i.version?u("Version mismatch: please update your record file"):(t.replayer=new I(this.index),this.index++,this.nodes.push(t),void this.processMessages())},k.prototype.getMessage=function(){var t,e=this.dataView.getInt8(this.offset),i=this.dataView.getInt8(this.offset+1),n=this.dataView.getInt8(this.offset+2),s=this.dataView.getInt32(this.offset+3,!0);if(this.offset+=7,i)t=this.buffer.slice(this.offset,this.offset+s);else{t="";for(var o=0;o<s;++o)t+=String.fromCharCode(this.dataView.getUint8(this.offset+o));try{t=decodeURIComponent(window.escape(t))}catch(t){}}return this.offset+=s,{index:e,isSent:n,message:t}},k.prototype.processMessages=function(){0===this.timeout&&(this.offset>=this.dataView.byteLength?c=void 0:this.dataView.getInt8(this.offset+2)||(this.timeout=e.window.setTimeout(function(){for(;this.offset<this.dataView.byteLength&&!this.dataView.getInt8(this.offset+2);){var t=this.getMessage();this.nodes[t.index].replayer.callback(t.message,-1)}this.timeout=0,this.processMessages()}.bind(this),1)))},e.setReplayUrl=function(t,e){if(void 0===(e=e||{}).checkSentMessages&&(e.checkSentMessages=!0),void 0===e.onerror&&(e.onerror=function(t){jasmine.addMatchers({toFail:function(){return{compare:function(t){return{pass:!1,message:t}}}}}),expect(t).toFail()}),u=function(t){c instanceof k&&c.reset(),c=void 0,e.onerror(t)},"boolean"==typeof c)return u("EK.Node created before calling EK.setReplayUrl");var i=new k(t+=".ekr",e.checkSentMessages),n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&i.init(n)},n.open("GET",t,!0),n.responseType="arraybuffer",n.send(null),c=i},e.replayIsReady=function(){return c instanceof k?void 0!==c.buffer:u("Missing EK.setReplayUrl call")},e.replayHasFinished=function(){return void 0===c};var I=function(t){this.index=t};function U(t){return t instanceof Uint8Array?t:t.buffer instanceof ArrayBuffer?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t)}function O(t){if("string"==typeof t)return t;for(var e=U(t),i="",n=0;n<e.length;++n){var s=e[n].toString(16);1===s.length&&(s="0"+s),i+=s+" "}return i}I.prototype.sendMessage=function(t){if(void 0===c)return u("Unexpected send "+O(t));var i=c.getMessage();if(i.index!==this.index)return u("Send "+O(t)+" with the wrong node");if(!i.isSent)return u("Send "+O(t)+" but expect to receive "+O(i.message));if(!function(t,e){if("string"==typeof t||"string"==typeof e)return t===e;var i=U(t),n=U(e);if(i.length!==n.length)return!1;for(var s=0;s!==i.length;++s)if(i[s]!==n[s])return!1;return!0}(i.message,t)){var n="Send "+O(t)+" but expect to send "+O(i.message);if(c.checkSentMessages)return u(n);e.window.console.warn("Ignoring because checkSentMessages is false: "+n)}return c.processMessages(),!0},I.prototype.onMessage=function(t){this.callback=t},I.prototype.onMessageResultsEnd=function(t){this.callbackResultsEnd=t},I.prototype.onOpen=function(){},I.prototype.onClose=function(){};var H=function(t,e){this.pool=e,this.clients={},this.uniqueId=0,this.index=-1,this.handlers=[],this.authentication=t.authentication,this.onError=t.onError,this.onPoolSelectable=[],c instanceof k?c.addNode(this):(c=!1,this.selectTimeouts={},this.pools={},this.inputs={},this.onHypervisorConnect=t.onHypervisorConnect,this.onHypervisorDisconnect=t.onHypervisorDisconnect,this.onDisconnect=t.onDisconnect,this.onText=t.onText,this.onBinary=t.onBinary,this.canDisconnect=t.canDisconnectFromHypervisor,this.wsHypervisor=null,void 0===t.hypervisorUrl&&(t.hypervisorUrl=t.hypervisorIp+":"+t.webSocketPort),"string"==typeof t.hypervisorUrl&&(t.hypervisorUrl=[t.hypervisorUrl]),this.hypervisorUrl=t.hypervisorUrl.map(function(e){return function(t,e){return/^\s*wss?:/.test(t)?t:(e?"wss://":"ws://")+t}(e,t.ssl)}),this.canDisconnect||this.connectToHypervisor())};function C(t,e){for(var i=0;i<t.length;++i){var n=t[i];if(n&&n.multiplexer===e)return}e.canJoin=!0,e.join()}H.prototype.connectToHypervisor=function(){var t=0;this.index++;var i=function(t){var e=this.hypervisorUrl[t],i={hypervisorId:0,id:n.hypervisor};this.wsHypervisor.connect(e,i)}.bind(this),s=function(){this.onHypervisorConnect()}.bind(this),o=function(e){e?this.onHypervisorDisconnect(e):t<this.hypervisorUrl.length?i(t++):(this.onError("Can't connect to the Hypervisor on "+this.hypervisorUrl),this.onHypervisorDisconnect(e))}.bind(this);this.wsHypervisor=new e.WebSocket(!0),this.wsHypervisor.onOpen(s),this.wsHypervisor.onClose(o),this.wsHypervisor.onMessage(this.privateOnText.bind(this)),i(t++),M(this.wsHypervisor,{_:"createNode",pool:this.pool,web:!0})},H.prototype.uniqueKey=function(t){return this.index+"_"+t.hypervisorId+"_"+t.id},H.prototype.setNodeId=function(t){var i;if(void 0!==t.status?((i=new e.WebSocket).name={},i.ws={readyState:3}):i=this.clients[this.uniqueKey(t)],void 0===i){var n=t.pool;this.inputs[n]=this.inputs[n]||[],this.inputs[n].push(t)}else{var s=t.uniqueId,o=this.pools[s];delete this.pools[s],void 0!==o&&o.setId(i,t.pool,this.onDisconnect);var r=this.selectTimeouts[s];delete this.selectTimeouts[s],clearTimeout(r)}},H.prototype.connect=function(t){var i={hypervisorId:t.hypervisorId,id:t.id},n=t.url,s=new e.WebSocket(!0);t.name.pool=this.pool,this.canDisconnect&&(t.name.canDisconnect=!0),s.channelRename(t.name,this.authentication,t.credentials,this),s.connect(n,i),this.clients[this.uniqueKey(t)]=s;var o=this.inputs[t.pool];if(void 0!==o)for(this.inputs[t.pool]=[];o.length;)this.setNodeId(o.shift());else{var r=new W(this);r.ws=s;var a=new R(r);s.onMessage(this.onMessage(a)),s.onMessageResultsEnd(this.onMessageResultsEnd(a))}s.pool=t.pool,this.monitor&&"ek.local.monitor"!==t.pool&&(s.monitor=this.monitor)},H.prototype.deleteHandler=function(t){for(var e=0;e<this.handlers.length;++e){var i=this.handlers[e];i&&i.nodeId.impl.ws===t&&(delete this.handlers[e],C(this.handlers,i.multiplexer))}var n=this.uniqueKey(t.name);delete this.clients[n]},H.prototype.closeIfNeeded=function(){if(this.canDisconnect&&null!==this.wsHypervisor&&!(this.onPoolSelectable.length>0)){for(var t in this.pools)if(this.pools.hasOwnProperty(t))return;for(var e in this.clients)if(void 0===this.clients[e].canClose)return;this.wsHypervisor.close(),this.wsHypervisor=null}},H.prototype.privateOnText=function(t){try{t=JSON.parse(t)}catch(t){return!1}var i=t._;if("setId"===i)t.monitor&&(this.monitor=this.askConnect("ek.local.monitor",e.Criterion.onlyMyHypervisor()),this.monitor.onMessage(this.privateOnText.bind(this))),this.uuid=t.uuid,!g(t.credentials,this.authentication,function(t,e){M(this.wsHypervisor,{_:"proxyValidate",serviceURL:t,serviceTicket:e}),this.wsHypervisor&&this.wsHypervisor.release()}.bind(this))&&this.wsHypervisor&&this.wsHypervisor.release();else if("connect!"===i)void 0===this.clients[this.uniqueKey(t)]&&4!==t.type&&this.connect(t);else if("id!"===i)this.setNodeId(t),void 0!==t.status&&this.closeIfNeeded();else if("isPoolSelectable!"===i){var n=this.onPoolSelectable.shift();void 0!==n&&n(t.pool,!!t.answer),this.closeIfNeeded()}else if("clientRemoved"===i){var s=this.uniqueKey(t),o=this.clients[s];void 0!==o&&(delete this.clients[s],"ek.local.monitor"===o.pool&&(S(this.clients,function(t,e){e.monitor=null}),this.monitor=void 0),o.close())}else if("monitorMessages"===i)"ek."!==this.pool.substr(0,3)&&(this.monitor||(this.monitor=this.askConnect("ek.local.monitor",e.Criterion.onlyMyHypervisor()),this.monitor.onMessage(this.privateOnText.bind(this))),S(this.clients,function(t,e){e.monitor=this.monitor}.bind(this)));else if("webAdded"===i){var r=this.clients[this.uniqueKey(t)];void 0!==r&&(r.canClose=!0),this.closeIfNeeded()}else{if("stop"!==i){var a="A web node from pool "+this.pool+" received an unknown message: "+JSON.stringify(t);return b(this.wsHypervisor,{_:"publishError",message:a}),this.onError(a),!1}this.stop()}return!0};var x=function(t,e){this.policy=t,this.name=e};x.prototype.withTimeout=function(t){return this.timeout=t>0?t:0,this},x.prototype.withoutQueuing=function(){return this.noQueuing=!0,this},x.prototype.withoutProcessCreation=function(){return this.noProcess=!0,this},x.prototype.withCmdLine=function(t){return this.cmdLine=t,this},e.Criterion={none:function(){return new x(s.noConstraint)},onlyMyHypervisor:function(){return new x(s.onlyMyHypervisor)},notMyHypervisor:function(){return new x(s.notMyHypervisor)},preferMyHypervisor:function(){return new x(s.preferMyHypervisor)},identifier:function(t){return new x(s.identifier,t)},timeout:function(t){return new x(s.noConstraint).withTimeout(t)},noQueuing:function(){return new x(s.noConstraint).withoutQueuing()},noProcessCreation:function(){return new x(s.noConstraint).withoutProcessCreation()}},H.prototype.sendMessageWithInterrupt=function(t,i,n,s){var o={onText:this.onText,onBinary:this.onBinary},r=new e.Multiplexer(s,o);r.impl.sendMessageWithInterrupt(t,i,n),r.close()},H.prototype.askConnect=function(t,i){var n=new W(this);if(c instanceof k)n.setId(this.replayer);else{i=i||{policy:s.noConstraint};var o=p.getUniqueId(),r={_:"id?",pool:t,uniqueId:o,policy:i.policy,name:i.name,cmdLine:i.cmdLine,timeout:void 0!==i.timeout?i.timeout:-1,noQueuing:i.noQueuing,noProcess:i.noProcess};this.pools[o]=n,null===this.wsHypervisor&&this.connectToHypervisor(),b(this.wsHypervisor,r),i.timeout>0&&(this.selectTimeouts[o]=e.window.setTimeout(function(){n.getStatus()!==e.Status.connected&&n.close()},1e3*i.timeout))}return n},H.prototype.unserializeNodeId=function(t,e,i,n,o){var r=new W(this),a=p.getUniqueId(),h={_:"unserializeId",uuid:e,pool:i,hypervisorId:n,id:o,uniqueId:a,policy:s.noConstraint};this.pools[a]=r,null===this.wsHypervisor&&this.connectToHypervisor(),b(this.wsHypervisor,h);var u=new T(t,i);return new B(u,void 0,r)},H.prototype.stop=function(){var t=this.onDisconnect;S(this.pools,function(i,n){var s=new e.WebSocket;s.name={},s.ws={readyState:3},n.setId(s,n.nodePool.pool,t)}),S(this.clients,function(t,e){e.close()}),this.wsHypervisor&&this.wsHypervisor.close(),this.wsHypervisor=null};var W=function(t){this.nodeImpl=t,this.outputs=[],this.onStatusChange=[],this.reduced=!1};W.prototype.setId=function(t,e,i){var n=null===this.ws;this.ws=t,n&&this.ws.onOpen(function(){this.close(this.reduced)}.bind(this));var s=t.ws&&t.ws.url;this.ws.onClose(function(t){s&&!t&&(b(this.nodeImpl.wsHypervisor,{_:"clientRejected",hypervisorId:this.ws.name.hypervisorId,id:this.ws.name.id}),this.nodeImpl.onError("Can't connect to the Node from pool '"+e+"' on "+s));this.ws&&this.nodeImpl.deleteHandler(this.ws)}.bind(this));var o=function(){if(this.ws){var t=new B;t.impl=this,this.onStatusChange.forEach(function(i){i(t,e)})}}.bind(this);if(this.ws.onOpen(o),this.ws.onClose(o),"function"==typeof i&&"ek."!==e.substr(0,3)){var r=function(){if(this.ws){var t=new B;t.impl=this,i(t,e)}}.bind(this);this.ws.onClose(r)}for(;this.outputs.length;){this.outputs.shift()()}},W.prototype.close=function(t){var e={_:"closeId",reduced:t};if(this.reduced=t,this.ws&&!0===this.ws.canClose)this.ws.sendMessage(JSON.stringify(e),o.channelRename);else{var i=this.nodeImpl.wsHypervisor;e.pool=this.nodePool.pool,e.uniqueId=function(t,e){for(var i in e)if(e.hasOwnProperty(i)&&e[i]===t)return Number(i);return-1}(this,this.nodeImpl.pools),this.ws?(e.hypervisorId=this.ws.name.hypervisorId,e.id=this.ws.name.id):this.ws=null,b(i,e)}},W.prototype.push=function(t){if(this.ws){if(!t()&&"boolean"==typeof c)throw new Error("ExperienceKernel was unable to send a message since the distant node is unreachable")}else this.outputs.push(t)},W.prototype.sendText=function(t){this.push(function(){return this.ws.sendMessage(t)}.bind(this))},W.prototype.sendBinary=function(t){this.push(function(){return"string"==typeof t&&(t=new String(t)),this.ws.sendMessage(t)}.bind(this))},W.prototype.sendMessage=function(t,e,i){var n=p.getTimestamp(e),s=this.nodeImpl,o=++s.uniqueId;this.push(function(){if(s.monitor){var r=void 0===this.ws?{}:this.ws.name;r.pool=this.nodePool.pool,l(s.monitor,n,o,t,"string"!=typeof t,0,e,r,i)}else o=void 0;return this.ws.sendMessage(t,e,i,o)}.bind(this))},W.prototype.onMessage=function(t){this.push(function(){return this.ws.onMessage(t),!0}.bind(this))},W.prototype.onMessageResultsEnd=function(t){this.push(function(){return this.ws.onMessageResultsEnd(t),!0}.bind(this))},W.prototype.getStatus=function(){if(void 0===this.ws)return e.Status.pending;if(null===this.ws||null===this.ws.ws)return e.Status.disconnected;var t=this.ws.ws;return 0===t.readyState?e.Status.pending:1===t.readyState?e.Status.connected:e.Status.disconnected},e.Node=function(t){for(var i in t=t||{})if(t.hasOwnProperty(i)&&!e.defaultsOptions.hasOwnProperty(i))throw new Error("Unknown EK.Node option named '"+i+"'. Valid options are: "+JSON.stringify(Object.keys(e.defaultsOptions)));if(t.hasOwnProperty("hypervisorUrl")&&(t.hasOwnProperty("hypervisorIp")||t.hasOwnProperty("webSocketPort")))throw new Error("Invalid options combination. Do not use hypervisorUrl with hypervisorIp and/or webSocketPort");h(t);var n=a({},e.defaultsOptions,t);this.onMessage=function(t){return function(e,i,s){if(t.id=i,t.resultsAnswer=s,s||-1===i)return("string"==typeof e?n.onText:n.onBinary)(e,t);if(void 0!==this.impl.handlers[i]){var o=this.impl.handlers[i].multiplexer.results;return("string"==typeof e?o.onText:o.onBinary)(e,t)}}.bind(this)},this.onMessageResultsEnd=function(){return function(t){var e=this.impl.handlers[t];e&&0==--e.cnt&&(delete this.impl.handlers[t],C(this.impl.handlers,e.multiplexer))}.bind(this)},this.impl=new H(n,n.pool),this.impl.onMessage=this.onMessage.bind(this),this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this)};var E=function(t,e){this.cnt=1,this.multiplexer=t,this.nodeId=e},R=function(t){this.impl=t,this.id=-1,this.resultsAnswer=!1};R.prototype.answerText=function(t){return this.answerMessage(t+"")},R.prototype.answerBinary=function(t){return this.answerMessage(t)},R.prototype.answerMessage=function(t){if(-1===this.id)this.impl.sendMessage(t);else if(this.resultsAnswer)this.impl.sendMessage(t,o.resultsAnswer,this.id);else{var e=this.impl.nodeImpl.handlers[this.id];e&&(++e.cnt,this.impl.sendMessage(t,o.resultsSend,this.id))}return this};var T=function(t,e){this.node=t,this.pool=e};T.prototype.select=function(t){return new B(this,t)};var B=function(t,e,i){if(void 0!==t){var n=t.node;this.impl=void 0!==i?i:n.impl.askConnect(t.pool,e),this.impl.nodePool=t;var s=new R(this.impl);this.impl.onMessage(n.onMessage(s)),this.impl.onMessageResultsEnd(n.onMessageResultsEnd(s))}};function D(t,e){if(t.impl.nodePool.node!==e)throw new Error("The NodeId doesn't belong to the right node")}B.prototype.equals=function(t){var e=this.impl.ws,i=t.impl.ws;return void 0!==e&&void 0!==i&&(e.name.id===i.name.id&&e.name.hypervisorId===i.name.hypervisorId)},B.prototype.close=function(){return this.impl.close(!1),this},B.prototype.closeWithReducedTimeout=function(){return this.impl.close(!0),this},B.prototype.getStatus=function(){return this.impl.getStatus()},B.prototype.isConnected=function(){return this.impl.getStatus()===e.Status.connected},B.prototype.onStatusChange=function(t){"function"==typeof t&&this.impl.onStatusChange.push(t)},B.prototype.unregisterStatusChange=function(t){"function"==typeof t&&(this.impl.onStatusChange=this.impl.onStatusChange.filter(function(e){return e!==t}))},e.Node.prototype.connect=function(t){return new T(this,t)},e.Node.prototype.isPoolSelectable=function(t,e){"function"==typeof e&&(this.impl.onPoolSelectable.push(e),null===this.impl.wsHypervisor&&this.impl.connectToHypervisor(),b(this.impl.wsHypervisor,{_:"isPoolSelectable",pool:t}))},e.Node.prototype.sendText=function(t,e){return D(t,this),e=e||"",t.impl.sendMessage(e+""),this},e.Node.prototype.sendBinary=function(t,e){return D(t,this),t.impl.sendMessage(e),this},e.Node.prototype.sendBinaryWithInterrupt=function(t,e,i){return D(t,this),this.impl.sendMessageWithInterrupt(t,e,i,this),this},e.Node.prototype.sendTextWithInterrupt=function(t,e,i){return D(t,this),this.impl.sendMessageWithInterrupt(t,e+"",i,this),this},e.Node.prototype.sendTextOnDisconnection=function(t,e){return D(t,this),e=e||"",t.impl.sendMessage(e+"",o.onDisconnect),this},e.Node.prototype.sendBinaryOnDisconnection=function(t,e){return D(t,this),t.impl.sendMessage(e,o.onDisconnect),this},e.Node.prototype.subscribe=function(t,e){return D(t,this),e=e||"",t.impl.sendMessage(e+"",o.subscribe),this},e.Node.prototype.unsubscribe=function(t,e){return D(t,this),e=e||"",t.impl.sendMessage(e+"",o.unsubscribe),this},e.Node.prototype.stop=function(){this.stop=function(){},this.impl.stop();var t=function(){throw new Error("EK.Node is closed")};for(var e in this.constructor.prototype)"function"==typeof this[e]&&(this[e]=t)},e.Interruption=function(){this.id=-1,this.interrupted=!1},e.Interruption.prototype.interrupt=function(){return!this.interrupted&&-1!==this.id&&(this.to.impl.sendMessage(void 0,o.resultsInterrupt,this.id),this.interrupted=!0,!0)},e.Multiplexer=function(t,i){for(var n in i=i||{})if(i.hasOwnProperty(n)&&!e.defaultsMultiplexerOptions.hasOwnProperty(n))throw new Error("Unknown EK.Multiplexer option named '"+n+"'. Valid options are: "+JSON.stringify(Object.keys(e.defaultsMultiplexerOptions)));var s=a({},e.defaultsMultiplexerOptions,i);this.impl=new P(t,s)},e.Multiplexer.prototype.sendBinary=function(t,e){this.impl.sendMessage(t,e)},e.Multiplexer.prototype.sendText=function(t,e){this.impl.sendMessage(t,e+"")},e.Multiplexer.prototype.sendBinaryWithInterrupt=function(t,e,i){this.impl.sendMessageWithInterrupt(t,e,i)},e.Multiplexer.prototype.sendTextWithInterrupt=function(t,e,i){this.impl.sendMessageWithInterrupt(t,e+"",i)},e.Multiplexer.prototype.close=function(){this.impl.join(),this.impl.isClosed=!0};var P=function(t,e){this.node=t,this.results=e,this.isClosed=!1,this.canJoin=!1};function A(t){return"number"==typeof t?t={low:t,high:0}:void 0!==t&&t.hasOwnProperty("low")||(t={low:0,high:0}),t}P.prototype.sendMessage=function(t,e,i){if(!this.isClosed){D(t,this.node);var n=this.node.impl.handlers.push(new E(this,t))-1;void 0!==i&&(i.id=n,i.to=t),t.impl.sendMessage(e,o.resultsSend,n)}},P.prototype.sendMessageWithInterrupt=function(t,e,i){-1===i.id&&this.sendMessage(t,e,i)},P.prototype.join=function(){this.canJoin&&(this.results.join(),this.canJoin=!1)},e.Store=function(t,i){for(var n in i=i||{})if(i.hasOwnProperty(n)&&!e.defaultsStoreOptions.hasOwnProperty(n))throw new Error("Unknown EK.Store option named '"+n+"'. Valid options are: "+JSON.stringify(Object.keys(e.defaultsStoreOptions)));h(i);var s=a({},e.defaultsStoreOptions,i);s.onBinary=function(t){var i=new e.BinaryReader(t),n=i.getSize();if(n&&i.readUint8()===r.NotifyObserverFromWeb)!function(t,e){var i=[],n=e.readUint32();if(void 0!==t.observedSnapshots[n]){for(t.observedSnapshots[n].snapshot.timeStamp=e.readUint64();e.tell()<e.getSize();){var s=i[i.length]={low:e.readUint32(),high:e.readUint32()},o=e.readInt64();t.observedSnapshots[n].snapshot.keys[s.high][s.low]=e.readArrayBuffer(o)}t.observedSnapshots[n].callback(t.observedSnapshots[n].snapshot,i)}}(this,i);else{var s=t.slice(n?1:0);this.callbacks.pop()(s)}}.bind(this),this.onMessage=function(t){return function(e){return("string"==typeof e?s.onText:s.onBinary)(e,t)}},this.onMessageResultsEnd=function(){return function(){}},this.observedSnapshots={},this.observedCounter=0,this.callbacks=[],this.impl=new H(s,(i.distant?"ek.distant.store.":"ek.local.store.")+t),this.impl.onMessage=this.onMessage.bind(this),this.impl.onMessageResultsEnd=this.onMessageResultsEnd.bind(this);var u=new T(this,"ek.store."+t);this.master=u.select(e.Criterion.preferMyHypervisor());var c=new e.BinaryWriter(1);c.writeUint8(r.StoreNodeDisconnectFromWeb),this.master.impl.sendMessage(c.createArrayBuffer(),o.onDisconnect);var p=new e.BinaryWriter(1);p.writeUint8(r.GetLocalMasterIdentifierFromWeb),this.master.impl.sendMessage(p.createArrayBuffer()),this.callbacks.unshift(function(t){var i=new e.BinaryReader(t);return this.port=i.readUint32(),this.hostname=i.readString(),!0}.bind(this))},e.Store.prototype.get=function(t,i){var n=new e.BinaryWriter(9);n.writeUint8(r.GetFromWeb);var s=A(t);return n.writeUint32(s.low),n.writeUint32(s.high),this.master.impl.sendMessage(n.createArrayBuffer()),this.callbacks.unshift(i),this},e.Store.prototype.put=function(t,i){var n=A(t);i=U(i);var s=new e.BinaryWriter(17+i.byteLength);return s.writeUint8(r.PutFromWeb),s.writeUint32(n.low),s.writeUint32(n.high),s.writeUint64(i.byteLength),s.writeUint8Array(i),this.master.impl.sendMessage(s.createArrayBuffer()),this},e.Store.prototype.del=function(t){var i=A(t),n=new e.BinaryWriter(17);return n.writeUint8(r.PutFromWeb),n.writeUint32(i.low),n.writeUint32(i.high),n.writeInt64(-1),this.master.impl.sendMessage(n.createArrayBuffer()),this};var N=function(t){for(var i=[],n=new e.BinaryReader(t),s=n.readUint64(),o=0;o<s;++o)i[o]={low:n.readUint32(),high:n.readUint32()};return i};e.Store.prototype.createKeys=function(t,i,n){var s=[];"string"==typeof n&&s.push(n);var o=new e.BinaryWriter(9);return o.writeUint8(r.CreateKeysFromWeb),o.writeUint64(t),o.writeUint64(s.length),o.writeStrings(s),this.master.impl.sendMessage(o.createArrayBuffer()),this.callbacks.unshift(function(t){var e=N(t);return i(e)}),this},e.Store.prototype.readKeys=function(t,i){var n=new e.BinaryWriter(1);n.writeUint8(r.ReadKeysFromWeb);var s=U(t);return n.writeUint8Array(s),this.master.impl.sendMessage(n.createArrayBuffer()),this.callbacks.unshift(function(t){var e=N(t);return i(e)}),this};var F,L=function(t,i,n){var s=new e.BinaryReader(n);this.store=t,this.keys={};for(var o=0;o<i.length;++o)void 0===this.keys[i[o].high]&&(this.keys[i[o].high]={}),this.keys[i[o].high][i[o].low]=void 0;for(this.fullSnapshot=s.readBool(),this.timeStamp=s.readUint64();s.tell()<n.byteLength;){var r={low:s.readUint32(),high:s.readUint32()},a=s.readInt64();void 0===this.keys[r.high]&&(this.keys[r.high]={}),this.keys[r.high][r.low]=s.readArrayBuffer(a)}};function q(t){var e={_:"graph"};t.options.cpu&&(e.cpu=!0),t.options.cpuLoad&&(e.cpuLoad=!0),t.options.ram&&(e.ram=!0),t.options.network&&(e.network=!0),t.lastRequest=Date.now(),t.timeout=void 0,t.ws.sendMessage(JSON.stringify(e))}return L.prototype.get=function(t){var e=A(t);return this.keys[e.high][e.low]?this.keys[e.high][e.low]:new ArrayBuffer(0)},e.Store.prototype.createSnapshot=function(t,i){var n,s=9+8*(i=i||[]).length,o=new e.BinaryWriter(s);o.writeUint8(r.SnapshotFromWeb),o.writeUint64(i.length);for(var a=0;a<i.length;++a)n=A(i[a]),o.writeUint32(n.low),o.writeUint32(n.high);this.master.impl.sendMessage(o.createArrayBuffer());var h=this;return this.callbacks.unshift(function(e){return t(new L(h,i,e))}),this},L.prototype.last=function(t){var i,n,s=0;for(i in this.keys){if(this.keys.hasOwnProperty(i))s+=Object.keys(this.keys[i]).length}var o=17+8*s,a=new e.BinaryWriter(o);for(i in a.writeUint8(r.LastSnapshotFromWeb),a.writeUint64(this.timeStamp),a.writeUint64(s),this.keys)if(this.keys.hasOwnProperty(i))for(n in this.keys[i])this.keys[i].hasOwnProperty(n)&&(a.writeUint32(n),a.writeUint32(i));this.store.master.impl.sendMessage(a.createArrayBuffer());var h=this;return this.store.callbacks.unshift(function(i){var n=function(t,i){var n=[],s=new e.BinaryReader(i);for(t.timeStamp=s.readUint64();s.tell()<i.byteLength;){var o=n[n.length]={low:s.readUint32(),high:s.readUint32()},r=s.readInt64();t.keys[o.high][o.low]=s.readArrayBuffer(r)}return n}(h,i);return t(h,n)}),this},L.prototype.createObserver=function(t,i){var n,s,o=0;for(n in this.keys){if(this.keys.hasOwnProperty(n))o+=Object.keys(this.keys[n]).length}var a=17+8*o,h=new e.BinaryWriter(a);for(n in h.writeUint8(r.CreateObserverFromWeb),h.writeBool(this.fullSnapshot),h.writeUint32(this.store.observedCounter),h.writeUint64(this.timeStamp),h.writeDouble(i),h.writeUint64(o),this.keys)if(this.keys.hasOwnProperty(n))for(s in this.keys[n])this.keys[n].hasOwnProperty(s)&&(h.writeUint32(s),h.writeUint32(n));return this.store.observedSnapshots[this.store.observedCounter]={snapshot:this,callback:t},this.store.observedCounter++,this.store.master.impl.sendMessage(h.createArrayBuffer()),this},L.prototype.deleteObserver=function(){var t=new e.BinaryWriter(5);t.writeUint8(r.DeleteObserverFromWeb);for(var i=0;i<this.store.observedCounter;++i)if(void 0!==this.store.observedSnapshots[i]&&this.store.observedSnapshots[i].snapshot===this){t.writeUint32(i),this.store.observedSnapshots[i]=void 0,this.store.master.impl.sendMessage(t.createArrayBuffer());break}return this},e.Batch=function(t){this.commands={},this.store=t},e.Batch.prototype.put=function(t,e){var i=A(t);return e=U(e),void 0===this.commands[i.high]&&(this.commands[i.high]={}),this.commands[i.high][i.low]={size:e.byteLength,binary:e},this},e.Batch.prototype.del=function(t){var e=A(t);return void 0===this.commands[e.high]&&(this.commands[e.high]={}),this.commands[e.high][e.low]={size:-1},this},e.Batch.prototype.commit=function(){var t,i,n,s=5,o=0;for(i in this.commands)if(this.commands.hasOwnProperty(i))for(n in this.commands[i])this.commands[i].hasOwnProperty(n)&&(o++,s+=16,-1!==(t=this.commands[i][n]).size&&(s+=t.size));var a=new e.BinaryWriter(s);for(i in a.writeUint8(r.CommitFromWeb),a.writeUint32(o),this.commands)if(this.commands.hasOwnProperty(i))for(n in this.commands[i])if(this.commands[i].hasOwnProperty(n)){t=this.commands[i][n];var h=new e.BinaryWriter(16);h.writeUint32(n),h.writeUint32(i),h.writeInt64(t.size),a.writeUint8Array(new Uint8Array(h.arrayBuffer)),-1!==t.size&&a.writeUint8Array(t.binary)}return this.store.master.impl.sendMessage(a.createArrayBuffer()),this},e.defaultsMonitorCallbacks=Object.freeze({onConnect:function(){},onDisconnect:function(){},onHypervisorAdd:function(){},onHypervisorUpdate:function(){},onHypervisorUnresponsive:function(){},onHypervisorDelete:function(){}}),e.defaultsMonitorOptions=Object.freeze({cpu:!1,cpuLoad:!1,ram:!1,network:!1,probes:!1,refreshIntervalInMilliseconds:1e3}),e.Monitor=function(t,i,s){void 0===F&&(F=new WeakMap);var o={};F.set(this,o),o.callbacks=a({},e.defaultsMonitorCallbacks,i),o.options=a({},e.defaultsMonitorOptions,s),o.ws=new e.WebSocket,o.ws.onOpen(o.callbacks.onConnect),o.ws.onClose(o.callbacks.onDisconnect),o.ws.onMessage(function(t){var i={revision:(t=JSON.parse(t)).revision};this.options.cpu&&(i.cpu=t.cpu),this.options.cpuLoad&&(i.cpuLoad=t.cpuLoad),this.options.ram&&(i.currentMemory=t.currentMemory,i.estimatedMemory=t.totalMemory-t.availableMemory,i.totalMemory=t.totalMemory,i.ram=100*i.currentMemory/i.totalMemory),this.options.probes&&(i.probes=t.probes),this.options.network&&(i.network=t.network);var n=!this.hypervisors.has(t.id);if(this.hypervisors.add(t.id),this.current.add(t.id),0===t.id&&(t.links=t.links||[],t.links.forEach(function(t){this.hypervisors.has(t.id)||(this.callbacks.onHypervisorAdd(t.id,t.hostname+":"+t.port),this.hypervisors.add(t.id))},this),this.current.forEach(function(t){this.hypervisors.delete(t)},this),this.hypervisors.forEach(function(e){0!==t.links.filter(function(t){return t.id===e}).length?(this.callbacks.onHypervisorUnresponsive(e),this.current.add(e)):this.callbacks.onHypervisorDelete(e)},this),this.hypervisors=this.current,this.current=new Set),n&&this.callbacks.onHypervisorAdd(t.id,t.hostname+":"+t.port),this.callbacks.onHypervisorUpdate(t.id,i),0===t.id&&this.running){var s=Math.max(this.lastRequest+this.options.refreshIntervalInMilliseconds-Date.now(),0);this.timeout=e.window.setTimeout(q,s,this)}}.bind(o)),o.ws.connect(t,{hypervisorId:0,id:n.hypervisor}),o.hypervisors=new Set,o.current=new Set,o.running=!0,o.lastRequest=0,o.timeout=void 0,q(o)},e.Monitor.prototype.pause=function(){var t=F.get(this);clearTimeout(t.timeout),t.running=!1,t.timeout=void 0},e.Monitor.prototype.resume=function(){var t=F.get(this),e=!t.running;t.running=!0,e&&void 0===t.timeout&&q(t)},e.Monitor.prototype.updateOptions=function(t){var i=F.get(this);if(i.options=a(i.options,t),i.running&&void 0!==i.timeout){clearTimeout(i.timeout);var n=Math.max(i.lastRequest+i.options.refreshIntervalInMilliseconds-Date.now(),0);i.timeout=e.window.setTimeout(q,n,i)}},e.Monitor.prototype.disconnect=function(){F.get(this).ws.close()},Object.keys(t).forEach(function(i){e[i]=t[i]}),e}()});