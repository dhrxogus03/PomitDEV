define("DS/FolderMigration/FolderMigration",["DS/IPClassifyUXUtil/service/IPClassifyUXUtilWebService","DS/IPClassifyUtil/IPClassifyUtility","DS/FolderEditor/utils/FolderEditorUtil","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADProbes","text!DS/FolderEditor/assets/FolderEditorColumns.json"],function(e,n,t,i,r,o){var a=JSON.parse(o);function s(e){if(e){var n={},t=function e(n){var t=!1,i={};for(var r in n){var o=r,a=n[r];!0!==a.e?o="_X_"+r:t=!0;var s=e(a.c);(!0===a.e||s.oneIsExpanded)&&(i[o]=s.elements),t=t||s.oneIsExpanded}return{oneIsExpanded:t,elements:i}}(e.root.c);t.oneIsExpanded&&(n={root:t.elements}),widget.setValue("folderTreeStructure",JSON.stringify(n))}}function d(){var e=widget.getValue("vMigration");return e||0}function u(){var e,t,i=widget.getValue("FolderCusto_treelistview"),r=null;d()<3?i&&(r=m(decodeURIComponent(i))):r=i?(e=i,t=n.jsonUnzip(e),value=m(t,null),value):null;return r}function l(e,n,t,i){return new Promise(function(r){if(!e||n>=i||t<i||!e.columnsOptimized)return r();var o=["ds6wg:revision","ds6w:reserved"];e.columnsOptimized.forEach(function(e){e.minWidth&&!e.width&&(50!=e.minWidth||o.indexOf(e.dataIndex)>=0)&&(e.width=e.minWidth),delete e.minWidth}),r()})}function c(e,n,t,i){return new Promise(function(r){if(!e||n>=i||t<i||!e.columnsOptimized)return r();var o=a.attributes,s={};o.forEach(e=>{var n=e.dataIndex;(n=n||e.ds6w)&&(s[n]=e)}),a.order.forEach((n,t)=>{var i=!1,r=s[n];if(r){for(var o=0;o<e.columnsOptimized.length;++o){var a=e.columnsOptimized[o];if(a.dataIndex===n){r.customisation&&!a.customisation&&(a.customisation=r.customisation),void 0!==r.sortableFlag&&(a.sortableFlag=r.sortableFlag),i=!0;break}}if(!i){var d=r;d.dataIndex=n,d.visibleFlag=!1,e.columnsOptimized.splice(t,0,d)}}}),r()})}function f(e,n,t,i){return new Promise(function(r){if(!e||n>=i||t<i)return r();if(e.rowsHeader=!1,delete e.custoFromTree,columns=e.columnsOptimized,columns){var o=[];columns.forEach(function(e){if("bi_color"!==e.dataIndex){var n={width:e.width,editableFlag:!1,customisation:e.customisation,dataIndex:e.dataIndex};e.xnav_options&&(n.kind=e.xnav_options.kind,n.kind="date"==n.kind?"datetime":n.kind,n.typeRepresentation="integer"===n.kind?"string":n.kind,"ds6w:reserved"===e.dataIndex&&(n.typeRepresentation="functionIcon"),n.ds6w=e.xnav_options.ds6w,!0===e.xnav_options.tree&&(n.tree=!0,n.editionPolicy="EditionOnDoubleClick")),!0===e.isHidden&&(n.visibleFlag=!1);for(var t in["kind","typeRepresentation","ds6w","tree","editionPolicy","visibleFlag"].forEach(t=>{void 0===n[t]&&void 0!==e[t]&&(n[t]=e[t])}),n)void 0===n[t]&&delete n[t];o.push(n)}}),e.columnsOptimized=o}r()})}function m(e,n){var t=n=n||null;try{t=e?JSON.parse(e):n}catch(e){t=n}return t}return{migrate:function(n){return new Promise(function(r,o){var a=function(e){return new Promise(function(n){if(d()>=1||e<1)return n();var t=widget.getValue("folderTreeStructure");t&&t.indexOf('"e"')>=0?(s(t=m(t,{})),n()):n()})}(n),v=function(e){return new Promise(function(n){var i=u(),r=d();l(i,r,e,2).then(()=>{f(i,r,e,7).then(()=>{c(i,r,e,7).then(()=>{i?t.setContentViewPreference(i,!1,e).then(n):n()})})})})}(n),p=function(n){return new Promise(function(r){if(d()>=3||n<3)return r();new Promise(function(n){i.app_initialization(function(){e.getUserPreferences({name:widget.getValue("x3dAppId")+"_template"}).then(e=>{var i=null,r=!1;e.length>0&&(i=m(decodeURIComponent(e)))&&(r=!0,t.setContentViewPreference(i,"only").then(n)),r||n()}).catch(n)})}).then(r)})}(n);Promise.all([v,a,p]).then(function(){widget.setValue("vMigration",n),r()})}.bind(this))},migratePreferences:function(e,n){var i=e.preference;return new Promise((r,o)=>{(function(e,n){return new Promise(function(t){var i=e.version?e.version:0;l(e,i,n,7).then(()=>{f(e,i,n,7).then(()=>{c(e,i,n,7).then(t)})})})})(i,n).then(()=>{t.setContentViewPreference(i,!0===e.template&&"only").then(()=>{r(i)}).catch(o)}).catch(o)})}}});