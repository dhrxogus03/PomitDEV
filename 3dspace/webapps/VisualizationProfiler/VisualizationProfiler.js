define("DS/VisualizationProfiler/VisuProfiler",["DS/CSICommandBinder/CSICommandBinder"],function(t){"use strict";var e=null;const i=Object.freeze({READY:0,RUNNING:1,STOPPED:2}),r=Object.freeze({WEB:0,A2X:1}),s=Object.freeze({enable:0,disable:1,reset:2,postProcess:3}),a=Object.freeze({NATIF_PANEL:"natif_panel",WEB_PANEL:"web_panel",CLI_COMMAND:"cli_command"}),n=Object.freeze({DURATION:0,COMPLETE:1,INSTANT:2,COUNTER:3,ASYNC:4,FLOW:5,SAMPLE:6,OBJECT:7,METADATA:8,MEM_DUMP:9,MARK:10,CLOCK_SYNC:11,CONTEXT:12}),c=Object.freeze({DEFAULT:0,WEB_CUSTOM:20}),o=Object.freeze({NONE:0,ENABLE:1,DISABLE:2,DOWNLOAD:3,RESET:4}),h=Object.freeze({NOLOG:0,INFO:1,WARN:2,ERROR:3});class l{constructor(t,e,i){this._label=t,this._startTime=e,this._TS=i}get(){return{label:this._label,startTime:this._startTime,ts:this._TS}}}class _{constructor(t,e,i,r){this._label=t,this._startTime=e,this._duration=i,this._TS=r}get(){return{label:this._label,startTime:this._startTime,duration:this._duration,ts:this._TS}}}const f={init:function(t){this._enabled=!1,this._state=i.READY,this._mode=r.WEB,this._lockLogs=!1,this._arrayOfMeasure=[],this._arrayOfMark=[],this._nativeStartTS=0,this._nativeEndTS=0,this._webStartTS=0,this._webEndTS=0,this._webTraces={traceEvents:[]},this._nativeTraces={traceEvents:[]},this._mergedTraces={traceEvents:[]},this._timeOffset=0,this._a2xSynchrOffSet=0,this._nativeTracesUploaded=!1,this._webTracesExtracted=!1,this._nativeTracesExtracted=!1,this._mergedTracesExtracted=!1,this._synchrOffsetExtracted=!1,this._customConfigExtracted=!1,this._tracingConfig=t?this._shallowCopy(t):void 0,this._defaultTracingConfig=Object.freeze({applyFilter:!1,reverseFilter:!1,filterList:[],splitThread:!1,gTraceEvtType:n.DURATION,interface:a.CLI_COMMAND,ODTMode:!1}),this._wPanelInterface=void 0,this._callbackManager={enable:[],disable:[],reset:[],postProcess:[]},this._callbackManager.call=function(t){switch(t){case s.enable:if(!this.enable.length)break;this.enable.forEach(t=>t()),this.enable=[];break;case s.disable:if(!this.disable.length)break;this.disable.forEach(t=>t()),this.disable=[];break;case s.reset:if(!this.reset.length)break;this.reset.forEach(t=>t()),this.reset=[];break;case s.postProcess:if(!this.postProcess.length)break;this.postProcess.forEach(t=>t()),this.postProcess=[]}},this._callbackManager.registerCB=function(t,e){switch(t){case s.enable:this.enable.push(e);break;case s.disable:this.disable.push(e);break;case s.reset:this.reset.push(e);break;case s.postProcess:this.postProcess.push(e)}}},openVisuProfiler:function(){if(this._mode!==r.A2X)return;let t={VisuProfilerPanel:1};t.sceneID=window.debugNavSync.getViewersMap()?window.debugNavSync.getViewersMap().entries().next().value[0]:1,this._sendCSIEmit(this._buildCSIPacket(t)),this._forceSetInterface(a.NATIF_PANEL)},registerWPanel:function(t){t&&(this._wPanelInterface=t,this._forceSetInterface(a.WEB_PANEL))},enable:function(t){t&&this._callbackManager.registerCB(s.enable,t),this._changeState(o.ENABLE)},disable:function(t){t&&this._callbackManager.registerCB(s.disable,t),this._changeState(o.DISABLE)},reset:function(t){t&&this._callbackManager.registerCB(s.reset,t),this._changeState(o.RESET)},subscribeToPostProcessing:function(t){t&&this._callbackManager.registerCB(s.postProcess,t)},downloadWebTraces:function(){this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadBeginCB();let t=this._getWebTraces();t?this._downloadFile(t,"dWebTraces.js"):this._logger(h.ERROR,"Failed to download web traces : no traces content found !")},downloadNativeTraces:function(){this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadBeginCB();let t=this._getNativeTraces();t?this._downloadFile(t,"dNativeTraces.js"):this._logger(h.ERROR,"Failed to download native traces : no traces content found !")},downloadA2XTraces:function(){this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadBeginCB();let t=this._getMergedTraces();t?this._downloadFile(t,"dA2XTraces.js"):this._logger(h.ERROR,"Failed to download a2x traces : no traces content found !")},get:function(){return e},getWebTraces:function(t){if(!this._enabled)return t&&!0===t?this._shallowCopy(this._getWebTraces()):this._getWebTraces()},getNativeTraces:function(t){if(!this._enabled)return t&&!0===t?this._shallowCopy(this._getNativeTraces()):this._getNativeTraces()},getA2XTraces:function(t){if(!this._enabled)return t&&!0===t?this._shallowCopy(this._getMergedTraces()):this._getMergedTraces()},getTimeLapses:function(){if(this._enabled)return-1;return{a2x:this._nativeEndTS-this._nativeStartTS,web:this._webEndTS-this._webStartTS,native:this._nativeEndTS-this._nativeStartTS}},getWebTracesPCS:function(t){let e=this.getWebTraces();if(0!==e.traceEvents.length)return this._getPCS(e,t,this._getCustomConfig().gTraceEvtType)},getNativeTracesPCS:function(t){let e=this.getNativeTraces();if(0!==e.traceEvents.length)return this._getPCS(e,t,this._getCustomConfig().gTraceEvtType)},getA2XTracesPCS:function(t){let e=this.getA2XTraces();if(0!==e.traceEvents.length)return this._getPCS(e,t,this._getCustomConfig().gTraceEvtType)},setConfig:function(t){t&&(this._tracingConfig=this._shallowCopy(t),this._customConfigExtracted=!1)},getConfig:function(){return this._shallowCopy(this._getCustomConfig())},isEnabled:function(){return this._enabled&&this._state===i.RUNNING},isODTMode:function(){return this._getCustomConfig().ODTMode},getInterface:function(){return this._getCustomConfig().interface},setLogging:function(t){this._lockLogs=!t},getMode:function(){return this._mode},getState:function(){return this._state},setCSIContext:function(t){t&&(this._state!==i.RUNNING?(this._CSIClientNode=t,this._subscribeToCSIEvents(),this._mode=r.A2X):this._logger(h.ERROR,"Failed to setCSIContext while profilling !"))},_onCSIMessage:function(t){let s=t.readString("id"),n=t.readString("content");if(s&&n)switch(s){case"visuprofiler":e._logger(h.INFO,n);break;case"A2XProfilerCmd":"Start"===n?e._startTracing():"Stop"===n&&e._stopTracing();break;case"A2XDownloadCmd":e._injectNativeTraces(JSON.parse(n)),e._mode===r.A2X&&e._state===i.STOPPED&&e._getCustomConfig().interface===a.NATIF_PANEL&&e.downloadA2XTraces();break;case"A2XProfilerStartTS":e._injectNativeStartTS(n);break;case"A2XProfilerStopTS":e._injectNativeStopTS(n),e._mode===r.A2X&&e._state===i.STOPPED&&e._cli_uploadNativeTraces();break;case"A2XProfilerWebAPICommander":switch(n){case"openVisuProfiler":this.openVisuProfiler();break;case"enable":this.enable();break;case"disable":this.disable();break;case"reset":this.reset()}}},_subscribeToCSIEvents:function(){this._CSIClientNode&&this._CSIClientNode.subscribe&&this._CSIClientNode.subscribe("NavSyncBack",this._onCSIMessage)},_sendCSIEmit:function(t){this._CSIClientNode.call({destinationNodeId:this._CSITargetPoolId,name:"invokeLowEvents",version:1,parameters:t,onSuccess:function(t){},onError:function(t){let e=t.readString("error");e&&this._logger(h.ERROR,e)},onProgress:function(t){}})},_buildCSIPacket:function(e,i=0){var r=new t.Parameters;return r.writeUint32("version",i),r.writeString("parameters",JSON.stringify(e)),r.writeString("options",JSON.stringify({runOnSecondaryThread:!1,waitForResult:!0})),r},_cli_interact:function(t){this._mode===r.A2X&&(t.VisuProfilerInteract=1,this._sendCSIEmit(this._buildCSIPacket(t)))},_cli_startTracing:function(){let t={InteractStart:1};this._cli_interact(t)},_cli_stopTracing:function(){let t={InteractStop:1};this._cli_interact(t)},_cli_uploadNativeTraces:function(){let t={InteractDownload:1};this._cli_interact(t),this._wPanelInterface&&this._wPanelInterface.onProfilerUploadBeginCB()},_changeState:function(t){switch(this._mode){case r.WEB:switch(t){case o.ENABLE:this._state!==i.RUNNING&&this._startTracing();break;case o.DISABLE:this._state===i.RUNNING&&this._stopTracing();break;case o.RESET:this._state===i.RUNNING&&this._changeState(o.DISABLE),this._factoryReset()}break;case r.A2X:switch(t){case o.ENABLE:this._state!==i.RUNNING&&this._cli_startTracing();break;case o.DISABLE:this._state===i.RUNNING&&this._cli_stopTracing();break;case o.RESET:this._state===i.RUNNING&&this._changeState(o.DISABLE),this._factoryReset()}}},_startTracing:function(){this._factoryReset(),this._enabled=!0,this._state=i.RUNNING,this._webStartTS=this._flagTracing(),this._callbackManager.call(s.enable),this._wPanelInterface&&this._wPanelInterface.onProfilerStartCB(),this._logger(h.INFO,this._getCustomConfig()),this._logger(h.INFO,"Profilling has started !")},_stopTracing:function(){this._enabled=!1,this._state=i.STOPPED,this._webEndTS=this._sampleTS(),this._callbackManager.call(s.disable),this._wPanelInterface&&this._wPanelInterface.onProfilerStopCB(),this._mode===r.WEB&&this._postProcess(),this._logger(h.INFO,"Profilling is stopped !")},_factoryReset:function(){this._arrayOfMeasure=[],this._arrayOfMark=[],this._enabled=!1,this._state=i.READY,this._nativeStartTS=0,this._nativeEndTS=0,this._webStartTS=0,this._webEndTS=0,this._webTraces={traceEvents:[]},this._nativeTraces={traceEvents:[]},this._mergedTraces={traceEvents:[]},this._timeOffset=0,this._a2xSynchrOffSet=0,this._nativeTracesUploaded=!1,this._webTracesExtracted=!1,this._nativeTracesExtracted=!1,this._mergedTracesExtracted=!1,this._synchrOffsetExtracted=!1,this._customConfigExtracted=!1,this._callbackManager.call(s.reset)},_injectNativeTraces:function(t){t&&(this._setNativeTracing(t),this._nativeTracesUploaded=!0,this._wPanelInterface&&this._wPanelInterface.onProfilerUploadEndCB(),this._postProcess())},_injectNativeStartTS:function(t){t&&(this._nativeStartTS=t)},_injectNativeStopTS:function(t){t&&(this._nativeEndTS=t)},_flagTracing:function(){this.probe("VisualizationProfiler::FlagTracing"),this._timeOffset=window.performance.now();let t=this._sampleTS();return this.probe("VisualizationProfiler::FlagTracing"),t},_sampleTS:function(){return Date.now()},_setCustomConfig:function(t){this._tracingConfig=t},_getCustomConfig:function(){return!1===this._customConfigExtracted&&(this._setTracingConfig(this._extractCustomConfig()),this._customConfigExtracted=!0),this._tracingConfig},_forceSetInterface:function(t){t&&this._getCustomConfig().interface!=t&&(this._tracingConfig.interface=t,this._customConfigExtracted=!1)},_setTracingConfig:function(t){t&&(this._tracingConfig=t)},_getTracingConfig:function(){return this._tracingConfig},_setWebTracing:function(t){this._webTraces=t},_getWebTraces:function(){return!1===this._webTracesExtracted&&(this._setWebTracing(this._extractWebTraces()),this._webTracesExtracted=!0),this._webTraces},_setNativeTracing:function(t){this._nativeTraces=t},_getNativeTraces:function(){return!1===this._nativeTracesExtracted&&(this._setNativeTracing(this._extractNativeTraces()),this._nativeTracesExtracted=!0),this._nativeTraces},_setMergedTraces:function(t){this._mergedTraces=t},_getMergedTraces:function(){return!1===this._mergedTracesExtracted&&(this._setMergedTraces(this._extractMergedTraces()),this._mergedTracesExtracted=!0),this._mergedTraces},_setSynchrOffset:function(t){this._a2xSynchrOffSet=t},_getSynchrOffset:function(){return!1===this._synchrOffsetExtracted&&(this._setSynchrOffset(this._extractSynchrOffset()),this._synchrOffsetExtracted=!0),this._a2xSynchrOffSet},_postProcess:function(){this.getWebTraces(),this._mode===r.A2X&&this.getA2XTraces(),this._callbackManager.call(s.postProcess),this._logger(h.INFO,"Profilling postProcess is done !")},_logger:function(t,e){this._lockLogs||t===h.NOLOG||(t===h.INFO&&console.info("[VisuProfiler] "+e),t===h.WARN&&console.warn("[VisuProfiler] "+e),t===h.ERROR&&console.error("[VisuProfiler] "+e))},_shallowCopy:function(t){return Object.assign({},t)},isArrIndex:function(t,e,i){return void 0!==i?t.findIndex(t=>t===e):-1!=t.findIndex(t=>t===e)},_isElemExist:function(t,e,i){return void 0!==i?t.findIndex(t=>t===e):-1!=t.findIndex(t=>t===e)},_buildUID:function(){return(Math.random()+1).toString(36).substring(7)},_getPCS:function(t,e,i){return"string"==typeof e?this._extractPCS(t,e,i):Array.isArray(e)?this._extractListOfPCS(t,e,i):void 0},_extractPCS:function(t,e,i){if(!t.traceEvents||0===t.traceEvents.length||!e)return;let r={wallDuration:0,avgWallDuration:0,occurrences:0};switch(i){case n.DURATION:{let i,s;for(let a=0;a<t.traceEvents.length;a++)t.traceEvents[a].name===e&&"B"===t.traceEvents[a].ph&&(i=t.traceEvents[a].ts),i&&t.traceEvents[a].name===e&&"E"===t.traceEvents[a].ph&&(s=t.traceEvents[a].ts,r.wallDuration+=s-i,r.occurrences++,i=void 0,s=void 0);break}case n.COMPLETE:for(let i=0;i<t.traceEvents.length;i++)t.traceEvents[i].name===e&&"X"===t.traceEvents[i].ph&&(r.wallDuration+=t.traceEvents[i].ts,r.occurrences++)}return r.occurrences>0&&(r.wallDuration/=1e3,r.wallDuration=Number.parseFloat(r.wallDuration.toFixed(3)),r.avgWallDuration=r.wallDuration/r.occurrences,r.avgWallDuration=Number.parseFloat(r.avgWallDuration.toFixed(3))),r},_extractListOfPCS:function(t,e,i){if(!t.traceEvents||0===t.traceEvents.length||0===e.length)return;if(1===e.length)return this._extractPCS(t,e[0],i);let r=[];for(let t=0;t<e.length;t++){let i={probe:e[t],wallDuration:0,avgWallDuration:0,occurrences:0,b:0,e:0};r.push(i)}switch(i){case n.DURATION:for(let i=0;i<t.traceEvents.length;i++)if(-1!=e.indexOf(t.traceEvents[i].name)){let s=e.indexOf(t.traceEvents[i].name),a=t.traceEvents[i];"B"===a.ph&&(r[s].b=a.ts),r[s].b&&"E"===a.ph&&(r[s].e=a.ts,r[s].wallDuration+=r[s].e-r[s].b,r[s].occurrences++,r[s].b=void 0,r[s].e=void 0)}break;case n.COMPLETE:for(let i=0;i<t.traceEvents.length;i++)if(-1!=e.indexOf(t.traceEvents[i].name)){let s=e.indexOf(t.traceEvents[i].name),a=t.traceEvents[i];"X"===a.ph&&(r[s].wallDuration+=a.ts,r[s].occurrences++)}}for(let t=0;t<r.length;t++)r[t].occurrences>0&&(r[t].wallDuration/=1e3,r[t].wallDuration=Number.parseFloat(r[t].wallDuration.toFixed(3)),r[t].avgWallDuration=r[t].wallDuration/r[t].occurrences,r[t].avgWallDuration=Number.parseFloat(r[t].avgWallDuration.toFixed(3))),delete r[t].b,delete r[t].e;return r},_downloadFile:function(t,e){const i=new Blob([JSON.stringify(t)],{type:"application/json"}),r=URL.createObjectURL(i);let s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download",e),document.body.appendChild(s),s.click(),s.remove(),this._wPanelInterface&&this._wPanelInterface.onProfilerDonwloadEndCB(),this._logger(h.INFO,"File "+e+" download is done ! ")},_applyFilter:function(t){let e=this._getCustomConfig();t.traceEvents.length>0&&!0===e.applyFilter&&(!1===e.reverseFilter?t.traceEvents=t.traceEvents.filter(t=>-1!=e.filterList.findIndex(e=>e===t.name)):t.traceEvents=t.traceEvents.filter(t=>!(-1!=e.filterList.findIndex(e=>e===t.name))))},_extractCustomConfig:function(){let t=this._shallowCopy(this._defaultTracingConfig);return void 0!==this._tracingConfig&&null!=this._tracingConfig&&"object"==typeof this._tracingConfig?(void 0!==this._tracingConfig.applyFilter&&null!==this._tracingConfig.applyFilter&&"boolean"==typeof this._tracingConfig.applyFilter&&(t.applyFilter=this._tracingConfig.applyFilter),void 0!==this._tracingConfig.reverseFilter&&null!==this._tracingConfig.reverseFilter&&"boolean"==typeof this._tracingConfig.reverseFilter&&(t.reverseFilter=this._tracingConfig.reverseFilter),void 0!==this._tracingConfig.filterList&&null!==this._tracingConfig.filterList&&"object"==typeof this._tracingConfig.filterList&&(t.filterList=this._tracingConfig.filterList),void 0!==this._tracingConfig.splitThread&&null!==this._tracingConfig.splitThread&&"boolean"==typeof this._tracingConfig.splitThread&&(t.splitThread=this._tracingConfig.splitThread),void 0!==this._tracingConfig.gTraceEvtType&&null!==this._tracingConfig.gTraceEvtType&&"number"==typeof this._tracingConfig.gTraceEvtType&&(t.gTraceEvtType=this._tracingConfig.gTraceEvtType),void 0!==this._tracingConfig.interface&&null!==this._tracingConfig.interface&&"string"==typeof this._tracingConfig.interface&&(t.interface=this._tracingConfig.interface),void 0!==this._tracingConfig.ODTMode&&null!==this._tracingConfig.ODTMode&&"boolean"==typeof this._tracingConfig.ODTMode&&(t.ODTMode=this._tracingConfig.ODTMode)):this._tracingConfig=t,t},_extractWebTraces:function(){let t=this._getCustomConfig(),e=this._extractSynchrOffset(),i={traceEvents:[]};switch(t.gTraceEvtType){case n.DURATION:this._arrayOfMark.length&&this._arrayOfMark.forEach(r=>{let s={ph:"",name:"",cat:"WebApplication",pid:0,tid:!0===t.splitThread?c.WEB_CUSTOM:c.DEFAULT,ts:0,args:{}};s.ph="0"===r._label.split("#")[1]?"B":"E",s.name=r._label.split("#")[0],s.ts=1===this._mode?1e3*(r._startTime-this._timeOffset)-e:1e3*(r._startTime-this._timeOffset),i.traceEvents.push(s)});break;case n.COMPLETE:this._arrayOfMeasure.length&&this._arrayOfMeasure.forEach(e=>{let r={ph:"",name:"",cat:"WebApplication",pid:0,tid:!0===t.splitThread?c.WEB_CUSTOM:c.DEFAULT,ts:0,dur:0,args:{}};r.ph="X",r.name=e._label.split("#")[0],r.dur=e._duration,r.ts=e._TS,i.traceEvents.push(r)})}return this._applyFilter(i),i},_extractNativeTraces:function(){return this._applyFilter(this._nativeTraces),this._nativeTraces},_extractMergedTraces:function(){let t=this._getWebTraces(),e=this._getNativeTraces();return this._mergedTraces.traceEvents=e.traceEvents.concat(t.traceEvents),this._mergedTraces.traceEvents.sort((t,e)=>t.ts<=e.ts?-1:1),this._mergedTraces},_extractSynchrOffset:function(){if(!(this._arrayOfMark.length>0&&this._nativeTraces.traceEvents.length>0))return 0;let t=this._nativeStartTS-this._webStartTS,e=(this._arrayOfMark.shift(),this._arrayOfMark.shift()),i=(this._nativeTraces.traceEvents.shift(),this._nativeTraces.traceEvents.shift()),r=1e3*(e._startTime-this._timeOffset),s=0;return s+=t,s+=i.ts-r},_wIsCompatible:function(){return!(!window.performance.mark||!window.performance.measure)},_checkGoCondition:function(){return!0===this._enabled},_recordVisPerfoMark:function(t,e,i){let r=new l(t,e,i);this._pushVisPerfoMark(r)},_pushVisPerfoMark:function(t){this._arrayOfMark.push(t)},_wClearPerfoMark:function(t){window.performance.clearMarks(t+"#0"),window.performance.clearMarks(t+"#1")},_recordVisPerfoMeasure:function(t,e,i,r){let s=new _(t,e,i,r);this._pushVisPerfoMeasure(s)},_pushVisPerfoMeasure:function(t){this._arrayOfMeasure.push(t)},_wClearPerfoMeasure:function(t){window.performance.clearMeasures(t)},_wIsEntryExist:function(t){return 1==window.performance.getEntriesByName(t).length},_isLabelCompliant:function(t){if(t.indexOf("::")>=1){let e=t.indexOf("::");if(t.length>e+2){let i=t.lastIndexOf("::");return i>-1&&i==e}}return!1},begin:function(t){if(!this._checkGoCondition())return;if(!this._isLabelCompliant(t))return;let e=window.performance.mark(t+"#0");this._recordVisPerfoMark(e.name,e.startTime,Date.now())},end:function(t){if(!this._checkGoCondition())return;if(!this._wIsEntryExist(t+"#0"))return;let e=window.performance.mark(t+"#1");this._recordVisPerfoMark(e.name,e.startTime,Date.now());let i=window.performance.measure(t,t+"#0",t+"#1");this._recordVisPerfoMeasure(i.name,i.startTime,i.duration,Date.now()),this._wClearPerfoMark(t),this._wClearPerfoMeasure(t)},probe:function(t){this._checkGoCondition()&&(this._wIsEntryExist(t+"#0")?this.end(t):this.begin(t))}};return f.init(),e=f,f});