/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeRobotSnapMove",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/CATW3DRobot/CATW3DRobot","DS/PADUtils/PADContext","DS/CATC3DNavigation/CAT3DComposeExamineController"],function(e,t,n,i,o){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var a=i.get();this.beginExecute=function(){var e=n.getMove3DRobot({context:a}),i=t.get();if(1===i.length){var r;i[0].event&&(r=t._items[0].pathElement.getBoundingSphere().center),e.modifyTargetAndPosition({pathElement:i[0].pathElement,robotPosition:r}),e.addCoordPanel({immersiveFrame:a.getFrameWindow().getImmersiveFrame(),w3dRobot:e,robotP:r});var s=o.getExamineController({context:a});s&&s.setActiveState(!1)}this.done()}}})}),define("DS/CAT3DComposeCommands/CATC3DReverseDirectionCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!1}),this.setRepeatMode(!1),this.beginExecute=function(){var e=t.get();if(e.length){var c,l=i.get(),u=r.giveMoveManager({context:l}),C=o.getMoveReferentManager({context:l}),d=a.giveConstraintsController({context:l});if(e.some(function(e){var t;return c=C.getMoveReferent(e.pathElement),!!(d&&c&&(t=c.getLastElement(!0))&&s.isInstance(t)&&t.children.length>0)&&(c.addElement(t.children[0]),d.isThereACstSuppportingReverseDirection(c))})&&c&&d){var m=d.simulateReverseDirection(c)||{},S=m.matrix||new n.Matrix4,p=new n.Matrix4,g=m.rc,E=m.redundancy;0!==g||E||(u.onMoveBegin({objectsMoved:e,from:this,moveMode:"Persistent"}),e.forEach(function(e){u.onMove({objectsMoved:[{path:e.pathElement}],from:this,worldMatrix:p.multiplyMatrices(S,e.pathElement.getWorldMatrix())})},this),u.onMoveEnd({from:this,status:"Moved"}))}this.done()}}}})}),define("DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommandsManager","DS/CATW3DMoveManager/CATW3DMoveManager"],function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;let s,c,l;var u=e.extend({init:function(e){this._parent(e),l=this,s=a.getMoveManager({context:n.get()}),this.onStateChange(function(){l.getState()&&u.PasteAtLocalCoordinates()}),this.toggleState=function(){l.getState()||l.setState(!0)},this._destroy=function(){Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),l=void 0}}});return u.PasteAtLocalCoordinates=function(e,i){!c&&i?c=i.executionContext.getComponent("Viewer"):c||i||(c=n.get()),s=a.getMoveManager({context:c});var l=[];t.get().forEach(function(e){l.push({path:e.pathElement})}),l.length&&(s.onMoveBegin({objectsMoved:l,from:u,moveMode:"Persistent"}),s.onMove({objectsMoved:l,from:u,leafMatrix:r}),s.onMoveEnd({from:u,status:"Moved"}),c.getViewer().render()),(!i||i&&!i.executionContext)&&o.getCommandCheckHeader("CATC3DPasteAtOriginalPositionHdr",c.getCommandContext?c.getCommandContext():null).setState(!1),require(["DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd"],function(t){t&&t.clean(e,i),e&&e()})},u.clean=function(e,t){l&&l.setState&&l.setState(!1),window.console.log(t),s=c=null,e&&e()},u}),define("DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATWebUXComponents/DMUCommandsManager"],function(e,t,n,i,o,a){"use strict";var r=new i.Matrix4;let s,c,l,u,C,d=this,m=!1,S=[],p=null;var g=e.extend({init:function(e){this._parent(e),d=this,m=!1,S=[],l=n.get().getFrameWindow().getContextualUIManager(),u=o.giveMoveManager({context:n.get()}),C=function(){c=[],l.hideContextualMenus(),t.get().forEach(function(e){var t=u.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(r)||c.push({pathElement:e.pathElement,path:t,matrix:n})}}),c.length>0&&(l.showContextualBar({x:n.get().getViewer().SCREEN_WIDTH/2,y:n.get().getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:n.get().getCommandContext?n.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]}),m=!0,d.setState(!0))},p=n.get().subscribe({event:"onAuthoringTransactionEnd"},C),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(e){var t=e.getDropManager({context:n.get()});S.push(t.subscribe({event:"onBeginInsertDrop3D"},function(){n.get().unsubscribe(p)})),S.push(t.subscribe({event:"onEndInsertDrop3D"},function(e){e&&"inPosition"===e.type&&C(),p=n.get().subscribe({event:"onAuthoringTransactionEnd"},C)}))}),this.onStateChange(function(){d.getState()&&g.PasteAtOriginalPosition()}),this.toggleState=function(){this.getState()||d.setState(!0)},this._destroy=function(){n.get().unsubscribe(p),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(e){var t=e.getDropManager({context:n.get()});t&&S.forEach(function(e){t.unsubscribe(e)}),S=[]}),Object.getPrototypeOf(this)._destroy&&Object.getPrototypeOf(this)._destroy.apply(this,arguments),u=c=m=p=l=C=d=void 0}}});return g.PasteAtOriginalPosition=function(e,i){!s&&i?s=i.executionContext.getComponent("Viewer"):s||i||(s=n.get()),m?m=!1:(l=s.getFrameWindow().getContextualUIManager(),u=o.giveMoveManager({context:s}),C=function(){c=[],l.hideContextualMenus(),t.get().forEach(function(e){var t=u.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(r)||c.push({pathElement:e.pathElement,path:t,matrix:n})}}),c.length>0&&(l.showContextualBar({x:s.getViewer().SCREEN_WIDTH/2,y:s.getViewer().SCREEN_HEIGHT/2,hideWithDistance:!1,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:n.get().getCommandContext?n.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]}),m=!0,d.setState&&d.setState(!0))},p=s.subscribe({event:"onAuthoringTransactionEnd"},C),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(e){var t=e.getDropManager({context:s});S.push(t.subscribe({event:"onBeginInsertDrop3D"},function(){s.unsubscribe(p)})),S.push(t.subscribe({event:"onEndInsertDrop3D"},function(e){e&&"inPosition"===e.type&&C(),p=n.get().subscribe({event:"onAuthoringTransactionEnd"},C)}))}),c.length>0&&(u.onMoveBegin({objectsMoved:c,from:d,moveMode:"Persistent"}),c.forEach(function(e){!e.path.getMatrix().equals(e.matrix)&&t.isIn(e)&&u.onMove({objectsMoved:[e],from:d,leafMatrix:e.matrix})}),u.onMoveEnd({from:d,status:"Moved"}),s.getViewer().render())),(!i||i&&!i.executionContext)&&a.getCommandCheckHeader("CATC3DPasteAtLocalCoordinatesHdr",s.getCommandContext?s.getCommandContext():null).setState(!1),require(["DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd"],function(t){t&&t.clean(e,i),e&&e()})},g.clean=function(e,t){d&&d.setState&&d.setState(!1),window.console.log(t),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(t){var n=t.getDropManager({context:s});n&&S.forEach(function(e){n.unsubscribe(e)}),S=[],e&&e()})},g}),define("DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent",["UWA/Class","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/DMUCommandsManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/PADUtils/PADContext"],function(e,t,n,i,o,a,r,s,c,l,u){"use strict";var C=0;return e.extend({init:function(e){this._parent(e);var d,m,S,p,g,E=e.context,A=E.getCommandContext?E.getCommandContext():null,f=[],h=u.get(),v=[],D=new n.Matrix4;this.activate=function(){if(0===f.length&&(d=E.getViewer(),m=r.getMoveReferentManager({context:E}),f=["CAT3DComposeCtxMenuAgent_"+C++,"CAT3DComposeCtxMenuAgent_"+C++],E.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,r){var s=t.get();if(0!==s.length){var u=c.getRoots(E),C=[],S=!1,p=!1,g=a.giveConstraintsController({context:E});s.some(function(e){var t,n=m.getMoveReferent(e.pathElement);if(n&&(t=n.getLastElement(!0))&&c.isInstance(t)&&t.children.length>0){n.addElement(t.children[0]),g&&g.isThereACstSuppportingReverseDirection(n)&&(S=!0);var a=g?g.getAxisTypeIfCstOnProductAxis(n):null;if(a)if(p=!0,E.getExecutionContext){let e=E.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e&&(a===o.GeometryType.AXISX?e.setRadioItemState({id:"SwitchToX",radioId:"CATC3DSwitchAxisHdr",state:!0}):a===o.GeometryType.AXISY?e.setRadioItemState({id:"SwitchToY",radioId:"CATC3DSwitchAxisHdr",state:!0}):e.setRadioItemState({id:"SwitchToZ",radioId:"CATC3DSwitchAxisHdr",state:!0}))}else a===o.GeometryType.AXISX?i.getCommandCheckHeader("CATC3DSwitchAxisXHdr",A).setState(!0):a===o.GeometryType.AXISY?i.getCommandCheckHeader("CATC3DSwitchAxisYHdr",A).setState(!0):i.getCommandCheckHeader("CATC3DSwitchAxisZHdr",A).setState(!0);return S&&p}return!1}),p&&C.push({name:"CATC3DSwitchAxisIcb",line:1,hdr_list:["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"],type:"handler",identifier:"CATC3DSwitchAxisHdr"}),S&&C.push({name:"CATC3DReverseDirectionStr",line:1,hdr_list:["CATC3DReverseDirectionHdr"],type:"handler",identifier:"CATC3DReverseDirectionHdr"});var f=s.some(function(e){var t=e.pathElement.getLastElement(!0);return u.some(function(n){var i=n!==t,o=e.pathElement.externalPath.some(function(e){return n===e});return i&&o})});if(f&&r&&r.withContextMenu&&"number"==typeof r.XmousePosition&&"number"==typeof r.YmousePosition)0===d.pick(d.getMousePosition(new n.Vector2(r.XmousePosition,r.YmousePosition)),"mesh",!1).path.length&&(f=!1);if(f&&(l.getExamineController({context:E}).canBeEnabled()&&C.push({name:"CAT3DComposeExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"],type:"handler",identifier:"CAT3DComposeExamineSelectionHdr"}),1===s.length)){let e=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),t=h.getController&&h.getController().hasAnyEffectiveFlexibleAssembly();require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration")&&e&&t||C.push({name:"RobotSnapMove",line:1,hdr_list:["CAT3DComposeRobotSnapMoveHdr"],type:"handler",identifier:"CAT3DComposeRobotSnapMoveHdr"}),C.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"],type:"handler",identifier:"LevelSelectorHdr"})}return h.getExecutionContext?C.length?{WAfrCtxBarRow1:{model:C}}:void 0:C.length?{cmdList:C}:void 0}},context:A,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:!0,subscriberId:f[0]}),E.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(e,i){var o=[],a=t.get();if(1===a.length){var r=a[0].pathElement.getLastElement(!0);c.getRoots(E).some(function(e){return e===r})&&o.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"],type:"handler",identifier:"ENO3DRemoveRootCmd"})}if(i&&i.withContextMenu&&"number"==typeof i.XmousePosition&&"number"==typeof i.YmousePosition&&0===d.pick(d.getMousePosition(new n.Vector2(i.XmousePosition,i.YmousePosition)),"mesh",!1).path.length)return;return h.getExecutionContext?o.length?{WAfrCtxBarRow1:{model:o}}:void 0:o.length?{cmdList:o}:void 0},context:A,workbenchName:"ENOPAD3DViewerContextualBar",module:"ENOPAD3DViewer",cmdPrefix:"",merge:!0,subscriberId:f[1]}),E.getExecutionContext)){p=E.getFrameWindow().getContextualUIManager(),g=s.giveMoveManager({context:E});let e=function(){if(p.hideContextualMenus(),t.get().forEach(function(e){var t=g.getSubPathToMovable(e.pathElement);if(t){var n=t.getMatrix();n.equals(D)||v.push({pathElement:e.pathElement,path:t,matrix:n})}}),v.length>0){let e=[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"],type:"handler",identifier:"PasteAtOriginalPosition"},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"],type:"handler",identifier:"PasteAtLocalCoordinates"}],t={onContextualBarReady:function(){return{WAfrCtxBarRow2:{model:e}}},context:E.getCommandContext?E.getCommandContext():null,subscriberId:"CATC3DPasteCmds",workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:!0};p.register(t),setTimeout(function(){p._showContextualBar({x:d.SCREEN_WIDTH/2,y:d.SCREEN_HEIGHT/2,hideWithDistance:!1,subscribersOptions:t});let e=E.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e&&e.setCheckState({id:"PasteAtOriginalPosition",state:!0}),p.unregister("CATC3DPasteCmds")},10)}};S=E.subscribe({event:"onAuthoringTransactionEnd"},e),require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(t){var n=t.getDropManager({context:E});f.push(n.subscribe({event:"onBeginInsertDrop3D"},function(){E.unsubscribe(S)})),f.push(n.subscribe({event:"onEndInsertDrop3D"},function(t){t&&"inPosition"===t.type&&e(),S=E.subscribe({event:"onAuthoringTransactionEnd"},function(){e()})}))})}},this.deactivate=function(){d=m=null,f.forEach(function(e){E.getFrameWindow().getContextualUIManager().unregister(e)}),f=[],S=null}}})}),define("DS/CAT3DComposeCommands/CATC3DSwitchAxisCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CATWebUXComponents/DMUCommandsManager","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s,c,l){"use strict";var u,C,d,m=c.GeometryType;let S=e.extend({init:function(e){let t,n;switch(this._parent(e),e.ID){case"CATC3DSwitchAxisXHdr":t=m.AXISX,n=["CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"];break;case"CATC3DSwitchAxisYHdr":t=m.AXISY,n=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisZHdr"];break;default:t=m.AXISZ,n=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr"]}var i=this.onStateChange(function(){this.getState()&&S.SwitchAxis(void 0,e,t,n)});this._destroy=function(){this._modelEvents.unsubscribe(i),Object.getPrototypeOf(this)._destroy.call(this),i=n=null}},toggleState:function(){this.getState()||this.setState(!0,!0)},_destroy:function(){this._parent()}});return S.SwitchAxis=function(e,c,p,g){if(!u&&c.executionContext?u=c.executionContext.getComponent("Viewer"):u||c.executionContext||(u=i.get()),p&&g&&(C=p,d=g),c.executionContext&&c.args&&c.args.Axis)switch(c.args.Axis){case"X":C=m.AXISX,d=["SwitchToX","SwitchToZ"];break;case"Y":C=m.AXISY,d=["SwitchToX","SwitchToZ"];break;default:C=m.AXISZ,d=["SwitchToX","SwitchToY"]}var E,A,f=a.giveConstraintsController({context:u}),h=s.giveMoveManager({context:u}),v=r.getMoveReferentManager({context:u}),D=n.get();if(D.some(function(e){var t;return A=v.getMoveReferent(e.pathElement),!!(f&&A&&(t=A.getLastElement(!0))&&l.isInstance(t)&&t.children.length>0)&&(A.addElement(t.children[0]),E=f.getAxisTypeIfCstOnProductAxis(A))}),f&&E&&E!==C&&A){var T=f.simulateSwitchAxis(A,C)||{},y=T.matrix||new o.Matrix4,I=new o.Matrix4,R=T.rc,x=T.redundancy;0!==R||x||(h.onMoveBegin({objectsMoved:D,from:S,moveMode:"Persistent"}),D.forEach(function(e){h.onMove({objectsMoved:[{path:e.pathElement}],from:S,worldMatrix:I.multiplyMatrices(y,e.pathElement.getWorldMatrix())})},S),h.onMoveEnd({from:S,status:"Moved"}),f.setProductAxisForConstraint(C))}c.executionContext?d.forEach(function(e){let t=c.executionContext.getComponent(WAfrStandardComponentKey.HandlerComponent);t&&t.setRadioItemState({id:e,radioId:"CATC3DSwitchAxisHdr",state:!1})}):d.forEach(function(e){t.getCommandCheckHeader(e,u.getCommandContext?u.getCommandContext():null).setState(!1)}),e&&e()},S.clean=function(e,t){!u&&t?u=t.executionContext.getComponent("Viewer"):u||t||(u=i.get()),e&&e()},S}),define("DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATW3DAnims/CATW3DAnimation3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/RenderStyle","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,n,i,o,a,r,s,c){"use strict";var l="AxisSystems";return e.extend({init:function(e){var u,C,d,m,S,p,g,E=e.context,A=E.getViewer().getSceneGraphOverrideSetManager();function f(e,t){return e&&t&&e.isEqual(t)}function h(e){for(var n,i=e?new t(e.externalPath):null;i&&(!(n=i.getLastElement())||!c.is3DLeaf(n));)i=i.getParentPath();return i}function v(e){var t,n,i,o,a=h(e),r=null;if(a&&(i=[],n=(t=a.getLastElement(!0)).getChildByName(l))){for(o=n.getParents();o&&o[0]&&o[0]!==t;)i.unshift(o[0]),o=o[0].getParents();i.push(n),r=a,i.forEach(function(e){r.addElement(e)})}if(r){var s=r.getChildrenPathes(),c=[];return s.forEach(function(e){var t={paths:[]};!function e(t,n){var i=null;n.push(t),(i=t.getChildrenPathes())&&i.length>0&&i.forEach(function(t){e(t,n)})}(e,t.paths),c.push(t)}),{axisBagPath:r,axisSystems:c}}return null}function D(e){if(!e||!e.pathElement)return null;if(E.getViewer().getAxisFilter())return g&&(A.removeSceneGraphOverrideSet(g),g=null,E.getViewer().render()),null;g&&-1===A.getSceneGraphOverrideSetIndex(g)&&A.pushSceneGraphOverrideSet(g);var t=v(e.pathElement);if(t&&t.axisSystems&&t.axisSystems.length>0){var n=[];t.axisSystems.forEach(function(e){var t;t=e.paths[0],m&&!m.get().some(function(e){return e.pathElement.getLastElement(!0)===t.getLastElement(!0)})&&(e.node=e.paths[0].getLastElement(!0),n.push(e))}),n.length===t.axisSystems.length&&n.push({paths:[t.axisBagPath]}),n.length>0&&n.forEach(function(e){g||(g=new r(E.getRootBagPath().externalPath[0]),A.pushSceneGraphOverrideSet(g));var t,n=g.getUniqueOverrideFromPathElement(e.paths[0]);n||(n=g.createOverride({pathes:e.paths}),(t=new s).setRenderMode("AxisSystem",!0),n.setRenderStyle(t)),e.override=n}),a.getAnimation3DEngine({viewer:E.getViewer()}).axisSystemVisibility({objectListToAnimate:n,visibility:e.visibility,pickability:e.pickability})}return e.pathElement}function T(e){var t=h(e.pathElement);f(S,t)||(D({pathElement:S,visibility:!1,pickability:!1}),S=D({pathElement:t,visibility:!0,pickability:!0}))}function y(){var e=n.get();clearTimeout(p),p=null,1===e.length?T({pathElement:e[0].pathElement?e[0].pathElement:e[0].originalPathElement}):D({pathElement:S,visibility:!1,pickability:!1})}function I(e){var t=h(e.pathElement?e.pathElement:e.originalPathElement);t&&(p=setTimeout(function(){D({pathElement:t,visibility:!1,pickability:!1}),S=null},1e3))}function R(e){var t=h(e.pathElement);(!S||S&&t&&!f(t,S))&&D({pathElement:e.pathElement,visibility:!1,pickability:!1})}E.getViewer().onAxisFilterChange(function(){g&&(A.removeSceneGraphOverrideSet(g),g=null,E.getViewer().render())}),this.activate=function(e){m||(g&&(A.pushSceneGraphOverrideSet(g),E.getViewer().render()),u=n.onPostAdd(y),C=n.onRemove(I),m=e&&"HSO"===e.type?i:o,d=m.onRemove(R))},this.analyze=T,this.deactivate=function(){m&&(g&&(A.removeSceneGraphOverrideSet(g),E.getViewer().render()),n.unsubscribe(u),n.unsubscribe(C),m.unsubscribe(d),u=C=d=m=null)}}})}),define("DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CATW3DUtils/CATW3DUtils"],function(e,t,n,i,o,a,r,s,c){"use strict";var l={};require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(e){l.point=e.point,l.center=e.center,l.axisSystem=e.axisSystem,l.line=e.line,l.plane=e.plane,l.cylinder=e.cylinder,l.surface=e.surface,l.product=e.product});var u,C,d=i.getWebappsAssetUrl("DMUMeasure","icons/32/"),m=i.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),S=function(e){u?e():C||(C=!0,require(["DS/Web3DUXFilterBar/Web3DUXFilterBar"],function(t){C=!1,u=t,e()}))},p=e.extend({init:function(e){var i,C,p,g,E,A,f,h,v=e.context,D=!0,T=v.getViewer(),y={none:0,point:0,center:0,axisSystem:1,line:0,plane:1,cylinder:1,surface:0,product:1},I=localStorage.getItem("C3DSelectionFilter"),R=new a({context:v}),x=function(){y={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},E.getActiveState("point")&&(y.none=0,y.point=1),E.getActiveState("center")&&(y.none=0,y.center=1),E.getActiveState("axisSystem")&&(y.none=0,y.axisSystem=1),E.getActiveState("line")&&(y.none=0,y.line=1),E.getActiveState("plane")&&(y.none=0,y.plane=1),E.getActiveState("cylinder")&&(y.none=0,y.cylinder=1),E.getActiveState("surface")&&(y.none=0,y.surface=1),E.getActiveState("product")&&(y.none=0,y.product=1);var e="1-"+y.point+y.center+y.axisSystem+y.line+y.plane+y.cylinder+y.surface+y.product+"-"+(D?1:0);localStorage.setItem("C3DSelectionFilter",e),y.axisSystem?R.activate():R.deactivate()},P=function(){var e;function t(t){if(!t)return e=!1,void(E&&E.setVisibleFlag(!1));e=!0,D?E?E.setVisibleFlag(!0):S(function(){(E=new u({body:v.getFrameWindow().getUIFrame(),frmWindow:v.getFrameWindow(),Idpanel:"c3dSelectionFilter",classpanel:"c3dSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:l.point,url:d+"I_Meas_Point.png",callback:x,bexclude:!1,bstateActif:y.point},{type:"element",id:"center",nls:l.center,url:d+"I_Meas_PointCircle.png",callback:x,bexclude:!1,bstateActif:y.center},{type:"element",id:"axisSystem",nls:l.axisSystem,url:m+"I_3DComposeAxisSystem.png",callback:x,bexclude:!1,bstateActif:y.axisSystem},{type:"element",id:"line",nls:l.line,url:d+"I_Meas_Line.png",callback:x,bexclude:!1,bstateActif:y.line},{type:"element",id:"plane",nls:l.plane,url:d+"I_Meas_Plane.png",callback:x,bexclude:!1,bstateActif:y.plane},{type:"element",id:"cylinder",nls:l.cylinder,url:d+"I_Meas_Cylinder.png",callback:x,bexclude:!1,bstateActif:y.cylinder},{type:"element",id:"surface",nls:l.surface,url:d+"I_Meas_Surface.png",callback:x,bexclude:!1,bstateActif:y.surface},{type:"element",id:"product",nls:l.product,url:d+"I_Meas_Product.png",callback:x,bexclude:!1,bstateActif:y.product}]})).build();var t=document.querySelector(".c3dSelectionFilter");t&&(t.style.position="absolute"),E.setVisibleFlag(!1),e&&D&&E.setVisibleFlag(!0)}):E&&E.setVisibleFlag(!1)}return function(){t(!!A&&(v&&o.getRoots(v).length>0))}}();if(I&&I.length>8){var b=2,M=parseInt(I.split("-")[0]);y.point="1"===I.charAt(b++)?1:0,y.center="1"===I.charAt(b++)?1:0,y.axisSystem="1"===I.charAt(b++)?1:0,y.line="1"===I.charAt(b++)?1:0,y.plane="1"===I.charAt(b++)?1:0,y.cylinder="1"===I.charAt(b++)?1:0,M&&(y.surface="1"===I.charAt(b++)?1:0),y.product="1"===I.charAt(b++)?1:0,y.point||y.center||y.axisSystem||y.line||y.plane||y.cylinder||y.surface||y.product||(y.none=1),I.length>b&&"-"===I.charAt(b++)&&(D="1"===I.charAt(b))}function N(e){var n=e.pathElement;return e.pathElement=new t,n.externalPath.some(function(t){return e.pathElement.addElement(t),t&&o.is3DLeaf(t)}),n.internalPath.length>0&&(e.originalPathElement=n),e}function w(e){if(!(e&&e.pathElement&&e.pathElement.externalPath.length&&o.isAModelPath(e.pathElement)))return e;if(!A||y.none)return N(e);if(y.axisSystem||y.point||y.center||y.line||y.plane||y.cylinder||y.surface){var t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:T,nonCanonicGeometry:Boolean(y.surface)}),n=t?t.getType():null;if(y.axisSystem&&n===s.GeometryType.AXISSYSTEM)return e.originalPathElement=e.pathElement,e.pathElement=t.getPathElement(),e.equivalentGeometry=t,e;if(y.point&&n===s.GeometryType.POINT||y.center&&(n===s.GeometryType.CIRCLE||n===s.GeometryType.SPHERE)||y.line&&n===s.GeometryType.LINE||y.plane&&(n===s.GeometryType.PLANE||n===s.GeometryType.REFPLANE)||y.cylinder&&(n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE)||y.surface&&n===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e;if(y.surface&&(n===s.GeometryType.PLANE||n===s.GeometryType.CYLINDER||n===s.GeometryType.CONE||n===s.GeometryType.SPHERE)&&(n=(t=r.getEquivalentGeometry({pathElement:e.pathElement,viewer:T,canonicGeometry:!1,nonCanonicGeometry:!0}))?t.getType():null)===s.GeometryType.SURFACE)return e.equivalentGeometry=t,e}if(y.surface){for(var i,a=e.pathElement.externalPath.length-1;a>=0&&!i;a--)o.isRepReference(e.pathElement.externalPath[a])&&(i=e.pathElement.externalPath[a]);if(i&&!v.getController().hasMeshInRAM(o.getNodeID(i)))return N(e)}return y.product?N(e):(e.originalPathElement=e.pathElement,e.pathElement=null,e)}function L(e){Array.isArray(e)?e.forEach(w):w(e)}function F(){return{point:y.point,center:y.center,line:y.line,axisSystem:y.axisSystem,plane:y.plane,cylinder:y.cylinder,surface:y.surface,product:y.product}}function _(e){C&&C.cancel&&C.cancel(),C=null,e&&e.pickingResult&&e.pickingResult.path&&e.pickingResult.path.length&&(C=c.switchToAV1withMesh({pathElement:e.pickingResult.path[0],pad3DViewer:v,selectionFilter:F(),onComplete:function(){C=null},onFailure:function(){C=null}}))}function O(){if(A){var e=v.getViewer();e.setPicking(g),e.setPrePicking({primitive:p}),i&&e.unsubscribe(i),i=null,n.unsubscribe(A),v.unsubscribe(f),v.unsubscribe(h),A=f=h=null,P(),R.deactivate()}}this.filter={activate:function(e){if(!A){var t=v.getViewer();g={primitive:t.picking.primitive,trapSelection:t.picking.trapSelection,trapPrimitive:t.picking.trapPrimitive,trapGPU:t.picking.trapGPU},p=t.pPicking.primitive,t.setPicking({primitive:1,trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),t.setPrePicking({primitive:1}),e&&e.switchToAV1withMesh&&(i=t.onPreactivate(_)),A=n.onPreAdd(L),f=v.subscribe({event:"onRootAdded"},P),h=v.subscribe({event:"onRootRemoved"},P),P(),y.axisSystem&&R.activate()}},deactivate:O,isActive:function(){return Boolean(A)},display:function(e){"boolean"==typeof e&&e!==D&&(D=e,P())},filterPath:w,switchToAV1withMesh:_,getFiltersState:F},Object.freeze(this.filter),this.unreference=function(){O(),E&&E.clear(),R=E=v=null}}}),g=[];return e.singleton({init:function(){},giveDefaultSelectionFilter:function(e){var t,n;return n=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&g.some(function(n){return n.context===e.context&&(t=n.mng.filter,!0)}),t},getDefaultSelectionFilter:function(e){var t,n;if(n=e.context.getExecutionContext?"ENO3DView":"ENOPAD3DViewer",e&&e.context&&e.context.name===n&&(g.some(function(n){return n.context===e.context&&(t=n.mng.filter,!0)}),!t)){var i=new p({context:e.context});g.push({context:e.context,mng:i}),t=i.filter}return t},unreferenceDefaultSelectionFilter:function(e){e&&e.context&&g.some(function(t,n){return t.context===e.context&&(t.mng.unreference(),g.splice(n,1),!0)})}})}),define("DS/CAT3DComposeCommands/CAT3DComposeMoveCmd",["DS/CATWebUXComponents/DMUCommand","DS/Visualization/SceneGraphUtils","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DAnims/CATW3DAnimation3D","DS/CATW3DBoxes/CATW3DBoxController","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CATW3DCommands/CATW3DCmdsUtils","DS/CATW3DCommands/CATW3DMoveBarUX","DS/CoreEvents/Events"],function(e,t,n,i,o,a,r,s,c,l,u,C,d){"use strict";var m,S,p,g,E,A;return require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(e){m=e.PositionModifiedSaveOK,S=e.PositionModifiedSaveKO,p=e.singleSplitInstance,g=e.multipleSplitInstance}),require(["DS/Selection/CSOManager"],function(e){E=e}),e.extend({init:function(f){this._parent(f,{mode:"exclusive",isAsynchronous:!0});var h,v,D,T,y,I,R,x=this,P=!0,b=!1,M=c.get(),N=M.getCommandContext(),w=l.getMoveManager({context:M}),L=r.getExamineController({context:M}),F=i.getDefaultSelectionFilter({context:M}),_=function(){b=!0,P=!1,w.terminateMove({save:!1}),M.getExecutionContext?x.cancelExecute():x.cancel()},O=function(){b=!0,P=!1,w.terminateMove({save:!0}),M.getExecutionContext?x.cancelExecute():x.cancel()},U=function(){w.cancelLocked()},W=w.subscribe("Move",function(e){h||(h=new C({uiFrame:M.getFrameWindow().getUIFrame(),onSave:O,onCancel:_,onCancelLocked:U})),e.objectsMoved.length>0&&"Persistent"===e.moveMode&&e.objectsMoved.forEach(function(e){var t=e.path.getLastElement(!0);u.isPLMInstanceNode(t)&&(h.showSpinner(),w.isPathLocked({pathElement:e.path,onCompleted:function(e){h&&(h.hideSpinner(),e.isLocked?h.showLock():h.showSave())}}))})}),G=function(e){var n="success"===e.eventID&&e.objectsMoved.length>0?m:"error"===e.eventID&&e.objectsCancelled.length>0?S:null;n&&M.displayNotification({eventID:e.eventID,msg:n});var i=o.getAnimation3DEngine({viewer:M.getViewer()});if(e&&e.splitInstances&&e.splitInstances.length){M.displayNotification({eventID:"info",msg:e.splitInstances.length>1?g:p});var a=[],r=M.getController(),s=M.getRootBagPath().getLastElement(!0);if(e.splitInstances.forEach(function(e){a=a.concat(t.buildPathesLeadingToNode(r.getNode({id:e.newId}),s).map(function(e){return{path:e}}))}),i.addAnimation({animationType:"opacityOnOff",objectListToAnimate:a,duration:1e3,createOverrideSet:!0}),i.addAnimation({animationType:"color",objectListToAnimate:a,duration:1e3,createOverrideSet:!0,color:"#ff821e"}),E){var c=E.get();c.length&&E.empty(),a.length&&E.add(a.map(function(e){return{pathElement:e.path}})),c.length&&E.empty(),E.add(c)}}e.objectsCancelled&&e.objectsCancelled.length>0&&i.addAnimation({animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout(function(){D.begin()},0)},createOverrideSet:!0}),i.startAnimation(),b&&(w.unsubscribe(I),w.unsubscribe(R))},k=function(e){if(h&&!0===e.bEmptyMove?(h.hideSave(),h.hideLock()):h&&!e.someMovedObjectsAreLocked&&h.hideLock(),e.objectsCancelled&&e.objectsCancelled.length>0){var t=o.getAnimation3DEngine({viewer:M.getViewer()}),n={animationType:"cancel",objectListToAnimate:e.objectsCancelled,callBackFct:function(){setTimeout(function(){D.begin()},0)},createOverrideSet:!0};t.addAnimation(n),t.startAnimation()}else M.getViewer().render();b&&(w.unsubscribe(I),w.unsubscribe(R))},X=function(e){"Enter"!==e.key&&13!==e.keyCode||!1===e.ctrlKey&&!1===e.altKey&&!1===e.shiftKey&&!1===e.metaKey&&(O(),document.removeEventListener("keydown",X))};A||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){A=e,x.isRunning()&&A.activate({context:M,withSnap:!0,selectionFilter:F})}),this.beginExecute=function(){T=w.subscribe("MoveBegin",function(){L&&L.setActiveState(!1);var e=n.give3DGridController({context:M});e&&e.hide3DGrids()}),y=w.subscribe("MoveEnd",function(){if(x.isRunning()){var e=a.getBoxController({context:M});e&&e.setActiveState(!0),L&&L.setActiveState(!0);var t=n.give3DGridController({context:M});t&&t.display3DGrids()}}),v||(v=new s({context:M})),D||(D=new e({ID:"CAT3DComposeFakeMoveHdr",mode:"shared",isAsynchronous:!1,context:N})),P=!0,b=!1,(h=new C({uiFrame:M.getFrameWindow().getUIFrame(),onSave:O,onCancel:_,onCancelLocked:U})).show(),v.activate();var t=a.getBoxController({context:M});t&&t.setActiveState(!w.isMoving());var i=n.give3DGridController({context:M});i&&i[w.isMoving()?"hide3DGrids":"display3DGrids"](),L&&L.setActiveState(!0),A&&A.activate({context:M,withSnap:!0,selectionFilter:F}),F.activate({switchToAV1withMesh:!0}),document.addEventListener("keydown",X),I=w.subscribe("onValidateMove",G),R=w.subscribe("onCancelMove",k)},this.cancelExecute=function(){document.removeEventListener("keydown",X),require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(e){e._sendUsageProbe("command",P?"MoveCancel":"MoveOK")}),P&&(b=!0,w.terminateMove({save:!1})),h&&h.destroy(),h=null,v.deactivate(),F&&F.deactivate();var e=a.getBoxController({context:M});e&&e.setActiveState(!1),L&&L.setActiveState(!1),M.getFrameWindow().getContextualUIManager().hideContextualMenus(),A&&A.deactivate({context:M}),M.getExecutionContext&&d.publish({event:"onCommandStart/BEGIN",data:{_id:M.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}}),this.done()},this.pauseExecute=function(){var e=a.getBoxController({context:M});e&&e.setActiveState(!1),h&&h.hide(),v.deactivate(),F.deactivate(),L&&L.setActiveState(!1),A&&A.deactivate({context:M}),document.removeEventListener("keydown",X),this.done()},this.resumeExecute=function(){var e=a.getBoxController({context:M});e&&e.setActiveState(!0),h&&h.show(),v.activate(),F.activate({switchToAV1withMesh:!0}),L&&L.setActiveState(!0),A&&A.activate({context:M,withSnap:!0,selectionFilter:F}),document.addEventListener("keydown",X),this.done()},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){Object.getPrototypeOf(this)._destroy.apply(this,arguments),w.unsubscribe(T),w.unsubscribe(W),w.unsubscribe(y),w.unsubscribe(I),w.unsubscribe(R),A&&A.unreference({context:M}),M=w=v=h=I=R=T=W=y=x=null}}})}),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUFrameWindow","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATC3DNavigation/CAT3DComposeExamineController"],function(e,t,n,i,o,a,r,s,c,l,u,C,d,m,S){"use strict";var p;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var g=this,E=!1,A=e.executionContext?e.executionContext.getComponent("Viewer"):r.get();s.init(A,{executionContext:e.executionContext});let f=new a({context:A}),h=t.getBoxController({context:A}),v=S.getExamineController({context:A}),D=c.getMoveManager({context:A}),T=m.getSelectionManager({context:A}),y=l.getDefaultSelectionFilter({context:A}),I=u.getMove3DRobot({context:A}),R=[],x=[],P={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},b={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3},M=!0;function N(){if(g.isRunning()){var e=n.give3DGridController({context:A});e&&e.hide3DGrids(),g&&g.isRunning()&&(y&&y.activate(),T&&T.setActiveState(!1)),h&&h.setActiveState(!1)}}function w(){if(g.isRunning()){var e=n.give3DGridController({context:A});e&&e.display3DGrids(),g&&g.isRunning()&&y&&!I.hasTarget()&&(y.deactivate(),T&&T.setActiveState(!0)),h&&h.setActiveState(!0)}}p||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){p=e,g.isRunning()&&(p.activate({context:A,withSnap:!0,selectionFilter:y}),p.give().setAllowManipulation(M),x.length||(x.push(p.subscribe("onDirectMoveBegin",N)),x.push(p.subscribe("onDirectMoveEnd",w))))}),I.setSelectionFilter(y),y.deactivate(),R.push(I.subscribe("onRobotMoveBegin",function(){g.isRunning()&&(g&&g.isRunning()&&(y&&y.activate(),T&&T.setActiveState(!1)),h&&h.setActiveState(!1))})),R.push(I.subscribe("onRobotMoveEnd",w));var L=[];function F(){L.length>0||(L.push(D.subscribe("MoveBegin",function(){v&&v.setActiveState(!1)})),L.push(D.subscribe("Move",function(){var e=o.giveDataLauncherController({context:A});e&&e.setVisibility(!1)})),L.push(D.subscribe("MoveEnd",function(){var e=o.giveDataLauncherController({context:A});e&&e.setVisibility(!0),v&&v.setActiveState(!0)})))}function _(){L.forEach(function(e){D.unsubscribe(e)}),L=[]}var O=C.getPreferenceManager({context:A.getFrameWindow()}),U=[];function W(e){g&&e.forEach(function(e){if("W3MprefMove"===e.name)e.preferences.forEach(function(e){if("C3DAllowDirectManipulation"===e.name){let t=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),n=A.getController&&A.getController().hasAnyEffectiveFlexibleAssembly(),i=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration");M=!(t&&n&&i)&&"true"===e.value,p&&p.give().setAllowManipulation(M)}else"defaultMoveReferent"===e.name&&(i.setMoveReferentDefault(e.value),h&&h.refreshBoxes(!0))});else if("FrameGeneral"===e.name)e.preferences.forEach(function(e){if("ProjectionType"===e.name){var t="Perspective"===e.value?0:1;let n=A?A.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}});else if("VisualizationRepository"===e.name)e.preferences.forEach(function(e){if("Gravity"===e.name){var t="true"===e.value;let n=A?A.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}});else if("SelectionRepository"===e.name)e.preferences.forEach(function(e){if("Select3DGeometry"===e.name){var t=!!y&&y.isActive();t&&y.deactivate(),T.setPicking("true"===e.value?0:1),t&&y.activate()}else"SelectParentReferenceOr3DShape"===e.name&&T&&T.selectParentReference("select3DShape"!==e.value)});else if("cke"===e.name){let t=!1,n=!1;e.preferences.forEach(function(e){"Length"===e.name?(P.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(P.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(b.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(b.decimalPlaceRO=parseInt(e.value),n=!0)}),t&&I.setLengthUnit(P),n&&I.setAngleUnit(b)}})}O.addPreferences(i.getPreferencesDefinition()),O.setUnitsPreferencesDisplayFlag(!0),O.setDisplayPreferencesDisplayFlag(!0),O.set3DSelectionPreferencesDisplayFlag(!0),O.setMeasurePreferencesDisplayFlag(!0),O.setClippingPreferencesDisplayFlag(!0),O.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),U.push(O.subscribe("com.ds.mep:onPrefUpdate",function(e){W(JSON.parse(e[1].preferences).repositories)})),A.getViewer().currentViewpoint.getControl().setRotationRolling(!0),A.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!0),A.getViewer().currentViewpoint.setProjectionType(0),T.setPicking(1),T.selectParentReference(!1);d.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["C3DAllowDirectManipulation","defaultMoveReferent"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then(function(e){W(e.repositories)}).catch(function(e){window.console.warn("Error Preferences ",e)}),this.beginExecute=function(){A&&(T.setActiveState(!0),A.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),function(){if(A&&!E){f.activate(),h.setActiveState(!0);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!0),p&&p.activate({context:A,withSnap:!0,selectionFilter:y}),y&&y.deactivate(),v&&v.setActiveState(!0),F()}}(),this.done())},this.endExecute=function(){if(A){f.deactivate(),h.setActiveState(!1);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!1),p&&p.deactivate({context:A}),T.setActiveState(!1),v&&v.setActiveState(!1),_()}},this.pauseExecute=function(){f.deactivate(),h.setActiveState(!1);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!1),p&&p.deactivate({context:A}),y&&y.deactivate(),T.setActiveState(!1),v&&v.setActiveState(!1),_(),this.done()},this.resumeExecute=function(){if(A){y&&I.hasTarget()?(y.activate(),T.setActiveState(!1)):T.setActiveState(!0),A.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),f.activate(),h.setActiveState(!0);var e=o.giveDataLauncherController({context:A});e&&e.setActiveState(!0),p&&p.activate({context:A,withSnap:!0,selectionFilter:y}),v&&v.setActiveState(!0),F(),this.done()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){_(),R.forEach(I.unsubscribe,I),x.forEach(I.unsubscribe,x),p&&(x.forEach(p.unsubscribe,x),p.unreference({context:A})),E=!0,U.forEach(O.unsubscribe,O),l.unreferenceDefaultSelectionFilter({context:A}),m.unreferenceSelectionManager({context:A}),S.unregisterExamineController({context:A}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),g=y=A=f=h=D=I=O=U=T=null}}})}),define("DS/CAT3DComposeCommands/CAT3DComposeExamineSelection",["UWA/Core","DS/CATWebUXComponents/DMUCommand","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CATW3DAnims/CATW3DAnimation3D","DS/PADUtils/PADContext","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/LevelSelector/LevelSelector","DS/CATW3DCommands/CATW3DCmdsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATC3DNavigation/CAT3DComposeExamineController","css!DS/CAT3DComposeUI/CAT3DComposeUI.css"],function(e,t,n,i,o,a,r,s,c,l,u,C,d,m,S,p,g){"use strict";var E=Math.PI/4;function A(e){var t,n,i,o=e&&e.externalPath.length>1;for(t=0;o&&t<e.externalPath.length-1;++t)n=e.externalPath[t],i=e.externalPath[t+1],n.children.indexOf(i)<0&&(o=!1);return o}var f,h,v=function(){var e,t,n,i,o,r;this.store=function(s,c){e=t=n=i=o=r=void 0;var l=c?(new a.Matrix4).extractRotation(c):null;e=s.getEyePosition(),c&&e.applyMatrix4(c),t=s.getUpDirection(),l&&t.applyMatrix4(l),n=s.getSightDirection(),l&&n.applyMatrix4(l),i=s.getTargetDistance(),o=s.getProjectionType(),r=s.getAngle()},this.restore=function(s,c){if(e){var l=c?(new a.Matrix4).extractRotation(c):null;s.moveTo({eyePosition:c?e.applyMatrix4(c):e,upDirection:l?t.applyMatrix4(l):t,sightDirection:l?n.applyMatrix4(l):n,distanceToTarget:i}),s.setProjectionType(o),s.setAngle(r)}}};return v.prototype={constructor:v},Object.freeze(v),t.extend({init:function(t){this._parent(t,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1);var D,T,y,I,R,x,P,b,M,N,w,L,F,_,O,U=this,W=s.get(),G=W.getViewer(),k=W.getController(),X=G.getSceneGraphOverrideSetManager(),V=C.giveMoveManager({context:W}),Y=[],B=[],H={},j=u.getMoveReferentManager({context:W}),q=g.getExamineController({context:W});function K(){Y.some(function(e){return"boolean"!=typeof X.getCurrentVisibility(e.path)})&&(W.getExecutionContext&&U.cancelExecute(),U.cancel())}function z(){D=null}function J(e){if(e&&e.from&&e.from.some(function(e){return e.view.id===G.canvas.id})){var t=e.gesture?e.gesture.getEvents()[0]:e.from[0];if(t&&t.event&&0===t.event.button&&0===t.event.buttons){var n=G.pick(G.getMousePosition(t.getCurrentPosition(G.canvas)),"mesh",!1);n&&n.path&&0!==n.path.length||(z(),W.getExecutionContext&&U.cancelExecute(),U.cancel())}}}require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e){O=e}),f||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){if(f=e,U.isRunning()){var t=p.giveDefaultSelectionFilter({context:W});t&&f.activate({context:W,withSnap:!0,selectionFilter:t})}}),h||require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],function(e){h=e});var Z,Q=function(){var e=W.getFrameWindow().getViewpoint(),t=new a.Matrix4,n=e.getUpDirection(),i=e.getSightDirection();this.className.search("right")>=0?t.makeRotationAxis(n,E):this.className.search("left")>=0?t.makeRotationAxis(n,-E):this.className.search("top")>=0?t.makeRotationAxis(i.cross(n),-E):t.makeRotationAxis(i.cross(n),E),Y.forEach(function(e){e.matrixRotation=t}),y.addAnimation({animationType:"rotate",objectListToAnimate:Y.filter(function(e){return e.rotate}),callBackFct:function(){Y.forEach(function(e){e.matrixSource=e.override.getPosition()})}}),y.startAnimation()},$=function(e,t,n,i){var o=[];if(e){var a=e.getKey();-1!==n.indexOf(a)||!0===i.getCurrentVisibilityFree(e)&&!i.getCurrentVisibility(e)||(t.some(function(t){return e.isAParentOf(t)})?e.getChildrenPathes().forEach(function(e){o=o.concat($(e,t,n,i))}):o.push(e))}return o},ee=(Z=new a.Color,function(){return Z.set(G.backgroundColor),255*Z.getHSL().l>120?"black":"white"});function te(){var e=60*Math.sqrt(2),t=W.getViewer(),n=t.SCREEN_WIDTH/2,i=t.SCREEN_HEIGHT/2;H.main.setStyles({top:i+"px",left:n+"px"}),H.right.setStyle("left",n-e-10+"px"),H.left.setStyle("left",-1*n+e+10+"px"),H.top.setStyle("top",-1*i+e+10+"px");var o=W.getExecutionContext?document.querySelector(".WAfrPageObjectUseOnly-WAfr-Actionbar").offsetHeight+2:"true"===W.getFrameWindow().getActionBar().elements.container.getAttribute("data-open")?73:30;H.bottom.setStyle("top",i-e-o+"px")}function ne(e){var t;y.forward(),"ArrowLeft"===e.key||37===e.keyCode?t=H.left:"ArrowUp"===e.key||38===e.keyCode?t=H.top:"ArrowRight"===e.key||39===e.keyCode?t=H.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=H.bottom),t&&(t.addClassName("active"),Q.call(t))}function ie(e){var t;"ArrowLeft"===e.key||37===e.keyCode?t=H.left:"ArrowUp"===e.key||38===e.keyCode?t=H.top:"ArrowRight"===e.key||39===e.keyCode?t=H.right:"ArrowDown"!==e.key&&40!==e.keyCode||(t=H.bottom),t&&t.removeClassName("active")}function oe(){Y.length&&(L||(L=new l(Y[0].path.externalPath)),A(L)?(_=new v).store(W.getFrameWindow().getViewpoint(),(new a.Matrix4).getInverse(L.getWorldMatrix())):L=_=null)}function ae(e){q&&q.setActiveState(!1);var t=p.giveDefaultSelectionFilter({context:W});t&&(f&&!e&&f.deactivate({context:W}),e||t.deactivate()),W.setRobotVisibility(T),O&&window.widget&&"true"===window.widget.getValue("changeControlActivation")&&O.show(),o.removeEvent(G.canvas,"onPrimaryPointerClick",J),b&&(V.unsubscribe(b),b=void 0),!e&&P&&(V.unsubscribe(P),P=void 0),B.forEach(function(e){W.unsubscribe(e)}),B=[],d.destroyView(),H.main&&H.main.hide(),M&&W.getViewer().unsubscribe(M);var n=W.getFrameWindow().getActionBar();N&&n.removeCallback(N),w&&n.removeCallback(w),M=N=w=void 0,document.removeEventListener("keydown",ne),document.removeEventListener("keyup",ie)}function re(){oe(),Y=[],z(),ae(!0);var e=W.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(I),I=R=null,e.render(),F.restore(W.getFrameWindow().getViewpoint())}function se(){q&&q.setActiveState(!0);var e=p.giveDefaultSelectionFilter({context:W});if(e&&f&&h&&!h.isNavigationActivated({context:W})&&f.activate({context:W,withSnap:!0,selectionFilter:e}),e&&e.activate({switchToAV1withMesh:!0}),W.getFrameWindow().getContextualUIManager().hideContextualMenus(),T=W.isRobotVisible(),W.setRobotVisibility(!1),O&&O.hide(),o.addEvent(G.canvas,"onPrimaryPointerClick",J),b=V.subscribe("Move",re),P=V.subscribe("MoveEnd",function(){W.getExecutionContext&&U.cancelExecute(),U.cancel()}),["onRootRemoved","onRootDetached","onAuthoringTransactionEnd","onEndDelete"].forEach(function(e){B.push(W.subscribe({event:e},K))}),function(e){if(e){var t,o=j.getMoveReferent(e)||e,a=o.getLastElement(!0);if(m.isPLMInstanceNode(a)){a&&a.children.length&&o.addElement(a.children[0]);var r={display:{type:"docked",marginW:10,marginH:10},background:G,disableKeyboard:!0,displayWhileViewpointIsManipulated:!0,uiFrame:W.getFrameWindow().getUIFrame(),getLevels:function(t){var n=m.getLevelSelectorLevels({pathElement:e,pathElementCurrent:o,onInfoCompleted:t,context:W});if(n){n.selectColor="#ff821e",n.selectOverColor="#ffb477";for(var i=n.levels.length-1;i>=0;--i){var a=n.levels[i];m.isPLMReferenceNode(a.pathElement.getLastElement(!0))&&j.getMoveReferent(a.pathElement)||(a.selection="notSelectable")}}return n},onHover:function(e){R&&(R.setColor(ee(),!1),R.setOpacity(.05,!1),R.setVisibility(!0),R.setVisibilityFree(null)),(t=I.createOverride({pathes:[o]})).setColor(16744448,!0),t.setOpacity(1,!0),G.render(),n.empty(),n.add(e)},onLeave:function(){R&&(R.setColor(null,null),R.setOpacity(null,null),R.setVisibility(!1),R.setVisibilityFree(!0)),I.deleteOverride(t),t=null,G.render(),n.empty(),n.add(i.get())},onSelect:function(n){if(n&&n.pathElement&&j){if(j.addMoveReferent(n.pathElement),I.deleteOverride(t),t=null,!(o=j.getMoveReferent(e)))return;(a=o.getLastElement(!0))&&a.children.length&&o.addElement(a.children[0]),(t=I.createOverride({pathes:[o]})).setColor(16744448,!0),t.setOpacity(1,!0),G.render()}}};d.createView(r)}}}(1===Y.length?Y[0].path:null),H.main.show(),te(),M=G.onViewerResize(te),!W.getExecutionContext){var t=W.getFrameWindow().getActionBar();N=t.onActionBarOpen(te),w=t.onActionBarClose(te)}document.addEventListener("keydown",ne),document.addEventListener("keyup",ie)}this.beginExecute=function(){(x=S.getRoots(W).map(S.getNodeID,S).some(k.isLargeDataStructure,k))&&k.pauseProgressiveLoading(),(F=new v).store(W.getFrameWindow().getViewpoint()),W.getExecutionContext||W.getFrameWindow().getActionBar().close(),y=r.getAnimation3DEngine({viewer:G}),Y=[],I=new c(W.getRootBagPath().externalPath[0]),X.pushSceneGraphOverrideSet(I);var t=[],o=[],s=new a.Box3,u=G.getVisibleSpace();if(D=[],i.get().forEach(function(e){D.push(e);for(var n=new l(e.pathElement.externalPath);n&&!m.isPLMNode(n.getLastElement(!0));)n=n.getParentPath();if(n&&n.externalPath.length&&(!1===X.getCurrentVisibilityFree(n)||"boolean"==typeof X.getCurrentVisibility(n))){var i=n.getParentPath().getWorldMatrix(),r=(new a.Matrix4).getInverse(i),c=n.getMatrix(),C={path:n,override:I.createOverride({pathes:[n]}),matrixSource:c,matrixParent:i,matrixParentInv:r,rotate:!0},d=u?n.getBoundingBox(null,G,"visibleSpace"):n.getBoundingBox(null,G,"invisibleSpace");d&&!d.isNaN()?(d.applyMatrix4(n.getWorldMatrix()),s.union(d)):C.rotate=!1,Y.push(C),t.push(n),o.push(n.getKey())}}),t.length>0){var C=s.center();Y.forEach(function(e){e.centerRotation=(new a.Vector3).copy(C).applyMatrix4(e.matrixParentInv)});var d=!1;L&&(L.isEqual(new l(t[0].externalPath))&&A(L)||(_=L=null)),_||(d=!0);var p=$(W.getRootBagPath(),t,o,X);R=I.createOverride({pathes:p}),y.addAnimation({animationType:"mask",objectListToAnimate:[{override:R}],callBackFct:function(){d?W.getFrameWindow().getViewpoint().reframe(null,0,s.getBoundingSphere()):_&&(_.restore(W.getFrameWindow().getViewpoint(),L.getWorldMatrix()),_=null)}}),y.startAnimation();H.main=e.createElement("div",{id:"C3D-viewpoint"}).inject(W.getFrameWindow().getUIFrame()),["left","top","right","bottom"].forEach(function(t){var n=new e.createElement("div",{class:t}).inject(H.main);n.addEvents({click:Q}),new e.createElement("div",{class:"background"}).inject(n);var i=new e.createElement("div",{class:"arrow"}).inject(n);new e.createElement("div",{class:"borderBottom"}).inject(i),new e.createElement("div",{class:"borderRight"}).inject(i),H[t]=n}),se(),n.empty(),i.empty(),require(["DS/CAT3DComposeUtils/CATC3DUtils"],function(e){e._sendUsageProbe("command","ExamineSelection")})}else W.getExecutionContext&&U.cancelExecute(),U.cancel()},this.cancelExecute=function(){if(oe(),Y=[],ae(),H.main&&H.main.destroy(),H={},I){var e=W.getViewer();e.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(I),I=R=null,e.render(),W.getExecutionContext||W.getFrameWindow().getActionBar().open(),F.restore(W.getFrameWindow().getViewpoint())}D&&D.length&&0===i.get().length&&(n.empty(),i.empty(),D.filter(function(e){return"boolean"==typeof X.getCurrentVisibility(e.pathElement)}).length&&(n.add(D),i.add(D)));z(),x&&k.resumeProgressiveLoading(),x=!1,this.done()},this.pauseExecute=function(){ae(!1),this.done()},this.resumeExecute=function(){se(),n.empty(),i.empty();var e=new a.Box3,t=G.getVisibleSpace();Y.forEach(function(n){var i=n.path,o=t?i.getBoundingBox(null,G,"visibleSpace"):i.getBoundingBox(null,G,"invisibleSpace");o&&!o.isNaN()?(o.applyMatrix4(i.getWorldMatrix()),e.union(o),n.rotate=!0):n.rotate=!1});var o=e.center();Y.forEach(function(e){e.centerRotation=(new a.Vector3).copy(o).applyMatrix4(e.matrixParentInv)}),this.done()},this.disable(),this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this._destroy=function(){U&&(f&&f.unreference({context:W}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),U=W=k=G=X=null)}}})}),define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmdV2",["DS/CATW3DBoxes/CATW3DBoxController","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CATWebUXComponents/DMUFrameWindow","DS/CATW3DMoveManager/CATW3DMoveManager","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATW3DRobot/CATW3DRobot","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATC3DNavigation/CAT3DComposeExamineController","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXUtils"],function(e,t,n,i,o,a,r,s,c,l,u,C,d,m,S,p){"use strict";let g;return class{constructor(E){var A=this,f=!1,h=E.executionContext?E.executionContext.getComponent("Viewer"):a.get();r.init(h,{executionContext:E.executionContext});let v=new o({context:h}),D=e.getBoxController({context:h}),T=m.getExamineController({context:h}),y=s.getMoveManager({context:h,saveToDatabase:!!E.executionContext||void 0}),I=d.getSelectionManager({context:h}),R=c.getDefaultSelectionFilter({context:h}),x=l.getMove3DRobot({context:h}),P=[],b=[],M={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},N={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3},w=!0;function L(){if(A.isRunning()){var e=t.give3DGridController({context:h});e&&e.hide3DGrids(),A&&A.isRunning()&&(R&&R.activate(),I&&I.setActiveState(!1)),D&&D.setActiveState(!1)}}function F(){if(A.isRunning()){var e=t.give3DGridController({context:h});e&&e.display3DGrids(),A&&A.isRunning()&&R&&!x.hasTarget()&&(R.deactivate(),I&&I.setActiveState(!0)),D&&D.setActiveState(!0)}}g||require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(e){g=e,A.isRunning()&&(g.activate({context:h,withSnap:!0,selectionFilter:R}),g.give().setAllowManipulation(w),b.length||(b.push(g.subscribe("onDirectMoveBegin",L)),b.push(g.subscribe("onDirectMoveEnd",F))))}),x.setSelectionFilter(R),R.deactivate(),P.push(x.subscribe("onRobotMoveBegin",function(){A.isRunning()&&(A&&A.isRunning()&&(R&&R.activate(),I&&I.setActiveState(!1)),D&&D.setActiveState(!1))})),P.push(x.subscribe("onRobotMoveEnd",F));var _=[];function O(){_.length>0||(_.push(y.subscribe("MoveBegin",function(){T&&T.setActiveState(!1)})),_.push(y.subscribe("Move",function(){var e=i.giveDataLauncherController({context:h});e&&e.setVisibility(!1)})),_.push(y.subscribe("MoveEnd",function(){var e=i.giveDataLauncherController({context:h});e&&e.setVisibility(!0),T&&T.setActiveState(!0)})))}function U(){_.forEach(function(e){y.unsubscribe(e)}),_=[]}var W=u.getPreferenceManager({context:h.getFrameWindow()}),G=[];function k(e){A&&e.forEach(function(e){if("W3MprefMove"===e.name)e.preferences.forEach(function(e){if("C3DAllowDirectManipulation"===e.name){let t=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),n=h.getController&&h.getController().hasAnyEffectiveFlexibleAssembly(),i=require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration");w=!(t&&n&&i)&&"true"===e.value,g&&g.give().setAllowManipulation(w)}else"defaultMoveReferent"===e.name&&(n.setMoveReferentDefault(e.value),D&&D.refreshBoxes(!0))});else if("FrameGeneral"===e.name)e.preferences.forEach(function(e){if("ProjectionType"===e.name){var t="Perspective"===e.value?0:1;let n=h?h.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}});else if("VisualizationRepository"===e.name)e.preferences.forEach(function(e){if("Gravity"===e.name){var t="true"===e.value;let n=h?h.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}});else if("SelectionRepository"===e.name)e.preferences.forEach(function(e){if("Select3DGeometry"===e.name){var t=!!R&&R.isActive();t&&R.deactivate(),I.setPicking("true"===e.value?0:1),t&&R.activate()}else"SelectParentReferenceOr3DShape"===e.name&&I&&I.selectParentReference("select3DShape"!==e.value)});else if("cke"===e.name){let t=!1,n=!1;e.preferences.forEach(function(e){"Length"===e.name?(M.unit=e.value,t=!0):"LengthCalcDisplay"===e.name?(M.decimalPlaceRO=parseInt(e.value),t=!0):"Angle"===e.name?(N.unit=e.value,n=!0):"AngleCalcDisplay"===e.name&&(N.decimalPlaceRO=parseInt(e.value),n=!0)}),t&&x.setLengthUnit(M),n&&x.setAngleUnit(N)}})}W.addPreferences(n.getPreferencesDefinition()),W.setUnitsPreferencesDisplayFlag(!0),W.setDisplayPreferencesDisplayFlag(!0),W.set3DSelectionPreferencesDisplayFlag(!0),W.setMeasurePreferencesDisplayFlag(!0),W.setClippingPreferencesDisplayFlag(!0),W.setPreferredPreferenceContainersOrder(["W3MprefMove","MeasurePreferences","SectionPreferences"]),G.push(W.subscribe("com.ds.mep:onPrefUpdate",function(e){k(JSON.parse(e[1].preferences).repositories)})),h.getViewer().currentViewpoint.getControl().setRotationRolling(!0),h.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!0),h.getViewer().currentViewpoint.setProjectionType(0),I.setPicking(1),I.selectParentReference(!1),C.readPreferences([{Repository:"W3MprefMove",PreferenceNames:["C3DAllowDirectManipulation","defaultMoveReferent"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Angle","AngleCalcDisplay"]}]).then(function(e){k(e.repositories)}).catch(function(e){window.console.warn("Error Preferences ",e)}),h.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"CATAnnotationsContextMenu",context:h.getCommandContext(),merge:!0,onContextualMenuReady:function(e,t){var n=[],i=[],o=[];if(h._defaultContextualMenuVisibility&&void 0!==e&&void 0!==e.XmousePositionWithDevPxRatio&&void 0!==e.YmousePositionWithDevPxRatio&&h.getViewer()){var a=S.get(),r=t?{x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio}:{x:e.XmousePositionWithDevPxRatio,y:e.YmousePositionWithDevPxRatio};if(0===h.getViewer().pick({xPix:r.x,yPix:r.y},"mesh",!0).path.length)o.push({category:"Display",hdrs:p.isMobile()?["ENO3DToggleStatusBarCmd"]:["VisuQMCommand","ENO3DToggleStatusBarCmd"]},{category:"Ambience",hdrs:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]});else if(a.length){let e=!1;for(let t=0;t<a.length;t++)for(var s=0;s<a[t].pathElement.externalPath.length;s++)a[t].pathElement.externalPath[s].getDMUType&&(e=!0);e||(i.push("ENO3DFocusOnCmd"),i.push("ENO3DReframeOnCmd"),i.push("ENO3DHideShowCmd"),i.push("ActionBar_Attributes"),o.push({category:"Geometry Quality",hdrs:["OptimizedQualityCmd","HighQualityCmd"]}))}for(let e=0;e<i.length;e++)"ENO3DToggleStatusBarCmd"===i[e]?n.push({type:"WAfrCheckHandlerItem",handlerId:i[e]}):n.push({type:"WAfrDefaultHandlerItem",handlerId:i[e]});return o.forEach(e=>{let t={type:"PushItem",title:e.category,submenu:[]};for(let n=0;n<e.hdrs.length;n++)"ENO3DToggleStatusBarCmd"===e.hdrs[n]?t.submenu.push({type:"WAfrCheckHandlerItem",handlerId:e.hdrs[n]}):t.submenu.push({type:"WAfrDefaultHandlerItem",handlerId:e.hdrs[n]});n.push(t)}),n}return n}}),this.beginExecute=function(){h&&(I.setActiveState(!0),h.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),function(){if(h&&!f){v.activate(),D.setActiveState(!0);var e=i.giveDataLauncherController({context:h});e&&e.setActiveState(!0),g&&g.activate({context:h,withSnap:!0,selectionFilter:R}),R&&R.deactivate(),T&&T.setActiveState(!0),O()}}())},this.destroy=function(){if(h){v.deactivate(),D.setActiveState(!1);var e=i.giveDataLauncherController({context:h});e&&e.setActiveState(!1),g&&g.deactivate({context:h}),I.setActiveState(!1),T&&T.setActiveState(!1),U()}},this.pauseExecute=function(){v.deactivate(),D.setActiveState(!1);var e=i.giveDataLauncherController({context:h});e&&e.setActiveState(!1),g&&g.deactivate({context:h}),R&&R.deactivate(),I.setActiveState(!1),T&&T.setActiveState(!1),U(),this.done()},this.resumeExecute=function(){if(h){R&&x.hasTarget()?(R.activate(),I.setActiveState(!1)):I.setActiveState(!0),h.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0}),v.activate(),D.setActiveState(!0);var e=i.giveDataLauncherController({context:h});e&&e.setActiveState(!0),g&&g.activate({context:h,withSnap:!0,selectionFilter:R}),T&&T.setActiveState(!0),O(),this.done()}},this.getRequestedCommandMode=function(e){return"Measure"===e.cmd||"Section"===e.cmd?"shared":void 0},this.allowManipulation=function(e){return"Measure"===e.object||"Section"===e.object||void 0},this.isRunning=function(){let e,t,n;return(e=h.getExecutionContext?h.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent):void 0)&&(n=e.getDefaultCommand(),t=null===e.getRunningCommand()?n:e.getRunningCommand()),t===n},this._destroy=function(){U(),P.forEach(x.unsubscribe,x),b.forEach(x.unsubscribe,b),g&&(b.forEach(g.unsubscribe,b),g.unreference({context:h})),f=!0,G.forEach(W.unsubscribe,W),c.unreferenceDefaultSelectionFilter({context:h}),d.unreferenceSelectionManager({context:h}),m.unregisterExamineController({context:h}),Object.getPrototypeOf(this)._destroy.apply(this,arguments),A=R=h=v=D=y=x=W=G=I=null}}}}),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter",["DS/StateCommandEngine/PathElementAgent","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/WebappsUtils/WebappsUtils","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(e,t,n,i,o,a,r,s,c){"use strict";var l;return e.extend({_frameWindow:null,_filterUI:null,_activeFilters:null,_filtersEnum:null,_postFilter:null,_axisAgent:null,geometryTypesEnum:{POINT:n.GeometryType.POINT,LINE:n.GeometryType.LINE,CIRCLE:n.GeometryType.CIRCLE,PLANE:n.GeometryType.PLANE,CYLINDER:n.GeometryType.CYLINDER,CONE:n.GeometryType.CONE,SPHERE:n.GeometryType.SPHERE,REFERENCE:10,AXISSYSTEM:n.GeometryType.AXISSYSTEM,AXISSYSTEMAXIS:n.GeometryType.AXISSYSTEMAXIS,AXISSYSTEMORIGIN:n.GeometryType.AXISSYSTEMORIGIN},init:function(e){var i,r=a.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),u=a.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");return this._preselection=!0,l=this,e.context?(this._frameWindow=e.context.getFrameWindow(),this._axisAgent=new o({context:e.context}),this._activeFilters=e.activeFilters||{POINT:1,CENTER:1,CIRCLE:1,AXISSYSTEM:1,AXISSYSTEMAXIS:1,AXISSYSTEMORIGIN:1,LINE:1,PLANE:1,CYLINDER:1,REFERENCE:1},this._postFilter=e.postFilter,this._filtersEnum={POINT:{type:"element",id:"POINT",nls:c.point,url:r+"I_Meas_Point.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.POINT},CENTER:{type:"element",id:"CENTER",nls:c.center,url:r+"I_Meas_PointCircle.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.CENTER},CIRCLE:{type:"element",id:"CIRCLE",nls:c.circle,url:r+"I_WebMarkerCircle.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.CIRCLE},AXISSYSTEM:{type:"element",id:"AXISSYSTEM",nls:c.axisSystem,url:u+"I_3DComposeAxisSystem.png",callback:function(){l._lastClicked="AXISSYSTEM",l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.AXISSYSTEM},AXISSYSTEMAXIS:{type:"element",id:"AXISSYSTEMAXIS",nls:c.axisSystemAxis,url:u+"I_C3DAxisAxis.png",callback:function(){l._lastClicked="AXISSYSTEMAXIS",l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.AXISSYSTEMAXIS},AXISSYSTEMORIGIN:{type:"element",id:"AXISSYSTEMORIGIN",nls:c.axisSystemOrigin,url:u+"I_C3DAxisOrigin.png",callback:function(){l._lastClicked="AXISSYSTEMORIGIN",l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.AXISSYSTEMORIGIN},LINE:{type:"element",id:"LINE",nls:c.line,url:r+"I_Meas_Line.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.LINE},PLANE:{type:"element",id:"PLANE",nls:c.plane,url:r+"I_Meas_Plane.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.PLANE},CYLINDER:{type:"element",id:"CYLINDER",nls:c.cylinder,url:r+"I_Meas_Cylinder.png",callback:function(){l.updateFilters()},bexclude:!1,bstateActif:l._activeFilters.CYLINDER},REFERENCE:{type:"element",id:"REFERENCE",nls:c.reference,url:r+"I_Meas_Product.png",callback:function(){l.updateFilters()},bexclude:!0,bstateActif:l._activeFilters.REFERENCE}},(i={agentId:"CAT3DComposeAssemblyPatternSelect",frameWindow:this._frameWindow,withPrevaluation:!1,engWithPSOHSO:!1,withPSO:!0,withHSO:!1,valuedFromCSO:!1,saveToCSO:!1,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",withUndoStep:!1}).prePickingFilter=i.pickingFilter=function(i){var o,a,r=!1,c=0,u=t.getEquivalentGeometry({pathElement:i,axisSystemSub:!l._activeFilters.AXISSYSTEM,axisSystemOrigin:!l._activeFilters.AXISSYSTEMORIGIN,viewer:e.context.getViewer()}),C=u?u.getType():null;if((l._activeFilters.AXISSYSTEM||l._activeFilters.AXISSYSTEMAXIS||l._activeFilters.AXISSYSTEMORIGIN)&&l._axisAgent.analyze({pathElement:i}),(1===l._activeFilters.AXISSYSTEM&&C===l.geometryTypesEnum.AXISSYSTEM||1===l._activeFilters.AXISSYSTEMAXIS&&C===l.geometryTypesEnum.AXISSYSTEMAXIS||1===l._activeFilters.AXISSYSTEMORIGIN&&C===l.geometryTypesEnum.AXISSYSTEMORIGIN)&&(u&&(a=u.getPathElement())&&(i.internalPath=a.internalPath,i.externalPath=a.externalPath),r=!0),!r&&(1===l._activeFilters.POINT&&C===l.geometryTypesEnum.POINT||1===l._activeFilters.CENTER&&(C===l.geometryTypesEnum.CIRCLE||C===l.geometryTypesEnum.SPHERE)||1===l._activeFilters.CIRCLE&&C===l.geometryTypesEnum.CIRCLE||1===l._activeFilters.LINE&&C===l.geometryTypesEnum.LINE||1===l._activeFilters.PLANE&&(C===l.geometryTypesEnum.PLANE||n.GeometryType.REFPLANE)||1===l._activeFilters.CYLINDER&&(C===l.geometryTypesEnum.CYLINDER||C===l.geometryTypesEnum.CONE))&&(r=!0),!r&&1===l._activeFilters.REFERENCE)for(c=i.externalPath.length-1;c>=0;--c)if((o=i.externalPath[c])&&s.isReference(o)){i.setFromArray(i.externalPath.slice(0,c+1)),r=!0;break}return r&&"function"==typeof l._postFilter&&(r=l._postFilter(i)),r},this._parent(i),this.updateFilters(),null):null},activate:function(){var e=r.get();this._parent(),this._preselection&&e.length>0&&(this._preselection=!1,this.object3D=[],this.options.pickingFilter(e[0].pathElement)&&(this.object3D.push(e[0]),this._modelEvents.publish({event:this._agentId,data:this.object3D}))),this.updateFilters()},deactivate:function(){this._filterUI&&(this._filterUI.clear(),this._filterUI.destroy(),this._filterUI=null),l._axisAgent.deactivate(),this._parent()},getSelType:function(e){var n=t.getEquivalentGeometry({pathElement:e,axisSystemSub:!l._activeFilters.AXISSYSTEM}),i=n?n.getType():null;return e&&e.externalPath&&s.isAModelPath(e)?!i&&0===e.internalPath.length&&e.externalPath.some(function(e){return e&&s.isReference(e)})?this.geometryTypesEnum.REFERENCE:"number"==typeof i?i:null:null},getActiveFilters:function(){return this._activeFilters},updateFilters:function(e,t){var n,o,a,r=!1,s=[];if("boolean"!=typeof t&&(t=!0),e&&"object"==typeof e){for(n in l._activeFilters={},e)e.hasOwnProperty(n)&&l._filtersEnum.hasOwnProperty(n)&&(l._activeFilters[n]=e[n],1!==l._activeFilters[n]&&(l._activeFilters[n]=0));r=!0}if(l._filterUI&&t)for(o in l._activeFilters)l._activeFilters.hasOwnProperty(o)&&(l._activeFilters[o]=l._filterUI.getActiveState(o)?1:0);if(l._lastClicked&&1===l._activeFilters[l._lastClicked]&&(l._activeFilters.AXISSYSTEM&&(l._activeFilters.AXISSYSTEM=0),l._activeFilters.AXISSYSTEMAXIS&&(l._activeFilters.AXISSYSTEMAXIS=0),l._activeFilters.AXISSYSTEMORIGIN&&(l._activeFilters.AXISSYSTEMORIGIN=0),l._activeFilters[l._lastClicked]=1,r=!0),l._lastClicked=null,l._activeFilters.AXISSYSTEM||l._activeFilters.AXISSYSTEMAXIS||l._activeFilters.AXISSYSTEMORIGIN?l._axisAgent.activate({type:"HSO",noPSOcb:!0}):l._axisAgent.deactivate(),r&&l._filterUI&&(l._filterUI.clear(),l._filterUI.destroy(),l._filterUI=null),!l._filterUI){for(o in l._activeFilters)l._activeFilters.hasOwnProperty(o)&&l._filtersEnum.hasOwnProperty(o)&&((a=l._filtersEnum[o]).bstateActif=l._activeFilters[o],s.push(a));l._filterUI=new i({body:l._frameWindow.getUIFrame(),frmWindow:l._frameWindow,Idpanel:"c3dPatternSelectionFilter",typeSeparator:"bubble",lJsonElement:s}),l._filterUI.build(),l._viewer.render()}}})}),
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeAssemblyPatternCmd",["DS/CATWebUXComponents/DMUStateCommand","DS/CoreEvents/Events","DS/CATWebUXComponents/CATWebUXNotifBar","DS/FlagPanel/FlagPanel","DS/FlagPanel/FlagPanelEnums","DS/FlagPanel/FlagPanelManager","DS/PADUtils/PADContext","DS/CATW3DGeometry/CATW3DEquivalentGeometry","DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter","DS/Selection/HSOManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUtils/CATC3DUtils","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CATW3DAnims/CATW3DAnimation3D","DS/Mesh/Mesh","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeAssemblyPatternCmd","css!DS/UIKIT/UIKIT"],function(e,t,n,i,o,a,r,s,c,l,u,C,d,m,S,p,g,E,A,f){"use strict";return e.extend({init:function(e){var h,v,D,T,y,I,R,x,P,b,M=this,N=0,w=r.get(),L=w.getFrameWindow(),F=w.getViewer(),_=!1,O=!1,U={},W={},G="NOPATTERN",k=!0,X="LINEAR",V="LINEAR",Y={count:2,spacing:50,angle:30,reverse:!1},B={count:2,spacing:50,angle:30,reverse:!1},H={NOPATTERN:{REFERENCE:1,POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0},NOPATTERN_LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_RECTANGULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_CIRCULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1},LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},RECTANGULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},CIRCULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1}},j={NOPATTERN:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEM","AXISSYSTEMORIGIN","AXISSYSTEMAXIS","REFERENCE"],NOPATTERN_LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_RECTANGULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_CIRCULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_USERDEFINED:["POINT","CENTER","AXISSYSTEM"],LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],RECTANGULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],CIRCULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],USERDEFINED:["POINT","CENTER","AXISSYSTEM"]},q=function(e){return e===R.geometryTypesEnum.POINT||e===R.geometryTypesEnum.CIRCLE||e===R.geometryTypesEnum.AXISSYSTEM||e===R.geometryTypesEnum.AXISSYSTEMORIGIN},K=function(){var e={version:3,reuse:k,radioPattern:V,direction1:Y,direction2:B,filters:H};e.reuse=!0,localStorage.setItem("CAT3DComposeAssemblyPatternCmd",JSON.stringify(e))},z=function(e,n,i,o){var a;i=void 0===i||i,o=void 0===o||o,P.removeFlag(v[e]),v[e].destroy(),delete v[e],e!==O&&o&&delete U[e],e===T?(T=null,y&&(Y.count=B.count,Y.spacing=B.spacing,Y.reverse=B.reverse,v[y].destroy(),delete v[y],T=y,y=null)):e===y?y=null:e===_&&(n&&"NOPATTERN"===n&&(a="NOPATTERN",O&&(a=a+"_"+V),H[a]=R.getActiveFilters(),G=null),F.removeNode(I),_=null),R.object3D[0]=null,i&&t.publish({event:"C3D_UNSELECT_EVT"})},J=function(e){var t,n,i,o,a,r,s=0,c=function(e){var t,n,i={bReference:Boolean(O),bOrigin:Boolean(_),typesCount:{}};for(t in R.geometryTypesEnum)R.geometryTypesEnum.hasOwnProperty(t)&&(i.typesCount[R.geometryTypesEnum[t]]=0);for(t in U)U.hasOwnProperty(t)&&t!==_&&t!==O&&i.typesCount[U[t].type]++;return R.object3D[0]&&!U[R.object3D[0].pathElement.getKey()]&&(n=R.getSelType(R.object3D[0].pathElement),O||n!==R.geometryTypesEnum.REFERENCE?!_&&q(n)?i.bOrigin=!0:!_&&e!==x.USERDEFINED.id&&q(n)||i.typesCount[n]++:i.bReference=!0),i}(e.stateID);if(!c||!c.bReference)return!1;for(s=0,a=(o=Object.keys(c.typesCount)).length,i=e.validTypes.length,t=0;t<a;++t)if(c.typesCount[o[t]]>0){for(r=!1,n=0;n<i;++n)if(o[t]===e.validTypes[n].type.toString()&&!(e.validTypes[n].maxcount&&c.typesCount[o[t]]>e.validTypes[n].maxcount)){s+=c.typesCount[o[t]],r=!0;break}if(!r)return!1}return e.stateID===x.USERDEFINED.id&&c.bOrigin&&s++,e.stateID===x.CIRCULAR.id&&c.bOrigin&&0===s&&s++,e.validSelCount>-1&&s===e.validSelCount||-1===e.validSelCount&&s>0},Z=function(e,t,n){var i=new u.Vector3;return e.type===R.geometryTypesEnum.POINT?i.subVectors(e.canonicGeom.getPoint(),t.position):e.type===R.geometryTypesEnum.LINE?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===R.geometryTypesEnum.CIRCLE?i.subVectors(e.canonicGeom.getCenter(),t.position):e.type===R.geometryTypesEnum.CYLINDER?i.subVectors(e.canonicGeom.getEndPoints().endPoint,e.canonicGeom.getEndPoints().beginPoint):e.type===R.geometryTypesEnum.AXISSYSTEM||e.type===R.geometryTypesEnum.AXISSYSTEMORIGIN?i.subVectors(e.position,t.position):e.type===R.geometryTypesEnum.AXISSYSTEMAXIS&&(i=e.canonicGeom.getDirection()),n?i.normalize():i},Q=function(e){var t,n,i;if(!e.getParentPath)return null;for(i=(n=e.getParentPath().clone()).getLength()-1;i>=0;--i)if((t=n.externalPath[i])&&A.isReference(t))return n.setFromArray(n.externalPath.slice(0,i+1)),n;return null},$=function(e){W.hasOwnProperty(e)&&(W[e].pRefParent.getLastElement().removeChild(W[e].node),delete W[e],N--),F.render()},ee=function(){var e;if(W)for(e in W)W.hasOwnProperty(e)&&$(e)},te=function(e,t,n){var i,o,a,r,s;return a=t.clone(),(s=t.getWorldMatrix()).getInverse(s),(i=new u.Matrix4).multiplyMatrices(s,n),(o=new C("PreviewNode"+ ++N)).setMatrix(i),o.addChild(e.pathElement.getLastElement()),t.getLastElement().addChild(o),a.addElement(o),r=a.getKey(),W[r]={node:o,activated:!0,pathElement:a,pRefParent:t},r},ne=function(e,t,n){var o={position:(new u.Matrix4).setPosition(U[e].position),iconUrl:U[e].iconUrl?U[e].iconUrl:"",closeButton:!0,closeCB:function(){z(e,n)}};v[e]=new i(F,o),t&&v[e].setOffset(t),P.addFlag(v[e])},ie=function(e,n,a,r,s){var c={position:U[n].clickPos?(new u.Matrix4).setPosition(U[n].clickPos):new u.Matrix4,label:a,iconUrl:U[n].iconUrl?U[n].iconUrl:"",closeButton:!0,closeCB:function(){z(n,e)},dialogs:[{type:o.fieldsTypeEnum.INTEGER,value:r.count,suffix:f.SUFFIX_INSTANCES,fnCallback:function(e){r.count=parseInt(e),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.DOUBLE,prefix:f.PREFIX_SPACING,value:"CIRCULAR"===e?r.angle:r.spacing,suffix:"CIRCULAR"===e?"":"mm",fnCallback:function(n){"CIRCULAR"===e?r.angle=parseInt(n):r.spacing=parseInt(n),t.publish({event:"C3D_PARAMETERS_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReverseDirection.png",value:r.reverse,fnCallback:function(e){r.reverse=e,t.publish({event:"C3D_PARAMETERS_CHG"})}}]};v[n]=new i(F,c),s&&v[n].setOffset(s),P.addFlag(v[n])},oe=function(e){var n,a,r,s,c,l,C,d,m,A,h,D,b="NOPATTERN"===e?V:e,M={};for(a in v)v.hasOwnProperty(a)&&(M[a]=v[a].getOffset(),P.removeFlag(v[a]),v[a].destroy(),delete v[a]);if(I&&F.removeNode(I),O){for(l=function(){var e,t=[];for(e in x)(x[e].conditions&&J(x[e].conditions)||O&&_&&2===Object.keys(U).length&&-1!==["LINEAR","CIRCULAR","USERDEFINED"].indexOf(e))&&t.push(e);return 0===t.length&&(t=["LINEAR","CIRCULAR","USERDEFINED"]),t}(),n=[{value:b,iconUrl:x[b].iconUrl,label:f["LABEL_"+b],isdefault:!0}],c=l.length||0,s=0;s<c;++s)l[s]!==b&&n.push({value:l[s],iconUrl:x[l[s]].iconUrl,label:f["LABEL_"+l[s]]});C={position:U[O].clickPos?(new u.Matrix4).setPosition(U[O].clickPos):(new u.Matrix4).setPosition(U[O].position),label:f.FLAG_REF_LABEL,iconUrl:U[O].iconUrl?U[O].iconUrl:"",closeButton:!0,closeCB:function(){P.removeFlag(v[O+"ref"]),v[O+"ref"].destroy(),delete v[O+"ref"],O!==_&&delete U[O],"NOPATTERN"===e&&(d="NOPATTERN",O&&(d=d+"_"+V),H[d]=R.getActiveFilters(),G=null),O=null,R.object3D[0]=null,t.publish({event:"C3D_UNSELECT_EVT"})},dialogs:[{type:o.fieldsTypeEnum.RADIO,radios:n,fnCallback:function(e){X=V,oe(V=e),t.publish({event:"C3D_PATTERN_CHG"})}},{type:o.fieldsTypeEnum.BOOLEAN,iconUrl:S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReuse.png",value:k}]},v[O+"ref"]=new i(F,C),v[O+"ref"].setOffset(M[O+"ref"]),(m=v[O+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1]).style.width=0,m.style.border=0,m.style.padding=0,m.style.margin=0,P.addFlag(v[O+"ref"])}if(O&&v[O+"ref"]&&O!==_?v[O+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].removeClassName("hidden"):O&&v[O+"ref"]&&v[O+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].addClassName("hidden"),_&&e!==x.USERDEFINED.id&&b!==x.USERDEFINED.id&&(A=U[_].worldMatrix.clone().setPosition(U[_].position),h=g.getAnimation3DEngine({viewer:F}),(D=new p({headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new E.Color(.25,.63,.85,1),colorY:new E.Color(.25,.63,.85,1),colorZ:new E.Color(.25,.63,.85,1)},head:p.types.ARROW})).exludeFromBounding(!0),D.setVisibilityInTree(!1),D.setPickable(E.PICKTHROUGH),D.setMatrix(A),F.addNode(D),h.axisSystemVisibility({objectListToAnimate:[D],visibility:!0,pickability:!1}),h.startAnimation(),I=D,e!==x.CIRCULAR.id||T||y?(C={position:(new u.Matrix4).setPosition(U[_].position),label:f.FLAG_ORIGIN_LABEL,iconUrl:U[_].iconUrl?U[_].iconUrl:"",closeButton:!0,closeCB:function(){z(_,e)}},_===O&&(C.offset=new u.Vector2(0,50)),v[_]=new i(F,C),v[_].setOffset(M[_]),P.addFlag(v[_])):ie(e,_,f.LABEL_AXIS,Y,M[_])),e===x.USERDEFINED.id||b===x.USERDEFINED.id)for(r in U)U.hasOwnProperty(r)&&r!==O&&ne(r,M[r],e);else T&&ie(e,T,f.LABEL_DIR1,Y,M[T]),y&&ie(e,y,f.LABEL_DIR2,B,M[y])},ae=function(e){var t,n,i,o,a,r,s,c,l,C,m,S,p,g,E,A,f,h,v,I,P=[],b=F.getSceneGraphOverrideSetManager();for(t in D&&(b.removeSceneGraphOverrideSet(D),D=null),D=new d(w.getRootBagPath().externalPath[0]),W)W.hasOwnProperty(t)&&$(t);if(O)switch(P.push(U[O].pathElement),i=_&&U.hasOwnProperty(_)?U[_]:null,"USERDEFINED"!==e&&"USERDEFINED"!==V&&(_&&(s=_),T&&(g=Z(U[T],i,!0),s=T,f=g.clone().setLength((Y.reverse?-1:1)*Y.spacing),E=(new u.Matrix4).makeTranslation(f.x,f.y,f.z)),y&&(f=Z(U[y],i,!0).clone().setLength((B.reverse?-1:1)*B.spacing),A=(new u.Matrix4).makeTranslation(f.x,f.y,f.z))),p=U[O],(S=(m=Q(p.pathElement)).getWorldMatrix()).getInverse(S),h=k?p.worldMatrix.clone().setPosition(p.position):p.worldMatrix.clone().setPosition(i.position),e){case x.LINEAR.id:if(T)for(o=0;o<Y.count;++o)(0!==o||k)&&o>0&&(h=E.clone().multiply(h),v=te(p,m,h),P.push(W[v].pathElement));break;case x.RECTANGULAR.id:if(T&&y)for(C=h.clone(),l=0;l<B.count;++l)for(l>0&&(C=A.clone().multiply(C)),h=C.clone(),o=0;o<Y.count;++o)0===o&&(l>0||!k)?(v=te(p,m,h),P.push(W[v].pathElement)):o>0&&(h=E.clone().multiply(h),v=te(p,m,h),P.push(W[v].pathElement));break;case x.CIRCULAR.id:if(s)for(r=g||U[s].canonicGeom.getNormal().clone(),n=(new u.Matrix4).makeRotationAxis(r,(Y.reverse?-1:1)*Y.angle*Math.PI/180),c=(new u.Matrix4).setPosition(U[s].position),o=0;o<Y.count;++o)(0!==o||k)&&o>0&&(h=c.clone().multiply(n.clone().multiply((new u.Matrix4).getInverse(c).multiply(h))),v=te(p,m,h),P.push(W[v].pathElement));break;case x.USERDEFINED.id:for(a in U)U.hasOwnProperty(a)&&a!==O&&(h=U[a].type===R.geometryTypesEnum.AXISSYSTEM?U[a].worldMatrix.clone():p.worldMatrix.clone().setPosition(U[a].position),v=te(p,m,h),P.push(W[v].pathElement))}D&&((I=D.createOverride({pathes:P}))&&(I.setOpacity(.5),I.setPickability("IGNORED")),b.pushSceneGraphOverrideSet(D))},re=function(){var e;for(e in l.empty(),U)U.hasOwnProperty(e)&&l.add(U[e]);for(e in W)W.hasOwnProperty(e)&&l.add(W[e])},se=function(e){_=e},ce=function(e){var t,n,i,o,a=e;for(G&&(H[G]=R.getActiveFilters()),O&&a===x.NOPATTERN.id&&(a=a+"_"+V),o=H[a],O&&o.REFERENCE&&delete o.REFERENCE,n=0,i=j[a].length;n<i;++n)o.hasOwnProperty(j[a][n])||(o[j[a][n]]=0);for(t in o)o.hasOwnProperty(t)&&-1===j[a].indexOf(t)&&delete o[t];e===x.CIRCULAR.id&&T&&(o={}),R.updateFilters(o,!1)},le=function(e){var t,n=Object.keys(U),i=n.length;for(_||(y&&q(U[y].type)&&z(y,e,!1,!1),T&&q(U[T].type)&&z(T,e,!1,!1)),t=0;t<i;++t)if(q(U[n[t]].type)){if(!_&&n[t]!==T&&n[t]!==y){se(n[t]);continue}if(!T&&n[t]!==_&&n[t]!==y){T=n[t];continue}if(!y&&n[t]!==T&&n[t]!==_){y=n[t];continue}}oe(e)},ue=function(e,n,i){var o,a,r,c,l,C,d=null,m=new u.Vector3;R.object3D[0]&&R.object3D[0].pathElement&&(d=R.object3D[0].pathElement),d&&!U[d.getKey()]&&(r=(o=s.getEquivalentGeometry({pathElement:d,axisSystemSub:!0,viewer:F}))?o.getType():R.geometryTypesEnum.REFERENCE,c=d.getWorldMatrix(),a=d.getKey(),r===R.geometryTypesEnum.REFERENCE||r===R.geometryTypesEnum.AXISSYSTEM||r===R.geometryTypesEnum.AXISSYSTEMAXIS?m.getPositionFromMatrix(c):m=function(e){var t=null,n=e.getType();if(void 0===n)return null;switch(n){case R.geometryTypesEnum.POINT:t=e.getPoint();break;case R.geometryTypesEnum.LINE:case R.geometryTypesEnum.CYLINDER:t=e.getEndPoints().beginPoint;break;case R.geometryTypesEnum.CIRCLE:case R.geometryTypesEnum.CENTER:t=e.getCenter()}return t}(o),U[a]={pathElement:d,type:r,worldMatrix:c,position:m,clickPos:R.object3D[0].position,canonicGeom:o,iconUrl:function(e){var t=null,n=S.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),i=S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");switch(e){case R.geometryTypesEnum.POINT:t=n+"I_Meas_Point.png";break;case R.geometryTypesEnum.CENTER:case R.geometryTypesEnum.CIRCLE:t=n+"I_Meas_PointCircle.png";break;case R.geometryTypesEnum.AXISSYSTEM:t=i+"I_3DComposeAxisSystem.png";break;case R.geometryTypesEnum.AXISSYSTEMORIGIN:t=i+"I_C3DAxisOrigin.png";break;case R.geometryTypesEnum.AXISSYSTEMAXIS:t=i+"I_C3DAxisAxis.png";break;case R.geometryTypesEnum.PLANE:t=n+"I_Meas_Plane.png";break;case R.geometryTypesEnum.CYLINDER:t=n+"I_Meas_Cylinder.png";break;case R.geometryTypesEnum.LINE:t=n+"I_Meas_Line.png"}return t}(r)},r===R.geometryTypesEnum.AXISSYSTEM&&(U[a].clickPos=m),O||r!==R.geometryTypesEnum.REFERENCE?!_&&e.id!==x.USERDEFINED.id&&q(r)?se(a):a!==_&&a!==O&&(T?y||(y=a,!_||r!==R.geometryTypesEnum.POINT&&r!==R.geometryTypesEnum.CIRCLE&&r!==R.geometryTypesEnum.AXISSYSTEM||(B.spacing=Math.round(1e3*U[_].position.distanceTo(m))/1e3)):(T=a,!_||r!==R.geometryTypesEnum.POINT&&r!==R.geometryTypesEnum.CIRCLE&&r!==R.geometryTypesEnum.AXISSYSTEMORIGIN||(Y.spacing=Math.round(1e3*U[_].position.distanceTo(m))/1e3))):(l=a,C=A.getNodeID(U[l].pathElement.getLastElement(!0)),O=l,U[l].iconUrl="",w.getController().getAttributes({ids:[C],attributes:["type_icon_url"],callbacks:{onComplete:function(e){U[l].iconUrl=e[C]?e[C].type_icon_url:"",v[l+"ref"]&&v[l+"ref"].setIcon(U[l].iconUrl)},onFailure:function(){}}})),R.object3D=[]),oe(e.id),ce(e.id),K(),ae(e.id),e.id!==x.NOPATTERN.id?h.removeAll(function(){h.add({message:f["LABEL_"+e.id],closable:!1,buttons:[{label:f.SAVEBTN,className:"primary",onClick:function(){t.publish({event:"C3D_SAVE_CLICK"})},doClose:!0},{label:f.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})}):h.removeAll(function(){var n=0;O&&(n=1),h.add({message:f["LABEL_"+e.id+"_"+n],closable:!1,buttons:[{label:f.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]})}),i(),re()},Ce=function(e,t,n){ae(e.id),ce(e.id),K(),n(),re()},de=function(){return!!O||(h.add({message:f.NOREFERROR,msgType:"warning",autoHide:!0,closable:!0}),!1)},me=function(){var e;for(e in K(),l.empty(),_=null,O=null,T=null,y=null,W&&ee(),D&&(F.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(D),D=null),F.setDefaultPicking(!0),R&&R.deactivate(),ee(),h&&(h.destroy(),h=null),I&&F.removeNode(I),v)v.hasOwnProperty(e)&&(P.removeFlag(v[e]),v[e].destroy(),delete v[e]);v.length=0,M.end?M.end():M.done()},Se=function(e){var t,n,i,o=F,a={context:w,parentID:null,children:[],onCompleted:function(t){var n=t.length||0;if(0===n)return me(),void e();t.forEach(function(t){n--,!t.instID&&t.message&&h.add({message:t.message,msgType:"error",autoHide:!0,closable:!0}),0===n&&(me(),e())})}};if(W&&U){for(t in n=U[O],i=A.getNodeID(n.pathElement.getLastElement()),a.parentID=A.getNodeID(Q(n.pathElement).getLastElement()),W)W.hasOwnProperty(t)&&W[t].activated&&a.children.push({id:i,matrix:W[t].pathElement.getMatrix(o)});m.insertExisting(a)}},pe=function(e){me(),e()};this.buildGraph=function(){P||(P=new a(F)),_=null,O=null,T=null,y=null,U={},h=(new n).inject(L.getUIFrame()),v=[],l.isEmpty()&&h.add({message:f.LABEL_NOPATTERN_0,closable:!1,buttons:[{label:f.CANCELBTN,className:"default",onClick:function(){t.publish({event:"C3D_CANCEL_CLICK"})},doClose:!0}]}),F.setDefaultPicking(!1);var e=S.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),i=this.createInitialState("NoPatternState"),o=this.createState("LinearState"),r=this.createState("RectangularState"),s=this.createState("CircularState"),u=this.createState("UserDefineState"),C=this.getFinalState(),d=H.NOPATTERN;O||(d={POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0,REFERENCE:1}),R=new c({context:w,activeFilters:d,postFilter:function(e){var t=A.getRoots(w);return!!A.isAModelPath(e)&&(!Array.isArray(t)||-1===t.indexOf(e.getLastElement()))}}),x={NOPATTERN:{id:"NOPATTERN",iconUrl:"",chkConditions:function(){return!0},actions:function(e){ue(x.NOPATTERN,0,e)}},LINEAR:{id:"LINEAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return("LINEAR"===V||"RECTANGULAR"===V)&&J(x.LINEAR.conditions)},conditions:{stateID:"LINEAR",debugTxt:"Linear pattern condition",validSelCount:1,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.LINE},{type:R.geometryTypesEnum.AXISSYSTEM},{type:R.geometryTypesEnum.AXISSYSTEMAXIS},{type:R.geometryTypesEnum.CYLINDER}]},actions:function(e){ue(x.LINEAR,0,e)}},RECTANGULAR:{id:"RECTANGULAR",iconUrl:e+"I_C3DRectangularPattern.png",chkConditions:function(){return!("LINEAR"!==V&&"RECTANGULAR"!==V||!T)&&J(x.RECTANGULAR.conditions)},conditions:{stateID:"RECTANGULAR",debugTxt:"Rectangular pattern condition",validSelCount:2,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.LINE},{type:R.geometryTypesEnum.CYLINDER},{type:R.geometryTypesEnum.AXISSYSTEM},{type:R.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){ue(x.RECTANGULAR,0,e),F.setDefaultPicking(!1)}},CIRCULAR:{id:"CIRCULAR",iconUrl:e+"I_C3DCircularPattern.png",chkConditions:function(){return"CIRCULAR"===V&&J(x.CIRCULAR.conditions)},conditions:{stateID:"CIRCULAR",debugTxt:"Circular pattern condition",validSelCount:1,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.CYLINDER},{type:R.geometryTypesEnum.LINE},{type:R.geometryTypesEnum.AXISSYSTEM},{type:R.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(e){ue(x.CIRCULAR,0,e)}},USERDEFINED:{id:"USERDEFINED",iconUrl:e+"I_C3DUserPattern.png",chkConditions:function(){return"USERDEFINED"===V&&J(x.USERDEFINED.conditions)},conditions:{stateID:"USERDEFINED",debugTxt:"User defined pattern condition",validSelCount:-1,validTypes:[{type:R.geometryTypesEnum.POINT},{type:R.geometryTypesEnum.CIRCLE},{type:R.geometryTypesEnum.AXISSYSTEM}]},actions:function(e){ue(x.USERDEFINED,0,e)}}},this.addTransition({iInitialState:i,iFinalState:o,iEvent:R,iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="NOPATTERN_LINEAR",x.LINEAR.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:R,iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){G="NOPATTERN_LINEAR",x.RECTANGULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:s,iEvent:R,iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="NOPATTERN_CIRCULAR",x.CIRCULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:u,iEvent:R,iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="NOPATTERN_USERDEFINED",x.USERDEFINED.actions(e)},iSender:M}),this.addTransition({iInitialState:i,iFinalState:C,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="NOPATTERN",O&&(G=G+"_"+V),pe(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:R,iCondition:function(){return x.NOPATTERN.chkConditions()},iAction:function(e){G="NOPATTERN",O&&(G=G+"_"+V),x.NOPATTERN.actions(e)},iSender:M}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:R,iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="LINEAR",x.LINEAR.actions(e)},iSender:M}),this.addTransition({iInitialState:o,iFinalState:o,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){G="LINEAR",Ce(x.LINEAR,0,e)}}),this.addTransition({iInitialState:o,iFinalState:r,iEvent:R,iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){G="LINEAR",x.RECTANGULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:o,iFinalState:C,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="LINEAR",pe(e)}}),this.addTransition({iInitialState:o,iFinalState:C,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return de()},iAction:function(e){G="LINEAR",Se(e)}}),this.addTransition({iInitialState:r,iFinalState:r,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){G="RECTANGULAR",Ce(x.RECTANGULAR,0,e)}}),this.addTransition({iInitialState:r,iFinalState:C,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="RECTANGULAR",pe(e)}}),this.addTransition({iInitialState:r,iFinalState:C,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return de()},iAction:function(e){G="RECTANGULAR",Se(e)}}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:R,iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="CIRCULAR",x.CIRCULAR.actions(e)},iSender:M}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:"C3D_PARAMETERS_CHG",iAction:function(e){G="CIRCULAR",Ce(x.CIRCULAR,0,e)}}),this.addTransition({iInitialState:s,iFinalState:C,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="CIRCULAR",pe(e)}}),this.addTransition({iInitialState:s,iFinalState:C,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return de()},iAction:function(e){G="CIRCULAR",Se(e)}}),this.addTransition({iInitialState:u,iFinalState:u,iEvent:R,iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="USERDEFINED",x.USERDEFINED.actions(e)},iSender:M}),this.addTransition({iInitialState:u,iFinalState:C,iEvent:"C3D_CANCEL_CLICK",iAction:function(e){G="USERDEFINED",pe(e)}}),this.addTransition({iInitialState:u,iFinalState:C,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return de()},iAction:function(e){G="USERDEFINED",Se(e)}}),this.addTransition({iInitialState:o,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="LINEAR",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="LINEAR",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="CIRCULAR",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="CIRCULAR",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){le(x.CIRCULAR.id),G="USERDEFINED",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="RECTANGULAR",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:r,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){le(x.RECTANGULAR.id),G="USERDEFINED",x.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){le(x.LINEAR.id),G="USERDEFINED",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="LINEAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="RECTANGULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="CIRCULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="USERDEFINED",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:o,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="NOPATTERN",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:r,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.RECTANGULAR.chkConditions()},iAction:function(e){G="NOPATTERN",x.RECTANGULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:s,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="NOPATTERN",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:u,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){G="NOPATTERN",x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_PATTERN_CHG",iAction:function(e){G="NOPATTERN",O&&(G=G+"_"+X),x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:o,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return x.LINEAR.chkConditions()},iAction:function(e){G="RECTANGULAR",x.LINEAR.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:u,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return x.USERDEFINED.chkConditions()},iAction:function(e){x.USERDEFINED.actions(e)}}),this.addTransition({iInitialState:o,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="LINEAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:s,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return x.CIRCULAR.chkConditions()},iAction:function(e){G="CIRCULAR",x.CIRCULAR.actions(e)}}),this.addTransition({iInitialState:s,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="CIRCULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:u,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="USERDEFINED",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:r,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){G="RECTANGULAR",x.NOPATTERN.actions(e)}}),this.addTransition({iInitialState:i,iFinalState:i,iEvent:"C3D_UNSELECT_EVT",iAction:function(e){x.NOPATTERN.actions(e)}})},(b=JSON.parse(localStorage.getItem("CAT3DComposeAssemblyPatternCmd")))&&3===b.version&&(k="object"==typeof b.reuse?b.reuse:k,V="object"==typeof b.radioPattern?b.radioPattern:V,Y="object"==typeof b.direction1?b.direction1:Y,B="object"==typeof b.direction2?b.direction2:B,H="object"==typeof b.filters?b.filters:H),this._parent(e,{mode:"exclusive",isAsynchronous:!0,doServerCall:!1}),this.odtUtilsSetDefaultNbInstances=function(e){Y.count=e,B.count=e}}})});