/*!  Copyright 2021 Dassault Systemes. All rights reserved. */
define("DS/DMUwebR3Mctrl/DMUwebR3Mctrl",["UWA/Class","UWA/Core","UWA/Utils/InterCom","DS/DMUwebR3Mux/DMUwebR3Mlist","DS/ENOXTriptych/js/ENOXTriptych","DS/EditPropWidget/EditPropWidget","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/utils/EditPropUtils","DS/DMUwebR3Mutils/DMUwebR3MserverRequests","DS/DMUwebR3Mutils/DMUwebR3MwidgetUtils","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","DS/DMUwebR3Mutils/DMUwebR3MCsiServices","i18n!DS/DMUwebR3Mctrl/assets/nls/DMUwebR3Mctrl.json","css!DS/DMUwebR3Mux/assets/css/DMUwebR3Mux","UWA/Utils/Client"],function(e,t,n,i,a,r,s,o,l,d,c,u,p,g,f){"use strict";function h(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function y(e){return new Promise(function(e,t){require("DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices").getPlatformServices({onComplete:function(t){e(t[0]["3DDashboard"])},onFailure:t})}).then(function(t){if(e){e.content.source=d.getWidget().data.appId,e.content.data.items.forEach(function(e){e.contextId=d.getSecurityContext().replace("ctx::","")});var n=d.getWidget().data.appId;return function(e){var t,n=document.createElement("textarea");if(n.classList.add("bookmark-txt-link"),n.value=e,document.body.appendChild(n),f.Platform&&f.Platform.hasOwnProperty("ios")&&!0===f.Platform.ios){n.contentEditable=!0,n.readOnly=!0;var i=document.createRange();i.selectNodeContents(n);var a=window.getSelection();a.removeAllRanges(),a.addRange(i),n.setSelectionRange(0,n.value.length)}else n.select();try{t=document.execCommand("copy")}catch(e){window.console.log(e)}return document.body.removeChild(n),t?1:0}(t+("#app:"+n+"/content:X3DContentId=")+encodeURIComponent(JSON.stringify(e.content)))}})}var m=e.extend({init:function(e){let f,m,S,v,w,b,I,D,M,O=new c,P=e.parent,C={},x={},E=h(),k=0,R=[],j=[],T={all:[],pending:[],completed:[],timeout:[],running:[]},U=[],A=[],W=Object.freeze({rvw:1,isr:1,msr:1,mkp:0,owner:0,released:0,obsolete:0,myselection:0});function V(){return t.extend(t.clone(W,!0),JSON.parse(localStorage.getItem("R3MwebPrefs")||"{}"))}function N(){return localStorage.setItem("R3MwebPrefs",JSON.stringify(D))}function _(){var e={onComplete:function(e){e.list.length>=1&&e.list.forEach(function(e){j.push({internalID:e.internalID,status:e.status,startingTime:e.startingTime})})},onFailure:function(){}};p._getListIfJobs(e)}function F(e){if(C[e])return[e];let t=[];return Object.keys(C).forEach(n=>{(function e(t,n){if(n){if(n[t])return 1;if(n.children)return n.children&&n.children[t]?1:Object.keys(n.children).some(i=>e(t,n.children[i]))}})(e,C[n])&&t.push(n)}),t}function L(e){var t=Object.keys(C).length;d.getWidget().setTitle(e?"":0===t?g.noValidObj:g["validObj"+(1===t?"":"s")]+t)}function q(e){if(void 0===e.validState)return;if(e.validStateWarning="",l.getIsrTypes().indexOf(e.type)>-1)"InProgress"===e.validState?"donenoko"!==e.analysisState&&"donewithko"!==e.analysisState||(e.validStateWarning=g.itfwarningAnalyzed):"Failed"===e.validState?"notcomputed"===e.analysisState?e.validStateWarning=g.itfwarningNotComputed:"startednoko"===e.analysisState?e.validStateWarning=g.itfwarningNotAnalyzed:"donenoko"===e.analysisState?e.validStateWarning=g.itfwarningNotReported:"computed"===e.analysisState&&(e.validStateWarning=g.itfwarningComputed):"Passed"===e.validState&&("notcomputed"===e.analysisState?e.validStateWarning=g.itfwarningNotComputed:"startednoko"===e.analysisState||"startedwithko"===e.analysisState?e.validStateWarning=g.itfwarningNotAnalyzed:"donewithko"===e.analysisState?e.validStateWarning=g.itfwarningReported:"computed"===e.analysisState&&(e.validStateWarning=g.itfwarningComputed));else{let t=e.children&&e.children[e.id+"_check"];if(!(t=t&&t.children?Object.keys(t.children).map(e=>x[e]).filter(e=>e):null)||!t.length)return;"InProgress"!==e.validState||t.some(t=>t.validState===e.validState)?"Failed"!==e.validState||t.some(t=>t.validState===e.validState)?"Passed"!==e.validState||t.every(e=>"Passed"===e.validState)||(e.validStateWarning=g.warningpassed):e.validStateWarning=g.warningfailed:e.validStateWarning=g.warninginprogress}}function X(e,t,n){if(!e||!t)return;let i,a=n||t.issue&&t.issue.length&&t.ca&&t.ca.length;return["issue","ca"].forEach(n=>{if(!t[n]||!t[n].length)return;i=!0;let r=e.children||(e.children={});if(a){let i=e.id+"_"+n;r[i]={id:i,title:g[n+(t[n].length>1?"s":"")],children:{}},r=r[i].children}t[n].forEach(e=>{r[e.id]=e}),delete t[n]}),!n&&a&&(e.noSort=!0),i}function B(e){var t,n=[],i=[],a=[],r=[],s=[],o=l.getRvwTypes(),d=l.getIsrTypes(),c=l.getMkpTypes(),u=l.getMsrTypes(),p=l.getNewMkpTypes();Object.keys(e).forEach(function(e){t=this[e].type,o.indexOf(t)>-1?n.push(e):d.indexOf(t)>-1?i.push(e):c.indexOf(t)>-1?a.push(e):p.indexOf(t)>-1?r.push(e):u.indexOf(t)>-1&&s.push(e)},e);var f={rvwIds:n,isrIds:i,mkpIds:a,newMkpIds:r,msrIds:s};l.navigate(f).then(function(e){var t={};[0,1,2,3,4].forEach(function(e){Object.keys(this[e]).forEach(function(e){let n=C[e];if(!n)return void window.console.log("id: "+e+" not in validated objects list");let i=["validated","check","highlight","issue","ca"].some(t=>this[e][t]&&this[e][t].length);["context","validated","check","highlight"].forEach(function(t){if(!this[t]||!this[t].length)return;"context"===t&&(this[t]=this[t].filter(e=>"Specification Report"!==e.type));let a=n.children||(n.children={});if(i){let n=e+"_"+t;a[n]={id:n,title:g[t+(this[t].length>1?"s":"")],children:{}},"validated"===t&&(a[n].validatedPath=this.validatedPath),"highlight"===t&&this[t].forEach(e=>X(e,e,!1)),a=a[n].children}this[t].forEach(function(e){a[e.id]=C[e.id]||e}),delete this[t]},this[e]),X(n,this[e],!0),function e(t){t&&t.id&&(x[t.id]||(x[t.id]=t),Object.keys(t.children||{}).forEach(n=>e(t.children[n])))}(n),q(n),i&&(n.noSort=!0),t[e]=n},this[e])},e),m.updateValidations(t)})}function J(){b&&b.dialog&&b.dialog.destroy(),b=null,I&&I.clean(),I=null,R&&R.forEach(e=>e.cancel()),R=[],d.perfoMark("refreshGrid_"+ ++k);const e=t.createElement("div",{class:"r3mLoadingValidations mask wux-datagridview-emptycontentmessage"}).inject(P),n=t.createElement("div",{class:"spinner spinner-lg spinning fade in",styles:{display:"flex","justify-content":"center"}}).inject(e);t.createElement("span",{class:"spinner-bar"}).inject(n),t.createElement("span",{class:"spinner-bar spinner-bar1"}).inject(n),t.createElement("span",{class:"spinner-bar spinner-bar2"}).inject(n),t.createElement("span",{class:"spinner-bar spinner-bar3"}).inject(n),t.createElement("div",{class:"r3mWelcomeText",html:g.validationLoad,styles:{}}).inject(e),L(!0),C={},x={},A=[],T={all:[],pending:[],completed:[],timeout:[],running:[]},U=[],j=[];var i=d.getWidget(),a=d.getDatafromContent(),r={};(0!==Object.keys(a).length&&i.data&&!i.data.loadDataFromCopiedLink||0!==Object.keys(a).length&&1===D.myselection)&&(r=Object.freeze({rvw:1,isr:1,msr:1,mkp:1}));const s=l.search(0!==Object.keys(r).length?r:D,function(t,n){x=Object.assign(x,t),0===n&&m.removeAll();var r,o={},l=[],c=[];a&&0===Object.keys(a).length?localStorage.removeItem("R3MFromCopylink"):a.obj&&Array.isArray(a.obj)&&a.obj.forEach(function(e){e.objectType&&"DMUValidationExposedPresentation"===e.objectType&&l.push(e.objectId)}),(r=l,new Promise(function(e){r&&r.length>0?require("DS/WAFData/WAFData").authenticatedRequest(d.get3DSpaceUrl()+"/resources/validation/service/getValidationsFromObjectsIds?tenant="+d.getPlatformId(),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:d.getSecurityContext()},data:JSON.stringify({listHighlights:r}),timeout:6e4,onComplete:function(t){let n=JSON.parse(t);e(n)},onFailure:function(){e()},onTimeout:function(){e()}}):e()})).then(n=>{var r=[];(0!==Object.keys(a).length&&i.data&&!i.data.loadDataFromCopiedLink||1===D.myselection)&&(D=V(),i.data.loadDataFromCopiedLink=!0,D.myselection=1,N(),n&&n.validations&&n.validations.length>0&&n.validations.forEach(function(e){t.hasOwnProperty(e.id)&&(c[e.id]=o[e.id]=t[e.id],r.push(e.id))}),a.obj&&a.obj.length>0&&a.obj.forEach(function(e){t.hasOwnProperty(e.objectId)&&(o[e.objectId]=t[e.objectId],r.push(e.objectId))}),localStorage.setItem("R3MFromCopylink",1)),C=o&&0===Object.keys(o).length?Object.assign(C,t):o,localStorage.setItem("r3mValidationObjects",JSON.stringify(C)),m.updateValidations(o&&0===Object.keys(o).length?t:o),m.checkFilterAndFetchValue(),B(o&&0===Object.keys(o).length?t:o),L(),m.expanReviewNode(c,n),s.promise.finally(function(){e.destroy(),d.perfoMeasure("refreshGrid_"+this)}.bind(k)),R.push(s)})});_()}function z(e,t){function n(e,t){return e.some(function(e){return t.length===e.length&&e.every(function(e,n){return e===t[n]})})}m.getSelectedRows().forEach(function(i){if(!i||!i.id||!x[i.id])return void window.console.error("Unidentified object");let a;(a=i.id.search("_")>-1?Object.values(x[i.id].children):[x[i.id]]).forEach(function(i){var a;i.validatedPath&&i.validatedPath.length>2?(a=i.validatedPath.map(function(e){return t[e.pid]||(t[e.pid]={type:e.type}),e.pid}),n(e,a)||e.push(a)):(t[i.pid||i.id]||(t[i.pid||i.id]={type:i.type}),a=[i.pid||i.id],n(e,a)||e.push(a))})})}function G(e,t,n){t.forEach(function(t){e.push({envId:d.getPlatformId(),serviceId:"3DSpace",contextId:d.getSecurityContext(),objectId:t[t.length-1],objectType:n[t[t.length-1]].type,path:t.length>2?t.map(function(e){return{resourceid:e,type:n[e].type}}):void 0})})}function K(e,t){var n={protocol:"3DXContent",version:"1.0",source:d.getWidgetAppId(),data:{items:[]}};return G(n.data.items,e,t),n}function H(e){var t,i=[],a={};if(z(i,a),t=i.map(function(e){var t=e[e.length-1],n=a[t].type,i={getID:function(){return t},tenant:d.getPlatformId(),type:n};return e.length>2&&(i.getRelationID=function(){return e[e.length-2]}),o.getModelFromSelectedNode(i)}),f.getRightOpen()&&S.initDatas(t),!e){var r={version:"1.1",paths:i,attributes:a,tenant:d.getPlatformId()},s={uid:h(),originUid:E,timestamp:Date.now(),appid:d.getWidgetAppId(),originWidgetId:d.getWidgetId()};u.publish("DS/PADUtils/PADCommandProxy/select",{data:r,metadata:s}),v||(w=d.getWidgetAppId()+"_CompassSocket_"+d.getWidgetId(),(v=new n.Socket(w)).subscribeServer("com.ds.compass",window.parent)),i.length?v.dispatchEvent("onSetX3DContent",K(i,a),w):v.dispatchEvent("onResetX3DContent",{},w)}}function Q(){H()}function Y(){H()}function $(e){var t;["rvw","isr","mkp","msr","owner","released","obsolete","myselection"].forEach(function(n){e[n]!==D[n]&&(t=!0,D[n]=e[n])}),t&&(J(),N())}function Z(){var e=f.getRightOpen();O.publish({event:e?"triptych-hide-panel":"triptych-show-panel",data:"right"}),m.setInfoState(!e),e||H(!0)}function ee(){var e=[],t={};return z(e,t),e.filter(e=>!(e&&1===e.length&&t[e[0]]&&"DMUValidationCheck"===t[e[0]].type))}function te(){let e=m.getSelectedRows(),t=[];return e.length&&1===e.length&&e.forEach(e=>{var n;if(e.parents&&e.parents.length>0&&e.parents[0].contains("_highlight"))n=e.parents[1]?e.parents[1]:"";else{let t=C[e.id];n=t&&-1!==l.getRvwTypes().concat(l.getIsrTypes().concat(l.getMkpTypes()).concat(l.getNewMkpTypes()).concat(l.getMsrTypes())).indexOf(t.type)&&t.id}n&&t.push({physicalid:n,tenant:d.getPlatformId()})}),t}function ne(){var e={protocol:"3DXContent",version:"1.1",data:{items:[]},source:d.getWidgetAppId(),widgetId:d.getWidgetId()},t=[],n={};z(t,n),G(e.data.items,t,n);var i=y({content:e});require(["DS/PADUtils/views/PADAlert"].concat([]),function(e){i?e.displayNotification({msg:g.replace(g.copyLinkSuccess,{label:x[t[0]].title}).replace(/"/g,"'"),eventID:"success"}):e.displayNotification({msg:g.copyLinkError,eventID:"error"})})}function ie(){var e=t.Promise.deferred();return require(["DS/PIMwebPropertiesTabs/PIMwebIsrPropInfo"].concat([]),function(t){let n=m.getSelectedRows(),i=[];n.forEach(e=>{var t;let n=C[e.id];(t=n&&-1!==l.getIsrTypes().indexOf(n.type)&&n.id)&&i.push(t)});let a=require("DS/DMUwebR3Mutils/DMUwebR3MwidgetUtils"),r={requestUtils:{get3DSpaceUrl:a.get3DSpaceUrl,getPlatformId:a.getPlatformId,getSecurityContext:a.getSecurityContext,getLang:a.getLang},isrIDs:i};t.getSpecInfo(r).then(function(t){let n=0===t.length?1:0;t.forEach(e=>{let t=Boolean(e.checkFasteners)||Boolean(e.pathwayItfs)||Boolean(e.electricalItfs)||"on"===e.specRule||"on"===e.specMCX,i=Boolean(e.volumeQuantifier)||2===e.clashGeometryStorage||3===e.clashGeometryStorage||2===e.clearanceGeometryStorage||3===e.clearanceGeometryStorage;n+=t&&i?3:t||i?2:1}),e.resolve(n)})}),e.promise}function ae(){if(!p._isUpdateSimulationAllowed())return 0;let e=1,t=m.getSelectedRows();if(t.length){let n=[];if(t.forEach(e=>{var t;let i=C[e.id];(t=i&&-1!==l.getIsrTypes().indexOf(i.type)&&i.id)&&n.push(t)}),n.length>=1){(function(e){var t=[];return e.forEach(e=>{let n=j.filter(t=>t.internalID===e);if(n.length>=1){let i=n.reduce((e,t)=>e&&e.startingTime>t.startingTime?e:t);t.push({id:e,status:i.status})}else t.push({id:e,status:"succeeded"})}),t})(n).filter(e=>"running"===e.status||"pending"===e.status).length>=1&&(e=2)}}return e}function re(e,t,n,i){e.analysisState=t,e.analysisStateDisp=l.getAnalysisStateNlsValue(t),e.analysisStateNbKO=n;let a={};q(e),a[e.id]=e,m.updateValidations(a,i)}function se(){var e=[];z(e,{}),e.length&&e.forEach(e=>{p._computeItfSimulation({isrID:e[0],app:"R3M",platformId:d.getPlatformId()}).then(function(){let t=C[e[0]];t&&(j.push({internalID:e[0],status:"running",startingTime:Math.floor(Date.now()/1e3)}),re(t,"Running",0))})})}function oe(){require(["DS/TransientWidget/TransientWidget"].concat([]),function(e){var t=[],n={};z(t,n),e.showWidget("ENORIPE_AP","",{X3DContentId:JSON.stringify(K(t,n))},{mode:"panel",width:700,height:800})})}function le(){let e=m.getSelectedRows();if(!e.length)return;let t=[];return e.forEach(e=>{let n=C[e.id],i=n&&-1!==l.getRvwTypes().concat(l.getIsrTypes()).indexOf(n.type)&&n.id;i&&t.push({physicalid:i,tenant:d.getPlatformId()})}),t}function de(){require(["DS/MaturityWidget/MaturityWidget"].concat([]),function(e){b&&b.dialog&&b.dialog.destroy(),(b=new e({externalSettings:d.getPlatformIdServices()})).addEvent("onMaturityCanceled",()=>{b=null}),b.addEvent("onMaturityTransitionEnd",e=>{if(!e||!e.data)return;let t={},n=[];e.data.forEach(e=>{let i=C[e.physicalid];if(!i)return;i.maturityDisp=l.getMaturityNlsValue(i.maturity="VPLM_SMB_Evaluation."+e.tostate);let a=e.tostate.toLowerCase();"released"===a&&!D.released||"obsolete"===a&&!D.obsolete?n.push(e.physicalid):t[e.physicalid]=i}),u.publish("DS/DMUwebR3Mctrl/R3MObjectModified",{modified:"maturity",data:C}),localStorage.setItem("r3mValidationObjects",JSON.stringify(C)),m.updateValidations(t),m.removeValidation(n)}),b.executeCmd(le(),{context:{getSecurityContext:()=>({SecurityContext:d.getSecurityContext()})}},()=>{})})}function ce(e){l.getFeatureStateInfo(e).then(t=>{let n=C[e.validatedObjId];if(n.children[e.text]&&n.children[e.text].children){let i=n.children[e.text].children[e.objectId];if(i){i.dateCreat=t.result[0].grid["ds6w:created"],i.dateModif=t.result[0].grid["ds6w:modified"],i.icon=t.result[0].icon,i.ownerid=t.result[0].grid.owner,i.owner=t.result[0].grid["ds6w:responsible"],i.title=t.result[0]["ds6w:label"],i.type=t.result[0].type;let e={};e[i.id]=i,m.updateValidations(e,!1,!0)}}})}function ue(e){-1===U.indexOf(e[0])&&(l.evalIssueCells(e,function(t,n){if(0===t.results.length){let t={r3mIssueApprovals:"",r3mIssueAssignees:"",r3mIssueResolvedBy:""},n={};n[e[0]]=t,m.updateValidations(n,!1,!0)}t.results.forEach(function(e){let t=e.body,i={},a={};i.r3mIssueApprovals=!("Unassigned"===t.waitingOn||""===t.waitingOn);var r=[];t.assignees.forEach(function(e){r.push({label:e.fullName,url:n[e.user]})}),i.r3mIssueAssignees=r.length>=1?r:"",i.r3mIssueResolvedBy=0===t.resolvedBy.length?"No":"Yes("+t.resolvedBy.length.toString()+")",i.r3mIssuePriority=t.priority,a[t.physicalId]=i,m.updateValidations(a,!1,!0)});let i=U.indexOf(e[0]);i>-1&&U.splice(i,1)}),U.push(e[0]))}function pe(e){-1===A.indexOf(e[0])&&(l.evalMetricIssueCells(e,function(t){let n;if(Object.keys(t.issues).length>0){if(C[e[0]].children||(C[e[0]].children={}),!C[e[0]].children[e[0]+"_issue"]){let t=Object.keys(C[e[0]].children);if(1===t.length&&"VPMReference"===C[e[0]].children[t[0]].type){let i=C[e[0]].children[t[0]];C[e[0]].children={},n=i.id,C[e[0]].children[e[0]+"_context"]={id:e[0]+"_context",title:"Context",children:{childNodeId:i}}}C[e[0]].children[e[0]+"_issue"]={id:e[0]+"_issue",title:"Issues",children:{}}}Object.assign(C[e[0]].children[e[0]+"_issue"].children,t.issues),1===Object.keys(C[e[0]].children[e[0]+"_issue"].children).length&&(C[e[0]].children[e[0]+"_issue"].title="Issue");var i={};i[e[0]]=C[e[0]],m.deleteNodes(e[0],n),m.updateValidations(i,!1,!1,!0)}}),A.push(e[0]))}function ge(e){let t=C[e[0]];if(t&&0===t.executionState)return void re(t,"notcomputed",0);function n(e){let t=T.pending.indexOf(e);if(t>-1&&T.pending.splice(t,1),-1===(t=T.completed.indexOf(e))&&T.completed.push(e),(t=T.running.indexOf(e))>-1&&T.running.splice(t,1),T.pending.length>0){let e=T.running.length;T.pending.forEach(function(t){(0===T.running.length||T.running.length>0&&T.running.indexOf(t))&&(ge([t]),e+=1)})}}function i(e,t,n){let i=C[e];if(i){i.analysisStateProgress=Math.ceil(n/t*100);let e={};e[i.id]=i,m.updateValidations(e,!1)}}function a(e){let t="error",i=0;if("timeout"===e.status)n(e.simIds[0]);else if("failure"!==e.status&&Array.isArray(e.output))e.output.forEach(function(e){let n=e.nbTotalItf,a=e.nbOK,r=e.nbKO,s=e.nbTotalItf-(e.nbKO+e.nbOK),o=e.simPid;"0"===e.ExecStatus?t="notcomputed":a===n?t="donenoko":s&&r?(t="startedwithko",i=r):s&&0===r&&a?t="startednoko":s&&0===r&&0===a?(t="computed",i=n):n===r+a?(t="donewithko",i=r):t="startednoko",C[o]&&C[o].analysisState!==t&&(re(C[o],t,i),m.updateStatusBar(C[o].id,"success"))}),n(e.output[0].simPid);else{let a=e.simIds?e.simIds[0]:"";C[a]&&C[a].analysisState!==t&&(re(C[a],t,i),m.updateStatusBar(C[a].id,"failure")),n(e.simIds[0])}}let r=e[0];for(-1===T.all.indexOf(r)&&T.all.push(r),-1===T.pending.indexOf(r)&&T.pending.push(r);T.running.length<4&&-1===T.running.indexOf(r);){let e=C[r];if(!e)return;let n=l.getIsrTypes(),s=e.type;if(n.indexOf(s)>-1&&("unknown"===e.analysisState&&re(e,"running",0,!0),-1===T.running.indexOf(r)))if(T.running.push(r),p._isUpdateSimulationAllowed()){let n=j.filter(e=>e.internalID===t.id);if(n.length>=1){let t=n.reduce((e,t)=>e&&e.startingTime>t.startingTime?e:t);"running"!==t.status&&"pending"!==t.status?l.evalAnalysisStatus(e,a,i):re(e,"Running",0)}else l.evalAnalysisStatus(e,a,i)}else l.evalAnalysisStatus(e,a,i)}}function fe(){const e=e=>!e.restrictedEditionDisp||"Activated"!==e.restrictedEditionDisp||!(!(e=>{let t=window.widget.getValue("xPref_CREDENTIAL"),n=t.split(".");t=n[0]?n[0]:"";return d.getUserLogin()===e.ownerid||["VPLMProjectLeader","VPLMAdmin"].includes(t)})(e)||"In Work"!==e.maturityDisp);let t=m.getSelectedRows();if(1!==t.length)return;let n=[];return t.forEach(t=>{let i=C[t.id],a=i&&(-1!==l.getRvwTypes().indexOf(i.type)||-1!==l.getIsrTypes().indexOf(i.type))&&i.id;if(!a)return;let r=i.validState;r="Failed"===r?"failed":"Passed"===r?"passed":"inProgress";let s=-1!==l.getIsrTypes().indexOf(i.type);const o=e(i);n.push({title:i.title,physicalid:a,status:r,isrType:s,display:o})}),n}function he(e,t){let n=C[e];return n.validState="passed"===t?"Passed":"failed"===t?"Failed":"InProgress",n.validStateDisp=l.getValidStateNlsValue(n.validState),q(n),n}function ye(){require(["DS/CATWebUXCVS/CATWebUXCVSComponent"].concat([]),function(e){I&&I.clean(),I=null;let t=fe();t&&1===t.length&&(t=t[0],I=new e({title:t.title,physicalId:t.physicalid,current:t.status,isrType:t.isrType,parent:P,platformSettings:d.getPlatformIdServices(),tenant:d.getPlatformId(),securityContext:{getSecurityContext:()=>({SecurityContext:d.getSecurityContext()})},onChangeValidationStateCompleted:function(e){if(C[t.physicalid].validState=e.sValidationState,u.publish("DS/DMUwebR3Mctrl/R3MObjectModified",{modified:"validationState",data:C}),localStorage.setItem("r3mValidationObjects",JSON.stringify(C)),I&&I.clean(),I=null,!e)return;let n=he(t.physicalid,e.sValidationState);n&&m.updateValidations({[t.physicalid]:n})},onChangeValidationStateClose:function(){I&&I.clean(),I=null},onChangeValidationStateFailure:function(){I&&I.clean(),I=null}}))})}D=V(),_(),L(),d.onTenantModified(e=>{M||(M=!0,m.removeAll(),e.then(()=>{M=!1,J()}))}),l.onTenantModified(()=>{l.getColumnsNls().then(m.onTenantModified)}),d.getWidget().addEvent("onRefresh",function(){var e=d.getWidgetData();Object.keys(e).length>0&&(window.widget.data=e,window.widget.data.loadDataFromCopiedLink=!1),M||J()}),u.subscribe("DS/PADUtils/PADCommandProxy/validationState",e=>{const{validationId:t,checkId:n,checkStatus:i}=e,a=C[t];let r=a.children&&a.children[`${a.id}_check`];r&&r.children[n]&&(r.children[n].validState=i,r.children[n].validStateDisp=i),he(t,a.validState.toLowerCase())}),this.buildUX=function(){return f?Promise.resolve():new Promise(function(e){var n=t.createElement("div",{class:"r3mMainView",styles:{width:"100%",height:"100%"}}),o=t.createElement("div",{class:"r3mRightView"});function c(e){e.stopPropagation()}function u(e,t){if(!m||!t)return!1;var n={protocol:"3DXContent",version:"1.1",data:{items:[]},source:d.getWidgetAppId(),widgetId:d.getWidgetId()},i=[],a={};return z(i,a),G(n.data.items,i,a),e.dataTransfer.setData("Text",JSON.stringify(n)),!1}o.style.height="100%",(f=new a).init({withtransition:!0,container:this,right:{withClose:!1},modelEvents:O},null,n,o),l.getColumnsNls().then(t=>{(m=new i({parent:n,onSelect:Q,onUnselect:Y,getFilterValues:function(){return Object.assign({},D)},getIsrTypes:function(){return l.getIsrTypes()},getFeatureStateInfo:ce,onFiltersModified:$,onInfo:Z,allowRelations:ee,allowCopyLink:te,onCopyLink:ne,onRelations:oe,allowMaturityState:le,onMaturityState:de,onAnalysisState:ge,onMetricIssue:pe,onIssueCells:ue,allowValidationState:fe,allowUpdateSimulation:ae,getCSIcomputeToken:ie,onValidationState:ye,onUpdateSimulation:se,columns:t,cbDnD:{onDragStartCell:u,onDragOverCell:c,onDragEnterBlank:c,onDragOverBlank:c,onDragStartRowHeader:u,onDragOverRowHeader:c}}))&&m.checkFilterAndFetchValue(),(S=new r({className:"r3mProperties",setEditButton:!0,readOnly:!1,setCloseButton:!0,typeOfDisplay:s.ALL,displayType:s.STANDARD,selectionType:s.NO_SELECTION,multiselection:s.MULTISEL_STD,collapseTabs:!1,appId:"ENOR3M_AP",actions:[{name:"closeSidePanel",text:g.closeSidePanel,icon:"close",handler:function(){O.publish({event:"triptych-hide-panel"}),m.setInfoState(!1)}}]}).inject(o)).initDatas([]);let a=require("DS/DMUwebR3Mutils/DMUwebR3MwidgetUtils"),d={requestUtils:{get3DSpaceUrl:a.get3DSpaceUrl,getPlatformId:a.getPlatformId,getSecurityContext:a.getSecurityContext,getLang:a.getLang},onFacetModification:function(e){let t=[];Object.keys(e||{}).forEach(function(e){let n=x[e];n&&Object.keys(this[e]||{}).forEach(function(i){let a;"sValidationState"===i?(a=!0,he(e,this[i])):"iCheckState"===i?(a=!0,l.updateCheckStateValue(this[i],n)):"title"!==i&&"description"!==i||(a=!0,n[i]=this[i]),a&&-1===t.indexOf(e)&&t.push(e)},this[e])},e);let n={};t.forEach(e=>{F(e).forEach(e=>{n[e]||(n[e]=C[e])})}),m.updateValidations(n)}};S.addFacets([{position:1,require:"DS/PIMwebPropertiesTabs/PIMwebIsrPropContextTab",supportMerge:!0,options:d,facet:{name:"interference_context",text:g.context,icon:"6w-what"}},{position:2,require:"DS/PIMwebPropertiesTabs/PIMwebIsrPropSpecTab",supportMerge:!0,options:d,facet:{name:"interference_specification",text:g.specifications,icon:"6w-how"}},{position:1,require:"DS/DMUReviewFacets/DMUwebR3MinfoRvwCheckTab",supportMerge:!0,options:d,facet:{name:"review_check",text:g.checks,icon:"check-review"}},{position:2,require:"DS/DMUReviewFacets/DMUwebR3MinfoRvwHighlightTab",supportMerge:!0,options:d,facet:{name:"review_highlight",text:g.highlights,icon:"highlight-review"}}]),e()})}.bind(this))}.bind(P),this.refresh=J,this.destroy=function(){window.console.error("TODO!!")}}}),S=[],v=function(e){return e&&e.id?(S.some(function(n){return n.id===e.id&&(t=n.enveloppe)}),t):null;var t};return Object.freeze({giveCtrl:function(e){return v(e)},getCtrl:function(e){if(!e||!e.id)return null;var t=v(e);if(!t){var n=new m({parent:e.parent}),i={buildUX:function(){return n?n.buildUX.apply(null,arguments):null},refresh:function(){return n?n.refresh.apply(null,arguments):null},destroy:function(){n&&(n.destroy.apply(null,arguments),n=null,S.some(function(e,t){if(e.enveloppe===i)return S.splice(t,1),i=null,!0}))}};Object.freeze(i),S.push({id:e.id,enveloppe:i}),t=i}return t}})});