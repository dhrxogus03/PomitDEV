define("DS/VCXWebDigger/VCXDiggerModifiableView",["DS/VCXWebDressup/VCXDressupModifiableView","i18n!DS/VCXWebDigger/assets/nls/VCXWebDigger"],function(e,t){"use strict";var i=e.extend({init:function(){this._parent()},getPropertyGroupsi18n:function(){return t},getGroupPropertiesOrders:function(){var e={"Group.Position":["Digger.Position","Digger.Radius"],"Group.Settings":["Digger.Mode","Digger.ZoomFactor","Digger.DepthFactor","Digger.DepthZoom","Digger.TorchFilter","Digger.Attach"]},t=this._parent()||{};for(const i in e)t[i]=e[i];return t}});return i.prototype._getGroupsPriorities=function(){var t=e.prototype._getGroupsPriorities();return UWA.extend(t,{"Group.Essentials":0,"Group.Position":10,"Group.Settings":20}),t},i}),define("DS/VCXWebDigger/VCXVisibilityDigger",["DS/VCXWebDressup/VCXVisibilityDressup"],function(e){"use strict";return e.extend({init:function(){},GetType:function(){return"VCXVisibilityDigger"},SetVisibility:function(e){this._parent(e);var t=this.QueryInterface("W3AISGNodeHolder");if(t){var i=t.getSGNode();if(i){var r=this.GetVisibility();i.setVisibility(r)}}}})}),define("DS/VCXWebDigger/VCXDiggerUI",["DS/Core/Core","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(e){this.diggerComponent=null},dispose:function(){},drawImage:function(e,t,i,r,o){e.save(),e.beginPath();var n=r.getPixelWidth()/2;e.arc(t,i,n,0,2*Math.PI,!1),e.clip();var s=r.toCanvas();e.globalAlpha=o,e.drawImage(s,t-n,i-n,2*n,2*n),e.globalAlpha=1,e.restore()},drawBorder:function(e,t,i,r,o){e.beginPath(),e.arc(t,i,r,0,2*Math.PI,!1),e.fillStyle=this.diggerComponent.borderColor.GetStyle(),e.globalAlpha=o*this.diggerComponent.borderColor.a,e.fill(),e.lineWidth=this.diggerComponent.borderLineOuter,e.strokeStyle="black",e.globalAlpha=o*this.diggerComponent.borderLineOuterColor.a,e.stroke(),e.globalAlpha=1},drawInnerBorder:function(e,t,i,r,o){e.beginPath(),e.arc(t,i,r+1,0,2*Math.PI,!1),e.lineWidth=this.diggerComponent.borderLineInner,e.strokeStyle="black",e.globalAlpha=o*this.diggerComponent.borderLineInnerColor.a,e.stroke(),e.globalAlpha=1},drawAttach:function(e,t,i,r){e.lineWidth=1,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(i.p1.x,i.p1.y),e.lineTo(i.p2.x,i.p2.y),e.lineTo(t.x,t.y),e.fillStyle="white",e.globalAlpha=r,e.fill(),e.strokeStyle="black",e.globalAlpha=r*this.diggerComponent.borderLineOuterColor.a,e.stroke(),e.globalAlpha=1}})});var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define("DS/VCXWebDigger/VCXDigger_Spec",["require","exports","DS/VCXWebProperties/VCXColor","DS/VCXWebDressup/VCXDressup_Spec"],function(e,t,i,r){"use strict";i=__importDefault(i),r=__importDefault(r);class o extends r.default{constructor(){super(),this._dirty=!1,this.IsAnchorDependent=!0,this.IsDressupPropertiesChangeIndependent=!0,this.IsViewPointDependent=!0,this._tooltip="",this._dirtyPickability=!1,this._DiggerDirtyMask=0,this.borderThickness=8,this.borderLineOuter=1,this.borderLineInner=1,this.borderColor=(new i.default).FromRGBA(1,1,1,.5),this.borderLineOuterColor=(new i.default).FromRGBA(0,0,0,.6),this.borderLineInnerColor=(new i.default).FromRGBA(0,0,0,.3)}isDirty(){return this._dirty||this._dirtyPickability}}return function(e){let t,i;!function(e){e[e.Zoom=0]="Zoom",e[e.Onion=1]="Onion",e[e.XRay=2]="XRay",e[e.Detail=3]="Detail"}(t=e.EMode||(e.EMode={})),function(e){e[e.Position=1]="Position",e[e.Radius=2]="Radius",e[e.AnchorPosition=4]="AnchorPosition",e[e.ViewpointMoved=8]="ViewpointMoved",e[e.Buttons=16]="Buttons"}(i=e.FDirty||(e.FDirty={}))}(o||(o={})),o.prototype.getDefaultName=function(){return"Digger"},Object.defineProperty(o.prototype,"componentType",{enumerable:!0,get:function(){return"VCXDigger_Spec"}}),o.prototype.dressupGroupName="Diggers",o}),define("DS/VCXWebDigger/VCXDiggerPrepareRenderToTexture",["require","exports","DS/VCXWebVisualization/VCXAPrepareRenderToTexture"],function(e,t,i){"use strict";return class extends i{constructor(){super()}async prepareRender(e,t){if("normal"===t){let e=this._object.QueryInterface("W3AISGNodeHolder").getSGNode();if(e.isVisible()){let t=e.Modifiable;if(t){let e=t.QueryInterface("VCXIManipulable"),i=e&&e.getAllInteractors(),r=i&&i["Interactor Anchor.0"];r&&r.node&&r.node.handle&&r.node.handle.Hide(!0)}}}}async postRender(e,t){if("normal"===t){var i=this._object._experienceBase.getManager("VCXPaperManager"),r=i.MMToPixel2(null,{x:0,y:0}).multiplyScalar(window.devicePixelRatio);let t=this._object.QueryInterface("W3AISGNodeHolder").getSGNode();if(!t.isVisible())return;var o=t.getRadiusInPixel()*window.devicePixelRatio;let D=t.DiggerUI.diggerComponent.borderThickness*i.MMToPixelRatio()*window.devicePixelRatio/10;var n=2*o-2*D,s=2*o-2*D;let _=(await t.doHiRes(this._object._experienceBase,n,s)).image;var a=e.canvas,g=a.getContext("2d"),h=t.getPositionInPixel().clone().multiplyScalar(window.devicePixelRatio).sub(r),l=t.GetOpacity();if(t.DiggerUI.drawBorder(g,h.x,h.y,o,l),t.getAttachDisplay()){var d=t.getAnchorVector(),c=t.convert3DPointToCanvasPxl(d,t._viewer,a).clone().sub(r),p=t.calcDiggerAnchorPoints(o+D,h,c);p&&t.DiggerUI.drawAttach(g,c,p,l)}t.DiggerUI.drawImage(g,h.x,h.y,_,l);var u=_.getPixelWidth()/2;t.DiggerUI.drawInnerBorder(g,h.x,h.y,u,l)}}GetType(){return"VCXDiggerPrepareRenderToTexture"}}}),define("DS/VCXWebDigger/VCXWebDiggerDictionary",[],function(){"use strict";var e={VCXDigger_Spec:{VCXIModifiable:"DS/VCXWebDigger/VCXDiggerModifiable",VCXIModifiableView:"DS/VCXWebDigger/VCXDiggerModifiableView",VCXIVisibility:"DS/VCXWebDigger/VCXVisibilityDigger",W3AISGNodeHolder:"DS/VCXWebDigger/VCXDiggerSGNodeHolder",VCXISensible:"DS/VCXWebComposer/VCXASensible",VCXITreeNode:"DS/VCXWebTreeExtensions/VCXTreeNodeDigger",VCXIModelNavigable:"DS/VCXWebDressup/VCXDressupModelNavigable",VCXIReadiness:"DS/WebApplicationBase/VCXAReadiness",VCXIPrepareRenderToTexture:"DS/VCXWebDigger/VCXDiggerPrepareRenderToTexture"}},t={VCXIModifiable:"DS/VCXWebModifiables/VCXIModifiable",VCXIModifiableView:"DS/VCXWebModifiables/VCXIModifiableView",VCXIVisibility:"DS/VCXWebVisibility/VCXIVisibility",W3AISGNodeHolder:"DS/WebApplicationBase/W3AISGNodeHolder",VCXIModelNavigable:"DS/WebApplicationBase/VCXIModelNavigable",VCXITreeNode:"DS/VCXWebTreeGUI/VCXITreeNode",VCXISensible:"DS/VCXWebComposer/VCXISensible",VCXIReadiness:"DS/WebApplicationBase/VCXIReadiness",VCXIPrepareRenderToTexture:"DS/VCXWebVisualization/VCXIPrepareRenderToTexture"},i={VCXDigger_Spec:"DS/VCXWebDigger/VCXDigger_Spec",VCXComponentDigger:"DS/VCXWebDigger/VCXDigger_Spec"},r=[];return{GetDictionary:function(){return{interfaces:t,components:i,extensions:e}},getNLSModules:function(){return r}}}),define("DS/VCXWebDigger/VCXDiggerModifiable",["DS/VCXWebDressup/VCXDressupModifiable","DS/VCXWebDigger/VCXDigger_Spec","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfoEnum","DS/VCXWebProperties/VCXPropertyValueAnchor","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValuePoint2D","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueEnum","DS/VCXWebProperties/VCXPropertyValueVector","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebVisualization/VCXAnchorHandle","i18n!DS/VCXWebDigger/assets/nls/VCXWebDigger"],function(e,t,i,r,o,n,s,a,g,h,l,d,c,p,u){"use strict";return e.extend({init:function(){this._parent()},Build:function(){this._parent();var r=[{Name:"Digger.Position",Type:g,DefaultValue:new i.Vector2(274.5,22.5),i18nGroup:u,GroupId:"Group.Position"},{Name:"Digger.Radius",Type:h,DefaultValue:45,i18nGroup:u,GroupId:"Group.Position",Bounds:{Min:10,Step:1}},{Name:"Digger.Mode",Type:l,DefaultValue:t.EMode.Zoom,i18nGroup:u,GroupId:"Group.Settings"},{Name:"Digger.ZoomFactor",Type:h,DefaultValue:.5,i18nGroup:u,GroupId:"Group.Settings",Bounds:{Min:0,Max:1,Step:.01}},{Name:"Digger.DepthFactor",Type:h,DefaultValue:0,i18nGroup:u,GroupId:"Group.Settings",Bounds:{Min:0,Max:1,Step:.01}},{Name:"Digger.DepthZoom",Type:h,DefaultValue:0,i18nGroup:u,GroupId:"Group.Settings",Bounds:{Min:0,Max:1,Step:.01}},{Name:"Digger.TorchFilter",Type:a,DefaultValue:!0,i18nGroup:u,GroupId:"Group.Settings"},{Name:"Digger.Attach",Type:a,DefaultValue:!0,i18nGroup:u,GroupId:"Group.Settings"},{Name:"Actor.Anchor.0",Type:n,DefaultValue:(new n).SetValueFrame((new s).SetValueFromVector(new i.Vector3(0,0,0))).GetValue(),visibleInPropertyGroups:!1},{Name:"Collab.ListAnchorsIDs",Type:d,DefaultValue:[0],visibleInPropertyGroups:!1},{Name:"Digger.AssociatedPanelID",Type:c,DefaultValue:"",visibleInPropertyGroups:!1},{Name:"Actor.IsAlwaysOnTop",visibleInPropertyGroups:!1}];this._BuildPropertyValues(r),this.SetPropertyInvisible("Collab.ListAnchorsIDs",!0),this.SetPropertyInvisible("Digger.AssociatedPanelID",!0),this.ChangeGroupAvailability("Group.Image",e.EAvailability.NoControl)},SetPropertiesInfo:function(){this._parent(),this.SetPropertyInvisible("Digger.ZoomFactor",this.GetPropertyValue("Digger.Mode")!==t.EMode.Zoom),this.SetPropertyInvisible("Digger.DepthFactor",this.GetPropertyValue("Digger.Mode")===t.EMode.Zoom),this.SetPropertyInvisible("Digger.DepthZoom",this.GetPropertyValue("Digger.Mode")===t.EMode.Zoom),this.SetPropertyInvisible("Digger.TorchFilter",this.GetPropertyValue("Digger.Mode")===t.EMode.Zoom),this.ChangeGroupAvailability("Group.Actions",e.EAvailability.AppForceNotAvailable)},GetProperty:function(e){var i=null;if("Digger.Mode"===e){var n=0;if(d=this._parent(e))n=d.Clone().GetPropertyValue().GetValue();var s=new l;s.SetValue(n);var a=this.QueryInterface("VCXIModifiableView");let c="";a&&(c=a.getPropertyGroupsi18n());var g=new o(e,1,!0,c),h=this._generateMapChoiceFromEnumAndId(t.EMode,"Digger",["Detail"]);g.SetMapChoiceEnum(h),g.SetGroupId("Group.Settings"),i=new r(g,s)}else i=this._parent(e);"Actor.IsAlwaysOnTop"!==e&&"Actor.ToolTip"!==e&&"Actor.Freeze"!==e&&"Actor.Anchor.0"!==e&&"Actor.Hyperlink"!==e||(d=this._parent(e))&&(c=d.GetPropertyInfo())&&c.SetVisible(!1);if("Digger.ZoomFactor"===e||"Digger.DepthFactor"===e||"Digger.DepthZoom"===e||"Digger.TorchFilter"===e){var d,c,p=this._parent("Digger.Mode"),u=null;if(p)u=p.Clone().GetPropertyValue().GetValue();if(d=this._parent(e))if(c=d.GetPropertyInfo()){var D="Digger.ZoomFactor"===e;c.SetVisible(0===u?D:!D)}}return i}})}),define("DS/VCXWebDigger/VCXDiggerNode",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/VCXWebIO/VCXFileServices","DS/VCXWebVisualization/VCXPickerTools","DS/VCXWebDressup/VCXDressupNode","DS/VCXWebDressupServices/ViewerUtils","DS/VCXWebDressup/VCXCmdChangeDressup","DS/VCXWebDressup/VCXMarkup_Spec","DS/VCXWebDigger/VCXDigger_Spec","DS/VCXWebDiggerKernel/VCXDiggerKernel","DS/VCXWebDigger/VCXDiggerUI","DS/VCXWebVisualization/VCXPublishRasterImage","DS/WebappsUtils/WebappsUtils","DS/Core/PointerEvents","DS/VCXWebProperties/VCXPropertyValuePoint2D","DS/VCXWebProperties/VCXPropertyValueBoolean","DS/VCXWebProperties/VCXPropertyValueFloat","DS/VCXWebProperties/VCXPropertyValueEnum","DS/VCXWebProperties/VCXPropertyValueAnchor","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebProperties/VCXPropertyValueVector","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernel/VCXCmdChangeSelection","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebGUIInfra/VCXArcBar","DS/VCXWebKernelCommands/VCXCmdChangeVisibility","i18n!DS/VCXWebDigger/assets/nls/VCXWebDigger"],function(e,t,i,r,o,n,s,a,g,h,l,d,c,p,u,D,_,V,C,b,y,P,v,M,f,S,m,X,x){"use strict";var w=o.extend({init:function(i){this._parent(i),this._viewerDigger=null,this.DiggerKernel=null,this.DiggerUI=null,this._previousVPTarget=new e.Vector3(0,0,0),this._previousVPOrientation=new e.Quaternion(0,0,0,0),this._attachDiv1=null,this._attachDiv2=null,this._angleZoom=-135,this._angleDepth=-135,this._viewer=null,this._displayUI=!0,this._buttonResize=null,this._buttonResizeGhost=null,this._buttonSlider=null,this._buttonSliderShadow=null,this._modeBackgroundColor="linear-gradient(rgb(216,233,248) 0, rgb(216,233,248) 35%, rgb(160,202,241) 100%)",this._modeBackgroundColorDefault="rgba(239,239,239,1)",this._isDragged=null,this._updatePickabilityTimer=null,this._anchorVect3=new e.Vector3(0,0,0),this._previousAnchorPosition=null,this.onPropertiesChanged=(e=>{this.isVisible()&&this.projectionTypeChanged()&&this._viewerDigger.render()}),this._tokenPropertiesChanged=t.subscribe({event:"VCX_PROPERTIES_CHANGED"},this.onPropertiesChanged),this.onStartPauseStopPlayBeginEndTransition=(e=>{if(this.isVisible()){var t=this.Modifiable.GetObject();t._DiggerDirtyMask|=g.FDirty.Buttons,t.setDirty()}}),this._tokenStartPlay=t.subscribe({event:"VCX_START_PLAY"},this.onStartPauseStopPlayBeginEndTransition),this._tokenPausePlay=t.subscribe({event:"VCX_PAUSE_PLAY"},this.onStartPauseStopPlayBeginEndTransition),this._tokenStopPlay=t.subscribe({event:"VCX_STOP_PLAY"},this.onStartPauseStopPlayBeginEndTransition),this._tokenScenarioEndReached=t.subscribe({event:"VCX_SCENARIO_END_REACHED"},this.onStartPauseStopPlayBeginEndTransition),this._tokenBeginTransition=t.subscribe({event:"VCX_BEGIN_TRANSITION"},this.onStartPauseStopPlayBeginEndTransition),this._tokenEndTransition=t.subscribe({event:"VCX_END_TRANSITION"},this.onStartPauseStopPlayBeginEndTransition)},disposeViewer:function(){var e=this.DiggerKernel._viewer.currentViewpoint;if(e&&e.control&&(e.control._mouseWheel=null,e.control._zoom=null),this.DiggerKernel.removeOverrides(),this.removeViewer(),this._viewerDigger){for(;this._viewerDigger.getRootNode().getChildren().length;)this._viewerDigger.getRootNode().removeChild(this._viewerDigger.getRootNode().getChildren()[0]);this._viewerDigger.removeViewpoint(0),this._viewerDigger.dispose(),this._viewerDigger=null}},dispose:function(){this.deleteDiggerPanelToolbar(),this.disposeViewer(),this._tokenPropertiesChanged&&(t.unsubscribe(this._tokenPropertiesChanged),this._tokenPropertiesChanged=null),this._tokenVCX_LPR_Desactivate&&(t.unsubscribe(this._tokenVCX_LPR_Desactivate),this._tokenVCX_LPR_Desactivate=null),this._tokenVCX_LPR_Activate&&(t.unsubscribe(this._tokenVCX_LPR_Activate),this._tokenVCX_LPR_Activate=null),this._tokenStartPlay&&(t.unsubscribe(this._tokenStartPlay),this._tokenStartPlay=null),this._tokenPausePlay&&(t.unsubscribe(this._tokenPausePlay),this._tokenPausePlay=null),this._tokenStopPlay&&(t.unsubscribe(this._tokenStopPlay),this._tokenStopPlay=null),this._tokenScenarioEndReached&&(t.unsubscribe(this._tokenScenarioEndReached),this._tokenScenarioEndReached=null),this._tokenBeginTransition&&(t.unsubscribe(this._tokenBeginTransition),this._tokenBeginTransition=null),this._tokenEndTransition&&(t.unsubscribe(this._tokenEndTransition),this._tokenEndTransition=null),this._tokenVCX_AMBIENCE_CHANGED&&(t.unsubscribe(this._tokenVCX_AMBIENCE_CHANGED),this._tokenVCX_AMBIENCE_CHANGED=null),this.DiggerKernel&&(this.DiggerKernel.dispose(),this.DiggerKernel=null),this.DiggerUI&&(this.DiggerUI.dispose(),this.DiggerUI=null),this.removeDiv(),this._buttonResize&&(this._buttonResize_POINTERDOWN&&(this._buttonResize.removeEventListener(p.POINTERDOWN,this._buttonResize_POINTERDOWN),this._buttonResize_POINTERDOWN=null),this._buttonResize=null),this._buttonSlider&&(this._buttonSlider_POINTERDOWN&&(this._buttonSlider.removeEventListener(p.POINTERDOWN,this._buttonSlider_POINTERDOWN),this._buttonSlider_POINTERDOWN=null),this._buttonSlider=null),this._buttonSliderShadow&&(this._buttonSliderShadow=null),this._buttonResizeGhost&&(this._buttonResizeGhost=null),this._fctWhile=null,this._fctEnd=null,this._viewer=null,this._previousAnchorPosition=null,this._parent()},removeEventListeners:function(){this.divParent.removeEventListener(p.POINTERMOVE,this._fctWhile,!0),this.divParent.removeEventListener(p.POINTERUP,this._fctEnd,!0),this.divParent.style["pointer-events"]="none"},addEventListeners:function(){this.divParent.addEventListener(p.POINTERMOVE,this._fctWhile,!0),this.divParent.addEventListener(p.POINTERUP,this._fctEnd,!0),this.divParent.style["pointer-events"]="unset"},getProp:function(e){var t=-1,i=this.Modifiable.GetProperty(e);i&&(t=i.Clone().GetPropertyValue().GetValue());return t},setProp:function(e,t,i){var r=this.Modifiable;null!==i&&(i.SetValue(e),r.OnChangeProperty(t,i),r.OnChangePropertiesEnd())},getRadius:function(){return this.getProp("Digger.Radius")},setRadius:function(e){this.setProp(e,"Digger.Radius",new _)},getRadiusInPixel:function(){return this.getRadius()*this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio()},setRadiusInPixel:function(e){var t=this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio();this.setRadius(e/t)},getPosition:function(){return this.getProp("Digger.Position")},setPosition:function(e){this.setProp(e,"Digger.Position",new u)},getPositionInPixel:function(){var e=this.getPosition();return this.ExperienceBase.getManager("VCXPaperManager").MMToPixel2(null,e)},setPositionInPixel:function(e){var t=this.ExperienceBase.getManager("VCXPaperManager").PixelToMM2(null,e);this.setPosition(t)},getMode:function(){return this.getProp("Digger.Mode")},setMode:function(e){this.setProp(e,"Digger.Mode",new V)},getZoomFactor:function(){return this.getProp("Digger.ZoomFactor")},setZoomFactor:function(e){this.setProp(e,"Digger.ZoomFactor",new _)},getDepthFactor:function(){return this.getProp("Digger.DepthFactor")},setDepthFactor:function(e){this.setProp(e,"Digger.DepthFactor",new _)},getDepthZoom:function(){return this.getProp("Digger.DepthZoom")},setDepthZoom:function(e){this.setProp(e,"Digger.DepthZoom",new _)},getAttachDisplay:function(){return this.getProp("Digger.Attach")},setAttachDisplay:function(e){this.setProp(e,"Digger.Attach",new D)},isVisible:function(){if(this.Modifiable&&this.Modifiable.GetObject()){var e=this.Modifiable.GetObject().QueryInterface("VCXIVisibility");if(e&&e.GetVisibility()===S.EVisState.Hidden)return!1;if(0===this.GetOpacity()&&0===this._diggerPreviousOpacity)return!1}return!0},getTorchFilter:function(){return this.getProp("Digger.TorchFilter")},setTorchFilter:function(e){this.setProp(e,"Digger.TorchFilter",new D)},convert3DPointToPxl:function(e,t){var i=null;return t&&(i=t.currentViewpoint.project(e)),i},convert3DPointToCanvasPxl:function(t,i,r){var o=null;if(i){var n=i.currentViewpoint.camera;o=t.clone();(new e.Projector).projectVector(o,n),o.x=.5*r.width*(o.x+1),o.y=.5*r.height*(1-o.y)}return o},getAnchorVector:function(){var t=Object.keys(this.Anchors)[0];return(new e.Vector3).getPositionFromMatrix(this.Modifiable.GetAnchorWorldMatrix(t,null))},getPaperCenter3D:function(){var t=this.ExperienceBase.getManager("VCXPaperManager"),i=t.Size.x,o=t.Size.y,n=new e.Vector2(0,0);n.x=0+.5*i,n.y=0+.5*o;var s=t.MMToPixel2(null,n),a=this.ExperienceBase.getManager("VCXContextManager").getMainViewer();if(a){var g=a.div.getBoundingClientRect();s.x+=g.left,s.y+=g.top}return new r(this.ExperienceBase).pick2DonGround(this.ExperienceBase.getManager("VCXContextManager").getMainViewer(),s.x,s.y)},calcDiggerPositionToAnchorAngle:function(e,t,i){var r,o=i.x-t.x,n=i.y-t.y;return Math.sqrt(o*o+n*n)-e<0?-1:(r=0===o?270:-Math.atan(n/o)*(180/Math.PI),o<0?r+=180:o>0&&n>0&&(r+=360),r)},calcDiggerAnchorPoints:function(t,i,r){var o=this.calcDiggerPositionToAnchorAngle(t,i,r);if(-1===o)return null;var n=new e.Vector2;n.x=i.x+t*this.myCos(o*Math.PI/180),n.y=i.y-t*this.mySin(o*Math.PI/180);var s=new e.Vector2,a=new e.Vector2,g=this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio()*window.devicePixelRatio,h=this.Modifiable.GetObject().borderThickness*g*.4;return s.x=n.x+h*this.myCos((o+90)*Math.PI/180),s.y=n.y-h*this.mySin((o+90)*Math.PI/180),a.x=n.x+h*this.myCos((o-90)*Math.PI/180),a.y=n.y-h*this.mySin((o-90)*Math.PI/180),{p1:s,p2:a}},drawTriangle:function(e,t,i,r,o,n){var s=this.getRadiusInPixel(),a=i.x-t.x,g=i.y-t.y,h=Math.sqrt(a*a+g*g)-s-this.Modifiable.GetObject().borderThickness+n;if(h<0)e.style.display="none";else{e.style.display="",e.style.width="0px",e.style.height="0px",e.style.position="absolute",e.style.display="block",e.style.borderRight=r+"px solid transparent",e.style.borderBottom=h+"px solid "+o,e.style.borderLeft=e.style.borderRight;var l=Math.atan(g/a)*(180/Math.PI);a>0&&g<0?l-=90:a>0&&g>0?l-=90:l+=90;var d=-r+s,c=-.5*h+s,p=-(.5*h+s)-this.Modifiable.GetObject().borderThickness+n;e.style.transform="translate("+d+"px, "+c+"px) rotate("+l+"deg) translateY("+p+"px)"}},updateDiggerAttach:function(e){if(this.getAttachDisplay()&&this._attachDiv1&&this._attachDiv2){void 0===e&&(e=this.getAnchorVector());var t=this.convert3DPointToPxl(e,this._viewer),i=this.getPositionInPixel();this.drawTriangle(this._attachDiv1,t,i,12,"rgb(250,250,250)",0),this.drawTriangle(this._attachDiv2,t,i,13,"rgb(60,60,60)",1),this.DiggerKernel._attachP=t}},updateDiggerUI:function(){if(this._divDigger){var e=this.getRadiusInPixel(),t=this.getPositionInPixel();this._divDigger.style.left=t.x-e+"px",this._divDigger.style.top=t.y-e+"px",this._divDigger.style.height=2*e+"px",this._divDigger.style.width=this._divDigger.style.height,this._divDiggerContent.style.height=2*(e-this.Modifiable.GetObject().borderThickness)+"px",this._divDiggerContent.style.width=this._divDiggerContent.style.height,this.updateButtons()}},myCos:function(e){var t=0;return e<-3.14159265?e+=6.28318531:e>3.14159265&&(e-=6.28318531),(e+=1.57079632)>3.14159265&&(e-=6.28318531),t=e<0?(t=1.27323954*e+.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t:(t=1.27323954*e-.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t},mySin:function(e){var t=0;return e<-3.14159265?e+=6.28318531:e>3.14159265&&(e-=6.28318531),t=e<0?(t=1.27323954*e+.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t:(t=1.27323954*e-.405284735*e*e)<0?.225*(t*-t-t)+t:.225*(t*t-t)+t},updateButtons:function(){var e;if(e=this._displayUI?"":"none",this._toolbar&&this._toolbar.updateCommandState(),this._buttonResize.style.display=e,this._buttonResizeGhost.style.display=e,this._buttonSlider.style.display=e,this._buttonSliderShadow.style.display=e,this._displayUI){var t,i=this.getRadiusInPixel(),r="translate("+(-3+i)+"px,"+(i-30)+"px)";r+=" rotate("+-30+"deg)",r+="translateX("+-(4.5+i)+"px",this._buttonResize.style.transform=r;r="translate("+(-7+i-.2)+"px,"+(i-10)+"px)";r+=" rotate("+(t=this.getMode()===g.EMode.Zoom?this.factor2angle(this.getZoomFactor()):this.factor2angle(this.getDepthFactor()))+"deg)",r+="translateY("+(15-this.Modifiable.GetObject().borderThickness+i+1.2)+"px",this._buttonSlider.style.transform=r;r="translate("+(-9.5+i)+"px,"+(i-10.5)+"px)";r+=" rotate("+t+"deg)",r+="translateY("+(15-this.Modifiable.GetObject().borderThickness+i+2)+"px",this._buttonSliderShadow.style.transform=r}},_Build:function(){this.DiggerKernel=new h,this.DiggerUI=new l;var e=this.Modifiable.GetObject();this.DiggerUI.diggerComponent=e,this._viewer=this.ExperienceBase.getManager("VCXContextManager").getMainViewer(),this.divParent=this.ExperienceBase.getManager("VCXDressupManager").getDressupsOverViewerDiv();var t=this.getRadiusInPixel(),i=this.getPositionInPixel();this.DiggerKernel._radiusPx=t,this.DiggerKernel._positionPx=i,this.cssStylesBorderDigger={position:"absolute",textAlign:"left",top:i.x-t+"px",left:i.y-t+"px",height:2*t+"px",width:2*t+"px",border:"1px solid "+e.borderLineOuterColor.GetStyle(),backgroundColor:e.borderColor.GetStyle(),borderRadius:"50%",boxShadow:"0px 0px 0px 1px "+e.borderLineInnerColor.GetStyle(),"pointer-events":"all"},this.cssStylesContentDigger={position:"absolute",height:2*(t-this.Modifiable.GetObject().borderThickness)+"px",width:2*(t-this.Modifiable.GetObject().borderThickness)+"px",borderRadius:"50%",boxShadow:"0px 0px 0px 1px "+e.borderLineInnerColor.GetStyle(),margin:"auto",top:"0",left:"0",bottom:"0",right:"0"},this._divDigger=new UWA.Element("div",{id:"divDigger",styles:this.cssStylesBorderDigger}),this._divDigger.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_divDigger"),this._divDiggerContent=new UWA.Element("div",{id:"divDiggerContent",styles:this.cssStylesContentDigger}),this._divDiggerContent.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_divDiggerContent"),this._divDiggerContent.inject(this._divDigger),this._divDigger.inject(this.divParent),this._attachDiv2=document.createElement("div"),this._divDigger.appendChild(this._attachDiv2),this._attachDiv1=document.createElement("div"),this._divDigger.appendChild(this._attachDiv1),this._attachDiv1.style.pointerEvents="none",this._attachDiv2.style.pointerEvents="none",this._attachDiv1.style.opacity="0.9",this._attachDiv2.style.opacity="0.5",this.updateAnchorAttach(!1),this._buttonResizeGhost=document.createElement("canvas"),this._buttonResizeGhost.style.margin="-4px",this._buttonResizeGhost.style.width="408px",this._buttonResizeGhost.style.height="408px",this._buttonResizeGhost.style.borderRadius="inherit",this._buttonResizeGhost.style.transform="rotate(0deg)";var r=this._buttonResizeGhost.getContext("2d");r.canvas.width=408,r.canvas.height=408,r.save(),r.shadowBlur=1,r.shadowColor="gray",r.fillStyle="rgba(200, 200, 200, 0.95)",r.clearRect(0,0,r.canvas.width,r.canvas.height),r.beginPath();var o=Math.PI/27;r.arc(207,204,188,Math.PI-o,Math.PI+o);var s=207+200*this.myCos(Math.PI+o),a=204+200*this.mySin(Math.PI+o);r.lineTo(s,a);for(var g=2*o/30,d=Math.PI+o,c=0;c<30;c++)d-=g,s=207+200*this.myCos(d),a=204+200*this.mySin(d),r.lineTo(s,a);r.closePath(),r.fill(),r.restore(),r.beginPath(),r.strokeStyle="#FFFFFF",r.arc(207,204,194,Math.PI-Math.PI/35,Math.PI+Math.PI/35),r.stroke(),this._buttonResize=document.createElement("canvas"),this._buttonResize.setAttribute("class","VCXsizeButton"),this._buttonResize.style.margin="-4px",this._buttonResize.style.transform="translate(-5px,"+(t-30)+"px) rotate(0deg)",this._buttonResize.style.cursor="sw-resize",this._buttonResize.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_VCXsizeButton"),this._divDigger.appendChild(this._buttonResize);var p=this._buttonResize.getContext("2d");p.canvas.width=22,p.canvas.height=60,p.drawImage(this._buttonResizeGhost,0,-175),this._buttonSliderShadow=UWA.createElement("div",{html:"",class:"VCXDiggerButtonZoomShadow",styles:{height:0,width:"2px",borderBottom:"21px solid rgba(0,0,0,0.6)",borderLeft:"3px solid transparent",borderRight:"4px solid transparent",padding:"0 8px 0 0",position:"absolute",transform:"rotate(135deg) translate(-43px,-22px)",top:"0px"}}),this._divDigger.appendChild(this._buttonSliderShadow),this._buttonSlider=UWA.createElement("div",{html:"",class:"VCXDiggerButtonZoom",styles:{height:0,width:"0px",borderBottom:"20px solid rgba(255,255,255,0.9)",borderLeft:"1px solid transparent",borderRight:"3px solid transparent",padding:"0 8px 0 0",position:"absolute",transform:"rotate(135deg) translate(-43px,-22px)",top:"0px",cursor:"s-resize"}}),this._buttonSlider.setAttribute("data-rec-id",this.Modifiable.GetObject().GetID()+"_VCXDiggerButtonZoom"),this._divDigger.appendChild(this._buttonSlider),this.createDiggerPanelToolbar();var u=this.Modifiable;if(!u)return;let D="viewer_"+u.GetObject().GetID();this._viewerDigger=n.createViewer(this.ExperienceBase,this._divDiggerContent,D,this.ExperienceBase.getManager("VCXContextManager").getMainViewer()),this._viewerDigger._isDigger=!0,this._viewerDigger.getRootNode().name="diggerRootNode";var _=this.ExperienceBase.getManager("VCXContextManager").getMainViewer().ambience;_&&this._viewerDigger.setAmbience(_),this.DiggerKernel._diggerViewpoint=this._viewerDigger.currentViewpoint;var V=this.ExperienceBase.getManager("VCXContextManager").getRootNode();if(V){var C=this._viewerDigger.getSceneGraphOverrideSetManager();this.DiggerKernel._SceneGraphOverrideSet=new f(V),C.pushSceneGraphOverrideSet(this.DiggerKernel._SceneGraphOverrideSet)}this._viewerDigger.canvas.style.borderRadius="inherit",this._viewerDigger.canvas.style.textAlign="left",this.synchronizeDiggerViewport(),this.synchronizeDiggerGround(),this.initDiggerDressup(),this.addPointerEvents(),this.updateButtons(),this.ExperienceBase.getManager("VCXVisuManager").getActiveViewport().update({viewer:this._viewerDigger,force:!0})},removeDiv:function(){this._divDigger&&(this._divDigger_POINTERDOWN&&(this._divDigger.removeEventListener(p.POINTERDOWN,this._divDigger_POINTERDOWN),this._divDigger_POINTERDOWN=null),this.divParent.removeChild(this._divDigger)),this._divDigger=null},dragWhileFactory:function(t){if(this.DiggerKernel._lockPickability=!0,this.Modifiable){var i=t.clientX,r=t.clientY;t.preventDefault(),t.stopPropagation();var o=this.getRadiusInPixel(),n=new e.Vector2;n.x=i-this._ondragDeltaX+o,n.y=r-this._ondragDeltaY+o,this._divDigger.style.left=i-this._ondragDeltaX+"px",this._divDigger.style.top=r-this._ondragDeltaY+"px",this.setPositionInPixel(n),this._toolbar.setInManipulation(!0),this._toolbar.updateVisibilityStyle()}},dragEndFactory:function(e){this.DiggerKernel._lockPickability=!1,this.removeEventListeners();var t=this.Modifiable.GetProperty("Digger.Position").Clone(),i=new u,r=this.getPosition();i.SetValue(r),t.SetPropertyValue(i);var o=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));o.ChangeProperty(this.Modifiable,t),this.ExperienceBase.getManager("VCXCommandManager").Push(o),this.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!0),e.stopPropagation(),this._isDragged=null,this._toolbar.setInManipulation(!1),this._toolbar.updateVisibilityStyle()},moveButtonWhileFactory:function(e){if(this.Modifiable){e.preventDefault(),e.stopPropagation();var t=e.clientX,i=e.clientY,r=this.getPositionInPixel(),o=this._viewer.div.getBoundingClientRect();if(r.x+=o.left,r.y+=o.top,this.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!1),this.DiggerKernel._lockPickability=!0,this._isDragged&&"VCXDiggerButtonZoom"===this._isDragged.className){var n,s=t-r.x,a=i-r.y;if((n=Math.atan2(a,s)-Math.atan2(1,0))>0&&n<.5*Math.PI&&(n=-1e-17),n<0&&(n+=2*Math.PI),n=Math.min(320,Math.max(180*n/Math.PI,204)),this.getMode()===g.EMode.Zoom){var h=this.angle2factor(n);this.DiggerKernel.setZoom(h),this.setZoomFactor(h)}else{var l=this.angle2factor(n);this.DiggerKernel.setDepth(l),this.setDepthFactor(l)}this.updateButtons()}else{var d=t-r.x;d=Math.abs(d*d);var c=i-r.y;c=Math.abs(c*c);var p=Math.sqrt(d+c);this.setRadiusInPixel(p),this.updateDiggerUI(),this._toolbar.setInManipulation(!0),this._toolbar.updateVisibilityStyle()}}},angle2factor:function(e){return e*(1/116)+(0-1/116*204)},factor2angle:function(e){return(e-(0-1/116*204))/(1/116)},moveButtonEndFactory:function(e){if(e.preventDefault(),e.stopPropagation(),this.removeEventListeners(),this._isDragged){var t=null,i=null;"VCXDiggerButtonZoom"===this._isDragged.className?(this.getMode()===g.EMode.Zoom?(t=this.Modifiable.GetProperty("Digger.ZoomFactor").Clone(),(i=new _).SetValue(this.getZoomFactor())):(t=this.Modifiable.GetProperty("Digger.DepthFactor").Clone(),(i=new _).SetValue(this.getDepthFactor())),this.DiggerKernel._lockPickability=!1,this.DiggerKernel.updateDiggerContent()):(t=this.Modifiable.GetProperty("Digger.Radius").Clone(),(i=new _).SetValue(this.getRadius()),this._toolbar.setInManipulation(!1),this._toolbar.updateVisibilityStyle()),t.SetPropertyValue(i);var r=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));r.ChangeProperty(this.Modifiable,t),this.ExperienceBase.getManager("VCXCommandManager").Push(r),this.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!0),this._isDragged=null}},distanceTo:function(e,t,i,r){return Math.sqrt(Math.pow(i-e,2)+Math.pow(r-t,2))},mouseOnBorder:function(e,t,i,r,o,n){var s=this.distanceTo(e,t,i,r);return s<=o&&s>=n},runUpdateCommand:function(e,t){switch(t){case"I_VCX_Digger_Mode_DetailView":e.check=this.getMode()===g.EMode.Detail;break;case"I_VCX_Digger_Mode_Zoom":e.check=this.getMode()===g.EMode.Zoom;break;case"I_VCX_Digger_Mode_XRay":e.check=this.getMode()===g.EMode.XRay;break;case"I_VCX_Digger_Mode_OnionSkin":e.check=this.getMode()===g.EMode.Onion;break;case"I_VCX_Digger_Tool_LockPlanes":e.check=this.DiggerKernel.getLockPlanes(),e.enable=this.getMode()===g.EMode.XRay||this.getMode()===g.EMode.Onion;break;case"I_VCX_Digger_Tool_LockVP":e.check=this.DiggerKernel.getLockViewpoint();break;case"I_VCX_Digger_Tool_Focus":e.check=this.getAttachDisplay()}},runCommand:function(e){switch(e){case"I_VCX_Digger_Mode_Zoom":this.setModeZoom();break;case"I_VCX_Digger_Mode_XRay":this.setModeXRay();break;case"I_VCX_Digger_Mode_OnionSkin":this.setModeOnionSkin();break;case"I_VCX_Digger_Hide":this.setDelete();break;case"I_VCX_Digger_Tool_2DSnapshot":this.setSnapshot2D();break;case"I_VCX_Digger_Tool_LockPlanes":this.setLockPlanes();break;case"I_VCX_Digger_Tool_LockVP":this.setLockViewpoint();break;case"I_VCX_Digger_Tool_Focus":this.setFocus()}},setDelete:function(){var e=this.Modifiable.GetObject();this.ExperienceBase.getManager("VCXSelectionManager").removeComponentsFromSelection([e],!1);var t=new s(this.ExperienceBase.getManager("VCXCommandManager"),this.ExperienceBase.getManager("VCXDressupManager"),this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.ComponentsMap),i=[];i.push(e),t.RemoveDressups(i),this.ExperienceBase.getManager("VCXCommandManager").Push(t)},setModeZoom:function(){this.setMode(g.EMode.Zoom);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new V;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setModeOnionSkin:function(){this.setMode(g.EMode.Onion);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new V;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setModeXRay:function(){this.setMode(g.EMode.XRay);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new V;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setModeDetail:function(){this.setMode(g.EMode.Detail);var e=this.Modifiable.GetProperty("Digger.Mode").Clone(),t=new V;t.SetValue(this.getMode()),e.SetPropertyValue(t);var i=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));i.ChangeProperty(this.Modifiable,e),this.ExperienceBase.getManager("VCXCommandManager").Push(i)},setSnapshot2D:function(){this.createSnapshot2D(!0)},setLockPlanes:function(){this.DiggerKernel.lockPlanes(!this.DiggerKernel.getLockPlanes()),this.DiggerKernel.sortFrontToBack(),this.DiggerKernel.updateDiggerContent(),this.updateButtons()},setLockViewpoint:function(){this.DiggerKernel.lockViewpoint(!this.DiggerKernel.getLockViewpoint()),this.synchronizeDiggerViewpoint(),this.setDiggerViewOffset(),this.updateButtons()},setFocus:function(){if((this.setAttachDisplay(!this.getAttachDisplay()),this.getAttachDisplay())&&this.getAnchorVector().equals(new e.Vector3)){var t=this.getPaperCenter3D(),i=new C;i.SetValueFrame((new b).SetValueFromVector(t)),this.setProp(i.GetValue(),"Actor.Anchor.0",new C)}var r=this.Modifiable.GetProperty("Digger.Attach").Clone(),o=new D;o.SetValue(this.getAttachDisplay()),r.SetPropertyValue(o);var n=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));n.ChangeProperty(this.Modifiable,r),this.ExperienceBase.getManager("VCXCommandManager").Push(n)},addPointerEvents:function(){this._divDigger_POINTERDOWN=(e=>{e.stopPropagation(),this._isDragged=this._divDigger;var t=e.clientX,i=e.clientY,r=this.getRadiusInPixel(),o=this.getPositionInPixel(),n=o.x-r,s=o.y-r,a=this._viewer.div.getBoundingClientRect();if(o.x+=a.left,o.y+=a.top,this.mouseOnBorder(o.x,o.y,t,i,r,r-this.Modifiable.GetObject().borderThickness)){var g=new M(this.ExperienceBase.getManager("VCXSelectionManager"));g.SetSelection(this.Modifiable.GetObject()),this.ExperienceBase.getManager("VCXCommandManager").Do(g),this._ondragDeltaX=t-n,this._ondragDeltaY=i-s,this._isDragged=!0,this.ExperienceBase.getManager("VCXContextManager").setAllViewerSensitive(!1),this._fctWhile=this.dragWhileFactory.bind(this),this._fctEnd=this.dragEndFactory.bind(this),this.addEventListeners()}}),this._divDigger.addEvent(p.POINTERDOWN,this._divDigger_POINTERDOWN),this._buttonResize_POINTERDOWN=(e=>{e.stopPropagation(),this._isDragged=this._buttonResize,this.removeEventListeners(),this._fctWhile=this.moveButtonWhileFactory.bind(this),this._fctEnd=this.moveButtonEndFactory.bind(this),this.addEventListeners()}),this._buttonResize.addEventListener(p.POINTERDOWN,this._buttonResize_POINTERDOWN),this._buttonSlider_POINTERDOWN=(e=>{e.stopPropagation(),this._isDragged=this._buttonSlider,this.removeEventListeners(),this._fctWhile=this.moveButtonWhileFactory.bind(this),this._fctEnd=this.moveButtonEndFactory.bind(this),this.addEventListeners()}),this._buttonSlider.addEventListener(p.POINTERDOWN,this._buttonSlider_POINTERDOWN.bind(this))},updateAnchorAttach:function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this.getAttachDisplay()&&t?(this._attachDiv1.style.display="",this._attachDiv2.style.display="",e&&this.updateDiggerAttach()):(this._attachDiv1.style.display="none",this._attachDiv2.style.display="none")},synchronizeDiggerViewport:function(){var e=this.ExperienceBase.getManager("VCXVisuManager").getActiveViewport();if(e){var t=e.QueryInterface("VCXIModifiable");if(t){var i=t.GetProperties();t._forceRefresh=!0,i.onEachProperty(function(e,i){t.OnChangeProperty(e,i.GetPropertyValue())}),t.OnChangePropertiesEnd();var r=t.QueryInterface("W3AISGNodeHolder");r&&r.setSGNodeDirty(!0),t._forceRefresh=!1;var o=t.GetObject();this.ExperienceBase.getManager("VCXContextManager").getExperienceIn3DPlay()?o.setLightingModeForComposerPlayer(t.GetPropertyValue("Render.Lighting.Override"),t.GetPropertyValue("Render.Lighting.Mode"),t.GetPropertyValue("Render.Lighting.Intensity"),t.GetPropertyValue("Render.Lighting.Static")):o.setLightingMode(t.GetPropertyValue("Render.Lighting.Override"),t.GetPropertyValue("Render.Lighting.Mode"),t.GetPropertyValue("Render.Lighting.Intensity"),t.GetPropertyValue("Render.Lighting.Static"))}}},synchronizeDiggerGround:function(){var e=this.ExperienceBase.ComponentsMap.GetComponentFromType("VCXComponentGround");if(e&&e.length){var t=e[0].QueryInterface("VCXIModifiable");if(t){var i=t.GetProperties();t._forceRefresh=!0,i.onEachProperty(function(e,i){t.OnChangeProperty(e,i.GetPropertyValue())}),t.OnChangePropertiesEnd();var r=t.QueryInterface("W3AISGNodeHolder");r&&r.setSGNodeDirty(!0),t._forceRefresh=!1}}},removeViewer:function(){var e=this.Modifiable;e&&this.ExperienceBase.getManager("VCXContextManager").removeViewer("viewer_"+e.GetObject().GetID())},setVisibility:function(e){this._parent(e),e?(this._viewerDigger||this._Build(),this.GetOpacity(),this._divDigger.style.display=""):this._divDigger.style.display="none",this._toolbar&&(this._toolbar.setVisible(e),this._toolbar.updateVisibilityStyle()),this.updateAnchorAttach(!0,e)},preRender:function(e){if(this.isVisible&&(this._parent(e),this._viewerDigger||this._Build(),this._toolbar&&this._toolbar.isVisible())){var t=this.calcToolbarInfo();this._toolbar.updateLayout(t.centerPx,t.radiusPx)}return!1},update:function(e){if(this.ExperienceBase.getManager("VCXVisuManager").HasViewpointMoved&&(this._diggerViewpointIsDirty=!0),this.isVisible()){this._viewerDigger||this._Build(),this._parent(e);var t=this.Modifiable;this._displayUI=!this.ExperienceBase.getManager("VCXScenarioManager").GetIsPlayingCurrentScenario()&&!this.ExperienceBase.getManager("VCXVisuManager").isInTransitionMode();var i=t.GetObject(),r=!1,o=!1,n=!1;if(this._toolbar&&this._toolbar.setVisible(this._displayUI),this._diggerViewpointIsDirty&&(this._diggerViewpointIsDirty=!1,i._DiggerDirtyMask|=g.FDirty.ViewpointMoved,this.getAttachDisplay()&&this.DiggerKernel.getLockViewpoint()||(this.synchronizeDiggerViewpoint(),o=!0)),this._divDigger){var s=this.GetOpacity();if(this._diggerPreviousOpacity!==s||0===s&&0!==this._diggerPreviousOpacity){0===s&&0!==this._diggerPreviousOpacity||0!==s&&this._diggerPreviousOpacity,this._diggerPreviousOpacity=s,this._divDigger.style.opacity=s;var a=!0,l="inherit";0===s?(a=!1,l="hidden",this.DiggerKernel._lockUpdateDigger=!0):this.DiggerKernel._lockUpdateDigger=!1,this._toolbar&&(this._toolbar.setRelatedOpacity(s),this._toolbar.setVisible(a&&this._displayUI)),this._divDigger.style&&(this._divDigger.style.visibility=l),this._viewerDigger&&this._viewerDigger.div&&this._viewerDigger.div.style&&(this._viewerDigger.div.style.visibility=l)}}this._toolbar&&this._toolbar.updateVisibilityStyle();var d=this.getRadiusInPixel();if(this._previousRadius!==d&&(i._DiggerDirtyMask|=g.FDirty.Radius,n=!0,this._previousRadius=d,this.DiggerKernel._radiusPx=d),this._divDigger){var c=this.getPositionInPixel();if(void 0===this._previousPosition||this._previousPosition.distanceTo(c)>1e-5){d=this.getRadiusInPixel();this._divDigger.style.left=c.x-d+"px",this._divDigger.style.top=c.y-d+"px",this.getAttachDisplay()||(n=!0),this._previousPosition=c,this.DiggerKernel._positionPx=c,i._DiggerDirtyMask|=g.FDirty.Position}}var p=this.getAttachDisplay();this._previousAttachDisplay!==p&&(this.DiggerKernel.setAttach(p),this.updateAnchorAttach(),this.DiggerKernel.resetTorchInfo(),r=!0,this.DiggerKernel.getLockViewpoint()||(n=!0),i._DiggerDirtyMask|=g.FDirty.Buttons,this._previousAttachDisplay=p);var u=this.getTorchFilter();if(this._previousTorchFilter!==u&&(this.DiggerKernel.setTorchFilter(this.getTorchFilter()),this.getMode()!==g.EMode.Zoom&&(this.DiggerKernel.resetTorchInfo(),r=!0),this._previousTorchFilter=u),t.getAnchorsCount()){var D=Object.keys(t._Anchors)[0],_=t.GetAnchorValue(D);_!==this._previousAnchorPosition&&(i._DiggerDirtyMask|=g.FDirty.AnchorPosition,this._previousAnchorPosition=_)}this.getAttachDisplay()&&i._DiggerDirtyMask&(g.FDirty.Position|g.FDirty.Radius|g.FDirty.AnchorPosition|g.FDirty.ViewpointMoved)&&this.updateDiggerAttach();var V=this.getMode();this._previousMode!==V&&(this.DiggerKernel.resetDepth(),this._previousDepthFactor=null,this.DiggerKernel.resetZoom(),this._previousZoomFactor=null,V===h.EDigMode.Linear?this.DiggerKernel.removeOverrides():(V===h.EMode.XRay&&this._previousMode!==h.EMode.Onion||V===h.EMode.Onion&&this._previousMode!==h.EMode.XRay)&&(o=!0),this.DiggerKernel.setMode(V),this._previousMode=V);var C=this.getZoomFactor();this._previousZoomFactor!==C&&(this.DiggerKernel.setZoom(C),r=!0,n=!0,i._DiggerDirtyMask|=g.FDirty.Buttons,this._previousZoomFactor=C);var b=this.getDepthFactor();this._previousDepthFactor!==b&&(this.DiggerKernel.setDepth(b),r=!0,i._DiggerDirtyMask|=g.FDirty.Buttons,this._previousDepthFactor=b);var y=this.getDepthZoom();if(this._previousDepthZoom!==y&&(this.DiggerKernel.setDepthZoom(y),r=!0,n=!0,this._previousDepthZoom=y),i._DiggerDirtyMask&g.FDirty.Radius?this.updateDiggerUI():i._DiggerDirtyMask&g.FDirty.Buttons&&this.updateButtons(),this.getMode()!==g.EMode.XRay&&this.getMode()!==g.EMode.Onion||(o&&(this.DiggerKernel.resetArray(!1),r=!0),this.getAttachDisplay()?i._DiggerDirtyMask&g.FDirty.AnchorPosition&&this.getTorchFilter()&&(this.DiggerKernel.resetTorchInfo(),r=!0):i._DiggerDirtyMask&(g.FDirty.Position|g.FDirty.Radius)&&this.getTorchFilter()&&(this.DiggerKernel.resetTorchInfo(),r=!0)),r&&e.time&&(this.DiggerKernel._lockPickability=!0,this.DiggerKernel.updateDiggerContent(),i._dirtyPickability||(i._dirtyPickability=!0),this._dirtyPickabilityStartTime=e.time),i._dirtyPickability&&e.time-this._dirtyPickabilityStartTime>500&&(this.DiggerKernel._lockPickability=!1,this.DiggerKernel._lockOpacity=!0,this.DiggerKernel.updateDiggerContent(),this.DiggerKernel._lockOpacity=!1,i._dirtyPickability=!1,this._dirtyPickabilityStartTime=null),this.getAttachDisplay()&&!this.DiggerKernel.getLockViewpoint()&&i._DiggerDirtyMask&(g.FDirty.AnchorPosition|g.FDirty.ViewpointMoved)&&(n=!0),n&&this.setDiggerViewOffset(),i._DiggerDirtyMask&&i._DiggerDirtyMask!==g.FDirty.Position||!this.getAttachDisplay()||r||o||n){var P=i.QueryInterface("VCXIReadiness");P&&(this._renderPromise&&this._renderPromise.resolve(),P.clearPromises(),this._renderPromise=UWA.Promise.deferred(),P.registerPromise(this._renderPromise.promise)),this._viewerDigger.render()}i.setDirty(!1),i._DiggerDirtyMask=0}},postUpdate:function(){if(this._renderPromise){this._renderPromise.resolve();var e=this.Modifiable.QueryInterface("VCXIReadiness");e&&e.clearPromises(),delete this._renderPromise}},initDiggerDressup:function(){this.DiggerKernel._experienceBase=this.ExperienceBase,this.DiggerKernel._viewer=this._viewerDigger,this.DiggerKernel._viewer.setSmallRenderTargetPicking(!0),this.DiggerKernel.setMode(this.getMode()),this.DiggerKernel.setZoom(this.getZoomFactor()),this.DiggerKernel.setAttach(this.getAttachDisplay()),this.synchronizeDiggerViewpoint(),this.setDiggerViewOffset(),this.DiggerKernel.updateDiggerContent(!0);var e=this.DiggerKernel._viewer.currentViewpoint;if(e.control){var t=e.control;e.control._zoom=((e,i)=>{var r,o;if(t.update(),r=e.y-i.y,1!==(o=1+(r*=.5/this.radiusZoom)*this.zoomSpeed)&&o>0){var n=(1-o)/5;this.zoom(n)}}),e.control._mouseWheel=(e=>{e.event.preventDefault();var t=UWA.Event.wheelDelta(e.getJSEvent());if(!this.DiggerKernel.getLockViewpoint()){var i=t/15;this.zoom(i)}})}},zoom:function(e){var t;t=this.DiggerKernel.getMode()===g.EMode.Zoom?"Digger.ZoomFactor":"Digger.DepthZoom";var i=this.getProp(t);i+=e,i=Math.min(i,1),i=Math.max(i,0),this.DiggerKernel.getMode()===g.EMode.Zoom?this.DiggerKernel.setZoom(i):this.DiggerKernel.setDepthZoom(i);var r=this.Modifiable,o=new _;o.SetValue(i);var n=r.GetProperty(t).Clone();n.SetPropertyValue(o);var s=new v(this.ExperienceBase.getManager("VCXScenarioManager"),this.ExperienceBase.getManager("VCXCommandManager"));s.ChangeProperty(r,n),this.ExperienceBase.getManager("VCXCommandManager").Push(s)},setDiggerViewOffset:function(){var t=this.ExperienceBase.getManager("VCXPaperManager"),i=1,r=0;r=this.DiggerKernel.getMode()===g.EMode.Zoom?this.getZoomFactor():this.getDepthZoom(),i=1-(r=Math.min(1,r)),i=Math.max(i,1e-10);var o=this._viewerDigger.div.clientWidth*i,n=this._viewerDigger.div.clientHeight*i,s=0,a=0;if(this.getAttachDisplay()){var h=this.getAnchorVector(),l=null;if((l=this.DiggerKernel.getLockViewpoint()?this._viewerDigger:this._viewer)===this._viewerDigger)this.getPositionInPixel();this.convert3DPointToPxl(h,l);var d=this.convert3DPointToPxl(h,this._viewer);s=t._ViewBoxPx.x-d.x+o/2,a=t._ViewBoxPx.y-d.y+n/2}else{var c=new e.Vector2(this._divDigger.offsetLeft,this._divDigger.offsetTop);s=t._ViewBoxPx.x-c.x-this._viewerDigger.div.offsetLeft-1-o*(1/i-1)/2,a=t._ViewBoxPx.y-c.y-this._viewerDigger.div.offsetTop-1-n*(1/i-1)/2}var p=t._ViewBoxPxSize.x,u=t._ViewBoxPxSize.y;this._viewerDigger.currentViewpoint.setViewOffset({fullWidth:p,fullHeight:u,x:-s,y:-a,width:o,height:n})},projectionTypeChanged:function(){if(!this._viewer||!this._viewerDigger)return!1;var e=this._viewer.currentViewpoint;return this._viewerDigger.currentViewpoint.getProjectionType()!==e.getProjectionType()},synchronizeDiggerViewpoint:function(){this.DiggerKernel._lockSynchronizeDiggerViewpoint=!0;var e=this._viewer.currentViewpoint,t=this._viewerDigger.currentViewpoint;this.projectionTypeChanged()&&(t.setProjectionType(e.getProjectionType()),t.setPixelCulling(e.camera.pixelCulling)),t.setAngle(e.getAngle()),t.setEyePosition(e.getEyePosition().clone()),t.setTarget(e.getTarget().clone()),t.setUpDirection(e.getUpDirection().clone()),this.DiggerKernel._lockSynchronizeDiggerViewpoint=!1},isNodeBuilt:function(){return Boolean(this._divDigger)},doHiRes:function(e,t,i){e=this.ExperienceBase;var r=new d;return r._viewer=this.DiggerKernel._viewer,r._usePaperRatio=!1,r._doHiResImage(e,t,i).then(function(e){return{diggerNode:this,image:e}}.bind(this))},createSnapshot2D:function(e){var t=this.ExperienceBase,i=1.5*this.DiggerKernel._viewer.SCREEN_WIDTH,r=1.5*this.DiggerKernel._viewer.SCREEN_HEIGHT;this.doHiRes(t,i,r).then(i=>{if(i.diggerNode.createUpdatePanel(i.image,1.5),e&&i.diggerNode.Modifiable&&i.diggerNode.Modifiable.GetObject()){var r=new X(t.getManager("VCXScenarioManager"),t.ComponentsMap,t.getManager("VCXCommandManager"));r.ChangeVisibility([i.diggerNode.Modifiable.GetObject()],S.EVisState.Hidden),t.getManager("VCXCommandManager").Do(r)}})},createUpdatePanel:function(e,t){if(!e)return!1;var r=this.ExperienceBase,o=r.getManager("VCXPaperManager").GetMmToPxRatio()*t,n=e.getPixelWidth()/o,g=(e.getPixelHeight(),n/2),h=e.toCanvas().toDataURL("image/jpeg"),l=null,d=this.getProp("Digger.AssociatedPanelID");d&&(l=this._ExperienceBase.ComponentsMap.GetComponentFromID(d));var c=(e,t)=>{var o=e.QueryInterface("VCXIModifiable");if(o){var l=this.Modifiable.GetObject(),d=new P(l.GetID());o.OnChangeProperty("Collab.AssociatedObjectID",d);var c=i.dataURLToBlob(h);if(c){var p=window.URL.createObjectURL(c),u=r.getManager("VCXDocManager").BuildPathFromString(p),C=r.getManager("VCXDocManager").AddOrModifyDoc(u);o.OnChangeProperty("Collab.Image.Doc.ID",C);var b=new _;if(b.SetValue(this.GetPropertyValue("Actor.Opacity")),o.OnChangeProperty("Actor.Opacity",b),!t){var v=new V;v.SetValue(a.EBillboardType.Spherical),o.OnChangeProperty("Collab.3D.Paper.Billboard.Type",v);var f=new V;f.SetValue(a.EBodyShape.Circle),o.OnChangeProperty("Collab.Body.Shape",f);var m=new D;m.SetValue(!0),o.OnChangeProperty("Collab.Border.Show",m);var x=new D(!0);o.OnChangeProperty("Collab.Background.Show",x);var w=new D;w.SetValue(!0),o.OnChangeProperty("Collab.Body.Shadow.Show",w)}var I=new D;I.SetValue(this.getAttachDisplay()),o.OnChangeProperty("Collab.Attach.Show",I);var E=this.Modifiable.GetProperty("Actor.Anchor.0").Clone().GetPropertyValue();o.OnChangeProperty("Actor.Anchor.0",E);var T=new y;if(T.SetValue([0]),o.OnChangeProperty("Collab.ListAnchorsIDs",T),!t){var A=new V;A.SetValue(a.ELeadType.Mustache),o.OnChangeProperty("Collab.Attach.LeadType",A);var G=new V;G.SetValue(1e3),o.OnChangeProperty("Collab.3D.Paper.Positioning.Type",G);var R=new _;R.SetValue(r.getManager("VCXDressupManager").GetDressupCount()),o.OnChangeProperty("Collab.3D.Paper.Depth",R);var O=new V;O.SetValue(1),o.OnChangeProperty("Collab.3D.Paper.Size.Control.Type",O)}var k=this.getPosition(),B=new _;B.SetValue(k.x-g),o.OnChangeProperty("Collab.3D.Paper.Paper.Position.X",B);var W=new _;W.SetValue(k.y+g),o.OnChangeProperty("Collab.3D.Paper.Paper.Position.Y",W);var N=new _;N.SetValue(n),o.OnChangeProperty("Collab.Body.Width",N);var F=new _;F.SetValue(n),o.OnChangeProperty("Collab.Body.Height",F);var L=new s(r.getManager("VCXCommandManager"),r.getManager("VCXDressupManager"),r.getManager("VCXScenarioManager"),r.ComponentsMap);L.AddDressups(e),r.getManager("VCXCommandManager").Push(L);d=new P(e.GetID());this.Modifiable.OnChangeProperty("Digger.AssociatedPanelID",d);var K=o.GetProperties();r.getManager("VCXScenarioManager").AddNeutrals(o,K);var Z=new X(r.getManager("VCXScenarioManager"),r.ComponentsMap,r.getManager("VCXCommandManager"));Z.ChangeVisibility([e],S.EVisState.Visible),r.getManager("VCXCommandManager").Do(Z);var z=new M(r.getManager("VCXSelectionManager"));z.SetSelection(e),r.getManager("VCXCommandManager").Do(z),this.ExperienceBase.getManager("VCXContextManager").renderAll({updateInfinitePlane:!0})}}},p=!0;if(l)c(l,p);else if(r.getManager("VCXCAT3DXModelManager")){var u=r.getManager("VCXContextManager").getRootComponent();u&&r.getManager("VCXCAT3DXModelManager").CreateActor("VCXDiggerPanel_Spec","Digger Panel",u).then(e=>{c(e,p=!1)})}else l=r.Factory.BuildComponent("VCXDiggerPanel_Spec"),c(l,p=!1);return!0},SetPropertiesFromPanel:function(t,i,r){var o=this.ExperienceBase.getManager("VCXPaperManager").GetMmToPxRatio();this.setRadius(t.internalSize.x/2+this.Modifiable.GetObject().borderThickness/o),this.setPosition(t.centerInPaper),this.setAttachDisplay(i);var n=(new e.Vector3).getPositionFromMatrix(r),s=new C;s.SetValueFrame((new b).SetValueFromVector(n)),this.setProp(s.GetValue(),"Actor.Anchor.0",new C)},addDiggerPanelEvents:function(){this._WUXEventTokens={};var e=(e,t)=>{if(this._toolbar&&this.isVisible())for(var i=0;i<t.length;++i){if(t[i]===this.Modifiable.GetObject()){this._toolbar.setSelected(e),this._toolbar.updateVisibilityStyle();break}}};this._WUXEventTokens.VCX_SELECTION_ADD=t.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},t=>{e(!0,t)}),this._WUXEventTokens.VCX_SELECTION_REMOVE=t.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},t=>{e(!1,t)})},removeDiggerPanelEvents:function(){for(var e in this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(e)&&this._WUXEventTokens[e]&&(t.unsubscribe(this._WUXEventTokens[e]),this._WUXEventTokens[e]=null)},calcToolbarInfo:function(){var e={},t=this.getPositionInPixel(),i=this.getRadiusInPixel();return e.radiusPx=i+20,e.centerPx={x:t.x,y:t.y},e},createDiggerPanelToolbar:function(){if(!this._toolbar){var e=this._ExperienceBase.getManager("VCXContextManager"),t=this.calcToolbarInfo(),i=[],r=e=>{i.push({nls:x[e],url:c.getWebappsAssetUrl("VCXWebDigger","icons/"+e+".png"),id:e,type:"element",callback:e=>{this.runCommand(e)},callbackUpdate:(e,t)=>{this.runUpdateCommand(e,t)}})};this.ExperienceBase.getManager("VCXContextManager").getPlayerMode()||(r("I_VCX_Digger_Hide"),i.push(m.Separator)),r("I_VCX_Digger_Mode_XRay"),r("I_VCX_Digger_Mode_OnionSkin"),r("I_VCX_Digger_Mode_Zoom"),i.push({type:"spacer",spacerStartAngle:300,spacerClockwise:!1}),this.ExperienceBase.getManager("VCXContextManager").getPlayerMode()||(r("I_VCX_Digger_Tool_2DSnapshot"),i.push(m.Separator)),r("I_VCX_Digger_Tool_LockPlanes"),r("I_VCX_Digger_Tool_LockVP"),r("I_VCX_Digger_Tool_Focus"),this._toolbar=new m({experienceBase:this._ExperienceBase,body:e.getUIFrame(),frmWindow:e.getFrameWindow(),title:"Digger",actionBar:e.getActionBar(),heightElem:22,widthElem:22,padding:1,updateOpacity:!1,startAngle:110,clockwise:!0,center:t.centerPx,radius:t.radiusPx,lJsonElement:i}),this.addDiggerPanelEvents()}},deleteDiggerPanelToolbar:function(){this.removeDiggerPanelEvents(),this._toolbar&&(this._toolbar.clear(),this._toolbar=null)}});return Object.defineProperty(w.prototype,"DiggerKernel",{enumerable:!0,get:function(){return this._diggerKernel},set:function(e){this._diggerKernel=e}}),Object.defineProperty(w.prototype,"DiggerUI",{enumerable:!0,get:function(){return this._diggerUI},set:function(e){this._diggerUI=e}}),w}),define("DS/VCXWebDigger/VCXDiggerSGNodeHolder",["DS/VCXWebDressup/VCXDressupSGNodeHolder","DS/VCXWebDigger/VCXDiggerNode"],function(e,t){"use strict";return e.extend({init:function(){},buildSGNode:function(){if(!this._sgNode){var e={name:"Digger",modifiable:this.GetObject().QueryInterface("VCXIModifiable")};this._sgNode=new t(e),this._sgNode.setIcon("../VCXWebDigger/assets/icons/32/I_VCX_Panel_Tree_DiggerLeaf.png")}return this._parent()},unreferenceSGNode:function(){this._sgNode&&(this._sgNode.dispose(),delete this._sgNode)}})});