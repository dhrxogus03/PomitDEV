define("DS/Intersection/IntersectionUtils",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";let t,n;const r=new e.Vector3,i=new e.Vector3,o=new e.Vector3;const c=new Map;let a=0,s=null,l=null;function u(e){let t;for(t of c.keys()){let n=c.get(t);if(n===s){s.clear(),a=0;break}if(a-=n.size,c.delete(t),a<e/2)break}}return{checkGAS:function(e,t){if(e&&e.isGAS){if(e._noPick)return!0}else if(t&&t._noPick)return!0;return!1},selectDGBSCache:function(e){if(!this._primBSCache)return void(s=null);if(e===l)return;if(e.getPrimitivesCount()>this._bsCacheMaxSize)return void(s=null);let t=c.get(e);void 0!==t?c.delete(e):t=new Map,c.set(e,t),s=t,l=e},clearDGBSCache:function(){c.clear(),a=0,s=null,l=null},checkRayToPrimitiveBoundingSphere:function(t,n,i,o,c,l){let g=0,p=0,d=null;if(s){const e=t._getSGPrimitive(!0);if(void 0===(d=s.get(e))&&((d=e.computeBoundingSphere(null))&&(s.set(e,d),a++),a>this._bsCacheMaxSize&&u(this._bsCacheMaxSize)),!d||c&&!c.getWorldSizeFromPixelSize)return!1;let n=1.4142135623730951;p=c?c.getWorldSizeFromPixelSize(n/l,d.center,this._screenHeight,2):0,g=o*n/2}else if(!(d=t.getBoundingSphere())){const n=t.getRep();n&&(d=n.boundingSphere)&&(d=(new e.Sphere).setSimple(d.center[0],d.center[1],d.center[2],d.radius))}if(!d||0===d.radius)return!1;let f=d.radius+p+g;if(n._distanceFromIntersection(d.center)>f)return!0;if(i>0&&r.subVectors(d.center,n.origin).dot(n.direction)-f>i)return!0;return!1},checkFrustumToPrimitiveBoundingSphere:function(t,n,r){let i=new e.Sphere,o=null;if(s){const e=t._getSGPrimitive(!0);t.getCount()>1?void 0===(o=s.get(e))&&((o=e.computeBoundingSphere(null))&&(s.set(e,o),a++),a>this._bsCacheMaxSize&&u(this._bsCacheMaxSize)):o=e.computeBoundingSphere(null)}else if(!(o=t.getBoundingSphere())){const n=t.getRep();n&&(o=n.boundingSphere)&&(o=(new e.Sphere).setSimple(o.center[0],o.center[1],o.center[2],o.radius))}return!!o&&(i.center.set(o.center.x,o.center.y,o.center.z),i.radius=o.radius*r.getMaxScaleOnAxis(),i.center.applyMatrix4(r),!n.intersectsSphere(i))},computeUVCoords:function(r,i,o){let c=new e.Vector3;return c.x=r.x+n*(i.x-r.x)+t*(o.x-r.x),c.y=r.y+n*(i.y-r.y)+t*(o.y-r.y),c.z=r.z+n*(i.z-r.z)+t*(o.z-r.z),c},pointInFace3:function(e,c,a,s){r.subVectors(s,c),i.subVectors(a,c),o.subVectors(e,c);const l=r,u=i,g=o,p=l.dot(l),d=l.dot(u),f=u.dot(u),m=p*f,h=m-d*d;if(0===m||h/m<1e-10)return!1;const y=l.dot(g),x=u.dot(g);return n=(p*x-d*y)/h,(t=(f*y-d*x)/h)>=0&&n>=0&&t+n<1},filterDrawingGroup:function(e,t,n){if(e.isFiltered)return e.isFiltered(n,t);console.error("Unexpected class in filterDrawingGroup, expected Mesh.DrawingGroup");let r=t||e._geomType;return!((r&n)>0||0===r)},_screenWidth:0,_screenHeight:0,_projScreenMatrix:new e.Matrix4,_primBSCache:!0,_bsCacheMaxSize:3e5}}),define("DS/Intersection/VolumeIntersection",["DS/Mesh/ThreeJS_Base","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,n){"use strict";var r=function(r,i,o,c,a,s,l,u,g,p){var d=new e.Vector3,f=new e.Vector3,m=new e.Vector3,h=new e.Sphere,y=i.vertexIndexArray;if(!i.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;!function(e,r,i,o,c){if(!o.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;const a=i.getFilterGeomType();for(var s=o.drawingGroups,l=0;l<s.length;l++){var u=s[l];if(!t.filterDrawingGroup(u,a,r)){var g=0;switch(u.glType){case 4:case 5:g=3;break;case 1:g=2;break;case 0:g=1;break;default:continue}var p=null;if(i.layer&&(p=i.layer.getIntervals(o,u)),p||!t.checkGAS(u.gas,u))for(var d=new n.SGPrimitiveHelper,f=0;f<u.getPrimitivesCount();f++){if(d.set(u,f),null!==p){for(var m=!1,h=p.length-1;h>=0;h--)if(p[h].start<=d.getStart()){let e=curLayer.gas;e||(e=u.gas),(p[h].skip(i,c)||t.checkGAS(e,u))&&(m=!0);break}if(m)continue}if(e(g,d))return}}}}(function(t,n){var c;switch(t){case 1:c=function(e){for(var t=!0,n=!1,r=e.getStart();r<e.getStart()+e.getCount();r++){i.getVertexPosition(y[r],d),d.applyMatrix4(u);var c=o.containsPoint(d);if(n=n||c,!(t=t&&c)&&n)break}return{insideb:t,partialb:n}}(n);break;case 2:c=function(t){for(var n=!0,r=!1,c=t.getStart();c<t.getStart()+t.getCount();c+=2){i.getVertexPosition(y[c],d),d.applyMatrix4(u),i.getVertexPosition(y[c+1],f),f.applyMatrix4(u);var a=o.containsPoint(d),s=o.containsPoint(f);if((n=n&&a&&s)?r=!0:(h.setFromCenterAndPoints(new e.Vector3((d.x+f.x)/2,(d.y+f.y)/2,(d.z+f.z)/2),[d,f]),r=r||a||s||o.intersectsSphere(h)&&o.intersectsLine([d,f])),!n&&r)break}return{insideb:n,partialb:r}}(n);break;case 3:c=function(t){for(var n=!0,r=!1,c=t.getStart();c+2<t.getStart()+t.getCount();c++){i.getVertexPosition(y[c],d),d.applyMatrix4(u),i.getVertexPosition(y[c+1],f),f.applyMatrix4(u),i.getVertexPosition(y[c+2],m),m.applyMatrix4(u);var a=o.containsPoint(d),s=o.containsPoint(f),l=o.containsPoint(m);if((n=n&&a&&s&&l)?r=!0:(h.setFromCenterAndPoints(new e.Vector3((d.x+f.x+m.x)/3,(d.y+f.y+m.y)/3,(d.z+f.z+m.z)/3),[d,f,m]),r=r||a||s||l||o.intersectsSphere(h)&&o.intersectsTriangle([d,f,m])),!n&&r)break}return{insideb:n,partialb:r}}(n);break;default:return void console.error("Error: requiredVectors can't be equal to 0")}var p={primitive:n.clone(),object:r};if(c.insideb)a.push(p);else{if(c.partialb)return l.push(p),g;s.push(p)}return!1},c,r,i,p)},i=function(e,t,n,i,o,c){if(!t.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;var a=[],s=[],l=[];return r(e,t,n,i,a,l,s,o,!0,c),s.length>0||l.length>0&&a.length>0?1:l.length>0?0:2};return{_meshIntersectVolume:function(t,n,r,o,c,a,s,l,u){if(!function(t,n,r,i){var o=new e.Sphere,c=t._getMMMatrix();return null!==t.boundingSphere&&o.copy(t.boundingSphere),o.applyMatrix4(c),n.containsSphere(o)?(i.push({object:t}),!0):!n.intersectsSphere(o)&&(r.push({object:t}),!0)}(t,n,s,a)){var g=t._getMMMatrix(),p=t.geometry;2===p._type&&(p=[p]);for(var d=r|o|c|e.RenderMode.defaultMask,f=0;f<p.length;f++){var m=p[f];switch(i(t,m,n,d,g,u)){case 0:s.push({object:t});break;case 1:l.push({object:t});break;case 2:a.push({object:t});break;default:return}}}}}}),define("DS/Intersection/RayFrustumUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,n){"use strict";const r=new e.Vector3,i=new e.Vector3,o=new e.Vector3,c=new e.Sphere;function a(e,n,r,i,o,c){if(null!==e){let a=!1;for(let s=e.length-1;s>=0;s--){let l=e[s];if(l.start<=n){let e=l.gas;e||(e=r),(l.skip(o,i)||t.checkGAS(e,c))&&(a=!0);break}}if(a)return!0}return!1}return{intersectBufferGeom3DInsideFrustumMesh:function(e,i,o,c){let s=!1,l=[];const u=i._getMMMatrix(),g=i.getFilterGeomType();let p=null,d=0;i.geometry.length>=0?(p=i.geometry[0],d=i.geometry.length):2===i.geometry._type&&(p=i.geometry,d=1);const f=new n.SGPrimitiveHelper;for(let n=0;n<d;n++){const l=p.drawingGroups,d=p.vertexIndexArray;for(let n=0;n<l.length;n++){const m=l[n];if(t.filterDrawingGroup(m,g,o))continue;let h=null;if(i.layer&&(h=i.layer.getIntervals(p,m)),!h&&t.checkGAS(m.gas,m))continue;const y=m.getPrimitivesCount();t.selectDGBSCache(m);for(let n=0;n<y;n++){f.set(m,n);const o=f.getCount(),l=f.getStart();if(a(h,l,m.gas,c,i,m)||t.checkFrustumToPrimitiveBoundingSphere(f,e,u))continue;const g=l+o;for(let t=l;t<g;t++)if(s=!0,p.getVertexPosition(d[t],r),r.applyMatrix4(u),!e.containsPoint(r))return null}}p=i.geometry[n+1]}return s?(l.push({object:i}),l):null},intersectBufferGeomZone3D:function(s,l,u,g,p,d){let f,m=[];const h=l._getMMMatrix();l.matrixRotationWorld.extractRotation(h);const y=l.getFilterGeomType();let x,v=null,M=0;if(l.geometry.length>=0?(v=l.geometry[0],M=l.geometry.length):2===l.geometry._type&&(v=l.geometry,M=1),M&&(v.noMeshInRAM||!v.vertexIndexArray))return m;u||(x=!g);const S=new n.SGPrimitiveHelper;for(let n=0;n<M;n++){const M=v.drawingGroups,b=v.vertexIndexArray;for(let n=0;n<M.length;n++){const w=M[n];if(4!=w.glType&&5!=w.glType)continue;if(t.filterDrawingGroup(w,y,p))continue;let V=null;if(l.layer&&(V=l.layer.getIntervals(v,w)),!V&&t.checkGAS(w.gas,w))continue;const P=w.getPrimitivesCount();t.selectDGBSCache(w);for(let n=0;n<P;n++){u&&!g&&(x=!0),S.set(w,n);const p=S.getCount(),y=S.getStart();if(a(V,y,w.gas,d,l,w)||t.checkFrustumToPrimitiveBoundingSphere(S,s,h))continue;const M=y+p;for(let t=y;t<M;t++){if(v.getVertexPosition(b[t],r),v.getVertexPosition(b[t+1],i),v.getVertexPosition(b[t+2],o),r.applyMatrix4(h),i.applyMatrix4(h),o.applyMatrix4(h),g){if(c.setFromCenterAndPoints(new e.Vector3((r.x+i.x+o.x)/3,(r.y+i.y+o.y)/3,(r.z+i.z+o.z)/3),[r,i,o]),s.intersectsSphere(c)&&s.intersectsTriangle([r,i,o])){u?(f={primitive:S.clone(),geometry:v,object:l},m.push(f)):x=!0;break}}else if(!(s.containsPoint(r)&&s.containsPoint(i)&&s.containsPoint(o))){x=!1;break}4==w.glType&&(t+=2)}if(u&&!g&&x)f={primitive:S.clone(),geometry:v,object:l},m.push(f);else if(!u&&g&&m.length)break}if(!u&&(g&&x||!g&&!x))break}if(!u&&(g&&x||!g&&!x))break;v=l.geometry[n+1]}return!u&&x&&m.push({object:l}),m},intersectBufferGeomEdge3D:function(o,s,l,u,g,p){let d,f=[];const m=s.getFilterGeomType(),h=s._getMMMatrix();let y,x=null,v=0;if(s.geometry.length>=0?(x=s.geometry[0],v=s.geometry.length):2===s.geometry._type&&(x=s.geometry,v=1),v&&(x.noMeshInRAM||!x.vertexIndexArray))return f;l||(y=!u);const M=new n.SGPrimitiveHelper;for(let n=0;n<v;n++){const v=x.drawingGroups,S=x.vertexIndexArray;for(let n=0;n<v.length;n++){const b=v[n];if(1!==b.glType)continue;if(t.filterDrawingGroup(b,m,g))continue;let w=null;if(s.layer&&(w=s.layer.getIntervals(x,b)),!w&&t.checkGAS(b.gas,b))continue;const V=b.getPrimitivesCount();t.selectDGBSCache(b);for(let n=0;n<V;n++){l&&(y=!0),M.set(b,n);const g=M.getCount(),m=M.getStart();if(a(w,m,b.gas,p,s,b)||t.checkFrustumToPrimitiveBoundingSphere(M,o,h))continue;const v=m+g;for(let t=m;t<v;t+=2)if(x.getVertexPosition(S[t],r),x.getVertexPosition(S[t+1],i),r.applyMatrix4(h),i.applyMatrix4(h),u){if(c.setFromCenterAndPoints(new e.Vector3((r.x+i.x)/2,(r.y+i.y)/2,(r.z+i.z)/2),[r,i]),o.intersectsSphere(c)&&o.intersectsLine([r,i])){l?(d={primitive:M.clone(),geometry:x,object:s},f.push(d)):y=!0;break}}else if(!o.containsPoint(r)||!o.containsPoint(i)){y=!1;break}if(l&&!u&&y)d={primitive:M.clone(),geometry:x,object:s},f.push(d);else if(!l&&u&&f.length)break}if(!l&&(u&&y||!u&&!y))break}if(!l&&(u&&y||!u&&!y))break;x=s.geometry[n+1]}return!l&&y&&f.push({object:s}),f},intersectBufferGeomPoint3D:function(e,i,o,c){let s,l=[];const u=i.getFilterGeomType(),g=i._getMMMatrix();let p=null,d=0;if(i.geometry.length>=0?(p=i.geometry[0],d=i.geometry.length):2===i.geometry._type&&(p=i.geometry,d=1),d&&(p.noMeshInRAM||!p.vertexIndexArray))return l;const f=new n.SGPrimitiveHelper;for(let n=0;n<d;n++){const d=p.drawingGroups,m=p.vertexIndexArray;for(let n=0;n<d.length;n++){const h=d[n];if(0!==h.glType)continue;if(t.filterDrawingGroup(h,u,o))continue;let y=null;if(i.layer&&(y=i.layer.getIntervals(p,h)),!y&&t.checkGAS(h.gas,h))continue;const x=h.getPrimitivesCount();for(let n=0;n<x;n++){f.set(h,n);const o=f.getCount(),u=f.getStart();if(a(y,u,h.gas,c,i,h)||t.checkFrustumToPrimitiveBoundingSphere(f,e,g))continue;const d=u+o;for(let t=u;t<d;t++)p.getVertexPosition(m[t],r),r.applyMatrix4(g),0===e.computeOutcode(r)&&(s={primitive:f.clone(),geometry:p,object:i},l.push(s))}}p=i.geometry[n+1]}return l}}}),define("DS/Intersection/RayCastUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,n){"use strict";const r=new e.Vector3,i=new e.Vector3,o=new e.Vector3,c=new e.Vector3,a=new e.Vector3,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3,g=new e.Vector3,p=new e.Vector3,d=new e.Vector3,f=new e.Vector3,m=new e.Vector3,h=new e.Vector3,y=new e.Vector3,x=new e.Matrix4;function v(e,t){if(null!==e){let n=!1;for(let r=e.length-1;r>=0;r--){const i=e[r];if(i.start<=t){i.skip(null,null)&&(n=!0);break}}if(n)return!0}return!1}return{_castRayIntoBufferGeom:function(h,y,M){let S,b=[];const w=h._getMMMatrix();x.getInverse(w);const V=x.getMaxScaleOnAxis();h.matrixRotationWorld.extractRotation(w);const P=(new e.Ray).copy(this).applyMatrix4(x),G=M*V,_=M<1/0;let I=null,T=0;if(h.geometry.length>=0?(I=h.geometry[0],T=h.geometry.length):2===h.geometry._type&&(I=h.geometry,T=1),I&&!I.vertexIndexArray)return S={distance:0,primitive:!0,object:h,point:null,normal:null},b.push(S),b;const A=new n.SGPrimitiveHelper;P.direction.normalize();const z=this,k=function(e,n,x){let v,M,V;r.copy(P.origin);const T=e.vertexUvArray?e.vertexUvArray:null;i.copy(P.direction),null===n?(v=x,M=x+1,V=x+2):(v=n[x],M=n[x+1],V=n[x+2]),e.getVertexPosition(v,o),e.getVertexPosition(M,c),e.getVertexPosition(V,a),g.subVectors(c,o);let k=g.dot(g);p.subVectors(o,a),k=Math.max(k,p.dot(p)),d.subVectors(o,P.origin),d.cross(P.direction);let R=d.dot(d);if(R>k)return!0;f.crossVectors(p,g).normalize(),d.subVectors(o,r);const D=i.dot(f),j=f.dot(d)/D;if(j>=0){if(_&&j>G)return!0;if(m.addVectors(r,i.multiplyScalar(j)),d.subVectors(o,m),(R=d.dot(d))>k)return!0;if(t.pointInFace3(m,o,c,a)){if(y)return S={object:h,geometry:I},b.push(S),!1;let n=null;e.getVertexNormal(v,s),e.getVertexNormal(M,l),e.getVertexNormal(V,u);const r=m.barycentricCoordinates(o,c,a);s.multiplyScalar(r.alpha),l.multiplyScalar(r.beta),u.multiplyScalar(r.gamma),f.addVectors(s,l),f.add(u),f.multiplyScalar(r.normalisationFactor),f.normalize();const i=m.clone().applyMatrix4(w);T&&(e.getUV(v,o),e.getUV(M,c),e.getUV(V,a),n=t.computeUVCoords(o,c,a)),S={distance:z.origin.distanceTo(i),point:i,normal:f.clone().applyMatrix4(h.matrixRotationWorld),tangent:null,uv:n,primitive:A.clone(),geometry:e,object:h},b.push(S)}}return!0};if(h.kdTree)return h.kdTree.intersect(P,function(e){A.set(e.dg,e.primitive);const t=A.getGroup();if(4!=t.glType&&5!=t.glType)return;const n=t.geometry,r=n.vertexIndexArray,i=e.offset;if(-1!==i)k(n,t.nonIndexed?null:r,i);else{const e=A.getStart(),i=e+A.getCount();for(let o=e;o<i&&k(n,t.nonIndexed?null:r,o);4===t.glType?o+=3:o++);}},null,_?G:null),b;for(let e=0;e<T;e++){const n=I.drawingGroups,r=I.vertexIndexArray;for(let e=0;e<n.length;e++){const i=n[e];if(4!=i.glType&&5!=i.glType)continue;let o=null;h.layer&&(o=h.layer.getIntervals(I,i));const c=i.getPrimitivesCount();t.selectDGBSCache(i);for(let e=0;e<c;e++){A.set(i,e);const n=A.getCount(),c=A.getStart();if(t.checkRayToPrimitiveBoundingSphere(A,P,_?G:0,0)||v(o,c))continue;const a=c+n;for(let e=c;e<a;4===i.glType?e+=3:e++)if(!k(I,i.nonIndexed?null:r,e))return b}}I=h.geometry[e+1]}return b},_castRayIntoBufferGeomEdge:function(r,i,a,s){let l,u=[];const g=r._getMMMatrix();x.getInverse(g);const p=x.getMaxScaleOnAxis();r.matrixRotationWorld.extractRotation(g);const f=(new e.Ray).copy(this).applyMatrix4(x),M=s*p,S=s<1/0;r.material&&r.material.lineWidth&&r.material.is2DLine&&(i+=.5*r.material.lineWidth);let b=null,w=0;if(r.geometry.length>=0?(b=r.geometry[0],w=r.geometry.length):2===r.geometry._type&&(b=r.geometry,w=1),b&&!b.vertexIndexArray)return l={distance:0,primitive:!0,object:r,point:null,normal:null},u.push(l),u;f.direction.normalize();const V=new n.SGPrimitiveHelper,P=this,G=function(t,n,p){null===n?(t.getVertexPosition(p,o),t.getVertexPosition(p+1,c)):(t.getVertexPosition(n[p],o),t.getVertexPosition(n[p+1],c)),d.subVectors(c,o);let x=d.dot(d);if(x+=2*Math.sqrt(x)*i+i*i,d.subVectors(o,f.origin),d.cross(f.direction),d.dot(d)>x)return!0;if(h.copy(o),y.copy(c),h.applyMatrix4(g),y.applyMatrix4(g),S){d.subVectors(h,P.origin);let e=d.dot(P.direction);if(d.subVectors(y,P.origin),(e=Math.min(e,d.dot(P.direction)))>s)return!0}if(P.distanceSqToSegment(h,y,null,m)<i*i){if(a)return l={object:r,geometry:t},u.push(l),!1;const n=P.origin.distanceTo(m);l={distance:Math.max(0,.99*n),point:m.clone(),normal:null,tangent:(new e.Vector3).subVectors(m,h).normalize(),primitive:V.clone(),geometry:t,object:r},u.push(l)}return!0};for(let e=0;e<w;e++){const n=b.drawingGroups,o=b.vertexIndexArray;for(let e=0;e<n.length;e++){const c=n[e];if(1!=c.glType)continue;let a=null;r.layer&&(a=r.layer.getIntervals(b,c));const s=c.getPrimitivesCount();t.selectDGBSCache(c);for(let e=0;e<s;e++){V.set(c,e);const n=V.getCount(),r=V.getStart();if(t.checkRayToPrimitiveBoundingSphere(V,f,S?M:0,i)||v(a,r))continue;const s=r+n;for(let e=r;e<s;e+=2)if(!G(b,c.nonIndexed?null:o,e))return u}}b=r.geometry[e+1]}return u},_castRayIntoBufferGeomPoint:function(r,i,c,a){let s,l=[];const u=r._getMMMatrix();x.getInverse(u);const g=x.getMaxScaleOnAxis();r.matrixRotationWorld.extractRotation(u);const p=(new e.Ray).copy(this).applyMatrix4(x),d=a*g,f=a<1/0;let m=null,y=0;if(r.geometry.length>=0?(m=r.geometry[0],y=r.geometry.length):2===r.geometry._type&&(m=r.geometry,y=1),m&&!m.vertexIndexArray)return s={distance:0,primitive:!0,object:r,point:null,normal:null},l.push(s),l;p.direction.normalize();const M=new n.SGPrimitiveHelper,S=this,b=function(e,t,n){if(null===t?e.getVertexPosition(n,o):e.getVertexPosition(t[n],o),h.copy(o),h.applyMatrix4(u),S.distanceToPoint(h)<i){if(c)return s={object:r,geometry:e},l.push(s),!1;const t=S.origin.distanceTo(h);if(f&&t>a)return!0;s={distance:Math.max(0,.98*t),point:h.clone(),normal:null,primitive:M.clone(),geometry:e,object:r},l.push(s)}return!0};for(let e=0;e<y;e++){const n=m.drawingGroups,o=m.vertexIndexArray;for(let e=0;e<n.length;e++){const c=n[e];if(0!==c.glType)continue;let a=null;r.layer&&(a=r.layer.getIntervals(m,c));const s=c.getPrimitivesCount();t.selectDGBSCache(c);for(let e=0;e<s;e++){M.set(c,e);const n=M.getCount(),r=M.getStart();if(t.checkRayToPrimitiveBoundingSphere(M,p,f?d:0,i)||v(a,r))continue;const s=r+n;for(let e=r;e<s;e++)if(!b(m,c.nonIndexed?null:o,e))return l}}m=r.geometry[e+1]}return l}}}),define("DS/Intersection/RayIntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,n){"use strict";const r=new e.Vector3,i=new e.Vector3,o=new e.Vector3,c=new e.Vector3,a=new e.Vector3,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3,g=new e.Vector3,p=new e.Vector3,d=new e.Vector3,f=new e.Vector3,m=new e.Vector3,h=new e.Vector3,y=new e.Vector3,x=new e.Vector3,v=new e.Vector3,M=new e.Vector3,S=new e.Vector3,b=new e.Vector3,w=new e.Plane,V=Math.sqrt(2);function P(e){let t,n;return e.geometry.length>=0?(t=e.geometry[0],n=e.geometry.length):2===e.geometry._type&&(t=e.geometry,n=1),[t,n]}function G(e,n,r,i,o,c){if(null!==e){let a=!1;for(let s=e.length-1;s>=0;s--){const l=e[s];if(l.start<=n){let e=l.gas;e||(e=r.gas),l.skip(o,i)||t.checkGAS(e,r)?a=!0:(c.updateToleranceFunc(e,r,l.getMaterial()),c.computeLayerGAS(l.gas));break}}if(a)return!0}return!1}return{intersectBufferGeomOptim:function(l,u,g,p,d,f){let y,V=[];const _=g._getMMMatrix(),I=(new e.Matrix4).getInverse(_);g.matrixRotationWorld.extractRotation(_);const T=g.material,A=(new e.Ray).copy(this).applyMatrix4(I);S.copy(l._viewpoint.getUpDirection()),S.applyMatrix4(I),b.crossVectors(A.direction,S),w.setFromNormalAndCoplanarPoint(b,A.origin);const z=b.x,k=b.y,R=b.z,D=w.constant,j=g.getFilterGeomType();let[C,F]=P(g);if(!p&&(T&&T._isAlteringGeometryOnGPU||C&&!C.vertexIndexArray))return y={distance:0,primitive:!0,object:g,point:null,normal:null},V.push(y),V;const B=new n.SGPrimitiveHelper,W=this.origin,L=new Map,E={dgGAS:null,layerGAS:null,updateToleranceFunc:function(e,t,n){},computeDGGAS:function(e){},computeLayerGAS:function(e){},getGAS:function(){return this.layerGAS?this.layerGAS:this.dgGAS}},O=function(e,n,l){let u,p,d;const f=e.vertexUvArray?e.vertexUvArray:null;null===n?(u=l,p=l+1,d=l+2):(u=n[l],p=n[l+1],d=n[l+2]),e.getVertexPosition(u,r),e.getVertexPosition(p,i),e.getVertexPosition(d,o);const S=r.x*z+r.y*k+r.z*R+D;if(S*(i.x*z+i.y*k+i.z*R+D)>0){if(S*(o.x*z+o.y*k+o.z*R+D)>0)return}v.subVectors(i,r),m.copy(v);let b=v.dot(v);v.subVectors(r,o),h.copy(v),b=Math.max(b,v.dot(v)),v.subVectors(r,A.origin),v.cross(A.direction);let w=v.dot(v);if(w>b)return;x.crossVectors(h,m).normalize(),v.subVectors(r,A.origin);const P=A.direction.dot(x),G=x.dot(v)/P;if(G>=0){if(M.copy(A.direction).multiplyScalar(G).add(A.origin),v.subVectors(r,M),(w=v.dot(v))>b)return!0;if(t.pointInFace3(M,r,i,o)){let n=null;if(e.layout.has("normal")){e.getVertexNormal(u,c),e.getVertexNormal(p,a),e.getVertexNormal(d,s);const t=M.barycentricCoordinates(r,i,o);c.multiplyScalar(t.alpha),a.multiplyScalar(t.beta),s.multiplyScalar(t.gamma),x.addVectors(c,a),x.add(s),x.multiplyScalar(t.normalisationFactor),x.normalize()}const l=M.clone().applyMatrix4(_);f&&(e.getUV(u,r),e.getUV(p,i),e.getUV(d,o),n=t.computeUVCoords(r,i,o)),y={distance:W.distanceTo(l),point:l,normal:x.clone().applyMatrix4(g.matrixRotationWorld),tangent:null,uv:n,primitive:B.clone(),geometry:e,object:g},V.push(y)}}};if(g.kdTree)g.kdTree.intersect(A,function(e){B.set(e.dg,e.primitive);const n=B.getGroup();if(4!=n.glType&&5!=n.glType)return;if(t.filterDrawingGroup(n,j,d))return;const r=n.geometry,i=B.getStart(),o=i+B.getCount(),c=g.layer&&g.layer.getIntervals(r,n);if(!c&&t.checkGAS(n.gas,n))return;if(E.computeDGGAS(n.gas),G(c,i,n,f,g,E))return;const a=r.vertexIndexArray,s=e.offset;if(p)L.has(n)?L.get(n).push(e.primitive):L.set(n,[e.primitive]);else if(-1!==s)O(r,n.nonIndexed?null:a,s);else for(let e=i;e<o;4===n.glType?e+=3:e++)O(r,n.nonIndexed?null:a,e)});else for(let e=0;e<F;e++){const n=C.drawingGroups,r=C.vertexIndexArray;for(let e=0;e<n.length;e++){const i=n[e];if(4!=i.glType&&5!=i.glType)continue;if(t.filterDrawingGroup(i,j,d))continue;const o=g.layer&&g.layer.getIntervals(C,i);if(!o&&t.checkGAS(i.gas,i))continue;E.computeDGGAS(i.gas);let c=i.getPrimitivesCount();t.selectDGBSCache(i);for(let e=0;e<c;e++){B.set(i,e);const n=B.getCount(),c=B.getStart();if(G(o,c,i,f,g,E)||t.checkRayToPrimitiveBoundingSphere(B,A,0,0,l,devicePixelRatio))continue;if(p){L.has(i)?L.get(i).push(e):L.set(i,[e]);continue}const a=c+n;for(let e=c;e<a;4===i.glType?e+=3:e++)O(C,i.nonIndexed?null:r,e)}}C=g.geometry[e+1]}return p&&L.forEach(function(e,t,n){e.sort(function(e,t){return e<=t}),V.push({object:g,dg:t,prims:e})}),V},intersectBufferGeomEdge:function(o,c,a,s,g,h,x,M){const S=s._viewpoint.viewer,b=S.renderer.renderer,w=s.getWorldSizeFromPixelSize(1/g,c.worldCenter,S._getDivClientHeight(),2),_=b.getMaterialMode(c,b.getRenderMode(c,!0)),I=c.material?c.material.line?c.material.line:c.material:null,T=!!c.material&&c.material.force,A=c.gas,z=c.matApp,k=z?z._getMaterialFromGLType(1,0):null;let R=1,D=!1,j=!1;const C=!k&&(_||!c.fromLoadedModel);I&&!0===T&&C?(R=I.lineWidth?I.lineWidth:1,D=I.is2DLine,j=!0):_&&k?(R=k.lineWidth?k.lineWidth:1,D=k.is2DLine):A&&A._doesInherit(e.GASEnum.LINEWIDTH_INHERITANCE_ON)&&(R=A.getLineThickness(),D=!1);const F=function(e,t){const n={norm:0,length:0,normMM:0,normMM2:0,computeLineWidth:e,is2DLine:t};return t&&(e/=w),n.length=a+1+Math.floor(e/2)/V,n.norm=V*n.length,n.normMM=n.norm/w,n.normMM2=n.normMM*n.normMM,n},B=new Map,W=new Map;let L=F(R,D);const E=L;D?W.set(R,L):B.set(R,L);let O,U=[];const H=c._getMMMatrix(),N=(new e.Matrix4).getInverse(H);c.matrixRotationWorld.extractRotation(H);const q=(new e.Ray).copy(this).applyMatrix4(N),J=c.getFilterGeomType();let[Z,K]=P(c);if(!h&&(I&&I._isAlteringGeometryOnGPU||Z&&!Z.vertexIndexArray))return O={distance:0,primitive:!0,object:c,point:null,normal:null},U.push(O),U;q.direction.normalize();const Q=this,X=new Map,Y=new n.SGPrimitiveHelper;const $={dgGAS:null,layerGAS:null,updateToleranceFunc:function(e,t,n){if(j&&!n)return void(L=E);if(n=n||t.material,_){if(n&&n.isMatApp)k&&(n=n.solveInheritance(z,c._occurrence?c._occurrence.depth:0)),n=n._getMaterialFromGLType(1,0);else if(k)return void(L=E)}else n=null;let r=1,i=!1;n?(r=n.lineWidth?n.lineWidth:1,i=n.is2DLine):e&&(r=e.isGAS?e.getLineThickness():e.lineWidth?e.lineWidth:1),r===L.computeLineWidth&&i===L.is2DLine||function(e,t){const n=t?W:B;n.has(e)?L=n.get(e):(L=F(e,t),n.set(e,L))}(r,i)},computeDGGAS:function(e){},computeLayerGAS:function(e){},getGAS:function(){return this.layerGAS?this.layerGAS:this.dgGAS}},ee=function(n,a,g){null===a?(n.getVertexPosition(g,r),n.getVertexPosition(g+1,i)):(n.getVertexPosition(a[g],r),n.getVertexPosition(a[g+1],i)),v.subVectors(i,r);let h=v.dot(v);if(h+=2*Math.sqrt(h)*L.normMM+L.normMM2,v.subVectors(r,q.origin),v.cross(q.direction),!(v.dot(v)>h)&&function(n,r,i,o,c,a){const s=c,g=.5*t._screenWidth,h=.5*t._screenHeight;f.copy(i),f.x=(f.x+1)*g,f.y=(f.y+1)*h,l.copy(n),u.copy(r),l.applyMatrix4(o),u.applyMatrix4(o),p.copy(l),d.copy(u),p.applyProjection(t._projScreenMatrix),d.applyProjection(t._projScreenMatrix);const x=p.z>1,v=d.z>1;if(x||v){const n=a._viewpoint._frustum,r=l.dot(n.planes[5].normal)+n.planes[5].constant<0,i=u.dot(n.planes[5].normal)+n.planes[5].constant<0;if(r&&i)return!1;if(r||i){const i=new e.Line3(l,u),o=n.planes[5].intersectLine(i);r?(p.copy(o),p.applyProjection(t._projScreenMatrix)):(d.copy(o),d.applyProjection(t._projScreenMatrix))}}p.x=(p.x+1)*g,p.y=(p.y+1)*h,d.x=(d.x+1)*g,d.y=(d.y+1)*h,m.subVectors(d,p),y.subVectors(f,p);const M=y.x*m.x+y.y*m.y;if(Math.abs(M)<1e-12)return!1;const S=m.x*m.x+m.y*m.y,b=Math.sqrt(S),w=s.length*S/b;if(M<-w||M>S+w)return!1;const V=M/S,P=p.x+V*m.x,G=p.y+V*m.y,_=Math.sqrt((P-f.x)*(P-f.x)+(G-f.y)*(G-f.y));return!(_>s.norm||_<-s.norm)}(r,i,o,H,L,s)){const t=Q.computeShortestPointToLine(l,u),r=Q.origin.distanceTo(t);O={distance:Math.max(0,.99*r),point:t.clone(),normal:null,tangent:(new e.Vector3).subVectors(t,l).normalize(),primitive:Y.clone(),geometry:n,object:c},U.push(O)}};for(let e=0;e<K;e++){const n=Z.drawingGroups,r=Z.vertexIndexArray;for(let e=0;e<n.length;e++){const i=n[e];if(1!=i.glType)continue;if(t.filterDrawingGroup(i,J,x))continue;const o=c.layer&&c.layer.getIntervals(Z,i);if(!o){const e=i.gas;if(t.checkGAS(e,i))continue;$.updateToleranceFunc(e,i,null)}$.computeDGGAS(i.gas);const a=i.getPrimitivesCount();t.selectDGBSCache(i);for(let e=0;e<a;e++){Y.set(i,e);const n=Y.getCount(),a=Y.getStart();if(!G(o,a,i,M,c,$)&&!t.checkRayToPrimitiveBoundingSphere(Y,q,0,L.normMM,s,g))if(h)X.has(i)?X.get(i).push(e):X.set(i,[e]);else{const e=a+n;for(let t=a;t<e;t+=2)ee(Z,i.nonIndexed?null:r,t)}}}Z=c.geometry[e+1]}return h&&X.forEach(function(e,t,n){e.sort(function(e,t){return e<=t}),U.push({object:c,dg:t,prims:e})}),U},intersectBufferGeomPoint:function(i,o,c,a,s,d,f,h,y,x){const v=c._viewpoint.viewer,M=v.renderer.renderer,S=c.getWorldSizeFromPixelSize(1/f,o.worldCenter,v._getDivClientHeight(),2),b=M.getMaterialMode(o,M.getRenderMode(o,!0)),w=o.material?o.material.point?o.material.point:o.material:null,_=!!o.material&&o.material.force,I=o.gas,T=o.matApp,A=T?T._getMaterialFromGLType(0,0):null;let z=1,k=!1;const R=!A&&(b||!o.fromLoadedModel);w&&1==_&&R?(z=w.size?w.size:1,k=!0):b&&A?z=A.size?A.size:1:I&&(z=I.getPointSize());const D=function(e){const t={norm:0,normMM:0,computePointSize:e};return t.norm=V*(s+1)+Math.floor(e/2),t.normMM=t.norm/S,t};let j=D(z);const C=j,F=new Map;F.set(z,j);let B,W=[];const L=o._getMMMatrix(),E=(new e.Matrix4).multiplyMatrices(c.matrixWorldInverse,L),O=(new e.Matrix4).getInverse(L);o.matrixRotationWorld.extractRotation(L);const U=(new e.Ray).copy(this).applyMatrix4(O),H=o.getFilterGeomType();let[N,q]=P(o);if(!h&&(w&&w._isAlteringGeometryOnGPU||N&&!N.vertexIndexArray))return B={distance:0,primitive:!0,object:o,point:null,normal:null},W.push(B),W;U.direction.normalize();const J=new n.SGPrimitiveHelper,Z=this,K=new Map;let Q=1/0,X=d;const Y=a;Y||(X=!1);const $={dgGAS:null,layerGAS:null,updateToleranceFunc:function(e,t,n){if(k&&!n)return void(j=C);if(n=n||t.material,b){if(n&&n.isMatApp)A&&(n=n.solveInheritance(T,o._occurrence?o._occurrence.depth:0)),n=n._getMaterialFromGLType(1,0);else if(A)return void(j=C)}else n=null;let r=1;n?r=n.size?n.size:1:e&&(r=e.isGAS?e.getPointSize():e.size?e.size:1),r!==j.computePointSize&&(F.has(r)?j=F.get(r):(j=D(r),F.set(r,j)))},computeDGGAS:function(e){},computeLayerGAS:function(e){},getGAS:function(){return this.layerGAS?this.layerGAS:this.dgGAS}},ee=function(n,c,a){if(null===c?n.getVertexPosition(a,r):n.getVertexPosition(c[a],r),X){const t=function(t,n,r,i){let o=1/0;l.copy(t),u.copy(n),l.applyMatrix4(i);const c=new e.Matrix4;return c.getInverse(r),u.applyMatrix4(c),u.applyMatrix4(i),l.z>u.z-.01&&l.z<u.z+.01&&(m.subVectors(l,u),o=Math.sqrt(m.x*m.x+m.y*m.y)),o}(r,Y,L,E);if(t<Q){Q=t;const e=Z.origin.distanceTo(l);B={distance:Math.max(0,.98*e),point:l.clone(),normal:null,primitive:J.clone(),geometry:n,object:o}}}else if(function(e,n,r,i,o){let c=96;const a=i/c;o&&(c*=o);const s=.5*t._screenWidth/c,u=.5*t._screenHeight/c;return g.copy(n),g.x*=s,g.y*=u,l.copy(e),l.applyMatrix4(r),p.copy(l),p.applyProjection(t._projScreenMatrix),p.x*=s,p.y*=u,m.subVectors(g,p),!(Math.sqrt(m.x*m.x+m.y*m.y)>a)}(r,i,L,j.norm,f)){const e=Z.origin.distanceTo(l);B={distance:Math.max(0,.98*e),point:l.clone(),normal:null,primitive:J.clone(),geometry:n,object:o},W.push(B)}};for(let e=0;e<q;e++){const n=N.drawingGroups,r=N.vertexIndexArray;for(let e=0;e<n.length;e++){const i=n[e];if(0!==i.glType)continue;if(t.filterDrawingGroup(i,H,y))continue;const c=o.layer&&o.layer.getIntervals(N,i);if(!c){const e=i.gas;if(t.checkGAS(e,i))continue;$.updateToleranceFunc(e,i,null)}$.computeDGGAS(i.gas);const a=i.getPrimitivesCount();for(let e=0;e<a;e++){J.set(i,e);const t=J.getCount(),n=J.getStart();if(!G(c,n,i,x,o,$))if(h)K.has(i)?K.get(i).push(e):K.set(i,[e]);else{const e=n+t;for(let t=n;t<e;t++)ee(N,i.nonIndexed?null:r,t)}}}N=o.geometry[e+1]}return X&&B&&W.push(B),h&&K.forEach(function(e,t,n){e.sort(function(e,t){return e<=t}),W.push({object:o,dg:t,prims:e})}),W}}}),define("DS/Intersection/Ray",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/IntersectionUtils","DS/Intersection/RayFrustumUtils","DS/Intersection/RayIntersectionUtils","DS/Intersection/RayCastUtils"],function(e,t,n,r,i,o){"use strict";var c,a,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3;function g(t,n,r){var i=t;if(n._occurrence&&(n._occurrence.renderMode&&(n._occurrence.renderMode.getMask?i=n._occurrence.renderMode.getMask():console.error("Error: expected RenderMode in OccurrenceNode.renderMode but got "+typeof n._occurrence.renderMode)),n._occurrence.pickingMode&&(r=n._occurrence.pickingMode)),r){var[o,c,a]=r._getPickingMasks(i);i=o|c|a}return i|e.RenderMode.defaultMask}function p(t,n,r){return!0===t?t=e.RenderMode.facesMask:!1===t&&(t=0),!0===n?n=e.RenderMode.linesMask:!1===n&&(n=0),!0===r?r=e.RenderMode.pointsMask:!1===r&&(r=0),t|n|r|e.RenderMode.defaultMask}var d,f,m,h=e.__visibleInCurrentSpace,y=function(t,n){this.origin=void 0!==t?t:new e.Vector3,this.direction=void 0!==n?n:new e.Vector3};return y.prototype={constructor:y,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},_cleanIntersectionsList:function(e,t){if(t)for(var n=0;n<e.length;n++){var r=e[n];if(r.object){var i=r.object;if(void 0!==i.pickable&&!i.pickable){e[n]={};continue}}}},at:function(t,n){return(n||new e.Vector3).copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var t=new e.Vector3;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,n){var r=n||new e.Vector3;r.subVectors(t,this.origin);var i=r.dot(this.direction);return r.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(){var t=new e.Vector3;return function(e){var n=t.subVectors(e,this.origin).dot(this.direction);return t.copy(this.direction).multiplyScalar(n).add(this.origin),t.distanceTo(e)}}(),distanceSqToSegment:(d=new e.Vector3,f=new e.Vector3,m=new e.Vector3,function(e,t,n,r){d.copy(e).add(t).multiplyScalar(.5),f.copy(t).sub(e).normalize(),m.copy(this.origin).sub(d);var i,o,c,a,s=.5*e.distanceTo(t),l=-this.direction.dot(f),u=m.dot(this.direction),g=-m.dot(f),p=m.lengthSq(),h=Math.abs(1-l*l);if(h>0)if(o=l*u-g,a=s*h,(i=l*g-u)>=0)if(o>=-a)if(o<=a){var y=1/h;c=(i*=y)*(i+l*(o*=y)+2*u)+o*(l*i+o+2*g)+p}else o=s,c=-(i=Math.max(0,-(l*o+u)))*i+o*(o+2*g)+p;else o=-s,c=-(i=Math.max(0,-(l*o+u)))*i+o*(o+2*g)+p;else o<=-a?c=-(i=Math.max(0,-(-l*s+u)))*i+(o=i>0?-s:Math.min(Math.max(-s,-g),s))*(o+2*g)+p:o<=a?(i=0,c=(o=Math.min(Math.max(-s,-g),s))*(o+2*g)+p):c=-(i=Math.max(0,-(l*s+u)))*i+(o=i>0?s:Math.min(Math.max(-s,-g),s))*(o+2*g)+p;else o=l>0?-s:s,c=-(i=Math.max(0,-(l*o+u)))*i+o*(o+2*g)+p;return n&&n.copy(this.direction).multiplyScalar(i).add(this.origin),r&&r.copy(f).multiplyScalar(o).add(d),c}),isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){return 0!=e.normal.dot(this.direction)||0==e.distanceToPoint(this.origin)},distanceToPlane:function(e){var t=e.normal.dot(this.direction);return 0==t?0==e.distanceToPoint(this.origin)?0:void 0:-(this.origin.dot(e.normal)+e.constant)/t},intersectPlane:function(e,t){var n=this.distanceToPlane(e);if(void 0!==n)return this.at(n,t)},intersectBox:function(e,t,n){var r,i,o,c,a,s,l=1/this.direction.x,u=1/this.direction.y,g=1/this.direction.z,p=this.origin;return l>=0?(r=(e.min.x-p.x)*l,i=(e.max.x-p.x)*l):(r=(e.max.x-p.x)*l,i=(e.min.x-p.x)*l),u>=0?(o=(e.min.y-p.y)*u,c=(e.max.y-p.y)*u):(o=(e.max.y-p.y)*u,c=(e.min.y-p.y)*u),r>c||o>i?null:((o>r||r!=r)&&(r=o),(c<i||i!=i)&&(i=c),g>=0?(a=(e.min.z-p.z)*g,s=(e.max.z-p.z)*g):(a=(e.max.z-p.z)*g,s=(e.min.z-p.z)*g),r>s||a>i?null:((a>r||r!=r)&&(r=a),(s<i||i!=i)&&(i=s),i<0?null:(n&&(n.x=r,n.y=i),this.at(r>=0?r:i,t))))},applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new e.Ray).copy(this)},intersectPlaneInDir:function(e,t){var n=this.distanceToPlane(e);if(!(void 0===n||n<0))return this.at(n,t)},computeShortestPointToLine:function(t,n){var r=this.direction,i=(new e.Vector3).subVectors(n,t),o=(new e.Vector3).subVectors(this.origin,t),c=r.lengthSq(),a=r.dot(i),s=i.lengthSq(),l=r.dot(o),u=i.dot(o),g=c*s-a*a,p=0;return p=g<1e-7?a>s?l/a:u/s:(c*u-a*l)/g,i.multiplyScalar(p).add(t)},_distanceFromIntersection:function(e){var t=this.origin,n=this.direction;return s.subVectors(e,t),c=s.dot(n),a=l.addVectors(t,u.copy(n).multiplyScalar(c)),e.distanceTo(a)},intersectMeshInstances:function(t,r,i,o,c,a,s,l,u,d){var f,m,y,x,v,M=(d=d||{}).devicePixelRatio?d.devicePixelRatio:e.getDevicePixelRatio(),S=!!d.candidatesOnly,b=!!d.debugPickHybrid,w=!!d.useViewerPickingRules,V=void 0===d.inVisibleSpace||d.inVisibleSpace,P=t.object,G=t.type,_=p(o,c,a);void 0!==G?(y=2===G,x=1===G,v=0===G):(y=!0,x=!0,v=!0);var I=null,T=!1;if(w&&r._viewpoint&&r._viewpoint.viewer&&((I=new e.PickingMode)._fromRenderer(r._viewpoint.viewer.renderer.renderer),T=r._viewpoint.viewer.renderer.renderer.currentRendererMode===e.RendererMode.dynamic),P instanceof e.Mesh)f=[{object:P}];else{var A=d.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(f=[],m=0;m<A.length;m++)f=f.concat(P.getWebGLObjects(A[m]))}var z,k,R=[];n._screenWidth=s,n._screenHeight=l,r.matrixWorldInverse.getInverse(r.matrixWorld),n._projScreenMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);var D=u*M,j=1.4142135623730951;for(m=0,z=f.length;m<z;m++)if(null!==f[m]){k=f[m].object;var C=!T||T&&!k.getDynamicMode(!0);if(k._isLastLOD()||(C=!1),C&&!1!==k.noPickThrough&&h(k.visible,k.visibilityFree,V,k.layer,k._occurrence)){var F=new e.Vector3;null!==k.geometry.boundingSphere&&F.copy(k.geometry.boundingSphere.center);var B=k._getMMMatrix();F.applyMatrix4(B);var W=this._distanceFromIntersection(F),L=B.getMaxScaleOnAxis(),E=0;if(k.frustumCulled&&void 0!==l){var O=0,U=0,H=null,N=0;k.geometry.length>=0?(H=k.geometry[0],N=k.geometry.length):2===k.geometry._type&&(H=k.geometry,N=1);for(var q=0;q<N;q++)for(var J=H.drawingGroups,Z=0,K=J.length;Z<K;Z++){var Q,X=J[Z];if(X.gas)X.gas.isGAS&&0===X.glType?Q=X.gas.getPointSize():X.gas instanceof e.ParticleBasicMaterial&&X.gas.size&&(Q=X.gas.size),Q>U&&(U=Q);else X.material&&X.material instanceof e.ParticleBasicMaterial&&X.material.size&&X.material.size>U&&(U=X.material.size)}O+=U,E=r.getWorldSizeFromPixelSize(O,F,n._screenHeight,2)}var Y=r.getWorldSizeFromPixelSize(D,F,n._screenHeight,2);if(!k.frustumCulled||W<=k.geometry.boundingSphere.radius*L+E*j/2+Y*j){var $=g(_,k,I);if(y){var ee;if(2===k.geometry._type||k.geometry.length>=0)(ee=this.intersectBufferGeomOptim(r,i,k,S,$,V)).length&&!S&&(!ee[0].point&&t.point&&(ee[0].point=t.point),!ee[0].normal&&t.normal&&(ee[0].normal=t.normal));else(ee=new e.Raycaster(this.origin,this.direction,r.near,r.far).intersectObject(k,!1)).length&&!S&&(!ee[0].point&&t.point&&(ee[0].point=t.point),!ee[0].normal&&t.normal&&(ee[0].normal=t.normal));R=R.concat(ee)}if(x){var te=this.intersectBufferGeomEdge(i,k,u,r,M,S,$,V);te.length&&!S&&(!te[0].point&&t.point&&(te[0].point=t.point),!te[0].normal&&t.normal&&(te[0].normal=t.normal)),R=R.concat(te)}if(v){var ne=this.intersectBufferGeomPoint(i,k,r,t.point,u,b,M,S,$,V);ne.length&&!S&&(!ne[0].point&&t.point&&(ne[0].point=t.point),!ne[0].normal&&t.normal&&(ne[0].normal=t.normal)),R=R.concat(ne)}}}}return S||R.sort(function(e,t){return e.distance-t.distance}),R},_cast:function(t,n,r,i){var o,c=r||{},a="mesh"===n,s=void 0!==c.rayLength?c.rayLength:1/0,l=null===c.intersectFaces||void 0===c.intersectFaces||c.intersectFaces,u=c.intersectEdges,g=c.intersectPoints,p=c.edgeTolerance?c.edgeTolerance:.1,d=c.pointTolerance?c.pointTolerance:.1,f=t,m=0,h=0,y=null,x=[],v=new e.Vector3;for(m=0,o=f.length;m<o;m++)if(null!==f[m]){var M=(y=f[m].object?f[m].object:f[m]).worldCenter,S=y.worldRadius,b=this.distanceToPoint(M);if(v.subVectors(M,this.origin).dot(this.direction)-S<=s&&b<=S){var w,V,P;if(l){if(2===y.geometry._type||y.geometry.length>=0)w=this._castRayIntoBufferGeom(y,a,s);else w=new e.Raycaster(this.origin,this.direction,0,s).intersectObject(y,!1);for(h=0;h<w.length;h++){var G=new i;if(w[h].primitive){var _=!0===w[h].primitive?null:THREEDS.SubElement.getFromSGNode(w[h].primitive);G.setFromOccurrence(w[h].object._occurrence,_,void 0,!0)}else G.setFromOccurrence(w[h].object._occurrence),w[h].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));w[h].pathElement=G}x=x.concat(w)}if(u&&(!a||a&&!w)){for(V=this._castRayIntoBufferGeomEdge(y,p,a,s),h=0;h<V.length;h++){G=new i;if(V[h].primitive){_=!0===V[h].primitive?null:THREEDS.SubElement.getFromSGNode(V[h].primitive);G.setFromOccurrence(V[h].object._occurrence,_,void 0,!0)}else G.setFromOccurrence(V[h].object._occurrence),V[h].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));V[h].pathElement=G}x=x.concat(V)}if(g&&(!a||a&&!V)){for(P=this._castRayIntoBufferGeomPoint(y,d,a,s),h=0;h<P.length;h++){G=new i;if(P[h].primitive){_=!0===P[h].primitive?null:THREEDS.SubElement.getFromSGNode(P[h].primitive);G.setFromOccurrence(P[h].object._occurrence,_,void 0,!0)}else G.setFromOccurrence(P[h].object._occurrence),P[h].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));P[h].pathElement=G}x=x.concat(P)}}}return x.sort(function(e,t){return e.distance-t.distance}),x},intersectMeshInstancesZones3D:function(t,r,i,o,c,a,s,l,u,d,f,m,y){var x,v,M=!!(y=y||{}).inVisibleSpace,S=!!y.useViewerPickingRules,b=void 0===M||M;if(t instanceof e.Mesh)x=[{object:t}];else{var w=y.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(x=[],v=0;v<w.length;v++)x=x.concat(t.getWebGLObjects(w[v]))}var V=null,P=!1;S&&r._viewpoint&&r._viewpoint.viewer&&((V=new e.PickingMode)._fromRenderer(r._viewpoint.viewer.renderer.renderer),P=r._viewpoint.viewer.renderer.renderer.currentRendererMode===e.RendererMode.dynamic);var G,_,I=p(s,l,u),T=[];for(n._screenWidth=d,n._screenHeight=f,r.matrixWorldInverse.getInverse(r.matrixWorld),n._projScreenMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),v=0,G=x.length;v<G;v++)if(null!==x[v]){_=x[v].object;var A=!P||P&&!_.getDynamicMode(!0);if(_._isLastLOD()||(A=!1),A&&!1!==_.noPickThrough&&h(_.visible,_.visibilityFree,b,_.layer,_._occurrence)){if(void 0!==_.pickable&&!_.pickable)continue;var z=new e.Sphere;null!==_.geometry.boundingSphere&&z.copy(_.geometry.boundingSphere);var k=_._getMMMatrix();if(z.center.applyMatrix4(k),c.intersectsSphere(z)){var R=[],D=g(I,_,V);if(m||a)for(var j=2;j>=0;j--){var C=[];if(2===j)if(2===_.geometry._type||_.geometry.length>=0)C=this.intersectBufferGeomZone3D(c,_,a,m,D,b);else C=new e.Raycaster(this.origin,this.direction,r.near,r.far).intersectObject(_,!1);else 1===j?C=this.intersectBufferGeomEdge3D(c,_,a,m,D,b):0===j&&(C=this.intersectBufferGeomPoint3D(c,_,D,b));if(a)R=R.concat(C);else{if(!m&&!C.length)break;if(!R.length&&C.length&&(R=R.concat(C)),m&&R.length>0)break}}else R=this.intersectBufferGeom3DInsideFrustumMesh(c,_,D,b);R&&(T=T.concat(R))}}}return T}},Object.assign(y.prototype,r),Object.assign(y.prototype,i),Object.assign(y.prototype,o),y}),define("DS/Intersection/Raycaster",["DS/Visualization/ThreeJS_R57","DS/Intersection/Ray"],function(e,t){"use strict";var n=function(e,n,r,i){this.ray=new t(e,n),this.ray.direction.lengthSq()>0&&this.ray.direction.normalize(),this.near=r||0,this.far=i||1/0},r=new e.Sphere,i=new t,o=new e.Plane,c=new e.Vector3,a=new e.Vector3,s=new e.Matrix4,l=function(e,t){return e.distance-t.distance},u=function(t,n,l){if(t instanceof e.Particle){a.getPositionFromMatrix(t.matrixWorld);var u=n.ray.distanceToPoint(a);if(u>t.scale.x)return l;l.push({distance:u,point:t.position,face:null,object:t})}else if(t instanceof e.Mesh){var g=t._getMMMatrix();if(a.getPositionFromMatrix(g),r.set(a,t.geometry.boundingSphere.radius*g.getMaxScaleOnAxis()),!n.ray.isIntersectionSphere(r))return l;var p,d,f,m,h=t.geometry,y=h.vertices,x=t.material instanceof e.MeshFaceMaterial,v=!0===x?t.material.materials:null,M=t.material.side,S=n.precision;t.matrixRotationWorld.extractRotation(g),s.getInverse(g),i.copy(n.ray).applyMatrix4(s);for(var b=0,w=h.faces.length;b<w;b++){var V=h.faces[b],P=!0===x?v[V.materialIndex]:t.material;if(void 0!==P){o.setFromNormalAndCoplanarPoint(V.normal,y[V.a]);var G=i.distanceToPlane(o);if(!(Math.abs(G)<S||G<0)){if((M=P.side)!==THREEConstants.DoubleSide){var _=i.direction.dot(o.normal);if(!(M===THREEConstants.FrontSide?_<0:_>0))continue}if(!(G<n.near||G>n.far)){if(c=i.at(G,c),V instanceof e.Face3){if(p=y[V.a],d=y[V.b],f=y[V.c],!e.Triangle.containsPoint(c,p,d,f))continue}else{if(!(V instanceof e.Face4))throw Error("face type not supported");if(p=y[V.a],d=y[V.b],f=y[V.c],m=y[V.d],!e.Triangle.containsPoint(c,p,d,m)&&!e.Triangle.containsPoint(c,d,f,m))continue}l.push({distance:G,point:n.ray.at(G),face:V,faceIndex:b,object:t})}}}}}},g=function(e,t,n){for(var r=e.getDescendants(),i=0,o=r.length;i<o;i++)u(r[i],t,n)};return n.prototype.precision=1e-4,n.prototype.set=function(e,t){this.ray.set(e,t),this.ray.direction.length()>0&&this.ray.direction.normalize()},n.prototype.intersectObject=function(e,t){var n=[];return!0===t&&g(e,this,n),u(e,this,n),n.sort(l),n},n.prototype.intersectObjects=function(e,t){for(var n=[],r=0,i=e.length;r<i;r++)u(e[r],this,n),!0===t&&g(e[r],this,n);return n.sort(l),n},n});