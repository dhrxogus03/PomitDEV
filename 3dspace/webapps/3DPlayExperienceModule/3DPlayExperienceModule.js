/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/3DPlayUtils/IdentifyPLMType",["UWA/Class","DS/3DPlaySupport/SupportList"],function(e,t){"use strict";return e.extend({init:function(){this._parent()},isKindOfDrawing:function(e,i){t["3DSPACE"].resolveParenting(e,function(e){"drawing"===e.toLowerCase()?i(e):i(!1)})}})}),define("DS/3DPlaySocialPanel/3DPlaySocialPanel",[],function(){}),define("DS/WebViewer2D/CanvasShapes",["UWA/Class","DS/WebUtils/GeometryUtils","DS/WebUtils/Vector2"],function(e,t,i){"use strict";function n(e){var t=e.settings;return{id:Date.now(),type:e.shapeData.type,property:{color:t.getColor(),thickness:t.getThickness()/e.scale},linkID:new Array,data:{}}}function r(e){var t=e.shape.property,i=e.canvas.getContext("2d");return e.lowLightMode?(i.globalAlpha=.8,i.strokeStyle="#D3D3D3",i.fillStyle="#D3D3D3"):(i.strokeStyle=t.color,i.fillStyle=t.color,i.globalAlpha=1,e.alpha&&(i.globalAlpha=e.alpha)),i.lineCap="round",i.lineJoin="round",i.lineWidth=t.thickness*e.scale,i}function s(e,t,i){var n=t.length;e.beginPath(),e.moveTo(t[0].x,t[0].y);for(var r=1;r<n;++r)e.lineTo(t[r].x,t[r].y);i&&e.closePath(),e.stroke()}var o={createunknownOpen:function(e){var t=n(e),i=e.shapeData;return t.data={path:i},t},drawunknownOpen:function(e){for(var t=e.shape,i=r(e),n=t.data.path,o=[],a=n.length,l=0;l<a;++l)o.push({x:n[l].x*e.scale,y:n[l].y*e.scale});return s(i,o,!1),{lastPosition:o[0].x-o[a-1].x>=0?o[0]:o[a-1]}},isIntersectunknownOpen:function(e){for(var i=e.shape,n=i.data.path,r=0;r<n.length-1;++r)if(t._intersect(n[r],n[r+1],e.startPoint,e.endPoint))return i.id;return!1},createline:function(e){var t=n(e),i=e.shapeData,r=[];return r.push({x:i[0].x,y:i[0].y}),r.push({x:i[i.length-1].x,y:i[i.length-1].y}),t.data={path:r},t},drawline:function(e){return o.drawunknownOpen(e)},isIntersectline:function(e){return o.isIntersectunknownOpen(e)},createarrowhead:function(e){var t=n(e),r=e.shapeData.data.vertices,s=e.shapeData.connectionData;if(s){for(var o=s.shape,a=s.pointID,l=s.pointEndID,d=o.data.path,c=function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},u=0,h=0;h<d.length-1;++h)u+=c(d[h+1],d[h]);u*=.15;var p=c(r[1],r[0]),g=c(r[1],r[2]),f=p>=g?p:g;u=f<=u?f:u;var m=new i(d[l].x-d[a].x,d[l].y-d[a].y);(m=m.normalize()).rotateAround({x:0,y:0},.55),r[0].x=m.x*u+d[a].x,r[0].y=m.y*u+d[a].y,r[1].x=d[a].x,r[1].y=d[a].y,m.rotateAround({x:0,y:0},-1.1),r[2].x=m.x*u+d[a].x,r[2].y=m.y*u+d[a].y,o.linkID.push({id:t.id,pointID:a}),t.linkID.push({id:o.id,pointID:1})}return t.data={path:r},t},drawarrowhead:function(e){var t=e.shape,i=r(e),n=[];return n.push({x:t.data.path[0].x*e.scale,y:t.data.path[0].y*e.scale}),n.push({x:t.data.path[1].x*e.scale,y:t.data.path[1].y*e.scale}),n.push({x:t.data.path[2].x*e.scale,y:t.data.path[2].y*e.scale}),s(i,n,!1),{lastPosition:{x:n[1].x,y:n[1].y}}},isIntersectarrowhead:function(e){return o.isIntersectunknownOpen(e)},createcircle:function(e){var t=n(e),i=e.shapeData;return t.data={radius:i.data.radius,centre:{x:i.data.centre.x,y:i.data.centre.y}},t},drawcircle:function(e){var t=e.shape,i=r(e),n=t.data.centre.x*e.scale,s=t.data.centre.y*e.scale,o=t.data.radius*e.scale;return i.beginPath(),i.arc(n,s,o,0,2*Math.PI),i.stroke(),{lastPosition:{x:n,y:s}}},isIntersectcircle:function(e){for(var i=e.shape,n=i.data.radius,r=i.data.centre.x,s=i.data.centre.y,o=2*Math.PI/10,a=[],l=0;l<2*Math.PI;l+=o)a.push({x:r+n*Math.cos(l),y:s+n*Math.sin(l)});for(var d=0;d<a.length-1;++d)if(t._intersect(a[d],a[d+1],e.startPoint,e.endPoint))return i.id;return!1},createellipse:function(e){var t=e.shapeData,i=n(e);return i.data={radiusX:t.data.radius1,radiusY:t.data.radius2,centre:{x:t.data.centre.x,y:t.data.centre.y},angle:t.data.angle},i},drawellipse:function(e){var t=e.shape,i=r(e),n=t.data.centre.x*e.scale,s=t.data.centre.y*e.scale,o=t.data.radiusX*e.scale,a=t.data.radiusY*e.scale,l=t.data.angle*Math.PI/180;return i.save(),i.beginPath(),i.translate(n,s),i.rotate(l),i.translate(-o,-a),i.scale(o,a),i.arc(1,1,1,0,2*Math.PI),i.restore(),i.stroke(),{lastPosition:{x:n,y:s}}},isIntersectellipse:function(e){var n=e.shape,r=n.data.centre.x,s=n.data.centre.y,o=n.data.radiusX,a=n.data.radiusY,l=n.data.angle*Math.PI/180,d=[];d.push(new i(r+o,s+a).rotateAround({x:r,y:s},l)),d.push(new i(r-o,s+a).rotateAround({x:r,y:s},l)),d.push(new i(r-o,s-a).rotateAround({x:r,y:s},l)),d.push(new i(r+o,s-a).rotateAround({x:r,y:s},l));for(var c=0;c<d.length-1;++c)if(t._intersect(d[c],d[c+1],e.startPoint,e.endPoint))return n.id;return!1},createpolygon:function(e){var t=e.shapeData,i=n(e);i.data={},i.data.path=[];for(var r=0;r<t.data.vertices.length;++r)i.data.path.push({x:t.data.vertices[r].x,y:t.data.vertices[r].y});return i},drawpolygon:function(e){for(var t=e.shape,i=r(e),n=null,o=null,a=t.data.path,l=[],d=a.length,c=0;c<d;++c)l.push({x:a[c].x*e.scale,y:a[c].y*e.scale}),(null==n||n<l[c].x)&&(n=l[c].x),(null==o||o>l[c].y)&&(o=l[c].y);return s(i,l,!0),{lastPosition:{x:n,y:o}}},isIntersectpolygon:function(e){return o.isIntersectunknownOpen(e)},createrectangle:function(e){return o.createpolygon(e)},drawrectangle:function(e){return o.drawpolygon(e)},isIntersectrectangle:function(e){return o.isIntersectpolygon(e)},createsquare:function(e){return o.createpolygon(e)},drawsquare:function(e){return o.drawpolygon(e)},isIntersectsquare:function(e){return o.isIntersectpolygon(e)},createtriangle:function(e){return o.createpolygon(e)},drawtriangle:function(e){return o.drawpolygon(e)},isIntersecttriangle:function(e){return o.isIntersectpolygon(e)},createtext:function(e){var t=n(e);return t.data=e.shapeData,t},drawtext:function(e){var t=e.shape.data,i=1+t.point.x*e.scale,n=t.point.y*e.scale,s=r(e),o=Math.ceil(t.fontSize*e.scale)+'px "3ds"';s.font=t.fontWeight+" "+o;for(var a=0;a<t.text.length;++a){var l=n+(t.offsetHeight-4)*e.scale*t.controlScale+a*t.offsetHeight*e.scale*t.controlScale;s.fillText(t.text[a],i,l)}return{lastPosition:{x:i,y:n}}},isIntersecttext:function(e){var i=e.shape.data.point.x,n=e.shape.data.point.y,r=e.shape.data.width,s=e.shape.data.height,o=[];o.push({x:i,y:n}),o.push({x:i,y:n+s}),o.push({x:i+r,y:n+s}),o.push({x:i+r,y:n});for(var a=0;a<o.length-1;++a)if(t._intersect(o[a],o[a+1],e.startPoint,e.endPoint))return e.shape.id;return!1}};return{createShapeFromJSON:function(e){},createShape:function(e){var t=o["create"+e.shapeData.type];return t||(t=o.createunknownOpen),t(e)},drawShape:function(e){var t=o["draw"+e.shape.type];return t||(t=o.drawunknownOpen),t(e)},isIntersectShape:function(e){var t=o["isIntersect"+e.shape.type];t||(t=o.isIntersectunknownOpen);var i=!1,n=t(e);return n&&(i=new Array,function e(t,i,n){if(n.indexOf(t)<0){n.push(t);var r=i[t];if(r)for(var s=r.linkID,o=0;o<s.length;++o)e(s[o].id,i,n)}return n.length>0}(n,e.shapeList,i)),i}}}),define("DS/3DPlayUtils/ContextualBar",["DS/WebInfraUI/ContextualBar"],function(e){"use strict";return console.log("WARNING!!! ContextualBar class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBar' to access it."),e}),define("DS/3DPlayUtils/NavigationArrows",["DS/WebInfraUI/NavigationArrows"],function(e){"use strict";return console.log("WARNING!!! NavigationArrows class has been migrated to new module. Please use 'DS/WebInfraUI/NavigationArrows' to access it."),e}),define("DS/3DPlaySocialPanel/3DPlaySocialPanelManager",["UWA/Class","DS/Windows/Panel","DS/WebSystem/Settings","DS/WebappsUtils/WebappsUtils"],function(e,t,i,n){"use strict";return e.extend({init:function(e){this._parent(e),this._frameWindow=e.frameWindow,this._buildPanel({assetId:e.assetId,tenantId:e.tenantId,serviceUrl:e.serviceUrl,assetProvider:e.assetProvider,serverToken:e.serverToken,onClickCB:e.onCommentClick})},_buildPanel:function(e){var i=this;require(["DS/SocialToolbar/SocialToolbar"],function(r){var s=new UWA.Element("div",{styles:{"background-color":"white"}}),o=i._frameWindow.getImmersiveFrame(),a=WUXDockAreaEnum.RightDockArea,l=e.serviceUrl,d=e.assetId;!e.assetProvider||"3DDRIVE"!=e.assetProvider&&"3DSPACE"!=e.assetProvider||(l=e.serviceUrl+"/resources",d="3DDRIVE"==e.assetProvider?"driveid:"+d:"pid:"+d),i.commentPanel=new r({subjectURI:d,tenantId:e.tenantId,serviceURL:l,"3DSwymServerToken":e.serverToken,enableShare:!1,commentProxyToken:{header:"X-DS-CSRFTOKEN"},events:{onMediaClick:e.onClickCB}}),i.commentPanel.inject(s),i._dockingElement=o.getDockingElement(a),i.panel=new t({titleBarVisibleFlag:!1,icon:n.getWebappsAssetUrl("3DPlaySpecTree","icons/32/")+"I_3DPlaySpecTree.png",title:"",content:s,immersiveFrame:o,resizableFlag:!0,movableFlag:!1,currentDockArea:a,width:400,verticallyStretchableFlag:!0,usePaddingFlag:!1,closeButtonFlag:!1,floatableFlag:!1,expandedFlag:!0,ensureHeightDefinitionOnHierarchy:!0})},function(e){console.log("Require failed for SocialToolbar")})},hide:function(){return!!this._dockingElement&&(this._dockingElement.visibleDockingZoneFlag=!1,this._dockingElement.collapseDockingZoneFlag=!0,!0)},show:function(){return!!this._dockingElement&&(this._dockingElement.visibleDockingZoneFlag=!0,this._dockingElement.collapseDockingZoneFlag=!1,!0)},postComment:function(e,t){if(this.commentPanel){var i={media:[{type:"annotation",file:t,data:{annotationFile:e}}]};this.commentPanel.setActiveFieldContent(i)}},dispose:function(){this.panel.destroy(),this.panel=void 0}})}),define("DS/WebViewer2D/ViewerDoc",["UWA/Core","UWA/Class","UWA/Element","DS/WebSystem/Environment"],function(e,t,i,n){"use strict";var r={init:function(t){var i,n;if(this.errorThumbnail="../3DPlay2DExperience/assets/images/I_3DSHARELoadFailed.png",this.status={failed:!1,loaded:!1},this.realSizeWidth=t.realSizeWidth,this.realSizeHeight=t.realSizeHeight,this.viewer=t.viewer,this.actionbarHeight=t.actionbarHeight,t.asset&&(n=t.asset.currentSrc||t.asset.baseURI||t.asset),"string"==typeof n&&""!==n){var r=n.split("/");i=r[r.length-1]}this.title=t.defaultTitle||i,this.thumbnail=null;var s={sheet:t.sheet};this.container=new e.Element("div",{data:s,class:"viewer"}).inject(this.viewer)},loadAsset:function(e){e.asset!==this.asset&&(this.asset=e.asset)},_setThumbnail:function(e){this.thumbnail=e},getTitle:function(){return this.title},getCurrentScale:function(){return this.scale},getRealSizeHeight:function(){return this.realSizeHeight},getRealSizeWidth:function(){return this.realSizeWidth},getMargin:function(){return this.margin},getContainer:function(){return this.container},show:function(){this.container.style.top="0px"},hide:function(){this.container.style.top=this.viewer.offsetHeight+"px"},onMouseWheel:function(e){e.preventDefault&&e.preventDefault();var t=window.event||e;this.zoom(t,(t.wheelDelta||-t.detail)>0?1.1:10/11,{x:t.clientX,y:t.clientY})},initMouseMoveZoom:function(e){this.currentZoom=100,this.initialY=e.clientY,this.minZoom=!1,this.viewerCenter={x:this.container.offsetWidth/2,y:this.container.offsetHeight/2},this.currentScale=this.scale},onMouseMoveZoom:function(e){if(n.isSet("3DPlay.DisableViewerCanvas")){var t=e.from&&e.from.length?e.from[0].event:null,i=100+(this.initialY-t.clientY)/2;if(i>0&&(!1===this.minZoom||i>this.currentZoom)&&(this.zoom(t,100/this.currentZoom,{x:this.viewerCenter.x,y:this.viewerCenter.y}),this.currentZoom=i,this.zoom(t,this.currentZoom/100,{x:this.viewerCenter.x,y:this.viewerCenter.y}),this.minZoom=this.scale<.1),!(e.from&&e.from[0]&&e.from[0].event&&e.from[0].event.preventDefault))return!1;e.from[0].event.preventDefault()}else if(e.from&&e.from[0]&&e.from[0].event&&e.from[0].event.preventDefault){e.from[0].event.preventDefault();var r=e.from&&e.from.length?e.from[0].event:null,s=this.initialY-r.clientY;if(Math.abs(s)>this.viewer.offsetHeight/100&&Math.abs(s)<this.viewer.offsetHeight){var o=1+s/this.viewer.offsetHeight*10,a=this.currentScale*o/this.scale;this.zoom(r,a,{x:this.viewerCenter.x,y:this.viewerCenter.y})}}return this.scale},panStart:function(e,t){},pan:function(e,t){return!0},panEnd:function(e,t){},onResize:function(){},fit:function(){},realSize:function(){},reframe:function(){},zoom:function(e,t,i){return!0},focusOn:function(e,t){},getScreenShot:function(e){var t=document.createElement("canvas");t.width=this.viewer.offsetWidth,t.height=this.viewer.offsetHeight;var i=t.getContext("2d");i.beginPath(),i.rect(0,0,t.width,t.height),i.fillStyle="white",i.fill();this.generateScreenshotOfDoc({onSuccess:function(r,s){i.drawImage(r,Math.floor(s.clipX),Math.floor(s.clipY),Math.floor(s.clipWidth),Math.floor(s.clipHeight),Math.floor(s.pastingX),Math.floor(s.pastingY),Math.floor(s.pastingWidth),Math.floor(s.pastingHeight)),n.isSet("ODT_3DPlay_Document2D")?require(["DS/CoreEvents/Events"],function(e){e.publish({event:n.get("ODT_3DPlay_Document2D")})}):e.onSuccess(t.toDataURL("image/png"))},onFail:function(t){e.onFail(t)},width:t.width,height:t.height})},generateScreenshotOfDoc:function(e){},rotate:function(e){},getAnnotationDiv:function(){},loadFailed:function(e){this.status.failed=!0,this.failureID=" failed "},getErrorID:function(){return this.failureID},dispose:function(){this.viewer.removeChild(this.container),this.container=this.viewer=null},setRealDimension:function(e){e&&(this.realSizeWidth=e.realSizeWidth,this.realSizeHeight=e.realSizeHeight)}};return t.extend(r)}),define("DS/3DPlayUtils/ContextualBarManager",["DS/WebInfraUI/ContextualBarManager"],function(e){"use strict";return console.log("WARNING!!! ContextualBarManager class has been migrated to new module. Please use 'DS/WebInfraUI/ContextualBarManager' to access it."),e}),define("DS/3DPlayUtils/ConvertService",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){this.supportedFormats={};var e=0;this.getConversionFormat=function(e){return this.supportedFormats[e]||null},this.clearQueue=function(){e++},this.convert=function(t,i,n,r,s){var o=i.ConversionFeedBack.progress,a=o.registerSubProgress(),l=i.ConversionFeedBack.notifTimeoutID,d=t;!1===Array.isArray(d)&&(d=[d]);for(var c=0,u=0,h=function(t){t.queueIdx===e&&(clearTimeout(l),o.advanceToMax(a),c++,delete t.queueIdx,c+u===d.length?r(t):s?s(t):r(t))},p=function(e,t){clearTimeout(l),o.advanceToMax(a),u++,n(e,t)},g=0;g<d.length;g++)d[g].queueIdx=e,this._convert({asset:d[g],onConvertSuccess:h,onConvertError:p,ConversionOpts:i.ConversionOpts||{}})},this._convert=function(){console.error("PlayWeb - Something is wrong, _convert is not defined.")}}})}),define("DS/3DPlayUtils/FullScreen",["UWA/Class","DS/CoreEvents/Events"],function(e,t){"use strict";return e.extend({init:function(e,i,n,r){this._parent();var s,o,a="none";try{window.getSwymContainer&&(e=window.getSwymContainer())}catch(e){}if(i&&"HTML5"===i.mode){for(var l=!0,d=window,c=document,u=d.parent;d!==u&&l;){var h,p,g=u.document,f=g.getElementsByTagName("iframe");for(h=0;h<f.length;h++)if((p=g.getElementsByTagName("iframe")[h])&&p.contentWindow.document===c){p.getAttribute("allowfullscreen")||(l=!1);break}c=g,u=(d=u).parent}if(l=(l=l&&(e.requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||e.msRequestFullscreen))&&(document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen||document.msCancelFullScreen||document.msFullscreenEnabled)){a="html5",o=function(){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},s=function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()};var m=function(t){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||!n.classList.contains("active")&&!e.classList.contains("PlayWeb-FullScreen")?(n.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(n.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))};document.onfullscreenchange=m,document.onmozfullscreenchange=m,document.onwebkitfullscreenchange=m,document.onmsfullscreenchange=m}}else if(i&&"CUSTOM"===i.mode&&i.onActivate&&i.onDeactivate&&r&&r.getView){a="custom",o=function(){setTimeout(function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}})},500)},s=function(){t.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})};var v=function(e){r.fullscreen&&t.publish({event:"3DPLAY/PLAYFROMCOMPASS/DISABLE",data:{}})},S=function(e){r.fullscreen&&setTimeout(function(){t.publish({event:"3DPLAY/PLAYFROMCOMPASS/ENABLE",data:{}})},500)};r.addEvent("onHide",v),r.addEvent("onShow",S),r.onViewChange=function(e){"maximized"===e.type||"fullscreen"===e.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==e.type&&"minimized"!==e.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}})},i.onViewChange&&i.onViewChange(function(t){!0===t?(n.addClassName("active"),e.classList.add("PlayWeb-FullScreen")):(n.removeClassName("active"),e.classList.remove("PlayWeb-FullScreen"))})}else if(i&&"PLATFORM"===i.mode&&r&&r.getView&&r.requestView){a="platform";var D="none";o=function(){"fullscreen"!==(D=r.getView().type)&&r.requestView({type:"fullscreen"})},s=function(){"fullscreen"!==D&&r.requestView({type:D})};v=function(e){r.fullscreen&&t.publish({event:"3DPLAY/PLAYFROMCOMPASS/DISABLE",data:{}})},S=function(e){r.fullscreen&&setTimeout(function(){t.publish({event:"3DPLAY/PLAYFROMCOMPASS/ENABLE",data:{}})},500)};r.addEvent("onHide",v),r.addEvent("onShow",S),r.onViewChange=function(s){"maximized"===s.type||"fullscreen"===s.type?t.publish({event:"3DPLAY/FULLSCREEN/ENABLE",data:{}}):"windowed"!==s.type&&"minimized"!==s.type||t.publish({event:"3DPLAY/FULLSCREEN/DISABLE",data:{}}),"fullscreen"!==s.type&&n.classList.contains("active")&&(e.classList.remove("PlayWeb-FullScreen"),n.removeClassName("active"),"fullscreen"!==D&&r.requestView({type:D}),i.onDeactivate&&i.onDeactivate())}}t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/BEGIN"},function(){n.getParent().setStyle("top",n.getParent().offsetTop+50+"px")}),t.subscribe({event:"3DPLAY/2D/TEXT_SEARCH/END"},function(){n.getParent().setStyle("top",n.getParent().offsetTop-50+"px")}),this.getMode=function(){return a},this.toggle=function(){e.classList.contains("PlayWeb-FullScreen")?(s(),n.removeClassName("active"),i&&i.onDeactivate&&i.onDeactivate(),e.classList.remove("PlayWeb-FullScreen")):(o(),e.classList.add("PlayWeb-FullScreen"),i&&i.onActivate&&i.onActivate(),n.addClassName("active"))}}})}),define("DS/3DPlayUtils/UIManager",["UWA/Class","DS/WebUtils/EventDisposer"],function(e,t){"use strict";return e.extend({init:function(e){this.ActionBarEventArray=new Array,this.ResizeEventArray=new Array,this.PanelEventArray=new Array,this.registerEvents(e)},registerEvents:function(e){var i=e.frameWindow,n=e.ctx,r=this,s=i.getActionBar();s&&(s.onActionBarClose(function(e){if(r&&r.ActionBarEventArray)for(var t=0,i=r.ActionBarEventArray.length;t<i;t++){r.ActionBarEventArray[t].addClassName("wux-ui-state-close")}}),s.onActionBarOpen(function(e){if(r&&r.ActionBarEventArray)for(var t=0,i=r.ActionBarEventArray.length;t<i;t++){var n=r.ActionBarEventArray[t];n.removeClassName("wux-ui-state-close"),"none"===n.style.display&&(n.style.display="block")}}));var o=function(e,t){if(r&&r.PanelEventArray)for(var i=0,n=r.PanelEventArray.length;i<n;i++){var s=r.PanelEventArray[i];if("object"==typeof s&&s.customCB){var o=UWA.extend({},e);o.visible=t,s.customCB(o)}else s.style.display=1==t?"none":""}};this.EventDisposer=new t,i&&i.experience?(this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/OPEN",function(e){o(e,!0)})),this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/CLOSE",function(e){o(e,!0)})),this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/SHOW",function(e){o(e,!0)})),this.EventDisposer.add(i.experience.subscribe("3DPLAY/RIGHTPANEL/HIDE",function(e){o(e,!1)}))):(this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/OPEN"},function(e){o(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/CLOSE"},function(e){o(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/SHOW"},function(e){o(e,!0)}),WUX.Events),this.EventDisposer.add(WUX.Events.subscribe({event:"/"+n+"3DPLAY/RIGHTPANEL/HIDE"},function(e){o(e,!1)}),WUX.Events))},dispose:function(){this.ActionBarEventArray=null,this.ResizeEventArray=null,this.PanelEventArray=null,this.EventDisposer.dispose(),this.EventDisposer=null},addToActionBarEvent:function(e){e.addClassName("wux-afr-actionbar"),this.ActionBarEventArray.push(e)},addToResizeEvent:function(e){this.ResizeEventArray.push(e)},addToPanelEvent:function(e,t){var i=void 0!==t?{div:e,customCB:t}:e;this.PanelEventArray.push(i)}})}),define("DS/3DPlayUtils/VisibilityUtils",["DS/WebSystem/Settings","DS/CoreEvents/Events"],function(e,t){"use strict";return{applyVisibilityToAll:function(e,t,i){if(t)for(var n=0;n<t.length;n++)this.applyVisibilityToPath(e,t[n],i)},reallyApplyVisibilityToAll:function(e,t,i){if(t){Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){var r=t[n].getChildrenPathes();0!=r.length?this.reallyApplyVisibilityToAll(e,r,i):this.applyVisibilityToPath(e,t[0],i)}}},showAll:function(e){var t,i=this.getCurrentSceneGraphState(e),n=this.getCurrentSceneGraphIsolateState(e),r=function(e){var t,i=e.getNodes();return i.forEach(function(e){"RootBag"===e.name&&(t=e)}),t||(t=i[0]),t}(e);t=i.getOverridesFromPathElement(r),i.deleteOverrides(t);var s,o=n.getRootsAndConcatinatedPaths(r);s=o.concatinated,n.deleteOverrides(s);var a=o.mainroot;a&&n.deleteOverride(a),0===e.getVisibleSpace()&&e.swapVisibleSpace()},applyVisibilityToPath:function(e,t,i,n){null==n&&(n=!0),e.setVisibility(t,i,n)},getTransparencyPercentage:function(){var t=Math.round(e.get("VisibilitySettings.TransparencySetting",11));return(t<0||t>100)&&(t=11),t},setTransparencyPercentage:function(t){t>=0&&t<=100?e.set("VisibilitySettings.TransparencySetting",t):console.error("Error: Visibility Utilities - Transparency settings value out of range")},updateTransparencyofObjects:function(e,t,i){if(1==i)this.removeTransparencyFromObjects(e,t);else{var n=function(t){t.length>0&&t.forEach(function(t){var r=e.getOpacity(t);if(null!=r&&r<1)e.setOpacity(t,i);else{var s=t.getChildrenOccurrencePathes();null!=s&&null!=s&&n(s)}})};n(t)}},removeTransparencyFromObjects:function(e,t){for(var i=0;i<t.length;i++){var n=t[i];e.setOpacity(n,1,!0),e.setPickability(n,"PICKABLE",!0)}},applyTransparencyToObjects:function(e,t,i,n,r){if(1==i)this.removeTransparencyFromObjects(e,t);else{null==r&&(r=!0);for(var s=0;s<t.length;s++)e.setOpacity(t[s],i,r),1!=n&&e.setPickability(t[s],"IGNORED",r)}},getCurrentSceneGraphState:function(e,t,i){return e.sgState||(e.sgState=this.createNewSceneGraphStateHelper(e,t,"VisibilitySG")),e.sgState},getCurrentSceneGraphIsolateState:function(e,t,i){return this.createNewSceneGraphStateHelper(e,t,"VisibilitySG_Isolate")},createNewSceneGraphStateHelper:function(e,t,i){return e.createSceneGraph(i)},resetCurrentSceneGraphState:function(e){e.sgState=null},setCurrentSceneGraphState:function(e,t){e.sgState=t,e.setCurrentSceneGraphState(e.sgState)},setVisibilityOfAnnotations:function(e,t,i){(i||e.getRootNode()).children.forEach(function(e){"annotGroupNode"==e.name&&e.setVisibility(t)})},setVisibilityOfSectionsAndMeasures:function(e,i,n){n||e.getRootNode();i?t.publish({event:"3DPLAY/EXPLODE/END"}):t.publish({event:"3DPLAY/EXPLODE/START"})}}}),define("DS/3DPlayUtils/DFATools",[],function(){"use strict";return{getFormat:function(e){let t=e.mimetype||e.format;return e.DFA&&e.DFA.format&&(t=e.DFA.format),t},getTarget:function(e){if(e.DFA&&e.DFA.target)return e.DFA.target},getType:function(e){let t=e.type;return e.DFA&&e.DFA.target&&(t=e.DFA.target),t}}});var deps=[];"false"!==window.localStorage["3DPlay.pad3DViewer"]&&deps.push("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"),define("DS/3DPlayExperienceModule/SceneGraphNodeServices",deps,function(e){"use strict";return{is3DXMLNode:function(e){return e?e.productType||void 0!==e.persistentId:null},getName:function(e){return e?this.is3DXMLNode(e)?e.getName():e.title||e.name:null},getId:function(t){return t?(e&&(i=e.getNodeID(t)),i||(i=t.getId?t.getId():i),i||(i=t.persistentId),i):null;var i},getType:function(t){return t?(e&&(i=e.getNodeType(t)),i||(i=t.getType?t.getType():void 0),i||(i=t.productType||t.worktype||t.plmtype),i):null;var i},isReference:function(t){return t?t.productType?"Reference3D"===t.productType:t.worktype?"Reference3D"===t.worktype:t.plmtype?"Reference3D"===t.plmtype:e?e.isReference(t):null:null},isInstance:function(t){return t?t.productType?"Instance3D"===t.productType:t.worktype?"Instance3D"===t.worktype:t.plmtype?"Instance3D"===t.plmtype:e?e.isInstance(t):null:null},isRepReference:function(t){return t?t.productType?"ReferenceRep"===t.productType:t.worktype?"ReferenceRep"===t.worktype:t.plmtype?"ReferenceRep"===t.plmtype:e?e.isRepReference(t):null:null},isRepInstance:function(t){return t?t.productType?"InstanceRep"===t.productType:t.worktype?"InstanceRep"===t.worktype:t.plmtype?"InstanceRep"===t.plmtype:e?e.isRepInstance(t):null:null},is3DLeaf:function(t){return t?this.is3DXMLNode(t)?this.isRepReference(t):e?e.is3DLeaf(t):null:null},isPLMNode:function(t){if(!t)return null;if(this.is3DXMLNode(t)){var i=this.getType(t);return null!=i&&""!==i}return e?e.isPLMNode(t):null}}}),define("DS/3DPlayUtils/PublishToSwym",["DS/3DPlay/3DPlay","UWA/Class","DS/WebSystem/Environment","DS/WebSystem/Nls","i18n!DS/3DPlay/assets/nls/3DPlay"],function(e,t,i,n,r){"use strict";return t.extend({init:function(t){var n,s;require(["DS/UIKIT/Modal","DS/SwymPublishForm/script/publish-form-view","css!DS/3DPlayUtils/PublishToSwym"],function(o,a){var l=e.getExperience(t.ctx);l&&l.getScreenShot({onSuccess:function(e){if(i.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:i.get("ODT_3DPlay_PanelManager")})});else{var t=l.args.input.tenantID||l.args.input.asset.tenant;if(t)n=t;else try{for(var d=window;!d.ds&&d.parent&&d!==d.parent;)d=d.parent;(n=d.ds.swymTenant)&&(s=!0)}catch(e){}p={title:"title",description:"description",mode:"base64",base64image:e,onCancel:h=function(){u&&u.destroy(),c&&c.destroy()},onContentCreated:h},n&&(p.platformId=n),s&&(p.forcePlatform=!0),u=new a(p),(c=new o({closable:!0,header:r.ShareSwymTitle,body:u.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),c.show()}var c,u,h,p},onFail:function(){e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:r.UnableToCreateScreenshot})}})},function(i){if("scripterror"===i.requireType){var n=i.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",n)}else console.error(i);e.sendEvent(t.ctx,eventType.notif,notification.error,{msg:r.ScripNotFoundError})})}})}),define("DS/3DPlayExperienceModule/Tracker_Translation_Experience",[],function(){"use strict";return{experience:{Connector_Require:2,Connector_Finished:3,Experience_Require:4,Viewer_init:5,ActionBar_Ready:6,Experience_Ready:7,WaitAllCommands:8,CSV_Tenant_Init:10},asset:{Connector_Require:2,Connector_Finished:3,Wait_MaterialsCommands:4,XCAD_DownloadExternalDrive:5,XCAD_Authentication:6,XCAD_Preprocess:7,XCAD_Transfer:8,XCAD_Convert:9,Download:10,Load_Infra:11,Load_Session:12,nbMeshOccurrences:13,nbMeshes:14,nbNodeOccurrences:15,nbNodes:16,nbLines:17,nbPoints:18,nbTriangles:19,width:17,height:18,nbPages:19,DownloadSize:20},comment:{measure:2,clipping:3,annotations:4,scenario:5,pgpFromServer:6,cgrPolicy:7}}}),define("DS/3DPlayUtils/EventDisposer",["DS/WebUtils/EventDisposer"],function(e){"use strict";return console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),console.error("DS/3DPlayUtils/EventDisposer has been moved to DS/WebUtils/EventDisposer of FW WebInfra"),e}),define("DS/3DPlayUtils/LeftPanel",["UWA/Core","UWA/Class","DS/Panels/SidePanel","css!DS/3DPlayUtils/LeftPanel"],function(e,t,i,n){return t.extend({init:function(t){this.leftPanel=new i({side:"left"}).inject(t.container);for(var n=new e.Element("div",{id:"MAIN_CONTAINER",styles:{height:this.leftPanel.elements.panel.clientHeight+"px","overflow-y":"scroll"}}).inject(this.leftPanel),r=new e.Element("div",{id:"SHEET_LIST_CONTAINER"}).inject(n),s=[],o=function(e){for(var t=0;t<s.length;t++){var i=s[t];i.className.indexOf("selected")>0&&i.removeClassName("selected")}(e.target?e.target:e.srcElement).addClassName("selected")},a=0;a<t.items.length;a++){var l=t.items[a],d="Sheet_"+(a+1),c=new e.Element("div",{id:d,class:"leftpanel-item",events:{click:l.onClickCB}}).inject(r);c.addEvent("click",o),c.appendText(d),s.push(c)}},dispose:function(){}})}),define("DS/3DPlayUtils/SpreadGesture",["DS/Visualization/ThreeJS_DS","DS/VisuEvents/ScreenEvent","DS/Gestures/BasicGesture"],function(e,t,i){"use strict";var n=i.extend({init:function(){return this._parent("Spread"),this.touches=[],this.fingersVector0_1=new e.Vector2,this.fingersVector1_2=new e.Vector2,this.fingersVector2_0=new e.Vector2,this.latencyTime=30,this.initTime=0,this.distance=null,this.lastDistance=0,this.initDistance=0,this.distanceMin=0,this},detect:function(e){switch(this.touches=THREEDS.VisuEventsManager.getTouchEventsByStates([t.State.BEGIN,t.State.MOVE,t.State.IDLE],this.view),3===this.touches.length&&(this.fingersVector0_1.subVectors(this.touches[1].currentPosition,this.touches[0].currentPosition),this.fingersVector1_2.subVectors(this.touches[2].currentPosition,this.touches[1].currentPosition),this.fingersVector2_0.subVectors(this.touches[0].currentPosition,this.touches[2].currentPosition),null===this.distance&&(this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.lastDistance=this.distance,this.distance=this.fingersVector0_1.length()+this.fingersVector1_2.length()+this.fingersVector2_0.length()),this.state){case i.State.INIT:this.distance=null,3===this.touches.length&&(this.preventDefault(this.touches),this.initTime=(new Date).getTime(),this.initDistance=this.distance,this.changeState(i.State.BEGIN));break;case i.State.BEGIN:case i.State.CHANGE:3===this.touches.length?(this.events=this.touches,this.preventDefault(this.events),this.changeState(i.State.CHANGE)):this.changeState(i.State.KO);break;case i.State.KO:case i.State.OK:case i.State.CANCEL:this.changeState(i.State.INIT),this.touches=[],this.distance=null}},preventDefault:function(e){for(var t=0;t<e.length;t++){var i=e[t].getJSEvent();i.preventDefault&&i.preventDefault()}}});return UWA.namespace("3DPlayModelViewer/SpreadGesture",n)}),define("DS/3DPlayUtils/BrowserSupportList",[],function(){"use strict";return{winphone:{8.1:{ie:{isSupported:function(e){return BrowserSupport.ok}}}},win:{default:{version:{isSupported:function(e){try{var t=parseFloat(e);return 7===t||8===t||t>=10}catch(e){return!1}}},chrome:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},opera:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}},ie:{isSupported:function(e){return BrowserSupport.ok}}}},android:{default:{version:{isSupported:function(e){return parseFloat(e)>=5}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return BrowserSupport.ok}}},4:{chrome:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}},firefox:{isSupported:function(e){return e<25?BrowserSupport.partial:BrowserSupport.ok}}}},macosx:{default:{version:{isSupported:function(e){try{return parseFloat(e)>=10.1}catch(e){return!1}}},safari:{isSupported:function(e){return BrowserSupport.ok}},chrome:{isSupported:function(e){return BrowserSupport.ok}},firefox:{isSupported:function(e){return e<18?BrowserSupport.partial:BrowserSupport.ok}}},10.9:{safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}}}},ios:{default:{version:{isSupported:function(e){return e<8?BrowserSupport.partial:BrowserSupport.ok}},safari:{isSupported:function(e){return e<600?BrowserSupport.partial:BrowserSupport.ok}},netscape:{isSupported:function(e){return BrowserSupport.ok}}}}}}),define("DS/WebRunloop/Runloop",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.name=e.name||"Runloop",this.running=!1,this.data=e.data,this.setRunloopCB(e.func),this.onStart=e.onStart,this.onStop=e.onStop,this.onError=e.onError,e.autoStart&&this.start()},setRunloopCB:function(e){if(e){this.func=e;var t=this,i=(new Date).getTime();this.data?this.runloop=function(){t.running&&(t.id=requestAnimationFrame(t.runloop));var e=(new Date).getTime();t.func.apply(t.data,[{time:e-t.starttime,deltaTime:e-i}]),i=e}:this.runloop=function(){t.running&&(t.id=requestAnimationFrame(t.runloop));var e=(new Date).getTime();t.func({time:e-t.starttime,deltaTime:e-i}),i=e}}},start:function(){this.runloop?(this.running=!0,this.id=requestAnimationFrame(this.runloop),this.starttime=(new Date).getTime(),this.onStart&&this.onStart()):(console.error("runloop have not loop function"),this.onError&&this.onError())},stop:function(){this.running=!1,cancelAnimationFrame(this.id),this.onStop&&this.onStop()},dispose:function(){!0===this.running&&this.stop(),this.func=null,this.data=null,this.runloop=null}})}),define("DS/3DPlayUtils/ServiceURL",["UWA/Core","DS/WebUtils/WebServices"],function(e,t){"use strict";return console.error("DS/3DPlayUtils/ServiceURL has been moved to (DS/WebUtils/WebServices).getServiceURL"),t.getServiceUrl}),define("DS/WebViewer2D/ViewerError",["UWA/Core","DS/WebViewer2D/ViewerDoc"],function(e,t){"use strict";return t.extend({init:function(t){this.viewer=t.viewer,this.status={failed:!0,loaded:!1};var i=(t.asset.filename||t.asset).split("/"),n=i[i.length-1];this.container=new e.Element("div",{data:t.data,class:"viewer"}).inject(this.viewer),this.getErrorID=function(){return" error LoadFailed"},this.getTitle=function(){return n}}})});var t=["DS/TagNavigatorProxy/TagNavigatorProxy"];define("DS/3DPlayUtils/PanelManager",["DS/3DPlay/3DPlay","UWA/Core","UWA/Class","UWA/Controls/TabView","DS/TopBarProxy/TopBarProxy","DS/WebSystem/Environment","DS/3DPlayUtils/UIManager","DS/UIKIT/Spinner","DS/WebSystem/DataUrlTools","DS/WebSystem/DetectBrowser","DS/3DPlayUtils/PublishToSwym","DS/WebSystem/Nls","DS/3DPlayUtils/FullScreen","DS/WebUtils/ContextedSingleton","DS/WebSystem/Settings","DS/Utilities/Css","DS/WebSystem/App","DS/WebUtils/Tracker","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebSystem/SessionManager"].concat(t),function(e,t,i,n,r,s,o,a,l,d,c,u,h,p,g,f,m,v,S,D,w){"use strict";return i.extend({init:function(e){this.showVersion=!0,this.UIManager=new o(e);var t=new Date;this.lastClickTime=t.getTime(),this.panelContent={},this.panelContent.wait=this._generateWaitingUI(),this.experience=e.frameWindow.experience},getSession:function(){return D.getSession()},setTopBarId:function(e){if(void 0===this.generated){if(this.generated=!0,e.topBarId&&(e.topBar={id:e.topBarId},console.error("API Migration : please don t use options.topBarId"),console.error("API Migration : use instead options.topBar.id")),!s.isSet("3DPlay.DisableTagger")&&m.is3DPlay()){var i=window.widget&&window.widget.id;i&&(this.tagger={proxyOptions:{filteringMode:"WithFilteringServices",widgetId:i,pod:"6WTags"},TagNavigatorProxy:w,experience:this.experience,dispose:function(){this.tagger&&this.tagger.die(),this.tagger=null,this.token&&this.experience.unsubscribe(this.token),this.token=null},activate:function(e){this.tagger&&(void 0===e||!0===e?this.tagger.activate():this.tagger.deactivate())},proxyTag:function(){this.tagger||(this.tagger=this.TagNavigatorProxy.createProxy(this.proxyOptions),this.tagger.addEvent("onFilterSubjectsChange",function(e){e&&(e.filteredSubjectList&&e.filteredSubjectList[0]&&"3DPlayAsset"===e.filteredSubjectList[0]?this.experience.isLoadingFinished()||this.experience.load(this.experience.args.input):(this.experience.modelLoadComplete=void 0,this.experience.clearView()),this.experience.getInformationsOnAsset()&&v.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type))}.bind(this))),this.token?console.error("not supposed to be here"):this.token=this.experience.addOnLoadingStartedCB(function(e){if(this.experience.args&&this.experience.args.input){var i=this.experience.args.input.asset;if(i&&"FILE"===(this.experience.currentProvider||i.provider)){if(this.currentTag=[],i.swymAttr&&i.swymAttr.tags6w_implicit&&i.swymAttr.tags6w_implicit.length>0){var n=this.currentTag;i.swymAttr.tags6w_implicit.forEach(function(e){n.push({object:e.type,sixw:e.predicate,dispValue:e.tag})})}else if(i.driveAttr){i.driveAttr.fullnameowner&&this.currentTag.push({object:i.driveAttr.fullnameowner,sixw:"ds6w:who/ds6w:responsible",dispValue:i.driveAttr.fullnameowner}),i.driveAttr.originator&&this.currentTag.push({object:i.driveAttr.originator,sixw:"ds6w:who/ds6w:responsible/ds6w:originator",dispValue:i.driveAttr.originator}),i.driveAttr.modified&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*i.driveAttr.modified),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:modified",type:"date"}),i.driveAttr.created&&this.currentTag.push({object:t.Date.strftime(new Date(1e3*i.driveAttr.created),"%Y/%m/%d"),sixw:"ds6w:when/ds6w:created",type:"date"}),i.driveAttr.type&&this.currentTag.push({object:i.driveAttr.type,sixw:"ds6w:what/ds6w:type",dispValue:i.driveAttr.type});var r=i.driveAttr.fileExtension||i.driveAttr.extension;r&&("string"==typeof r||r instanceof String)&&(r={catanalysis:"CATAnalysis",catdrawing:"CATDrawing",catmaterial:"CATMaterial",catpart:"CATPart",catprocess:"CATProcess",catproduct:"CATProduct",catshape:"CATShape",catsystem:"CATSystem"}[r.toLowerCase()]||r.toUpperCase(),this.currentTag.push({object:r,sixw:"ds6w:what/ds6w:docExtension",dispValue:r})),i.driveAttr.dataSource&&this.currentTag.push({object:i.driveAttr.dataSource,sixw:"ds6w:where/ds6w:source/ds6w:dataSource",dispValue:dataSource})}this.tagger.setSubjectsTags({"3DPlayAsset":this.currentTag||[]})}}else console.log((new Error).stack)}.bind(this)),this.tagger.setSubjectsTags({"3DPlayAsset":[]})}})}if(r){var n={};if(e.topBar&&e.topBar.id?n=e.topBar:window.widget&&window.widget.id&&(n.id=window.widget.id),n.id){for(var o=window;!o._swymData43DPlay&&o.parent&&o!==o.parent;)o=o.parent;if(o._swymData43DPlay)try{n.options={rightParentWindow:o.parent}}catch(e){}this.topBarProxy=new r(n),!1!==e.activeState&&"false"!==e.activeState||this.topBarProxy.deactivate()}}}},setVisibility:function(e){this.isTopBarAvailable()?this.topBarProxy&&(!1===e?this.topBarProxy.deactivate():this.topBarProxy.activate()):this.topMenuContainer&&(this.topMenuContainer.style.display=e?"":"none")},dispose:function(){this.UIManager&&(this.UIManager.dispose(),this.UIManager=null),this.panel=null,this.currentPanel=null,this.panelContainer=null,this.topMenuContainer=null,this.experience=null,this.panelClose=null,this.isTopBarAvailable()&&(this.topBarProxy.die(),this.topBarProxy=null),this.tagger&&(this.tagger.dispose(),this.tagger.experience=null,this.tagger=null)},isTopBarAvailable:function(){return void 0!==this.topBarProxy},createTopMenu:function(e){var i=e.container,n=this;if(this.experience=e.experience,this.ctx=e.ctx,this.panel=new t.Element("div",{attributes:{id:"PlayWeb-Panel",class:"SHAREPluginless_noSelect"}}),this.panelClose=new t.Element("span",{class:"CloseBtn"}).addEvent("click",function(){n.panelContainer.style.display="none"}).addEvent("touchstart",function(){n.panelContainer.style.display="none"}),new t.Element("span",{class:"fonticon fonticon-cancel"}).inject(n.panelClose),new t.Element("span",{class:"fonticon fonticon-cancel-circled"}).inject(n.panelClose),this.panel.appendChild(n.panelClose),this.panelContainer=f.verticalAlign(this.panel),this.panelContainer.id="PlayWeb-Panel-CSSV",this.panelContainer.setStyles({position:"absolute","text-align":"center","pointer-events":"none",display:"none","z-index":"10",top:"0px"}),this.panelContainer.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.panelContainer.inject(i),this.isTopBarAvailable()){var r=!1,o=!1;require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){e.getPlatformServices({onComplete:function(e){for(var t=0;t<e.length&&(e[t]["3DSwym"]&&""!==e[t]["3DSwym"]&&(o=!0),!0!==o);t++);r=!0},onFailure:function(){console.error(S.PlatformNotFound),r=!0}})},function(e){if("scripterror"===e.requireType){var t=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",t)}else console.error(e);console.error(S.ScripNotFoundError),r=!0});var a=0,l=setInterval(function(){11!==++a&&!0!==r||(clearInterval(l),l=void 0,r=!1,(!0===o||s.isSet("ODT_3DPlay_PanelManager"))&&(o=!1),s.isSet("3DPlay.Statistics")&&n.topBarProxy&&n.topBarProxy.setContent({share:[{label:"Dump PCS",submenu:[{label:"All times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("Full")}},{label:"3DPlay Times",onExecute:function(){require("DS/WebUtils/ProbesManager").dump("3DPlay",!0)}}]}]}))},100)}else if(!0===e.showBubbleMenu||s.isSet("3DPlay.ShowBubbleMenu")){this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container);var d=new t.Element("span",{id:"PlayWeb-Save-Annotations",class:"PlayWeb-button",events:{click:function(){if(g.get("3DPlay.PersistedAnnotationsEnabled")){var e=p.get(n.ctx,"ANNOTATION_MANAGER");if(e){var t=e.saveAnnotationsToJSON();g.set("3DPlay.AnnotJson",t),alert("Annotations saved !!!")}}}}}).inject(this.topMenuContainer),c=new t.Element("span",{id:"PlayWeb-Create-Saved-Annotations",class:"PlayWeb-button"}).inject(this.topMenuContainer),u=g.get("3DPlay.AnnotJson");u?c.addEvent("click",function(){g.get("3DPlay.PersistedAnnotationsEnabled")&&require("DS/3DPlayAnnotationUtils/AnnotationManagerUtils",function(e){e.getAnnotationManager(n.ctx).drawAnnotationsFromJSON(u)})}):c.style.display="none",this.panelContent.publish=this._generatePublishUI();var m=new t.Element("span",{id:"PlayWeb-Publish",class:"PlayWeb-button"}).inject(this.topMenuContainer);m.addEvent("click",function(){n._togglePanel(n.panelContent.publish)}),m.addEvent("touchend",function(){n._togglePanel(n.panelContent.publish)}),this.helpBtn=new t.Element("span",{id:"PlayWeb-Help",class:"PlayWeb-button"}).inject(this.topMenuContainer),m.setAttribute("title",S.Publish_Title),n.helpBtn.setAttribute("title",S.Help_Title),d.setAttribute("title",S.SaveAnnotation_Title),c.setAttribute("title",S.CreateSavedAnnotation_Title),this.openHelpPanel=function(e){void 0!==e&&n.Tab.selectTab(e),n._togglePanel(n.panelContent.help)},this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")})}var v=this.experience&&this.experience.args?this.experience.args:{};if(v.commandFullscreen||v.options.fullscreen){var D=new t.Element("span",{id:"PlayWeb-Fullscreen",class:"PlayWeb-button"}),w=new h(v.container,v.options.fullscreen,D,v.widget||window.widget);"none"!==w.getMode()&&(this.topMenuContainer||(this.topMenuContainer=new t.Element("div",{id:"PlayWeb-TopMenu",class:"SHAREPluginless_noSelect"}).inject(e.container),this.UIManager&&this.UIManager.addToPanelEvent(this.topMenuContainer,function(e){this.topMenuContainer&&(e.visible?this.topMenuContainer.style.right="35px":this.topMenuContainer.style.right="0px")})),D.inject(this.topMenuContainer),D.addEvent("click",function(){w.toggle(D)}),v.options&&v.options.fullscreen&&v.options.fullscreen.activateOnStart&&D.click())}},_togglePanel:function(e){e!==this.currentPanel?(this.currentPanel&&this.panel.removeChild(this.currentPanel),this.panel.appendChild(e),this.currentPanel=e,this.panelContainer.style.display="table",this.currentPanel===this.panelContent.wait?this.panelClose.style.display="none":this.panelClose.style.display=""):"none"===this.panelContainer.style.display?this.panelContainer.style.display="table":this.panelContainer.style.display="none"},_generatePublishUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"}),i=this,n=function(){setTimeout(function(){i._printScreenshot()},100)};new t.Element("li",{id:"Print_Menu_Item",html:S.Publish_Print,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",n).addEvent("touchstart",n);var r=function(){setTimeout(function(){i._saveScreenshot()},100)};return new t.Element("li",{id:"Save_Menu_Item",html:S.Publish_Save,class:"PlayWeb-MenuItem"}).inject(e).addEvent("click",r).addEvent("touchstart",r),e},_generateWaitingUI:function(){var e=new t.Element("ul",{class:"PlayWeb-Menu"});return new a({className:"large",visible:"true"}).inject(e),e.appendChild(document.createElement("br")),new t.Element("span",{html:S.GeneratingScreenshot}).inject(e),e},createDefaultHelp:function(){var e=[];if(!0===this.experience.args.touch){e.push({id:"Menu_Touch",event:"touchend",array:[["icTouchPan","HelpTouchPan"],["icTouchZoom","HelpTouchZoom"],["icTouchRotate","HelpTouchRotate"],["icTouchReframe","HelpTouchReframe"]]})}e.push({id:"Menu_Mouse",event:"click",array:[["icMouseLeft","HelpRotateBtn"],["icMouseMiddle","HelpZoomBtn"],["icMouseRight","HelpZoomAltBtn"],["icMouseMiddle","HelpDragBtn"]]}),this.setHelpContent(e)},setHelpContent:function(e){this.panelContent.help=this._generateHelphUI(e)},_generateHelphUI:function(e){var i=this,r=[],s=[],o=[];this.maxHeight=0;for(var a=e,l=0;l<a.length;l++)o[l]=a[l].id;this.showVersion&&o.push("Menu_About");for(var d=new t.Element("div"),c=function(e){return function(){var t=new Date;i.currentClickTime=t.getTime(),i.currentClickTime-i.lastClickTime>500&&(i.openHelpPanel(e),i.lastClickTime=i.currentClickTime)}},u=!1,h=!1,p=0;p<o.length;p++)if(p<a.length){var g=a[p].event;if(void 0!==g){"click"===g?u=!0:"touchend"===g&&(h=!0);var f=o[p];i.helpBtn&&i.helpBtn.addEvent(g,c(f))}r.push(new n.Tab({id:o[p],text:S[o[p]]})),s.push(document.createElement("table")),i._fillPanel(d,s[p],a[p].array)}else"Menu_About"===o[p]&&(i.helpBtn&&(!1===u?i.helpBtn.addEvent("click",c("Menu_About")):!1===h&&i.helpBtn.addEvent("touchend",c("Menu_About"))),r.push(new n.Tab({id:o[p],text:S[o[p]]})),s.push(document.createElement("table")),i._fillVersionPanel(s[p]));i.Tab=new n({className:"help",tabs:r,events:{onSelectTab:function(){}}}).inject(d);for(var m=0;m<r.length;m++)r[m].setContent(s[m]);return d},_fillPanel:function(e,t,i){this.maxHeight<i.length&&(this.maxHeight=i.length),e.setStyles({height:66*this.maxHeight+60+"px"});for(var n=[],r=0;r<i.length;r++)n[r]=i[r][1];for(var s=0;s<i.length;s++){var o=document.createElement("tr"),a=document.createElement("td");a.setAttribute("class","ic "+i[s][0]);var l=document.createElement("td");l.appendChild(document.createTextNode(S[n[s]])),l.setAttribute("class","desc"),o.appendChild(a),o.appendChild(l),t.appendChild(o)}},_fillVersionPanel:function(e){var i=document.createElement("tr"),n=document.createElement("td");n.setAttribute("class","logoDS");var r=document.createElement("td");r.appendChild(document.createTextNode(S.Menu_AppName)),r.appendChild(document.createElement("br")),r.appendChild(document.createElement("br"));var s=new t.Element("div",{styles:{"pointer-events":"all"}}).inject(r);new t.Element("a",{html:S.Menu_Documentation,href:"http://www.3ds.com/support/3dplay-app/",target:"_blank",styles:{"pointer-events":"all",color:"#456077"}}).inject(s),r.setAttribute("style","font-size: initial;vertical-align: middle;"),i.appendChild(n),i.appendChild(r),e.appendChild(i),this.maxHeight>0&&(e.style.minHeight=66*this.maxHeight+"px")},_publishToSwYm:function(){this._pictureFlash();var e={ctx:this.ctx};setTimeout(function(){new c(e)},1e3)},_printScreenshotAfterFlash:function(){var e=this,i=new t.Element("iframe",{styles:{position:"fixed",top:"0",left:"100%",width:"100%",height:"100%"}}).inject(document.body);d&&"firefox"===d().browser.name?i.onload=function(){e._printScreenshotAfterFrameLoaded(i)}:e._printScreenshotAfterFrameLoaded(i)},_printScreenshotAfterFrameLoaded:function(i){var n,r=this;if(d&&"ie"===d().browser.name&&void 0!==r.experience.frmWindow._3dViewer&&null!==r.experience.frmWindow._3dViewer&&void 0!==r.experience.frmWindow._3dViewer.getCurrentSheet&&null!==r.experience.frmWindow.getCurrentSheet&&(n=r.experience.frmWindow._3dViewer.getCurrentSheet()),n&&void 0!==n.svg&&null!==n.svg){if(void 0!==n.getSVGCloneNode&&null!==n.getSVGCloneNode){var o=n.getSVGCloneNode();i.contentWindow.document.body.appendChild(o);try{!1===i.contentWindow.document.execCommand("print",!1,null)&&i.contentWindow.print()}catch(e){i.contentWindow.print()}o=null,setTimeout(function(){document.body.removeChild(i),i=null},6e4)}}else r.experience.getScreenShot({onSuccess:function(e){var n,r=new t.Element("img",{src:e,styles:{"max-width":"100%","max-height":"100%"}}).inject(i.contentWindow.document.body);n=setInterval(function(){if(r.offsetHeight||r.height){if(clearInterval(n),s.isSet("ODT_3DPlay_PanelManager"))require(["DS/CoreEvents/Events"],function(e){e.publish({event:s.get("ODT_3DPlay_PanelManager")})});else try{!1===i.contentWindow.document.execCommand("print",!1,null)&&i.contentWindow.print()}catch(e){i.contentWindow.print()}setTimeout(function(){document.body.removeChild(i),i=null},6e4)}},100)},onFail:function(){e.sendEvent(r.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}});n=null},_printScreenshot:function(){var e=this;this._pictureFlash(function(){e._printScreenshotAfterFlash(),e=void 0})},_saveScreenshotAfterFlash:function(){var i=this;this.experience.getScreenShot({onSuccess:function(e){if(void 0!==window.Windows&&void 0!==window.Windows.Security&&void 0!==window.Windows.Storage){var i=e.replace("data:image/png;base64,",""),n=Windows.Security.Cryptography.CryptographicBuffer.decodeFromBase64String(i),r=new Windows.Storage.Pickers.FileSavePicker;r.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,r.fileTypeChoices.insert("Picture",[".png"]),r.suggestedFileName="myScreenshot",r.pickSaveFileAsync().then(function(e){if(e)return Windows.Storage.FileIO.writeBufferAsync(e,n)})}else if("download"in document.createElement("a")){var o,a;g.get("3DPlay.PersistedAnnotationsEnabled")?(o=e,a="3DPlay_Screenshot.svg"):(o=l.toBlob(e),a="3DPlay_Screenshot.png");var d=new t.Element("a",{href:o,download:a,styles:{visibility:"hidden"}}).inject(document.body);s.isSet("ODT_3DPlay_PanelManager")?require(["DS/CoreEvents/Events"],function(e){e.publish({event:s.get("ODT_3DPlay_PanelManager")})}):d.click(),document.body.removeChild(d)}else{window.open("about:blank","3DPlay web","width=1024,height=860").document.body.innerHTML='<img style="max-width:100%;max-height:100%" src="'+e+'" />'}},onFail:function(){e.sendEvent(i.ctx,eventType.notif,notification.error,{msg:S.UnableToCreateScreenshot})}})},_saveScreenshot:function(){var e=this;this._pictureFlash(function(){e._saveScreenshotAfterFlash(),e=void 0})},_pictureFlash:function(e){this.panelContainer.style.display="none";var i=this.experience.frmWindow.getViewerFrame(),n=this.experience.frmWindow.getUIFrame(),r=new t.Element("div",{id:"_3DPlay-Flash",styles:{position:"absolute",top:0,left:0,width:i.clientWidth+"px",height:i.clientHeight+"px","background-color":"white"}}).inject(n),s=1,o=function(){s-=.02,r.setStyle("opacity",s),s<0?(n.removeChild(r),"function"==typeof e&&e()):requestAnimationFrame(o)};o()},_shareTo3DComment:function(){var e=this.experience;this._pictureFlash(function(){var t=function(e,t){var i=new Blob([t],{type:"application/json"});e.getScreenShot({width:240,height:180,type:"jpeg",onSuccess:function(t){var n={screenshot:t,annotation:i};e.onAnnotationShared?(console.log("Social: onAnnotationShared found"),e.onAnnotationShared(n)):(console.log("3DPlay: Launching 3DPlay's social panel"),e.publish("3DPLAY/EXP/3DPLAY3DCOMMENT",{data:n})),e=null}})},i=e.frmWindow.getViewer(),n=i&&i.getCurrentState?i.getCurrentState():void 0;if(n){var r=p.get(e.ctx,"ANNOTATION_MANAGER");t(e,r.saveAnnotationsToJSON(null,n))}else e.updateSession().then(function(){t(e,JSON.stringify(D.getSession()))})})},_downloadSourceDocument:function(){!!(this.experience&&this.experience.args&&this.experience.args.input&&this.experience.args.input.asset&&"FILE"===this.experience.args.input.asset.provider&&"pdf"===this.experience.args.input.asset.type)&&window.open(this.experience.args.input.asset.filename,"_blank")}})}),define("DS/3DPlayUtils/XCADSpatialSupport",["DS/3DPlaySupport/XCADSpatialSupportedFormats","UWA/Core","DS/3DPlayUtils/ConvertService","DS/WebSystem/Environment","DS/WebInfraUI/Notification","DS/WebUtils/Logger","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/WebUtils/ProbesManager","DS/WebSystem/Nls","DS/WebSystem/App","DS/WAFData/WAFData","i18n!DS/3DPlay/assets/nls/3DPlay","DS/3DPlaySupport/OfficeFiles"],function(e,t,i,n,r,s,o,a,l,d,c,u,h,p){"use strict";var g,f,m,v={},S={};return i.extend({init:function(i){this._parent(),this.logger=s("3DPlay.XCADSpatialSupport","3DPlay.Log.Convert"),this._exp=i,this.connector3DSpace=null,this._counter=0,this.supportedFormats=e,i.extendedXCADSupport&&t.extend(this.supportedFormats,i.extendedXCADSupport,!0),this._convert=function(e){this._computeInfos(e),c.isOnCloud()||e.asset&&e.asset.filename&&e.asset.filename.includes&&e.asset.filename.includes("3DPlayExperiencesTest")||e.asset&&e.asset.serverurl&&e.asset.serverurl.includes&&e.asset.serverurl.includes("3DPlayExperiencesTest")?this._isOffice(e)?this._isSourceSourcing(e)||this._isSource3DSocialMedia(e)||this._isSource3DDrive(e)||this._isSource3DSpace(e)?this._convertDFA(e):this._displayFatal(e):this._isSource3DDrive(e)?"EXTERNAL"==e.computedInfos.provider.toUpperCase()||e.asset.user&&"guest"==e.asset.user||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest")||e.asset.serverurl&&e.asset.serverurl.includes("3DPlayExperiencesTest")?this._convertCO(e):this._convertDFA(e):this._isSource3DSpace(e)?this._isAssembly(e)?this._displayUnsupported(e):"ODT_Tenant"===e.asset.tenant||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest")?this._convertCO(e):this._convertDFA(e):this._convertCO(e):this._displayFatal(e)},this._computeInfos=function(e){e.computedInfos=e.asset,e.asset&&e.asset.originalAsset?(e.computedInfos=e.asset.originalAsset,e.asset.DFA&&(e.computedInfos.provider=e.asset.DFA.provider,e.asset.DFA.realType&&(e.computedInfos.type=e.asset.DFA.realType),e.computedInfos.physicalid=e.asset.DFA.physicalid)):this._isSource3DDrive(e)?e.computedInfos={type:e.asset.format,provider:e.asset._3DPlayDatas&&!0===e.asset._3DPlayDatas.externalDrive?"EXTERNAL":"3DDRIVE",physicalid:e.asset.physicalid}:("ODT_Tenant"===e.asset.tenant||e.asset.filename&&e.asset.filename.includes("3DPlayExperiencesTest"))&&(window.isCloud=!0,e.computedInfos.provider||(e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&"prt"==e.asset.type&&(this.connector3DSpace={open:function(e,t){t({url:"test_url"})}}),e.computedInfos.provider="EV6"))},this._isAssembly=function(e){return"asm"===e.asset.dataFormat},this._isSourceSourcing=function(e){return e&&e.computedInfos&&e.computedInfos.provider&&"SOURCING"===e.computedInfos.provider.toUpperCase()},this._isSource3DSocialMedia=function(e){return e&&e.computedInfos&&e.computedInfos.provider&&"SOCIALMEDIA"===e.computedInfos.provider.toUpperCase()},this._isSource3DDrive=function(e){return c.is3DDrive()||e&&e.computedInfos&&e.computedInfos.provider&&"3DDRIVE"===e.computedInfos.provider.toUpperCase()},this._isSource3DSpace=function(e){return"EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider.toUpperCase()},this._isOffice=function(e){var t=e.asset.DFA?e.asset.DFA.format:e.asset.type;return p.indexOf(t.toUpperCase())>=0},this._displayFatal=function(e){this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:r.fatal},e.asset)},this._displayUnsupported=function(e){this.logger.error("Unsupported format"),this.logger.error(arguments),e.onConvertError({nls:"LoadingError_FORMAT",level:r.fatal},e.asset)},this._convertDFA=function(e){var t=this,i=e.asset,n=function(){t.profilerLocateOpen=l.createProbe("XCAD_Preprocess"),t.profilerLocateOpen.begin(),t._startLocate(e,!0),t=null,i=null};S[i.tenant]?n():o.getServiceUrl({serviceName:"derivedformataccess",logger:t.logger,platformId:i.tenant,onSuccess:function(e){S[i.tenant]=e.url,e.platformId!==i.tenant&&t.logger.warn("DerivedFileAccess desired Tenant:",i.tenant,"got ",e.platformId),t.logger.log("DerivedFileAccess : URL found > ",S[i.tenant]),n()},onError:function(i){t.logger.error("Ooops, missing Service : ",i.serviceName,"Reason : ",i.error),t._displayFatal(e),t=null}})},this._convertCO=function(e){if(c.isOnCloud()&&this._isOffice(e))return this.logger.error("Conversion error"),this.logger.error(arguments),void e.onConvertError({nls:"LoadingError_FORMAT",level:"fatal"},t);if(g){var t=e.asset;if(!v[t.tenant]){if(!n.isSet("3DPlay.ProtoConvertSpatial")||"true"===n.get("3DPlay.ProtoConvertSpatial")){var i=this;return void o.getServiceUrl({serviceName:"SPAContentOptimizer",logger:i.logger,platformId:t.tenant,onSuccess:function(n){v[t.tenant]||(v[t.tenant]=d(n.url)),n.platformId!==t.tenant&&i.logger.warn("XCADSpatialSupport desired Tenant:",t.tenant,"got ",n.platformId),i.logger.log("XCADSpatialSupport : URL found > ",v[t.tenant]),i._startConvert(e),i=null},onError:function(n){i.logger.error("Ooops, missing Service : ",n.serviceName,"Reason : ",n.error);var s={nls:"Convert_SERVICE_NOT_FOUND",level:r.warning,abort:!0};e.onConvertError(s,t),i=null}})}v[t.tenant]=n.get("3DPlay.ProtoConvertSpatial"),this.logger.log("XCADSpatialSupport (using envar value) : URL found > ",v[t.tenant])}this._startConvert(e)}else{var s=this;require(["DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/COptConvertOption","DS/SPAContentOptimizer/coptConvertV1"],function(t,i,n){g=t,f=i,m=n,s._convert(e),s=null})}};var d=function(e){var i=t.Utils.parseUrl(e);return i.authority+i.directoryPath};this._startLocate=function(e,i){var r=this,s=e.asset;this.located=!1,this.logger.log("XCADSpatialSupport._startLocate");var o=e.computedInfos.contextid?e.computedInfos.contextid:e.computedInfos.contextId?e.computedInfos.contextId:"preferred";n.get("PreferredCredentials")&&(o=n.get("PreferredCredentials"));var a="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==e.computedInfos.provider.toUpperCase()&&"3DSPACE"!==e.computedInfos.provider.toUpperCase()||(a+="&SecurityContext="+encodeURIComponent(o)),"asm"===s.dataFormat&&(s.dataFormat="3dxml");var d=S[s.tenant]+a,c={specificationFilter:[{format:s.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===e.computedInfos.provider.toUpperCase()?"3DSpace":e.computedInfos.provider,id:e.computedInfos.physicalid,type:e.computedInfos.type}]};!0===i&&(c.specificationFilter[0].notifyIfMissing=!0),0==r._counter&&l.begin("XCAD_Convert"),u.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:o},type:"json",data:JSON.stringify(c),onComplete:function(i){if(console.log("onComplete locate"),i.derivedOutputs&&i.derivedOutputs[0]&&i.derivedOutputs[0].derivedOutputFormats&&i.derivedOutputs[0].derivedOutputFormats[0]&&i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){r._counter=0;var o=S[s.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+i.derivedOutputs[0].id+"/DerivedOutputFiles/"+i.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";l.end("XCAD_Convert");var a=i;u.authenticatedRequest(o,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(i){console.log("onComplete download ticket");var l=i.data[0].dataelements,d=l.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(l.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",c=t.clone(s);e.onConvertSuccess(t.extend(c,{provider:"FILE",filename:d,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:s.type,mimetype:s.dataFormat||s.mimetype,format:s.dataFormat||s.mimetype,type:s.dataFormat||s.mimetype})),console.log("Loading from DFA : "+d),r.profilerLocateOpen.end(),n.isSet("3DPlay.downloadConvertResult")&&u.authenticatedRequest(o,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete second download ticket for debug");var t=e.data[0].dataelements,i=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",n=document.createElement("a");n.download="DFA_Download_File."+s.dataFormat||s.mimetype,n.innerHTML="Download File",n.href=i,n.onclick=function(e){document.body.removeChild(e.target)},n.style.display="none",document.body.appendChild(n),n.click()}}),r._handleCR(a,s)},onFailure:function(e){console.log("onFailure download ticket"),r.profilerLocateOpen.end()}})}else if(i.derivedOutputs&&i.derivedOutputs[0]&&i.derivedOutputs[0].derivedOutputFormats&&i.derivedOutputs[0].derivedOutputFormats[0]&&i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"KO"===i.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status)r._handleCR(i,s);else if(!r._stop){r._counter>210&&(r._stop=!0);var d=r._counter++<10?1e3:3e3;console.log(" restart locate in "+d+" ms"),setTimeout(r._startLocate.bind(r,e,!1),d)}},onFailure:function(t){console.log("onFailure locate"),r._counter=0,r._displayFatal(e),r.profilerLocateOpen.end(),r.profilerLocateOpen=null}})},this._handleCR=function(e,t){var i=this,n=S[t.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+e.derivedOutputs[0].id+"/DerivedOutputFiles/"+e.derivedOutputs[0].derivedOutputFormats[0].id+"/ConversionReport/"+e.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.id+"/DownloadTicket";u.authenticatedRequest(n,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){console.log("onComplete report download ticket");var t=e.data[0].dataelements,n=t.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(t.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true";u.authenticatedRequest(n,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(e){if(console.log("onComplete report download"),1==e.reportFileVersion)e.warnings&&e.warnings.length>0&&(e.warnings[0].includes("Error : The input file is saved in Civil3D. Output might be incomplete.")?SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_Civil3D_Warning}):e.warnings[0].includes("Alert ! Text layout could look different as some fonts are not present on the system !")&&SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.info,{msg:h.Convert_MissingFonts_Warning}));else if(2==e.reportFileVersion){for(var t=0;t<e.warnings.length;t++)"PartialResult"==e.warnings[t].category&&("IncompleteResultFromCivil3D"==e.warnings[t].id?SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_Civil3D_Warning}):"CroppedPageForXLS"==e.warnings[t].id?SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_CroppedPageForXLS_Warning}):"ConversionWithMissingFonts"==e.warnings[t].id&&SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.info,{msg:h.Convert_MissingFonts_Warning}));for(t=0;t<e.errors.length;t++)"UnsupportedInput"==e.errors[t].category&&("UnsupportedFileVersion"==e.errors[t].id?SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.fatal,{msg:h.Convert_NOTSUPPORTED_SOLIDWORKS}):"UnsupportedParasolidBareBinary"==e.errors[t].id&&SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.fatal,{msg:h.Convert_NOTSUPPORTED_BIN})),e._doFallback=!1;for(t=0;t<e.warnings.length;t++)if("MissingInput"==e.warnings[t].category&&"MissingInputFiles"==e.warnings[t].id){for(var n="",r=0;r<e.warnings[t].parameters.length;r++)n+=e.warnings[t].parameters[r];SHARE.Core.sendEvent(i._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_MISSING_FILES+" "+n})}}},onFailure:function(e){console.log("onFailure report download")}})},onFailure:function(e){console.log("onFailure report download ticket")}})};var D="Not initialized";this._startConvert=function(e){var t=this;this.connected=!1,this.logger.log("XCADSpatialSupport._startConvert");var i={onHypervisorDisconnect:function(){t.logger.log("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t.connected?t.connected=!1:(t.logger.error("Unable to connect"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},e.asset))},onHypervisorConnect:function(){t.connected=!0,t.logger.log("CSIServer Connected")},onDisconnect:function(){t.logger.log("CSIServer Node Disconnected")},authentication:function(e,i,n){t.logger.log("CSIServer authentication");var r=encodeURIComponent(D).replace(/'/g,"%27").replace(/"/g,"%22");a.authenticatedRequest(e.passportURL+"/login?service="+r,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{t.logger.log("CSIServer authentication onComplete");var r=JSON.parse(e).access_token;i(D,r)}catch(i){n("Failed to parse ticket"),t.logger.error("Failed to parse ticket : "+e)}},onFailure:function(e,i){n("Failed to retrieve ticket"),t.logger.log("CSIServer authentication onFailure"),t.logger.error("Failed to retrieve ticket: "+i)}},"XCAD_Authentication")}},n=v[e.asset.tenant];""===n||void 0===n?(i.hypervisorIp=void 0,i.webSocketPort=void 0,this.logger.log("Trying to Connect via IP> "+void 0),D="https://"+i.hypervisorIp+":"+i.hypervisorPort):(i.hypervisorUrl=n,i.ssl=!0,this.logger.log("Trying to Connect via hypervisorUrl : "+n),D="https://"+i.hypervisorUrl);var r=g.getPool("application.webWidget").createNode(i);"prt"===e.asset.type?this._execOpenCmd(e,r):this._execConvertCmd(e,r)}},_execOpenCmd:function(e,t,i){i=t.select("ContentOptimizer"),this.logger.log("_execOpenCmd");var n,r=this,s=e.asset,o=function(){e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},s)};(n=l.createProbe("XCAD_Preprocess")).begin();var a=new g.Parameters;a.writeString("inputFileName",s.filename||"DummyName."+(s.format||s.mimetype)),a.writeString("inputFileUrl",s.url),t.call({destinationNodeId:i,name:"coptOpen",version:1,parameters:a,onSuccess:function(a){r.logger.log("answerOpenResultCB._execOpenCmd"),n.end(),n=null,setTimeout(function(){var n;if(n=a.readUint8("DocumentType"),(2===n||3===n)&&"prt"===s.type)o();else if(e.asset&&e.computedInfos&&e.computedInfos.provider&&("EV6"===e.computedInfos.provider.toUpperCase()||"3DSPACE"===e.computedInfos.provider)){var d=l.createProbe("3DSpaceDocumentConnector");d.begin();var c=function(n){d&&(d.end(),d=null),e.asset.url=n.url,r._execConvertCmd(e,t,i)};r.connector3DSpace?r.connector3DSpace.open(e.computedInfos,c,o):(r.connector3DSpace="DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector",require([r.connector3DSpace],function(t){r.connector3DSpace=new t,r.connector3DSpace.open(e.computedInfos,c,o)},o))}else r._execConvertCmd(e,t,i)},1)}.bind(this),onError:o.bind(this)})},_execConvertCmd:function(e,i,s){this.logger.log("_execConvertCmd");var o=e.asset,d=function(s){var a,d=new m(i);d.onResultFile=function(i,r){if(this.logger.log("launchConvert.onResultFile",i),l.end("Download"),l.end("_execConvertCmd"),!0!==i||(this._exp.loadingAsset.size=r.byteLength,!r))return this.onErrorsVisited||(this.logger.error("Conversion error"),this.logger.error(arguments),e.onConvertError({nls:"Convert_ERROR",level:"fatal"},o)),this.cleanNode(d),!0;var s=new Blob([r]);n.isSet("3DPlay.downloadConvertResult")&&require(["DS/WebSystem/Downloader"],function(e){e("XCAD-Converted-File."+o.dataFormat,s)});var a=t.clone(o);e.onConvertSuccess(t.extend(a,{provider:"FILE",filename:window.URL.createObjectURL(s),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype}))}.bind(this),d.onErrors=function(t){var i;this.logger.error("Conversion error",t);try{i=JSON.parse(t)}catch(e){i=void 0}if(i&&i.errorCode>=500)return this.onErrorsVisited=!0,void("The connection with the server node has been closed before any success or error answer"===i.error&&e.onConvertError({nls:"Convert_ERROR",level:"fatal"},o));if(t&&t[0]&&t[0].split("\n")){var n=t[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===n[2]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_SOLIDWORKS",level:r.fatal},o),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===n[1]?(e.onConvertError({nls:"Convert_NOTSUPPORTED_BIN",level:r.fatal},o),this.onErrorsVisited=!0):"Translation failed for unknown error."===n[0]?(e.onConvertError({nls:"Convert_ERROR",level:r.fatal},o),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===n[0]?SHARE.Core.sendEvent(this._exp.args.ctx,eventType.notif,notification.warning,{msg:h.Convert_Civil3D_Warning}):(e.onConvertError({nls:"Convert_ERROR",level:r.fatal},o),t[1]&&console.log("Error : "+t[1]),this.onErrorsVisited=!0)}}.bind(this),d.onMissingFiles=function(t){if(this.logger.error("Missing Files domain"),t&&("sldasm"!==o.type||"sldasm"!==o.format||"sldasm"!==o.mimetype)){this.logger.error(t);for(var i=0;i<t.length;i++){var n=t[i],s=Math.max(n.lastIndexOf("/"),n.lastIndexOf("\\"));-1!==s&&(n=n.substring(s+1,s.length));var a={nls:"Convert_MISSING_FILES",level:r.error,text:" "+n};this._exp&&this._exp.onModelLoadingError&&this._exp.onModelLoadingError(a)}e.onConvertError&&e.onConvertError({nls:"Convert_MISSING_FILES"})}return this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,100),this.cleanNode(d),!0}.bind(this),d.onProgress=function(e){this.logger.log("launchConvert.onProgress",e),e<.01?(l.end("XCAD_Transfer"),l.begin("XCAD_Convert")):e>.99&&(l.end("XCAD_Convert"),l.begin("Download")),this._exp&&this._exp.getPhaseProgress()&&this.subProgressID&&e&&this._exp.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e/1*100)}.bind(this),e.ConversionOpts&&(a=new f,Object.keys(e.ConversionOpts).forEach(function(t){void 0!==e.ConversionOpts[t]&&a["Set"+t](e.ConversionOpts[t])})),l.begin("_execConvertCmd"),l.begin("XCAD_Transfer");var c=o.url,u=o.filename;(!c||e.asset._3DPlayDatas&&e.asset._3DPlayDatas.externalDrive&&!0===e.asset._3DPlayDatas.externalDrive)&&(c=u,u="");var p=u||"DummyName."+(o.format||o.mimetype);"asm"===o.dataFormat&&(o.dataFormat="3dxml"),s?(this.logger.log("_execConvertCmd.convert",p,s,o.dataFormat,a),d.convert(p,s,o.dataFormat,a)):(this.logger.log("_execConvertCmd.convertUrl",p,c,o.dataFormat,a),d.convertUrl(p,c,o.dataFormat,a))};if(o._3DPlayDatas&&o._3DPlayDatas.externalDrive){if("asm"===o.dataFormat)return void e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},o);var c=o.requestsOptions||{};c.type="arraybuffer",c.timeout=5e4,l.begin("XCAD_DownloadExternalDrive");var u=this;c.onComplete=function(e){l.end("XCAD_DownloadExternalDrive");var t=new Uint8Array(e);d.apply(u,[t]),u=null},c.onFailure=c.onTimeout=function(t){l.end("XCAD_DownloadExternalDrive"),e.onConvertError({nls:"Convert_FILE_NOT_LOADED"},o),u=null},a.handleRequest(o.filename,c)}else d.apply(this)},cleanNode:function(e){setTimeout(function(){e._node.stop(),e=null},1e3)},dispose:function(){this._exp=null,this._stop=!0,this._counter=0}})}),define("DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin",["DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/3DPlayUtils/VisibilityUtils","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/3DPlaySupport/SupportList","DS/3DPlayExperienceModule/SceneGraphNodeServices"],function(e,t,i,n,r,s,o,a){"use strict";var l=["InstanceRep","ReferenceRep"],d=function(e,t){-1==l.indexOf(e)&&o.CROSSHIGHLIGHT.resolveParenting({type:e,physicalid:t},function(t){void 0!==t&&(o.CROSSHIGHLIGHT[t]=1)?o.CROSSHIGHLIGHT[e]=1:o.CROSSHIGHLIGHT[e]=0})},c=function(t){var i=t.getNodes(),n=[];return i.forEach(function(t){var i=new e;i.addElement(t),n.push(i)}),n},u=function(e,t){var i,n=c(t),r=e.split("/"),s=function(e,t){e.length>0&&e.forEach(function(e){var n,r=e.getLastElement();if(void 0!==r.getPersistentId)"Instance3D"!=r.productType&&1!=r.getPersistentId()||(n=r.getPersistentId())==t[0]&&(t.splice(0,1),i=e);else{var l=a.getType(r);null!=l&&(null==o.CROSSHIGHLIGHT[l]&&d(l,a.getId(r)),1==o.CROSSHIGHLIGHT[l]&&(n=a.getId(r))),null!=n&&n==t[0]&&(t.splice(0,1),i=e)}var c=e.getChildrenOccurrencePathes();null!=c&&t.length>0&&s(c,t)})};return s(n,r),i},h=function(e){for(var t=e.pathElement,i="";null!=t;){var n=t.getLastElement(!0);if(void 0!==n.getPersistentId)"Instance3D"!=n.productType&&1!=n.getPersistentId()||(0!==i.length&&(i="/"+i),i=n.getPersistentId()+i);else{var r,s=a.getType(n);null!=s&&(null==o.CROSSHIGHLIGHT[s]&&d(s,a.getId(n)),1==o.CROSSHIGHLIGHT[s]&&(r=a.getId(n))),null!=r&&(0!==i.length&&(i="/"+i),i=r+i)}t=t.getParentOccurrencePath()}return i};return function(e,l){var p=[];l.addScriptingFunction("subscribeCommandEvent",function(e){var t=WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+l.ctx+"/"+e.name+"/"+e.cmd.toUpperCase()},function(){e.cb(e.name+"/"+e.cmd.toUpperCase())});return p.push(t),t}),l.addScriptingFunction("unsubscribeCommandEvent",function(e){var t=p.indexOf(e);return t>-1&&(p.splice(t,1),WUX.Events.unsubscribe(e),!0)}),l.disposeFunctions.add(function(){p.forEach(e=>{WUX.Events.unsubscribe(e)}),p=[]}),l.createPathFromId=function(){console.error("Empty Function")},l.addScriptingFunction("createPathFromId",u.bind(e),"",[e,l]),l.createIdFromPath=function(){console.error("Empty Function")},l.addScriptingFunction("createIdFromPath",h.bind(e),"",[e,l]),l.filterFEM=function(){console.error("Empty Function")},l.addScriptingFunction("filterFEM",function(e){var t=this,i=this.instance.frmWindow.getViewer(),n=c(i),r=function(i){i.length>0&&i.forEach(function(i){var n,s,o=i.getLastElement();a.getId(o)==e&&null!=(n=a.getType(o))&&-1!==n.indexOf("FEM")&&t.hideNode({pathElement:i}),null!=(s=i.getChildrenOccurrencePathes())?r(s):console.log("FINISHED FEM FILTERING")})};r(n)}.bind(e),"",[e,l]),l.addScriptingFunction("checkCustomType",d.bind(e),"",e);l.addScriptingFunction("initCustomTypes",function(){var e=this.instance.frmWindow.getViewer(),t=c(e),i=function(e){e.length>0&&e.forEach(function(e){var t,n,r=e.getLastElement();void 0!==(t=a.getType(r))&&null==o.CROSSHIGHLIGHT[t]&&d(t,a.getId(r)),null!=(n=e.getChildrenOccurrencePathes())?i(n):console.log("FINISHED CUSTOM TYPES PARSING")})};i(t)}.bind(e),"",e);var g;l.addScriptingFunction("getSceneContent",function(e){var t=this.instance.frmWindow.getViewer(),i=c(t),n=[],r=function(t,i,n){t.length>0&&t.forEach(function(t){var s,l,c,u,h,p=t.getLastElement();s=a.getId(p),l=a.getName(p),null!=(c=a.getType(p))?(null==o.CROSSHIGHLIGHT[c]&&d(c,s),1==o.CROSSHIGHLIGHT[c]&&(u={name:l,id:s=i+s,type:c},n.push(u))):s=i,null!=(h=t.getChildrenOccurrencePathes())?r(h,s?s+"/":s,u&&e?u.children=[]:n):u&&(u.id=u.slice(0,-1))})};return r(i,"",n),n}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("get3DPlayInstanceId",function(){return null==g&&(g=Date.now()+Math.random()),g}.bind(e),"",e);l.addScriptingFunction("set3DPlayInstanceId",function(e){g=e}.bind(e),"",e);l.addScriptingFunction("selectNode",function(e,n){if(this._check()){var s,o=this.instance.frmWindow.getViewer(),a=[],l=[];Array.isArray(e)?l=e:l.push(e),n&&n.highlightColor&&((s={color:new r.Color(0),outlineColor:new r.Color(0),intensity:n.highlightColor.intensity}).color.set(n.highlightColor.color),s.outlineColor.set(n.highlightColor.outlineColor),o.createHighlightSet(s,!0)),l.forEach(function(e){a.push({pathElement:u(e,o),parameters:{highlightColor:s}})}),t.add(a),i.add(a)}this.instance.frmWindow.getViewer().render()}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("unselectNode",function(e,n){if(this._check()){var r=t.get(),s=[];r.forEach(function(e){s.push(h(e))});var o=[];Array.isArray(e)?o=e:o.push(e);var a=[];o.forEach(function(e){for(var t=0;t<s.length;t++)s[t].indexOf(e)>-1&&a.push(r[t])}),a.forEach(function(e){t.remove(e),i.remove(e)})}this.instance.frmWindow.getViewer().render()}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("selectAll",function(){if(this._check()){var e=this.getSceneContent(),n=[],r=this.instance.frmWindow.getViewer();e.forEach(function(e){n.push({pathElement:u(e.id,r)})}),t.add(n),i.add(n)}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("emptySelection",function(){this._check()&&(t.empty(),i.empty())}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("getCurrentSelection",function(){if(this._check()){var e=[];return t.get().forEach(function(t){e.push(h(t))}),e}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("addSelectionCB",function(e){void 0!==e&&(e.onAddToken=t.onAdd(function(t){Array.isArray(t)||(t=[t]);var i=[];t.forEach(function(e){i.push(h(e))}),e("ADD",i)}),e.onRemoveToken=t.onRemove(function(t){Array.isArray(t)||(t=[t]);var i=[];t.forEach(function(e){i.push(h(e))}),e("REMOVE",i)}))}.bind(e),"",e);l.addScriptingFunction("removeSelectionCB",function(e){void 0!==e&&(void 0!==e.onAddToken&&t.unsubscribe(e.onAddToken),void 0!==e.onRemoveToken&&t.unsubscribe(e.onRemoveToken))}.bind(e),"",e);l.addScriptingFunction("hideNode",function(e,t){if(this._check()){var i=this.instance.frmWindow.getViewer(),r=n.getCurrentSceneGraphState(i);Array.isArray(e)?e.forEach(function(e){null!=e.pathElement?n.reallyApplyVisibilityToAll(r,e.pathElement,0):n.reallyApplyVisibilityToAll(r,u(e,i),0)}):null!=e.pathElement?n.reallyApplyVisibilityToAll(r,e.pathElement,0):n.reallyApplyVisibilityToAll(r,u(e,i),0),this.instance.frmWindow.getViewer().render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("showNode",function(e,t){if(this._check()){var i=this.instance.frmWindow.getViewer(),r=n.getCurrentSceneGraphState(this.instance.frmWindow.getViewer());Array.isArray(e)?e.forEach(function(e){n.reallyApplyVisibilityToAll(r,u(e,i),1)}):n.reallyApplyVisibilityToAll(r,u(e,i),1),this.instance.frmWindow.getViewer().render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("hideAll",function(){if(this._check()){var e=this.instance.frmWindow.getViewer(),t=n.getCurrentSceneGraphState(e),i=c(e);n.reallyApplyVisibilityToAll(t,i,0),e.render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("showAll",function(){if(this._check()){var e=this.instance.frmWindow.getViewer();n.showAll(e),e.render()}}.bind(e),"",e,void 0,l.trackScriptingFunction);l.addScriptingFunction("getCurrentHiddenSet",function(){}.bind(e),"",e);l.addScriptingFunction("getCurrentShownSet",function(){}.bind(e),"",e);var f=[];l.addScriptingFunction("addHideShowCB",function(e){void 0!==e&&(f[WUX.Events.subscribe({event:"/"+l.ctx+"/3DPLAY/HIDE/"},function(t){0!=t.data.length&&e("HIDE",[h(t.data[0])])})]=e,f[WUX.Events.subscribe({event:"/"+l.ctx+"/3DPLAY/SHOW_ALL/"},function(t){e("SHOW_ALL")})]=e)}.bind(e),"",e);l.addScriptingFunction("removeHideShowCB",function(e){for(var t=f.indexOf(e);t>-1;)f[t]=void 0,WUX.Events.unsubscribe(t.toString()),t=f.indexOf(e)}.bind(e),"",e);var m=[];l.addScriptingFunction("addViewpointChangeCB",function(e){void 0!==e&&(m[WUX.Events.subscribe({event:"/VISU/"},function(t){if("@onViewpointChange"==t.eventType){var i={position:t.cameraEye.clone(),target:t.cameraTarget.clone(),upDirection:t.cameraUp.clone()};e(i)}})]=e)}.bind(e),"",[l,e],void 0,l.trackScriptingFunction);l.addScriptingFunction("removeViewpointChangeCB",function(e){for(var t=m.indexOf(e);t>-1;)WUX.Events.unsubscribe(t.toString()),m[t]=void 0,t=m.indexOf(e)}.bind(e),"",[l,e]);l.addScriptingFunction("getCurrentViewpoint",function(){var e=this.frmWindow.getViewer().currentViewpoint;return{position:e.getEyePosition().clone(),target:e.getTarget().clone(),upDirection:e.getUpDirection().clone()}}.bind(l),"",[l,e]);l.addScriptingFunction("setCurrentViewpoint",function(e){Array.isArray(e)&&(e=e[0]);var t=this.getCurrentViewpoint();t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.target.x=e.target.x,t.target.y=e.target.y,t.target.z=e.target.z,t.upDirection.x=e.upDirection.x,t.upDirection.y=e.upDirection.y,t.upDirection.z=e.upDirection.z;var i=this.frmWindow.getViewer(),n=i.currentViewpoint.camera.matrix.clone(),r=i.currentViewpoint.camera.quaternion.clone();n.lookAt(t.position,t.target,t.upDirection),r.setFromRotationMatrix(n);var s={position:t.position,orientation:r,distanceToTarget:t.target.distanceTo(t.position),duration:void 0!==t.duration?t.duration:1};i.currentViewpoint.getControl().moveTo(s)}.bind(l),"",[l,e]);l.addScriptingFunction("setVisuMode",function(e){var t=function(e,t){return s.getCommand(e,t)||s.getCommand(e)}(e,l.ctx);t&&t.beginExecute()}.bind(e),"",e,void 0,l.trackScriptingFunction);var v=[],S=["VisuNoShadingEdges","VisuShading","VisuShadingEdges","VisuShadingEdgesNoSmoothEdges","VisuShadingEdgesHiddenEdges","VisuShadingMaterial","VisuShadingMaterialEdges","VisuShadingIllustration","VisuOrthographicView","VisuPerspectiveView"];l.addScriptingFunction("addVisuModeCB",function(e){void 0!==e&&S.forEach(function(t){v[WUX.Events.subscribe({event:"/WUX/AFR/CMD/"+l.ctx+"/"+t+"/"},function(i){e("VISU_MODE",[t])})]=e})}.bind(e),"",e);l.addScriptingFunction("removeVisuModeCB",function(e){for(var t=v.indexOf(e);t>-1;)WUX.Events.unsubscribe(t.toString()),v[t]=void 0,t=v.indexOf(e)}.bind(e),"",e);l.addScriptingFunction("setNodeProperties",function(e,t){if(this._check()){var i=this.instance.frmWindow.getViewer();if(e){var r=n.getCurrentSceneGraphState(i);r&&(t.opacity&&r.setOpacity(e,t.opacity),t.color,t.position,void 0!==t.visibility&&t.visibility)}}}.bind(e),"",e,void 0,l.trackScriptingFunction)}}),define("DS/WebViewer2D/ViewerCanvas",["UWA/Core","DS/WebViewer2D/ViewerDoc","DS/UIKIT/Spinner","DS/CoreEvents/Events","DS/WebViewer2D/CanvasShapes","WebappsUtils/WebappsUtils"],function(e,t,i,n,r,s){"use strict";return t.extend({init:function(t){this._parent(t),this.thumbnail=t.thumbnail,this.title=t.title||t.defaultTitle,this.margin=t.margin||10,this.documentContainer=new e.Element("div",{styles:{position:"relative",display:"inline-block","vertical-align":"middle","background-color":"#ffffff","box-shadow":"darkgrey 2px 2px 10px 1px",overflow:"hidden",height:"calc(100% - 10px)","margin-top":"5px","margin-bottom":"5px"}}).inject(this.container),this.canvas=new e.Element("canvas",{id:"ViewerCanvas",styles:{"z-index":"2000","vertical-align":"top",display:"none",height:"100%"}});var i=document.createElement("div");i.setAttribute("class","PlayWeb-Splash"),this.splashImage=document.createElement("img"),this.baseUrl=s.getWebappsBaseUrl(),"/"!==this.baseUrl.charAt(this.baseUrl.length-1)&&(this.baseUrl+="/"),this.splashImage.setAttribute("src",this.baseUrl+"3DPlay2DExperience/assets/images/sheet_loading.gif"),this.splashImage.setAttribute("class","PlayWeb-SplashImage loading"),i.appendChild(this.splashImage);var n=this,r=function(e){"thumb"===e&&(n.splashImage.setAttribute("class","PlayWeb-SplashImage thumb"),n.thumbnail?(n.splashImage.src=n.thumbnail,n.thumbnailImg=new Image,n.thumbnailImg.src=n.thumbnail):e="loading"),"thumb"!==e&&("loading"===e?n.splashImage.src=n.baseUrl+"3DPlay2DExperience/assets/images/sheet_loading.gif":"failed"===e&&(n.splashImage.src=n.baseUrl+"3DPlay2DExperience/assets/images/sheet_failed.png"),n.canvas.width=n.realSizeWidth*n.scale,n.canvas.height=n.realSizeHeight*n.scale,n.canvas.setStyle("display",""),n.splashImage.setAttribute("class","PlayWeb-SplashImage ")),i.style.display=""};this.specialViews={hide:function(){i.style.display="none"},show:{loading:function(){r("loading")},failed:function(){r("failed")},thumbnail:function(){r("thumb")}}},this.documentContainer.appendChild(i),this.canvas.inject(this.documentContainer),this.shapeList={},this._isCentered=!1},updateView:function(e){this.asset=e.asset,this.status=e.status,this.title=e.title,this.shapeList=e.annotations||{},this.scale=e.scale,this.useLOD=e.useLOD,!1===this.status.loaded?(this.specialViews.show.loading(),e.doneCB&&e.doneCB(!0)):!0===this.status.failed?(this.specialViews.show.failed(),e.doneCB&&e.doneCB(!0)):this.scaleAndRender(e.doneCB)},_scaleAndRender:function(){return!1},scaleAndRender:function(e){var t=this;this._scaleAndRender({scale:this.scale||1,asset:this.asset,status:this.status,OnComplete:function(i){for(var n in!0!==i&&(t.canvas.setStyle("display",""),t.specialViews.hide()),t.shapeList)r.drawShape({shape:t.shapeList[n],canvas:t.canvas,scale:t.scale});t=void 0,e&&e()}})},setScale:function(e){if(e!==this.scale){this.scale=e;var t=function(){n.publish({event:"3DPlay.2D.Zoom.Completed",data:{scale:this.scale}})}.bind(this);this.scaleAndRender(t)}},getScale:function(){return this.scale},getScreenShot:function(e){var t,i,n,r,s,o,a,l,d=this.useLOD?this.thumbnailImg:this.canvas,c=(this.useLOD?this.splashImage:this.canvas).getBoundingClientRect(),u=c.top-e.viewerFrameBB.top,h=c.left-e.viewerFrameBB.left,p=c.right-e.viewerFrameBB.left,g=c.bottom-e.viewerFrameBB.top,f=e.containerBB.top-e.viewerFrameBB.top,m=e.containerBB.bottom-e.viewerFrameBB.top,v=e.containerBB.left-e.viewerFrameBB.left,S=e.containerBB.right-e.viewerFrameBB.left;g<=f||u>=m||h>=S||p<=v||(this.useLOD?(t=h>0?0:Math.abs(h)*(this.thumbnailImg.width/c.width),i=u>0?0:Math.abs(u)*(this.thumbnailImg.height/c.height),n=this.thumbnailImg.width-t,r=this.thumbnailImg.height-i,s=h>0?h:0,o=u>0?u:0,a=h>0?c.width:c.width+h,l=u>0?c.height:c.height+u):(h>v?(t=0,s=h):(t=Math.abs(h),s=0),u>f?(i=0,o=u):(i=Math.abs(u),o=0),a=n=h<e.containerBB.left?p>S?e.containerBB.width:c.width+h:p<S?c.width:S-h,l=r=u<f?g>m?e.containerBB.height:c.height+u:g<m?c.height:m-u),e.context.shadowColor="darkgrey",e.context.shadowOffsetX=2,e.context.shadowOffsetY=2,e.context.shadowBlur=10,e.context.fillRect(s,o,a,l),e.context.drawImage(d,t,i,n,r,s,o,a,l))},getAnnotationDiv:function(){return this.document},getContainer:function(){return this.container},getViewerPositionFromMouse:function(e){var t=this.documentContainer.getBoundingClientRect(),i=e.x-t.left,n=e.y-t.top;return i>0&&n>0&&i<this.currentWidth&&n<this.currentHeight&&{x:i/=this.scale,y:n/=this.scale}},getMousePositionFromViewer:function(e){var t=e.x*this.scale,i=e.y*this.scale;return t>0&&i>0&&t<this.currentWidth&&i<this.currentHeight&&{x:t+=this.currentPosH,y:i+=this.currentPosV}},getShapeList:function(){return this.shapeList},createShape:function(e){var t=r.createShape({shapeData:e.shapeData,scale:this.scale,settings:e.settings});return this.shapeList[""+t.id]=t,r.drawShape({shape:t,canvas:this.canvas,scale:this.scale})},getIntersectingShapes:function(e){var t=[];for(var i in this.shapeList){var n=r.isIntersectShape({shape:this.shapeList[i],startPoint:e.startPoint,endPoint:e.endPoint,shapeList:this.shapeList});n&&(t=t.concat(n))}return t},drawShape:function(e){for(var t=e.idList,i=0;i<t.length;++i)r.drawShape({shape:this.shapeList[""+t[i]],canvas:this.canvas,scale:this.scale,lowLightMode:e.lowLightMode})},destroyShape:function(e){for(var t=e.idList,i=0;i<t.length;++i)delete this.shapeList[""+t[i]]},dispose:function(){this._parent(),this.baseUrl=null,this.documentContainer=null,this.canvas=null},_setThumbnail:function(e){this._parent(e),this.useLOD&&this.specialViews.show.thumbnail()}})}),define("DS/WebViewer2D/ViewerSvg",["DS/WebViewer2D/ViewerDoc","DS/WebViewer2D/ViewerCanvas","DS/WebSystem/DetectBrowser","DS/CoreEvents/Events","DS/WebSystem/Environment","DS/WebSystem/Nls","WebappsUtils/WebappsUtils"],function(e,t,i,n,r,s,o){"use strict";return t.extend({init:function(e){this._parent(e),this.margin=e.margin||10,this._isLODActive=!1,this._nextRender=null,this._isRenderInProgress=!1},loadAsset:function(e){var t="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e.asset.asset)));this.asset=e.asset,this.status=e.status,this.useLOD=e.useLOD;var n=new Image;n.width=5*this.asset.width,n.height=5*this.asset.height;var r=this;n.onload=function(){r.asset.image=n,r._scaleAndRender({scale:1,isForThumb:!0,OnComplete:function(){e.doneCB&&("ie"===i().browser.name?e.doneCB(n,t):e.doneCB(n,r.canvas.toDataURL("image/png")))}})},n.onerror=function(){this.specialViews.show.error()}.bind(this),n.src=t},_scaleAndRender:function(e){if(void 0===this.asset||null===this.asset||null==this.asset.image||null==this.asset.image)return this._nextRender=null,this.specialViews.show.failed(),options.OnComplete(!0),!0;var t=this.asset.width*e.scale,i=this.asset.height*e.scale;if(this.useLOD&&!0!==e.isForThumb)this._nextRender=null,this.thumbnail?this.specialViews.show.thumbnail():this.specialViews.show.loading(),e.OnComplete&&e.OnComplete(!0);else if(this.canvas.width=t||this.container.offsetWidth,this.canvas.height=i||this.container.offsetHeight,!1===this._isRenderInProgress){this._isRenderInProgress=!0;var n=this.canvas.getContext("2d");this.asset.image?(!0===e.isForThumb&&(n.fillStyle="#FFFFFF",n.fillRect(0,0,t,i)),n.drawImage(this.asset.image,0,0,t,i)):console.error("No image: render skipped."),this._isRenderInProgress=!1,this._nextRender?(this._scaleAndRender(this._nextRender),this._nextRender=null):e.OnComplete&&e.OnComplete(!1)}else this._nextRender=e;return!0},dispose:function(){}})}),define("DS/3DPlayExperienceModule/3DPlayAbstractExperience",["UWA/Core","DS/WebSystem/Scripting","DS/3DPlay/3DPlay","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/UIManager","DS/WebSystem/Settings","DS/ApplicationFrame/CommandsManager","DS/WebInfraUI/Notification","DS/WebSystem/Environment","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/WebUtils/EventDisposer","DS/WebSystem/Nls","DS/WebUtils/FunctionDisposer","DS/3DPlayUtils/XCADSpatialSupport","DS/3DPlayConnectors/3DPlayInputPreProcessor","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/WebInfraUI/MobileActionBar","DS/WebUtils/PhaseProgress","DS/WebUtils/Tracker","DS/ENOXTriptych/js/ENOXTriptych","DS/WebSystem/App","i18n!DS/3DPlay/assets/nls/3DPlay","DS/3DPlayUtils/DFATools"],function(e,t,i,n,r,s,o,a,l,d,c,u,h,p,g,f,m,v,S,D,w,P,y,C,b,E){"use strict";return t.extend({name:"3DPlayAbstractExperience",getExperienceModule:function(){return this.args.input.experience.filename},init:function(e){this._parent(),this.widgetPreferences={},this.args=e,this._name=e.input.experience.filename||"Default",this.EventDisposer=new u,this.addOnPauseCB(this.onPause),this.addOnPlayCB(this.onPlay),this.addOnStopCB(this.onStop),this.addOnScenarioChangeCB(this.onScenarioChange),this.addOnLoadingFinishedCB(this.onLoadingFinished),this.disposeFunctions=new p,this.createScriptingAPI(),this.addScriptingInitCB(),this.xcadSupport=new g(this),this._isReady=!1,this._enableCMenu=!0,this.playerSplashScreen=void 0,this.showSplashBetweenLoad=!0,this.modelLoadComplete=!1,this.phaseProgress=new w({mode:this.args.input.mode}),this.isFromTransition=!1,window.widget&&(this.landingPage=widget.welcomeScreen);var t=this;this.progress={},this.progress.hide=function(){t.getPhaseProgress()&&t.getPhaseProgress().hideProgressBar()},this.progress.updateProgression=function(e){t.getPhaseProgress()&&(t.getPhaseProgress().setAbsoluteProgress(this.subProgressID,e),t.progress.state.value=e)},this.progress.visible=function(){t.getPhaseProgress()&&(t.getPhaseProgress().showProgressBar(),t.progress.state.visible=!0)},this.progress.state={visible:!1,value:0},this.progress.spinnerContainer={style:{overflow:""}}},acceptSwitch:function(){return!1},acceptRefresh:function(){var e=void 0===this.needToRefresh||this.needToRefresh;return this.needToRefresh=void 0,e},resetWidgetPreferences:function(){var e=window.widget;for(var t in e&&C.is3DPlay()&&e.setPreferences([]),this.widgetPreferences)this.widgetPreferences.hasOwnProperty(t)&&(this.widgetPreferences[t].update=null)},refreshFromPreferences:function(e){this.needToRefresh=e},addWidgetPreferences:function(){var e=window.widget,t=this.widgetPreferences;if(e){var i=this,n=function(n){var r=!1;e.addEvent("onUpdateValue",function(e){t[e]&&t[e].update&&t[e].update(this.getValue(e))&&(r=!0)}),e.addEvent("endEdit",function(e){e&&e.submitted&&i.refreshFromPreferences(r)})};for(var r in t)t.hasOwnProperty(r)&&(e.hasPreference(r)||e.addPreference(t[r]));e.addEvent("onEdit",n),this.EventDisposer.add(function(){var e=window.widget;e.removeEvent("onEdit",n),e.removeEvent("onUpdateValue",onUpdateValue),onUpdateValue=null,n=null,i=null})}},registerCollabAction:function(){},isLoadingFinished:function(){return this.modelLoadComplete},isLoadingFInished:function(){return console.error("Wrong function - case error, please use isLoadingFinished"),console.error("Wrong function - case error, please use isLoadingFinished"),this.isLoadingFinished()},createScriptingAPI:function(){var e=this.args.options.helper||m.get(this.args.ctx,"helper"),t=this;t.addScriptingFunction("registerAction",t.addScriptingFunction.bind(t),"",e),t.addScriptingFunction("performAction",t.executeScriptingFunction.bind(t),"",e),t.addScriptingFunction("getAvailableActions",t.getScriptingFunctions.bind(t),"",e),t.addScriptingFunction("isActionSupported",t.hasScriptingFunction.bind(t),"",e),t.addScriptingFunction("unregisterAction",t.removeScriptingFunction.bind(t),"",e),t.addScriptingFunction("unregisterAllActions",t.disposeAllScriptingFunctions.bind(t),"",e),t.addScriptingFunction("notifyAction",t.notifyScriptingFunction.bind(t),"",[e,t]),t.addScriptingFunction("subscribeAction",t.subscribeScriptingFunction.bind(t),"",e),t.addScriptingFunction("unsubscribeAction",t.unsubscribeScriptingFunction.bind(t),"",e),t.addScriptingFunction("subscribeAllActions",t.subscribeAllScriptingFunctions.bind(t),"",e),t.addScriptingFunction("unsubscribeAllActions",t.unsubscribeAllScriptingFunctions.bind(t),"",e);this.trackScriptingFunction=function(e){P.trackPageEvent("commands","scripting",e)},t.addScriptingFunction("getScreenshot",function(e){this._check()&&this.instance.getScreenShot(e)}.bind(e),"",e,void 0,this.trackScriptingFunction);t.addScriptingFunction("getCollabMode",function(){return t.collabMode}.bind(e),"",e);t.addScriptingFunction("setCollabMode",function(e){t.collabMode=e}.bind(e),"",e),this.trackScriptingFunction;var i=[],n=["selectNode","unselectNode","setCurrentViewpoint","hideNode","showNode","showAll","hideAll","setVisuMode"];t.addScriptingFunction("addCollabCB",function(e){void 0!==e&&(i.push(e),e.collabNotif=function(e,i){"ADD"===e?t.notifyScriptingFunction("selectNode",i):"REMOVE"===e?t.notifyScriptingFunction("unselectNode",i):"HIDE"===e?t.notifyScriptingFunction("hideNode",i):"SHOW_ALL"===e?t.notifyScriptingFunction("showAll"):"VISU_MODE"===e?t.notifyScriptingFunction("setVisuMode",i):void 0===i&&t.notifyScriptingFunction("setCurrentViewpoint",[e])},this.addSelectionCB&&this.addSelectionCB(e.collabNotif),this.addViewpointChangeCB&&this.addViewpointChangeCB(e.collabNotif),this.addHideShowCB&&this.addHideShowCB(e.collabNotif),this.addVisuModeCB&&this.addVisuModeCB(e.collabNotif),n.forEach(function(i){t.subscribeScriptingFunction(i,e)}))}.bind(e),"",e);t.addScriptingFunction("removeCollabCB",function(e){if(void 0!==e){for(var t=i.indexOf(e);t>-1;)i[t]=void 0,t=i.indexOf(e);removeSelectionCB(e.sCB),removeViewpointChangeCB(sCB),removeHideShowCB(e.collabNotif),removeVisuModeCB(e.collabNotif)}}.bind(e),"",e);t.addScriptingFunction("registerCollabAction",function(r,s){t.addScriptingFunction(r,s,"",[e,t]),n.push(r),i.forEach(function(e){t.subscribeScriptingFunction(r,e)})}.bind(t),"",[e,t]);t.addScriptingFunction("unRegisterCollabAction",function(e){if(void 0!==n)for(var r=n.indexOf(e);r>-1;)n[r]=void 0,r=n.indexOf(e);t.removeScriptingFunction(e),i.forEach(function(i){t.unSubscribeScriptingFunction(e,i)})}.bind(t),"",[e,t]),t.addScriptingFunction("initCustomTypes",function(){},"",e)},addScriptingInitCB:function(){var e=this.args.options.helper||m.get(this.args.ctx,"helper");e&&this.args.options.collabmode&&e.setCollabMode("true"===this.args.options.collabmode),this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},function(){e.initCustomTypes()}))},addOnLoadingFinishedCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({origin:this,event:"/"+this.args.ctx+"/ASSET/LOADINGFINISHED"},e))},onLoadingFinished:function(){},addOnLoadingStartedCB:function(e,t){return this.subscribe("ASSET/LOADINGSTARTED",e,t)},addOnPlayCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PLAY"},e))},onPlay:function(){},addOnPauseCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/PAUSED"},e))},onPause:function(){},addOnStopCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/EXPERIENCE/STOP"},e))},onStop:function(){},addOnScenarioChangeCB:function(e){this.EventDisposer.add(WUX.Events.subscribe({event:"/"+this.args.ctx+"/SCENARIO/CHANGE"},e))},onScenarioChange:function(){},onLightboxReady:function(){},dispose:function(e){if(l.isSet("3DPlay.Debug")&&console.log("3DPlay.Debug:3DPlayAbstractExperience.dispose",e),this.stop(),this.notifScreen&&(this.notifScreen.dispose&&this.notifScreen.dispose(),this.notifScreen=null),e=e||{},this.playerSplashScreen&&(this.playerSplashScreen=null),this.landingPage&&(this.landingPage=null),this.notifTimeoutID&&(clearTimeout(this.notifTimeoutID),this.notifTimeoutID=null),this.EventDisposer.dispose(),this.EventDisposer=null,this.resetWidgetPreferences(),this.disposeFunctions.dispose(),this.disposeFunctions=null,i.removeCallbacks(this.args.ctx),void 0===e.disposeFrameWindow||!0===e.disposeFrameWindow)void 0!==this.frmWindow&&null!==this.frmWindow&&(void 0!==this.frmWindow.dispose&&null!==this.frmWindow.dispose&&this.frmWindow.dispose(),this.frmWindow.experience=null,this.frmWindow=null);else{var t=this.args.ctx;o._commandsState[t]={lastCommand:[],currentCommand:null,defaultCommand:null},o.resetDefaultCommand(t),o._isCommandEnding=!1,o._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){if(o[e]){var i=o[e][t];i&&Object.keys(i).forEach(function(e){var t=i[e];t&&t._destroy&&t._destroy(),delete i[e]})}})}this.PanelManager&&(this.PanelManager.dispose(),this.PanelManager=null),this.UIManager&&(this.UIManager.dispose&&this.UIManager.dispose(),this.UIManager=null),this.phaseProgress&&(this.phaseProgress.dispose&&this.phaseProgress.dispose(),this.phaseProgress=null),this.xcadSupport&&(this.xcadSupport.dispose&&this.xcadSupport.dispose(),this.xcadSupport=null),this._parent(e),this.args=null,this.actionBarProfile&&(this.actionBarProfile.dispose&&this.actionBarProfile.dispose(),this.actionBarProfile=null),this.mainTrip&&this.mainTrip.remove(),this.triptych&&this.triptych.destroy(),this.mainTrip=null,this.triptych=null},informActiveState:function(e){this.PanelManager.setVisibility(e),e?v.publish({event:"3DPLAY/3DPLAYPREVIEW/ENABLE",data:{}}):v.publish({event:"3DPLAY/3DPLAYPREVIEW/DISABLE",data:{}})},play:function(){if(void 0===this.pausetime&&(this.pausetime=this.first),!0===this.paused||!0===this.stoped){var e=(new Date).getTime()-this.pausetime;this.first+=e,this.paused=this.stoped=!1,this.publish("EXPERIENCE/PLAY",{experience:this,ctx:this.args.ctx})}},pause:function(){!1===this.paused&&(this.pausetime=(new Date).getTime(),this.paused=!0,this.stoped=!1,this.publish("EXPERIENCE/PAUSED",{experience:this,ctx:this.args.ctx}))},stop:function(){this.stoped=!0,this.paused=!1,this.publish("EXPERIENCE/STOP",{experience:this,ctx:this.args.ctx})},_testBrowser:function(){return BrowserSupport.ok},testBrowser:function(){return BrowserSupport.ok},getScreenShot:function(e){},start:function(){this.playerSplashScreen&&this.playerSplashScreen.removeOnClick(),this.args.options.loading===loadingMode.preload?this.isLoaded?this.toggleSplash(!1):this.args.options.splashscreen&&this.args.options.splashscreen.waitloading?this.toggleSplash(!0):this.toggleSplash(!1):this.initExperience()},toggleSplash:function(e){this.landingPage&&e&&this.landingPage.hide(),this.playerSplashScreen&&(e?this.playerSplashScreen.show():this.playerSplashScreen.hide())},initExperience:function(){},fromTransition:function(){return this.isFromTransition},createUIComponents:function(e){var t=this;if(this.paused=!0,e.experience=this,this.UIManager=new r({frameWindow:e,ctx:this.args.ctx}),this.PanelManager=new n({frameWindow:e,ctx:this.args.ctx}),this.PanelManager.setTopBarId(this.args.options),C.is3DPlay()&&this.PanelManager.tagger&&this.PanelManager.tagger.proxyTag(),0==this.getIfToDealyMABCreation()){var i=e.getActionBar();i&&this.mabModel&&(i.MAB&&i.MAB.dispose(),this.tabletMabModel?i.MAB=new D({ctx:this.ctx,frameWnd:e,exp:this,actionBar:i,model:this.mabModel,modelTablet:this.tabletMabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&l.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}):i.MAB=new D({ctx:this.ctx,frameWnd:e,exp:this,actionBar:i,model:this.mabModel,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&l.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}))}t.disposeFunctions.add(function(){var e=t.frmWindow.getActionBar();e&&e.MAB&&(!0===e.MAB.state.visible&&e.MAB.hide(),e.MAB.dispose()),t=null}),void 0!==this.notifScreen&&null!==this.notifScreen||(this.notifMsg=d,this.notifScreen=c,c.elements&&c.elements.container.isInjected()||c.inject(e.getUIFrame()),this.args&&(this.args.commandFullscreen||this.args.options.fullscreen)?c.slide({top:60,right:0}):c.slide({top:0,right:0}),c.setNotificationManager(d)),this.manageWorkBenchs({createActionBar:void 0!==this.args.options.pad3DViewer,frameWindow:e,finishCallBack:function(){t.publish("EXPERIENCE/EXPERIENCEREADY",t)}}),this.notifScreen&&this.UIManager.addToPanelEvent(this.notifScreen,function(e){t.notifScreen.slide({top:60,right:0}),e.visible&&t.notifScreen.slide({top:60,right:e.size+10})})},getInformationsOnAsset:function(){var e=this.args.input&&this.args.input.asset;if(Array.isArray(e)&&(e=e[0]),!e)return e;var t=e.provider,i=e.type,n=e.physicalid||e.id,r=e.source,s=e.tenant,o=e.displayPreview;if(e.originalType&&(i=e.originalType),e.originalAsset&&(t=e.originalAsset.provider||t,i=i||e.originalAsset.format||e.originalAsset.dtype||e.originalAsset.type,n=e.originalAsset.physicalid||n,r=r||e.originalAsset.source,s=s||e.originalAsset.tenant,o=o||e.originalAsset.displayPreview),e.localFile&&(r=s="Desktop"),"FILE"===t&&(C.is3DDrive()?t="3DDRIVE":C.is3DSwym()&&(t="3DSWYM")),"xmlv43"===i&&(i="3DXML"),"EV6"===t)t="3DSpace";else if("3DSWYM"===t&&!n&&e.originalAsset&&null==(n=e.originalAsset.objectId)&&e.filename){var a=e.filename;if(a.search("/id/")>=0){var l=a.search("/id/");l+=4,l=(a=a.slice(l)).search("/"),n=a.slice(0,l)}e.swymAttr&&(n=e.swymAttr.id)}return{id:n,provider:t,type:i,source:r,tenant:s,swymAttr:e.swymAttr,swymServerToken:e.swymServerToken,driveAttr:e.driveAttr,fileAttr:e.localFile,displayPreview:o}},getIfToDealyMABCreation:function(){return!1},updateConnection:function(e,t){t&&t()},createDom:function(t,i){if(!this.frmWindow){this.args.ui=this.args.ui||{displayTree:!0};var n={context:this.args.ctx,height:"100%",minHeight:void 0!==this.args.minHeight?this.args.minHeight:0,viewerOptions:this.args.viewerOptions||this.args.visu||{},uiOptions:this.args.ui,onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var r=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++,n.ignoreResetCommandManager=!0,n.workbenchModule=r.module,n.workbench=r.name+".xml",n.defaultCommand=void 0!==r.defaultCommand?r.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"},this.actionBarProfile=S.createProbe("ActionBar_"+r.name),this.actionBarProfile.begin()}if(this.frmWindow=new t(n),C.is3DPlay()){this.mainTrip=e.createElement("div",{class:"3Dplayviewer_mainTriptych",styles:{width:"100%",height:"100%",position:"relative"}}),this.rightTrip=e.createElement("div",{class:"3Dplayviewer_rightTriptych rightSidePanel"});var s={container:this.mainTrip,withtransition:!0,withoverflowhidden:!0,right:{resizable:!0,originalState:"close",overMobile:!0,minWidth:250,withClose:!1}};this.triptych=new y,this.triptych.init(s,void 0,this.frmWindow.getContent(),this.rightTrip);var o=this;require(["DS/PADServices/utils/GlobalModelEvents"],function(e){o.triptych._modelEvents.subscribe({event:"triptych-clicked-overlay"},function(t){e.publish({event:"ENXViews/Triptych/onOverlayClick",data:t})})}),this.triptych.togglePanel=function(e){"left"===e?o.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"}):o.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"})},this.triptych.inject(this.args.container),this.triptych.getMainPanelContainer().style.zIndex="auto";var a=this.frmWindow.getActionBar();a&&a.inject(this.mainTrip)}else this.frmWindow.inject(this.args.container)}i&&i.apply(this)},getPhaseProgress:function(){return this.phaseProgress},load:function(t,n){if(this.hasConvertFailed=!1,n&&n.newAsset){if(i.endAllCommands({ctx:this.args.ctx,resetDefaultCmd:!1}),s.get("3DPlay.Video.Enabled")){var r=m.get(this.args.ctx,"3DP_Video_Controls");r&&(r.destroyUI(),m.remove(this.args.ctx,"3DP_Video_Controls")),m.get(this.args.ctx,"3DP_Video_Viewer")&&m.remove(this.args.ctx,"3DP_Video_Viewer")}i.publish(this.args.ctx,"ASSET/CHANGE",{model:"clear",ctx:this.args.ctx})}if(null==n&&(n={}),this.playerSplashScreen){var o=n?n.splashscreen:null;this.playerSplashScreen.refreshOptions(o)}!0!==t.preProcessed&&(console.error("3DPlayWeb: inputs should have been pre processed before call."),console.error("3DPlayWeb: Please consider using 3DPlayHelper or InputPreProcessor."));var a=S.createProbe("PreProcessor");a.begin();var l=this;(new f).run(t,function(r){a.end(),a=null;var s=r;if(t=r,l._isReady=!0,!0!==l._isReady)return l.args.input=t,void(l.args.options=n);if(void 0!==l.frmWindow){if(s&&void 0!==s.asset&&!1===Array.isArray(s.asset)&&(s.asset=[s.asset]),s&&void 0!==s.asset&&void 0!==s.asset[0]){var o=!1,d=!0;n&&(o=(void 0===s||void 0===s.asset||void 0===s.asset[0])&&!0===n.clearSceneGraph,void 0!==n.clearSceneGraph&&null!==n.clearSceneGraph&&(d=n.clearSceneGraph)),l.notifTimeoutID&&(clearTimeout(l.notifTimeoutID),l.notifTimeoutID=null),o||d?(l.showSplashBetweenLoad&&l.playerSplashScreen&&(l.playerSplashScreen.showView(l.playerSplashScreen.views.loading),l.toggleSplash(!0)),l.clearView(),l.getPhaseProgress().setIndeterminateState(),l.xcadSupport.clearQueue()):l.autoReframe=!1,o&&l.publish("ASSET/LOADINGFINISHED",{model:"clear",ctx:this.args.ctx});for(var c=null,u={},h=l.getInformationsOnAsset(),p=function(e){e.loadAssetInfo=h,l.onModelLoadingError?l.onModelLoadingError(e):l.onDocumentLoadingError&&l.onDocumentLoadingError(e);var t={};t[e.type]=1,P.trackPageEvent("errors","conversion_error",h.type,0,t),h=null,console.error("Conversion fails, see logs below :"),console.error(e)},g=0;g<s.asset.length;g++)s.asset[g]&&(s.asset[g].mimetype&&s.asset[g].mimetype.toLowerCase&&"3dxml"==s.asset[g].mimetype.toLowerCase()||s.asset[g].format&&s.asset[g].format.toLowerCase&&"3dxml"==s.asset[g].format.toLowerCase())&&("3ddrive"!=s.asset[g].provider.toLowerCase()&&(!s.asset[g].originalAsset||"3ddrive"!=s.asset[g].originalAsset.provider.toLowerCase())||s.asset[g]&&s.asset[g].filename&&s.asset[g].filename.includes&&s.asset[g].filename.includes("3DPlayExperiencesTest")||s.asset[g]&&s.asset[g].serverurl&&s.asset[g].serverurl.includes&&(s.asset[g].serverurl.includes("3DPlayExperiencesTest")||s.asset[g].serverurl.includes("zz3DPlayPCSLoading")))&&(s.asset[g].useConvertors=!1);if(s.asset.length>1){var m=[],v=[];for(g=0;g<s.asset.length;g++)s.asset[g]&&(n&&n.tenant&&(void 0===s.asset[g].tenant||null===s.asset[g].tenant)&&(s.asset[g].tenant=n.tenant),null!==(c=l.xcadSupport.getConversionFormat(s.asset[g].mimetype||s.asset[g].format))&&!1!==s.asset[g].useConvertors?(s.asset[g].dataFormat=c,m.push(s.asset[g])):v.push(s.asset[g]));m.length>0&&(u.nbAssetToConvert=m.length,u.progress=l.getPhaseProgress(),u.progressDivisions=v.length+m.length);var D=s;D.asset=v;var w=l._loadAssets(D,e.extend(n,{convert:u}));w&&m.length>0&&(this.notifTimeoutID=u.notifTimeoutID=setTimeout(function(){i.sendEvent(l.args.ctx,eventType.notif,notification.info,{msg:b.ConversionNeeded})},6e3),m.length>0&&l.xcadSupport.convert(m,u,function(e,t){p(e),w.addNewFile(t)},function(e,t){l.playerSplashScreen.showView(l.playerSplashScreen.views.loading),w.addNewFile(e)},function(e){w.addNewFile(e)}))}else{if(null===s.asset[0]||void 0===s.asset[0])return void l.loadAsset(void 0,n);n&&n.tenant&&(void 0===s.asset[0].tenant||null===s.asset[0].tenant)&&(s.asset[0].tenant=n.tenant);let t=null,r=null;if(!1!==s.asset[0].useConvertors){let e=E.getFormat(s.asset[0]),i=E.getTarget(s.asset[0]);i||(i=l.xcadSupport.getConversionFormat(e)),i&&(r=i,t=l.xcadSupport)}if(null===r)s.asset=s.asset[0],window.localStorage["3DPlayHybridApp"]&&window.HybridAppArgs&&window.HybridAppArgs.myAppsUrl?l.updateConnection(s,function(){l.loadAsset(s,n)}):l.loadAsset(s,n);else{l.subProgressID=l.getPhaseProgress().registerSubProgress(),l.getPhaseProgress().showProgressBar(),s.asset[0].dataFormat=r;var y=e.extend(n,{clearSceneGraph:!0,ConversionFeedBack:{progress:l.getPhaseProgress()}});l.notifTimeoutID=y.ConversionFeedBack.notifTimeoutID=setTimeout(function(){i.sendEvent(l.args.ctx,eventType.notif,notification.info,{msg:b.ConversionNeeded})},6e3);var C=S.createProbe("Convert");C.begin(),t.convert(s.asset[0],y,function(e,t){l.args.input.asset=t,l.loadAssetInfo=t,C.end();t&&t.format&&{step:!0,stp:!0}[t.format.toLowerCase()]?(l.playerSplashScreen&&l.playerSplashScreen.showView(l.playerSplashScreen.views.loading),t&&(t.originalAsset?(new f).run({asset:t.originalAsset},function(e){e.asset.serverurl="",e.asset.filename=e.asset.url,l.loadAsset(e,y)}):l._loadAssets({asset:t},y))):p(e)},function(t){l.loadAssetInfo=e.clone(t,!0),s.asset[0].originalAsset?l.loadAssetInfo.originalAsset=e.clone(s.asset[0].originalAsset,!0):l.loadAssetInfo.originalAsset=e.clone(s.asset[0],!0),l.args.input.asset=t,C.end(),l.playerSplashScreen&&l.playerSplashScreen.showView(l.playerSplashScreen.views.loading),l._loadAssets({asset:t},y)})}}}l.args.input.annotation=s.annotation,l.args.input.asset=e.clone(s.asset,!0),l.args.input.experience=e.extend(l.args.input.experience,s.experience,!0),l.args.options=e.extend(l.args.options,e.clone(n,!0),!0),l.loadAssetInfo=e.clone(l.args.input.asset,!0),l.modelLoadComplete=void 0}})},loadAssets:function(e,t){console.error("Function not implemented - loadAsset")},_handleNotification:function(e){e.eventID===a.fatal?i.displayFatalError({ctx:e.ctx,msg:e.msg}):e.eventID===a.warning||e.eventID===a.info||e.eventID===a.success||e.eventID===a.error||e.eventID===a.assistance?(this.notifMsg.addNotif({level:e.eventID,title:e.title,subtitle:e.subtitle,message:e.msg,category:e.category||"3DPlay - "+this.ctx,sticky:!1}),this.publish("EXPERIENCE/NOTIF",{ctx:e.ctx,event:e.eventID,msg:e.msg})):console.error("3DPlay: "+b.IncorectNotif)},setOnLoadedCallback:function(e){console.error("Function not implemented - AbstractExp")},setOnProgressCallback:function(e){console.error("Function not implemented - AbstractExp")},_step:function(){console.error("Function not implemented - AbstractExp")},step:function(){console.error("Function not implemented - AbstractExp")},preRenderCB:function(){console.error("Function not implemented - AbstractExp")},postRenderCB:function(){console.error("Function not implemented - AbstractExp")},preCreate:function(){console.error("Function not implemented - AbstractExp")},postCreate:function(){console.error("Function not implemented - AbstractExp")},onPreCreate:function(){console.error("Function not implemented - AbstractExp")},onPostCreate:function(){console.error("Function not implemented - AbstractExp")},addScenario:function(e){console.error("Function not implemented - AbstractExp")},getScenarioNumber:function(){console.error("Function not implemented - AbstractExp")},getScenario:function(e){console.error("Function not implemented - AbstractExp")},loadWorkbench:function(e,t){console.error("Function not implemented - AbstractExp")},changeScenario:function(e,t){console.error("Function not implemented - AbstractExp")},getDefaultScenario:function(){console.error("Function not implemented - AbstractExp")},manageScenario:function(){console.error("Function not implemented - AbstractExp")},getModelLoader:function(){console.error("Function not implemented - AbstractExp")},getScenarioManager:function(){console.error("Function not implemented - AbstractExp")},clearView:function(){this.notifScreen&&this.notifScreen.removeNotifications(),this.showSplashBetweenLoad&&this.playerSplashScreen&&(this.playerSplashScreen.showView(this.playerSplashScreen.views.loading),this.toggleSplash(!0))},showContextualMenu:function(e){this._enableCMenu=e},addCallbacks:function(e){i.addCallbacks(this.args.ctx,e)},publish:function(e,t){v.publish({event:"/"+this.args.ctx+"/"+e+"/",data:t})},subscribe:function(e,t,i){var n=v.subscribe({event:"/"+this.args.ctx+"/"+e+"/"},t);return i?(this.EventDisposer.add(n),null):n},subscribeOnce:function(e,t){var i=v.subscribe({event:"/"+this.args.ctx+"/"+e+"/"},function(){v.unsubscribe(i),t.apply(void 0,arguments)})},unsubscribe:function(e){return v.unsubscribe(e)}})}),define("DS/3DPlayUtils/TestBrowser",["DS/3DPlayUtils/BrowserSupportList","DS/WebSystem/DetectBrowser"],function(e,t){"use strict";return function(){var i,n=!1,r=document.createElement("canvas");try{(i=r.getContext("webgl"))&&(n=!0)}catch(e){}if(!i)try{(i=r.getContext("experimental-webgl"))&&(console.warn("experimental-webgl"),n=!0)}catch(e){}if(0==n)return BrowserSupport.none;if("undefined"==typeof Worker)return BrowserSupport.none;var s=t(),o=e[s.os.name];if(void 0!==o){var a=o[s.os.version];if(void 0===a&&(void 0===(a=o.default)||void 0!==a.version&&void 0!==a.version.isSupported&&!1!==a.version.isSupported(s.os.version)||(a=void 0)),void 0!==a){var l=a[s.browser.name];if(void 0!==l&&void 0!==l.isSupported)return l.isSupported(s.browser.version)}}return BrowserSupport.partial}});var EditPropConstantsReq=[];"true"!==window.localStorage["3DPlay.useOutsidePlatform"]&&EditPropConstantsReq.push("DS/EditPropWidget/constants/EditPropConstants"),define("DS/3DPlayExperienceModule/3DPlayExperience",["DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayAbstractExperience","DS/ApplicationFrame/CommandsManager","DS/3DPlay/3DPlayScenarioManager","DS/WebInfraUI/Notification","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/3DPlaySupport/SupportList","DS/3DPlaySupport/ExperiencesList","DS/3DPlaySupport/AssetSupport","DS/WebUtils/ProbesManager","DS/WebUtils/Statistics","DS/WebUtils/Tracker","DS/3DPlaySocialPanel/3DPlaySocialPanelManager","DS/WebSystem/App","DS/WebUtils/WebServices","DS/3DPlayExperienceModule/Tracker_Translation_Experience","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/WebSystem/SessionManager","DS/3DPlayHelper/AssetLoadingPreview","DS/WebInfraUI/MobileActionBar"].concat(EditPropConstantsReq),function(e,t,i,n,r,s,o,a,l,d,c,u,h,p,g,f,m,v,S,D,w,P,y,C){"use strict";return n.extend({init:function(i){if(this.detectPlatform(),this._parent(i),this.useSession){var n=i.session||[];w.init({sessionKey:"3DPlay.Session",dataKey:"experience",ToCopy:n.ToCopy,toMigrate:n.toMigrate})}if(m.is3DPlay()&&(this.args.options.propertiesFacet=this.args.options.propertiesFacet||[],this.args.options.propertiesFacet.push(C.FACET_PROPERTIES),this.args.options.propertiesFacet.push(C.FACET_SWYMCOMMENTS),this.args.options.propertiesFacet.push(C.FACET_RELATIONS)),i.options.callback&&this.setOnAnnotationShared(i.options.callback.onAnnotationShared),this.force3DComment=!1,this.args.options&&this.args.options.behaviors&&(this.force3DComment=Array.isArray(this.args.options.behaviors)&&this.args.options.behaviors.indexOf("comment")>-1),void 0===i.commandApplication||!0===i.commandApplication){if(i.workbenchs=i.workbenchs||[],i.workbenchs.unshift({name:"3DPlay",module:"3DPlay"}),t.isSet("3DPlay.Session.AB")&&i.workbenchs.push({name:"3DPlayDebug",module:"3DPlayExperienceModule"}),this._hasLightbox=widget.hasLightbox,this._hasLightbox)m.isOnCloud()?i.workbenchs.push({name:"3DPlayShareComment_LightboxMode",module:"3DPlay"}):i.workbenchs.push({name:"3DPlayShare_LightboxMode",module:"3DPlay"});else{let e=this.force3DComment||this.useSession&&(m.is3DSwym()||m.is3DDrive()||m.is3DSpace()||m.is3DPlay())&&m.isOnCloud()&&!0!==this.share3DCommentHide;this._iOS?e?i.workbenchs.push({name:"3DPlayShareComment_iOS",module:"3DPlay"}):t.isSet("3DPlay.publishToMakeCmdActivate")?i.workbenchs.push({name:"3DPlayShare_iOSPublishToMake",module:"3DPlay"}):i.workbenchs.push({name:"3DPlayShare_iOS",module:"3DPlay"}):e?i.workbenchs.push({name:"3DPlayShareComment",module:"3DPlay"}):t.isSet("3DPlay.publishToMakeCmdActivate")?i.workbenchs.push({name:"3DPlaySharePublishToMake",module:"3DPlay"}):i.workbenchs.push({name:"3DPlayShare",module:"3DPlay"})}t.isSet("3DPlay.Session.AB")&&i.workbenchs.push({name:"3DPlayDebug",module:"3DPlayExperienceModule"}),t.isSet("3DPlay.Activate3DComment")&&i.workbenchs.push({name:"3DPlayComment",module:"3DPlay"})}s.loadManager(this),this.ctx=this.args.ctx,this.modelTotalCount=0,this.modelLoadComplete=void 0,this.getPhaseProgress().setIndeterminateState(),this.getPhaseProgress().addProgressBarIntoUI(i.container);var r=this;this.disposeFunctions.add(function(){r=null}),this.onModelLoadingStarted=function(t){r.args.container.classList.toggle("3DPlayPO-Loading-Started");var i=r.args.input.asset,n=r.getInformationsOnAsset(i);if(!r.onAnnotationShared&&i){var s,o=i.serviceURL;"3DSWYM"===n.provider&&(s=i.swymServerToken),null==o?"3DSWYM"===n.provider&&v.getServiceUrl({serviceName:"3DSwym",platformId:n.tenant,onSuccess:function(e){var t=e;t&&(Array.isArray(t)&&(t=t[0]),t.url&&(o=t.url)),n.id&&n.tenant&&o&&r.createSocialPanel(n.id,n.tenant,o,n.provider)},onError:function(){}}):n.id&&n.tenant&&o&&r.createSocialPanel(n.id,n.tenant,o,n.provider,s)}r.modelLoadComplete=!1,r.startLoadingPreview(n),r.publish("ASSET/LOADINGSTARTED",{data:r.modelName,ctx:r.args.ctx,loadAssetInfo:n}),e.endAllCommands({ctx:r.args.ctx,resetDefaultCmd:!1}),!0===(void 0===t||t)&&(r.getPhaseProgress().setIndeterminateState(),r.getPhaseProgress().showProgressBar()),0===r.getPhaseProgress().getSubProgressDivisions()&&(r.subProgressID=r.getPhaseProgress().registerSubProgress()),r.noGeoTimO&&clearTimeout(r.noGeoTimO),r.noGeoInt&&clearInterval(r.noGeoInt)},this.onModelLoadingProgression=function(e){if(r){var t=e.currentProgressID||r.subProgressID;t?r.subProgressID!==t&&(r.subProgressID=t):t=r.subProgressID=r.getPhaseProgress().registerSubProgress(),void 0!==e.loaded&&void 0!==e.total&&0!==e.total&&(r.newPart=!0,r.modelLoadCount=e.loaded,r.modelTotalCount=e.total,r.getPhaseProgress().setAbsoluteProgress(t,Math.round(100*e.loaded/e.total)),r.modelLoadCount>0&&r.stopLoadingPreview(),r.publish("ASSET/LOADINGPROGRESS",{model:r.modelName,progress:e,ctx:r.ctx}))}},this.onModelLoadingCompleted=function(){if(r){r.args.container.classList.toggle("3DPlayPO-Loading-Complete"),r.args.container.classList.toggle("3DPlayPO-Loading-Started"),r._onModelLoadingCompleted&&r._onModelLoadingCompleted(),r.getPhaseProgress()&&(r.getPhaseProgress().advanceToMax(r.subProgressID),r.getPhaseProgress().resetProgress(),r.getPhaseProgress().hideProgressBar()),r.args.options.loading===loadingMode.preload&&(r.isLoaded=!0),r.stopLoadingPreview(),r.toggleSplash(!1),r.modelLoadComplete=!0;var e=0;r.totalLoadingAssetProfiler&&(r.totalLoadingAssetProfiler.end(),e=Math.floor(r.totalLoadingAssetProfiler.getTime())),r.publish("ASSET/LOADINGFINISHED",{model:r.modelName,time:e,ctx:r.args.ctx,loadAssetInfo:r.loadAssetInfo||{}});r.args.input.asset;if(r.stats&&setTimeout(function(){r.stats.UpdateProbes=!0,r.stats.postProcess()},2e3),t.isSet("3DPlay.zzPCS")){var i=window.top.document.createEvent("CustomEvent");i.initCustomEvent("3DPlay.zzPCS",!0,!1,require("DS/WebUtils/ProbesManager").GetProcessedData({topWindow:!0,cleanNames:!0,only3DPlay:!0})),window.top.document.dispatchEvent(i)}if(t.isSet("3DPlay.ConsolePCS")){var n=h.GetProcessedData({topWindow:!0,cleanNames:!0}),s={Timings:{},Memory:{},FIleStats:r.computeViewerStats()};n.sort(function(e,t){var i=e.startTime,n=t.startTime;return i<n?-1:i>n?1:0}),n.forEach(function(e){s.Timings[e.name]={startTime:e.startTime,duration:e.duration}}),require("DS/WebSystem/Downloader")("3DPlay.QAPCS.json",new Blob([JSON.stringify(s)],{type:"text/plain"}))}r.args.input.annotation&&(r.loadAnnotations(r.args.input.annotation),delete r.args.input.annotation)}},this.subscribe("ASSET/LOADINGERROR",function(){r&&r.stopLoadingPreview()}),t.isSet("3DPlay.Statistics")&&(this.stats=new p,this.stats.set({container:this.args.container}))},detectPlatform:function(){this._iOS=Boolean(navigator.platform)&&/iPad|iPhone|iPod/.test(navigator.platform)||Boolean(navigator.userAgent)&&/iPad|iPhone|iPod/.test(navigator.userAgent)||(/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&!window.MSStream,this._android=Boolean(navigator.userAgent)&&/Android/.test(navigator.userAgent)},comuteViewerStats:function(){return{}},getExperienceBase:function(){return this.experienceBase},getScenarioManager:function(){return s},loadScenario:function(){console.error("3DPlayExperience : Method Deprecated -> Use getScenarioManager Instead")},dispose:function(e){this._loadingPreview&&(this._loadingPreview.hide(),this._loadingPreview.remove()),this.useSession&&w.dispose(),this.sessionProbes&&(this.sessionProbes.end(),g.trackPageEvent("infos","3DPlay_session","duration",Math.floor(this.sessionProbes.getTime())/1e3));var t=l.get(this.args.ctx,"ANNOTATION_MANAGER");t&&(t.deleteAllAnnotations(),l.remove(this.args.ctx,"ANNOTATION_MANAGER")),this.currentLoadingAssetProfiler&&(this.currentLoadingAssetProfiler.dispose&&this.currentLoadingAssetProfiler.dispose(),this.currentLoadingAssetProfiler=null);var i=require("DS/ApplicationFrame/AfrPlayerService");i&&(i._playerView={},i.hidePlayer(),i.registerPlayerContainer(void 0)),this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,this._parent(e),s.dispose(),this.frmWindow&&(this.frmWindow.experience=null,this.frmWindow=null)},setOnLoadedCallback:function(){},setOnProgressCallback:function(){},step:function(){},_step:function(){this.stats&&this.stats.postProcess()},onPreCreate:function(){},onPostCreate:function(){},manageWorkBenchs:function(e){var i,n=e&&e.frameWindow?e.frameWindow:this.frmWindow,s=e.finishCallBack;if(this.actionBarReady=!1,n&&n.getActionBar()){var o=this;i=e.customWorkBench?e.customWorkBench:o.args.workbenchs;var a="none";e&&e.frameWindow&&e.frameWindow.experience&&e.frameWindow.experience.args&&e.frameWindow.experience.args.input&&e.frameWindow.experience.args.input.asset&&e.frameWindow.experience.args.input.asset.provider&&(a=e.frameWindow.experience.args.input.asset.provider);for(var d=i.length;d--;)!t.isSet("3DPlay.publishToMakeCmdActivate")||"FILE"!=a&&"3DDRIVE"!=a&&"3DSWYM"!=a?"3DPlayShare_iOSPublishToMake"==i[d].name?i[d].name="3DPlayShare_iOS":"3DPlaySharePublishToMake"==i[d].name&&(this.args.workbenchs[d].name="3DPlayShare"):o._iOS?"3DPlayShare_iOS"==i[d].name&&(i[d].name="3DPlayShare_iOSPublishToMake"):"3DPlayShare"==i[d].name&&(i[d].name="3DPlaySharePublishToMake");var c=function(t){var a,d;a=function(){var e;if(n&&n.experience&&n.experience.workbenchIndex>0&&o.actionBarProfile&&o.actionBarProfile.end(),void 0===o.workbenchIndex&&(o.workbenchIndex=0),o.workbenchIndex<i.length)e=i[o.workbenchIndex],o.actionBarProfile=h.createProbe("ActionBar_"+e.name),o.actionBarProfile.begin(),o.loadWorkbench(e,0!==o.workbenchIndex),o.workbenchIndex++;else{(e=i[i.length-1])&&e.defaultCommand&&(e.defaultCommand.context=o.args.ctx,r.setDefaultCommand(e.defaultCommand)),o.actionBarReady=!0,h.end("ActionBar_Ready"),void 0!==o.args.ui.onActionBarReady&&o.args.ui.onActionBarReady(),o.args.container.classList.toggle("3DPlayPO-Init-Ready"),o.args.options.helper||l.get(this.args.ctx,"helper");var c=r.getCommands(o.args.ctx);if(c)for(var u in c)c.hasOwnProperty(u)&&o.addScriptingFunction(c[u].getId(),function(e){return function(t){e[t||"begin"]()}}(c[u]),"Command "+c[u].getId(),void 0,void 0,o.trackScriptingFunction);if(c=r.getCommandCheckHeaders(o.args.ctx))for(var u in c)c.hasOwnProperty(u)&&o.addScriptingFunction(c[u]._id,function(e){return function(t){var i="begin"===(t||"begin");e.setState(i)}}(c[u]),"Command "+c[u]._id,void 0,void 0,o.trackScriptingFunction);o.play(),a=null,n._actionBar.removeCallback(d),s&&s(),t()}}.bind(o),d=n.onActionBarReady(a),(e.createActionBar||o.enopadInited)&&a&&a()};this.WKPromise?this.WKPromise.then(function(){o.WKPromise=new Promise(c)}):this.WKPromise=new Promise(c)}},updateMAB:function(e){var i=this.frmWindow.getActionBar();e&&i&&(i.MAB?i.MAB.update(e):i.MAB=new y({ctx:this.ctx,frameWnd:this.frmWindow,exp:this,actionBar:i,model:e,panelManager:this.PanelManager,alwaysOn:this._iOS||this._android||window.WinJS&&t.isSet("3DPlay.MabWin10"),ios:this._iOS,pdf:this.isCurrentDocumentPDF}))},resetScenarioMAB:function(e){var t=(e&&e.frameWindow?e.frameWindow:this.frmWindow).getActionBar();t&&t.MAB&&t.MAB.resetScenario()},loadWorkbench:function(e,t,i){if(this.frmWindow){var n=void 0!==t&&t;if(void 0!==e.name){var r=e.name,s=this.args.ctx;"xml"!==a.getExtension(e.name)&&(r+=".xml");var o=this.frmWindow.getActionBar();o&&(o.loadModel({context:s,file:r,module:e.module,merge:!0===n}),i&&o.MAB&&o.MAB.loadScenarioWb(i,t))}}},preCreate:function(){},postCreate:function(){},_loadAssets:function(e,t){var n=this;if(this.frmWindow&&this.frmWindow.getModelLoader){var r=this.frmWindow.getModelLoader();null!==t.convert&&void 0!==t.convert||(t.convert={});var s=[];if(t.convert.progressArray)s=s.concat(t.convert.progressArray);else{var o=t.convert.progressDivisions||e.asset.length;s=n.getPhaseProgress().registerMultipleSubProgress(o)}var a={modelLoaderonLoadedCB:r.onLoadedCB,proportion:t.convert.progressProportion||1/e.asset.length,array:[].concat(e.asset),experience:this,phaseprogress:t.convert.progress||n.getPhaseProgress(),progressArray:[].concat(s),currentProgressID:void 0,ctx:this.args.ctx,currentmodel:void 0,options:i.extend({},t),nbAssetDelayed:t.convert.nbAssetToConvert||0,isWaiting:!1,addNewFile:function(e){null!==e&&a.array.push(e),a.nbAssetDelayed=a.nbAssetDelayed-1,a.isWaiting&&(a.isWaiting=!1,a.processNextFile())},processNextFile:function(){if(void 0===this.currentmodel?void 0!==this.options.clearSceneGraph&&null!==this.options.clearSceneGraph||(this.options.clearSceneGraph=!0):(this.options.clearSceneGraph=!1,this.array.length),this.array.length>0){this.currentmodel=this.array.shift(),this.currentProgressID=this.progressArray.shift();var e=this.experience;e.updateConnection({asset:this.currentmodel},function(){e.loadAsset({asset:this.currentmodel},this.options,!1,this.profile),e=null}.bind(this))}else 0===a.nbAssetDelayed?(n.setOnLoadedCallback(this.experience.onModelLoadingCompleted),n.setOnProgressCallback(this.experience.onModelLoadingProgression),this.modelLoaderonLoadedCB()):a.isWaiting=!0},progress:function(e){e.currentProgressID=a.currentProgressID,this.experience.onModelLoadingProgression(e)}};return this.setOnLoadedCallback(function(){a.phaseprogress.advanceToMax(a.currentProgressID),a.processNextFile()}),this.setOnProgressCallback(function(e){a.progress(e)}),a.processNextFile(),a}},initExperienceBase:function(e,t){t&&t(0)},disposeExperienceBase:function(e){e&&e(0)},computeViewerStats:function(){return{}},initExperience:function(){if(this.onPreCreate(),this.preCreate(),this._postcreate=function(){this.createUIComponents(this.frmWindow),this.args.helpercb&&this.args.helpercb(this,this.args.ctx);var e=this.args.options.helper;e||(e=l.get(this.args.ctx,"helper")),e&&(e.instance=this,e.loaded=!0,e.SupportList=d,e.ExperiencesList=c,e.AssetSupport=u),this.addWidgetPreferences(),this.postCreate(),this.onPostCreate(),this.first=(new Date).getTime(),this.frmWindow.getActionBar()||this.publish("EXPERIENCE/EXPERIENCEREADY",this),this.fromTransition()||this.args.input&&this.args.input.asset&&(this.args.options.loading===loadingMode.preload||this.args.options.splashscreen&&this.args.options.splashscreen.waitloading||this.toggleSplash(!1),this.totalLoadingAssetProfiler=h.createProbe("_Load_"),this.totalLoadingAssetProfiler.begin(),this.waitingCammandsForLoad=this.waitingCammandsForLoad||[],Promise.all(this.waitingCammandsForLoad).then(function(){this.load(this.args.input,this.args.options)}.bind(this)))},this.startLoadingPreview(this.getInformationsOnAsset(this.args.input.asset)),this.frmWindow)this.createDom(void 0,this._postcreate),this._postcreate();else{var e=this,t=this.args.input.experience.filename||this.args.input.experience;this.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",function(){e.sessionProbes=h.createProbe("session_duration"),e.sessionProbes.begin(),setTimeout(function(){var e=h._parse("ExperienceReady");e.end();var i=e.getTime(),n=h.GetSubProbesFrom(e,!1);n.Experience_Ready=i,g.trackPageEvent("experience","ExperienceReady",t,Math.floor(e.getTime()),n,void 0,S.experience)},100),e.stats&&(e.stats.probesDone=!1,e.stats.postProcess()),e=null}),this.subscribe("ASSET/LOADINGFINISHED",function(e){this.args.input&&this.args.input.asset&&"ENOPAD"!==this.currentProvider&&this._sendStats(!0)}.bind(this),!0),this.subscribe("ASSET/LOADINGSTARTED",function(e){e&&!e.refreshed&&(this._sendStats(!1),g.resetCommandCounter())}.bind(this),!0),this.createDom(this.args.FrameWindow,this._postcreate),this.frmWindow&&(this.frmWindow.experience=this)}},_sendStats:function(e){var t=this.getInformationsOnAsset();if(t)if(e)try{var n=h.GetSubProbesFrom(this.totalLoadingAssetProfiler,!1);n=i.extend(n,this.computeViewerStats()),g.trackPageEvent("asset",t.type,t.provider,this.totalLoadingAssetProfiler.getTime(),n,void 0,S.asset)}catch(e){}else g.trackPageEvent("infos","asset_type",t.type),g.trackPageEvent("infos","asset_source",t.provider),g.trackPageEvent("infos","tenant",t.tenant),t.source&&g.trackPageEvent("infos","drop_source",t.source)},loadAnnotations:function(e,t){if(1==this.modelLoadComplete)this._loadAnnotations(e,t);else{var i=this;this.subscribeOnce("ASSET/LOADINGFINISHED/",function(){i._loadAnnotations(e,t)})}},_loadAnnotations:function(e,t){var i=new FileReader,n=this;i.addEventListener("loadend",function(e){var i;try{i=JSON.parse(e.srcElement.result)}catch(e){}if(i&&i.experience){w.restoreSession(i);let e={measure:0,clipping:0,annotations:0,pgpFromServer:i.experience.pgpFromServer?1:0};i.experience.DMU&&i.experience.DMU.dmuObjects&&i.experience.DMU.dmuObjects.forEach((t,i)=>{"MeasureItem"===t.type&&(e.measure=1),"Clipping"===t.type&&(e.clipping=1)}),(r=l.get(n.args.ctx,"ANNOTATION_MANAGER"))&&(e.annotations=r._annotViewpointList.length),g.trackPageEvent("interactions","comment","3d",0,e,void 0,S.comment)}else{var r;(r=l.get(n.args.ctx,"ANNOTATION_MANAGER"))&&r.drawAnnotationsFromJSON(e.srcElement.result,t),n=null,g.trackPageEvent("interactions","comment","2d")}}),i.readAsText(e)},createSocialPanel:function(e,i,n,r,s){t.isSet("3DPlay.Activate3DComment")&&(this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,e&&e&&n&&(this._3dCommentPanel=new f({frameWindow:this.frmWindow,assetId:e,tenantId:i,serviceUrl:n,assetProvider:r,serverToken:s,onCommentClick:function(e){e.data&&e.data.annotationFile&&this.loadAnnotations(e.data.annotationFile,!0)}.bind(this)})))},createComment:function(e){return!!this._3dCommentPanel&&(this._3dCommentPanel.postComment(e.annotation,e.screenshot),this._3dCommentPanel.show())},hideSocialPanel:function(){return!!this._3dCommentPanel&&this._3dCommentPanel.hide()},setOnAnnotationShared:function(e){this._3dCommentPanel&&this._3dCommentPanel.dispose(),this._3dCommentPanel=void 0,this.onAnnotationShared=e},refresh:function(){if(this.args.input.asset.originalAsset){var e=this;(new(require("DS/3DPlayConnectors/3DPlayInputPreProcessor"))).run(this.args.input.asset.originalAsset,function(t){e.load(t,e.args.options),e=null})}else this.load(this.args.input,this.args.options);return!0},startLoadingPreview:function(e){e&&!0!==this.modelLoadComplete&&(this._hidePreview=!1,this.thumbnailURL(e).then(function(e){this._hidePreview||(this._loadingPreview?(this._loadingPreview.updateThumbnailURL(e),this._loadingPreview.show()):(this._loadingPreview=new P({thumbnailURL:e}),this._loadingPreview.inject(this.args.container)))}.bind(this)).catch(function(e){console.warn("Unable to retrieve thumbnail URL for loading preview"),console.warn(e)}))},stopLoadingPreview:function(){this._hidePreview=!0,this._loadingPreview&&this._loadingPreview.hide()},thumbnailURL:function(e){return new Promise(function(t,i){"3DDRIVE"!=e.provider?e.originalAsset&&e.originalAsset.displayPreview?t(e.originalAsset.displayPreview):e.displayPreview?t(e.displayPreview):"3DSWYM"==e.provider&&(e.preview&&e.preview.thumbnails&&t(e.preview.thumbnails[2].transient_url),e.swymAttr&&e.swymAttr.thumbnails?t(e.swymAttr.thumbnails[2].transient_url):v.getMediaInformationFrom3DSwym(e).then(function(e){t(e.result.preview.thumbnails[2].transient_url)}).catch(i)):i("Loading preview disabled for 3DDrive content.")}.bind(this))}})});var enopad=[];"false"!==window.localStorage["3DPlay.pad3DViewer"]&&(enopad=["DS/ENOPAD3DViewer/PAD3DViewer","DS/PADUtils/PADUtilsServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","i18n!DS/PADUtils/assets/nls/PADUtils","DS/PADUtils/PADSettingsMgt","text!DS/PADUtils/assets/PADSettingsMgt.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSharedSettings"]),define("DS/3DPlayExperienceModule/PlayExperience3D",["DS/WebappsUtils/WebappsUtils","DS/3DPlay/3DPlay","DS/WebSystem/Environment","UWA/Core","DS/3DPlayExperienceModule/3DPlayExperience","DS/ApplicationFrame/CommandsManager","DS/WebUtils/Profiler","DS/3DPlayUtils/PanelManager","DS/3DPlayUtils/TestBrowser","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/WebUtils/StringUtils","DS/WebUtils/ContextedSingleton","DS/WebSystem/Nls","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/WebInfraUI/Notification","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/WebViewer/SceneGraphHelper","DS/3DPlayExperienceModule/SceneGraphNodeServices","css!DS/3DPlayExperienceModule/assets/PlayExperience3D","DS/WebUtils/ProbesManager","i18n!DS/3DPlayHelper/assets/nls/SplashScreen","UWA/Promise","DS/WebRunloop/Runloop","DS/WebUtils/Tracker","DS/WebUtils/Network","DS/VisuTools/StatsComputer","i18n!DS/3DPlayExperienceModule/assets/nls/3DPlayExperienceModule","DS/3DPlayExperienceModule/PlayExperience3DScriptingPlugin","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/Controls/ProgressBar","DS/UIKIT/Tooltip","DS/3DPlaySupport/ExperiencesList","DS/ApplicationFrame/FrameWindow3D","DS/WebSystem/Preference","DS/WebSystem/App","DS/Selection/CSOManager","DS/WebInfraUI/ConfirmBox","i18n!DS/3DPlayCommands/assets/nls/CmdENOPADStream","i18n!DS/3DPlay/assets/nls/3DPlay","DS/WebUtils/Logger","DS/WebSystem/SessionManager","DS/DMU3DPlayAPIWeb/DMUMeasureSectionExportImportAPI","DS/3DPlayAnnotation3D/AnnotationManagerUtils","DS/DMUBaseExperience/DMUContextManager"].concat(enopad),function(WebappsUtils,_3DPlay,Environment,UWA,EXPERIENCE,CommandsManager,Profiler,PanelManager,TestBrowser,Node3D,WorldOrientation,StringUtils,ContextedSingleton,NLS,ModelLoader,THREE,Notification,SceneGraphOverrideSet,SceneGraphHelper,SceneGraphNodeServices,Css,ProbesManager,SplashScreenNLS,UWAPromise,Runloop,Tracker,Network,StatsComputer,prefs,PlayExperience3DScriptingPlugin,VisuEventsManager,WUXEvents,WUXProgressBar,Tooltip,ExperiencesList,FrameWindow3D,Preference,App,CSOManager,ConfirmBox,CmdENOPADStreamNLS,NLS3DPlay,Logger,SessionManager,DMUMeasureSectionExportImportAPI,AnnotationManagerUtils,DMUContextManager,ENOPAD3DViewer,PADUtilsServices,NLSPAD3DViewer,NLSPADUtuils,PADSettingsMgt,PADSettingsMgtJSON,PAD3DViewerModelServices,PADSharedSettings){"use strict";var VCXExperienceBase,requirePromise=new UWAPromise(function(e){"false"===window.localStorage["3DPlay.VCX"]?e():require(["DS/VCXWebExperienceBase/VCXExperienceBase"],function(t){VCXExperienceBase=t,e()})}),logger=Logger("3DPlay.PlayExperience3D"),endEdit,prefName="3DPlay.CGRPolicy",visuModeOptions={MaterialMode:{needCGR:!0,needMaterial:!0},Illustration:{needCGR:!0,needMeshInRam:!0},Edges:{needCGR:!0},AxisFilter:{needCGR:!0},PlanesFilter:{needCGR:!0},LinesFilter:{needCGR:!0},PointsFilter:{needCGR:!0}},exp={name:"PlayExperience3D",refresh:function(e){if(this.acceptRefresh()){if(CommandsManager.endAll(this.args.ctx),e||(SessionManager.clearSession(),AnnotationManagerUtils.deleteAnnotationManager(this.args.ctx)),"ENOPAD"!==this.currentProvider)return this._parent();this.pad3DViewer&&this.pad3DViewer.getRoots().length>0&&(this._materialModeChanged&&e?(this.pad3DViewer.getController().refreshForMaterials(),this._materialModeChanged=!1):(e||this.changeVisuSettingIfPossible(),this.pad3DViewer.refresh()))}return!0},acceptSwitch:function(){var e=!1,t=this.args.input.asset;return Array.isArray(t)&&(t=t[0]),null==t?e=!0:t.provider&&(e="FILE"!==t.provider),e},_onModelLoadingCompleted:function(){this.loadingAsset.Load_Session&&this.loadingAsset.Load_Session.end()},computeViewerStats:function(){var e=new StatsComputer(this.frmWindow.getViewer()),t=e.computeStats();if(t){t.DownloadSize=Math.floor(this.loadingAsset.size/1e3),e.viewer=null,e=null}return t},createScriptingAPI:function(){this._parent();var e=this.args.options.helper||ContextedSingleton.get(this.args.ctx,"helper");e&&PlayExperience3DScriptingPlugin(e,this)},init:function(options){if(options&&options.options&&options.options.NR&&!0===options.options.NR.active){var moduleNR="DS/3DPlayWebNRTools/NRModeManager";require([moduleNR],function(e){logger.log("NRModeManager call completed in DefaultExp"),_this.NRMgr=new e({frmWindow:_this.frmWindow})}),!0===Environment.isSet("3DPlay.NRPrototype.DebugCmd")&&(options.workbenchs=options.workbenchs||[],options.workbenchs.unshift({name:"3DPlayNRExperience",module:"3DPlayNRExperience"}))}var expName;options.workbenchs=options.workbenchs||[];try{expName=options.input.experience.filename.match(/\/(\w*)$/)[1]}catch(e){expName=null}var experiencesWithoutQM=["CAT3DSketchExperience","3DPlay360Experience"],wkbName;((App.is3DSwym()||App.is3DDrive())&&expName&&!experiencesWithoutQM.includes(expName)&&options.workbenchs.unshift({name:"3DPlayQualityManager",module:"3DPlay"}),Environment.isSet("3DPlay.publishToMakeCmdTest")&&options&&options.input&&options.input.asset&&options.input.asset.provider&&("FILE"===options.input.asset.provider||"3DDRIVE"===options.input.asset.provider||"3DSWYM"===options.input.asset.provider)?Environment.set("3DPlay.publishToMakeCmdActivate","true"):Environment.remove("3DPlay.publishToMakeCmdActivate"),this.evtTokenMouse=[],void 0===VisuEventsManager._isInit&&VisuEventsManager.init(),this.reframeConfiguration={},this.noGeoTimO="timeout",this.noGeoInt="interval",this.loadingAsset={size:0},this.pad3DViewerTokens=[],options=options||{},this.does3DPlayDoTheRequestNewExperienceBase="false"!==window.localStorage["3DPlay.VCX"],options.input&&options.input.experience&&("DS/VCXWebComposer3DPlayExperience/VCXWebPlayerIn3DPlayExperience"===options.input.experience.filename||"DS/XCT3DPlayIntegratability/XCT3DPlayIntegratability"===options.input.experience.filename)&&(this.does3DPlayDoTheRequestNewExperienceBase=!1),this._hasLightbox=widget.hasLightbox,void 0===options.commandApplication||!0===options.commandApplication)&&(wkbName=this._iOS||this._android?"3DPlayExperience3D_mobile":"3DPlayExperience3D",options.workbenchs.unshift({name:wkbName,module:"3DPlay"}),App.is3DPlay()&&(this._hasLightbox?options.workbenchs.push({name:"EnopadRightPanel_LightboxMode",module:"3DPlay"}):options.workbenchs.push({name:"EnopadRightPanel",module:"3DPlay"})),Environment.isSet("3DPlay.VisuPanel")&&options.workbenchs.push({name:"3DPlayVisuPanel",module:"3DPlayExperienceModule"}));function isLoadAnimationValid(val){return"Full"===val||"None"===val||"Optimized"===val||!isNaN(val)&&eval(val)>=0&&eval(val)%1==0}var EnvLoadAnimation=Environment.get("3DPlay.LoadAnimation");isNaN(EnvLoadAnimation)||(EnvLoadAnimation=eval(EnvLoadAnimation)),isLoadAnimationValid(EnvLoadAnimation)?options.options.loadAnimation=EnvLoadAnimation:!1===isLoadAnimationValid(options.options.loadAnimation)&&(options.options.loadAnimation="Optimized"),this.useSession&&(options.session={ToCopy:["VisuViewSettings"],toMigrate:[{src:"3DPlay.scenarioActivated",dst:"Scenario"}]}),this._parent(options),this.modelLoadCount=0,this.modelTotalCount=0,this.modelLoadComplete=void 0,this.showSplashBetweenLoad=!1,NLS.loadNls("Visualization/3DXML_errors");var _this=this,hideRefAxisCount=0;this.hideRefAxis=function(){if(++hideRefAxisCount>0&&_this&&_this.frmWindow){var e=_this.frmWindow.getViewer();e&&e.setReferenceAxisSystem&&(e.setReferenceAxisSystem(!1),e.render())}},this.showRefAxis=function(){if(0===(hideRefAxisCount=Math.max(0,hideRefAxisCount-1))&&_this&&_this.frmWindow){var e=_this.frmWindow.getViewer();e&&e.setReferenceAxisSystem&&(e.setReferenceAxisSystem(!0),e.render())}};var phaseProgress=this.getPhaseProgress(),ctx=_this.args.ctx,viewpoint,viewer,frmWindow;this.onModelLoadingError=function(e){if(_this.hadLoadingError=!0,void 0!==e.rsc)NLS.nls(e.rsc,e.type,function(t){e.text&&(t+=e.text),_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:t}),e.abort&&phaseProgress.hideProgressBar()});else if(void 0!==e.nls&&null!==e.nls)if("Convert_SERVICE_NOT_FOUND"===e.type&&(_this.hasConvertFailed?e.level=Notification.fatal:_this.hasConvertFailed=!0),null==e.fileNls){var t=NLS3DPlay[e.nls]+(e.text?e.text:"");_3DPlay.sendEvent(ctx,eventType.notif,e.level,{msg:t}),e.abort&&phaseProgress.hideProgressBar()}else{var i=["i18n!DS/"+e.fileNls.split("/")[0]+"/assets/catnls/"+e.fileNls.split("/")[1]];require(i,function(t){var i=t[e.nls.split(".")[0]][e.nls.split(".")[1]]+" : "+(e.txt?e.txt:"");_3DPlay.sendEvent(ctx,eventType.notif,Notification.warning,{msg:i})})}else NLS.nls("Visualization/3DXML_errors","ERROR_"+e.type,function(t){var i;"FORMAT"===e.type?(i=NLS3DPlay.LoadingError_FORMAT+":"+StringUtils.getExtension(e.url),_this=!1,_3DPlay.displayFatalError({ctx:ctx,msg:i})):"NO_GEOMETRY"===e.type?(_3DPlay.displayNotification({ctx:ctx,msg:t}),phaseProgress.hideProgressBar()):(i=t+" : "+e.url,_3DPlay.sendEvent(ctx,eventType.notif,Notification.error,{msg:t}),phaseProgress.hideProgressBar()),void 0!==i&&logger.error(i)});_this&&_this.publish("ASSET/LOADINGERROR",UWA.extend({ctx:ctx},e))},this.onSelectCallback=function(e){var t=!1,i=CommandsManager.getCommands(_this.frmWindow.experience.ctx);if(i){for(var n=Object.keys(i),r=0;r<n.length;r++){var s=n[r];if("myDefaultCmd"!==s){var o=i[s];if(o&&o.isRunning()){t=!0;break}}}if(!1===t&&_this.frmWindow.getViewerFrame().offsetHeight>240&&_this.frmWindow.getViewerFrame().offsetWidth>240){var a=CSOManager.get(),l=!1;if(1===a.length){var d=a[0].pathElement||a[0];if(d&&d.externalPath)for(r=0;r<d.externalPath.length;r++)if("annotGroupNode"===d.externalPath[r].name){l=!0;break}}if(!0===l){var c=d.externalPath[d.externalPath.length-1].annotID,u=ContextedSingleton.get(_this.frmWindow.experience.ctx,"ANNOTATION_MANAGER");if(u){var h=u.getAnnotationTypeWithID(c),p=_this.frmWindow.getViewer(),g=_this.frmWindow.experience.ctx;if("text"===h)p.shapeEditionData={id:c},CommandsManager.getCommands(g).AnnotationCommand3DText&&CommandsManager.getCommands(g).AnnotationCommand3DText.isEnabled()&&CommandsManager.getCommands(g).AnnotationCommand3DText.begin();else{var f={x:e.event._currentPosition.x,y:e.event._currentPosition.y};p.shapeEditionData={point:f},CommandsManager.getCommands(g).AnnotationCommand3DEditShape&&CommandsManager.getCommands(g).AnnotationCommand3DEditShape.isEnabled()&&CommandsManager.getCommands(g).AnnotationCommand3DEditShape.begin()}}}}}},this.countRender=0,this.countBeforeRender=1,this.modelPrevLoadCount=0,this.renderTime=0,this.postCreate=function(){var e,t=this.args;t&&t.visu&&!0!==t.visu.showReferenceAxisSystem&&hideRefAxisCount++,(viewpoint=this.frmWindow.getViewer().currentViewpoint)&&(viewpoint.control.lockZ=!0,viewpoint.control.setRotationSpeed(3.5)),viewer=this.frmWindow.getViewer();try{e=this.pad3DViewer?this.getRootBag():null}catch(e){}if(frmWindow=this.frmWindow,null===e&&(this.rootbag=new Node3D("RootBag"),viewer.addNode(this.rootbag),e=this.rootbag),this.modelLoader=new ModelLoader({node:e,viewer:viewer}),"DS/3DPlayModelViewer/3DPlayModelViewer"===this.args.input.experience.filneame&&this.modelLoader.setNoMeshInRAM(!0),this.modelLoader.setViewer&&this.modelLoader.setViewer(viewer),t.modelLoader&&void 0!==t.modelLoader.readDecoration&&(this.modelLoader.readDecoration=t.modelLoader.readDecoration),this.modelLoader.setOnProgressCallback(this.onModelLoadingProgression),this.modelLoader.setOnLoadedCallback(this.onModelLoadingCompleted),this.modelLoader.setOnErrorCallback(this.onModelLoadingError),this.token=CSOManager.onAdd(this.onSelectCallback),this.pad3DViewer&&this.pad3DViewer.getController()._BIProxy.addEvent("ApplyNGFilter",function(){try{Tracker.trackPageEvent("interactions","6wTags",this.experience.getInformationsOnAsset().type)}catch(e){}this.onModelLoadingStarted(!1)},this),viewer.getBagNode=function(){return logger.error("Please use 3DPlayExperience.getRootBag() rathen the Viewer.getBagNode()"),this.getRootBag()}.bind(this),viewer.deleteSceneGraphState=function(e){var t=this.getSceneGraphOverrideSetManager();if(t)for(var i=t.getNumberOfSceneGraphOverrideSets();i--;){var n=t.getSceneGraphOverrideSetAt(i);n&&n.privateName===e&&(t.removeSceneGraphOverrideSetAt(i),n.helper&&(n.helper.dispose(),n.helper=null),n.dispose&&n.dispose())}},viewer.getSceneGraph=function(e){var t=this.getSceneGraphOverrideSetManager();if(t)for(var i=t.getNumberOfSceneGraphOverrideSets();i--;){var n=t.getSceneGraphOverrideSetAt(i);if(n&&n.helper&&n.helper.name===e)return n.helper}return null},viewer.createSceneGraph=function(e,t){var i=this.getSceneGraph(e);if(void 0===t&&(t=this.getBagNode()),!i&&t){var n=new SceneGraphOverrideSet(t),r=this.getSceneGraphOverrideSetManager();r&&r.pushSceneGraphOverrideSet(n)&&(i=n.helper=new SceneGraphHelper(n,e))}return i},this.EventDisposer.add(this.subscribe("ASSET/CHANGE",function(e){_this.reframeConfiguration.hasViewpointSet=!1,SessionManager.clearSession()})),this.EventDisposer.add(this.subscribe("ASSET/LOADINGFINISHED",function(t){if(_this&&ExperiencesList.is3DPlay3DExperience(_this)){if(_this.modelFailure){try{var i=_this.getInformationsOnAsset();Tracker.trackPageEvent("errors","no_access",i.type)}catch(e){}_3DPlay.displayNotification({ctx:t.ctx,msg:NLS3DPlay.LoadingDocument404})}else if(0===_this.getRootBag().getBoundingSphere().radius&&"FILE"===_this.currentProvider&&!_this.hadLoadingError){try{i=_this.getInformationsOnAsset();Tracker.trackPageEvent("errors","input_no_geometry",i.type)}catch(e){}_3DPlay.sendEvent(_this.ctx,eventType.notif,Notification.warning,{msg:NLS3DPlay.LoadingError_NO_GEOMETRY})}var n=e.getChildByName("AxisSystems");n&&(void 0===frmWindow.hello?(frmWindow.hello=!0,n.setVisibility(!0)):n.setVisibility(frmWindow.hello));var r=_this.args.input.annotData;r&&Environment.get("3DPlay.PersistedAnnotationsEnabled")&&setTimeout(function(){let e=AnnotationManagerUtils.getAnnotationManager(ctx);e&&e.drawAnnotationsFromJSON(r)},200)}})),this.autoReframe=!0,this.useSession){this.reframeConfiguration.viewpointCB=function(e){SessionManager.setSessionEntry("viewpoint",e)},this.waitingCammandsForLoad=this.waitingCammandsForLoad||[],this.waitingCammandsForLoad.push(new Promise(function(e){this.subscribe("COMMAND/READY/ANNONATIONTOUR",e)}.bind(this)));var i=function(){var e=AnnotationManagerUtils.getAnnotationManager(this.args.ctx);e&&SessionManager.isReady()&&SessionManager.setSessionEntry("annotations",e.saveAnnotationsToJSON(void 0,!0))}.bind(this);this.subscribe("3DPLAY/ANNONATION/ADD",i,!0),this.subscribe("3DPLAY/ANNONATION/UPDATE",i,!0),this.subscribe("3DPLAY/ANNONATION/REMOVE",i,!0),this.subscribe("3DPLAY/ANNONATION/NOTINSESSION",function(){SessionManager.setSessionEntry("annotations",void 0)},!0);var n=this;function r(e){SessionManager.isReady()&&(_this&&e&&"DMUSection"===e.dmuObject.getType()||"DMUMeasure"===e.dmuObject.getType()&&!e.dmuObject._isInCreationState)&&_this.updateSession()}this.disposeFunctions.add(function(){n=null,i=null}),SessionManager.register({key:"annotations",clearCB:function(e){AnnotationManagerUtils.getAnnotationManager(n.args.ctx,n.frmWindow).deleteAllAnnotations(),e()},readCB:function(e,t,i){AnnotationManagerUtils.getAnnotationManager(n.args.ctx,n.frmWindow).drawAnnotationsFromJSON(e,!0),i()}}),Tracker.pause(!0),this.addViewpointChangeCB(this.reframeConfiguration.viewpointCB),Tracker.pause(!1),SessionManager.register({key:"viewpoint",readCB:function(e,t,i){_this.autoReframe=!1,_this.reframeConfiguration.hasViewpointSet=!0,_this.setCurrentViewpoint(e),_this.frmWindow.getViewer().animate(),setTimeout(i,20)}}),SessionManager.register({key:"VisuViewSettings",readCB:function(e,t,i){viewer.applyViewPanelSettings(e),i&&i()}}),SessionManager.register({key:"pgpFromServer",readCB:function(e,t,i){(App.is3DSpace()||App.is3DPlay())&&PADSettingsMgt.getSetting("pgpFromServer")!==e&&(PADSettingsMgt.setSetting("pgpFromServer",e),_this.refresh(!0)),i&&i()},writeCB:function(){return PADSettingsMgt.getSetting("pgpFromServer")},clearCB:function(e){PADSettingsMgt.setSetting("pgpFromServer",widget.getValue("pgpFromServer")),e&&e()}}),SessionManager.register({key:"DMU",clearCB:function(e){let t=DMUContextManager.getReviewContext({context:_this.pad3DViewer});t&&t.getTransientReviewBag().removeDMUObjects(),e&&e()},readCB:function(e,t,i){new DMUMeasureSectionExportImportAPI({ctxViewer:_this.pad3DViewer}).importModel(e),i&&i()}});var s=DMUContextManager.getEventsController({context:this.pad3DViewer});s&&(this.DMUTokens=[s.addEvent("onDMUObjectInitialized",r)],this.DMUTokens.push(s.addEvent("onDMUObjectDeleted",r)),this.disposeFunctions.add(function(){_this.DMUTokens.forEach(e=>{s.removeEvent(e)}),_this.DMUTokens=[],s=null}))}this.updateSession=async function(){if(DMUContextManager.getReviewContext({context:this.pad3DViewer})){let e=await new DMUMeasureSectionExportImportAPI({ctxViewer:this.pad3DViewer}).exportModel();e?SessionManager.setSessionEntry("DMU",e):console.error("error exportModel NULL")}},this.EventDisposer.add(this.subscribe("ASSET/LOADINGSTARTED",function(){_this.hadLoadingError=!1,_this.modelFailure=!1,_this.oldradius=0,_this.autoReframe=!_this.reframeConfiguration.hasViewpointSet,_this.reframeConfiguration.userclicked=!1}));this.addCallbacks({asset:{LoadingFinished:function(){_this.autoReframe&&viewpoint.reframe(void 0,0),viewer.render({updateInfinitePlane:!0})}}});var o=function(){_this.autoReframe=!1,_this.reframeConfiguration.userclicked=!0};this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onLeftMouseDown",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onRightMouseDown",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onMiddleMouseDown",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onMouseWheel",o)),this.evtTokenMouse.push(VisuEventsManager.addEvent(this.frmWindow.getViewerFrame(),"onTouch",o)),this.PanelManager.createTopMenu({ctx:t.ctx,container:this.frmWindow.getUIFrame(),experience:this,showBubbleMenu:this.args.options.showBubbleMenu}),this.PanelManager.createDefaultHelp(),this.disposeFunctions.add(function(){o=null})},this.disposeFunctions.add(function(){frmWindow=null,viewpoint=null,viewer=null,_this=null})},initExperienceBase:function(e,t){this.frmWindow._experienceBase=e,t&&t(0)},requestNewExperienceBase:function(){this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.disposeExperienceBase(),this.experienceBase._ManagerSet.unInitialize(),this.experienceBase.Clean(),this.frmWindow._experienceBase=null,this.experienceBase.webApplication=null,this.experienceBase.modelLoader=null,this.experienceBase=null),this.experienceBase=new VCXExperienceBase(null),this.experienceBase.webApplication=this,this.frmWindow._experienceBase=this.experienceBase,this.initExperienceBase(this.experienceBase),this.experienceBase._ManagerSet.initialize();var e=this.experienceBase._ManagerSet.getManager("VCXContextManager");return e&&e.setFrameWindow(this.frmWindow),this.experienceBase._ManagerSet.postInitialize(),e&&e.setRootNode(this.getRootBag()),this.profileFrame=Profiler.start("Runloop"),this.runloop=new Runloop({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase.webApplication=this,this.experienceBase},requestNewExperienceBaseAsync:function(){var e=this;ProbesManager.begin("requestNewExperienceBaseAsync");var t=UWA.Promise.resolve().then(function(){return e.runloop&&(e.runloop.stop(),e.runloop.dispose(),e.runloop=null),e.experienceBase&&e.disposeExperienceBase()}).then(function(){return e.experienceBase&&e.experienceBase._ManagerSet&&e.experienceBase._ManagerSet.unInitialize(!0)}).then(function(){return e.experienceBase&&(e.experienceBase.Clean(),e.experienceBase.webApplication=null,e.experienceBase=null),e.experienceBase=new VCXExperienceBase(null),e.frmWindow._experienceBase=e.experienceBase,e.experienceBase.requestPromise=t,e.experienceBase.initialize&&e.experienceBase.initialize(e)}).then(function(){return e.experienceBase.webApplication=e,new UWA.Promise(function(t,i){e.initExperienceBase(e.experienceBase,t)})}).then(function(){return e.experienceBase._ManagerSet.initialize(!0)}).then(function(){var t=e.experienceBase._ManagerSet.getManager("VCXContextManager");if(t){t.setFrameWindow(e.frmWindow);var i=e.getRootBag();t.setRootNode(i),e.frmWindow.getViewer().addNode(i)}return e.experienceBase._ManagerSet.postInitialize(!0)}).then(function(){ProbesManager.end("requestNewExperienceBaseAsync")}).then(function(){return e.profileFrame=Profiler.start("webApplication::frame"),e.runloop=new Runloop({data:e,func:e.runloopFunc}),e.runloop.start(),e.experienceBase});return t},runloopFunc:function(e){this.profileFrame.start();var t=this.profileFrame.addProfile("3DPlay::Step");if(this.skipRender=!1,this._step.apply(this,[arguments[0].time,arguments[0].profiler]),t.stop(),this.experienceBase){var i=this.experienceBase._ManagerSet.getManager("VCXContextManager"),n=UWA.extend({viewer:this.frmWindow.getViewer()},e,!0);if(n.profiler=this.profileFrame.addProfile("managerSet::update"),this.experienceBase._ManagerSet.update(n),this.skipRender)this.skipRender=!1;else{var r=this;i.applyToViewers(function(e){e._modelEvent&&!e.registredCBs&&(e.registredCBs={preToken:e._modelEvent.subscribe({event:"PreRender"},function(e){e.profiler=r.profile_animate.addProfile("preRender"),r.experienceBase._ManagerSet.preRender(e),r.profile_render=r.profile_animate.addProfile("render")}),postToken:e._modelEvent.subscribe({event:"PostRender"},function(e){e.renderingTime=r.profile_render.stop(),e.profiler=r.profile_animate.addProfile("postRender"),r.experienceBase._ManagerSet.postRender(e)})},e.defaultAnimationLoop=!1,r.disposeFunctions.add(function(){r=null})),r.profile_animate=r.profileFrame.addProfile("viewer["+e.id+"]::animate"),e.animate(),r.profile_animate.stop()}),this.nbrender=this.nbrender||0,this.nbrender++}n.viewer=this.viewer?i.getMainViewer():null,n.profiler=this.profileFrame.addProfile("managerSet::postUpdate"),this.experienceBase._ManagerSet.postUpdate(n),this.profileFrame.stop()}else this.frmWindow.getViewer().animate()},dispose:function(e){if(this.removeViewpointChangeCB(this.reframeConfiguration.viewpointCB),CSOManager.unsubscribe(this.token),this.token=null,this.evtTokenMouse&&(this.evtTokenMouse.forEach(function(e){VisuEventsManager.removeEventFromToken(e)}),this.evtTokenMouse=void 0),this.noGeoTimO&&clearTimeout(this.noGeoTimO),this.noGeoInt&&clearInterval(this.noGeoInt),endEdit&&App.isInWidget()&&widget.removeEvent("endEdit",endEdit),this.stats&&(this.stats.dispose&&this.stats.dispose(),this.stats=null),_3DPlay.endAllCommands({ctx:this.ctx,resetDefaultCmd:!0}),this.publish("EXPERIENCE/DISPOSE",{exprience:this}),this.intervalTimer&&clearInterval(this.intervalTimer),this.modelLoader.abort(),this.modelLoader.dispose&&this.modelLoader.dispose(),this.modelLoader=null,this.pad3DViewer){this.deletePad3DViewerCBs();var t=!1;if(!0!==(e=e||{}).disposeFrameWindow&&void 0!==e.disposeFrameWindow||(t=!0,e.disposeFrameWindow=!1),!1===e.disposeFrameWindow&&this.experienceBase&&this.experienceBase._ManagerSet){var i=this.experienceBase._ManagerSet.getManager("VCXContextManager");i&&(i._nRootNode=null)}var n=this.frmWindow.getViewer();if(this.viewerVisuModeCB.forEach(e=>{n.unsubscribe(e)}),delete this.viewerVisuModeCB,n.deleteSceneGraphState=null,n.getSceneGraph=null,n.createSceneGraph=null,n.getBagNode=null,this.experienceBase){this.frmWindow._experienceBase=null;var r=this;this.disposeExperienceBase(function(){r.runloop&&(r.runloop.stop(),r.runloop.dispose(),r.runloop=null);var e=r.experienceBase&&r.experienceBase._ManagerSet&&r.experienceBase._ManagerSet.unInitialize();e||(e=new UWAPromise(function(e){e()})),e.then(function(){r.experienceBase._ManagerSet.getManager("VCXContextManager").applyToViewers(function(e){e.registredCBs&&(e.defaultAnimationLoop=!0,e.disposed||(e._modelEvent.unsubscribe(e.registredCBs.preToken),e._modelEvent.unsubscribe(e.registredCBs.postToken)),delete e.registredCBs,e.animate())}),r.experienceBase&&(r.experienceBase.Clean(),r.experienceBase.webApplication=null,r.experienceBase=null),r=null})})}if(this.pad3DViewerConfig.changeVisuModeCmdAvailability&&(this.pad3DViewer.changeVisuModeCmdAvailability=null,this.pad3DViewer.changeVisuModeCmdAvailability=this.pad3DViewerConfig.changeVisuModeCmdAvailability,this.pad3DViewerConfig.changeVisuModeCmdAvailability=null),this._parent(e),t){if(this.pad3DViewer){var s=this.pad3DViewer.getFrameWindow();s&&s.removeReviewModel&&s.removeReviewModel();try{this.pad3DViewer.getController()._BIProxy._biFilter.die()}catch(e){}this.pad3DViewer.destroy(),s._viewpoint=null,s._sceneGraphTree=null,s._private_sceneGraph=null,this.repLoadingStuff&&(this.repLoadingStuff.hide(),this.repLoadingStuff.parentNode.removeChild(this.repLoadingStuff),this.repLoadingStuff=null)}}else{this.resetWidgetPreferences(),n.setPicking(this.pad3DViewerConfig.picking),n.setPrePicking(this.pad3DViewerConfig.pPicking),this.pad3DViewer.getFrameWindow().getViewer().currentViewpoint.setDefaultController(!0,this.pad3DViewerConfig.ControlMode),this.pad3DViewer.setRobotVisibility(this.pad3DViewerConfig.Robot),this.pad3DViewer.setDefaultProgressBarVisibility(this.pad3DViewerConfig.Progress),this.pad3DViewer.setAutomaticReframePolicy(this.pad3DViewerConfig.Reframe),this.pad3DViewer.setDefaultContextualMenuVisibility(!1),this.pad3DViewer.setDefaultContextualBarVisibility(!1),this.RuntimeMode.dynamicRepLoading&&(this.repLoadingStuff.hide(),this.repLoadingStuff.parentNode.removeChild(this.repLoadingStuff),this.repLoadingStuff=null),this.pad3DViewer.elements.container.addEventListener("dragenter",this.pad3DViewer._dndCB[0]),this.pad3DViewer.elements.container.addEventListener("dragover",this.pad3DViewer._dndCB[0]),this.pad3DViewer.elements.container.addEventListener("dragleave",this.pad3DViewer._dndCB[1]),this.pad3DViewer.elements.container.addEventListener("dragend",this.pad3DViewer._dndCB[1]),this.pad3DViewer.elements.container.addEventListener("drop",this.pad3DViewer._dndCB[2]),this.pad3DViewerConfig.toShow();var o=this.getRootBag();(o&&o.children&&o.children.length>0||this.pad3DViewer.getRoots().length>0)&&this.pad3DViewer._dropZoneContainer.elements.container.hide(),this.pad3DViewer._dropZoneContainer.options.mode=this.pad3DViewerConfig.DropMode}this.pad3DViewerConfig=null,this.pad3DViewer=null}else this._parent(e)},preCreate:function(){var e={visu:{antiAliasing:!0,useShadowMap:!0,infinitePlane:!0,displayGrid:!1,displayLines:!1,debugShadowLight:!1,debugBSphere:!1,debugBBox:!1,picking:!0,displayPicking:!0,prePicking:!1,displayprePicking:!1,highlight:{trapSelection:!1},autoUpdatePlane:!0,useMirror:!0,defaultAnimationLoop:!1,multiViewerFix:!0,useViewPanel:!0,viewPanelConfig:{uiConfig:{useShadingIllustration:!0}}},ui:{displayTree:Environment.isBoolActive("3DPlay.Debug.DisplayTree"),displayActionBar:!0}};Environment.isSet("3DPlay.VisuPanel")&&(e.visu.useViewPanel=!0),window.nearFarBigScale=!0,this.args=UWA.extend(e,this.args,!0),this.args.touch="ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0,(App.is3DSwym()||App.is3DDrive())&&(this.mabModel&&this.mabModel.sections&&this.mabModel.sections.push({id:"QualityManager",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"}),this.tabletMabModel&&this.tabletMabModel.sections&&this.tabletMabModel.sections.push({id:"QualityManager",nls:"3DPlay/3DPlayExperience3D",rsc:"3DPlay/3DPlayExperience3D"}))},_step:function(){if(!1===this.modelLoadComplete){if(!this.does3DPlayDoTheRequestNewExperienceBase)return void(this.forceRender=!0);this.skipRender=!0;var e=!1,t=!1,i=this.frmWindow.getViewer();if(this.forceRender)this.forceRender=!1,e=t=!0;else if(this.newPart)if(this.newPart=!1,"Optimized"===this.args.options.loadAnimation){if(this.autoReframe){var n=i.getRootNode().getBoundingSphere().radius;1.3*this.oldradius<n&&(t=!0,e=!0,this.oldradius=n,this.modelPrevLoadCount=this.modelLoadCount)}if(!t){var r=this.modelPrevLoadCount+5;this.modelTotalCount>0&&(r=this.reframeConfiguration.userclicked?this.modelPrevLoadCount+1:this.modelPrevLoadCount+Math.max(1,.08*this.modelTotalCount)),this.modelLoadCount>r&&(this.modelPrevLoadCount=r,t=!0)}}else"Full"===this.args.options.loadAnimation?(e=!0,t=!0):"None"===this.args.options.loadAnimation||this.modelLoadCount>this.modelPrevLoadCount+this.args.options.loadAnimation&&(this.modelPrevLoadCount=this.modelLoadCount,e=!0,t=!0);if(e&&this.autoReframe&&i.currentViewpoint.reframe(),t||this.reframeConfiguration.userclicked)this.skipRender=!1,i.render({updateInfinitePlane:!0});else{var s=i.div.clientWidth||1,o=i.div.clientHeight||1;i.SCREEN_WIDTH===s&&i.SCREEN_HEIGHT===o||(this.skipRender=!1)}}this._parent()},preRenderCB:function(){},postRenderCB:function(){},setOnLoadedCallback:function(e){this.modelLoader&&this.modelLoader.setOnLoadedCallback(e)},setOnProgressCallback:function(e){this.modelLoader&&this.modelLoader.setOnProgressCallback(e)},getModelLoader:function(){return this.modelLoader},getRootBag:function(){if(this.pad3DViewer){var e=this.pad3DViewer.getRootBagPath();if(e)return e.getLastElement()}if(this.rootbag)return this.rootbag;var t=this.frmWindow.getViewer();return t.getBagNode?t.getBagNode():t.getRootNode()},createPad3DViewerCBs:function(){this.subscribeToReloadEvents(),this.configureController=function(e){!1===this.isLoadingFinished()&&this.clearView(),logger.log("DEBUG-configureController",e),this.pad3DViewer.setDefaultStreamToLoad(e.needCGR||e.haveCGR||"index"!==Preference.get(prefName));var t=this.pad3DViewer.getController();if(e.needMeshInRam)if("ENOPAD"===this.currentProvider){this.pad3DViewer.getRoots()[0];this._haveMeshInRam(t)||t.lockGlobalMeshInRAM()}else Environment.isSet("3DPlay.noMeshInRam.File")&&this.modelLoader.setNoMeshInRAM(!e.needMeshInRam);else"ENOPAD"===this.currentProvider?t.unlockGlobalMeshInRAM():Environment.isSet("3DPlay.noMeshInRam.File")&&this.modelLoader.setNoMeshInRAM(!e.needMeshInRam)},this.isReloadRequired=function(e){var t=!e||void 0===e.needCGR||e.needCGR,i=!(!e||void 0===e.needMeshInRam)&&e.needMeshInRam,n=!(!e||void 0===e.needMaterial)&&e.needMaterial,r=!0,s=!0,o=!0;if("ENOPAD"===this.currentProvider){var a=this.pad3DViewer.getController();r="cgr"===a.getDefaultStreamToLoad(),a.hasMeshInRAM&&(s=this._haveMeshInRam(a)),(o=!a.areDataLoadedWithoutMaterial())||0!==this.pad3DViewer.getRoots().length||(o=!0),t&&!r&&this.enopadStatistics&&this.enopadStatistics.nbCgrLoaded>0&&0===this.enopadStatistics.nbThbLoaded&&(r=!0)}else s=!this.modelLoader.getNoMeshInRAM();var l={needCGR:t&&!r,needMaterial:n&&!o,needMeshInRam:i&&!s,haveCGR:r};return logger.log("DEBUG-isReloadRequired",l),l};var e=this,t=window.widget;if(t){t.getValue("appId");if(!App.is3DDrive()&&!App.is3DSwym())for(var i in this.addENOPADProperty=function(e){this.widgetPreferences[e.prop]={name:e.prop,defaultValue:e.defaultValue,type:e.type,label:e.label,update:e.update||function(t){return PADSettingsMgt.setSetting(e.prop,void 0!==t&&t),"ENOPAD"===this.currentProvider}.bind(this)}},this.resetWidgetPreferences(),this.RuntimeMode.dynamicRepLoading&&(this.widgetPreferences["3DPlay.displayCandidateQueue"]={name:"3DPlay.displayCandidateQueue",defaultValue:!0,type:"boolean",label:prefs.displayCandidateQueue,update:function(e){return PADSettingsMgt.setSetting("enopad3dviewer_displayCandidateQueue",e?"ALWAYS":"OFF"),this.pad3DViewer.setupLoadingBoxesEngine(),!1}.bind(this)}),this.widgetPreferences[prefName]={name:prefName,defaultValue:"index",type:"list",label:prefs.Label,options:[{label:prefs.index,value:"index"},{label:prefs.base,value:"base"}],update:function(e){return e&&this.configureController&&this.configureController({needCGR:"high"===e||"base"===e,needMeshInRam:"high"===e}),"ENOPAD"===this.currentProvider}.bind(this)},this.widgetPreferences[prefName].options.push({label:prefs.high,value:"high"}),this.widgetPreferences[prefName+".automaticQualityAdaptation"]={name:prefName+".automaticQualityAdaptation",defaultValue:!1,type:"boolean",label:prefs.automaticQualityAdaptation},this.addENOPADProperty({prop:"enopad3dviewer_flexibleAssemblySupportActivated",defaultValue:!1,type:this.pad3DViewer&&this.pad3DViewer.getController&&!App.isOnCloud()&&!this.pad3DViewer.getController()._elasticLoadingGranted?"boolean":"hidden",label:NLSPAD3DViewer.flexibleAssemblySupport}),this.addENOPADProperty({prop:"pgpFromServer",defaultValue:!0,type:"boolean",label:NLSPADUtuils.enopad3dviewer_pgpFromServer_label,update:function(e){return PADSettingsMgt.setSetting("pgpFromServer",void 0!==e&&e),SessionManager.setSessionEntry("pgpFromServer",e),"ENOPAD"===this.currentProvider}.bind(this)}),void 0===Preference.get("pgpFromServer")&&Preference.set("pgpFromServer",!0),"auto"===Preference.get(prefName)&&(Preference.set("3DPlay.CGRPolicy.automaticQualityAdaptation",!0),Preference.set(prefName,"index")),this.widgetPreferences)this.widgetPreferences.hasOwnProperty(i)&&this.widgetPreferences[i].update&&this.widgetPreferences[i].update(Preference.get(i))}this.pad3DViewerTokens=this.pad3DViewerTokens||[];var n=void 0!==this.args.options.callbacks?this.args.options.callbacks.enopad:void 0;if(n)for(var r in n){var s=this.pad3DViewer.subscribe({event:r},n[r]);this.pad3DViewerTokens.push(s)}if(this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLeafReferenceLoaded"},function(){e.modelLoadCount++,e.newPart=!0})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({evnt:"onLeafReferenceUnloaded"},function(){e.newPart=!0})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onUrlLoaded"},function(t){e.enopadStatistics=t})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootRemoved"},function(){if(e.pad3DViewer._dropZoneContainer){var t=e.pad3DViewer._dropZoneContainer.elements.container;t.isHidden()||t.hide()}})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRootAdded"},function(e){WUXEvents.publish({event:"onRootAdded",data:e})})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingComplete"},function(){e.onLoadingFailure||(e.forceRender=!0,e.onModelLoadingCompleted())})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRepresentationLoaded"},function(t){Environment.isSet("3DPlay.FilterFEMRep")&&e.filterFEM(t)})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRefreshCompleted"},function(){})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onRefreshBegin"},function(){e.publish("ASSET/LOADINGSTARTED",{refreshed:!0})})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},function(t){e.onLoadingFailure=!0;var i="LOAD";if(t&&t.message){var n=t.message.replace(" ","_");"Timeout_raised"===n&&(i=n)}_3DPlay.displayFatalError({ctx:e.args.ctx,msg:NLS3DPlay["LoadingError_"+i]})})),this.RuntimeMode.dynamicRepLoading){this.DynamicProgressUI=new WUXProgressBar({shape:"circular",infiniteFlag:!0,statusFlag:!1});this.DynamicProgressUI.height=40,this.DynamicProgressUI.repLoadingStuff=this.repLoadingStuff=new UWA.Element("div",{id:"PlayWeb-Spinner-DynRepLoading",events:{click:function(){this.repLoadingStuff.isHidden()||(this.DynamicProgressUI.playPause3DloadingFonticon.hasClassName("wux-ui-3ds-pause")?(this.DynamicProgressUI.pause(),this.pad3DViewer.getController().pauseProgressiveLoading()):(this.pad3DViewer.getController().resumeProgressiveLoading(),this.DynamicProgressUI.play()))}.bind(this)}}).inject(this.args.container),this.repLoadingStuff.style["z-index"]=10,this.DynamicProgressUI.inject(this.repLoadingStuff),this.DynamicProgressUI._playPause3DloadingFonticonTooltip=new Tooltip({target:this.DynamicProgressUI.repLoadingStuff,position:"right"}),this.DynamicProgressUI._playPause3DloadingFonticonTooltip.options.target.addEventListener("touchend",this.DynamicProgressUI._playPause3DloadingFonticonTooltip.toggle),this.DynamicProgressUI.playPause3DloadingFonticon=UWA.createElement("span",{class:"wux-ui-3ds wux-ui-3ds-1x",styles:{top:"17px",left:"17px",position:"absolute"}}).inject(this.repLoadingStuff),this.DynamicProgressUI.createAnimation=function(t){return new UWA.Fx(t.container,{duration:t.fadeDuration,transition:"linear",events:{onComplete:function(){e&&("fadeOut"===e.DynamicProgressUI.currentFade&&e.repLoadingStuff.hide(),e.DynamicProgressUI.currentFade="none")}}})},this.DynamicProgressUI._fadeOut=function(e){this.animation||(this.animation=this.createAnimation(e)),"fadeIn"===this.currentFade&&this.animation.stop(),this.animation.start({opacity:[parseFloat(this.repLoadingStuff.style.opacity),0]}),this.currentFade="fadeOut"},this.DynamicProgressUI._fadeIn=function(e){this.animation||(this.animation=this.createAnimation(e)),"fadeOut"===this.currentFade&&this.animation.stop(),this.animation.start({opacity:[parseFloat(this.repLoadingStuff.style.opacity),1]}),this.currentFade="fadeIn"};this.DynamicProgressUI.start=function(){this.repLoadingStuff.show(),this._fadeIn({container:e.repLoadingStuff,fadeDuration:1e3}),this.play()},this.DynamicProgressUI.play=function(){this.paused=!1,this.finishTimeout&&(clearTimeout(this.finishTimeout),this.finishTimeout=null),this.emphasize="info",this.value=30,this.infiniteFlag=!0,this.playPause3DloadingFonticon.style.left="16px",this.playPause3DloadingFonticon.removeClassName("fonticon-check"),this.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-play"),this.playPause3DloadingFonticon.addClassName("wux-ui-3ds-pause"),this._playPause3DloadingFonticonTooltip.setBody(NLSPADUtuils.PADStatusInfos_lock3DLoadingTooltip)},this.DynamicProgressUI.pause=function(e){this.paused=!0,this.infiniteFlag=!1,this.emphasize=e?"err":"info",e?this._playPause3DloadingFonticonTooltip.setBody(NLSPAD3DViewer.progressiveExpandFullMemory):(this.playPause3DloadingFonticon.style.left="17px",this.playPause3DloadingFonticon.removeClassName("fonticon-check"),this.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-pause"),this.playPause3DloadingFonticon.addClassName("wux-ui-3ds-play"),this._playPause3DloadingFonticonTooltip.setBody(NLSPADUtuils.PADStatusInfos_unlock3DLoadingTooltip)),this.value=100},this.DynamicProgressUI.finish=function(){if(!this.paused&&!this.finishTimeout){var t=this;this.finishTimeout=setTimeout(function(){t.finishTimeout=null,t.infiniteFlag=!1,t.emphasize="success",t.value=100,t._playPause3DloadingFonticonTooltip.setBody(NLSPAD3DViewer.PADStatus_loadingComplete),t.playPause3DloadingFonticon.style.left="16px",t.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-play"),t.playPause3DloadingFonticon.removeClassName("wux-ui-3ds-pause"),t.playPause3DloadingFonticon.addClassName("fonticon-check"),e&&t._fadeOut({container:e.repLoadingStuff,fadeDuration:1e3})},1e3)}},this.DynamicProgressUI.inject(this.repLoadingStuff),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartProgressiveLoad"},function(){e.DynamicProgressUI.start()})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onEndProgressiveLoad"},function(t){t.memoryFull?e.DynamicProgressUI.pause(!0):e.DynamicProgressUI.finish(),"timeout"===e.noGeoTimO&&(e.noGeoTimO=setTimeout(function(){if(!0!==e.frmWindow.getViewer().get360Mode()&&0===e.getRootBag().getBoundingSphere().radius){try{var t=this.getInformationsOnAsset();Tracker.trackPageEvent("errors","input_no_geometry",t.type)}catch(e){}_3DPlay.sendEvent(e.args.ctx,eventType.notif,Notification.warning,{msg:NLS3DPlay.LoadingError_NO_GEOMETRY}),e.noGeoInt=setInterval(function(){e.noGeoTimO="timeout",0!==e.getRootBag().getBoundingSphere().radius&&(e.notifScreen.removeNotifications(),clearInterval(e.noGeoInt))},1e3)}},4e3))})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onStartAsync"},function(){e.frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")})),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onLoadingFailure"},function(){var t=arguments[0];t&&t.message&&t.message.startsWith("Failed to retrieve object information.")&&(e.modelFailure=!0),e.onModelLoadingCompleted()})),this.disposeFunctions.add(function(){e=null})}},deletePad3DViewerCBs:function(){if(this.pad3DViewerTokens){for(var e=this.pad3DViewerTokens.length;e--;)this.pad3DViewer.unsubscribe(this.pad3DViewerTokens[e]);this.pad3DViewerTokens=[]}},createDom:function(e,t){if(this.args.options.pad3DViewer){this.currentProvider="ENOPAD",this.isFromTransition=!0,this.pad3DViewer=this.args.options.pad3DViewer,this.frmWindow=this.pad3DViewer.getFrameWindow(),this.RuntimeMode={dynamicRepLoading:PADSettingsMgt.getSetting("enopad3dviewer_dynamicRepLoading"),OOC:PADSettingsMgt.getSetting("enopad3dviewer_lightNodeModel")},this.customizePad3DViewer(),this._parent(e);var i=this;requirePromise.then(function(){t.apply(i),i=null})}else if(ENOPAD3DViewer){var n={context:this.args.ctx,height:"100%",minHeight:void 0!==this.args.minHeight?this.args.minHeight:0,viewerOptions:this.args.visu||{},uiOptions:this.args.ui||{},onModelLoaded:this.onModelLoadingCompleted,language:this.args.lang};if(this.RuntimeMode={binaryPrimitives:!1},this.args.workbenchs&&this.args.workbenchs.length>0){this.workbenchIndex=0;var r=this.args.workbenchs[this.workbenchIndex];this.workbenchIndex++,n.ignoreResetCommandManager=!0,n.workbenchModule=r.module,n.workbench=r.name+".xml",n.defaultCommand=void 0!==r.defaultCommand?r.defaultCommand:{ID:"",className:"DS.3DPlayCommands.EmptyCmd"},ProbesManager.begin("ActionBar_Ready"),this.actionBarProfile=ProbesManager.createProbe("ActionBar_"+r.name),this.actionBarProfile.begin()}else n.workbench=!1,n.defaultCommand={ID:"",className:"DS.3DPlayCommands.EmptyCmd"};var s={widget:window.widget?window.widget:n.widget,windowOptions:n};if(this.args.options.enopad&&(s=UWA.extend(s,this.args.options.enopad,!0)),this.args.input&&this.args.input.asset&&"guest"===this.args.input.asset.user||App.is3DDrive()||App.is3DSwym())s.offline=!0;else{var o,a=Preference.get("x3dPlatformId"),l=Environment.get("3DPlay.Plateform.3DSpaceUrl");if(l&&a)s.offline=!l.some(function(e){return e.platformId===a&&e.url}),s.offline&&(l.forEach(function(e){!o&&e.url&&(o=e.platformId)}),o?(s.offline=!1,Preference.set("x3dPlatformId",o),o=1):o=0),Tracker.trackPageEvent("infos","tenant_provider",a,void 0===o?2:o)}void 0===s.allowAuthoring&&(s.allowAuthoring=!0,this.RuntimeMode.allowAuthoring=s.allowAuthoring),s.authorizeSet3DStructure=!1,this.args.options.platformServices&&(s.plateformServices=this.args.options.platformServices),s.getPlatformServicesInBackground=!0,void 0===window.HybridApp&&this.args.input&&this.args.input.asset&&(this.args.input.asset.provider&&"EV6"===this.args.input.asset.provider||void 0!==this.args.input.asset.dtype)&&(s.getPlatformServicesInBackground=!1),s.windowOptions.robotVisibility=!1,s.interwidgetComAvailability=!1,s.enableFiltering=!0,s.interwidgetComAvailability=!0,ProbesManager.createProbe("Viewer_init").begin();var d=!1;ExperiencesList.isDynamicRepLoadingCompatibleExperience(this)?(s.dynamicRepLoading=!0,s.windowOptions.supportWorldOrientation=!0,s.windowOptions.defaultStatusBarVisibility=!1,s.binaryPrimitives=!0,d=!0):((Environment.isSet("3DPlay.OOC")||Environment.isSet("3DPlay.dynamicRepLoading"))&&(s.dynamicRepLoading=!0),(Environment.isSet("3DPlay.OOC")||Environment.isSet("3DPlay.binaryPrimitives"))&&(s.binaryPrimitives=!0),Environment.isSet("3DPlay.OOC")&&(d=!0)),Environment.isSet("3DPlay.DisableOOC")&&(d=!1),d&&(this.RuntimeMode.OOC=!0,s.visuProgressiveTileModel=!0),this.RuntimeMode.binaryPrimitives=s.binaryPrimitives,this.RuntimeMode.dynamicRepLoading=s.dynamicRepLoading,this.args.options.propertiesFacet&&this.args.options.propertiesFacet.length&&(s.enableSidePanel=!0),App.isInWidget()&&("ENOENBO_AP"!==App.getEmbeder()&&(s.windowOptions.BIMode="DUAL"),widget.setValue("addPlatformPref",!1)),App.is3DSwym()&&(s.windowOptions.viewerOptions.qualityManagerProfile="SWYM"),s.useWidgetLink=App.is3DPlay(),this.pad3DViewer=new ENOPAD3DViewer(s),this.frmWindow=this.pad3DViewer.getFrameWindow(),this.pad3DViewer.render().inject(this.args.container);var c=this,u=this._parent;c.disposeFunctions.add(function(){c=null}),this.pad3DViewerTokens.push(this.pad3DViewer.subscribe({event:"onReady"},function(){c.enopadInited||(Preference.get("3DPlay.Controller.Configuration")&&Preference.delete("3DPlay.Controller.Configuration"),Preference.get("3DPlay.lastVisuCommand.FILE")&&Preference.delete("3DPlay.lastVisuCommand.FILE"),Preference.get("3DPlay.lastVisuCommand.ENOPAD")&&Preference.delete("3DPlay.lastVisuCommand.ENOPAD"),PADSharedSettings.addSharedSettings(widget,["x3dPlatformId"]),PADSettingsMgt.setSetting("x3dPlatformId",Preference.get("x3dPlatformId")),ProbesManager.end("Viewer_init"),c.enopadInited=!0,u.apply(c,[e]),c.frmWindow.getViewer().animate(),requirePromise.then(function(){var e=[];VCXExperienceBase&&e.push(c.requestNewExperienceBaseAsync()),c.pad3DViewer&&e.push(c.customizePad3DViewer(s.windowOptions)),Promise.all(e).then(function(){t.apply(c),s=null}),c.subscribeOnce("EXPERIENCE/EXPERIENCEREADY",function(){Tracker.trackPageEvent("infos","loader_config",c.RuntimeMode?c.RuntimeMode.OOC?"OOC":c.RuntimeMode.dynamicRepLoading?"Dynamic":"Basic":"Base"),c=null}),u=null}))}))}else this._parent(FrameWindow3D,t)},customizePad3DViewer:function(e){PADSettingsMgt.setSetting("enopad3dviewer_staticMappingSupportActivated",!0),PADSettingsMgt.setSetting("enopad3dviewer_autoReloadOnMaterialModeEngaged",!1),this.createPad3DViewerCBs();var t=this.pad3DViewer.getViewer();this.pad3DViewerConfig={picking:UWA.clone(t.picking),pPicking:UWA.clone(t.pPicking),Robot:this.pad3DViewer.isRobotVisible(),Progress:this.pad3DViewer.getDefaultProgressBarVisibility(),Reframe:this.pad3DViewer.getAutomaticReframePolicy(),Menu:this.pad3DViewer.isDefaultContextualMenuVisible(),Bar:this.pad3DViewer.isDefaultContextualBarVisible(),toHide:function(e){e.hide(),this.hideshowElem=this.hideshowElem||[],this.hideshowElem.push(e)},toShow:function(){if(this.hideshowElem){for(var e=0;e<this.hideshowElem.length;e++)this.hideshowElem[e].show();this.hideshowElem=null}}},t.setPicking({activated:this.args.visu.picking,displayHL:this.args.visu.displayPicking,primitive:!1}),t.setPrePicking({activated:this.args.visu.prePicking,displayHL:this.args.visu.displayprePicking}),this.pad3DViewerConfig.changeVisuModeCmdAvailability=this.pad3DViewer.changeVisuModeCmdAvailability,this.pad3DViewer.changeVisuModeCmdAvailability=function(){};var i=this,n=this;let r=new Promise(function(t){require(["DS/PADUtils/PADWebInWinServices"],function(r){Promise.all([new Promise(function(t){var n=function(){try{if(i.pad3DViewer._dropZoneContainer&&i.pad3DViewer._dropZoneContainer.elements.container){i.pad3DViewerConfig.DropMode=i.pad3DViewer._dropZoneContainer.options.mode,i.pad3DViewer._dropZoneContainer.options.mode="none",i.pad3DViewer.elements.container.removeEventListener("dragenter",i.pad3DViewer._dndCB[0]),i.pad3DViewer.elements.container.removeEventListener("dragover",i.pad3DViewer._dndCB[0]),i.pad3DViewer.elements.container.removeEventListener("dragleave",i.pad3DViewer._dndCB[1]),i.pad3DViewer.elements.container.removeEventListener("dragend",i.pad3DViewer._dndCB[1]),i.pad3DViewer.elements.container.removeEventListener("drop",i.pad3DViewer._dndCB[2]);var e=i.pad3DViewer._dropZoneContainer.elements.container;e.isHidden()||(i.pad3DViewerConfig.toHide(e),t()),void 0!==i.intervalTimer&&(clearInterval(i.intervalTimer),this.intervalTimer=void 0)}else void 0===i.intervalTimer&&(i.intervalTimer=setInterval(n,2))}catch(e){void 0===i.intervalTimer&&(i.intervalTimer=setInterval(n,2))}};r.isWebInWinContext()||e&&!1===e.allowDnD?t():n()}),new Promise(function(t){var i=function(){var e=window.document.getElementsByClassName("pad_status");e&&((e=e[0])?(t(),n.pad3DViewerConfig.toHide(e)):setTimeout(i,50))};e&&!1!==e.defaultStatusBarVisibility&&!n.RuntimeMode.dynamicRepLoading?i():t()})]).then(function(){n=null,i=null,e=null,t()})},t)});var s=window.document.getElementById("BubbleContainer");return s&&!s.isHidden()&&this.pad3DViewerConfig.toHide(s),this.pad3DViewer.setRobotVisibility(!1),this.pad3DViewer.setDefaultProgressBarVisibility(!1),this.pad3DViewer.setAutomaticReframePolicy(!1),this.pad3DViewer.setDefaultContextualMenuVisibility(!1),this.pad3DViewer.setDefaultContextualBarVisibility(!1),this.frmWindow=this.pad3DViewer.getFrameWindow(),r},clearView:function(){if(this.notifScreen.removeNotifications(),this.autoReframe=!0,this.pad3DViewer&&"ENOPAD"===this.currentProvider&&this.pad3DViewer.getRoots().length>0){var e=PAD3DViewerModelServices.getRoots(this.pad3DViewer),t=[];e.forEach(function(){t.push(PAD3DViewerModelServices.getNodeID(e[0]))}),this.DynamicProgressUI&&this.DynamicProgressUI.finish(),this.pad3DViewer.removeRoots({pids:t})}else{this.xcadmodelLoader&&this.xcadmodelLoader.clear&&(this.xcadmodelLoader.clear(),this.xcadmodelLoader=void 0);var i=this.getRootBag();i&&i.children&&i.children.length>0&&i.removeChildren(),this.modelLoader.setSceneGraph(i),!1===this.modelLoadComplete&&(this.modelLoader.abort(),this.progress.hide())}this.frmWindow.getViewer().render({updateInfinitePlane:!0})},subscribeToReloadEvents:function(){var e=this.pad3DViewer.getViewer();this.viewerVisuModeCB=[];var t=function(e){this.pendingConfiguration||(this.pendingConfiguration={}),this.pendingConfiguration=function(){for(var e={},t=0;t<arguments.length;t+=1)for(var i=arguments[t]?arguments[t]:{},n=Object.keys(i),r=0;r<n.length;r+=1)e[n[r]]=i[n[r]];return e}(this.pendingConfiguration,e.configuration),this.pendingCancel=e.onCancel,this.timeoutConfiguration||(this.timeoutConfiguration=setTimeout(function(){this.checkReloadNeeded(this.pendingConfiguration,{onCancel:this.pendingCancel}),delete this.timeoutConfiguration}.bind(this),100))};this.viewerVisuModeCB.push(e.onVisuShadingFaceModeChange(function(e){!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),"Illustration"!==e.value&&"Wireframe"!==e.value||t.apply(this,[{configuration:visuModeOptions[e.value],onCancel:function(){e.viewer.setVisuShadingEdgeMode("NoEdges"),e.viewer.setVisuShadingFaceMode("Shaded")}.bind(this)}])}.bind(this))),this.viewerVisuModeCB.push(e.onMaterialModeChange(function(e){!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),this._materialModeChanged=!0;let t=visuModeOptions.MaterialMode;if(!0===e.value){this.currentProvider;this.checkReloadNeeded(t,{onCancel:function(){e.viewer.setMaterialMode(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onVisuShadingEdgeModeChange(function(e){!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),"NoEdges"!==e.value&&t.apply(this,[{configuration:visuModeOptions.Edges,onCancel:function(){e.viewer.setVisuShadingEdgeMode("NoEdges"),e.viewer.setVisuShadingMode("Shading")}.bind(this)}])}.bind(this))),this.viewerVisuModeCB.push(e.onAxisFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let t=visuModeOptions.AxisFilter;this.currentProvider;this.checkReloadNeeded(t,{onCancel:function(){e.viewer.setAxisFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onPlanesFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let t=visuModeOptions.PlanesFilter;this.currentProvider;this.checkReloadNeeded(t,{onCancel:function(){e.viewer.setPlanesFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onLinesFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let t=visuModeOptions.LinesFilter;this.currentProvider;this.checkReloadNeeded(t,{onCancel:function(){e.viewer.setLinesFilter(!1)}})}}.bind(this))),this.viewerVisuModeCB.push(e.onPointsFilterChange(function(e){if(!this.dontrecordVisuChange&&this.currentProvider&&Preference.set("3DPlay.DefaultVisualizationChanged."+this.currentProvider,!0),!0===e.state){let t=visuModeOptions.PointsFilter;this.currentProvider;this.checkReloadNeeded(t,{onCancel:function(){e.viewer.setPointsFilter(!1)}})}}.bind(this)))},_haveMeshInRam:function(e){var t=function(i){for(var n=i.children,r=0;r<n.length;r++)return SceneGraphNodeServices.isRepReference(n[r])?e.hasMeshInRAM(PAD3DViewerModelServices.getNodeID(n[r])):t(n[r]);return!1},i=this.pad3DViewer.getRoots()[0];return!!i&&t(i)},checkReloadNeeded:function(e,t){var i;if(e=e||{needCGR:!0},this.pad3DViewer&&(i=this.pad3DViewer.getFrameWindow()),i){var n=this.isReloadRequired(e);if(n.needCGR||n.needMeshInRam||n.needMaterial){var r=!Preference.get("3DPlay.CGRPolicy.automaticQualityAdaptation");return n.needMeshInRam&&(r="high"!==Preference.get("3DPlay.CGRPolicy")),void(r?this.confirmReloadBoxDisplayed||(this.confirmReloadBoxDisplayed=!0,ConfirmBox({this:this,warning:!1,container:i.getViewerFrame(),caption:CmdENOPADStreamNLS.Title,info:[n.needMeshInRam?CmdENOPADStreamNLS.Specific_Caption_NMIR:CmdENOPADStreamNLS.General_Caption,CmdENOPADStreamNLS.Confirm_General],checkBox:{text:CmdENOPADStreamNLS.CheckBox_Settings,callback:function(e){e&&Tracker.trackPageEvent("commands","enopadstream","automaticQualityAdaptation"),Preference.set("3DPlay.CGRPolicy.automaticQualityAdaptation",e)}},confirm:{callback:function(){this.confirmReloadBoxDisplayed=!1,this.reload(n),t.onConfirm&&t.onConfirm()},text:CmdENOPADStreamNLS.Button_Proceed},cancel:{callback:function(){this.confirmReloadBoxDisplayed=!1,t.onCancel&&t.onCancel()},text:CmdENOPADStreamNLS.Button_Cancel}})):(this.reload(n),t.onConfirm&&t.onConfirm()))}t.onConfirm&&t.onConfirm()}},reload:function(e){Tracker.trackPageEvent("commands","enopadstream","acceptReload",void 0,{needCGR:e.needCGR?1:0,needMeshInRam:e.needMeshInRam?1:0,needMaterial:e.needMaterial?1:0}),this.configureController(e),this.refresh(!0)},fromTransition:function(){return!0===this.isFromTransition&&(this.pad3DViewer.getController().toggleBetweenStandaloneAndSlaveMode("DUAL"),this.pad3DViewer.displayStatusBar(!1),this.modelName=UWA.clone(this.args.input.asset),this.onModelLoadingStarted(),this.isFromTransition=!1,this.onModelLoadingCompleted(),!0)},updateConnection:function(e,t){window.localStorage["3DPlayHybridApp"]&&window.HybridAppArgs&&window.HybridAppArgs.myAppsUrl?this.pad3DViewer.connectToPlatform({readyCB:t,allowAuthoring:!1}):t()},changeVisuSettingIfPossible:function(){if(ExperiencesList.is3DPlay3DExperience(this)){function e(){var e=this.frmWindow.getViewer();this.dontrecordVisuChange=!0,e.setVisuShadingMode("Shading"),e.setVisuShadingEdgeMode("NoEdges"),e.setMaterialMode("FILE"===this.currentProvider),this.dontrecordVisuChange=!1,logger.log("DEBUG-setDefaultVisualizationSetting")}if(logger.log("DEBUG-3DPlay.DefaultVisualizationChanged."+this.currentProvider,Preference.get("3DPlay.DefaultVisualizationChanged."+this.currentProvider)),1==Preference.get("3DPlay.DefaultVisualizationChanged."+this.currentProvider)){let t=this.frmWindow.getViewer(),i={needCGR:"Shaded"!==t.getVisuShadingFaceMode()||t.getAxisFilter()||t.getPointsFilter()||t.getPlanesFilter()||t.getLinesFilter()||"NoEdges"!=t.getVisuShadingEdgeMode()||t.getMaterialMode(),needMaterial:t.getMaterialMode(),needMeshInRam:"Illustration"===t.getVisuShadingFaceMode()};if(logger.log("DEBUG-targetVisuCommandConfiguration",i),i.needCGR){let t=!1,n="FILE"===this.currentProvider||!0===Preference.get(prefName+".automaticQualityAdaptation")||Environment.isSet("3DPlay.Plateform.Cloud",!0)&&!PADSettingsMgt.getSetting("enopad3dviewer_VISnVIOStatus")||"cgr"===this.pad3DViewer.getController().getDefaultStreamToLoad();n&&(t=n,i.needMeshInRam&&(t="FILE"===this.currentProvider||Environment.isSet(prefName,"high")||this._haveMeshInRam(this.pad3DViewer.getController()))),logger.log("DEBUG-canChangeConfigurationSilently",t),t?this.configureController(i):e.apply(this,[])}}else e.apply(this,[])}},loadModel:function(e,t,i){if(!1!==this.modelLoadComplete||"ENOPAD"!==this.currentProvider){var n=this.frmWindow.getViewer();t&&!1!==t.resetCameraOrientation&&!this.reframeConfiguration.hasViewpointSet&&n.currentViewpoint.resetCameraOrientation();var r=e?e.asset:this.args.input?this.args.input.asset:null,s="",o=r;if("string"==typeof o){if(""===o)return;s=o;var a=StringUtils.getExtension(o);""!==a&&"3dxml"!==(a=a.toLowerCase())&&this.modelLoader.setFileType(a)}else if(void 0===o.provider||null===o.provider||"file"===o.provider.toLowerCase()){s=o.filename;var l=o.serverurl;if(!(null!=l&&""!==l||null!=s&&""!==s))return}var d=this;if(this.disposeFunctions.add(function(){d=null,Network.disableHook()}),this.pad3DViewer&&o.provider&&"FILE"!==o.provider?this.currentProvider="ENOPAD":this.currentProvider="FILE",this.changeVisuSettingIfPossible(),this.donwlonadProgress||(this.donwlonadProgress=this.getPhaseProgress().registerSubProgress()),this.oldradius=0,this.onLoadingFailure=!1,(Environment.isSet("3DPlay.ProtoSMM")||Environment.isSet("3DPlay.ProtoConvertSpatial"))&&"BUFFER"===o.provider)this.modelLoader.setFileType("cgr"),this.modelName="buffer",this.modelLoader.loadModelFromBuffer(o.data);else if("ENOPAD"===this.currentProvider){var c;r=e.asset,this.pad3DViewer._lockCSONotification=!1,this.modelName=r.id=r.physicalid;try{c=PADUtilsServices.get3DSpaceUrl()}catch(e){}if(!c||r.tenant&&r.tenant!==Preference.get("x3dPlatformId"))return Tracker.trackPageEvent("infos","switch_tenant",r.tenant),Preference.set("x3dPlatformId",r.tenant),void this.pad3DViewer.connectToPlatform({readyCB:ProbesManager.createFunctionProbe("Enopad:connectToPlatform",function(){new UWAPromise(function(e){PADUtilsServices.updateWidgetSecPref({tenant:r.tenant,padsecurityctx:r.contextid,resolve:e,withPreference:!1})}).then(function(){PADSettingsMgt.setSetting("x3dPlatformId",r.tenant),d.loadModel(e,t,i),null}).catch(function(){Traker.trackPageEvent("error","switch_tenant",Preference.get("x3dPlatformId")),d.modelFailure=!0,d.onModelLoadingCompleted(),null})}),allowAuthoring:!1});try{this.PanelManager.tagger.activate(!1),this.pad3DViewer.getController()._BIProxy._biFilter.activate(),this.pad3DViewer.getController()._BIProxy.addEvent("ApplyNGFilter",function(){this.onModelLoadingStarted(!1)},this)}catch(e){}this.RuntimeMode.dynamicRepLoading?(!0===this.DynamicProgressUI.paused&&this.pad3DViewer.getController().resumeProgressiveLoading(),this.onModelLoadingStarted(!1)):this.onModelLoadingStarted(),r.Play3DXContent&&r.Play3DXContent.biProxyCtx?this.pad3DViewer.addRootNodesFromContent({json3DXContent:r.Play3DXContent,dispatch:!1}):"ENOStrRefinementSpecification"===r.dtype?this.pad3DViewer.addFilter([{objectId:r.physicalid}]):"R2VSURVEY"===r.provider?this.pad3DViewer.addR2Vs({objects:[r],reframe:!0,displayNotif:!1,dispatch:!1}):this.pad3DViewer.addRoots({objects:[r]},!1,!1)}else{o.originalType||(this.loadingAsset.size=0);try{this.pad3DViewer.getController()._BIProxy._biFilter.deactivate(),this.PanelManager.tagger.activate()}catch(e){}var u;if(ProbesManager.begin("TECHNO.loadmodel"),Network.hookNetwork(function(e){var t;return-1===e.indexOf(".js")&&(t={id:"Download",onStatistics:function(e){d.loadingAsset.size=e.DownloadSize},onProgress:function(e){if(0!==e.total){d.loadingAsset.size=e.total;var t=e.loaded/e.total;d.donwlonadProgress&&d.getPhaseProgress().setAbsoluteProgress(d.donwlonadProgress,t/1*100)}},onComplete:function(){d.getPhaseProgress().setAbsoluteProgress(d.donwlonadProgress,100),d.loadingAsset.Load_Session=ProbesManager.createProbe("Load_Session").begin()}}),ProbesManager.end("TECHNO.loadmodel"),t}),this.pad3DViewer&&(this.pad3DViewer._lockCSONotification=!1),s.indexOf("blob:")>-1?(this.modelName="blob",this.loadingAsset.Load_Session=ProbesManager.createProbe("Load_Session").begin()):(this.modelName=s.split("/").pop(),this.modelName.length>128&&(this.modelName=this.modelName.substr(this.modelName.length-128,this.modelName.length))),n.setWorldOrientation(WorldOrientation.ZUpYRight),"stpa"===o.format){u=!1;if(!o.localFile){var h=NLS3DPlay.LoadingError_FORMAT+":stpa";return d=!1,void _3DPlay.displayFatalError({ctx:this.args.ctx,msg:h})}require(["DS/XCADLoader/XCADModelLoader"],function(e){d.xcadmodelLoader=new e(d.frmWindow.getViewer(),d.modelLoader,o.localFile),d.xcadmodelLoader.setOnStartLoadingCB(function(){d.DynamicProgressUI.start()}),d.xcadmodelLoader.setOnEndLoadingCB&&d.xcadmodelLoader.setOnEndLoadingCB(function(e){e.memoryFull?d.DynamicProgressUI.pause(!0):d.DynamicProgressUI.finish(),d.modelLoadComplete=!0}),d.xcadmodelLoader.setObjectLoadedCB&&d.xcadmodelLoader.setObjectLoadedCB(function(){d.newpart=!0})})}else t&&t["3DXMLLoadOpts"]?this.modelLoader.loadModel(o,void 0,void 0,{applicativeContainers:t["3DXMLLoadOpts"]}):this.modelLoader.loadModel(o);this.onModelLoadingStarted(u)}n.render({updateInfinitePlane:!0}),this.forceRender=!0}else this.loadingpending=arguments},loadAsset:function(e,t,i,n){if(this.does3DPlayDoTheRequestNewExperienceBase?requirePromise.then(function(){this.requestNewExperienceBaseAsync().then(function(){this.publish("EXPERIENCEBASE/NEW",{data:this.experienceBase}),this.loadModel(e,t,i)}.bind(this))}.bind(this)):(this.runloop||(this.runloop=new Runloop({data:this,func:this.runloopFunc}),this.runloop.start(),this.profileFrame=Profiler.start("webApplication::frame")),this.loadModel(e,t,i)),this.pad3DViewer&&!this.isFromTransition){var r=this.pad3DViewer.getFrameWindow();r&&r.removeReviewModel&&r.removeReviewModel()}this._parent()},_testBrowser:TestBrowser,getScreenShot:function(e){var t=this.frmWindow.getViewer();t.save&&t.save();var i=t.currentViewpoint,n=window.devicePixelRatio>1?window.devicePixelRatio:1,r={data:null,width:Math.floor(t.SCREEN_WIDTH*n),height:Math.floor(t.SCREEN_HEIGHT*n)},s=document.createElement("canvas");s.width=e.width?e.width:r.width,s.height=e.height?e.height:r.height,i.getControl().update(),t.renderToTarget(r,i);var o=s.getContext("2d"),a=o.getImageData(0,0,s.width,s.height);a.width!==s.width&&e.onError("size error"),a.height!==s.height&&e.onError("size error");var l,d,c,u,h=(r.width-1)/(a.width-1),p=(r.height-1)/(a.height-1),g=r.data,f=a.data;if(1===h&&1===p){var m=a.height,v=4*a.width;for(d=0;d<m;d++)for(c=v*d,u=v*(m-d),l=v;l--;)f[c+l]=g[u+l]}else{var S=function(e,t,i,n,r){return r&&(t=n-t),i*t+e},D=a.height,w=a.width,P=r.height,y=r.width;for(d=0;d<D;d++){var C=Math.floor(p*d);for(l=0;l<w;l++)c=4*S(l,d,w,D),u=4*S(Math.floor(h*l),C,y,P,!0),f[c]=g[u],f[c+1]=g[u+1],f[c+2]=g[u+2],f[c+3]=g[u+3]}}o.putImageData(a,0,0,0,0,s.width,s.height),this._setScreenshotUI(s);var b=e.type?"image/"+e.type:"png";if(Environment.get("3DPlay.PersistedAnnotationsEnabled")){var E=this._getSvgScreenshot(s.toDataURL(b));e.onSuccess(E)}else"jpeg"===e.type?s.toBlob(function(t){e.onSuccess(t)},"image/jpeg"):"canvas"===e.type?e.onSuccess(s):e.onSuccess(s.toDataURL(b))},_getSvgScreenshot:function(e){this.frmWindow.getViewer().getBagNode();var t=this.frmWindow.getViewerFrame().getDimensions();let i=AnnotationManagerUtils.getAnnotationManager(_thatannot.args.ctx);var n="<Model>"+JSON.stringify(this.args.input.asset)+"</Model>",r="<Annotations>"+i.saveAnnotationsToJSON()+"</Annotations>",s="<svg width='"+t.width+"' height='"+t.height+"' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'> <image xlink:href='"+e+"' x='0' y='0' width='100%' height='100%'/>"+n+r+"</svg>",o=new Blob([s],{type:"image/svg+xml;charset=utf-8"});return(self.URL||self.webkitURL||self).createObjectURL(o)},_setScreenshotUI:function(){}};return"false"===window.localStorage["3DPlay.VCX"]&&(delete exp.requestNewExperienceBase,delete exp.requestNewExperienceBaseAsync),EXPERIENCE.extend(exp)});