define("DS/RTDriver/RTGroup",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger"],function(e,t,n){"use strict";return n.debug("RTGroup load"),e.extend(t,{init:function(e){this.groupId=e.groupId,this.groupName=e.groupName,this.users={}},addUser:function(e){this.users[e.getId()]=e},removeUser:function(e){delete this.users[e]},updateUser:function(e){this.users[e.getId()]=e},getUsers:function(){return this.users},getName:function(){return this.groupName},getId:function(){return this.groupId}})}),define("DS/RTDriver/RTDetectClient",["DS/RTProxyDriver/RTLogger"],function(e){"use strict";e.debug("RTDetectClient load");var t="1",n=!1;["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach(function(e){n||e in window&&(n=!0)}),e.debug("WebRTCCompatible = "+n);var i=!!(navigator.getDisplayMedia||navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia);e.debug("ScreenSharingCompatible = "+i);var o=navigator.platform.toUpperCase().indexOf("MAC")>=0;e.debug("isMac = "+o);var r=/(iPhone|iPod|iPad)/i.test(navigator.platform);return e.debug("isIOS = "+r),{setCallVersion:function(e){t=e},isIphone:function(){return-1!=navigator.platform.indexOf("iPhone")},getClientInfos:function(){return{WebRTCCompatible:n,ScreenSharingCompatible:i,userAgent:navigator?navigator.userAgent:null,appVersion:navigator?navigator.appVersion:null,platform:navigator?navigator.platform:null,hasMicrophone:!0,hasWebcam:!0,callVersion:t,isIOS:r,isMac:o}}}}),define("DS/RTDriver/RTUserStatus",[],function(){"use strict";return{Offline:"Offline",Away:"Away",Busy:"Busy",Online:"Online"}}),define("DS/RTDriver/RTDriver",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTProxyDriver","DS/RTDriver/RTUserStatus","DS/RTProxyDriver/RTLogger"],function(e,t,n,i,o){"use strict";return o.debug("RTDriver load"),e.extend(t,{init:function(e){var t=this;this.driver=void 0,this.jid=e.credentials.jid,this.options=e,this.driverName=e.driverName,o.debug("RTDriver Require : "+e.driverName),require(["DS/RTDriver/drivers/"+e.driverName],function(i){o.info("RTDriver driver "+e.driverName+" loaded"),t.driver=new i(e),t.driver&&(n.dispatch(n.eventName.GETSTATUSLIST,[t.getListOfStatus()]),t.connect())})},connect:function(){var e=this;o.debug("RTDriver login"),this.driver&&(this.driver.addEvent(n.eventName.CONNECTED,function(t){o.debug("RTDriver CONNECTED"),n.dispatch(n.eventName.CONNECTED,t),e.driver.getBuddylist()}),this.driver.addEvent(n.eventName.SIGNOUT,function(e){n.dispatch(n.eventName.SIGNOUT,e)}),this.driver.addEvent(n.eventName.BUDDYLISTBUILT,function(e){o.debug("RTDriver BUDDYLISTBUILT"),n.dispatch(n.eventName.BUDDYLISTBUILT,e)}),this.driver.addEvent(n.eventName.RESULTOFSEARCH,function(e){o.debug("RTDriver RESULTOFSEARCH"),n.dispatch(n.eventName.RESULTOFSEARCH,[e])}),this.driver.addEvent(n.eventName.RESULTOFSEARCHFORSEARCHAPI,function(e){o.debug("RTDriver RESULTOFSEARCHFORSEARCHAPI"),n.dispatch(n.eventName.RESULTOFSEARCHFORSEARCHAPI,[e])}),this.driver.addEvent(n.eventName.ONPRESENCERECEIVED,function(e){o.debug("RTDriver ONPRESENCERECEIVED"),n.dispatch(n.eventName.ONPRESENCERECEIVED,[e])}),this.driver.addEvent(n.eventName.STATUSUPDATED,function(e){o.debug("RTDriver STATUSUPDATED"),n.dispatch(n.eventName.STATUSUPDATED,[e])}),this.driver.addEvent(n.eventName.ONMESSAGERECEIVED,function(e){o.debug("RTDriver ONMESSAGERECEIVED"),n.dispatch(n.eventName.ONMESSAGERECEIVED,e)}),this.driver.addEvent(n.eventName.ONARCHIVERECEIVED,function(e){o.debug("RTDriver ONARCHIVERECEIVED"),n.dispatch(n.eventName.ONARCHIVERECEIVED,e)}),this.driver.addEvent(n.eventName.ONDATARECEIVED,function(e){o.debug("RTDriver ONDATARECEIVED"),n.dispatch(n.eventName.ONDATARECEIVED,e)}),this.driver.addEvent(n.eventName.DISCONNECTED,function(e){o.debug("RTDriver DISCONNECTED"),n.dispatch(n.eventName.DISCONNECTED,e)}),this.driver.addEvent(n.eventName.GROUPREMOVED,function(e){o.debug("RTDriver GROUPREMOVED"),n.dispatch(n.eventName.GROUPREMOVED,e)}),this.driver.addEvent(n.eventName.REMOVECONTACT,function(e){o.debug("RTDriver REMOVECONTACT"),n.dispatch(n.eventName.REMOVECONTACT,e)}),this.driver.addEvent("mediaSourceReady",function(e){o.debug("RTDriver mediaSourceReady"),n.dispatch("mediaSourceReady",e)}),this.driver.addEvent("start-streaming",function(e){o.debug("RTDriver start-streaming"),n.dispatch("start-streaming",e)}),this.driver.addEvent("connectTelWS",function(e){o.debug("RTDriver connectTelWS"),n.dispatch("connectTelWS",e)}),n.addEvent("getMedias",function(t){e.driver.getMedias(t)}),n.addEvent("uploadMedia",function(t){e.driver.uploadMedia(t)}),n.addEvent("coreview",function(t){e.driver.coreview(t)}),n.addEvent(n.eventName.LOGOUT,function(t){"XMPP"===e.driverName&&e.closeSession(),e.logout()}),n.addEvent(n.eventName.CLOSESESSION,function(t){e.closeSession()}),n.addEvent(n.eventName.SENDMSG,function(t){e.sendMessage(t)}),n.addEvent(n.eventName.SENDDATA,function(t){e.sendData(t)}),n.addEvent(n.eventName.SENDSYSMSG,function(t){e.sendSystemMsg(t)}),n.addEvent(n.eventName.SENDNOTIF,function(t){e.sendNotif(t)}),n.addEvent(n.eventName.GETSTATUS,function(t){e.getStatus(t)}),n.addEvent(n.eventName.GETALLSTATUS,function(t){e.getAllStatus(t)}),n.addEvent(n.eventName.SETSTATUS,function(t){e.setMyStatus(t.myStatus,t.statusMsg)}),n.addEvent(n.eventName.CREATEGROUP,function(t){e.addGroup(t)}),n.addEvent(n.eventName.ADDCONTACT,function(t){e.addContact(t.user,t.group)}),n.addEvent(n.eventName.REMOVEGROUP,function(t){e.removeGroup(t)}),n.addEvent(n.eventName.REMOVECONTACT,function(t){t.fromDriver||e.removeContact(t.user,t.group)}),n.addEvent(n.eventName.SEARCHCONTACT,function(t){e.searchContact(t)}),n.addEvent(n.eventName.RENAMEGROUP,function(t){e.renameGroup(t)}),n.addEvent(n.eventName.GETARCHIVES,function(t){e.getArchives(t)}),n.addEvent(n.eventName.CLEANARCHIVES,function(t){e.cleanArchives(t)}),n.addEvent("GETROOM",function(t){e.getRoom(t)}),n.addEvent("JOINROOM",function(t){e.joinRoom(t)}),n.addEvent("LEAVEROOM",function(t){e.leaveRoom(t)}),n.addEvent("discover",function(t){e.discover(t)}),n.addEvent("startCall",function(t){e.startCall(t)}),n.addEvent("webrtcIceCandidate",function(t){e.webrtcIceCandidate(t)}),n.addEvent("SDP",function(t){e.SDP(t)}),n.addEvent("endCall",function(t){e.endCall(t)}),n.addEvent("acceptCall",function(t){e.acceptCall(t)}),n.addEvent("callEventFromView",function(t){e.driver.onCallEventFromView(t)}),this.driver.addEvent("inviteSent",function(e){n.dispatch("inviteSent",e)}),this.driver.addEvent("callEvent",function(e){n.dispatch("callEvent",e)}),this.driver.addEvent("inviteToCall",function(e){n.dispatch("inviteToCall",e)}),this.driver.addEvent("callEnded",function(e){n.dispatch("callEnded",e)}),this.driver.addEvent("callAccepted",function(e){n.dispatch("callAccepted",e)}),this.driver.addEvent("webrtcIceCandidateReceived",function(e){n.dispatch("webrtcIceCandidateReceived",e)}),this.driver.addEvent("mediaReceived",function(e){n.dispatch("mediaReceived",e)}),this.driver.addEvent("SDPreceived",function(e){n.dispatch("SDPreceived",e)}),this.driver.addEvent("GROUP",function(e){n.dispatch("GROUP",e)}),this.driver.addEvent("ROOM",function(e){n.dispatch("ROOM",e)}),this.driver.addEvent("COREVIEW",function(e){n.dispatch("COREVIEW",e)}),this.driver.addEvent("roomLeft",function(e){n.dispatch("onLeaveRoom",e)}),this.driver.addEvent("roomJoined",function(e){n.dispatch("onJoinRoom",e)}),this.driver.addEvent("miscellaneous",function(e){n.dispatch("miscellaneous",e)}),this.driver.addEvent("discovered",function(e){n.dispatch("discovered",e)}),this.driver.addEvent("callInfo",function(e){n.dispatch("callInfo",e)}),this.driver.addEvent("callHistory",function(e){n.dispatch("callHistory",e)}),this.driver.addEvent("convInfo",function(e){n.dispatch("convInfo",e)}),n.addEvent("getCallInfo",function(t){e.driver.getCallInfo(t)}),n.addEvent("subConv",function(t){e.driver.subConv(t)}),n.addEvent("IAmTyping",function(t){e.driver.IAmTyping(t)}),n.addEvent("getRoomInfos",function(t){e.driver.getRoomInfos(t)}),n.addEvent("UPDATEROOM",function(t){e.driver.updateRoom(t)}),n.addEvent("JOINPUBLICROOM",function(t){e.driver.joinPublicRoom(t)}),n.addEvent("sipEvent",function(t){e.driver.sipEvent(t)}),n.addEvent("toRTC",function(t){e.driver.conversationEvent(t)}),this.driver.addEvent("conversation",function(e){n.dispatch("conversation",e)}),n.addEvent("callToRTC",function(t){e.driver.callEvent(t)}),this.driver.addEvent("call",function(e){n.dispatch("call",e)}),this.driver.addEvent("desktopApp",function(e){n.dispatch("desktopApp",e)}),this.driver.login())},startCall:function(e){this.driver.startCall(e)},endCall:function(e){this.driver.endCall(e)},acceptCall:function(e){this.driver.acceptCall(e)},webrtcIceCandidate:function(e){this.driver.webrtcIceCandidate(e)},SDP:function(e){this.driver.SDP(e)},sendData:function(e){e.from=this.jid,this.driver.sendData(e)},sendMessage:function(e){var t={};t.msg=e,t.from=this.jid,this.driver.sendMessage(t)},sendSystemMsg:function(e){e.from=this.jid,this.driver.sendSystemMsg(e)},sendNotif:function(e){e.from=this.jid,this.driver.sendNotif(e)},addGroup:function(e){this.driver.addGroup(e)},removeGroup:function(e){this.driver.removeGroup(e)},addContact:function(e,t){this.driver.addContact(e,t)},removeContact:function(e,t){this.driver.removeContact(e,t)},getStatus:function(e){this.driver.getStatus(e)},getAllStatus:function(e){this.driver.getAllStatus(e)},setMyStatus:function(e,t){this.driver.setPresence(e,t)},searchContact:function(e){this.driver.searchContact(e)},logout:function(){this.driver.logout(),n.removeEvent(n.eventName.SENDMSG),n.removeEvent(n.eventName.SEARCHCONTACT),n.removeEvent(n.eventName.GETARCHIVES),n.removeEvent(n.eventName.RENAMEGROUP),n.removeEvent(n.eventName.SENDDATA),n.removeEvent(n.eventName.SENDDATA),n.removeEvent("startCall"),n.removeEvent("webrtcIceCandidate"),n.removeEvent("SDP"),n.removeEvent("endCall"),n.removeEvent("acceptCall")},closeSession:function(){this.driver.setPresence(i.Offline,i.Offline)},getListOfStatus:function(){return i},renameGroup:function(e){this.driver.renameGroup(e)},getArchives:function(e){this.driver.getArchives(e)},cleanArchives:function(e){this.driver.cleanArchives(e)},getRoom:function(e){this.driver.getRoom(e)},joinRoom:function(e){this.driver.joinRoom(e)},leaveRoom:function(e){this.driver.leaveRoom(e)},discover:function(e){this.driver.discover(e)}})}),define("DS/RTDriver/RTUser",["UWA/Class","UWA/Class/Events","DS/RTProxyDriver/RTLogger","DS/RTDriver/RTUserStatus"],function(e,t,n,i){"use strict";return n.debug("3DIM - RTUser load"),e.extend(t,{init:function(e){this.userId=e.userId,this.userName=void 0===e.userName?this.userId:e.userName,this.status=i.Offline,e.status&&(this.status=i[e.status]?i[e.status]:i.Offline)},getId:function(){return this.userId},getName:function(){return this.userName},setStatus:function(e){this.status=e},getStatus:function(){return this.status}})}),define("DS/RTDriver/drivers/NODE",["UWA/Class","UWA/Class/Events","DS/RTDriver/RTUser","DS/RTDriver/RTDetectClient","DS/RTDriver/RTGroup","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/DSNodeSocketioClient_4.7.4/DSNodeSocketioClient_4.7.4","DS/RTProxyDriver/RTLogger","DS/i3DXCompassPlatformServices/i3DXCompassRegistryClient","DS/Usage/TrackerAPI"],function(e,t,n,i,o,r,s,a,c,d,v){"use strict";c.addLevel("nodeDriver","green"),c.nodeDriver("driver nodejs load 7/18/2019");var u=void 0;let l,E,h=0;const m=crypto.randomUUID();const f=e=>{try{c.nodeDriver("Analytics event : "+JSON.stringify(e)),v.trackPageEvent(e)}catch(e){c.nodeDriver("Analytics event request failed : "+e)}},p=(e,t,n)=>{const i={eventCategory:"collaboration.manager",eventAction:"websocketConnection",eventLabel:"Websocket connection time in milliseconds",eventValue:e,persVal:{pv1:t},persDim:{pd2:n?"failure":"success",pd4:m},appID:"X3DIMSG_AP"};if(n){const e=n.message?(n.type?n.type+": ":"")+n.message:n.toString();i.persDim.pd1=e,e.match(/timeout/i)?i.persDim.pd3="timeout":e.match(/socket error/i)?i.persDim.pd3="websocket error":i.persDim.pd3="other"}f(i)};return e.extend(t,{init:function(e){c.nodeDriver("init");const t=s.getApplicationConfiguration("app.swymfeature.activateRTC");this.rtconv=""===t||"true"===t||!0===t||UWA&&UWA.Utils&&"true"==UWA.Utils.getQueryString(document.URL,"rtconv")||location&&location.href&&location.href.includes("rtconv"),this.MAX_CONNECTION_TRIES=10,s.subscribe("fromDesktopApp.ds.com",this.handlerReconnect.bind(this)),s.subscribe("reliveWebsocket.im.ds.com",this.checkSocketStatus.bind(this));var n=e.url.replace(":5281",":443").replace("/rest","").replace(":443:443",":443");if(n.indexOf("://")>-1){var i=n.split("/");n=-1==i[2].indexOf(":")?i[2]+":443":i[2]}this.url=n,this.credentials=e.credentials,this.credentials.jid&&1!=this.credentials.jid.indexOf("@")&&(this.credentials.jid=this.credentials.jid.split("@")[0]),this.start_time=void 0,this.sid=e.sid,this.domaineName=e.domaineName,this.myStatus=void 0,this.username=e.username,this.webSocket={},this.devEnv=e.devEnv,this.passportUrl=e.passportUrl,this.connection=void 0,this.roster={},this.loginsToSub=[],u=this,document.RTCManager&&(document.RTCManager.driver=this),this.DELAY_TIME=10,this.DELAY_INCREMENT=0,this.DELAY_MAX=36e5,this.USE_RETRY=!0,this.IN_RETRY=!1,this.IS_LOGINOK=!1,this.retryTimeOut=null,this.listenNetworkEvent(),this.listenVisibilityEvent()},handlerReconnect:function(e){if(e&&"rtc"===e.socket)if(e.checkSocketStatus)this.dispatchEventToApp("socketStatus",{isConnected:this.webSocket&&this.webSocket.connected,authenticated:this.IS_LOGINOK});else if(e.forceSocketReconnect){this.USE_RETRY||(this.USE_RETRY=!0),this.checkSocketStatus(!0)?this.dispatchEventToApp("socketReconnect",{inRetry:this.IN_RETRY,isConnected:this.webSocket&&this.webSocket.connected,authenticated:this.IS_LOGINOK,retryCount:h}):this.dispatchEventToApp("socketReconnect",{inRetry:this.IN_RETRY,isConnected:this.webSocket&&this.webSocket.connected,authenticated:this.IS_LOGINOK})}},dispatchEventToApp:function(e,t){s.publish("toDesktopApp.ds.com",{type:"SocketMonitorEvent",payload:{event:e,data:t,socket:"rtc"}})},listenVisibilityEvent:function(){var e,t;void 0!==document.hidden?(e="hidden",t="visibilitychange"):void 0!==document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),void 0===document.addEventListener||void 0===e?c.nodeDriver("RTC Node requires a browser that supports the Page Visibility API."):document.addEventListener(t,function(e){document.hidden||(u.IN_RETRY?c.nodeDriver("RTC Node visible but in retry process."):u.DELAY_INCREMENT=0,u.checkSocketStatus())})},listenNetworkEvent:function(){this.USE_RETRY&&(window.addEventListener("online",this.checkSocketStatus),window.addEventListener("offline",this.checkSocketStatus))},removeNetworkEvent:function(){window.removeEventListener("online",this.checkSocketStatus),window.removeEventListener("offline",this.checkSocketStatus)},alertRetryEvent:function(e){if(document&&document.IMCall)try{c.nodeDriver(e)}catch(e){}},checkSocketStatus:function(e){return c.nodeDriver("RTC NODE checkSocketStatus use retry "+u.USE_RETRY),!!u.USE_RETRY&&(navigator.onLine?(u.webSocket&&u.webSocket.disconnected?u.IN_RETRY?c.nodeDriver("RTC NODE already in retry process!"):(u.alertRetryEvent("alert_reconnectOngoing"),u.IN_RETRY=!0,u.webSocket.io.reconnection(!0),h++,l=(new Date).getTime(),u.webSocket.connect(),c.nodeDriver("RTC NODE retry process connect socket.")):u.webSocket&&u.webSocket.connected?u.IN_RETRY||u.IS_LOGINOK||(e?(u.IN_RETRY=!0,u.getServiceTicket(!0)):c.nodeDriver("RTC NODE checkSocketStatus terminated (maybe KO)!!!")):!u.webSocket&&e&&(u.alertRetryEvent("alert_reconnectOngoing"),u.login(),c.nodeDriver("RTC NODE need to do whole login again!")),!0):(u.webSocket&&(!u.webSocket.connected&&u.webSocket.disconnected||(c.nodeDriver("RTC NODE need to disconnect socket before retry."),u.webSocket.io.reconnection(!1),u.webSocket.disconnect())),u.dispatchEvent("DISCONNECTED"),u.IN_RETRY=!1,u.alertRetryEvent("alert_connexionNetworkLost"),c.nodeDriver("RTC NODE no network!"),!1))},postponeReconnect:function(e){return"boolean"==typeof e.USE_RETRY?(u.USE_RETRY=e.USE_RETRY,!0):(e.delay||(e.delay=60*Math.floor(5*Math.random()+1)*60*1e3),u.DELAY_MAX+=e.delay,u.DELAY_TIME=e.delay,c.nodeDriver("postponeReconnect to "+e.delay))},setRetryDelay:function(e){if(!u.USE_RETRY)return e(!1);c.nodeDriver("RTC NODE will set retry with increment..."),u.DELAY_INCREMENT+=5,u.DELAY_INCREMENT*u.DELAY_TIME*1e3<u.DELAY_MAX?(c.nodeDriver("RTC NODE set retry. Should wait for: "+u.DELAY_INCREMENT*u.DELAY_TIME*1e3),u.alertRetryEvent("alert_reconnectOngoing"),u.retryTimeOut=setTimeout(function(){e&&e(!0)},u.DELAY_INCREMENT*u.DELAY_TIME*1e3)):(c.nodeDriver("RTC NODE do not set retry. Max delay exceeded: "+u.DELAY_INCREMENT*u.DELAY_TIME*1e3),e&&e(!1))},tryLogin:function(e){c.nodeDriver("login user "+this.credentials.jid+" on tenant "+this.domaineName+"/rtconv="+this.rtconv),this.tryConnect(e)},tryConnect:function(e){try{if(this.io=e,this.connectionParams={path:this.devEnv?"/socket.io":this.rtconv?"/socketio.conv":"/socketio.rtc",forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:1e3*this.MAX_CONNECTION_TRIES,reconnectionAttempts:this.MAX_CONNECTION_TRIES,timeout:15e3,transports:["websocket"]},this.url&&(this.url=this.url.replace(/^https?:\/\//,""),this.url.startsWith("wss://")||(this.url="wss://"+this.url)),l=(new Date).getTime(),this.webSocket=e.connect(this.url,this.connectionParams),this.devEnv&&(document.webSocket=this.webSocket),u=this,this.webSocket){if(this.webSocket.onmessage=this.onMsgReceived,isNaN(this.MAX_CONNECTION_TRIES))return c.nodeDriver("MAX_CONNECTION_TRIES is not a number");this.webSocket.io.reconnectionAttempts(this.MAX_CONNECTION_TRIES),this.webSocket.io.reconnectionDelayMax(1e3*this.MAX_CONNECTION_TRIES);var t,n={search:u.onSearchReceived,message:u.onMessage,presence:u.onPresenceChanged,roster:u.onRosterChanged,data:u.onDataReceived,roomInfos:u.roomInfosReceived,userInfo:u.userInfoReceived,sendScreen:u.onScreenReceived,stream:u.onStreamReceived,addContact:u.onAddContact,group:u.onGroupAdded,"3dimError":function(e){e.error&&e.error;c.nodeDriver("3DIM [ERROR] "),c.nodeDriver(e)},loginOK:u.onLoginOK,loginKO:u.onLoginKO,archive:u.onArchivesReceived,connectionOK:function(){},cleanRoom:u.onArchivesCleanedReceived,room:u.onRoomReceived,renameGroup:u.onGroupRenamed,removeGroup:u.onGroupRemoved,removeContact:u.onContactRemoved,disconnect:u.onDisconnect,leaveroom:u.onLeaveRoom,joinroom:u.onJoinRoom,miscellaneous:u.onSpecialEvent,connect_timeout:u.onConnectError,reconnect:u.onConnectError,reconnecting:u.onConnectError,reconnect_attempt:u.onReConnectAttempt,reconnect_error:u.onConnectError,reconnect_failed:u.onConnectError,connect_error:u.onConnectError,inviteSent:u.onInviteSent,inviteToCall:u.onInviteToCall,callEnded:u.onCallEnded,callAccepted:u.onCallAccepted,webrtcIceCandidate:u.onWebRTCIceCandidate,SDPreceived:u.onSDPreceived,callEvent:u.onCallEvent,callInfo:u.onCallInfo,convInfo:u.onConvInfo,media:u.onMediaReceived,coreview:u.onCoreview,discovered:u.onDiscover,goTo:u.goTo,conversation:u.onConversation,call:u.onCall,desktopApp:u.onDesktopApp,postponeReconnect:u.postponeReconnect};for(t in n)this.webSocket.on(t,function(e){return function(t){c.nodeDriver("[EVENT RECEIVED] "+e+" [DATA] "+JSON.stringify(t)),c.nodeDriver(t),"function"==typeof n[e]?n[e](t):c.nodeDriver("An event is not associated with a function : "+e)}}(t));this.webSocket.io.on("error",e=>{if(l){const t=(new Date).getTime()-l;p(t,h,e),l=null}u.IN_RETRY=!1,u.dispatchEventToApp("socketError",{inRetry:u.IN_RETRY,isConnected:u.webSocket&&u.webSocket.connected,authenticated:u.IS_LOGINOK,error:e,retryCount:h})}),this.webSocket.on("connect",function(e){if(l){const e=(new Date).getTime()-l;p(e,h),h=0,l=null}E=(new Date).getTime(),c.nodeDriver("RTC Node connected to server, now trying to login. "+e+" if retry: "+u.IN_RETRY),u.getServiceTicket(!0),u.IN_RETRY&&u.alertRetryEvent("alert_connexionRetrieved"),u.IN_RETRY=!1})}}catch(e){c.nodeDriver("error login: "+e)}},login:function(){this.tryLogin(a)},getServiceTicket:function(e,t){if(c.nodeDriver("getServiceTicket "),this.passportUrl||(this.passportUrl=s.getApplicationConfiguration("app.urls.passport")),!this.passportUrl)return e&&this.serverLogin(),c.error("NodeDriver has no passportUrl set");var n=this;function i(t){!t&&c.nodeDriver("passportUrl retrieved failbacked to "+n.passportUrl);var i=t||n.passportUrl,o=i+"/login?service=3DSIM",s=function(t){try{if(c.nodeDriver("Retrieved from PASSPORT : "+JSON.stringify(t)),!t)throw new Error("no answer from Passport");t.access_token?n.credentials.password=t.access_token:n.credentials.password=JSON.parse(t).access_token}catch(e){return n.IN_RETRY=!1,n.dispatchEventToApp("socketError",{inRetry:n.IN_RETRY,isConnected:n.webSocket&&n.webSocket.connected,authenticated:n.IS_LOGINOK,error:"Authenticaion request failed",retryCount:h}),console.error(e)}e&&n.serverLogin()},a={type:"json",onComplete:s,onFailure:function(e){i===n.passportUrl?(n.IN_RETRY=!1,n.dispatchEventToApp("socketError",{inRetry:n.IN_RETRY,isConnected:n.webSocket&&n.webSocket.connected,authenticated:n.IS_LOGINOK,error:"Authenticaion request failed",retryCount:h}),c.nodeDriver(e)):r.authenticatedRequest(n.passportUrl,a)},onTimeout:function(e){n.IN_RETRY=!1,n.dispatchEventToApp("socketError",{inRetry:n.IN_RETRY,isConnected:n.webSocket&&n.webSocket.connected,authenticated:n.IS_LOGINOK,error:"Authenticaion request timeout",retryCount:h}),c.nodeDriver(e)}};if(n.devEnv)return s('{"access_token":"osef"}');r.authenticatedRequest(o,a)}s.getApplicationConfiguration("app.urls.registry")&&n.domaineName?d.getServicesByPlatform({services:["3DPassport"],platforms:[n.domaineName],config:{url:s.getApplicationConfiguration("app.urls.registry")}}).then(e=>{let t;e&&e.length>0&&e[0].id&&e[0].id.toLowerCase()===n.domaineName.toLowerCase()&&e[0].services&&e[0].services.length>0&&e[0].services[0].id&&"3dpassport"===e[0].services[0].id.toLowerCase()&&(t=e[0].services[0].url),c.nodeDriver("passportUrl retrieved from Registry "+t),i(t)},function(){i()}):i()},serverLogin:function(){this.webSocket.emit("login",{login:this.credentials.jid,username:this.username,st:this.devEnv?"osef":this.credentials.password,tenant:this.domaineName,clientDevice:i.getClientInfos(),bypassGroups:!0,bypassUnreadMessages:!0})},onReConnectAttempt:function(e){return isNaN(e)?c.nodeDriver("socket io onReConnectAttempt arg is not a number !"):!(!u.webSocket||!u.webSocket.io)&&(u.webSocket.io.reconnectionDelay(1e3*e),c.nodeDriver("RTC NODE "+e+" tries to connect to RTC server have occured, the reconnection delay has been raised to "+e+"s"),void(e>=u.MAX_CONNECTION_TRIES&&u.setRetryDelay(function(e){c.nodeDriver("RTC NODE max tries quantity have been reached."),e?(c.nodeDriver("RTC NODE max tries duration not reached. Retry ongoing: "+u.webSocket.connected),u.webSocket.connected||u.webSocket.disconnect()):(c.nodeDriver("RTC NODE max tries duration have been reached. Stopping connection attempts"),u.IN_RETRY=!1,u.webSocket.io.reconnection(!1),u.webSocket.close())})))},onConnectError:function(e){c.nodeDriver("generic connection handler raised")},onContactRemoved:function(e){if(c.nodeDriver("onContactRemoved "+JSON.stringify(e)),!(e&&e.group&&e.group.name&&e.user&&e.user.login))return c.nodeDriver("onContactRemoved bad args");e.fromDriver=!0,u.dispatchEvent("REMOVECONTACT",[e]);try{delete u.roster[e.group.name].users[e.user.login]}catch(e){c.node("unable to remove user from roster")}},onGroupRemoved:function(e){if(c.nodeDriver("onGroupRemoved "+JSON.stringify(e)),!e||!e.name)return c.nodeDriver("onGroupRemoved bad args");var t=[{name:e.name,removeGroup:!0}];u.buildBuddyList(t)},onLoginOK:function(e){c.nodeDriver("loginOK !");var t={userId:e.user.login,status:e.user.presence.show,username:e.user.username,user_id:e.user.user_id,data:e,clientDevice:i.getClientInfos()};u.dispatchEvent("CONNECTED",[t]),u.IS_LOGINOK=!0,u.IN_RETRY=!1,u.dispatchEventToApp("socketStatus",{inRetry:u.IN_RETRY,isConnected:u.webSocket&&u.webSocket.connected,authenticated:u.IS_LOGINOK})},onLoginKO:function(e){u.IS_LOGINOK=!1,u.IN_RETRY=!1,u.dispatchEventToApp("socketStatus",{inRetry:u.IN_RETRY,isConnected:u.webSocket&&u.webSocket.connected,authenticated:u.IS_LOGINOK}),c.nodeDriver("loginKO : "+JSON.stringify(e))},chatWith:function(e){u.webSocket.emit("chatwith",e)},roomInfosReceived:function(e){c.nodeDriver("roomInfosReceived : "),u.dispatchEvent("ROOMINFOSRECEIVED",[e])},userInfoReceived:function(e){c.nodeDriver("userInfoReceived : "),u.dispatchEvent("USERINFOSRECEIVED",[e])},getUserInfo:function(e){c.nodeDriver("getUserInfo : "),this.webSocket.emit("getUserInfo",e)},logout:function(){this.users={},this.roster={},this.empty={},this.myStatus=void 0,this.webSocket&&this.webSocket.disconnect(),this.retryTimeOut&&clearTimeout(this.retryTimeOut),this.retryTimeOut=null,this.removeNetworkEvent()},onRoomReceived:function(e){var t=e.room;if(!t||!t.room_id)return c.nodeDriver("onRoomReceived bad args");u.rooms&&u.rooms[t.room_id]||(u.rooms&&u.rooms[t.room_id]||(u.rooms={}),u.rooms[t.room_id]=!0),u.dispatchEvent("ROOM",e)},getRoomInfos:function(e){u.webSocket.emit("getRoomInfos",e.room_id)},getRoom:function(e){u.webSocket.emit("getRoom",e)},joinRoom:function(e){u.webSocket.emit("joinRoom",e)},leaveRoom:function(e){u.webSocket.emit("leaveRoom",e)},onMessage:function(e){c.nodeDriver("onMessage : "+JSON.stringify(e));var t=e.message;try{t=decodeURIComponent(escape(window.atob(t)))}catch(e){c.nodeDriver("driver onMessage - unable to decode the message "+t)}var n={origin:e.origin,data:e.data,message_id:e.message_id,msg_id:e.message_id,to:e.author.login===u.credentials.jid?e.room_id:u.credentials.jid,from:e.author.login,username:e.author.username||e.author.login,typeMsg:e.type,activeArchive:!0,msg:t,status:e.author&&e.author.presence?e.author.presence.show||"Online":"Offline",where:void 0,login:e.author.login,roomId:e.room_id};"data"==n.origin?u.onDataReceived(e):u.dispatchEvent("ONMESSAGERECEIVED",[n]),u.webSocket.emit("setMessageRead",{room_id:n.roomId,message_id:n.message_id})},sendMessage:function(e){this.webSocket.emit("message",{message:btoa(unescape(encodeURIComponent(e.msg.msg))),room:e.msg.room,uuid:e.msg.uuid})},uploadMedia:function(e){this.webSocket.emit("uploadMedia",e)},getMedias:function(e){this.webSocket.emit("getMedias",e)},coreview:function(e){this.webSocket.emit("coreview",e)},onMessageSys:function(e){c.nodeDriver("onMessageSys : "+e)},onDataReceived:function(e){if(c.nodeDriver("onDataReceived : "+JSON.stringify(e)),!e||!e.author||!e.message)return c.nodeDriver("onDataReceived : bad format received");if("string"==typeof e.message&&-1!=e.message.indexOf("CATRTC"))return!1;var t={to:e.author.login===u.credentials.jid?e.room_id:u.credentials.jid,from:e.author.login,username:e.author.username,typeMsg:e.type,status:e.author&&e.author.presence?e.author.presence.show||"Online":"Offline",where:void 0,activeArchive:!1,login:e.from,data:e.message.data||e.message,typeData:e.message.typeData,message_id:e.message_id,roomId:e.room_id,fileName:e.message.fileName,fileId:e.message.fileId,nbpart:1,numpart:1,origin:e.origin};u.dispatchEvent("ONMESSAGERECEIVED",[t])},onScreenReceived:function(e){var t={to:u.credentials.jid,from:e.from,login:e.from,roomId:e.room,screenData:e.screenData};u.dispatchEvent("ONSCREENRECEIVED",[t])},onStreamReceived:function(e){var t={to:u.credentials.jid,from:e.from,login:e.from,roomId:e.room,stream:e.stream};u.dispatchEvent("ONSTREAMRECEIVED",[t])},onRosterChanged:function(e){c.nodeDriver("onRosterChanged : "+e),u.buildBuddyList(e)},onPresenceChanged:function(e){var t,n,i={...e,userId:e.login,status:e.presence.show,presence:e.presence.show,username:e.username,phone:e.phone||e.uri,login:e.login,user_id:e.user_id||e.id};for(t in u.dispatchEvent("ONPRESENCERECEIVED",[i]),u.roster)for(n in u.roster[t].users)n==e.login&&(u.roster[t].users[n].presence=e.presence,u.roster[t].users[n].status=e.presence.show)},onDisconnect:function(e){var t;c.nodeDriver("disconnection : "+e),t=(new Date).getTime()-E,f({eventCategory:"collaboration.manager",eventAction:"websocketDisconnection",eventLabel:"Websocket disconnection",eventValue:t,persDim:{pd1:m},appID:"X3DIMSG_AP"}),u.IS_LOGINOK=!1,u.IN_RETRY=!1;var n={userId:u.credentials.jid,status:"Offline"};u.dispatchEvent("ONPRESENCERECEIVED",[n]),u.dispatchEvent("DISCONNECTED",[{forced:"transport close"===e}]),u.dispatchEventToApp("socketStatus",{inRetry:u.IN_RETRY,isConnected:u.webSocket&&u.webSocket.connected,authenticated:u.IS_LOGINOK})},onSearchReceived:function(e){c.nodeDriver("onSearchReceived : "+e);for(var t=[],i=0;i<e.users.length;i++){var o={userId:e.users[i].login,userName:e.users[i].username,status:e.users[i].presence&&e.users[i].presence.show?e.users[i].presence.show:"Offline"},r=new n(o);t.push(r),u.dispatchEvent("ONPRESENCERECEIVED",[r])}return u.nextSearchIsForShareAPI?(u.dispatchEvent("RESULTOFSEARCHFORSEARCHAPI",[t]),u.nextSearchIsForShareAPI=!1,!0):(u.dispatchEvent("RESULTOFSEARCH",[t]),!0)},onArchivesReceived:function(e){if(c.nodeDriver("- archive received : "+JSON.stringify(e)),!e.room_id)return c.nodeDriver("received a message without room_id : "+JSON.stringify(e));var t=e.message;if("archive_qty"!==e.type&&"3DIMmessages3DIMsoon3DIMdeleted3DIM"!==t&&"3DIMmessages3DIMdeleted3DIM"!==t)try{t=decodeURIComponent(escape(window.atob(t)))}catch(e){c.nodeDriver("driver onArchivesReceived - unable to decode the message "+t)}var n={origin:e.origin,data:e.data,to:e.room_name,from:e.login,username:e.username,typeMsg:e.type,msg:t,status:null,where:null,login:e.login,isSend:u.credentials.jid.split("/")[0]==e.login,dateMsg:e.date?e.date+"Z":null,type:e.type,msg_id:e.message_id,message_id:e.message_id,roomID:e.room_name,read_date:e.read_date,uuid:e.room_id};"archive_qty"===e.type&&(n.archive_qty=parseInt(e.message?e.message:"0",10),c.nodeDriver("- onArchivesReceived : waiting for "+n.archive_qty+" archived messages in the room "+e.room_id+" / "+e.room_name)),u.dispatchEvent("ONARCHIVERECEIVED",[n])},onArchivesCleanedReceived:function(e){if(c.nodeDriver("- archive Cleaned : "+JSON.stringify(e)),!e||!e.uuid)return c.nodeDriver("- archive Cleaned bad args");var t={uuid:e.uuid,qty:"some",type:"archiveCleaned"};return u.dispatchEvent("ONARCHIVERECEIVED",[t]),!0},setPresence:function(e,t){c.nodeDriver("setPresence : "+e+" - "+t),this.webSocket&&this.webSocket.emit("setPresence",{login:this.credentials.jid,statusMsg:e,show:t})},requestForSubscribe:function(e){},sendSystemMsg:function(e){},sendNotif:function(e){},sendData:function(e){c.nodeDriver("sendData "+e.data);var t=e.data.length,n=Math.floor(t/1e4);1e4*n<t&&n++;this.webSocket.emit("data",{from:u.credentials.jid,data:{robotName:e.robotName,typeData:e.typeData,type:"DSRTData",dataSize:t,data:e.data,persisted:e.persisted,accept:e.accept,fileName:e.fileName,fileId:e.fileId,nbpart:"progress"==e.data?e.nbpart:n,numpart:"progress"==e.data?e.numpart:0},room:e.roomId,uuid:e.roomId})},sendStream:function(e){c.nodeDriver("sendData"),this.webSocket.emit("stream",{from:u.credentials.jid,stream:e.stream,room:e.roomId})},getBuddylist:function(){this.webSocket&&this.webSocket.emit("getRoster",{from:this.credentials.jid})},onAddContact:function(e){var t=[{name:e.name,login:e.user.login,username:e.user.username,status:e.user.presence?e.user.presence.show||e.user.presence.statusMsg:"Offline"}];u.buildBuddyList(t)},onGroupAdded:function(e){var t,i,r,s;if(c.nodeDriver("onGroupAdded"),!e||!e.name||!e.users)return c.nodeDriver("[error] onGroupAdded received bad args");if(u.dispatchEvent("GROUP",e),(i=u.roster[e.name])||(i=new o({groupName:e.name,groupId:e.name}),u.roster[i.groupId]=i),u.roster[i.groupId]&&u.roster[i.groupId]instanceof o)for(t=0;t<e.users.length;t++)s=e.users[t],r=new n({userId:s.login,userName:s.username||s.login,status:s.presence.show||s.presence.statusMsg}),u.addUserToGroup(u.roster[i.groupId],r),u.dispatchEvent("ONPRESENCERECEIVED",[r]);else c.nodeDriver("[error] onGroupAdded unable to add group to roster");u.dispatchEvent("BUDDYLISTBUILT",[u.roster])},addUserToGroup:function(e,t){var n=t.userId;if(e.users||(e.users={}),e.users[n])return c.nodeDriver("[error] addUserToGroup user "+n+" is already in the group "+e.groupId);e.users[n]=t,c.nodeDriver("addUserToGroup user "+n+" added to the group "+e.groupId)},buildBuddyList:function(e){if(c.nodeDriver("buildBuddyList"),e.length>0){for(var t=0;t<e.length;t++){var i=u.roster[e[t].name];if(i&&i.toRemove&&(i.toRemove=!1),i||(i=new o({groupName:e[t].name,groupId:e[t].name}),u.roster[e[t].name]=i),i){if(e[t].removeGroup){u.roster[e[t].name].toRemove=!0;continue}var r={userId:e[t].login,userName:e[t].username,status:e[t].status?e[t].status:"Offline"},s=new n(r);e[t].removeUser&&(s.toRemove=!0),u.addUserToGroup(i,s),u.dispatchEvent("ONPRESENCERECEIVED",[s])}}u.dispatchEvent("BUDDYLISTBUILT",[this.roster])}},onGroupRenamed:function(e){if(c.nodeDriver("onGroupRenamed "+JSON.stringify(e)),!e||!e.oldName||!e.name)return c.nodeDriver("onGroupRenamed bad args");u.roster[e.oldName]?(u.roster[e.name]=new o({groupName:e.name,groupId:e.name}),u.roster[e.name].users=u.roster[e.oldName].users,delete u.roster[e.oldName],u.roster[e.oldName]={toRemove:!0},u.dispatchEvent("BUDDYLISTBUILT",[u.roster])):u.onGroupAdded(e)},addGroup:function(e){this.webSocket&&this.webSocket.emit("addGroup",{from:this.credentials.jid,name:e})},removeGroup:function(e){this.webSocket&&this.webSocket.emit("removeGroup",{name:e})},renameGroup:function(e){this.webSocket&&e.oldName&&e.newName?this.webSocket.emit("renameGroup",e):c.nodeDriver("renameGroup bad args")},addContact:function(e,t){this.webSocket&&this.webSocket.emit("addContact",{name:t,login:e.userId,tenant:this.domaineName})},removeContact:function(e,t){this.webSocket&&this.webSocket.emit("removeContact",{name:t,login:e})},getStatus:function(e){this.webSocket&&this.webSocket.emit("getPresence",{from:this.credentials.jid,users:[{login:e.login,to:e.userId}]})},getAllStatus:function(e){this.webSocket&&this.webSocket.emit("getPresence",{from:this.credentials.jid,users:e})},UpdateStatus:function(e,t){},searchContact:function(e){this.webSocket&&this.webSocket.emit("search",{login:this.credentials.jid,text:e,tenant:this.domaineName}),e.isForShareAPI&&(this.nextSearchIsForShareAPI=!0)},auth:function(e){},analyseForCATIA:function(e){},setPresenceForCATIA:function(e){},getArchives:function(e){c.nodeDriver("NODE getArchives "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("getMessages",e)},cleanArchives:function(e){this.webSocket&&this.webSocket.emit("cleanRoom",e)},startCall:function(e){c.nodeDriver("NODE startCall "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("startCall",e)},endCall:function(e){c.nodeDriver("NODE endCall "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("endCall",e),this.telwebsocket&&this.telwebsocket.close()},acceptCall:function(e){c.nodeDriver("NODE acceptCall "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("acceptCall",e)},webrtcIceCandidate:function(e){c.nodeDriver("NODE webrtcIceCandidate "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("iceCandidate",e)},SDP:function(e){c.nodeDriver("NODE SDP "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("SDP",e)},onInviteSent:function(e){u.dispatchEvent("inviteSent",[e])},onCallEvent:function(e){u.dispatchEvent("callEvent",[e])},onCallInfo:function(e){u.dispatchEvent("callInfo",[e])},onCallHistory:function(e){u.dispatchEvent("callHistory",[e])},onConvInfo:function(e){u.dispatchEvent("convInfo",[e])},onCallEventFromView:function(e){c.nodeDriver("NODE onCallEventFromView "+JSON.stringify(e)),this.webSocket&&this.webSocket.emit("callEvent",e)},onInviteToCall:function(e){u.dispatchEvent("inviteToCall",[e])},onCallEnded:function(e){u.dispatchEvent("callEnded",[e])},onCallAccepted:function(e){u.dispatchEvent("callAccepted",[e])},onWebRTCIceCandidate:function(e){u.dispatchEvent("webrtcIceCandidateReceived",[e])},onSDPreceived:function(e){u.dispatchEvent("SDPreceived",[e])},onMediaReceived:function(e){u.dispatchEvent("mediaReceived",[e])},onCoreview:function(e){u.dispatchEvent("COREVIEW",[e])},onLeaveRoom:function(e){u.dispatchEvent("roomLeft",[e])},onJoinRoom:function(e){u.dispatchEvent("roomJoined",[e])},onSpecialEvent:function(e){u.dispatchEvent("miscellaneous",[e])},updateRoom:function(e){this.webSocket&&this.webSocket.emit("updateRoom",e)},onDiscover:function(e){u.dispatchEvent("discovered",[e])},discover:function(e){this.webSocket&&this.webSocket.emit("discover",e)},joinPublicRoom:function(e){this.webSocket&&this.webSocket.emit("joinPublicRoom",e)},getCallInfo:function(e){this.webSocket&&this.webSocket.emit("getCallInfo",e)},subConv:function(e){this.webSocket&&this.webSocket.emit("subConv",e)},IAmTyping:function(e){this.webSocket&&this.webSocket.emit("IAmTyping",e)},goTo:function(e){u.dispatchEvent("connectTelWS",{url:e.telUrl||u.url,connectionParams:u.connectionParams,call_id:e.call_id,cookie:e.telCookie})},sipEvent:function(e){if(!u.telwebsocket)return c.nodeDriver("cant send sipEvent without telwebsocket "+e.action);c.nodeDriver("send sipEvent "+e.action),u.telwebsocket.emit(e.action,e.data)},deactivateTelephony:function(){},onConversation:function(e){u.dispatchEvent("conversation",[e])},onCall:function(e){u.dispatchEvent("call",[e])},conversationEvent:function(e){this.webSocket&&this.webSocket.emit("toRTC",e)},onCall:function(e){u.dispatchEvent("call",[e])},callEvent:function(e){this.webSocket&&e.TxID&&!e.TxID.includes("callEventFromView")&&this.webSocket.emit("callToRTC",e)},onDesktopApp:function(e){e&&e.channel&&e.data&&s.publish(e.channel,e.data)}})});