define("DS/DMUReadPersistence/DMUReadPersistence",[],function(){}),define("DS/DMUReadPersistence/DMUReadServices",["require","exports","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUContextManager"],function(e,t,n,o){"use strict";return class{static importModel(e){if(e&&"object"==typeof e&&e.dataJson&&"object"==typeof e.dataJson&&e.dataJson.Model&&"object"==typeof e.dataJson.Model){let t=o.getReviewContext({viewer:e.viewer}),a=new n({viewer:e.viewer,experience:t,appType:e.appType,markupRepRef:e.mkpRepRef});a.importDataModel(e.dataJson,function(t){a.postImport(),e.onImportCompleted&&e.onImportCompleted(t)})}else e.onImportFailed&&e.onImportFailed()}}}),define("DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting",["UWA/Core","UWA/Class","UWA/Class/Options","DS/Logger/Logger","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WAFData/WAFData","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices"],function(e,t,n,o,a,i,r,s){"use strict";var l=t.singleton(n,{init:function(){var t=o.getLogger(l);t.log("init"),this.setOptions({navigate_opts:{timeout:2e4}});var n=this,d=!1;function c(e){if(null===e&&void 0===e)return"";var t="";if(Array.isArray(e))for(var n=e.length/2,o=0;o<n;o++)t+=0===o?"?":"&",t+=e[2*o]+"="+e[2*o+1];return encodeURI(t)}this.sendWebServiceCall=function(o){if(o){if(!d)return s=function(){n.sendWebServiceCall(o)},l=o.onFailure,t.log("app_initialization"),void a.getPlatformServices({onComplete:function(e){n.setOption("platform_services",e),d=!0,s()},onFailure:function(){t.warn("Cannot retrieve the Platform Services"),d=!0,l()}});var s,l;if(Array.isArray(n.getOption("platform_services"))){var u=e.clone(o.config,!1);u.onComplete=o.onSuccess,u.onFailure=o.onFailure,u.onTimeout=o.onFailure,u.method=u.verb,u.headers={Accept:"application/json","Content-Type":"application/json","Accept-Language":o.platform?o.platform.getLang():r.getSetting("lang"),SecurityContext:o.platform?o.platform.getSecurityContext():r.getSetting("pad_security_ctx")},"object"==typeof u.data&&(u.data=JSON.stringify(u.data));var p=[];p.push("securityContext"),p.push(o.platform?o.platform.getSecurityContext():r.getSetting("pad_security_ctx")),p.push("tenant"),p.push(o.platform?o.platform.getPlatformId():n.getOption("platform_services")[function(){var t,o=n.getOption("platform_services"),a=n.getTenant();if(e.is(a)){var i=a.value?a.value:a;if(Array.isArray(n.getOption("platform_services")))for(var r=0;r<o.length&&!e.is(t);r++)o[r].platformId===i&&(t=r)}return e.is(t)||(window.console.warn("Tenant not found => Tenant idx by default is 0"),t=0),t}()].platformId),i.authenticatedRequest(o.platform?o.platform.get3DSpaceUrl()+"/"+o.url+c(p):n.get3DSpaceUrl()+"/"+o.url+c(p),u)}else o.onFailure&&o.onFailure()}},this.getServerContext=function(e){if(!e||"function"!=typeof e.onComplete||"function"!=typeof e.onFailure)return;let t=r.getSetting("pad_security_ctx");t?e.onComplete(t):e.onFailure()},this.get3DSpaceUrl=function(){return s.get3DSpaceUrl()},this.getTenant=function(){return r.getSetting("x3dPlatformId")}},doInitialize:function(){}});return l.doInitialize(),l}),define("DS/DMUReadPersistence/DMUPasswordDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/Controls/LineEditor","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,i,r){"use strict";return t.extend({init:function(t){this._parent(t);var s,l,d,c=(t||{}).ctxViewer;this.build=function(t,u){if(!s){var p=e.createElement("div",{id:"DMUPasswordDialogContent"});e.createElement("p",{id:"DMUPasswordDialogDescription",text:r.documentPasswordMessage}).inject(p);var f=e.createElement("div",{styles:{display:"flex","justify-content":"space-evenly","align-items":"center"}}).inject(p);l=new i({placeholder:r.documentPassword,selectAllOnFocus:!0,displayStyle:"password"}).inject(f);var m=new o({label:"Display Password",showLabelFlag:!1,icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"},type:"check",displayStyle:"icon"}).inject(f);m.getContent().setStyle("margin-left","10px"),d=e.createElement("p",{styles:{color:"#EA4F37",margin:"5px"}}).inject(p),m.getContent().addEventListener("change",function(){m.checkFlag?(m.setProperties({icon:{iconName:"eye-off",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="text"):(m.setProperties({icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}}),l.displayStyle="password")});var g={Ok:new o({emphasize:"primary",label:"OK",onClick:function(){l.value?(l.disabled=!0,d.innerText="",g.Ok.disabled=!0,t(l.value)):d.innerText=r.documentPasswordRequired}}),Cancel:new o({label:"Cancel",onClick:u})};l.addEventListener("uncommittedChange",function(){d&&d.innerText&&(d.innerText="")}),s=new n({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:r.documentPasswordRequired,content:p,closeButtonFlag:!1,position:a.getTouchMode()?{my:"center bottom"}:void 0,immersiveFrame:c.getFrameWindow().getImmersiveFrame(),buttons:g})}},this.onIncorrectPassword=function(){s&&l&&(l.disabled=!1,s.buttons.Ok.disabled=!1,d.innerText=r.documentIncorrectPassword)},this.getValue=function(){return l?l.value:""},this.close=function(){c&&(s&&s.close(),c=s=null,l=null,d=null)}}})}),define("DS/DMUReadPersistence/DMUXCADSupport",["UWA/Core","DS/WebUtils/WebServices","DS/WebUtils/Network","DS/Logger/Logger","DS/WAFData/WAFData","DS/WebSystem/Environment","DS/CSICommandBinder/CSICommandBinder","DS/SPAContentOptimizer/ConvertV1","DS/SPAContentOptimizer/COConvertOption","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"],function(e,t,n,o,a,i,r,s,l,d){"use strict";var c={},u={},p=o.getLogger("DS/DMUReadPersistence/DMUXCADSupport");p.log("init");var f=0;return{returnSpaConvertUri:function(t){var n=e.Utils.parseUrl(t);return n.authority+n.directoryPath},execConvertCmd:function(t,n){var o=t.asset;!function(){var a,i=new s(n);i.onResultFile=function(n,a){if(p.log("launchConvert.onResultFile",n),"Success"!==n||!a)return!0;var i=new Blob([a]),r=e.clone(o);t.onConvertSuccess(e.extend(r,{provider:"FILE",filename:window.URL.createObjectURL(i),proxyurl:"none",requiredAuth:null,serverurl:"",originalType:o.type,mimetype:o.dataFormat||o.mimetype,format:o.dataFormat||o.mimetype,type:o.dataFormat||o.mimetype}))},i.onErrors=function(e){if(p.error("Conversion error"),e&&e[0]&&e[0].split("\n")){var n=e[0].split("\n");"Please check the documentation for supported file versions and resave the file in one of supported versions if possible"===n[2]?(p.error(e),this.onErrorsVisited=!0):"InterOp Diagnostic: The input Parasolid file is Bare binary file which is an unsupported format."===n[1]?(p.error(e),this.onErrorsVisited=!0):"Error : The input file is saved in Civil3D. Output might be incomplete."===n[0]&&p.warn(e)}t.onConvertError(d.contentOptimizerNotSupport)},i.onMissingFiles=function(e){p.error("Missing Files domain"),p.error(e),t.onConvertError&&t.onConvertError()},i.onProgress=function(e){p.log("launchConvert.onProgress",e)},t.ConversionOpts&&(a=new l,Object.keys(t.ConversionOpts).forEach(function(e){void 0!==t.ConversionOpts[e]&&a["Set"+e](t.ConversionOpts[e])}));var r=o.url,c=o.filename;p.log("_execConvertCmd.convertUrl",c,r,o.dataFormat,a),i.convertUrl(c,r,o.dataFormat,a)}()},startConvert:function(e){var o=this,a=e.asset,i="Not initialized";new Promise(function(n){t.getServiceUrl({serviceName:"SPAContentOptimizer",logger:p,platformId:a.tenant,onSuccess:function(e){c[a.tenant]=o.returnSpaConvertUri(e.url),n()},onError:function(t){p.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service")}})}).then(function(){var t=!1,s={onHypervisorDisconnect:function(){p.log("XCADSpatialSupport._startConvert: CSIServer Hypervisor Disconnected"),t?t=!1:(p.error("Unable to connect"),e.onConvertError(e.asset))},onHypervisorConnect:function(){t=!0,p.log("CSIServer Connected")},onDisconnect:function(){p.log("CSIServer Node Disconnected")},authentication:function(e,t,o){var a=encodeURIComponent(i).replace(/'/g,"%27").replace(/"/g,"%22");n.authenticatedRequest(e.passportURL+"/login?service="+a,{method:"GET",headers:{Accept:"application/json"},onComplete:function(e){try{var n=JSON.parse(e).access_token;t(i,n)}catch(e){o("Failed to parse ticket")}},onFailure:function(e,t){o("Failed to retrieve ticket"),p.log("CSIServer authentication onFailure"),p.error("Failed to retrieve ticket: "+t+e)}})}},l=c[a.tenant];""!==l&&void 0!==l&&(s.hypervisorUrl=l,s.ssl=!0,i="https://"+s.hypervisorUrl);var d=r.getPool("application.webWidget").createNode(s),u=d.select("ContentOptimizer");o.execConvertCmd(e,d,u)})},startLocate:function(t,n){var o=this,r=t.asset;this.located=!1,p.log("XCADSpatialSupport._startLocate");var s=t.asset.originalAsset.contextid?t.asset.originalAsset.contextid:"preferred";i.get("PreferredCredentials")&&(s=i.get("PreferredCredentials"));var l="/api/v2/modeler/dsdo/DerivedOutputs/locate?withSyncStatus=yes";"EV6"!==t.asset.originalAsset.provider.toUpperCase()&&"3DSPACE"!==t.asset.originalAsset.provider.toUpperCase()||(l+="&SecurityContext="+encodeURIComponent(s)),"asm"===r.dataFormat&&(r.dataFormat="3dxml");var d=u[r.tenant]+l,c={specificationFilter:[{format:r.dataFormat,filterConversionParams:[{key:"streamId",value:"visualization"}]}],referencedObject:[{source:"EV6"===t.asset.originalAsset.provider.toUpperCase()?"3DSpace":t.computedInfos.provider,id:t.asset.originalAsset.physicalid,type:t.asset.originalAsset.type}]};!0===n&&(c.specificationFilter[0].notifyIfMissing=!0),a.authenticatedRequest(d,{method:"POST",headers:{"Content-Type":"application/json",SecurityContext:s},type:"json",data:JSON.stringify(c),onComplete:function(n){if(console.log("onComplete locate"),n.derivedOutputs&&n.derivedOutputs[0]&&n.derivedOutputs[0].derivedOutputFormats&&n.derivedOutputs[0].derivedOutputFormats[0]&&n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult&&!0===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.isSync&&"OK"===n.derivedOutputs[0].derivedOutputFormats[0].lastConversionResult.status){f=0;var i=u[r.tenant]+"/api/v2/modeler/dsdo/DerivedOutputs/"+n.derivedOutputs[0].id+"/DerivedOutputFiles/"+n.derivedOutputs[0].derivedOutputFormats[0].id+"/DownloadTicket";a.authenticatedRequest(i,{method:"GET",headers:{"Content-Type":"application/json"},type:"json",onComplete:function(n){console.log("onComplete download ticket");var o=n.data[0].dataelements,a=o.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(o.ticket)+"&jobTicket=__fcs__jobTicket&__fcs__attachment=true",i=e.clone(r);t.onConvertSuccess(e.extend(i,{provider:"FILE",filename:a,proxyurl:"none",requiredAuth:null,serverurl:"",originalType:r.type,mimetype:r.dataFormat||r.mimetype,format:r.dataFormat||r.mimetype,type:r.dataFormat||r.mimetype})),console.log("Loading from DFA : "+a)},onFailure:function(e){console.log("onFailure download ticket"+e)}})}else if(f<=10){var s=f++<5?1e3:3e3;console.log(" restart locate in "+s+" ms"),setTimeout(o.startLocate.bind(o,t,!1),s)}else console.log("locate service is not available")},onFailure:function(e){console.log("onFailure locate"+e)}})},convertDFA:function(e){var n=this,o=e.asset;t.getServiceUrl({serviceName:"derivedformataccess",logger:p,platformId:o.tenant,onSuccess:function(t){u[o.tenant]||(u[o.tenant]=t.url),t.platformId!==o.tenant&&p.warn("DerivedFileAccess desired Tenant:",o.tenant,"got ",t.platformId),p.log("DerivedFileAccess : URL found > ",u[o.tenant]),n.startLocate(e,!0),n=null},onError:function(t){p.error("Ooops, missing Service : ",t.serviceName,"Reason : ",t.error),e.onConvertError("Missing Service"),n=null}})}}}),define("DS/DMUReadPersistence/DMUReviewPersistenceServices",["UWA/Class","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPUtils","DS/PlatformAPI/PlatformAPI","DS/3DSpaceDocumentConnector/3DSpaceDocumentConnector","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DocumentManagement/DocumentManagement","DS/VisuDataAccess/Ox4StreamLoader","UWA/Utils"],function(e,t,n,o,a,i,r,s,l){"use strict";return e.extend({init:function(){let e=!0;var d=new a;this.updateReviewAndJSONFile=function(e,t,n){i.getServerContext({onComplete:function(o){var a=e.markupName,s=e.markupType,l=(new Date).getTime(),d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(l+16*Math.random())%16|0;return l=Math.floor(l/16),("x"===e?t:3&t|8).toString(16)}),c=new Blob([JSON.stringify(e.json)],{type:"application/json"}),u=null;c&&((u=c).name=d,u.fileName=d);var p={fileInfo:{file:u,title:d,newFile:e.newFile,fileName:d},id:e.reviewPhysicalId},f={onComplete:function(e){t&&t({reviewId:e.data[0].id,reviewName:a,reviewType:s})},onFailure:function(){n&&n({reviewName:a,reviewType:s})},securityContext:o,tenant:i.getTenant(),tenantUrl:i.get3DSpaceUrl()};r.modifyDocument(p,f)},onFailure:n})},this.updateMarkupStream=function(e,t,n){var o,a=e.markupName,r=e.markupType,s=new Blob([e.json],{type:"application/json"}),d=l.getUUID().toString();(o="DMUMarkupRepReference",new Promise(function(e,t){i.sendWebServiceCall({url:"resources/markup/service/getCheckinTicket",config:{verb:"POST",data:JSON.stringify({sObjectType:o})},onSuccess:function(t){e(t?JSON.parse(t):{})},onFailure:function(e){t(e)}})})).then(function(o){var l,c=o.checkinTicket,u=o.actionURL;c&&u&&(l={file:s,ticket:c,URL:u,correlationId:d,fileName:"WebReviewContent.json"},new Promise(function(e,t){var n=new FormData;n.append("__fcs__jobTicket",l.ticket),n.append("file_0",l.file,l.fileName);var o=new XMLHttpRequest;o.open("POST",l.URL,!0),o.onload=function(){200===o.status&&e(o.responseText)},o.onerror=(()=>t(new Error("Network Error"))),o.send(n)})).then(function(o){var s=o;s&&function(e){return new Promise(function(t){i.sendWebServiceCall({url:"resources/markup/service/checkinStreamInfo",config:{verb:"POST",data:JSON.stringify({sObjectId:e.ObjectId,sReceipt:e.receipt,sJsonStream:e.stream,sFileName:e.fileName,sPersistencyType:e.persistencyType,sPersistencyName:e.persistencyName})},onFailure:function(e){t({error:e})},onSuccess:function(e){t(e?JSON.parse(e):{})}})})}({ObjectId:e.reviewPhysicalId,receipt:s,stream:e.json,fileName:"WebReviewContent.json",persistencyName:"WebReviewContent",persistencyType:"json"}).then(function(o){o&&!o.error?t&&t({reviewId:e.reviewPhysicalId,reviewName:a,reviewType:r}):n()})}).catch(n)}).catch(n)},this.getDnDReviewAndJSONFile=function(e,a,s){e.serverurl||(e.serverurl=i.get3DSpaceUrl()),e.tenant||(e.tenant=i.getTenant()),i.getServerContext({onComplete:function(i){var l={onComplete:function(i){!function(e,a,i){var r=e?e.MarkupReservedby:null;if(null!==r&&d){var s=e.MarkupID,l=e.MarkupType,c=e.MarkupName?e.MarkupName:e.MarkupTitle,u=e.MarkupDescription,p=e.MarkupState,f={onComplete:function(e){var d={url:e[0].downloadUrl,responseType:"json",onComplete:function(e){var t={reviewPid:s,reviewType:l,reviewName:c,reviewDescription:u,reviewState:p,jsonObj:JSON.parse(n.cleanJSONString(e)),modifiable:!r||""===r||r===o.getUser().login};a(t),window.widget&&window.widget.dispatchEvent("onDMUMarkupLoaded",s)},onFailure:i};t.request(d.url,{responseType:d.responseType,method:"GET",onComplete:d.onComplete,onFailure:d.onFailure,timeout:0})},onFailure:i};d.downloadDocuments([e.MarkupID],f)}else i()}({MarkupID:e.markupId,MarkupType:e.markupType,MarkupJsonFileID:i&&i.data&&i.data.length&&i.data[0].relateddata&&i.data[0].relateddata.files&&i.data[0].relateddata.files.length?i.data[0].relateddata.files[0].id:void 0,MarkupReservedby:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.reservedby:null,MarkupName:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.title:null,MarkupDescription:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.description:null,MarkupState:i&&i.data&&i.data.length&&i.data[0].dataelements?i.data[0].dataelements.state:null},a,s)},onFailure:s,securityContext:i,additionalURLParams:"$include=parents",tenantUrl:e.serverurl,tenant:e.tenant,relInfo:{parentRelName:"Markup",parentDirection:"from"}};r.getDocuments([e.markupId],l)},onFailure:s})},this.getProductByMarkerId=function(e,t,n){e&&e.physicalid&&(e.serverurl||(e.serverurl=i.get3DSpaceUrl()),e.tenant||(e.tenant=i.getTenant()),i.getServerContext({onComplete:function(o){var a={onComplete:function(e){if(0===e.data.length)n(e);else{var o={MarkupContext:{}};e.data[0].relateddata.parents&&e.data[0].relateddata.parents.length?o.MarkupContext.contexts=e.data[0].relateddata.parents:e.data[0].dataelements&&e.data[0].dataelements.parentId&&(o.MarkupContext.contexts=[],o.MarkupContext.contexts.push({id:e.data[0].dataelements.parentId})),t(o)}},onFailure:n,securityContext:o,tenantUrl:e.serverurl,tenant:e.tenant,additionalURLParams:"$include=parents",relInfo:{parentRelName:"Markup",parentDirection:"from"}};r.getDocuments([e.physicalid],a)},onFailure:n}))},this.getMarkupInfos=function(t,n,o){t&&t.physicalid&&i.sendWebServiceCall({url:"resources/markup/service/getMarkup",config:{verb:"POST",data:JSON.stringify({sMarkupId:t.physicalid})},onSuccess:function(t){if(t){let o=JSON.parse(t);if(n(o),o.reservedby||"false"===o.modifyAccess){let t=o.modifyAccess;e=!t||"false"!==t}else e=!0}else n({})},onFailure:o})},this.getMarkupStream=function(t,o,a){var r={IRPC:!0,serverUrl:i.get3DSpaceUrl(),physicalid:t.markupId,boType:"DMUMarkupRepReference",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(a){window.console.log("getMarkupJson::success:"+a.byteLength),o({jsonObj:JSON.parse(n.cleanJSONString(a)),reviewPid:t.markupId,reviewType:t.markupType,reviewName:t.markupTitle,owner:t.markupOwner,modifiable:e})},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),a(e="NOSTREAM")}};s.Load(r)}}})}),define("DS/DMUReadPersistence/DMUWebServicesUtils",["UWA/Class","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting"],function(e,t){"use strict";return e.singleton({init:function(){},getParentTypes:function(e){return new Promise((n,o)=>{t.sendWebServiceCall({url:"resources/markup/service/getParentTypes",config:{verb:"POST",data:JSON.stringify({sType:e})},onSuccess:function(e){let t=JSON.parse(e);n(t.parentTypes)},onFailure:function(e){o(e)}})})}})}),define("DS/DMUReadPersistence/DMULoadingContextController",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DocumentManagement/DocumentManagement","DS/DMUControls/EXPNotify","DS/DMUControls/panels/DMUDocumentPanel","DS/PADUtils/views/PADProgressBar","DS/DMUReadPersistence/DMUPasswordDialog","DS/DMUBaseExperience/EXPManagerSet","DS/CoreEvents/ModelEvents","DS/CATWebUXComponents/DMUCommandsManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/WAFData/WAFData","DS/DMUBaseExperience/EXPToolsContext","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"].concat(["DS/DMU3DReviewWidget/DMU3DReviewWidgetOptions","DS/DMUReviewWebApp/DMUReviewWebAppOptions","DS/DMUValidationWebApp/DMUValidationWebAppOptions"]),function(e,t,n,o,a,i,r,s,l,d,c,u,p,f,m,g,v,D,S,h,I){"use strict";let C={isr:"DS/PIMwebViewController/PIMwebItfCtrl",difAnnotSet:"DS/CAT3DAnnotControllerForReview/CATDIFAnnotSetLoader",msr:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRLoadCtrl"},y=e.extend({init:function(e){this._parent(e);let y,b,x,M,w,R,P,k,F,U,O,T=this,L=(e||{}).ctxViewer,A=null,j=null,N={},E={},V=new d,W=null,_=null,q=!0,B=t.getEventsController({viewer:L.getViewer()}),J=null,K={icon:null,title:null},X=null,G=!0,z=null,H=[],$={},Q=["doc","docx","docm","dot","dotm","dotx","rtf","ppt","pptx","pot","potm","potx","pps","ppsm","ppsx","pptm"];function Y(e,t,n){b&&b.destroy(),b=new a({body:L.getFrameWindow().getUIFrame(),type:e,message:t}),"successful"===n&&T.publish("on2DDocumentLoadSuccess")}function Z(e){let t;P&&(P.close(),P=null),L.removeRoots({pids:[x]}),e&&"InvalidPDFException"===e.name&&(t=D.documentNotSupported),L.displayNotification({msg:t||D.documentLoadKO,eventID:"error"}),x=null;let n=r._counter;for(let e=0;e<n;e++)r.off();T.publish("onDocumentLoadFailure")}function ee(){let e=r._counter;for(let t=0;t<e;t++)r.off();Y("info","Document"===(n.getNodeType(L.getRootBagPath().getChildrenPathes()[0])?n.getNodeType(L.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)):null)||"Document"===z?D.documentLoadCancel:D.requirementLoadCancel);let t=c.getCommand("CleanAll",L.getCommandContext());t&&t.begin()}function te(e,t){return new Promise(n=>{F&&F[e]?n(F[e]):m.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let o=new FileReader;o.onload=function(){F||(F={}),F[e]=o.result,n(F[e])},o.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})})}function ne(){let e=t.giveEventsController({viewer:L.getViewer()});e&&e.fireEvent("onLoadedReviewContext",{rootType:W})}const oe=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function ae(e){let t="Requirement Specification"===e.parentElement.type?[]:[e.parentElement],n=[],o=[],a=function(e){let t="";for(let o=1;o<=e&&n[o];o++)1!==o&&(t+="."),t+=n[o];return t};const i={0:e.parentElement.pathId};for(let r=1;r<e.dataObj.length;r++){const s=e.dataObj[r];g.getParentType(s)||g.setParentType(s.type,s["type.kindof"]);const l=parseInt(s.level),d="/";i[l]=`${i[l-1]}${d}${s["physicalid[connection]"]}${d}${s.physicalid}`;let c={pathId:i[l],typeIconUrl:await te(s["type.kindof"],s.type_icon_url),level:l};if(o.length-1>c.level&&(o=o.slice(0,c.level+1)),o[s.level]?o[s.level]++:o[s.level]=1,"Chapter"===s["type.kindof"])n[s.level]?n[s.level]++:n[s.level]=1,n.length-1>c.level&&(n=n.slice(0,c.level+1)),c.content=s["attribute[Title]"],c.title=s["attribute[Title]"],c.type=s["type.kindof"],c.chapterLevelTag=a(c.level),c.fontSize=34-2*c.level;else if("Comment"===s["type.kindof"]||"Requirement"===s["type.kindof"]){c.content=s["attribute[Content Data]"],c.title=s["attribute[Title]"],c.type=s["type.kindof"],"1"===s.level?c.chapterLevelTag="0":c.chapterLevelTag=a(c.level-1)||"0";let e="",t=Math.max(0,n.length-1>=c.level?c.level-1:n.length-1);for(let n=t+1;n<=c.level;n++)n!==t+1&&(e+="."),o[n]||(o[n]=1),e+=o[n];c.subLevelTag=e}t.push(c)}F=null;let s=l.getManager({name:"DMU2DSheetManager",context:L.getFrameWindow()});s&&s.loadDocumentStream({documentID:x,type:"Requirement",elementsToLoad:t,fatherNode:L.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:function(){let e=v.giveReqCompareController({context:L});e&&e.isLoading()||(y&&y(),Y("info",D.documentLoadOK,"successful")),R&&R();let t=r._counter;for(let e=0;e<t;e++)r.off();ne()},onFailure:Z})}function ie(e){m.authenticatedRequest(u.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.parentElement.pathId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e.securityData},timeout:6e4,onComplete:function(t){let n=JSON.parse(t);e.onComplete(n)},onFailure:Z,onTimeout:Z})}function re(e){let t=p.getSetting("pad_security_ctx");var n,o;r.on(),(n=e.phyID,o=t,new Promise(function(e,t){let a=encodeURI(`${u.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${n}&select=type,attribute[Content Data],attribute[Title]`);m.authenticatedRequest(a,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:o},timeout:6e4,onComplete:function(t){let o=JSON.parse(t);o&&"success"===o.status&&o.results[0]?e({phyId:n,content:oe(o.results[0]["attribute[Content Data]"]||""),title:o.results[0]["attribute[Title]"],type:o.results[0].type.value}):e({phyId:n})},onFailure:function(){t(new Error("Requirement content Request Failed"))},onTimeout:function(){t(new Error("Requirement content Request Timeout"))}})})).then(function(n){let o={pathId:n.phyId,content:n.content,title:n.title,type:g.getParentType(n.type)?g.getParentType(n.type):n.type};"Requirement"===o.type?L.getController().getAttributes({ids:[e.phyID],attributes:["type_icon_url"],callbacks:{onComplete:function(n){o.level=0,o.chapterLevelTag=0,o.subLevelTag=0,te(o.type,n[e.phyID].type_icon_url).then(e=>{o.typeIconUrl=e,ie({parentElement:o,securityData:t,onComplete:function(e){O=[o.pathId],ae({parentElement:o,dataObj:e})}})})},onFailure:Z}}):ie({parentElement:o,securityData:t,onComplete:function(e){O=[o.pathId],e.length>0&&e.forEach(e=>{O.push(e.physicalid)}),ae({parentElement:o,dataObj:e})}})})}function se(e){let a,d;e.path&&(a=n.getNodeID(e.path.getLastElement(!0)),d=n.getNodeType(e.path.getLastElement(!0))),"Document"===d||"Specification Report"===d?function(e){let n,a,d=function(e,t){let o=l.getManager({name:"DMU2DSheetManager",context:L.getFrameWindow()});o||(o=new f({ctxViewer:L}),l.addManager({name:"DMU2DSheetManager",context:L.getFrameWindow(),manager:o})),o&&o.loadDocumentStream({documentID:x,dataBuffer:e,type:"Document",password:t,fatherNode:L.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:async function(){y&&y(),R&&await R();let e=r._counter;for(let t=0;t<e;t++)r.off();Y("info",D.documentLoadOK,"successful"),ne()},onPasswordOk:function(){P&&(P.close(),P=null)},onIncorrectPassword:function(){P?P.onIncorrectPassword():(P=new s({ctxViewer:L})).build(function(t){d(e,t)},function(){if(w&&n&&a){P&&(P.close(),P=null);let e=r._counter;for(let t=0;t<e;t++)r.off();w.build(n,a,ee)}else ee()})},onFailure:Z})},g={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){d(e)},onFailure:Z,onTimeout:Z};a=function(n,a){r.on(),M={fileId:n,versions:a},o.downloadDocuments([a[0]],{onComplete:function(n){const o=n[0].fileName.split(".").pop().toLowerCase();if("pdf"===n[0].fileName.split(".").pop().toLowerCase())W="PDF",m.authenticatedRequest(n[0].downloadUrl,g);else if("dxf"===o||"dwg"===o){W=n[0].fileName.split(".").pop().toUpperCase();let o={dataFormat:"udl",dtype:"Document",filename:n[0].fileName,format:n[0].fileName.split(".").pop().toLowerCase(),mimetype:n[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},tenant:p.getSetting("x3dPlatformId"),type:n[0].fileName.split(".").pop().toLowerCase(),url:n[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],function(n){n.startConvert({asset:o,onConvertError:function(e){if("Missing Service"===e){Y("warning",D.documentTypeNotSupported);for(let e=0;e<r._counter;e++)r.off()}else Y(e)},onConvertSuccess:function(n){require(["DS/DibUDLWebLoader/DraftingUDLWebLoader"],function(o){if(o){let i=new o;if(i.set3DAccuracy(.001),i.set2DAccuracy(.001),n){let o={provider:"FILE",serverurl:"",proxyurl:"none",requiredAuth:null};o.filename=n.filename;let s={serverUrl:u.get3DSpaceUrl(),securityContext:p.getSetting("pad_security_ctx"),UDLObjURL:o,onComplete:function(n){U=n;let o=L.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),s=l.getManager({name:"DMU2DSheetManager",context:L.getFrameWindow()});s||(s=new f({ctxViewer:L}),l.addManager({name:"DMU2DSheetManager",context:L.getFrameWindow(),manager:s}));let d=[];for(let t=0;t<n.sheetIDList.length;t++)d.push({modelID:n.sheetIDList[t],sheetID:"Drw."+e.phyID+"_"+n.sheetIDList[t],label:i.getSheetName(n.sheetIDList[t])});s.load2DDocument({loadedSheetInformations:n,phyID:a[0],dataType:"DXF/DWG",sheetNodes:d,parentNode:o,getSheet3DNode:function(e){let t=i.getSheetBackgroundColor(e.modelID);i.getSheet3DNode({sheetID:e.modelID,onSheetNodeCreated:function(n){o.addChild(n),L.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.sheetID)&&e.noUdlWarningMessage(),i.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),L.getViewer().render(),L.getViewpoint().reframe(),e.end();for(let e=0;e<r._counter;e++)r.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){for(let e=0;e<r._counter;e++)r.off();y&&y();let e=t.giveEventsController({viewer:L.getViewer()});e&&e.fireEvent("onDXFLoadSuccess"),R&&R(),ne()},onFailure:function(){L.removeRoots({pids:[o]}),L.displayNotification({msg:D.fileWithNoSVG,eventID:"error"}),T.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};i&&i.loadModel(s)}}})}})})}else if(Q.includes(o.toLowerCase())){W=n[0].fileName.split(".").pop().toUpperCase();let e={ConversionOpts:{},dataFormat:"pdf",dtype:"Document",filename:n[0].fileName,format:n[0].fileName.split(".").pop().toLowerCase(),mimetype:n[0].fileName.split(".").pop().toLowerCase(),provider:"FILE",requestsOptions:{authentication:"passport",proxy:"none",method:"POST"},originalAsset:{contextid:p.getSetting("pad_security_ctx"),displayname:n[0].fileName,dtype:"Document",physicalid:x,provider:"EV6",requiredAuth:"passport",serverurl:u.get3DSpaceUrl(),serviceId:"3DSpace",tenant:p.getSetting("x3dPlatformId"),type:"Document"},tenant:p.getSetting("x3dPlatformId"),type:n[0].fileName.split(".").pop().toLowerCase(),url:n[0].downloadUrl};require(["DS/DMUReadPersistence/DMUXCADSupport"],function(t){t.convertDFA({asset:e,onConvertError:function(e){if("Missing Service"===e){Y("warning",D.documentTypeNotSupported);for(let e=0;e<r._counter;e++)r.off()}else Y(e)},onConvertSuccess:function(e){let t={proxy:"none",type:"arraybuffer",timeout:18e4,onComplete:function(e){d(e)},onFailure:Z,onTimeout:Z};m.authenticatedRequest(e.filename,t)}})})}else Y("error",D.documentNotSupported)}})};let v={onComplete:function(e){if(e&&e.data&&e.data[0]&&e.data[0].relateddata.files){K.icon=e.data[0].dataelements.typeicon?e.data[0].dataelements.typeicon:null,K.title=e.data[0].dataelements.title?e.data[0].dataelements.title:null;let o=t.giveEventsController({viewer:L.getViewer()});o&&o.fireEvent("onGetDocumentsCompleted");let s=["pdf","dxf","dwg"].concat(Q);if(A){let t,o,l,d,c={},u=[];if(A&&(t=0),e.data[0].relateddata.files.forEach(function(e){-1!==s.indexOf(e.dataelements.title.split(".").pop().toLowerCase())&&e.dataelements.title.split(".").pop().toUpperCase()===_&&(c.versions=[],c.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach(function(e){c.versions.push(e.id)}),c.fileId=e.relId,A&&A===e.relId&&(t++,o=e.dataelements.title.split(".").pop().toLowerCase(),l=e.dataelements.title,d=c.versions),c.title=e.dataelements.title,c.creationDate=new Date(e.dataelements.originated),c.modifiedDate=new Date(e.dataelements.modified),u.push(c),c={})}),!t&&e.data[0].relateddata.files.length>0)if("X3DPLAW_AP"===j)Y("error",D.documentDeleted);else{k="delete";let e=r._counter;for(let t=0;t<e;t++)r.off();n={title:D.documentPanel.deleteFile,data:u,mode:"delete"},w||(w=new i({immersiveFrame:L.getFrameWindow().getImmersiveFrame()})),w.build(n,a,ee)}else e.data[0].relateddata.files.length?t&&Q.includes(o)&&e.data[0].relateddata.files.length>1?(L.displayNotification({msg:`${D.markupDocmultioffice} ${l}`,eventID:"error"}),ee()):(k="normal",a(A,d)):(L.displayNotification({msg:D.documentNofile,eventID:"warning"}),ee())}else if(1===e.data[0].relateddata.files.length)if(-1===s.indexOf(e.data[0].relateddata.files[0].dataelements.title.split(".").pop().toLowerCase())){Y("warning",D.documentTypeNotSupported);let e=c.getCommand("CleanAll",L.getCommandContext());e&&e.begin()}else{let t,n=[];e.data[0].relateddata.files[0].relateddata.versions.length?(t=e.data[0].relateddata.files[0].relId,n.push(e.data[0].relateddata.files[0].id),e.data[0].relateddata.files[0].relateddata.versions.forEach(function(e){n.push(e.id)})):(t=e.data[0].relateddata.files[0].relId,n.push(e.data[0].relateddata.files[0].id)),a(t,n)}else{let t={},o=[],r=0,s=0;e.data[0].relateddata.files.forEach(function(e){-1!==["pdf","dxf","dwg"].indexOf(e.dataelements.title.split(".").pop().toLowerCase())?(r++,t.versions=[],t.versions.push(e.id),e.relateddata.versions.length&&e.relateddata.versions.forEach(function(e){t.versions.push(e.id)}),t.fileId=e.relId,t.title=e.dataelements.title,t.creationDate=new Date(e.dataelements.originated),t.modifiedDate=new Date(e.dataelements.modified),o.push(t),t={}):Q.includes(e.dataelements.title.split(".").pop().toLowerCase())&&(s++,r++)}),!r&&e.data[0].relateddata.files.length>0?Y("warning",D.documentTypeNotSupported):e.data[0].relateddata.files.length?s===r?Y("warning",D.documentMultiOfficeNotSupported):(n={title:D.documentPanel.selectFile,data:o,mode:"select"},w||(w=new i({immersiveFrame:L.getFrameWindow().getImmersiveFrame()})),w.build(n,a,ee)):Y("warning",D.documentNofile)}}else Z()},onFailure:Z,securityContext:p.getSetting("pad_security_ctx"),tenantUrl:u.get3DSpaceUrl(),tenant:p.getSetting("x3dPlatformId"),getVersions:!0};o.getDocuments([e.phyID],v)}({phyID:a}):"Requirement"!==d&&"Requirement Specification"!==d||(re({phyID:a}),W=d)}function le(e){let t=L.getRootBagPath().getChildrenPathes();if(1===t.length&&y)y();else{if(q){let e=L.subscribe({event:"onRootRemoved"},()=>{L.unsubscribe(e),function(e){J&&e&&e.id===J.objectId?J=null:y&&y()}()})}t.forEach(function(t){n.getNodeID(t.getLastElement(!0))!==e&&L.removeRoots({pids:[n.getNodeID(t.getLastElement(!0))]})})}}function de(e){let n=e.data.objectType,o=e.data.objectParentType,a=e.data.loadMode,i=e.data.objectId,s=e.data.objectName,d=e.data.serviceId;function c(){L.setAutomaticReframePolicy(!1);let e=p.getSetting("enopad3dviewer_lightNodeModel")?[{rootID:i,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:i,"ds6w:type":o,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part","ds6w:label":s,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:i,"ds6w:type":o,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]},refreshDelegationCB:function(){return new Promise(function(e){e()})}}]:[{rootID:i,validForServerCall:!0,structure:{rootId:o,results:[{attributes:[{name:"did",value:i},{name:"physicalid",value:i},{name:"ds6w:type",value:o}]},{path:[i]}]}}];L.loadJSON({data:e})}g.getParentType(n)||g.setParentType(n,o);const m=S.getOption("testMbom")||h.getOption("testMbom")||I.getOption("testMbom")?["Document","Requirement","Requirement Specification","DELLmiWorkPlanSystemReference","Specification Report"]:["Document","Requirement","Requirement Specification","Specification Report"];if("PLMPIMMetricReference"===o||"SIMItfSimulation"===o)require([C.isr],function(n){let r=n.getLoaderForMarkup({context:L});function s(){if(L.getApplicativeData().getLoadedItfData&&L.getApplicativeData().getLoadedItfData().data.length){let e=L.getApplicativeData().getLoadedItfData();e.data[0].prd&&le(e.data[0].prd[0])}e.data.cbOK&&e.data.cbOK()}let l=r.subscribe("onDMUCtxtAlreadyLoaded",function(){r.unsubscribe(l),s()}),d=r.subscribe("onDMUCtxtLoadingSuccess",function(){l&&r.unsubscribe(l),r.unsubscribe(d),s(),ne()}),c=t.getReviewContext({context:L});c&&c.getCurrentSessionMarkup()&&"X3DPLAW_AP"!==e.data.appInfo?"SIMItfSimulation"===o?(i===x?W="ITF":J&&J.objectId===i&&(J.type="ITF"),L.getApplicativeData().getLoadedItfData&&L.getApplicativeData().getLoadedItfData().data.length?i===L.getApplicativeData().getLoadedItfData().data[0].isrID?r.load({data:{isrID:[i],loadMode:a}}):(c.getCurrentSessionMarkup().setActiveFlag(!1),r.remove({data:{objectType:"SIMItfSimulation",objectId:L.getApplicativeData().getLoadedItfData().data[0].isrID}}),r.load({data:{isrID:[i],loadMode:a}})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),r.load({data:{isrID:[i],loadMode:a}}))):(i===x?W="ISR":J&&J.objectId===i&&(J.type="ISR"),r.getIsrPointingToMetric([i]).then(function(e){let t=e[i][0];L.getApplicativeData().getLoadedItfData&&L.getApplicativeData().getLoadedItfData().data.length?t===L.getApplicativeData().getLoadedItfData().data[0].isrID?r.load({data:{metricID:[i]},loadMode:a}):(c.getCurrentSessionMarkup().setActiveFlag(!1),r.remove(L.getApplicativeData().getLoadedItfData().data[0].isrID),r.load({data:{metricID:[i]},loadMode:a})):(c.getValidation()||c.getCurrentSessionMarkup().setActiveFlag(!1),r.load({data:{metricID:[i],loadMode:a}}))})):"SIMItfSimulation"===o?(i===x?W="ITF":J&&J.objectId===i&&(J.type="ITF"),r.load({data:{isrID:[i],loadMode:a}})):(i===x?W="ISR":J&&J.objectId===i&&(J.type="ISR"),r.load({data:{metricID:[i]},loadMode:a}))});else if("DIFLayout"===o||"DIFSheet"===o)require(["DS/DibUDLWebLoader/CATDibUDLWebLoader"],function(t){if(t){let o=new t,a={data:{physicalid:i,dataType:n},contextViewer:L,serverUrl:u.get3DSpaceUrl(),securityContext:p.getSetting("pad_security_ctx"),onComplete:function(t){U=t;let a=l.getManager({name:"DMU2DSheetManager",context:L.getFrameWindow()});a||(a=new f({ctxViewer:L}),l.addManager({name:"DMU2DSheetManager",context:L.getFrameWindow(),manager:a}));let s=[];for(let e=0;e<t.sheetIDList.length;e++)s.push({modelID:t.sheetIDList[e],sheetID:"Drw."+i+"_"+t.sheetIDList[e],label:o.getSheetName(t.sheetIDList[e])});a.load2DDocument({loadedSheetInformations:t,phyID:i,dataType:n,sheetNodes:s,getSheet3DNode:function(e){let t=o.getSheetBackgroundColor(e.modelID);o.setDisplaySheet({sheetID:e.modelID,onSheetNodeCreated:function(){L.getViewer().render(),e.cb(t)},onSheetLoaded:function(){e.noUdlMessage.includes(e.modelID)&&e.noUdlWarningMessage(),J&&i===J.objectId||o.setSheetPickingByView({sheetID:e.modelID,pickingByView:!0}),L.getViewer().render(),J||L.getViewpoint().reframe(),e.end();for(let e=0;e<r._counter;e++)r.off()},onFailure:function(){e.noUdlMessage.push(e.sheetID),e.noUdlWarningMessage(),e.end()}})},onComplete:function(){ne();for(let e=0;e<r._counter;e++)r.off();y&&y(),e.data.cbOK&&e.data.cbOK()},onFailure:function(){L.displayNotification({msg:D.fileWithNoSVG,eventID:"error"}),T.publish("on2DDocumentLoadFailure")}})},onFailure:function(){window.console.log("Unexpected error!! Failed to Load UDL via _UDLLoader.loadModel!!")}};o&&o.loadModel(a)}}),W="FLDiagram",J||le(i);else if("DIFAnnotationSet"===o)require([C.difAnnotSet],function(t){new t({context:L}).load({id:i}).then(()=>{e.data.cbOK&&e.data.cbOK()})});else if("DesignSight"===o)require([C.msr],e=>{L.getFrameWindow().options={},L._context="Default",L.getFrameWindow().options.context="Default";let t=e.getLoaderForMarkup({context:L});t&&G&&(W="MSR",i!==X?(t.load({data:{msrID:i},onComplete:()=>{G=!0,X=i,y&&y();let e=L.subscribe({event:"onRootRemoved"},()=>{L.unsubscribe(e),X&&(X=null)})},onFailure:()=>{G=!0}}),G=!1):L.displayNotification({msg:D.msrAlreayLoaded,eventID:"info"}))}),q=!1,le(i);else if(m.includes(o)){let t=v.giveReqCompareController({context:L});if(t&&t.isLoading()||!L.getRootBagPath().getChildrenPathes().length)e.data.subContext&&e.data.subContext.id&&T.setSubContextInformations({mainContextId:e.data.objectId,subContext:e.data.subContext}),c();else{let e=L.subscribe({event:"onEndRootRemoved"},function(t){L.unsubscribe(e),e=-1,t&&t.ids&&t.ids.includes(x)||c()})}q=!1,(!t||t&&!t.isRequirementCompareActive())&&le(i)}else"R2V_FeatureState"===o&&(W="R2V_FeatureState",function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(u.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":p.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}(b={serviceId:d,objectId:i}).then(e=>{H.push({id:b.objectId,info:e.result})}));var b;let M=t.giveEventsController({viewer:L.getViewer()});M&&M.fireEvent("onLoadedReviewContext",{rootType:o})}this.getLoadedID=function(){return x},this.setLoadedID=function(e){x=e},this.getIsrContext=function(e){return new Promise(function(t){require([C.isr],function(n){n.getLoaderForMarkup({context:L}).getIsrContext(e).then(t)})})},this.load=function(e){j=e.data.appInfo,x=e.data.objectId instanceof Array?e.data.objectId[0]:e.data.objectId,R=e.data.cbOK,A=e.data.fileId;const t=e.data.serviceId;let n;e.data.documentType&&(_=e.data.documentType),z=e.data.objectType,y=e.data.loadMarkup?e.data.loadMarkup:null,n=e.data&&e.data.subContext?e.data.subContext.label:e.data.displayName,de({data:{appInfo:j,objectId:x,objectType:e.data.objectType,objectParentType:e.data.objectParentType?e.data.objectParentType:e.data.objectType,objectName:n,loadMode:e.data.loadMode,cbOK:R,fileId:A,documentType:_,loadMarkup:y,serviceId:t,subContext:e.data.subContext}})},this.clean=function(e){L&&(P&&(P.close(),P=null),w&&w.destroy(),j=W=w=F=U=O=null,q=!0,e&&(x=null,N.onRootAdded&&L.unsubscribe(N.onRootAdded),N.onRootAdded=null,N.widgetReresh&&L.unsubscribe(N.widgetReresh),N.widgetReresh=null),E={},K={},L.getViewer().render())};this.getLoadMarkupDocumentMode=function(){return k},this.getLoadMarkupCtxType=function(){return W},this.getLoadedSheetInformations=(()=>U),this.getTempObjectInformations=(()=>K),this.getLoadedR2VInformations=(()=>H),this.setLoadedR2VInformations=(e=>{H=e}),this.updateLoadedR2VInformations=((e,t)=>{"remove"===t&&(H=H.filter(t=>t.id!==e))}),this.getSubContextInformations=(e=>$[e]),this.setSubContextInformations=(e=>{e&&e.mainContextId&&($[e.mainContextId]=e.subContext)}),this.removeSubContextInformations=(e=>{e&&$[e]&&($[e]=void 0)}),this.getDocumentVersionInfos=function(){return M},this.subscribe=function(e,t){if(e&&t&&V)return V.subscribe({event:e},t)},this.unsubscribe=function(e){V&&e&&V.unsubscribe(e)},this.publish=function(e,t){V&&V.publish({event:e,data:t})},E.on2DDocumentLoadRequired=B.addEvent("on2DDocumentLoadRequired",e=>{e&&de({data:J={objectType:e.documentType,objectId:e.rootID,objectParentType:e.documentType,objectName:e.objectName}})}),N.onRootAdded=L.subscribe({event:"onRootAdded"},function(e){se({path:e.path})}),N.widgetReresh=L.subscribe({event:"widgetReresh"},e=>{"DesignSight"===e.objectType&&(e.objectParentType=e.objectParentType?e.objectParentType:e.objectType,de({data:e}))}),E.onGetLoadedSheetInformations=B.addEvent("onGetLoadedSheetInformations",e=>{e.cb&&e.cb(U)}),E.onGetLoadedReqSpecInformations=B.addEvent("onGetLoadedReqSpecInformations",e=>{e.cb&&e.cb(O)})}}),b=[];return e.singleton({init:function(){},giveLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<b.length;t++)if(b[t].context===e.context)return b[t].controller},getLoadingContextController:function(e){let t;if(e&&e.context&&!(t=this.giveLoadingContextController(e))){let n=new y({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},getLoadedID:function(){if(n)return n.getLoadedID()},setLoadedID:function(e){if(n)return n.setLoadedID(e)},getDocumentVersionInfos:function(){if(n)return n.getDocumentVersionInfos()},getIsrContext:function(e){if(n)return n.getIsrContext(e)},clean:function(e){if(n)return n.clean(e)},getLoadMarkupDocumentMode:function(){if(n)return n.getLoadMarkupDocumentMode()},getLoadMarkupCtxType:function(){if(n)return n.getLoadMarkupCtxType()},getLoadedSheetInformations:function(){if(n)return n.getLoadedSheetInformations()},getTempObjectInformations:function(){if(n)return n.getTempObjectInformations()},setLoadedR2VInformations:function(e){if(n)return n.setLoadedR2VInformations(e)},getLoadedR2VInformations:function(){if(n)return n.getLoadedR2VInformations()},setSubContextInformations:function(e){if(n)return n.setSubContextInformations(e)},getSubContextInformations:function(e){if(n)return n.getSubContextInformations(e)},removeSubContextInformations:function(e){if(n)return n.removeSubContextInformations(e)},updateLoadedR2VInformations:function(e,t){if(n)return n.updateLoadedR2VInformations(e,t)}}),b.push({context:e.context,controller:t})}return t},unreferenceLoadingContextController:function(e){if(e&&e.context)for(let t=0;t<b.length;t++)b[t].context===e.context&&(b[t].controller.clean(!0),b.splice(t,1))}})}),define("DS/DMUReadPersistence/DMUValidationReadServices",["UWA/Class","DS/DMUBaseExperience/EXPUtils","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/VisuDataAccess/Ox4StreamLoader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADSettingsMgt"],function(e,t,n,o,a,i,r){"use strict";return e.extend({init:function(){this.getProductByValidationId=function(e,t,o){n.sendWebServiceCall({url:"resources/validation/service/getPrdIdByValidationId",config:{verb:"POST",data:{sValidationId:e}},onSuccess:function(e){var n=JSON.parse(e);t(n)},onFailure:function(){o()}})},this.getAllElementsByValidationId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getAll",config:{verb:"POST",data:{sValidationId:e.validationId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getMarkupJson=function(e,s,l,d){var c={IRPC:!0,serverUrl:n.get3DSpaceUrl(),physicalid:e.markupId,boType:"VALReview",format:"1",persistancyType:"json",streamType:"string",onStreamLoaded:function(n){window.console.log("getMarkupJson::success:"+n.byteLength),s({jsonObj:JSON.parse(t.cleanJSONString(n)),reviewPid:e.markupId,reviewName:e.markupName,modifiable:!0},d)},onError:function(e){window.console.log("getMarkupJson::erreur:"+e),l(e="NOSTREAM")}};window.console.log("Loading streams");var u=i.getUser().login;a.useUWAProxy({proxymode:"passport",login:u,contextid:r.getSetting("pad_security_ctx")}),o.Load(c)},this.getValidationFromHighlightId=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationFromHighlightId",config:{verb:"POST",data:{sHighlightId:e.highlightId}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})},this.getValidationsFromObjectsIds=function(e){n.sendWebServiceCall({url:"resources/validation/service/getValidationsFromObjectsIds",config:{verb:"POST",data:{listHighlights:e.highlightIds,listChecks:e.checkIds,listValidations:e.validationIds}},onSuccess:function(t){var n=JSON.parse(t);e.onSuccess(n)},onFailure:function(){e.onFailure()},platform:e.platform})}}})}),define("DS/DMUReadPersistence/DMULoadMarkupServices",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUReadPersistence/DMUValidationReadServices","DS/DMUBaseWebValidation/EXPValImporter","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReadPersistence/DMUReadServices","DS/CATWebUXComponents/DMUCommandsManager","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUReadPersistence/DMULoadingContextController","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUReadPersistence/assets/nls/DMUReadPersistence"].concat(["DS/DMU3DReviewWidget/DMU3DReviewWidgetOptions","DS/DMUReviewWebApp/DMUReviewWebAppOptions","DS/DMUValidationWebApp/DMUValidationWebAppOptions"]),function(e,t,n,o,a,i,r,s,l,d,c,u,p,f,m,g,v,D,S,h,I,C,y,b){"use strict";var x=e.extend({init:function(x){var M,w,R,P,k,F,U=this,O=!0,T=new c,L=x.ctxViewer,A=[],j=[],N=0,E=new o,V=new a;function W(){var e=p.getReviewContext({context:L});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().setReadOnly(!0);var t=l.getCommand("DMUMarkupHdr",L.getCommandContext());t&&t.enable();var n=l.getCommand("CleanAll",L.getCommandContext());n&&n.enable()}function _(e,t){T&&T.publish({event:e,data:t,context:U})}function q(e){if(L&&e!==O){O=e;var t=p.getReviewContext({context:L});O?(L&&(A&&(A.forEach(function(e){var t=l.getCommand(e._id,L.getCommandContext());t&&(e._isEnabled?t.enable():t.disable())}),A=[]),j&&(j.forEach(function(e){var t=l.getCommandCheckHeader(e._id,L.getCommandContext());e&&(e._isEnabled?t.enable():t.disable())}),j=[])),t&&t.getNode()&&t.getNode().setPickable(d.PICKABLE)):(!function(){if(L){var e,t,n=l.getCommands(L.getCommandContext());for(e in n)n.hasOwnProperty(e)&&(t=n[e],A.push({_id:t._id,_isEnabled:t._isEnabled}));var o=l.getCommandCheckHeaders(L.getCommandContext());for(e in o)o.hasOwnProperty(e)&&(t=o[e],j.push({_id:t._id,_isEnabled:t._isEnabled}));l.disableAll(L.getCommandContext())}}(),t&&t.getNode()&&t.getNode().setPickable(d.PICKTHROUGH)),L.getViewer().render()}}function B(e,n){M&&(M.destroy(),M=null),M=new t({body:L.getFrameWindow().getUIFrame(),type:e,message:n})}function J(e){L&&(N>0&&(g.off(),N--),q(!0),e&&B("error",e),L.getWidget().dispatchEvent("onDMUMarkupLoadFailed"),_("onDMUMarkupLoadFailed"))}function K(e){if(L){N>0&&(g.off(),N--);var t=p.getReviewContext({context:L});J("Cancel"!==e?"NoMarkup"===e?I.loadNoMarkup:I.loadError:void 0),t&&t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().isReadOnly()&&W()}}async function X(e){q(!0),N>0&&(g.off(),N--),p.removeReviewContext({context:L}),await n.createReviewContext({context:L}),s.importModel({dataJson:e.jsonObj,appType:e.ID,viewer:L.getViewer(),onImportCompleted:function(t){if(!L)return;var n=F?F.getLoadMarkupCtxType():w;let o,a=F?F.getSubContextInformations(e.contextId):void 0;o=a?{title:a.label}:F?F.getTempObjectInformations():void 0;var i=p.getReviewContext({context:L});const s=e.jsonObj&&e.jsonObj.ApplicativeContext?e.jsonObj.ApplicativeContext:null;t[0]&&t[0].setApplicativeContext&&t[0].setApplicativeContext(s);const l=t[0].getMarkupContent?t[0].getMarkupContent():t[0];l&&l.setMaturityState(e.reviewState),i.setCurrentSessionMarkup(l),i.setReviewCtxInformation({contextId:e.contextId,contextType:n,subContextId:e.subContextId,subContext:e.subContext,reviewId:e.reviewPid,reviewName:e.reviewName,reviewDescription:e.reviewDescription,reviewType:e.reviewType,owner:e.owner,modifiable:e.modifiable,tempObjectInfo:o}),f.setSlidePreferences({context:L.getFrameWindow(),preferences:{panelTitle:e.reviewName}}),p.getContextViewer({viewer:L.getFrameWindow().getViewer()}).getController().getAttributes({ids:[e.reviewPid],attributes:["ds6w:reservedBy"],callbacks:{onComplete:function(t){if(t){const o=r.getUserLogin();var n=t[e.reviewPid]["ds6w:reservedBy"];n&&o?r.getUserName(o,function(e){e!==n&&B("info",I.ReviewReserved+" "+n)}):e.modifiable?B("info",I.loadOK):B("info",I.ReviewNotModifiable)}},onFailure:function(){return null}}}),e.modifiable||W(),_("onDMUMarkupLoadSucceeded",{id:e.reviewPid})},onImportFailed:K})}function G(e,t){S.getParentTypes(e).then(function(n){t([e].concat(n))}).catch(function(){t([e])})}function z(e,t,n){return L?new Promise(function(n){"SIMItfSimulation"===t?(F||(F=m.getLoadingContextController({context:L})),F.getIsrContext(e).then(function(e){n({contextID:e&&e.length?e[0]:null})})):n({contextID:e})}).then(function(e){var t,o,a,i=L.getRootBagPath().getChildrenPathes();if(0===i.length)n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;else for(let r=0;r<i.length;r++){if(a=u.getNodeID(i[r].getLastElement(!0)),L.getController().isFiltered(a).filterId?t=L.getController().isFiltered(a).filterId:o=a,o&&o===e.contextID){n.loadMarkupAllowed=!0;break}if(t&&a===e.contextID){n.removeFilterAllowed=!0,n.loadProductAllowed=!0,n.loadMarkupAllowed=!0;break}}return Promise.resolve({conditions:n,sessionFilterId:t,sessionProductId:o,sessionRootId:a})}):Promise.resolve()}function H(e,t,n,o,a,i){var r=e.conditions,s=e.sessionRootId,l=null,d=null,c={};G(a,function(e){if(e&&e.length)if(-1!==e.indexOf("DesignSight")||-1!==e.indexOf("SIMItfSimulation")||-1!==e.indexOf("Document")||-1!==e.indexOf("Requirement Specification")||-1!==e.indexOf("Requirement")||-1!==e.indexOf("Specification Report"))if(r.loadMarkupAllowed||-1!==e.indexOf("SIMItfSimulation")){let o;F||(F=m.getLoadingContextController({context:L})),(o="Markup"===t.objectType?E.getDnDReviewAndJSONFile:E.getMarkupStream)({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner},function(o){if(o&&(o.reviewState=o.reviewState||t.currentState),o.jsonObj.Contexts){let t;-1!==e.indexOf("Document")?t="Document":-1!==e.indexOf("Specification Report")&&(t="Specification Report"),t?(o.jsonObj.Contexts[0].documentVersionInfos&&(R=o.jsonObj.Contexts[0].documentVersionInfos),c.objectId=n,c.objectType=a,c.objectParentType=t,c.fileId=R.fileId,c.versionId=R.versions[0],c.versions=R.versions,c.documentType=o.jsonObj.Contexts[0].documentType,i&&i.id&&(c.subContext=i),c.loadMarkup=function(){F.getDocumentVersionInfos().versions[0]!==R.versions[0]&&("normal"===F.getLoadMarkupDocumentMode()?B("info",I.loadMarkupWithNewVersionFile):"delete"===F.getLoadMarkupDocumentMode()&&B("info",I.loadMarkupWithNewFile)),o.contextId=n,i&&i.id&&(o.subContext=i),X(o)},r.loadProductAllowed?F.load({data:c}):r.loadMarkupAllowed&&c.loadMarkup()):-1!==e.indexOf("SIMItfSimulation")&&(l=o.jsonObj.Contexts[0].listData,d=o.jsonObj.Contexts[0].loadingInfos,l&&0!==l.length?(c.objectId=l,c.objectType="PLMPIMMetricReference",c.loadMode=d,c.loadMarkup=function(){o.contextId=n,X(o)},F.load({data:c})):(c.objectId=n,c.objectType=a,c.objectParentType="SIMItfSimulation",c.loadMode=d,c.loadMarkup=function(){o.contextId=n,X(o)},F.load({data:c})))}else-1!==e.indexOf("Requirement")||-1!==e.indexOf("Requirement Specification")?(c.objectId=n,c.objectType=a,c.objectParentType=-1!==e.indexOf("Requirement")?"Requirement":"Requirement Specification",c.loadMarkup=function(){o.contextId=n,X(o)},F.load({data:c})):-1!==e.indexOf("DesignSight")?(c.objectId=n,c.objectType=a,c.objectParentType="DesignSight",c.loadMode=d,c.loadMarkup=function(){o.contextId=n,X(o)},r.loadProductAllowed?F.load({data:c}):r.loadMarkupAllowed&&c.loadMarkup()):-1!==e.indexOf("DELLmiWorkPlanSystemReference")&&(C.getOption("testMbom")||y.getOption("testMbom")||b.getOption("testMbom"))&&(c.objectId=n,c.objectType=a,c.objectParentType="DELLmiWorkPlanSystemReference",c.loadMode=d,c.loadMarkup=function(){o.contextId=n,X(o)},r.loadProductAllowed?F.load({data:c}):r.loadMarkupAllowed&&c.loadMarkup())},K)}else J(I.DragAndDropError);else{if((r.removeFilterAllowed||r.removeProductAllowed)&&L.getController().removeRoots({pids:[s]}),r.loadFilterAllowed&&L.addFilter([{objectId:o}]),r.loadProductAllowed){var u=L.getAutomaticReframePolicy();L.setAutomaticReframePolicy(!1),-1!==e.indexOf("DIFLayout")||-1!==e.indexOf("DIFSheet")?(F||(F=m.getLoadingContextController({context:L})),c.objectId=n,c.objectType=a,c.objectParentType=-1!==e.indexOf("DIFLayout")?"DIFLayout":"DIFSheet",F.load({data:c})):-1!==e.indexOf("DELLmiWorkPlanSystemReference")&&(C.getOption("testMbom")||y.getOption("testMbom")||b.getOption("testMbom"))?(F||(F=m.getLoadingContextController({context:L})),c.objectId=n,c.objectType=a,c.objectParentType="DELLmiWorkPlanSystemReference",F.load({data:c})):"R2V_FeatureState"===a?L.addR2Vs({objects:[{displayName:"r2vName",objectId:n,objectType:"R2V_FeatureState",path:[{resourceid:n,type:"R2V_FeatureState"}],serviceId:"r2vsurvey"}],reframe:!1,displayNotif:!0,dispatch:!0}):L.addRoots({objects:[{path:[n]}]}),L.setAutomaticReframePolicy(u)}let i=()=>{let e;(e="Markup"===t.objectType?E.getDnDReviewAndJSONFile:E.getMarkupStream)({markupId:t.objectId,markupType:t.objectType,markupTitle:t.displayName,markupOwner:t.owner},function(e){e&&(e.reviewState=t.currentState),e.contextId="ENOStrRefinementSpecification"===a?o:n,X(e)},K)};if(r.loadMarkupAllowed)if("Drawing"===a){let e=setInterval(function(){L.getViewer().get2DMode()&&(i(),clearInterval(e),e=null)},100)}else i();else J(I.DragAndDropError)}})}function $(t){return new e.Promise(function(e){function n(){e({status:"KO",msg:I.loadError})}if(!t||!t.objectId||!t.objectType)return void n();let o;(o="Markup"===t.objectType?E.getProductByMarkerId:E.getMarkupInfos)({physicalid:t.objectId},function(t){if(L){var n,o,a,i,r,s,l,d,c={loadProductAllowed:!1,removeProductAllowed:!1,loadFilterAllowed:!1,removeFilterAllowed:!1,loadMarkupAllowed:!1};if(t&&t.MarkupContext&&t.MarkupContext.contexts&&t.MarkupContext.contexts.length){if(1===t.MarkupContext.contexts.length)n=t.MarkupContext.contexts[0].type,w=n;else if(t.MarkupContext.contexts.length>1)for(var p=0;p<t.MarkupContext.contexts.length;p++)"Specification Report"===t.MarkupContext.contexts[p].type?(d=t.MarkupContext.contexts[p].id,n=t.MarkupContext.contexts[p].type,w=n):l={id:t.MarkupContext.contexts[p].id,type:t.MarkupContext.contexts[p].type,label:t.MarkupContext.contexts[p].name}}else"r2vsurvey"===t.MarkupContext.serviceID?n=w="R2V_FeatureState":e({status:"NoContextFound"});if(t&&t.name&&(r=t.name),t&&t.currentState&&(s=t.currentState),n&&"ENOStrRefinementSpecification"===n){var f=[a=t.MarkupContext.contexts[0].id];L.getController().getPrdIdFromFilterId(f).then(function(t){i=function(e,t,n){if(L){var o,a,i,r=L.getRootBagPath().getChildrenPathes();if(0===r.length)n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;else for(let s=0;s<r.length;s++){if(i=u.getNodeID(r[s].getLastElement(!0)),L.getController().isFiltered(i).filterId?o=L.getController().isFiltered(i).filterId:a=i,o&&o===e){n.loadMarkupAllowed=!0;break}if(o&&o!==e&&i===t){n.removeFilterAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}if(a&&t===a){n.removeProductAllowed=!0,n.loadFilterAllowed=!0,n.loadMarkupAllowed=!0;break}}return{conditions:n,sessionFilterId:o,sessionProductId:a,sessionRootId:i}}}(a,o=t,c),e({status:"OK",mkpMaturityState:s,valMarkup:i,mkpName:r,relatedRootId:o,relatedFilterId:a,relatedObjectType:n})}).catch(function(t){window.console.log(t),e({status:"KO",msg:I.loadError})})}else"R2V_FeatureState"===n?z(o=t.MarkupContext.contextIds&&t.MarkupContext.contextIds.length>0?t.MarkupContext.contextIds[0]:t.MarkupContext.contextId,n,c).then(function(t){e({status:"OK",mkpMaturityState:s,valMarkup:t,mkpName:r,relatedRootId:o,relatedFilterId:a,relatedObjectType:n})}):z(o=d||t.MarkupContext.contexts[0].id,n,c).then(function(i){e({status:"OK",mkpMaturityState:s,valMarkup:i,mkpName:r,relatedRootId:o,relatedFilterId:a,relatedObjectType:n,relatedSubContext:l,mkpOwner:t.owner})})}},n)})}function Q(e){V.getMarkupJson({markupId:e.markup.getPlmID(),markupName:e.markup.getName()},e.onLoadingCompleted,e.onLoadingFailed,e.markup)}function Y(e){s.importModel({dataJson:e.asset.jsonObj,appType:e.asset.ID,mkpRepRef:e.asset.markupCtx,viewer:L.getViewer(),onImportFailed:e.onImportFailed,onImportCompleted:e.onImportCompleted})}this.subscribe=function(e,t){if(T&&e&&t)return T.subscribe({event:e},t)},this.unsubscribe=function(e){T&&e&&T.unsubscribe(e)},this.load=function(e){e.objectId&&L&&(g.on(I.LoadingPanel,null),N++,$(e).then(function(t){"KO"===t.status?J(I.loadError):"NoContextFound"===t.status?J(I.loadMarkupNoContext):(e.displayName=t.mkpName,e.owner=t.mkpOwner,e.currentState=t.mkpMaturityState,H(t.valMarkup,e,t.relatedRootId,t.relatedFilterId,t.relatedObjectType,t.relatedSubContext))}))},this.loadIfContextLoaded=function(e){if(L)return new Promise(function(t){$(e).then(function(n){if(L){var o=n.valMarkup.conditions;"OK"!==n.status||o.removeFilterAllowed||o.removeProductAllowed||o.loadFilterAllowed||o.loadProductAllowed||!o.loadMarkupAllowed?t(!1):(e.currentState=n.mkpMaturityState,H(n.valMarkup,e,n.relatedRootId,n.relatedFilterId,n.relatedObjectType),t(!0))}})})},this.getMarkupContextType=function(){return w},this.getDocumentVersionInfos=function(){return R},this.loadValidation=function(e){let t,o,a,r,s,l=0,d=["Requirement Specification","Requirement","DIFLayout","DIFSheet","Document","Specification Report","SIMItfSimulation","PLMPIMMetricReference","DesignSight"];if(F||(F=m.getLoadingContextController({context:L})),L){var c,g=p.getReviewContext({context:L});if(g&&(c=g.getValidation()),e.reviewId){var S=p.giveEventsController({viewer:L.getViewer()}),C=null,y=function(e){return new Promise(function(n){if(e){var i=e.getRepRef();i?S.fireEvent("onGetMarkupJsonEvt",{markup:i,onLoadingCompleted:function(e,i){let r=()=>{e.markupCtx=i,S.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(e){if(e&&e[0]){var t=e[0].getMarkupContent?e[0].getMarkupContent():e[0];t&&(i.getMarkupContent()||i.setMarkupContent(t),t.getMarkupOwner()||t.setMarkupOwner(i),C&&t.setReadOnly(C.isReadOnly()||i.isReadOnly()))}n("OK")}})},c=a||o;if(-1!==d.indexOf(c))if(0!==l||L.getRoots().length)L.getRoots().length&&S.fireEvent("onLoadedReviewContext",{rootType:c}),r();else{let n=L.subscribe({event:"onRootAdded"},function(){L.unsubscribe(n),r()});l++;let a={};if(e.jsonObj.Contexts){if("Document"===c||"Specification Report"===c){if(e.jsonObj.Contexts[0].documentVersionInfos&&(R=e.jsonObj.Contexts[0].documentVersionInfos),a.objectId=t,a.objectType=o,a.objectParentType=c,a.fileId=R.fileId,a.versionId=R.versions[0],a.versions=R.versions,a.documentType=e.jsonObj.Contexts[0].documentType,s&&(a.subContext=s),F.load({data:a}),S)var u=S.addEvent("onGetDocumentsCompleted",function(){S.removeEvent(u);let e=p.getReviewContext({context:L});if(e){let t,n=e.getReviewCtxInformation();t=s?{title:s.label}:F?F.getTempObjectInformations():void 0,n.tempObjectInfo=t,e.setReviewCtxInformation(n)}})}else if("SIMItfSimulation"===c){let n=e.jsonObj.Contexts[0].listData,i=e.jsonObj.Contexts[0].loadingInfos;n&&0!==n.length?(a.objectId=n,a.objectType="PLMPIMMetricReference",a.loadMode=i,F.load({data:a})):(a.objectId=t,a.objectType=o,a.objectParentType="SIMItfSimulation",a.loadMode=i,F.load({data:a}))}}else a.objectId=t,a.objectType=o,a.objectParentType=c,s&&s.id&&(a.subContext=s),F.load({data:a})}else r()},onLoadingFailed:function(){n("KO")}}):n("KO")}else n("KO")})},b=function(l){var g,b,x,M;new Promise(e=>{if(l&&l.children){F||(F=m.getLoadingContextController({context:L}));let t=0;l.children.forEach(n=>{if(n&&"DMUValidationContext"===n.type)if("r2vsurvey"===n.serviceID)(function(e){return new Promise((t,n)=>{require("DS/WAFData/WAFData").authenticatedRequest(v.getPlatformURL(e.serviceId)+"/enovia/resources/r2v/v1/modeler/featurestate/fetch",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":D.getSetting("lang")},data:JSON.stringify({ids:[e.objectId]}),timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})})({serviceId:n.serviceID,objectId:n.contextIds[0]}).then(t=>{M=t.result[0]["ds6w:label"],n.contexts=[{id:n.contextIds[0],name:t.result[0]["ds6w:label"],type:t.result[0].type,loadedR2VInfo:[{id:n.contextIds[0],info:t.result}]}],g=n.contexts,x=n.serviceID,l.children.forEach(e=>{e&&"DMUValidationValidated"===e.type&&(sessionStorage.getItem(e.id)||sessionStorage.setItem(e.id,"true"),"true"===sessionStorage.getItem(e.id)&&(e.validatedObjects=[{PathElements:[n.contextIds[0]],referenceName:M,instanceName:M}]))}),e()});else{if(g=n.contexts,n.contexts&&2===n.contexts.length){let e=n.contexts.findIndex(e=>!("Specification Report"===e.type));n.contexts[e].subContext=!0}e()}else++t===l.children.length&&e()})}}).then(async()=>{let m,v;if(L.getApplicativeData().getLoadedItfData&&L.getApplicativeData().getLoadedItfData().data.length?m=L.getApplicativeData().getLoadedItfData().data[0].isrID:L.getRootBagPath().getChildrenPathes().length>0&&(m=u.getNodeID(L.getRootBagPath().getChildrenPathes()[0].getLastElement(!0))),g)if(1===g.length)t=g[0].id,o=g[0].type;else if(2===g.length){let e=g.find(e=>"Specification Report"===e.type);e?(t=e.id,o=e.type):r=!0}if(L.getController().isFiltered(m).filterId&&(v=L.getController().isFiltered(m).filterId),m&&m!==t&&v!==t)B("error",I.valDragAndDropError),e.cbFailed();else{m&&c&&(p.removeReviewContext({context:L}),S&&S.fireEvent("onDMURemoveSessionReview")),(C=await n.createReviewContext({context:L,typeObject:"Review"})).setReadOnly(e.readOnly);var D=new i({viewer:L,DMUExperience:C}),w=null;P||k||(P=S.addEvent("onGetMarkupJsonEvt",Q),k=S.addEvent("onImportModelEvt",Y));var R=async function(){var i=(w=D.importValidationFromJSON(l,e.editionMode)).getContext()&&w.getContext().getMainContextID()?w.getContext().getMainContextID():void 0;w.getContext()&&w.getContext().getSubContextID()&&(s={id:w.getContext().getSubContextID(),label:w.getContext().getSubContextName(),type:w.getContext().getSubContextType()}),(await n.createReviewContext({context:L})).setReviewCtxInformation({reviewId:w.getPlmID(),highlightId:e.type&&"DMUValidationExposedPresentation"===e.type?e.reviewId:void 0,reviewName:e.displayName?e.displayName:w.getName(),reviewType:e.type?e.type:w.getType(),contextId:i,modifiable:!(e.readOnly?e.readOnly:w.isReadOnly()),owner:w.getOwner()}),f.setSlidePreferences({context:L.getFrameWindow(),preferences:{panelTitle:l.name}});var r=null;if(r=L.subscribe({event:"onRootAdded"},function(){e.cbRootAdded(),L.unsubscribe(r)}),t&&m!==t&&"refreshMode"!==e.loadMode){var c=w.getContext().getJsonContextIDs();-1===d.indexOf(a)&&("R2V_FeatureState"===a?L.addR2Vs({objects:[{displayName:M,objectId:i,objectType:"R2V_FeatureState",path:[{resourceid:i,type:"R2V_FeatureState"}],serviceId:x}],reframe:!1,displayNotif:!0,dispatch:!0}):L.addRoots({objects:[{path:c}]}))}var v=[],h=[],C=function(e,t){e.getReplies().forEach(function(e){t.push(e),C(e,t)})};w.getMarkups().forEach(function(e){C(e,h),e.hasStream()&&v.push(y(e))}),h.forEach(function(e){e.hasStream()&&v.push(y(e))});var b=function(t){var n=w.getLoadedRepRefs();if(n.length>0){if(w.setCurrentMarkup(n[0]),w.refreshNode(),L.getViewer().render(),t?B("warning",I.loadValSomeMkup):B("success",I.loadValSuccess),!g){let e=p.getReviewContext({context:L}).getValidation().getMarkups();S.fireEvent("reviewNoContextModeOn",{markups:e});let t=L.subscribe({event:"onRootAdded"},function(e){let n=u.getNodeType(e.path.getLastElement(!0));S.fireEvent("reviewNoContextModeOff",{rootType:n}),L.unsubscribe(t)})}S.fireEvent("OnReviewMarkupLoaded",{commentId:e.commentId?e.commentId:null}),e.cbOK()}else e.cbFailed()};if(v.length>0)Promise.all(v).then(function(){b()},function(){b(!0)});else{if(!g){let e=p.getReviewContext({context:L}).getValidation().getMarkups();S.fireEvent("reviewNoContextModeOn",{markups:e});let t=L.subscribe({event:"onRootAdded"},function(e){let n=u.getNodeType(e.path.getLastElement(!0));S.fireEvent("reviewNoContextModeOff",{rootType:n}),L.unsubscribe(t)})}let e={};e.objectId=t,e.objectType=o,e.objectParentType=a||o,F.load({data:e}),B("warning",I.loadValNoMarkup)}};o&&t&&!r?G(o,function(t){const n=["VPMReference","Document","Requirement","Requirement Specification","Drawing","SIMItfSimulation","Specification Report","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_FeatureState"];let i=!1;if(t)for(b=0;b<t.length;b++){if(n.includes(t[b])&&(i=!0,a=t[b],h.setParentType(o,a)),"PPRContext"===t[b]){i=!1;break}if("Requirement"===t[b]||"Drawing"===t[b]||"DIFSheet"===t[b]||"DIFLayout"===t[b]){if(i=!0,l.children)for(let e=0;e<l.children.length;e++)if("Markup"===l.children[e].type&&l.children[e].children){for(let t=0;t<l.children[e].children.length;t++)if("false"===l.children[e].children[t].webMarkup){i=!1;break}if(!1===i)break}if(!1===i)break}}if(i)R();else if(t&&-1!==t.indexOf("ENOStrRefinementSpecification")){if(l&&l.children)for(b=0;b<l.children.length;b++)if(l.children[b]&&"DMUValidationContext"===l.children[b].type){g=l.children[b].contexts;break}L.getController().getPrdIdFromFilterId([g[0].id]).then(function(){"refreshMode"!==e.loadMode&&L.addFilter([{objectId:g[0].id}]),function(e){var t=e.valImporter.importValidationFromJSON(e.jsonNode,e.editionMode);f.setSlidePreferences({context:L.getFrameWindow(),preferences:{panelTitle:e.jsonNode.name}});var n=[],o=[],a=function(e,t){e.getReplies().forEach(function(e){t.push(e),a(e,t)})};t.getMarkups().forEach(function(t){a(t,o),n.push(e.loadMarkup(t))}),o.forEach(function(t){n.push(e.loadMarkup(t))});var i=function(n){var o=t.getLoadedRepRefs();o.length>0?(t.setCurrentMarkup(o[0]),t.refreshNode(),L.getViewer().render(),n?B("warning",I.loadValSomeMkup):B("success",I.loadValSuccess),e.cbOK(),p.giveEventsController({viewer:L.getViewer()}).fireEvent("OnReviewMarkupLoaded")):e.cbFailed()};n.length>0?Promise.all(n).then(function(){i()},function(){i(!0)}):B("warning",I.loadValNoMarkup)}({jsonNode:l,editionMode:e.editionMode,valImporter:D,loadMarkup:y,cbOK:e.cbOK})})}else e.cbFailed(),B("error",I.loadValContextError)}):m||g?(B("error",I.valMultiContextDragAndDropError),e.cbFailed()):R()}})},x=function(){B("error",I.loadValError),e.cbFailed()};"DMUValidationValidation"===e.type&&V.getAllElementsByValidationId({validationId:e.reviewId,onSuccess:b,onFailure:x}),"DMUValidationExposedPresentation"===e.type&&V.getValidationFromHighlightId({highlightId:e.reviewId,onSuccess:function(t){t&&c&&c.getPlmID()===t.id?e.cbOK({sameReview:!0}):b(t)},onFailure:x})}else B("error",I.valDragAndDropError)}},this.clearController=function(){if(M&&M.destroy(),P&&k){var e=p.giveEventsController({viewer:L.getViewer()});e.removeEvent(P),e.removeEvent(k),P=k=null}L=M=T=E=w=null}}}),M=[];return e.singleton({init:function(){},giveLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<M.length;t++)if(M[t].context===e.context)return M[t].controller},getLoadMarkupServices:function(e){var t;if(e&&e.context&&!(t=this.giveLoadMarkupServices(e))){var n=new x({ctxViewer:e.context});t=Object.freeze({load:function(e){n&&n.load(e)},loadValidation:function(e,t,o){if(n)return n.loadValidation(e,t,o)},loadIfContextLoaded:function(e){if(n)return n.loadIfContextLoaded(e)},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},getMarkupContextType:function(){if(n)return n.getMarkupContextType()},clearController:function(){n&&(n.clearController(),n=null)},getDocumentVersionInfos:function(){if(n)return n.getMarkupContextType()}}),M.push({context:e.context,controller:t})}return t},unreferenceLoadMarkupServices:function(e){if(e&&e.context)for(var t=0;t<M.length;t++)if(M[t].context===e.context){M[t].controller.clearController(),M.splice(t,1);break}}})});