define("DS/DataAnalyzerWidget/DataAnalyzerWidget",["UWA/Controls/Abstract","DS/WAFData/WAFData","DS/WebToWinInfra/WebToWinCom","DS/WebInWinHelper/WebInWinHelper","DS/Controls/Accordeon","DS/Controls/Button","DS/Controls/Tab","DS/Tree/FileTreeView","DS/Tree/Tree","DS/UIKIT/Scroller","DS/ENOCollabToolsUI/tracker/ENOCollabTracker","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/DataAnalyzerWidget/assets/nls/DataAnalyzerWidgetNls","css!DS/DataAnalyzerWidget/DataAnalyzerWidget"],function(e,t,n,i,r,a,s,o,l,c,u,p,m){"use strict";return e.extend({init:function(e,t,i){var r=this;this.widget=e,this.parentWidget=t,this.options=i,this.wintop=!1,this.runmyapp=!1,this.odtmode=!1,this.tenant=null,i&&i.odtmode&&(this.odtmode=i.odtmode),this._parent(i),i&&i.wintop?(this.wintop=!0,this.container=UWA.createElement("div",{class:"dataanalyse_popup",id:"dataanalyse_popup"}),this._computingTxt=new UWA.Element("text",{text:m.computing}),this._computingTxt.inject(this.container),this._computingTxt.hide(),this.webToWinCom_Socket=n.createSocket({socket_id:"WebInWin_DataAnalyzerWidget_Socket_"+Math.floor(1e5*Math.random()+1)}),void 0!==this.options.serverUrl&&this.options.serverUrl.length>0&&void 0!==this.options.serverUrl[0].platformId&&(this.tenant=this.options.serverUrl[0].platformId,this["3DSpaceURL"]=this.options.serverUrl[0]["3DSpace"]),this.addEvent("onComplete",()=>{this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"ClosePanel",notif_parameters:"ClosePanel"},"lf_web_in_win")})):i&&i.runmyapp&&(this.runmyapp=!0,this.container=UWA.createElement("div",{class:"dataanalyse_popup",id:"dataanalyse_popup"}),this._getPlatformServices(void 0,function(e){console.log("_getPlatformServices("+JSON.stringify(e)+")"),r.tenant=e[0].platformId,r["3DSpaceURL"]=e[0]["3DSpace"]}))},initDatafromWin:function(e){var t=[];e.forEach(function(e){var n=e.physicalId,i=e.name,r={physicalid:n,name:i,displayName:i};e.hasOwnProperty("config_filter")&&(r.config_filter=e.config_filter),t.push(r)}),this.executeCmd(t)},initDatafromDrop:function(e){var t=[];e.forEach(function(e){var n=e.physicalId,i=e.name,r={physicalid:n,name:i,displayName:i};e.hasOwnProperty("config_filter")&&(r.config_filter=e.config_filter),t.push(r)}),this.executeCmd(t)},executeCmd:function(e){var n=this;if(this.trackerEventBeginTime=Date.now(),this.physicalIds=[],0===e.length)throw p.noObject;e.forEach(function(e){if(e.hasOwnProperty("physicalid")&&""===e.physicalid)throw p.epmtyPhysicalId;n.physicalIds.push(e)});var i=n._get3DSpaceWSUrl(n.tenant,"/resources/pno/person/getsecuritycontext",null);t.authenticatedRequest(i,{type:"json",method:"GET",proxy:"passport",headers:n._getHeaders(),timeout:6e5,onComplete:function(t){n.securityContext="ctx::"+t.SecurityContext,n._executeAnalysis(function(t){n._showCommandUI(e,t)},function(t){n._showCommandFailed(e,t)})},onFailure:function(e,t){console.log("getSecurityContext:Failure..."+e)},ontimeout:function(){console.log("getSecurityContext: A connection timeout occurred.")}})},_getPlatformServices:function(e,t,n){require(["DS/i3DXCompassServices/i3DXCompassServices"],function(i){e&&""!==e||(e=widget.getValue("PlatFormInstanceId")),e&&""!==e||(e=void 0),i.getPlatformServices({platformId:e,onComplete:t,onFailure:n})})},_get3DSpaceWSUrl:function(e,t,n){var i=this["3DSpaceURL"]+t+(t.indexOf("?")<0?"?":"&")+"tenant="+e;return null!=n&&null!=n&&(i=i+"&"+n),i},_getHeaders:function(e){var t={Accept:"application/json","Content-Type":"application/json"};return e&&(t.SecurityContext=e),t},_setWaitingResponse:function(){this.widget?this.widget.body.style.cursor="wait":document.body.style.cursor="wait",this._computingTxt&&this._computingTxt.show()},_setEndWaitingResponse:function(){this.widget?this.widget.body.style.cursor="default":document.body.style.cursor="default",this._computingTxt&&this._computingTxt.hide()},_showCommandFailed:function(e,t){console.log(t);var n=null;if(t&&t.status&&t.status,t&&t.report&&t.report.length>=1){n=m.error_message_report;for(var i=0;i<t.report.length;i++){var r=t.report[i];null!==r&&r.hasOwnProperty("message")&&(n=n+"\n"+r.message)}}if(t&&t.error&&t.error.length>=1){n="";var a=t.error[0];null!==a&&a.hasOwnProperty("message")&&(n=a.message);for(i=1;i<t.error.length;i++)null!==(a=t.error[i])&&a.hasOwnProperty("message")&&(n=n+"\n"+a.message)}null===n&&(n=m.error_message_invalid_server_response),this.wintop||this.odtmode?this.webToWinCom_Socket.dispatchEvent("onDispatchToWin",{notif_name:"onDisplayErrorMessage",notif_parameters:{severity:"warning",message:n}},"lf_web_in_win"):alert("computation failed:\n"+n),this.dispatchEvent("onDisplayErrorMessage")},_showCommandUI:function(e,t){var n=null;if((this.wintop||this.runmyapp)&&(this.container.empty(),(n=UWA.createElement("div",{class:"dataanalyse_content"})).inject(this.container)),1!=e.length||this.wintop?1==e.length?new UWA.Element("h5",{text:m.H5Title1+":"}).inject(n):new UWA.Element("h5",{text:m.H5TitleS+":"}).inject(n):new UWA.Element("h5",{text:m.H5Title+e[0].displayName+":"}).inject(n),t&&t.hasOwnProperty("summary")){var i=[],a=t.summary,s=!1,o=!1,l=this._itemSummaryCount(a);l&&(i.push(l),s=!0);var p=this._itemSummaryDepth(a);p&&(i.push(p),o=!0);var h=new UWA.Element("div",{id:"advanced_div",class:"dataanalyze_advanced"}),d=this._itemSummaryTypes(a,this.tenant);d&&d.inject(h);var y=e[0].displayName,_=this._DumpList(y,a,t,this.tenant);_&&_.inject(h);var f={header:m.AdvancedSection,content:h};i.push(f);var v=new r({items:i,exclusive:!1,style:"simple",recId:"displayedSummaryInt"});v.getContent().setAttribute("id","displayedSummaryExt"),v.inject(n),v.items.length>0&&(s||o)&&v.expandItem(0),v.items.length>1&&o&&v.expandItem(1),t.hasOwnProperty("elapse_time")&&t.hasOwnProperty("cloudview_elapse_time")&&new UWA.Element("text",{class:"dataanalyze_elapses_time",text:m.elapse_time+t.elapse_time+"(ms) , "+m.cloudview_elapse_time+t.cloudview_elapse_time+"(ms)"}).inject(n)}this.runmyapp&&new c({element:n}).inject(this.container),this.dispatchEvent("onResultDisplayed");let g=this.trackerEventBeginTime?Date.now()-this.trackerEventBeginTime:0,w={UXName:"DataAnalyzer",numberObjects:t&&t.summary?t.summary.nbObjects:0,actionStatus:"success",actionTime:g},S=u.createInitActionEvent(w);u.checkAndTrackPageEvent(S)},_executeAnalysis:function(e,t){var n=this.physicalIds;this._analysisServiceRequest(n,[],function(n){n&&n.status&&"failure"!==n.status&&"error"!==n.status&&"success"===n.status&&n.results?e(n.results):t(n)})},_analysisServiceRequest:function(e,n,i){var r=this;1==e.length&&e[0]?console.log("DATA ANALYSIS: "+e[0].physicalid+"\n"):e.length>1?console.log("DATA ANALYSIS: "+e.length+" objects\n"):console.log("DATA ANALYSIS: ???\n");var a=JSON.stringify({data:e,options:n}),s=r.securityContext,o=this._get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/dataanalyze/structure","SecurityContext="+s);this._setWaitingResponse(),t.authenticatedRequest(o,{method:"POST",headers:r._getHeaders(encodeURIComponent(s)),timeout:864e5,onComplete:function(e){r._setEndWaitingResponse(),console.log("DATA ANALYSIS: COMPLETED\n"),i(e)},data:a,onTimeout:function(e){r._setEndWaitingResponse(),console.log("DATA ANALYSIS: Timeout error\n"),i({status:"failure",error:{message:m.error_message_timeout}})},onFailure:function(e,t){r._setEndWaitingResponse(),console.log("DATA ANALYSIS: Failed to retrieve data from the server\n"),console.log(t),i({status:"failure",error:{message:m.error_message_request_failed}})},type:"json"})},_itemSummaryCount:function(e){if(null!==e){var t=0;e.hasOwnProperty("nbObjects")&&(t=e.nbObjects);var n=0;e.hasOwnProperty("nbEntities")&&(n=e.nbEntities);var i=0;e.hasOwnProperty("nbRelations")&&(i=e.nbRelations);var r=new UWA.Element("div",{id:"itemSummaryCount_div"}),a=new UWA.Element("ul").inject(r);return n>1?new UWA.Element("li",{text:n+m.itemSummaryCount_entities}).inject(a):new UWA.Element("li",{text:n+m.itemSummaryCount_entity}).inject(a),i>=1&&new UWA.Element("li",{text:i+m.itemSummaryCount_relations}).inject(a),{header:m.itemSummaryCount_summaryItem+t,content:r}}},_itemSummaryDepth:function(e){if(null!==e&&e.hasOwnProperty("max_depth")&&e.max_depth>0){var t=new UWA.Element("div",{id:"itemSummaryDepth_div"}),n=new UWA.Element("ul").inject(t);return new UWA.Element("li",{text:m.replace(m.itemSummaryDepth_one_structure,{max_depth:e.max_depth})}).inject(n),{header:m.itemSummaryDepth_header,content:t}}if(null!==e&&e.hasOwnProperty("structures")){var i=e.structures;t=new UWA.Element("div",{id:"itemSummaryDepth_div"});new UWA.Element("text",{text:m.replace(m.itemSummaryDepth_several_structures,{nbStructures:i.length})}).inject(t);n=new UWA.Element("ul").inject(t);return i.forEach(function(e){if(e.hasOwnProperty("nbObjects")&&e.hasOwnProperty("max_depth")){var t=e.nbObjects,i=e.max_depth;new UWA.Element("li",{text:m.replace(m.itemSummaryDepth_composed_of,{structure_nb_objects:t,max_depth:i})}).inject(n)}}),{header:m.itemSummaryDepth_header,content:t}}},_itemSummaryTypes_ListContent:function(e,t,n){var i=this,r=new UWA.Element("div",{class:"itemSummaryTypes_ListContent",id:"itemSummaryTypes_ListContent_div"}),a=new UWA.Element("table").inject(r);return t.forEach(function(t){if(null!==t&&t.hasOwnProperty("name")&&t.hasOwnProperty("count")){var r=t.name,s=parseInt(t.count);if(e.hasOwnProperty(r)){var o=e[r];if(null!==o&&o.hasOwnProperty("icon")){var l="";l=o.hasOwnProperty("nls")&&null!==o.nls&&""!==o.nls?o.nls:"`"+o.name+"`";var c="";o.hasOwnProperty("icon")&&null!==o.icon&&""!==o.icon&&(c=o.icon);var u=new UWA.Element("tr").inject(a),p=i._get3DSpaceWSUrl(n,c),m=new UWA.Element("td").inject(u);new UWA.Element("img",{src:p}).inject(m);var h=new UWA.Element("td",{class:"dataanalyze_typelist_count_td"}).inject(u);new UWA.Element("text",{text:s+" "}).inject(h);var d=new UWA.Element("td").inject(u);new UWA.Element("text",{text:l+"(s)"}).inject(d)}}else console.log("_itemSummaryTypes_ListContent / not found "+r)}}),r},_typeGoThru:function(e,t,n,i,r){if(i.hasOwnProperty(e)){var a=i[e],s=null;r.hasOwnProperty(e)?s=r[e]:(s={name:e,nls:"",icon:"",count:0,isroot:!1,nodechildren:[],irpc:""},r[e]=s,null!==a&&a.hasOwnProperty("nls")&&(s.nls=a.nls),null!==a&&a.hasOwnProperty("icon")&&(s.icon=a.icon),null!==a&&a.hasOwnProperty("irpc")&&(s.irpc=a.irpc),null!==a&&a.hasOwnProperty("parent")&&null!==a.parent?s.isroot=!1:(s.isroot=!0,r.push(s))),s.count=s.count+n,null===t||s.nodechildren.hasOwnProperty(t.name)||(s.nodechildren[t.name]=t,s.nodechildren.push(t)),null!==a&&a.hasOwnProperty("parent")&&null!==a.parent&&this._typeGoThru(a.parent,s,n,i,r)}else console.log("_typeGoThru / not found "+e)},_convertTypesListAsTreeNode:function(e,t,n){var i=this,r=!1,a="";t.hasOwnProperty("nls")&&null!==t.nls&&""!==t.nls?(a=t.nls+" ("+t.count+")",r=!0):a="`"+t.name+"` ("+t.count+")",t.label=a;var s=this._get3DSpaceWSUrl(n,t.icon);t.icons=[s],t.data=t;var o=[];if(t.nodechildren.forEach(function(t){var r=i._convertTypesListAsTreeNode(e,t,n);for(var a in r)o.push(r[a])}),r&&(1!=o.length||t.isroot||1==o.length&&o[0].count!=t.count)){if(0!=o.length)for(var l in t.children=[],o)t.children.push(o[l]);return[t]}return r?1==o.length&&console.log("_convertTypesListAsTreeNode / skipping only 1 child: "+a):console.log("_convertTypesListAsTreeNode / skipping not displayable: "+a),o},_itemSummaryTypes_TreeContent:function(e,t,n){var i=this,r=[];t.forEach(function(t){if(null!==t&&t.hasOwnProperty("name")&&t.hasOwnProperty("count")){var n=t.name,a=parseInt(t.count);i._typeGoThru(n,null,a,e,r)}});var a=null,s=null,l=null,c=null,u=null,p=null,m=[],h=[],d=[];r.forEach(function(e){"PLMCoreInstance"==e.name?a=e:"PLMCoreRepInstance"==e.name?l=e:"PLMCoreReference"==e.name?s=e:"PLMCoreRepReference"==e.name?c=e:"PLMPort"==e.name?u=e:"PLMConnection"==e.name?p=e:e.isroot&&"PLMInstance"==e.irpc?a.push(e):e.isroot&&"PLMRepInstance"==e.irpc?l.push(e):e.isroot&&"PLMReference"==e.irpc?s.push(e):e.isroot&&"PLMRepReference"==e.irpc?c.push(e):e.isroot&&"PLMConnection"==e.irpc?p.push(e):e.isroot&&"PLMPort"==e.irpc?u.push(e):e.isroot&&"entity"==e.irpc?m.push(e):e.isroot&&"relation"==e.irpc?h.push(e):d.push(e)}),r=[],null!==s&&r.push(s),null!==a&&r.push(a),null!==c&&r.push(c),null!==l&&r.push(l),null!==p&&r.push(p),null!==u&&r.push(u),r=(r=(r=r.concat(m)).concat(h)).concat(d);var y=new UWA.Element("div",{id:"itemSummaryTypes_TreeContent_div",class:"dataanalyze_itemSummaryTypes_TreeContent"});return r.forEach(function(e){i._convertTypesListAsTreeNode(y,e,n)}),new o({apiVersion:2,roots:r}).inject(y),y},_itemSummaryTypes:function(e,t){var n=new UWA.Element("div",{id:"itemSummaryTypes_div"});if(null!==e&&e.hasOwnProperty("typesinfo")&&e.hasOwnProperty("typescount")){var i=e.typesinfo,r=e.typescount;if(null!==i&&0!==i.length&&null!==r&&0!==r.length){var a=new s({displayStyle:"panel",multiSelFlag:!0,reorderFlag:!1,showComboBoxFlag:!0,recId:"typeSummaryTab"});a.tabBar.closeButtonFlag=!1,a.tabBar.centeredFlag=!1;var o=this._itemSummaryTypes_ListContent(i,r,t),l=this._itemSummaryTypes_TreeContent(i,r,t);a.add({label:m.Types_as_list,content:o,index:0,value:0}),a.add({label:m.Types_as_tree,content:l,index:1,value:1}),a.value=[0],a.inject(n)}}return n},_DumpList:function(e,t,n,i){var r=this,s=new UWA.Element("div");if(s.setStyle("padding-top","10px"),null!=n&&n.hasOwnProperty("structure")&&null!=t&&t.hasOwnProperty("typesinfo")){var o=n.structure,l=t.typesinfo,c=["id","type","irpc","primarytype","interface","name","revision","physicalid","policy","owner","project","organization","PLM_ExternalID","V_Name","current","V_discipline","V_Owner","V_InstanceOf"],u=new a({label:m.Dump_objects,recId:"dumpButton",domId:"dumpButton"});u.inject(s),u.addEventListener("buttonclick",function(t){var n="",i=0;for(i=0;i<c.length;i++)n+=c[i],i!==c.length-1&&(n+=",");n+="\n";var a={};if(null!=l)for(var s in l)if(l.hasOwnProperty(s)){var u=l[s];a.hasOwnProperty(u.name)||(a[u.name]=[]),a[u.name].push(u)}o.forEach(function(e){var t=e.type;if(a.hasOwnProperty(t)){var r=a[t],s=null;null!=r&&r.length>=1&&(s=r[0]),null!=s&&s.hasOwnProperty("irpc")&&(e.irpc=s.irpc)}for(i=0;i<c.length;i++){var o=c[i];null!==e&&e.hasOwnProperty(o)&&(n+=e[o]),i!==c.length-1&&(n+=",")}n+="\n"});var p=new Blob([n],{type:"data:text/csv;charset=utf-8"}),m=window.document.createElementNS("http://www.w3.org/1999/xhtml","a");m.href=URL.createObjectURL(p),m.download=e+".csv";var h=new MouseEvent("click");r.odtmode||m.dispatchEvent(h)})}return s}})});