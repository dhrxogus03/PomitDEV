/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerMIRController",["UWA/Class","DS/PADUtils/PADSettingsMgt"],function(e,t){"use strict";return e.extend({name:"_PAD3DViewerMIRController",hasMeshInRAM:function(e){var i=null;return!0===t.getSetting("enopad3dviewer_lightNodeModel")&&(i=this._model.hasMeshInRAM(e)),i},lockGlobalMeshInRAM:function(){!0===t.getSetting("enopad3dviewer_lightNodeModel")&&this._model.lockGlobalMeshInRAM()},unlockGlobalMeshInRAM:function(){!0===t.getSetting("enopad3dviewer_lightNodeModel")&&this._model.unlockGlobalMeshInRAM()},lockRepresentationMeshInRAM:function(e){!0===t.getSetting("enopad3dviewer_lightNodeModel")&&this._model.lockRepresentationMeshInRAM(e)},unlockRepresentationMeshInRAM:function(e){!0===t.getSetting("enopad3dviewer_lightNodeModel")&&this._model.unlockRepresentationMeshInRAM(e)}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerFocusOnCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._context=i.get(this.options.context)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerFocusOnCmd"}),i.trackPageEvent()});var e=this;require(["DS/Selection/CSOManager","DS/PADUtils/PADCommandProxy"],function(t,i){var o=i.create();if(o){var n=t.get(),s=[];if(n.length){n.forEach(function(t){var i=t.pathElement,o=e._context.streamPath(i);s.push(o)});var r=require("DS/PADUtils/PADUtilsServices");o.focus({intent:"focus",paths:s,widget:"3D",sharedID:r.getSharedId(),appID:r.getAppId()})}}e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerFocusOnCmd",o)}),define("DS/ENOPAD3DViewer/views/PADLayerSearchView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r,a){"use strict";function l(e){this.options=e||{},this.elements={},this._tokensXSO=[],this._nbChildren=0,this._elementSize=39,this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},cellActivationFeedback:"row",showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",columns:[{dataIndex:"hidden",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"colorSquare",typeRepresentation:"color",editableFlag:!0,sortableFlag:!1,resizableFlag:!1,width:5,alignment:"center",editionPolicy:"EditionOnOver",getCellTooltip:function(e){return{shortHelp:n.changeSearchResultColor,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}}},this._mdlEvts=new r,this._buildContent()}return l.prototype.getHeader=function(){return n.searchLayer.title},l.prototype.getIcon=function(){return s.getSetting("newLayerView")?{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_SearchInCurrentTab.png")}:void 0},l.prototype.render=function(){return this.elements.container},l.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this)),s.addEventListener("liveChange",this._colorChange.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},l.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},l.prototype.selectItemIdx=function(e){this.options.dgv.setActiveCell(0);var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},l.prototype.addChild=function(e){this.options.model.addChild(e),this._nbChildren++},l.prototype.removeChild=function(e){this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:l.layerName}})},l.prototype.getModelEvents=function(){return this._mdlEvts},l.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility()}},l.prototype._colorChange=function(e,t){t&&t.nodeModel&&t.nodeModel.options.grid&&"colorSquare"===this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)&&t.nodeModel.updateSearchLayerColor(e.srcElement.dsModel.value)},l.layerName="search",l}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerRootInfoPanelCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/PADServices/utils/GlobalModelEvents"],function(e,t,i,o){"use strict";return t.extend({_context:null,_callbackAdd:!1,init:function(e){this._parent(e,{}),this._context=i.get();var t=this,n=!1;e.isEnabled&&this._context.elements.triptych&&this._context.elements.triptych.getLeftOpen()&&this.setState(!0),t._context.elements.triptych&&t._context.elements.triptych._modelEvents&&(t._context.elements.triptych._modelEvents.subscribe({event:"triptych-hide-panel"},function(e){"left"===e&&(n=!0,t.setState(!1,!1))}),o.subscribe({event:"ENXViews/Triptych/onOverlayClick"},function(e){e&&"left"===e&&!0===t.getState()&&(n=!0,t.toggleState(!1,!1))}),t._callbackAdd=!0),this.onStateChange(function(){if(n)require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerRootInfoPanelCmd-close"}),i.trackPageEvent()}),n=!1;else{if(require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerRootInfoPanelCmd-"+(this.getState()?"open":"close")}),i.trackPageEvent()}.bind(this)),this._context.elements.triptych.getLeftOpen()&&this.getState()||!this._context.elements.triptych.getLeftOpen()&&!this.getState())return;this._context.elements.triptych.togglePanel("left")}}.bind(this))},addCallback:function(){!1===that._callbackAdd&&(this._context.elements.triptych._modelEvents.subscribe({event:"triptych-hide-panel"},function(e){"left"===e&&(change_state_from_close=!0,that.setState(!1,!1))}),that._callbackAdd=!0)}})}),define("DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions",["UWA/Class","UWA/Class/Options","DS/CoreEvents/ModelEvents"],function(e,t,i){"use strict";var o=e.singleton(t,{name:"PAD3DPOIGroupingOptions",_clusteringEnabled:!1,_clusteringType:null,_groupEngineInitialized:!1,_proximityMergingActive:!1,_proximityMergingEnabled:!1,_mergingThreshold:.001,_maxClusters:100,_parametersSet:!1,_memPCS2d:!1,_memPCS3d:!0,_poiType:"",_tokens:[],init:function(){this._modelEvents=new i},setParameters:function(e){e.clustering2D&&!0===e.clustering2D.active?(this._clusteringType="2d",this._clusteringEnabled=!0,this._maxClusters=e.clustering2D.maxClusters?e.clustering2D.maxClusters:100):e.clustering3D&&!0===e.clustering3D.active?(this._clusteringType="3d",this._clusteringEnabled=!0):(this._clusteringType="none",this._clusteringEnabled=!1),!1===e.useMemPCS?o.setMemPCS(!1):!0===e.useMemPCS?o.setMemPCS(!0):(this._memPCS2d=!1,this._memPCS3d=!0),e.proximityMerging&&!0===e.proximityMerging.active?(this._proximityMergingEnabled=!0,this._mergingThreshold=e.proximityMerging.proximityThreshold?e.proximityMerging.proximityThreshold:.001):e.proximityMerging&&!1===e.proximityMerging.active?this._proximityMergingEnabled=!1:this._proximityMergingEnabled=!0,e.poiType&&(this._poiType=e.poiType),this._parametersSet=!0},getGroupingParameters:function(){return{clustering2D:{active:!0===this._clusteringEnabled&&"2d"===this._clusteringType,maxClusters:this._maxClusters},clustering3D:{active:!0===this._clusteringEnabled&&"3d"===this._clusteringType},proximityMerging:{active:!0===this._proximityMergingEnabled,proximityThreshold:this._mergingThreshold}}},setGroupEngineInit:function(e){this._groupEngineInitialized=e,!1===e&&(this._clusteringType=null,this._clusteringEnabled=!1)},isGroupEngineInitialized:function(){return this._groupEngineInitialized},setMemPCS:function(e){this._memPCS2d=e,this._memPCS3d=e},setProximityMergingActive:function(e){this._proximityMergingActive=e},isProximityMergingActive:function(e){return this._proximityMergingActive},isParametersSet:function(){return this._parametersSet},isMemPCS:function(){return this._clusteringEnabled&&("2d"===this._clusteringType&&!0===this._memPCS2d||"3d"===this._clusteringType&&!0===this._memPCS3d)},isClusteringEnabled:function(){return this._clusteringEnabled},isProximityMergingEnabled:function(){return this._proximityMergingEnabled},getMaxClusters:function(){return this._maxClusters},getMergingThreshold:function(){return this._mergingThreshold},getClusteringType:function(){return this._clusteringType},setPOIType:function(e){"2D"!==e&&"3D"!==e&&""!==e||(this._poiType=e,this._publish({event:"poiType-change",data:{poiType:e}}))},getPOIType:function(){return this._poiType},subscribe:function(e,t){var i=this._modelEvents.subscribe(e,t);return this._tokens.push(i),i},unsubscribe:function(e){return this._modelEvents.unsubscribe(e)},_publish:function(e){return this._modelEvents.publish(e)},resetParameters:function(){this._tokens.forEach(function(e){this.unsubscribe(e)}.bind(this)),this._clusteringEnabled=!1,this._clusteringType=null,this._groupEngineInitialized=!1,this._proximityMergingEnabled=!1,this._mergingThreshold=.001,this._maxClusters=100,this._parametersSet=!1,this._proximityMergingActive=!1},destroy:function(){this._tokens.forEach(function(e){this.unsubscribe(e)}.bind(this)),this._clusteringEnabled=null,this._clusteringType=null,this._groupEngineInitialized=null,this._proximityMergingEnabled=null,this._mergingThreshold=null,this._maxClusters=null,this._parametersSet=null,this._proximityMergingActive=null}});return o}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerPGPController",["UWA/Class","DS/PADUtils/PADSettingsMgt","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/OOCManager","DS/Visualization/IdPath"],function(e,t,i,o,n){"use strict";return e.extend({name:"_PAD3DViewerPGPController",initPGPController:function(){this._model.subscribe({event:"PGPPostProcess"},function(e){t.getSetting("enopad3dviewer_lightNodeModel")?this._applyPGPOnIDs(e):this.publish({event:"PGPPostProcess",data:e})}.bind(this)),this._pgpHSOOverrideSetMap=new Map,this._rootIdToOverrideSetManagerMap=new Map,this._nodeIdToOverrideSetMap=new Map,t.getSetting("enopad3dviewer_lightNodeModel")&&this.subscribe({event:"onRootRemoved"},function(e){this._deletePGPOverrideSet(e.id)}.bind(this))},_applyPGPOnIDs:function(e){var t=0,i=function(t,i){var o=!0,s=this._pgpHSOOverrideSetMap.get(e.rootId);s||(s=this._createPGPOverrideSet(e.rootId));var r=null;if("reference"===t)s.getUniqueOverrideFromNodeId(i.id)?(r=s.getUniqueOverrideFromNodeId(i.id),o=!1):(r=s.createNodeIdOverride(i.id,!1,!0),o=!0);else if("instance"===t)s.getUniqueOverrideFromNodeId(i.id)?(r=s.getUniqueOverrideFromNodeId(i.id),o=!1):(r=s.createNodeIdOverride(i.id,!0,!0),o=!0);else if("occurrence"===t){var a=[this.getRootBagId()].concat(i.path);e.rootId!==i.path[0]&&((s=this._nodeIdToOverrideSetMap.get(i.path[0]))||(s=this._createPartialPathOverrideSet(e.rootId,i.path)),a=[].concat(i.path));var l=new n(a);s&&(s.getUniqueOverrideFromIdPath(l)?(r=s.getUniqueOverrideFromIdPath(l),o=!1):(r=s.createIdPathOverride({idPathes:[l],pgp:!0}),o=!0))}if(r&&!1===o)switch(i.type){case"hideshow":if(r.getVisibility&&null!==r.getVisibility())return null;break;case"opacity":if(r.getOpacity&&null!==r.getOpacity())return null;break;case"color":if(r.getColor&&r.getColor())return null;break;case"inheritance":if(r.getPGPInheritance&&null!==r.getPGPInheritance())return null}return r&&r.setPGPInheritance&&void 0!==i.inheritance&&!isNaN(i.inheritance)&&r.setPGPInheritance(i.inheritance),r}.bind(this),o=function(e,t){var o=i(e,t);o&&o.setVisibility(t.value)}.bind(this),s=function(e,t){var o,n,s,r,a=function(e){var t=Number(e).toString(16);return 1===t.length?"0"+t:t},l=i(e,t);l&&(t.value&&"#"===t.value[0]?l.setColor(t.value):(t.value&&(o=t.value.split(",")),o&&3===o.length&&l.setColor((n=o[0],s=o[1],r=o[2],"#"+a(n)+a(s)+a(r)))))}.bind(this),r=function(e,t){var o=i(e,t);o&&o.setOpacity(Number(t.value)/255)}.bind(this),a=function(e,t){void 0!==t.inheritance&&i(e,t)}.bind(this),l=function(e,i){for(t=0;t<i.length;t++)"hideshow"===i[t].type?o(e,i[t]):("color"===i[t].type&&s(e,i[t]),"opacity"===i[t].type&&r(e,i[t]),"inheritance"===i[t].type&&a(e,i[t]))};e.references.length&&l("reference",e.references),e.instances.length&&l("instance",e.instances),e.occurrences.length&&l("occurrence",e.occurrences)},_createPGPOverrideSet:function(e){var t=new i(this._context.getController().getRootBag(),this._context.getController().getRootBagId(),!0);return this._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(t),this._pgpHSOOverrideSetMap.set(e,t),t},_createPartialPathOverrideSet:function(e,t){var i=this._context.getController()._model.getOOCManager().createNodeIdOverrideSetManager(t[0]),o=i.createSceneGraphOverrideSet();i.pushSceneGraphOverrideSet(o);var n=this._rootIdToOverrideSetManagerMap.get(e);return n?n.push(i):this._rootIdToOverrideSetManagerMap.set(e,[i]),this._nodeIdToOverrideSetMap.set(t[0],o),o},_deletePGPOverrideSet:function(e){var t=this._pgpHSOOverrideSetMap.get(e);if(t){this._context.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(t),this._pgpHSOOverrideSetMap.delete(e);var i=this._context.getController()._model.getOOCManager(),o=this._rootIdToOverrideSetManagerMap.get(e);if(o)for(var n=0;n<o.length;n++){var s=this._nodeIdToOverrideSetMap.get(o[n].nodeId);o[n].removeSceneGraphOverrideSet(s),this._nodeIdToOverrideSetMap.delete(o[n].nodeId),i.removeNodeIdOverrideSetManager(o[n])}this._rootIdToOverrideSetManagerMap.delete(e)}}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerStaticMappingController",["UWA/Class","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/IdPath","DS/PADUtils/PADSettingsMgt","DS/ApplicationFrame/CommandsManager","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s){"use strict";return e.extend({name:"PAD3DViewerStaticMappingController",_excludedOccOverrideSetMap:new Map,_eventTokens:[],initStaticMappingController:function(){this._eventTokens.push(this.subscribe({event:"onExcludedOccurencesReceived"},e=>{if(e&&e.results&&e.results.length){const t=[];for(let i=0;i<e.results.length;++i)t.push(e.results[i].Path);this._hideExcludedOccurence({idPaths:t})}else e.errors&&console.warn(e.errors)})),this._eventTokens.push(this.subscribe({event:"onRootRemoved"},e=>{e&&e.id&&this._clearAllOverridesForId(e.id)}))},disposeStaticMappingController:function(){for(let e=0;e<this._eventTokens.length;++e)this.unsubscribe(this._eventTokens[e]);for(let e of this._excludedOccOverrideSetMap.keys())this.clearStaticMapping(e)},_hideExcludedOccurence:function(e){if(e.idPaths&&e.idPaths.length>0){for(let t=0;t<e.idPaths.length;++t){const o=new i([this.getRootBagId()].concat(e.idPaths[t]));let n=this._excludedOccOverrideSetMap.get(e.idPaths[t][0]);n||(n=this._createExcludedOccOverrideSet(e.idPaths[t][0]));let s=n.getUniqueOverrideFromIdPath(o);s?(s.setVisibility(!1),s.setVisibilityFree(!0)):(s=n.createIdPathOverride(o))&&(s.setVisibility(!1),s.setVisibilityFree(!0))}const t=this._context.getViewer().getSceneGraphOverrideSetManager();if(t)for(let e of this._excludedOccOverrideSetMap.values())t.removeSceneGraphOverrideSet(e),t.pushSceneGraphOverrideSet(e);setTimeout(function(){this._context.getViewer().render({updateInfinitePlane:!0})}.bind(this)),this.publish({event:"onStaticMappingApplied",data:e})}},_createExcludedOccOverrideSet:function(e){const i=new t(this.getRootBag(),this.getRootBagId(),!0);return this._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(i),this._excludedOccOverrideSetMap.set(e,i),i},_clearAllOverridesForId:function(e){const t=this._excludedOccOverrideSetMap.get(e),i=this._context.getViewer().getSceneGraphOverrideSetManager();i&&t&&i.removeSceneGraphOverrideSet(t),this._excludedOccOverrideSetMap.delete(e)},clearStaticMapping:function(e){this._clearAllOverridesForId(e)},isPathEffectiveForStaticMapping:function(e){if(e){const t=this._excludedOccOverrideSetMap.get(e[0]);if(t){const o=new i([this.getRootBagId()].concat(e));return!(null===t.getUniqueOverrideFromIdPath(o))}}return!1},hasAnyEffectiveStaticMapping:function(){return 0!==this._excludedOccOverrideSetMap.size},_enableStaticMappingSupport:function(){o.setSetting("enopad3dviewer_staticMappingSupportActivated",!0)},_disableStaticMappingSupport:function(){o.setSetting("enopad3dviewer_staticMappingSupportActivated",!1)}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerViewpointController",["UWA/Class","DS/Visualization/ThreeJS_DS","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/CoreEvents/Events","DS/ENOXInterWdgCom/LinkManager","DS/Utilities/Utils"],function(e,t,i,o,n,s){"use strict";return e.extend({name:"_PAD3DViewerViewpointController",_360SyncTimeout:null,_onSetCurrentViewpoint:function(e){try{if(!((e="string"==typeof e?JSON.parse(e):e)&&e.up&&e.up.x&&!isNaN(e.up.x)&&e.up.y&&!isNaN(e.up.y)&&e.up.z&&!isNaN(e.up.z)&&e.eye&&e.eye.x&&!isNaN(e.eye.x)&&e.eye.y&&!isNaN(e.eye.y)&&e.eye.z&&!isNaN(e.eye.z)&&e.sight&&e.sight.x&&!isNaN(e.sight.x)&&e.sight.y&&!isNaN(e.sight.y)&&e.sight.z)||isNaN(e.sight.z)||void 0!==e.focus&&(!e.focus||isNaN(e.focus))||void 0!==e.near&&(void 0===e.near||isNaN(e.near))||void 0!==e.far&&(void 0===e.far||isNaN(e.far))||void 0!==e.duration&&(void 0===e.duration||isNaN(e.duration)))throw new Error("Wrong parameters");var o=this.getViewpoint();o.camera.near=void 0!==e.near?e.near:o.camera.near,o.camera.far=void 0!==e.far?e.far:o.camera.far,this.getViewer()&&this.getViewer().get360Mode()&&(o.camera.fov=void 0!==e.fov?e.fov:o.camera.fov),o.contextAwareMoveTo({eyePosition:new t.Vector3(e.eye.x,e.eye.y,e.eye.z),upDirection:new t.Vector3(e.up.x,e.up.y,e.up.z),sightDirection:new t.Vector3(e.sight.x,e.sight.y,e.sight.z),distanceToTarget:void 0!==e.focus?e.focus:o.getTargetDistance(),duration:void 0!==e.duration?e.duration:0},{allow360:!0})}catch(e){this.displayNotification({msg:i.externalProtocol_WrongParameters.replace("{eventName}","setCurrentViewpoint"),eventID:"error",key:"pad3dViewer-setCurrentViewpoint-wrong-parameters"})}},_onViewPointSync:function(e){let t=function(e){let t=e.viewpoint;t.duration=0,t.up.x||(t.up=t.up[0]),t.sight.x||(t.sight=t.sight[0]),t.eye.x||(t.eye=t.eye[0]),t.eye.x&&t.eye.y&&t.eye.z&&t.up.x&&t.up.y&&t.up.z&&t.sight.x&&t.sight.y&&t.sight.z&&(this._viewPointChangeFromWL=!0,this._onSetCurrentViewpoint(t,!0))}.bind(this);this._isChoosingWLOptionsFromLink||(!0===this._lockViewpointSync||e.fromEnableFeature)&&(this.getViewer().get360Mode()?!this.getController()||this.getController()._isLoadingR2V||this.getController()._requesting360Mode||(null!==this._360SyncTimeout&&clearTimeout(this._360SyncTimeout),this._360SyncTimeout=setTimeout(()=>{this._360SyncTimeout=null,t(e)},300)):t(e))},_onSetViewpointSyncMaster:function(){this._lockViewpointSync=!0},_onViewPointChange:function(e){if("@onViewpointBeginMove"===e.eventType&&!this._isChoosingWLOptionsFromLink&&this._isMouseOver);else if("@onViewpointChange"!==e.eventType||this._isChoosingWLOptionsFromLink){if(("@onViewpointEndMove"===e.eventType||"@onViewpointEndMove_bis"===e.eventType)&&this.getViewer()&&this.getViewer().get360Mode()&&!this._isChoosingWLOptionsFromLink&&!0!==this._lockViewpointSync){this.getViewpoint()&&(null!==this._360SyncTimeout&&clearTimeout(this._360SyncTimeout),this._360SyncTimeout=setTimeout(()=>{this._360SyncTimeout=null,n.publish("DS/ExternalWdgtCom/ViewPointSync",{viewpoint:this.getViewpointParameters()})},300))}}else if(!0!==this._lockViewpointSync||this._isMouseOver||this.getViewer()&&!this.getViewer().get360Mode())if(this._lockViewpointSync=!1,n.publish("DS/ExternalWdgtCom/SetViewpointSyncMaster"),this._viewPointChangeFromWL||!this.getController()||this.getController()._isLoadingR2V||this.getController()._requesting360Mode)this._viewPointChangeFromWL=!1;else{this.getViewpoint()&&(this.getViewer()&&this.getViewer().get360Mode()?(null!==this._360SyncTimeout&&clearTimeout(this._360SyncTimeout),this._360SyncTimeout=setTimeout(()=>{this._360SyncTimeout=null,n.publish("DS/ExternalWdgtCom/ViewPointSync",{viewpoint:this.getViewpointParameters()})},300)):n.publish("DS/ExternalWdgtCom/ViewPointSync",{viewpoint:this.getViewpointParameters()}))}}})}),define("DS/ENOPAD3DViewer/views/PADLayerGroupingView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r,a){"use strict";function l(e){this.options=e||{},this.elements={},this._tokensXSO=[],this._nbChildren=0,this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",cellActivationFeedback:"row",columns:[{dataIndex:"hidden",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}}},this._mdlEvts=new r,this._buildContent()}return l.prototype.getHeader=function(){return n.groupingLayer.title},l.prototype.getIcon=function(){return s.getSetting("newLayerView")?{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Grouping.png")}:void 0},l.prototype.render=function(){return this.elements.container},l.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},l.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},l.prototype.addChild=function(e){this.options.model.addChild(e),this._nbChildren++},l.prototype.removeChild=function(e){this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:l.layerName}})},l.prototype.getModelEvents=function(){return this._mdlEvts},l.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility()}},l.layerName="grouping",l}),define("DS/ENOPAD3DViewer/views/PADLayerTransparencyView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r,a){"use strict";function l(e){this.options=e||{},this.elements={},this._tokensXSO=[],this._nbChildren=0,this._elementSize=39,this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",cellActivationFeedback:"row",columns:[{dataIndex:"hidden",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"eye",fontIconFamily:WUXManagedFontIcons.Font3DS}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"eye-off",fontIconFamily:WUXManagedFontIcons.Font3DS}}}},this._mdlEvts=new r,this._buildContent()}return l.prototype.getHeader=function(){return n.transparencyLayer.title},l.prototype.getIcon=function(){return s.getSetting("newLayerView")?{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Transparency.png")}:void 0},l.prototype.render=function(){return this.elements.container},l.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},l.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},l.prototype.selectItemIdx=function(e){this.options.dgv.setActiveCell(0);var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},l.prototype.addChild=function(e){this.options.model.addChild(e),this._nbChildren++},l.prototype.removeChild=function(e){this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:l.layerName}})},l.prototype.getModelEvents=function(){return this._mdlEvts},l.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility()}},l.layerName="transparency",l}),define("DS/ENOPAD3DViewer/views/PAD3DLayerKindToolbar",["DS/CoreEvents/ModelEvents","DS/Tweakers/GeneratedToolbar","DS/PADUtils/PADContext","DS/WebappsUtils/WebappsUtils","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADServices/utils/PADTrackerManager"],function(e,t,i,o,n,s){"use strict";function r(n){this._modelEvents=n.modelEvents?n.modelEvents:new e,this._context=i.get(),this._empty=!0,this._icon3d=o.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_3DPOI.png"),this._kind=n.kind;var s={entries:[]},r=new Map;this._fillEntries(r),this._empty=!1,s.entries.push(r.get("3DPOI")),s.entries.push(r.get("legend")),s.entries.push(r.get("remove")),this._model=t.prototype.createTreeDocument(s),this._generatedToolbar=new t({overflowManagement:"dropdown",direction:"horizontal",items:this._model,minHeight:29}),this._generatedToolbar.getContent().style="min-height: 29px;";var a=this._generatedToolbar.getContent().getElementsByClassName("wux-controls-toolbar-farContainer");a&&a.length>0&&(a[0].style="min-height: 29px;"),this._generatedToolbar.updateNodeModel("3DPOI",{visibleFlag:!1}),this._generatedToolbar.updateNodeModel("legend",{visibleFlag:!1}),this._generatedToolbar.updateNodeModel("remove",{visibleFlag:!1})}return r.prototype.setButtonKindAvailability=function(e,t){switch(e){case"3dpoi":!0===t?this._generatedToolbar.updateNodeModel("3DPOI",{visibleFlag:!0}):this._generatedToolbar.updateNodeModel("3DPOI",{visibleFlag:!1});break;case"legend":!0===t?this._generatedToolbar.updateNodeModel("legend",{visibleFlag:!0}):this._generatedToolbar.updateNodeModel("legend",{visibleFlag:!1});break;case"remove":!0===t?this._generatedToolbar.updateNodeModel("remove",{visibleFlag:!0}):this._generatedToolbar.updateNodeModel("remove",{visibleFlag:!1})}},r.prototype.update=function(){var e=this._context.getController().get3DLayerController().getPOIType();this._generatedToolbar.updateNodeModel("3DPOI",{icon:{iconPath:this._icon3d,className:"3D"===e?"PAD3DLayerKindToolbar-button-active":"PAD3DLayerKindToolbar-button-inactive"},label:"3D"===e?n.POI3DToggle.toggle2dpoi:n.POI3DToggle.toggle3dpoi,tooltip:"3D"===e?n.POI3DToggle.toggle2dpoi:n.POI3DToggle.toggle3dpoi})},r.prototype._fillEntries=function(e){var t="";null!=this._context.getController().get3DLayerController()&&(t=this._context.getController().get3DLayerController().getPOIType()),e.set("3DPOI",{id:"3DPOI",dataElements:{typeRepresentation:"functionIcon",icon:{iconPath:this._icon3d,className:"3D"===t?"PAD3DLayerKindToolbar-button-active":"PAD3DLayerKindToolbar-button-inactive"},position:"near",category:"staticCmds",value:e=>{var t=this._context.getController().get3DLayerController().getPOIType();"2D"===t?t="3D":"3D"===t&&(t="2D"),this._context.getController().get3DLayerController().setPOIType(t),this._modelEvents.publish({event:"PAD3DLayer/Toggle3DPOI",data:{options:e,state:t}}),this._generatedToolbar.updateNodeModel("3DPOI",{icon:{iconPath:this._icon3d,className:"3D"===t?"PAD3DLayerKindToolbar-button-active":"PAD3DLayerKindToolbar-button-inactive"},label:"3D"===t?n.POI3DToggle.toggle2dpoi:n.POI3DToggle.toggle3dpoi,tooltip:"3D"===t?n.POI3DToggle.toggle2dpoi:n.POI3DToggle.toggle3dpoi});var i=s.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_poiTypeToggle_stats"});i.persDim.pd2=t,i.trackPageEvent()},position:"far"},onNodeUpdate:function(e){this._context.getController().get3DLayerController().getPOIType(),this._generatedToolbar.getNodeModelByID("3DPOI")}.bind(this)}),e.set("legend",{id:"legend",dataElements:{label:n.viewLegend,typeRepresentation:"functionIcon",category:"staticCmds",icon:{iconPath:o.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Legend.png")},position:"far",value:e=>{this._modelEvents.publish({event:"PAD3DLayer/ToolbarLegend",data:e})}}}),e.set("remove",{id:"remove",dataElements:{label:n.remove,typeRepresentation:"functionIcon",icon:{iconName:"compass-3d wux-ui-3ds",fontIconFamily:1},category:"staticCmds",icon:{iconPath:o.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Remove.png")},position:"far",value:e=>{this._selectedXSO&&(this._selectedXSO.layerRemoved(),this._selectedXSO=null),this._modelEvents.publish({event:"PAD3DLayer/ToolbarRemove",data:e})}}})},r.prototype.updateButtonSelect=function(e){var t="poi"===e||"reveal"===e,i="search"===e,o="transparency"===e,n="grouping"===e,s="pointCloudClassification"===e||"pointCloudElevation"===e,r="default"===e,a=t||"graphic properties"===e||"zoi"===e||n;this.setButtonKindAvailability("3dpoi",t),this.setButtonKindAvailability("legend",a),this.setButtonKindAvailability("remove",!n&&(a||i||o||s||r)),this.update()},r.prototype.xsoAdd=function(e){this._selectedXSO=e.selected,e.selected&&e.selected.options&&e.selected.options.kind&&this.updateButtonSelect(e.selected.options.kind)},r.prototype.xsoRemove=function(e){this.updateButtonSelect("none")},r.prototype.inject=function(e){this._generatedToolbar.inject(e)},r.prototype.getContent=function(){return this._generatedToolbar.getContent()},r.prototype.isEmpty=function(){return this._empty},r.prototype.subscribe=function(e,t){return this._modelEvents.subscribe(e,t)},r}),define("DS/ENOPAD3DViewer/views/PAD3DLineLayout",["UWA/Core","UWA/Controls/Abstract","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Animation/PropertyAnimation","DS/Logger/Logger","DS/CoreEvents/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils"],function(e,t,i,o,n,s,r,a,l){"use strict";var d=t.extend({name:"PAD3DLineLayout",_logger:null,_context:null,_roots:null,_isActive:!1,_modelToken:[],_overloadedPaths:[],_modelEvents:null,init:function(e){this._parent(e),this._logger=s.getLogger(d),this._context=e.context;this._modelEvents=new r},isActive:function(){return this._isActive},activate:function(){var e=this;function t(){e.isActive()&&e.compute()}this._roots=this._context.getRoots().slice(0),this._sceneGraphOverrideSet=new a(this._context.getController().getRootBagPath().externalPath[0]),this._context&&(this._modelToken.push(this._context.subscribe({event:"onRootDetached"},t)),this._modelToken.push(this._context.subscribe({event:"onRootAttached"},t)),this._modelToken.push(this._context.subscribe({event:"onRootRemoved"},t)),this._modelToken.push(this._context.subscribe({event:"onLoadingComplete"},t)),this._modelToken.push(this._context.subscribe({event:"onModelUpdated"},t))),this._isActive=!0,this.compute()},deactivate:function(e){var t=this;this._modelToken.forEach(function(e){t._context.unsubscribe(e)}),this._modelToken=[],this._isActive&&(this.resetPositions(e),this._isActive=!1)},compute:function(){var e=this;this._logger.log("compute"),this.publish({event:"onLayoutComputationBegin"});var t=this._context.getViewer().getSceneGraphOverrideSetManager();t&&t.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet);var s=this._context.getRoots().slice(0);if(void 0!==s){var r=[],a=0,l=0;for(l=s.length-1;l>=0;l--){var d=s[l].getBoundingBox();Math.abs(d.max.x-d.min.x)===1/0&&s.splice(l,1)}s.forEach(function(e){var t=e.getBoundingBox(),i=Math.abs(t.max.x-t.min.x);i!==1/0&&(r.push({xSize:t.max.x-t.min.x,zMin:t.min.z,center:t.min.clone().add(t.max).divideScalar(2)}),a<i&&(a=i))}),l=0,s.forEach(function(s){if(Math.round(s.getMatrix().elements[12])!=Math.round(-(r[l].center.x+a*l*1.2))||Math.round(s.getMatrix().elements[13])!=Math.round(-r[l].center.y)||Math.round(s.getMatrix().elements[14])!=Math.round(-r[l].zMin)){var d=new o;d.addElement(e._context.getController()._model.getRootBag()),d.addElement(s),e._overloadedPaths.push(d);var h=t.computeAppliedPosition(d);null===h&&(h=d.getLastElement(!0).getMatrix());var c={_duration:1e3,_startX:h.elements[12],_startY:h.elements[13],_startZ:h.elements[14],_endX:-(r[l].center.x+a*l*1.2),_endY:-r[l].center.y,_endZ:-r[l].zMin,_path:d,duration:function(){return this._duration},valueAt:function(t){var o=this._startX+(this._endX-this._startX)*(t/this._duration),n=this._startY+(this._endY-this._startY)*(t/this._duration),s=this._startZ+(this._endZ-this._startZ)*(t/this._duration),r=(new i.Matrix4).makeTranslation(o,n,s),a=e._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path);a||(a=e._sceneGraphOverrideSet.createOverride(this._path)),a.setPosition(r),e._context._viewer.render({updateInfinitePlane:!0})}};new n(s,"setMatrix",c).start()}l++}),setTimeout(function(){e._context._viewer.render({updateInfinitePlane:!0}),e._context.reframe(),e.publish({event:"onLayoutComputationEnd"})},1100)}},destroy:function(){this._logger.log("destroy"),this.deactivate(!1)},resetPositions:function(e){e=void 0===e||e;var t=this,o=this._context.getViewer().getSceneGraphOverrideSetManager();if(o&&o.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet),this._overloadedPaths&&this._overloadedPaths.length>0){this.publish({event:"onLayoutComputationBegin"});var s=1e3;e||(s=1),this._overloadedPaths.forEach(function(e){var r=o.computeAppliedPosition(e);o.removeSceneGraphOverrideSet(t._sceneGraphOverrideSet);var a=o.computeAppliedPosition(e);if(null===a&&(a=e.getLastElement(!0).getMatrix()),o.pushSceneGraphOverrideSet(t._sceneGraphOverrideSet),r&&a){var l={_duration:s,_startX:r.elements[12],_endX:a.elements[12],_startY:r.elements[13],_endY:a.elements[13],_startZ:r.elements[14],_endZ:a.elements[14],_path:e,duration:function(){return this._duration},valueAt:function(e){var n=this._startX+(this._endX-this._startX)*(e/this._duration),s=this._startY+(this._endY-this._startY)*(e/this._duration),r=this._startZ+(this._endZ-this._startZ)*(e/this._duration),a=(new i.Matrix4).makeTranslation(n,s,r);if(e===this._duration)o&&(o.removeSceneGraphOverrideSet(t._sceneGraphOverrideSet),delete t._sceneGraphOverrideSet);else{var l=t._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path);l?l.setPosition(a):l=t._sceneGraphOverrideSet.createOverride(this._path)}t._context._viewer.render({updateInfinitePlane:!0})}};new n(e.getLastElement(!0),"setMatrix",l).start()}}),setTimeout(function(){t._context._viewer.render({updateInfinitePlane:!0}),t._context.reframe(),t.publish({event:"onLayoutComputationEnd"})},s+100)}},publish:function(e){this.getModelEvents().publish(e)},subscribe:function(e,t){return this.getModelEvents().subscribe(e,t)},unsubscribe:function(e){this.getModelEvents().unsubscribe(e)},getModelEvents:function(){return this._modelEvents}});return e.namespace("DS/ENOPAD3DViewer/views/PAD3DLineLayout",d)}),define("DS/ENOPAD3DViewer/views/PAD3DVolumeManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var o=i.extend({init:function(t){return this._parent(t),this.projector=new e.Projector,this.setExclusive(!0),this},BeginManipulate:function(t,i,o){this._parent(t,i,o);var n={eventChannel:"BeginManipulate",paths:this.manipulatedPaths,intersection:o};this.publish("BeginManipulate",n),this._initialPositionProjected=i.from[0].getCurrentPosition(this.viewer.canvas),this._initial3dIntersectionPoint=o.position,this._initial3dIntersectionPointTranslated=(new e.Vector3).copy(this._initial3dIntersectionPoint),this._initial3dIntersectionPointTranslated.add(o.normal)},Manipulate:function(t,i,o){this._parent(t,i,o);var n=(new e.Vector2).copy(i.from[0].getCurrentPosition(this.viewer.canvas));n.x=(2*n.x-this.viewer.canvas.width)/this.viewer.canvas.width,n.y=-(2*n.y-this.viewer.canvas.height)/this.viewer.canvas.height;var s=new e.Vector3(n.x,n.y,1);this.projector.unprojectVector(s,this.viewer.currentViewpoint.camera);var r=new e.Ray(this.viewer.currentViewpoint.camera.position,s.sub(this.viewer.currentViewpoint.camera.position).normalize()).computeShortestPointToLine(this._initial3dIntersectionPoint,this._initial3dIntersectionPointTranslated),a=(new e.Vector3).subVectors(r,this._initial3dIntersectionPoint),l={eventChannel:"Manipulate",paths:this.manipulatedPaths,translationVector:a,intersection:o};this.publish("Manipulate",l)},EndManipulate:function(e,t,i){var o={eventChannel:"EndManipulate",paths:this.manipulatedPaths,intersection:i};this.publish("EndManipulate",o),this._parent(e,t,i)},BeginPreactivate:function(e,t,i){var o={eventChannel:"BeginPreactivate",preactivated:this.preactivated,intersection:i};this.publish("BeginPreactivate",o)},Preactivate:function(e,t,i){var o={eventChannel:"Preactivate",preactivated:this.preactivated,intersection:i};this.publish("Preactivate",o)},EndPreactivate:function(e,t,i){var o={eventChannel:"EndPreactivate",preactivated:this.preactivated,intersection:i};this.publish("EndPreactivate",o)}});return UWA.namespace("DS/ENOPAD3DViewer/views/PAD3DVolumeManipulator",o)}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerNMIRDMUOperatorController",["UWA/Core","UWA/Class","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSettingsMgt"],function(e,t,i,o){"use strict";return t.extend({name:"_PAD3DViewerNMIRDMUOperatorController",completeSessionWithClippingOperatorCandidates:function(t){return new Promise(function(t,n,s){if("object"==typeof t)if(Array.isArray(t.path)){if("object"==typeof t.sectionPlane){if(!Array.isArray(t.sectionPlane.origin))return void s({error:"Section plane's origin is not defined"});if(!Array.isArray(t.sectionPlane.u_direction))return void s({error:"Section plane's u_direction is not defined"});if(!Array.isArray(t.sectionPlane.v_direction))return void s({error:"Section plane's v_direction is not defined"})}if("object"==typeof t.box){if(!Array.isArray(t.box.corner_min))return void s({error:"Box's corner_min is not defined"});if(!Array.isArray(t.box.corner_max))return void s({error:"Box's corner_max is not defined"});if(!Array.isArray(t.box.transformation_matrix))return void s({error:"Box's transformation_matrix is not defined"});if("string"!=typeof t.box.intersection_mode)return void s({error:"Box's intersection_mode is not defined"})}if("object"==typeof t.box||"object"==typeof t.sectionPlane){var r=void 0!==t.stream?t.stream:this.getDefaultStreamToLoad(),a=e.clone(o.getWebAPI_Options("navigate3D"),!0),l="thumbnail"===r?a.computeCGRsNThumbnails:a.computeCGRs,d=void 0!==t.sectionPlane?{plane_section_filter:t.sectionPlane}:{box_filter:t.box},h={data:{rootPhID:t.path[0],root_path_physicalid:[t.path],compute_select_bo:l,select_bo:a.select_bo,select_rel:a.select_rel,overrides:this._context.getViewer().getSceneGraphOverrideSetManager().exportIdPathOverrides("position"),volume_filter:d,get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0},FBIProxy:this._BIProxy,timeout:parseInt(o.getSetting("webapi_timeout")),onComplete:function(e,t,i,o,n,s){var r;try{r="string"==typeof s?JSON.parse(s):s,this._model.buildFromJSON({rootIds:[i],json:r,reframe:!1,meshInRAM:n,streamToLoad:o,enforceStreamSwitch:!0,callbacks:{onComplete:function(t,i){this._stopAsync(),e({response:t,selectedPaths:i.selectedPaths})}.bind(this,r)}})}catch(e){this._stopAsync(),t({error:"Unable to parse response"})}}.bind(this,n,s,t.path[0],r,t.meshInRAM),onFailure:function(e,t){this._stopAsync(),t({error:"Query failed"})}.bind(this,n,s),onTimeout:function(e,t){this._stopAsync(),t({error:"Query timeout"})}.bind(this,n,s)};this._startAsync(),i.volumeQueryV2(h)}else s({error:"No volume defined"})}else s({error:"No path defined"});else s({error:"No parameter defined"})}.bind(this,t))},completeSessionWithMinMaxMeasureCandidates:function(t){return new Promise(function(t,n,s){if("object"==typeof t)if("string"==typeof t.rootPhID)if("min"===t.mode||"max"===t.mode)if(Array.isArray(t.sets))if(2===t.sets.length)if("string"==typeof t.sets[0].id&&"string"==typeof t.sets[1].id)if(Array.isArray(t.sets[0].paths)&&Array.isArray(t.sets[1].paths))if(Array.isArray(t.sets[0].paths[0])&&Array.isArray(t.sets[1].paths[0])){var r=void 0!==t.stream?t.stream:this.getDefaultStreamToLoad(),a=e.clone(o.getWebAPI_Options("navigate3D"),!0),l="thumbnail"===r?a.computeCGRsNThumbnails:a.computeCGRs,d={data:{rootPhID:t.rootPhID,compute_select_bo:l,select_bo:a.select_bo,select_rel:a.select_rel,overrides:this._context.getViewer().getSceneGraphOverrideSetManager().exportIdPathOverrides("position"),sets:t.sets,mode:t.mode,get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0},FBIProxy:this._BIProxy,timeout:parseInt(o.getSetting("webapi_timeout")),onComplete:function(e,t,i,o,n,s){var r;try{r="string"==typeof s?JSON.parse(s):s,this._model.buildFromJSON({rootIds:[i],json:r,reframe:!1,meshInRAM:n,streamToLoad:o,enforceStreamSwitch:!0,callbacks:{onComplete:function(t,i){this._stopAsync(),e({response:t,selectedPaths:i.selectedPaths,sortedPaths:i.sortedPaths})}.bind(this,r)}})}catch(e){this._stopAsync(),t({error:"Unable to parse response"})}}.bind(this,n,s,t.rootPhID,r,t.meshInRAM),onFailure:function(e,t){this._stopAsync(),t({error:"Query failed"})}.bind(this,n,s),onTimeout:function(e,t){this._stopAsync(),t({error:"Query timeout"})}.bind(this,n,s)};this._startAsync(),i.getMinMaxDistanceCandidates(d)}else s({error:"Paths should be array of array"});else s({error:"Missing set paths"});else s({error:"Missing set id"});else s({error:"Wrong set definition"});else s({error:"No set defined"});else s({error:"Wrong mode value"});else s({error:"No rootPhID defined"});else s({error:"No parameter defined"})}.bind(this,t))},_completeSessionWithBoxForWalk:function(t){return new Promise(function(t,n,s){if("object"==typeof t)if(Array.isArray(t.path)){if("object"==typeof t.box){if(!Array.isArray(t.box.corner_min))return void s({error:"Box's corner_min is not defined"});if(!Array.isArray(t.box.corner_max))return void s({error:"Box's corner_max is not defined"});if(!Array.isArray(t.box.transformation_matrix))return void s({error:"Box's transformation_matrix is not defined"});if("string"!=typeof t.box.intersection_mode)return void s({error:"Box's intersection_mode is not defined"})}if("object"==typeof t.box){var r=void 0!==t.stream?t.stream:this.getDefaultStreamToLoad(),a=e.clone(o.getWebAPI_Options("navigate3D"),!0),l="thumbnail"===r?a.computeCGRsNThumbnails:a.computeCGRs,d={box_filter:t.box},h={data:{applicationID:"FLY-WALK-604d7617-e5cb-4baf-bb45-3a7b681c3d5e",rootPhID:t.path[0],root_path_physicalid:[t.path],compute_select_bo:l,select_bo:a.select_bo,select_rel:a.select_rel,overrides:this._context.getViewer().getSceneGraphOverrideSetManager().exportIdPathOverrides("position"),volume_filter:d,get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0},FBIProxy:this._BIProxy,timeout:parseInt(o.getSetting("webapi_timeout")),onComplete:function(e,t,i,o,n){var s;try{s="string"==typeof n?JSON.parse(n):n}catch(e){return this._stopAsync(),void t({errors:[{code:"PARSING_FAILED"}]})}s.errors&&s.errors.length&&!s.results?t(s):s.results&&0===s.results.length?e({representationsList:[],pathsList:[]}):this._model.buildFromJSON({rootIds:[i],json:s,reframe:!1,streamToLoad:o,callbacks:{onComplete:function(t,i){e({representationsList:i.representationsList,pathsList:i.selectedPaths})}.bind(this,s)}})}.bind(this,n,s,t.path[0],r),onFailure:function(e,t,i){var o=null;try{o="string"==typeof i?JSON.parse(i):i}catch(e){return void t({errors:[{code:"QUERY_FAILED"}]})}t(o)}.bind(this,n,s),onTimeout:function(e,t){t({errors:[{code:"QUERY_TIMEOUT"}]})}.bind(this,n,s)};i.volumeQueryV2(h)}else s({error:"No volume defined"})}else s({error:"No path defined"});else s({error:"No parameter defined"})}.bind(this,t))}})}),define("DS/ENOPAD3DViewer/views/PAD3DPOIPanel",["DS/Windows/Panel","DS/PADServices/utils/PADTrackerManager","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i){"use strict";function o(e){this._parentContainer=e.renderTo,this._clickOnPOICB=e.clickOnPOICB?e.clickOnPOICB:null,this._group=null,this.elements={},this._buildPanel()}return o.prototype._buildPanel=function(){this.deletePanel(),this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DPOIPanel-container"),this.elements.panel||(this.elements.panel=new e({immersiveFrame:this._parentContainer,identifier:"PAD3DPOIPanel",minWidth:150,width:250,height:"auto",content:this.elements.container,verticallyStretchableFlag:!navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i),titleBarVisibleFlag:!0,resizableFlag:!0,allowedDockAreas:12,collapsibleFlag:!1,movableFlag:!0,resizableFlag:!0,closeButtonFlag:!0}),this.elements.panel.immersiveFrame.dockWindow(this.elements.panel,4,{attachToOtherDockedWindow:!0}))},o.prototype.isClosed=function(){return!this.elements.panel||this.elements.panel.disabled||!this.elements.panel.visibleFlag||!(this.elements.container||this.container)},o.prototype.setPosition=function(e){this.elements.panel.position.offsetX=e.x+15,this.elements.panel.position.offsetY=e.y},o.prototype.hide=function(){this.elements&&this.elements.panel&&this.elements.panel.elements&&this.elements.panel.elements.container&&this.elements.panel.hide()},o.prototype.show=function(){this.elements&&this.elements.panel&&this.elements.panel.elements&&this.elements.panel.elements.container?this.elements.panel.show():(this.elements={},this._buildPanel(),this.elements.panel.show())},o.prototype.setContentPOIGroup=function(e,t){this._group=e;var i="DS/ENOPAD3DViewer/views/PADDefaultGroupView";t&&(i=t),function(){require([i],function(t){this.elements&&(this.elements.container&&(this.elements.container.innerHTML=""),this._layerGroupView=i,this._groupView=new t({poiGroup:this._group,cbClick:this._clickOnPOICB}),this.elements.panel&&(this.elements.panel.title=this._groupView.getTitle(e.layerLabel)),this.elements.container&&this.elements.container.appendChild(this._groupView.render()))}.bind(this))}.bind(this)()},o.prototype.setContentsPOIGroups=function(e){this._group={node:null,pois:[],layer:null,layerId:null,position:{x:0,y:0,z:0},name:""};for(var t="DS/ENOPAD3DViewer/views/PADDefaultGroupView",i=null,o=!1,n=e.length,s=0;s<e.length;s++)void 0!==e[s].position?(this._group.position.x+=e[s].position.x,this._group.position.y+=e[s].position.y,this._group.position.z+=e[s].position.z):n--,i?!o&&i&&i!==e[s].layerGroupView?(o=!0,i=t):!o&&i&&i===e[s].layerGroupView&&(i=e[s].layerGroupView):i=e[s].layerGroupView,this._group.pois=this._group.pois.concat(e[s].pois);1===e.length&&e[0].node&&e[0].node._name&&(this._group.name=e[0].node._name),this._group.position.x=this._group.position.x/n,this._group.position.y=this._group.position.y/n,this._group.position.z=this._group.position.z/n,i&&(t=i),function(){require([t],function(e){this.elements&&(this.elements.container&&(this.elements.container.innerHTML=""),this._layerGroupView=t,this._groupView=new e({poiGroup:this._group,cbClick:this._clickOnPOICB}),this.elements.panel&&(this.elements.panel.title=this._groupView.getTitle()),this.elements.container&&this.elements.container.appendChild(this._groupView.render()))}.bind(this))}.bind(this)()},o.prototype.deletePanel=function(){this.elements&&this.elements.container&&(this.elements.container.innerHTML=""),delete this._layerGroupView,delete this.elements.panel,delete this.elements.container},o}),define("DS/ENOPAD3DViewer/views/PADPOIManipulatorTT",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var o=i.extend({init:function(e){return this._parent(),this._name=e,this},BeginManipulate:function(e,t,i){var o={eventChannel:"BeginManipulate",paths:this.manipulatedPaths,intersection:i,event:t,manipulator:this};this.publish("BeginManipulate",o)},Manipulate:function(e,t,i){this.publish("Manipulate",e,t,i)},EndManipulate:function(e,t,i){this.publish("EndManipulate",e,t,i)},BeginPreactivate:function(e,t,i){var o={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",o)},Preactivate:function(e,t,i){var o={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",o)},EndPreactivate:function(e,t,i){var o={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this,poiname:this._name};this.publish("EndPreactivate",o)}});return UWA.namespace("DS/ENOPAD3DViewer/views/PADPOIManipulatorTT",o)}),define("DS/ENOPAD3DViewer/views/PADLayerColorizeView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/CoreEvents/ModelEvents","DS/PADServices/utils/GlobalModelEvents","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r){"use strict";function a(e){this.options=e||{},this.elements={},this._nbChildren=0,this._elementSize=27,this._hiddenColumn={dataIndex:"hidden",typeRepresentation:"layerToggle",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"38px",alignment:"center",getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:o.show,updateModel:!1}:{shortHelp:o.hide,updateModel:!1}}},this._stringColumn={dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"},this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},cellActivationFeedback:"none",cellPreselectionFeedback:"none",showRowIndexFlag:!1,showRowBorderFlag:!0,showBackgroundFlag:!1,showAlternateBackgroundFlag:!1,rowSelection:"none",columnSelection:"none",cellSelection:"none",columns:[this._hiddenColumn,this._stringColumn],layoutOptions:{rowsHeader:!1,columnsHeader:!1}},this.options.typeReps={layerToggle:{stdTemplate:"toggleIcon",semantics:{possibleValues:[{value:!0,icon:{iconName:"radiobutton-off",fontIconFamily:1}},{value:!1,icon:{iconName:"radiobutton-on",fontIconFamily:1}}]}}},this._mdlEvts=new n,this._buildContent()}return a.prototype.getHeader=function(){return o.colorizeLayer.title},a.prototype.getIcon=function(){return{iconPath:r.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Colorize.png")}},a.prototype.render=function(){return this.elements.container},a.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container"),this.elements.container.classList.add("colorize-layers-view");var o=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions),n=this.options.dgv=new i(o);this.options.model=new t,n.treeDocument=this.options.model,n.getContent().addClassName("PAD3DLayerDefaultView-dgv"),n.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),n.onReady(function(){n.addEventListener("click",this._cellClicked.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},a.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},a.prototype.addChild=function(e){++this._nbChildren,null!==e.getPosition()&&void 0!==e.getPosition()?this.options.model.addChild(e,e.getPosition()):this.options.model.addChild(e)},a.prototype.removeChild=function(e){--this._nbChildren,this.options.model.removeRoot(e),0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:a.layerName}})},a.prototype.getModelEvents=function(){return this._mdlEvts},a.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":this.options.model.withTransactionUpdate(()=>{const e=this.options.model.getRoots();if(t.nodeModel.getPosition()>1)for(let i=2;i<e.length;++i)i===t.nodeModel.getPosition()?(e[i].setVisibility(!0),e[i].updateOptions({grid:{hidden:!1}})):(e[i].setVisibility(!1),e[i].updateOptions({grid:{hidden:!0}}));else e[t.nodeModel.getPosition()].setVisibility(!0),e[t.nodeModel.getPosition()].updateOptions({grid:{hidden:!1}}),e[(t.nodeModel.getPosition()+1)%2].setVisibility(!1),e[(t.nodeModel.getPosition()+1)%2].updateOptions({grid:{hidden:!0}}),s.publish({event:"ENXDISC_AP/Colorize/InstanceReferenceSwitch",data:{state:!!t.nodeModel.getPosition()}})})}},a.layerName="colorize",a}),define("DS/ENOPAD3DViewer/views/PADLayerGraphicPropertiesView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r,a){"use strict";function l(e){this.options=e||{},this.elements={},this._tokensXSO=[],this._nbChildren=0,this._elementSize=39,this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",cellActivationFeedback:"row",columns:[{dataIndex:"hidden",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}}},this._mdlEvts=new r,this._buildContent()}return l.prototype.getHeader=function(){return n.graphicPropertiesLayer.title},l.prototype.getIcon=function(){return s.getSetting("newLayerView")?{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_GP.png")}:void 0},l.prototype.render=function(){return this.elements.container},l.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},l.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},l.prototype.selectItemIdx=function(e){this.options.dgv.setActiveCell(0);var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},l.prototype.addChild=function(e){this.options.model.addChild(e),this._nbChildren++},l.prototype.removeChild=function(e){this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:l.layerName}})},l.prototype.getModelEvents=function(){return this._mdlEvts},l.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility()}},l.layerName="graphic properties",l}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerPCSTracker",["UWA/Class"],function(e){"use strict";return e.extend({name:"_PAD3DViewerPCSTracker",initPCSTracker:function(e){return new Promise(function(t,i){e.model.subscribe({event:"parsingComplete"},this._onParsingComplete.bind(this)),this.subscribe({event:"onStartProgressiveLoad"},this._onStartProgressiveLoad.bind(this)),this.subscribe({event:"onEndProgressiveLoad"},this._onEndProgressiveLoad.bind(this)),this.subscribe({event:"rootStatsRetrieved"},this._onRootStatsRetrieved.bind(this)),this.subscribe({event:"onExcludedOccurencesReceived"},this._onExcludedOccurencesReceived.bind(this)),t()}.bind(this))},_onParsingComplete:function(e){e&&require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t,i){var o=t.getPADTracker({eventCategory:"performance",eventAction:"3d_loading"});o.setEventData({eventLabel:"3d_imm_loading",eventValue:e.timing,txKey:1===this._rootIds.length?this._rootIds[0]:void 0}),o.addMultivaluedEventData("3d_imm_loading",e.infos),o.trackPageEvent()}.bind(this,e))},_onStartProgressiveLoad:function(){this._startProgressiveLoadStamp=new Date},_onEndProgressiveLoad:function(e){this._endProgressiveLoadStamp=new Date;var t=this._endProgressiveLoadStamp-this._startProgressiveLoadStamp;delete this._startProgressiveLoadStamp,delete this._endProgressiveLoadStamp,t&&require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,i,o){var n=i.getPADTracker({eventCategory:"performance",eventAction:"3d_loading"});n.setEventData({eventLabel:"3d_loading_completion",eventValue:t,txKey:1===this._rootIds.length?this._rootIds[0]:void 0}),n.persDim.pd2=e.memoryFull?"Stopped":"Complete",n.trackPageEvent()}.bind(this,e))},_onRootStatsRetrieved:function(e){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADSettingsMgt"],function(e,t,i){var o=i.getSetting("enopad3dviewer_VISnVIOStatus"),n=t.getPADTracker({eventCategory:"usage",eventAction:"vik_usage"}),s=e.initialPathes[0][0],r="";o&&!this._isLarge(s)?r="VIKnSmall":o&&this._isLarge(s)?r="VIKnLarge":o||this._isLarge(s)?!o&&this._isLarge(s)&&(r="notVIKnLarge"):r="notVIKnSmall",n.setEventData({eventLabel:r}),n.trackPageEvent()}.bind(this,e))},_onExcludedOccurencesReceived:function(e){require(["DS/PADServices/utils/PADTrackerManager"],function(e,t){var i=t.getPADTracker({eventCategory:"usage",eventAction:"3d_loading"}),o=e&&e.results?e.results.length:0;i.setEventData({eventLabel:"3d_loading_staticMappingRetrieved",eventValue:o,txKey:1===this._rootIds.length?this._rootIds[0]:void 0}),i.trackPageEvent()}.bind(this,e))}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerMaterialViewController",["UWA/Class","DS/CoreEvents/Events","DS/PADUtils/PADSettingsMgt","DS/RenderingMaterial/MaterialRequestBuilder"],function(e,t,i,o){"use strict";return e.extend({name:"_PAD3DViewerMaterialViewController",_materialVisuEventToken:null,_dataLoadedWithoutMaterial:!i.getSetting("enopad3dviewer_materialMode"),initMaterialViewController:function(){return new Promise(function(e,t){this._setMaterialSetting(this._context.getViewer()),this._materialVisuEventToken=this._context.getViewer().onMaterialModeChange(this._onMaterialChanged.bind(this)),e()}.bind(this))},disposeMaterialController:function(){this._materialVisuEventToken&&(this._context.getViewer()&&this._context.getViewer().unsubscribe(this._materialVisuEventToken),this._materialVisuEventToken=null)},refreshForMaterials:function(){this._setMaterialSetting(this._context.getViewer())&&!0===this._dataLoadedWithoutMaterial&&(this._dataLoadedWithoutMaterial=!1,this.refresh(!0))},areDataLoadedWithoutMaterial:function(){return this._dataLoadedWithoutMaterial},_onMaterialChanged:function(e){this.isMaterialSupportActivated()&&i.getSetting("enopad3dviewer_autoReloadOnMaterialModeEngaged")&&this.refreshForMaterials()},_setMaterialSetting:function(e){var t=e.getMaterialMode();return"number"==typeof t&&(t=0!==t),i.setSetting("enopad3dviewer_materialMode",t),t},needToGetMaterials:function(){var e=void 0;return this.isViewerInMaterialMode()&&this.isMaterialSupportActivated()&&(e=!0),e},getMaterialParametersForQuery:function(){if(i.getSetting("enopad3dviewer_lightNodeModel"))return{aggregationProcessors:o.getAggregatedProcessor(),materialAttributes:o.getMaterialAttributes()}},isViewerInMaterialMode:function(){return i.getSetting("enopad3dviewer_materialMode")},isMaterialSupportActivated:function(){return i.getSetting("enopad3dviewer_materialSupportActivated")}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerReframeOnCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt"],function(e,t,i,o){"use strict";var n=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0,mode:"shared"}),this._context=i.get(e.context)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerReframeOnCmd"}),i.trackPageEvent()});var e=this;require(["DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices"],function(t,i){var n=t.get(),s=[];n.forEach(function(e){s.push(e.pathElement)}),o.getSetting("enopad3dviewer_lightNodeModel")?i.reframeOnCandidates({paths:s,viewpoint:e._context.getViewpoint(),context:e._context}):i.reframeOn({paths:s,viewpoint:e._context.getViewpoint()}),e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerReframeOnCmd",n)}),define("DS/ENOPAD3DViewer/utils/PADOctree",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory"],function(e,t,i,o,n,s,r){"use strict";var a=function(){this.children=[],this.data=[]};return t.extend({init:function(e,t){this.__traverseDebug=!1,this._a=0,this._nbPrimitives=0,this._maxDepth=t||16,this._bound=e||new o.Box3,this._root=new a,this._allData=[],this._nbNodes=1,this._allData_id=[]},add:function(e,t){var i=(t.max.x-t.min.x)*(t.max.x-t.min.x)+(t.max.y-t.min.y)*(t.max.y-t.min.y)+(t.max.z-t.min.z)*(t.max.z-t.min.z);this._allData_id[e.id/5]=!1,this._add(this._root,this._bound,e,t,i,0)},_add:function(e,t,i,n,s,r){var l=(t.max.x-t.min.x)*(t.max.x-t.min.x)+(t.max.y-t.min.y)*(t.max.y-t.min.y)+(t.max.z-t.min.z)*(t.max.z-t.min.z);if(r===this._maxDepth||l<s)this._allData_id[i.id/5]||(e.data.push(i),this._allData.push(i),this._allData_id[i.id/5]=!0);else{var d=new o.Vector3;d.set(.5*t.min.x+.5*t.max.x,.5*t.min.y+.5*t.max.y,.5*t.min.z+.5*t.max.z);var h=new Array(8);h[0]=h[1]=h[2]=h[3]=n.min.x<=d.x,h[4]=h[5]=h[6]=h[7]=n.max.x>d.x,h[0]&=n.min.y<=d.y,h[1]&=n.min.y<=d.y,h[4]&=n.min.y<=d.y,h[5]&=n.min.y<=d.y,h[2]&=n.max.y>d.y,h[3]&=n.max.y>d.y,h[6]&=n.max.y>d.y,h[7]&=n.max.y>d.y,h[0]&=n.min.z<=d.z,h[2]&=n.min.z<=d.z,h[4]&=n.min.z<=d.z,h[6]&=n.min.z<=d.z,h[1]&=n.max.z>d.z,h[3]&=n.max.z>d.z,h[5]&=n.max.z>d.z,h[7]&=n.max.z>d.z;for(var c=0;c<8;++c)if(h[c]){e.children[c]||(e.children[c]=new a,this._nbNodes++);var p=new o.Box3;p.min.x=4&c?d.x:t.min.x,p.max.x=4&c?t.max.x:d.x,p.min.y=2&c?d.y:t.min.y,p.max.y=2&c?t.max.y:d.y,p.min.z=1&c?d.z:t.min.z,p.max.z=1&c?t.max.z:d.z,this._add(e.children[c],p,i,n,s,r+1)}}}})}),define("DS/ENOPAD3DViewer/utils/PAD3DOctree",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/Node3D"],function(e,t,i,o){"use strict";function n(e){e.mem&&1===e.mem?(this._mem=1,this._iReductionFactor_VPBox=e.iReductionFactor_VPBox?e.iReductionFactor_VPBox:1):this._mem=0,this._depth=e.depth?e.depth:0,this._nodeElements=[],this._divided=!1,this._box=e.box,this._min=this._box.min,this._max=this._box.max,this._displayAll=!1,this._hideAll=!1,this._center={x:(this._max.x+this._min.x)/2,y:(this._max.y+this._min.y)/2,z:(this._max.z+this._min.z)/2},this._contents=[],this._contentPointsInput=0,this._realContentSize=0,this._numberOfProx=0,this._onlyOneProx=null,this._onlyOnePOI=null,this._positionSum={x:0,y:0,z:0},this._averagePos={x:void 0,y:void 0,z:void 0},this._viewerSize=e.viewerSize,this._viewpoint=e.viewpoint,this._vpInCube=this._isPointInsideBox(this._viewpoint.position,{max:this._max,min:this._min}),this._minArea=e.minArea;var i=new t.Vector3(this._viewpoint.target.x-this._viewpoint.position.x,this._viewpoint.target.y-this._viewpoint.position.y,this._viewpoint.target.z-this._viewpoint.position.z);i.normalize();var o=.04*(n._vpBBox.max.x-n._vpBBox.min.x);e.mem&&1===e.mem&&(o=.04*(n._vpBBox.max.x-n._vpBBox.min.x)/this._iReductionFactor_VPBox),this._boxAroundVP={min:{x:this._viewpoint.position.x+i.x*o*.7-o,y:this._viewpoint.position.y+i.y*o*.7-o,z:this._viewpoint.position.z+i.z*o*.7-o},max:{x:this._viewpoint.position.x+i.x*o*.7+o,y:this._viewpoint.position.y+i.y*o*.7+o,z:this._viewpoint.position.z+i.z*o*.7+o}},this.subdivide()}return n.maxDepth=0,n.minDepth=null,n.maxDist=0,n.minDist=null,n._sumDist=0,n._sumSums=0,n._vpBBox=0,n.averageDist=0,n.prototype.clear=function(){this._divided&&(delete this._northWest,delete this._northEast,delete this._southWest,delete this._southEast),this._nodeElements=null},n.prototype.subdivide=function(){if(this._vpInCube&&this._depth<11||this._isAreaGreaterThanMin()){this._divided=!0;var e={x:this._center.x,y:this._center.y,z:this._center.z},t={x:this._min.x,y:this._min.y,z:this._min.z},i={x:this._max.x,y:this._max.y,z:this._max.z};0===this._mem?(this._topNorthWest=new n({box:{min:{x:e.x,y:t.y,z:e.z},max:{x:i.x,y:e.y,z:i.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._topNorthEast=new n({box:{min:e,max:i},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._topSouthWest=new n({box:{min:{x:t.x,y:t.y,z:e.z},max:{x:e.x,y:e.y,z:i.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._topSouthEast=new n({box:{min:{x:t.x,y:e.y,z:e.z},max:{x:e.x,y:i.y,z:i.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._botNorthWest=new n({box:{min:{x:e.x,y:t.y,z:t.z},max:{x:i.x,y:e.y,z:e.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._botNorthEast=new n({box:{min:{x:e.x,y:e.y,z:t.z},max:{x:i.x,y:i.y,z:e.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._botSouthWest=new n({box:{min:t,max:e},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1}),this._botSouthEast=new n({box:{min:{x:t.x,y:e.y,z:t.z},max:{x:e.x,y:i.y,z:e.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1})):1===this._mem&&(this._topNorthWest=new n({box:{min:{x:e.x,y:t.y,z:e.z},max:{x:i.x,y:e.y,z:i.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._topNorthEast=new n({box:{min:e,max:i},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._topSouthWest=new n({box:{min:{x:t.x,y:t.y,z:e.z},max:{x:e.x,y:e.y,z:i.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._topSouthEast=new n({box:{min:{x:t.x,y:e.y,z:e.z},max:{x:e.x,y:i.y,z:i.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._botNorthWest=new n({box:{min:{x:e.x,y:t.y,z:t.z},max:{x:i.x,y:e.y,z:e.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._botNorthEast=new n({box:{min:{x:e.x,y:e.y,z:t.z},max:{x:i.x,y:i.y,z:e.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._botSouthWest=new n({box:{min:t,max:e},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}),this._botSouthEast=new n({box:{min:{x:t.x,y:e.y,z:t.z},max:{x:e.x,y:i.y,z:e.z}},viewpoint:this._viewpoint,viewerSize:this._viewerSize,minArea:this._minArea,depth:this._depth+1,mem:1,id:0,iReductionFactor_VPBox:this._iReductionFactor_VPBox}))}},n.prototype._isAreaGreaterThanMin=function(){var e,i,o,n,s=[],r=[],a=0,l={x:this._max.x,y:this._min.y,z:this._max.z},d=this._max,h={x:this._min.x,y:this._min.y,z:this._max.z},c={x:this._min.x,y:this._max.y,z:this._max.z};s.push(l),s.push(d),s.push(h),s.push(c),r.push(l),r.push(d),r.push(h),r.push(c);var p={x:this._max.x,y:this._min.y,z:this._min.z},u={x:this._max.x,y:this._max.y,z:this._min.z},g=this._min,_={x:this._min.x,y:this._max.y,z:this._min.z};s.push(p),s.push(u),s.push(g),s.push(_),r.push(p),r.push(u),r.push(g),r.push(_);for(var f=this._center,v=!0,m=0;m<s.length;m++)this._isPointInsideBox(s[m],this._boxAroundVP)||(v=!1);if(v)return this._displayAll=!0,!1;s.push(f);var b={x:(d.x+f.x)/2,y:(d.y+f.y)/2,z:(d.z+f.z)/2},y={x:(l.x+f.x)/2,y:(l.y+f.y)/2,z:(l.z+f.z)/2},P={x:(c.x+f.x)/2,y:(c.y+f.y)/2,z:(c.z+f.z)/2},D={x:(g.x+f.x)/2,y:(g.y+f.y)/2,z:(g.z+f.z)/2},I={x:(u.x+f.x)/2,y:(u.y+f.y)/2,z:(u.z+f.z)/2},S={x:(p.x+f.x)/2,y:(p.y+f.y)/2,z:(p.z+f.z)/2},C={x:(_.x+f.x)/2,y:(_.y+f.y)/2,z:(_.z+f.z)/2},w={x:(g.x+f.x)/2,y:(g.y+f.y)/2,z:(g.z+f.z)/2};if(r.push(b),r.push(y),r.push(P),r.push(D),r.push(I),r.push(S),r.push(C),r.push(w),this._depth>3)for(var x=this._max.x-this._min.x,O=this._max.y-this._min.y,A=this._max.z-this._min.z,M=0;M<15;M++)for(var N=0;N<15;N++)for(var V=0;V<15;V++)r.push({x:this._min.x+x*M,y:this._min.y+O*N,z:this._min.z+A*V});var E=!0,T=!0;for(m=0;m<r.length;m++)this._isInsideVisibleField(r[m])&&(E=!1);if(E)return this._hideAll=!0,!1;for(m=0;m<s.length;m++){var R=this._viewpoint.project((new t.Vector3).copy(s[m]));this._vpInCube?T=!1:T&&R&&R.x>0&&R.y>0&&R.x<this._viewerSize.width&&R.y<this._viewerSize.height&&(T=!1),e||(e=R.x),i||(i=R.y),o||(o=R.x),n||(n=R.y),e=Math.max(e,R.x),i=Math.max(i,R.y),o=Math.min(o,R.x),n=Math.min(n,R.y)}return!T&&(a=Math.abs((e-o)*(i-n)),this._minArea<a)},n.prototype._isInsideVisibleField=function(e){return!(this._depth>3)||this._viewpoint._frustum.containsPoint((new t.Vector3).copy(e))},n.prototype.insert=function(e){if(this._divided&&!this._hideAll)this._isPointInsideBox(e.position3D,this._topNorthWest._box)?this._topNorthWest.insert(e):this._isPointInsideBox(e.position3D,this._topNorthEast._box)?this._topNorthEast.insert(e):this._isPointInsideBox(e.position3D,this._topSouthWest._box)?this._topSouthWest.insert(e):this._isPointInsideBox(e.position3D,this._topSouthEast._box)?this._topSouthEast.insert(e):this._isPointInsideBox(e.position3D,this._botNorthWest._box)?this._botNorthWest.insert(e):this._isPointInsideBox(e.position3D,this._botNorthEast._box)?this._botNorthEast.insert(e):this._isPointInsideBox(e.position3D,this._botSouthWest._box)?this._botSouthWest.insert(e):this._isPointInsideBox(e.position3D,this._botSouthEast._box)&&this._botSouthEast.insert(e);else{if("ProximityGroup"===e.data.node.getType()&&e.data.pois&&e.data.pois.length>0){for(var t=0;t<e.data.pois.length;t++){this._contents.push(e.data.pois[t]),this._positionSum.x+=e.data.pois[t].position3D.x,this._positionSum.y+=e.data.pois[t].position3D.y,this._positionSum.z+=e.data.pois[t].position3D.z;var i=Math.sqrt((this._viewpoint.position.x-e.data.pois[t].position3D.x)*(this._viewpoint.position.x-e.data.pois[t].position3D.x)+(this._viewpoint.position.y-e.data.pois[t].position3D.y)*(this._viewpoint.position.y-e.data.pois[t].position3D.y)+(this._viewpoint.position.z-e.data.pois[t].position3D.z)*(this._viewpoint.position.z-e.data.pois[t].position3D.z));n.maxDist=Math.max(i,n.maxDist),n.minDist?n.minDist=Math.min(i,n.minDist):n.minDist=i,n._sumDist+=i,n._sumSums++,n.averageDist=n._sumDist/n._sumSums}this._realContentSize+=e.data.pois.length,this._onlyOnePOI&&(this._onlyOnePOI.data.node.setVisibility(!1),this._onlyOnePOI=null),e.data.pois&&e.data.pois.length>1&&this._contents.length>e.data.pois.length?(this._onlyOneProx&&this._onlyOneProx.data.node&&this._onlyOneProx.data.node.setVisibility(!1),this._onlyOneProx=null,e.data.node.setVisibility(!1)):e.data.pois&&this._contents.length===e.data.pois.length&&(this._onlyOneProx=e)}else{this._onlyOneProx&&this._onlyOneProx.data.node&&this._onlyOneProx.data.node.setVisibility(!1),this._onlyOneProx=null,this._contents.push(e),this._realContentSize++,this._contents.length>1?(this._onlyOnePOI&&(this._onlyOnePOI.data.node.setVisibility(!1),this._onlyOnePOI=null),this._displayAll||e.data.node.setVisibility(!1)):this._onlyOnePOI=e,this._positionSum.x+=e.position3D.x,this._positionSum.y+=e.position3D.y,this._positionSum.z+=e.position3D.z;i=Math.sqrt((this._viewpoint.position.x-e.position3D.x)*(this._viewpoint.position.x-e.position3D.x)+(this._viewpoint.position.y-e.position3D.y)*(this._viewpoint.position.y-e.position3D.y)+(this._viewpoint.position.z-e.position3D.z)*(this._viewpoint.position.z-e.position3D.z));n.maxDist=Math.max(i,n.maxDist),n.minDist?n.minDist=Math.min(i,n.minDist):n.minDist=i}this._averagePos.x=this._positionSum.x/this._contents.length,this._averagePos.y=this._positionSum.y/this._contents.length,this._averagePos.z=this._positionSum.z/this._contents.length}},n.prototype.getLeaves=function(e){this._divided?(this._topNorthWest.getLeaves(e),this._topNorthEast.getLeaves(e),this._topSouthWest.getLeaves(e),this._topSouthEast.getLeaves(e),this._botNorthWest.getLeaves(e),this._botNorthEast.getLeaves(e),this._botSouthWest.getLeaves(e),this._botSouthEast.getLeaves(e)):this._contents.length>0&&e.push({min:this._min,max:this._max,center:this._averagePos,content:this._contents,size:this._realContentSize,depth:this._depth,onlyOneProx:this._onlyOneProx,displayAll:this._displayAll,hideAll:this._hideAll})},n.prototype.empty=function(){this._divided?(this._topNorthWest.empty(),this._topNorthEast.empty(),this._topSouthWest.empty(),this._topSouthEast.empty(),this._botNorthWest.empty(),this._botNorthEast.empty(),this._botSouthWest.empty(),this._botSouthEast.empty()):(this._contents=[],this._realContentSize=0,this._numberOfProx=0,this._onlyOneProx=null,this._positionSum={x:0,y:0,z:0},this._averagePos={x:void 0,y:void 0,z:void 0})},n.prototype._isPointInsideBox=function(e,t){return e.x>=t.min.x&&e.x<=t.max.x&&e.y>=t.min.y&&e.y<=t.max.y&&e.z>=t.min.z&&e.z<=t.max.z},n.prototype.isPointInsideViewpointBox=function(e){return this._isPointInsideBox(e,this._boxAroundVP)},n}),define("DS/ENOPAD3DViewer/views/PAD3DTransparencyPanel",["UWA/Controls/Abstract","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ButtonGroup","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/Controls/TooltipModel","DS/Windows/ImmersiveFrame","DS/Windows/Dialog"],function(e,t,i,o,n,s,r,a){"use strict";const l=-1,d=1,h=.7,c=.2;return e.extend({name:"pad3dviewer-transparency-panel-body",_modal:null,init:function(e){this._parent(e);let s=UWA.createElement("div",{class:this.getClassNames()});this.buttonGroup=new o({type:"radio"});let p=new i({type:"radio",label:n.transparencyPanel.none,value:l,checkFlag:!1}),u=new i({type:"radio",label:n.transparencyPanel.opaque,value:d,checkFlag:!1}),g=new i({type:"radio",label:n.transparencyPanel.low,value:h,checkFlag:!1}),_=new i({type:"radio",label:n.transparencyPanel.high,value:c,checkFlag:!1});if(e.commonTransparency)switch(e.commonTransparency){case d:u.checkFlag=!0;break;case h:g.checkFlag=!0;break;case c:_.checkFlag=!0}else p.checkFlag=!0;this.buttonGroup.addChild(p),this.buttonGroup.addChild(u),this.buttonGroup.addChild(g),this.buttonGroup.addChild(_),this.buttonGroup.inject(s);var f=new r({identifier:"transparency_immersive-frame"});f.inject(document.body);new a({domId:"transparency-dialog-frame",immersiveFrame:f,width:"auto",height:"auto",title:n.transparencyPanel.title,content:s,modalFlag:!1,resizableFlag:!1,closeButtonFlag:!1,buttons:{Ok:new t({onClick:this._onOKDialog.bind(this),domId:"PAD3DTransparencyPanel-OK-button"}),Cancel:new t({onClick:this._onCloseDialog.bind(this),domId:"PAD3DTransparencyPanel-Cancel-button"})}})},_onCloseDialog:function(e){this.dispatchEvent("onCancel",{event:e}),e.dsModel.dialog.close()},_onOKDialog:function(e){this.dispatchEvent("onConfirm",{opacity:this.buttonGroup.value[0]}),e.dsModel.dialog.close()}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerZOIController",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],function(e,t,i,o){return e.extend({_idToNodeMap:new Map,_zoneIdToLayerMap:new Map,_drawZoneOfInterest:function(e){return new Promise(((e,t)=>{var i=[],o=e.zoneOfInterest;if(o&&o.layers){this._layerController.declareLayerKinds([{AMD:"DS/ENOPAD3DViewer/views/PADLayerZOIView",kind:"zoi"}]).then((t=>{if(!0!==e.cumulativeMode){this._resetZoneOfInterest();for(var o=0;o<t.layers.length;o++)i.push(this._createZoneOfInterestLayer(t.layers[o]))}else for(o=0;o<t.layers.length;o++){if(void 0!==t.layers[o].id)this._ZOILayers.get(t.layers[o].id)?i.push(this._updateZoneOfInterestLayer(t.layers[o])):i.push(this._createZoneOfInterestLayer(t.layers[o]))}}).bind(void 0,o))}Promise.all(i).then(t)}).bind(void 0,e))},_createZoneOfInterestLayer:function(e){return new Promise(((e,t)=>{if(e&&e.zones&&(e.zones.boxes&&e.zones.boxes.length||e.zones.spheres&&e.zones.spheres.length||e.zones.cylinders&&e.zones.cylinders.length)){var i=new Map;this._generateStyleMap(e.styles,i,!1);var o=this._layerController.createLayer({layerId:e.id,type:"zoi",kind:"zoi",label:e.label,visibility:void 0===e.visibility||e.visibility});o.setStyles(i),this._ZOILayers.set(o.getID(),o),this._layers.set("ZOIs",this._ZOILayers);var n=[];Array.isArray(e.zones.boxes)&&n.push(this._handleBoxes(e.zones.boxes,i,o)),Array.isArray(e.zones.spheres)&&n.push(this._handleSpheres(e.zones.spheres,i,o)),Array.isArray(e.zones.cylinders)&&n.push(this._handleCylinders(e.zones.cylinders,i,o)),Promise.all(n).then(function(e){this._context.getViewer().render({updateInfinitePlane:!0}),e()}.bind(this,t))}else t()}).bind(void 0,e))},_updateZoneOfInterestLayer:function(e){return new Promise(((e,t)=>{if(void 0===e.id)return console.error("No id defined for this layer, impossible to cumulate data"),void t();var i=this._ZOILayers.get(e.id);if(!i)return console.error("No existing layer with "+e.id+" id, impossible to cumulate data"),void t();var o=i.getStyles();this._generateStyleMap(e.styles,o,!0),i.setStyles(o);var n=[];Array.isArray(e.zones.boxes)&&n.push(this._handleBoxes(e.zones.boxes,o,i)),Array.isArray(e.zones.spheres)&&n.push(this._handleSpheres(e.zones.spheres,o,i)),Array.isArray(e.zones.cylinders)&&n.push(this._handleCylinders(e.zones.cylinders,o,i)),Promise.all(n).then(function(e){this._context.getViewer().render({updateInfinitePlane:!0}),e()}.bind(this,t))}).bind(void 0,e))},_handleBoxes:function(e,t,i){return new Promise(((e,t,i,o)=>{for(var n=0;n<e.length;n++){var s=e[n];void 0!==s.id&&void 0!==s.style&&void 0!==s.min&&void 0!==s.max&&void 0!==s.matrix&&(this._idToNodeMap.get(s.id)&&this._cleanZOI(s.id),this._createBox(s,t,i))}o()}).bind(void 0,e,t,i))},_cleanZOI:function(e){var t=this._idToNodeMap.get(e);t.parents[0].remove(t),this._idToNodeMap.delete(e),this._zoneIdToLayerMap.delete(e)},_createBox:function(e,o,n){var s=e.style,r=o.get(s),a=new i.Box3(new i.Vector3(parseFloat(e.min[0]),parseFloat(e.min[1]),parseFloat(e.min[2])),new i.Vector3(parseFloat(e.max[0]),parseFloat(e.max[1]),parseFloat(e.max[2]))),l={color:r.color,force:!0};void 0!==r.opacity&&r.opacity<1&&(l.transparent=!0,l.opacity=r.opacity);var d=i.MaterialUtils.createShinyFaceMaterial(l),h=t.createCuboidNodeFromBox3(a,d);h.id=e.id,h.className="PAD3DZOINode",e.matrix&&h.setMatrix((new i.Matrix4).setFromArray(e.matrix)),this._idToNodeMap.set(e.id,h),this._zoneIdToLayerMap.set(e.id,n.getID()),n.getNode3DBag().addChild(h)},_handleSpheres:function(e,t,i){return new Promise(((e,t,i,o)=>{for(var n=0;n<e.length;n++){var s=e[n];void 0!==s.id&&void 0!==s.style&&void 0!==s.center&&void 0!==s.radius&&(this._idToNodeMap.get(s.id)&&this._cleanZOI(s.id),this._createSphere(s,t,i))}o()}).bind(void 0,e,t,i))},_createSphere:function(e,o,n){var s=e.style,r=o.get(s),a={color:r.color,force:!0};void 0!==r.opacity&&r.opacity<1&&(a.transparent=!0,a.opacity=r.opacity);var l=i.MaterialUtils.createShinyFaceMaterial(a),d=new i.Matrix4;d.setPosition(new i.Vector3(parseFloat(e.center[0]),parseFloat(e.center[1]),parseFloat(e.center[2])));var h=t.createSphereNode({matrix:d,radius:e.radius,material:l});h.id=e.id,h.className="PAD3DZOINode",this._idToNodeMap.set(e.id,h),this._zoneIdToLayerMap.set(e.id,n.getID()),n.getNode3DBag().addChild(h)},_handleCylinders:function(e,t,i){return new Promise(((e,t,i,o)=>{for(var n=0;n<e.length;n++){var s=e[n];void 0!==s.id&&void 0!==s.style&&void 0!==s.bottomCenterPoint&&void 0!==s.topCenterPoint&&void 0!==s.radius&&void 0!==s.subdivision&&(this._idToNodeMap.get(s.id)&&this._cleanZOI(s.id),this._createCylinder(s,t,i))}o()}).bind(void 0,e,t,i))},_createCylinder:function(e,o,n){var s=e.style,r=o.get(s),a={color:r.color,force:!0};void 0!==r.opacity&&r.opacity<1&&(a.transparent=!0,a.opacity=r.opacity);var l=i.MaterialUtils.createShinyFaceMaterial(a),d=new i.Vector3(parseFloat(e.bottomCenterPoint[0]),parseFloat(e.bottomCenterPoint[1]),parseFloat(e.bottomCenterPoint[2])),h=new i.Vector3(parseFloat(e.topCenterPoint[0]),parseFloat(e.topCenterPoint[1]),parseFloat(e.topCenterPoint[2])),c=t.createCylinderNode({bottomCenterPoint:d,topCenterPoint:h,radius:e.radius,sag:Math.min(e.subdivision,60),material:l});c.id=e.id,c.className="PAD3DZOINode",this._idToNodeMap.set(e.id,c),this._zoneIdToLayerMap.set(e.id,n.getID()),n.getNode3DBag().addChild(c)},_resetZoneOfInterest:function(){var e=this._layers.get("ZOIs");e&&(e.forEach((e,t)=>{this._layerController.deleteLayer(e)}),this._layers.delete("ZOIs")),this._ZOILayers.clear(),this._idToNodeMap.clear(),this._zoneIdToLayerMap.clear(),this._context.getViewer().render()},streamZOI:function(e,t){if(e&&t){var i=e.getLastElement(!0);i&&"PAD3DZOINode"===i.className&&t.push(i.id)}},unstreamZOIs:function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i],s=this._idToNodeMap.get(n),r=this._zoneIdToLayerMap.get(n);if(s&&r){var a=this._ZOILayers.get(r);if(a){var l=new o([this._decorationBag,a.getNode3DBag(),s]);t.push({pathElement:l})}}}return t}})}),define("DS/ENOPAD3DViewer/views/PAD3DLayerWindow",["DS/Windows/Panel","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t){"use strict";function i(e){this._list=null,this._panel=null,this._parentContainer=e.renderTo,this._buildSkeleton()}return i.prototype._buildSkeleton=function(){this._list=document.createElement("div"),this._list.classList.add("PAD3DLayerWindow-container"),this._panel=new e({title:t.PAD3DLayerPanel_title,immersiveFrame:this._parentContainer,content:this._list,resizableFlag:!1,width:200,height:"auto",allowedDockAreas:12,collapsibleFlag:!1,verticallyStretchableFlag:!navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i),closeButtonFlag:!1}),this._panel.immersiveFrame.dockWindow(this._panel,8,{attachToOtherDockedWindow:!0})},i.prototype.hide=function(){this._panel.hide()},i.prototype.show=function(){this._panel.show()},i.prototype.appendChild=function(e){this._list.appendChild(e)},i.prototype.removeChild=function(e){this._list.removeChild(e)},i}),define("DS/ENOPAD3DViewer/views/PADLayerLegend",["DS/Utilities/UUID","DS/Utilities/Dom","DS/Core/PointerEvents","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/Controls/ColorPalette","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer"],function(e,t,i,o,n,s,r){"use strict";function a(e){this.options=e||{},this.elements={},this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"none",cellSelection:"none",placeholder:r.emptyLegend,columns:[{dataIndex:"labelColor",typeRepresentation:"color",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,onCellRequest:function(e){var t,i,o=this.options.dgv.reuseCellContent("colorPalette"),n=e.nodeModel.getAttributeValue("labelColor");t=(t=e.nodeModel.getAttributeValue("opacity"))?Math.round(255*t).toString(16):"ff",n.substring&&(i=n.substring(0,7).toLowerCase()+t,o.swatches=[{value:i}]),e.cellView.setReusableContent(o)}.bind(this)},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}],layoutOptions:{rowsHeader:!1,columnsHeader:!1,layoutDensity:"comfortable"}},this.options.typeReps={},this._buildContent()}return a.prototype.render=function(){return this.elements.container},a.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerLegendView-container"),this.elements.header=document.createElement("div"),this.elements.header.classList.add("PAD3DLayerLegendView-header"),this.elements.container.appendChild(this.elements.header);let i=document.createElement("div");i.classList.add("PAD3DLayerLegendView-layerName"),i.innerText=this.options.layerLabel,this.elements.header.appendChild(i);let a=t.generateIcon("back");a.classList.add("closeIcon"),a.addEventListener("click",e=>{this.options.mdlEvts.publish({event:"PAD3DLayer/hideMore",data:{layerName:this.options.layerName}})}),this.elements.header.appendChild(a);var l=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions),d=this.options.dgv=new n(l);if(this.options.model=new o,d.treeDocument=this.options.model,d.getContent().addClassName("PAD3DLayerLegendView-dgv"),d.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),d.onReady(()=>{}),d.registerReusableCellContent({id:"colorPalette",buildContent:function(){var e=new s({swatches:[]});return e.getContent().addClassName("PAD3DLayerLegendView_ColorPalette"),e}}),this.options.legend&&this.options.legend.length)for(let e=0;e<this.options.legend.length;e++)this.options.legend[e].label?this.options.legend[e].color?this.options.model.addChild({label:this.options.legend[e].label,grid:{labelColor:this.options.legend[e].color,opacity:this.options.legend[e].opacity}}):this.options.model.addChild({label:this.options.legend[e].label,grid:{labelColor:"#FFFFFF",opacity:this.options.legend[e].opacity}}):void 0===this.options.legend[e].label&&(this.options.legend[e].color?this.options.model.addChild({label:r.legendStyle+" "+(e+1),grid:{labelColor:this.options.legend[e].color,opacity:this.options.legend[e].opacity}}):this.options.model.addChild({label:r.legendStyle+" "+(e+1),grid:{labelColor:"#FFFFFF",opacity:this.options.legend[e].opacity}}));this.elements.container.appendChild(this.options.dgv.getContent())},a}),define("DS/ENOPAD3DViewer/mixins/PAD3DViewerDebugTileNodeModel",["UWA/Core","UWA/Class"],function(e,t){"use strict";return t.extend({name:"PAD3DViewerDebugTileNodeModel",dump_representations_loaded_inViewpoint:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)0===e[t[o]].handlerType&&"complete"===e[t[o]].status&&e[t[o]].screenRadius>=0&&i.push(t[o]);console.group("Status about reps loaded in current viewpoint:"),console.group("Number of reps:"),console.log(i.length),console.groupEnd(),console.group("List of rep ids:"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd(),console.groupEnd()},dump_references_nbChildren:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)e[t[o]].expectedNbChildren&&i.push(e[t[o]].expectedNbChildren);i.sort(function(e,t){return e<t?-1:e>t?1:0}).reverse(),console.group("All nbChildren"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd()},dump_representations_loaded_outsideViewpoint:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)0===e[t[o]].handlerType&&"complete"===e[t[o]].status&&e[t[o]].screenRadius<0&&i.push(t[o]);console.group("Status about reps loaded outside current viewpoint:"),console.group("Number of reps:"),console.log(i.length),console.groupEnd(),console.group("List of rep ids:"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd(),console.groupEnd()},dump_representations_notLoaded_inViewpoint:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)0===e[t[o]].handlerType&&"complete"!==e[t[o]].status&&e[t[o]].screenRadius>=0&&i.push(t[o]);console.group("Status about reps not loaded in current viewpoint:"),console.group("Number of reps:"),console.log(i.length),console.groupEnd(),console.group("List of rep ids:"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd(),console.groupEnd()},dump_representations_notLoaded_outsideViewpoint:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)0===e[t[o]].handlerType&&"complete"!==e[t[o]].status&&e[t[o]].screenRadius<0&&i.push(t[o]);console.group("Status about reps not loaded outside current viewpoint:"),console.group("Number of reps:"),console.log(i.length),console.groupEnd(),console.group("List of rep ids:"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd(),console.groupEnd()},dump_references_locked:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)this.isNodeLocked(t[o])&&i.push(t[o]);console.group("Status about references locked:"),console.group("Number of references:"),console.log(i.length),console.groupEnd(),console.group("List of reference ids:"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd(),console.groupEnd()},dump_representations_withoutStream:function(){for(var e=this._OOCManager._getDebugJSON().references,t=Object.keys(e),i=[],o=0;o<t.length;o++)0===e[t[o]].handlerType&&(this._OOCManager._getLDHReference(t[o]).url||i.push(t[o]));console.group("Status about reps without stream:"),console.group("Number of reps:"),console.log(i.length),console.groupEnd(),console.group("List of rep ids:"),console.log(JSON.stringify(i)),"undefined"!=typeof copy&&(copy(JSON.stringify(i)),console.log("Content is copied in clipboard")),console.groupEnd(),console.groupEnd()},dump_debugJSON:function(){var e=this._OOCManager._getDebugJSON();console.group("Status OOC model:"),console.log(JSON.stringify(e)),"undefined"!=typeof copy&&(copy(JSON.stringify(e)),console.log("Content is copied in clipboard")),console.groupEnd()},dump_OOCModelStats:function(){var e=this._OOCManager._getDebugJSON().references,t=this._OOCManager._getAllInstancesDebugJSON(),i=[],o=[],n=[],s=0,r=Object.keys(e),a=Object.keys(t);for(s=0;s<r.length;s++){1===e[r[s]].handlerType?n.push(r[s]):o.push(r[s])}for(s=0;s<a.length;s++)i.push(a[s]);console.group("Stats about OOC model:"),console.group("References"),console.group("Number of references:"),console.log(n.length),console.groupEnd(),console.group("List of reference ids:"),console.log(JSON.stringify(n)),console.groupEnd(),console.groupEnd(),console.group("Instances"),console.group("Number of instances:"),console.log(i.length),console.groupEnd(),console.group("List of instance ids:"),console.log(JSON.stringify(i)),console.groupEnd(),console.groupEnd(),console.group("Representations"),console.group("Number of representations:"),console.log(o.length),console.groupEnd(),console.group("List of representation ids:"),console.log(JSON.stringify(o)),console.groupEnd(),console.groupEnd(),console.groupEnd()},dump_representations_projected_bbox:function(){this._OOCManager._getDebugJSON().references;var e=[],t=[],i=[],o=0;for(o=this._repList.length-1;o>=0;o--){this._OOCManager._getLDHReference(this._repList[o].id,!0)||this._repList.splice(o,1)}if(this._repList.length){var n=this._repList[0].stamp;for(t.push("00:00:00.000"),i.push(this._repList[0].parsingID),e.push(Math.min(this._OOCManager._getLDHReference(this._repList[0].id,!0)._screenRadius,2e3)),o=1;o<this._repList.length;o++){e.push(Math.min(this._OOCManager._getLDHReference(this._repList[o].id,!0)._screenRadius,2e3));var s=this._repList[o].stamp.getTime()-n.getTime(),r=Math.floor(s/6e4),a=(s%6e4/1e3).toFixed(0),l=(1e3*(s%6e4/1e3-Math.floor(s%6e4/1e3))).toFixed(0);t.push("00:"+r+":"+a+"."+l),i.push(this._repList[o].parsingID)}}console.group("Projected BBox ordered as received:"),console.group("Number of reps:"),console.log(e.length),console.groupEnd(),console.group("List of size:"),console.log(JSON.stringify(e)),console.groupEnd(),console.group("List of dates:"),console.log(JSON.stringify(t)),console.groupEnd(),console.group("List of query id:"),console.log(JSON.stringify(i)),console.groupEnd(),console.groupEnd()}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerHideShowCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._context=i.get(this.options.context)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerHideShowCmd"}),i.trackPageEvent()});var e=this;require(["DS/Selection/CSOManager"],function(t){var i=t.get(),o=[];i.forEach(function(e){o.push(e.pathElement.clone())}),e._context.getHideShowController().toggleHideShow({paths:o,dispatch:!0}),e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerHideShowCmd",o)}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerTypesDictionary",["UWA/Class","UWA/Class/Options","text!DS/ENOPAD3DViewer/assets/typesDictionary.json"],function(e,t,i){"use strict";return e.singleton(t,{name:"PAD3DViewerTypesDictionary",_dictionary:null,init:function(){this._dictionary=JSON.parse(i)},get:function(){return this._dictionary}})}),define("DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/PADUtils/PADSettingsMgt","UWA/Controls/Abstract","DS/PADUtils/PADContext","DS/Controls/Button","DS/Controls/Toggle"],function(e,t,i,o,n,s){var r=function(e){var t=!1;return"boolean"==typeof e?t=e:"string"==typeof e&&(t="true"===e.toLowerCase()),t};return i.extend({name:"padRemoveFilterPanel",widget:null,init:function(t){this._parent(t),this.container=this.options.container,this.widget=o.get().getWidget(),this.options={displayRemoveFilterOpts:!1,validateCB:t.events.onValidate},this.elements.container=UWA.createElement("div",{class:this.getClassNames("-removeFilter")}),!0===r(this.widget.getValue("displayRemoveFilterOpt"))?require(["DS/ENOFloatingPanel/ENOFloatingPanel"],function(t){this.elements.floatingpanel=new t({className:this.name,body:this._buildContainer(),footer:this._buildFooter(),title:e.removeFilterPanelTitle,overlay:!0,closable:!0,animate:!0,resizable:!1,visible:!0,events:{onClose:function(){this.options.validateCB(r(this.widget.getValue("removeFilterFullReload"))),this.elements.floatingpanel.destroy()}.bind(this)}}),this.elements.floatingpanel.inject(this.container)}.bind(this),function(e){console.error("AMD loading failed : failed to load the module ENOFloatingPanel, "+e)}):(o.get().displayNotification({eventID:"info",msg:!0===r(this.widget.getValue("removeFilterFullReload"))?e.removeFilterAutoReload:e.removeFilterAutoIgnore}),this.options.validateCB(r(this.widget.getValue("removeFilterFullReload"))))},_buildContainer:function(){var t=UWA.createElement("div",{class:this.getClassNames("-bodyView")}).inject(this.elements.container);UWA.createElement("p",{class:this.getClassNames("-description")}).inject(t).innerText=e.removeFilterPanelDescription;var i=UWA.createElement("div",{class:this.getClassNames("-footerView")}).inject(t);applyToggle=new s({label:e.removeFilterPanelAutoApply,checkFlag:!r(this.widget.getValue("displayRemoveFilterOpt"))});var o=UWA.createElement("div",{class:this.getClassNames("-instruction applyToggle"),content:applyToggle});return applyToggle.inject(o),o.inject(i),applyToggle.addEventListener("change",function(e){var t=e.dsModel;this.options.displayRemoveFilterOpts=!t.checkFlag,r(this.widget.getValue("displayRemoveFilterOpt"))!==this.options.displayRemoveFilterOpts&&this.widget.setValue("displayRemoveFilterOpt",this.options.displayRemoveFilterOpts)}.bind(this)),t},_buildFooter:function(){var t=UWA.createElement("div",{class:this.getClassNames("-footerModal")}),i=new n({label:e.reload,emphasize:"primary",touchMode:!0}),o=new n({label:e.ignore,touchMode:!0});return i.addEventListener("click",function(){!1===r(this.widget.getValue("displayRemoveFilterOpt"))&&this.widget.setValue("removeFilterFullReload",!0),this.options.validateCB(!0),this.elements.floatingpanel.destroy()}.bind(this)),o.addEventListener("click",function(){!1===r(this.widget.getValue("displayRemoveFilterOpt"))&&this.widget.setValue("removeFilterFullReload",!1),this.options.validateCB(!1),this.elements.floatingpanel.destroy()}.bind(this)),i.inject(t),o.inject(t),t}})}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerReveal",["DS/PADServices/ws/WSAccess","DS/PADServices/utils/GlobalUtils","text!DS/ENOPAD3DViewer/assets/json/RevealPatterns.json","DS/PADUtils/views/PADProgressBar","DS/UIKIT/Modal","DS/Controls/Label","DS/Controls/Button","DS/Controls/ButtonGroup","DS/Controls/Toggle","DS/PADUtils/PADContext","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s,r,a,l,d,h){"use strict";var c=!1,p=JSON.parse(i);function u(){return"object"==typeof u.instance?u.instance:(u.instance=this,localStorage.getItem("Reveal-settings-"+t.getAppId())||localStorage.setItem("Reveal-settings-"+t.getAppId(),JSON.stringify(p)),this._loadingActive=!1,this._startReveal=!1,this._processing=!1,this._lastBatch=!1,this._refPIDMap=null,this._layerMap=null,this._timeoutToken=null,this._timeoutNoDocs=null,this._nodocs=!0,this._firstPass=!0,this._numberOfRequests=0,this._numberOfAnswers=0,this)}return u.prototype.initialize=function(e){return new Promise(function(i){if(e&&e.context&&(this._context=e.context,this._context.subscribe("newNodes",this.__manageNewNodes.bind(this))),this._numberOfAnswers=0,this._nodocs=!0,!1===c){this._processing=!1;var o=localStorage.getItem("Reveal-settings-"+t.getAppId());o&&(p=JSON.parse(o));for(var n=Object.keys(p),s=[],r=0;r<n.length;r++)p[n[r]].nlsPatternAMD&&-1===s.indexOf(p[n[r]].nlsPatternAMD)&&s.push(p[n[r]].nlsPatternAMD);new Promise(function(e){require(s,function(){e()})}).then(function(){for(var e=0;e<n.length;e++){var t=require(p[n[e]].nlsPatternAMD)[n[e]];p[n[e]].label=t}c=!0,i()})}else i()}.bind(this))},u.prototype._revealIds=function(e){this._processing=!0;for(var t=[],i=[],o=Date.now(),n=0;n<e.length;++n){var s=this._context.getController().createReferenceIterator(e[n]);this._getPathId(s,i,t)}Date.now();this._timeoutToken=setTimeout(function(){this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._notifyMsg(h.RevealDocumentsMsgs.timeout,"warning"),this.endReveal()}.bind(this),6e4);var r=[];this._context.getController()._layerController.setCustomHeaderVisibility("reveal",!0);var a=e;if(e.length>99){for(;a.length>99;){var l=a.slice(0,98);a=a.slice(99),this._numberOfRequests++,r.push(this.reveal(l))}a.length>0&&(this._numberOfRequests++,r.push(this.reveal(a)))}else this._numberOfRequests++,r.push(this.reveal(i));Promise.all(r).then(function(e){!0===this._nodocs?(this._notifyMsg(h.RevealDocumentsMsgs.nodocs,"info"),this.endReveal()):this._idsDone()}.bind(this))},u.prototype._idsDone=function(){this._nodocs=!0,this._numberOfRequests=0,this._processing=!1,this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._context.getController()._layerController.setCustomHeaderVisibility("reveal",!1),this._notifyMsg(h.RevealDocumentsMsgs.success,"success"),setTimeout(function(){if(this._context.getController()._layers){var e=this._context.getController()._layers.get("POIs");if(e)for(var t=0;t<e.length;t++)e[t].subscribe({event:"delete"},function(e){this._deleteLayerCB(e)}.bind(this))}}.bind(this),2e3)},u.prototype._notifyMsg=function(e,i){document.querySelector(".PAD3DLayerRevealView-progress-bar");if("error"===i||"info"===i){c=!1;var o=localStorage.getItem("Reveal-modal-"+t.getAppId());if(o)var n=JSON.parse(o);if(n&&!1===n.openPanel){var s=localStorage.getItem("Reveal-settings-"+t.getAppId());s&&(p=JSON.parse(s))}}this._context.getController()._layerController.setCustomHeaderVisibility("reveal",!1),this._context.displayNotification({eventID:i||"warning",msg:e})},u.prototype._startRevealAfterPanel=function(){this._refPIDMap=new Map,this._layerMap=new Map,this._startReveal=!0,this._deletedLayers=new Map,this._context.getController().publish({event:"startAsync",data:{}}),this._loadingActive=!0,o.setText(h.RevealDocumentsMsgs.queryDocuments),this._timeoutNoDocs=setTimeout(function(){this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._notifyMsg(h.timeout,"error"),this.endReveal()}.bind(this),55e3);var e=localStorage.getItem("Reveal-settings-"+t.getAppId());e&&(p=JSON.parse(e)),this._pois=new Map,this._jsonPOI={cumulativeMode:!0,pointOfInterest:{enableClustering:!0,enableProximityMerging:!0,proximityThreshold:.001,kinds:[{kind:"reveal",AMD:"DS/ENOPAD3DViewer/views/PADLayerRevealView"}],layers:[]}},this._context.getController()._layerController.setCustomHeaderVisibility("reveal",!0);var i=this._context.getController()._model._OOCManager.getAllReferences();this._revealIds(i)},u.prototype.startReveal=function(){var e=localStorage.getItem("Reveal-modal-"+t.getAppId());if(e)var i=JSON.parse(e);i&&!1===i.openPanel?this._startRevealAfterPanel():this._openModal()},u.prototype.endReveal=function(){this._startReveal=!1,this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._timeoutToken&&clearTimeout(this._timeoutToken),this._timeoutNoDocs&&clearTimeout(this._timeoutNoDocs),this._layerMap&&this._layerMap.size>0&&this._layerMap.forEach(function(e){e&&e.id&&this._context.getController().get3DLayerController().deleteLayerId(e.id)}.bind(this)),this._context.getController()._updatePOIClustersTimedout(),delete this._refPIDMap,delete this._layerMap,this._refPIDMap=null},u.prototype._deleteLayerCB=function(e){"reveal"===e.layer.options.kind&&this._deletedLayers.set(e.layer.options.label,e.layer)},u.prototype.reveal=function(t){return new Promise(function(i){this.getPatterns().then(function(o){var n=Object.keys(o);n&&n.length>0?e.getDetail({ids:t,relations:n,trueREST:!0,ecoSystemWithDetail:!0}).then(function(e){this._numberOfAnswers++;var t=(e="string"==typeof e?JSON.parse(e):e).newstructure;if(0!==Object.getOwnPropertyNames(t).length){this._firstPass=!1;this._timeoutToken&&(clearTimeout(this._timeoutToken),this._timeoutToken=null),this._timeoutNoDocs&&(clearTimeout(this._timeoutNoDocs),this._timeoutNoDocs=null),n.length<99?this._lastBatch=!0:this._lastBatch=!1;for(var s=0;s<n.length;s++)if(t[n[s]]){var r,a=n[s];r="v6_specdoc_to"===a?"#EA4F37":"v6_annexdoc_to"===a?"#42A2DA":"#FEE000";var l=this._layerMap.get(n[s]);if(o[n[s]]&&!this._deletedLayers.has(o[n[s]].label)){l||(l={id:o[n[s]].label,label:o[n[s]].label,clustered:!0,poiIcon:"document",kind:"reveal",type:"reveal",layerGroupView:"DS/ENOPAD3DViewer/views/PADRevealGroupView",color:r,pointMap:[]},this._layerMap.set(n[s],l),this._jsonPOI.pointOfInterest.layers.push(l),this._pois.set(o[n[s]].label,new Map));for(var d=0;d<t[n[s]].length;d++){var h=t[n[s]][d],c=o[n[s]].label+"_"+h.id;h.name;this._pois.has(o[n[s]].label)&&!this._pois.get(o[n[s]].label).has(c)?this._pois.get(o[n[s]].label).set(c,{id:c,label:h.name,resourceids:[h.relation.substring(0,h.relation.indexOf("_"))],color:r}):this._pois.get(o[n[s]].label).get(c).resourceids.push(h.relation.substring(0,h.relation.indexOf("_")))}}else if(this._deletedLayers.has(o[n[s]].label)&&this._jsonPOI.pointOfInterest.layers.length>0)for(var p=this._jsonPOI.pointOfInterest.layers,u=p.length-1;u>=0;u--)p[u].label===o[n[s]].label&&this._jsonPOI.pointOfInterest.layers.splice(u,1)}this._lastBatch?(this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._pois.forEach(function(e,t){for(var i=0,o=0;o<this._jsonPOI.pointOfInterest.layers.length;o++)this._jsonPOI.pointOfInterest.layers[o].id===t&&(i=o);e.forEach(function(e){this._jsonPOI.pointOfInterest.layers[i].pointMap.push(e)}.bind(this))}.bind(this)),this._context.getController().enrich3D(this._jsonPOI).then(function(){this._nodocs=!1,this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._context.getController().enrich3D(this._jsonPOI).then(function(){this._nodocs=!1,this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._context.getController().subscribe({event:"onEndRootRemoved"},function(){this._nodocs=!0}.bind(this)),this._context.getController().subscribe({event:"onComplete"},function(e){"addRoot"===e.intend&&(this._nodocs=!0)}.bind(this)),i()}.bind(this)),i()}.bind(this))):this._context.getController()._layerController.setCustomHeaderVisibility("reveal",!1)}else this._numberOfAnswers===this._numberOfRequests?this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1):this._context.getController()._layerController.setCustomHeaderVisibility("reveal",!1),i()}.bind(this)).catch(function(e){this.endReveal(),this._loadingActive&&(this._context.getController().publish({event:"stopAsync",data:{}}),this._loadingActive=!1),this._timeoutToken&&clearTimeout(this._timeoutToken),this._timeoutNoDocs&&clearTimeout(this._timeoutNoDocs),console.error(e),i()}.bind(this)):this.endReveal()}.bind(this))}.bind(this))},u.prototype._getPathId=function(e,t,i){for(var o=e.getParents(),n=0;n<o.length;++n){var s=o[n].getReferenceId();s&&-1===i.indexOf(s)&&(i.push(s),this._getPathId(o[n],t,i))}var r=e.getReferenceId();this._refPIDMap.get(r)||-1!==t.indexOf(r)||t.push(r)},u.prototype.getPatterns=function(){return new Promise(function(e){this.initialize().then(function(){for(var t={},i=Object.keys(p),o=0;o<i.length;o++)!0===p[i[o]].activated&&(t[i[o]]=p[i[o]]);e(t)})}.bind(this))},u.prototype._openModal=function(){var e=UWA.createElement("div"),i=UWA.createElement("div"),o=UWA.createElement("div");i.classList.add("PAD3DViewerReveal-footer"),o.classList.add("PAD3DViewerReveal-footer-btns");var s,u=new n({className:"",closable:!0,header:h.RevealDocumentsModal.header,body:e,footer:i,visible:!0,events:{onHide:function(){var e=localStorage.getItem("Reveal-settings-"+t.getAppId());e&&(p=JSON.parse(e)),c=!1,u.destroy()}}}).inject(document.body),g=document.createElement("div");g.innerText=h.RevealDocumentsModal.kindOfDocuments,e.appendChild(g);var _=new l({type:"checkbox",label:h.RevealDocumentsModal.doNotShow,value:!1}).inject(i),f=new r({emphasize:"primary",label:h.RevealDocumentsModal.ok}).inject(o);f.getContent().addClassName("PAD3DLayerRevealView-okBtn"),f.getContent().addEventListener("buttonclick",function(e){this.endReveal(),s=this.getAvailablePatterns(),Object.keys(s).length>0&&(!0===_.checkFlag&&localStorage.setItem("Reveal-modal-"+t.getAppId(),JSON.stringify({openPanel:!1})),this.setAvailablePatterns(s),this._startRevealAfterPanel(),u.hide())}.bind(this));var v=new r({emphasize:"secondary",label:h.RevealDocumentsModal.cancel}).inject(o);o.inject(i),v.getContent().addEventListener("buttonclick",function(e){u.hide()}.bind(this)),s=this.getAvailablePatterns();for(var m=new a({type:"checkbox"}).inject(e),b=Object.keys(s),y=0;y<b.length;y++){var P=new l({type:"checkbox",label:s[b[y]].label,value:b[y],checkFlag:s[b[y]].activated});P.getContent().addClassName("PAD3DLayerRevealView-toggle"),P.addEventListener("change",function(e){if(s[e.dsModel.value].activated=e.dsModel.checkFlag,!e.dsModel.checkFlag){for(var t=Object.keys(s),i=!0,o=0;o<t.length;o++)s[t[o]].activated&&(i=!1);i&&(d.get().displayNotification({eventID:"warning",msg:h.revealLayer.warningNoSelection}),e.dsModel.checkFlag=!0)}}),m.addChild(P)}u.show()},u.prototype.setAvailablePatterns=function(e){p=e,localStorage.setItem("Reveal-settings-"+t.getAppId(),JSON.stringify(p))},u.prototype.getAvailablePatterns=function(){return p},u.prototype.__manageNewNodes=function(e){this._startReveal},new u}),define("DS/ENOPAD3DViewer/views/PADPOIManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var o=i.extend({init:function(){return this._parent(),this.noCursorChange=!0,this},BeginManipulate:function(e,t,i){},BeginPreactivate:function(e,t,i){var o={viewer:t.viewer,eventChannel:"BeginPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("BeginPreactivate",o)},Preactivate:function(e,t,i){var o={viewer:t.viewer,eventChannel:"Preactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.publish("Preactivate",o)},EndPreactivate:function(e,t,i){var o={viewer:t.viewer,eventChannel:"EndPreactivate",event:t,preactivated:this.preactivated,intersection:i,manipulator:this};this.setSelectionAllowed(!0),this.publish("EndPreactivate",o)},EndManipulate:function(e,t,i){console.log("end manipulate")}});return UWA.namespace("DS/ENOPAD3DViewer/views/PADPOIManipulator",o)}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerPrintCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices"],function(e,t,i,o){"use strict";var n=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0,mode:"shared"}),this._context=i.get(e.context),o.isMobileDevice()&&this.disable()},execute:function(){this.disable(),require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerPrintCmd"}),i.trackPageEvent()});var e=this._context.getViewer(),t=e.SCREEN_WIDTH/e.SCREEN_HEIGHT,i=t>1?1920:Math.floor(1920*t),o=t>1?Math.floor(1920/t):1920,n=document.createElement("canvas");n.width=i,n.height=o;var s={data:null,width:i,height:o,bufferWidth:0,bufferHeight:0,x:0,y:0};this._context.getViewer().renderToTarget(s,this._context.getViewpoint());var r=n.getContext("2d"),a=r.getImageData(0,0,n.width,n.height);if(a.width==n.width)if(a.height==n.height){var l,d,h,c,p=(s.width-1)/(a.width-1),u=(s.height-1)/(a.height-1),g=s.data,_=a.data;if(1==p&&1==u){var f=a.height,v=a.width,m=4*v;for(d=0;d<f;d++)for(h=d*v*4,c=(f-d)*v*4,l=m;l--;)_[h+l]=g[c+l]}else{var b=function(e,t,i,o,n){return n&&(t=o-t),i*t+e},y=a.height,P=a.width,D=s.height,I=s.width;for(d=0;d<y;d++){var S=Math.floor(u*d);for(l=0;l<P;l++)h=4*b(l,d,P,y),c=4*b(Math.floor(p*l),S,I,D,!0),_[h]=g[c],_[h+1]=g[c+1],_[h+2]=g[c+2],_[h+3]=g[c+3]}}r.putImageData(a,0,0,0,0,n.width,n.height);var C=function(e){var i='style="max-width: 100%"';t<1&&(i='style="max-height: 95%; margin: 0px"');var o="<!DOCTYPE html>";o+='<html style="height: 100vh; width: 100vw; margin: 0px">',o+="<head><title>"+e.contentName+"</title></head>",o+='<body style="height: 100vh; width: 100vw; margin: 0px">',o+='<img src="'+n.toDataURL("image/png")+'" '+i+">",o+="</body>",o+="</html>";var s=window.open("","","width=800,height=600");s.document.open(),s.document.addEventListener("load",function(){s.focus(),s.print(),s.document.close(),s.close(),this.end(),this.enable()}.bind(this),!0),s.document.write(o)};this._context.getContentName({callbacks:{onComplete:C.bind(this),onFailure:C.bind(this)}})}else console.error("error");else console.error("error")}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerPrintCmd",n)}),define("DS/ENOPAD3DViewer/views/PADLayerDefaultView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r){"use strict";function a(e){this.options=e||{},this.elements={},this._tokensXSO=[],this._elementSize=39,this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},cellActivationFeedback:"none",showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",columns:[{dataIndex:"hidden",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto",getCellKPIColor:function(e){if(!e.isHeader&&e.nodeModel&&e.nodeModel.options.color)return e.nodeModel.options.color}}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:r.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:r.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}}},this._mdlEvts=new s,this._buildContent()}return a.prototype.getHeader=function(){return n.defaultLayer.title},a.prototype.getIcon=function(){},a.prototype.render=function(){return this.elements.container},a.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},a.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},a.prototype.selectItemIdx=function(e){var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},a.prototype.addChild=function(e){this.options.model.addChild(e)},a.prototype.removeChild=function(e){this.options.model.removeRoot(e),0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:a.layerName}})},a.prototype.getModelEvents=function(){return this._mdlEvts},a.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility();break;case"remove":t.nodeModel.layerRemoved()}},a.layerName="default",a}),define("DS/ENOPAD3DViewer/commands/PAD3DLineLayoutCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{}),this._context=i.get(this.options.context),this._layout=this._context.getCurrentLayout()||null,this._layout&&this.setState(!0);var t=this;this.onStateChange(function(){t.disable(),t._layout?t.getState()?t._activateCmd():(require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DLineLayoutCmd-off"}),i.trackPageEvent()}),t._context.setCurrentLayout(null),t._layout.deactivate()):require(["DS/ENOPAD3DViewer/views/PAD3DLineLayout"],function(e){t._layout=new e({context:t._context}),t._activateCmd()}),setTimeout(function(){t.enable()},1e3)})},_activateCmd:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DLineLayoutCmd-on"}),i.trackPageEvent()}),this._context.setCurrentLayout(this._layout),this._layout.activate()},destroy:function(){this._layout&&this._layout.destroy()}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DLineLayoutCmd",o)}),define("DS/ENOPAD3DViewer/views/PADRevealGroupView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/CollectionView/ResponsiveLargeTilesCollectionView","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/CoreEvents/ModelEvents","DS/Controls/Loader","DS/PADServices/ws/WSAccess","DS/PADServices/utils/CompassUtils","DS/PADServices/utils/ParserUtils","DS/PADServices/views/private/TilesViewUtils","DS/PADServices/utils/PlatformURL","DS/PADUtils/PADContext"],function(e,t,i,o,n,s,r,a,l,d,h,c){"use strict";function p(e){this.options=e||{},this.elements={},this.options.tilesOptions={selectionBehavior:{canInteractiveMultiselectWithCheckboxClick:!1,canMultiSelect:!1,enableFeedbackForActiveCell:!0,enableShiftSelection:!1,toggle:!1,unselectAllOnEmptyArea:!0},allowUnsafeHTMLContent:!0,useDragAndDrop:!0,displayedOptionalCellProperties:["description","contextualMenu","activeFlag"],onDragStartCell:this._dragStartTile.bind(this)},this._tokensXSO=[],this._mdlEvts=new n,this._buildContent(),this._includedDLTypes=new Map,this._includedDLTypes.set("Document",!0)}return p.prototype.render=function(){return this.elements.container},p.prototype._buildContent=function(){if(this.elements.container=document.createElement("div"),this.elements.container.classList.add("PADRevealGroupView-container"),this._tokensXSO&&this._tokensXSO.length>0){for(var o=0;o<this._tokensXSO.length;o++)this.options.model.getXSO().unsubscribe(this._tokensXSO[o]);this._tokensXSO=[]}var n=UWA.extend({identifier:"Tiles-3DLayerDefault-"+e.v4()},this.options.tilesOptions),r=this.options.tiles=new i(n);this.options.model=new t,r.model=this.options.model,r.onContextualEvent={this:this,callback:this._onCtxEvent},r.getCustomTooltip=d.getTooltip,r.onCellDoubleClick(this._onDoubleClick.bind(this)),r.getContent().addClassName("PADRevealGroupView-tiles"),this.options.tiles.getContent().addClassName("hidden"),this.elements.container.appendChild(this.options.tiles.getContent()),this.options.loader=new s,this.options.loader.getContent().addClassName("poisLoader"),this.elements.container.appendChild(this.options.loader.getContent()),this.options.loader.on(),this.options.poiGroup&&this._retrievePOIsData().then(function(){this.options.loader.getContent().removeClassName("poisLoader"),this.options.loader.off(),this.options.tiles.getContent().removeClassName("hidden")}.bind(this)),this.options.cbClick&&this._tokensXSO.push(this.options.model.getXSO().onPostAdd(function(e){if(!0!==this.options.selectAllPOIsInProgress)for(var t=0;t<e.length;t++)this.options.cbClick(e[t].options,this.options.poiGroup)}.bind(this)))},p.prototype.getTitle=function(e){return e?o.replace(o.revealGroupView.title,{layerLabel:e}):o.revealGroupView.titleWithoutLayerName},p.prototype.getModelEvents=function(){return this._mdlEvts},p.prototype.selectAllPOIs=function(e){var t=!0;this.options.selectAllPOIsInProgress=!0,this.options.model.prepareUpdate(),this.options.model.unselectAll();for(var i=0;i<e.pois.length&&t;i++){var o=this.options.model.search({match:function(t){return t.nodeModel.options.resourceid===e.pois[i].data.id}});1===o.length?o[0].select():t=!1}return this.options.model.pushUpdate(),delete this.options.selectAllPOIsInProgress,t},p.prototype._retrievePOIsData=function(){var e=this;return new Promise(function(t){for(var i=e.options.poiGroup.pois,o=[],n=(new Map,new Map),s=0;s<i.length;s++){var a,h=i[s].data.id.split("_"),c=i[s].data.id.replace(h[0]+"_","");if(n.has(c))(a=n.get(c)).push(i[s].data),n.set(c,a);else(a=[]).push(i[s].data),n.set(c,a),o.push(c)}r.fetch({pids:o,data:{select_predicate:d.getFetchAttribute(),select_file:["icon","thumbnail_2d"]}}).then(function(i){var o="string"==typeof i?JSON.parse(i):i;if(o.results)for(var s=0;s<o.results.length;s++){var r=o.results[s];let t=l.parseAttributes(r.attributes);d.buildNodeOptions(t).then(t=>{var i=n.get(t.resourceid);if(i)for(var o=0;o<i.length;++o)t.label=i[o].label,t.instanceid=i[o].instanceId,t.documentid=t.resourceid,t.resourceid=t.resourceid,t.revealPoiId=i[o].id,t.color=i[o].color,t.type=t.grid["ds6w:type"],e.options.model.addRoot(t)})}t()})})},p.prototype._onDoubleClick=function(e){e.nodeModel&&a.launchApp({context:{model:e.nodeModel,appName:"X3DPLAW_AP"}})},p.prototype._dlDocument=function(e){var t={fetchSecurityContext:function(){return widget.getValue("credentials")},getSelectedNodes:function(){return e.context.options.getSelectedNodes()},getDocumentFromNodeModel:function(){return e.context.model.options},platformUrls:{"3DSpace":h.get3DSpaceURL(),"3DSwym":h.get3DSwymURL(),"3DDashboard":h.getPlatformURL("3DDashboard"),platformId:h.getPlatformId()},events:this._mdlEvts};require(["DS/DocumentManagement/DocumentManagement"],function(i){i.downloadDocument(e.context.model.options.documentid,void 0,!1,{tenant:t.platformUrls.platformId,securityContext:t.fetchSecurityContext(),tenantUrl:t.platformUrls["3DSpace"],onComplete:function(e){},onFailure:function(e){c.get().displayNotification({eventID:"error",msg:o.revealGroupView.downloadFail})},autoDownload:!0})})},p.prototype._infoDocument=function(e){require(["DS/PADUtils/PADSettingsMgt","DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase"],function(t,i){var o=new i,n={fetchSecurityContext:function(){return widget.getValue("credentials")},getSecurityContext:function(){return{SecurityContext:t.getSetting("pad_security_ctx"),tenant:t.getSetting("x3dPlatformId")}},getSelectedNodes:function(){var i=e.context.options.getSelectedNodes(),o=[];return i.forEach(function(e){var i={id:e.options.documentid,tenant:t.getSetting("x3dPlatformId"),source:"3DSpace",getID:function(){return e.options.documentid},getRelationID:function(){return e.options.resourceid}};o.push(i)}.bind(this)),o},getDocumentFromNodeModel:function(){return e.context.model.options},platformUrls:{"3DSpace":h.get3DSpaceURL(),"3DSwym":h.get3DSwymURL(),"3DDashboard":h.getPlatformURL("3DDashboard"),platformId:h.getPlatformId()},events:this._mdlEvts};o.launchProperties(n)}.bind(this))},p.prototype._onCtxEvent=function(e){return new Promise(function(t){var i=[],n=e.cellInfos?e.cellInfos.nodeModel?e.cellInfos.nodeModel:e.cellInfos.cellModel:null;if(n&&(n.select(),!(n.getTreeDocument().getSelectedNodes().length>1))){var s,r=h.getPlatformId(),a={platformUrls:{"3DSpace":h.get3DSpaceURL(),"3DSwym":h.get3DSwymURL(),"3DDashboard":h.getPlatformURL("3DDashboard"),platformId:r},document:{id:n.options.documentid,envId:r,contextId:widget.getValue("credentials"),data:n.options}};require(["DS/DocumentCommands/ENOXDocumentCommands"],function(e){var r=new e;r.init(a),s=r.render(),i.push({title:s.Preview.title,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+s.Preview.fonticon,family:WUXManagedFontIcons.Font3DS},type:"PushItem",action:{this:this,context:{model:n,appName:"X3DPLAW_AP"},callback:s.Preview.handler}});for(var l=!1,d=0;d<r.supportedTypes.length;d++)n.options.grid["ds6w:type-original"]===r.supportedTypes[d]&&(l=!0);!0===l&&i.push({title:s.Download.title,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+s.Download.fonticon,family:WUXManagedFontIcons.Font3DS},type:"PushItem",action:{this:this,context:{model:n,options:n.getTreeDocument()},callback:s.Download.handler}}),i.push({title:o.revealGroupView.CtxInfo,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-info-open-in-a-new-window",family:WUXManagedFontIcons.Font3DS},type:"PushItem",action:{this:this,context:{model:n,options:n.getTreeDocument()},callback:this._infoDocument}}),t(i)}.bind(this))}}.bind(this))},p.prototype._dragStartTile=function(e,t){for(var i=t.nodeModel.getTreeDocument().getXSO().get().slice(0),o=[],n=0;n<i.length;n++)o.push(i[n]);var s=a.buildDnDData(o);return e.dataTransfer.setData("Text",JSON.stringify(s)),e.stopPropagation(),!1},p}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerCenterTreeCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._context=i.get(this.options.context)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerCenterTreeCmd"}),i.trackPageEvent()});var e=this;require(["DS/Selection/CSOManager"],function(t){var i=e._context.getCommandProxy();if(i){var o=t.get(),n=[];o.length&&(o.forEach(function(t){var i=t.pathElement,o=e._context.streamPath(i);n.push(o)}),i.focus({paths:n,intent:"centerTree"}))}e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerCenterTreeCmd",o)}),define("DS/ENOPAD3DViewer/views/PAD3DLayerView",["DS/CoreEvents/ModelEvents","DS/PADUtils/PADSettingsMgt"],function(e,t){"use strict";function i(t){this._container=null,this._hideShowBtnDiv=null,this._labelDiv=null,this._deleteBtnDiv=null,this._controller=null,this._modelEvents=new e,this._buildSkeleton(t),this._bindEvents()}return i.prototype.hide=function(){this.publish({event:"hide"})},i.prototype.show=function(){this.publish({event:"show"})},i.prototype.render=function(){return this._container},i.prototype.destroy=function(){delete this._container,delete this._hideShowBtnDiv,delete this._labelDiv,delete this._deleteBtnDiv,delete this._controller,delete this._modelEvents},i.prototype.getModelEvents=function(e){return this._modelEvents},i.prototype.publish=function(e){this.getModelEvents().publish(e)},i.prototype.subscribe=function(e,t){return this.getModelEvents().subscribe(e,t)},i.prototype.unsubscribe=function(e){this.getModelEvents().unsubscribe(e)},i.prototype._buildSkeleton=function(e){this._container=document.createElement("div"),this._container.classList.add("PAD3DLayer-container"),this._hideShowBtnDiv=document.createElement("div"),this._hideShowBtnDiv.classList.add("PAD3DLayer-button"),this._hideShowBtnDiv.classList.add("fonticon"),this._labelDiv=document.createElement("div"),this._labelDiv.classList.add("PAD3DLayer-label"),this._labelDiv.innerHTML=e.label,this._deleteBtnDiv=document.createElement("div"),this._deleteBtnDiv.classList.add("PAD3DLayer-button"),this._deleteBtnDiv.classList.add("fonticon"),this._deleteBtnDiv.classList.add("fonticon-wrong"),null!==this._hideShowBtnDiv&&this._container.appendChild(this._hideShowBtnDiv),this._container.appendChild(this._labelDiv),this._container.appendChild(this._deleteBtnDiv)},i.prototype._bindEvents=function(){null!==this._hideShowBtnDiv&&(this._hideShowBtnDiv.onclick=function(){this._hideShowBtnDiv.classList.contains("fonticon-eye")?this.hide():this.show()}.bind(this)),this._deleteBtnDiv.onclick=function(){this.publish({event:"delete"})}.bind(this)},i}),define("DS/ENOPAD3DViewer/views/PADDefaultGroupView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","DS/PADServices/utils/PADTrackerManager","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/CoreEvents/ModelEvents"],function(e,t,i,o,n,s,r){"use strict";function a(e){this.options=e||{},this.elements={},this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"multiple",cellSelection:"none",selectionBehavior:{canInteractiveMultiselectWithCheckboxClick:!0,canMultiSelect:!0,enableFeedbackForActiveCell:!0,enableShiftSelection:!0,toggle:!1,unselectAllOnEmptyArea:!0},showNodeKPIColorFlag:!0,columns:[{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto",getCellKPIColor:function(e){if(!e.isHeader&&e.nodeModel&&e.nodeModel.options.color)return e.nodeModel.options.color}}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this._mdlEvts=new r,this._buildContent()}return a.prototype.render=function(){return this.elements.container},a.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PADDefaultGroupView-container");var s=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);s.layout=new o(this.options.dgvLayoutOptions);var r=this.options.dgv=new i(s);(this.options.model=new t,r.treeDocument=this.options.model,r.getContent().addClassName("PADDefaultGroupView-dgv"),this.elements.container.appendChild(this.options.dgv.getContent()),this.options.poiGroup)&&this.options.poiGroup.pois.forEach(function(e){var t={label:e.data.label?e.data.label:"ID:["+e.data.id+"]",resourceid:e.data.id,instanceid:e.data.instanceId,color:e.data.color,grid:{},children:null};this.options.model.addRoot(t)}.bind(this));this.options.cbClick&&this.options.model.getXSO().onPostAdd(function(e){if(!0!==this.options.selectAllPOIsInProgress){var t=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LeftPanel_clickPOIElement_stats"});!0===this.options.poiGroup.name.includes("PAD3DPOIProximityGroup")?t.persDim.pd2="belongs to POI Proximity Group":this.options.poiGroup&&(1===this.options.poiGroup.pois.length?t.persDim.pd2="is a Single POI":t.persDim.pd2="belongs to POI Group"),t.trackPageEvent();for(var i=0;i<e.length;i++)this.options.cbClick(e[i].options,this.options.poiGroup)}}.bind(this))},a.prototype.getTitle=function(e){return e?s.replace(s.defaultGroupView.title,{layerLabel:e}):s.defaultGroupView.titleWithoutLayerName},a.prototype.getModelEvents=function(){return this._mdlEvts},a}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerTransparencyController",["UWA/Class","DS/CoreEvents/ModelEvents","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/Visualization/IdPath","DS/PADUtils/PADSettingsMgt"],function(e,t,i,o,n){"use strict";function s(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}function r(e,t){for(let i=0;i<e.length;i++){let o=!1;for(let n=0;n<t.length;n++)s(t[n],e[i])&&(o=!0);if(!o)return!1}return!0}return e.extend({name:"_PAD3DViewerTransparencyController",initTransparencyController:function(){this._viewer=this._context.getViewer(),n.getSetting("enopad3dviewer_lightNodeModel")&&(this.subscribe({event:"onRootRemoved"},function(e){this.removeTransparencyOfRoot(e.id)}.bind(this)),this._layerController.declareLayerKinds([{kind:"transparency",AMD:"DS/ENOPAD3DViewer/views/PADLayerTransparencyView"}]))},destroyTransparencyLayer:function(){this.get3DLayerController().deleteLayer(this._layer),delete this._layer},createTransparencyLayer:function(){this._layer=this.get3DLayerController().createLayer({layerId:"ENO_transparency_layer",kind:"transparency",type:"transparency",label:i.transparencyLayer.layerLabel,viewer:this._viewer,visibility:!0,position:0}),this._layer.transparencyOverridesMap=new Map},getTransparencyLayer:function(){return this.get3DLayerController().getLayer("ENO_transparency_layer")},applyTransparencyOnPaths:function(e,t){let i=this._layer.getIdPathOverrideSet();for(let n=0;n<e.length;n++){let s,a=this._context.streamPath(e[n]),l=a[0],d=new o([this._context.getController().getRootBagId()].concat(a));if((s=i.getUniqueOverrideFromIdPath(d))||(s=i.createIdPathOverride(d)),s.setOpacity(t,!1),this._layer.transparencyOverridesMap.has(l)){let e=this._layer.transparencyOverridesMap.get(l);r([d.ids],e)||(e.push(d.ids),this._layer.transparencyOverridesMap.set(l,e))}else this._layer.transparencyOverridesMap.set(l,[d.ids])}this._layer.setVisibility(!0),this._context.publish({event:"onTransparencyApplied"})},removeTransparencyOnPaths:function(e){if(this._layer){let t=[],i=this._layer.getIdPathOverrideSet();for(let n=0;n<e.length;n++){let s=this._context.streamPath(e[n]),r=s[0],a=new o([this._context.getController().getRootBagId()].concat(s));if(t.push(i.getUniqueOverrideFromIdPath(a)),this._layer.transparencyOverridesMap.has(r)){let e=this._layer.transparencyOverridesMap.get(r),t=e.indexOf(a.ids);e.splice(t,1),this._layer.transparencyOverridesMap.set(r,e)}}i.deleteOverrides(t),0===i.getOverrides().length&&this.destroyTransparencyLayer(),this._context.publish({event:"onTransparencyRemoved"})}},removeTransparencyOfRoot:function(e){if(this._layer){let t=this._layer.getIdPathOverrideSet(),i=this._layer.transparencyOverridesMap.get(e),n=[];if(i&&i.length>0){for(let e=0;e<i.length;e++){let s=new o(i[e]);n.push(t.getUniqueOverrideFromIdPath(s))}t.deleteOverrides(n),this._layer.transparencyOverridesMap.delete(e)}0===t.getOverrides().length&&this.destroyTransparencyLayer(),this._context.publish({event:"onTransparencyRemoved"})}},getCommonTransparency:function(e){var t=this;let i,o=!0,n=this._layer.getIdPathOverrideSet();e=e.map(function(e){return t._context.streamPath(e)});let a=n.getOverrides().filter(function(t){for(let i=0;i<e.length;i++)if(s(e[i],t.getIdPathes()[0].ids.slice(1)))return t}),l=a.map(function(e){return e.getIdPathes()[0].ids.slice(1)});if(r(e,l)){let e=a[0].getOpacity();for(let t=1;t<a.length;t++){e!==a[t].getOpacity()&&(o=!1)}o&&(i=e)}return i}})}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerLayerServices",["UWA/Core","DS/ApplicationFrame/CommandsManager"],function(e,t){"use strict";return{streamLayers:function(e){var t=[];return e.getLayers().forEach(function(e){var i={id:e.getID(),reloadable:e.options.reloadable,visible:e.isLayerVisible()};switch(e.options.kind){case"poi":i.kind="ENO3DViewer_POI",i.clustered=e.isClustered(),i.color=e.getColor();break;case"graphic properties":i.kind="ENO3DViewer_GP",i.color=e.getColor();break;case"reveal":i.kind="ENO3DViewer_Reveal",i.color=e.getColor();break;case"colorize":i.kind="ENO3DViewer_Colorize";break;case"grouping":i.kind="ENO3DViewer_Grouping";break;case"search":i.kind="ENO3DViewer_Search",i.color=e.getColor(),i.keyword=e.getLabel();break;case"zoi":i.kind="ENO3DViewer_ZOI"}t.push(i)}.bind(this)),t},setLayersProperties:function(e,t){for(var i,o=e.layers,n=0;n<o.length;n++)if(i=t.getLayer(o[n].id))switch(i.options.kind){case"poi":!0!==o[n].clustered&&!1!==o[n].clustered||i.setClustering(o[n].clustered),o[n].color&&("string"==typeof o[n].color||o[n].color instanceof String)&&o[n].color.contains("#")&&7===o[n].color.length&&i.updateColor(o[n].color),!0!==o[n].visible&&!1!==o[n].visible||i.setVisibility(o[n].visible);break;case"graphic properties":!0!==o[n].visible&&!1!==o[n].visible||i.setVisibility(o[n].visible),o[n].color&&("string"==typeof o[n].color||o[n].color instanceof String)&&o[n].color.contains("#")&&7===o[n].color.length&&i.updateColor(o[n].color);break;case"reveal":case"colorize":break;case"search":o[n].color&&("string"==typeof o[n].color||o[n].color instanceof String)&&o[n].color.contains("#")&&7===o[n].color.length&&i.updateSearchLayerColor(o[n].color),!0!==o[n].visible&&!1!==o[n].visible||i.setVisibility(o[n].visible);break;case"grouping":break;case"zoi":!0!==o[n].visible&&!1!==o[n].visible||i.setVisibility(o[n].visible)}}}}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession",[],function(){"use strict";var e,t,i=!1,o=!1,n=!1;function s(e){var i=t.getValue("PAD3DViewerRootsDetached");(i=i?JSON.parse(i):void 0)||(t.addPreference({name:"PAD3DViewerRootsDetached",type:"hidden"}),i=[]);var o=i.filter(function(t){return e.id!==t});o.length!==i.length&&t.setValue("PAD3DViewerRootsDetached",JSON.stringify(o))}function r(e){var i=t.getValue("PAD3DViewerRootsDetached");(i=i?JSON.parse(i):void 0)||(t.addPreference({name:"PAD3DViewerRootsDetached",type:"hidden"}),i=[]),i.some(function(t){return t===e.id})||(i.push(e.id),t.setValue("PAD3DViewerRootsDetached",JSON.stringify(i)))}function a(e){var i=t.getValue("PAD3DViewerPathsInSession");(i=i?JSON.parse(i):void 0)||t.addPreference({name:"PAD3DViewerPathsInSession",type:"hidden"}),t.setValue("PAD3DViewerPathsInSession",JSON.stringify(e.rootLog)),!0===e.hidden&&r(e)}return{init:function(l){if(!i){if("object"!=typeof l)throw new Error("No parameter defined");if(!l.pad3DViewer)throw new Error("No pad3DViewer defined");if(!l.widget)throw new Error("No widget defined");i=!0,e=l.pad3DViewer,(t=l.widget).addEventOnce("onDestroy",function(){i=o=n=!1,e=t=void 0});var d=e.subscribe({event:"onReady"},function(){n=!0,e.unsubscribe(d),d=null});e.subscribe({event:"onRootAdded"},a),e.subscribe({event:"onRootRemoved"},function(e){a(e),s(e)}),e.subscribe({event:"onRootAttached"},s),e.subscribe({event:"onRootDetached"},r)}},restoreSession:function(){var s={objectsLoading:!1};if(!(i&&e&&t&&n))throw new Error("init method must be called first");if(o)return s;o=!0;var r=t.getValue("PAD3DViewerPathsInSession");r=r?JSON.parse(r):void 0;var a=t.getValue("X3DContentId");if(t.deleteValue("X3DContentId"),r&&r.length>0){var l=t.getValue("PAD3DViewerRootsDetached");l=l?JSON.parse(l):[];var d=[];r.forEach(function(e){if(e&&e.length){var t=e[0];d.push({path:e,hidden:l.some(function(e){return t===e})})}}),e.addRoots({objects:d},!1),s.objectsLoading=!0}else a&&(e.addRootNodesFromContent({json3DXContent:JSON.parse(a),dispatch:!1}),s.objectsLoading=!0);return s}}}),define("DS/ENOPAD3DViewer/views/PADLayerPOIView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils","DS/Controls/ProgressBar"],function(e,t,i,o,n,s,r,a,l){"use strict";function d(e){this.options=e||{},this._removedClus=!1,this._elementSize=39,this._clusteringIsEditable=!0,this.elements={},this._tokensXSO=[],this._nbChildren=0,this._orderingWithClustering="|hidden|clustered|colorSquare|tree|",this._orderingWithoutClustering="|hidden|colorSquare|tree|",this._hiddenColumn={dataIndex:"hidden",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,height:"38px",width:"38px",alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},this._clusteredColumn={dataIndex:"clustered",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,typeRepresentation:"string",height:38,width:38,alignment:"center",disabled:!1,editable:!0,getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.clustered?"clusteringOn":"clusteringOff"},getCellSemantics:function(e){return e.nodeModel&&(!0!==e.nodeModel.options.clusteringEditable&&!1!==e.nodeModel.options.clusteringEditable||(this._clusteringIsEditable=e.nodeModel.options.clusteringEditable)),{disabled:!this._clusteringIsEditable,editableFlag:this._clusteringIsEditable}}.bind(this),getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.clustered?{shortHelp:n.clustering.disable,updateModel:!1}:{shortHelp:n.clustering.activate,updateModel:!1}}},this._POIGroupColorCustoColumn={dataIndex:"colorSquare",typeRepresentation:"color",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:5,alignment:"center",editionPolicy:"EditionOnOver",getCellTooltip:function(e){return{shortHelp:n.changePOIGroupColor,updateModel:!1}}},this._stringColumn={dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto",minWidth:78},this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",cellActivationFeedback:"row",columns:[this._hiddenColumn,this._clusteredColumn,this._POIGroupColorCustoColumn,this._stringColumn]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}},clusteringOn:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Clustered.png")}}},clusteringOff:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Unclustered.png")}}}},this._mdlEvts=new r,this._customHeader=new l({shape:"circular",height:24,infiniteFlag:!0}),this._buildContent()}return d.prototype.getHeader=function(){return n.POILayer.title},d.prototype.getCustomHeader=function(){return this._customHeader},d.prototype.getIcon=function(){return s.getSetting("newLayerView")?{iconPath:a.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_POI.png")}:void 0},d.prototype.render=function(){return this.elements.container},d.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this)),s.addEventListener("liveChange",this._colorChange.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},d.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},d.prototype.selectItemIdx=function(e){this.options.dgv.setActiveCell(0);var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},d.prototype.addChild=function(e){var t="|";if(this.options.dgvOptions&&this.options.dgvOptions.columns){for(var i=0;i<this.options.dgvOptions.columns.length;i++)t+=this.options.dgvOptions.columns[i].dataIndex+"|";t===this._orderingWithClustering?(this.options.dgvOptions.columns[2].editableFlag=e.options.layerColorEditable,!1===e.options.enableClustering&&(this.options.dgvOptions.columns.splice(1,1),this._buildContent())):t===this._orderingWithoutClustering&&(this.options.dgvOptions.columns[1].editableFlag=e.options.layerColorEditable,!0===e.options.enableClustering&&(this.options.dgvOptions.columns.splice(1,0,this._clusteredColumn),this._buildContent()))}this.options.model.addChild(e),this._nbChildren++},d.prototype.removeChild=function(e){this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&(this._removedClus=!1,this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:d.layerName}}))},d.prototype.getModelEvents=function(){return this._mdlEvts},d.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility();break;case"clustered":this._clusteringIsEditable&&t.nodeModel.toggleClustering()}},d.prototype._colorChange=function(e,t){t&&t.nodeModel&&t.nodeModel.options.grid&&"colorSquare"===this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)&&t.nodeModel.updateColor(e.srcElement.dsModel.value)},d.layerName="poi",d}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerScreenshotCmd",["DS/ApplicationFrame/Command","DS/ViewerCommandsExt/ViewerScreenshotUtils","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n){"use strict";var s=e.extend({appPrefix:"3D Navigate",init:function(e){this._parent(e,{isAsynchronous:!0}),e.arguments.length?e.arguments.forEach(e=>{"appPrefix"===e.ID&&(this.appPrefix=e.Value)}):"undefined"!=typeof widget&&void 0!==widget.getValue("appTitle")&&(this.appPrefix=widget.getValue("appTitle")),this._context=i.get(this.options.context),o.isMobileDevice()?this.disable():this.enable()},execute:function(){require(["DS/PADServices/utils/PADTrackerManager"],function(e){var t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"PAD3DViewerScreenshotCmd"}),t.trackPageEvent()}),this._context.getContentName({callbacks:{onComplete:e=>{t.saveScreenshot({viewer:this._context.getFrameWindow().getViewer(),filenamePrefix:this.appPrefix+"-"+e.contentName}),this.end()},onFailure:e=>{t.saveScreenshot({viewer:this._context.getFrameWindow().getViewer(),filenamePrefix:this.appPrefix}),console.warn(n.offlineScreenshot),this.end()}}})}});return UWA.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerScreenshotCmd",s)}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerPointCloudStylingController",["UWA/Class","DS/PADServices/utils/GlobalModelEvents","DS/CoreEvents/ModelEvents","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/views/PADAlert","DS/Visualization/ThreeJS_DS","DS/PADServices/utils/PADTrackerManager"],function(e,t,i,o,n,s,r){"use strict";function a(e,t){for(var i="",o=0;o<3;o++){var n=e.substring(2*o,2+2*o),s=t.substring(2*o,2+2*o),r=parseInt(n,16),a=parseInt(s,16);i+=("0"+Math.floor(r+.5*(a-r)).toString(16).toUpperCase()).slice(-2)}return i}function l(e){let t=(new s.Vector3).getPositionFromMatrix(e.getTileWorldMatrices(e._getRoot().uri)[0]),i=e._getRoot().getBoundingBox(),o=t.add(i.min),n=(t=(new s.Vector3).getPositionFromMatrix(e.getTileWorldMatrices(e._getRoot().uri)[0])).add(i.max);return new s.Box3(o,n)}function d(e){function t(t,i){let o=e.map(e=>e[i][t]);switch(i){case"min":return Math.min.apply(null,o);case"max":return Math.max.apply(null,o)}}let i=t("x","min"),o=t("y","min"),n=t("z","min"),r=t("x","max"),a=t("y","max"),l=t("z","max");return new s.Box3(new s.Vector3(i,o,n),new s.Vector3(r,a,l))}const h={showFilter:{inList:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],attribute:"Classification"},renderFilter:{inList:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],attribute:"Classification"},render:{type:"range",attribute:"Classification",values:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],colors:["#b6b6b6","#aaaaaa","#aa5500","#00aaaa","#55ff55","#00aa00","#ff5555","#aa0000","#555555","#55ffff","#aa00aa","#000000","#555555","#ffff55","#ffff55","#ff55ff","#ffff55","#5555ff","#646464"]},priority:1};return e.extend({initPointCloudStyling:function(){this._mdlEvts=new i,this._stylingSubTokens=[],this._tileSets=new Map,this._stylings=new Map,this._currentAxis="z",this._elevationViewBuilt=!1,this._context.disableCmd("ENO3DPointCloudClassificationCmd"),this._context.disableCmd("ENO3DPointCloudElevationCmd"),this.subscribe({event:"onEndRootRemoved"},function(e){let i=!1;for(let t=0;t<e.ids.length;t++)this._stylings.delete(e.ids[t]),this._tileSets.delete(e.ids[t]);for(let[e,t]of this._tileSets){t.getAvailableAttributes().map(e=>e.name).includes("Classification")&&(i=!0)}if(i?this._context.enableCmd("ENO3DPointCloudClassificationCmd"):this._context.disableCmd("ENO3DPointCloudClassificationCmd"),0===this._tileSets.size){this._classificationLayer&&(this._layerController.deleteLayer(this._classificationLayer),delete this._classificationLayer),this._elevationLayer&&(this._layerController.deleteLayer(this._elevationLayer),delete this._elevationLayer);for(let e=0;e<this._stylingSubTokens.length;e++)t.unsubscribe(this._stylingSubTokens[e]);this._stylingSubTokens.length=0,this._context.disableCmd("ENO3DPointCloudElevationCmd")}else this._stylings.size>0&&(Array.from(this._stylings.values())[0].rules.hasOwnProperty("elevation")&&this._updateElevationStylingAndLayer(),this._applyStyling())}.bind(this)),this.subscribe({event:"onR2VLoaded"},function(e){let t=e.rootPhID,i=this.getRoots(),s=0,r=!0;for(let e=0;e<i.length;e++){let o=i[e],n=this._model.getOOCManager().getTileSet(o.modelIdentification);if(n){s++,n.getAvailableAttributes().map(e=>e.name).includes("Classification")&&(r=!1,n.setAvailableAttribute({name:"Classification",type:"integer"})),o.modelIdentification===t&&this._tileSets.set(t,n)}}if(this._context.enableCmd("ENO3DPointCloudElevationCmd"),s>0&&(r?(this._context.disableCmd("ENO3DPointCloudClassificationCmd"),n.displayNotification({eventID:"info",title:o.classificationDisabledNoAttribute.title,subtitle:o.classificationDisabledNoAttribute.subtitle,msg:o.classificationDisabledNoAttribute.message})):this._context.enableCmd("ENO3DPointCloudClassificationCmd")),0!==this._stylings.size){let t=Array.from(this._stylings.values())[0];this._stylings.set(e.rootPhID,JSON.parse(JSON.stringify(t))),t.rules.hasOwnProperty("elevation")&&this._updateElevationStylingAndLayer(),this._applyStyling()}}.bind(this))},launchPointCloudStyling:function(e){let i=this.getRoots(),s=!1,r=0;for(let e=0;e<i.length;e++){let t=i[e];if(t.isOOCTileSetNode()){r++;let e=this._model.getOOCManager().getTileSet(t.modelIdentification);e.getAvailableAttributes().map(e=>e.name).includes("Classification")&&(e.setAvailableAttribute({name:"Classification",type:"integer"}),s=!0),this._stylings.has(t.modelIdentification)||this._stylings.set(t.modelIdentification,{rules:{},applyRules:[]}),this._tileSets.set(t.modelIdentification,e)}}if(0===r)this._addStylingProbeHit("command-3d-execution-error","noRealDataForStylingCmd"),n.displayNotification({eventID:"warning",title:o.noRealDataForR2VCommand.title,subtitle:o.noRealDataForR2VCommand.subtitle,msg:o.noRealDataForR2VCommand.message});else{let i=this;function a(){i._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/SelectLayer"},i._onSelectLayer.bind(i))),i._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/HideClasses"},i._hideClasses.bind(i))),i._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/ShowClasses"},i._showClasses.bind(i))),i._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/ChangeClassColor"},i._changeClassColor.bind(i))),i._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/ChangeElevationParameters"},i._changeElevationParameters.bind(i))),i._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/RemoveStyling"},i._removePointCloudStyling.bind(i)))}if(0!==i._stylings.length){let e=!0;for(let[t,i]of this._stylings)0!==Object.keys(i.rules).length&&(e=!1);e&&a()}else a();switch(e){case"classification":s&&this._createPointCloudClassification();break;case"elevation":this._createPointCloudElevation()}}},_createPointCloudClassification:function(){this._applyClassificationRule();for(let[e,t]of this._stylings)t.rules.classification=JSON.parse(JSON.stringify(h));this.get3DLayerController().declareLayerKinds([{kind:"pointCloudClassification",AMD:"DS/ENO3DView/views/PADLayerPointCloudClassificationView"}]).then(function(){this._classificationLayer=this._layerController.createLayer({layerId:"pointCloudClassificationLayer",kind:"pointCloudClassification",type:"pointCloudClassification",visibility:"true",viewer:this._viewer,position:0}),this._applyStyling()}.bind(this))},_applyClassificationRule:function(){this._activeStylingLayer="classification";for(let[e,t]of this._stylings){let e=t.applyRules.indexOf("elevation");-1!==e&&t.applyRules.splice(e,1),-1===t.applyRules.indexOf("classification")&&t.applyRules.push("classification")}},_createPointCloudElevation:function(){this._applyElevationRule();let e=[];for(let[t,i]of this._tileSets)e.push(l(i));let i=d(e);this._computeGlobalBoundingBoxes(i,e),this._stylingSubTokens.push(t.subscribe({event:"ENXDISC_AP/PointCloudStyling/GetBoundingBox"},function(e){e.get&&t.publish({event:"ENXDISC_AP/PointCloudStyling/GetBoundingBox",data:{min:i.min,max:i.max}})}.bind(this))),this._elevationViewBuilt&&t.publish({event:"ENXDISC_AP/PointCloudStyling/GetBoundingBox",data:{min:i.min,max:i.max}}),this._createElevationStylings(),this.get3DLayerController().declareLayerKinds([{kind:"pointCloudElevation",AMD:"DS/ENO3DView/views/PADLayerPointCloudElevationView"}]).then(function(){this._elevationLayer=this._layerController.createLayer({layerId:"pointCloudElevationLayer",kind:"pointCloudElevation",type:"pointCloudElevation",visibility:"true",viewer:this._viewer,position:0}),this._elevationViewBuilt=!0,this._applyStyling()}.bind(this))},_applyElevationRule:function(){this._activeStylingLayer="elevation";for(let[e,t]of this._stylings){let e=t.applyRules.indexOf("classification");-1!==e&&t.applyRules.splice(e,1),-1===t.applyRules.indexOf("elevation")&&t.applyRules.push("elevation")}},_updateElevationStylingAndLayer:function(){let e=[];for(let[t,i]of this._tileSets)e.push(l(i));let i=d(e);this._computeGlobalBoundingBoxes(i,e),this._updateElevationStylingsValues(),t.publish({event:"ENXDISC_AP/PointCloudStyling/GetBoundingBox",data:{min:i.min,max:i.max}})},_computeGlobalBoundingBoxes:function(e,t){let i=Array.from(this._tileSets.values()).map(e=>e._getRoot().getBoundingBox()),o=0;this._globalBoundingBoxes=new Map;for(let[n,r]of this._tileSets){let r=t[o],a=new s.Vector3(e.min.x-r.min.x,e.min.y-r.min.y,e.min.z-r.min.z),l=new s.Vector3(e.max.x-r.max.x,e.max.y-r.max.y,e.max.z-r.max.z),d=(new s.Vector3).copy(i[o].min).add(a),h=(new s.Vector3).copy(i[o].max).add(l);this._globalBoundingBoxes.set(n,new s.Box3(d,h)),o++}},_createElevationStylings:function(){for(let[e,t]of this._stylings){let i=this._globalBoundingBoxes.get(e);t.rules.elevation={render:{type:"ramp",attribute:"Predefined3DSTiles_"+this._currentAxis,values:[i.min[this._currentAxis],(i.min[this._currentAxis]+i.max[this._currentAxis])/2,i.max[this._currentAxis]],colors:["#00f1ff","#"+a("00f1ff","ff0000"),"#ff0000"]},priority:1}}},_updateElevationStylingsValues:function(){for(let[e,t]of this._stylings){let i=this._globalBoundingBoxes.get(e);t.rules.elevation.render.values=[i.min[this._currentAxis],(i.min[this._currentAxis]+i.max[this._currentAxis])/2,i.max[this._currentAxis]]}},_onSelectLayer:function(e){switch(e.kind){case"elevation":"elevation"!==this._activeStylingLayer&&(this._applyElevationRule(),this._applyStyling()),e.fromLayerPanel||this._addStylingProbeHit("ENO3DPointCloudClassification-usage","selectLayer");break;case"classification":"classification"!==this._activeStylingLayer&&(this._applyClassificationRule(),this._applyStyling()),e.fromLayerPanel||this._addStylingProbeHit("ENO3DPointCloudElevation-usage","selectLayer")}},_hideClasses:function(e){for(let[t,i]of this._stylings){let t=i.rules.classification.showFilter.inList;if(e.all)t.length=0,this._addStylingProbeHit("ENO3DPointCloudClassification-usage","hideAllClasses");else{for(let i=0;i<e.removedClasses.length;i++){let o=e.removedClasses[i];-1!==t.indexOf(o)&&t.splice(t.indexOf(o),1)}this._addStylingProbeHit("ENO3DPointCloudClassification-usage","hideClasses")}}this._applyStyling()},_showClasses:function(e){for(let[t,i]of this._stylings){let t=i.rules.classification.showFilter.inList;if(e.all)t.length=0,i.rules.classification.showFilter.inList=t.concat([...h.render.values]),this._addStylingProbeHit("ENO3DPointCloudClassification-usage","showAllClasses");else{for(let i=0;i<e.addedClasses.length;i++){let o=e.addedClasses[i];-1===t.indexOf(o)&&t.push(o)}this._addStylingProbeHit("ENO3DPointCloudClassification-usage","showClasses")}}this._applyStyling()},_changeClassColor:function(e){for(let[t,i]of this._stylings){let t=i.rules.classification.render.colors,o=parseInt(e.updatedClass);t[i.rules.classification.render.values.indexOf(o)]="#"+e.color}this._applyStyling(),this._addStylingProbeHit("ENO3DPointCloudClassification-usage","changeClassColor")},_changeElevationParameters:function(e){for(let[t,i]of this._stylings){let o=i.rules.elevation.render.colors,n=i.rules.elevation.render.values,s=this._globalBoundingBoxes.get(t);if(e.boundaries){let t=s.min[this._currentAxis],i=s.max[this._currentAxis]-t;n[0]=t+i*e.boundaries[0],n[1]=t+i*e.boundaries[1],n[2]=t+i*e.boundaries[2],this._addStylingProbeHit("ENO3DPointCloudElevation-usage","changeBoundaries")}if(e.colors&&(e.colors.min&&(o[0]="#"+e.colors.min,this._addStylingProbeHit("ENO3DPointCloudElevation-usage","changeMinColor")),e.colors.middle&&(o[1]="#"+e.colors.middle),e.colors.max&&(o[2]="#"+e.colors.max,this._addStylingProbeHit("ENO3DPointCloudElevation-usage","changeMaxColor"))),e.axis){this._currentAxis=e.axis;let t=s.min[this._currentAxis],o=s.max[this._currentAxis];i.rules.elevation.render.attribute="Predefined3DSTiles_"+this._currentAxis,n[0]=t,n[1]=(t+o)/2,n[2]=o,this._addStylingProbeHit("ENO3DPointCloudElevation-usage","changeAxis")}}this._applyStyling()},_applyStyling:function(){for(let[e,t]of this._tileSets)t.setStyling({json:this._stylings.get(e)})},_removePointCloudStyling:function(e){for(let[i,o]of this._stylings){let i=e.kind;if(o.applyRules.splice(o.applyRules.indexOf(i),1),delete o.rules[i],"elevation"===e.kind&&void 0!==o.rules.classification)this._applyClassificationRule();else if("classification"===e.kind&&void 0!==o.rules.elevation)this._applyElevationRule();else if(0===Object.keys(o.rules).length){for(let e=0;e<this._stylingSubTokens.length;e++)t.unsubscribe(this._stylingSubTokens[e]);this._stylingSubTokens.length=0}}this._applyStyling(),"classification"===e.kind?this._addStylingProbeHit("ENO3DPointCloudElevation-usage","removeLayer"):"elevation"===e.kind&&this._addStylingProbeHit("ENO3DPointCloudClassification-usage","removeLayer")},_addStylingProbeHit:function(e,t){var i=r.getPADTracker({eventCategory:"usage",eventAction:e,appId:widget.getValue("appId")});i.setEventData({eventLabel:t,eventValue:t}),i.trackPageEvent()}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerMoveRootController",["UWA/Class","DS/Visualization/ThreeJS_DS","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/CoreEvents/Events","DS/ENOXInterWdgCom/LinkManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/Visualization/IdPath"],function(e,t,i,o,n,s,r,a){"use strict";return e.extend({name:"_PAD3DViewerMoveRootController",_moveRootOverrideSet:null,initMoveRootController:function(){},_onMoveRoot:function(e){if(this._moveRootOverrideSet||(this._moveRootOverrideSet=new s(this.getRootBag(),this.getRootBagId(),!0)),e.rootId){let i=this.getRoots().filter(t=>t.modelIdentification===e.rootId)[0];if(i){let o=new a([this.getRootBagId()].concat([e.rootId])),n=this._moveRootOverrideSet.getUniqueOverrideFromIdPath(o);if(e.reset&&n)this._moveRootOverrideSet.deleteOverride(n),this._viewer.render({updateInfinitePlane:!0}),this._context.reframe();else if(e.matrix){if(n)n.setPosition((new t.Matrix4).setFromArray(e.matrix));else{this._moveRootOverrideSet.createIdPathOverride(o).setPosition((new t.Matrix4).setFromArray(e.matrix))}this._viewer.render({updateInfinitePlane:!0}),this._context.reframe()}this._viewer.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(this._moveRootOverrideSet),i.isOOCTileSetNode()&&this._model.getOOCManager().getTileSet(e.rootId).refreshWorldMatrix()}}}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveAllCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this._context=i.get(e.context),this._CBTokens=[];var t=this;this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},function(){t.enable()})),this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},function(){0!==t._context.getRoots().length||t._context._controller.getHiddenRootIds().length||t.disable()})),0!==this._context.getRoots().length||t._context._controller.getHiddenRootIds().length?this.enable():this.disable()},destroy:function(){if(this._context)for(var e=0;e<this._CBTokens.length;e++)this._context.unsubscribe(this._CBTokens[e]);this._CBTokens=null,this._context=null},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerRemoveAllCmd"}),i.trackPageEvent()});var e=this;require(["DS/Selection/CSOManager","DS/Selection/HSOManager"],function(t,i){e._context&&"ENOPAD3DViewer"===e._context.name&&e._context.empty(),t.empty(),i.empty(),e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveAllCmd",o)}),define("DS/ENOPAD3DViewer/commands/PAD3DToggleStatusBarCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(e,t,i){"use strict";var o=t.extend({init:function(e){this._parent(e,{}),this._context=i.get(this.options.context),this.onStateChange(this._toggleStatusBar.bind(this)),this._initStatusBarState()},destroy:function(){},_toggleStatusBar:function(){this.getState()?(this._context._displayStatusBar(!0),window.localStorage.setItem("PAD3DViewerStatusBarExpandState",!0)):(this._context._displayStatusBar(!1),window.localStorage.setItem("PAD3DViewerStatusBarExpandState",!1))},_initStatusBarState:function(){"false"===window.localStorage.getItem("PAD3DViewerStatusBarExpandState")?this.setState(!1):this.setState(!0)}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DToggleStatusBarCmd",o)}),define("DS/ENOPAD3DViewer/utils/PAD3DPOIDrawingFactory",["text!DS/ENOPAD3DViewer/assets/json/IconsPOI.json"],function(e){"use strict";function t(){if("object"==typeof t.instance)return t.instance;t.instance=this;var i=JSON.parse(e);if(!i.icons)throw new Error("no POI icons available - please retry");return this._poiIcons=i.icons,this}return t.prototype.draw=function(e){if(this._draw=null,e&&e.icon&&!0===this._poiIcons[e.icon])switch(e.icon){case"default":this._draw=this._drawDefault(e);break;case"alert":this._draw=this._drawAlert(e);break;case"arrow":this._draw=this._drawArrow(e);break;case"camera":this._draw=this._drawCamera(e);break;case"circle":this._draw=this._drawCircle(e);break;case"cross":this._draw=this._drawCross(e);break;case"document":this._draw=this._drawDocument(e);break;case"square":this._draw=this._drawSquare(e);break;case"diamond":this._draw=this._drawDiamond(e);break;case"star":this._draw=this._drawStar(e);break;case"triangle":this._draw=this._drawTriangle(e);break;case"virus":this._draw=this._drawVirus(e);break;case"flag":this._draw=this._drawFlag(e);break;case"info":this._draw=this._drawInfo(e);break;case"gear":this._draw=this._drawGear(e);break;case"nail":this._draw=this._drawNail(e);break;default:this._draw=this._drawDefault(e)}else this._draw=this._drawDefault(e);return this._draw},t.prototype._drawDefault=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.beginPath(),t.moveTo(0,0),t.bezierCurveTo(2,-6,-20,-25,0,-30),t.bezierCurveTo(20,-25,-2,-6,0,0),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-21,3,0,2*Math.PI),t.closePath(),t.fillStyle=o,t.fill(),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.beginPath(),t.moveTo(0,0),t.bezierCurveTo(2,-6,-20,-25,0,-30),t.bezierCurveTo(20,-25,-2,-6,0,0),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-21,3,0,2*Math.PI),t.closePath(),t.fillStyle=o,t.fill(),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.beginPath(),t.moveTo(0,0),t.bezierCurveTo(2,-6,-20,-25,0,-30),t.bezierCurveTo(20,-25,-2,-6,0,0),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-21,3,0,2*Math.PI),t.closePath(),t.fillStyle="#000000",t.fill()};break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.beginPath(),t.moveTo(0,0),t.bezierCurveTo(2,-6,-20,-25,0,-30),t.bezierCurveTo(20,-25,-2,-6,0,0),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-21,3,0,2*Math.PI),t.closePath(),t.fillStyle=o,t.fill()}}return t},t.prototype._drawAlert=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(0,-25),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("!",0,-12),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(0,-25),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("!",0,-12),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(0,-25),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#000000",t.fillText("!",0,-12)}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(0,-25),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("!",0,-12)}.bind(this)}return t},t.prototype._drawArrow=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.moveTo(-5,-25),t.lineTo(-5,-10),t.lineTo(-10,-10),t.lineTo(0,0),t.lineTo(10,-10),t.lineTo(5,-10),t.lineTo(5,-25),t.lineTo(-5,-25),t.fill(),t.stroke(),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.moveTo(-5,-25),t.lineTo(-5,-10),t.lineTo(-10,-10),t.lineTo(0,0),t.lineTo(10,-10),t.lineTo(5,-10),t.lineTo(5,-25),t.lineTo(-5,-25),t.fill(),t.stroke(),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.moveTo(-5,-25),t.lineTo(-5,-10),t.lineTo(-10,-10),t.lineTo(0,0),t.lineTo(10,-10),t.lineTo(5,-10),t.lineTo(5,-25),t.lineTo(-5,-25),t.fill(),t.stroke()};break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.moveTo(-5,-25),t.lineTo(-5,-10),t.lineTo(-10,-10),t.lineTo(0,0),t.lineTo(10,-10),t.lineTo(5,-10),t.lineTo(5,-25),t.lineTo(-5,-25),t.fill(),t.stroke()}}return t},t.prototype._drawCamera=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(-10,-19),t.lineTo(-5,-19),t.lineTo(-3,-21),t.lineTo(3,-21),t.lineTo(5,-19),t.lineTo(10,-19),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-12,4,0,2*Math.PI),t.closePath(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(-10,-19),t.lineTo(-5,-19),t.lineTo(-3,-21),t.lineTo(3,-21),t.lineTo(5,-19),t.lineTo(10,-19),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-12,4,0,2*Math.PI),t.closePath(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(-10,-19),t.lineTo(-5,-19),t.lineTo(-3,-21),t.lineTo(3,-21),t.lineTo(5,-19),t.lineTo(10,-19),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-12,4,0,2*Math.PI),t.closePath(),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-10,-5),t.lineTo(-10,-19),t.lineTo(-5,-19),t.lineTo(-3,-21),t.lineTo(3,-21),t.lineTo(5,-19),t.lineTo(10,-19),t.lineTo(10,-5),t.lineTo(-10,-5),t.fill(),t.stroke(),t.beginPath(),t.arc(0,-12,4,0,2*Math.PI),t.closePath(),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this)}return t},t.prototype._drawCircle=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this)}return t},t.prototype._drawCross=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i);for(var h=0;h<9;h++){var c=h%2==0?4:13,p=Math.PI*h/4;t.lineTo(0+c*Math.sin(p),c*Math.cos(p)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-9}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i);for(var h=0;h<9;h++){var c=h%2==0?4:13,p=Math.PI*h/4;t.lineTo(0+c*Math.sin(p),c*Math.cos(p)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-9}),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i);for(var o=0;o<9;o++){var n=o%2==0?4:13,l=Math.PI*o/4;t.lineTo(0+n*Math.sin(l),n*Math.cos(l)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-9})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i);for(var l=0;l<9;l++){var h=l%2==0?4:13,c=Math.PI*l/4;t.lineTo(0+h*Math.sin(c),h*Math.cos(c)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-9})}.bind(this)}return t},t.prototype._drawDiamond=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(0,-24),t.lineTo(9,-12),t.lineTo(0,0),t.lineTo(-9,-12),t.lineTo(0,-24),t.fill(),t.stroke(),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(0,-24),t.lineTo(9,-12),t.lineTo(0,0),t.lineTo(-9,-12),t.lineTo(0,-24),t.fill(),t.stroke(),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(0,-24),t.lineTo(9,-12),t.lineTo(0,0),t.lineTo(-9,-12),t.lineTo(0,-24),t.fill(),t.stroke()};break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(0,-24),t.lineTo(9,-12),t.lineTo(0,0),t.lineTo(-9,-12),t.lineTo(0,-24),t.fill(),t.stroke()}}return t},t.prototype._drawDocument=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-7,-5),t.lineTo(-7,-27),t.lineTo(2,-27),t.lineTo(8,-21),t.lineTo(8,-5),t.lineTo(-7,-5),t.fill(),t.moveTo(2,-27),t.lineTo(2,-21),t.lineTo(8,-21),t.moveTo(-4,-18),t.lineTo(5,-18),t.moveTo(-4,-15),t.lineTo(5,-15),t.moveTo(-4,-12),t.lineTo(5,-12),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-7,-5),t.lineTo(-7,-27),t.lineTo(2,-27),t.lineTo(8,-21),t.lineTo(8,-5),t.lineTo(-7,-5),t.fill(),t.moveTo(2,-27),t.lineTo(2,-21),t.lineTo(8,-21),t.moveTo(-4,-18),t.lineTo(5,-18),t.moveTo(-4,-15),t.lineTo(5,-15),t.moveTo(-4,-12),t.lineTo(5,-12),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-7,-5),t.lineTo(-7,-27),t.lineTo(2,-27),t.lineTo(8,-21),t.lineTo(8,-5),t.lineTo(-7,-5),t.fill(),t.moveTo(2,-27),t.lineTo(2,-21),t.lineTo(8,-21),t.moveTo(-4,-18),t.lineTo(5,-18),t.moveTo(-4,-15),t.lineTo(5,-15),t.moveTo(-4,-12),t.lineTo(5,-12),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-7,-5),t.lineTo(-7,-27),t.lineTo(2,-27),t.lineTo(8,-21),t.lineTo(8,-5),t.lineTo(-7,-5),t.fill(),t.moveTo(2,-27),t.lineTo(2,-21),t.lineTo(8,-21),t.moveTo(-4,-18),t.lineTo(5,-18),t.moveTo(-4,-15),t.lineTo(5,-15),t.moveTo(-4,-12),t.lineTo(5,-12),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this)}return t},t.prototype._drawFlag=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2-5*s,a-5*s),t.scale(s*i,s*i),t.moveTo(-1,-27),t.lineTo(-1,0),t.lineTo(1,0),t.lineTo(1,-13),t.lineTo(13,-18),t.lineTo(1,-25),t.lineTo(1,-27),t.lineTo(-1,-27),t.moveTo(1,-24),t.lineTo(1,-14),t.fill(),t.stroke(),this._drawProximityBaseCircle(t,{x:10,y:-30}),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2-5*s,a-5*s),t.scale(s*i,s*i),t.moveTo(-1,-27),t.lineTo(-1,0),t.lineTo(1,0),t.lineTo(1,-13),t.lineTo(13,-18),t.lineTo(1,-25),t.lineTo(1,-27),t.lineTo(-1,-27),t.moveTo(1,-24),t.lineTo(1,-14),t.fill(),t.stroke(),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2-5*s,a),t.scale(s*i,s*i),t.moveTo(-1,-27),t.lineTo(-1,0),t.lineTo(1,0),t.lineTo(1,-13),t.lineTo(13,-18),t.lineTo(1,-25),t.lineTo(1,-27),t.lineTo(-1,-27),t.moveTo(1,-24),t.lineTo(1,-14),t.fill(),t.stroke()};break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2-5*s,a),t.scale(s*i,s*i),t.moveTo(-1,-27),t.lineTo(-1,0),t.lineTo(1,0),t.lineTo(1,-13),t.lineTo(13,-18),t.lineTo(1,-25),t.lineTo(1,-27),t.lineTo(-1,-27),t.moveTo(1,-24),t.lineTo(1,-14),t.fill(),t.stroke()}}return t},t.prototype._drawGear=function(e){var t=null,i=window.devicePixelRatio||1,o=(e.parameters.borderColor,e.parameters.fillColor),n=e.parameters.scale,s=e.parameters.width,r=e.parameters.height,a=(e.parameters.number,e.parameters.opacity);if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=a,t.fillStyle=o,t.save(),t.translate(s/2,r),t.scale(n*i,n*i)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=a,t.fillStyle=o,t.save(),t.translate(s/2,r-5*n),t.scale(n*i,n*i),t.lineWidth=.5}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.save(),t.translate(s/2,r),t.scale(n*i,n*i)}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=a,t.fillStyle=o,t.save(),t.translate(s/2,r),t.scale(n*i,n*i)}.bind(this)}return t},t.prototype._drawInfo=function(e){var t=null,i=window.devicePixelRatio||1,o=(e.parameters.borderColor,e.parameters.fillColor),n=e.parameters.scale,s=e.parameters.width,r=e.parameters.height,a=e.parameters.number,l=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=l,t.fillStyle=o,t.lineWidth=.5,t.translate(s/2,r-5*n),t.scale(n*i,n*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("i",0,-13),this._drawClusterBubble(t,{x:8,y:-30},a)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=l,t.fillStyle=o,t.lineWidth=.5,t.translate(s/2,r-5*n),t.scale(n*i,n*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawProximityBaseCircle(t),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("i",0,-13),this._drawClusterBubble(t,{x:8,y:-30},a)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.lineWidth=.5,t.translate(s/2,r),t.scale(n*i,n*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("i",0,-13)}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=l,t.fillStyle=o,t.lineWidth=.5,t.translate(s/2,r),t.scale(n*i,n*i),t.beginPath(),t.arc(0,-14,9,0,2*Math.PI),t.closePath(),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),t.textAlign="center",t.textBaseline="middle",t.font="bold 11pt Arial",t.fillStyle="#3d3d3d",t.fillText("i",0,-13)}.bind(this)}return t},t.prototype._drawSquare=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.rect(-9,-23,18,18),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.rect(-9,-23,18,18),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:8,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.rect(-9,-23,18,18),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.rect(-9,-23,18,18),t.fill(),this._drawHotspotPoint(t,{x:0,y:-5})}.bind(this)}return t},t.prototype._drawStar=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i);for(var h=0;h<11;h++){var c=h%2==0?6:11,p=Math.PI*h/5;t.lineTo(0+c*Math.sin(p),c*Math.cos(p)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i);for(var h=0;h<11;h++){var c=h%2==0?6:11,p=Math.PI*h/5;t.lineTo(0+c*Math.sin(p),c*Math.cos(p)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7}),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i);for(var o=0;o<11;o++){var n=o%2==0?6:11,l=Math.PI*o/5;t.lineTo(0+n*Math.sin(l),n*Math.cos(l)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i);for(var l=0;l<11;l++){var h=l%2==0?6:11,c=Math.PI*l/5;t.lineTo(0+h*Math.sin(c),h*Math.cos(c)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7})}.bind(this)}return t},t.prototype._drawTriangle=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-9,-21),t.lineTo(9,-21),t.lineTo(0,0),t.lineTo(-9,-21),t.fill(),t.stroke(),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.lineTo(-9,-21),t.lineTo(9,-21),t.lineTo(0,0),t.lineTo(-9,-21),t.fill(),t.stroke(),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-9,-21),t.lineTo(9,-21),t.lineTo(0,0),t.lineTo(-9,-21),t.fill(),t.stroke()};break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.lineTo(-9,-21),t.lineTo(9,-21),t.lineTo(0,0),t.lineTo(-9,-21),t.fill(),t.stroke()}}return t},t.prototype._drawVirus=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i);for(var h=0;h<21;h++){var c=h%2==0?6:11,p=Math.PI*h/10;t.lineTo(0+c*Math.sin(p),c*Math.cos(p)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7}),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i);for(var h=0;h<21;h++){var c=h%2==0?6:11,p=Math.PI*h/10;t.lineTo(0+c*Math.sin(p),c*Math.cos(p)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7}),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i);for(var o=0;o<21;o++){var n=o%2==0?6:11,l=Math.PI*o/10;t.lineTo(0+n*Math.sin(l),n*Math.cos(l)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7})}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i);for(var l=0;l<21;l++){var h=l%2==0?6:11,c=Math.PI*l/10;t.lineTo(0+h*Math.sin(c),h*Math.cos(c)-14)}t.fill(),this._drawHotspotPoint(t,{x:0,y:-7})}.bind(this)}return t},t.prototype._drawNail=function(e){var t=null,i=window.devicePixelRatio||1,o=e.parameters.borderColor,n=e.parameters.fillColor,s=e.parameters.scale,r=e.parameters.width,a=e.parameters.height,l=e.parameters.number,d=e.parameters.opacity;if(e&&e.type)switch(e.type){case"cluster":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-16,13,-3*Math.PI/4,-Math.PI/4),t.lineTo(9,-25),t.lineTo(-9,-25),t.moveTo(-3,-25),t.lineTo(-3,-5),t.lineTo(0,-1),t.lineTo(3,-5),t.lineTo(3,-25),t.moveTo(-3,-5),t.lineTo(3,-5),t.moveTo(3,-17),t.lineTo(0,-15),t.moveTo(3,-14),t.lineTo(0,-12),t.moveTo(3,-11),t.lineTo(0,-9),t.fill(),t.stroke(),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"proximity":t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a-5*s),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-16,13,-3*Math.PI/4,-Math.PI/4),t.lineTo(9,-25),t.lineTo(-9,-25),t.moveTo(-3,-25),t.lineTo(-3,-5),t.lineTo(0,-1),t.lineTo(3,-5),t.lineTo(3,-25),t.moveTo(-3,-5),t.lineTo(3,-5),t.moveTo(3,-17),t.lineTo(0,-15),t.moveTo(3,-14),t.lineTo(0,-12),t.moveTo(3,-11),t.lineTo(0,-9),t.fill(),t.stroke(),this._drawProximityBaseCircle(t),this._drawClusterBubble(t,{x:10,y:-30},l)}.bind(this);break;case"instancing":t=function(e,t){t.globalAlpha=d,t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-16,13,-3*Math.PI/4,-Math.PI/4),t.lineTo(9,-25),t.lineTo(-9,-25),t.moveTo(-3,-25),t.lineTo(-3,-5),t.lineTo(0,-1),t.lineTo(3,-5),t.lineTo(3,-25),t.moveTo(-3,-5),t.lineTo(3,-5),t.moveTo(3,-17),t.lineTo(0,-15),t.moveTo(3,-14),t.lineTo(0,-12),t.moveTo(3,-11),t.lineTo(0,-9),t.fill(),t.stroke()}.bind(this);break;case"default":default:t=function(e,t){t.globalAlpha=d,t.fillStyle=n,t.strokeStyle=o,t.lineWidth=.5,t.translate(r/2,a),t.scale(s*i,s*i),t.beginPath(),t.arc(0,-16,13,-3*Math.PI/4,-Math.PI/4),t.lineTo(9,-25),t.lineTo(-9,-25),t.moveTo(-3,-25),t.lineTo(-3,-5),t.lineTo(0,-1),t.lineTo(3,-5),t.lineTo(3,-25),t.moveTo(-3,-5),t.lineTo(3,-5),t.moveTo(3,-17),t.lineTo(0,-15),t.moveTo(3,-14),t.lineTo(0,-12),t.moveTo(3,-11),t.lineTo(0,-9),t.fill(),t.stroke()}.bind(this)}return t},t.prototype._drawHotspotPoint=function(e,t){e.fillStyle="black",e.strokeStyle="black",e.lineWidth=.5,e.moveTo(t.x,t.y),e.lineTo(0,0),e.stroke(),e.beginPath(),e.arc(0,-1,1,0,2*Math.PI),e.closePath(),e.fill()},t.prototype._drawClusterBubble=function(e,t,i){e.fillStyle="#EA4F37",e.beginPath(),e.arc(t.x,t.y,9,0,2*Math.PI),e.closePath(),e.fill(),e.textAlign="center",e.textBaseline="middle",e.fillStyle="#F4F5F6";var o="",n=0;try{i<10?e.font="12px pad-3ds-light":i<100?(e.font="11px pad-3ds-light",n=1):i<1e3?e.font="9px pad-3ds-light":(e.font="7px pad-3ds-light",n=1)}catch(e){console.error(e)}o=i<1e3?i+"":"999+",e.fillText(o,t.x+n,t.y)},t.prototype._drawProximityBaseCircle=function(e){e.fillStyle="black",e.strokeStyle="black",e.lineWidth=.4,e.beginPath(),e.ellipse(0,0,10,3,0,-Math.PI/3,-2*Math.PI/3),e.stroke()},new t}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerSearchResultsView",["UWA/Class","DS/ApplicationFrame/CommandsManager","DS/Selection/CSOManager","DS/Selection/HSOManager","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json"],function(e,t,i,o,n,s){"use strict";return e.extend({name:"_PAD3DViewerSearchResultsView",_taggerSelect:function(e){var t=this,r=[],a=!1;if(e&&e.selectedPaths&&e.selectedPaths.length&&e.selectedPaths.forEach(function(e){var i=t.unstreamPath(e);i&&((t._hideShowController&&!t._hideShowController.isVisible(i)&&1===t._viewer.getVisibleSpace()||t._hideShowController&&t._hideShowController.isVisible(i)&&0===t._viewer.getVisibleSpace())&&(a=!0),r.push({pathElement:i}))}),e&&!0===e.memoryFull)t.displayNotification({eventID:"info",msg:n.searchResults_memoryFull.replace("{nbResult}",e.pathCount)});else if(r.length){t.lockSelectionBroadcast(!0),i.empty(),o.empty();var l=e.selectedPaths.length>1?n.multipleResultOfSearchInContext:n.singleResultOfSearchInContext;i.add(r),i.get().forEach(function(e){o.add(e)}),t.displayNotification({eventID:"info",msg:e.selectedPaths.length+l}),a&&t.displayNotification({eventID:"info",msg:n.selectionInOtherSpace}),t.lockSelectionBroadcast(!1)}else e&&e.tooManyPath?t.displayNotification({eventID:"info",msg:n.tooManyResultFound}):e&&0===e.pathCount&&t.displayNotification({eventID:"info",msg:s.tagger_select_no_result}),t.publish({event:"onSearchCompleted",data:e})},_findPaths:function(e){var s=[],r=!1;if(e&&e.selectedPaths&&e.selectedPaths.length&&e.selectedPaths.forEach(function(e){var t=this.unstreamPath(e);t&&((this._hideShowController&&!this._hideShowController.isVisible(t)&&1===this._viewer.getVisibleSpace()||this._hideShowController&&this._hideShowController.isVisible(t)&&0===this._viewer.getVisibleSpace())&&(r=!0),s.push({pathElement:t}))}.bind(this)),e&&!0===e.memoryFull)this.displayNotification({eventID:"info",msg:n.searchResults_memoryFull.replace("{nbResult}",e.pathCount)});else if(s.length){this.lockSelectionBroadcast(!0);var a=t.getCommand("PAD3DViewerNavigateOnSelectionHdr",this._context);a&&a._view&&a._view.visible&&a.end({performingAgain:!0}),i.empty(),o.empty();var l=e.selectedPaths.length>1?n.multipleResultOfSearchInContext:n.singleResultOfSearchInContext;i.add(s),i.get().forEach(function(e){o.add(e)}),this.displayNotification({eventID:"info",msg:e.selectedPaths.length+l}),r&&this.displayNotification({eventID:"info",msg:n.selectionInOtherSpace}),a&&a.execute(e.selectedPaths).then(function(){this.publish({event:"onSearchCompleted",data:e})}.bind(this)),this.lockSelectionBroadcast(!1)}else e&&e.tooManyPath?this.displayNotification({eventID:"info",msg:n.tooManyResultFound}):this.displayNotification({eventID:"info",msg:n.emptyResultOfSearchInContext}),this.publish({event:"onSearchCompleted",data:e})},_findInContext:function(e){var s=[],r=!1;if(e&&e.selectedPaths&&e.selectedPaths.length&&(this.applyGraphicPropertiesForFindInCtx(e.selectedPaths,e.searchQuery),e.selectedPaths.forEach(function(e){var t=this.unstreamPath(e);t&&((this._hideShowController&&!this._hideShowController.isVisible(t)&&1===this._viewer.getVisibleSpace()||this._hideShowController&&this._hideShowController.isVisible(t)&&0===this._viewer.getVisibleSpace())&&(r=!0),s.push({pathElement:t}))}.bind(this))),e&&!0===e.memoryFull)this.displayNotification({eventID:"info",msg:n.searchResults_memoryFull.replace("{nbResult}",e.pathCount)});else if(s.length){this.lockSelectionBroadcast(!0);var a=t.getCommand("PAD3DViewerNavigateOnSelectionHdr",this._context);a&&a._view&&a._view.visible&&a.end({performingAgain:!0}),i.empty(),o.empty();var l=e.selectedPaths.length>1?n.multipleResultOfSearchInContext:n.singleResultOfSearchInContext;i.add(s),i.get().forEach(function(e){o.add(e)}),this.displayNotification({eventID:"info",msg:e.selectedPaths.length+l}),r&&this.displayNotification({eventID:"info",msg:n.selectionInOtherSpace}),a?a.execute(e.selectedPaths).then(function(){this.publish({event:"onSearchCompleted",data:e})}.bind(this)):this._executeCommand&&this._executeCommand({handlerId:"ENO3DNavigateOnSelectionCmd",args:{paths:e.selectedPaths}}).then(()=>{this.publish({event:"onSearchCompleted",data:e})}),this.lockSelectionBroadcast(!1)}else e&&e.tooManyPath?this.displayNotification({eventID:"info",msg:n.tooManyResultFound}):this.displayNotification({eventID:"info",msg:n.emptyResultOfSearchInContext}),this.publish({event:"onSearchCompleted",data:e})}})}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices",["UWA/Core","DS/Controls/Loader","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS"],function(e,t,i,o){"use strict";function n(e){return{x:e.x,y:e.y,z:e.z}}return{reframeOn:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!e.path&&!e.paths&&!e.BS)throw new Error("No paths or bounding sphere defined");if(!e.viewpoint)throw new Error("No viewpoint defined");if(e.BS)e.viewpoint.reframe(null,void 0,e.BS);else{var t=[];e.path?t.push(e.path):t=e.paths;var i,n=new o.Vector3(0,0,0),s=new o.Vector3(0,0,0),r=new o.Vector3(0,0,0),a=0;t.forEach(function(t){if(e.context&&e.context.getController().isAPOIPath(t)){var i=e.context.getController().getPOIPosition(t),o=d={x:i.x,y:i.y,z:i.z};0===a?(n.x=i.x,n.y=i.y,n.z=i.z,s.x=i.x,s.y=i.y,s.z=i.z):(n.x=Math.min(i.x,n.x),n.y=Math.min(i.y,n.y),n.z=Math.min(i.z,n.z),s.x=Math.max(i.x,s.x),s.y=Math.max(i.y,s.y),s.z=Math.max(i.z,s.z)),a++}else{var r=t.getLastElement(!0).getBoundingBox().clone(),l=t.getWorldMatrix();r.applyMatrix4(l);var d=r.min;o=r.max;0===a?(n.x=Math.min(d.x,o.x),n.y=Math.min(d.y,o.y),n.z=Math.min(d.z,o.z),s.x=Math.max(d.x,o.x),s.y=Math.max(d.y,o.y),s.z=Math.max(d.z,o.z)):(n.x=Math.min(Math.min(d.x,o.x),n.x),n.y=Math.min(Math.min(d.y,o.y),n.y),n.z=Math.min(Math.min(d.z,o.z),n.z),s.x=Math.max(Math.max(d.x,o.x),s.x),s.y=Math.max(Math.max(d.y,o.y),s.y),s.z=Math.max(Math.max(d.z,o.z),s.z)),a++}}),i=Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2)+Math.pow(s.z-n.z,2))/2,r.add(n).add(s),r.divideScalar(2);var l=e.viewpoint,d=1.1*i/Math.tan(22.5*Math.PI/180),h=r.clone(),c=l.control.orientation.clone();l.control.moveTo({target:h,orientation:c,distanceToTarget:d,duration:400})}},reframeOnCandidates:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!e.path&&!e.paths&&!e.BS)throw new Error("No paths or bounding sphere defined");if(!e.viewpoint)throw new Error("No viewpoint defined");if(!e.context)throw new Error("No context defined");if(e.BS)e.viewpoint.reframe(null,void 0,e.BS);else{var t=[];e.path?t.push(e.path):t=e.paths;var i=null;var n,s=new o.Vector3(0,0,0),r=new o.Vector3(0,0,0),a=new o.Vector3(0,0,0),l=0;let u=!1;t.forEach(function(t){var n=e.context.getController().buildArrayFromPath(t);if(n&&n.length>0&&e.context.getController()._model.getWorldMatrix){u=!0;var a=e.context.getController().getReferenceBoundingSphere(n[n.length-1]);if(a){var d=e.context.getController()._model.getWorldMatrix(n);a.applyMatrix4(d);var h=t.getBoundingSphere(),c=new o.Sphere;!h||h.isNaN()||h.empty()?c=a:a.mergeWithSphere(h,c),i=function(e,t){if(t&&!t.isNaN()){var i=t.clone();e?e.mergeWithSphere(i,e):e=i}return e}(i,c)}}else if(n&&n.length>0){var p=e.context.getController().getReferenceBoundingBox(n[n.length-1]);if(p){d=e.context.getController()._model.getWorldMatrix(n);p.applyMatrix4(d);var g=p.min,_=p.max;0===l?(s.x=Math.min(g.x,_.x),s.y=Math.min(g.y,_.y),s.z=Math.min(g.z,_.z),r.x=Math.max(g.x,_.x),r.y=Math.max(g.y,_.y),r.z=Math.max(g.z,_.z)):(s.x=Math.min(Math.min(g.x,_.x),s.x),s.y=Math.min(Math.min(g.y,_.y),s.y),s.z=Math.min(Math.min(g.z,_.z),s.z),r.x=Math.max(Math.max(g.x,_.x),r.x),r.y=Math.max(Math.max(g.y,_.y),r.y),r.z=Math.max(Math.max(g.z,_.z),r.z)),l++}}}),n=Math.sqrt(Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2)+Math.pow(r.z-s.z,2))/2,a.add(s).add(r),a.divideScalar(2);var d=e.viewpoint,h=1.1*n/Math.tan(22.5*Math.PI/180),c=a.clone();if(u)h=1.1*i.radius/Math.tan(22.5*Math.PI/180),c=i.center.clone();var p=d.control.orientation.clone();d.control.moveTo({target:c,orientation:p,distanceToTarget:h,duration:400})}},buildViewPoint:function(e){return function(e){var t=e.camera,o=t.getLookAt();return{projection:e.getProjectionType()===i.PERSPECTIVE?"CONIC":"CYLINDRIC",focus:e.getTargetDistance(),near:t.near,far:t.far,up:[n(t.up)],eye:[n(t.position)],sight:[n(o)],fov:e.getAngle()}}(e)},convertExponentialToDecimal:function(e){var t=e.toString();if(-1!==t.indexOf("e")){if(/\d+\.?\d*e[\+\-]*\d+/i.test(e)){var i=String(e).toLowerCase().split("e"),o=i.pop(),n=Math.abs(o),s=o/n,r=i[0].split(".");if(-1===s)r[0]=Math.abs(r[0]),e="-0."+new Array(n).join("0")+r.join("");else{var a=r[1];a&&(n-=a.length),e=r.join("")+new Array(n+1).join("0")}}return e}return t},rgbaToHex:function(e){const t=e.split("(")[1].slice(0,-1).split(",");return{hex:"#"+((1<<24)+(parseInt(t[0])<<16)+(parseInt(t[1])<<8)+parseInt(t[2])).toString(16).slice(1),opacity:parseFloat(t[3])}},_getFrustumDefinition:function(e,t){var o=t.camera,n={screen_width_px:e.SCREEN_WIDTH.toFixed(1),screen_height_px:e.SCREEN_HEIGHT.toFixed(1),eye_position:[this.convertExponentialToDecimal(o.position.x),this.convertExponentialToDecimal(o.position.y),this.convertExponentialToDecimal(o.position.z)],sight:[this.convertExponentialToDecimal(o.getLookAt().x),this.convertExponentialToDecimal(o.getLookAt().y),this.convertExponentialToDecimal(o.getLookAt().z)],up:[this.convertExponentialToDecimal(o.up.x),this.convertExponentialToDecimal(o.up.y),this.convertExponentialToDecimal(o.up.z)]};return t.getProjectionType()===i.PERSPECTIVE?n.angle=t.getAngle().toFixed(1):(n.left=""+o.left,n.right=""+o.right,n.top=""+o.top,n.bottom=""+o.bottom),n}}}),define("DS/ENOPAD3DViewer/utils/PADQuadTree",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/Node3D"],function(e,t,i,o){"use strict";function n(e){this._capacity=e.capacity,this._boundary=e.boundary,this._depth=e.depth?e.depth:0,this._nodeElements=[],this._divided=!1}return n.prototype.clear=function(){this._divided&&(delete this._northWest,delete this._northEast,delete this._southWest,delete this._southEast),this._nodeElements=null},n.prototype.insert=function(e){this._isPointInsideSubdiv(e.position)&&(this._nodeElements.length<this._capacity?this._nodeElements.push(e):(this._divided||(this.subdivide(),this._divided=!0),this._northEast.insert(e),this._northWest.insert(e),this._southEast.insert(e),this._southWest.insert(e)))},n.prototype.subdivide=function(){var e=this._boundary.x,t=this._boundary.y,i=this._boundary.w,o=this._boundary.h;this._northWest=new n({boundary:{x:e,y:t,w:i/2,h:o/2},capacity:this._capacity,depth:this._depth+1}),this._northEast=new n({boundary:{x:e+i/2,y:t,w:i/2,h:o/2},capacity:this._capacity,depth:this._depth+1}),this._southWest=new n({boundary:{x:e,y:t+o/2,w:i/2,h:o/2},capacity:this._capacity,depth:this._depth+1}),this._southEast=new n({boundary:{x:e+i/2,y:t+o/2,w:i/2,h:o/2},capacity:this._capacity,depth:this._depth+1})},n.prototype.query=function(e,t){if(t||(t=[]),this._boundariesIntersects(e)){for(var i=0;i<this._nodeElements.length;++i)this._isPointInside(e,this._nodeElements[i].position)&&t.push(this._nodeElements[i]);this._divided&&(this._northWest.query(e,t),this._northEast.query(e,t),this._southWest.query(e,t),this._southEast.query(e,t))}return t},n.prototype._isPointInsideSubdiv=function(e){return e.x>this._boundary.x&&e.x<this._boundary.x+this._boundary.w&&e.y>this._boundary.y&&e.y<this._boundary.y+this._boundary.h},n.prototype._isPointInside=function(e,t){return t.x>e.x&&t.x<e.x+e.w&&t.y>e.y&&t.y<e.y+e.h},n.prototype._boundariesIntersects=function(e){return this._rectanglesIntersect(e,this._boundary)},n.prototype._rectanglesIntersect=function(e,t){var i=e.x+e.w,o=e.y+e.h,n=e.x,s=e.y+e.h,r=e.x+e.w,a=e.y,l=t.x+t.w,d=t.y+t.h,h=t.x,c=t.y+t.h,p=t.x+t.w,u=t.y;return t.x>=e.x&&t.x<=i&&t.y>=e.y&&t.y<=o||l>=e.x&&l<=i&&d>=e.y&&d<=o||h>=e.x&&h<=i&&c>=e.y&&c<=o||p>=e.x&&p<=i&&u>=e.y&&u<=o||e.x>=t.x&&e.x<=l&&e.y>=t.y&&e.y<=d||i>=t.x&&i<=l&&o>=t.y&&o<=d||n>=t.x&&n<=l&&s>=t.y&&s<=d||r>=t.x&&r<=l&&a>=t.y&&a<=d},n}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices",["UWA/Core","DS/PADUtils/PADSettingsMgt","DS/Visualization/Node3D"],function(e,t,i){"use strict";return{toUnique:function(e,t,i){if((t=e.length)>1)for(;i=--t;)for(;i--;)e[t]===e[i]&&e.splice(i,1);return e},equals:function(e,t){var i=!1;return this.isPLMNode(e)&&this.isPLMNode(t)&&(i=this.getNodeID(e)===this.getNodeID(t)),i},isAModelPath:function(e){var t=!1;if(e)for(var i=0;i<e.externalPath.length;i++)if("RootBag"===e.externalPath[i].name){t=!0;break}return t},isAPOIPath:function(e){var t=!1;if(e)for(var i=0;i<e.externalPath.length;i++)if("PAD3DPOINode"===e.externalPath[i].className){t=!0;break}return t},isAPOIGroupPath:function(e){var t=!1;if(e)for(var i=0;i<e.externalPath.length;i++)if("PAD3DPOIGroupNode"===e.externalPath[i].className||"PAD3DPOIProximityNode"===e.externalPath[i].className||"ProximityGroup"===e.externalPath[i].className){t=!0;break}return t},isAZOIPath:function(e){var t=!1;return e&&e.externalPath[e.externalPath.length-1]&&"PAD3DZOINode"===e.externalPath[e.externalPath.length-1].className&&(t=!0),t},getPOILayerId:function(e){var t=null;if(e)for(var i=0;i<e.externalPath.length;i++)if("PAD3DPOINode"===e.externalPath[i].className){t=e.externalPath[i+1]&&e.externalPath[i+1].name&&e.externalPath[i+1].name.indexOf("PAD3DPOINode")>-1?e.externalPath[i].name:e.externalPath[i+1].name;break}return t},getNodeID:function(e){var i=null;return this.isModelNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.getModelIdentification():e.getID()),i},getNodeType:function(e){var i=null;return this.isModelNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.getUserData&&e.getUserData()?e.getUserData().type:null:e.getType()),i},getLoadedStream:function(e,i){var o=null;return this.isPLMNode(e)&&(t.getSetting("enopad3dviewer_lightNodeModel")||t.getSetting("enopad3dviewer_dynamicRepLoading")?this.isRepReference(e)&&(i&&i.getController()?o=i.getController().getLoadedStream(e):(console.warn("deprecated, please use the signature with the PAD3DViewer in parameter"),o=e.getUserData&&e.getUserData()?e.getUserData().loadedStream:null)):o=e.getLoadedStream()),o},isReference:function(e){var i=!1;return this.isPLMNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.isOOCReference():e.isPLMReference()),i},isInstance:function(e){var i=!1;return this.isPLMNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.isOOCInstance():e.isPLMInstance()),i},isRepReference:function(e){var i=!1;return this.isPLMNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.isOOCRepReference():e.isPLMRepReference()),i},isRepInstance:function(e){var i=!1;return this.isPLMNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.isOOCRepInstance():e.isPLMRepInstance()),i},is3DLeaf:function(e){var i=!1;return this.isPLMNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.isOOCRepReference():e.is3DLeaf()),i},isModelNode:function(e){return t.getSetting("enopad3dviewer_lightNodeModel")?this.isPLMNode(e)||this.isTileSetNode(e):this.isPLMNode(e)},isPLMNode:function(e){return t.getSetting("enopad3dviewer_lightNodeModel")?!(!e||null===e.isOOCPLMNode||void 0===e.isOOCPLMNode)&&e.isOOCPLMNode():!(!e||"PAD3DViewerNode"!==e.className)},isTileSetNode:function(e){var i=!1;return t.getSetting("enopad3dviewer_lightNodeModel")?i=!(!e||null===e.isOOCTileSetNode||void 0===e.isOOCTileSetNode)&&e.isOOCTileSetNode():(console.warn("isTileSetNode: wrong usage, API designed for OOC loader only"),i=!1),i},isFiltered:function(e,t){return t.getController().isFiltered(this.getNodeID(e)).hasFilter},getBIColor:function(e){var i=null;return this.isPLMNode(e)&&(i=t.getSetting("enopad3dviewer_lightNodeModel")?e.getUserData&&e.getUserData()?e.getUserData().BIColor:null:e.getBIColor()),i},getRoots:function(e){return t.getSetting("enopad3dviewer_lightNodeModel")?e.getController().getRootBag().children:e.getController().getRoots()},getSiblings:function(e){var t=[],i=e,o=this;return e.parents.forEach(function(e){e.children.forEach(function(e){o.equals(e,i)||t.push(e)})}),this.toUnique(t)},getReferences:function(e){var t=[];return this.isRepInstance(e)?t=e.parents:this.isReference(e)?t.push(e):this.isRepReference(e)?e.parents.forEach(function(e){t=t.concat(e.parents)}):this.isInstance(e)&&(t=e.children),this.toUnique(t)},isLeaf:function(e){var t=!0,i=this;return e.children.forEach(function(e){i.isRepInstance(e)||(t=!1)}),this.isReference(e)&&t},getRootReferences:function(e,t){t||(t=[]);var i=this;return 1===e.parents.length&&"RootBag"===e.parents[0].name?(t.push(e),i.toUnique(t)):(e.parents.forEach(function(e){i.getRootReferences(e,t)}),i.toUnique(t))},getReferenceBoundingBox:function(e,i){var o=null;if(i)if(t.getSetting("enopad3dviewer_lightNodeModel"))o=i.getReferenceBoundingBox(e);else{var n=i.getNode({id:e});n&&(o=n.getBoundingBox())}else console.warn("getReferenceBoundingBox : You must specify the controller");return o},getReferenceBoundingSphere:function(e,i){var o=null;if(i)if(t.getSetting("enopad3dviewer_lightNodeModel"))o=i.getReferenceBoundingSphere(e);else{var n=i.getNode({id:e});n&&(o=n.getBoundingSphere())}else console.warn("getReferenceBoundingSphere : You must specify the controller");return o},getUserData:function(e,t){var i=null;return t?i=t.getUserData(e):console.warn("getReferenceBoundingSphere : You must specify the controller"),i}}}),define("DS/ENOPAD3DViewer/mixins/PAD3DViewerQueryParser",["DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADUtilsServices","DS/RenderingMaterial/PLMMaterialFactory","DS/3DXMTiles/OOCManager"],function(e,t,i,o,n,s){"use strict";return{name:"PAD3DViewerQueryParser",_buildFromJSONOcc:function(i){var r=this,a=(void 0!==i.hidden&&i.hidden,"ON"===window.localStorage.getItem("TileModelDebug"));r.nbCgrLoaded=0,r.nbThbLoaded=0;var l=[],d=[],h=0,c=!1,p=[],u=[],g={},_=null,f=!1,v=function(){var e=l.slice(0),t=d.slice(0);i.callbacks.onComplete({id:i.rootIds[0],ids:i.rootIds,createdPaths:e,selectedPaths:t,BS:_,memoryFull:c,expandCut:!0===f?f:void 0}),l=null,d=null,i=null,c=null,r=null};this._parsingRunning=!0,this.parsingProbe=e.createProbe("Parsing "+i.json.results.length+" results and building structure");var m=window.performance.now(),b=new Map,y=new Map,P=0,D=0,I=0,S=0,C=i.json.results.length,w=i.json.results,x=0;for(this._OOCManager.startInstRefGraphTransaction(),x=0;x<C;x++){if(this._OOCManager.isCPUMemoryFull()){c=!0;break}var O=w[x],A=null,M=null;if(void 0!==O.attributes){P++;var N={};if(this._parseAttributes(O.attributes,N,i.extraAttribute),"ds6w:Instance"!==N.globalType&&"VPMRepInstance"!==N.type){if((N.thbUrl||N.cgrUrl)&&I++,!this.isRegistered(N.pid)){if(u.push(N.pid),O.boundingbox){var V=this._parseBoundingElements(O.boundingbox,N.thbUrl||N.cgrUrl);M=V.boundingBox,A=V.boundingSphere}(N.thbUrl||N.cgrUrl)&&S++;var E=null,T=null;"ds6w:Document"===N.globalType&&("thumbnail"===i.streamToLoad&&N.thbUrl?(E=N.thbUrl,T=s.RepType.pr,r.nbThbLoaded++):(E=N.cgrUrl,T=s.RepType.av1,r.nbCgrLoaded++),E||(A.radius=0),a&&this._repList.push({id:N.pid,stamp:new Date(Date.now()),parsingID:m})),this._OOCManager.registerReference(N.pid,{handlerType:"ds6w:Document"===N.globalType?"repRef":"ref",boundingBox:A&&A.radius>0?M:void 0,boundingSphere:A,url:E,type:T}),this._OOCManager.setUserData(N.pid,{type:N.type})}if("ds6w:Document"===N.globalType&&p.push(N.pid),"addRoot"===i.intent&&-1!==i.rootIds.indexOf(N.pid)){if(!0===i.reframe&&i.callbacks.onReframe({BS:A,rootBS:!0}),!this.getRoot({id:N.pid})){var R=this._OOCManager.addRoot(N.pid,{handlerType:N.thbUrl?"repRef":N.cgrUrl?"repRef":"rep",boundingBox:A&&A.radius>0?M:void 0,boundingSphere:A});this._OOCManager.addSceneGraphLock(N.pid),this._rootIndex[N.pid]={occId:R,setSequenceFilter:function(e){this._sequenceFilter=e},setConfigFilter:function(e){this._configFilter=e},setCVFilterQuery:function(e){this._CVFilterQuery=e},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(e,t,i){var o="V1"===i?{V1:{}}:{V2:{}},n=null;if(t&&t.GetFilterSpec){var s=t.GetFilterSpec(e,o);s&&(n=s.CVQuery3D)}return n}.bind(this,N.pid)}}_=A}i.extraAttribute&&(g[N.pid]||(g[N.pid]={},N[i.extraAttribute]&&(g[N.pid][i.extraAttribute]=N[i.extraAttribute]))),y.set(N.did,N.pid)}else b.set(N.did,N),y.set(N.did,N.pid)}else if(void 0!==O.path){D++;for(var L=""+O.path[0],F=y.get(L),k=[F],B=1;B<O.path.length;B++)if(k.push(y.get(""+O.path[B])),B%2==1){var G=""+O.path[B],U=y.get(G),z=""+O.path[B+1],W=y.get(z);this.isRegistered(U)||(this._OOCManager.addChild(F,W,{matrix:b.get(G).matrix,instanceId:U}),this._OOCManager.setUserData(U,{type:b.get(G).type}),b.delete(G)),L=z,F=W}i.forceLoad&&this.lockNodes({ids:[k[k.length-1]]}),d.push(k)}else void 0!==O.status?"EXPAND_WAS_CUT_MAX_OUTPUT_PATHS"===O.status&&(f=!0):O.material_overload&&(n.setParams({messageFromIndex:O.material_overload,jsonVersion:"1.0",rootId:i.rootIds[0],getNodeFromID:function(e){return this.getNode({id:e})}.bind(this),getDepth:function(){return 1}.bind(this),retrieveIRPathFromIIPath:this._getIRPathFromIIPath.bind(this),getSecurityParamsCB:function(){return{securityCtx:t.getSetting("pad_security_ctx"),tenant:o.getPlatformId(),service3DSpaceUrl:o.get3DSpaceUrl(),userLogin:o.getUser().login}}}),n.computeMaterials({rootId:i.rootIds[0]}))}r.publish({event:"onUrlLoaded",data:{nbCgrLoaded:r.nbCgrLoaded,nbThbLoaded:r.nbThbLoaded}}),this._OOCManager.endInstRefGraphTransaction(),r.parsingProbe.end(),delete r.parsingProbe,this.statProb=e.createProbe("nbRef: "+P+" / nbUrl : "+I+" / nbNewUrl : "+S+" / nbPath : "+D),r.statProb.end(),delete r.statProb,i.json=null,delete i.json,r._parsingRunning=!1,p.length&&i.extraAttribute&&r.publish({event:"colorOverridePostProcess",data:{leavesToColorize:p,hashMap:g}}),u.length&&r.publish({event:"newNodes",data:{newNodes:u}}),0===h&&v()},_buildFromJSONInstRef:function(i){var r=this,a="ON"===window.localStorage.getItem("TileModelDebug");r.nbCgrLoaded=0,r.nbThbLoaded=0;var l=[],d=[],h={},c=0,p=null,u=[],g=[],_=[],f=[],v=[],m={},b=!1,y=[],P=function(){var e=l.slice(0),t=d.slice(0),o=u.slice(0);i.callbacks.onComplete({id:i.rootIds[0],ids:i.rootIds,createdPaths:e,selectedPaths:t,sortedPaths:h,representationsList:o,BS:null,memoryFull:b,results:y,orientation:p}),l=null,d=null,u=null,i=null,b=null,r=null};this._parsingRunning=!0,this.parsingProbe=e.createProbe("Parsing "+i.json.results.length+" results and building structure");var D=window.performance.now(),I={references:[],instances:[],occurrences:[],rootId:i.rootIds[0]};let S=[];var C={nbRef:0,nbNewRef:0,nbRep:0,nbNewRep:0,nbInst:0,nbNewInst:0,nbUrl:0,nbNewUrl:0,nbObj:0,nbPath:0,timing:0,pgpOnRef:0,pgpOnInst:0,pgpOnOcc:0,pmrOnOcc:0},w=i.json.results.length,x=i.json.results,O=new Date,A=0;for(this._OOCManager.startInstRefGraphTransaction(),A=0;A<w;A++){if(this._OOCManager.isCPUMemoryFull()){b=!0,y=x;break}C.nbObj++;var M=x[A],N=null,V=null,E=null,T=!1;if(M.boundingbox&&i.filteredBBox&&this._isValidBBox(i.filteredBBox)&&-1!==i.rootIds.indexOf(M.resourceid)&&(M.boundingbox=i.filteredBBox),M.Path){d.push(M.Path),C.nbPath++;var R=M.matching_lengths;if(R)for(var L=[M.Path.length],F=0;F<R.length;++F){var k=R[F];k%2==0&&k+1<=M.Path.length&&(k+=1),-1===L.indexOf(k)&&(d.push(M.Path.slice(0,k)),L.push(k),C.nbPath++)}var B=M.annotations;if(B)for(F=0;F<B.length;F++)h[B[F]]||(h[B[F]]=[]),h[B[F]].push(M.Path)}else if(M.materials_info)T=!0,n.setParams({messageFromIndex:M.materials_info,jsonVersion:"2.0",rootId:i.rootIds[0],getNodeFromID:function(e){return this.getNode({id:e})}.bind(this),getDepth:function(){return 1}.bind(this),retrieveIRPathFromIIPath:this._getIRPathFromIIPath.bind(this),getSecurityParamsCB:function(){return{securityCtx:t.getSetting("pad_security_ctx"),tenant:o.getPlatformId(),service3DSpaceUrl:o.get3DSpaceUrl(),userLogin:o.getUser().login}}});else if(M.pgp_output){var G=M.pgp_output.pgp_show?M.pgp_output.pgp_show:null,U=M.pgp_output.pgp_hide?M.pgp_output.pgp_hide:null,z=M.pgp_output.pgp_color?M.pgp_output.pgp_color[0].path:null,W=M.pgp_output.pgp_opacity?M.pgp_output.pgp_opacity[0].path:null,H=M.pgp_output.pgp_inheritance?M.pgp_output.pgp_inheritance[0].path:null,j=0;if(G)for(j=0;j<G.length;j++)G[j][0]&&(I.occurrences.push({path:G[j],value:!0,type:"hideshow"}),C.pgpOnOcc++);if(U)for(j=0;j<U.length;j++)U[j][0]&&(I.occurrences.push({path:U[j],value:!1,type:"hideshow"}),C.pgpOnOcc++);if(W&&W.length)for(j=0;j<M.pgp_output.pgp_opacity.length;j++)I.occurrences.push({path:M.pgp_output.pgp_opacity[j].path,value:M.pgp_output.pgp_opacity[j].opacity,type:"opacity",inheritance:M.pgp_output.pgp_opacity[j].inheritance?parseInt(M.pgp_output.pgp_opacity[j].inheritance):void 0}),C.pgpOnOcc++;if(z&&z.length)for(j=0;j<M.pgp_output.pgp_color.length;j++)I.occurrences.push({path:M.pgp_output.pgp_color[j].path,value:M.pgp_output.pgp_color[j].color,type:"color",inheritance:M.pgp_output.pgp_color[j].inheritance?parseInt(M.pgp_output.pgp_color[j].inheritance):void 0}),C.pgpOnOcc++;if(H&&H.length)for(j=0;j<M.pgp_output.pgp_inheritance.length;j++)I.occurrences.push({path:M.pgp_output.pgp_inheritance[j].path,value:M.pgp_output.pgp_inheritance[j].inheritance,type:"inheritance",inheritance:M.pgp_output.pgp_inheritance[j].inheritance?parseInt(M.pgp_output.pgp_inheritance[j].inheritance):void 0})}else if(M.flexible_assembly_output)S=S.concat(M.flexible_assembly_output),C.pmrOnOcc+=M.flexible_assembly_output.length;else{var Q,q,X,K,Z,J,Y,$,ee;if(M["ro.PGPShowExtension.V_PGP_Show"]||M["bo.PGPShowExtension.V_PGP_Show"]||M["ro.pgpshowextension.v_pgp_show"]||M["bo.pgpshowextension.v_pgp_show"])M["ro.PGPShowExtension.V_PGP_Show"]||M["ro.pgpshowextension.v_pgp_show"]?(Q=M["ro.PGPShowExtension.V_PGP_Show"]?"true"===M["ro.PGPShowExtension.V_PGP_Show"].toLowerCase():"true"===M["ro.pgpshowextension.v_pgp_show"].toLowerCase(),I.instances.push({id:M.resourceid,value:Q,type:"hideshow"}),C.pgpOnInst++):(Q=M["bo.PGPShowExtension.V_PGP_Show"]?"true"===M["bo.PGPShowExtension.V_PGP_Show"].toLowerCase():"true"===M["bo.pgpshowextension.v_pgp_show"].toLowerCase(),I.references.push({id:M.resourceid,value:Q,type:"hideshow"}),C.pgpOnRef++);if(M["ro.PGPColorExtension.V_PGP_ColorRGB.Asstring"]||M["bo.PGPColorExtension.V_PGP_ColorRGB.Asstring"]||M["ro.pgpcolorextension.v_pgp_colorrgb.asstring"]||M["bo.pgpcolorextension.v_pgp_colorrgb.asstring"])if(M["ro.PGPColorExtension.V_PGP_ColorRGB.Asstring"]||M["ro.pgpcolorextension.v_pgp_colorrgb.asstring"])M["ro.PGPColorExtension.V_PGP_ColorRGB.Asstring"]?(q=M["ro.PGPColorExtension.V_PGP_ColorRGB.Asstring"],X=parseInt(M["ro.PGPInheritanceExtension.V_PGP_Inheritance"])):(q=M["ro.pgpcolorextension.v_pgp_colorrgb.asstring"],X=parseInt(M["ro.pgpinheritanceextension.v_pgp_inheritance"])),I.instances.push({id:M.resourceid,value:q,type:"color",inheritance:X}),C.pgpOnInst++;else M["bo.PGPColorExtension.V_PGP_ColorRGB.Asstring"]?(K=M["bo.PGPColorExtension.V_PGP_ColorRGB.Asstring"],Z=parseInt(M["bo.PGPInheritanceExtension.V_PGP_Inheritance"])):(K=M["bo.pgpcolorextension.v_pgp_colorrgb.asstring"],Z=parseInt(M["bo.pgpinheritanceextension.v_pgp_inheritance"])),I.references.push({id:M.resourceid,value:K,type:"color",inheritance:Z}),C.pgpOnRef++;if(M["ro.PGPOpacityExtension.V_PGP_Opacity"]||M["bo.PGPOpacityExtension.V_PGP_Opacity"]||M["ro.pgpopacityextension.v_pgp_opacity"]||M["bo.pgpopacityextension.v_pgp_opacity"])if(M["ro.PGPOpacityExtension.V_PGP_Opacity"]||M["ro.pgpopacityextension.v_pgp_opacity"])M["ro.PGPOpacityExtension.V_PGP_Opacity"]?(J=M["ro.PGPOpacityExtension.V_PGP_Opacity"],$=parseInt(M["ro.PGPInheritanceExtension.V_PGP_Inheritance"])):(J=M["ro.pgpopacityextension.v_pgp_opacity"],$=parseInt(M["ro.pgpinheritanceextension.v_pgp_inheritance"])),I.instances.push({id:M.resourceid,value:J,type:"opacity",inheritance:$}),C.pgpOnInst++;else M["bo.PGPOpacityExtension.V_PGP_Opacity"]?(Y=M["bo.PGPOpacityExtension.V_PGP_Opacity"],ee=parseInt(M["bo.PGPInheritanceExtension.V_PGP_Inheritance"])):(Y=M["bo.pgpopacityextension.v_pgp_opacity"],ee=parseInt(M["bo.pgpinheritanceextension.v_pgp_inheritance"])),I.references.push({id:M.resourceid,value:Y,type:"opacity",inheritance:ee}),C.pgpOnRef++;if((M["ro.PGPInheritanceExtension.V_PGP_Inheritance"]||M["bo.PGPInheritanceExtension.V_PGP_Inheritance"]||M["ro.pgpinheritanceextension.v_pgp_inheritance"]||M["bo.pgpinheritanceextension.v_pgp_inheritance"])&&!(M["ro.PGPColorExtension.V_PGP_ColorRGB.Asstring"]||M["bo.PGPColorExtension.V_PGP_ColorRGB.Asstring"]||M["ro.pgpcolorextension.v_pgp_colorrgb.asstring"]||M["bo.pgpcolorextension.v_pgp_colorrgb.asstring"]||M["ro.PGPOpacityExtension.V_PGP_Opacity"]||M["bo.PGPOpacityExtension.V_PGP_Opacity"]||M["ro.pgpopacityextension.v_pgp_opacity"]||M["bo.pgpopacityextension.v_pgp_opacity"]))if(M["ro.PGPInheritanceExtension.V_PGP_Inheritance"]||M["ro.pgpinheritanceextension.v_pgp_inheritance"])$=M["ro.PGPInheritanceExtension.V_PGP_Inheritance"]?parseInt(M["ro.PGPInheritanceExtension.V_PGP_Inheritance"]):parseInt(M["ro.pgpinheritanceextension.v_pgp_inheritance"]),I.instances.push({id:M.resourceid,value:$,type:"inheritance",inheritance:$}),C.pgpOnInst++;else ee=M["bo.PGPInheritanceExtension.V_PGP_Inheritance"]?parseInt(M["bo.PGPInheritanceExtension.V_PGP_Inheritance"]):parseInt(M["bo.pgpinheritanceextension.v_pgp_inheritance"]),I.references.push({id:M.resourceid,value:ee,type:"inheritance",inheritance:ee}),C.pgpOnRef++;if("ds6w:Document"===M["ds6w:globaltype"]||"ds6w:Document"===M["ds6w:globalType"]){u.push(M.resourceid),g.push(M.resourceid);var te=null,ie=null;if("thumbnail"===i.streamToLoad&&M.thumbnail_3d?(E=M.thumbnail_3d,te=s.RepType.pr,ie=M["3dthbwms"],this.nbThbLoaded++):(E=M.cgr,te=s.RepType.av1,ie=M.cgrwms,this.nbCgrLoaded++),o.isCloud()&&(ie=M.cgrwms),this.isRegistered(M.resourceid)){var oe=this.getLoadedStream(M.resourceid);i.enforceStreamSwitch&&i.streamToLoad!==oe&&this._OOCManager.switchRepresentation(M.resourceid,{url:E,type:te})}else{if(f.push(M.resourceid),M.boundingbox)V=(se=this._parseBoundingElements(M.boundingbox,E)).boundingBox,N=se.boundingSphere;if(void 0!==M["bo.vpmpointcloudidentifierext.v_pointcloudidentifier"]){var ne="string"==typeof M["bo.vpmpointcloudidentifierext.v_pointcloudidentifier"]?JSON.parse(M["bo.vpmpointcloudidentifierext.v_pointcloudidentifier"]):M["bo.vpmpointcloudidentifierext.v_pointcloudidentifier"];this._OOCManager.registerReference(M.resourceid,{handlerType:"tileSet",tileSet:{sourceId:ne.serviceId,resourceId:ne.objectId}})}else!E&&N&&(N.radius=0,V=void 0),this._OOCManager.registerReference(M.resourceid,{handlerType:"repRef",boundingBox:V,boundingSphere:N,url:E,type:te,wms:ie,serviceId:i.serviceId});this._OOCManager.setUserData(M.resourceid,{type:M["ds6w:type"]}),a&&this._repList.push({id:M.resourceid,stamp:new Date(Date.now()),parsingID:D}),(M.thumbnail_3d||M.cgr)&&C.nbNewUrl++,C.nbNewRep++}void 0!==i.meshInRAM&&(!0===i.meshInRAM?this.lockRepresentationMeshInRAM(M.resourceid):this.unlockRepresentationMeshInRAM(M.resourceid)),i.forceLoad&&v.push(M.resourceid),(M.thumbnail_3d||M.cgr)&&C.nbUrl++,C.nbRep++}else if("ds6w:Part"===M["ds6w:globaltype"]||"ds6w:Part"===M["ds6w:globalType"]){if(g.push(M.resourceid),!this.isRegistered(M.resourceid)){var se;if(M.boundingbox)V=(se=this._parseBoundingElements(M.boundingbox,!1)).boundingBox,N=se.boundingSphere;this._OOCManager.registerReference(M.resourceid,{handlerType:"ref",boundingBox:V,boundingSphere:N,url:null,loadModelOptions:null,serviceId:i.serviceId}),this._OOCManager.setUserData(M.resourceid,{type:M["ds6w:type"]}),C.nbNewRef++}i.forceLoad&&v.push(M.resourceid),C.nbRef++}else if("ds6w:Instance"===M["ds6w:globaltype"]||"ds6w:Instance"===M["ds6w:globalType"]||M.from&&M.to){if(_.push(M.resourceid),!this.isRegistered(M.resourceid)&&void 0!==M.from&&void 0!==M.to&&this.isRegistered(M.from)&&this.isRegistered(M.to)){var re=this._parseMatrix(M.matrixtxt);this._OOCManager.addChild(M.from,M.to,{matrix:re,instanceId:M.resourceid}),M["ds6w:type"]&&this._OOCManager.setUserData(M.resourceid,{type:M["ds6w:type"]}),C.nbNewInst++}else this.isRegistered(M.from)?this.isRegistered(M.to)||console.log("Unknown to object : "+M.to):console.log("Unknown from object : "+M.from);C.nbInst++}}if(!0===T&&n.computeMaterials({rootId:i.rootIds[0]}),"addRoot"===i.intent&&(void 0===M["ds6wg:xcadorientationext.v_worldorientation"]&&void 0===M["ds6wg:XCADOrientationExt.V_WorldOrientation"]||(p=void 0!==M["ds6wg:xcadorientationext.v_worldorientation"]?parseInt(M["ds6wg:xcadorientationext.v_worldorientation"]):parseInt(M["ds6wg:XCADOrientationExt.V_WorldOrientation"])),-1!==i.rootIds.indexOf(M.resourceid)&&!this.getRoot({id:M.resourceid}))){var ae=this._OOCManager.addRoot(M.resourceid,{handlerType:"ds6w:Document"===M["ds6w:globaltype"]||"ds6w:Document"===M["ds6w:globalType"]?"repRef":"ref",boundingBox:V,boundingSphere:N,elasticLoading:i.elasticLoadingGranted});this._OOCManager.addSceneGraphLock(M.resourceid),this._rootIndex[M.resourceid]={occId:ae,setSequenceFilter:function(e){this._sequenceFilter=e},setConfigFilter:function(e){this._configFilter=e},setCVFilterQuery:function(e){this._CVFilterQuery=e},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(e,t,i){var o="V1"===i?{V1:{}}:{V2:{}},n=null;if(t&&t.GetFilterSpec){var s=t.GetFilterSpec(e,o);s&&(n=s.CVQuery3D)}return n}.bind(this,M.resourceid)}}i.extraAttribute&&(m[M.resourceid]||(m[M.resourceid]={},M[i.extraAttribute]&&(m[M.resourceid][i.extraAttribute]=M[i.extraAttribute])))}if("addRoot"===i.intent&&!0===i.reframe){var le=null;if(i.partialOpenPath){var de=this.getWorldMatrix(i.partialOpenPath);(le=this.getReferenceBoundingSphere(i.partialOpenPath[i.partialOpenPath.length-1]))?de.multiplyVector3(le.center):le=this.getReferenceBoundingSphere(i.partialOpenPath[0])}else le=this.getReferenceBoundingSphere(i.rootIds[0]);i.callbacks.onReframe({BS:le,rootBS:null!==le})}this._OOCManager.endInstRefGraphTransaction(),i.forceLoad&&v.length&&this.lockNodes({ids:v}),this.parsingProbe.end(),delete this.parsingProbe;var he=new Date,ce=he-O;ce/=1e3,C.timing=ce+"s",this.statProb=e.createProbe(JSON.stringify(C)),this.statProb.end(),delete this.statProb,this.publish({event:"parsingComplete",data:{timing:he-O,infos:C}}),i.json=null,delete i.json,this._parsingRunning=!1,u.length&&i.extraAttribute&&this.publish({event:"colorOverridePostProcess",data:{leavesToColorize:u,nodesToColorize:g,instancesToColorize:_,hashMap:m}}),this.publish({event:"onUrlLoaded",data:{nbCgrLoaded:this.nbCgrLoaded,nbThbLoaded:this.nbThbLoaded}}),f.length&&r.publish({event:"newNodes",data:{newNodes:f}}),(I.references.length||I.instances.length||I.occurrences.length)&&this.publish({event:"PGPPostProcess",data:I}),S.length&&this.publish({event:"flexibleAssemblyReceived",data:{fa:S,rootId:i.rootIds[0]}}),0===c&&P()},_buildR2VFromJSON:function(e){var t;e.objectId;if(this._registerTileSet(e.objectId,e.serviceId,e.objectType),"replaceRoot"===e.intent){if(!e.fromId)return void console.error("No fromId defined");let i=function(){e.callbacks.onComplete()}.bind(this),o=function(){e.callbacks.onRootRemoved()}.bind(this),n=function(){var t=this.getContentTypes(e.objectId),i=this.getReferenceBoundingSphere(e.objectId);e.callbacks.onRootLoaded({contentTypes:t,BS:i,rootBS:!0,reframe:!1,rootPhID:e.objectId})}.bind(this),s=this.getRootIndex()[e.fromId].occId;t=this.replaceTileSetRoot(s,e.objectId,{removeFromRoot:!0,userRequest360:!0,onRemovedCB:o,onLoadedCB:n,onTransitionCompleteCB:i}),this._addRootIndex(e.objectId,t)}else t=this._OOCManager.addRoot(e.objectId,{onLoadedCB:function(e,t){e({BS:this.getReferenceBoundingSphere(t),rootBS:!0,contentTypes:this.getContentTypes(t)})}.bind(this,e.callbacks.onRootLoaded)}),this._addRootIndex(e.objectId,t),e.callbacks.onComplete()},_parseBoundingElements:function(e,t){var o=new i.Box3(new i.Vector3(parseFloat(e.min[0]),parseFloat(e.min[1]),parseFloat(e.min[2])),new i.Vector3(parseFloat(e.max[0]),parseFloat(e.max[1]),parseFloat(e.max[2]))),n=o?o.getBoundingSphere():null;return this._isValidBBox(e)||(t?(n=null,o=null):(n.radius=0,o=void 0)),{boundingBox:o,boundingSphere:n}},_isValidBBox:function(e){var t=!0;return(!e||!Array.isArray(e.min)||!Array.isArray(e.max)||parseFloat(e.max[0])<parseFloat(e.min[0])||parseFloat(e.max[1])<parseFloat(e.min[1])||parseFloat(e.max[2])<parseFloat(e.min[2]))&&(t=!1),t},_parseMatrix:function(e){var t=null;if(void 0!==e&&""!==e&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==e&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==e&&"1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"!==e){t=new i.Matrix4;var o=e.split(/[,]/);t.elements[0]=parseFloat(o[0]),t.elements[1]=parseFloat(o[1]),t.elements[2]=parseFloat(o[2]),t.elements[4]=parseFloat(o[3]),t.elements[5]=parseFloat(o[4]),t.elements[6]=parseFloat(o[5]),t.elements[8]=parseFloat(o[6]),t.elements[9]=parseFloat(o[7]),t.elements[10]=parseFloat(o[8]),t.elements[12]=parseFloat(o[9]),t.elements[13]=parseFloat(o[10]),t.elements[14]=parseFloat(o[11])}return t}}}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/ENOPAD3DViewer/views/PAD3DVolumeRobot",["UWA/Class","DS/Robot/FreeRobot","DS/Ruler/Ruler","DS/Visualization/ThreeJS_DS","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/Visualization/PathElement"],function(e,t,i,o,n,s,r){"use strict";return e.extend({init:function(e){this._window=e.window,this._sceneGraph=e.sceneGraph,this._viewer=e.viewer,this._modelEvent=new n,this._robot=new t("robotVolumeQuery",this._viewer,!0);var o=new r([this._sceneGraph,e.target]);this._robot.setTarget(o),this._sceneGraph.addChild(this._robot),this._ruler=new i(this._window,{offset:95}),this._ruler.subscribe("RulerManipulate",function(e){onRulerValueModified(e)}),s.addEvent(this._viewer.canvas,"onMiddleMouseUp",this._onLocalTransfo),s.addEvent(this._viewer.canvas,"onMiddleMouseDown",this._onLocalTransfo)},setTarget:function(e){this._robot.setTarget(e)},updateRobotFromMatrix:function(e){this._ruler.initOrigin=(new o.Vector3).getPositionFromMatrix(e),this._ruler.origin=this._ruler.initOrigin,this._robot.updateCenterPosition(this._ruler.initOrigin);var t=new o.Vector3(e.elements[0],e.elements[1],e.elements[2]).normalize(),i=new o.Vector3(e.elements[4],e.elements[5],e.elements[6]).normalize(),n=new o.Vector3(e.elements[8],e.elements[9],e.elements[10]).normalize();this._robot.updateAxis(t,i,n),this._robot.setMatrix(e),this._ruler.direction=null,this._ruler.value=0},setVisibility:function(e){this._robot.setVisibility(e),1==e?(s.addEvent(this._viewer.canvas,"onMiddleMouseUp",this._onLocalTransfo),s.addEvent(this._viewer.canvas,"onMiddleMouseDown",this._onLocalTransfo)):(this._ruler.setVisibleFlag(!1),s.removeEvent(this._viewer.canvas,"onMiddleMouseUp",this._onLocalTransfo),s.removeEvent(this._viewer.canvas,"onMiddleMouseDown",this._onLocalTransfo))}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerFilterDropObjectsCmd",["i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ApplicationFrame/Command","DS/PADUtils/PADSession","DS/PADUtils/PADContext","DS/PADUtils/views/PADAlert","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n,s,r){"use strict";return t.extend({context:o.get(),init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!1})},execute:function(e,t,o){i.isAuthoring()?this.context.getController()._onFilterInAuthoring():(require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerFilterDropObjectsCmd"}),i.trackPageEvent()}),require(["DS/PADUtils/PADTypesMgt"],function(i){var n=this;i.retrieveAuthorizedObjects({notifPerObjects:!0,displayNotif:!1,unserializedData:e,callback:function(i){i.authorized_objects.length<=1?n._handler(i,t,o):n._multiHandler(e,t,o)},version:"2.0"})}.bind(this)))},_handler:function(t,o,a){var l=void 0===o?void 0===a||!a:!o,d=t.authorizedWithKind.Product?t.authorizedWithKind.Product.length:0;if(d+=t.authorizedWithKind.Filter?t.authorizedWithKind.Filter.length:0,t.authorized_objects&&0===t.authorized_objects.length||0===d);else{var h=this.context.subscribe({event:"onRootAdded"},function(n){this.context.unsubscribe(h),i.isAuthoring()?(this.context.getController()._disableFilterWaiting({rootIds:[n.id]}),this.context.displayNotification({msg:e.noFilterOnAuthoring,eventID:"warning"})):1===t.authorized_objects.length&&n.id&&!0!==o&&this._callDefineFilter(n.id)}.bind(this)),c=this.context.subscribe({event:"onRootAlreadyExisting"},function(e){this.context.unsubscribe(c),1===t.authorized_objects.length&&e.id&&!0!==o&&this._callDefineFilter(e.id)}.bind(this)),p=this.context.getRoots(),u=this;s.multiTenantMgt(t.authorized_objects,p,function(e){if(e.isMultiTenant)e.isMultiTenant&&e.invalidTenant;else{if(t.authorized_objects&&t.authorizedWithKind.Product&&t.authorizedWithKind.Product.length)for(var i=0;i<t.authorizedWithKind.Product.length;++i)u.context.addRoots({objects:[{path:[t.authorizedWithKind.Product[i].objectId]}],loadWithFilter:1===t.authorized_objects.length,tenant:s.getPlatformId()},l),1===t.authorized_objects.length&&(u.context._filterPanelOpen=!0,u.context._filterRootIds=[t.authorizedWithKind.Product[i].objectId]);t.authorizedWithKind.Filter&&t.authorizedWithKind.Filter.length&&u.context.getController()._BIProxy.retrieveFilters({filterObjects:t.authorizedWithKind.Filter,fromDropOnFilter:!0,callback:function(e){for(var i=function(e,i){e?(u.context.addRoots({objects:[{path:[e],filterId:i}],loadWithFilter:!0,tenant:s.getPlatformId()},l),u.context._filterPanelOpen=!0,u.context._filterRootIds=[e]):1===t.authorized_objects.length&&!0!==o&&u._callDefineFilter(t.authorized_objects[0].objectId)}.bind(u),a=u.context.getController().getRoots(),d=0;d<e.success.length;++d)if(0===a.length)i(e.success[d].rootId,e.success[d].filterId);else for(var h=0;h<a.length;++h)e.success[d].rootId!==r.getNodeID(a[h])?i(e.success[d].rootId,e.success[d].filterId):u.context.getController().publish({event:"onRootAlreadyExisting"});if(e.failure.length)for(var c=0;c<e.failure.length;c++){var p={msg:e.failure[c].msg,eventID:e.failure[c].eventID};n.displayNotification(p)}}.bind(u)})}})}},_multiHandler:function(e,t,i){var o=void 0===t?void 0===i||!i:!t;this.context.addRootNodesFromContent({json3DXContent:e,inContext:!0,dispatch:o})},_callDefineFilter:function(e){var t=this;require(["DS/ApplicationFrame/CommandsManager"],function(i){var o=i.getCommand("DefineFilterHdr",this.context.getCommandContext());o?(o.setAppParams({widgetId:s.getWidgetId(),appId:s.getSharedId()}),o.setOpenFilterNow(e),o.begin(),t.context._filterPanelOpen=!0,t.context._filterRootIds=[e]):this.context&&this.context._executeCommand&&this.context._executeCommand({handlerId:"ENO3DDefineFilterCmd",args:{objectId:e}})}.bind(this))}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd",["UWA/Core","DS/CoreEvents/Events","DS/ApplicationFrame/Command","DS/Logger/Logger","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n,s,r,a,l,d,h,c,p){"use strict";var u=i.extend({init:function(e){this._logger=o.getLogger(u),this._parent(e,{isAsynchronous:!0,isEnabled:!0}),this._labelsVisibility=!1,this._context=l.get(e.context)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerLevelSelectorCmd"}),i.trackPageEvent()}),this._subscribeToEvent();var e=s.get();if(1===e.length){var t=e[0].pathElement,i=e[0].event;this._levelSelectorContext=e[0].pathElement.clone(),this._context.getFrameWindow().getContextualUIManager().getContextualBar().hide();var o=[],l={positionX:i?i.currentPosition.x+75:this._context.elements.view_container.offsetWidth/2,positionY:i?i.currentPosition.y-75:this._context.elements.view_container.offsetHeight/2,uiFrame:this._context.elements.view_container,getLevels:function(e){for(var n=[],s=t;s;){if(p.isPLMNode(s.externalPath[s.externalPath.length-1])&&(p.isReference(s.externalPath[s.externalPath.length-1])||p.is3DLeaf(s.externalPath[s.externalPath.length-1]))){var r=s.getLastElement(!0),a=p.getBIColor(r);null!==a?o.push({pathElement:s,canvasColor:a,event:i}):o.push({pathElement:s,event:i}),n.push(p.getNodeID(s.getLastElement(!0)))}s=s.getParentPath()}if(this._labelsVisibility){var l=["ds6w:label","type_icon_url"],d="";if(this._context.getController().is3DLeafColorizeActivated()){d=this._context.getController().getBIColorMap().predicate;l.push(d)}this._context.getController().getAttributes({ids:n,attributes:l,callbacks:{onComplete:function(t,i){for(var n=0;n<o.length;++n){var s=o[n],r=p.getNodeID(s.pathElement.getLastElement(!0));if(i[r]&&(s.name=i[r]["ds6w:label"],s.icon=i[r].type_icon_url,this._context.getController().is3DLeafColorizeActivated()&&""!==t)){var a=i[r][t];s.canvasColor=this._context.getController().getColorValueForPredicate(a,this._context.getController().getBIColorMap().predicateKind)}}e(o)}.bind(this,d),onFailure:function(t){console.error("Level selector command: The getAttributes call failed.",t),e(o)}}})}return o}.bind(this),onHover:function(e){r.empty(),a.empty(),e.event=i,r.add(e)}.bind(this),onLeave:function(e){r.empty(),a.empty(),r.add({pathElement:this._levelSelectorContext,event:i})}.bind(this),onSelect:function(e){r.empty(),s.empty(),e.event=i,r.add(e),s.add(e),this.end()}.bind(this)};n.createView(l)}},endExecute:function(){this._unsubscribeToEvent(),n.destroyView()},displayLabels:function(e){this._labelsVisibility=e},_subscribeToEvent:function(){this._emptyCSOToken=s.onEmpty(this.end.bind(this)),this._rootRemovedToken=this._context.subscribe({event:"onRootRemoved"},this.end.bind(this)),this._rootAddedToken=this._context.subscribe({event:"onRootAdded"},this.end.bind(this)),this._modelUpdatedToken=this._context.subscribe({event:"onModelUpdated"},this.end.bind(this)),this._modelUpdatedToken=this._context.subscribe({event:"on3DLeafUnColorize"},function(){this.endExecute()}.bind(this))},_unsubscribeToEvent:function(){s.unsubscribe(this._emptyCSOToken),this._context&&(this._context.unsubscribe(this._rootRemovedToken),this._context.unsubscribe(this._rootAddedToken),this._context.unsubscribe(this._modelUpdatedToken))}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd",u)}),define("DS/ENOPAD3DViewer/views/PADLayerZOIView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/ENOPAD3DViewer/views/PADLayerLegend","DS/WebappsUtils/WebappsUtils"],function(e,t,i,o,n,s,r,a,l){"use strict";function d(e){this.options=e||{},this.elements={},this._nbChildren=0,this._elementSize=39,this._tokensXSO=[],this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,cellActivationFeedback:"row",rowSelection:"single",columnSelection:"none",cellSelection:"none",columns:[{dataIndex:"hidden",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:l.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:l.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}}},this._mdlEvts=new r,this._buildContent()}return d.prototype.getHeader=function(){return n.zoiLayer.title},d.prototype.getIcon=function(){return s.getSetting("newLayerView")?{iconPath:l.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_ZOI.png")}:void 0},d.prototype.render=function(){return this.elements.container},d.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container");var n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions);n.layout=new o(this.options.dgvLayoutOptions);var s=this.options.dgv=new i(n);this.options.model=new t,s.treeDocument=this.options.model,this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),s.getContent().addClassName("PAD3DLayerDefaultView-dgv"),s.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),s.onReady(function(){s.addEventListener("click",this._cellClicked.bind(this))}.bind(this)),this.elements.container.appendChild(this.options.dgv.getContent())},d.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},d.prototype.selectItemIdx=function(e){this.options.dgv.setActiveCell(0);var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},d.prototype.addChild=function(e){this.options.model.addChild(e),this._nbChildren++},d.prototype.removeChild=function(e){this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:d.layerName}})},d.prototype.getModelEvents=function(){return this._mdlEvts},d.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility()}},d.layerName="zoi",d}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerOpenAppCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n){return e.extend({_appID:null,_context:null,init:function(e){if(this._parent(e,{isAsynchronous:!0,mode:"shared"}),this._context=i.get(),e.arguments.length)for(var n=0;n<e.arguments.length;n++){var s=e.arguments[n];"APPID"===s.ID&&(this._appID=s.Value)}!0===t.getSetting("enopad3dviewer_lightNodeModel")&&(o.onPostAdd(function(){this._isLargeDataSelected()?this.disable():this.enable()}.bind(this)),o.onEmpty(function(){this.disable()}.bind(this)),o.onRemove(function(){this._isLargeDataSelected()?this.disable():this.enable()}.bind(this)),this._isLargeDataSelected()?this.disable():this.enable())},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerOpenAppCmd-"+this._appID}),i.trackPageEvent()}.bind(this)),require(["DS/PADUtils/PADUtilsServices","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/Visualization/SceneGraphUtils","DS/i3DXCompassServices/i3DXCompassPubSub"],function(e,o,n,s,r,a){var l=i.get(),d=[],h={},c=[],p=[],u=[],g=o.get(),_=l.getController()._model.getRootBag(),f=[],v={},m={version:"1.1",paths:d,attributes:h};if(l.getRoots().forEach(function(e){f.push(n.getNodeID(e))}),t.getSetting("authorizeChangeControl")){var b=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");v.changeControl=b.get()}for(var y={},P=0;P<g.length;P++){var D={},I=g[P];if(n.isAModelPath(I.pathElement)){var S=I.pathElement,C=S.getLastElement(!0),w=n.getNodeID(C);if(n.isTileSetNode(C))l.streamPathWithType(I.pathElement,d,h);else if(-1!==f.indexOf(w)&&d.push([w]),!n.is3DLeaf(C)&&w){if(!0===t.getSetting("enopad3dviewer_lightNodeModel")){var x=l.getController().createReferenceIterator(w);this._traverseOOCGraphToGetReps(x,y,D);var O=Object.keys(D);l.getController().lockNodes({ids:O})}if(n.isPLMNode(C)){var A={};C.traverse(function(e){if(n.is3DLeaf(e)){var t=n.getNodeID(e);if(t&&!A[t])A[t]=!0,r.buildPathesLeadingToNode(e,_).forEach(function(e){S.isAParentOf(e)&&c.push(e)})}})}else{for(;!n.is3DLeaf(C);)C=(S=S.getParentPath()).getLastElement(!0);c.push(S)}c.forEach(function(e){l._hideShowController.isVisible(e)||u.push(n.getNodeID(e.getLastElement(!0))),l.streamPathWithType(e,d,h)})}else l.streamPathWithType(I.pathElement,d,h)}}!0===t.getSetting("enopad3dviewer_lightNodeModel")&&l.getController().unlockNodes({ids:Object.keys(y)}),d&&d.forEach(function(e){p.push(e[e.length-1])}),l.setTypesForOFW({nodes2Open:p,hiddenNodes:u,selectedPaths:m},function(t){var i=l.getViewpoint(),o=s.buildViewPoint(i);null!==o&&t.viewpoint.push(o),v.changeControl&&(t.workUnder=v.changeControl),t.appId=this._appID;var n=JSON.stringify(t),r={appId:this._appID,widgetId:e.getWidgetId(),fileName:"-file",fileContent:n};a.publish("launchApp",r),this.end()}.bind(this))}.bind(this))},_traverseOOCGraphToGetReps:function(e,t,i){if(e)if(e.isRepRef())t[e.getReferenceId()]||(t[e.getReferenceId()]=!0,i[e.getReferenceId()]=!0);else for(var o=e.getChildren(),n=0;n<o.length;n++)this._traverseOOCGraphToGetReps(o[n].getReferenceIterator(),t,i)},_isLargeDataSelected:function(){for(var e=o.get(),t=!1,i=!1,s=this._context.getController(),r=0;r<e.length;r++){var a=e[r].pathElement;if(n.isAModelPath(a))for(var l=0;l<a.externalPath.length;l++)if("RootBag"===a.externalPath[l].name&&l+1<a.externalPath.length){var d=a.externalPath[l+1];s.isLargeDataStructure(n.getNodeID(d))&&(t=!0),n.isTileSetNode(d)&&(i=!0);break}if(t||i)break}return t||i}})}),define("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController",["UWA/Core","UWA/Controls/Abstract","DS/CoreEvents/ModelEvents","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/Visualization/IdPath","DS/PADUtils/PADSettingsMgt"],function(e,t,i,o,n,s,r,a,l){"use strict";var d=t.extend({name:"PAD3DViewerHideShowController",init:function(e){this._parent(e),this._commandProxy=null,this._overloadedPaths=[],this._hiddenPaths=new Map,this._shownPaths=new Map,this._sceneGraphOverrideSet=null,this._context=e.context,this._viewer=e.viewer,this.createOverrideSet(),this._modelEvents=new i,this._initInterwidgetCom(),l.getSetting("enopad3dviewer_lightNodeModel")&&this._context.getController().subscribe({event:"onRootRemoved"},function(e){this.clearOverrides(e.id)}.bind(this))},destroy:function(){delete this._context,this._viewer&&delete this._viewer,delete this._modelEvents,delete this._hiddenPaths,delete this._shownPaths,this._commandProxy&&(this._commandProxy.destroy(),delete this._commandProxy)},publish:function(e){this.getModelEvents().publish(e)},subscribe:function(e,t){return this.getModelEvents().subscribe(e,t)},unsubscribe:function(e){this.getModelEvents().unsubscribe(e)},getModelEvents:function(){return this._modelEvents},_initInterwidgetCom:function(){var e=this;this._context.isInterwidgetComAvailable()&&require(["DS/PADUtils/PADCommandProxy"],function(t){e._commandProxy=t.create({events:{onShow:function(t){t.action="Show",l.getSetting("enopad3dviewer_lightNodeModel")?e._onShowForOOC(t):e._onHideShow(t)},onHide:function(t){t.action="Hide",l.getSetting("enopad3dviewer_lightNodeModel")?e._onHideForOOC(t):e._onHideShow(t)}}})})},hide:function(e){if("object"==typeof e){var t=0;e.withLock=void 0===e.withLock||e.withLock;var i=[];if(e.paths&&this._sceneGraphOverrideSet){e.paths.forEach(function(e){var i=e.clone();if(n.isAModelPath(i)){for(;i&&!n.isModelNode(i.getLastElement(!0));)i=i.getParentPath();if(i)if(l.getSetting("enopad3dviewer_lightNodeModel")){let e=this._context.getController().buildArrayFromPath(i);var o=new a([this._context.getController().getRootBagId()].concat(e));(s=this._sceneGraphOverrideSet.getUniqueOverrideFromIdPath(o))?(s.setVisibility(!1),this._hiddenPaths.set(s.id,e),this._shownPaths.delete(s.id)):(s=this._sceneGraphOverrideSet.createIdPathOverride(o))&&(s.setVisibility(!1),this._hiddenPaths.set(s.id,e),this._shownPaths.delete(s.id))}else{var s;(s=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(i))&&null!==s||(s=this._sceneGraphOverrideSet.createOverride(i)),s.setVisibility(!1)}t++}}.bind(this));var o=this._viewer.getSceneGraphOverrideSetManager();o&&(o.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),o.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)),t&&setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this)),e.dispatch&&e.paths.forEach(function(e){if(n.isAModelPath(e)){var t=this._context.streamPath(e);i.push(t)}}.bind(this)),this.publish({event:"onHide",data:e})}else e.idPaths&&this._sceneGraphOverrideSet&&(this._onHideForOOC({paths:e.idPaths}),i=e.idPaths);e.dispatch&&this._commandProxy&&this._commandProxy.hide({paths:i})}else console.error("Incorrect parameters type in hide()")},_onHideForOOC:function(e){if(l.getSetting("enopad3dviewer_lightNodeModel")){if("object"!=typeof e&&!Array.isArray(e.paths))return void console.error("No path to hide/show defined");for(var t=0;t<e.paths.length;t++){var i=new a([this._context.getController().getRootBagId()].concat(e.paths[t])),o=this._sceneGraphOverrideSet.getUniqueOverrideFromIdPath(i);o?(o.setVisibility(!1),this._hiddenPaths.set(o.id,e.paths[t]),this._shownPaths.delete(o.id)):(o=this._sceneGraphOverrideSet.createIdPathOverride(i))&&(o.setVisibility(!1),this._hiddenPaths.set(o.id,e.paths[t]),this._shownPaths.delete(o.id))}var n=this._viewer.getSceneGraphOverrideSetManager();n&&(n.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),n.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)),setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this)),this.publish({event:"onHide",data:e})}},_onShowForOOC:function(e){if(l.getSetting("enopad3dviewer_lightNodeModel")){if("object"!=typeof e&&!Array.isArray(e.paths))return void console.error("No path to hide/show defined");for(var t=0;t<e.paths.length;t++){var i=new a([this._context.getController().getRootBagId()].concat(e.paths[t])),o=this._sceneGraphOverrideSet.getUniqueOverrideFromIdPath(i);o?(o.setVisibility(!0),this._hiddenPaths.delete(o.id),this._shownPaths.set(o.id,e.paths[t])):(o=this._sceneGraphOverrideSet.createIdPathOverride(i))&&(o.setVisibility(!0),this._hiddenPaths.delete(o.id),this._shownPaths.set(o.id,e.paths[t]))}var n=this._viewer.getSceneGraphOverrideSetManager();n&&(n.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),n.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)),setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this)),this.publish({event:"onShow",data:e})}},show:function(e){if("object"==typeof e){var t=0,i=[];e.withLock=void 0===e.withLock||e.withLock;var o=function(e){if("object"==typeof e){var i=e.clone();if(n.isAModelPath(i)){for(;i&&!n.isModelNode(i.getLastElement(!0));)i=i.getParentPath();if(i){if(l.getSetting("enopad3dviewer_lightNodeModel")){let e=this._context.getController().buildArrayFromPath(i);var o=new a([this._context.getController().getRootBagId()].concat(e));(s=this._sceneGraphOverrideSet.getUniqueOverrideFromIdPath(o))||(s=this._sceneGraphOverrideSet.createIdPathOverride(o)),s.setVisibility(!0),this._hiddenPaths.delete(s.id),this._shownPaths.set(s.id,e)}else{var s;(s=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(i))&&!1===s.getVisibility()?s.setVisibility(!0):s||(s=this._sceneGraphOverrideSet.createOverride(i)).setVisibility(!0)}t++}}}else console.error("Incorrect path type in show().override()")}.bind(this);if(e.paths&&this._sceneGraphOverrideSet){for(var s=0;s<e.paths.length;++s)o(e.paths[s]);var r=this._viewer.getSceneGraphOverrideSetManager();r&&(r.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),r.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)),t&&setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this)),e.dispatch&&e.paths.forEach(function(e){n.isAModelPath(e)&&i.push(this._context.streamPath(e))}.bind(this)),this.publish({event:"onShow",data:e})}else e.idPaths&&this._sceneGraphOverrideSet&&(this._onShowForOOC({paths:e.idPaths}),i=e.idPaths);e.dispatch&&this._commandProxy&&this._commandProxy.show({paths:i})}else console.error("Incorrect parameters type in show()")},createOverrideSet:function(){this._context.isSelectiveLoadingActivated()?this._sceneGraphOverrideSet=new s(this._context.getController().getRootBag(),this._context.getController().getRootBagId(),!0):this._sceneGraphOverrideSet=new s(this._context.getController().getRootBag()),this._viewer.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)},getSGOverrideSet:function(){return this._sceneGraphOverrideSet},resetState:function(){if(l.getSetting("enopad3dviewer_lightNodeModel")){if(this._viewer&&this._exclusiveShowSceneGraphOverrideSet)(e=this._viewer.getSceneGraphOverrideSetManager())&&(e.removeSceneGraphOverrideSet(this._exclusiveShowSceneGraphOverrideSet),delete this._exclusiveShowSceneGraphOverrideSet,this._exclusiveShowSceneGraphOverrideSet=new s(this._context.getController().getRootBag(),this._context.getController().getRootBagId(),!0),e.pushSceneGraphOverrideSet(this._exclusiveShowSceneGraphOverrideSet)),setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this))}else{var e,t=this;if(this._viewer&&this._sceneGraphOverrideSet)(e=this._viewer.getSceneGraphOverrideSetManager())&&(e.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),delete this._sceneGraphOverrideSet,this.createOverrideSet()),setTimeout(function(){t._viewer.render({updateInfinitePlane:!0})})}},resetExclusiveShow:function(){if(l.getSetting("enopad3dviewer_lightNodeModel")&&this._viewer){var e=this._viewer.getSceneGraphOverrideSetManager();e&&(this._exclusiveShowSceneGraphOverrideSet&&(e.removeSceneGraphOverrideSet(this._exclusiveShowSceneGraphOverrideSet),delete this._exclusiveShowSceneGraphOverrideSet),this._exclusiveShowSceneGraphOverrideSet=new s(this._context.getController().getRootBag(),this._context.getController().getRootBagId(),!0),e.pushSceneGraphOverrideSet(this._exclusiveShowSceneGraphOverrideSet),setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this)))}},exclusiveShow:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.paths))throw new Error("No paths to be shown defined");if(l.getSetting("enopad3dviewer_lightNodeModel")){this.resetExclusiveShow();for(var t=this._context.getController().getRoots(),i=[],o=0;o<t.length;o++){var s=n.getNodeID(t[o]);s&&i.push(new a([this._context.getController().getRootBagId(),s]))}if(i.length){var d=this._exclusiveShowSceneGraphOverrideSet.createIdPathOverride({idPathes:i,propagateUntilRepRefs:!0});d&&d.setVisibility(!1)}var h=[];for(o=0;o<e.paths.length;o++)h.push(new a([this._context.getController().getRootBagId()].concat(e.paths[o])));if(h.length){var c=this._exclusiveShowSceneGraphOverrideSet.createIdPathOverride({idPathes:h,propagateUntilRepRefs:!0});c&&c.setVisibility(!0);var p=this._exclusiveShowSceneGraphOverrideSet.createIdPathOverride({idPathes:h,propagateToParents:!0});p&&p.setVisibility(!0)}(g=this._viewer.getSceneGraphOverrideSetManager())&&g.pushSceneGraphOverrideSet(this._exclusiveShowSceneGraphOverrideSet),setTimeout(function(){this._viewer.render({updateInfinitePlane:!0})}.bind(this)),this.publish({event:"onExclusiveShow",data:e})}else{var u=this;u.resetState();var g,_=u._context.getController()._model._nodeIndex,f=Object.getOwnPropertyNames(_),v=u._context.getController()._model.getRootBag();f.forEach(function(e){_[e].is3DLeaf&&_[e].is3DLeaf()&&r.buildPathesLeadingToNode(_[e],v).forEach(function(e){u._sceneGraphOverrideSet.createOverride(e).setVisibility(!1)})}),e.paths.forEach(function(e){if(n.isAModelPath(e)){var t=e.getLastElement(!0);if(t.is3DLeaf&&t.is3DLeaf()){u._sceneGraphOverrideSet.createOverride(e).setVisibility(!0)}else{var i=[],o={};t.traverse(function(t){t.is3DLeaf&&t.is3DLeaf()&&!o[t.getID()]&&(o[t.getID()]=!0,r.buildPathesLeadingToNode(t,v).forEach(function(t){e.isAParentOf(t)&&i.push(t)}))}),i.forEach(function(e){u._sceneGraphOverrideSet.createOverride(e).setVisibility(!0)})}}}),(g=u._viewer.getSceneGraphOverrideSetManager())&&(g.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),g.pushSceneGraphOverrideSet(u._sceneGraphOverrideSet)),setTimeout(function(){u._viewer.render({updateInfinitePlane:!0})}),this.publish({event:"onExclusiveShow",data:e})}},toggleHideShow:function(e){var t=this;if(e.paths){var i=[],o=[];e.paths.forEach(function(e){if(n.isAModelPath(e)){for(;e&&!n.isModelNode(e.getLastElement(!0));)e=e.getParentPath();var s=t._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(e);null===s||s?o.push(e):i.push(e)}}),i.length&&this.show({paths:i,dispatch:e.dispatch,withLock:!0}),o.length&&this.hide({paths:o,dispatch:e.dispatch,withLock:!0})}},_onHideShow:function(e){if("object"==typeof e||Array.isArray(e.paths)){for(var t=[],i=[],o=function(t,o){t.forEach(function(e){if(e.length){var t=this._context.unstreamPath(e);t&&i.push(t)}}.bind(this)),"Hide"===e.action?this.hide({paths:i,dispatch:!1,withLock:o}):"Show"===e.action&&this.show({paths:i,dispatch:!1,withLock:o})}.bind(this),n=0;n<e.paths.length;++n)null===this._context.unstreamPath(e.paths[n])&&t.push(e.paths[n]);0===t.length?o(e.paths,!0):this._context.getController().expand({paths:t,withFrustumFilter:!1,expand_iter:"0",forceLoad:!0,singleAdd:!1,onComplete:function(t){"object"==typeof t?Array.isArray(t.selectedPaths)?o(e.paths,!1):console.error("Incorrect data.selectedPaths type in expand onComplete()"):console.error("Incorrect data type in expand onComplete()")}.bind(this),onFailure:function(){console.warn("Something went wrong when trying to expand those paths.")}},!1,!1)}else console.error("No path to hide/show defined")},isVisible:function(e){var t=!1;return e&&this._viewer&&(t=null===this._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(e)||this._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(e)),t},applyPGP:function(e){var t=this._context.getController().getRootBag();if(e.references&&e.references.length>0){for(var i,o=[],s=[],a=0;a<e.references.length;a++)i=r.buildPathesLeadingToNode(this._context.getController().getNode({id:e.references[a].id}),t),"hideshow"===e.references[a].type?!0===e.references[a].value?s=s.concat(i):o=o.concat(i):this.applyPGPColorOpacity(i,e.references[a].type,e.references[a].value,e.references[a].inheritance);o.length&&this.hide({paths:o,dispatch:!1}),s.length&&this.show({paths:s,dispatch:!1})}if(e.instances&&e.instances.length>0){for(var l,d=[],h=[],c=0;c<e.instances.length;c++){l=r.buildPathesLeadingToNode(this._context.getController().getNode({id:e.instances[c].id}),t);for(var p=0;p<l.length;p++)l[p].addElement(n.getReferences(l[p].getLastElement(!0))[0]);"boolean"==typeof e.instances[c].value?!0===e.instances[c].value?h=h.concat(l):d=d.concat(l):this.applyPGPColorOpacity(l,e.instances[c].type,e.instances[c].value,e.instances[c].inheritance,!0)}d.length&&this.hide({paths:d,dispatch:!1}),h.length&&this.show({paths:h,dispatch:!1})}if(e.occurrences&&e.occurrences.length>0){for(var u,g,_=[],f=[],v=0;v<e.occurrences.length;v++)(g=this._context.unstreamPath(e.occurrences[v].path))&&(u=g.clone(),"boolean"==typeof e.occurrences[v].value?!0===e.occurrences[v].value?f.push(u):_.push(u):this.applyPGPColorOpacity([u],e.occurrences[v].type,e.occurrences[v].value,e.occurrences[v].inheritance));_.length&&this.hide({paths:_,dispatch:!1}),f.length&&this.show({paths:f,dispatch:!1})}var m=this._viewer.getSceneGraphOverrideSetManager();-1===m.getSceneGraphOverrideSetIndex(this._sceneGraphOverrideSet)&&m.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)},applyPGPColorOpacity:function(e,t,i,o,s){if(this._sceneGraphOverrideSet)for(var r,a=function(e){var t=Number(e).toString(16);return 1===t.length?"0"+t:t},l=function(e){if(e){var t=e.getParentPath();if(!t)return;if(!(t=t.getParentPath()))return;var i=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(t);if(i&&i.getPGPInheritance&&i.getPGPInheritance())return i.getPGPInheritance();l(t)}}.bind(this),d=0;d<e.length;d++){var h=e[d].clone();if(n.isAModelPath(h)){for(;h&&!n.isModelNode(h.getLastElement(!0));)h=h.getParentPath();if(h)if("opacity"===t)(r=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(h))&&null!==r||(r=s?this._sceneGraphOverrideSet.createOverride({pathes:[h],pgp:!0,propagateToDirectChildrenOnly:!0}):this._sceneGraphOverrideSet.createOverride({pathes:[h],pgp:!0})),r&&(void 0===o&&(o=r.getPGPInheritance&&r.getPGPInheritance()?r.getPGPInheritance()||o:o||l(h)),"1"===o&&(o=3),r.setPGPInheritance&&r.setPGPInheritance(o),r.setOpacity(Number(i)/255));else if("color"===t){var c;if((r=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(h))&&null!==r||(r=s?this._sceneGraphOverrideSet.createOverride({pathes:[h],pgp:!0,propagateToDirectChildrenOnly:!0}):this._sceneGraphOverrideSet.createOverride({pathes:[h],pgp:!0})),r)if(void 0===o&&(o=r.getPGPInheritance&&r.getPGPInheritance()?r.getPGPInheritance()||o:o||l(h)),r.setPGPInheritance&&r.setPGPInheritance(o),i&&3===(c=i.split(",")).length){var p=(u=c[0],g=c[1],_=c[2],"#"+a(u)+a(g)+a(_));r.setColor(p)}}else"inheritance"===t&&((r=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(h))&&null!==r||(r=this._sceneGraphOverrideSet.createOverride({pathes:[h],pgp:!0})),r&&r.setPGPInheritance&&r.setPGPInheritance(o))}}var u,g,_},clearOverrides:function(e){if(l.getSetting("enopad3dviewer_lightNodeModel")){for(var t=this._sceneGraphOverrideSet.getOverrides(),i=0;i<t.length;i++){var o=t[i],n=o._getIdPathes();if(n)for(var s=0;s<n.length;s++)n[s].getElement(1)===e&&this._sceneGraphOverrideSet.deleteOverride(o);else o._nodeId&&o._nodeId===e&&this._sceneGraphOverrideSet.deleteOverride(o)}this._hiddenPaths.clear(),this._shownPaths.clear()}},getHiddenPathsAsArray:function(){return Array.from(this._hiddenPaths.values())},getShownPathsAsArray:function(){return Array.from(this._shownPaths.values())}});return e.namespace("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController",d)}),define("DS/ENOPAD3DViewer/models/PAD3DLayer",["DS/ENOPAD3DViewer/views/PAD3DLayerView","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/OOCQuickOverrideSet","DS/Visualization/Node3D"],function(e,t,i,o,n,s){"use strict";function r(e){this._view=null,this._node3DBag=null,this._overrideSet=null,this._idPathOverrideSet=null,this._uuid=e.UUID,this._overrideSetId=e.UUID,this._label=e.label,this._viewer=e.viewer,this._controller=e.controller,this._decorationBag=e.decorationBag,this._color=e.color,this._layerGroupView=e.layerGroupView,this._overrideSetManager=e.viewer.getSceneGraphOverrideSetManager(),this._buildView(e),this._buildOverrideSet(e),this._buildNode(e),this._bindEvents()}return r.prototype.getID=function(){return this._uuid},r.prototype.getColor=function(){return this._color},r.prototype.getGroupView=function(){return this._layerGroupView},r.prototype.getOverrideSet=function(){return this._overrideSet},r.prototype.getIdPathOverrideSet=function(){return this._idPathOverrideSet},r.prototype.getOverrideSetID=function(){return this._overrideSetId},r.prototype.isLayerVisible=function(){return this._layerVisibility},r.prototype.getNode3DBag=function(){return this._node3DBag},r.prototype.show=function(){this._addNodeBagToSG(),this._pushOverrideSet(),this._layerVisibility=!0},r.prototype.hide=function(){this._removeNodeBagFromSG(),this._removeOverrideSet(),this._layerVisibility=!1},r.prototype.render=function(){return this._view.render()},r.prototype.destroy=function(){this._removeOverrideSet(),this._removeNodeBagFromSG(),this._view.destroy(),delete this._view,delete this._node3DBag,delete this._uuid,delete this._modelEvents,delete this._overrideSet,delete this._overrideSetManager,delete this._overrideSetId,delete this._controller,delete this._viewer},r.prototype.getModelEvents=function(e){return this._modelEvents},r.prototype.publish=function(e){this.getModelEvents().publish(e)},r.prototype.subscribe=function(e,t){return this.getModelEvents().subscribe(e,t)},r.prototype.unsubscribe=function(e){this.getModelEvents().unsubscribe(e)},r.prototype._buildView=function(){this._view=new e({label:this._label})},r.prototype._buildOverrideSet=function(e){t.getSetting("enopad3dviewer_lightNodeModel")?this._overrideSet=new n(e.controller._model.getOOCManager()):this._overrideSet=new o(e.rootBag),this._pushOverrideSet()},r.prototype.buildIdPathOverrideSet=function(e){this._idPathOverrideSet=new o(e.rootNode,e.rootId),this._pushOverrideSet()},r.prototype._buildNode=function(e){this._node3DBag=new s(e.root),this._addNodeBagToSG()},r.prototype._pushOverrideSet=function(){t.getSetting("enopad3dviewer_lightNodeModel")?this._overrideSet.setActive(!0):this._overrideSetManager&&this._overrideSet&&this._overrideSet.getOverrides().length&&-1===this._overrideSetManager.getSceneGraphOverrideSetIndex(this._overrideSet)&&this._overrideSetManager.pushSceneGraphOverrideSet(this._overrideSet),this._overrideSetManager&&this._idPathOverrideSet&&this._idPathOverrideSet.getOverrides().length&&-1===this._overrideSetManager.getSceneGraphOverrideSetIndex(this._idPathOverrideSet)&&this._overrideSetManager.pushSceneGraphOverrideSet(this._idPathOverrideSet),this._viewer.render()},r.prototype._removeOverrideSet=function(){t.getSetting("enopad3dviewer_lightNodeModel")?this._overrideSet.setActive(!1):this._overrideSetManager&&this._overrideSet&&this._overrideSetManager.removeSceneGraphOverrideSet(this._overrideSet),this._idPathOverrideSet&&this._overrideSetManager.removeSceneGraphOverrideSet(this._idPathOverrideSet),this._viewer.render()},r.prototype._addNodeBagToSG=function(){this._decorationBag.add(this._node3DBag)},r.prototype._removeNodeBagFromSG=function(){this._decorationBag.remove(this._node3DBag)},r.prototype._bindEvents=function(){this._modelEvents=new i,this._view.subscribe({event:"show"},function(){this.show(),this.publish({event:"show",data:{id:this.getID(),layer:this}})}.bind(this)),this._view.subscribe({event:"hide"},function(){this.hide(),this.publish({event:"hide",data:{id:this.getID(),layer:this}})}.bind(this)),this._view.subscribe({event:"delete"},function(){this.publish({event:"delete",data:{id:this.getID(),layer:this}})}.bind(this))},r}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerToggleGeometry",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/Selection/CSOManager","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s,r,a,l){"use strict";var d=t.extend({_quality:null,_CSOTokens:[],_ctxTokens:[],_sessionCBTokens:[],_availableForRole:!1,_VISnVIORetrievedToken:null,init:function(e){if(this._parent(e,{mode:"shared"}),e.arguments.length)for(var t=0;t<e.arguments.length;t++){var o=e.arguments[t];"mode"===o.ID&&(this._quality=o.Value)}this._context=i.get(e.context),this._setCSOCallbacks(),this._checkCloudAvailability(),this._checkSelection(),"optimized"===this._quality&&this._sessionCBTokens.push(r.subscribe({event:"authoringStateModified"},function(){this._checkSelection()}.bind(this))),this._ctxTokens.push(this._context.subscribe({event:"onStreamSwitched"},function(){this._checkSelection()}.bind(this)))},destroy:function(){if(this._VISnVIORetrievedToken&&this._context&&(this._context.unsubscribe(this._VISnVIORetrievedToken),delete this._VISnVIORetrievedToken),this._CSOTokens)for(var e=0;e<this._CSOTokens.length;e++)s.unsubscribe(this._CSOTokens[e]);if(this._sessionCBTokens)for(e=0;e<this._sessionCBTokens.length;e++)r.unsubscribe(this._sessionCBTokens[e]);if(this._context)for(e=0;e<this._ctxTokens.length;e++)this._context.unsubscribe(this._ctxTokens[e]);this._CSOTokens=null,this._sessionCBTokens=null,this._ctxTokens=null,this._context=null},execute:function(){var e=s.get(),t=this._getAllLeaves(e);if(t.length){for(var i=[],o=0;o<t.length;o++)i.push({node:this._context.getController().getNode({id:t[o]}),stream:"optimized"===this._quality?"thumbnail":"cgr"});this._context.getController().switchNodeVisuStreamOnDemand({data:i,callbacks:{onComplete:function(e){if(0!==e.nbUrlLoaded)if("high"===this._quality){var t=e.nbUrlLoaded;e.nbUrlLoaded>1?t+=l.toggleVisuNodeToCGRsSuccess:t+=l.toggleVisuNodeToCGRSuccess,this._context.displayNotification({eventID:"success",msg:t})}else{t=e.nbUrlLoaded;e.nbUrlLoaded>1?t+=l.toggleVisuNodeToThumbnailsSuccess:t+=l.toggleVisuNodeToThumbnailSuccess,this._context.displayNotification({eventID:"success",msg:t})}else 0===e.nbUrlLoaded&&(!0===e.urlNotFound?this._context.displayNotification({eventID:"info",msg:l.toggleVisuNoUrlFound.replace("{visuMode}","optimized"===this._quality?l.toggleVisuOptimizedMaj:l.toggleVisuHighQualityMaj)}):this._context.displayNotification({eventID:"info",msg:l.toggleVisuNothingChanged.replace("{visuMode}","optimized"===this._quality?l.toggleVisuOptimized:l.toggleVisuHighQuality)}))}.bind(this),onFailure:function(){this._context.displayNotification({eventID:"error",msg:l.toggleVisuNodeFailure.replace("{visuMode}","optimized"===this._quality?l.toggleVisuOptimized:l.toggleVisuHighQuality),key:"pad3dViewer-toggle-visu-node-failure"})}.bind(this)}})}},_isAvailable:function(){return("optimized"!==this._quality||!r.determineAuthoredFlag())&&this._availableForRole},_setCSOCallbacks:function(){this._CSOTokens.push(s.onPostAdd(this._checkSelection.bind(this))),this._CSOTokens.push(s.onEmpty(this._checkSelection.bind(this))),this._CSOTokens.push(s.onRemove(this._checkSelection.bind(this)))},_checkCloudAvailability:function(){o.isCloud()?(this._setAvailabilityForRoles(),this._VISnVIORetrievedToken=this._context.subscribe({event:"VISnVIOStatusRetrieved"},this._checkAvailabilityForRoles.bind(this))):this._availableForRole=!0},_checkSelection:function(){if(this._isAvailable()&&this._context){var e=s.get(),t=e.length;if(0===t)this.disable();else if(1===t){var i=this._getAllLeaves(e,2);if(1===i.length){var o=this._context.getController().getNode({id:i[0]});if(o){var n=a.getLoadedStream(o,this._context);"optimized"===this._quality&&"thumbnail"===n?this.disable():"high"===this._quality&&"cgr"===n?this.disable():this.enable()}else this.disable()}else this.enable()}else this.enable()}else this.disable()},_checkAvailabilityForRoles:function(){var e=n.getSetting("enopad3dviewer_roles");if(n.getSetting("enopad3dviewer_VISnVIOStatus"))this._availableForRole=!0;else{this._availableForRole=!1;for(var t=0;t<e.length;t++)if("InternalDS"===e[t].id&&(!e[t].platforms||e[t].platforms&&e[t].platforms.indexOf(o.getPlatformId())>-1)){this._availableForRole=!0;break}}this._checkSelection()},_setAvailabilityForRoles:function(){o.getVISnVIOStatus(function(e){e.hasLicense?(this._availableForRole=!0,this._checkSelection()):o.getGrantedRoles(function(e){this._availableForRole=!1;for(var t=0;t<e.length;t++)if("InternalDS"===e[t].id&&(!e[t].platforms||e[t].platforms&&e[t].platforms.indexOf(o.getPlatformId())>-1)){this._availableForRole=!0;break}this._checkSelection()}.bind(this))}.bind(this))},_getAllLeaves:function(e,t){var i={};function o(e){if(a.is3DLeaf(e)){var t=a.getNodeID(e);i[t]||(i[t]=!0)}}for(var n=0;n<e.length;n++){var s=e[n].pathElement;if(a.isAModelPath(s)){var r=s.getLastElement(!0);if(a.is3DLeaf(r)){var l=a.getNodeID(r);i[l]||(i[l]=!0)}else if(a.isPLMNode(r))r.traverse(o);else{for(;!a.is3DLeaf(r)&&"RootBag"!==r.name;)r=(s=s.getParentPath()).getLastElement(!0);l=a.getNodeID(r);i[l]||(i[l]=!0)}}if(void 0!==t&&Object.keys(i).length>=t)break}return Object.keys(i)}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerToggleGeometry",d)}),define("DS/ENOPAD3DViewer/views/PADLayerRevealView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/CoreEvents/ModelEvents","DS/Controls/Button","DS/Controls/ButtonGroup","DS/Controls/Toggle","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/WebappsUtils/WebappsUtils","DS/Controls/ProgressBar","DS/ENOPAD3DViewer/views/PAD3DLayerKindToolbar"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u){"use strict";function g(e){this.options=e||{},this.elements={},this._nbChildren=0,this._tokensXSO=[],this._elementSize=39,this._clusteringIsEditable=!0,this._progressBar=null,this.options.dgvOptions={defaultColumnDef:{width:"auto",typeRepresentation:"string"},showRowIndexFlag:!1,showRowBorderFlag:!0,showAlternateBackgroundFlag:!1,rowSelection:"single",columnSelection:"none",cellSelection:"none",cellActivationFeedback:"row",selectionBehavior:{canInteractiveMultiselectWithCheckboxClick:!0,canMultiSelect:!0,enableFeedbackForActiveCell:!0,enableShiftSelection:!0,toggle:!1,unselectAllOnEmptyArea:!0},columns:[{dataIndex:"hidden",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,height:"38px",width:"38px",alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?"hide":"show"},getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.hidden?{shortHelp:n.show,updateModel:!1}:{shortHelp:n.hide,updateModel:!1}}},{dataIndex:"clustered",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,typeRepresentation:"string",height:38,width:38,alignment:"center",getCellTypeRepresentation:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.clustered?"clusteringOn":"clusteringOff"},getCellSemantics:function(e){return e.nodeModel&&(!0!==e.nodeModel.options.clusteringEditable&&!1!==e.nodeModel.options.clusteringEditable||(this._clusteringIsEditable=e.nodeModel.options.clusteringEditable)),{disabled:!this._clusteringIsEditable,editableFlag:this._clusteringIsEditable}}.bind(this),getCellTooltip:function(e){if(e.nodeModel)return!0===e.nodeModel.options.grid.clustered?{shortHelp:n.clustering.disable,updateModel:!1}:{shortHelp:n.clustering.activate,updateModel:!1}}},{dataIndex:"colorSquare",typeRepresentation:"color",editableFlag:!0,sortableFlag:!1,resizableFlag:!1,width:5,alignment:"center",editionPolicy:"EditionOnOver",getCellTooltip:function(e){return{shortHelp:n.changePOIGroupColor,updateModel:!1}}},{dataIndex:"tree",typeRepresentation:"string",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,width:"auto"}]},this.options.dgvLayoutOptions={cellHeight:38,rowsHeader:!1,columnsHeader:!1},this.options.typeReps={show:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:c.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Shown.png")}}},hide:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:c.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Hidden.png")}}},clusteringOn:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:c.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Clustered.png")}}},clusteringOff:{stdTemplate:"functionIcon",semantics:{icon:{iconPath:c.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_Unclustered.png")}}}},this._mdlEvts=new s,this._customHeader=new p({shape:"circular",height:24,infiniteFlag:!0}),this._buildContent()}return g.prototype.getHeader=function(){return n.revealLayer.title},g.prototype.getIcon=function(){return h.getSetting("newLayerView")?{iconPath:c.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_RevealDocuments.png")}:void 0},g.prototype.render=function(){return this.elements.container},g.prototype.getCustomHeader=function(){return this._customHeader},g.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerRevealView-container"),this.elements.revealView=document.createElement("div"),this.elements.revealView.classList.add("PAD3DLayerRevealView-revealView");var n=document.createElement("div");n.classList.add("PAD3DLayerRevealView-dgvContainer");var s=UWA.extend({identifier:"DataGridView-3DLayerReveal-"+e.v4()},this.options.dgvOptions);s.layout=new o(this.options.dgvLayoutOptions);var r=this.options.dgv=new i(s);this.options.model=new t,r.treeDocument=this.options.model,this.elements.container.appendChild(this.elements.revealView),this.elements.revealView.appendChild(n),this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPreAdd(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),r.getContent().addClassName("PAD3DLayerRevealView-dgv"),r.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(this.options.typeReps)),r.onReady(function(){r.addEventListener("click",this._cellClicked.bind(this)),r.addEventListener("liveChange",this._colorChange.bind(this))}.bind(this)),n.appendChild(this.options.dgv.getContent())},g.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var o=0;o<t.length;++o){var n=t[o];n.options.layerId&&n.options.layerId===e.options.layerId&&null===i&&(i=o)}if(i>=0)return i}},g.prototype.selectItemIdx=function(e){this.options.dgv.setActiveCell(0);var t=null;this.options.model.getChildren().length>e&&this.options.model.getChildren()[e]?(t=this.options.model.getChildren()[e],this.options.model.getXSO().add(t)):this.options.model.getChildren().length<=e&&(t=this.options.model.getChildren()[this.options.model.getChildren().length-1],this.options.model.getXSO().add(t))},g.prototype.addChild=function(e){!0!==e.isLoading()&&(this.options.model.search({match:function(t){var i=!1;return t.nodeModel.options.layerId===e.options.layerId&&(i=!0),i}}).length>=0&&(this.options.model.addRoot(e),this._nbChildren++))},g.prototype.removeChild=function(e){!0!==e.isLoading()&&this.options.model&&this.options.model.getChildren()&&(this.options.model.removeRoot(e),this._nbChildren--,0===this.options.model.getRoots().length&&this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:g.layerName}}))},g.prototype.getModelEvents=function(){return this._mdlEvts},g.prototype._cellClicked=function(e,t){if(t&&t.nodeModel&&t.nodeModel.options.grid)switch(this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)){case"hidden":t.nodeModel.toggleVisibility();break;case"clustered":this._clusteringIsEditable&&t.nodeModel.toggleClustering()}},g.prototype._parametersView=function(){var e;if(this.options.model.unselectAll(),this.elements.revealView.classList.add("hidden"),this.elements.parametersView)this.elements.parametersView.classList.remove("hidden");else{this.elements.parametersView=document.createElement("div"),this.elements.parametersView.classList.add("PAD3DLayerRevealView-parametersView"),this.elements.container.appendChild(this.elements.parametersView),this.elements.availablePatterns=document.createElement("div"),this.elements.availablePatterns.classList.add("PAD3DLayerRevealView-availablePatterns"),this.elements.parametersView.appendChild(this.elements.availablePatterns),this.elements.paramsFooter=document.createElement("div"),this.elements.paramsFooter.classList.add("PAD3DLayerRevealView-paramsFooter"),this.elements.parametersView.appendChild(this.elements.paramsFooter);var t=new r({emphasize:"primary",label:n.revealLayer.okParams});t.getContent().addClassName("PAD3DLayerRevealView-okBtn"),t.getContent().addEventListener("buttonclick",function(t){var i=require("DS/ENOPAD3DViewer/utils/PAD3DViewerReveal");e=i.getAvailablePatterns(),Object.keys(e).length>0&&(i.endReveal(),i.setAvailablePatterns(e),this.elements.revealView.classList.remove("hidden"),this.elements.parametersView.classList.add("hidden"),i.startReveal())}.bind(this)),this.elements.paramsFooter.appendChild(t.getContent());var i=new r({emphasize:"secondary",label:n.revealLayer.cancelParams});i.getContent().addClassName("PAD3DLayerRevealView-cancelBtn"),i.getContent().addEventListener("buttonclick",function(e){this.elements.revealView.classList.remove("hidden"),this.elements.parametersView.classList.add("hidden")}.bind(this)),this.elements.paramsFooter.appendChild(i.getContent())}this.elements.availablePatterns.innerHTML="",require(["DS/ENOPAD3DViewer/utils/PAD3DViewerReveal"],function(t){e=t.getAvailablePatterns();var i=new a({type:"checkbox"});i.getContent().addClassName("PAD3DLayerRevealView-btnGrpPatterns"),this.elements.availablePatterns.appendChild(i.getContent());for(var o=Object.keys(e),s=0;s<o.length;s++){var r=new l({type:"switch",label:e[o[s]].label,value:o[s],checkFlag:e[o[s]].activated});r.addEventListener("change",function(t){if(e[t.dsModel.value].activated=t.dsModel.checkFlag,!t.dsModel.checkFlag){for(var i=Object.keys(e),o=!0,s=0;s<i.length;s++)e[i[s]].activated&&(o=!1);o&&(d.get().displayNotification({eventID:"warning",msg:n.revealLayer.warningNoSelection}),t.dsModel.checkFlag=!0)}}),i.addChild(r)}}.bind(this))},g.prototype._colorChange=function(e,t){t&&t.nodeModel&&t.nodeModel.options.grid&&"colorSquare"===this.options.dgv.layout.getDataIndexFromColumnIndex(t.columnID)&&t.nodeModel.updateColor(e.srcElement.dsModel.value)},g.layerName="reveal",g}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerRevealCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i){"use strict";return e.extend({_context:null,_reveal:null,init:function(e){e=e||{},this._parent(e,{}),this._context=t.get(e.context),this._CBTokens=[],this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},this._checkAvailability.bind(this))),this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},this._checkAvailability.bind(this))),this._checkAvailability()},execute:function(){var e=this;require(["DS/ENOPAD3DViewer/utils/PAD3DViewerReveal"],function(t){t.initialize({context:e._context}).then(function(){t.startReveal(),require(["DS/PADServices/utils/PADTrackerManager"],function(e){var t=e.getPADTracker({eventCategory:"usage",eventAction:"command"});t.setEventData({eventLabel:"PAD3DViewerRevealCmd"}),t.trackPageEvent()})})})},destroy:function(){if(this._context)for(var e=0;e<this._CBTokens.length;e++)this._context.unsubscribe(this._CBTokens[e])},_checkAvailability:function(){var e=this._context.getRoots();if(0!==e.length){for(var o=!1,n=0;n<e.length;n++)if(t.get().getController().isRootSupported(i.getNodeID(e[n]))){o=!0;break}o?this.enable():this.disable()}else this.disable()}})}),define("DS/ENOPAD3DViewer/models/PAD3DViewerTileNodeModel",["UWA/Class","UWA/Promise","DS/ENOPAD3DViewer/mixins/PAD3DViewerDebugTileNodeModel","DS/ENOPAD3DViewer/mixins/PAD3DViewerQueryParser","DS/3DXMTiles/OOCManager","DS/3DXMTiles/OOCModel3DHandler","DS/3DXMTiles/OOCHandler","DS/3DXMTiles/OOCTileSetHandler","DS/3DXMTiles/LDHReference","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ModelLoader","DS/CoreEvents/ModelEvents","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/PADServices/utils/PlatformURL","DS/RenderingMaterial/PLMMaterialFactory"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_,f,v,m,b,y){"use strict";return e.extend(i,o,{className:"PAD3DViewerTileNodeModel",init:function(e){this._parent(e),this._modelEvents=new u,this._nodeIndex={},this._rootIndex={},this._hiddenRootIds=[],this._repList=[],this._rootLog=[],this._OOCManager=null,this._config=null,this._rootStatsController=null,this._parsingRunning=!1,this._getFcsUrlsCB=e.getFcsUrlsCB,this._unsupportedRootMap=new Map,this._nodeIndex[this.getRootBagId()]=new h("RootBag"),e.viewer.addNode(this._nodeIndex[this.getRootBagId()]),this._decorationBag=new h("DecorationBag"),e.viewer.addNode(this._decorationBag),this._loadingBoxesBag=new h("LoadingBoxesBag"),e.viewer.addNode(this._loadingBoxesBag);var t=new c;t.addElement(this._nodeIndex[this.getRootBagId()]),this._nodeIndex[this.getRootBagId()].path=t,this._rootStatsController=e.rootStatsController;var i={enableOcclusionTest:v.getSetting("enopad3dviewer_occlusionTest"),config:"full",fullVP:!0,fullOOC:!0,meshInRAM:v.getSetting("enopad3dviewer_defaultMIRMode"),newLoadingBoxes:!0,getServiceUrlCB:function(e){return b.getPlatformURL(e)}};i.config=this.getConfig(),"medium"===i.config?e.viewer.setSmallRenderTargetPicking(!0):"restricted"===i.config&&e.viewer.setSmallRenderTargetPicking(!0);var o=void 0!==e.appOOCManagerOptions?UWA.extend(i,e.appOOCManagerOptions):i;this._OOCManager=new n(e.viewer,o),this._OOCManager.setTargetNode(this.getRootBag()),this._OOCManager.setOnStartLoadingCB(e.startLoadingCB),this._OOCManager.setOnEndLoadingCB(e.endLoadingCB),this._OOCManager.setOnSwitchRepCB(e.representationLoadedCB),this._OOCManager.setOnCycleDetectedCB(e.cycleDetectedCB),this._OOCManager.setTargetNode(this.getRootBag()),this._OOCManager.setPerformancesOptions({pauseLoadingDuringViewpointMove:!0}),this._OOCManager.setSplattingParameters&&this._OOCManager.setSplattingParameters({splattingFactor:.8,minSize:2}),this._OOCManager.registerExternalSceneGraphNode(this.getRootBagId(),this._nodeIndex[this.getRootBagId()]),this._OOCManager.setMaxNbExpectedChildrenPerRequest&&this._OOCManager.setMaxNbExpectedChildrenPerRequest(3e4),e.viewer.budgetedRenderManager.setBudget(.1),window._modelDebugger=this,this._initOOCHandlers(e)},getRootBagId:function(){return"rootBag"},getRootLog:function(){return this._rootLog.slice(0)},addToRootLog:function(e){this._rootLog.push(e)},_registerTileSet:function(e,t,i){this._OOCManager.registerReference(e,{handlerType:"tileSet",tileSet:{sourceId:t,resourceId:e}}),this._OOCManager.setUserData(e,{type:i})},replaceTileSetRoot:function(e,t,i){return this._OOCManager.replaceTileSetRoot(e,t,i)},_addRootIndex:function(e,t){this._OOCManager.addSceneGraphLock(e),this._rootIndex[e]={occId:t,setSequenceFilter:function(e){this._sequenceFilter=e},setConfigFilter:function(e){this._configFilter=e},setCVFilterQuery:function(e){this._CVFilterQuery=e},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(e,t,i){var o="V1"===i?{V1:{}}:{V2:{}},n=null;if(t&&t.GetFilterSpec){var s=t.GetFilterSpec(e,o);s&&(n=s.CVQuery3D)}return n}.bind(this,e)}},getRootIndex:function(){return this._rootIndex},getHiddenRootIds:function(e){return void 0!==e?this._hiddenRootIds[e]:this._hiddenRootIds},getOOCManager:function(){if(void 0!==this._OOCManager)return this._OOCManager},destroy:function(){delete this._modelLoader,delete this._nodeIndex,delete this._hiddenRootIds,delete this._viewer,delete this._rootLog,this._modelEvents&&delete this._modelEvents,this._parent()},_initOOCHandlers:function(e){this._model3DHandler=new s({getSecurityParamsCB:function(){return{securityCtx:v.getSetting("pad_security_ctx"),tenant:m.getPlatformId(),service3DSpaceUrl:m.get3DSpaceUrl(),userLogin:m.getUser()?m.getUser().login:null}},oocManager:this._OOCManager}),this._model3DHandler.setLoadModelOptions({proxyurl:"none"}),m.isCloud()&&this._model3DHandler.setAutoRedirect(!0),this._model3DHandler.setFileType(v.getSetting("enopad3dviewer_streamFileType")?v.getSetting("enopad3dviewer_streamFileType"):"cgr"),this._model3DHandler.setRedirectUrlCB&&this._model3DHandler.setRedirectUrlCB(function(e,t){this._getFcsUrlsCB({urls:e,callbacks:{onComplete:function(e){e.results&&t(e.results)},onFailure:function(i){for(var o=[],n=0;n<e.length;n++)o.push(null);t(o)}}})}.bind(this));var i=this,o=function(e){r.call(this,r.InstRefHander),this._processing=!1,this._expandCB=e.expandCB,this._handleBoxCB=e.handleBoxCB,this.manager=i._OOCManager,this.model=i,this._rootStatsController=e.rootStatsController};(o.prototype=Object.create(r.prototype)).isReady=function(){return!1===this._processing},o.prototype.getBatchSize=function(){return v.getSetting("enopad3dviewer_LDHBatchSize")?v.getSetting("enopad3dviewer_LDHBatchSize"):100},o.prototype.getData=function(e,i){this._processing=!0;var o={},n=0;for(n=0;n<e.length;n++){var s=e[n],r=s.ids[0];void 0===o[r]&&(o[r]={idPaths:[],treatedRef:[]}),o[r].idPaths.push(s.ids),o[r].treatedRef.push(s.getLastId())}var a=Object.keys(o),l=[];for(n=0;n<a.length;n++){var d=a[n];o[d].idPaths.length&&l.push(new t(function(e,t,s){var r=UWA.clone(this._rootStatsController.getRootStats(e).pathesToExpand),l=0===this.model.createReferenceIterator(e).getChildren().length&&!this.model._OOCManager.getReferenceBoundingBox(e);this._expandCB({paths:r,pixelCulling:v.getSetting("enopad3dviewer_pixelCulling_progressiveExpand"),onComplete:function(e,o,n,s,r){!this._rootStatsController||this._rootStatsController.isLargeDataStructure(e)||r.memoryFull?!this._rootStatsController.isLargeDataStructure(e)&&r.memoryFull&&this._rootStatsController.enforceDynamicLoading(e):(this.model.freezeRoot(e),this._rootStatsController.getRootStats(e).pathesToExpand.splice(0,n.length)),s&&this._rootStatsController.publish({event:"onReframe",data:{BS:null,rootBS:!1}}),this.done(o,[],i),t()}.bind(this,e,o[a[n]].treatedRef,r,l),onFailure:function(e,o){this._rootStatsController.isLargeDataStructure(e)||this._rootStatsController.enforceDynamicLoading(e),this.done([],o,i),t()}.bind(this,e,o[a[n]].treatedRef),singleAdd:!1,progressiveExpand:!0},!1,!1)}.bind(this,d)))}a.length||this.done([],[],i),t.all(l).then(function(){this._processing=!1}.bind(this))},o.prototype.done=function(e,t,i){i.doneCB(e,t)},o.prototype.handlePathes=function(e,t){this.getData(e,t)},o.prototype.handleBox=function(e,t,i){this._handleBoxCB({path:[e],box:t}).then(function(e,t){e.doneCB(t)}.bind(this,i)).catch(function(e,t){e.errorCB&&e.errorCB(t)}.bind(this,i))},this._refHandler=new o(e),this._tileSetHandler=new a({sortingMetric:"pixelError",triggerMetric:"pixelError",getDataCB:function(i,o){return new t(function(e,t,i,o,n){e({ids:t,attributes:i,callbacks:{onComplete:o,onFailure:n,onTimeout:n}})}.bind(this,e.fetchCB,i,o))},getSecurityParamsCB:function(){return{securityCtx:v.getSetting("pad_security_ctx"),tenant:m.getPlatformId(),service3DSpaceUrl:m.get3DSpaceUrl(),userLogin:m.getUser()?m.getUser().login:null}}}),this._OOCManager.registerHandlers({ref:this._refHandler,repRef:this._model3DHandler,tileSet:this._tileSetHandler})},_parseAttributes:function(e,t,i){var o=null,n=e.length,s=0;for(t.did=null,t.globalType=null,t.type=null,t.pid=null,t.thbUrl=null,t.cgrUrl=null,t.matrix=null,s=0;s<n;s++){if("did"===(o=e[s]).name)t.did=o.value;else if("ds6w:globaltype"===o.name.toLowerCase())t.globalType=o.value;else if("type"===o.name)t.type=o.value;else if("ds6w:type"===o.name)t.type=o.value;else if("physicalid"===o.name)t.pid=o.value;else if("resourceid"===o.name)t.pid=o.value;else if("thumbnail_3d"===o.name)t.thbUrl=o.value;else if("cgr"===o.name)t.cgrUrl=o.value;else if("matrixtxt"===o.name&&""!==o.value&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==o.value&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==o.value&&"1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"!==o.value){t.matrix=new g.Matrix4;var r=o.value.split(/[,]/);t.matrix.elements[0]=parseFloat(r[0]),t.matrix.elements[1]=parseFloat(r[1]),t.matrix.elements[2]=parseFloat(r[2]),t.matrix.elements[4]=parseFloat(r[3]),t.matrix.elements[5]=parseFloat(r[4]),t.matrix.elements[6]=parseFloat(r[5]),t.matrix.elements[8]=parseFloat(r[6]),t.matrix.elements[9]=parseFloat(r[7]),t.matrix.elements[10]=parseFloat(r[8]),t.matrix.elements[12]=parseFloat(r[9]),t.matrix.elements[13]=parseFloat(r[10]),t.matrix.elements[14]=parseFloat(r[11])}i&&i===o.name&&(t[o.name]=o.value)}},buildFromJSON:function(e){e.json&&e.json.infos&&e.json.infos.kind&&e.json.infos.kind.indexOf("InstRef")>-1?this._buildFromJSONInstRef(e):this._buildFromJSONOcc(e)},unlockChildren:function(e){this._OOCManager.unlockChildren(e.id)},reparentNode:function(e){this.buildFromJSON({json:e.json,rootIds:[],streamToLoad:e.streamToLoad,callbacks:{onComplete:function(e){this._OOCManager.removeInstance(e.oldInstanceId)}.bind(this,e)}})},insertExistingNode:function(e){this.buildFromJSON({json:e.json,rootIds:e.rootIds,streamToLoad:e.streamToLoad,callbacks:{onComplete:function(){}}})},createNode:function(e){},removeNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id){var t=e.id;this.isInstance(t)?this._OOCManager.removeInstanceTree(t):this.isReference(t)&&this._OOCManager.removeReferenceTree(t)}else console.error("No id defined")},removeRoot:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id){for(var t=this._rootLog.length-1;t>=0;t--)Array.isArray(this._rootLog[t])&&this._rootLog[t][0]===e.id&&this._rootLog.splice(t,1);this._rootIndex[e.id]&&this._rootIndex[e.id].occId&&(e.intent&&"replaceRoot"===e.intent||this._OOCManager.removeRoot(this._rootIndex[e.id].occId),y.onRemovedRoot&&y.onRemovedRoot(e.id),this.isRootSupported(e.id)||this.removeUnsupportedRootFromMap(e.id),delete this._rootIndex[e.id])}else console.error("No id defined")},detachNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id)if(void 0!==e.parentId){var t=this.getNode({id:e.id}),i=this.getNode({id:e.parentId});t&&i&&i.remove(t)}else console.error("No parentId defined");else console.error("No id defined")},attachNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id)if(void 0!==e.parentId){var t=this.getNode({id:e.id}),i=this.getNode({id:e.parentId});t&&i&&(i.add(t),t.path=i.path.clone(),t.path.addElement(t))}else console.error("No parentId defined");else console.error("No id defined")},switchNodeVisuStreamOnDemand:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.data))throw new Error("No input data defined");if("function"!=typeof e.callbacks.onURLLoad)throw new Error("No onURLLoad callback function defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback function defined");var t=this;t.nbCgrLoaded=0,t.nbThbLoaded=0;var i=function(){t._nbURLToLoad--,t._nbURLLoaded++,0===t._nbURLToLoad&&e.callbacks.onComplete({nbUrlLoaded:t._nbURLLoaded})};e.autoLock=void 0===e.autoLock||e.autoLock,t._nbURLToLoad=e.data.length,t._nbURLLoaded=0;var o=!1;e.data.forEach(function(s){var r=s.url,a=s.node.getModelIdentification(),l=t.getLoadedStream(s.node),d=t.getRequestedStream(s.node);if(!r||s.stream===l&&s.stream===d)t._nbURLToLoad--,r||(o=!0);else{t._OOCManager.setReferenceLoadModelOptions(a,{applicativeContainers:void 0===e.applicativeContainers?void 0:e.applicativeContainers});var h=null;"cgr"===s.stream?(h=n.RepType.av1,t.nbCgrLoaded++):(h=n.RepType.pr,t.nbThbLoaded++),!0===e.autoLock&&(s.stream!==(v.getSetting("enopad3dviewer_CGRorTHB")?"cgr":"thumbnail")?t.lockNodes({ids:[a]}):t.unlockNodes({ids:[a]})),t._OOCManager.switchRepresentation(a,{url:r,type:h,wms:s.wms},i),void 0!==e.noMeshInRAM&&(e.noMeshInRAM?t.unlockRepresentationMeshInRAM(a):t.lockRepresentationMeshInRAM(a))}}),t.publish({event:"onUrlLoaded",data:{nbCgrLoaded:t.nbCgrLoaded,nbThbLoaded:t.nbThbLoaded}}),t._nbURLToLoad||e.callbacks.onComplete({nbUrlLoaded:t._nbURLLoaded,urlNotFound:o})},refreshStream:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.data))throw new Error("No input data defined");if("function"!=typeof e.callbacks.onURLLoad)throw new Error("No onURLLoad callback function defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback function defined");var t,i=this;i._nbURLToLoad=e.data.length,i._nbURLLoaded=0,i.nbCgrLoaded=0,i.nbThbLoaded=0,t=function(){i._nbURLToLoad--,0===i._nbURLToLoad&&e.callbacks.onComplete()},e.data.forEach(function(o){var s=o.url,r=null;"cgr"===o.stream?(r=n.RepType.av1,i.nbCgrLoaded++):(r=n.RepType.pr,i.nbThbLoaded++),i._OOCManager.setReferenceLoadModelOptions(o.node.getModelIdentification(),{applicativeContainers:e.applicativeContainers}),i._OOCManager.switchRepresentation(o.node.getModelIdentification(),{url:s,type:r,wms:o.wms},t),void 0!==e.noMeshInRAM&&(e.noMeshInRAM?i.unlockRepresentationMeshInRAM(o.node.getModelIdentification()):i.lockRepresentationMeshInRAM(o.node.getModelIdentification()))}),i.publish({event:"onUrlLoaded",data:{nbCgrLoaded:i.nbCgrLoaded,nbThbLoaded:i.nbThbLoaded}}),i._nbURLToLoad||e.callbacks.onComplete()},isNodeLocked:function(e){return this._OOCManager.getSceneGraphLockCounter(e)>0},lockNodes:function(e){if("object"==typeof e)for(var t=0;t<e.ids.length;++t)this._OOCManager.addSceneGraphLock(e.ids[t]);else console.error("Incorrect options type in addSceneGraphLock()")},unlockNodes:function(e){if("object"==typeof e)for(var t=0;t<e.ids.length;++t)this._OOCManager.removeSceneGraphLock(e.ids[t]);else console.error("Incorrect options type in removeSceneGraphLock()")},forceReferencesLoad:function(e){if("object"==typeof e)return new t(function(i,o,n){for(var s=[],r=0;r<e.ids.length;++r)this._OOCManager.isRegistered(i[r])&&s.push(new t(function(e,t,i){this._OOCManager.forceReferenceLoad(e,t)}.bind(this,i[r])));t.all(s).then(o)}.bind(this,e.ids));console.error("Incorrect options type in forceReferenceLoad()")},setForceReferencesLoad:function(e){if("object"!=typeof e)throw new Error("PAD3DViewerTileNodeModel : No input data in setForceReferencesLoad()");if(!Array.isArray(e.data))throw new Error("PAD3DViewerTileNodeModel : Incorrect input data type in setForceReferencesLoad()");return this._OOCManager?new t(function(e,i,o){for(var n=[],s=0;s<e.length;++s)this._OOCManager.isRegistered(e[s].id)&&(e[s].state?n.push(new t(function(e,t,i){this._OOCManager.setForceReferenceLoad(e,t,i)}.bind(this,e[s].id,e[s].state))):this._OOCManager.setForceReferenceLoad(e[s].id,e[s].state));t.all(n).then(i)}.bind(this,e.data)):(console.warn("Not supported out of OOC context"),new t(function(e){return e()}))},getRootBag:function(){return this._nodeIndex.rootBag},getNode:function(e){return"rootBag"===e.id?this.getRootBag():this._OOCManager.getSceneGraphNode(e.id)},getUserData:function(e){if(this._OOCManager.isRegistered(e.id))return this._OOCManager.getUserData(e.id)},getRoot:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if("string"==typeof e.id)return this._rootIndex[e.id];console.error("No id defined")},abort:function(e){for(;this._parsingRunning;);this._rootIndex[e]&&this._rootIndex[e].occId&&this._OOCManager.removeRoot(this._rootIndex[e].occId)},pause:function(){this._OOCManager&&this._OOCManager.setPauseLoading(!0)},resume:function(){this._OOCManager&&this._OOCManager.setPauseLoading(!1)},getDecorationBag:function(){return this._decorationBag},getLoadingBoxesBag:function(){return this._loadingBoxesBag},publish:function(e){this.getModelEvents().publish(e)},subscribe:function(e,t){return this.getModelEvents().subscribe(e,t)},unsubscribe:function(e){this.getModelEvents().unsubscribe(e)},getModelEvents:function(){return this._modelEvents},getReferenceBoundingSphere:function(e){var t=this._OOCManager.getReferenceBoundingSphere(e);return t&&(t=t.clone()),t},getReferenceBoundingBox:function(e){var t=this._OOCManager.getReferenceBoundingBox(e);return t&&(t=t.clone()),t},getInstanceParentReferenceId:function(e){return this._OOCManager.getInstanceParentReferenceId(e)},getInstanceChildReferenceId:function(e){return this._OOCManager.getInstanceChildReferenceId(e)},addUserQueue:function(e){this._OOCManager.addUserQueue(e)},removeUserQueue:function(e){this._OOCManager.removeUserQueue(e)},displayCandidateQueue:function(e,t){e?this._OOCManager.setCandidateQueueRendererParams(!0,{displayIntermediateReferences:!0,repRefAttributes:{color:new g.Color(t.repColor),opacity:.3,dimension:2},refAttributes:{color:new g.Color(t.assemblyColor),opacity:.3,dimension:2},rootNode:this.getLoadingBoxesBag()}):this._OOCManager.setCandidateQueueRendererParams(!1)},registerOverrideSet:function(e){this._OOCManager.registerOverrideSet(e)},setOverrideCB:function(e,t,i){this._OOCManager.setOverrideCB(e,t,i)},hasOverrideCB:function(e,t){var i=!1;return this._OOCManager.hasOverrideCB&&(i=this._OOCManager.hasOverrideCB(e,t)),i},removeOverrideSet:function(e){this._OOCManager.removeOverrideSet(e)},createReferenceIterator:function(e){return this._OOCManager.createReferenceIterator(e)},setLoadingBoxesPickable:function(e){this._OOCManager.setLoadingBoxesPickable&&(e?this._OOCManager.setLoadingBoxesPickable(_.PICKABLE):this._OOCManager.setLoadingBoxesPickable(_.NODRAWHL))},getOOCSelectedReferenceID:function(){var e=null;return this._OOCManager&&(e=this._OOCManager.getSelectedReference("cso")),e},getOOCReference:function(e){var t=null;return this._OOCManager&&(t=this._OOCManager._getLDHReference(e)),t},getWorldMatrix:function(e){var t=null;return this._OOCManager&&(t=this._OOCManager.getWorldMatrix(this._rootIndex[e[0]].occId,e)),t},getOccurrences:function(e){var t=null;return this._OOCManager&&this._OOCManager.getOccurrences&&(t=this._OOCManager.getOccurrences(e)),t},isReferenceComplete:function(e){var t=null;this._OOCManager&&e&&(this.getNode({id:e})&&(t=this._OOCManager.isReferenceComplete(e)));return t},setDefaultLoadModelOptions:function(e){this._OOCManager&&this._OOCManager.setDefaultLoadModelOptions&&this._OOCManager.setDefaultLoadModelOptions(e)},hasMeshInRAM:function(e){var t=!1;return this._OOCManager&&this._OOCManager.hasMeshInRAM&&(t=this._OOCManager.hasMeshInRAM(e)),t},lockGlobalMeshInRAM:function(){this._OOCManager&&this._OOCManager.lockGlobalMeshInRAM&&this._OOCManager.lockGlobalMeshInRAM()},unlockGlobalMeshInRAM:function(){this._OOCManager&&this._OOCManager.unlockGlobalMeshInRAM&&this._OOCManager.unlockGlobalMeshInRAM()},lockRepresentationMeshInRAM:function(e){this._OOCManager&&this._OOCManager.lockReferenceMeshInRAM&&this._OOCManager.lockReferenceMeshInRAM(e)},unlockRepresentationMeshInRAM:function(e){this._OOCManager&&this._OOCManager.unlockReferenceMeshInRAM&&this._OOCManager.unlockReferenceMeshInRAM(e)},getDefaultLoadModelOptions:function(){var e=null;return this._OOCManager&&this._OOCManager.getDefaultLoadModelOptions&&(e=this._OOCManager.getDefaultLoadModelOptions()),e},setRootEnabled:function(e,t){if(this._OOCManager){var i=this.getRoot({id:e});i&&this._OOCManager.setRootEnabled(i.occId,t)}},freezeRoot:function(e){if(this._OOCManager){var t=this.getRoot({id:e});t&&this._OOCManager.freezeRoot(t.occId)}},isRegistered:function(e){var t=!1;return this._OOCManager&&(t=this._OOCManager.isRegistered(e)),t},isReference:function(e){var t=!1;return this._OOCManager&&(t=this._OOCManager.isRegistered(e,!0)),t},isRepReference:function(e){var t=!1;return this._OOCManager&&(t=this._OOCManager.isRepRef(e,!0)),t},isInstance:function(e){var t=!1;return this._OOCManager&&(t=this.isRegistered(e)&&!this.isReference(e)),t},declareTreeModified:function(e){if(this._OOCManager){var t=this.getRoot({id:e});t&&this._OOCManager.declareTreeModified(t.occId)}},forceRefresh:function(){this._OOCManager&&this._OOCManager.forceRefresh&&this._OOCManager.forceRefresh()},getConfig:function(){if(null===this._config){var e="full";navigator.userAgent.match(/iPad/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1?e="medium":navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&(e="restricted"),this._config=e}return this._config},getLoadedStream:function(e){var t=null;switch(this.getRepType(e)){case n.RepType.pr:t="thumbnail";break;case n.RepType.av1:t="cgr"}return t},getRequestedStream:function(e){var t=null;switch(this.getRequestedRepType(e)){case n.RepType.pr:t="thumbnail";break;case n.RepType.av1:t="cgr"}return t},getRepType:function(e){var t=null;return this._OOCManager&&(t="string"==typeof e?this._OOCManager.getRepType(e):this._OOCManager.getRepType(e.getModelIdentification())),t},getRequestedRepType:function(e){var t=null;return this._OOCManager&&(t="string"==typeof e?this._OOCManager.getRequestedRepType(e):this._OOCManager.getRequestedRepType(e.getModelIdentification())),t},getIdPathesLeadingToReference:function(e){return this._OOCManager.getIdPathesLeadingToReference(e)},_getIRPathFromIIPath:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]),this.isInstance(e[i])&&i+1<e.length&&this.isInstance(e[i+1])&&t.push(this.getInstanceParentReferenceId(e[i+1]));return t},updateInstance:function(e,t){this._OOCManager.updateInstance(e,t)},_updatePositionMatrix:function(e){var t=new g.Matrix4,i=e.hasPositioningMatrix;t.elements[0]=parseFloat(i[0]),t.elements[1]=parseFloat(i[1]),t.elements[2]=parseFloat(i[2]),t.elements[3]=parseFloat(0),t.elements[4]=parseFloat(i[3]),t.elements[5]=parseFloat(i[4]),t.elements[6]=parseFloat(i[5]),t.elements[7]=parseFloat(0),t.elements[8]=parseFloat(i[6]),t.elements[9]=parseFloat(i[7]),t.elements[10]=parseFloat(i[8]),t.elements[11]=parseFloat(0),t.elements[12]=parseFloat(i[9]),t.elements[13]=parseFloat(i[10]),t.elements[14]=parseFloat(i[11]),t.elements[15]=parseFloat(1);var o={id:String(e.instance)},n={id:String(e.instance),matrix:t};return this.updateNode(o,n)},updateNode:function(e,t){var i=this.isRegistered(e.id);if(i){var o={};t.matrix&&(o.matrix=t.matrix),t.id&&(o.instanceId=t.id),this._OOCManager.updateInstance(e.id,o)}return i},declareUnsupportedRoot:function(e){this._unsupportedRootMap.set(e,!0)},removeUnsupportedRootFromMap:function(e){this._unsupportedRootMap.delete(e)},isRootSupported:function(e){return!this._unsupportedRootMap.has(e)},notifyRootVisibilityChange:function(e,t){if(this._OOCManager&&e){var i=this.getRoot({id:e});i&&this._OOCManager.notifyRootVisibilityChange(i.occId,t)}},getContentTypes:function(e){var t=null;if(this._OOCManager&&e){var i=this._OOCManager.getTileSets(e);if(i)for(var o=0;o<i.length;o++)t=null===t?i[o].getContentTypes():t.concat(i[o].getContentTypes())}return t}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerDefineFilterCmd",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmd","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/PADUtils/PADSession","DS/Selection/CSOManager","DS/ENOXInterWdgCom/LinkManager"],function(e,t,i,o,n,s,r,a){"use strict";return e.extend({_hasCSV:!1,_openFilterPanelNow:!1,init:function(e){this._parent(e),n.get().getController().getModelEvents().subscribe({event:"onRootRemoved"},function(e){this.setAvailabilityFromRolesAndRoots()}.bind(this)),n.get().getModelEvents().subscribe({event:"grantedRoleRetrieved"},function(e){this.checkRoles(e),this.setAvailabilityFromRolesAndRoots()}.bind(this)),n.get().getController().getModelEvents().subscribe({event:"onRootAdded"},function(e){this.setAvailabilityFromRolesAndRoots()}.bind(this)),s.subscribe({event:"authoringStateModified"},function(e){this.getAvailability()||e.authored?this.disable():this.setAvailabilityFromRolesAndRoots()}.bind(this)),this._setUpLicensing(),o.addEvent("onX3dPlatformId",this._setUpLicensing,this)},setAppParams:function(e){this._widgetId=e.widgetId,this._appId=e.appId},_setUpLicensing:function(){this.checkRoles(o.getSetting("enopad3dviewer_roles")),this.setAvailabilityFromRolesAndRoots()},setOpenFilterNow:function(e){this._openFilterPanelNow=!0,this._SelectedID=e},getAppParams:function(){var e=i.getAppId();return{widgetId:i.getWidgetId(),NGFUXId:n.get().getNGFUXID(!0),appId:e,shareFilterspec:!0}},getRoots:function(){if(!1!==this._openFilterPanelNow){this._openFilterPanelNow=!1;var e=[];if(n.get().getController().isRootSupported(this._SelectedID)){var i=n.get().getController().getRoot({id:this._SelectedID});e.push({id:this._SelectedID,filtered:t.isFiltered(i,n.get())})}return e}e=[];for(var o=n.get().getController().getRoots(),s=0;s<o.length;++s){var r=t.getNodeID(o[s]);n.get().getController().isRootSupported(r)&&e.push({id:r,filtered:t.isFiltered(o[s],n.get())})}return e},getSelection:function(){var e=r.get(),t=[];if(e.length>0)for(var i=0;i<e.length;++i)null!==e[i].pathElement&&t.push(n.get().streamPath(e[i].pathElement));return{path:t}},getSelectorManager:function(){return r||null},checkRoles:function(e){for(var t=0;t<e.length;++t)if(("CSV"===e[t].id||"InternalDS"===e[t].id)&&(!e[t].platforms||e[t].platforms&&e[t].platforms.indexOf(i.getPlatformId())>-1))return void(this._hasCSV=!0);this._hasCSV=!1},_checkAvailability:function(){this.setAvailabilityFromRolesAndRoots()},setAvailabilityFromRolesAndRoots:function(){var e=n.get().getController().getRoots();if(!this.isEnabled()&&!0===this._hasCSV&&e.length>0){for(var i=!1,o=0;o<e.length;o++)if(n.get().getController().isRootSupported(t.getNodeID(e[o]))){i=!0;break}i?this.enable():this.disable()}else if(0!==e.length){for(i=!1,o=0;o<e.length;o++)if(n.get().getController().isRootSupported(t.getNodeID(e[o]))){i=!0;break}i||this.disable()}else this.disable()},destroy:function(){o.removeEvent("onX3dPlatformId",this._setUpLicensing,this)}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerRightSidePanel",["DS/PADUtils/commands/RightSidePanel","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n){"use strict";return e.extend({getXSO:function(){return t},getID:function(e){for(var t,i=e.pathElement;i&&!n.isPLMNode(i.getLastElement(!0));)i=i.getParentPath();if(!i&&o.get().isSelectiveLoadingActivated())t=o.get().getController().getOOCSelectedReferenceID();else{var s=i.getLastElement(!0);t=n.getNodeID(s)}return t},getRelationID:function(e){for(var t,i=e.pathElement;i&&!n.isPLMNode(i.getLastElement(!0));)i=i.getParentPath();if(i){var o=i.getLastElement(!0);if(n.isInstance(o))t=n.getNodeID(o);else{var s=i.getParentPath().getLastElement(!0);t=n.getNodeID(s)}}return t},getServiceId:function(e){let t=n.getNodeID(e.pathElement.externalPath[1]);return i.getSetting("enopad3dviewer_lightNodeModel")&&o.get().getController().getRootStats(t)?o.get().getController().getRootStats(t).serviceId:"3DSpace"},getType:function(e){for(var t,i=e.pathElement;i&&!n.isPLMNode(i.getLastElement(!0));)i=i.getParentPath();if(i){var o=i.getLastElement(!0);t=n.getNodeType(o)}return t},getTriptych:function(){return o.get().elements.triptych},onTriptychReady:function(e){var t=o.get().subscribe({event:"on3DTriptychReady"},function(i){e.call(o.get().elements.triptych),require("DS/PADServices/utils/GlobalModelEvents").unsubscribe(t)})},isNodeValid:function(e){return!0}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerTransparencyCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/views/PAD3DTransparencyPanel","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o){"use strict";var n=t.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._context=i.get(this.options.context),this._controller=this._context.getController()},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerTransparencyCmd"}),i.trackPageEvent()}),this._controller.initTransparencyController();var e=this;require(["DS/Selection/CSOManager"],function(t){var i=t.get(),n=[];let s;i.forEach(function(e){n.push(e.pathElement.clone())}),e._controller.getTransparencyLayer()&&(s=e._controller.getCommonTransparency(n)),new o({commonTransparency:s,events:{onConfirm:function(t){e._controller.getTransparencyLayer()||e._controller.createTransparencyLayer(),-1===t.opacity?e._controller.removeTransparencyOnPaths(n):e._controller.applyTransparencyOnPaths(n,t.opacity),e.end()},onCancel:function(){e.end()}}})})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerTransparencyCmd",n)}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerNavigateOnSelectionCmd",["UWA/Core","UWA/Promise","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADUtilsServices","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADPager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g){"use strict";var _=i.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._CBTokens=[],this._view=null,this._selection=[],this._selectedIdx=null,this._previousCB=null,this._nextCB=null,this._selectAllCB=null,this._reframeAllCB=null,this._closeCB=null,this._csoChangeCB=null,this._escapeCB=null,this._lockedNodes=[],this.useModelBoundingSphere=!1,this._context=r.get(this.options.context);var t=this;this._CBTokens.push(this._context.subscribe({event:"onUpdatePager"},function(e){t.updatePager(e)})),this._escapeCB=function(e){27===e.keyCode&&this.end()}.bind(this)},updatePager:function(e){var t=this,i=[];e.forEach(function(e){var o=t._context.unstreamPath(e);i.push({pathElement:o})}),t._selection=i,t._selectedIdx=0,"POIs"===t._kind?t.reframeOnPOI():"ZOIs"===t._kind?t.reframeOnZOI():t.reframeOn(t.useModelBoundingSphere)},focusChange:function(e){if(this._context._focusTooltip&&"POIs"===this._kind){var t=this._context.getController()._layers.get("POIs");t&&t.forEach(function(e){this._context.getViewer().render(),this._context.getController()._clean_allTooltip_from_isFromFocusRefCmd(this._context.getController(),e._uuid)}.bind(this))}this._selection&&this._selection.length>0&&("previous"==e.operation&&("POIs"===this._kind?(this._selectedIdx--,this.reframeOnPOI()):"ZOIs"===this._kind?(this._selectedIdx--,this.reframeOnZOI()):(this._selectedIdx--,this.reframeOn(this.useModelBoundingSphere))),"next"==e.operation&&("POIs"===this._kind?(this._selectedIdx++,this.reframeOnPOI()):"ZOIs"===this._kind?(this._selectedIdx++,this.reframeOnZOI()):(this._selectedIdx++,this.reframeOn(this.useModelBoundingSphere))))},execute:function(e,i,n){return this._kind=i,n&&!0===n&&(this._context._focusTooltip=n),new t(function(t,i){this.prepareCSOData(e,n).then(function(e){n&&!0===n&&(this._context._focusTooltip=n),document.addEventListener("keyup",this._escapeCB),this.useModelBoundingSphere=e,this._selectedIdx=0;var i;i=o.get().slice(),this._internalCSOChange=!1;var s=this;"POIs"!==this._kind&&"ZOIs"!==this._kind||(this._selection=[]);for(var r=0;r<i.length;r++)null!==i[r].pathElement&&this._selection.push(i[r]);this._selection.length>1?(null===this._view&&(this._previousCB=function(){s.focusChange({operation:"previous"})},this._nextCB=function(){s.focusChange({operation:"next"})},this._reframeAllCB=function(){if(s._selection.length){for(var e=[],t=0;t<s._selection.length;t++)s._selection[t].pathElement&&e.push(s._selection[t].pathElement);if(!0===a.getSetting("enopad3dviewer_lightNodeModel")?"POIs"===s._kind||"ZOIs"===s._kind?h.reframeOn({paths:e,viewpoint:s._context.getViewpoint(),context:s._context}):h.reframeOnCandidates({paths:e,viewpoint:s._context.getViewpoint(),context:s._context}):h.reframeOn({paths:e,viewpoint:s._context.getViewpoint()}),s._context._focusTooltip&&!0===s._context._focusTooltip){s._context.getController()._createNode_and_Tooltip_and_pinTooltip_forFocRef(e,s._context.getController(),!0,!1,!0)}}},this._selectAllCB=function(){s.restoreSelection()},this._closeCB=function(){s.end()},this._view=new l({renderTo:this._context.elements.view_container,context:this._context,callbacks:{onPrevious:this._previousCB,onNext:this._nextCB,onSelectAll:this._selectAllCB,onReframeAll:this._reframeAllCB,onClose:this._closeCB}})),"POIs"===this._kind?this.reframeOnPOI():"ZOIs"===this._kind?this.reframeOnZOI():this.reframeOn(e),this._view.show(),this._csoChangeCB=o.onRemove(function(){s._internalCSOChange||s._context.getController()._updateClustersInProgress||s.end()})):1===this._selection.length?("POIs"===this._kind?this.reframeOnPOI():"ZOIs"===this._kind?this.reframeOnZOI():this.reframeOn(e),this._csoChangeCB=o.onRemove(function(){s._internalCSOChange||s._context.getController()._updateClustersInProgress||s.end()})):(console.log("CSO selection is empty"),s.end()),require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t,i){var o=t.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});o.setEventData({eventLabel:"PAD3DViewerNavigateOnSelectionCmd",eventValue:e?e.length:0}),o.trackPageEvent()}.bind(this,this._selection)),t()}.bind(this))}.bind(this))},restoreSelection:function(){var e=this,t=[];if(e._context.lockSelectionBroadcast(!0),e.originalSelection.length)for(var i=0;i<e.originalSelection.length;i++)if("POIs"===e._kind)for(var n=e._context.getController().unstreamPOI4Select(e.originalSelection[i]),r=0;r<n.length;r++)null!==n[r]&&t.push({pathElement:n[r]});else if("ZOIs"===e._kind)t=e._context.getController().unstreamZOIs(e.originalSelection);else{var a=e._context.unstreamPath(e.originalSelection[i]);null!==a&&t.push({pathElement:a})}this._internalCSOChange=!0,s.empty(),o.empty(),s.add(t),o.add(t),this._internalCSOChange=!1,e._context.lockSelectionBroadcast(!1),"POIs"===e._kind&&setTimeout(function(){e._context.getController()._tooltipFrame&&!e._context.getController()._tooltipFrame.isClosed()&&e._context.getController()._tooltipFrame.hide()},200)},end:function(e){if(this._context.getController().unlockNodes({ids:this._lockedNodes}),this._context._reframeFocus=!1,this._selection=[],this._selectedIdx=null,this._previousCB=null,this._nextCB=null,this._selectAllCB=null,this._reframeAllCB=null,this._closeCB=null,this._lockedNodes=[],this._csoChangeCB&&o.unsubscribe(this._csoChangeCB),this._escapeCB&&document.removeEventListener("keyup",this._escapeCB),(!e||!e.performingAgain)&&(this._view&&this._view.visible&&this._view.hide(),this._context._focusTooltip&&!0===this._context._focusTooltip)){var t=this._context.getController()._layers.get("POIs");t&&t.forEach(function(e){this._context.getViewer().render(),this._context.getController()._clean_allTooltip_from_isFromFocusRefCmd(this._context.getController(),e._uuid)}.bind(this)),this._context._focusTooltip=!1}},prepareCSOData:function(e){return new t(function(t){var i=function(e){this._context.lockSelectionBroadcast(!0),this.originalSelection=e;var t=[];o.empty(),s.empty();var i=this._context._controller.getHiddenRootIds();if("POIs"===this._kind)for(var n=0;n<e.length;n++){var r=this._context.getController().unstreamPOI(e[n]);if(r&&r.length)for(var a=0;a<r.length;a++)t.push({pathElement:r[a]})}else if("ZOIs"===this._kind)t=this._context.getController().unstreamZOIs(e);else for(var l=0;l<e.length;l++)if(-1===i.indexOf(e[l][0])){var d=this._context.unstreamPath(e[l]);t.push({pathElement:d})}t.length&&(o.add(t),s.add(t)),this._context.lockSelectionBroadcast(!1)}.bind(this),n=[];if(!0===a.getSetting("enopad3dviewer_lightNodeModel")&&"POIs"!==this._kind&&"ZOIs"!==this._kind)for(var r=0;r<e.length;++r)null===this._context.unstreamPath(e[r])&&n.push(e[r]);0===n.length?(i(e),!0===a.getSetting("enopad3dviewer_lightNodeModel")?t(!0):t(!1)):this._context.getController().expand({paths:n,withFrustumFilter:!1,expand_iter:"0",singleAdd:!1,onComplete:function(o){if("object"==typeof o){for(var n=0;n<e.length;++n)this._lockedNodes.push(e[n][e[n].length-1]);this._context.getController().lockNodes({ids:this._lockedNodes}),i(e),t(!0)}else console.error("Incorrect data type in expand onComplete()")}.bind(this)})}.bind(this))},reframeOn:function(e){-1===this._selectedIdx&&(this._selectedIdx=this._selection.length-1);var t=this._selectedIdx%this._selection.length;if(this._view){var i=t+1+"/"+this._selection.length;this._view.setLabel(i)}this._internalCSOChange=!0,this._context._reframeFocus=!0,this._context.lockSelectionBroadcast(!0),o.empty(),s.empty(),o.add(this._selection[t]),s.add(this._selection[t]),this._internalCSOChange=!1,this._context.lockSelectionBroadcast(!1),(this._context.getHideShowController()&&!this._context.getHideShowController().isVisible(this._selection[t].pathElement)&&1===this._context._viewer.getVisibleSpace()||this._context.getHideShowController()&&this._context.getHideShowController().isVisible(this._selection[t].pathElement)&&0===this._context._viewer.getVisibleSpace())&&this._context.displayNotification({eventID:"info",msg:u.swapToSeeSelection});var n=null;var r=this._context.getController().buildArrayFromPath(this._selection[t].pathElement);if(r&&r.length>0&&this._context.getController()._model.getWorldMatrix){var a=this._context.getController().getReferenceBoundingSphere(r[r.length-1]);if(a){var l=this._context.getController()._model.getWorldMatrix(r);a.applyMatrix4(l);var d=this._selection[t].pathElement.getBoundingSphere(),c=new p.Sphere;!d||d.isNaN()||d.empty()?c=a:a.mergeWithSphere(d,c),n=function(e,t){if(t&&!t.isNaN()){var i=t.clone();e?e.mergeWithSphere(i,e):e=i}return e}(n,c),h.reframeOn({BS:n,viewpoint:this._context.getViewpoint()})}else h.reframeOn({paths:[this._selection[t].pathElement],viewpoint:this._context.getViewpoint()})}else h.reframeOn({paths:[this._selection[t].pathElement],viewpoint:this._context.getViewpoint()})},reframeOnPOI:function(){-1===this._selectedIdx&&(this._selectedIdx=this._selection.length-1);var e=this._selectedIdx%this._selection.length;if(this._view){var t=e+1+"/"+this._selection.length;this._view.setLabel(t)}this._internalCSOChange=!0,this._context._reframeFocus=!0,this._context.lockSelectionBroadcast(!0),o.empty(),s.empty(),o.add(this._selection[e]),s.add(this._selection[e]),this._context.lockSelectionBroadcast(!1);var i,n,r,a,l,d,h,c=this._selection[e].pathElement.getLastElement(!0);if(c.name.indexOf("PAD3DPOINode")>-1){var p;if(c.getLayerID&&(i=c.getLayerID()),c._layerId&&(i=c._layerId),c.name&&(p=c.name.split("_")),(n=p[p.length-1])&&(n=parseInt(n)),i&&(r=this._context.getController()._layerPOIsIdInstancingNodeMap.get(i)),!0===g.isMemPCS()&&this._context.getController()._layerPOIsIdInstancingNodeMapMaster&&this._context.getController()._layerPOIsIdInstancingNodeMapMaster.size){var u=this._context.getController()._layerPOIsIdInstancingNodeMapMaster.get(i);if(u){var _=u.get(n),f=this._context.getController()._layers.get("POIs").get(i);this._context.getController()._seedNewNode(_,f,this._context.getController()._layerPOIsIdInstancingNodeMap.get(i),this._context.getController()._layerPOIsIdInstancingIndexMap.get(i),100,1);r=this._context.getController()._layerPOIsIdInstancingNodeMap.get(i)}}r&&(h=r.get(n)),a=h.getLabelPOI(),d=h.getId(),l=h.getColorPOI()}else n=this._selection[e].pathElement.instanceId,(i=c.name)&&(r=this._context.getController()._layerPOIsIdInstancingNodeMap.get(i)),r&&(h=r.get(n)),a=h.label,d=h.id,l=h.color;if(h){var v={resourceid:d,instanceid:n},m={layerID:i,layer:i,openPanel:!0,pois:[{layer:i,data:{instanceId:n,label:a,id:d,color:l}}]};this._context.getController()._reframeOnPOI(v,m),this._internalCSOChange=!1}},reframeOnZOI:function(){-1===this._selectedIdx&&(this._selectedIdx=this._selection.length-1);var e=this._selectedIdx%this._selection.length;if(this._view){var t=e+1+"/"+this._selection.length;this._view.setLabel(t)}this._internalCSOChange=!0,this._context._reframeFocus=!0,this._context.lockSelectionBroadcast(!0),o.empty(),s.empty(),o.add(this._selection[e]),s.add(this._selection[e]),this._internalCSOChange=!1,this._context.lockSelectionBroadcast(!1),h.reframeOn({paths:[this._selection[e].pathElement],viewpoint:this._context.getViewpoint()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerNavigateOnSelectionCmd",_)}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerEditPropertiesCmd",["UWA/Class","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n){"use strict";return t.extend({_propertiesCommandPath:"DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase",init:function(e){var t=this;this._parent(e,{mode:"shared",isAsynchronous:!1}),require([this._propertiesCommandPath],function(e){i.onPostAdd(this._checkSelection.bind(this)),i.onEmpty(function(){t.disable()}),i.onRemove(this._checkSelection.bind(this)),this._checkSelection()}.bind(this),function(){t.disable()})},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerEditPropertiesCmd"}),i.trackPageEvent()}),require(["DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices",this._propertiesCommandPath],function(e,t,n){for(var s=new n,r=i.get(),a=[],l=[],d=0;d<r.length;d++)a.push(r[d].pathElement);a.forEach(function(e){for(;e&&!t.isPLMNode(e.getLastElement(!0));)e=e.getParentPath();if(!e&&o.get().isSelectiveLoadingActivated()){var i=o.get().getController().getOOCSelectedReferenceID();i&&l.push({refID:i,instID:null})}else{var n=e.getLastElement(!0),s=e.getParentPath().getLastElement(!0);l.push({refID:t.getNodeID(n),instID:t.getNodeID(s)})}});var h={getSelectedNodes:function(){var t=[];return l.forEach(function(i){var o={id:i.refID,tenant:e.getSetting("x3dPlatformId"),source:"3DSpace",getID:function(){return i.refID},getRelationID:function(){return i.instID}};t.push(o)}),t},getSecurityContext:function(){return{SecurityContext:e.getSetting("pad_security_ctx"),tenant:e.getSetting("x3dPlatformId")}}};s.launchProperties(h)})},_checkSelection:function(){for(var e=!1,t=i.get(),o=0;o<t.length;o++)if(n.isAModelPath(t[o].pathElement)&&!n.isTileSetNode(t[o].pathElement.externalPath[1])){e=!0;break}e?this.enable():this.disable()}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerRelationalNavigatorCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s){"use strict";var r=t.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._context=o.get(e.context),this._CBTokens=[],this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},this._checkAvailability.bind(this))),this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},this._checkAvailability.bind(this))),this._checkAvailability()},destroy:function(){if(this._context)for(var e=0;e<this._CBTokens.length;e++)this._context.unsubscribe(this._CBTokens[e]);this._context=null},_checkAvailability:function(){var e=this._context.getRoots();if(0!==e.length){for(var t=!1,i=0;i<e.length;i++)if(o.get().getController().isRootSupported(n.getNodeID(e[i]))){t=!0;break}t?this.enable():this.disable()}else this.disable()},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerRelationalNavigatorCmd"}),i.trackPageEvent()});var e=this;require(["DS/PADUtils/PADUtilsServices"],function(t){var o=i.get(),s=[];o.forEach(function(t){for(var i=t.pathElement,o=i.getLastElement(!0);o&&!n.isPLMNode(o);)o=o.parents[0];if(o){var r=e._context.streamPath(i),a={options:{type:n.getNodeType(o),grid:{"ds6w:type":""}},getID:function(){return n.getNodeID(o)},getLabel:function(){},getOccurencePathWithType:function(){return r}};s.push(a)}}),t.setObject_on_compass({nodes_2_open:s}),t.launchApp({appId:"ENORIPE_AP"},function(){}),e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRelationalNavigatorCmd",r)}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveRootCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADContext"],function(e,t,i,o){"use strict";var n=t.extend({init:function(e){this._parent(e,{isAsynchronous:!0}),this._context=o.get(e.context)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){var i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerRemoveRootCmd"}),i.trackPageEvent()});var e=this;require(["DS/Selection/CSOManager","DS/Selection/HSOManager"],function(t,o){var n=t.get(),s=[];n.forEach(function(e){var t=e.pathElement.getLastElement(!0);i.isModelNode(t)&&s.push(i.getNodeID(t))}),t.empty(),o.empty(),s.length&&(e._context.removeRoots({pids:s},!0),e._context.getViewer().render({updateInfinitePlane:!0}),e._context.reframe()),e.end()})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveRootCmd",n)}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerSwitchVisuOnDemandCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/Selection/CSOManager","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s,r,a,l){"use strict";var d=t.extend({_currentMode:"thumbnail",init:function(e){if(this._parent(e,{}),this._context=i.get(e.context),this._CBTokens=[],this._VISnVIORetrievedToken=null,this._currentMode=this._context.getController().getDefaultStreamToLoad(),!n.getSetting("enopad3dviewer_materialSupportActivated")){var t=this;this._CBTokens.push(this._context.subscribe({event:"onUrlLoaded"},function(e){e.nbCgrLoaded&&t._context.changeVisuModeCmdAvailability(!0)})),this._CBTokens.push(this._context.subscribe({event:"onStreamSwitched"},function(){t.checkStream()})),this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},function(){t.checkStream()})),this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},function(){t.checkStream()})),"cgr"===this._currentMode?this._context.changeVisuModeCmdAvailability(!0):this._context.changeVisuModeCmdAvailability(!1)}o.isCloud()&&(this._setAvailabilityForRoles(),this._VISnVIORetrievedToken=this._context.subscribe({event:"VISnVIOStatusRetrieved"},this._checkAvailabilityForRoles.bind(this)))},_checkAvailabilityForRoles:function(){var e=!1,t=n.getSetting("enopad3dviewer_roles");if(n.getSetting("enopad3dviewer_VISnVIOStatus"))e=!0;else for(var i=0;i<t.length;i++)if("InternalDS"===t[i].id&&(!t[i].platforms||t[i].platforms&&t[i].platforms.indexOf(o.getPlatformId())>-1)){e=!0;break}e?this.enable():this.disable()},_setAvailabilityForRoles:function(){this.disable(),o.getVISnVIOStatus(function(e){e.hasLicense?this.enable():o.getGrantedRoles(function(e){for(var t=!1,i=0;i<e.length;i++)if("InternalDS"===e[i].id&&(!e[i].platforms||e[i].platforms&&e[i].platforms.indexOf(o.getPlatformId())>-1)){t=!0;break}t?this.enable():this.disable()}.bind(this))}.bind(this))},destroy:function(){if(this._VISnVIORetrievedToken&&this._context&&(this._context.unsubscribe(this._VISnVIORetrievedToken),delete this._VISnVIORetrievedToken),this._context)for(var e=0;e<this._CBTokens.length;e++)this._context.unsubscribe(this._CBTokens[e]);this._CBTokens=null,this._context=null},checkStream:function(e){var t=!1,i=[];if(e)this._context.changeVisuModeCmdAvailability(!0);else{var o=function(e){e.forEach(function(e){a.is3DLeaf(e)?i.push(e):o(e.children)})},n=a.getRoots(this._context);if(o(n),i.length){for(var s=0;s<i.length;s++)if(a.getLoadedStream(i[s]),this._context){t=!0;break}this._context.changeVisuModeCmdAvailability(t)}}},execute:function(){var e=this,t=null,i=[],o=s.get(),n=[],d=[],h=function(e){e.forEach(function(e){a.is3DLeaf(e)?n.push(a.getNodeID(e)):h(e.children)})},c=function(t){return e._context.getController().getNode({id:t})};if(o.forEach(function(t){var i=e._context.streamPath(t.pathElement);d.push(c(i[i.length-1]))}),h(d),1===n.length&&a.is3DLeaf(c(n[0]))){if(t="thumbnail"===a.getLoadedStream(c(n[0]),e._context)?"cgr":"thumbnail",r.isAuthoring()&&"thumbnail"===t)return void e._context.displayNotification({eventID:"info",msg:l.switchVisuNodeNoThumbnailOnAuthoring});i.push({node:c(n[0]),stream:t})}if(n.length>1){var p=0,u=0;if(n.forEach(function(t){a.is3DLeaf(c(t))&&("thumbnail"===a.getLoadedStream(c(t),e._context)?p++:"cgr"===a.getLoadedStream(c(t),e._context)&&u++)}),p>=u)t="cgr";else if(t="thumbnail",r.isAuthoring()&&"thumbnail"===t)return void e._context.displayNotification({eventID:"info",msg:l.switchVisuNodeNoThumbnailOnAuthoring});n.forEach(function(e){i.push({node:c(e),stream:t})})}require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t,i){var o=t.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});o.setEventData({eventLabel:"PAD3DViewerSwitchVisuOnDemandCmd",eventValue:e}),o.trackPageEvent()}.bind(this,i.length)),i.length&&e._context.getController().switchNodeVisuStreamOnDemand({data:i,callbacks:{onComplete:function(t){if(0!==t.nbUrlLoaded)if("cgr"===i[0].stream){var o=t.nbUrlLoaded;t.nbUrlLoaded>1?o+=l.switchVisuNodeToCGRsSuccess:o+=l.switchVisuNodeToCGRSuccess,e._context.displayNotification({eventID:"success",msg:o})}else{o=t.nbUrlLoaded;t.nbUrlLoaded>1?o+=l.switchVisuNodeToThumbnailsSuccess:o+=l.switchVisuNodeToThumbnailSuccess,e._context.displayNotification({eventID:"success",msg:o})}else 0===t.nbUrlLoaded&&"thumbnail"===i[0].stream&&e._context.displayNotification({eventID:"info",msg:l.switchVisuNodeUrlnotFound})},onFailure:function(){e._context.displayNotification({eventID:"error",msg:l.switchVisuNodeFailure,key:"pad3dViewer-switch-visu-node-failure"})}}})}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerSwitchVisuOnDemandCmd",d)}),define("DS/ENOPAD3DViewer/views/PAD3DPOINodeNew",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture","DS/Visualization/Node3D","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Visualization/SceneGraphUtils","DS/Mesh/MeshUtils","DS/ENOPAD3DViewer/views/PADPOIManipulator","DS/ENOPAD3DViewer/utils/PAD3DPOIDrawingFactory","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s,r,a,l,d,h){"use strict";function c(e){this._context=e.context,this._fillColor=e.fillColor?e.fillColor:"#FF4500",this._borderColor=e.borderColor?e.borderColor:"#000000",this.instanceId=e.instanceId,this._layerId=e.layerId,this._pickability=e.pickability,this.enablePOIPanel=e.enablePOIPanel,this.devicePixelRatio=window.devicePixelRatio||1,this._scale=void 0!==e.scale?e.scale:1,this._icon=void 0!==e.icon?e.icon:"default",void 0!==e.editable&&null!==e.editable&&(this._editable=e.editable),this._poiId=e.poiId,this._label=e.label?e.label:"POI "+this._poiId,this._highlightColor="#368EC4",this._selected=!1,this._isVisible=!1,this._canvasNode=null,this._definedData=e.data;var t=this._fillColor.slice(1,this._fillColor.length),i=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),s=parseInt(t.substring(4,6),16);this._textColor=i<=150&&n<=150&&s<=180?"#FFFFFF":"#000000",this._borderColor="#000000",this._name=e.name,this._opacity=e.opacity?e.opacity:1,this._position=e.position,this._parent=e.parent,this._node=new o(this._name),this._node._layerId=this._layerId,"IGNORED"===this._pickability?this._node.setPickable(a.INVISIBLE):"NOT_PICKABLE"===this._pickability?this._node.setPickable(a.NOPICKABLE):this._node.setPickable(a.PICKABLE),this._onHoverCallback=e.onHoverCallback,this._outHoverCallback=e.outHoverCallback,this._hoverManipulator=new l(this._name),this._hoverManipulator.setSelectionAllowed(!0),this._hoverManipulator.setPreActivationDuringManipulation(!0),this._hoverManipulator.setPrePickingDuringManipulation(!0),this._hoverManipulator.subscribe("BeginPreactivate",this._onHoverCallback),this._hoverManipulator.subscribe("EndPreactivate",this._outHoverCallback),this._width=20*this.devicePixelRatio*this._scale,this._height=32*this.devicePixelRatio*this._scale,this._rendered=!1,this._draw=d.draw({type:"default",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height,opacity:this._opacity}})}return c.prototype.getNode=function(){return this._node},c.prototype.getLayerID=function(){return this._layerId},c.prototype.getPosition=function(){return this._position},c.prototype.getColorPOI=function(){return this._fillColor},c.prototype.edit=function(e){var t=null;return this._editable&&(t={},e.color&&e.color.indexOf&&0===e.color.indexOf("#")&&(this._fillColor=e.color,t.color=e.color),this._draw=d.draw({type:"default",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height}}),this.render()),t},c.prototype.setEditable=function(e){this._editable=e},c.prototype.getId=function(){return this._poiId},c.prototype.getLabelPOI=function(){return this._label},c.prototype.getPOIId=function(){return this._poiId},c.prototype.render=function(){var o=new i({width:this._width,height:this._height,drawCB:this._draw,alphaTest:.02});this._canvasNode=e.createCanvas2DNode({canvasNodeTexture:o,hotspot:new t.Vector2(this._width/2-("flag"===this._icon?5*this._scale:0),0)}),this._canvasNode.setPickParent(!0),this._canvasNode.rectangle.setPickParent(!0),this._canvasNode.setMatrix((new t.Matrix4).setPosition(this._position)),this._isVisible&&(this._node.removeChildren(),this._node.addChild(this._canvasNode)),this._hoverManipulator&&this._hoverManipulator.linkToNode(this._canvasNode.rectangle),this._context.getViewer().render()},c.prototype.setHighlight=function(e){this._selected=e,this.render()},c.prototype.setVisibility=function(e){e?(this._parent.addChild(this._node),this._canvasNode||this.render(),this._node.addChild(this._canvasNode),this._isVisible=!0):!e&&this._isVisible&&(this._parent.remove(this._node),this._node.removeChildren(),this._isVisible=!1)},c.prototype.setOpacity=function(e){this._opacity=e,this._draw=d.draw({type:"default",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height,opacity:this._opacity}}),this.render()},c.prototype.isVisible=function(){return this._isVisible},c.prototype.getType=function(){return"PAD3DPOINodeNew"},c}),define("DS/ENOPAD3DViewer/views/PAD3DVolumeNode",["DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/ModelEvents"],function(e,t,i,o,n){"use strict";function s(t){var i=null;t.fillColor&&t.fillColor.indexOf&&t.fillColor.indexOf("0x")>=0?i=t.fillColor.replace("0x","#"):t.fillColor&&(i=t.fillColor);var o=null;t.borderColor&&t.borderColor.indexOf&&t.borderColor.indexOf("0x")>=0?o=t.borderColor.replace("0x","#"):t.borderColor&&(o=t.borderColor),this._fillColor=i||"#93d8fd",this._borderColor=o||"#63d8ff",this._parentNode=t.parentNode,this._type=t.type?t.type:"Box",this._context=t.context?t.context:e.get(),this._id=t.id,this._modelEvents=new n,!1===t.editable?this._isEditable=!1:this._isEditable=!0,this._isValidated=!1,this._callbackManipulateCB=t.endManipulateCB}return s.prototype.getId=function(){return this._id},s.prototype.getModelEvents=function(){return this._modelEvents},s.prototype.subscribe=function(e,t){return this.getModelEvents().subscribe(e,t)},s.prototype.unsubscribe=function(e){this.getModelEvents().unsubscribe(e)},s.prototype.publish=function(e){return this.getModelEvents().publish(e)},s.prototype._preactivateCB=function(e){return this.publish({event:"onPreactivate"}),!0},s.prototype._endPreactivateCB=function(e){return this.publish({event:"onEndPreactivate"}),!0},s.prototype.setEditable=function(e){this.isValidated()||(this._isEditable=e,this.isEditable()?this.isEditable()&&(this._ruler.setVisibleFlag(!0),this._robot.setVisibility(!0)):(this._ruler.setVisibleFlag(!1),this._robot.setVisibility(!1)))},s.prototype.isEditable=function(){return this._isEditable},s.prototype.isValidated=function(){return this._isValidated},s.prototype.validate=function(){this._isEditable=!1,this._isValidated=!0,this._ruler.setVisibleFlag(!1),this._robot.setVisibility(!1),this._callbackManipulateCB({id:this._id,params:this.getParameters()})},s.prototype._hexToRgb=function(e){var t=0,i=0,o=0;return 4==e.length?(t="0x"+e[1]+e[1],i="0x"+e[2]+e[2],o="0x"+e[3]+e[3]):7==e.length&&(t="0x"+e[1]+e[2],i="0x"+e[3]+e[4],o="0x"+e[5]+e[6]),{r:t,g:i,b:o}},s}),define("DS/ENOPAD3DViewer/views/PAD3DPOINode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture","DS/Visualization/Node3D","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Visualization/SceneGraphUtils","DS/Mesh/MeshUtils","DS/ENOPAD3DViewer/views/PADPOIManipulator","DS/ENOPAD3DViewer/utils/PAD3DPOIDrawingFactory","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s,r,a,l,d,h){"use strict";function c(e){this._poiMemModeinNode=!1,e.poiMemMode&&(this._poiMemModeinNode=e.poiMemMode),this._context=e.context,this._fillColor=e.fillColor?e.fillColor:"#FF4500",this._borderColor=e.borderColor?e.borderColor:"#000000",this.instanceId=e.instanceId,this._layerId=e.layerId,this._pickability=e.pickability,this.enablePOIPanel=e.enablePOIPanel,this.devicePixelRatio=window.devicePixelRatio||1,this._scale=void 0!==e.scale?e.scale:1,this._icon=void 0!==e.icon?e.icon:"default",void 0!==e.editable&&null!==e.editable&&(this._editable=e.editable),this._poiId=e.poiId,this._label=e.label?e.label:"POI "+this._poiId,this._highlightColor="#368EC4",this._selected=!1,this._isVisible=!1,this._canvasNode=null,this._definedData=e.data;var t=this._fillColor.slice(1,this._fillColor.length),i=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),s=parseInt(t.substring(4,6),16);this._textColor=i<=150&&n<=150&&s<=180?"#FFFFFF":"#000000",this._borderColor="#000000",this._name=e.name,this._opacity=e.opacity?e.opacity:1,this._position=e.position,this._parent=e.parent,!1===this._poiMemModeinNode&&(this._node=new o(this._name),this._node._layerId=this._layerId,"IGNORED"===this._pickability?this._node.setPickable(a.INVISIBLE):"NOT_PICKABLE"===this._pickability?this._node.setPickable(a.NOPICKABLE):this._node.setPickable(a.PICKABLE),this._onHoverCallback=e.onHoverCallback,this._outHoverCallback=e.outHoverCallback,this._hoverManipulator=new l(this._name),this._hoverManipulator.setSelectionAllowed(!0),this._hoverManipulator.setPreActivationDuringManipulation(!0),this._hoverManipulator.setPrePickingDuringManipulation(!0),this._hoverManipulator.subscribe("BeginPreactivate",this._onHoverCallback),this._hoverManipulator.subscribe("EndPreactivate",this._outHoverCallback),this._width=20*this.devicePixelRatio*this._scale,this._height=32*this.devicePixelRatio*this._scale,this._rendered=!1,this._draw=d.draw({type:"default",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height,opacity:this._opacity}}))}return c.prototype.getNode=function(){return!1===this._poiMemModeinNode?this._node:null},c.prototype.getLayerID=function(){return this._layerId},c.prototype.getPosition=function(){return this._position},c.prototype.getColorPOI=function(){return this._fillColor},c.prototype.edit=function(e){var t=null;return!1===this._poiMemModeinNode&&this._editable&&(t={},e.color&&e.color.indexOf&&0===e.color.indexOf("#")&&(this._fillColor=e.color,t.color=e.color),this._draw=d.draw({type:"default",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height}}),this.render()),t},c.prototype.setEditable=function(e){this._editable=e},c.prototype.getId=function(){return this._poiId},c.prototype.getLabelPOI=function(){return this._label},c.prototype.getPOIId=function(){return this._poiId},c.prototype.render=function(){if(!1===this._poiMemModeinNode){var o=new i({width:this._width,height:this._height,drawCB:this._draw,alphaTest:.02});this._canvasNode=e.createCanvas2DNode({canvasNodeTexture:o,hotspot:new t.Vector2(this._width/2-("flag"===this._icon?5*this._scale:0),0)}),this._canvasNode.setPickParent(!0),this._canvasNode.rectangle.setPickParent(!0),this._canvasNode.setMatrix((new t.Matrix4).setPosition(this._position)),this._isVisible&&(this._node.removeChildren(),this._node.addChild(this._canvasNode)),this._hoverManipulator&&this._hoverManipulator.linkToNode(this._canvasNode.rectangle),this._context.getViewer().render()}},c.prototype.setHighlight=function(e){!1===this._poiMemModeinNode&&(this._selected=e,this.render())},c.prototype.setVisibility=function(e){!1===this._poiMemModeinNode&&(e?(this._parent.addChild(this._node),this._canvasNode||this.render(),this._node.addChild(this._canvasNode),this._isVisible=!0):!e&&this._isVisible&&(this._parent.remove(this._node),this._node.removeChildren(),this._isVisible=!1))},c.prototype.setOpacity=function(e){!1===this._poiMemModeinNode&&(this._opacity=e,this._draw=d.draw({type:"default",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height,opacity:this._opacity}}),this.render())},c.prototype.isVisible=function(){return!1===this._poiMemModeinNode&&this._isVisible},c.prototype.getType=function(){return"PAD3DPOINode"},c}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerCapturePOICmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/GeometryHelper","DS/Manipulators/LineTranslationManipulator","DS/Mesh/MeshUtils","DS/ApplicationFrame/CommandsManager","DS/ENOPAD3DViewer/views/PAD3DPOINode","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","text!DS/ENOPAD3DViewer/assets/json/DefaultColorStream.json"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_,f){"use strict";var v=t.extend({states:{STOPPED:0,STARTED:1,ADD:2},_state:0,init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._toAddCount=0,this._addedCount=0,this._context=i.get(this.options.context),this._geomHelper=new r,this._csoTokens=[],this._lastPickInfo=null,require(["DS/PADUtils/PADCommandProxy"],function(e){this._poiCaptureCommandProxy=e.create({events:{onCapturePOI:function(e){}.bind(this)}})}.bind(this)),this._abortCB=[],this._parentPOIsNode=new n,this._pois=new Map,this._executing=!1,this._poiQueue=[],this._switchedToCGRNodes=[],this._manips=new Map,this._count=0,this._colorStreamJSON=[];var t=JSON.parse(f);if(t&&t.colorStream)for(var o=0;o<t.colorStream.length;o++)this._colorStreamJSON.push(t.colorStream[o]);this._coloredPOIsMap=new Map},capturePOI:function(e){var t=e;if(this._executing||(this._context.getDecorationBag().add(this._parentPOIsNode),this._parentPOIsNode.removeChildren(),this._abortCB.push(this._context.subscribe({event:"onRootRemoved"},function(e){this.abort()}.bind(this))),this._executing=!0),t.new){if((h=t.new).id&&this._pois&&!this._pois.has(h.id)){this._csoTokens&&this._csoTokens.length<=0&&this.captureActivate();var i="";h.color&&h.color.indexOf("#")>=0?i=t.new.color:(i=this._getNewColor(),this._coloredPOIsMap.set(h.id,i)),this._poiQueue.splice(0,0,h),this._toAddCount++;var s=new n(h.id);this._pois.set(h.id,{node:s,color:i,drawn:!1,validated:!1,editable:!0}),this._manips.size>0&&this._unsubscribeAllManips(),this._context.displayNotification({eventID:"info",msg:_.capturePOI.newInfo})}}else if(t.edit){if(t.edit.id&&this._pois.has(t.edit.id)){var r=null;if((h=this._pois.get(t.edit.id))&&!0!==h.validated&&h.poiNode){if(r=h.poiNode.edit(t.edit),t.edit.position){var a=(new o.Matrix4).makeTranslation(t.edit.position.x,t.edit.position.y,t.edit.position.z);h.node.setMatrix(a)}r.id=t.edit.id;var l=this._manips.get(t.edit.id);l&&l.manip&&l.manip.linkToNode(h.node)}if(this._context.getViewer().render(),r){if(r.color&&this._coloredPOIsMap.has(t.edit.id)){var d=this._coloredPOIsMap.get(t.edit.id);this._colorStreamJSON.splice(0,0,d),this._coloredPOIsMap.delete(t.edit.id)}this.parametersChanged(r)}}}else if(t.validate){var h;if(t.validate.id&&this._pois.has(t.validate.id))if(h=this._pois.get(t.validate.id)){h.validated=!0,this._unsubscribeManips(t.validate.id),this._unsubscribePreactivateManips(t.validate.id),h.poiNode&&h.poiNode.setEditable(!1);var c=h.pathElement,p=this._context.streamPath(c);h.node.removeChild(h.cross.parents[0]),h.node.excludeFromHighlight(!0,!0),h.poiNode.getNode().excludeFromHighlight(!0,!0),h.poiNode.getNode().children[0].excludeFromHighlight(!0,!0);r={id:h.node.name,pathElement:p,absolutePosition:h.absolutePosition,relativePosition:h.relativePosition,validated:!0};this.parametersChanged(r),this._context.getViewer().render()}}else t.delete?t.delete.id&&(this.removePOINode(t.delete.id),this._context.getViewer().render()):t.end&&this.end()},execute:function(e){this.capturePOI(e)},abort:function(){this._poiCaptureCommandProxy.capturePOI({abort:{}}),this.end()},captureActivate:function(){this.allowClickPOI()},end:function(){this.restoreSwitched(),this._parentPOIsNode.removeChildren(),this._unsubscribeAllManips();for(var e=0;e<this._abortCB.length;e++)this._context.unsubscribe(this._abortCB[e]);this._abortCB=[],this._poiQueue=[],this._manips.clear(),this._pois.clear(),this._context.getDecorationBag().removeChild(this._parentPOIsNode),this._executing=!1,this._state="STOPPED",this._context.getViewer().render()},allowClickPOI:function(){this._csoTokens.push(p.onPostAdd(this.createPOI.bind(this)))},parametersChanged:function(e){this._poiCaptureCommandProxy.capturePOI({parametersChanged:e})},createPOI:function(e){if(this._poiQueue&&this._poiQueue.length>0&&e&&e[0]&&e[0].event&&e[0].event.currentPosition){this._state=this.states.ADD;var t=this._context.getViewer().pick(this._context.getViewer().getMousePosition(e[0].event.currentPosition),"mesh",!0);if(t.path.length&&c.isAModelPath(t.path[0]))if(this.createPOINode(t),this._context.getViewer().render(),0===this._poiQueue.length){this._state=this.states.STARTED;for(var i=0;i<this._csoTokens.length;i++)p.unsubscribe(this._csoTokens[i]);this._csoTokens=[],(this._toAddCount.length>1||this._addedCount.length>1)&&this._context.displayNotification({eventID:"success",msg:_.capturePOI.allAdded}),this._subscribeAllManips(),this._addedCount=0,this._toAddCount=0}else this._addedCount++,(this._toAddCount.length>1||this._addedCount.length>1)&&this._context.displayNotification({eventID:"info",msg:_.capturePOI.added+" "+this._addedCount+"/"+this._toAddCount})}},createPOINode:function(e){var t=this._poiQueue.pop(),i=null;if(t&&(i=this._pois.get(t.id)),i){var r=(new o.Matrix4).makeTranslation(e.position.x,e.position.y,e.position.z);this._count++;var l=i.node;i.pathElement=e.path[0],i.pathElement&&(i.pathElement=i.pathElement.getParentPath());var d=new h({parent:l,fillColor:i.color?i.color:"#FEE000",position:new o.Vector3(0,0,0),instanceId:this._count,poiId:t.id,name:t.id,label:"",layerId:"0",pickability:!0,editable:!0,context:this._context});d.setVisibility(!0),this._pois.get(t.id).poiNode=d;var c=new o.MeshBasicMaterial({transparent:!1,opacity:1,enableClipPlanes:!1,color:"#3D3D3D",force:!0,side:o.DoubleSide}),p=new n;this._pois.get(t.id).cross=p;var u=this._geomHelper.createCircle({radius:15,segments:32,fill:!0}),g=new o.MeshBasicMaterial({side:o.DoubleSide,color:9689341,opacity:.7,transparent:!0});g.force=!0,p.excludeFromHighlight(!0,!0),p.excludeFromCSO(!0);var _=s.createMeshNode(u,g);_.excludeFromCSO(!0),_.excludeFromHighlight(!0,!0),_.setSSAO(!1),_.setShadow(!1,!1),_.setMatrix((new o.Matrix4).makeTranslation(0,0,-1));var f=s.createLineNode({points:[new o.Vector3(-8,0,-1),new o.Vector3(8,0,-1)],material:c});f.excludeFromHighlight(!0,!0),f.excludeFromCSO(!0);var v=s.createLineNode({points:[new o.Vector3(0,-8,-1),new o.Vector3(0,8,-1)],material:c});v.excludeFromHighlight(!0,!0),v.excludeFromCSO(!0),p.addChild(f),p.addChild(v),p.addChild(_),p.setNoHighlightNoZ(!0);var m=this.retrievePositionMatrix(e.normal,new o.Vector3(0,0,0));p.setMatrix(m);var b=s.createFixedSizeNode();b.addChild(p),l.addChild(b),l.setMatrix(r),this._parentPOIsNode.addChild(l);var y=new a({axis:(new o.Vector3).copy(e.position)});y.setExclusive(!0),y.linkToNode(l);var P={tokens:[],preactivate:[]};P.manip=y,P.preactivate.push(y.subscribe("Preactivate",function(e){this._context.getViewer().setCursor("pointer")}.bind(this,l))),P.preactivate.push(y.subscribe("EndPreactivate",function(e){this._context.getViewer().setCursor("auto")}.bind(this,l))),this._manips.set(t.id,P);var D=e.path[0];if(D){var I={},S=D.getWorldMatrix(),C=D.getLastElement(!0).getBoundingSphere().center,w=(new o.Matrix4).makeTranslation(C.x,C.y,C.z),x=(new o.Matrix4).multiply(S,w),O=(new o.Matrix4).getInverse(x);if(C)(I=new o.Vector3(e.position.x,e.position.y,e.position.z)).applyProjection(O)}i.absolutePosition={x:e.position.x,y:e.position.y,z:e.position.z},i.relativePosition=I;var A=this._context.streamPath(D),M={id:t.id,absolutePosition:{x:i.absolutePosition.x,y:i.absolutePosition.y,z:i.absolutePosition.z},relativePosition:I,pathElement:A};this.switchToCGR(D.getParentPath()),this.parametersChanged(M)}},_unsubscribeAllManips:function(){this._pois.forEach(function(e,t){this._unsubscribeManips(t)}.bind(this))},_subscribeAllManips:function(){this._pois.forEach(function(e,t){if(!0!==e.validated){var i=this._manips.get(t);i&&i.manip&&i.tokens&&(i.tokens=this._subscribeManip(i.manip,t))}}.bind(this))},_unsubscribeManips:function(e){var t=this._manips.get(e);if(t&&t.tokens&&t.manip)for(var i=t.tokens,o=0;o<i.length;o++)t.manip.unsubscribe(i[o])},_unsubscribePreactivateManips:function(e){var t=this._manips.get(e);if(t&&t.preactivate&&t.manip)for(var i=t.preactivate,o=0;o<i.length;o++)t.manip.unsubscribe(i[o])},_subscribeManip:function(e,t){var i=this._pois.get(t),n=[];if(i&&!0!==i.validated){var s=i.node;if(s){var r=this._pois.get(t).cross;this._pois.get(t).poiNode;n.push(e.subscribe("BeginManipulate",function(t){this._state===this.states.STARTED?(t.setPickable(l.NODRAWHL),this._context.getViewer().setCursor("pointer"),p.empty(),u.empty()):e.publish("EndManipulate")}.bind(this,s))),n.push(e.subscribe("Manipulate",function(t,i){if(this._state===this.states.STARTED){var n=this._context.getViewer().pick(this._context.getViewer().getMousePosition(i.event.from[0].currentPosition),"mesh",!0);if((n.path.length<=0||n.path[0]&&!c.isAModelPath(n.path[0]))&&this._lastPickInfo&&(n=this._lastPickInfo),n&&n.path.length&&c.isAModelPath(n.path[0])){this._lastPickInfo=n;var s=(new o.Matrix4).makeTranslation(n.position.x,n.position.y,n.position.z),a=this.retrievePositionMatrix(n.normal,new o.Vector3(0,0,0));r.setMatrix(a),t.setMatrix(s),this._context.getViewer().render()}}else e.publish("EndManipulate")}.bind(this,s))),n.push(e.subscribe("EndManipulate",function(e,t){if(t&&t.event){var n=this._context.getViewer().pick(this._context.getViewer().getMousePosition(t.event.from[0].currentPosition),"mesh",!0);if((n.path.length<=0||n.path[0]&&!c.isAModelPath(n.path[0]))&&(n=this._lastPickInfo),n.path.length&&c.isAModelPath(n.path[0])){var s=n.path[0];s&&(s=s.getParentPath());var a=(new o.Matrix4).makeTranslation(n.position.x,n.position.y,n.position.z),d=this.retrievePositionMatrix(n.normal,new o.Vector3(0,0,0));r.setMatrix(d),e.setMatrix(a),p.empty(),u.empty(),g.empty(),p.add({pathElement:s}),u.add({pathElement:s}),this._context.getViewer().render();var h={},_=new o.Vector3(n.position.x,n.position.y,n.position.z);if(s){h={};var f=s.getWorldMatrix(),v=s.getLastElement(!0).getBoundingSphere().center,m=(new o.Matrix4).makeTranslation(v.x,v.y,v.z),b=(new o.Matrix4).multiply(f,m),y=(new o.Matrix4).getInverse(b);if(v)(h=new o.Vector3(n.position.x,n.position.y,n.position.z)).applyProjection(y)}var P=this._pois.get(i.node.name);P&&(P.pathElement=s,P.absolutePosition={x:_.x,y:_.y,z:_.z},P.relativePosition=h);var D=this._context.streamPath(s),I={id:i.node.name,absolutePosition:{x:_.x,y:_.y,z:_.z},relativePosition:h,pathElement:D};this.switchToCGR(s),this.parametersChanged(I)}}e.setPickable(l.PICKABLE),this._context.getViewer().setCursor("auto")}.bind(this,s)))}}return n},removePOINode:function(e){if(e&&this._pois.has(e)){if(this._coloredPOIsMap.has(e)){var t=this._coloredPOIsMap.get(e);this._colorStreamJSON.splice(0,0,t),this._coloredPOIsMap.delete(e)}var i=this._pois.get(e);i.node&&(this._parentPOIsNode.removeChild(i.node),this._unsubscribeManips(e),this._unsubscribePreactivateManips(e),this._manips.delete(e),this._pois.delete(e))}},_getNewColor:function(){var e="#ADADAD";if(this._coloredPOIsMap&&this._coloredPOIsMap.size<this._colorStreamJSON.length-1){var t=this._colorStreamJSON.splice(0,1);t&&t[0]&&(e=t[0])}return e},switchToCGR:function(e){if(this._context&&e){var t=e.externalPath[e.externalPath.length-1];if(t&&"thumbnail"===this._context.getController().getLoadedStream(t)){var i={data:[{stream:"cgr",node:t}]};this._context.getController().switchNodeVisuStreamOnDemand(i),this._switchedToCGRNodes.push(t)}}},restoreSwitched:function(){if(this._context){for(var e=0;e<this._switchedToCGRNodes.length;e++){var t=this._switchedToCGRNodes[e];if(t&&"cgr"===this._context.getController().getLoadedStream(t)){var i={data:[{stream:"thumbnail",node:t}]};this._context.getController().switchNodeVisuStreamOnDemand(i)}}this._switchedToCGRNodes=[]}},retrievePositionMatrix:function(e,t){var i=new o.Vector3(1,0,0).cross(e).normalize();this.colinear(new o.Vector3(1,0,0),i)&&(i=new o.Vector3(0,1,0).cross(e).normalize());var n=(new o.Vector3).copy(e),s=(new o.Vector3).copy(i).cross(n).normalize();n.applyAxisAngle(s,Math.PI);var r=new o.Matrix4,a=(new o.Vector3).copy(t),l=r.elements;return l[0]=i.x,l[1]=i.y,l[2]=i.z,l[4]=s.x,l[5]=s.y,l[6]=s.z,l[8]=n.x,l[9]=n.y,l[10]=n.z,r.setPosition(a),r},colinear:function(e,t){var i=(new o.Vector3).copy(e),n=(new o.Vector3).copy(t),s=i.cross(n).length();return 0===Math.round(100*s)}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerCapturePOICmd",v)}),define("DS/ENOPAD3DViewer/views/PAD3DSphereNode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/Node3D","DS/Ruler/Ruler","DS/Mesh/MeshUtils","DS/ENOPAD3DViewer/views/PAD3DVolumeNode","DS/ENOPAD3DViewer/views/PAD3DVolumeManipulator","DS/ENOPAD3DViewer/views/PAD3DVolumeRobot"],function(e,t,i,o,n,s,r,a,l){"use strict";function d(e){r.call(this,e),this._manipTokens=[],this._manip=this._createManip(),this._matrix=new t.Matrix4,this._nodeToParent=new o("VolumeNode"+this.getId()),this._sceneBag=new o,this._node=new o,this._nodeToParent.addChild(this._sceneBag),this._sceneBag.addChild(this._node),this._parentNode.addChild(this._nodeToParent),this._token=0,this._radius=e.radius?e.radius:100,this._center=e.center?new t.Vector3(e.center.x,e.center.y,e.center.z):new t.Vector3(0,0,0),this._savedCenter=(new t.Vector3).copy(this._center),this._robot=new l({window:this._context,viewer:this._context.getViewer(),sceneGraph:this._nodeToParent,target:this._sceneBag}),this._robotToken=new Array(9),this._ruler=new n(this._context,{displayOrigin:!0,hideDuringLocalTransfo:!0,startPoint:0,startValue:0}),this._tokenLocalRuler=this._ruler.subscribe("RulerManipulate",function(e){this.updateFromRulerValue(e)}.bind(this)),this._matrix.translate(this._center),this.isEditable()||(this._ruler.setVisibleFlag(!1),this._robot.setVisibility(!1)),this.render()}return d.prototype=Object.create(r.prototype),d.prototype.updateFromRulerValue=function(e){if(this.isEditable()){if(e.value<0)return this._ruler.value=this._previousTranslate.length(),void this._ruler.refresh();var i=(new t.Vector3).copy(e.translationVector);if(0==i.x&&0==i.y&&0==i.z)return;this._previousTranslate.add(i);e.value,this._radius;this._radius=e.value,this.createSphere(),this._manip.unlink(this._token),this._manip=this._createManip(),this._token=this._manip.linkToNode(this._sceneBag),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}),this._context.getViewer().render()}},d.prototype._createManip=function(){var e=new a(this._context.getViewer());return this.isEditable()&&(this._manipTokens.push(e.subscribe("BeginManipulate",function(e){this._beginManipulateCB(e)}.bind(this))),this._manipTokens.push(e.subscribe("Manipulate",function(e){this._manipulateCB(e)}.bind(this))),this._manipTokens.push(e.subscribe("EndManipulate",function(e){this._endManipulateCB(e)}.bind(this))),this._manipTokens.push(e.subscribe("Preactivate",function(e){this._preactivateCB(e)}.bind(this))),this._manipTokens.push(e.subscribe("EndPreactivate",function(e){this._endPreactivateCB(e)}.bind(this)))),e},d.prototype.createSphere=function(){this._node&&this._node.removeChildren();var i=(new t.Matrix4).copy(this._matrix),n=new t.MeshBasicMaterial({transparent:!0,opacity:.5,enableClipPlanes:!1,color:this._fillColor,force:!0,side:t.DoubleSide}),s=e.createSphereNode({radius:this._radius,material:n});s.excludeFromCSO(!0),s.excludeFromHighlight(!0),s.setSSAO(!1),s.setShadow(!1,!1),this._node||(this._node=new o,this._sceneBag.add(this._node)),this._node.add(s);var r=new t.LineBasicMaterial({color:this._borderColor,side:t.DoubleSide,force:!0}),a=e.createCircleNode({radius:this._radius,material:r,segments:64});a.excludeFromCSO(!0),a.excludeFromHighlight(!0),a.setSSAO(!1),a.setShadow(!1,!1),this._node.setMatrix(i),this._node.addChild(a)},d.prototype.render=function(){this.createSphere(),this._manip=this._createManip(),this._token=this._manip.linkToNode(this._node),this._robot.updateRobotFromMatrix(this._matrix),this._sceneBag.addChild(this._node),this.isEditable()?this._robot.setVisibility(!0):this._robot.setVisibility(!1);var e=new i;return e.setFromArray([this._nodeToParent,this._sceneBag]),this.isEditable()&&(this._robot._robot.target=e,this._robot.updateRobotFromMatrix(this._matrix),this._robotToken[0]=this._robot._robot.subscribe("LineTranslationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[1]=this._robot._robot.subscribe("PlaneTranslationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[2]=this._robot._robot.subscribe("ScalingBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[3]=this._robot._robot.subscribe("LineTranslationManipulation",function(e){this.RobotTranslationManipulationCB(e)}.bind(this)),this._robotToken[4]=this._robot._robot.subscribe("PlaneTranslationManipulation",function(e){this.RobotTranslationManipulationCB(e)}.bind(this)),this._robotToken[5]=this._robot._robot.subscribe("ScalingManipulation",function(e){this.RobotScalingManipulationCB(e)}.bind(this)),this._robotToken[6]=this._robot._robot.subscribe("LineTranslationEnd",function(e){this.RobotEndTranslationManipulationCB(e)}.bind(this)),this._robotToken[7]=this._robot._robot.subscribe("PlaneTranslationEnd",function(e){this.RobotEndTranslationManipulationCB(e)}.bind(this)),this._robotToken[8]=this._robot._robot.subscribe("ScalingEnd",function(e){this.RobotEndScalingManipulationCB(e)}.bind(this))),this._context.getViewer().render(),this._sceneBag},d.prototype.BeginRobotManipulationCB=function(e){this.isEditable()&&(this._savedCenter.copy(this._center),this._savedRadius=this._radius,this._ruler.setVisibleFlag(!1),this._ruler.clear())},d.prototype.RobotTranslationManipulationCB=function(e){this.isEditable()&&(this._center.copy(this._savedCenter),this._center.add(e.translationVector))},d.prototype.RobotScalingManipulationCB=function(e){this.isEditable()&&(this._radius=this._savedRadius,this._radius*=e.scalingFactor)},d.prototype.RobotEndTranslationManipulationCB=function(e){this.isEditable()&&(this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},d.prototype.RobotEndScalingManipulationCB=function(e){this.isEditable()&&(this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},d.prototype.refreshAfterManipulation=function(){if(this.isEditable()){this._matrix=(new t.Matrix4).copy(this._robot._robot.getMatrix()),this._node&&this._node.removeChildren(),this._node=null,this._sceneBag&&(this._sceneBag.removeChildren(),this._nodeToParent.remove(this._sceneBag)),this._sceneBag=null,this._sceneBag=new o,this._nodeToParent.addChild(this._sceneBag),this._manip=null,this.createSphere(),this._manip=this._createManip(),this._token=this._manip.linkToNode(this._sceneBag);var e=new i;e.setFromArray([this._nodeToParent,this._sceneBag]),this._robot._robot.target=e,this._context.getViewer().render()}},d.prototype._beginManipulateCB=function(e){this.isEditable()&&(this._previousTranslate=new t.Vector3(0,0,0),this._normalVector=(new t.Vector3).copy(e.intersection.normal),this._ruler.clear(),this._ruler.origin=(new t.Vector3).copy(this._center),this._ruler.initValue=this._radius,this._ruler.value=this._ruler.initValue,this._ruler.direction=e.intersection.normal,this._ruler.setVisibleFlag(!0),this._robot.setVisibility(!1),this._ruler.display(),this._ruler.beginManipulation(),this.isModifiedByUser=!0)},d.prototype._manipulateCB=function(e){if(this.isEditable()){if(0!==this._ruler.getSnappedTranslationVector(e).returnCode)return null;var i=this._ruler.getSnappedTranslationVector(e).snappedTranslationVector,o=(new t.Vector3).copy(i).sub(this._previousTranslate);if(0==o.x&&0==o.y&&0==o.z)return;var n=o.dot(this._normalVector);o=(new t.Vector3).copy(i).sub(this._previousTranslate);var s=this._ruler.value+o.length()*(n>0?1:-1);if(s<=0)return;this._ruler.value=s,this._ruler.refresh(),this._previousTranslate.add(o);var r=(new t.Vector3).copy(this._normalVector).setLength(this._radius).add(o);this._radius=r.length(),this.createSphere(),this._context.getViewer().render(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}})}},d.prototype._endManipulateCB=function(e){this.isEditable()&&(this._manip.unlink(this._token),this._manip=this._createManip(),this._ruler.snapping=!1,this._ruler.endManipulation(),this._ruler.display(),this._robot.setVisibility(!0),this._token=this._manip.linkToNode(this._sceneBag),this._context.getViewer().render(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},d.prototype.getParameters=function(){return{id:this._id,type:"Sphere",center:this._center,radius:this._radius,editable:this.isEditable(),validated:this.isValidated()}},d.prototype.setParameters=function(e){if(!e)throw new Error("PAD3DBoxNode.setParameters: options is not defined");this._fillColor=e.fillColor?e.fillColor:this._fillColor,this._borderColor=e.borderColor?e.borderColor:this._borderColor,e.radius&&(this._radius=e.radius),e.center&&(this._center=new t.Vector3(e.center.x,e.center.y,e.center.z),this._matrix=(new t.Matrix4).translate(this._center)),!1!==e.editable&&!0!==e.editable||this.setEditable(e.editable),this.isEditable()||(this._ruler.setVisibleFlag(!1),this._robot.setVisibility(!1)),this.render()},d.prototype.destroy=function(){this._sceneBag.remove(this._robot._robot),this._sceneBag.remove(this._node),this._robot.setVisibility(!1),this._robot._ruler.setVisibleFlag(!1),this._robot._ruler.clear(),this._ruler.setVisibleFlag(!1),this._ruler.clear(),this._manipTokens.forEach(function(e){this._manip.unsubscribe(e)}.bind(this)),this._robotToken.forEach(function(e){this._robot._robot.unsubscribe(e)}.bind(this)),this._robot._ruler.unsubscribe(this._tokenRobotRuler),this._ruler.unsubscribe(this._tokenLocalRuler),this._manip.unlink(this._token),this._node&&this._node.removeChildren(),this._sceneBag&&this._sceneBag.removeChildren(),this._nodeToParent.remove(this._sceneBag),this._parentNode.remove(this._nodeToParent),delete this._previousTranslate,delete this._normalVector,delete this._matrix,delete this._nodeToParent,delete this._sceneBag,delete this._node,delete this._ruler,delete this._savedCenter,delete this._center,delete this._robotToken,this.getModelEvents(),this._nodeToParent=null,this._sceneBag=null,this._node=null},d}),define("DS/ENOPAD3DViewer/views/PAD3DPushpinNodeGroup",["css!DS/ENOPAD3DViewer/ENOPAD3DViewer","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture","DS/Visualization/Node3D","DS/ENOPAD3DViewer/views/PADPOIManipulator","DS/ENOPAD3DViewer/utils/PAD3DPOIDrawingFactory","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s,r,a){"use strict";function l(e){this._fillColor=e.fillColor?e.fillColor:"#FF4500",this._borderColor=e.borderColor?e.borderColor:"#000000",this._position=e.position,this._parent=e.parent,this._name=e.name,this._number=e.number,this._layerID=e.layerID,this._highlightColor="#368EC4",this._opacity=e.opacity,this._type=e.type?e.type:"2DClusteringNode",this._isVisible=!1,this._selected=!1,this.devicePixelRatio=window.devicePixelRatio||1,this._scale=void 0!==e.scale?e.scale:1,this._icon=void 0!==e.icon?e.icon:"default",this._borderColor="#000000",this._canvasNode=null,this._node=new n(this._name),this._node._layerId=this._layerID,this._parent.addChild(this._node),"2DClusteringNode"===this._type?(this._typeDraw="cluster",this._node.className="2DClusteringGroup"):(this._typeDraw="proximity",this._node.className="ProximityGroup"),this._onHoverCallback=e.onHoverCallback,this._outHoverCallback=e.outHoverCallback,this._hoverManipulator=new s(this._name),this._hoverManipulator.setSelectionAllowed(!0),this._hoverManipulator.setPreActivationDuringManipulation(!0),this._hoverManipulator.setPrePickingDuringManipulation(!0),this._hoverManipulator.subscribe("BeginPreactivate",this._onHoverCallback),this._hoverManipulator.subscribe("EndPreactivate",this._outHoverCallback),this._width=40*this.devicePixelRatio*this._scale,this._height=46*this.devicePixelRatio*this._scale,this._draw=r.draw({type:this._typeDraw,icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height,number:this._number,opacity:this._opacity}})}return l.prototype.getId=function(){return this._name},l.prototype.render=function(){delete this._canvasNode,this._node.removeChildren(),this._draw=r.draw({type:this._typeDraw,icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height,number:this._number,opacity:this._opacity}});var e=new o({width:this._width,height:this._height,drawCB:this._draw,alphaTest:.02});this._canvasNode=t.createCanvas2DNode({canvasNodeTexture:e,hotspot:new i.Vector2(this._width/2-("flag"===this._icon?5*this._scale:0),5*this._scale)}),this._canvasNode.setPickParent(!0),"3D"===a.getPOIType()&&this._canvasNode.rectangle.setNoZ(!1),this._canvasNode.rectangle.setPickParent(!0),this._node.addChild(this._canvasNode),this._canvasNode.setMatrix((new i.Matrix4).setPosition(this._position)),this._hoverManipulator&&this._hoverManipulator.linkToNode(this._canvasNode.rectangle)},l.prototype.setVisibility=function(e){e&&!this._isVisible?(this._parent.addChild(this._node),this._canvasNode||this.render(),this._node.addChild(this._canvasNode),this._isVisible=!0):!e&&this._isVisible&&(this._parent.remove(this._node),this._node.removeChildren(),this._isVisible=!1)},l.prototype.isVisible=function(){return this._isVisible},l.prototype.setHighlight=function(e){this._selected=e,this.render()},l.prototype.getLayerID=function(){return this._layerID},l.prototype.getNode=function(){return this._node},l.prototype.getType=function(){return this._node.className},l.prototype._draw3DNode=function(e,t){t.fillStyle=this._fillColor,t.save(),t.translate(this._width/2,this._height-6*this.devicePixelRatio),t.lineWidth=.5*this.devicePixelRatio,t.beginPath(),t.moveTo(0,0),t.bezierCurveTo(2*this.devicePixelRatio,-6*this.devicePixelRatio,-20*this.devicePixelRatio,-25*this.devicePixelRatio,0,-30*this.devicePixelRatio),t.bezierCurveTo(20*this.devicePixelRatio,-25*this.devicePixelRatio,-2*this.devicePixelRatio,-6*this.devicePixelRatio,0,0),t.fill(),t.strokeStyle=this._borderColor,t.stroke(),t.fillStyle="#EA4F37",t.beginPath(),t.arc(8*this.devicePixelRatio,-30*this.devicePixelRatio,9*this.devicePixelRatio,0,2*Math.PI),t.closePath(),t.fill(),t.fillStyle=this._borderColor,t.beginPath(),t.arc(0,-20*this.devicePixelRatio,1*this.devicePixelRatio,0,2*Math.PI),t.closePath(),t.fill(),t.stroke(),t.fillStyle="black",t.strokeStyle="black",t.beginPath(),t.arc(0,-21*this.devicePixelRatio,3*this.devicePixelRatio,0,2*Math.PI),t.closePath(),t.fill(),t.lineWidth=.4*this.devicePixelRatio,t.beginPath(),t.ellipse(0,0,10*this.devicePixelRatio,3*this.devicePixelRatio,0,-Math.PI/3,-2*Math.PI/3),t.stroke(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="#F4F5F6";var i="",o=0;try{this._number<10?t.font=12*this.devicePixelRatio+"px pad-3ds-light":this._number<100?(t.font=11*this.devicePixelRatio+"px pad-3ds-light",o=1):this._number<1e3?t.font=9*this.devicePixelRatio+"px pad-3ds-light":(t.font=7*this.devicePixelRatio+"px pad-3ds-light",o=1)}catch(e){console.error(e)}i=this._number<1e3?this._number+"":"999+",t.fillText(i,8*this.devicePixelRatio+o*this.devicePixelRatio,-30*this.devicePixelRatio)},l.prototype._draw2DNode=function(e,t){t.fillStyle=this._fillColor,t.save(),t.translate(this._width/2,this._height-6*this.devicePixelRatio),t.lineWidth=.5*this.devicePixelRatio,t.beginPath(),t.moveTo(0,0),t.bezierCurveTo(2*this.devicePixelRatio,-6*this.devicePixelRatio,-20*this.devicePixelRatio,-25*this.devicePixelRatio,0,-30*this.devicePixelRatio),t.bezierCurveTo(20*this.devicePixelRatio,-25*this.devicePixelRatio,-2*this.devicePixelRatio,-6*this.devicePixelRatio,0,0),t.fill(),t.strokeStyle=this._borderColor,t.stroke(),t.fillStyle="#EA4F37",t.beginPath(),t.arc(8*this.devicePixelRatio,-30*this.devicePixelRatio,9*this.devicePixelRatio,0,2*Math.PI),t.closePath(),t.fill(),t.fillStyle=this._borderColor,t.beginPath(),t.arc(0,-21*this.devicePixelRatio,3*this.devicePixelRatio,0,2*Math.PI),t.closePath(),t.fill(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="#F4F5F6";var i="",o=0;this._number<10?t.font=12*this.devicePixelRatio+"px pad-3ds-light":this._number<100?(t.font=11*this.devicePixelRatio+"px pad-3ds-light",o=1):this._number<1e3?t.font=9*this.devicePixelRatio+"px pad-3ds-light":(t.font=7*this.devicePixelRatio+"px pad-3ds-light",o=1),i=this._number<1e3?this._number+"":"999+",t.fillText(i,8*this.devicePixelRatio+o*this.devicePixelRatio,-30*this.devicePixelRatio)},l.prototype.setOpacity=function(e){this._opacity=e,this._isVisible&&this.render()},l.prototype.setColor=function(e){this._fillColor=e,this._isVisible&&this.render()},l}),define("DS/ENOPAD3DViewer/views/PAD3DBoxNode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Ruler/Ruler","DS/Manipulators/LineTranslationManipulator","DS/ENOPAD3DViewer/views/PAD3DVolumeNode","DS/ENOPAD3DViewer/views/PAD3DVolumeRobot"],function(e,t,i,o,n,s,r,a,l,d){"use strict";function h(e){if(l.call(this,e),this._sceneBag=new n("VolumeNode"+this.getId()),this._robotMatrix=new t.Matrix4,this._savedCornerPoint=new t.Vector3,this._savedFstAxis=new t.Vector3,this._savedSndAxis=new t.Vector3,this._savedThdAxis=new t.Vector3,this._rotationCenter=new t.Vector3,this._faceNodes=new Array(6),this._token=new Array(6),this._faceNodeBag=new n("BoxVolumeSelector"),this._sceneBag.addChild(this._faceNodeBag),this._preactivatedFaceId=-1,this._preactivatedFace=new n("preactivatedFace"),this._faceNodeBag.addChild(this._preactivatedFace),this._manips=new Array(6),this._overManager=null,this._geomHelper=new o,this._previousTranslate=null,this._parentNode.addChild(this._sceneBag),this._manipulatedFace=0,e.min&&e.max)this._min=e.min,this._max=e.max,this._cornerPoint=new t.Vector3(this._min.x,this._min.y,this._min.z),this._firstAxis=new t.Vector3(this._max.x-this._min.x,0,0),this._secondAxis=new t.Vector3(0,this._max.y-this._min.y,0),this._thirdAxis=new t.Vector3(0,0,this._max.z-this._min.z);else if(e.cornerPoint&&e.axes){if(this._min={x:e.cornerPoint.x,y:e.cornerPoint.y,z:e.cornerPoint.z},this._max={x:e.cornerPoint.x+e.axes[0].x,y:e.cornerPoint.y+e.axes[1].y,z:e.cornerPoint.z+e.axes[2].z},this._cornerPoint=new t.Vector3(e.cornerPoint.x,e.cornerPoint.y,e.cornerPoint.z),this._firstAxis=new t.Vector3(e.axes[0].x,0,0),this._secondAxis=new t.Vector3(0,e.axes[1].y,0),this._thirdAxis=new t.Vector3(0,0,e.axes[2].z),e.matrix){var i=(new t.Matrix4).setFromArray(e.matrix),s=i.decompose();this._firstAxis.multiplyScalar(s[2].x),this._secondAxis.multiplyScalar(s[2].y),this._thirdAxis.multiplyScalar(s[2].z),this._cornerPoint.add(s[0]);var a=(new t.Matrix4).extractRotation(i);this._cornerPoint.applyMatrix4(a),this._firstAxis.applyMatrix4(a),this._secondAxis.applyMatrix4(a),this._thirdAxis.applyMatrix4(a),this._robotMatrix.multiply(a)}}else this._min={x:-300,y:-300,z:-300},this._max={x:300,y:300,z:300},this._cornerPoint=new t.Vector3(this._min.x,this._min.y,this._min.z),this._firstAxis=new t.Vector3(this._max.x-this._min.x,0,0),this._secondAxis=new t.Vector3(0,this._max.y-this._min.y,0),this._thirdAxis=new t.Vector3(0,0,this._max.z-this._min.z);this._robot=new d({window:this._context,viewer:this._context.getViewer(),sceneGraph:this._sceneBag,target:this._faceNodeBag}),this._robotToken=new Array(13),this._ruler=new r(this._context,{displayOrigin:!0,hideDuringLocalTransfo:!0,startPoint:0,startValue:0}),this._tokenLocalRuler=this._ruler.subscribe("RulerManipulate",function(e){this.updateFromRulerValue(e)}.bind(this)),this.isEditable()||(this._ruler.setVisibleFlag(!1),this._robot.setVisibility(!1)),this.render()}return h.prototype=Object.create(l.prototype),h.prototype.updateFromRulerValue=function(e){if(this.isEditable()){var i=null,o=this.getFaceNormal(this._manipulatedFace);this.colinear(o,this._firstAxis)?i=this._firstAxis:this.colinear(o,this._secondAxis)?i=this._secondAxis:this.colinear(o,this._thirdAxis)&&(i=this._thirdAxis);var n=e.value,s=(new t.Vector3).copy(i),r=i.length();if(n<0)return this._ruler.value=r,void this._ruler.refresh();var a=n-r;if(a<0?(a*=-1,s.setLength(a).multiplyScalar(-1)):s.setLength(a),this._previousTranslate.add(s),0==this._manipulatedFace){if(0==(l=(new t.Vector3).copy(this._thirdAxis).add(s)).length())return;this._thirdAxis.copy(l)}else if(1==this._manipulatedFace){if(0==(l=(new t.Vector3).copy(this._firstAxis).add(s)).length())return;this._firstAxis.copy(l)}else if(2==this._manipulatedFace){if(0==(l=(new t.Vector3).copy(this._secondAxis).add(s)).length())return;this._secondAxis.copy(l)}else if(3==this._manipulatedFace){if(0==(l=(new t.Vector3).copy(this._firstAxis).add(s)).length())return;this._firstAxis.copy(l)}else if(4==this._manipulatedFace){if(0==(l=(new t.Vector3).copy(this._secondAxis).add(s)).length())return;this._secondAxis.copy(l)}else if(5==this._manipulatedFace){var l;if(0==(l=(new t.Vector3).copy(this._thirdAxis).add(s)).length())return;this._thirdAxis.copy(l)}0!=this._manipulatedFace&&1!=this._manipulatedFace&&2!=this._manipulatedFace||this._cornerPoint.sub(s),this.isEditable()&&this.refreshAfterManipulation();var d=(new t.Vector3).copy(this._firstAxis).multiplyScalar(.5),h=(new t.Vector3).copy(this._secondAxis).multiplyScalar(.5),c=(new t.Vector3).copy(this._thirdAxis).multiplyScalar(.5),p=(new t.Vector3).copy(this._cornerPoint);p.add(d),p.add(h),p.add(c),this._robotMatrix.setPosition(p),this.isEditable()&&this._robot.updateRobotFromMatrix(this._robotMatrix),this._context.getViewer().render(),this._boxUpdate=!1,this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()})}},h.prototype.colinear=function(e,i){var o=(new t.Vector3).copy(e),n=(new t.Vector3).copy(i),s=o.cross(n).length();return 0==Math.round(100*s)},h.prototype.getFaceNormal=function(e){var i=null,o=null;switch(e){case 0:i=(new t.Vector3).copy(this._secondAxis),o=(new t.Vector3).copy(this._firstAxis);break;case 1:i=(new t.Vector3).copy(this._thirdAxis),o=(new t.Vector3).copy(this._secondAxis);break;case 2:i=(new t.Vector3).copy(this._firstAxis),o=(new t.Vector3).copy(this._thirdAxis);break;case 3:i=(new t.Vector3).copy(this._secondAxis),o=(new t.Vector3).copy(this._thirdAxis);break;case 4:i=(new t.Vector3).copy(this._thirdAxis),o=(new t.Vector3).copy(this._firstAxis);break;case 5:i=(new t.Vector3).copy(this._firstAxis),o=(new t.Vector3).copy(this._secondAxis)}return(new t.Vector3).copy(o).cross(i).normalize()},h.prototype._createManip=function(e,i){var o=new a({axis:(new t.Vector3).copy(i)});return this.isEditable()&&(o.setExclusive(!0),e>=0&&(o.subscribe("BeginManipulate",function(t){this.beginManipulateCB(e,t)}.bind(this)),o.subscribe("Manipulate",function(t){this.manipulateCB(e,t)}.bind(this)),o.subscribe("EndManipulate",function(t){this.endManipulateCB(e,t)}.bind(this)),o.subscribe("BeginPreactivate",function(t){this.beginPreactivateCB(e,t)}.bind(this)),o.subscribe("EndPreactivate",function(t){this.endPreactivateCB(e,t)}.bind(this)))),o},h.prototype.createFaceAndEdge=function(i){this._faceNodes[i]&&this._faceNodes[i].removeChildren();var o=null,s=null,r=null;switch(i){case 0:o=this._cornerPoint,s=this._secondAxis,r=this._firstAxis;break;case 1:o=this._cornerPoint,s=this._thirdAxis,r=this._secondAxis;break;case 2:o=this._cornerPoint,s=this._firstAxis,r=this._thirdAxis;break;case 3:o=(new t.Vector3).copy(this._cornerPoint).add(this._firstAxis),s=this._secondAxis,r=this._thirdAxis;break;case 4:o=(new t.Vector3).copy(this._cornerPoint).add(this._secondAxis),s=this._thirdAxis,r=this._firstAxis;break;case 5:o=(new t.Vector3).copy(this._cornerPoint).add(this._thirdAxis),s=this._firstAxis,r=this._secondAxis}var a=this.createRectangle({corner:o,firstAxis:s,secondAxis:r}),l=e.createMeshNode(a);l.excludeFromCSO(!0),l.excludeFromHighlight(!0),l.setSSAO(!1),l.setShadow(!1,!1),this._faceNodes[i]||(this._faceNodes[i]=new n("Face"+i),this._faceNodeBag.add(this._faceNodes[i])),this._faceNodes[i].add(l),this._manips[i]&&this._manips[i].unlink(this._token[i]),this._manips[i]=null,this._manips[i]||(this._manips[i]=this._createManip(i,(new t.Vector3).copy(s).cross(r).normalize()),this._token[i]=this._manips[i].linkToNode(this._faceNodes[i])),this._overManager=this._createManip(-1,new t.Vector3)},h.prototype.createRectangle=function(e){var i,o,n,r,a,l,d,h,c,p,u,g=this._hexToRgb(this._borderColor),_=e.corner,f=e.firstAxis,v=e.secondAxis;(i=new s.PrimitiveGroup).fillAttr=new s.FillAttributes,i.lineAttr=new s.LineAttributes,i.pointAttr=new s.PointAttributes,(o=new s.Buffer).size=12,o.component=s.VertexComponentEnum.POSITION,o.format=s.DataTypeEnum.FLOAT,o.dimension=3,o.data=new Float32Array(12),(r=new s.Buffer).indexBuffer=!0,r.size=9,r.format=s.DataTypeEnum.UINT,r.dimension=1,r.data=new Uint16Array(9),(n=new s.Buffer).size=3,n.component=s.VertexComponentEnum.NORMAL,n.format=s.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(3),(a=new s.Buffer).indexBuffer=!0,a.size=4,a.format=s.DataTypeEnum.UINT,a.dimension=1,a.data=new Uint16Array(4),i.addBuffer(0,o),i.addBuffer(1,r),i.addBuffer(2,n),i.addBuffer(3,a),d=0,(l=o.data)[d++]=_.x,l[d++]=_.y,l[d++]=_.z,u=(new t.Vector3).copy(_).add(f),l[d++]=u.x,l[d++]=u.y,l[d++]=u.z,u=(new t.Vector3).copy(_).add(f).add(v),l[d++]=u.x,l[d++]=u.y,l[d++]=u.z,u=(new t.Vector3).copy(_).add(v),l[d++]=u.x,l[d++]=u.y,l[d++]=u.z,(l=r.data)[0]=0,l[1]=1,l[2]=3,l[3]=2,(l=n.data)[0]=0,l[1]=0,l[2]=1,(l=a.data)[0]=0,l[1]=0,l[2]=0,l[3]=0,(h=new s.Primitive).nbIndices=4,h.connectivity=s.ConnectivityTypeEnum.TRIANGLE_STRIP,h.material=new t.MeshBasicMaterial({side:t.DoubleSide,color:this._fillColor,opacity:.5,transparent:!0}),(c=new s.VertexComponent).component=s.VertexComponentEnum.POSITION,c.nbVertices=4,c.nbValuesPerVertex=3,c.format=s.DataTypeEnum.FLOAT,c.cardinality=0,c.bufferId=0,c.indices=new s.IndexArray,c.indices.format=s.DataTypeEnum.UINT,c.indices.bufferId=1,c.indices.offset=0,h.addVertexComponent(c),(p=new s.VertexComponent).component=s.VertexComponentEnum.NORMAL,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=s.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=2,p.indices=new s.IndexArray,p.indices.format=s.DataTypeEnum.UINT,p.indices.bufferId=3,p.indices.offset=0,h.addVertexComponent(p),i.addPrimitive(h),d=4,(l=r.data)[d++]=0,l[d++]=1,l[d++]=2,l[d++]=3,l[d++]=0;var m=new s.Primitive;return m.nbIndices=4,m.connectivity=s.ConnectivityTypeEnum.LINE_STRIP,m.attr={fill:new s.FillAttributes,line:new s.LineAttributes(new s.Color(parseInt(g.r,16)/255,parseInt(g.g,16)/255,parseInt(g.b,16)/255)),point:new s.PointAttributes},(c=new s.VertexComponent).component=s.VertexComponentEnum.POSITION,c.nbVertices=5,c.nbValuesPerVertex=3,c.format=s.DataTypeEnum.FLOAT,c.cardinality=0,c.bufferId=0,c.indices=new s.IndexArray,c.indices.format=s.DataTypeEnum.UINT,c.indices.bufferId=1,c.indices.offset=4,m.addVertexComponent(c),i.addPrimitive(m),i.noz=!1,i},h.prototype.render=function(){for(var e=0;e<6;e++)this.createFaceAndEdge(e);this.isEditable()?this._robot.setVisibility(!0):this._robot.setVisibility(!1);var o=new i;if(o.setFromArray([this._sceneBag,this._faceNodeBag]),this.isEditable()){this._robot.setTarget(o);var n=(new t.Vector3).copy(this._firstAxis).multiplyScalar(.5),s=(new t.Vector3).copy(this._secondAxis).multiplyScalar(.5),r=(new t.Vector3).copy(this._thirdAxis).multiplyScalar(.5),a=(new t.Vector3).copy(this._cornerPoint);a.add(n),a.add(s),a.add(r),this._robotMatrix.setPosition(a),this._robot.updateRobotFromMatrix(this._robotMatrix),this._robotToken[0]=this._robot._robot.subscribe("LineTranslationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[1]=this._robot._robot.subscribe("RotationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[2]=this._robot._robot.subscribe("PlaneTranslationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[3]=this._robot._robot.subscribe("ScalingBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[4]=this._robot._robot.subscribe("LineTranslationManipulation",function(e){this.RobotTranslationManipulationCB(e)}.bind(this)),this._robotToken[5]=this._robot._robot.subscribe("RotationManipulation",function(e){this.RobotRotationManipulationCB(e)}.bind(this)),this._robotToken[6]=this._robot._robot.subscribe("PlaneTranslationManipulation",function(e){this.RobotTranslationManipulationCB(e)}.bind(this)),this._robotToken[7]=this._robot._robot.subscribe("ScalingManipulation",function(e){this.RobotScalingManipulationCB(e)}.bind(this)),this._robotToken[8]=this._robot._robot.subscribe("LineTranslationEnd",function(e){this.RobotEndTranslationManipulationCB(e)}.bind(this)),this._robotToken[9]=this._robot._robot.subscribe("RotationEnd",function(e){this.RobotRotationEndCB(e)}.bind(this)),this._robotToken[10]=this._robot._robot.subscribe("PlaneTranslationEnd",function(e){this.RobotEndTranslationManipulationCB(e)}.bind(this)),this._robotToken[11]=this._robot._robot.subscribe("ScalingEnd",function(e){this.RobotEndScalingManipulationCB(e)}.bind(this))}return this._context.getViewer().render(),this._sceneBag},h.prototype.BeginRobotManipulationCB=function(e){this.isEditable()&&(this._savedCornerPoint.copy(this._cornerPoint),this._savedFstAxis.copy(this._firstAxis),this._savedSndAxis.copy(this._secondAxis),this._savedThdAxis.copy(this._thirdAxis),this._preactivatedFace.removeChildren(),this._whileManipulation=!0,this._ruler.setVisibleFlag(!1),this._ruler.clear())},h.prototype.RobotTranslationManipulationCB=function(e){this.isEditable()&&(this._cornerPoint.copy(this._savedCornerPoint),this._cornerPoint.add(e.translationVector))},h.prototype.RobotRotationManipulationCB=function(e){this.isEditable()&&(this._cornerPoint.copy(this._savedCornerPoint),this._firstAxis.copy(this._savedFstAxis),this._secondAxis.copy(this._savedSndAxis),this._thirdAxis.copy(this._savedThdAxis),this._cornerPoint.applyMatrix4(e.rotationMatrix),this._firstAxis.applyMatrix4(e.rotationMatrix),this._secondAxis.applyMatrix4(e.rotationMatrix),this._thirdAxis.applyMatrix4(e.rotationMatrix),this._rotationCenter.copy(e.rotationCenter))},h.prototype.RobotRotationEndCB=function(e){if(this.isEditable()){var i=(new t.Vector3).copy(this._firstAxis).multiplyScalar(.5),o=(new t.Vector3).copy(this._secondAxis).multiplyScalar(.5),n=(new t.Vector3).copy(this._thirdAxis).multiplyScalar(.5),s=(new t.Vector3).copy(this._cornerPoint);s.add(i),s.add(o),s.add(n);var r=(new t.Vector3).copy(s).sub(this._rotationCenter);this._cornerPoint.sub(r),this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()})}},h.prototype.RobotScalingManipulationCB=function(e){if(this.isEditable()){this._firstAxis.copy(this._savedFstAxis),this._secondAxis.copy(this._savedSndAxis),this._thirdAxis.copy(this._savedThdAxis),this._cornerPoint.copy(e.scalingCenter),this._firstAxis.multiplyScalar(e.scalingFactor),this._secondAxis.multiplyScalar(e.scalingFactor),this._thirdAxis.multiplyScalar(e.scalingFactor);var i=(new t.Vector3).copy(this._firstAxis).multiplyScalar(.5),o=(new t.Vector3).copy(this._secondAxis).multiplyScalar(.5),n=(new t.Vector3).copy(this._thirdAxis).multiplyScalar(.5);this._cornerPoint.sub(i),this._cornerPoint.sub(o),this._cornerPoint.sub(n)}},h.prototype.RobotEndScalingManipulationCB=function(e){this.isEditable()&&(this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},h.prototype.RobotEndTranslationManipulationCB=function(e){this.isEditable()&&(this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},h.prototype.refreshAfterManipulation=function(){if(this.isEditable()){this._robotMatrix.copy(this._robot._robot.getMatrix()),this._preactivatedFace.removeChildren(),this._whileManipulation=!1;for(var e=0;e<6;e++)this._manips[e]&&(this._manips[e].unsubscribe(this._token[e]),this._manips[e].unlink(this._token[e])),this._manips[e]=null,this._faceNodes[e]&&this._faceNodes[e].removeChildren(),this._faceNodes[e]=null;this._faceNodeBag&&(this._faceNodeBag.removeChildren(),this._sceneBag.remove(this._faceNodeBag)),this._faceNodes=new Array(6),this._faceNodeBag=new n("BoxVolumeSelector"),this._sceneBag.addChild(this._faceNodeBag),this._manips=new Array(6);for(e=0;e<6;e++)this.createFaceAndEdge(e);var t=new i;t.setFromArray([this._sceneBag,this._faceNodeBag]),this._robot.setTarget(t),this.isEditable()&&this._robot.updateRobotFromMatrix(this._robotMatrix),this._context.getViewer().render()}},h.prototype.beginManipulateCB=function(e,i){if(this.isEditable()){this._previousTranslate=new t.Vector3(0,0,0),this._preactivatedFace.removeChildren(),this._whileManipulation=!0,this.isModifiedByUser=!0,this._ruler.clear();(new t.Vector3).getPositionFromMatrix(this._robotMatrix);var o=this.getFaceNormal(e),n=null;this.colinear(o,this._firstAxis)?n=this._firstAxis:this.colinear(o,this._secondAxis)?n=this._secondAxis:this.colinear(o,this._thirdAxis)&&(n=this._thirdAxis);var s=null,r=null;switch(e){case 0:s=(new t.Vector3).copy(this._cornerPoint),r=this._firstAxis;break;case 1:s=(new t.Vector3).copy(this._cornerPoint),r=this._secondAxis;break;case 2:s=(new t.Vector3).copy(this._cornerPoint).sub(this._thirdAxis),r=this._thirdAxis;break;case 3:s=(new t.Vector3).copy(this._cornerPoint).add(this._firstAxis).sub(this._thirdAxis),r=this._thirdAxis;break;case 4:s=(new t.Vector3).copy(this._cornerPoint).add(this._secondAxis),r=this._firstAxis;break;case 5:s=(new t.Vector3).copy(this._cornerPoint).add(this._thirdAxis),r=this._secondAxis}var a=(new t.Vector3).copy(o).setLength(n.length()).add((new t.Vector3).copy(r).setLength(r.length()));this._ruler.origin=(new t.Vector3).copy(s).add(a),this._ruler.initValue=n.length(),this._ruler.value=this._ruler.initValue,this._ruler.direction=o.multiplyScalar(-1),this._ruler.setVisibleFlag(!0),this._ruler.display(),this._ruler.beginManipulation(),this._robot.setVisibility(!1),this._context.getViewer().render()}},h.prototype.manipulateCB=function(e,i){if(this.isEditable()){if(e<0||e>5)return void console.warn("Invalid callback index.");if(0!==this._ruler.getSnappedTranslationVector(i).returnCode)return null;var o,n=this._ruler.getSnappedTranslationVector(i).snappedTranslationVector,s=(new t.Vector3).copy(n).sub(this._previousTranslate),r=s.dot(this.getFaceNormal(e));if(this._ruler.value+s.length()*(r<0?1:-1)<=0)return;if(this._previousTranslate.add(s),0==e){if(0==(a=(new t.Vector3).copy(this._thirdAxis).sub(s)).length())return;this._thirdAxis.copy(a)}else if(1==e){if(0==(a=(new t.Vector3).copy(this._firstAxis).sub(s)).length())return;this._firstAxis.copy(a)}else if(2==e){if(0==(a=(new t.Vector3).copy(this._secondAxis).sub(s)).length())return;this._secondAxis.copy(a)}else if(3==e){if(0==(a=(new t.Vector3).copy(this._firstAxis).add(s)).length())return;this._firstAxis.copy(a)}else if(4==e){if(0==(a=(new t.Vector3).copy(this._secondAxis).add(s)).length())return;this._secondAxis.copy(a)}else if(5==e){var a;if(0==(a=(new t.Vector3).copy(this._thirdAxis).add(s)).length())return;this._thirdAxis.copy(a)}0!=e&&1!=e&&2!=e||this._cornerPoint.add(s),o=void 0!==i.paths&&1===i.paths.length?i.paths[0].getMatrix():new t.Matrix4;var l=(new t.Vector3).getPositionFromMatrix(o).add(s);o.setPosition(l),i.paths[0].getLastElement(!0).setMatrix(o),this.refresh(e),this._context.getViewer().render(),this._ruler.value+=s.length()*(r<0?1:-1),this._ruler.refresh();var d=(new t.Vector3).copy(this._firstAxis).multiplyScalar(.5),h=(new t.Vector3).copy(this._secondAxis).multiplyScalar(.5),c=(new t.Vector3).copy(this._thirdAxis).multiplyScalar(.5),p=(new t.Vector3).copy(this._cornerPoint);p.add(d),p.add(h),p.add(c),this._robotMatrix.setPosition(p),this._robot.updateRobotFromMatrix(this._robotMatrix),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}})}},h.prototype.endManipulateCB=function(e,t){this.isEditable()&&(this._ruler.snapping=!1,this._ruler.endManipulation(),this._ruler.display(),this._robot.setVisibility(!0),this._whileManipulation=!1,this._context.getViewer().render(),this._manipulatedFace=e,this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},h.prototype.beginPreactivateCB=function(i,o){if(this.isEditable()){if(this._whileManipulation)return!0;var n=null,s=null,r=null;switch(i){case 0:n=this._cornerPoint,s=this._secondAxis,r=this._firstAxis;break;case 1:n=this._cornerPoint,s=this._thirdAxis,r=this._secondAxis;break;case 2:n=this._cornerPoint,s=this._firstAxis,r=this._thirdAxis;break;case 3:n=(new t.Vector3).copy(this._cornerPoint).add(this._firstAxis),s=this._secondAxis,r=this._thirdAxis;break;case 4:n=(new t.Vector3).copy(this._cornerPoint).add(this._secondAxis),s=this._thirdAxis,r=this._firstAxis;break;case 5:n=(new t.Vector3).copy(this._cornerPoint).add(this._thirdAxis),s=this._firstAxis,r=this._secondAxis}var a=(new t.Vector3).copy(s);a.cross(r),a.normalize(),a.setLength(.05);var l=(new t.Vector3).copy(n).sub(a),d=this.createRectangle({corner:l,firstAxis:s,secondAxis:r}),h=e.createMeshNode(d);return h.excludeFromCSO(!0),h.excludeFromHighlight(!0),h.setSSAO(!1),h.setShadow(!1,!1),this._preactivatedFace.removeChildren(),this._preactivatedFace.add(h),this._preactivatedFaceId=i,this._context.getViewer().render(),this.publish({event:"onPreactivate",data:{id:this._id,preactivatedFaceId:this._preactivatedFaceId}}),!0}},h.prototype.endPreactivateCB=function(e,t){return!!this._whileManipulation||(this._preactivatedFace.removeChildren(),this._preactivatedFaceId=-1,this._context.getViewer().render(),this.publish({event:"onEndPreactivate",data:{id:this._id}}),!0)},h.prototype.refresh=function(e){if(this.isEditable())for(var t=0;t<6;t++)t!=e&&this.createFaceAndEdge(t)},h.prototype.destroy=function(){for(var e=0;e<6;e++)this._manips[e]&&this._manips[e].unlink(this._token[e]),this._manips[e]=null,this._faceNodes[e]&&this._faceNodes[e].removeChildren(),this._faceNodes[e]=null;this._faceNodeBag&&(this._faceNodeBag.removeChildren(),this._sceneBag.remove(this._faceNodeBag)),this._preactivatedFace&&this._preactivatedFace.removeChildren(),this._context.getDecorationBag().remove(this._sceneBag),this._preactivatedFace=null,this._preactivatedFaceId=-1,this._faceNodeBag=null,this._sceneBag.remove(this._robot._robot),this._robot.setVisibility(!1),this._robot._ruler.setVisibleFlag(!1),this._robot._ruler.clear(),this._ruler.setVisibleFlag(!1),this._ruler.clear(),this._parentNode.remove(this._sceneBag),this._robotToken.forEach(function(e){this._robot._robot.unsubscribe(e)}.bind(this)),this._robot._ruler.unsubscribe(this._tokenRobotRuler),this._ruler.unsubscribe(this._tokenLocalRuler),delete this._previousTranslate,delete this._cornerPoint,delete this._firstAxis,delete this._secondAxis,delete this._thirdAxis,delete this._robot,delete this._ruler,delete this._faceNodes,delete this._token,delete this._faceNodeBag,delete this._manips,delete this._geomHelper,this.getModelEvents(),delete this._tokenRobotRuler,delete this._robotToken,delete this._savedCornerPoint,delete this._savedFstAxis,delete this._savedSndAxis,delete this._savedThdAxis,delete this._rotationCenter,delete this._preactivatedFace,delete this._robotMatrix},h.prototype.getParameters=function(){var e=this._faceNodeBag.getBoundingBox(),i=(new t.Matrix4).copy(this._robotMatrix).setPosition(this._cornerPoint);return{id:this._id,type:"Box",cornerPoint:this._cornerPoint,axes:[this._firstAxis,this._secondAxis,this._thirdAxis],min:e.min,max:e.max,matrix:i,editable:this.isEditable(),validated:this.isValidated()}},h.prototype.setParameters=function(e){if(!e)throw new Error("PAD3DBoxNode.setParameters: options is not defined");if(e.cornerPoint?(this._cornerPoint=new t.Vector3(e.cornerPoint.x,e.cornerPoint.y,e.cornerPoint.z),e.axes&&3===e.axes.length&&(this._firstAxis=new t.Vector3(e.axes[0].x,0,0),this._secondAxis=new t.Vector3(0,e.axes[1].y,0),this._thirdAxis=new t.Vector3(0,0,e.axes[2].z),this._min={x:e.cornerPoint.x,y:e.cornerPoint.y,z:e.cornerPoint.z},this._max={x:e.cornerPoint.x+e.axes[0].x,y:e.cornerPoint.y+e.axes[1].y,z:e.cornerPoint.z+e.axes[2].z})):e.min&&(this._cornerPoint=new t.Vector3(e.min.x,e.min.y,e.min.z),this._min=e.min),e.max&&(this._max=e.max,this._firstAxis=new t.Vector3(e.max.x-this._cornerPoint.x,0,0),this._secondAxis=new t.Vector3(0,e.max.y-this._cornerPoint.y,0),this._thirdAxis=new t.Vector3(0,0,e.max.z-this._cornerPoint.z)),this._fillColor=e.fillColor?e.fillColor:this._fillColor,this._borderColor=e.borderColor?e.borderColor:this._borderColor,!1!==e.editable&&!0!==e.editable||this.setEditable(e.editable),e.matrix){var i=(new t.Matrix4).setFromArray(e.matrix),o=i.decompose();this._firstAxis.multiplyScalar(o[2].x),this._secondAxis.multiplyScalar(o[2].y),this._thirdAxis.multiplyScalar(o[2].z),this._cornerPoint.add(o[0]);var n=(new t.Matrix4).extractRotation(i);this._cornerPoint.applyMatrix4(n),this._firstAxis.applyMatrix4(n),this._secondAxis.applyMatrix4(n),this._thirdAxis.applyMatrix4(n),this._robotMatrix.copy(n);var s=(new t.Vector3).copy(this._firstAxis).multiplyScalar(.5),r=(new t.Vector3).copy(this._secondAxis).multiplyScalar(.5),a=(new t.Vector3).copy(this._thirdAxis).multiplyScalar(.5),l=(new t.Vector3).copy(this._cornerPoint);l.add(s),l.add(r),l.add(a),this._robotMatrix.setPosition(l)}this.render()},h}),define("DS/ENOPAD3DViewer/views/PAD3DCylinderNode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Ruler/Ruler","DS/Manipulators/LineTranslationManipulator","DS/ENOPAD3DViewer/views/PAD3DVolumeNode","DS/ENOPAD3DViewer/views/PAD3DVolumeRobot","DS/ENOPAD3DViewer/views/PAD3DVolumeManipulator"],function(e,t,i,o,n,s,r,a,l,d,h){"use strict";function c(e){l.call(this,e),this._activate_console_traces=!1,this._nodeToParent=new n("VolumeNode"+this.getId()),this._sceneBag=new n("VolumeNodeSceneBag"+this.getId()),this._nodeToParent.addChild(this._sceneBag),this._preactivatedFaceId=-1,this._preactivatedFace=new n("preactivatedFace"),this._faceNodes=new Array(3),this._token=new Array(3),this._tubeNode=new n("CylinderSurface2"),this._faceNodeBagLidBtm=new n("CylinderLidBtm"),this._faceNodeBagLidTop=new n("CylinderLidTop"),this._sceneBag.addChild(this._preactivatedFace),this._sceneBag.addChild(this._faceNodeBagLidBtm),this._sceneBag.addChild(this._faceNodeBagLidTop),this._sceneBag.addChild(this._tubeNode),this._manips=new Array(3),this._overManager=null,this._geomHelper=new o,this._previousTranslate=null,this._parentNode.addChild(this._nodeToParent),this._manipulatedFace=0,this._robot=new d({window:this._context,viewer:this._context.getViewer(),sceneGraph:this._nodeToParent,target:this._sceneBag}),this._robotToken=new Array(13),this._ruler=new r(this._context,{displayOrigin:!0,hideDuringLocalTransfo:!0,startPoint:0,startValue:0}),this._tokenLocalRuler=this._ruler.subscribe("RulerManipulate",function(e){this.updateFromRulerValue(e)}.bind(this)),this._radius=e.radius?e.radius:50,this._bottomCenter=e.bottomCenter?new t.Vector3(e.bottomCenter.x,e.bottomCenter.y,e.bottomCenter.z):new t.Vector3(0,0,0),this._heightVectorInit=e.heightVector?new t.Vector3(e.heightVector.x,e.heightVector.y,e.heightVector.z):new t.Vector3(0,0,100),this.isEditable()||(this._ruler.setVisibleFlag(!1),this._robot.setVisibility(!1)),this.initDatas(e)}return c.prototype=Object.create(l.prototype),c.prototype.initDatas=function(e){this._fillColor=e.fillColor?e.fillColor:this._fillColor,this._borderColor=e.borderColor?e.borderColor:this._borderColor,this._manipTokensTube=[],this._robotMatrix=new t.Matrix4,this._robotMatrix=e.matrix?e.matrix:this._robotMatrix,this._robotranslationvec=new t.Vector3(0,0,0),this._robotScalingFactor=1,this._robotScalingFactorCumulative=1,this._heightVectorWithScaling=(new t.Vector3).copy(this._heightVectorInit),this._bEndScalingUsed=!1,this._heightVecScalingFactor=1,this._savedCenter=(new t.Vector3).copy(this._bottomCenter),this._savedHeightVector=(new t.Vector3).copy(this._heightVectorInit),this._savedScalingHtVec=(new t.Vector3).copy(this._heightVectorInit),this._translationVector=new t.Vector3(0,0,0),this._ruler_BeginManip=1,this._htVec_BeginManip=new t.Vector3(0,0,1),this._ruler_Btm_BeginManip=1,this._htVec_Btm_BeginManip=new t.Vector3(0,0,1),this._ruler_Btm_Manip=1,this._htVec_Btm_Manip=new t.Vector3(0,0,1),this._ruler_Btm_Manip_Prev=0,this._htVec_Btm_Manip_Prev=new t.Vector3(0,0,1),this._circleRepBtm=void 0,this._circleRepTop=void 0,this._manipTube=this._createManipTube(),this._robotMatrixInit=new t.Matrix4,this._robotMatrixInit.setPosition(this._bottomCenter),this.initMatricesForBottomAndTopCircles();var i=(new t.Matrix4).copy(this._bottomCircleMatrix_Quater);if(this._robotMatrixInit.multiply(i),this._robotMatrix=this._robotMatrixInit,this.consolelog(" init:_robotMatrix "+JSON.stringify(this._robotMatrix)),this._sceneBag){var o=new t.Matrix4,n=this._bottomCenter;o.setPosition(n),this.consolelog(" vAccountforBtmCntr "+JSON.stringify(o));var s=o.multiply(i);this.consolelog(" vTmp "+JSON.stringify(s)),this._sceneBag.setMatrix(s)}this.render(),this._robot.updateRobotFromMatrix(this._robotMatrixInit)},c.prototype.updateFromRulerValue=function(e){if(this.isEditable()&&e.value>0){var i=null;0===this._manipulatedFace&&(i=new t.Vector3(0,0,this._heightVectorInit.z)),1===this._manipulatedFace&&(i=new t.Vector3(0,0,this._heightVectorInit.z)),2===this._manipulatedFace&&(i=new t.Vector3(this._radius,0,0));var o=e.value,n=((new t.Vector3).copy(i),i.length());if(0===this._manipulatedFace){var s=(new t.Vector3).copy(this._ruler.direction);s.normalize().multiplyScalar(o-this._ruler.initValue),this._bottomCenter.add(s),this._robotMatrix=this._robot._robot.getMatrix(),this._robotMatrix.setPosition(this._bottomCenter),this._robot.updateRobotFromMatrix(this._robotMatrix),this._robotMatrix=this._robot._robot.getMatrix(),this._sceneBag.setMatrix(this._robot._robot.getMatrix()),this._heightVectorWithScaling.normalize().multiplyScalar(o);var r=this._heightVectorWithScaling.length()/this._heightVecScalingFactor;this._heightVectorInit.normalize().multiplyScalar(r)}if(1===this._manipulatedFace){this._heightVectorWithScaling.normalize().multiplyScalar(o);r=this._heightVectorWithScaling.length()/this._heightVecScalingFactor;this._heightVectorInit.normalize().multiplyScalar(r)}if(2===this._manipulatedFace&&(this._radius=o),o<0)return this._ruler.value=n,void this._ruler.refresh();if(this.isEditable()&&this.refreshAfterManipulation(),this._robotMatrix.setPosition(this._bottomCenter),this.isEditable()&&this._sceneBag){var a=(new t.Vector3).getPositionFromMatrix(this._sceneBag._matrix);this._robot._robot._matrix.setPosition(a),this._robot.updateRobotFromMatrix(this._robot._robot._matrix)}this._context.getViewer().render(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()})}},c.prototype.colinear=function(e,i){var o=(new t.Vector3).copy(e),n=(new t.Vector3).copy(i),s=o.cross(n).length();return 0==Math.round(100*s)},c.prototype.getFaceNormal=function(e){var i=null,o=null;switch(e){case 0:i=new t.Vector3(0,1,0),o=new t.Vector3(1,0,0);break;case 1:i=new t.Vector3(1,0,0),o=new t.Vector3(0,1,0);break;case 2:i=new t.Vector3(0,1,0),o=new t.Vector3(0,0,1)}return(new t.Vector3).copy(o).cross(i).normalize()},c.prototype._createManipTube=function(){var e=new h(this._context.getViewer());return this.isEditable()&&(this._manipTokensTube.push(e.subscribe("BeginManipulate",function(e){this.beginManipulateCB(2,e)}.bind(this))),this._manipTokensTube.push(e.subscribe("Manipulate",function(e){this.manipulateCB(2,e)}.bind(this))),this._manipTokensTube.push(e.subscribe("EndManipulate",function(e){this.endManipulateCB(2,e)}.bind(this))),this._manipTokensTube.push(e.subscribe("Preactivate",function(e){this.beginPreactivateCB(2,e)}.bind(this))),this._manipTokensTube.push(e.subscribe("EndPreactivate",function(e){this.endPreactivateCB(2,e)}.bind(this)))),e},c.prototype._createManip=function(e,i){var o=new a({axis:(new t.Vector3).copy(i)});return this.isEditable()&&(o.setExclusive(!0),e>=0&&(o.subscribe("BeginManipulate",function(t){this.beginManipulateCB(e,t)}.bind(this)),o.subscribe("Manipulate",function(t){this.manipulateCB(e,t)}.bind(this)),o.subscribe("EndManipulate",function(t){this.endManipulateCB(e,t)}.bind(this)),o.subscribe("BeginPreactivate",function(t){this.beginPreactivateCB(e,t)}.bind(this)),o.subscribe("EndPreactivate",function(t){this.endPreactivateCB(e,t)}.bind(this)))),o},c.prototype.createTubeForChangedBtmFace=function(i){this._tubeNode.removeChildren();var o=this._radius*this._heightVectorInit.length()/this._heightVectorWithScaling.length(),n=o+1,s=new t.MeshBasicMaterial({transparent:!0,opacity:.5,enableClipPlanes:!1,color:this._fillColor,force:!0,side:t.DoubleSide}),r=new t.Vector3(i.x,i.y,i.z),a=new t.Vector3(r.x,r.y,r.z),l=(new t.Vector3).copy(this._heightVectorInit).length(),d=new t.Vector3(0,0,l),h=e.createTubeNode({bottomCenterPoint:a,extrusionVector:d,internalRadius:o,externalRadius:n,sag:40,material:s});h.name="CylTube2Node3D",h.excludeFromCSO(!0),h.excludeFromHighlight(!0),h.setSSAO(!1),h.setShadow(!1,!1),this._tubeNode.addChild(h),this._context.getViewer().render()},c.prototype.createTube=function(){this._tubeNode.removeChildren();var i=this._radius*this._heightVectorInit.length()/this._heightVectorWithScaling.length(),o=i+1,n=new t.MeshBasicMaterial({transparent:!0,opacity:.5,enableClipPlanes:!1,color:this._fillColor,force:!0,side:t.DoubleSide}),s=new t.Vector3(0,0,0),r=new t.Vector3(s.x,s.y,s.z),a=(new t.Vector3).copy(this._heightVectorInit).length(),l=new t.Vector3(0,0,a),d=e.createTubeNode({bottomCenterPoint:r,extrusionVector:l,internalRadius:i,externalRadius:o,sag:40,material:n});d.name="CylTube2Node3D",d.excludeFromCSO(!0),d.excludeFromHighlight(!0),d.setSSAO(!1),d.setShadow(!1,!1),this._tubeNode.addChild(d),this._context.getViewer().render()},c.prototype.createCircles=function(i){this.consolelog(" --\x3e> createCircles ");var o=!1,s=null,r=null;switch(i){case 0:s=new t.Vector3(0,1,0),r=new t.Vector3(1,0,0),o=!0;break;case 1:s=new t.Vector3(1,0,0),r=new t.Vector3(0,1,0),o=!0}if(!0===o){var a;this._faceNodes[i]&&this._faceNodes[i].removeChildren();var l=this._radius*this._heightVectorInit.length()/this._heightVectorWithScaling.length()+1,d=new t.MeshBasicMaterial({transparent:!0,opacity:.5,enableClipPlanes:!1,color:this._fillColor,force:!0,side:t.DoubleSide}),h=e.createCircleNode({radius:l,segments:32,fill:!0,material:d,color:this._fillColor});if(0===i){var c=new t.Matrix4,p=(new t.Vector3).getPositionFromMatrix(this._robotMatrix);c.setPosition(p),this._circleRepBtm=h}var u=new t.Matrix4;if(1===i){var g=(new t.Vector3).copy(this._heightVectorInit),_=new t.Vector3(0,0,g.length());u.setPosition(_),this._circleRepTop=h}(a=h).excludeFromCSO(!0),a.excludeFromHighlight(!0),a.setSSAO(!1),a.setShadow(!1,!1),(!this._faceNodes[i]||this._faceNodes[i]&&0===this._faceNodes[i].children.length)&&(0===i&&(this._faceNodes[i]=new n("CylBtmFace"+i),this._faceNodeBagLidBtm.add(this._faceNodes[i])),1===i&&(this._faceNodes[i]=new n("CylTopFace"+i),this._faceNodeBagLidTop.add(this._faceNodes[i]),this._faceNodeBagLidTop.setMatrix(u))),this._faceNodes[i].add(a),this._manips[i]&&2!=i&&this._manips[i].unlink(this._token[i]),this._manips[i]=null,this._manips[i]||2==i||(this._manips[i]=this._createManip(i,(new t.Vector3).copy(s).cross(r).normalize()),this._token[i]=this._manips[i].linkToNode(this._faceNodes[i])),this._overManager=this._createManip(1,new t.Vector3)}},c.prototype.render=function(){for(var e=0;e<2;e++)this.createCircles(e);this.createTube(),this._manipTube.unlink(this._tubeToken),this._manipTube=this._createManipTube(),this._tubeToken=this._manipTube.linkToNode(this._tubeNode),this.isEditable()?this._robot.setVisibility(!0):this._robot.setVisibility(!1);var t=new i;return t.setFromArray([this._nodeToParent,this._sceneBag]),this.isEditable()&&(this._robot.setTarget(t),this._robotToken[0]=this._robot._robot.subscribe("LineTranslationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[1]=this._robot._robot.subscribe("RotationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[2]=this._robot._robot.subscribe("PlaneTranslationBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[3]=this._robot._robot.subscribe("ScalingBegin",function(e){this.BeginRobotManipulationCB(e)}.bind(this)),this._robotToken[4]=this._robot._robot.subscribe("LineTranslationManipulation",function(e){this.RobotTranslationManipulationCB(e)}.bind(this)),this._robotToken[5]=this._robot._robot.subscribe("RotationManipulation",function(e){this.RobotRotationManipulationCB(e)}.bind(this)),this._robotToken[6]=this._robot._robot.subscribe("PlaneTranslationManipulation",function(e){this.RobotTranslationManipulationCB(e)}.bind(this)),this._robotToken[7]=this._robot._robot.subscribe("ScalingManipulation",function(e){this.RobotScalingManipulationCB(e)}.bind(this)),this._robotToken[8]=this._robot._robot.subscribe("LineTranslationEnd",function(e){this.RobotEndTranslationManipulationCB(e)}.bind(this)),this._robotToken[9]=this._robot._robot.subscribe("RotationEnd",function(e){this.RobotRotationEndCB(e)}.bind(this)),this._robotToken[10]=this._robot._robot.subscribe("PlaneTranslationEnd",function(e){this.RobotEndTranslationManipulationCB(e)}.bind(this)),this._robotToken[11]=this._robot._robot.subscribe("ScalingEnd",function(e){this.RobotEndScalingManipulationCB(e)}.bind(this))),this._context.getViewer().render(),this._sceneBag},c.prototype.BeginRobotManipulationCB=function(e){this.isEditable()&&(this._preactivatedFace.removeChildren(),this._whileManipulation=!0,this._savedHeightVector.copy(this._heightVectorInit),this._savedCenter.copy(this._bottomCenter),this._ruler.setVisibleFlag(!1),this._ruler.clear())},c.prototype.RobotTranslationManipulationCB=function(e){this.isEditable()&&(this._robotranslationvec=e.translationVector)},c.prototype.RobotRotationManipulationCB=function(e){this.isEditable()},c.prototype.RobotRotationEndCB=function(e){this.isEditable()&&(this._savedCenter=this._bottomCenter,this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},c.prototype.RobotScalingManipulationCB=function(e){this.isEditable()&&(this._robotScalingFactor=e.scalingFactor),this._bEndScalingUsed=!1},c.prototype.RobotEndScalingManipulationCB=function(e){if(this.isEditable()&&!this._bEndScalingUsed){this._radius*=this._robotScalingFactor;var i=new t.Vector3(0,0,0),o=(new t.Matrix4).copy(this._sceneBag.getMatrix());o.setPosition(i);var n=this._heightVectorInit.x*o.elements[0]+this._heightVectorInit.y*o.elements[1]+this._heightVectorInit.z*o.elements[2],s=this._heightVectorInit.x*o.elements[4]+this._heightVectorInit.y*o.elements[5]+this._heightVectorInit.z*o.elements[6],r=this._heightVectorInit.x*o.elements[8]+this._heightVectorInit.y*o.elements[9]+this._heightVectorInit.z*o.elements[10],a=new t.Vector3(n,s,r);this._heightVectorWithScaling=a;var l=this._heightVectorWithScaling.length();(a=(new t.Vector3).copy(this._heightVectorInit)).normalize().multiplyScalar(l),this._heightVectorWithScaling=a,this._robotScalingFactor=1,this._bEndScalingUsed=!0,this.refreshAfterManipulation(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()})}},c.prototype.RobotEndTranslationManipulationCB=function(e){this.isEditable()&&(this._bottomCenter.add(this._robotranslationvec),this._savedCenter=this._bottomCenter,this.refreshAfterManipulation(),this._robotranslationvec.x=0,this._robotranslationvec.y=0,this._robotranslationvec.z=0,this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()}))},c.prototype.refreshAfterManipulation=function(){if(this.isEditable()){this._robotMatrix.copy(this._robot._robot.getMatrix()),this._preactivatedFace.removeChildren(),this._whileManipulation=!1;for(var e=0;e<3;e++)this._manips[e]&&(this._manips[e].unsubscribe(this._token[e]),this._manips[e].unlink(this._token[e])),this._manips[e]=null,this._faceNodes[e]&&this._faceNodes[e].removeChildren(),this._faceNodes[e]=null;this._faceNodeBagLidBtm&&this._faceNodeBagLidBtm.removeChildren(),this._faceNodeBagLidTop&&this._faceNodeBagLidTop.removeChildren(),this._faceNodes=new Array(2),this._manips=new Array(2);for(e=0;e<2;e++)this.createCircles(e);this.createTube(),this._manipTube.unlink(this._tubeToken),this._manipTube=this._createManipTube(),this._tubeToken=this._manipTube.linkToNode(this._tubeNode);var o=new i;if(o.setFromArray([this._nodeToParent,this._sceneBag]),this._robot.setTarget(o),this.isEditable()&&this._sceneBag){var n=(new t.Vector3).getPositionFromMatrix(this._sceneBag._matrix);(new t.Vector3).getPositionFromMatrix(this._robot._robot._matrix);this._robot._robot._matrix.setPosition(n),this._robot.updateRobotFromMatrix(this._robot._robot._matrix)}this._context.getViewer().render()}},c.prototype.beginManipulateCB=function(e,i){if(this.isEditable()){var o;this._previousTranslate=new t.Vector3(0,0,0),this._normalVector=(new t.Vector3).copy(i.intersection.normal),this._preactivatedFace.removeChildren(),this._whileManipulation=!0,this.isModifiedByUser=!0,this._ruler.clear();var n=null;if(0===e&&(o=new t.Vector3(0,0,1),n=new t.Vector3(0,0,this._heightVectorInit.z)),1===e&&(o=new t.Vector3(1,0,0),n=new t.Vector3(0,0,this._heightVectorInit.z)),2===e){o=new t.Vector3(1,0,0);var s=(new t.Vector3).copy(i.intersection.normal);s.multiplyScalar(this._radius),n=s}var r=new t.Vector3(1,0,0);r=n;var a=(new t.Vector3).copy(o).setLength(n.length()).add((new t.Vector3).copy(r).setLength(r.length())),l=i.intersection.position;if(this._ruler.origin=(new t.Vector3).copy(l).add(a),this._ruler.direction=i.intersection.normal,this._ruler.initValue=n.length(),0===e){var d=this._faceNodes[0].children[0].mesh3js.position,h=this._faceNodes[1].children[0].mesh3js.position,c=new t.Vector3(d.x,d.y,d.z),p=new t.Vector3(-h.x+d.x,-h.y+d.y,-h.z+d.z);this._ruler.direction.x=p.x,this._ruler.direction.y=p.y,this._ruler.direction.z=p.z,this._ruler.origin.x=h.x,this._ruler.origin.y=h.y,this._ruler.origin.z=h.z;var u=(new t.Vector3).copy(this._heightVectorWithScaling);this._ruler.initValue=u.length(),this._htVec_Btm_BeginManip=(new t.Vector3).copy(this._heightVectorInit),this._ruler_Btm_BeginManip=this._ruler.initValue,this._heightVecScalingFactor=this._heightVectorWithScaling.length()/this._heightVectorInit.length()}if(1===e){d=this._faceNodes[0].children[0].mesh3js.position,c=new t.Vector3(d.x,d.y,d.z);this._ruler.origin.x=c.x,this._ruler.origin.y=c.y,this._ruler.origin.z=c.z;h=this._faceNodes[1].children[0].mesh3js.position;this._ruler.direction.x=h.x-d.x,this._ruler.direction.y=h.y-d.y,this._ruler.direction.z=h.z-d.z;u=(new t.Vector3).copy(this._heightVectorWithScaling);this._ruler.initValue=u.length(),this._htVec_BeginManip=(new t.Vector3).copy(this._heightVectorInit),this._ruler_BeginManip=this._ruler.initValue,this._heightVecScalingFactor=this._heightVectorWithScaling.length()/this._heightVectorInit.length()}if(2===e){this._ruler.initValue=this._radius;var g=(new t.Vector3).copy(i.intersection.normal);g.normalize().multiplyScalar(this._radius),this._ruler.origin=(new t.Vector3).copy(l),this._ruler.origin.sub(g)}this._ruler.value=this._ruler.initValue,this._ruler.setVisibleFlag(!0),this._ruler.display(),this._ruler.beginManipulation(),this._robot.setVisibility(!1),this._context.getViewer().render()}},c.prototype.manipulateCB=function(e,i){if(this.isEditable()){if(e<0||e>2)return void console.warn("Invalid callback index.");if(0!==this._ruler.getSnappedTranslationVector(i).returnCode)return null;var o=this._ruler.getSnappedTranslationVector(i).snappedTranslationVector,n=(new t.Vector3).copy(o).sub(this._previousTranslate);if(0==n.x&&0==n.y&&0==n.z)return;if(0===e){var s=(a=n.dot(this._normalVector))>0?1:-1;if((l=this._ruler.value+n.length()*s)<=0)return;this._previousTranslate.add(n),this._heightVectorWithScaling.normalize().multiplyScalar(l);var r=this._heightVectorWithScaling.length()/this._heightVecScalingFactor;this._heightVectorInit.normalize().multiplyScalar(r),this._ruler.value=l}if(1===e){var a=n.dot(this._normalVector);if((l=this._ruler.value+n.length()*(a>0?1:-1))<=0)return;this._previousTranslate.add(n),this._heightVectorWithScaling.normalize().multiplyScalar(l);r=this._heightVectorWithScaling.length()/this._heightVecScalingFactor;this._heightVectorInit.normalize().multiplyScalar(r),this._ruler.value=l}if(2===e){var l;a=n.dot(this._normalVector);if((l=this._ruler.value+n.length()*(a>0?1:-1))<=0&&(l=-l),l<=0)return;this._ruler.value=l,this._ruler.refresh(),this._previousTranslate.add(n);var d=(new t.Vector3).copy(this._normalVector).setLength(this._radius).add(n);this._radius=d.length(),this._ruler.direction=i.intersection.normal,this._ruler.value=this._radius}this._ruler.refresh(),this.refresh(e),this._context.getViewer().render(),this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}})}},c.prototype.endManipulateCB=function(e,i){if(this.isEditable()){if(0===e){var o=(new t.Vector3).copy(this._ruler.direction);o.normalize().multiplyScalar(this._previousTranslate.length());var n=(new t.Vector3).copy(o);n.normalize().multiplyScalar(this._ruler.value-this._ruler_Btm_BeginManip),this._bottomCenter.add(n),this._robotMatrix=this._robot._robot.getMatrix(),this._robotMatrix.setPosition(this._bottomCenter),this._robot.updateRobotFromMatrix(this._robotMatrix),this._robotMatrix=this._robot._robot.getMatrix(),this._sceneBag.setMatrix(this._robot._robot.getMatrix())}this.refreshAll(),this._manipTube.unlink(this._tubeToken),this._manipTube=this._createManipTube(),this._tubeToken=this._manipTube.linkToNode(this._tubeNode),this._ruler.snapping=!1,this._ruler.endManipulation(),this._ruler.display(),this._robot.setVisibility(!0),this._whileManipulation=!1,this._context.getViewer().render(),this._manipulatedFace=e,this.publish({event:"EndManipulationVolume",data:{id:this._id,params:this.getParameters()}}),this._callbackManipulateCB({id:this._id,params:this.getParameters()})}},c.prototype.beginPreactivateCB=function(e,t){},c.prototype.endPreactivateCB=function(e,t){return!!this._whileManipulation||(this._preactivatedFace.removeChildren(),this._preactivatedFaceId=-1,this._context.getViewer().render(),this.publish({event:"onEndPreactivate",data:{id:this._id}}),!0)},c.prototype.refresh=function(e){if(this.isEditable()){this.consolelog(" --\x3e refresh with iFaceToExclude as "+e);for(var t=0;t<2;t++)t!=e&&(0===e&&1===t||this.createCircles(t));0===e?this.createTubeForChangedBtmFace(this._previousTranslate):this.createTube()}},c.prototype.refreshAll=function(){if(this.isEditable()){for(var e=0;e<2;e++)this.createCircles(e);this.createTube()}},c.prototype.destroy=function(){for(var e=0;e<3;e++)this._manips[e]&&this._manips[e].unlink(this._token[e]),this._manips[e]=null,this._faceNodes[e]&&this._faceNodes[e].removeChildren(),this._faceNodes[e]=null;this._faceNodeBagLidBtm&&(this._faceNodeBagLidBtm.removeChildren(),this._sceneBag.remove(this._faceNodeBagLidBtm)),this._faceNodeBagLidTop&&(this._faceNodeBagLidTop.removeChildren(),this._sceneBag.remove(this._faceNodeBagLidTop)),this._preactivatedFace&&(this._preactivatedFace.removeChildren(),this._sceneBag.remove(this._preactivatedFace)),this._preactivatedFace=null,this._preactivatedFaceId=-1,this._faceNodeBagLidBtm=null,this._faceNodeBagLidTop=null,this._sceneBag.remove(this._robot._robot),this._robot.setVisibility(!1),this._robot._ruler.setVisibleFlag(!1),this._robot._ruler.clear(),this._ruler.setVisibleFlag(!1),this._ruler.clear(),this._parentNode.remove(this._nodeToParent),this._nodeToParent.remove(this._sceneBag),this._robotToken.forEach(function(e){this._robot._robot.unsubscribe(e)}.bind(this)),this._robot._ruler.unsubscribe(this._tokenRobotRuler),this._ruler.unsubscribe(this._tokenLocalRuler),delete this._previousTranslate,delete this._robot,delete this._ruler,delete this._faceNodes,delete this._token,delete this._faceNodeBagLidBtm,delete this._faceNodeBagLidTop,delete this._manips,delete this._geomHelper,this.getModelEvents(),delete this._tokenRobotRuler,delete this._robotToken,delete this._preactivatedFace,delete this._normalVector,delete this._robotMatrix},c.prototype.getParameters=function(){var e=new t.Vector3(0,0,0),i=new t.Vector3(0,0,1),o=i;return this._circleRepBtm&&this._circleRepTop&&(e=this._circleRepBtm.mesh3js.position,new t.Vector3(e.x,e.y,e.z),i=this._circleRepTop.mesh3js.position,o=new t.Vector3(i.x-e.x,i.y-e.y,i.z-e.z)),{id:this._id,type:"Cylinder",radius:this._radius,bottomCenter:{x:this._bottomCenter.x,y:this._bottomCenter.y,z:this._bottomCenter.z},heightVector:{x:o.x,y:o.y,z:o.z},editable:this.isEditable(),validated:this.isValidated()}},c.prototype.setParameters=function(e){if(!e)throw new Error("PAD3DCylinderNode.setParameters: options is not defined");!1!==e.editable&&!0!==e.editable||this.setEditable(e.editable),e.radius&&(this._radius=e.radius),e.bottomCenter&&(this._bottomCenter=new t.Vector3(e.bottomCenter.x,e.bottomCenter.y,e.bottomCenter.z)),e.heightVector&&(this._heightVectorInit=new t.Vector3(e.heightVector.x,e.heightVector.y,e.heightVector.z)),this.initDatas(e)},c.prototype.initMatricesForBottomAndTopCircles=function(){this._bottomCircleMatrix_Quater=new t.Matrix4,this._topCircleMatrix_Quater=new t.Matrix4;var e=(new t.Vector3).copy(this._bottomCenter),i=this._heightVectorInit.length(),o=this._heightVectorInit.normalize().multiplyScalar(i);e.add(o);var n=new t.Vector3(this._heightVectorInit.x,this._heightVectorInit.y,this._heightVectorInit.z),s=new t.Vector3(0,0,1),r=new t.Vector3(n.x,n.y,n.z);this._QuaterMat=this.getRotMatbyquaternion(s,r),this._bottomCircleMatrix_Quater.multiply(this._QuaterMat),this._topCircleMatrix_Quater.multiply(this._QuaterMat)},c.prototype.getRotMatbyquaternion=function(e,i){var o=new t.Vector3;e.normalize(),i.normalize();var n=0,s=0,r=0,a=1+e.dot(i);a<1e-6?(a=0,Math.abs(e.x)>Math.abs(e.z)?(n=-e.y,s=e.x,r=0):(n=0,s=-e.z,r=e.y)):(o.crossVectors(e,i),n=o.x,s=o.y,r=o.z);var l=n,d=s,h=r,c=a,p=1/Math.sqrt(l*l+d*d+h*h+c*c);l*=p,d*=p,h*=p,c*=p;new t.Matrix4;var u=new t.Matrix4;return u.elements[0]=1-2*(d*d+h*h),u.elements[4]=2*(l*d-h*c),u.elements[8]=2*(l*h+d*c),u.elements[3]=0,u.elements[1]=2*(l*d+h*c),u.elements[5]=1-2*(l*l+h*h),u.elements[9]=2*(d*h-l*c),u.elements[7]=0,u.elements[2]=2*(l*h-d*c),u.elements[6]=2*(d*h+l*c),u.elements[10]=1-2*(l*l+d*d),u.elements[11]=0,u.elements[12]=0,u.elements[13]=0,u.elements[14]=0,u.elements[15]=1,u},c.prototype.consolelog=function(e){this._activate_console_traces&&console.log(e)},c}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerDisplay3DVolumeCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/ENOPAD3DViewer/views/PAD3DBoxNode","DS/ENOPAD3DViewer/views/PAD3DSphereNode","DS/ENOPAD3DViewer/views/PAD3DCylinderNode"],function(e,t,i,o,n,s,r,a,l){"use strict";var d=t.extend({states:{STOPPED:0,STARTED:1,ADD:2},_state:0,init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0}),this._toAddCount=0,this._addedCount=0,this._context=i.get(this.options.context),this._csoTokens=[],this._lastPickInfo=null,require(["DS/PADUtils/PADCommandProxy"],function(e){this._volumeCommandProxy=e.create({events:{onDisplay3DVolume:function(e){}.bind(this)}})}.bind(this)),this._abortCB=[],this._volumesParentNode=new n("3DVolumes"),this._volumes=new Map,this._executing=!1},display3DVolume:function(e){var t=e;this._executing||(this._context.getDecorationBag().add(this._volumesParentNode),this._volumesParentNode.removeChildren(),this._abortCB.push(this._context.subscribe({event:"onRootRemoved"},function(e){this.abort()}.bind(this))),this._executing=!0),t.new?this.createVolume(t.new):t.edit?this.edit(t.edit):t.get?this.getParams(t.get):t.validate?this.validate(t.validate):t.delete?this.removeVolume(t.delete):t.end&&this.end()},execute:function(e){this.display3DVolume(e)},abort:function(){this._volumeCommandProxy.display3DVolume({abort:{}}),this.end()},end:function(){this._volumesParentNode.removeChildren();for(var e=0;e<this._abortCB.length;e++)this._context.unsubscribe(this._abortCB[e]);this._volumes.forEach(function(e){e.destroy()}.bind(this)),this._volumes.clear(),this._context.getDecorationBag().removeChild(this._volumesParentNode),this._executing=!1,this._state="STOPPED",this._context.getViewer().render()},parametersChanged:function(e){this._volumeCommandProxy.display3DVolume({parametersChanged:e.params})},createVolume:function(e){if(!e||!e.id||!e.box&&!e.sphere&&!e.cylinder||!this._volumes||this._volumes.has(e.id))throw new Error("display3DVolume new: Wrong input parameters");var t=null;e.box?t=new r({id:e.id,type:"Box",fillColor:e.fillColor,borderColor:e.borderColor,editable:e.editable,min:e.box.min,max:e.box.max,cornerPoint:e.box.cornerPoint,axes:e.box.axes,matrix:e.box.matrix,parentNode:this._volumesParentNode,endManipulateCB:this.parametersChanged.bind(this)}):e.sphere?t=new a({id:e.id,type:"Sphere",fillColor:e.fillColor,borderColor:e.borderColor,editable:e.editable,center:e.sphere.center,radius:e.sphere.radius,parentNode:this._volumesParentNode,endManipulateCB:this.parametersChanged.bind(this)}):e.cylinder&&(t=new l({id:e.id,type:"Cylinder",fillColor:e.fillColor,borderColor:e.borderColor,editable:e.editable,heightVector:e.cylinder.heightVector,radius:e.cylinder.radius,bottomCenter:e.cylinder.bottomCenter,parentNode:this._volumesParentNode,endManipulateCB:this.parametersChanged.bind(this)})),t&&this._volumes.set(e.id,t)},validate:function(e){if(!e||!e.id)throw new Error("display3DVolume validate: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume validate: No volume with this ID");var t=this._volumes.get(e.id);if(t){var i=t.validate();this.parametersChanged({params:i})}},removeVolume:function(e){if(!e||!e.id)throw new Error("display3DVolume delete: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume delete: No volume with this ID");if(this._volumes){var t=this._volumes.get(e.id);t&&(this._volumes.delete(e.id),t.destroy(),t=null)}this._context.getViewer().render()},getParams:function(e){if(!e||!e.id||!this._volumes.has(e.id))throw new Error("display3DVolume get: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume get: No volume with this ID");var t=this._volumes.get(e.id);if(t){var i=t.getParameters();this.parametersChanged({params:i})}},edit:function(e){if(!e||!e.id||!e.box&&!e.sphere&&!e.cylinder)throw new Error("display3DVolume edit: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume edit: No volume with this ID");var t=this._volumes.get(e.id);if(t){e.box?t.setParameters({editable:e.editable,fillColor:e.fillColor,borderColor:e.borderColor,cornerPoint:e.box.cornerPoint,axes:e.box.axes,matrix:e.box.matrix,min:e.box.min,max:e.box.max}):e.sphere?t.setParameters({editable:e.editable,fillColor:e.fillColor,borderColor:e.borderColor,radius:e.sphere.radius,center:e.sphere.center}):e.cylinder&&t.setParameters({editable:e.editable,fillColor:e.fillColor,borderColor:e.borderColor,heightVector:e.cylinder.heightVector,radius:e.cylinder.radius,bottomCenter:e.cylinder.bottomCenter});var i=t.getParameters();this.parametersChanged({params:i})}},retrievePositionMatrix:function(e,t){var i=new o.Vector3(1,0,0).cross(e).normalize();this.colinear(new o.Vector3(1,0,0),i)&&(i=new o.Vector3(0,1,0).cross(e).normalize());var n=(new o.Vector3).copy(e),s=(new o.Vector3).copy(i).cross(n).normalize();n.applyAxisAngle(s,Math.PI);var r=new o.Matrix4,a=(new o.Vector3).copy(t),l=r.elements;return l[0]=i.x,l[1]=i.y,l[2]=i.z,l[4]=s.x,l[5]=s.y,l[6]=s.z,l[8]=n.x,l[9]=n.y,l[10]=n.z,r.setPosition(a),r},colinear:function(e,t){var i=(new o.Vector3).copy(e),n=(new o.Vector3).copy(t),s=i.cross(n).length();return 0===Math.round(100*s)}});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerDisplay3DVolumeCmd",d)}),define("DS/ENOPAD3DViewer/models/PAD3DLayerModel",["DS/PADUtils/PADSettingsMgt","DS/TreeModel/TreeNodeModel","DS/CoreEvents/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/PADServices/utils/PADTrackerManager","DS/ENOPAD3DViewer/views/PADLayerLegend","DS/3DXMTiles/OOCQuickOverrideSet","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS"],function(e,t,i,o,n,s,r,a,l){"use strict";var d={label:"",layerId:"",icons:[],grid:{hidden:!1,remove:"",layerGroupView:null,color:null},resourceid:"",kind:"default",loading:!1,children:null,thumbnail:null,useAsyncPreExpand:!0};function h(e){this.options=UWA.clone(d),this._view=null,this._node3DBag=null,this._overrideSet=null,this._idPathOverrideSet=null,this._uuid=e.UUID,this._overrideSetId=e.UUID,this._viewer=e.viewer,this._controller=e.controller,this._decorationBag=e.decorationBag,this._overrideSetManager=e.viewer.getSceneGraphOverrideSetManager(),this._highlightSet=null,this.options.label=e.label,this.options.kind=e.kind,this.options.layerId=e.layerId,this.options.color=e.color,this.options.loading=e.loading,this.options.grid.layerGroupView=e.layerGroupView,this.options.grid.colorSquare=e.color,this.options.uniqueIDGroupLayer=e.uniqueIDGroupLayer,this.options.reloadable=e.reloadable,this.options.position=e.position,"object"==typeof e.legend?this.options.grid.legend=e.legend:this.options.grid.legend=[],this._layerVisibility=!e.visibility||e.visibility,this._styles=e.styles?e.styles:new Map,e.features=Array.isArray(e.features)?e.features:[],e.kind&&"search"===e.kind&&(!1===e.features.includes("HIGHLIGHTSET")&&e.features.push("HIGHLIGHTSET"),!1===e.features.includes("PATHELEMENT_OVERRIDESET")&&e.features.push("PATHELEMENT_OVERRIDESET")),e.kind&&"poi"===e.kind&&(!1===e.features.includes("PATHELEMENT_OVERRIDESET")&&e.features.push("PATHELEMENT_OVERRIDESET"),!1===e.features.includes("DECORATION")&&e.features.push("DECORATION")),e.kind&&"reveal"===e.kind&&(!1===e.features.includes("PATHELEMENT_OVERRIDESET")&&e.features.push("PATHELEMENT_OVERRIDESET"),!1===e.features.includes("DECORATION")&&e.features.push("DECORATION")),e.kind&&"zoi"===e.kind&&!1===e.features.includes("DECORATION")&&e.features.push("DECORATION"),e.kind&&"graphic properties"===e.kind&&!1===e.features.includes("IDPATH_OVERRIDESET")&&e.features.push("IDPATH_OVERRIDESET"),!e.kind||"colorize"!==e.kind&&"transparency"!==e.kind||!1===e.features.includes("IDPATH_OVERRIDESET")&&e.features.push("IDPATH_OVERRIDESET"),e.features.includes("HIGHLIGHTSET")&&this._buildHighlightSet(e),e.features.includes("IDPATH_OVERRIDESET")&&this.buildIdPathOverrideSet({rootNode:this._controller.getRootBag(),rootId:"rootBag"}),e.features.includes("PATHELEMENT_OVERRIDESET")&&this._buildOverrideSet(e),e.features.includes("DECORATION")&&this._buildNode(e),this._bindEvents(),t.call(this,this.options)}return h.prototype=Object.create(t.prototype),h.prototype.getID=function(){return this._uuid},h.prototype.isReloadable=function(){return this.options.reloadable},h.prototype.getColor=function(){return this.options.color},h.prototype.getPosition=function(){return this.options.position},h.prototype.getGroupView=function(){return this.options.grid.layerGroupView},h.prototype.isLayerVisible=function(){return this._layerVisibility},h.prototype.getKind=function(){return this.options.kind},h.prototype.isLoading=function(){return this.options.loading},h.prototype.getOverrideSet=function(){return this._overrideSet},h.prototype.getHighlightSet=function(){return this._highlightSet},h.prototype.getIdPathOverrideSet=function(){return this._idPathOverrideSet},h.prototype.getOverrideSetID=function(){return this._overrideSetId},h.prototype.getNode3DBag=function(){return this._node3DBag},h.prototype.show=function(){this._addNodeBagToSG(),this._pushOverrideSet(),this._layerVisibility=!0},h.prototype.hide=function(){this._removeNodeBagFromSG(),this._removeOverrideSet(),this._layerVisibility=!1},h.prototype.destroy=function(){this._removeOverrideSet(),this._removeNodeBagFromSG(),this._highlightSet&&(this._viewer.removeHighlightSet(this._highlightSet),delete this._highlightSet),delete this._node3DBag,delete this._uuid,delete this._localModelEvents,delete this._overrideSet,delete this._overrideSetManager,delete this._overrideSetId,delete this._controller,delete this._viewer},h.prototype.getModelEvents=function(){return null==this._localModelEvents&&this._bindEvents(),this._localModelEvents},h.prototype.publish=function(e){this.getModelEvents().publish(e)},h.prototype.subscribe=function(e,t){return this.getModelEvents().subscribe(e,t)},h.prototype.unsubscribe=function(e){this.getModelEvents().unsubscribe(e)},h.prototype._buildOverrideSet=function(t){e.getSetting("enopad3dviewer_lightNodeModel")?this._overrideSet=new r(t.controller._model.getOOCManager()):this._overrideSet=new o(t.rootBag),this._pushOverrideSet()},h.prototype._buildHighlightSet=function(e){this._highlightSet=this._viewer.createHighlightSet({outlineEnabled:!0,outlineColor:new l.Color(this.options.color),outlineAlpha:.5,outlineThickness:.1,haloEnabled:!0,haloColor:new l.Color(this.options.color),haloIntensity:.4,haloThickness:1,color:new l.Color(this.options.color),colorEnabled:!0,priority:-10,clearDepth:!0},!1,//!linktoHSO
!1,!0)},h.prototype.buildIdPathOverrideSet=function(e){this._idPathOverrideSet=new o(e.rootNode,e.rootId,!0),this._pushOverrideSet()},h.prototype._buildNode=function(){this._node3DBag=new a,this._addNodeBagToSG()},h.prototype._pushOverrideSet=function(){e.getSetting("enopad3dviewer_lightNodeModel")&&this._overrideSet?this._overrideSet.setActive(!0):this._overrideSetManager&&this._overrideSet&&this._overrideSet.getOverrides().length&&-1===this._overrideSetManager.getSceneGraphOverrideSetIndex(this._overrideSet)&&this._overrideSetManager.pushSceneGraphOverrideSet(this._overrideSet),this._overrideSetManager&&this._idPathOverrideSet&&this._idPathOverrideSet.getOverrides().length&&(-1===this._overrideSetManager.getSceneGraphOverrideSetIndex(this._idPathOverrideSet)?this._overrideSetManager.pushSceneGraphOverrideSet(this._idPathOverrideSet):(this._overrideSetManager.removeSceneGraphOverrideSet(this._idPathOverrideSet),this._overrideSetManager.pushSceneGraphOverrideSet(this._idPathOverrideSet))),this._viewer.render()},h.prototype._removeOverrideSet=function(){e.getSetting("enopad3dviewer_lightNodeModel")&&this._overrideSet?this._overrideSet.setActive(!1):this._overrideSetManager&&this._overrideSet&&this._overrideSetManager.removeSceneGraphOverrideSet(this._overrideSet),this._overrideSetManager&&this._idPathOverrideSet&&this._overrideSetManager.removeSceneGraphOverrideSet(this._idPathOverrideSet),this._viewer.render()},h.prototype._addNodeBagToSG=function(){this._node3DBag&&this._decorationBag.add(this._node3DBag)},h.prototype._removeNodeBagFromSG=function(){this._node3DBag&&this._decorationBag.remove(this._node3DBag)},h.prototype.setVisibility=function(e){!1===e?(this.hide(),this.publish({event:"hide",data:{id:this.getID(),layer:this}})):(this.show(),this.publish({event:"show",data:{id:this.getID(),layer:this}})),this.updateOptions({grid:{hidden:!e}})},h.prototype.toggleVisibility=function(){var e,t=this.getReferenceValue("hidden");!1===t?((e=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_HideShow_stats"})).persDim.pd2="Hidden",e.trackPageEvent(),this.hide(),this.publish({event:"hide",data:{id:this.getID(),layer:this}})):((e=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_HideShow_stats"})).persDim.pd2="Visible",e.trackPageEvent(),this.show(),this.publish({event:"show",data:{id:this.getID(),layer:this}}));this.updateOptions({grid:{hidden:!t}})},h.prototype.toggleLegend=function(e){console.log("toggle Legend for "+this.getLabel()),this._viewMdlEvts=e.modelEvents,this._legendUX=new s({layerName:e.layerName,layerLabel:this.getLabel(),legend:this.getReferenceValue("legend"),mdlEvts:e.modelEvents}),e.modelEvents.publish({event:"PAD3DLayer/showMore",data:{moreContent:this._legendUX.render()}})},h.prototype.layerRemoved=function(){var e=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_LayerRemoved"});e.persDim.pd2="Layer Removed",e.trackPageEvent(),this.publish({event:"delete",data:{id:this.getID(),layer:this}})},h.prototype.updateColor=function(e){"#"!==e[0]?this.options.color="#"+e:this.options.color=e,this.updateOptions({grid:{colorSquare:this.options.color}}),this.publish({event:"updateLayerColor",data:{color:this.options.color}})},h.prototype.updateSearchLayerColor=function(e){"#"!==e[0]&&(e="#"+e),this.publish({event:"updateSearchLayerColor",data:{color:e}})},h.prototype.setLegend=function(e){if(e){if(Array.isArray(e))this.options.grid.legend=e,this.updateOptions({grid:{legend:e}});else if(e.size>0){var t=[];e.forEach(function(e){t.push(e)}),this.options.grid.legend=t,this.updateOptions({grid:{legend:t}})}if(this._legendUX){var i=this._legendUX.options.layerName;delete this._legendUX,this._legendUX=new s({layerName:i,layerLabel:this.getLabel(),legend:this.getReferenceValue("legend"),mdlEvts:this._viewMdlEvts}),this._viewMdlEvts.publish({event:"PAD3DLayer/updateMore",data:{moreContent:this._legendUX.render()}})}}},h.prototype.setStyles=function(e){this._styles=e,this.setLegend(e)},h.prototype.getStyles=function(){return this._styles},h.prototype._bindEvents=function(){this._localModelEvents=new i,this.subscribe({event:"enableClusters"},function(){var e=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_Clusters_stats"});e.persDim.pd2="Enable",e.trackPageEvent(),this.publish({event:"modified",data:{id:this.getID(),clustered:!0}})}.bind(this)),this.subscribe({event:"disableClusters"},function(){var e=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_Clusters_stats"});e.persDim.pd2="Disable",e.trackPageEvent(),this.publish({event:"modified",data:{id:this.getID(),clustered:!1}})}.bind(this)),this.subscribe({event:"updateLayerColor"},function(){this.publish({event:"modified",data:{id:this.getID(),color:this.options.color}})}.bind(this)),this.subscribe({event:"updateSearchLayerColor"},function(){this.publish({event:"modified",data:{id:this.getID(),color:this.options.color}})}.bind(this)),this.subscribe({event:"show"},function(){this.publish({event:"modified",data:{id:this.getID(),visible:!0}})}.bind(this)),this.subscribe({event:"hide"},function(){this.publish({event:"modified",data:{id:this.getID(),visible:!1}})}.bind(this))},h}),define("DS/ENOPAD3DViewer/views/PAD3DPOIHoverTooltip",["css!DS/ENOPAD3DViewer/ENOPAD3DViewer","DS/WAFData/WAFData","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture","DS/Visualization/Node3D","DS/PADServices/utils/PADTrackerManager","DS/ENOPAD3DViewer/views/PADPOIManipulatorTT","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s,r,a,l){"use strict";function d(e){var t=e.parent,i=!1;e.needsToBePinned&&(i=e.needsToBePinned);var o=document.createElement("canvas").getContext("2d");try{o.font="10px pad-3ds-light"}catch(e){console.error(e)}this._tooltipType=e.tooltipType,this._options_temp_focRef_pinnedTT=e.temp_focRef_pinnedTT,this._context=e.context,this._context=e.context,this._pinnedImg=e.pinnedImg,this._unpinnedImg=e.unpinnedImg,this._POIObject=e.node,this.devicePixelRatio=window.devicePixelRatio||1,"POI"===this._tooltipType?this._poiScale=void 0!==e.poiScale&&e.poiScale>0?e.poiScale:1:this._poiScale=1;var n=e.instanceId;if(t&&(this._parent=t),this._POIObject){this._fillColor=this._POIObject.fillColor?this._POIObject.fillColor:"#FF4500",this._borderColor=this._POIObject.borderColor?this._POIObject.borderColor:"#77797C","POI"===this._tooltipType&&(this._POIObject.node?(this._position=this._POIObject.position,this._parent=t,this._name=this._POIObject.node._name,this._number=this._POIObject.node._number,this._layerID=this._POIObject.node._layerID,this._highlightColor="#368EC4",this._type=this._POIObject.node._type,this._node=new s(this._name),e&&e.threshold&&(this._threshold=e.threshold)):(this._POIObject.getId?(this._position=this._POIObject._position,this._name=this._POIObject._label,this._number=n,this._layerID=e.layerId):(this._position=this._POIObject.position,this._name=this._POIObject.label,this._number=n,this._layerID=e.layerId),this._highlightColor="#368EC4",this._type="SinglePOINode",this._node=new s(this._number),this._node._layerId=this._layerID)),"ZOI"===this._tooltipType&&(this._position=e.posData,this._name=this._POIObject.id,this._number=n,this._layerID=e.layerId,this._highlightColor="#368EC4",this._type="ZOINode",this._node=new s(this._number),this._node._layerId=this._layerID),this._isVisible=!1,this._selected=!1,this._callfromHover=!0,this._pinClicked_Tooltip=!1,this._beginofHoverOverTooltip=!1,this._pinned=!1;var r=this._fillColor.slice(1,this._fillColor.length);parseInt(r.substring(0,2),16),parseInt(r.substring(2,4),16),parseInt(r.substring(4,6),16);this._textColor="#939698",this._borderColor="#939698",this._width=84,this._height=111,this._canvasNode=null,this._parent.addChild(this._node),"POI"===this._tooltipType?"2DClusteringNode"===this._type?(this._width=102,this._height=120,this._node.className="2DClusteringTooltip",this._text=this._POIObject.pois.length):"SinglePOINode"===this._type?(this._text=this._name,this._node.className="POINodeTooltip"):(this._node.className="ProximityGroupTooltip",this._POIObject.pois.length>999?this._text=this._POIObject.pois.length+" "+l.poiTooltip.atLessThan+" "+this._threshold+" mm":this._text=l.poiTooltip.mergingThreshold+": "+this._threshold+" mm"):"ZOI"===this._tooltipType&&(this._text=this._name,this._node.className="ZOITooltip");var d=o.measureText(this._text).width;"SinglePOINode"==this._type?this._width=d+40:"ZOINode"==this._type?this._width=d+40:this._width=d+20,this._height=34,this._onHoverCallback=e.onHoverCallback,this._outHoverCallback=e.outHoverCallback,this._onManipulateCallback=e.onManipulateCallback,this._outManipulateCallback=e.outManipulateCallback,this._hoverManipulator=new a(this._name),this._hoverManipulator.setExclusive(!0),this._hoverManipulator.subscribe("BeginPreactivate",this._onHoverCallback),this._hoverManipulator.subscribe("EndPreactivate",this._outHoverCallback),this._hoverManipulator.subscribe("BeginManipulate",this._onManipulateCallback),this._hoverManipulator.subscribe("EndManipulate",this._outManipulateCallback),!0===i&&this.pinClicked_Tooltip()}}return d.prototype.getId=function(){return this._name},d.prototype.getpinClickedTooltip=function(){return this._pinClicked_Tooltip},d.prototype.removeTooltip=function(){this._pinClicked_Tooltip||this._parent.removeChild(this._node)},d.prototype.beginofHoverOverTooltip=function(){this._beginofHoverOverTooltip=!0,this.render()},d.prototype.updateIcon=function(e){0===e&&(this._pinned=!1),1===e&&(this._pinned=!0),this.render()},d.prototype.pinClicked_Tooltip=function(){var e=r.getPADTracker({eventCategory:"usage",eventAction:"3d_POITooltip_stats"});"SinglePOINode"===this._type&&(e.persDim.pd2="Pinned"),e.trackPageEvent(),this._pinClicked_Tooltip=!0,this.updateIcon(1),this.render()},d.prototype.render=function(){delete this._canvasNode,this._node?this._node.removeChildren():(this._node=new s(this._name),this._node.setPickParent(!0),this._canvasNode.setPickParent(!0),this._parent.addChild(this._node));var e=new n({width:this._width,height:this._height,drawCB:this._draw.bind(this),alphaTest:.02}),t=-26*this._poiScale;"ZOI"===this._tooltipType&&(t=0);var r=0,a=0;"2DClusteringNode"===this._type&&this._POIObject.pois.length>999&&(r=-10*this._poiScale,a=-12*this._poiScale),"3DClusteringNode"===this._type&&(a=-12*this._poiScale),this._canvasNode=i.createCanvas2DNode({canvasNodeTexture:e,hotspot:new o.Vector2(r+this._width/2,a+t)}),this._canvasNode.rectangle.setRenderDepth(1e9),this._canvasNode.canvas2DMaterial.depthTest=!1,this._node.addChild(this._canvasNode),this._canvasNode.setMatrix((new o.Matrix4).setPosition(this._position)),this._hoverManipulator&&this._hoverManipulator.linkToNode(this._canvasNode.rectangle),this._context.getViewer().render()},d.prototype.relinkNode=function(){this._hoverManipulator&&this._hoverManipulator.linkToNode(this._canvasNode.rectangle),this._context.getViewer().render()},d.prototype.undogeneratepopup=function(){this._pinClicked_Tooltip||this._beginofHoverOverTooltip||(this._callfromHover=!1,this.render())},d.prototype.generatepopup=function(){this._callfromHover=!0,this.render()},d.prototype.getNode=function(){return this._node},d.prototype.getTooltipId=function(){return this._number},d.prototype._drawPOITooltip=function(e,t){if(this._callfromHover){t.font="10px pad-3ds-light";var i=16+t.measureText(this._text).width;"SinglePOINode"===this._type&&(i+=20),"ZOINode"===this._type&&(i+=20);t.fillStyle="#F9F9F9",t.fillRect(0,0,i,24),t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,t.lineWidth=.3,t.strokeStyle="#3D3D3D",t.strokeRect(0,0,i,24),t.fillStyle="#2D2D2D",t.fillText(this._text,8,15),"SinglePOINode"==this._type?this._pinned?this._pinnedImg&&t.drawImage(this._pinnedImg,i-20,4,16,16):this._unpinnedImg&&t.drawImage(this._unpinnedImg,i-20,4,16,16):"ZOINode"==this._type&&(this._pinned?this._pinnedImg&&t.drawImage(this._pinnedImg,i-20,4,16,16):this._unpinnedImg&&t.drawImage(this._unpinnedImg,i-20,4,16,16));t.translate(i/2+1-5,23),t.beginPath(),t.lineTo(10,0),t.lineTo(5,10),t.lineTo(0,0),t.fillStyle="#F9F9F9",t.fill(),t.lineWidth=.3,t.strokeStyle="#3D3D3D",t.stroke(),t.closePath()}},d.prototype._draw=function(e,t){this._drawPOITooltip(e,t)},d}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerFlexibleAssemblyController",["UWA/Class","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/IdPath","DS/PADUtils/PADSettingsMgt","DS/ApplicationFrame/CommandsManager","DS/Visualization/ThreeJS_DS","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s,r,a){"use strict";return e.extend({name:"_PAD3DViewerFlexibleAssemblyController",_eventTokens:[],_flexibleAssembliesOverrideSetMap:new Map,_flexibleAssembliesPartialOverrideSetMap:new Map,_flexibleAssembliesOverrideSetManagerMap:new Map,initFlexibleAssemblyController:function(){this._eventTokens.push(this._model.subscribe({event:"flexibleAssemblyReceived"},e=>{this._applyFlexibleAssemblies(e)})),this._eventTokens.push(this.subscribe({event:"onRootRemoved"},e=>{e&&e.id&&this._clearFlexibleAssembly(e.id)}))},disposeFlexibleAssemblyController:function(){for(let e=0;e<this._eventTokens.length;++e)this.unsubscribe(this._eventTokens[e])},_applyFlexibleAssemblies:function(e){for(let t=0;t<e.fa.length;++t){e.fa[t].path.length%2==1&&e.fa[t].path.pop();let o=new i([this.getRootBagId()].concat(e.fa[t].path)),n=null;e.fa[t].path[0]!==e.rootId?(n=this._flexibleAssembliesPartialOverrideSetMap.get(e.fa[t].path[0]),o=new i(e.fa[t].path),n||(n=this._createPartialFlexibleAssemblyOverrideSet(e.rootId,e.fa[t].path))):(n=this._flexibleAssembliesOverrideSetMap.get(e.fa[t].path[0]))||(n=this._createFlexibleAssemblyOverrideSet(e.fa[t].path[0]));let s=n.getUniqueOverrideFromIdPath(o);s?s.setPosition(this._parseMatrix(e.fa[t].matrixtxt)):(s=n.createIdPathOverride({idPathes:[o],depthPriority:!0}))&&s.setPosition(this._parseMatrix(e.fa[t].matrixtxt))}const t=this._context.getViewer().getSceneGraphOverrideSetManager();if(t)for(let e of this._flexibleAssembliesOverrideSetMap.values())t.removeSceneGraphOverrideSet(e),t.pushSceneGraphOverrideSet(e);var o=this._flexibleAssembliesOverrideSetManagerMap.get(e.rootId);if(o)for(let e=0;e<o.length;++e)for(let t of this._flexibleAssembliesPartialOverrideSetMap.values())o[e].removeSceneGraphOverrideSet(t),o[e].pushSceneGraphOverrideSet(t);setTimeout(function(){this._context.getViewer().render({updateInfinitePlane:!0})}.bind(this)),this.publish({event:"onFlexibleAssemblyApplied"})},_clearFlexibleAssembly:function(e){const t=this._flexibleAssembliesOverrideSetMap.get(e),i=this._context.getViewer().getSceneGraphOverrideSetManager();t&&(i&&i.removeSceneGraphOverrideSet(t),this._flexibleAssembliesOverrideSetMap.delete(e));var o=this._flexibleAssembliesOverrideSetManagerMap.get(e);if(o){for(let e=0;e<o.length;++e){const t=this._flexibleAssembliesPartialOverrideSetMap.get(o[e].nodeId);t&&(i&&i.removeSceneGraphOverrideSet(t),o[e].removeSceneGraphOverrideSet(t),this._flexibleAssembliesPartialOverrideSetMap.delete(o[e].nodeId))}this._flexibleAssembliesOverrideSetManagerMap.delete(e)}},clearFlexibleAssembly:function(e){this._clearFlexibleAssembly(e)},isPathEffectiveForFlexibleAssembly:function(e){if(e){const t=this._flexibleAssembliesOverrideSetMap.get(e[0]);if(t){const o=new i([this.getRootBagId()].concat(e));return!(null===t.getUniqueOverrideFromIdPath(o))}}return!1},hasAnyEffectiveFlexibleAssembly:function(){return 0!==this._flexibleAssembliesOverrideSetMap.size||0!==this._flexibleAssembliesPartialOverrideSetMap.size},_createFlexibleAssemblyOverrideSet:function(e){const i=new t(this.getRootBag(),this.getRootBagId(),!0);return this._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(i),this._flexibleAssembliesOverrideSetMap.set(e,i),i},_createPartialFlexibleAssemblyOverrideSet:function(e,t){const i=this._flexibleAssembliesPartialOverrideSetMap.get(t[0]);if(i)return i;var o=this._context.getController()._model.getOOCManager().createNodeIdOverrideSetManager(t[0]),n=o.createSceneGraphOverrideSet();o.pushSceneGraphOverrideSet(n);var s=this._flexibleAssembliesOverrideSetManagerMap.get(e);return s?s.push(o):this._flexibleAssembliesOverrideSetManagerMap.set(e,[o]),this._flexibleAssembliesPartialOverrideSetMap.set(t[0],n),n},_enableFlexibleAssemblySupport:function(){o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",!0)},_disableFlexibleAssemblySupport:function(){o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",!1)},_parseMatrix:function(e){var t=null;if(void 0!==e&&""!==e&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==e&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==e&&"1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"!==e){t=new s.Matrix4;var i=e.split(/[,]/);t.elements[0]=parseFloat(i[0]),t.elements[4]=parseFloat(i[1]),t.elements[8]=parseFloat(i[2]),t.elements[1]=parseFloat(i[3]),t.elements[5]=parseFloat(i[4]),t.elements[9]=parseFloat(i[5]),t.elements[2]=parseFloat(i[6]),t.elements[6]=parseFloat(i[7]),t.elements[10]=parseFloat(i[8]),t.elements[12]=parseFloat(i[9]),t.elements[13]=parseFloat(i[10]),t.elements[14]=parseFloat(i[11])}return t}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerStartupViewAutoloader",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/VisuTools/FPSCounter","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADServices/ws/WSAccess","DS/Visualization/WorldOrientation","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/Controls/ModalContainer","DS/Controls/Loader","DS/UIKIT/Mask"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u){"use strict";return t.extend({name:"_PAD3DViewerStartupViewAutoloader",_startupViewAutoloaderActivated:!1,_setupStartupViewAutoloader:function(e){this.toggleStartupView(e.activateStartupViewAutoloader),this._startupViewAutoloaderActivated&&"undefined"!=typeof widget&&this.getWidget()&&this.subscribe({event:"onReady"},function(){var e=!("undefined"==typeof widget||!this.getWidget())&&this.getWidget().getValue("autoreload"),t=window.localStorage.getItem("TileModelPreloadData")||"undefined"!=typeof widget&&this.getWidget()&&this.getWidget().getValue("StartupViewAutoloadData");if(t&&e)this.displayNotification({eventID:"warning",title:d.startupViewWithAutoreload.title,subtitle:d.startupViewWithAutoreload.subtitle.replace("{autoreloadpreference}",h.autoreload_label),msg:d.startupViewWithAutoreload.message.replace("{autoreloadpreference}",h.autoreload_label)});else if(t){u.mask(document.body,d.startupViewWithAutoreload.loaderLabel);var r="object"!=typeof t?JSON.parse(t):t,a=null;if((a=Array.isArray(r)?r[0]:r).active){if(a.viewpoint){const e=this.getViewpoint();let t=new i.Vector3(a.viewpoint.pos.x,a.viewpoint.pos.y,a.viewpoint.pos.z),o=new i.Vector3(a.viewpoint.up.x,a.viewpoint.up.y,a.viewpoint.up.z),n=new i.Vector3(a.viewpoint.sight.x,a.viewpoint.sight.y,a.viewpoint.sight.z);s.getSetting("supportWorldOrientation")&&"y"===a.upAttribute&&(t=new i.Vector3(a.viewpoint.pos.z,a.viewpoint.pos.x,a.viewpoint.pos.y),o=new i.Vector3(a.viewpoint.up.z,a.viewpoint.up.x,a.viewpoint.up.y),n=new i.Vector3(a.viewpoint.sight.z,a.viewpoint.sight.x,a.viewpoint.sight.y)),e.moveTo({eyePosition:t,upDirection:o,sightDirection:n,distanceToTarget:void 0!==a.viewpoint.distanceToTarget?a.viewpoint.distanceToTarget:150,duration:0})}setTimeout(function(e){var t=this.subscribe({event:"onRootAdded"},function(){this.unsubscribe(t),u.unmask(document.body),this.publish({event:"onAutoloadStartupView"}),setTimeout(function(){oocLDHNodeManager&&oocLDHNodeManager.requestUpdate(!0,!0)},500)}.bind(this)),i=this.subscribe({event:"onLoadingFailure"},function(){this.unsubscribe(i),this.publish({event:"onAutoloadStartupViewFailed"}),u.unmask(document.body)}.bind(this)),o=this.subscribe({event:"onRootAlreadyExisting"},function(){this.unsubscribe(o),this.publish({event:"onAutoloadStartupViewFailed"}),u.unmask(document.body)}.bind(this));t=this.subscribe({event:"onLoadingComplete"},function(){this.unsubscribe(t),this.publish({event:"onAutoloadStartupViewLoaded"}),u.unmask(document.body)}.bind(this));if(e.kind&&"FILTER"===e.kind){let t=function(){this.getController().addFilter([{objectId:e.rootId}],!0,!0),this._commandProxy.dropFilter3D({droppedFilters:[{envId:n.getPlatformId(),serviceId:e.serviceId,contextId:s.getSetting("pad_security_ctx")?s.getSetting("pad_security_ctx"):void 0,objectId:e.rootId,objectType:"ENOStrRefinementSpecification",displayType:"Advanced Filter"}],broadcast:!1})}.bind(this);this._waitForLinkWith?this._linkProxyPromise.then(t):t()}else e.kind&&"R2V"===e.kind?this.addR2Vs({objects:[{objectId:e.rootId,objectType:e.objectType,displayType:e.displayType,displayName:e.displayName,soIdisplayName:e.soIdisplayName,serviceId:e.serviceId}],reframe:!1,displayNotif:!0,dispatch:!0}):this.getController().addRoots({objects:[{path:[e.rootId]}]},!0,!0,!1)}.bind(this,a),1e3),require(["DS/PADServices/utils/PADTrackerManager"],function(e){var t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DStartupView"});t.setEventData({eventLabel:"ENO3DStartupView-load"}),t.trackPageEvent()})}}"ON"===window.localStorage.getItem("TileModelPerf")&&(o.setAutoRefresh(!1),this.getViewer().showPerfo(!0,!1))}.bind(this))},_onSetStartupViewClicked:function(){if(this._startupViewAutoloaderActivated&&"undefined"!=typeof widget&&this.getWidget())if(this.getWidget().readOnly)this.displayNotification({eventID:"info",title:d.setStartupViewFailedReadOnly.title,subtitle:d.setStartupViewFailedReadOnly.subtitle,msg:d.setStartupViewFailedReadOnly.message});else{var e=this.getRoots();if(this.getWidget().getValue("StartupViewAutoloadData"))this.getWidget().deleteValue("StartupViewAutoloadData"),this.getStatusBar().clearStartupView(),this.displayNotification({eventID:"success",title:d.successForStartupViewRemoval.title,subtitle:d.successForStartupViewRemoval.subtitle,msg:d.successForStartupViewRemoval.message}),require(["DS/PADServices/utils/PADTrackerManager"],function(e){var t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DStartupView"});t.setEventData({eventLabel:"ENO3DStartupView-remove"}),t.trackPageEvent()});else if(1===e.length){var t=this.getRoots()[0],i=l.getNodeID(t),o=this.getController().getRootStats(i),n=!1,s="",a=l.getNodeType(t);l.isTileSetNode(t)?s="R2V":l.isPLMNode(t)&&((n=this.getController().isFiltered(i))&&n.filterId?(i=n.filterId,a="ENOStrRefinementSpecification",s="FILTER"):s="PRODUCT");var h={viewpoint:{pos:this.getViewer().currentViewpoint.getEyePosition().createJSON(),sight:this.getViewer().currentViewpoint.getSightDirection().createJSON(),up:this.getViewer().currentViewpoint.getUpDirection(),distanceToTarget:this.getViewer().currentViewpoint.getTargetDistance()},rootId:i,objectType:a,kind:s,serviceId:o.serviceId,active:!0,upAttribute:this.getViewer().getWorldOrientation().upAttribute},c=[h];this.getWidget().setValue("StartupViewAutoloadData",c),"R2V"===s?r.getFeatureState({objectId:h.rootId,serviceId:h.serviceId}).then(e=>{(e="object"!=typeof e&&void 0!==e?JSON.parse(e):e).result&&(this.getStatusBar().setStartupView({id:h.rootId,name:e.result["ds6w:label"],icon:e.result.thumbnail}),this.displayNotification({eventID:"success",title:d.successForStartupView.title,subtitle:d.successForStartupView.subtitle.replace("{rootname}",e.result["ds6w:label"]),msg:d.successForStartupView.message}))}).catch(e=>{this.getStatusBar().setStartupView({id:"failed",name:"Unable to load information"})}):this.getController().getAttributes({ids:[h.rootId],attributes:["ds6w:label","thumbnail_2d"],callbacks:{onComplete:function(e){this.getStatusBar().setStartupView({id:h.rootId,name:e[h.rootId]["ds6w:label"],icon:e[h.rootId].preview_url}),this.displayNotification({eventID:"success",title:d.successForStartupView.title,subtitle:d.successForStartupView.subtitle.replace("{rootname}",e[h.rootId]["ds6w:label"]),msg:d.successForStartupView.message})}.bind(this),onFailure:function(e){this.getStatusBar().setStartupView({id:"failed",name:"Unable to load information"})}.bind(this)}}),require(["DS/PADServices/utils/PADTrackerManager"],function(e){var t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DStartupView"});t.setEventData({eventLabel:"ENO3DStartupView-set"}),t.trackPageEvent()})}else e.length>1?this.displayNotification({eventID:"error",title:d.multipleRootForSetStartupView.title,subtitle:d.multipleRootForSetStartupView.subtitle,msg:d.multipleRootForSetStartupView.message}):0===e.length&&this.displayNotification({eventID:"error",title:d.noRootForSetStartupView.title,subtitle:d.noRootForSetStartupView.subtitle,msg:d.noRootForSetStartupView.message})}},toggleStartupView:function(e){this._startupViewAutoloaderActivated=e,this.getStatusBar().toggleStartupView(e);var t=this.getWidget().getValue("StartupViewAutoloadData"),i="object"!=typeof t&&void 0!==t?JSON.parse(t):t;if(i){var o=null;"R2V"===(o=Array.isArray(i)?i[0]:i).kind?r.getFeatureState({objectId:o.rootId,serviceId:o.serviceId}).then(e=>{(e="object"!=typeof e&&void 0!==e?JSON.parse(e):e).result&&this.getStatusBar().setStartupView({id:o.rootId,name:e.result["ds6w:label"],icon:e.result.thumbnail})}).catch(e=>{this.getStatusBar().setStartupView({id:"failed",name:"Unable to load information"})}):this.getController().getAttributes({ids:[o.rootId],attributes:["ds6w:label","thumbnail_2d"],callbacks:{onComplete:function(e){this.getStatusBar().setStartupView({id:o.rootId,name:e[o.rootId]["ds6w:label"],icon:e[o.rootId].preview_url})}.bind(this),onFailure:function(e){this.getStatusBar().setStartupView({id:"failed",name:"Unable to load information"})}.bind(this)}})}else this.getStatusBar().clearStartupView()}})}),define("DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n){"use strict";var s={GREY:"rgb(119,121,124)",ORANGE:"rgb(232,123,0)",BLUE:"rgb(5,155,255)",GREEN:"rgb(50,221,28)",YELLOW:"rgb(232,212,24)"},r={"5SEC":5e3,"10SEC":1e4,"15SEC":15e3};return t.extend({name:"PAD3DViewerLoadingBoxesEngine",_boxesDisplayToken:null,_endVpMoveToken:null,_realMove:!1,_startProgressiveExpandToken:null,_endProgressiveExpandToken:null,_boxesRemovalToken:null,_expandToken:null,_enforceLoadingBoxesDisplay:!1,_colors:{repColor:s.GREY,assemblyColor:s.GREY},setupLoadingBoxesEngine:function(){this.isSelectiveLoadingActivated()&&("OFF"!==o.getSetting("enopad3dviewer_displayCandidateQueue")?(this.setLoadingBoxesColor(o.getSetting("enopad3dviewer_displayCandidateQueue_color")),this._clearVisuEventCallback(),"ALWAYS"===o.getSetting("enopad3dviewer_displayCandidateQueue")?this.toggleLoadingBoxesDisplay(!0):(this._endVpMoveToken=i.subscribe({event:"/VISU/"},function(e){switch(e.eventType){case"@onViewpointChange":this._realMove=!0;break;case"@onViewpointBeginMove":case"@onViewpointBeginMove_bis":this._clearBoxesDisplayTimeout(),this._clearBoxesRemovalTimeout();break;case"@onViewpointEndMove":case"@onViewpointEndMove_bis":this._realMove&&(this._realMove=!1,this._clearBoxesDisplayTimeout(),this._clearBoxesRemovalTimeout(),this._enforceLoadingBoxesDisplay||(this._boxesRemovalToken=setTimeout(function(){this._boxesRemovalToken=null,this.toggleLoadingBoxesDisplay(!1)}.bind(this),1e3)),this._boxesDisplayToken=setTimeout(function(){this._boxesDisplayToken=null,this.toggleLoadingBoxesDisplay(!0)}.bind(this),r[o.getSetting("enopad3dviewer_displayCandidateQueue")]))}}.bind(this)),this._endProgressiveExpandToken=this.subscribe({event:"onEndProgressiveLoad"},function(e){this.toggleLoadingBoxesDisplay(!0),this.getController()._model.setLoadingBoxesPickable(!0)}.bind(this)),this._startProgressiveExpandToken=this.subscribe({event:"onStartProgressiveLoad"},function(e){this.getController()._model.setLoadingBoxesPickable(!1)}.bind(this)))):(this.toggleLoadingBoxesDisplay(!1),this.disposeLoadingBoxesEngine()),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DView-usage"});t.setEventData({eventLabel:"ENO3DViewBoundingBoxes"}),t.persDim.pd2=o.getSetting("enopad3dviewer_displayCandidateQueue"),t.persDim.pd3=this._colors.repColor,t.persDim.pd4=this._colors.assemblyColor,t.trackPageEvent()}))},toggleLoadingBoxesDisplay:function(e){this.isSelectiveLoadingActivated()&&this.getController()&&this.getController()._model&&void 0!==e&&(e&&"OFF"!==o.getSetting("enopad3dviewer_displayCandidateQueue")?this.getController()._model.displayCandidateQueue(!0,this._colors):e||this.getController()._model.displayCandidateQueue(!1,this._colors))},_clearBoxesDisplayTimeout:function(){this._boxesDisplayToken&&(clearTimeout(this._boxesDisplayToken),this._boxesDisplayToken=null)},_clearBoxesRemovalTimeout:function(){this._boxesRemovalToken&&(clearTimeout(this._boxesRemovalToken),this._boxesRemovalToken=null)},_clearVisuEventCallback:function(){this._endVpMoveToken&&(i.unsubscribe(this._endVpMoveToken),this._endVpMoveToken=null)},_clearMemoryLimitCallback:function(){this._endProgressiveExpandToken&&(this.unsubscribe(this._startProgressiveExpandToken),this._startProgressiveExpandToken=null,this.unsubscribe(this._endProgressiveExpandToken),this._endProgressiveExpandToken=null)},disposeLoadingBoxesEngine:function(){this.isSelectiveLoadingActivated()&&(this._clearVisuEventCallback(),this._clearMemoryLimitCallback(),this._clearBoxesDisplayTimeout())},setLoadingBoxesColor:function(e){this._colors.repColor=s[e],this._colors.assemblyColor=s[e]}})}),define("DS/ENOPAD3DViewer/models/PAD3DPOILayer",["DS/ENOPAD3DViewer/models/PAD3DLayerModel"],function(e){"use strict";function t(t){e.call(this,t),this.options.enableClustering=void 0!==t.enableClustering&&t.enableClustering,this.options.layerColorEditable=void 0!==t.layerColorEditable&&t.layerColorEditable,this.options.clustered=void 0!==t.clustered&&t.clustered,this.options.clusteringEditable=void 0===t.clusteringEditable||t.clusteringEditable,this.options.maxClusters=t.maxClusters?t.maxClusters:200,this.options.proximityMerging=void 0===t.proximityMerging||t.proximityMerging,this.options.proximityThreshold=t.proximityThreshold?t.proximityThreshold:.001,this.options.grid.clustered=void 0!==t.clustered&&t.clustered,this.options.poiIcon=t.poiIcon?t.poiIcon:"default",this.options.scale=t.scale?t.scale:1,t.styles&&this.setStyles(t.styles)}return t.prototype=Object.create(e.prototype),t.prototype.getPOIScale=function(){return this.options.scale},t.prototype.getPOIIcon=function(){return this.options.poiIcon},t.prototype.getMaxClusters=function(){return this.options.maxClusters},t.prototype.isClustered=function(){return this.options.clustered},t.prototype.toggleClustering=function(){this.setClustering(!this.options.clustered)},t.prototype.disableClustering=function(){this._previousClusteringState=this.options.clustered,this.updateOptions({clusteringEditable:!1}),this.setClustering(!1)},t.prototype.restoreClustering=function(){null!==this._previousClusteringState?(this.setClustering(this._previousClusteringState),this._previousClusteringState=null):this.setClustering(!1),this.updateOptions({clusteringEditable:!0})},t.prototype.isProximityMerged=function(){return this.options.proximityMerging},t.prototype.getProximityThreshold=function(){return this.options.proximityThreshold},t.prototype.setClustering=function(e){this.options.clustered=e,e?this.publish({event:"enableClusters",data:{id:this.getID(),layer:this}}):this.publish({event:"disableClusters",data:{id:this.getID(),layer:this}}),this.updateOptions({grid:{clustered:e}})},t}),define("DS/ENOPAD3DViewer/mixins/PAD3DViewerWidgetLink",["UWA/Class","DS/ENOXInterWdgCom/LinkManager","DS/PlatformAPI/PlatformAPI","DS/PADServices/utils/GlobalUtils","DS/Notifications/NotificationsManagerViewOnScreen","DS/PADUtils/PADPromise","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/PADServices/utils/GlobalModelEvents","DS/CoreEvents/Events","DS/ENOXInterWdgCom/views/ENOWidgetLinkOptionsPanel","DS/PADUtils/PADTypesMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt"],function(e,t,i,o,n,s,r,a,l,d,h,c,p){return e.extend({setupWidgetLink:function(){!window.__karma__||p.getSetting("widgetlink-odt")?(this._isChoosingWLOptionsFromLink=!1,this._waitForLinkWith=t.isLinkedWithPartnerApp(widget.getValue("x3dSharedId")),this._linkProxyPromise=new Promise(function(e){this._resolveLinkProxyPromise=e}.bind(this)),this._appReadyForSync=!1,this.subscribe({event:"onReady"},()=>{this._appReadyForSync=!0}),t.subscribe("DS/ExternalWdgtCom/LoadData",this._onLoadData.bind(this)),t.subscribe("DS/ExternalWdgtCom/RemoveAll",this._onRemoveAll.bind(this)),t.subscribe("DS/ExternalWdgtCom/RemoveRoot",this._onRemoveRoots.bind(this)),t.subscribe("DS/ExternalWdgtCom/Find",this._onFind.bind(this)),t.subscribe("DS/ExternalWdgtCom/captureSnapshot",this._onScreenshot.bind(this)),t.subscribe("DS/ExternalWdgtCom/DisableTimeline",this._onDisableTimeline.bind(this)),t.subscribe("DS/ExternalWdgtCom/EnableTimeline",this._onEnableTimeline.bind(this)),t.subscribe("DS/ExternalWdgtCom/CapturePoint",this._onCapturePoint.bind(this)),t.subscribe("DS/ExternalWdgtCom/MoveRoot",this._onMoveRoot.bind(this)),t.subscribe("DS/ExternalWdgtCom/GetInfosForSync",this._onGetInfosForSync.bind(this)),t.subscribe("DS/ExternalWdgtCom/SyncContent",this._onSyncContent.bind(this)),t.subscribe("DS/ExternalWdgtCom/EndSync",this._endSync.bind(this)),t.subscribe("DS/ExternalWdgtCom/UnlinkBIProxy",this._unLinkBIProxy.bind(this)),t.subscribe("DS/ExternalWdgtCom/SyncContent3D",this._onSyncContent3D.bind(this)),t.subscribe("DS/ExternalWdgtCom/CancelSyncContent3D",this._onCancelSyncContent3D.bind(this)),t.subscribe("DS/ExternalWdgtCom/ViewPointSync",this._onViewPointSync.bind(this)),t.subscribe("DS/ExternalWdgtCom/SetViewpointSyncMaster",this._onSetViewpointSyncMaster.bind(this)),l.subscribe({event:"/VISU/"},this._onViewPointChange.bind(this))):console.warn("We are in karma test environment, thus preventing the use of WidgetLink.")},_onUnLink:function(e){if(void 0!==this.getController().get3DLayerController()){let t=this.getController().get3DLayerController()._layersToDeleteOnUnlink,i=t.get(e);if(i&&i.length>0){for(let e=0;e<i.length;e++)this.getController()._layerController.deleteLayerId(i[e]);t.delete(e)}}},_onLink:function(e){},_isEventSourceCorrect:function(e,i,o){let n=!0;if(e&&"Widgets"===i){t.getLinked().filter(t=>t.id===e).length>0&&(console.warn("Please use WidgetLink instead of PlatformAPI to publish this "+o+" event if your widget "+e+" is linked to 3D Navigate Standalone"),n=!1)}return n},_onLoadData:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"LoadData")&&(e.dropData.broadcast=!1,e.dropData.behavior="WITHOUT_CONTEXT",t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/LoadData"),this._openObjectsFromWL(e.dropData))},_onFind:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"Find")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/Find"),this.getController().search(e))},_onScreenshot:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"Screenshot")&&null!==e.get&&void 0!==e.get&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/captureSnapshot"),this.getController().screenshot(e))},_onRemoveAll:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"RemoveAll")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/RemoveAll"),this.empty(!1))},_onRemoveRoots:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"RemoveRoot")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/RemoveRoot"),delete e.fromWidgetId,this.removeRoots(e))},_onDisableTimeline:function(e,i){if(this._isEventSourceCorrect(e.fromWidgetId,i.channel,"DisableTimeline")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/DisableTimeline"),this._loadedSoI)){let e=Object.keys(this._loadedSoI);for(let t=0;t<e.length;t++)this._loadedSoI[e[t]].disableTimeline()}},_onEnableTimeline:function(e,i){if(this._isEventSourceCorrect(e.fromWidgetId,i.channel,"EnableTimeline")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/EnableTimeline"),this._loadedSoI)){let e=Object.keys(this._loadedSoI);for(let t=0;t<e.length;t++)this._loadedSoI[e[t]].enableTimeline()}},_onCapturePoint:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"CapturePoint")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/CapturePoint"),e.fromCapturePoint=!0,this.getController()._capturePOI(e))},_onMoveRoot:function(e,i){this._isEventSourceCorrect(e.fromWidgetId,i.channel,"MoveRoot")&&(t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/MoveRoot"),this.getController()._onMoveRoot(e))},_onLinkExternalWidget:function(e){let i=e.fromWidgetId,o=t.getLinked().filter(e=>e.id===i);o&&0!==o.length||t.setLinked({[i]:!0})},_onGetInfosForSync:function(e){if(e&&e.fromLinkManager){t.setWidgetSynchronizing(!0);let i=this.getRoots(),o=this.getController(),n=[];i&&i.length>0&&(n=i.map(e=>{const t=e.getModelIdentification();return{rootID:t,pathes:o.getRootStats(t).initialPathes,serviceID:o.getRootStats(t).serviceId,filterId:this.getBIController().getBIProxy().HasFilter(t).filterId,isR2V:c.isTileSetNode(e),type:e.getUserData()?e.getUserData().type:void 0}}));let s=widget.getValue("x3dSharedId"),r={id:widget.id,sharedID:s,contentFeatureEnabled:t.getSyncFeature("Content"),is3D:!0,isChoosingWLOptionsFromLink:this._isChoosingWLOptionsFromLink,content:n,hiddenPaths:this.getHideShowController()?this.getHideShowController().getHiddenPathsAsArray():[],shownPaths:this.getHideShowController()?this.getHideShowController().getShownPathsAsArray():[]};if(!e||!e.get)return r;t.publish("DS/ExternalWdgtCom/GetInfosForSync",r)}},_onSyncContent:function(e){let i,o=function(){if(i&&this.unsubscribe(i),e.srcWidgetID!==widget.id?t._initiatorLinks.set(e.srcWidgetID,!1):t._initiatorLinks.set(e.fromWidgetId,!0),!this._isChoosingWLOptionsFromLink){var o=this;this.getController().publish({event:"onDisableUX"}),t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/SyncContent"),t.setSourceWidgetId(e.srcWidgetID);let i=!1;if(e.srcWidgetID===widget.id&&"function"==typeof this.getBIController().getBIProxy().linkWith){if(t._nbWdgtsToSync=e.nbWdgtsToSync,t._syncEnded=!1,e.rootsToSync.length>0){let t=o.getController().subscribe({event:"onRefreshCompleted"},function(){e.hiddenPaths&&e.hiddenPaths.length>0&&o.getHideShowController().hide({idPaths:e.hiddenPaths,dispatch:!1}),e.shownPaths&&e.shownPaths.length>0&&o.getHideShowController().show({idPaths:e.shownPaths,dispatch:!1}),o.getController().unsubscribe(t)})}return void this.getBIController().getBIProxy().linkWith({srcWgtId:e.srcWidgetID,callback:function(){i||(o.refresh(!1),t._onFinishSync(),i=!0),console.log("Linked BIProxy of "+widget.id+" with "+e.srcWidgetID)}})}let r=t.createView(t=>t.id===e.srcWidgetID);var n=function(){if(console.log("Linked BIProxy of "+widget.id+" with "+e.srcWidgetID),!i)if(i=!0,e.rootsToSync.length>0){let i=[];for(let t=0;t<e.rootsToSync.length;t++){let o=e.rootsToSync[t].type;i.push({type:o})}let n,a,l=e.rootsToSync.filter(function(e){return!e.isR2V}),d=e.rootsToSync.filter(function(e){return e.isR2V});if(d.length>0?o.empty(!1,!0):o.empty(!1,!1),l.length>0){n={objects:[],paths:[]};for(let e=0;e<l.length;e++){let t=l[e].rootID,i=l[e].serviceID,o=l[e].filterId,s=l[e].type,r=l[e].pathes;n.objects.push({path:[t],serviceId:i,filterId:o,type:s});for(let e=0;e<r.length;e++){let t=r[e];n.paths.push(t)}}}if(d.length>0){a={objects:[],dispatch:!1,displayNotif:!1,reframe:!0};for(let e=0;e<d.length;e++){let t=d[e].rootID,i=d[e].type;a.objects.push({objectId:t,serviceId:d[e].serviceID,type:i})}}let c=[];var t=s.getPromises();Promise.all(t).then(function(){h.isTypesAuthorized(i,function(t,i){if(l.length>0){n.objects=n.objects.filter(function(e){return t.includes(e.type)});let i=n.objects.map(e=>e.path[0]);delete n.objects,n.paths=n.paths.filter(function(e){return i.includes(e[0])}),c.push(new Promise((t,i)=>{n.paths.length>0?o.getController().addRoots(n,!1,!0,o.getAutomaticReframePolicy(),()=>{e.hiddenPaths&&e.hiddenPaths.length>0&&o.getHideShowController().hide({idPaths:e.hiddenPaths,dispatch:!1}),e.shownPaths&&e.shownPaths.length>0&&o.getHideShowController().show({idPaths:e.shownPaths,dispatch:!1}),t()}):i()}))}d.length>0&&(a.objects=a.objects.filter(function(e){return t.includes(e.type)}),a.objects=a.objects.map(e=>(delete e.type,e)),c.push(new Promise((e,t)=>{a.objects.length>0?o.getController().addR2Vs(a).then(()=>{e()}):t()}))),Promise.all(c).then(()=>{r.publish("DS/ExternalWdgtCom/FinishedSync")},()=>{r.publish("DS/ExternalWdgtCom/FinishedSync",{notSupportedError:widget.id})})},!0,!1,"2.0")})}else o.empty(!1,!0),r.publish("DS/ExternalWdgtCom/FinishedSync")};"function"==typeof this.getBIController().getBIProxy().linkWith?this.getBIController().getBIProxy().linkWith({srcWgtId:e.srcWidgetID,callback:n}):a.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{this.getBIController().getBIProxy().linkWith({srcWgtId:e.srcWidgetID,callback:n})})}}.bind(this);this._appReadyForSync?o():i=this.subscribe({event:"onReady"},o.bind(this))},_unLinkBIProxy:function(e){"function"==typeof this.getBIController().getBIProxy().unlink&&("function"==typeof this.getStatusBar&&this.getStatusBar()._widgetLinkPanelOpened&&this._WLOptionsPanel&&(this.getController().publish({event:"onEnableUX"}),this._WLOptionsPanel.getDialog().close(),this.getStatusBar()._widgetLinkPanelOpened=!1),this.getBIController().getBIProxy().unlink({widgetId:widget.id,srcWgtId:e,NGFUXId:t.getPreviousNGFUXID(),callback:()=>{console.log("Unlinked BIProxy of "+widget.id+" from "+e)}}),t.setPreviousNGFUXID(this.getNGFUXID(!0)))},_linkBIProxy:function(e){"function"==typeof this.getBIController().getBIProxy().linkWith&&this.getBIController().getBIProxy().linkWith({srcWgtId:e,callback:()=>{console.log("Linked BI Proxy of"+widget.id+" with "+e),this._resolveLinkProxyPromise()}})},_endSync:function(e){n.removeNotifications("syncInfo");const i=s.getPromises();Promise.all(i).then(()=>{t.setWidgetSynchronizing(!1),e&&e.isInitiator?this.getController().publish({event:"onEnableUX"}):"undefined"==typeof widget||!e||e.widgetsWithErrors.includes(widget.id)||this._isChoosingWLOptionsFromLink||(this.getController().publish({event:"onEnableUX"}),o.displayNotif({level:"success",message:r.syncSuccessNotif,sticky:!1}))})},_onSyncContent3D:function(e){t.addWidgetLinkHit("event-3d","DS/ExternalWdgtCom/SyncContent3D"),e.fromEnableContent?t._onSync(!0):(this._isChoosingWLOptionsFromLink=!0,this._openWLOptionsPanel(!0,e.fromWidgetId))},_onCancelSyncContent3D:function(){this.getController().publish({event:"onEnableUX"})},_openWLOptionsPanel:function(e,i){this.getStatusBar()._widgetLinkPanelOpened||(this.getController().publish({event:"onDisableUX"}),this._WLOptionsPanel=new d({events:{onConfirm:function(t){this.getController().publish({event:"onEnableUX"}),this.getStatusBar()._widgetLinkPanelOpened=!1,this._isChoosingWLOptionsFromLink=!1,this._syncFeatures(t,e,i)}.bind(this),onCancel:function(){if(this.getStatusBar()._widgetLinkPanelOpened=!1,this._isChoosingWLOptionsFromLink=!1,e){let e=t.getLinked().filter(e=>e.id===i);e.length>0&&e[0].unlink("test")}this.getController().publish({event:"onEnableUX"}),t.createView(function(e){return e.id===i}).publish("DS/ExternalWdgtCom/CancelSyncContent3D")}.bind(this)},features:t.getSyncFeatures()}),this.getStatusBar()._widgetLinkPanelOpened=!0)},_syncFeatures:function(e,i,o){let n=t.getSyncFeatures(),s=e.features,r=s.includes(1),a=s.includes(2);this.getStatusBar()._widgetLinkPanelOpened=!1,n.Content!==r&&(r?(this._enableContentSync(),i||t._onSync()):(this._disableContentSync(e.fromWidgetId),this.getController().publish({event:"onEnableUX"}))),i&&this._launchContentSync(o),(n.ViewPoint!==a||i)&&(a?this._enableViewpointSync():this._disableViewpointSync())},_enableViewpointSync:function(){t.enableSyncFeature("ViewPoint"),t.publish("DS/ExternalWdgtCom/ViewPointSync",{viewpoint:this.getViewpointParameters(),fromEnableFeature:!0}),o.displayNotif({level:"success",message:r.viewpointSyncSuccessNotif,sticky:!1})},_disableViewpointSync:function(){t.disableSyncFeature("ViewPoint")},_enableContentSync:function(){t.enableSyncFeature("Content")},_launchContentSync:function(e){t.createView(function(t){return t.id===e}).publish("DS/ExternalWdgtCom/SyncContent3D",{fromEnableContent:!0})},_disableContentSync:function(){t.disableSyncFeature("Content");let e=t.getLinked();for(let i=0;i<e.length;i++){let o=e[i],n=o.id!==widget.id?o.id:o._widgetLink.id;t.isInitiatorOfLink(n)?(this._unLinkBIProxy(widget.id),t.publish("DS/ExternalWdgtCom/UnlinkBIProxy",widget.id)):(this._unLinkBIProxy(n),t.publish("DS/ExternalWdgtCom/UnlinkBIProxy",n))}}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewer2DClusterController",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions","DS/ENOPAD3DViewer/utils/PADQuadTree","DS/ENOPAD3DViewer/views/PAD3DPushpinNodeGroup","DS/ENOPAD3DViewer/views/PAD3DPOINodeNew"],function(e,t,i,o,n,s,r,a,l){return e.extend({_update2DCluster:function(e,t){if("2d"===s.getClusteringType()){this._groups&&this._groups.clear(),this._groupNodes&&this._groupNodes.removeChildren();var o=this._layers.get("POIs");o&&o.size>0&&o.forEach(function(o){var n=o;if(n.isLayerVisible()){var d=Math.floor(Math.sqrt(n.getMaxClusters())),h=e/d,c=t/d;if(n.isClustered()){if(!0===s.isMemPCS()){var p,u=o.getNode3DBag(),g=new Map,_=new Map;if(u&&u.children){for(var f=u.children,v=0;v<f.length;v++)if("PAD3DPOINode"===f[v].className){var m=f[v].children;if(f[v]&&m&&m.length){var b=f[v].children;if((this._pinnedPOIExclusionMap.size||this._whiteListPOI&&this._whiteListPOI.size)&&b&&b.length){"\n  ------------------------ ","\n  @ 216 --- this._whiteListPOI ---- "+this._whiteListPOI.size,"\n  @ 216 --- children[j].children ---- "+f[v].children.length,"\n  ------------------------ ";var y=[],P=[],D=[],I=[];this._pinnedPOIExclusionMap.forEach(function(e,t){if(e._layerId===n.getID()){for(var i=b.length-1;i>=0;i--)b[i]&&n.getID()===b[i]._layerId&&b[i].name===e._name&&("\n  ^^^^^^^^^ @ _pinnedPOIExclusionMap MATCH FOUND  with child idx "+i+" , "+e._label+" , "+e._layerId+" , "+e._name,y.push(i));for(var o=b.length-1;o>=0;o--)if(n.getID()===b[o]._layerId){for(var s=!1,r=0;r<y.length;r++){o===y[r]&&(s=!0)}s||P.push(o)}}}.bind(this)),this._whiteListPOI.size&&this._whiteListPOI.forEach(function(e,t){if(e)if(e.node&&e.node._type&&e.node._name)"\n  @ _whiteListPOI "+t+", "+e.node._type+", "+e.node._name;else if("\n  @ _whiteListPOI "+t+" , "+e._label+" , "+e._layerId+" , "+e._name,n.getID()===e._layerId)for(var i=b.length-1;i>=0;i--)b[i]&&n.getID()===b[i]._layerId&&b[i].name===e._name&&("\n  ^^^^^^^^^ @ _whiteListPOI MATCH FOUND  with child idx "+i+", "+t+" , "+e._label+" , "+e._layerId+" , "+e._name,D.push(i));for(var o=b.length-1;o>=0;o--)if(n.getID()===b[o]._layerId){for(var s=!1,r=0;r<D.length;r++){o===D[r]&&(s=!0)}s||I.push(o)}}.bind(this));var S=f[v].children;if(S&&S.length){for(var C=" ",w=" ",x=[],O=" ",A=" ",M=0;M<D.length;M++)A+=", ",A+=D[M],O+=", ",D[M]<S.length&&(O+=S[D[M]].name,x.push(S[D[M]].name));for(var N=0;N<y.length;N++)A+=", ",A+=D[N],O+=", ",y[N]<S.length&&(O+=S[y[N]].name,x.push(S[y[N]].name));"\n  sKeepIdx "+A,"\n  sKeepIdxNames "+O;for(var V=S.length-1;V>=0;V--)if(n.getID()===S[V]._layerId){for(var E=!1,T=!1,R=0;R<D.length;R++)V===D[R]&&(E=!0);for(var L=0;L<y.length;L++)V===y[L]&&(T=!0);E||T||(w+=", ",w+=V,C+=", ",C+=S[V].name)}"\n  sRemoveIdx "+w,"\n  sRemoveIdxNames "+C;for(var F=f[v].children.length-1;F>=0;F--){bOKToRemove=!0;for(var k=0;k<x.length;k++)x[k]===f[v].children[F].name&&(bOKToRemove=!1);bOKToRemove&&f[v].removeChild(f[v].children[F])}"\n  ------ children[j].children.length  ------ AFTER REMOVE CHILD ------- ","\n  ------ "+f[v].children.length+" ------- ","\n  ------ children[j].children.length  ------ AFTER REMOVE CHILD ------- "}"\n  @ 380 --- this._whiteListPOI ---- "+this._whiteListPOI.size,"\n  @ 380 --- children[j].children ---- "+f[v].children.length,"\n  ------------------------ "}else"\n  @ 385 --- removeAllChildren ",f[v].removeChildren()}}0}}this._poisQuadTree&&(this._poisQuadTree.clear(),this._poisQuadTree=null),this._poisQuadTree=new r({boundary:{x:0,y:0,w:e,h:t},capacity:4});var B,G=this._context.getViewpoint().position,U=(new i.Vector3).subVectors(this._context.getViewpoint().target,G),z=this._proximityGroups.get(n.getID());if(z&&z.size>0)for(var W=z.values(),H=W.next();!H.done;){var j=H.value;if(n.getID()===j.layerID)if(this._whiteListPOI.has(j.node._name))j.node.setVisibility(!0);else if(U.x*(j.position.x-G.x)+U.y*(j.position.y-G.y)+U.z*(j.position.z-G.z)>0)if((ie=this._context.getViewpoint().project((new i.Vector3).copy(j.position)))&&ie.x>20&&ie.y>32&&ie.x<e&&ie.y<t){var Q={layer:n.getID(),node:j.node,pois:j.pois,coord2D:ie,coord3D:j.position,name:j.name},q={position:{x:ie.x-10,y:ie.y-16,z:ie.z,w:20,h:32},position3D:j.position,data:Q};this._poisQuadTree&&this._poisQuadTree.insert(q)}H=W.next()}if(!1===s.isMemPCS()&&(B=this._layerPOIsIdInstancingNodeMap.get(n.getID())),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&this._layerPOIsIdInstancingNodeMapMaster&&(B=this._layerPOIsIdInstancingNodeMapMaster.get(n.getID())),B&&B.size>0&&n.isClustered()){var X=B.values(),K=X.next();for(B.size;!K.done;){var Z=K.value;if(!Z.instancingPOI){var J=this._tooltipNodesPinnedMap.get(n.getID());(this._whiteListPOI.has(n.getID()+"_"+Z.instanceId)||J&&J.has(Z.instanceId))&&Z.setVisibility(!0);var Y=Z.getPosition(),$=!1,ee=(Z.instanceId,n.getID(),this._proxGroupPOIsForLayer.get(n.getID()));if(ee&&ee.size>0){var te=ee.get(Z.instanceId);te&&($=!0)}if(!$&&(this._whiteListPOI.has(n.getID()+"_"+Z.instanceId)||J&&J.has(Z.instanceId)||U.x*(Y.x-G.x)+U.y*(Y.y-G.y)+U.z*(Y.z-G.z)>0)){var ie=this._context.getViewpoint().project(Y);if(this._whiteListPOI.has(n.getID()+"_"+Z.instanceId)||J&&J.has(Z.instanceId)||ie&&ie.x>20&&ie.y>32&&ie.x<e&&ie.y<t){Q={layer:n.getID(),node:Z,instanceId:Z.instanceId,coord2D:ie,coord3D:Y,color:Z.getColorPOI(),id:Z.getId(),label:Z.getLabelPOI()};var oe={position:{x:ie.x-10,y:ie.y-16,z:ie.z,w:20,h:32},position3D:Y,data:Q};this._poisQuadTree&&this._poisQuadTree.insert(oe)}else Z.isVisible()&&Z.setVisibility(!1),0}else Z.isVisible()&&Z.setVisibility(!1),0}K=X.next()}}else if(this._proximityGroups&&this._proximityGroups.size>0&&this._proximityGroups&&this._proximityGroups.size>0){U=(new i.Vector3).subVectors(this._context.getViewpoint().target,G);this._proximityGroups.forEach(function(o){o.forEach(function(o){if(n.getID()===o.layerID)if(this._layerController.getLayer(o.layerID)){var s=this._context.getViewpoint().project((new i.Vector3).copy(o.position));s&&s.x>20&&s.y>32&&s.x<e&&s.y<t?(o.node.setVisibility(!0),o.node.render()):o.node.setVisibility(!1)}else o.node.setVisibility(!1)}.bind(this))}.bind(this))}for(var ne=[],se=0;se<Math.floor(this._clustersPerLine)+1;se++)for(var re=0;re<Math.floor(this._clustersPerLine)+1;re++)ne.push({x:se*h,y:re*c,w:h,h:c});for(var ae=0;ae<ne.length;++ae){var le=this._poisQuadTree.query(ne[ae]);if(le.length>1){for(var de=0,he=0,ce=0,pe=[],ue=0;ue<le.length;ue++)if(le[ue].layerId=n.getID(),le[ue]&&le[ue].data&&le[ue].data)if(le[ue].data.pois&&le[ue].data.pois.length>0){le[ue].data.node.setVisibility(!1);for(var ge=le[ue].data.pois,_e=0;_e<ge.length;_e++)pe.push(ge[_e]),de+=ge[_e].data.coord3D.x,he+=ge[_e].data.coord3D.y,ce+=ge[_e].data.coord3D.z}else{if(this._whiteListPOI.has(n.getID()+"_"+le[ue].data.node.instanceId)||J&&J.has(le[ue].data.node.instanceId))(me=le[ue].data.node)&&me.setVisibility(!0);else de+=le[ue].position3D.x,he+=le[ue].position3D.y,ce+=le[ue].position3D.z,le[ue].data.node.setVisibility(!1),pe.push(le[ue])}if(pe.length>1){if(de/=pe.length,he/=pe.length,ce/=pe.length,n.getGroupView())n.getGroupView();if("2d"===s.getClusteringType()){var fe=new a({parent:this._groupNodes,fillColor:n.getColor(),position:{x:de,y:he,z:ce},number:pe.length,name:"PAD3DPOIGroupNode"+ae+"_"+n.getID(),layerID:n.getID(),type:"2DClusteringNode",scale:n.getPOIScale(),icon:n.getPOIIcon(),onHoverCallback:this._onHoveroverPOINodeGroupcallback.bind(this),outHoverCallback:this._outHoveroverPOINodeGroupcallback.bind(this)});this._groups.set("PAD3DPOIGroupNode"+ae+"_"+n.getID(),{pois:pe,square:ne[ae],layer:n.getID(),layerID:n.getID(),position:{x:de,y:he,z:ce},node:fe,name:"PAD3DPOIGroupNode"+ae+"_"+n.getID(),layerGroupView:n.getGroupView()}),fe.setVisibility(!0)}else for(ue=0;ue<le.length;ue++){var ve=le[ue].node;ve&&ve.setVisibility(!0)}pe.length}else if(1===pe.length){(me=pe[0].node)&&me.setVisibility(!0)}}else if(1===le.length&&le[0]){var me;if((me=le[0].data.node)&&(!1===s.isMemPCS()&&me.setVisibility(!0),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()))if("proximity"===me._typeDraw)me.setVisibility(!0),me.render();else if(p){var be=new l({context:this._context,parent:p,fillColor:me._fillColor,position:new i.Vector3(me._position.x,me._position.y,me._position.z),instanceId:me.instanceId,poiId:me._poiId,name:"PAD3DPOINode_"+me.instanceId,label:me._label,layerId:n.getID(),scale:n.getPOIScale(),icon:n.getPOIIcon(),pickability:!0,enablePOIPanel:!0,onHoverCallback:this._onHoveroverPOINodecallback.bind(this),outHoverCallback:this._outHoveroverPOINodecallback.bind(this)});g.set(me.instanceId,be),_.set(me.instanceId,""+me.instanceId/5-1),be.setVisibility(!0)}}}!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(this._layerPOIsIdInstancingNodeMap.set(n.getID(),g),this._layerPOIsIdInstancingIndexMap.set(n.getID(),_))}else if(this._proximityGroups&&this._proximityGroups.size>0&&this._proximityGroups&&this._proximityGroups.size>0){G=this._context.getViewpoint().position,U=(new i.Vector3).subVectors(this._context.getViewpoint().target,G);var ye=this._proximityGroups.get(n.getID());ye&&ye.forEach(function(o){if(this._layerController.getLayer(o.layerID)){var n=this._context.getViewpoint().project((new i.Vector3).copy(o.position));n&&n.x>20&&n.y>32&&n.x<e&&n.y<t?(o.node.setVisibility(!0),o.node.render()):o.node.setVisibility(!1)}else o.node.setVisibility(!1)}.bind(this))}}}.bind(this))}}})}),define("DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","UWA/Core","UWA/Class","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/Controls/Button","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n,s,r){"use strict";return i.extend({init:function(e){this.context=n.get(),this.floatingpanel={},this.closeButton={},this.close=this.close.bind(this),this.context.getViewer()&&this.context.getViewer()._enableInfos&&this.context.getViewer()._enableInfos(!0)},execute:function(){require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t){const i=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});i.setEventData({eventLabel:"PAD3DViewerDebugVisuCmd"}),i.trackPageEvent()});const i=this.context.getViewer().onPostRender(()=>{this.context.getViewer()._modelEvent.unsubscribe(i);const o=t.createElement("div",{}),n=t.createElement("div",{});this._build(o,n),require(["DS/ENOFloatingPanel/ENOFloatingPanel"],t=>{this.floatingpanel=new t({body:o,footer:n,title:e.debugVisuTitle,overlay:!0,closable:!0,animate:!0,resizable:!0,visible:!0,events:{onClose:this.close}}),this.floatingpanel.inject(document.body)})});this.context.getViewer().render()},_build:function(i,n){i.id="DebugVisuCmdPanel",i.style.width="100%",i.style.height="100%",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i.style.flexDirection="column";var a={styles:{marginBottom:0}},l=t.createElement("p",a).inject(i),d=t.createElement("p",a).inject(i),h=t.createElement("p",a).inject(i),c=t.createElement("p",a).inject(i),p=t.createElement("p",a).inject(i),u=t.createElement("p",a).inject(i),g=t.createElement("p",a).inject(i),_=t.createElement("p",a).inject(i),f=t.createElement("p",a).inject(i),v=t.createElement("p",a).inject(i),m=t.createElement("p",a).inject(i),b=t.createElement("p",a).inject(i),y=t.createElement("p",a).inject(i),P=t.createElement("p",a).inject(i),D=t.createElement("p",a).inject(i),I=t.createElement("p",a).inject(i);this.closeButton=new s({label:e.close,emphasize:"primary",touchMode:!0}).inject(n),this.closeButton.elements.button.id="DebugVisuCmdCloseButton",this.closeButton.addEventListener("click",this.close);var S=0,C=0,w=0,x=0;if(!0===o.getSetting("enopad3dviewer_lightNodeModel")){var O={},A=function(e){for(var t=0;t<e.children.length;++t){if(!(e.children[t].children.length>0)||O[e.children[t].modelIdentification])return;r.isReference(e.children[t])?++x:r.isRepInstance(e.children[t])?++S:r.isInstance(e.children[t])?++C:r.isRepReference(e.children[t])&&++w,O[e.children[t].modelIdentification]=1,A(e.children[t])}}.bind(this),M=this.context.getController()._model._nodeIndex.rootBag;A(M)}else{!function(e){for(var t=Object.getOwnPropertyNames(e),i=0;i<t.length;i++)r.isReference(e[t[i]])?x++:r.isInstance(e[t[i]])?C++:r.isRepReference(e[t[i]])?w++:r.isRepInstance(e[t[i]])&&S++}(this.context.getController()._model._nodeIndex)}var N=this.context.getViewer().getInfos(),V=N.memory,E=N.render;l.innerHTML=e.debugVisuRefAmount+"<b>"+x+"</b>",d.innerHTML=e.debugVisuInstAmount+"<b>"+C+"</b>",h.innerHTML=e.debugVisuRepRefAmount+"<b>"+w+"</b>",c.innerHTML=e.debugVisuRepInstAmount+"<b>"+S+"</b>",p.innerHTML=e.debugVisuTotalGeometryAmount+"<b>"+V.geometries+"</b>",u.innerHTML=e.debugVisunbSharedBufferAmount+"<b>"+V.sharedbuffers+"</b>",g.innerHTML=e.debugVisunbTexturesAmount+"<b>"+V.textures+"</b>",_.innerHTML=e.debugVisunbProgramsAmount+"<b>"+V.programs+"</b>",f.innerHTML=e.debugVisunbCallsAmount+"<b>"+E.calls+"</b>",v.innerHTML=e.debugVisunbFacesAmount+"<b>"+E.faces+"</b>",m.innerHTML=e.debugVisunbLinesAmount+"<b>"+E.lines+"</b>",b.innerHTML=e.debugVisunbMeshesAmount+"<b>"+E.meshes+"</b>",y.innerHTML=e.debugVisunbCulledMeshesAmount+"<b>"+E.culledMeshes+"</b>",P.innerHTML=e.debugVisunbCulledGeometriesAmount+"<b>"+E.culledGeometries+"</b>",D.innerHTML=e.debugVisunbCulledTrianglesAmount+"<b>"+E.culledDGTriangles+"</b>",I.innerHTML=e.debugVisunbCulledLinesAmount+"<b>"+E.culledDGLines+"</b>";var T,R={refCount:x,instCount:C,repRefCount:w,repInstCount:S,geometries:V.geometries,sharedBuffer:V.sharedbuffers,textures:V.textures,programs:V.programs,calls:E.calls,faces:E.faces,lines:E.lines,meshes:E.meshes,culledMeshes:E.culledMeshes,culledGeometries:E.culledGeometries,culledDGTriangles:E.culledDGTriangles,culledDGLines:E.culledDGLines},L=(T=document.createElement("a"),document.body.appendChild(T),/Edge/.test(navigator.userAgent)?T.style.display="none;":/Firefox/.test(navigator.userAgent)||/Google Inc/.test(navigator.vendor)?T.style="display: none":T.setAttribute("display","none"),function(e,t){if(document.documentMode)navigator.msSaveBlob(e,t);else{var i=window.URL.createObjectURL(e);T.href=i,T.download=t,T.click(),window.URL.revokeObjectURL(i)}}),F=new Blob([JSON.stringify(R,null,2)],{type:"application/json"});L(F,Date.now()+"-VisuDebugValues.json"),L=null,F=null},close:function(){this.closeButton.removeEventListener("click",this.close),this.floatingpanel.destroy(),this.destroy()},destroy:function(){delete this.context,delete this.floatingpanel,delete this.closeButton}})}),define("DS/ENOPAD3DViewer/views/PAD3DFindInContextColorized",["DS/CoreEvents/ModelEvents","UWA/Class","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n,s){"use strict";return t.extend({applyGraphicPropertiesForFindInCtx:function(e,t){var n,r,a=this._searchResultColor,l=[],d=[];n=this.getRoots();for(var h=this.getController()._layerController.createLayer({label:'"'+t+'"',color:a,kind:"search",type:"search"}),c=0;c<e.length;c++)l[c]=this.unstreamPath(e[c]),1===e[c].length&&d.push(e[c][0]);if(this._findInCtxLayers.push(h),!0===i.getSetting("enopad3dviewer_lightNodeModel")){for(var p=0;p<e.length;p++)!1===h.getOverrideSet().hasOverrideCB(e[p][e[p].length-1])&&h.getOverrideSet().setOverrideCB(e[p][e[p].length-1],function(e,t){if(t)if(-1!==d.indexOf(e))t.setOpacity(.3,!1),t.setColor("#ffffff",!1);else{t.setOpacity(1,!0)}}.bind(this));for(var u=0;u<l.length;u++)r=!0,l[u]&&h.getHighlightSet().add(l[u],{highlightColor:new o.Color(a)},r);for(var g=0;g<n.length;g++){var _=s.getNodeID(n[g]);-1===d.indexOf(_)&&h.getOverrideSet().setOverrideCB(_,function(e,t){t&&(t.setOpacity(.3,!1),t.setColor("#ffffff",!1))})}}else{for(var f=0;f<e.length;f++){r=!0,(D=l[f])&&h.getHighlightSet().add(D,{highlightColor:new o.Color(a)},r);var v=1,m=!0;(P=h.getOverrideSet().createOverride(D))&&P.setOpacity(v,m)}for(var b=0;b<n.length;b++){var y=s.getNodeID(n[b]);if(-1===d.indexOf(y)){var P,D=this.unstreamPath([s.getNodeID(n[b])]);v=.3,m=!1;(P=h.getOverrideSet().createOverride(D))&&(P.setOpacity(v,m),P.setColor("#ffffff",m))}}h.show()}navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&this.getController().get3DLayerController().getLayerListView().options.renderTo.dockingElements&&this.getController().get3DLayerController().getLayerListView().options.renderTo.dockingElements[1]&&(this.getController().get3DLayerController().getLayerListView().options.renderTo.dockingElements[1].collapseDockingZoneFlag=!0),h.subscribe({event:"updateSearchLayerColor"},function(e){a=e.color,h.options.color=e.color,h.getHighlightSet().setHighlightData(null,{outlineEnabled:!0,outlineColor:new o.Color(a),outlineAlpha:.5,outlineThickness:.1,haloEnabled:!0,haloColor:new o.Color(a),haloIntensity:.4,haloThickness:1,color:new o.Color(a),colorEnabled:!0,priority:-10,clearDepth:!0}),!1!==h.isLayerVisible()&&h.show()}.bind(this)),h.subscribe({event:"hide"},function(e){for(var t=0;t<l.length;t++)l[t]&&h.getHighlightSet().remove(l[t],{highlightColor:new o.Color(a)})}.bind(this)),h.subscribe({event:"delete"},function(e){h.getHighlightSet()&&this._viewer.removeHighlightSet(h.getHighlightSet())}.bind(this)),h.subscribe({event:"show"},function(e){for(var t=0;t<l.length;t++){l[t]&&h.getHighlightSet().add(l[t],{highlightColor:new o.Color(a)},!0)}}.bind(this))},initFindInContextColorizedSubscription:function(){this._searchResultColor="#008000",this._findInCtxLayers=[],this.subscribe({event:"onEndRootRemoved"},function(){for(var e=this._findInCtxLayers.length-1;e>=0;e--){this.getController()._layerController.deleteLayer(this._findInCtxLayers[e]);var t=this._findInCtxLayers[e].getHighlightSet();t&&this._viewer.removeHighlightSet(t)}this._findInCtxLayers=[]}.bind(this)),this.subscribe({event:"onComplete"},function(e){if("addRoot"===e.intend){for(var t=this._findInCtxLayers.length-1;t>=0;t--){this.getController()._layerController.deleteLayer(this._findInCtxLayers[t]);var i=this._findInCtxLayers[t].getHighlightSet();i&&this._viewer.removeHighlightSet(i)}this._findInCtxLayers=[]}}.bind(this)),this.subscribe({event:"onEndReparent"},function(){for(var e=this._findInCtxLayers.length-1;e>=0;e--){this.getController()._layerController.deleteLayer(this._findInCtxLayers[e]);var t=this._findInCtxLayers[e].getHighlightSet();t&&this._viewer.removeHighlightSet(t)}this._findInCtxLayers=[]}.bind(this)),this.subscribe({event:"onEndReplaceInstance"},function(){for(var e=this._findInCtxLayers.length-1;e>=0;e--){this.getController()._layerController.deleteLayer(this._findInCtxLayers[e]);var t=this._findInCtxLayers[e].getHighlightSet();t&&this._viewer.removeHighlightSet(t)}this._findInCtxLayers=[]}.bind(this)),this.subscribe({event:"onEndDelete"},function(){for(var e=this._findInCtxLayers.length-1;e>=0;e--){this.getController()._layerController.deleteLayer(this._findInCtxLayers[e]);var t=this._findInCtxLayers[e].getHighlightSet();t&&this._viewer.removeHighlightSet(t)}this._findInCtxLayers=[]}.bind(this)),this.subscribe({event:"onInsertExisting"},function(){for(var e=this._findInCtxLayers.length-1;e>=0;e--){this.getController()._layerController.deleteLayer(this._findInCtxLayers[e]);var t=this._findInCtxLayers[e].getHighlightSet();t&&this._viewer.removeHighlightSet(t)}this._findInCtxLayers=[]}.bind(this))}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerTooltipController",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/Node3D","DS/PADServices/utils/PADTrackerManager","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions","DS/ENOPAD3DViewer/views/PAD3DPOIHoverTooltip"],function(e,t,i,o,n,s,r,a){return e.extend({_onHoverGroupEmpty:function(){if(this._tooltipNodes){for(var e=this._tooltipNodes.getChildren(),t=0;t<e.length;t++){var i=e[t];if(i){var o=i.name;if(isNaN(o)){var n,s="";if(s+=parseInt(o.split(" ")[1]),this._tooltipNodesMap.has(s))i._layerId&&(n=this._tooltipNodesMap.get(s+i._layerId).hoverNode),n&&(n.undogeneratepopup(),n.removeTooltip())}}}this._tooltipNodes.removeChildren()}this._bHoverOverPOIHoverTooltip_Pin_as_clicked&&!this._bHoverOverPinnedToUnpinned_clicked&&(this._bHoverOverPOIHoverTooltip=!1,this._preselectedSinglePOIHoverNode&&this._preselectedSinglePOIHoverNode._parent&&this._preselectedSinglePOIHoverNode.pinClicked_Tooltip()),this._bHoverOverPinnedToUnpinned_clicked&&this._preselectedSinglePOIHoverNode&&this._preselectedSinglePOIHoverNode._parent&&1===this._tooltipNodes.children.length&&this._tooltipNodes.removeChildren(),this._bHoverOverPOIHoverTooltip||(this._bHoverOverPOIHoverTooltip_Pin_as_clicked?this._preselectedSinglePOIHoverNode=null:this._preselectedSinglePOIHoverNode&&this._preselectedSinglePOIHoverNode._parent),this._cleanHoverTooltip(),this._bHoverOverPOIHoverTooltip=!1,this._bHoverOverPOIHoverTooltip_Pin_as_clicked=!1,this._bHoverOverPinnedToUnpinned_clicked=!1,this._bhoverOverGroupNode=!1},_onHoverGroup:function(){},_onTTHoverManipulateCB:function(e){if(e.intersection.path.length){var t=e.intersection.path[0];if(t)for(var i=t.externalPath,o=i.length,r=0;r<o;r++){if("POINodeTooltip"===i[r].className){var a,l=i[r].name,d=i[r]._layerId;if(this._layerPOIsIdInstancingNodeMap&&this._layerPOIsIdInstancingNodeMap.get(d)){var h=this._layerPOIsIdInstancingNodeMap.get(d).get(l);if(h){if(this._preselectedSinglePOIHoverNode||i[r-1]&&"PAD3DPOITooltipNodePinned"===i[r-1].className)if(this._preselectedSinglePOIHoverNode&&this._preselectedSinglePOIHoverNode._POIObject&&this._preselectedSinglePOIHoverNode._POIObject.instanceId===l)a=this._preselectedSinglePOIHoverNode;else if(this._tooltipNodesMap){var c=this._tooltipNodesMap.get(l+d);c&&c.hoverNode._number===l&&(a=c.hoverNode)}var p=!0;if(a)if(!0===a.getpinClickedTooltip()){p=!1;var u=!1;if(this._layers.get("POIs")&&(D=this._layers.get("POIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")),D)D.children.forEach(function(e){u||e.name===l&&(P=e,u=!0)});if(this._layers.get("POIs")&&this._layers.get("POIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")){var g=s.getPADTracker({eventCategory:"usage",eventAction:"3d_POITooltip_stats"});a&&"SinglePOINode"===a._type&&(g.persDim.pd2="Unpinned"),g.trackPageEvent(),this._layers.get("POIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned").removeChild(P)}this._pinnedPOIExclusionMap.delete(l),this._tooltipNodesPinnedMap.get(d)&&this._tooltipNodesPinnedMap.get(d).has(l)&&this._tooltipNodesPinnedMap.get(d).delete(l),this._context.getViewer().render()}else a.pinClicked_Tooltip()}}if(p&&a&&h){this._tooltipNodesMap.set(l+d,{hoverNode:a,poiNode:h});var _,f=this._tooltipNodesMap.get(l+d);if(f&&(S=f.hoverNode,_=f.poiNode),S&&_){var v=this._tooltipNodesPinnedMap.get(d);v||(v=new Map,this._tooltipNodesPinnedMap.set(d,v)),v&&v.set(l,S),this._pinnedPOIExclusionMap.set(l,_),this._layers.get("POIs")&&(I=this._layers.get("POIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")),I||((I=new n("PAD3DPOITooltipNodePinned")).className="PAD3DPOITooltipNodePinned",this._layers.get("POIs")&&this._layers.get("POIs").get(d).getNode3DBag().addChild(I)),I&&(this._tooltipNodes.children.length&&I.addChild(this._tooltipNodes.children[0]),S&&S.relinkNode())}}else a&&(a.render(),this._cleanHoverTooltip(),this._onHoverGroupEmpty());setTimeout(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this),50)}if("ZOITooltip"===i[r].className){l=i[r].name,d="";if(i[r]._layerID&&(d=i[r]._layerID),i[r]._layerId&&(d=i[r]._layerId),this._preselectedSinglePOIHoverNode&&d)if(this._preselectedSinglePOIHoverNode._layerID===d);else{var m;this._preselectedSinglePOIHoverNode=null;var b,y=!1;if(this._layers.get("ZOIs")&&this._layers.get("ZOIs").get(d)&&this._layers.get("ZOIs").get(d).getNode3DBag()&&(b=this._layers.get("ZOIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")),b)b.children.forEach(function(e){y||e.name===l&&(m=e,y=!0)});this._layers.get("ZOIs")&&this._layers.get("ZOIs").get(d)&&this._layers.get("ZOIs").get(d).getNode3DBag()&&this._layers.get("ZOIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")&&(this._layers.get("ZOIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned").removeChild(m),this._context.getViewer().render())}if(d)if(this._preselectedSinglePOIHoverNode&&!0===this._preselectedSinglePOIHoverNode._pinned||!0===this._preselectedSinglePOIHoverNode_ExistingFound){var P,D;p=!1,u=!1;if(this._layers.get("ZOIs")&&this._layers.get("ZOIs").get(d)&&this._layers.get("ZOIs").get(d).getNode3DBag()&&(D=this._layers.get("ZOIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")),D)D.children.forEach(function(e){u||e.name===l&&(P=e,u=!0)});if(this._layers.get("ZOIs")&&this._layers.get("ZOIs").get(d)&&this._layers.get("ZOIs").get(d).getNode3DBag()&&this._layers.get("ZOIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"))this._layers.get("ZOIs").get(d).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned").removeChild(P),this._context.getViewer().render()}else if(this._preselectedSinglePOIHoverNode){this._preselectedSinglePOIHoverNode.pinClicked_Tooltip();var I,S,C=this._zoneIdToLayerMap.get(this._preselectedSinglePOIHoverNode.getId());if((I=this._layers.get("ZOIs").get(C).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"))||((I=new n("PAD3DPOITooltipNodePinned")).className="PAD3DPOITooltipNodePinned",this._layers.get("ZOIs").get(C).getNode3DBag().addChild(I)),I)this._tooltipNodes.children.length&&I.addChild(this._tooltipNodes.children[0]),(S=this._preselectedSinglePOIHoverNode)&&S.relinkNode()}}}}},_outTTHoverManipulateCB:function(e){},_onHoverTTHoverPreactivateCB:function(e){if(e&&e.intersection&&e.intersection.path)for(var t=e.intersection.path,i=0;i<t.length;i++)if(t[i].externalPath)for(var o=t[i].externalPath,n=0;n<=o.length-2;n++)o[n].className&&"PAD3DPOITooltipNode"===o[n].className&&(this._context.getViewer().getCursor(),this._context.getViewer().getCursor(),this._context.getViewer().setCursor("pointer"),clearTimeout(this._tokenTimeout)),o[n].className&&"PAD3DPOITooltipNodePinned"===o[n].className&&(this._context.getViewer().getCursor(),this._context.getViewer().getCursor(),this._context.getViewer().setCursor("pointer"),this._onHoverGroupEmpty(),this._context.getViewer().render())},_outHoverTTHoverPreactivateCB:function(e){"pointer"===this._context.getViewer().getCursor()&&this._context.getViewer().setCursor("auto"),this._cleanHoverTooltip(),this._onHoverGroupEmpty()},_onHoveroverPOINodecallback:function(e){this._i_onHoverSinglePOI_active=1;var t=s.getPADTracker({eventCategory:"usage",eventAction:"3d_Hoverover_stats"});if(e&&e.intersection&&e.intersection.path)for(var i=e.intersection.path,o=0;o<i.length;o++)if(i[o].externalPath)for(var n=i[o].externalPath,r=0;r<n.length-1;r++)if(n[r].className&&"PAD3DPOINode"===n[r].className){this._tooltipNodes.removeChildren(),!0;var a,l,d,h,c,p="";if(""!==(a=n[r].name)&&""!=(p=n[r+1].name)&&isNaN(p)&&(l=parseInt(p.split("_")[1])),!isNaN(l)){if(a){var u=this._tooltipNodesPinnedMap.get(a);if(u&&u.has(l)){var g=u.get(l);g&&(g._POIObject._node&&g._POIObject._node.id===n[r+1].id&&g._POIObject._name===n[r+1].name||g._POIObject.instanceId)&&(d=g)}}if(d)h=d;else if(this._layerPOIsIdInstancingNodeMap&&this._layerPOIsIdInstancingNodeMap.get(a)&&(c=this._layerPOIsIdInstancingNodeMap.get(a).get(l))){if(!0===c.instancingPOI&&this._layer_instancing_to_visible_for_Hover.has(a)){var _=this._layer_instancing_to_visible_for_Hover.get(a);if(_&&_.has(l)){var f=_.get(l);f>-1&&(l=f,c=this._layerPOIsIdInstancingNodeMap.get(a).get(l))}}clearTimeout(this._tokenTimeout);var v;v=this._layerTypeOfNode(c,a),h=this._createHoverTooltip(c,v,void 0,a,this,!1,!1,!1,!1,!1,void 0)}}h&&(h.render(),this._bHoverOverPOIHoverTooltip=!0,this._preselectedSinglePOIHoverNode=h),c&&(t.persDim.pd2="Single POI",!0===c.instancingPOI&&(t.persDim.pd2="Instancing  POI")),h&&c&&!d&&this._tooltipNodesMap.set(l+a,{hoverNode:h,poiNode:c})}t.trackPageEvent()},_createNode_and_Tooltip_and_pinTooltip_forFocRef:function(e,t,i,o,n){if(e&&e.length)for(var s=0;s<e.length&&s<300;s++)if(e[s].externalPath&&e[s].externalPath.length){var r=e[s].externalPath[e[s].externalPath.length-1]._layerId,a=e[s].instanceId;if(r||(r=e[s].externalPath[e[s].externalPath.length-1].name),r&&a){var l=!1;if(this._POIIdGroupedPOIs&&this._POIIdGroupedPOIs.has(r)&&this._POIIdGroupedPOIs.get(r).has(a)&&(l=!0),!1===l){var d;if(!(d=this._layerPOIsIdInstancingNodeMap.get(r).get(a))){var h,c=this._layers.get("POIs");c&&c.size>0&&(h=c.get(r));var p=this._layerPOIsIdInstancingNodeMapMaster.get(r).get(a);(d=this._seedNewNode(p,h,this._layerPOIsIdInstancingNodeMap.get(r),this._layerPOIsIdInstancingIndexMap.get(r),100,1))&&d.setVisibility(!0)}if(d){var u=!1;if(d&&d._layerId&&d.instanceId)if(this._tooltipNodesPinnedMap)if(this._tooltipNodesPinnedMap.get(d._layerId))this._tooltipNodesPinnedMap.get(d._layerId).get(d.instanceId)&&(u=!0);u||this._createTooltip_and_pinTooltip_forFocRef(d,t,i,o,n,r)}}}}},_createTooltip_and_pinTooltip_forFocRef:function(e,t,i,o,n,s){if(e){var r,a=!1,l=e.instanceId,d="",h=!0,c="";if(e&&!0===e.instancingPOI)a=!0,d=s;else if(e._node){if(d=e._node._layerId,this._POIIdGroupedPOIs&&this._POIIdGroupedPOIs.has(d)&&this._POIIdGroupedPOIs.get(d).has(l)&&(!0,h=!1),!1!==h){var p=this._layers.get("POIs").get(e._node._layerId).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned");if(p)for(var u=p.children.length,g=0;g<u;g++)p.children[0].name===e.instanceId&&this._tooltipNodesMap.get(e.instanceId+d)&&this._tooltipNodesMap.get(e.instanceId+d).hoverNode&&!0===this._tooltipNodesMap.get(e.instanceId+d).hoverNode._options_temp_focRef_pinnedTT&&(h=!1)}}else e._layerId&&(d=e._layerId);if("POI"!==(r=this._layerTypeOfNode(e,d))&&(h=!1),h){c=r;this._createHoverTooltip(e,r,c,d,t,a,i,o,n)}}},_layerTypeOfNode:function(e,t){var i="";return e&&this._layers&&(this._layers.get("POIs")&&this._layers.get("POIs").get(t)&&(i="POI"),this._layers.get("ZOIs")&&this._layers.get("ZOIs").get(t)&&(i="ZOI")),i},_createHoverTooltip:function(e,t,i,o,s,l,d,h,c,p){var u;if("ZOI"===t&&(l=!1,d=!1,!1,c=!1),e&&t&&o&&s){var g,_,f=1,v="";"ZOI"===t?(f=1,g=p,v=e.id):(f=this._layers.get(t+"s").get(o).getPOIScale(),v=e.instanceId),"prox"===i&&(_=r.getMergingThreshold());var m=!1;if(d&&(m=!0),(u=new a({node:e,threshold:_,instanceId:v,layerId:o,poiScale:f,posData:g,parent:this._tooltipNodes,pinnedImg:this._pinnedTooltipImg,unpinnedImg:this._unpinnedTooltipImg,context:this._context,onHoverCallback:this._onHoverTTHoverPreactivateCB.bind(s),outHoverCallback:this._outHoverTTHoverPreactivateCB.bind(s),onManipulateCallback:this._onTTHoverManipulateCB.bind(s),outManipulateCallback:this._outTTHoverManipulateCB.bind(s),tooltipType:t,temp_focRef_pinnedTT:m}))&&(!0===l&&(this._preselectedSinglePOIHoverNode=u),u.render(),d)){u.pinClicked_Tooltip();var b,y,P,D=e.instanceId;if(this._tooltipNodesMap.set(D+o,{hoverNode:u,poiNode:e}),(w=this._tooltipNodesMap.get(D+o))&&(b=w.hoverNode,y=w.poiNode),b&&y)if((x=this._tooltipNodesPinnedMap.get(o))||(x=new Map,this._tooltipNodesPinnedMap.set(o,x)),x&&x.set(D,b),this._pinnedPOIExclusionMap.set(D,y),this._layers.get("POIs")&&(P=this._layers.get("POIs").get(o).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")),P||((P=new n("PAD3DPOITooltipNodePinned")).className="PAD3DPOITooltipNodePinned",this._layers.get(t+"s")&&this._layers.get(t+"s").get(o).getNode3DBag().addChild(P)),P){if(this._tooltipNodes.children.length&&(!0===c||this._clean_allTooltip_from_isFromFocusRefCmd(this),this._tooltipNodes&&this._tooltipNodes.children.length>0))for(var I=!1,S=-1,C=0;C<this._tooltipNodes.children.length;C++){(e._layerId?e._layerId:o)===this._tooltipNodes.children[C]._layerId&&e.instanceId===this._tooltipNodes.children[C].name&&(S=C,I=!0),I&&S>=0&&P.addChild(this._tooltipNodes.children[C])}var w,x;if(b)if(b.relinkNode(),(w=this._tooltipNodesMap.get(D+o))&&(b=w.hoverNode),b)(x=this._tooltipNodesPinnedMap.get(o))||((x=new Map)&&x.set(D,b),this._tooltipNodesPinnedMap.set(o,x))}}}return u},_clean_allTooltip_from_isFromFocusRefCmd:function(e){for(var t="",i=e,o=0;o<10;o++)if(this._layers&&i){var n=this._layers.get("POIs");n&&n.size>0&&n.forEach(function(e){var o,n;if(t=e.getID(),i._layers.get("POIs")&&i._layers.get("POIs").get(t)&&i._layers.get("POIs").get(t).getNode3DBag()&&(n=i._layers.get("POIs").get(t).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned")),n){var s=n.children,r="",a=!1;s.forEach(function(e){if(e&&e.name){if(a=!1,r=e.name,o=e,this._layerPOIsIdInstancingNodeMapMaster.get(t)&&this._layerPOIsIdInstancingNodeMapMaster.get(t).get(r),this._tooltipNodesMap.get(r+t))if(this._tooltipNodesMap.get(r+t).hoverNode)if(t===this._tooltipNodesMap.get(r+t).hoverNode._layerID)!0===this._tooltipNodesMap.get(r+t).hoverNode._options_temp_focRef_pinnedTT&&(a=!0);if(!0===a){if(this._tooltipNodesMap.get(r+t)&&this._tooltipNodesMap.get(r+t).hoverNode&&(this._tooltipNodesMap.get(r+t).hoverNode.undogeneratepopup(),this._tooltipNodesMap.get(r+t).hoverNode.removeTooltip()),i._layers.get("POIs")&&i._layers.get("POIs").get(t)&&i._layers.get("POIs").get(t).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"))i._layers.get("POIs").get(t).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned").removeChild(o);if(this._pinnedPOIExclusionMap.has(r))this._pinnedPOIExclusionMap.delete(r);if(this._tooltipNodesPinnedMap&&this._tooltipNodesPinnedMap.get(t)&&this._tooltipNodesPinnedMap.get(t).has(r)&&this._tooltipNodesPinnedMap.get(t).get(r)&&!0===this._tooltipNodesPinnedMap.get(t).get(r)._options_temp_focRef_pinnedTT)this._tooltipNodesPinnedMap.get(t).delete(r)}}}.bind(this))}this._context.getViewer().render()}.bind(this))}},_outHoveroverPOINodecallback:function(e){this._i_onHoverSinglePOI_active=0;var t;if(e&&e.preactivated&&e.preactivated.path&&(e.manipulator&&e.manipulator.preactivated&&e.manipulator.preactivated.path&&e.manipulator.preactivated.path.externalPath&&(r=e.manipulator.preactivated.path.externalPath)&&r.length))for(var i=0;i<r.length-1;i++)if("PAD3DPOINode"===r[i].className){var o=r[i+1].name;if(isNaN(o))t=parseInt(o.split("_")[1])}var n=e.preactivated.path;if(n.externalPath)for(var s=0;s<n.externalPath.length;s++)if(n.externalPath[s]&&n.externalPath[s].children){var r=n.externalPath[s].children;for(i=0;i<r.length-1;i++){if(r[i].className&&"PAD3DPOITooltipNode"===r[i].className)if(r[i].children.length&&r[i].children[0])t===r[i].children[0].name&&!0}}this._tokenTimeout=setTimeout(function(){this._onHoverGroupEmpty(),this._context.getViewer().render()}.bind(this),1500)},_onHoveroverPOINodeGroupcallback:function(e){this._i_onHoverNodeGroup_active=1;var t=s.getPADTracker({eventCategory:"usage",eventAction:"3d_Hoverover_stats"});if(e&&e.intersection&&e.intersection.path)for(var i=e.intersection.path,o=0;o<i.length;o++)if(i[o].externalPath)for(var n=i[o].externalPath,r=0;r<n.length-1;r++){if(n[r].className&&"ProximityGroup"===n[r].className){this._i_onHoverNodeGroup_active=2;var a=n[r]._layerId,l=this._layers.get("POIs");if(a){var d=this._proximityGroups.get(a);if(d){t.persDim.pd2="POI Proximity Group";var h=d.get(n[r].name);if(h){var c="POI",p="prox";"ZOI"===(c=this._layerTypeOfNode(h,a))&&(p="ZOI");this._createHoverTooltip(h,c,p,a,this)}}}}if(n[r].className&&"2DClusteringGroup"===n[r].className){a=n[r]._layerId;if((l=this._layers.get("POIs"))&&l.has(a)){var u=n[r].name;t.persDim.pd2="POI Group";var g=this._groups.get(u);if(g&&g.pois.length>999){c="POI";"ZOI"===(c=this._layerTypeOfNode(g,a))&&(p="ZOI");this._createHoverTooltip(g,c,p,a,this)}}}}t.trackPageEvent()},_outHoveroverPOINodeGroupcallback:function(e){this._i_onHoverNodeGroup_active=0;e&&e.preactivated&&e.preactivated.path,this._cleanHoverTooltip(),this._onHoverGroupEmpty()},_cleanHoverTooltip:function(){this._preselectedGroupHoverNode&&(this._preselectedGroupHoverNode.undogeneratepopup(),this._preselectedGroupHoverNode.removeTooltip(),this._preselectedGroupHoverNode=null)}})}),define("DS/ENOPAD3DViewer/utils/PAD3DViewer3DProximityServices",["UWA/Core","DS/Controls/Loader","DS/ENOPAD3DViewer/utils/PADOctree","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i,o,n,s){"use strict";function r(e,t,i){e++;for(var o=function(e){var t=e,i=void 0,o=0,n=0;if(t){var i=t.children,o=0;i&&(o=i.length);var s=t.data;s&&(n=s.length)}return{getChild:i,childlen:o,getData:s,datalen:n}}(t),n=0;n<e;n++)":";if(" level is "+e,o.childlen>0)for(var s=o.getChild,a=0,l=o.childlen;a<l;a++)r(e,s[a],i);else o.datalen&&i.push(o.getData);return i}function a(e){if(e&&e.length)for(var t=-1e5,i=-1e5,o=-1e5,n=1e5,s=1e5,r=1e5,a=0;a<e.length;a++)t<e[a].data.coord3D.x&&(t=e[a].data.coord3D.x),i<e[a].data.coord3D.y&&(i=e[a].data.coord3D.y),o<e[a].data.coord3D.z&&(o=e[a].data.coord3D.z),n>e[a].data.coord3D.x&&(n=e[a].data.coord3D.x),s>e[a].data.coord3D.y&&(s=e[a].data.coord3D.y),r>e[a].data.coord3D.z&&(r=e[a].data.coord3D.z);return{minx:n,maxx:t,miny:s,maxy:i,minz:r,maxz:o}}function l(e){if(!e.collectionofdatas)return 1;for(var t=e.collectionofdatas,i=e.threshold,o=i*i,n=[],s=0;s<t.length;s++){var r=t[s];if(r.length>1){for(var a=[],l=new Map,d=0;d<r.length;d++){var h=[],c=r[d].id;if(!l.has(c)){for(var p=r[d].data.coord3D,u=d+1;u<r.length;u++){var g=r[u].id;if(!l.has(g)){var _=r[u].data.coord3D;if(c===g);else if(Math.abs(p.x-_.x)>i||Math.abs(p.y-_.y)>i||Math.abs(p.z-_.z)>i);else(p.x-_.x)*(p.x-_.x)+(p.y-_.y)*(p.y-_.y)+(p.z-_.z)*(p.z-_.z)<o&&(","+g,0,0===h.length&&(h[0]=r[d],l.set(c,{belongsTo3DGroup:!0})),h.push(r[u]),l.set(g,{belongsTo3DGroup:!0}))}}h.length>1&&a.push(h)}}l=null,0===a.length||n.push(a)}}return n}return{getLayerGroupsBy3DProximity:function(e){var t=void 0;if(e.context&&e.context.getController()){var o=e.context.getController().getRootBag();o&&(t=o._bbShow)}var s=e.layerPOIData,d=e.proximityThreshold,h=new i(t,1),c=new n.Vector3(.02,.02,.02);if(s&&s.length>0)for(var p=0;p<s.length;p++)if(s[p]){var u=s[p].position3D;(C=new n.Box3).setFromCenterAndSize(u,c);var g={data:s[p].data,id:s[p].data.instanceId};h.add(g,C)}var _=[],f=[];if(f=r(0,h._root,f),h=null,s.length>2400)for(var v=0;v<f.length;v++){var m=f[v],b=a(m),y=new n.Vector3(b.minx,b.miny,b.minz),P=new n.Vector3(b.maxx,b.maxy,b.maxz),D=new n.Box3;D.set(y,P);var I=1;m.length<=2400&&(I=1),m.length>2400&&m.length<=19200&&(I=2),m.length>19200&&m.length<=153200&&(I=3),m.length>153200&&(I=4);var S=new i(D,I);if(m&&m.length>0)for(p=0;p<m.length;p++)if(m[p]){var C;u=m[p].data.coord3D;(C=new n.Box3).setFromCenterAndSize(u,c);g={data:m[p].data,id:m[p].data.instanceId};S.add(g,C)}var w=[];w=r(0,S._root,w);for(var x=0;x<w.length;x++)w[x]&&_.push(w[x]);S=null}else _=f;for(var O=[],A=0;A<_.length;A++){var M=[],N=_[A];if(void 0===N);else{var V=[];V.push(N),M=l({collectionofdatas:V,threshold:d});for(var E=0;E<M.length;E++){var T=M[E];T.length;for(var R=0;R<T.length;R++)O.push({pois:T[R]})}}}return O}}}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerBIController",["UWA/Core","UWA/Class","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/PADUtils/PADPromise","DS/Visualization/PathElement","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/SceneGraphUtils","DS/PADUtils/PADUtilsServices","DS/Utilities/Utils","DS/Visualization/IdPath","DS/PADServices/utils/GlobalModelEvents","DS/3DXMTiles/OOCReferenceIterator","DS/3DXMTiles/OOCInstanceIterator","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/ENOXInterWdgCom/LinkManager"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_){"use strict";return t.extend({name:"PAD3DViewerBIController",_userQueueCallbacks:{},_modelControllerTokens:[],_mode:null,_isInstanceModeActive:!1,_is3DLeafColorizeActive:!1,_isTreeColorizeActive:!1,_isFromBottomColorizeActive:!1,_isFromTopColorizeActive:!1,_treeData:null,_biData:null,_biCommandProxy:null,_biRootAddedEvents:-1,_biRootRemovedEvents:-1,_cbCounter:0,_referenceRadio:null,_instanceRadio:null,_activeLayer:"3dLeaf",_3dLeafLayer:null,_treeLayer:null,_fromBottomLayer:null,_fromTopLayer:null,_loadedNodeMap:null,_colorizationInProgress:!1,initBIController:function(){this._viewer=this._context.getViewer(),this._context.subscribe({event:"onRootRemoved"},function(){0===this.getRoots().length&&(this._remove3DLeafLayer(),this._removeTreeLayer(),this._removeInstRefLayer(),this._colorizationInProgress=!1)}.bind(this)),c.subscribe({event:"ENXDISC_AP/Colorize/InstanceReferenceSwitch"},e=>{this._isInstanceModeActive=e.state,!0===this._isTreeColorizeActive&&this._onTreeColorize(this._treeData),!0===this._is3DLeafColorizeActive&&this._on3DLeafColorize(this._biData)})},destroyBIController:function(){this._viewer=null,this._biCommandProxy&&(this._biCommandProxy.destroy(),delete this._biCommandProxy),this._parent()},onSetTagsWithExpandSynthesis:function(e){if(!(!0!==this.isStandaloneFilterAvailable()||e&&e.loadWithFilter))if(this._BIProxy){for(var t=[],i=this.getRoots(),o=0;o<i.length;++o){var n=r.getNodeID(i[o]);n&&this._model.isRootSupported(n)&&t.push(n)}this._BIProxy.setTagsWithExpandSynthesis?t.length&&this._BIProxy.setTagsWithExpandSynthesis(t,{graph:s.getSetting("enopad3dviewer_graphDefinitionForExpand")}):console.warn("onSetTagsWithExpandSynthesis: The BIProxy doesn't implement the setTagsWithExpandSynthesis() method.")}else console.warn("onSetTagsWithExpandSynthesis: The PAD3DViewerController doesn't contains a BIProxy object.")},toggleBetweenStandaloneAndSlaveMode:function(e){e!==this._biMode&&("STANDALONE"!==e&&"SLAVE"!==e||console.warn("DEPRECATED 3DEXPERIENCER2021x_FD06 : PAD3DViewerBIController "+e+" mode is now replaced with DUAL mode for colorization"),"OFF"!==e?this._activateDualMode():(this._biMode="OFF",this._BIProxy.removeEvent("FilterBIColorize"),this._BIProxy.removeEvent("FilterBIUnColorize"),this.unsubscribe(this._biRootAddedEvents),this.unsubscribe(this._biRootRemovedEvents),this._biCommandProxy&&this._biCommandProxy.delete()))},_activateDualMode:function(){this._biMode="DUAL",this._BIProxy.addEvent("FilterBIColorize",this._on3DLeafColorize,this),this._BIProxy.addEvent("FilterBIUnColorize",this._on3DLeafUnColorize,this),this._biRootAddedEvents=this.subscribe({event:"onRootAdditionTransactionComplete"},this.onSetTagsWithExpandSynthesis.bind(this)),this._biRootRemovedEvents=this.subscribe({event:"onEndRootRemoved"},this._rootRemovedProxyEvent.bind(this)),this._context.isInterwidgetComAvailable()&&!this._biCommandProxy&&require(["DS/PADUtils/PADCommandProxy"],function(e){this._biCommandProxy=e.create({events:{onPadFilterBI:function(e,t){e.filterBIColorize?this._onTreeColorize(e.filterBIColorize,t):e.filterBIUnColorize&&this._onTreeUnColorize(e.filterBIUnColorize)}.bind(this)}})}.bind(this)),this._layerController.declareLayerKinds([{AMD:"DS/ENOPAD3DViewer/views/PADLayerColorizeView"}])},_rootRemovedProxyEvent:function(e){if(!0===this.isStandaloneFilterAvailable()&&!_.isWidgetSynchronizing()&&e.ids&&!0!==e.fromRefresh&&!0!==e.fromWidgetLink){for(var t=e.ids.length-1;t>=0;--t)this._model.isRootSupported(e.ids[t])||e.ids.splice(t,1);e.ids.length>0&&(this._BIProxy.resetNGFilterUI({widgetId:l.getWidgetId(),appId:l.getSharedId(),rootIds:e.ids}),this._BIProxy.removeRoots(e.ids))}},_defineInstanceReferenceRadio:function(){null===this._referenceRadio&&null===this._instanceRadio&&(this._referenceRadio=this._layerController.createLayer({label:i.colorizeLayer.referenceMode,kind:"colorize",type:"colorize",visibility:"true",viewer:this._viewer,position:0}),this._instanceRadio=this._layerController.createLayer({label:i.colorizeLayer.instanceMode,kind:"colorize",type:"colorize",visibility:"true",viewer:this._viewer,position:1}),!0===this._isInstanceModeActive?(this._referenceRadio.setVisibility(!1),this._instanceRadio.setVisibility(!0)):(this._referenceRadio.setVisibility(!0),this._instanceRadio.setVisibility(!1)))},_define3DLeafLayer:function(){null===this._3dLeafLayer&&("tree"===this._activeLayer&&!1===this._waitingForTree&&(this._wait4TreeTimeoutId=setTimeout(function(){!1===this._waitingForTree&&(this._context.displayNotification({eventID:"warning",msg:i.colorizeLayer.fallbackLeaf}),this._3dLeafLayer.setVisibility(!0),this._3dLeafLayer.show(),this._wait4TreeTimeoutId=-1)}.bind(this),5e3)),this._defineInstanceReferenceRadio(),this._3dLeafLayer=this._layerController.createLayer({label:i.colorizeLayer.leafLayer,kind:"colorize",type:"colorize",visibility:"true",viewer:this._viewer,position:2}),this._3dLeafLayer.getIdPathOverrideSet()||this._3dLeafLayer.buildIdPathOverrideSet({rootNode:this.getRootBag(),rootId:this.getRootBagId()}),"3dLeaf"===this._activeLayer?this._3dLeafLayer.setVisibility(!0):this._3dLeafLayer.setVisibility(!1),this._3dLeafLayer.subscribe({event:"show"},function(){this._activeLayer="3dLeaf"}.bind(this)),this._fromBottomLayer=this._layerController.createLayer({label:i.colorizeLayer.fromBottomLayer,kind:"colorize",type:"colorize",visibility:"true",viewer:this._viewer,position:3}),this._fromBottomLayer.getIdPathOverrideSet()&&this._fromBottomLayer.buildIdPathOverrideSet({rootNode:this.getRootBag(),rootId:this.getRootBagId()}),"fromBottom"===this._activeLayer?this._fromBottomLayer.setVisibility(!0):this._fromBottomLayer.setVisibility(!1),this._fromBottomLayer.subscribe({event:"show"},function(){this._activeLayer="fromBottom"}.bind(this)),this._fromTopLayer=this._layerController.createLayer({label:i.colorizeLayer.fromTopLayer,kind:"colorize",type:"colorize",visibility:"true",viewer:this._viewer,position:4}),this._fromTopLayer.getIdPathOverrideSet()&&this._fromTopLayer.buildIdPathOverrideSet({rootNode:this.getRootBag(),rootId:this.getRootBagId()}),"fromTop"===this._activeLayer?this._fromTopLayer.setVisibility(!0):this._fromTopLayer.setVisibility(!1),this._fromTopLayer.subscribe({event:"show"},function(){this._activeLayer="fromTop"}.bind(this)))},_clear3DLeafLayer:function(){if(null!==this._3dLeafLayer){var e=this._3dLeafLayer.getIdPathOverrideSet();e&&e.deleteOverrides(e.getOverrides()),(e=this._fromBottomLayer.getIdPathOverrideSet())&&e.deleteOverrides(e.getOverrides()),(e=this._fromTopLayer.getIdPathOverrideSet())&&e.deleteOverrides(e.getOverrides())}},_remove3DLeafLayer:function(){this._layerController&&(this._3dLeafLayer&&this._layerController.deleteLayer(this._3dLeafLayer),this._fromBottomLayer&&this._layerController.deleteLayer(this._fromBottomLayer),this._fromTopLayer&&this._layerController.deleteLayer(this._fromTopLayer),this._referenceRadio&&this._layerController.deleteLayer(this._referenceRadio),this._instanceRadio&&this._layerController.deleteLayer(this._instanceRadio)),this._referenceRadio=null,this._instanceRadio=null,this._3dLeafLayer=null,this._fromBottomLayer=null,this._fromTopLayer=null,this._is3DLeafColorizeActive=!1,this._isFromBottomColorizeActive=!1,this._isFromTopColorizeActive=!1},_on3DLeafColorize:function(e){if(!0===this.isColorizeAvailable()){this._isAuthored()&&this.publish({event:"onColorizeInAuthoring"});var t=o.getPromises().slice();o.createPromise(function(i,o){Promise.all(t).then(function(o){if(0!==this.getRoots().length&&!0!==this._colorizationInProgress){if(this._colorizationInProgress=!0,this._biData=e,null===this._3dLeafLayer?this._define3DLeafLayer():this._clear3DLeafLayer(),this._loadedNodeMap=new Map,this._is3DLeafColorizeActive=!0,t=null,this._viewer){this._model.getRootBag();if(Array.isArray(e.tagColors)){for(var n={map:{},predicate:void 0,predicateKind:void 0},a=0;a<e.tagColors.length;++a){var l=e.tagColors[a];if(void 0===n.predicate){var d=l.predicate.split("/"),h=d[d.length-1];n.predicate=h.toLowerCase(),n.predicateKind=l.type}var c=!1;l.object.join?(n.map[l.object.join("/")]=l.color,n.isHierrarchyPredicate=!0,c=!0):(n.map[l.object]=l.color,c||(n.isHierrarchyPredicate=!1))}if(this._colorMap=this.sortColorMapKeys(n),!1===s.getSetting("enopad3dviewer_lightNodeModel")){console.warn("Deprecated usage, old loader spotted, please migrate to visuProgressiveTileModel");var p=Object.keys(this._model._nodeIndex),u=[];for(a=0;a<p.length;++a){var g=this._model._nodeIndex[p[a]];if(r.is3DLeaf(g)){for(var _=r.getReferences(g),f=0;f<_.length;++f)u.push(r.getNodeID(_[f]));1e3===u.length&&(this._getAttributesFromIds(u,i),u=[])}}this._getAttributesFromIds(u,i)}else{var v=!1;this._userQueueCallbacks={handleReferences:function(e,t){v=!0;this._buildIdsToFetch(e,t,function(e){v=!1,t.doneCB(e,[])},i)}.bind(this),getBatchSize:function(){return 1e3},isReady:function(){return!1===v},done:function(e,t,i){v=!1,i.doneCB(e,t)},onFailure:function(e){console.log(e)}},this.addUserQueue(this._userQueueCallbacks)}}}this.publish({event:"onBIColorize"}),this.publish({event:"on3DLeafColorize"})}}.bind(this))}.bind(this),"3DLeafColorize",!1)}},_on3DLeafUnColorize:function(){if(0!==this.getRoots().length&&!0===this.isColorizeAvailable()){var e=o.getPromises().slice();o.createPromise(function(t,i){Promise.all(e).then(function(i){e=null,this._clear3DLeafLayer(),this._layerController.deleteLayer(this._referenceRadio),this._layerController.deleteLayer(this._instanceRadio),this._layerController.deleteLayer(this._3dLeafLayer),this._layerController.deleteLayer(this._fromBottomLayer),this._layerController.deleteLayer(this._fromTopLayer),this._referenceRadio=null,this._instanceRadio=null,this._3dLeafLayer=null,this._fromBottomLayer=null,this._fromTopLayer=null,this._model.removeUserQueue(this._userQueueCallbacks),this._is3DLeafColorizeActive=!1,this._isFromTopColorizeActive=!1,this._isFromTopColorizeActive=!1,this._loadedNodeMap=null,this.publish({event:"onBIUnColorize"}),this.publish({event:"on3DLeafUnColorize"}),this._colorizationInProgress=!1,t()}.bind(this))}.bind(this),"3DLeafUnColorize")}},_buildIdsToFetch:function(e,t,i,o){for(var n=[],s=new Map,r=function(e){if(e)for(var t=0;t<e.length;++t){if(!1===this._isInstanceModeActive){var i=e[t].getReferenceId();!i||s.has(i)||this._loadedNodeMap.has(i)||(n.push(i),s.set(i,null),this._loadedNodeMap.set(i,!0))}else{var o=e[t].getParentInstanceIterators();for(let e=0;e<o.length;++e)for(let t=0;t<o[e].instanceIterators.length;++t){var a=o[e].instanceIterators[t].getInstanceId()||null;!a||s.has(a)||this._loadedNodeMap.has(a)||(n.push(a),s.set(a,null),this._loadedNodeMap.set(a,!0))}}r(e[t].getParents())}}.bind(this),a=0;a<e.length;++a){var l=this.createReferenceIterator(e[a]),d=l.getParents();if(!1===this._isInstanceModeActive)this._loadedNodeMap.has(e[a])||(n.push(e[a]),s.set(e[a],null),this._loadedNodeMap.set(e[a],!0));else{var h=l.getParentInstanceIterators();for(let e=0;e<h.length;++e)for(let t=0;t<h[e].instanceIterators.length;++t){var c=h[e].instanceIterators[t].getInstanceId()||null;!c||s.has(c)||this._loadedNodeMap.has(c)||(n.push(c),s.set(c,null),this._loadedNodeMap.set(c,!0))}}this._model.isRepReference(e[a])&&(n.push(e[a]),s.set(e[a],null),this._loadedNodeMap.set(e[a],!0)),r(d)}i(e),this._getAttributesFromIds(n,o,i)},_getAttributesFromIds:function(e,t,i){0!==e.length&&this.getAttributes({ids:e,attributes:[this._colorMap.predicate],callbacks:{onComplete:function(e){if(!0===s.getSetting("enopad3dviewer_lightNodeModel")){var o=this._applyFromBottomColorize(e);this._applyFromTopColorize(o),this._apply3dLeafColorize(o),this._colorizationInProgress=!1,i()}else{console.warn("DEPRECATED, the colorize in non-tile node model will soon be removed. Please upgrade.");for(var n=[],l=Object.keys(e),d=this._context.getController().getRoots(),h=this._3dLeafLayer.getIdPathOverrideSet().getOverrides().length,c=0;c<d.length;c++){var p=r.getNodeID(d[c]);if(p){var u=this._model._nodeIndex[p];if(u){var g=a.buildPathesLeadingToNode(u,this.getRootBag())[0];(b=this._3dLeafLayer.getIdPathOverrideSet().getUniqueOverrideFromPathElement(g))||(b=this._3dLeafLayer.getIdPathOverrideSet().createNodeIdOverride(g))}n.push(p)}}for(var _=0;_<l.length;++_)if(-1===n.indexOf(l[_])){for(var f=this._model._nodeIndex[l[_]],v=a.buildPathesLeadingToNode(f,this.getRootBag()),m=0;m<v.length;++m){var b,y;(b=this._3dLeafLayer.getIdPathOverrideSet().getUniqueOverrideFromPathElement(v[m]))||(b=this._3dLeafLayer.getIdPathOverrideSet().createNodeIdOverride(v[m]));var P=this._colorMap.map[e[l[_]][this._colorMap.predicate]];void 0===P?(P="#FFFFFF",y=.3,b.setOpacity(y,!1),b.setColor(P,!1)):(b.setColor(P,!0),b.setOpacity(y,!0))}f.setBIColor(this._colorMap.map[e[l[_]][this._colorMap.predicate]])}0===h&&h<this._3dLeafLayer.getIdPathOverrideSet().getOverrides().length&&"3dLeaf"===this._activeLayer&&this._3dLeafLayer.setVisibility(!0)}this._viewer.render({updateInfinitePlane:!0}),t()}.bind(this),onFailure:function(e){console.log(e)}}})},_applyFromBottomColorize:function(e){!1===s.getSetting("enopad3dviewer_lightNodeModel")&&console.warn("DEPRECATED");for(var t={idMap:new Map,leavesId:[]},i=Object.keys(e),o=this._context.getController().getRoots(),n=this._fromBottomLayer.getIdPathOverrideSet(),a=n.getOverrides().length,l=0;l<o.length;++l){(c=n.getUniqueOverrideFromNodeId(r.getNodeID(o[l])))||(c=n.createNodeIdOverride(r.getNodeID(o[l]))),c.setOpacity(.3,!0),c.setColor("#FFFFFF",!0),!1===this._isInstanceModeActive&&t.idMap.set(r.getNodeID(o[l]),null)}for(var d=0;d<i.length;++d){if(e[i[d]]){var h=this.getColorValueForPredicate(e[i[d]][this._colorMap.predicate],this._colorMap.predicateKind);if(!1===this._isInstanceModeActive){var c;(c=n.getUniqueOverrideFromNodeId(i[d]))||(c=n.createNodeIdOverride(i[d]));var p=!0;null==h?(p=!1,c.setOpacity(.3,p),c.setColor("#FFFFFF",p)):(c.setColor(h,p),c.setOpacity(1,p))}null==h?t.idMap.set(i[d],null):t.idMap.set(i[d],h)}if(this._model.isRepReference(i[d])&&t.leavesId.indexOf(-1===i[d])&&(t.leavesId.push(i[d]),!0===this._isInstanceModeActive)){var u=this.createReferenceIterator(i[d]).getParents(),g=u[0].getReferenceId(),_=u[0].getParentInstanceIterators();for(let i=0;i<_.length;++i)for(let o=0;o<_[i].instanceIterators.length;++o){g=_[i].instanceIterators[o].getInstanceId()||null;var f=n.getUniqueOverrideFromNodeId(g);f||(f=n.createNodeIdOverride(g));p=!0;null==(h=this.getColorValueForPredicate(e[g][this._colorMap.predicate],this._colorMap.predicateKind))?(p=!1,f.setOpacity(.3,p),f.setColor("#FFFFFF",p),t.idMap.set(g,null)):(f.setColor(h,p),f.setOpacity(1,p),t.idMap.set(g,h))}}}return 0===a&&a<n.getOverrides().length&&"fromBottom"===this._activeLayer&&this._fromBottomLayer.setVisibility(!0),t},_applyFromTopColorize:function(e){!1===s.getSetting("enopad3dviewer_lightNodeModel")&&console.warn("DEPRECATED");var t=this._fromTopLayer.getIdPathOverrideSet(),i=t.getOverrides().length;e.idMap.forEach(function(e,i){var o=t.getUniqueOverrideFromNodeId(i);o||(o=t.createNodeIdOverride(i)),null!=(e=e)?(o.setColor(e,!1),o.setOpacity(1,!1)):this._model.isRepReference(i)&&(o.setOpacity(.3,!1),o.setColor("#FFFFFF",!1))}.bind(this)),0===i&&i<t.getOverrides().length&&"fromTop"===this._activeLayer&&this._fromTopLayer.setVisibility(!0)},_apply3dLeafColorize:function(e){!1===s.getSetting("enopad3dviewer_lightNodeModel")&&console.warn("DEPRECATED");for(var t=this._context.getController().getRoots(),i=this._3dLeafLayer.getIdPathOverrideSet(),o=i.getOverrides().length,n=0;n<t.length;++n){var a=i.getUniqueOverrideFromNodeId(r.getNodeID(t[n]));a||(a=i.createNodeIdOverride(r.getNodeID(t[n])))}for(var l=0;l<e.leavesId.length;++l){var d=e.leavesId[l],h=this.createReferenceIterator(d).getParents(),c=h[0].getReferenceId();if(!0===this._isInstanceModeActive){var p=h[0].getParentInstanceIterators();for(let t=0;t<p.length;++t)for(let o=0;o<p[t].instanceIterators.length;++o){c=p[t].instanceIterators[o].getInstanceId()||null,(g=i.getUniqueOverrideFromNodeId(c))||(g=i.createNodeIdOverride(c));var u=!0;null===(_=e.idMap.get(c))?(u=!1,g.setOpacity(.3,u),g.setColor("#FFFFFF",u)):(g.setColor(_,u),g.setOpacity(1,u))}}else{var g;(g=i.getUniqueOverrideFromNodeId(d))||(g=i.createNodeIdOverride(d));var _;u=!0;null===(_=e.idMap.get(c))?(u=!1,g.setOpacity(.3,u),g.setColor("#FFFFFF",u)):(g.setColor(_,u),g.setOpacity(1,u))}}0===o&&o<i.getOverrides().length&&"3dLeaf"===this._activeLayer&&this._3dLeafLayer.setVisibility(!0)},colorizeNewNodes:function(e){if(!0===this.isColorizeAvailable())if(!0===s.getSetting("enopad3dviewer_lightNodeModel")){var t=this._3dLeafLayer.getIdPathOverrideSet().getOverrides().length;for(let t=0;t<e.leavesToColorize.length;++t){var i=e.leavesToColorize[t],o=this.createReferenceIterator(i).getParents(),n=o[0].getReferenceId();if(!0===this._isInstanceModeActive){var r=o[0].getParentInstanceIterators();n=r.length>0?r[0].instanceIterators[0].getInstanceId():null}if(!this._loadedNodeMap.has(i)&&e.hashMap[i]){var a=this._3dLeafLayer.getIdPathOverrideSet().getUniqueOverrideFromNodeId(i);a||(a=this._3dLeafLayer.getIdPathOverrideSet().createNodeIdOverride(i));var l=!0;void 0===(_=this.getColorValueForPredicate(e.hashMap[n][this._colorMap.predicate],this._colorMap.predicateKind))?(_="#FFFFFF",.3,l=!1,a.setOpacity(.3,l),a.setColor(_,l)):(a.setColor(_,l),a.setOpacity(1,l))}}0===t&&t<this._3dLeafLayer.getIdPathOverrideSet().getOverrides().length&&"3dLeaf"===this._activeLayer&&this._3dLeafLayer.setVisibility(!0);var d=this._fromBottomLayer.getIdPathOverrideSet().getOverrides().length,h=this._fromTopLayer.getIdPathOverrideSet().getOverrides().length;let s=e.nodesToColorize;!0===this._isInstanceModeActive&&(s=e.instancesToColorize);for(let t=0;t<s.length;++t){var c=s[t];if(!this._loadedNodeMap.has(c)&&e.hashMap[c]){var p=this._fromBottomLayer.getIdPathOverrideSet(),u=this._fromTopLayer.getIdPathOverrideSet(),g=p.getUniqueOverrideFromNodeId(c);g||(g=p.createNodeIdOverride(c));var _,f=u.getUniqueOverrideFromNodeId(c);f||(f=u.createNodeIdOverride(c)),null==(_=this.getColorValueForPredicate(e.hashMap[c][this._colorMap.predicate],this._colorMap.predicateKind))?(g.setOpacity(.3,!1),g.setColor("#FFFFFF",!1),this._model.isRepReference(c)&&(f.setOpacity(.3,!1),f.setColor("#FFFFFF",!1))):(g.setColor(_,!0),g.setOpacity(1,!0),f.setColor(_,!1),f.setOpacity(1,!1)),this._loadedNodeMap.set(c,!0)}}0===d&&d<this._fromBottomLayer.getIdPathOverrideSet().getOverrides().length&&"fromBottom"===this._activeLayer&&this._fromBottomLayer.setVisibility(!0),0===h&&h<this._fromTopLayer.getIdPathOverrideSet().getOverrides().length&&"fromTop"===this._activeLayer&&this._fromTopLayer.setVisibility(!0)}else console.warn("colorizeNewNodes: This method must be called in light node model only.")},_defineTreeLayer:function(e){if(null===this._treeLayer){this._defineInstanceReferenceRadio(),this._treeLayer=this._layerController.createLayer({label:i.colorizeLayer.treeLayer,kind:"colorize",type:"colorize",visibility:"false",viewer:this._viewer,position:5});let t=this._layerController._layersToDeleteOnUnlink.get(e.originWidgetId),o=this._treeLayer.getID();t&&t.length>0?t.push(o):this._layerController._layersToDeleteOnUnlink.set(e.originWidgetId,[o]),this._treeLayer.getIdPathOverrideSet()&&this._treeLayer.buildIdPathOverrideSet({rootNode:this.getRootBag(),rootId:this.getRootBagId()}),"tree"===this._activeLayer?this._treeLayer.setVisibility(!0):this._treeLayer.setVisibility(!1),this._treeLayer.subscribe({event:"show"},function(){this._activeLayer="tree"}.bind(this))}},_clearTreeLayer:function(){if(null!==this._treeLayer){var e=this._treeLayer.getIdPathOverrideSet();e&&e.deleteOverrides(e.getOverrides())}},_removeTreeLayer:function(){this._layerController&&this._treeLayer&&this._layerController.deleteLayer(this._treeLayer),this._treeLayer=null,this._isTreeColorizeActive=!1},_onTreeColorize:function(e,t){if(!0===this.isColorizeAvailable()){this._waitingForTree=!0;var i=o.getPromises().slice();o.createPromise(function(o,n){Promise.all(i).then(function(n){if(null===this._treeLayer?this._defineTreeLayer(t):this._clearTreeLayer(),this._isTreeColorizeActive=!0,i=null,this._viewer){this._model.getRootBag();if(e.nodes&&(this._treeData=e,e.path&&e.nodes)){for(var s=this._treeLayer.getIdPathOverrideSet().getOverrides().length,r=0;r<e.path.length;r++){for(var a=e.path[r],l=[this._context.getController().getRootBagId()],d=0;d<a.length;d++)l.push(e.nodes[a[d]].pid);var c=e.nodes[a[a.length-1]];!0===this._isInstanceModeActive&&(c=e.nodes[a[a.length-2]]);var p=new h(l),u=this._treeLayer.getIdPathOverrideSet().getUniqueOverrideFromNodeId(p);if(u||(u=this._treeLayer.getIdPathOverrideSet().createIdPathOverride(p)),c)if(c.ghostMode)u.setColor("#FFFFFF",!1),u.setOpacity(.3,!1);else if(-1!==c.color.indexOf("rgba")){const e=g.rgbaToHex(c.color);u.setColor(e.hex,!1),u.setOpacity(e.opacity,!1)}else u.setColor(c.color,!0),u.setOpacity(1,!0);else u.setColor("#FFFFFF",!1),u.setOpacity(.3,!1)}0===s&&s<this._treeLayer.getIdPathOverrideSet().getOverrides().length&&"tree"===this._activeLayer&&this._treeLayer.setVisibility(!0)}this._viewer.render({updateInfinitePlane:!0}),o()}this.publish({event:"onBIColorize"}),this.publish({event:"onTreeColorize"})}.bind(this))}.bind(this),"TreeColorize",!1)}},_onTreeUnColorize:function(){if(this._waitingForTree=!1,clearTimeout(this._wait4TreeTimeoutId),this._wait4TreeTimeoutId=-1,!0===this.isColorizeAvailable()){var e=o.getPromises().slice();o.createPromise(function(t,i){Promise.all(e).then(function(i){e=null,this._clearTreeLayer(),this._layerController.deleteLayer(this._treeLayer),this._treeLayer=null,this._isTreeColorizeActive=!1,this.publish({event:"onBIUnColorize"}),this.publish({event:"onTreeUnColorize"}),t()}.bind(this))}.bind(this),"TreeUnColorize")}},_removeInstRefLayer:function(){this._layerController&&this._referenceRadio&&this._layerController.deleteLayer(this._referenceRadio),this._layerController&&this._instanceRadio&&this._layerController.deleteLayer(this._instanceRadio),this._referenceRadio=null,this._instanceRadio=null},sortColorMapKeys:function(t){var i=e.clone(t,!0);if(t.isHierrarchyPredicate){i.map={};var o=Object.keys(t.map);o.sort(function(e,t){return e.split("/").length>t.split("/").length?-1:e.split("/").length<t.split("/").length?1:0});for(var n=0;n<o.length;++n)i.map[o[n]]=t.map[o[n]];t=i}return t},getColorValueForPredicate:function(e,t){var i,o=Object.keys(this._colorMap.map);if("date"===t){var n=e.substring(0,e.indexOf("T")).split("-"),s=[];s.push([n[0],n[1],n[2]].join("/")),s.push([n[0],n[1]].join("/")),s.push(n[0]);for(var r=0;r<s.length;r++)if(void 0!==this._colorMap.map[s[r]]){i=this._colorMap.map[s[r]];break}if(i)return i}if(!0===this._colorMap.isHierrarchyPredicate&&void 0!==e){for(var a=0;a<o.length;++a)if(-1!==e.indexOf(o[a])){i=this._colorMap.map[o[a]];break}}else i=this._colorMap.map[e];return i},getAppliedColor:function(e,t){t||(t="3dLeaf");var i=null;if(s.getSetting("enopad3dviewer_lightNodeModel")){var o=[this.getRootBagId()].concat(this.buildArrayFromPath(e)),n=new h(o),a="3dLeaf"===t?this._3dLeafLayer:this._treeLayer,l=null;a?(l=a.getIdPathOverrideSet().getUniqueOverrideFromIdPath(n))&&(i=l.getColor()):console.warn("The "+t+" layer doesn't exists")}else i=r.getBIColor(e.getLastElement(!0));return i},getColorizeInstanceReferenceSwitchState:function(){return this._isInstanceModeActive},isColorizeActivated:function(){return this._is3DLeafColorizeActive||this._isTreeColorizeActive},isColorizeAvailable:function(){return"OFF"!==this._BIMode},is3DLeafColorizeActivated:function(){return this._is3DLeafColorizeActive},isStandalone:function(){return"OFF"!==this._biMode&&"DUAL"===this._biMode},isSlave:function(){return"OFF"!==this._biMode&&"DUAL"===this._biMode},getBIColorMap:function(){return e.clone(this._colorMap,!0)},getBIProxy:function(){return this._BIProxy}})}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction",["UWA/Class","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADChangeActionHandler","DS/PADUtils/PADWSAccess","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSettingsMgt","DS/PADServices/utils/GlobalModelEvents","i18n!DS/PADUtils/assets/nls/PADUtils.json"],function(e,t,o,n,s,r,a,l,d,h){function c(e){var t=[];for(i=0;i<e.results.length;i++){var o=e.results[i];o.Path&&t.push({path:o.Path,hidden:!1})}return t}return e.extend({init:function(e){this._parent(e),this.__ctrl=e.ctrl,this._commandProxy=a.create()},loadChange:function(e){var t=e.app,i=this;t._controller.getRoots(),t._controller.getHiddenRootIds();t._controller._startAsync(),r.setText(h.retrieveChangeAction);var n=e.changes.map(function(e){return e.objectId});o.getInfos(n,function(o){t._controller._stopAsync();var n=-1;let s=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");var r=function(){if(++n<o.length){var a=o[n];i._processCA(a,t,r)}else t._controller.checkIfEmpty(),e.callback&&e.callback(),!0===l.getSetting("changeControlDlgOpen")?(i._commandProxy.changeControlDlgOpen({isOpen:!1,widget:"3D"}),"function"==typeof s.setFromDrop&&s.setFromDrop(o,function(){console.log("Change set on Singleton from 3D")})):l.setSetting("changeControlDlgOpen",!0)};r()})},_processCA:function(e,i,r){var a=this;o.determineExecution(e,{addAndFind:function(e){var d=o.extractIds(e.changeaction.context),p=o.extractRealizedAndProposed(e),u=i._controller.getRoots().map(function(e){return t.getNodeID(e)});u=u.concat(i._controller.getHiddenRootIds());var g=d.filter(function(e){return-1===u.indexOf(e)});if(g.length!==d.length&&(s.displayNotification({msg:h.root_already_loaded}),0===g.length&&r&&r()),g.length){var _,f,v=g.length,m=function(e){0===--v&&(i._controller.unsubscribe(_),i._controller.unsubscribe(f),r&&r())};_=i._controller.subscribe({event:"onLoadingFailure"},m),f=i._controller.subscribe({event:"onRootAdded"},m);for(var b=0;b<g.length;b++){var y=UWA.clone(l.getWebAPI_Options("navigate3D"),!0);let e={expand_iter:"-1",select_bo:y.select_bo,select_rel:y.select_rel,compute_select_bo:"thumbnail"===a.__ctrl.getDefaultStreamToLoad()?y.computeCGRsNThumbnails:y.computeCGRs,intent:"explore_3D",authored:!1,boundingbox:!1,fcs_url_mode:l.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0,rootPhID:g[b],subPaths:[p]};new Promise((t,i)=>{n.searchV2({FBIProxy:a.__ctrl._BIProxy._biFilter,data:e,onComplete:t,onFailure:i})}).then(function(e){var t=c(e="string"==typeof e?JSON.parse(e):e);t.length?i.addRoots({objects:t,dispatch:!1}):(s.displayNotification({msg:h.find_in_context_no_result,eventID:"info"}),i.addRoots({objects:[{path:[e.params.rootId]}],dispatch:!1}))}).catch(function(e){console.error(e)})}}},add:function(e){var o=i._controller.getRoots().map(function(e){return t.getNodeID(e)});o=o.concat(i._controller.getHiddenRootIds());var n=e.filter(function(e){return-1===o.indexOf(e)});if(0===n.length)s.displayNotification({msg:h.root_already_loaded}),r&&r();else{var a,l,d=n.length,c=function(e){0===--d&&(i._controller.unsubscribe(a),i._controller.unsubscribe(l),r&&r())};a=i._controller.subscribe({event:"onLoadingFailure"},c),l=i._controller.subscribe({event:"onRootAdded"},c);var p=function(e){for(var t=[],i=0;i<e.length;i++)t.push({id:e[i],hidden:!1});return t}(n);i.addRoots({objects:p})}},wasEmpty:function(){0==i._controller.getRoots().length?i._dropZoneContainer.show("drop"):i._dropZoneContainer.hide(),r&&r()}})}})}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerCapturePOI",["DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/GeometryHelper","DS/Manipulators/LineTranslationManipulator","DS/Mesh/MeshUtils","DS/ApplicationFrame/CommandsManager","DS/ENOPAD3DViewer/views/PAD3DPOINode","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/ENOXInterWdgCom/LinkManager","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","text!DS/ENOPAD3DViewer/assets/json/DefaultColorStream.json"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_){"use strict";var f=1,v=2,m=0,b=JSON.parse(_),y=!1;function P(){return"object"==typeof P.instance?P.instance:(P.instance=this,this)}return P.prototype.isInitialized=function(){return y},P.prototype.initialize=function(){if(this._toAddCount=0,this._addedCount=0,this._context=e.get(),this._geomHelper=new n,this._csoTokens=[],this._customIcon=null,this._isCapturePoint=!1,this._lastPickInfo=null,require(["DS/PADUtils/PADCommandProxy"],function(e){this._poiCaptureCommandProxy=e.create()}.bind(this)),this._abortCB=[],this._parentPOIsNode=new i,this._pois=new Map,this._executing=!1,this._poiQueue=[],this._switchedToCGRNodes=[],this._manips=new Map,this._count=0,this._colorStreamJSON=[],b&&b.colorStream)for(var t=0;t<b.colorStream.length;t++)this._colorStreamJSON.push(b.colorStream[t]);this._coloredPOIsMap=new Map,y=!0},P.prototype.capturePOI=function(e){var o=e;if(e.fromCapturePoint&&(this._isCapturePoint=!0),this._executing||(this._context.getDecorationBag().add(this._parentPOIsNode),this._parentPOIsNode.removeChildren(),this._abortCB.push(this._context.subscribe({event:"onRootRemoved"},function(e){this.abort()}.bind(this))),this._executing=!0),o.new){if(e.fromCapturePoint&&o.new.customIcon&&(this._customIcon=o.new.customIcon),(u=o.new).id&&this._pois&&!this._pois.has(u.id)){this._csoTokens&&this._csoTokens.length<=0&&this.captureActivate();var n="";u.color&&u.color.indexOf("#")>=0?n=o.new.color:(n=this._getNewColor(),this._coloredPOIsMap.set(u.id,n)),this._poiQueue.splice(0,0,u),this._toAddCount++;var s=new i(u.id);this._pois.set(u.id,{node:s,color:n,drawn:!1,validated:!1,editable:!0}),this._manips.size>0&&this._unsubscribeAllManips(),e.fromCapturePoint&&o.new.customMessage?this._context.displayNotification({eventID:"info",msg:o.new.customMessage}):this._context.displayNotification({eventID:"info",msg:g.capturePOI.newInfo})}}else if(o.edit){if(o.edit.id&&this._pois.has(o.edit.id)){var r=null;if((u=this._pois.get(o.edit.id))&&!0!==u.validated&&u.poiNode){if(r=u.poiNode.edit(o.edit),o.edit.position){var a=(new t.Matrix4).makeTranslation(o.edit.position.x,o.edit.position.y,o.edit.position.z);u.node.setMatrix(a)}r.id=o.edit.id;var l=this._manips.get(o.edit.id);l&&l.manip&&l.manip.linkToNode(u.node)}if(this._context.getViewer().render(),r){if(r.color&&this._coloredPOIsMap.has(o.edit.id)){var d=this._coloredPOIsMap.get(o.edit.id);this._colorStreamJSON.splice(0,0,d),this._coloredPOIsMap.delete(o.edit.id)}this.parametersChanged(r)}}}else if(o.validate){if(o.validate.id&&this._pois.has(o.validate.id))if(u=this._pois.get(o.validate.id)){u.validated=!0,this._unsubscribeManips(o.validate.id),this._unsubscribePreactivateManips(o.validate.id),u.poiNode&&u.poiNode.setEditable(!1);var h=u.pathElement,c=this._context.streamPath(h);u.node.removeChild(u.cross.parents[0]),u.node.excludeFromHighlight(!0,!0),u.poiNode.getNode().excludeFromHighlight(!0,!0),u.poiNode.getNode().children[0].excludeFromHighlight(!0,!0);r={id:u.node.name,pathElement:c,absolutePosition:u.absolutePosition,relativePosition:u.relativePosition,validated:!0};this.parametersChanged(r),this._context.getViewer().render()}}else if(o.cancel){if(o.cancel.id){var p=o.cancel.id;if(this._pois&&this._pois.has(p)&&this._poiQueue&&this._poiQueue.length>0){for(var u=this._pois.get(p),_=-1,f=0;f<this._poiQueue.length;++f)this._poiQueue[f].id===p&&(_=f);_>-1&&this._poiQueue.splice(_,1),this._toAddCount--,this.removePOINode(p),this._context.displayNotification({eventID:"info",msg:g.capturePOI.cancelled})}}}else o.delete?o.delete.id&&(this.removePOINode(o.delete.id),this._context.getViewer().render()):o.end&&this.end()},P.prototype.execute=function(e){this.capturePOI(e)},P.prototype.abort=function(){this._isCapturePoint?u.publish("DS/ExternalWdgtCom/CapturePoint",{abort:{}}):this._poiCaptureCommandProxy.capturePOI({abort:{}}),this.end()},P.prototype.captureActivate=function(){this.allowClickPOI()},P.prototype.end=function(){this.restoreSwitched(),this._parentPOIsNode.removeChildren(),this._unsubscribeAllManips();for(var e=0;e<this._abortCB.length;e++)this._context.unsubscribe(this._abortCB[e]);this._abortCB=[],this._poiQueue=[],this._manips.clear(),this._pois.clear(),this._context.getDecorationBag().removeChild(this._parentPOIsNode),this._isCapturePoint=!1,this._executing=!1,m="STOPPED",this._context.getViewer().render()},P.prototype.allowClickPOI=function(){this._csoTokens.push(h.onPostAdd(this.createPOI.bind(this)))},P.prototype.parametersChanged=function(e){this._isCapturePoint?u.publish("DS/ExternalWdgtCom/CapturePoint",{parametersChanged:e}):this._poiCaptureCommandProxy.capturePOI({parametersChanged:e})},P.prototype.createPOI=function(e){if(this._poiQueue&&this._poiQueue.length>0&&e&&e[0]&&e[0].event&&e[0].event.currentPosition){m=v;var t=this._context.getViewer().pick(this._context.getViewer().getMousePosition(e[0].event.currentPosition),"mesh",!0);if(t.path.length&&d.isAModelPath(t.path[0]))if(this.createPOINode(t),this._context.getViewer().render(),0===this._poiQueue.length){m=f;for(var i=0;i<this._csoTokens.length;i++)h.unsubscribe(this._csoTokens[i]);this._csoTokens=[],(this._toAddCount.length>1||this._addedCount.length>1)&&this._context.displayNotification({eventID:"success",msg:g.capturePOI.allAdded}),this._subscribeAllManips(),this._addedCount=0,this._toAddCount=0}else this._addedCount++,(this._toAddCount.length>1||this._addedCount.length>1)&&this._context.displayNotification({eventID:"info",msg:g.capturePOI.added+" "+this._addedCount+"/"+this._toAddCount})}},P.prototype.createPOINode=function(e){var n=this._poiQueue.pop(),r=null;if(n&&(r=this._pois.get(n.id)),r){var a=(new t.Matrix4).makeTranslation(e.position.x,e.position.y,e.position.z);this._count++;var d=r.node;r.pathElement=e.path[0],r.pathElement&&(r.pathElement=r.pathElement.getParentPath());var h=new l({parent:d,icon:this._customIcon?this._customIcon:"default",fillColor:r.color?r.color:"#FEE000",position:new t.Vector3(0,0,0),instanceId:this._count,poiId:n.id,name:n.id,label:"",layerId:"0",pickability:!0,editable:!0,context:this._context});h.setVisibility(!0),this._pois.get(n.id).poiNode=h;var c=new t.MeshBasicMaterial({transparent:!1,opacity:1,enableClipPlanes:!1,color:"#3D3D3D",force:!0,side:t.DoubleSide}),p=new i;this._pois.get(n.id).cross=p;var u=this._geomHelper.createCircle({radius:15,segments:32,fill:!0}),g=new t.MeshBasicMaterial({side:t.DoubleSide,color:9689341,opacity:.7,transparent:!0});g.force=!0,p.excludeFromHighlight(!0,!0),p.excludeFromCSO(!0);var _=o.createMeshNode(u,g);_.excludeFromCSO(!0),_.excludeFromHighlight(!0,!0),_.setSSAO(!1),_.setShadow(!1,!1),_.setMatrix((new t.Matrix4).makeTranslation(0,0,-1));var f=o.createLineNode({points:[new t.Vector3(-8,0,-1),new t.Vector3(8,0,-1)],material:c});f.excludeFromHighlight(!0,!0),f.excludeFromCSO(!0);var v=o.createLineNode({points:[new t.Vector3(0,-8,-1),new t.Vector3(0,8,-1)],material:c});v.excludeFromHighlight(!0,!0),v.excludeFromCSO(!0),p.addChild(f),p.addChild(v),p.addChild(_),p.setNoHighlightNoZ(!0);var m=this.retrievePositionMatrix(e.normal,new t.Vector3(0,0,0));p.setMatrix(m);var b=o.createFixedSizeNode();b.addChild(p),d.addChild(b),d.setMatrix(a),this._parentPOIsNode.addChild(d);var y=new s({axis:(new t.Vector3).copy(e.position)});y.setExclusive(!0),y.linkToNode(d);var P={tokens:[],preactivate:[]};P.manip=y,P.preactivate.push(y.subscribe("Preactivate",function(e){this._context.getViewer().setCursor("pointer")}.bind(this,d))),P.preactivate.push(y.subscribe("EndPreactivate",function(e){this._context.getViewer().setCursor("auto")}.bind(this,d))),this._manips.set(n.id,P);var D=e.path[0];if(D){var I={},S=D.getWorldMatrix(),C=D.getLastElement(!0).getBoundingSphere().center,w=(new t.Matrix4).makeTranslation(C.x,C.y,C.z),x=(new t.Matrix4).multiply(S,w),O=(new t.Matrix4).getInverse(x);if(C)(I=new t.Vector3(e.position.x,e.position.y,e.position.z)).applyProjection(O)}r.absolutePosition={x:e.position.x,y:e.position.y,z:e.position.z},r.relativePosition=I;var A=this._context.streamPath(D),M={id:n.id,absolutePosition:{x:r.absolutePosition.x,y:r.absolutePosition.y,z:r.absolutePosition.z},relativePosition:I,pathElement:A};this.switchToCGR(D.getParentPath()),this.parametersChanged(M)}},P.prototype._unsubscribeAllManips=function(){this._pois.forEach(function(e,t){this._unsubscribeManips(t)}.bind(this))},P.prototype._subscribeAllManips=function(){this._pois.forEach(function(e,t){if(!0!==e.validated){var i=this._manips.get(t);i&&i.manip&&i.tokens&&(i.tokens=this._subscribeManip(i.manip,t))}}.bind(this))},P.prototype._unsubscribeManips=function(e){var t=this._manips.get(e);if(t&&t.tokens&&t.manip)for(var i=t.tokens,o=0;o<i.length;o++)t.manip.unsubscribe(i[o])},P.prototype._unsubscribePreactivateManips=function(e){var t=this._manips.get(e);if(t&&t.preactivate&&t.manip)for(var i=t.preactivate,o=0;o<i.length;o++)t.manip.unsubscribe(i[o])},P.prototype._subscribeManip=function(e,i){var o=this._pois.get(i),n=[];if(o&&!0!==o.validated){var s=o.node;if(s){var a=this._pois.get(i).cross;this._pois.get(i).poiNode;n.push(e.subscribe("BeginManipulate",function(t){m===f?(t.setPickable(r.PICKTHROUGH),this._context.getViewer().setCursor("pointer"),h.empty(),c.empty()):e.publish("EndManipulate")}.bind(this,s))),n.push(e.subscribe("Manipulate",function(i,o){if(m===f){var n=this._context.getViewer().pick(this._context.getViewer().getMousePosition(o.event.from[0].currentPosition),"mesh",!0);if((n.path.length<=0||n.path[0]&&!d.isAModelPath(n.path[0]))&&this._lastPickInfo&&(n=this._lastPickInfo),n&&n.path.length&&d.isAModelPath(n.path[0])){this._lastPickInfo=n;var s=(new t.Matrix4).makeTranslation(n.position.x,n.position.y,n.position.z),r=this.retrievePositionMatrix(n.normal,new t.Vector3(0,0,0));a.setMatrix(r),i.setMatrix(s),this._context.getViewer().render()}}else e.publish("EndManipulate")}.bind(this,s))),n.push(e.subscribe("EndManipulate",function(e,i){if(i&&i.event){var n=this._context.getViewer().pick(this._context.getViewer().getMousePosition(i.event.from[0].currentPosition),"mesh",!0);if((n.path.length<=0||n.path[0]&&!d.isAModelPath(n.path[0]))&&(n=this._lastPickInfo),n.path.length&&d.isAModelPath(n.path[0])){var s=n.path[0];s&&(s=s.getParentPath());var l=(new t.Matrix4).makeTranslation(n.position.x,n.position.y,n.position.z),u=this.retrievePositionMatrix(n.normal,new t.Vector3(0,0,0));a.setMatrix(u),e.setMatrix(l),h.empty(),c.empty(),p.empty(),h.add({pathElement:s}),c.add({pathElement:s}),this._context.getViewer().render();var g={},_=new t.Vector3(n.position.x,n.position.y,n.position.z);if(s){g={};var f=s.getWorldMatrix(),v=s.getLastElement(!0).getBoundingSphere().center,m=(new t.Matrix4).makeTranslation(v.x,v.y,v.z),b=(new t.Matrix4).multiply(f,m),y=(new t.Matrix4).getInverse(b);if(v)(g=new t.Vector3(n.position.x,n.position.y,n.position.z)).applyProjection(y)}var P=this._pois.get(o.node.name);P&&(P.pathElement=s,P.absolutePosition={x:_.x,y:_.y,z:_.z},P.relativePosition=g);var D=this._context.streamPath(s),I={id:o.node.name,absolutePosition:{x:_.x,y:_.y,z:_.z},relativePosition:g,pathElement:D};this.switchToCGR(s),this.parametersChanged(I)}}e.setPickable(r.PICKABLE),this._context.getViewer().setCursor("auto")}.bind(this,s)))}}return n},P.prototype.removePOINode=function(e){if(e&&this._pois.has(e)){if(this._coloredPOIsMap.has(e)){var t=this._coloredPOIsMap.get(e);this._colorStreamJSON.splice(0,0,t),this._coloredPOIsMap.delete(e)}var i=this._pois.get(e);i.node&&(this._parentPOIsNode.removeChild(i.node),this._unsubscribeManips(e),this._unsubscribePreactivateManips(e),this._manips.delete(e),this._pois.delete(e))}},P.prototype._getNewColor=function(){var e="#ADADAD";if(this._coloredPOIsMap&&this._coloredPOIsMap.size<this._colorStreamJSON.length-1){var t=this._colorStreamJSON.splice(0,1);t&&t[0]&&(e=t[0])}return e},P.prototype.switchToCGR=function(e){if(this._context&&e){var t=e.externalPath[e.externalPath.length-1];if(t&&"thumbnail"===this._context.getController().getLoadedStream(t)){var i={data:[{stream:"cgr",node:t}]};this._context.getController().switchNodeVisuStreamOnDemand(i),this._switchedToCGRNodes.push(t)}}},P.prototype.restoreSwitched=function(){if(this._context){for(var e=0;e<this._switchedToCGRNodes.length;e++){var t=this._switchedToCGRNodes[e];if(t&&"cgr"===this._context.getController().getLoadedStream(t)){var i={data:[{stream:"thumbnail",node:t}]};this._context.getController().switchNodeVisuStreamOnDemand(i)}}this._switchedToCGRNodes=[]}},P.prototype.retrievePositionMatrix=function(e,i){var o=new t.Vector3(1,0,0).cross(e).normalize();this.colinear(new t.Vector3(1,0,0),o)&&(o=new t.Vector3(0,1,0).cross(e).normalize());var n=(new t.Vector3).copy(e),s=(new t.Vector3).copy(o).cross(n).normalize();n.applyAxisAngle(s,Math.PI);var r=new t.Matrix4,a=(new t.Vector3).copy(i),l=r.elements;return l[0]=o.x,l[1]=o.y,l[2]=o.z,l[4]=s.x,l[5]=s.y,l[6]=s.z,l[8]=n.x,l[9]=n.y,l[10]=n.z,r.setPosition(a),r},P.prototype.colinear=function(e,i){var o=(new t.Vector3).copy(e),n=(new t.Vector3).copy(i),s=o.cross(n).length();return 0===Math.round(100*s)},new P}),define("DS/ENOPAD3DViewer/views/PAD3DPushpinCanvasNode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture","DS/ENOPAD3DViewer/views/PADPOIManipulator","DS/ENOPAD3DViewer/utils/PAD3DPOIDrawingFactory","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s){"use strict";function r(e){this.devicePixelRatio=window.devicePixelRatio||1,this._scale=void 0!==e.scale?e.scale:1,this._icon=void 0!==e.icon?e.icon:"default",this._poisNum=e.poisNum,this._colors=e.colors,this._matrices=e.matrices,this._highlight=e.highlight?e.highlight:null,this._name=e.name,this._context=e.context,this._onHoverCallback=e.onHoverCallback,this._outHoverCallback=e.outHoverCallback,this._hoverManipulator=new o,this._width=20*this.devicePixelRatio*this._scale,this._height=32*this.devicePixelRatio*this._scale,this._hoverManipulator.subscribe("BeginPreactivate",this._onHoverCallback),this._hoverManipulator.subscribe("EndPreactivate",this._outHoverCallback),this._draw=n.draw({type:"instancing",icon:this._icon,parameters:{scale:this._scale,fillColor:this._fillColor,borderColor:this._borderColor,width:this._width,height:this._height}})}return r.prototype.render=function(){var o=new i({width:this._width,height:this._height,drawCB:this._draw,alphaTest:.02}),n=e.createCanvas2DInstancingNode({name:this._name,canvasNodeTexture:o,hotspot:new t.Vector2(this._width/2,0),nbInstances:this._poisNum,matrices:this._matrices,colors:this._colors});return"3D"===s.getPOIType()&&n.rectangle.setNoZ(!1),this._hoverManipulator.linkToNode(n.rectangle),this._context&&this._context.getViewer().render(),n},r}),define("DS/ENOPAD3DViewer/views/PAD3DRootListMgt",["UWA/Class","UWA/Promise","DS/PADServices/views/ENXLeftSidePanel","DS/PADServices/utils/GlobalModelEvents","DS/PADServices/utils/ParserUtils","DS/PADServices/ws/WSAccess","DS/PADServices/views/private/TilesViewUtils","DS/PADUtils/PADWSAccess","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADSession"],function(e,t,i,o,n,s,r,a,l,d,h,c,p){"use strict";var u=[];function g(){for(var e=[],t=0;t<u.length;t++)u[t].isFulfilled&&u[t].isFulfilled()||e.push(u[t]);return u=e}function _(e,i){var o=function(e,t){if(e.isResolved)return e;var i=!0,o=!1,n=!1,s=e.then(function(e){return n=!0,i=!1,e},function(e){throw o=!0,i=!1,e});return s.isFulfilled=function(){return n},s.isPending=function(){return i},s.isRejected=function(){return o},s.name=t,s}(new t(e),i);return g().push(o),o}return e.extend({createRootListSlidder:function(e){var d=this;return this._tokenRootListMgt=[],this._tokenCSORootListMgt=[],this.elements.padrootlist_div=UWA.createElement("div",{class:"pad3drootlist"}),this.leftsidepanel=new i({noTitle:e&&e.noTitle}),o.subscribe({event:"ENXModel/Root/select"},this._onTileSelect.bind(this)),o.subscribe({event:"ENXModel/Root/addTile"},this.openDroppedObjects.bind(this)),o.subscribe({event:"ENXModel/Root/removeTile"},this._onRemoveTile.bind(this)),this._tokenCSORootListMgt.push(l.onPostAdd(function(){var e=g().slice(),i=l.get();return _(function(n,s){t.all(e).then(function(e){i.length>0&&i.forEach(function(e){if(null!==e.pathElement){var t=e.pathElement.getLastElement(!0);d._controller.getRoots().forEach(function(e){if(h.getNodeID(e)===h.getNodeID(t)){o.publish({event:"ENXModel/Root/selectTile",data:{data:{nodeModel:{getID:function(){return h.getNodeID(t)}}}}})}})}}),n()})},"SelectTile"),!1})),this._tokenCSORootListMgt.push(l.onPostRemove(function(e){for(var t=0;t<e.length;t++)if(null!==e[t].pathElement){var i=e[t].pathElement.getLastElement(!0);d._controller.getRoots().forEach(function(e){if(h.getNodeID(e)===h.getNodeID(i)){o.publish({event:"ENXModel/Root/unselectTile",data:{data:{nodeModel:{getID:function(){return h.getNodeID(i)}}}}})}})}})),this._tokenRootListMgt.push(d.subscribe({event:"onRootAdded"},function(i){i.serviceId||(i.serviceId="3DSpace");var l=g().slice();switch(i.serviceId){case"3DSpace":_(function(e,s){t.all(l).then(function(t){a.fetch({enopad_webapis:c.getSetting("enopad_webapis"),data:{authored:p.determineAuthoredFlag(),intent:"fetch_3D",select_predicate:r.getFetchAttribute(),select_file:["icon","thumbnail_2d"]},pids:[i.id],onComplete:function(t,s){for(var r="string"==typeof s?JSON.parse(s):s,a={grid:{}},l=0;l<r.results.length;l++){var c=r.results[l];c.hasOwnProperty("attributes")&&((a=n.parseAttributes(c.attributes)).serviceId=t,a.type=a.grid["ds6w:type"])}var p=null;if(h.isFiltered&&(p=h.isFiltered(d.getController().getNode({id:i.id}),d)),a.isFiltered=!!p,a){a.resolve=e;var u={added_node:a};o.publish({event:"ENXModel/Root/manage",data:u})}e()}.bind(this,i.serviceId),onFailure:function(){s()}})}).catch(function(){console.log("PAD3DRootlist::Failed to fetch root data")})},"AddRootTile").catch(function(){console.log("PAD3DRootlist::Failed to fetch root data")});break;case"r2vsurvey":_(function(n,r){t.all(l).then(function(t){s.fetchFeatureStates({ids:[i.id],serviceId:i.serviceId}).then(function(t,i){var s=null;try{s="string"==typeof i?JSON.parse(i):i}catch(t){return void e.onFailure("PARSING_FAILED")}if(s.result)for(let e=0;e<s.result.length;++e){var r={added_node:{resourceid:s.result[e].resourceid,soiid:s.result[e].featureOfInterestId,surveyid:s.result[e].surveyId,label:s.result[e]["ds6w:label"],grid:s.result[e].grid,icons:[s.result[e].icon],thumbnail:s.result[e].thumbnail,serviceId:t,type:s.result[e].type}};o.publish({event:"ENXModel/Root/manage",data:r})}n()}.bind(this,i.serviceId))}).catch(function(){console.log("PAD3DRootlist::Failed to fetch root data")})},"AddR2VRootTile").catch(function(){console.log("PAD3DRootlist::Failed to fetch root data")});break;default:console.warn("PAD3DRootLstMgt::Unknown service:"+i.serviceId)}})),this._tokenRootListMgt.push(d.subscribe({event:"onRootRemoved"},function(e){return o.publish({event:"ENXModel/Root/remove",data:{pids:[e.id],noDispatch:!0}}),!1})),this._tokenRootListMgt.push(d.subscribe({event:"onFilterRemoved"},function(e){return o.publish({event:"ENXModel/Root/sync",data:{tileId:e.id,isFiltered:!1}}),!1})),this.leftsidepanel.getContent().inject(this.elements.padrootlist_div),e&&e.leftContainer&&d.elements.padrootlist_div.inject(e.leftContainer),d.elements.padrootlist_div},_onTileSelect:function(e){if(!Array.isArray(e.tile_ids))throw new Error("Invalid input param, no params.tile_ids defined");var t=this,i=[];l.empty(),d.empty(),e.tile_ids.forEach(function(e){if(t._controller.getNode({id:e})){var o=t._controller.buildPathFromArray([e]);i.push({pathElement:o}),l.add(i),l.get().forEach(function(e){d.add(e)})}else console.log("Cannot find ["+e+"] in the TreeDocument")})},_onRemoveTile:function(e){if(!UWA.is(e.tile_id))throw new Error("Invalid input parameter");var t=this.getController().getNode({id:e.tile_id});return UWA.is(t)&&this.getController().removeRoots({pids:[e.tile_id]}),!1},disposeRootListMgt:function(){if(this._tokenCSORootListMgt)for(var e=0;e<this._tokenCSORootListMgt.length;e++)l.unsubscribe(this._tokenCSORootListMgt[e]);if(this._tokenRootListMgt)for(var t=0;t<this._tokenRootListMgt.length;t++)this.unsubscribe(this._tokenRootListMgt[t])}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerLayerInterface",["UWA/Class","DS/ENOPAD3DViewer/utils/PAD3DViewerLayerServices"],function(e,t){"use strict";return e.extend({name:"_PAD3DViewerLayerInterface",streamLayers:function(){return t.streamLayers(this.get3DLayerController())},setLayersProperties:function(e){t.setLayersProperties(e,this.get3DLayerController())}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerExternalKPIController",["UWA/Core","UWA/Class","DS/PADUtils/PADPromise","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/PADServices/utils/PADTrackerManager","DS/ENOPAD3DViewer/mixins/_PAD3DViewerZOIController","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/views/PAD3DPushpinCanvasNode","DS/ENOPAD3DViewer/views/PAD3DPOINode","DS/ENOPAD3DViewer/views/PAD3DPOINodeNew","DS/ENOPAD3DViewer/views/PAD3DBoxNode","DS/ENOPAD3DViewer/views/PAD3DSphereNode","DS/ENOPAD3DViewer/views/PAD3DCylinderNode","DS/Visualization/IdPath","DS/ENOPAD3DViewer/views/PAD3DPOIHoverTooltip","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/PADUtils/PADCommandProxy","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_,f,v,m,b,y,P,D,I,S){"use strict";return t.extend(h,{name:"PAD3DViewerExternalKPIController",_externalKPICommandProxy:null,_viewer:null,_decorationBag:null,_layers:null,_POIsDescriptionMap:null,_layerPOIsIdInstancingIndexMap:null,_whiteListPOI:null,_layerPOIColorsMap:null,_layerPOIMatricesMap:null,_pushPinNodeColorMap:null,_selectedPushpinCanvasNodeColorMap:null,_POIsKPIUserQueueCallbacks:{},_selectedPOI:[],_pois:[],_layer_instancing_to_visible_for_Hover:null,_layer_visible_to_instancing_for_Select:null,_layerVisibleInstancingPOIs:null,_loadPOIs_pre:[],_csoTokens:[],_poiVolumeSelectors:[],_originalOITState:null,_poiIdInfoMap:null,_poiInstanceInfoMap:null,_poiDataPerLayer:null,_poiTooltipMasterNode:null,_poiIdLayerId:null,_bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight:!1,initExternalKPIController:function(){return new Promise(function(e){this._context.isInterwidgetComAvailable()&&!this._externalKPICommandProxy?(this._viewer=this._context.getViewer(),this._decorationBag=this.getDecorationBag(),this._originalOITState=this._viewer.getOIT(),this._layers=new Map,this._POIsDescriptionMap={},this._poiDataPerLayer=new Map,this._poiDataLayerDraw=new Map,this._layerPOIsIdInstancingIndexMap=new Map,this._layerPOIsIdInstancingNodeMap=new Map,this._layerPOIsIdInstancingNodeMapMaster=new Map,this._layerVisibleInstancingPOIs=new Map,this._layer_instancing_to_visible_for_Hover=new Map,this._layer_visible_to_instancing_for_Select=new Map,this._whiteListPOI=new Map,this._poiIdInfoMap=new Map,this._poiInstanceInfoMap=new Map,this._poiIdLayerId=new Map,this._layerPOIColorsMap=new Map,this._layerPOIMatricesMap=new Map,this._pushPinNodeColorMap=new Map,this._selectedPushpinCanvasNodeColorMap=new Map,this.poiToLoad=[],this._poisToLoadMap=new Map,this.max_path=5e3,this._POILayers=new Map,this._ZOILayers=new Map,this._GPLayers=new Map,this._selectionVolumesMap=new Map,this._isLayerColorEditable=!1,this._pendingEnrich=[],this._externalKPICommandProxy=I.create({events:{onEnrich3D:function(e){var t=!1,i=!1,o=!1,n=!1,s="";e&&e.pointOfInterest&&e.pointOfInterest.clusteringOptions&&(e.pointOfInterest.clusteringOptions.clustering2D&&(t=e.pointOfInterest.clusteringOptions.clustering2D.active),e.pointOfInterest.clusteringOptions.clustering3D&&(i=e.pointOfInterest.clusteringOptions.clustering3D.active),e.pointOfInterest.clusteringOptions.proximityMerging&&(o=e.pointOfInterest.clusteringOptions.proximityMerging.active)),e&&e.cumulativeMode&&(n=e.cumulativeMode),e&&e.pointOfInterest&&(s=e.pointOfInterest.poiType?e.pointOfInterest.poiType:"2D");var r=0,a=0,l=0;e&&e.pointOfInterest&&e.pointOfInterest.layers&&(r=e.pointOfInterest.layers.length),e&&e.graphicProperties&&e.graphicProperties.layers&&(l=e.graphicProperties.layers.length),e&&e.zoneOfInterest&&e.zoneOfInterest.layers&&(a=e.zoneOfInterest.layers.length);var h=d.getPADTracker({eventCategory:"usage",eventAction:"3d_enrich3D_stats"});h.persDim.pd2=i?"3D Clustering":t?"2D Clustering":"No Clustering",h.persDim.pd3=o?"Activated":"Deactivated",h.persDim.pd4=n?"Activated":"Deactivated",h.persDim.pd5=s,h.persVal.pv2=r+l+a,h.persVal.pv3=r,h.persVal.pv4=a,h.persVal.pv5=l,h.trackPageEvent(),this._pendingEnrich.push(e),this._pendingEnrich.length<=1&&this.enrich3D(e)}.bind(this),onEnrichWithKPI:function(e){this.enrichWithKPI(e)}.bind(this),onAddVolume:this.addVolume.bind(this),onSetVolumeParameters:this.setVolumeParameters.bind(this),onRemoveVolume:this.removeVolume.bind(this),onGetVolumeParameters:this.getVolumeParameters.bind(this)}}),this._pinnedTooltipImg=new Image,this._pinnedTooltipImgUrl=P.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_PinYes.png"),D.authenticatedRequest(this._pinnedTooltipImgUrl,{proxy:"none",type:"blob",timeout:6e4,onComplete:function(e){var t=new FileReader;t.onload=function(){this._pinnedTooltipImg.src=t.result}.bind(this),t.readAsDataURL(e)}.bind(this),onFailure:function(){},onTimeout:function(){}}),this._unpinnedTooltipImg=new Image,this._unpinnedTooltipImgUrl=P.getWebappsAssetUrl("ENOPAD3DViewer","icons/32/I_PinNo.png"),D.authenticatedRequest(this._unpinnedTooltipImgUrl,{proxy:"none",type:"blob",timeout:6e4,onComplete:function(e){var t=new FileReader;t.onload=function(){this._unpinnedTooltipImg.src=t.result}.bind(this),t.readAsDataURL(e)}.bind(this),onFailure:function(){},onTimeout:function(){}}),this._csoTokens.push(a.onPostAdd(this._addCSO.bind(this))),this._csoTokens.push(a.onEmpty(this._emptyCSO.bind(this))),this._csoTokens.push(a.onPostRemove(this._removeCSO.bind(this))),this.subscribe({event:"onEndRootRemoved"},function(){this.resetPOIs(),this.resetGraphicProperties(),this._resetZoneOfInterest(),this._shareSessionContent()}.bind(this)),this.subscribe({event:"onComplete"},function(e){"addRoot"===e.intend&&(this.resetPOIs(),this.resetGraphicProperties(),this._shareSessionContent())}.bind(this)),e()):e()}.bind(this))},destroyExternalKPIController:function(){this._viewer&&delete this._viewer,this._externalKPICommandProxy&&(this._externalKPICommandProxy.destroy(),delete this._externalKPICommandProxy),S.destroy(),this._POILayers.clear(),delete this._POILayers,this._GPLayers.clear(),delete this._GPLayers,this._ZOILayers.clear(),delete this._ZOILayers,this._layers.clear(),delete this._layers,this._layerController.destroy(),delete this._layerController,this._selectionVolumesMap&&(delete this._selectionVolumesMap,this._selectionVolumesMap=null),this._selectionVolumesNode&&(this._decorationBag.remove(this._selectionVolumesNode),delete this._selectionVolumesNode,this._selectionVolumesNode=null),this._parent()},enrich3D:function(e){return new Promise(function(t){var i=[],o=!1;if(e){if(e.deleteLayers)for(let t=0;t<e.deleteLayers.length;t++)this._layerController.deleteLayerId(e.deleteLayers[t]);if(e.graphicProperties&&(e.deleteLayers||e.cumulativeMode&&!0===e.cumulativeMode||this.resetGraphicProperties(),e.deleteLayers||0!==Object.keys(e.graphicProperties).length?i.push(this.applyGraphicProperties(e)):this.resetGraphicProperties()),e.pointOfInterest){if(null!==(n=document.createElement("canvas")))null!==(s=n.getContext("2d"))&&(s.font="10px pad-3ds-light");if(e.cumulativeMode&&("3D"===S.getPOIType()?e.pointOfInterest.poiType="3D":"2D"===S.getPOIType()&&(e.pointOfInterest.poiType="2D")),e.deleteLayers||e.cumulativeMode&&!0===e.cumulativeMode||(this.resetPOIs(),S.resetParameters(),this._poiDataPerLayer.clear()),"3D"===e.pointOfInterest.poiType?(S.setPOIType("3D"),e.pointOfInterest.clusteringOptions?(e.pointOfInterest.clusteringOptions.clustering3D&&(e.pointOfInterest.clusteringOptions.clustering3D.active=!1),e.pointOfInterest.clusteringOptions.clustering2D&&(e.pointOfInterest.clusteringOptions.clustering2D.active=!1)):e.pointOfInterest.enableClustering&&!0===e.pointOfInterest.enableClustering&&(e.pointOfInterest.enableClustering=!1)):S.setPOIType("2D"),0!==Object.keys(e.pointOfInterest).length||e.deleteLayers){var n,s;if(null!==(n=document.createElement("canvas")))if(null!==(s=n.getContext("2d")))try{s.font="10px pad-3ds-light"}catch(e){console.error(e)}i.push(this.drawPOIs(e)),o=!0}else this.resetPOIs(),this._poiDataPerLayer.clear()}e.zoneOfInterest&&(0!==Object.keys(e.zoneOfInterest).length||e.deleteLayers?i.push(this._drawZoneOfInterest(e,this._viewer)):this._resetZoneOfInterest()),e.graphicProperties||e.pointOfInterest||e.zoneOfInterest||e.deleteLayers||(this.resetPOIs(),this._poiDataPerLayer.clear(),this.resetGraphicProperties(),this._resetZoneOfInterest()),Promise.all(i).then(function(){o&&this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()}),t()}.bind(this))}else t()}.bind(this)).then(function(){this._pendingEnrich&&this._pendingEnrich.length>0&&(this._pendingEnrich.splice(0,1),this._pendingEnrich.length>0&&this.enrich3D(this._pendingEnrich[0]))}.bind(this))},enrichWithKPI:function(e){console.log("method enrichWithKPI is drecated. Please use enrich3D")},addVolume:function(e){if(console.warn("DEPRECATED 21XFD06, please use display3DVolume protocol."),!e||!e.selectionVolume)throw new Error("PAD3DViewerExternalKPIController.addVolume: Wrong input parameters");this._selectionVolumesNode||(this._selectionVolumesNode=new r("SelectionVolumes"),this._decorationBag.addChild(this._selectionVolumesNode)),this._drawVolume(e.selectionVolume)},_shareSessionContent:function(){this.getSessionContent()},applyGraphicProperties:function(e){return new Promise(function(t){for(var i=[],o=this.getRoots(),n=0;n<o.length;n++)i.push(c.getNodeID(o[n]));var s=[];e.graphicProperties.kinds=e.graphicProperties.kinds?e.graphicProperties.kinds:[{AMD:"DS/ENOPAD3DViewer/views/PADLayerGraphicPropertiesView",kind:"Graphic properties layer"}],e.graphicProperties.kinds&&s.push(this._layerController.declareLayerKinds(e.graphicProperties.kinds)),Promise.all(s).then(function(){if(void 0===e.graphicProperties.layers&&(!0===e.cumulativeMode&&e.graphicProperties.id&&this._layerController.hasLayer(e.graphicProperties.id)&&(e.graphicProperties.append=!0),this.applyGPSingleLayer(e.graphicProperties)),e.graphicProperties.layers&&Array.isArray(e.graphicProperties.layers))for(var i=0;i<e.graphicProperties.layers.length;i++){if(!0===e.cumulativeMode&&e.graphicProperties.layers[i]&&e.graphicProperties.layers[i].id&&this._layerController.hasLayer(e.graphicProperties.layers[i].id)&&(e.graphicProperties.layers[i].append=!0),e.originWidgetId&&e.deleteOnUnlink){let t=this._layerController._layersToDeleteOnUnlink.get(e.originWidgetId),o=e.graphicProperties.layers[i].id;t&&t.length>0?t.push(o):this._layerController._layersToDeleteOnUnlink.set(e.originWidgetId,[o])}this.applyGPSingleLayer(e.graphicProperties.layers[i])}t(),this._context.getViewer().render()}.bind(this))}.bind(this))},applyGPSingleLayer:function(e){if(e.colorMap.length){this._originalOITState=this._viewer.getOIT(),this._viewer.setOIT(!0);var t,i=new Map;e.append&&e.id&&(i=(t=this._GPLayers.get(e.id)).getStyles(),e.visibility=t.isLayerVisible()),e.styles&&(this._generateStyleMap(e.styles,i,e.append),t&&t.setStyles(i)),e.append&&t||(t=this._layerController.createLayer({layerId:e.id,ghostLayer:e.ghostLayer,label:void 0!==e.label?e.label:"KPI colors",visibility:void 0===e.visibility||e.visibility,kind:e.kind?e.kind:"graphic properties",type:"graphic properties",styles:i||void 0,legend:e.styles?e.styles:void 0}));t.subscribe({event:"hide"},function(e){this._externalKPICommandProxy.layerHide({id:e.id,widgetId:I.appId()})}.bind(this)),t.subscribe({event:"show"},function(e){this._externalKPICommandProxy.layerShow({id:e.id,widgetId:I.appId()})}.bind(this));!1===e.visibility&&(t.hide(),this.publish({event:"hide",data:{id:t.getID(),layer:t}})),this._GPLayers.set(t.getID(),t),this._layers.set("KPIs",this._GPLayers),null===t.getIdPathOverrideSet()&&t.buildIdPathOverrideSet({rootNode:this.getRootBag(),rootId:"rootBag"});for(var o=0;o<e.colorMap.length;o++){var n=null,s=i.get(e.colorMap[o].style);if(s){if(e.colorMap[o].resourceid)(n=t.getIdPathOverrideSet().getUniqueOverrideFromNodeId(e.colorMap[o].resourceid))||(n=t.getIdPathOverrideSet().createNodeIdOverride(e.colorMap[o].resourceid));else if(e.colorMap[o].path){for(var r=e.colorMap[o].path,a=["rootBag"],l=0;l<r.length;l++)a.push(r[l]);var d=new m(a);(n=t.getIdPathOverrideSet().getUniqueOverrideFromIdPath(d))||(n=t.getIdPathOverrideSet().createIdPathOverride(d))}if(n){var h=void 0===s.forceInherit||s.forceInherit;void 0!==s.opacity&&n.setOpacity(s.opacity,h),void 0!==s.color&&n.setColor(s.color,h),s.pickability&&n.setPickability(s.pickability,h)}}}!1!==e.visibility&&t.show()}},resetGraphicProperties:function(){var e=this._layers.get("KPIs");e&&(e.forEach(function(e){this._layerController.deleteLayer(e)}.bind(this)),this._layers.delete("KPIs")),this._GPLayers.clear(),void 0!==this._originalOITState&&this._viewer.setOIT(this._originalOITState),this._context.getViewer().render()},isAPOIPath:function(e){return c.isAPOIPath(e)},getProximityFromPath:function(e){var t=null,i=null;if(e)for(var o=0;o<e.externalPath.length;o++)if("PAD3DPOINode"===e.externalPath[o].className){i=e.externalPath[o+1]&&e.externalPath[o+1].name&&e.externalPath[o+1].name.indexOf("PAD3DPOINode")>-1?e.externalPath[o].name:e.externalPath[o+1].name;break}if(i){var n;if(t=S.isClusteringEnabled()&&this._layers.get("POIs").get(i).isClustered()||this.isPoIUICustomized?parseInt(e.externalPath[e.externalPath.length-1].name.replace("PAD3DPOINode_","")):e.instanceId,isNaN(t)&&e.instanceId&&(t=e.instanceId),this._POIIdGroupedPOIs&&this._POIIdGroupedPOIs.has(i)&&(n=this._POIIdGroupedPOIs.get(i)),n&&n.has(t)){var s=n.get(t).groupName;return s||!1}return!1}},getProximityPath:function(e){if(!e)return!1;var t=e.split("_");if(!(t.length>2))return!1;var i=e.replace(t[0]+"_"+t[1]+"_",""),o=this._proximityGroups.get(i);if(o){var n=o.get(e);if(n&&n.node){var r=s.buildPathesLeadingToNode(n.node.getNode(),this._model.getDecorationBag());return!(!r||!r[0])&&r[0]}}},streamPOI:function(e,t,i){var o=null,n=null;if(o=S.isClusteringEnabled()||this.isPoIUICustomized?parseInt(e.externalPath[e.externalPath.length-1].name.replace("PAD3DPOINode_","")):e.instanceId,isNaN(o)&&e.instanceId&&(o=e.instanceId),null!=o&&!isNaN(o)){var s=o;if(this._layer_instancing_to_visible_for_Hover.has(t)){var r=this._layer_instancing_to_visible_for_Hover.get(t);if(r){var a=r.get(s);a>-1&&(s=a)}}o=s,n=this._layerPOIsIdInstancingIndexMap.get(t).get(o),i.push(n)}},unstreamPOI:function(e){var t=[],i=this.getPOINodeInstanceId(e),n=this.getPOILayerId(e);if(null!=n){var s=this._layers.get("POIs").get(n);if(S.isClusteringEnabled()&&s.isClustered()){if(s&&s.getNode3DBag&&s.getNode3DBag().children[0]){var r=this._layerPOIsIdInstancingNodeMap.get(n);if(S.isMemPCS())for(var a=0;a<i.length;a++){if(r.get(i[a]));else if(this._layerPOIsIdInstancingNodeMapMaster&&this._layerPOIsIdInstancingNodeMapMaster.size){var l=this._layerPOIsIdInstancingNodeMapMaster.get(n);if(l){var d=l.get(i[a]);this._seedNewNode(d,s,this._layerPOIsIdInstancingNodeMap.get(n),this._layerPOIsIdInstancingIndexMap.get(n),100,1);r=this._layerPOIsIdInstancingNodeMap.get(n)}}}for(a=0;a<i.length;a++){var h=new o;if(r&&r.size){if(void 0===(d=r.get(i[a]))&&this._layer_instancing_to_visible_for_Hover.has(n)){var c=this._layer_instancing_to_visible_for_Hover.get(n);if(c&&c.has(i[a])){var p=c.get(i[a]);p>-1&&(d=this._layerPOIsIdInstancingNodeMap.get(n).get(p))}}this._whiteListPOI.set(n+"_"+i[a],d),h.setFromArray([this._decorationBag,s.getNode3DBag(),s.getNode3DBag().children[0],d._node])}else{if(!s.getNode3DBag().children[0].children[i[a]/5-1])return t;h.setFromArray([this._decorationBag,s.getNode3DBag(),s.getNode3DBag().children[0],s.getNode3DBag().children[0].children[i[a]/5-1]])}h.instanceId=i[a],h.externalPath[2].name=n,t.push(h)}}}else if(s&&s.getNode3DBag().children[0]&&s.getNode3DBag().children[0].children[0])for(a=0;a<i.length;a++){(h=new o).setFromArray([this._decorationBag,s.getNode3DBag(),s.getNode3DBag().children[0],s.getNode3DBag().children[0].children[0]]);var u=i[a];h.instanceId=u,h.externalPath[2].name=n,t.push(h)}}return t},unstreamPOIGroup:function(e){var t=[],i=null,o=e.id;if(o){var n=o.split("_");if(n.length>1){var r=o.replace(n[0]+"_"+n[1]+"_",""),a=this._proximityGroups.get(r);if(a){var l=a.get(o);l&&l.node&&(i=s.buildPathesLeadingToNode(l.node.getNode(),this._decorationBag))&&i[0]&&t.push(i[0])}}}return t},unstreamPOI4Select:function(e){var t=[];S.isMemPCS()&&(this._blockPanelUpdate_dbg=0);var i=this.getPOINodeInstanceId(e),n=this.getPOILayerId(e),r=!1;if(null!=n){var a=this._layers.get("POIs").get(n);if(S.isClusteringEnabled()&&a.isLayerVisible()&&a.isClustered()){if(a&&a.getNode3DBag&&a.getNode3DBag().children[0]){var l=this._layerPOIsIdInstancingNodeMap.get(n);if(S.isMemPCS())for(var d=0;d<i.length;d++){if(l.get(i[d]));else if(this._layerPOIsIdInstancingNodeMapMaster&&this._layerPOIsIdInstancingNodeMapMaster.size){var h=this._layerPOIsIdInstancingNodeMapMaster.get(n);if(h){var c=h.get(i[d]);this._seedNewNode(c,a,this._layerPOIsIdInstancingNodeMap.get(n),this._layerPOIsIdInstancingIndexMap.get(n),100,1);l=this._layerPOIsIdInstancingNodeMap.get(n)}}}for(d=0;d<i.length;d++){var p=new o;if(l&&l.size){c=l.get(i[d]),r=!1;var u=i[d]+"_"+n;if(this._proximityGroupedPOIs)var g=this._proximityGroupedPOIs.get(u);if(g){var _=this._proximityGroups.get(n).get(g.groupName);if(this._whiteListPOI.set(g.groupName,_),_&&_.node)if(_.node.setVisibility(!0),C=a.getNode3DBag().children[1].children)(I=s.buildPathesLeadingToNode(_.node.getNode(),this._decorationBag))&&(p=I[0],r=!0)}else this._whiteListPOI.set(n+"_"+i[d],c),this._updatePOIClustersTimedout();r||c&&c._node&&p.setFromArray([this._decorationBag,a.getNode3DBag(),a.getNode3DBag().children[0],c._node])}else{if(!a.getNode3DBag().children[0].children[i[d]/5-1])return t;p.setFromArray([this._decorationBag,a.getNode3DBag(),a.getNode3DBag().children[0],a.getNode3DBag().children[0].children[i[d]/5-1]])}r||(p.instanceId=i[d],p.externalPath[2]&&(p.externalPath[2].name=n)),t.push(p)}}}else if(a.isVisible()&&a.isProximityMerged()){if(a&&a.getNode3DBag().children[0]&&a.getNode3DBag().children[0].children[0])for(d=0;d<i.length;d++){(p=new o).setFromArray([this._decorationBag,a.getNode3DBag(),a.getNode3DBag().children[0],a.getNode3DBag().children[0].children[0]]);var f=i[d];r=!1;if(this._layer_instancing_to_visible_for_Hover.has(n)){var v=this._layer_instancing_to_visible_for_Hover.get(n);if(v){var m=new Map(Array.from(v,e=>e.reverse()));if(m&&m.has(f)){var b=m.get(f);if(b>-1&&(f=b),-1===b){var y=this._layerPOIsIdInstancingNodeMap.get(n).get(f).path,P=new o;P.setFromArray[(y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7])],p=P}}else{var D;this._proximityGroups.get(n),u=f+"_"+n;if(this._POIIdGroupedPOIs&&this._POIIdGroupedPOIs.has(n)&&(D=this._POIIdGroupedPOIs.get(n)),D&&D.has(f)){g=D.get(f);var I,C=a.getNode3DBag().children[1].children,w=0,x=0;C.forEach(function(e){e.name===g.groupName&&(x=w),w++}),(I=new o).setFromArray([this._decorationBag,a.getNode3DBag(),a.getNode3DBag().children[1],a.getNode3DBag().children[1].children[x]]),p=I,r=!0}}}}r||(p.instanceId=f,p.externalPath[2].name=n),t.push(p)}}else if(a.isVisible()&&a&&a.getNode3DBag().children[0]&&a.getNode3DBag().children[0].children[0])for(d=0;d<i.length;d++){(p=new o).setFromArray([this._decorationBag,a.getNode3DBag(),a.getNode3DBag().children[0],a.getNode3DBag().children[0].children[0]]),p.instanceId=i[d],p.externalPath[2].name=n,t.push(p)}}return t},unstreamPOIInstancingId:function(e,t){var i=new o;if(null!=t){var n=this._layers.get("POIs").get(t);if(n&&n.getNode3DBag()&&n.getNode3DBag().children.length>0&&n.getNode3DBag().children[0]&&n.getNode3DBag().children[0].children.length>0&&n.getNode3DBag().children[0].children[0]&&n.getNode3DBag().children[0].children[0].children.length>0&&n.getNode3DBag().children[0].children[0].children[0]){if(i.setFromArray([this._decorationBag,n.getNode3DBag(),n.getNode3DBag().children[0],n.getNode3DBag().children[0].children[0],n.getNode3DBag().children[0].children[0].children[0]]),this._layer_instancing_to_visible_for_Hover.has(t)){var s=this._layer_instancing_to_visible_for_Hover.get(t);if(s){var r=new Map(Array.from(s,e=>e.reverse()));if(r&&r.has(e)){var a=r.get(e);a>-1&&(e=a)}}}i.instanceId=e,i.externalPath[2].name=t}}return i},getPOINodeInstanceId:function(e){var t=[],i=null,o=null;if(void 0!==e){var n=this._poiIdLayerId.get(e);n&&(!1===S.isMemPCS()?(o=this._layerPOIsIdInstancingIndexMap.get(n))&&o.forEach(function(i,o){i===e&&t.push(o)}):(i=this._layerPOIsIdInstancingNodeMapMaster.get(n))&&i.forEach(function(i,o){i.instancingPOI?i.id===e&&t.push(o):i._poiId===e&&t.push(o)}))}return t},getPOILayerId:function(e){var t=null;return void 0!==e&&(t=this._poiIdLayerId.get(e)),t},getPOIPosition:function(e){var t=null,i=null,o=null,n=(t=null,-1);if(e)for(var s=0;s<e.externalPath.length;s++)"PAD3DPOINode"===e.externalPath[s].className&&(e.externalPath[s+1]&&e.externalPath[s+1].name&&e.externalPath[s+1].name.indexOf("PAD3DPOINode")>-1?(t=e.externalPath[s].name,n=s+1):t=e.externalPath[s+1].name);if(t&&(S.isClusteringEnabled()&&this._layers.get("POIs").get(t).isClustered()||this.isPoIUICustomized?e.externalPath.length>=n&&(o=parseInt(e.externalPath[n].name.replace("PAD3DPOINode_",""))):o=e.instanceId,isNaN(o)&&e.instanceId&&(o=e.instanceId),null!=o&&!isNaN(o))){var r=o;if(this._layer_instancing_to_visible_for_Hover.has(t)){var a=this._layer_instancing_to_visible_for_Hover.get(t);if(a){var l=a.get(r);l>-1&&(r=l)}}o=r;var d=this._layerPOIsIdInstancingNodeMap.get(t);if(d){var h=d.get(o);if(!h){var c=this._layerController.getLayer(t);if(c.isClustered()&&S.isMemPCS()){var p=this._layerPOIsIdInstancingNodeMapMaster.get(t).get(o);this._seedNewNode(p,c,this._layerPOIsIdInstancingNodeMap.get(t),this._layerPOIsIdInstancingIndexMap.get(t),100,1),h=this._layerPOIsIdInstancingNodeMap.get(t).get(o)}}h&&(i=h.getPosition?{x:h.getPosition().x,y:h.getPosition().y,z:h.getPosition().z}:{x:h.position.x,y:h.position.y,z:h.position.z})}}return i},getPOIRelatedPath:function(e){var t=null,i=null,o=null,n=null,s=(i=null,-1);if(e)for(var r=0;r<e.externalPath.length;r++)"PAD3DPOINode"===e.externalPath[r].className&&(e.externalPath[r+1]&&e.externalPath[r+1].name&&e.externalPath[r+1].name.indexOf("PAD3DPOINode")>-1?(i=e.externalPath[r].name,s=r+1):i=e.externalPath[r+1].name);if(i&&(S.isClusteringEnabled()&&this._layers.get("POIs").get(i).isClustered()||this.isPoIUICustomized?e.externalPath.length>=s&&(n=parseInt(e.externalPath[s].name.replace("PAD3DPOINode_",""))):n=e.instanceId,isNaN(n)&&e.instanceId&&(n=e.instanceId),null!=n&&!isNaN(n))){var a=n;if(this._layer_instancing_to_visible_for_Hover.has(i)){var l=this._layer_instancing_to_visible_for_Hover.get(i);if(l){var d=l.get(a);d>-1&&(a=d)}}if(n=a,this._poiInstanceInfoMap&&this._poiInstanceInfoMap.has(i)&&(o=this._poiInstanceInfoMap.get(i))&&o.has(n)){var h=o.get(n);if(h&&h.path)t=e=this.buildPathFromArray(h.path,!0)}}return t},getPOIPositions:function(e){for(var t=[],i=this.getPOINodeInstanceId(e),o=this.getPOILayerId(e),n=0;n<i.length;n++)if(void 0!==i[n]&&null!==i[n]){var s=this._layerPOIsIdInstancingNodeMap.get(o);if(s){var r=s.get(i[n]);if(r)if(r.getPosition){var a=r.getPosition();t.push({x:a.x,y:a.y,z:a.z})}else{a=r.position;t.push({x:a.x,y:a.y,z:a.z})}}}return t},getPOILabel:function(e){var t=null,i=null,o=null,n=null,s=(t=null,-1);if(e)for(var r=0;r<e.externalPath.length;r++)"PAD3DPOINode"===e.externalPath[r].className&&(e.externalPath[r+1]&&e.externalPath[r+1].name&&e.externalPath[r+1].name.indexOf("PAD3DPOINode")>-1?(t=e.externalPath[r].name,s=r+1):t=e.externalPath[r+1].name);if(t&&(S.isClusteringEnabled()&&this._layers.get("POIs").get(t).isClustered()||this.isPoIUICustomized?e.externalPath.length>=s&&(n=parseInt(e.externalPath[s].name.replace("PAD3DPOINode_",""))):n=e.instanceId,isNaN(n)&&e.instanceId&&(n=e.instanceId),null!=n&&!isNaN(n))){var a=n;if(this._layer_instancing_to_visible_for_Hover.has(t)){var l=this._layer_instancing_to_visible_for_Hover.get(t);if(l){var d=l.get(a);d>-1&&(a=d)}}if(n=a,this._poiInstanceInfoMap&&this._poiInstanceInfoMap.has(t)&&(o=this._poiInstanceInfoMap.get(t))&&o.has(n)){var h=o.get(n);h&&h.label&&(i=h.label)}}return i},drawPOIs:function(e){return new Promise(function(t){var i=e.pointOfInterest,o=[];i&&(void 0===i.kinds||i.kinds.length<1)&&(i.kinds=[{AMD:"DS/ENOPAD3DViewer/views/PADLayerPOIView",kind:"POI"}]),i&&i.kinds&&i.kinds.forEach(function(e){void 0===e.AMD&&(e.AMD="DS/ENOPAD3DViewer/views/PADLayerPOIView")}),o.push(this._layerController.declareLayerKinds(i.kinds)),Promise.all(o).then(function(){var o=.001,n=100,s=(i.enableClustering,!1);if(i.clusteringOptions?!0===e.cumulativeMode&&S.isParametersSet()||S.setParameters(i.clusteringOptions):(!0!==i.enableClustering&&!0!==i.enableProximityMerging||(!0===i.enableClustering&&(n=i.maxClusters?i.maxClusters:100),void 0!==i.proximityThreshold&&(o=i.proximityThreshold)),!0===e.cumulativeMode&&S.isParametersSet()||S.setParameters({clustering2D:{active:i.enableClustering,maxClusters:n},proximityMerging:{active:i.enableProximityMerging,proximityThreshold:o}})),!0===e.cumulativeMode&&S.isParametersSet()&&(S.isParametersSet()&&!0===S.isClusteringEnabled()&&!1===i.enableClustering?s=!0:S.isParametersSet()&&!1===S.isClusteringEnabled()&&!0===i.enableClustering&&(s=!0)),S.isGroupEngineInitialized()||this.setupPOIGroupEngine(),!0===i.layerColorEditable?this._isLayerColorEditable=!0:this._isLayerColorEditable=!1,i&&i.layers)for(var r=0;r<i.layers.length;r++){if(!0===e.cumulativeMode&&i.layers[r]&&i.layers[r].id&&this._layerController.hasLayer(i.layers[r].id)){i.layers[r].append=!0;var a=this._proxGroupPOIsForLayer.get(i.layers[r].id),l=this._proximityGroups.get(i.layers[r].id);a&&a.clear(),l&&l.clear()}S.isGroupEngineInitialized()||this.setupPOIGroupEngine(),s&&(i.layers[r].clustered=!1),i.layers[r].enableProximityMerging=S.isProximityMergingEnabled(),i.layers[r].enableClustering=S.isClusteringEnabled(),i.layers[r].proximityThreshold=S.getMergingThreshold(),i.layers[r].clusterMaxNum=S.getMaxClusters(),this.drawPOIsSingleLayer(i.layers[r]).then(function(){t()}.bind(this))}else{if(!0===e.cumulativeMode&&i&&i.id&&this._layerController.hasLayer(i.id)){var d={id:i.layers[r].id,layer:this._layerController.getLayer(i.layers[r].id)};this._deleteLayerUpdate(d),this._layerController.deleteLayerId(i.layers[r].id)}s&&(i.clustered=!1),i.enableProximityMerging=i.enableProximityMerging,i.enableClustering=i.enableClustering,i.proximityThreshold=o,i.clusterMaxNum=n,this.drawPOIsSingleLayer(i).then(function(){t()}.bind(this))}}.bind(this))}.bind(this))},drawPOIsSingleLayer:function(e){return new Promise(function(t){if(S.isClusteringEnabled()&&null==e.clustered?e.clustered=!0:!1===e.enableClustering&&(e.clustered=!1),e&&e.pointMap&&e.pointMap.length){var i,o;this._poiTooltipMasterNode||(this._poiTooltipMasterNode=new r,this._decorationBag.addChild(this._poiTooltipMasterNode)),this._pushPinNodeColorMap=new Map,e.append&&e.id&&(o=(i=this._POILayers.get(e.id)).getStyles(),e.clustered=i.isClustered(),e.visibility=i.isLayerVisible()),e.styles&&(o||(o=new Map),this._generateStyleMap(e.styles,o,e.append),i&&i.setStyles(o)),e.append&&i||(i=this._layerController.createLayer({layerId:e.id,label:void 0!==e.label?e.label:"POIs",color:void 0!==e.color?e.color:"#",clustered:void 0!==e.clustered?e.clustered:S.isClusteringEnabled(),enableClustering:e.enableClustering?e.enableClustering:S.isClusteringEnabled(),maxClusters:void 0!==S.getMaxClusters()?S.getMaxClusters():200,proximityMerging:void 0===e.enableProximityMerging||e.enableProximityMerging,proximityThreshold:void 0!==S.getMergingThreshold()?S.getMergingThreshold():.001,layerColorEditable:e.layerColorEditable?e.layerColorEditable:this._isLayerColorEditable,visibility:void 0===e.visibility||e.visibility,layerGroupView:void 0!==e.layerGroupView?e.layerGroupView:null,kind:e.kind?e.kind:"poi",type:e.type?e.type:"poi",styles:o||void 0,scale:e.scale>0?e.scale:1,poiIcon:void 0!==e.poiIcon?e.poiIcon:"default",ghostLayer:e.ghostLayer})),i&&(this._convertPointMap(e,i),this._poiDataPerLayer.set(i.getID(),e),this._POILayers.set(i.getID(),i),this._layers.set("POIs",this._POILayers),this._proximityGroupsInitDone?this._proximityGroupsInitDone.set(i.getID(),!1):this._proximityGroupsInitDone=new Map);var n={data:e,layer:i,layerId:i.getID()};i.subscribe({event:"enableClusters"},function(e){var t=this._poiDataLayerDraw.get(e.id);if(t){if(t.data.clustered=!0,e.layer.isLayerVisible()){this._whiteListPOI.clear();var i=this._layerController.getLayer(e.id);i&&i.isLayerVisible()&&(this._layerController.setCustomHeaderVisibility(e.layer.getKind(),!0),setTimeout(function(){this.resetPOIsForLayer(i),this._drawPOINodes(t.pois,e.id,t.customUI,t.data).then(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this))}.bind(this),10))}this._updatePOIClusters()}}.bind(this)),i.subscribe({event:"disableClusters"},function(e){var t=this._poiDataLayerDraw.get(e.id);if(t&&(t.data.clustered=!1,e.layer.isLayerVisible())){!0===S.isProximityMergingActive()&&this._layerController.setCustomHeaderVisibility(e.layer.getKind(),!0),this._whiteListPOI.clear(),this._hideGroupsForLayer(e.layer);var i=this._layerController.getLayer(e.id);i&&i.isLayerVisible()&&setTimeout(function(){this.resetPOIsForLayer(i),this._drawPOINodes(t.pois,e.id,t.customUI,t.data).then(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this))}.bind(this),10)}}.bind(this)),i.subscribe({event:"updateLayerColor"},function(e){var t=this._proximityGroups.get(i.getID());t&&t.forEach(function(t,i){t.node.setColor(e.color)}),this._groups.forEach(function(t,o){var n=o.split("_");n.length>1&&(o.replace(n[0]+"_","")===i.getID()&&t.node.setColor(e.color))}),this._context.getViewer().render()}.bind(this));i.subscribe({event:"delete"},function(e){this._deleteLayerUpdate(e)}.bind(this)),i.subscribe({event:"hide"},function(e){this._proximityNodes&&this._proximityNodes.removeChildren(),e.layer.isClustered&&e.layer.isClustered()&&this._hideLayerUpdate(e),this._externalKPICommandProxy.layerHide({id:e.id,widgetId:I.appId()})}.bind(this)),i.subscribe({event:"show"},function(e){this.resetPOIsForLayer(n.layer),this._showLayerUpdate(e),this._externalKPICommandProxy.layerShow({id:e.id,widgetId:I.appId()})}.bind(this));if(i){if(e.rootOpacity)for(var a=this.getRoots(),h=0;h<a.length;h++)if(!0===l.getSetting("enopad3dviewer_lightNodeModel")){var p=c.getNodeID(a[h]);i.getOverrideSet().setOverrideCB(p,function(t,i){var o=e.rootOpacity;i&&i.setOpacity(o,!1)})}else if(a[h]){var u=s.buildPathesLeadingToNode(a[h],this.getRootBag()),g=e.opacity;i.getOverrideSet().createOverride(u).setOpacity(g,!1)}this._layerController.setCustomHeaderVisibility(i.getKind(),!0),this._drawPOIsAfterLayer(e,i,i.getID()).then(function(){if(this._updatePOIClusters(),this._context.getViewer().render(),this._layerController.setCustomHeaderVisibility(i.getKind(),!1),!1===e.visibility&&i.setVisibility(!1),e&&e.pointMap&&i){var o=0;o=e.pointMap.length,this._layerPOIsIdInstancingNodeMap&&this._layerPOIsIdInstancingNodeMap.get(i.getID())&&(o=this._layerPOIsIdInstancingNodeMap.get(i.getID()).size);var n=0,s=0,r=0;e.positionPOIs&&(n=e.positionPOIs.size),e.pathPOIs&&(s=e.pathPOIs.size),e.referencePOIs&&(r=e.referencePOIs.size),this._poiDataLayerDraw&&this._poiDataLayerDraw.get(i.getID())&&this._poiDataLayerDraw.get(i.getID()).pois&&(o=this._poiDataLayerDraw.get(i.getID()).pois.length);var a=d.getPADTracker({eventCategory:"usage",eventAction:"3d_enrich3D_layer_stats"}),l="POI";e.kind?l=e.kind:n>0||s||r||(l="not_POI"),a.persDim.pd2=i.isClustered()?"Activated":"Deactivated",a.persDim.pd3=i.isVisible()?"Visible":"Hidden",a.persDim.pd4=i.isProximityMerged()?"Activated":"Deactivated",a.persDim.pd5="POI"===l||"poi"===l?"POI":"not_POI",a.persVal.pv2=o,a.persVal.pv3=n,a.persVal.pv4=s,a.persVal.pv5=r,a.trackPageEvent()}t()}.bind(this))}}else e&&t()}.bind(this))},_drawPOIsAfterLayer_2:function(e,t,i){return new Promise(function(o){this._drawPOIsAfterLayer_1(e,t,i).then(function(){o()}.bind(this))}.bind(this))},_drawPOIsAfterLayer:function(t,i,o){return new Promise(function(n){this._instanceId=0;var s=[];if(!0===l.getSetting("enopad3dviewer_lightNodeModel")){if(this._POIsDescriptionMap.referencePOIs.forEach(function(e){this._drawPOIWithDynamicLoading(e)}.bind(this)),this._POIsDescriptionMap.pathPOIs.forEach(function(e){this._drawPOIWithDynamicLoading(e)}.bind(this)),this._poisToLoadMap.forEach(function(e,t){this.poiToLoad.push(e)}.bind(this)),this.poiToLoad.length>0){for(;this.poiToLoad.length>this.max_path;)s=s.concat(this._loadPOI(this.poiToLoad.slice(0,this.max_path))),this.poiToLoad=this.poiToLoad.slice(this.max_path);s=s.concat(this._loadPOI(this.poiToLoad)),this.poiToLoad=[],this._poisToLoadMap.clear()}}else this._POIsDescriptionMap.referencePOIs.forEach(function(e){this._drawPOI(e)}.bind(this)),this._POIsDescriptionMap.pathPOIs.forEach(function(e){this._drawPOI(e)}.bind(this));this._POIsDescriptionMap.positionPOIs.forEach(function(e){this._drawPOI(e)}.bind(this)),this._loadPOIs_pre=s;var r,a=t;r=e.clone(this._pois),this._pois=[],t.poiUI?(this.isPoIUICustomized=!0,require([t.poiUI],function(e){Promise.all(s).then(function(t){if(this._layers.get("POIs")&&this._layers.get("POIs").size>0){if(this._pois.length)for(var s=0;s<this._pois.length;s++)r.push(this._pois[s]);this._poiDataLayerDraw.set(i.getID(),{pois:r,customUI:e,data:a}),this._drawPOINodes(r,i.getID(),e,a).then(function(){if(i&&i.getID()){if(i.show(),!0===i.isProximityMerged()&&(this.setup3DProximityGroups(i.getID()),!i.isClustered()&&this._layers.get("POIs").get(i.getID()).getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity"))){this._hideProxInstancesFromInstancingPOIs(this._layers.get("POIs").get(i.getID()));var e=this._layerPOIsIdInstancingIndexMap.get(i.getID()),t=this._layerVisibleInstancingPOIs.get(i.getID()),s=[],r=0;t.forEach(function(e,t){s[r]=t,r++});var a=0,l=new Map;e.forEach(function(e,t){var i=-1;a<r&&(i=s[a]),l.set(t,i),a++}),this._layer_instancing_to_visible_for_Hover.set(o,l)}this._updatePOIClusters(),n()}else n()}.bind(this))}}.bind(this))}.bind(this))):(this.isPoIUICustomized=!1,Promise.all(s).then(function(e){if(this._layers.get("POIs")&&this._layers.get("POIs").size>0){if(this._pois.length)for(var t=0;t<this._pois.length;t++)r.push(this._pois[t]);this._poiDataLayerDraw.set(i.getID(),{pois:r,customUI:null,data:a}),this._drawPOINodes(r,i.getID(),null,a).then(function(){if(i&&i.getID()){if(i.show(),!0===i.isProximityMerged()&&(this.setup3DProximityGroups(i.getID()),!i.isClustered()&&this._layers.get("POIs").get(i.getID()).getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity"))){this._hideProxInstancesFromInstancingPOIs(this._layers.get("POIs").get(i.getID()));var e=this._layerPOIsIdInstancingIndexMap.get(i.getID()),t=this._layerVisibleInstancingPOIs.get(i.getID()),s=[],r=0;t.forEach(function(e,t){s[r]=t,r++});var a=0,l=new Map;e.forEach(function(e,t){var i=-1;a<r&&(i=s[a]),l.set(t,i),a++}),this._layer_instancing_to_visible_for_Hover.set(o,l)}this._updatePOIClusters(),n()}else n()}.bind(this))}}.bind(this)))}.bind(this))},_hideProxInstancesFromInstancingPOIs:function(e){var t;if(this._proxGroupPOIsForLayer&&e.getID()&&this._proxGroupPOIsForLayer.has(e.getID())&&(t=this._proxGroupPOIsForLayer.get(e.getID()))&&t.size>0){var i=this._layerVisibleInstancingPOIs.get(e.getID()),o=new Map,s=[],r=[];i&&(i.forEach(function(i){var a;t.has(i.instanceId)||(null!=i.color?a=i.color:e.getStyles()&&void 0!==i.style&&e.getStyles().has(i.style)&&(a=e.getStyles().get(i.style).color),s.push(new n.Color(a)),r.push((new n.Matrix4).setPosition(new n.Vector3(i.position.x,i.position.y,i.position.z))),o.set(i.instanceId,i))}),o&&o.size>=0&&e.getNode3DBag().children[0].children[0].setInstancingParams({name:e.getID(),nbInstances:o.size,matrices:r,colors:s}),this._layerVisibleInstancingPOIs.set(e.getID(),o))}},_hideLayerUpdate:function(e){if(e.layer&&e.layer.isClustered&&e.layer.isClustered()){var t=this._layerPOIsIdInstancingNodeMap.get(e.layer.getID()),i=e.layer.getNode3DBag().children;if(S.isMemPCS())for(var o=0;o<i.length;o++)if("PAD3DPOINode"===i[o].className){var n=t;if(n)for(var s=0;s<i[o].children.length;s++){var r=parseInt(e.layer.getNode3DBag().children[o].children[s].name.substr(13),10),a=n.get(r);a&&a.setVisibility(!1)}}this._whiteListPOI&&this._whiteListPOI.clear(),this._hideGroupsForLayer(e.layer),this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}},_showLayerUpdate:function(e){if(e.layer.isLayerVisible()){var t=this._poiDataLayerDraw.get(e.id),i=this._layerController.getLayer(e.layer.getID());i&&i.isLayerVisible()&&(i.clustered?(this._layerController.setCustomHeaderVisibility(e.layer.getKind(),!0),setTimeout(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this),10)):(!0===S.isProximityMergingActive()&&this._layerController.setCustomHeaderVisibility(e.layer.getKind(),!0),setTimeout(function(){this.resetPOIsForLayer(i),this._drawPOINodes(t.pois,e.id,t.customUI,t.data).then(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()}),this._context.getViewer().render()}.bind(this))}.bind(this),10)))}},_deleteLayerUpdate:function(e){var t=e.layer.getID();S.isClusteringEnabled()&&e.layer.isClustered()&&this._hideGroupsForLayer(e.layer);var i=this._layers.get("POIs");if(i&&i.size>0){var o=e.layer;o.getNode3DBag().children[0]&&o.getNode3DBag().children[0].removeChildren(),o.getNode3DBag().children.length>1&&o.getNode3DBag().children[1]&&o.getNode3DBag().children[1].removeChildren(),o.getNode3DBag().removeChildren(),this._layers.get("POIs").delete(t)}t&&(this._layerPOIsIdInstancingIndexMap.delete(t),this._layerPOIsIdInstancingNodeMap.delete(t),this._layerVisibleInstancingPOIs.delete(t),this._proxGroupPOIsForLayer&&this._proxGroupPOIsForLayer.delete(t),this._proximityGroups&&this._proximityGroups.delete(t),this._poiDataPerLayer.has(t)&&this._poiDataPerLayer.delete(t),this._proximityGroupsInitDone.delete(t)),this._tooltipNodes&&this._tooltipNodes.removeChildren(),this._whiteListPOI&&this._whiteListPOI.clear(),i&&i.size<1?(this.stopPOIClusters(),this.resetPOIs()):this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})},resetPOIs:function(){S.setPOIType(""),S.isGroupEngineInitialized()&&this.stopPOIClusters(),this._POIIdGroupedPOIs&&this._POIIdGroupedPOIs.clear(),this._tooltipFrame&&this._tooltipFrame.hide();var e=this._layers.get("POIs");e&&(e.forEach(function(e){var t=e.getNode3DBag();if(t&&t.children){for(var i=t.children,o=0;o<i.length;o++)"PAD3DPOINode"===i[o].className&&i[o].removeChildren();this._layerController.deleteLayer(e)}}.bind(this)),this._layers.delete("POIs")),this._POILayers.clear(),this._proximityNodes&&this._proximityNodes.getChildren().length>0&&this._proximityNodes.removeChildren(),this._poiIdInfoMap.clear(),this._poiInstanceInfoMap.clear(),this._poiIdLayerId.clear(),this._layerPOIsIdInstancingIndexMap.clear(),this._layerPOIsIdInstancingNodeMap.clear(),this._layerPOIColorsMap.clear(),this._layerPOIMatricesMap.clear(),this._layerVisibleInstancingPOIs.clear(),this._layer_instancing_to_visible_for_Hover.clear(),this._proximityGroupedPOIs&&this._proximityGroupedPOIs.size>0&&this._proximityGroupedPOIs.clear(),this._layer_visible_to_instancing_for_Select.clear(),this._whiteListPOI&&this._whiteListPOI.size>0&&this._whiteListPOI.clear(),this._model.removeUserQueue(this._POIsKPIUserQueueCallbacks),this._POIsDescriptionMap={},this._pois=[],this._pushPinNodeColorMap.clear(),this._context.getViewer().render()},resetPOIsForLayer:function(e){var t=e.getNode3DBag();if(t&&t.children)for(var i=t.children,o=0;o<i.length;o++)"PAD3DPOINode"===i[o].className&&i[o].removeChildren();e.options.layerId&&this._layerPOIsIdInstancingIndexMap.get(this._layerPOIsIdInstancingIndexMap)&&this._layerPOIsIdInstancingIndexMap.get(e.options.layerId).clear(),this._instanceId=0,this._model.removeUserQueue(this._POIsKPIUserQueueCallbacks),this._context.getViewer().render()},getVolumeParameters:function(e){if(console.warn("DEPRECATED 21XFD06, please use display3DVolume protocol."),!e||!e.id)throw new Error("PAD3DViewerExternalKPIController.getVolumeParameters: Wrong input parameters");var t=null,i=this._selectionVolumesMap.get(e.id);return i&&(this._externalKPICommandProxy&&this._externalKPICommandProxy.volumeParametersChanged({id:e.id,volumeParams:i.getParameters(),widgetId:I.appId()}),t=i.getParameters()),t},setVolumeParameters:function(e){if(console.warn("DEPRECATED 21XFD06, please use display3DVolume protocol."),!e||!e.id||!e.params)throw new Error("PAD3DViewerExternalKPIController.setVolumeParameters: Wrong input parameters");var t=this._selectionVolumesMap.get(e.id);t&&t.setParameters(e.params)},removeVolume:function(e){if(console.warn("DEPRECATED 21XFD06, please use display3DVolume protocol."),!e||!e.id)throw new Error("PAD3DViewerExternalKPIController.removeVolume: Wrong input parameters");if(this._selectionVolumesMap){var t=this._selectionVolumesMap.get(e.id);t&&(this._selectionVolumesMap.delete(e.id),t.destroy(),t=null)}},_drawVolume:function(e){var t=null;if(!e||!e.type)throw new Error("PAD3DViewerExternalKPIController._drawVolume: Wrong input parameters");function i(e){this._externalKPICommandProxy.volumeParametersChanged({volumeParams:e.params,widgetId:I.appId()})}return"Box"===e.type?t=new _({id:e.id,type:e.type,fillColor:e.fillColor,borderColor:e.borderColor,min:e.min,max:e.max,parentNode:this._selectionVolumesNode,endManipulateCB:i.bind(this)}):"Sphere"===e.type&&(t=new f({id:e.id,type:e.type,fillColor:e.fillColor,borderColor:e.borderColor,center:e.center,radius:e.radius,parentNode:this._selectionVolumesNode,endManipulateCB:i.bind(this)})),t&&this._selectionVolumesMap.set(e.id,t),t},_convertPointMap:function(e,t){var i=t.getID(),o=e.pointMap,s=t.getStyles();if(this._POIsDescriptionMap={positionPOIs:new Map,referencePOIs:new Map,pathPOIs:new Map},e.append&&i){var r=this._poiDataPerLayer.get(i);r&&(this._POIsDescriptionMap.positionPOIs=r.positionPOIs,this._POIsDescriptionMap.referencePOIs=r.referencePOIs,this._POIsDescriptionMap.pathPOIs=r.pathPOIs)}for(var a=0;a<o.length;a++){var d=o[a];this._POIsDescriptionMap.referencePOIs.delete(d.id),this._POIsDescriptionMap.pathPOIs.delete(d.id),this._POIsDescriptionMap.positionPOIs.delete(d.id),d.localMatrix&&d.localMatrix.length&&d.localMatrix.length>0&&!d.localMatrix.elements&&(d.localMatrix=(new n.Matrix4).setFromArray(d.localMatrix)),d.localPositionMatrix&&d.localPositionMatrix.length&&d.localPositionMatrix.length>0&&!d.localPositionMatrix.elements&&(d.localMatrix=(new n.Matrix4).setFromArray(d.localPositionMatrix)),d.resourceids||d.resourceid&&this.getNode({id:d.resourceid})||d.resourceid&&l.getSetting("enopad3dviewer_lightNodeModel")?s&&null!=d.style&&s.has(d.style)?(this._POIsDescriptionMap.referencePOIs.set(d.id,{id:d.id,resourceid:d.resourceid,resourceids:d.resourceids,style:d.style,label:void 0!==d.label?d.label:"POI "+d.id,enablePOIPanel:void 0===d.enablePOIPanel||d.enablePOIPanel,localMatrix:void 0!==d.localMatrix?d.localMatrix:new n.Matrix4}),this._poiIdInfoMap.set(d.id,{resourceid:d.resourceid,resourceids:d.resourceids,content:d})):(this._POIsDescriptionMap.referencePOIs.set(d.id,{id:d.id,resourceid:d.resourceid,resourceids:d.resourceids,color:void 0!==d.color?d.color:"#EA4F37",label:void 0!==d.label?d.label:"POI "+d.id,pickability:d.pickability?d.pickability:"PICKABLE",enablePOIPanel:void 0===d.enablePOIPanel||d.enablePOIPanel,localMatrix:void 0!==d.localMatrix?d.localMatrix:new n.Matrix4}),this._poiIdInfoMap.set(d.id,{resourceid:d.resourceid,resourceids:d.resourceids,content:d})):(d.pathes||d.path&&this.getNode({id:d.path[d.path.length-1]})||d.path&&l.getSetting("enopad3dviewer_lightNodeModel"))&&(s&&null!=d.style&&s.has(d.style)?(this._POIsDescriptionMap.pathPOIs.set(d.id,{id:d.id,path:d.path,pathes:d.pathes,style:d.style,label:void 0!==d.label?d.label:"POI "+d.id,enablePOIPanel:void 0===d.enablePOIPanel||d.enablePOIPanel,localMatrix:void 0!==d.localMatrix?d.localMatrix:new n.Matrix4}),this._poiIdInfoMap.set(d.id,{path:d.path,pathes:d.pathes,content:d})):(this._POIsDescriptionMap.pathPOIs.set(d.id,{id:d.id,path:d.path,pathes:d.pathes,color:void 0!==d.color?d.color:"#EA4F37",label:void 0!==d.label?d.label:"POI "+d.id,pickability:d.pickability?d.pickability:"PICKABLE",enablePOIPanel:void 0===d.enablePOIPanel||d.enablePOIPanel,localMatrix:void 0!==d.localMatrix?d.localMatrix:new n.Matrix4}),this._poiIdInfoMap.set(d.id,{path:d.path,pathes:d.pathes,content:d}))),d.position&&(s&&null!=d.style&&s.has(d.style)?(this._POIsDescriptionMap.positionPOIs.set(d.id,{id:d.id,position:d.position,style:d.style,label:void 0!==d.label?d.label:"POI "+d.id,enablePOIPanel:void 0===d.enablePOIPanel||d.enablePOIPanel}),this._poiIdInfoMap.set(d.id,{position:d.position,content:d})):(this._POIsDescriptionMap.positionPOIs.set(d.id,{id:d.id,position:d.position,color:void 0!==d.color?d.color:"#EA4F37",label:void 0!==d.label?d.label:"POI "+d.id,pickability:d.pickability?d.pickability:"PICKABLE",enablePOIPanel:void 0===d.enablePOIPanel||d.enablePOIPanel}),this._poiIdInfoMap.set(d.id,{position:d.position,content:d})))}var h=e;h.positionPOIs=this._POIsDescriptionMap.positionPOIs,h.referencePOIs=this._POIsDescriptionMap.referencePOIs,h.pathPOIs=this._POIsDescriptionMap.pathPOIs,this._poiDataPerLayer.set(e.id,h)},_generateStyleMap:function(e,t,i){i||t.clear();for(var o=0;o<e.length;o++){var n=void 0===e[o].id?o:e[o].id;t.has(n)||(delete e[o].id,t.set(n,e[o]))}},_drawPOINodes:function(e,t,i,o){return new Promise(function(s){if(t){if(void 0===e)return;var a=this._layers.get("POIs").get(t);if(a){var l;this._proxGroupPOIsForLayer&&this._proxGroupPOIsForLayer.has(t)&&a&&(l=this._proxGroupPOIsForLayer.get(t));var d=new Map,h=this._layerController.getLayerStyles(t);if(S.isClusteringEnabled()&&o.clustered){var c=new r;c.className="PAD3DPOINode",c.name=t;var g,_;I=new Map,f=new Map;for(C=0;C<e.length;C++){l&&l.has(e[C].instanceId)&&(d.set(e[C].instanceId,e[C]),f.set(e[C].instanceId,e[C].id),this._poiIdLayerId.set(e[C].id,t));V=void 0!==h&&null!=e[C].style&&void 0!==h.get(e[C].style)&&void 0!==h.get(e[C].style).color?h.get(e[C].style).color:e[C].color;if(i){this._poiIdInfoMap.get(e[C].id)&&(w=this._poiIdInfoMap.get(e[C].id).content);x=i.createCustomPoI({context:this._context,parent:c,fillColor:V,position:new n.Vector3(parseFloat(e[C].position.x),parseFloat(e[C].position.y),parseFloat(e[C].position.z)),instanceId:e[C].instanceId,poiId:e[C].id,name:"PAD3DPOINode_"+e[C].instanceId,poiType:S.getPOIType(),label:e[C].label,layerId:t,scale:a.getPOIScale(),icon:a.getPOIIcon(),content:w,pickability:e[C].pickability,enablePOIPanel:void 0===e[C].enablePOIPanel||e[C].enablePOIPanel,onHoverCallback:this._onHoveroverPOINodecallback.bind(this),outHoverCallback:this._outHoveroverPOINodecallback.bind(this)})}else x=new u({context:this._context,parent:c,fillColor:V,position:new n.Vector3(parseFloat(e[C].position.x),parseFloat(e[C].position.y),parseFloat(e[C].position.z)),instanceId:e[C].instanceId,poiId:e[C].id,name:"PAD3DPOINode_"+e[C].instanceId,label:e[C].label,layerId:t,scale:a.getPOIScale(),icon:a.getPOIIcon(),poiType:S.getPOIType(),pickability:e[C].pickability,enablePOIPanel:void 0===e[C].enablePOIPanel||e[C].enablePOIPanel,onHoverCallback:this._onHoveroverPOINodecallback.bind(this),outHoverCallback:this._outHoveroverPOINodecallback.bind(this),poiMemMode:S.isMemPCS()});e[C].color=V,f.set(e[C].instanceId,e[C].id),I.set(e[C].instanceId,x),this._poiIdLayerId.set(e[C].id,t),d.set(e[C].instanceId,e[C])}this._layerPOIsIdInstancingIndexMap.set(t,f),this._layerPOIsIdInstancingNodeMap.set(t,I),S.isMemPCS()&&this._layerPOIsIdInstancingNodeMapMaster.set(t,I),a&&(a.getNode3DBag().children.length>0&&(g=a.getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"),_=a.getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity"),a.getNode3DBag().removeChildren()),a.getNode3DBag().addChild(c),g&&a.getNode3DBag().addChild(g),_&&a.getNode3DBag().addChild(_)),this._pois=[],this._poiInstanceInfoMap.set(t,d),s()}else{var f=new Map,v=[],m=[],b=null,y=new r;if(y.className="PAD3DPOINode",i){y.name=t;for(var P,D,I=new Map,C=0;C<e.length;C++){var w,x;this._poiIdInfoMap.get(e[C].id)&&(w=this._poiIdInfoMap.get(e[C].id).content),(x=i.createCustomPoI({context:this._context,parent:y,fillColor:void 0!==h&&null!=e[C].style&&void 0!==h.get(e[C].style)&&void 0!==h.get(e[C].style).color?h.get(e[C].style).color:e[C].color,position:new n.Vector3(parseFloat(e[C].position.x),parseFloat(e[C].position.y),parseFloat(e[C].position.z)),instanceId:e[C].instanceId,poiId:e[C].id,name:"PAD3DPOINode_"+e[C].instanceId,label:e[C].label,layerId:t,content:w,poiIcon:o.poiIcon,enablePOIPanel:void 0===e[C].enablePOIPanel||e[C].enablePOIPanel,onHoverCallback:this._onHoveroverPOINodecallback.bind(this),outHoverCallback:this._outHoveroverPOINodecallback.bind(this)})).setVisibility(!0),f.set(e[C].instanceId,e[C].id),I.set(e[C].instanceId,x),this._poiIdLayerId.set(e[C].id,t),d.set(e[C].instanceId,e[C])}a&&(a.getNode3DBag().children.length>0&&(P=a.getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"),D=a.getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity"),a.getNode3DBag().removeChildren()),a.getNode3DBag().addChild(y),P&&a.getNode3DBag().addChild(P),D&&a.getNode3DBag().addChild(D)),this._layerPOIsIdInstancingNodeMap.set(t,I),S.isMemPCS()&&this._layerPOIsIdInstancingNodeMapMaster.set(t,I),this._context.getViewer().render()}else{var O,A,I=new Map,M=new Map,N=0;for(C=0;C<e.length;C++){if(e[C].instancingPOI=!0,I.set(e[C].instanceId,e[C]),f.set(e[C].instanceId,e[C].id),!l||l&&!l.has(e[C].instanceId)){N++;var V=void 0!==h&&null!=e[C].style&&void 0!==h.get(e[C].style)&&void 0!==h.get(e[C].style).color?h.get(e[C].style).color:e[C].color;e[C].color=V,v.push(new n.Color(V)),m.push((new n.Matrix4).setPosition(new n.Vector3(parseFloat(e[C].position.x),parseFloat(e[C].position.y),parseFloat(e[C].position.z)))),e[C].instancingPOI=!0,M.set(e[C].instanceId,e[C])}this._poiIdLayerId.set(e[C].id,t),d.set(e[C].instanceId,e[C])}if(b=new p({context:this._context,name:t,layerId:t,poisNum:N,colors:v,scale:a.getPOIScale(),icon:a.getPOIIcon(),poiType:S.getPOIType(),matrices:m,onHoverCallback:this._onHoverInstanceCallback.bind(this),outHoverCallback:this._outHoverInstanceCallback.bind(this)}).render(),y.addChild(b),a){if(a.getNode3DBag().children.length>0){O=a.getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"),A=a.getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity");var E=this._proximityGroups.get(t);E&&E.forEach(function(e){var t=e.node._node;void 0===A.addChild(t)&&t.setVisibility(!0)}),a.getNode3DBag().removeChildren()}a.getNode3DBag().addChild(y),O&&a.getNode3DBag().addChild(O),A&&a.getNode3DBag().addChild(A)}this._layerPOIsIdInstancingNodeMap.set(t,I),S.isMemPCS()&&this._layerPOIsIdInstancingNodeMapMaster.set(t,I),this._layerVisibleInstancingPOIs.set(t,M);var T=[],R=0;M.forEach(function(e,t){T[R]=t,R++});var L=0,F=new Map;f.forEach(function(e,t){var i=-1;L<R&&(i=T[L]),F.set(t,i),L++}),this._layer_instancing_to_visible_for_Hover.set(t,F)}this._layerPOIsIdInstancingIndexMap.set(t,f),this._layerPOIColorsMap.set(t,v),this._layerPOIMatricesMap.set(t,m),this._pois=[],s()}this._poiInstanceInfoMap.set(t,d)}}else s()}.bind(this))},_drawPOI:function(t){if(t.resourceid||t.resourceids){if(t.resourceids)for(var i=0;i<t.resourceids.length;i++){var o;if(o=this.getNode({id:t.resourceids[i]}))for(var r=s.buildPathesLeadingToNode(o,this.getRootBag()),a=0;a<r.length;a++){var l=(g=r[a]).getWorldMatrix(),d=g.getLastElement(!0).getBoundingSphere().center,h=this._context.streamPath(g);if(void 0!==t.localMatrix&&(t.localMatrix.length&&t.localMatrix.length>0&&(t.localMatrix=new n.Matrix4),d.applyProjection(t.localMatrix)),d.applyProjection(l),d){(_=e.clone(t)).instanceId=5*(this._instanceId+1),this._instanceId++,_.position=d;for(var c=[],p=0;p<h.length;p++)c.push(h[p]);_.path=c,this._pois.push(_)}}}else if(o=this.getNode({id:t.resourceid}))for(r=s.buildPathesLeadingToNode(o,this.getRootBag()),a=0;a<r.length;a++){l=(g=r[a]).getWorldMatrix(),d=g.getLastElement(!0).getBoundingSphere().center,h=this._context.streamPath(g);if(void 0!==t.localMatrix&&(t.localMatrix.length&&t.localMatrix.length>0&&(t.localMatrix=new n.Matrix4),d.applyProjection(t.localMatrix)),d.applyProjection(l),d){(_=e.clone(t)).instanceId=5*(this._instanceId+1),this._instanceId++,_.position=d;for(c=[],p=0;p<h.length;p++)c.push(h[p]);_.path=c,this._pois.push(_)}}}else if(t.path||t.pathes){if(t.pathes&&t.pathes.length)for(var u=0;u<t.pathes.length;u++){var g;if(g=this.buildPathFromArray(t.pathes[u])){var _;l=g.getWorldMatrix(),d=g.getLastElement(!0).getBoundingSphere().center;if(void 0!==t.localMatrix&&d.applyProjection(t.localMatrix),d.applyProjection(l),d)(_=e.clone(t)).instanceId=5*(this._instanceId+1),this._instanceId++,_.path=poipath,_.position=d,this._pois.push(_)}}else if(g=this.buildPathFromArray(t.path)){l=g.getWorldMatrix(),d=g.getLastElement(!0).getBoundingSphere().center;void 0!==t.localMatrix&&d.applyProjection(t.localMatrix),d.applyProjection(l),d&&(t.instanceId=5*(this._instanceId+1),this._instanceId++,t.position=d,this._pois.push(t))}}else t.position&&(t.instanceId=5*(this._instanceId+1),this._instanceId++,this._pois.push(t))},_drawPOIWithDynamicLoading:function(t){if(void 0!==t&&(t.resourceid||t.resourceids))if(t.resourceids&&t.resourceids.length&&t.resourceids.length>0)for(var i=0;i<t.resourceids.length;i++){var o;if(this.isRegistered(t.resourceids[i])){if(o=this.getIdPathesLeadingToReference(t.resourceids[i]))if(null!==(_=this.getReferenceBoundingBox(t.resourceids[i])))for(var s=new n.Vector3((_.min.x+_.max.x)/2,(_.min.y+_.max.y)/2,(_.min.z+_.max.z)/2),r=0;r<o.length;r++){var a=o[r],l=this._model.getWorldMatrix(a.ids),d=s.clone();if(void 0!==t.localMatrix&&d.applyProjection(t.localMatrix),d.applyProjection(l),d){(g=e.clone(t)).instanceId=5*(this._instanceId+1),this._instanceId++,g.position=d,g.path=[];for(var h=0;h<a.ids.length;h++)g.path.push(a.ids[h]);this._pois.push(g)}}}else this._poisToLoadMap.set(t.resourceids[i],t.resourceids[i])}else if(this.isRegistered(t.resourceid)){if((o=this.getIdPathesLeadingToReference(t.resourceid))&&null!==(_=this.getReferenceBoundingBox(t.resourceid)))for(s=new n.Vector3((_.min.x+_.max.x)/2,(_.min.y+_.max.y)/2,(_.min.z+_.max.z)/2),r=0;r<o.length;r++){a=o[r],l=this._model.getWorldMatrix(a.ids),d=s.clone();if(void 0!==t.localMatrix&&d.applyProjection(t.localMatrix),d.applyProjection(l),d){(g=e.clone(t)).instanceId=5*(this._instanceId+1),this._instanceId++,g.position=d,g.path=[];for(h=0;h<a.ids.length;h++)g.path.push(a.ids[h]);this._pois.push(g)}}}else this._poisToLoadMap.set(t.resourceid,t.resourceid);else if(void 0!==t&&(t.path||t.pathes))if(t.pathes&&t.pathes.length>0)for(var c=0;c<t.pathes.length;c++){var p=t.pathes[c];if(p&&p.length){var u=!1;for(r=0;r<p.length;r++)if(!this.isRegistered(p[r])){u=!0;break}if(u)this._poisToLoadMap.set(p[p.length-1],p[p.length-1]);else if(null!==(_=this.getReferenceBoundingBox(p[p.length-1]))){var g;l=this._model.getWorldMatrix(p),d=new n.Vector3((_.min.x+_.max.x)/2,(_.min.y+_.max.y)/2,(_.min.z+_.max.z)/2);if(void 0!==t.localMatrix&&d.applyProjection(t.localMatrix),d.applyProjection(l),d)(g=e.clone(t)).instanceId=5*(this._instanceId+1),this._instanceId++,g.path=p,g.position=d,this._pois.push(g)}}}else{var _;for(u=!1,r=0;r<t.path.length;r++)if(!this.isRegistered(t.path[r])){u=!0;break}if(u)this._poisToLoadMap.set(t.path[t.path.length-1],t.path[t.path.length-1]);else if(null!==(_=this.getReferenceBoundingBox(t.path[t.path.length-1]))){l=this._model.getWorldMatrix(t.path),d=new n.Vector3((_.min.x+_.max.x)/2,(_.min.y+_.max.y)/2,(_.min.z+_.max.z)/2);void 0!==t.localMatrix&&d.applyProjection(t.localMatrix),d.applyProjection(l),d&&(t.position=d,t.instanceId=5*(this._instanceId+1),this._instanceId++,this._pois.push(t))}}else void 0!==t&&t.position&&(t.instanceId=5*(this._instanceId+1),this._instanceId++,this._pois.push(t))},_addCSO:function(){for(var e=null,t=a.get(),i=0;i<t.length;i++)if(t[i].pathElement)for(var o=t[i].pathElement.externalPath,n=0;n<o.length-1;n++)"PAD3DPOINode"===o[n].className&&(o[n+1]&&o[n+1].name&&-1===o[n+1].name.indexOf("PAD3DPOINode")?e=o[n+1].name:o[n+1]&&o[n+1].name&&o[n].name&&-1===o[n].name.indexOf("PAD3DPOINode")&&(e=o[n].name));if(this._selectedLayer||e){var s=this._layers.get("POIs"),r=null;r=!this._selectedLayer&&this._layers.get("POIs")?e:this._selectedLayer,(!S.isClusteringEnabled()||s&&s.size>0&&r&&this._layers.get("POIs").get(r)&&this._layers.get("POIs").get(r).isClustered&&!this._layers.get("POIs").get(r).isClustered())&&!this.isPoIUICustomized?this._drawHighlightInstance("add"):this._drawHighlight("add")}else this._whiteListPOI&&this._whiteListPOI.clear()},_removeCSO:function(){for(var e=null,t=a.get(),i=0;i<t.length;i++)for(var o=t[i].pathElement.externalPath,n=0;n<o.length-1;n++)"PAD3DPOINode"===o[n].className&&(o[n+1]&&isNaN(o[n+1].name)&&-1===o[n+1].name.indexOf("PAD3DPOINode")?e=o[n+1].name:o[n+1]&&isNaN(o[n+1].name)&&(e=o[n].name));if(this._selectedLayer||e){var s=this._layers.get("POIs"),r=null;r=!this._selectedLayer&&this._layers.get("POIs")?e:this._selectedLayer,(!S.isClusteringEnabled()||s&&s.size>0&&r&&this._layers.get("POIs").get(r)&&this._layers.get("POIs").get(r).isClustered&&!this._layers.get("POIs").get(r).isClustered())&&!this.isPoIUICustomized?this._drawHighlightInstance("remove"):this._drawHighlight("remove")}},_emptyCSO:function(){for(var e=null,t=a.get(),i=0;i<t.length;i++)for(var o=t[i].pathElement.externalPath,n=0;n<o.length-1;n++)"PAD3DPOINode"===o[n].className&&(o[n+1]&&isNaN(o[n+1].name)&&-1===o[n+1].name.indexOf("PAD3DPOINode")?e=o[n+1].name:o[n+1]&&isNaN(o[n+1].name)&&(e=o[n].name));var s=this._layers.get("POIs"),r=null;r=!this._selectedLayer&&this._layers.get("POIs")?e:this._selectedLayer,(!S.isClusteringEnabled()||s&&s.size>0&&r&&this._layers.get("POIs").get(r)&&this._layers.get("POIs").get(r).isClustered&&!this._layers.get("POIs").get(r).isClustered())&&!this.isPoIUICustomized?this._drawHighlightInstance("empty"):this._drawHighlight("empty")},_drawHighlightInstance:function(e){this._selectedPOI&&this._selectedPOI.length},_drawHighlight:function(e){if(S.isMemPCS()&&(this._bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight=!1,"add"===e||(this._doNotInvokePOIClusterUpdate=!1)),this._selectedPOI&&this._selectedPOI.length>0){for(var t=0;t<this._selectedPOI.length;++t)this._selectedPOI[t].node?(this._selectedPOI[t].node.setHighlight(!1),this._whiteListPOI&&this._whiteListPOI.clear()):this._selectedPOI[t].instanceId&&this._whiteListPOI&&this._whiteListPOI.clear();this._selectedPOI=[],this._whiteListPOI&&S.isMemPCS()&&this._selectedPOI&&this._selectedPOI.length>0&&(this._selectedPOI.length===this._whiteListPOI.size?this._bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight=!0:this._bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight=!1)}var i=a.get();if(!1===S.isMemPCS())for(t=0;t<i.length;t++)if(i[t].pathElement&&i[t].pathElement.externalPath)for(var o=i[t].pathElement.externalPath,n=0;n<o.length;n++)if("PAD3DPOINode"===o[n].className){var s=o[n].name,r=null;if(o[n+1]&&o[n+1].name&&isNaN(o[n+1].name)&&(r=parseInt(o[n+1].name.replace("PAD3DPOINode_",""))),r&&s){var l=this._layerPOIsIdInstancingNodeMap.get(s).get(r);this._layerPOIsIdInstancingIndexMap.get(s).get(r);this._whiteListPOI.set(s+"_"+r,l),l&&(this._selectedPOI.push({id:r,node:l,path:i[t].pathElement}),this._selectedLayer=s)}}if(S.isMemPCS())if(this._bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight&&this._selectedPOI.length===this._whiteListPOI.size);else for(t=0;t<i.length;t++)if(i[t].pathElement&&i[t].pathElement.externalPath)for(o=i[t].pathElement.externalPath,n=0;n<o.length;n++)if("PAD3DPOINode"===o[n].className){s=o[n].name,r=null;if(o[n+1]&&o[n+1].name&&isNaN(o[n+1].name)&&(r=parseInt(o[n+1].name.replace("PAD3DPOINode_",""))),r&&s){l=this._layerPOIsIdInstancingNodeMap.get(s).get(r),this._layerPOIsIdInstancingIndexMap.get(s).get(r);this._whiteListPOI.set(s+"_"+r,l),l&&(this._selectedPOI.push({id:r,node:l,path:i[t].pathElement}),this._selectedLayer=s)}}this._whiteListPOI&&S.isMemPCS()&&this._selectedPOI&&this._selectedPOI.length>0&&(this._selectedPOI.length===this._whiteListPOI.size?this._bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight=!0:this._bNoNeedToProcessFurther_KPICntrl_3724_drawHighlight=!1),this._context.getViewer().render()},_onHoverInstanceCallback:function(e){this._i_onHoverInstancingPOI_active=1;for(var t=e.intersection.path,i=0;i<t.length;i++)if(t[i].externalPath){for(var o=t[i].externalPath,n=!1,s=0;s<o.length-1;s++)if(o[s].className&&"PAD3DPOINode"===o[s].className){var r;this._tooltipNodes&&this._tooltipNodes.removeChildren(),clearTimeout(this._tokenTimeout),n=!0;var a,l,h=o[s].name;o[s+1].name;if(""===h||null==h)h=o[s+1].name;if(r=t[i].instanceId,1===o[s].children.length&&this._layer_instancing_to_visible_for_Hover.has(h)){var c=this._layerPOIsIdInstancingIndexMap.get(h),p=0;if(this._layers.get("POIs").get(h).getNode3DBag().children.length>1&&(p=this._layers.get("POIs").get(h).getNode3DBag().children[1].children.length),p>0){var u=this._layer_instancing_to_visible_for_Hover.get(h),g=!0;u.forEach(function(e,t){-1==e&&(g=!1)});var _=this._layerPOIsIdInstancingIndexMap.get(h).size;if(!0===g&&_>0&&u.size===_){var f=new Map;this._layer_instancing_to_visible_for_Hover.set(h,f);var v=this._layerVisibleInstancingPOIs.get(h),m=[],b=0;v.forEach(function(e,t){m[b]=t,b++});var y=0,P=new Map;c.forEach(function(e,t){var i=-1;y<b&&(i=m[y]),P.set(t,i),y++}),this._layer_instancing_to_visible_for_Hover.set(h,P)}}var D=this._layer_instancing_to_visible_for_Hover.get(h);if(D&&D.has(r)){var I=D.get(r);I>-1&&(r=I)}}if(h){var S=this._tooltipNodesPinnedMap.get(h);if(S&&S.has(r)){var C=S.get(r);C._POIObject.instanceId&&t[i].instanceId&&t[i].instanceId===C._POIObject.instanceId&&(a=C)}}if(this._cleanHoverTooltip(),a)l=a;else if(this._layerPOIsIdInstancingNodeMap&&this._layerPOIsIdInstancingNodeMap.get(h)&&(this._tooltipNodesPinnedMap&&this._tooltipNodesPinnedMap.get(h)&&!this._tooltipNodesPinnedMap.get(h).has(r)||!this._tooltipNodesPinnedMap.get(h))){var w=this._layerPOIsIdInstancingNodeMap.get(h).get(r);if(w){var x,O;"ZOI"===(x=this._layerTypeOfNode(w,h))&&(O="ZOI");l=this._createHoverTooltip(w,x,O,h,this,!0)}}l&&(this._bHoverOverPOIHoverTooltip=!0,this._preselectedSinglePOIHoverNode=l),l&&w&&this._tooltipNodesMap.set(r+h,{hoverNode:l,poiNode:w})}n||this._cleanHoverTooltip()}var A=d.getPADTracker({eventCategory:"usage",eventAction:"3d_Hoverover_stats"});A.persDim.pd2="Instancing POI",A.trackPageEvent(),this._context.getViewer().render()},_outHoverInstanceCallback:function(e){this._i_onHoverInstancingPOI_active=0;this._tokenTimeout=setTimeout(function(){this._onHoverGroupEmpty(),this._context.getViewer().render()}.bind(this),1500)},_loadPOI:function(e){if(e.length>0){var t=this.getRoots(),o=[],n=this,s=[],r="physicalid:"+e.join(" OR physicalid:"),a=i.getPromises().slice();if(t.length>0)for(var l=0;l<t.length;l++)o.push(i.createPromise(function(e,i){var o={cancelable:!1,forceIndex:!0,find_in_context_physicalid:r,path:[c.getNodeID(t[l])],parent:n._model.getRootBag(),sequence_filter:n._model.getRoot({id:c.getNodeID(t[l])}).getSequenceFilter(),configBin:n._model.getRoot({id:c.getNodeID(t[l])}).getConfigFilter(),CVQuery3D:n._model.getRoot({id:c.getNodeID(t[l])}).getCVFilterQuery(),resolve:e,intent:"searchInDsBoard",progressiveExpand:!1,expand_iter:"-1",forceLoad:!1,max_count_path:(10*n.max_path).toString(),onComplete:function(t){for(var i=[],o=[],s=new Map,r=0;r<t.selectedPaths.length;r++)o.push(t.selectedPaths[r]),s.set(t.selectedPaths[r][t.selectedPaths[r].length-1],t.selectedPaths[r][t.selectedPaths[r].length-1]);if(s.forEach(function(e,t){i.push(e)}),n._POIsDescriptionMap&&n._POIsDescriptionMap.referencePOIs)for(var a=0;a<i.length;a++)n._POIsDescriptionMap.referencePOIs.forEach(function(e){i[a]===e.resourceid&&n._drawPOIWithDynamicLoading(e)}),n._POIsDescriptionMap.pathPOIs.forEach(function(e){i[a]===e.path[e.path.length-1]&&n._drawPOIWithDynamicLoading(e)});e&&e(o),n._loadingQueue.length?n._processLoadingQueue():n.publish({event:"onComplete",data:{reframe:!1}})},onFailure:function(t){n.publish({event:"onLoadPOIFailure",data:t}),e&&e(),n._loadingQueue.length?n._processLoadingQueue():n.publish({event:"onComplete",data:{reframe:!1}})},onTimeout:function(t){n.publish({event:"onLoadPOIFailure",data:t}),e&&e(),n._loadingQueue.length?n._processLoadingQueue():n.publish({event:"onComplete",data:{reframe:!1}})}};s.push(o)},"loadPOI"));return Promise.all(a).then(function(e){a=null;for(var t=0;t<s.length;t++){var i=s[t];n._loadingQueue.push(i)}n._processLoadingQueue()}),o}}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerR2VController",["UWA/Class","DS/PADUtils/PADPromise","DS/PADServices/ws/WSAccess","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,o,n,s,r,a){"use strict";return e.extend({addR2Vs:function(e){return new Promise(function(e,i,n){let s=t.getPromises().slice();const r=[],a=[],l={R2Vs:[],tenant:o.getPlatformId()};for(let t=0;t<e.objects.length;++t){const i=this._addR2V({r2vToLoad:e.objects[t],fromId:e.fromId,intent:e.intent,stack:a,displayNotif:e.displayNotif,reframe:e.reframe,fromTimeline:e.fromTimeline}).then(()=>{this._loadingQueue.length&&this._processLoadingQueue()});r.push(i),l.R2Vs.push({objectId:e.objects[t].objectId,serviceId:e.objects[t].serviceId,objectType:e.objects[t].objectType})}Promise.all(s).then(function(e,t){s=null;for(let t=0;t<e.length;++t){const i=e[t];let o=!1;const n=this._model.getRootLog();for(let e=0;e<n.length;++e){const t=n[e];if(1===t.length&&t[0]===i.objectId){o=!0;break}}o?(this.publish({event:"onRootAlreadyExisting",data:{id:i.objectId}}),i.resolve()):this._loadingQueue.push(i)}this._isLoadingR2V=!0,this._processLoadingQueue()}.bind(this,a)),Promise.all(r).then(e=>{e.isSoi||(this.publish({event:"onComplete",data:{intend:"addRoot"}}),this.publish({event:"onRootAdditionTransactionComplete",data:{loadWithFilter:!1}})),i()}),e.dispatch&&this._commandProxy.drop(l)}.bind(this,e))},_addR2V:function(e){return t.createPromise(function(e,t,i){e.stack.push({objectId:e.r2vToLoad.objectId,objectType:e.r2vToLoad.objectType,displayType:e.r2vToLoad.displayType,displayName:e.r2vToLoad.displayName,soIdisplayName:e.r2vToLoad.soIdisplayName,serviceId:e.r2vToLoad.serviceId,fromId:e.fromId,intent:e.intent,reframe:e.reframe,fromTimeline:e.r2vToLoad.fromTimeline,resolve:t,reject:i,onComplete:function(e){this.declareUnsupportedRoot(e.r2vToLoad.objectId),!0===e.r2vToLoad.fromTimeline&&this.publish({event:"onRootAdded",data:{fromLoadJSON:!1,rootLog:this._model.getRootLog(),isFiltered:!1,id:e.r2vToLoad.objectId,idPath:[e.r2vToLoad.objectId],displayNotif:e.displayNotif,reframe:e.reframe,inContext:!1,hidden:!1,BS:null,orientation:null,serviceId:e.r2vToLoad.serviceId,soiId:e.r2vToLoad.soiId}}),t(e.isSoi)}.bind(this,e),onFailure:function(t){let o={message:r.generic_service_failure,displayNotif:"UNSUPPORTED_TYPE"!==t.message&&e.displayNotif};t.message&&(o=t),this.publish({event:"onLoadingFailure",data:o}),this._isLoadingR2V=!1,i()}.bind(this),onTimeout:function(){this.publish({event:"onLoadingFailure",data:{message:s.timeout,displayNotif:e.displayNotif}}),this._isLoadingR2V=!1,i()}.bind(this)})}.bind(this,e),"addRoot")},_loadR2V:function(e){const t=()=>{this._startAsync(),i.getR2VAssets({objectId:e.objectId,serviceId:e.serviceId}).then(t=>{this._stopAsync();try{"string"==typeof t?JSON.parse(t):t}catch(t){return void e.onFailure("PARSING_FAILED")}this._model._buildR2VFromJSON({objectId:e.objectId,serviceId:e.serviceId,objectType:e.objectType,displayType:e.displayType,fromId:e.fromId,intent:e.intent,callbacks:{onComplete:function(){this._fillRootStats({serviceId:e.serviceId,data:{rootPhID:e.objectId},FBIProxy:this._BIProxy._biFilter},function(){},{},{results:[{resourceid:e.objectId,"ds6w:label":e.soIdisplayName},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]}),this._rootIds.push(e.objectId),this._model.addToRootLog([e.objectId]),e.onComplete()}.bind(this),onRootLoaded:function(t){t.rootPhID=e.objectId,!0===e.reframe&&this.publish({event:"onReframe",data:t}),this._isLoadingR2V=!1,this.publish({event:"onR2VLoaded",data:t})}.bind(this),onRootRemoved:function(t){"replaceRoot"===e.intent&&this.removeRoots({intent:e.intent,pids:[e.fromId],fromTimeline:!0},!1,!1)}.bind(this)}})}).catch(t=>{this._stopAsync(),"TIMEOUT"===t?e.onTimeout():e.onFailure("QUERY_FAILED")})},o=t=>{this._startAsync(),i.getSoI({objectId:t&&t.soiId?t.soiId:e.objectId,serviceId:e.serviceId}).then(o=>{var r={reframe:e.reframe,serviceId:e.serviceId,soiData:o.result[0]||o.result,selectedState:-1,states:[]};i.getFeatureStatesFromSOI({objectId:t&&t.soiId?t.soiId:e.objectId,serviceId:e.serviceId,isFork:t?t.isFork:!!e&&e.isFork}).then(i=>{this._stopAsync();for(let e=i.result.length-1;e>=0;--e)"IN_WORK"===i.result[e].status&&i.result.splice(e,1);var o=-1;for(let e=0;e<i.result.length;++e)"RELEASE"!==i.result[e].status&&"FROZEN"!==i.result[e].status||(t&&i.result[e].resourceid===t.selectedStateId&&(o=e),r.states.push(i.result[e]));void 0!==o&&o>=0&&o<r.states.length?r.selectedState=o:r.selectedState=r.states.length-1,r.states.length>0?"wafr"===n.getSetting("eno3dviewer_infrastructure_version")?this.publish({event:"onRealAssetLoaded",data:{callback:()=>{this.publish({event:"onSOIDropped",data:r}),e.onComplete({isSoi:!0})}}}):(this.publish({event:"onSOIDropped",data:r}),e.onComplete({isSoi:!0})):(this._stopAsync(),e.onFailure({message:s.replace(s.noLocState,{soiName:r.soiData["ds6w:label"]}),displayNotif:!0}))}).catch(t=>{this._stopAsync(),"TIMEOUT"===t?e.onTimeout():e.onFailure("QUERY_FAILED")})}).catch(t=>{e.onFailure("QUERY_FAILED")})},r=t=>{var i={reframe:e.reframe,serviceId:e.serviceId,soiData:t.subChain[0],selectedState:-1,states:[]},o=-1;for(let e=0;e<t.subChain.length;++e)"RELEASE"!==t.subChain[e].status&&"FROZEN"!==t.subChain[e].status||(t&&t.subChain[e].resourceid===t.selectedStateId&&(o=e),i.states.push(t.subChain[e]));void 0!==o&&o>=0&&o<i.states.length?i.selectedState=o:i.selectedState=i.states.length-1,i.states.length>0?"wafr"===n.getSetting("eno3dviewer_infrastructure_version")?this.publish({event:"onRealAssetLoaded",data:{callback:()=>{this.publish({event:"onSOIDropped",data:i}),e.onComplete({isSoi:!0})}}}):(this.publish({event:"onSOIDropped",data:i}),e.onComplete({isSoi:!0})):(this._stopAsync(),e.onFailure({message:s.replace(s.noLocState,{soiName:i.soiData["ds6w:label"]}),displayNotif:!0}))},a=async t=>new Promise((o,n)=>{let s=[t];i.getFeatureState({objectId:e.objectId,serviceId:e.serviceId,isFork:!!t&&t.isFork}).then(e=>{s=s.concat(e.result);let i={selectedStateId:t.resourceid,soiId:t.featureOfInterestId,subChain:s};r(i)}).catch(t=>{"TIMEOUT"===t?e.onTimeout():e.onFailure("QUERY_FAILED"),n()})});"R2V_FeatureOfInterest"===e.objectType?o():!0===e.fromTimeline?t():(async()=>new Promise((t,o)=>{i.getFeatureState({objectId:e.objectId,serviceId:e.serviceId}).then(e=>{!0===e.result.isFork?a(e.result):t(e.result)}).catch(t=>{"TIMEOUT"===t?e.onTimeout():e.onFailure("QUERY_FAILED"),o()})}))().then(t=>{let i={selectedStateId:e.objectId,soiId:t.featureOfInterestId,isFork:!!t&&t.isFork};o(i)}).catch(()=>{})},has360:function(e){var t=!1,i=this._getContentTypes(e);return i&&i.length&&i.length>0&&(t=i.includes("360")),t},_getContentTypes:function(e){return this._model.getContentTypes(e)}})}),define("DS/ENOPAD3DViewer/views/PAD3DSOITimelineView",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADServices/utils/PlatformURL","DS/PADServices/utils/GlobalUtils","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],function(e,t,i,o,n,s,r){"use strict";return{_isSoIUsable:!0,_updatedVP:null,_soiList:[],_visibility:!0,toggleSOITimelinesUsability:function(e){if(this._loadedSoI){let t=Object.keys(this._loadedSoI);if(t)for(let i=0;i<t.length;i++)e?this._loadedSoI[t[i]].enableTimeline():this._loadedSoI[t[i]].disableTimeline();this._isSoIUsable=!!e}},_initSOITimelineView:function(){this._loadedSoI={},this.subscribe({event:"onSOIDropped"},this._onSOIDropped.bind(this)),this.subscribe({event:"onR2VLoaded"},this._onR2VLoaded.bind(this)),this.getViewer().onStart360Mode(function(){this.getController()._requesting360Mode=!1,this._on360ModeChanged({state:!0})}.bind(this)),this.getViewer().onEnd360Mode(function(){this.getController()._requesting360Mode=!1,this._on360ModeChanged({state:!1})}.bind(this))},_onR2VLoaded:function(t){if(t&&t.contentTypes&&(t.contentTypes.length,1)&&t.contentTypes.includes("360")){if((d=(a=Object.keys(this._loadedSoI)).length)>0&&d<=1){for(l=0;l<d;l++)for(var i=this._loadedSoI[a[l]],o=0;o<i.options.data.states.length;o++)if(t.rootPhID===i.options.data.states[o].resourceid){if("afr"===n.getSetting("eno3dviewer_infrastructure_version")){var s=d<=1;this._loadedSoI[a[l]].has360=!0,this._loadedSoI[a[l]].toggle360ModeAvailability(s);!1===this._loadedSoI[a[l]].toggle360Mode(s,{BSCenter:this._updatedVP?this._updatedVP:t.BS.center})&&this._applyPhoto360({checkFlag:s,BSCenter:this._loadedSoI[a[l]]._BSCenter})}else{this.enableCheck("ENO3DTogglePhoto360ModeChk");var r=null===window.localStorage.getItem("SoITimeline360ModeState")||JSON.parse(window.localStorage.getItem("SoITimeline360ModeState"));r&&(this.getCommandHandler().getCheckState({id:"ENO3DTogglePhoto360ModeChk"})?this._applyPhoto360FromCmd({action:r}):this.getCommandHandler().setCheckState({id:"ENO3DTogglePhoto360ModeChk",state:!0,args:{autoSwitch:!0}}))}break}}else"afr"===n.getSetting("eno3dviewer_infrastructure_version")?this._applyPhoto360({checkFlag:!1,BSCenter:this._loadedSoI[a[l]]._BSCenter}):(this.disableCheck("ENO3DTogglePhoto360ModeChk"),this._applyPhoto360FromCmd({action:!1}));this._visuEventOnEndMove||require(["DS/CoreEvents/Events"],function(e){this._visuEventOnEndMove=e.subscribe({event:"/VISU/"},function(e){switch(e.eventType){case"@onViewpointChange":this._realMove=!0;break;case"@onViewpointEndMove":case"@onViewpointEndMove_bis":if(this._realMove){this._realMove=!1;var t,i=this.getViewpoint().camera.position,o=Object.keys(this._loadedSoI),n=o.length;for(t=0;t<n;t++){this._loadedSoI[o[t]].updateBS({BSCenter:i}),this._updatedVP=i}}}}.bind(this))}.bind(this))}else if(this.displayNotification({eventID:"info",title:e.mode360DisabledDueToNo360Content.title,subtitle:e.mode360DisabledDueToNo360Content.subtitle,msg:e.mode360DisabledDueToNo360Content.message}),"afr"===n.getSetting("eno3dviewer_infrastructure_version")){var a,l,d=(a=Object.keys(this._loadedSoI)).length;for(l=0;l<d;l++)for(i=this._loadedSoI[a[l]],o=0;o<i.options.data.states.length;o++)if(t.rootPhID===i.options.data.states[o].resourceid){this._loadedSoI[a[l]].toggle360ModeAvailability(!1);break}}else this.disableCheck("ENO3DTogglePhoto360ModeChk")},_on360ModeChanged:function(e){var t,i=Object.keys(this._loadedSoI),o=i.length;for(t=0;t<o;t++)this._loadedSoI[i[t]].setSplattingFactorAvailability(e.state)},__togglePhoto360CommandStates:function(e){var t=this.getCommandContext();null!=t&&require(["DS/ApplicationFrame/CommandsManager"],function(e){for(var i=["RevealDocuments","PAD3DViewerRelationalNavigatorHdr"],o=0;o<i.length;++o){var n=e.getCommand(i[o],t);n&&n._checkAvailability()}}.bind(this))},_onSOIDropped:function(e){require(["DS/PADServices/views/private/SoITimeline"],t=>{var i=Object.keys(this._loadedSoI).length,o=this.getViewer().get360Mode();i>0&&!0===o&&(o=!1),this._loadedSoI[e.soiData.resourceid]?this._loadedSoI[e.soiData.resourceid].setActiveState(e.selectedState,!1,!0):(this._soiList.push(e.soiData.resourceid),this._loadedSoI[e.soiData.resourceid]=new t({immersiveFrame:this.getFrameWindow().getImmersiveFrame(),loadedStateIdx:e.selectedState,mode360Activated:o,BSCenter:new s.Vector3(0,0,0),visibility:this._visibility,data:e,events:{stateStopClicked:this.__stateStopClicked.bind(this),closeTimeline:e=>{delete this._loadedSoI[e];const t=this._soiList.indexOf(e);this._soiList.splice(t,1)},on360ModeChangedCB:e=>{this._applyPhoto360(e)},onSplattingChangedCB:e=>{this.getController()._model._OOCManager.setSplattingParameters&&(this.getController()._model._OOCManager.setSplattingParameters({splattingFactor:.8*e.value,minSize:2*e.value}),this.getViewer().render())}}}),this._soiList.length>1&&this._loadedSoI[this._soiList[this._soiList.length-1]]&&this._loadedSoI[this._soiList[this._soiList.length-2]]&&this._loadedSoI[this._soiList[this._soiList.length-1]].elements.panel.attachToWindow(this._loadedSoI[this._soiList[this._soiList.length-2]].elements.panel,WUXSnapAreaEnum.InsideArea,"after")),this.getCommandHandler&&this.toggleSOITimelinesVisibility(this.getCommandHandler().getCheckState({id:"ENO3DToggleTimelineViewChk"})?"show":"hide")});let t=this.subscribe({event:"onRootRemoved"},e=>{let i=Object.keys(this._loadedSoI);for(let t=0;t<i.length;t++)this._loadedSoI[i[t]].getActiveStateId()===e.id&&this._loadedSoI[i[t]].close(e.id);1===(i=Object.keys(this._loadedSoI)).length&&!0===this._loadedSoI[i[0]].has360&&this._loadedSoI[i[0]].toggle360ModeAvailability(!0),0===Object.keys(this._loadedSoI)&&this.unsubscribe(t)}),i=this.subscribe({event:"onLoadingFailure"},e=>{let t=Object.keys(this._loadedSoI);for(let e=0;e<t.length;e++)this._loadedSoI[t[e]].close(t[e]),this._loadedSoI[t[e]].endStateLoadingTransaction();0===Object.keys(this._loadedSoI)&&this.unsubscribe(i)})},_applyPhoto360:function(e){this.getController()._requesting360Mode=!0,this.getViewer().request360Mode(e.checkFlag,{position:e.BSCenter}),this.__togglePhoto360CommandStates(e.checkFlag)},_applyPhoto360FromCmd:function(e){var i=this.getRoots();let o=0;var n=null;for(let e=0;e<i.length;++e){var s=t.getNodeID(i[e]);t.isTileSetNode(i[e])&&this.getController().getRootStats(s)&&"r2vsurvey"===this.getController().getRootStats(s).serviceId&&1===++o&&(n=this.getController().getReferenceBoundingSphere(s))}(e.action&&1===o&&n||!e.action)&&n&&(this.getController()._requesting360Mode=!0,this.getViewer().request360Mode(e.action,{position:this._updatedVP?this._updatedVP:n.center}))},set360Mode:function(e){this.getController()._requesting360Mode=!0,this.getViewer().request360Mode(e.checkFlag,{position:e.BSCenter?e.BSCenter:this.getViewer().currentViewpoint.getEyePosition()}),this.__togglePhoto360CommandStates(e.checkFlag);let t=Object.keys(this._loadedSoI);if(t)for(let i=0;i<t.length;i++)!0!==e.checkFlag&&!1!==e.checkFlag||this._loadedSoI[t[i]].setToggleValue(e.checkFlag)},toggleSOITimelinesVisibility:function(e){let t=Object.keys(this._loadedSoI);for(let i=0;i<t.length;i++)"show"===e?(require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DSOITimelineViewShow"}),t.trackPageEvent()}),this._visibility=!0,this._loadedSoI[t[i]]._visibility||this._loadedSoI[t[i]].show()):"hide"===e&&(this._visibility=!1,this._loadedSoI[t[i]]._visibility&&this._loadedSoI[t[i]].hide(),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DSOITimelineViewHide"}),t.trackPageEvent()}))},_checkAll360Availability:function(){let t=Object.keys(this._loadedSoI);var i=t.length<=1;if(!1===i&&(this.displayNotification({eventID:"info",title:e.mode360DisabledDueToMultipleRoot.title,subtitle:e.mode360DisabledDueToMultipleRoot.subtitle,msg:e.mode360DisabledDueToMultipleRoot.message}),this.getController()._requesting360Mode=!0,this.getViewer().request360Mode(!1,{position:this.getViewer().currentViewpoint.getEyePosition()}),this.__togglePhoto360CommandStates(!1)),t&&!1===i)for(let e=0;e<t.length;e++)this._loadedSoI[t[e]].setToggleValue(!1),this._loadedSoI[t[e]].toggle360ModeAvailability(!1)},__stateStopClicked:function(e){if(!0===this._isSoIUsable){if(e&&e.previouslySelected&&require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DSOITimelineView"});t.setEventData({eventLabel:"ENO3DSOITimelineView-stateChanged"}),t.trackPageEvent()}),this.getViewer().get360Mode()&&e.previouslySelected){return new Promise(function(t){this.addR2Vs({objects:[e.stateData],fromId:e.previouslySelected,intent:"replaceRoot",reframe:!1,displayNotif:!0,dispatch:!1,fromTimeline:!0}).then(()=>{this._loadedSoI[e.stateData.soiId].endStateLoadingTransaction(e.stateData.objectId),t()})}.bind(this))}{let t=this.subscribe({event:"onR2VLoaded"},()=>{this.unsubscribe(t);let i=Promise.resolve();e.previouslySelected&&(i=this.fadeRootOut({pids:[e.previouslySelected],fromTimeline:!0})),i.then(()=>{this._loadedSoI[e.stateData.soiId].endStateLoadingTransaction(e.stateData.objectId)})}),i=this.subscribe({event:"onLoadingFailure"},()=>{this.unsubscribe(t),this.unsubscribe(i)});return this.addR2Vs({objects:[e.stateData],reframe:!0===e.reframe,displayNotif:!0,dispatch:!1,fromTimeline:!0})}}return Promise.resolve()},getSoIUsability:function(){return this._isSoIUsable}}}),define("DS/ENOPAD3DViewer/views/PAD3DLayerPanel",["DS/Windows/Panel","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/Controls/Accordeon","DS/Utilities/Utils","DS/PADServices/utils/PADTrackerManager","DS/ENOPAD3DViewer/views/PADLayerDefaultView","DS/ENOPAD3DViewer/views/PADLayerSearchView","DS/ENOPAD3DViewer/views/PAD3DLayerKindToolbar","DS/CoreEvents/ModelEvents","DS/PADUtils/PADContext"],function(e,t,i,o,n,s,r,a,l,d){"use strict";function h(e){this.options=e||{},this.elements={},this._context=d.get(),this.isMobileMode=!1,this._modelEvents=e.modelEvents?e.modelEvents:new l,this._selectedXSO=null,this._toolbar=null,navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&(this.isMobileMode=!0),this.options.mapKind={default:new s,search:new r},this.options.availableKindInAccordeon={},this.options.mapKindTokens=[],this._is_POI_accordion_Item_Expanded=!0,this._buildSkeleton()}return h.prototype._buildSkeleton=function(){this._buildContent(),this.options.panel=new e({title:t.PAD3DLayerPanel_title,header:this._toolbar.getContent(),identifier:"PAD3DLayerPanel",immersiveFrame:this.options.renderTo,content:this.elements.panelContent,resizableFlag:!0,width:335,height:"auto",minWidth:265,minHeight:300,allowedDockAreas:12,collapsibleFlag:!1,verticallyStretchableFlag:!this.isMobileMode,closeButtonFlag:!1}),this.options.panel.immersiveFrame.dockWindow(this.options.panel,8,{attachToOtherDockedWindow:!0}),this.isMobileMode?(this.options.panel.addEventListener("stopResize",this.updateHeight.bind(this)),this.options.panel.addEventListener("placeChange",this.updateHeight.bind(this))):(this.options.panel.addEventListener("stopResize",this.__updateExpanderHeight.bind(this)),this.options.panel.addEventListener("placeChange",this.__updateExpanderHeight.bind(this)),this.options.panel.addEventListener("dimensionsChanged",this.__updateExpanderProbe.bind(this),50),this.options.renderTo.addEventListener("freeZoneResize",o.debounce(function(){this.__updateExpanderHeight()}.bind(this),50)))},h.prototype._buildContent=function(){this._toolbar=new a({kind:"poi",modelEvents:this._mdlEvts}),this.elements.panelContent=UWA.createElement("div",{class:"PAD3DLayerPanel-main"}),this.elements.accordion=new i({style:"simple",exclusive:!1}),this._toolbar.isEmpty()||(this.elements.accordion.getContent().style.top="30px",this.elements.accordion.getContent().style.minWidth="251px",this._toolbar.subscribe({event:"PAD3DLayer/Toggle3DPOI"},function(e){"3D"===e.state?this._clusteringIsEditable=!1:this._clusteringIsEditable=!0}.bind(this)),this._toolbar.subscribe({event:"PAD3DLayer/ToolbarLegend"},function(e){null!=this._selectedXSO&&this._selectedXSO.selected&&this._selectedXSO.selected.toggleLegend({modelEvents:this.options.mapKind[this._selectedXSO.selected.options.kind].getModelEvents()})}.bind(this)),this._toolbar.subscribe({event:"PAD3DLayer/ToolbarRemove"},function(e){if(null!=this._selectedXSO&&this._selectedXSO.selected){this._selectedXSO.selected.options.onlyKind||this._context.getController().get3DLayerController().deleteLayer(this._selectedXSO.selected);var t=this._selectedXSO.selected.getKind(),i=null;if(this._idxKind>=0){var o=Object.keys(this.options.availableKindInAccordeon);o&&(o[this._idxKind]?i=o[this._idxKind]:o[this._idxKind-1]&&(i=o[this._idxKind-1]))}this.options.mapKind[t]&&(this.options.mapKind[t]._nbChildren>0&&!this._selectedXSO.selected.options.onlyKind?this.options.mapKind[i]&&this.options.mapKind[i].selectItemIdx&&this.options.mapKind[i].selectItemIdx(this._selectionIdx):this.options.mapKind[i]&&this.options.mapKind[i].selectItemIdx&&this.options.mapKind[i].selectItemIdx(0))}}.bind(this))),this.elements.accordion.getContent().addClassName("PAD3DLayerPanel-accordion"),this.elements.panelContent.appendChild(this.elements.accordion.getContent()),this.elements.panelMore=UWA.createElement("div",{class:"PAD3DLayerPanel-more"}),this.elements.panelContent.appendChild(this.elements.panelMore)},h.prototype.hide=function(){this.options.panel.hide()},h.prototype.show=function(){this.options.panel.show()},h.prototype.setCustomHeaderVisibility=function(e,t){this.options.mapKind[e]&&this.options.mapKind[e].getCustomHeader&&(this.options.mapKind[e].getCustomHeader().visibleFlag=t)},h.prototype.appendChild=function(e){var t=e.getKind();if(this.options.mapKind[t]?this.options.mapKind[t].addChild(e):(t="default",this.options.mapKind[t].addChild(e)),this.isMobileMode?this.updateHeight({kind:t}):this.__updateExpanderHeight(),void 0===this.options.availableKindInAccordeon[t]){this.elements.accordion.addItem({header:this.options.mapKind[t].getHeader(),icon:this.options.mapKind[t].getIcon(),body:this.options.mapKind[t].render(),customHeader:this.options.mapKind[t].getCustomHeader?this.options.mapKind[t].getCustomHeader():void 0,height:"auto",expandedFlag:!0});var i=this.elements.accordion.items.length-1;this.elements.accordion.items[i].kind=t,this.options.availableKindInAccordeon[t]=i,this.options.mapKindTokens[t]={},this.options.mapKindTokens[t].removeLayer=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/removeLayer"},function(e){var t=e.layerName;this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].hideMore),this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].showMore),this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].updateMore),this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].xsoPreAdd),this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].xsoRemove),this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].xsoEmpty),this.options.mapKind[t].getModelEvents().unsubscribe(this.options.mapKindTokens[t].removeLayer),this.elements.accordion.deleteItem(this.options.availableKindInAccordeon[t]),delete this.options.availableKindInAccordeon[t];for(var i=0;i<this.elements.accordion.items.length;i++)this.options.availableKindInAccordeon[this.elements.accordion.items[i].kind]=i;this.isMobileMode||this.__updateExpanderHeight(),0===this.elements.accordion.items.length&&this.options.panel.hide(),this.__hideMore()}.bind(this)),this.options.mapKindTokens[t].showMore=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/showMore"},this.__showMore.bind(this)),this.options.mapKindTokens[t].hideMore=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/hideMore"},this.__hideMore.bind(this)),this.options.mapKindTokens[t].updateMore=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/updateMore"},this.__updateMore.bind(this)),this.options.mapKindTokens[t].xsoPreAdd=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/xsoPreAdd"},this.__xsoPreAdd.bind(this)),this.options.mapKindTokens[t].xsoRemove=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/xsoRemove"},this.__xsoRemove.bind(this)),this.options.mapKindTokens[t].xsoEmpty=this.options.mapKind[t].getModelEvents().subscribe({event:"PAD3DLayer/xsoEmpty"},this.__xsoEmpty.bind(this)),this.isMobileMode?this.updateHeight({kind:t}):this.__updateExpanderHeight(),this.options.availableKindInAccordeon&&this.options.mapKind[t]&&this.options.mapKind[t].selectItemIdx&&(1===Object.keys(this.options.availableKindInAccordeon).length||e.options.onlyKind)&&this.options.mapKind[t].selectItemIdx(0)}this._toolbar&&this._toolbar.isEmpty()},h.prototype.removeChild=function(e){if(e){var t=e.getKind();this._idxKind=this.options.availableKindInAccordeon[t],t||(t="default"),e.options.onlyKind?this.removeAllInKind(t):this.removeKind(t,e)}},h.prototype.removeKind=function(e,t){this.options.mapKind[e]?(this.options.mapKind[e].getItemIdx&&(this._selectionIdx=this.options.mapKind[e].getItemIdx(t)),void 0!==this._selectionIdx&&this.options.mapKind[e].removeChild(t)):console.warn("Unknown kind ["+e+"]"),this.isMobileMode?this.updateHeight({kind:e}):this.__updateExpanderHeight()},h.prototype.removeAllInKind=function(e){this.options.mapKind[e]?this.options.mapKind[e].removeChildren():console.warn("Unknown kind ["+e+"]"),this.isMobileMode?this.updateHeight({kind:e}):this.__updateExpanderHeight()},h.prototype.updateHeight=function(e){var t,i,o=e?e.kind:void 0,n=0;if(o)t=this.elements.accordion.getExpanderFromIndex(this.options.availableKindInAccordeon[o]),this.options.mapKind[o]&&this.options.mapKind[o]._nbChildren&&(n=this.options.mapKind[o]._nbChildren),(i=100+40*n)<100&&(i=100),t&&t.body.setStyle("height",i);else for(var s=Object.keys(this.options.availableKindInAccordeon),r=0;r<s.length;r++)t=this.elements.accordion.getExpanderFromIndex(this.options.availableKindInAccordeon[s[r]]),this.options.mapKind[s[r]]&&this.options.mapKind[s[r]]._nbChildren&&(n=this.options.mapKind[s[r]]._nbChildren),(i=100+40*n)<100&&(i=100),t&&t.body.setStyle("height",i)},h.prototype.declareLayerKinds=function(e){var t=this;return new Promise(function(i,o){for(var n=[],s=0;s<e.length;s++)e[s].AMD&&n.push(e[s].AMD);require(n,function(){for(var e=arguments,o=0;o<e.length;o++)t.options.mapKind[e[o].layerName]||(t.options.mapKind[e[o].layerName]=new e[o]);i()})})},h.prototype.__updateExpanderHeight=function(){var e,t,i;e=Object.keys(this.options.availableKindInAccordeon);for(var o=0;o<e.length;o++)(t=this.elements.accordion.getExpanderFromIndex(this.options.availableKindInAccordeon[e[o]]))&&t.body&&((i=(this.options.mapKind[e[o]]&&this.options.mapKind[e[o]]._nbChildren?this.options.mapKind[e[o]]._nbChildren:0)*(this.options.mapKind[e[o]]&&this.options.mapKind[e[o]]._elementSize?this.options.mapKind[e[o]]._elementSize:39)+(this.options.mapKind[e[o]]&&this.options.mapKind[e[o]]._toolbarOffset?this.options.mapKind[e[o]]._toolbarOffset:0))<39&&(i=39),i<39?i=39:i>400&&"pointCloudClassification"!==e[o]&&(i=400),t.body.setStyle("height",i))},h.prototype.__updateExpanderProbe=function(){var e=0;this.elements&&this.elements.accordion&&this.elements.accordion._properties&&this.elements.accordion._properties.items&&this.elements.accordion._properties.items.value&&(e=this.elements.accordion._properties.items.value.length);for(var t=0;t<e;t++)if("POI"===this.elements.accordion._properties.items.value[t].header){for(var i=void 0,o=Object.keys(this.options.availableKindInAccordeon),s=0;s<o.length;s++){var r=this.elements.accordion.getExpanderFromIndex(this.options.availableKindInAccordeon[o[s]]);r&&"poi"===o[s]&&r._properties&&r._properties.expandedFlag&&(i=r._properties.expandedFlag.value)}if(i===this._is_POI_accordion_Item_Expanded&&!0===i);else if(i===this._is_POI_accordion_Item_Expanded&&!1===i);else if(!1===i||!0===i){var a=n.getPADTracker({eventCategory:"usage",eventAction:"3d_LayerPanel_POIExpander"});!0===i?(this._is_POI_accordion_Item_Expanded=!0,a.persDim.pd2="Expanded"):(this._is_POI_accordion_Item_Expanded=!1,a.persDim.pd2="Collapsed"),a.trackPageEvent()}}},h.prototype.__showMore=function(e){this.elements.panelMore.empty(),this.elements.panelContent.addClassName("showMore"),e.moreContent&&this.elements.panelMore.appendChild(e.moreContent)},h.prototype.__hideMore=function(e){this.elements.panelContent.removeClassName("showMore"),this.elements.panelMore.empty()},h.prototype.__updateMore=function(e){e.moreContent&&(this.elements.panelMore.empty(),this.elements.panelMore.appendChild(e.moreContent))},h.prototype.__xsoPreAdd=function(e){null!=this._selectedXSO&&this._selectedXSO.xso.empty(),this._selectedXSO=e,this._toolbar.xsoAdd(e)},h.prototype.__xsoRemove=function(e){this._toolbar.xsoRemove(e)},h.prototype.__xsoEmpty=function(e){this._selectedXSO=null},h}),define("DS/ENOPAD3DViewer/utils/PAD3DViewerDisplay3DVolume",["UWA/Core","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/ENOPAD3DViewer/views/PAD3DBoxNode","DS/ENOPAD3DViewer/views/PAD3DSphereNode","DS/ENOPAD3DViewer/views/PAD3DCylinderNode"],function(e,t,i,o,n,s,r,a){"use strict";var l=!1;function d(){return"object"==typeof d.instance?d.instance:(d.instance=this,this)}return d.prototype.isInitialized=function(){return l},d.prototype.initialize=function(){this._toAddCount=0,this._addedCount=0,this._context=t.get(),this._csoTokens=[],this._lastPickInfo=null,require(["DS/PADUtils/PADCommandProxy"],function(e){this._volumeCommandProxy=e.create({events:{onDisplay3DVolume:function(e){}.bind(this)}})}.bind(this)),this._abortCB=[],this._volumesParentNode=new o("3DVolumes"),this._volumes=new Map,this._executing=!1,l=!0},d.prototype.display3DVolume=function(e){var t=e;this._executing||(this._context.getDecorationBag().add(this._volumesParentNode),this._volumesParentNode.removeChildren(),this._abortCB.push(this._context.subscribe({event:"onRootRemoved"},function(e){this.abort()}.bind(this))),this._executing=!0),t.new?this.createVolume(t.new):t.edit?this.edit(t.edit):t.get?this.getParams(t.get):t.validate?this.validate(t.validate):t.delete?this.removeVolume(t.delete):t.end&&this.end()},d.prototype.execute=function(e){this.display3DVolume(e)},d.prototype.abort=function(){this._volumeCommandProxy.display3DVolume({abort:{}}),this.end()},d.prototype.end=function(){this._volumesParentNode.removeChildren();for(var e=0;e<this._abortCB.length;e++)this._context.unsubscribe(this._abortCB[e]);this._volumes.forEach(function(e){e.destroy()}.bind(this)),this._volumes.clear(),this._context.getDecorationBag().removeChild(this._volumesParentNode),this._executing=!1,"STOPPED",this._context.getViewer().render()},d.prototype.parametersChanged=function(e){this._volumeCommandProxy.display3DVolume({parametersChanged:e.params})},d.prototype.createVolume=function(e){if(!e||!e.id||!e.box&&!e.sphere&&!e.cylinder||!this._volumes||this._volumes.has(e.id))throw new Error("display3DVolume new: Wrong input parameters");var t=null;e.box?t=new s({id:e.id,type:"Box",fillColor:e.fillColor,borderColor:e.borderColor,editable:e.editable,min:e.box.min,max:e.box.max,cornerPoint:e.box.cornerPoint,axes:e.box.axes,matrix:e.box.matrix,parentNode:this._volumesParentNode,endManipulateCB:this.parametersChanged.bind(this)}):e.sphere?t=new r({id:e.id,type:"Sphere",fillColor:e.fillColor,borderColor:e.borderColor,editable:e.editable,center:e.sphere.center,radius:e.sphere.radius,parentNode:this._volumesParentNode,endManipulateCB:this.parametersChanged.bind(this)}):e.cylinder&&(t=new a({id:e.id,type:"Cylinder",fillColor:e.fillColor,borderColor:e.borderColor,editable:e.editable,heightVector:e.cylinder.heightVector,radius:e.cylinder.radius,bottomCenter:e.cylinder.bottomCenter,parentNode:this._volumesParentNode,endManipulateCB:this.parametersChanged.bind(this)})),t&&this._volumes.set(e.id,t)},d.prototype.validate=function(e){if(!e||!e.id)throw new Error("display3DVolume validate: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume validate: No volume with this ID");var t=this._volumes.get(e.id);if(t){var i=t.validate();this.parametersChanged({params:i})}},d.prototype.removeVolume=function(e){if(!e||!e.id)throw new Error("display3DVolume delete: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume delete: No volume with this ID");if(this._volumes){var t=this._volumes.get(e.id);t&&(this._volumes.delete(e.id),t.destroy(),t=null)}this._context.getViewer().render()},d.prototype.getParams=function(e){if(!e||!e.id||!this._volumes.has(e.id))throw new Error("display3DVolume get: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume get: No volume with this ID");var t=this._volumes.get(e.id);if(t){var i=t.getParameters();this.parametersChanged({params:i})}},d.prototype.edit=function(e){if(!e||!e.id||!e.box&&!e.sphere&&!e.cylinder)throw new Error("display3DVolume edit: Wrong input parameters");if(!this._volumes&&!this._volumes.has(e.id))throw new Error("display3DVolume edit: No volume with this ID");var t=this._volumes.get(e.id);if(t){e.box?t.setParameters({editable:e.editable,fillColor:e.fillColor,borderColor:e.borderColor,cornerPoint:e.box.cornerPoint,axes:e.box.axes,matrix:e.box.matrix,min:e.box.min,max:e.box.max}):e.sphere?t.setParameters({editable:e.editable,fillColor:e.fillColor,borderColor:e.borderColor,radius:e.sphere.radius,center:e.sphere.center}):e.cylinder&&t.setParameters({editable:e.editable,fillColor:e.fillColor,borderColor:e.borderColor,heightVector:e.cylinder.heightVector,radius:e.cylinder.radius,bottomCenter:e.cylinder.bottomCenter});var i=t.getParameters();this.parametersChanged({params:i})}},d.prototype.retrievePositionMatrix=function(e,t){var o=new i.Vector3(1,0,0).cross(e).normalize();this.colinear(new i.Vector3(1,0,0),o)&&(o=new i.Vector3(0,1,0).cross(e).normalize());var n=(new i.Vector3).copy(e),s=(new i.Vector3).copy(o).cross(n).normalize();n.applyAxisAngle(s,Math.PI);var r=new i.Matrix4,a=(new i.Vector3).copy(t),l=r.elements;return l[0]=o.x,l[1]=o.y,l[2]=o.z,l[4]=s.x,l[5]=s.y,l[6]=s.z,l[8]=n.x,l[9]=n.y,l[10]=n.z,r.setPosition(a),r},d.prototype.colinear=function(e,t){var o=(new i.Vector3).copy(e),n=(new i.Vector3).copy(t),s=o.cross(n).length();return 0===Math.round(100*s)},new d}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerRootStatsController",["UWA/Core","UWA/Class","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSession","DS/PADUtils/views/PADAlert","DS/PADServices/utils/PADTrackerManager","DS/Selection/CSOManager","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(e,t,i,o,n,s,r,a,l,d,h,c){"use strict";return t.extend({name:"_PAD3DViewerRootStatsController",_rootStatsMap:null,_rootRemovedToken:null,_elasticLoadingGranted:!1,_VISnVIORetrievedToken:null,initRootStatsController:function(){this._rootStatsMap=new Map,this._rootRemovedToken=this.subscribe({event:"onRootRemoved"},function(e){this._rootStatsMap&&this._rootStatsMap.delete(e.id)}.bind(this)),this._checkElasticLoadingAvailability(),this._VISnVIORetrievedToken=this._context.subscribe({event:"VISnVIOStatusRetrieved"},this._checkElasticLoadingAvailability.bind(this))},_checkElasticLoadingAvailability:function(){this._elasticLoadingGranted=!1;var e=n.getSetting("privateFlag_enopad3dviewer_onPremiseElasticLoading"),t=n.getSetting("enopad3dviewer_roles"),i=n.getSetting("enopad3dviewer_VISnVIOStatus");if(e){if(i)this._elasticLoadingGranted=!0;else if(t)for(var o=0;o<t.length;o++)if(("E19"===t[o].id||"InternalDS"===t[o].id)&&(!t[o].platforms||t[o].platforms&&t[o].platforms.indexOf(s.getPlatformId())>-1)){this._elasticLoadingGranted=!0;break}}else if(i)this._elasticLoadingGranted=!0;else if(t)for(o=0;o<t.length;o++)if("InternalDS"===t[o].id&&(!t[o].platforms||t[o].platforms&&t[o].platforms.indexOf(s.getPlatformId())>-1)){this._elasticLoadingGranted=!0;break}},disposeRootStatsController:function(){delete this._rootStatsMap,this._rootRemovedToken&&(this._rootRemovedToken=this.unsubscribe(this._rootRemovedToken),delete this._rootRemovedToken),this._VISnVIORetrievedToken&&this._context&&(this._context.unsubscribe(this._VISnVIORetrievedToken),delete this._VISnVIORetrievedToken)},fillRootStats:function(e,t){return new Promise(function(e,t,i,s){var r={readOnly:this.isReadOnly(),data:{rootPhID:e.data.rootPhID,root_path_physicalid:e.data.root_path_physicalid,select_bo:e.data.select_bo,select_rel:e.data.select_rel,compute_select_bo:e.data.compute_select_bo,get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0},maxLeaves:this.getFrustumVsAllThresholds().leaf+1,FBIProxy:e.FBIProxy,onComplete:this._fillRootStats.bind(this,e,i,t),onFailure:function(t){e.onFailure&&e.onFailure(t),i()}.bind(this),onTimeout:function(t){e.onTimeout&&e.onTimeout(t),i()}.bind(this)};r.data.select_bo.push("ds6w:label"),n.getSetting("supportWorldOrientation")&&r.data.select_bo.push("ds6wg:XCADOrientationExt.V_WorldOrientation"),this._runningQuery=o.getRootStats(r)}.bind(this,e,t))},getRootStats:function(e){return this._rootStatsMap.get(e)},computeGlobalStats:function(){var e={flat:0,occ:0,leaf:0};return this._rootStatsMap.forEach(function(t,i){e.flat+=t.size.flat,e.occ+=t.size.occ,e.leaf+=t.size.leaf}),e},isLargeSession:function(){var e=!1;if(this._elasticLoadingGranted){var t=this.getFrustumVsAllThresholds(),i=this.computeGlobalStats();(i.flat>t.flat||i.occ>t.occ||i.leaf>t.leaf)&&(e=!0)}return e},isLargeDataStructure:function(e){var t=!1;return this._elasticLoadingGranted&&(t=this._isLarge(e)),t},enforceDynamicLoading:function(t){if(this._elasticLoadingGranted&&!this._isAuthored()){var i=this._rootStatsMap.get(t);i.forceLDH=!0,i.pathesToExpand=e.clone(i.initialPathes)}else this.freezeRoot(t),this.publish({event:"onParsingInterruptedMemoryFull",data:{rootId:t}})},freezeRoot:function(e){this._model.freezeRoot(e)},getFrustumVsAllThresholds:function(){var e=n.getSetting("enopad3dviewer_frustumVsAllThreshold_flat"),t=n.getSetting("enopad3dviewer_frustumVsAllThreshold_occ"),i=n.getSetting("enopad3dviewer_frustumVsAllThreshold_leaf"),o=1,s=this._model.getConfig();return"medium"===s?o=.25:"restricted"===s&&(o=.1),{flat:e*o,occ:t*o,leaf:i*o}},_getStaticMappingExcludedOccurrences:function(e){return o.getStaticMappingExcludedOccurrences({serviceId:e.serviceId,enopad_webapis:!this._useWrap&&!this.isReadOnly(),withFrustumFilter:!1,data:{select_bo:["physicalid"],select_rel:["physicalid"],root_physicalid:e.data.rootPhID,rootPhID:e.data.rootPhID},expand3DType:this._useWrap?this._wait4Filter?"expand3D":"wrap":"expand3D",FBIProxy:this._BIProxy._biFilter,timeout:parseInt(n.getSetting("webapi_timeout")),onComplete:function(e,t){let i=null;try{i=JSON.parse(e),this.publish({event:"onExcludedOccurencesReceived",data:i})}catch(e){console.error(e)}}.bind(this),onFailure:function(){console.warn("Failed to retrieve static mapping information"),a.displayNotification({msg:c.staticMappingFailure,eventID:"warning"})},onTimeout:function(){console.warn("Timeout reached during static mapping information retrieval"),a.displayNotification({msg:c.staticMappingFailure,eventID:"warning"})}})},_isLarge:function(e){var t=!1;if(this._rootStatsMap.get(e)){var i=this.getFrustumVsAllThresholds(),o=this._rootStatsMap.get(e);(o.size.flat>i.flat||o.size.occ>i.occ||o.size.leaf>i.leaf||o.forceLDH)&&(t=!0)}return t},_fillRootStats:function(t,i,o,s){var a=this.getRootStats(t.data.rootPhID);!n.getSetting("enopad3dviewer_staticMappingSupportActivated")||"r2vsurvey"===t.serviceId||a||o.loadWithFilter||this._isAuthored()||this._getStaticMappingExcludedOccurrences(t);var d=t.data.root_path_physicalid?t.data.root_path_physicalid:t.data.root_physicalid?[[t.data.root_physicalid]]:[[t.data.rootPhID]];if(a?(a.initialPathes=a.initialPathes.concat(d),a.pathesToExpand=a.pathesToExpand.concat(d)):a={initialPathes:e.clone(d),pathesToExpand:e.clone(d),size:{flat:0,occ:0,leaf:0},serviceId:t.serviceId,forceLDH:!1},s&&"string"==typeof s)try{s=JSON.parse(s)}catch(e){return t.onFailure&&t.onFailure(),void i()}if(s.results&&s.results.length){var c=0,p=!1,u=null;for(c=0;c<s.results.length;c++){var g=s.results[c].synthesis,_=s.results[c].boundingbox,f=s.results[c].resourceid;g?"ProgressiveExpand_FlatSynthesis"===g.name?a.size.flat=g.value:"ProgressiveExpand_OccSynthesis"===g.name?a.size.occ=g.value:"ProgressiveExpand_LeafSynthesis"===g.name&&(a.size.leaf=g.value):f?(p=!0,a.label=s.results[c]["ds6w:label"]?s.results[c]["ds6w:label"]:""):_&&(u=_)}if(p){this._rootStatsMap.set(t.data.rootPhID,a),t.onComplete&&t.onComplete(s,u),"r2vsurvey"!==a.serviceId&&(0===a.size.flat||0===a.size.occ||0===a.size.leaf||t.data.fromLocalJSON?this.freezeRoot(t.data.rootPhID):(this.isLargeSession()&&(a.forceLDH=!0),this._model.declareTreeModified(t.data.rootPhID))),this.publish({event:"rootStatsRetrieved",data:a});var v=l.getPADTracker({eventCategory:"usage",eventAction:"synthesis"});if(v){let e=t.data.rootPhID,i=t.FBIProxy.HasFilter(e);v.addMultivaluedEventData("synthesis",{flatSynthesis:a.size.flat,occSynthesis:a.size.occ,leafSynthesis:a.size.leaf},{labelKey:a.label,txKey:e,filtered:i&&!0===i.hasFilter?"filtered":"noFilter"}),v.trackPageEvent()}else console.warn("tracker not defined")}else t.onFailure&&t.onFailure(s)}if(!s.infos||s.errors)if(s.errors&&s.errors.length){var m=!1;for(c=0;c<s.errors.length;c++){switch(s.errors[c].code){case"INVALID_ROOT":m=!0}}!this._isAuthored()&&!this.isReadOnly()&&o&&m?(this._stopAsync({userFeedback:o.userFeedback}),r.setAuthoringState(!0,h.PADSession_disabling_index_object_not_found,!0),this._load(o)):t.onFailure&&t.onFailure(s)}else t.onFailure&&t.onFailure(s);else s.results&&s.results.length||t.onFailure&&t.onFailure(s);i()},getContentName:function(){return new Promise(function(e){var t="",o=this.getRoots(),n=this.getHiddenRootIds(),s=o.length+n.length;switch(s){case 0:t="";break;case 1:var r=i.getNodeID(o[0])||this.getHiddenRootIds(0);t=this.getRootStats(r)?this.getRootStats(r).label:"";break;default:t=s+" "+c.contentNameSuffix}e({contentName:t})}.bind(this))},_isLargeDataSelected:function(){for(var e=d.get(),t=!1,o=!1,n=0;n<e.length;n++){var s=e[n].pathElement;if(i.isAModelPath(s))for(var r=0;r<s.externalPath.length;r++)if("RootBag"===s.externalPath[r].name&&r+1<s.externalPath.length){var a=s.externalPath[r+1];this.isLargeDataStructure(i.getNodeID(a))&&(t=!0),i.isTileSetNode(a)&&(o=!0);break}if(t||o)break}return t||o},_disableElasticLoadingForTransition:function(){n.setSetting("privateFlag_enopad3dviewer_onPremiseElasticLoading",!1),this._checkElasticLoadingAvailability()},_enableElasticLoadingForTransition:function(){n.setSetting("privateFlag_enopad3dviewer_onPremiseElasticLoading",!0),this._checkElasticLoadingAvailability()},_freezeRoots:function(){for(var e=this.getRoots(),t=0;t<e.length;++t)this.freezeRoot(i.getNodeID(e[t]))}})}),define("DS/ENOPAD3DViewer/controller/PAD3DLayerController",["DS/ENOPAD3DViewer/views/PAD3DLayerPanel","DS/ENOPAD3DViewer/models/PAD3DLayerModel","DS/ENOPAD3DViewer/models/PAD3DPOILayer","DS/CoreEvents/ModelEvents","DS/Utilities/UUID","DS/Utilities/Utils","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions","DS/ENOXInterWdgCom/LinkManager","text!DS/ENOPAD3DViewer/assets/json/DefaultColorStream.json"],function(e,t,i,o,n,s,r,a,l){"use strict";function d(t){this._layers=new Map,this._layersToDeleteOnUnlink=new Map,this._layerListView=null,this._rootBag=t.rootBag,this._decorationBag=t.decorationBag,this._viewer=t.viewer,this._parentContainer=t.renderTo,this._controller=t.controller,this._kindsWithPOI=new Set(["reveal","poi"]);var i=JSON.parse(l);i&&i.colorStream&&(this._colorStreamJSON=i.colorStream,this._colorStreamIdx=0),this._coloredLayersMap=new Map,this._modelEvents=new o,this._layerListView=new e({renderTo:this._parentContainer}),this._layerListView.hide()}return d.prototype.getLayer=function(e){return this._layers.get(e)},d.prototype.hasLayer=function(e){return this._layers.has(e)},d.prototype.getLayers=function(){return this._layers},d.prototype.getLayerListView=function(){return this._layerListView},d.prototype.setCustomHeaderVisibility=function(e,t){this._layerListView.setCustomHeaderVisibility(e,t)},d.prototype.declareLayerKinds=function(e){return this._layerListView.declareLayerKinds(e)},d.prototype.createLayer=function(e){var o="";e&&e.layerId?o=e.layerId:o=n.v4().split("-")[0];!e.layerGroupView&&e.kind;e.kind&&e.kind;var s=e.type?e.type:"default",r=null;switch(!e||"#"!==e.color&&e.color||(e.color=this._getNewColor(),this._coloredLayersMap.set(o,e.color)),s){case"default":r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,poiIcon:e.poiIcon,scale:e.scale,reloadable:!1});break;case"search":r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,scale:e.scale,reloadable:!0});break;case"poi":r=new i({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,clustered:e.clustered,enableClustering:e.enableClustering,maxClusters:void 0!==e.maxClusters?e.maxClusters:200,proximityMerging:void 0===e.proximityMerging||e.proximityMerging,proximityThreshold:void 0!==e.proximityThreshold?e.proximityThreshold:.001,layerColorEditable:e.layerColorEditable,poiIcon:e.poiIcon,scale:e.scale,styles:e.styles,legend:"object"==typeof e.legend?e.legend:void 0,reloadable:!0});break;case"reveal":r=new i({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,clustered:e.clustered,enableClustering:e.enableClustering,maxClusters:void 0!==e.maxClusters?e.maxClusters:200,proximityMerging:void 0===e.proximityMerging||e.proximityMerging,proximityThreshold:void 0!==e.proximityThreshold?e.proximityThreshold:.001,layerColorEditable:e.layerColorEditable,poiIcon:e.poiIcon,scale:e.scale,reloadable:!1});break;case"graphic properties":r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,styles:e.styles,legend:"object"==typeof e.legend?e.legend:void 0,reloadable:!0});break;case"grouping":r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,styles:e.styles,legend:"object"==typeof e.legend?e.legend:void 0,reloadable:!1});break;case"zoi":r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,visibility:e.visibility,layerGroupView:e.layerGroupView,legend:"object"==typeof e.legend?e.legend:void 0,reloadable:!0});break;case"colorize":case"transparency":case"pointCloudClassification":case"pointCloudElevation":r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:o,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,position:e.position,reloadable:!1});break;default:r=new t({UUID:o,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller,layerId:e.layerId,kind:e.kind,color:e.color,visibility:e.visibility,layerGroupView:e.layerGroupView,reloadable:!1})}return this._bindEvents(r),this._layers.set(o,r),e.ghostLayer||(this._layerListView.appendChild(r),this._layerListView.show()),this.publish({event:"layerCreated",data:{id:o}}),r},d.prototype.getLayerGroupView=function(e){var t=null,i=this._layers.get(e);return i&&(t=i.getGroupView()),t},d.prototype.getLayerStyles=function(e){var t=null,i=this._layers.get(e);return i&&(t=i.getStyles()),t},d.prototype.deleteLayer=function(e,t){if(t=t||10,e){var i=e.getID(),o=this._layers.get(i);for(let[e,t]of this._layersToDeleteOnUnlink){let o=t.indexOf(i);-1!==o&&(1===t.length?this._layersToDeleteOnUnlink.delete(e):t.splice(o,1))}if(this._coloredLayersMap.delete(i),o){this._layerListView.removeChild(o);let t=e.getKind();"poi"!==t&&"graphic properties"!==t||a.publish("DS/ExternalWdgtCom/LayerDeleted",{layerId:i}),this._layers.delete(i),o.destroy()}this._controller&&this._controller._updatePOIClusters().then(()=>{"function"==typeof this._controller._endClusterUpdate&&this._controller._endClusterUpdate(),this._layers&&0===this._layers.size&&this._controller&&this._controller.stopPOIClusters()}),0===this._layers.size&&this._layerListView.hide()}},d.prototype.deleteLayerId=function(e){var t=e,i=this._layers.get(t);this.deleteLayer(i)},d.prototype.disableClustering=function(){this._layers.forEach(function(e,t){this._kindsWithPOI.has(e.getKind())&&e.disableClustering()}.bind(this))},d.prototype.restoreClustering=function(){this._layers.forEach(function(e,t){this._kindsWithPOI.has(e.getKind())&&e.restoreClustering()}.bind(this))},d.prototype.setPOIType=function(e){r.setPOIType(e),"2D"===e?(this.restoreClustering(),this._layers.forEach(function(e,t){var i=this._controller._proximityGroups.get(e.getID());i&&i.forEach(function(e,t){e.node.render()})}.bind(this))):"3D"===e&&(this.disableClustering(),this._layers.forEach(function(e,t){var i=this._controller._proximityGroups.get(e.getID());i&&i.forEach(function(e,t){e.node.render()})}.bind(this))),this._controller._updatePOIClusters()},d.prototype.getPOIType=function(){return r.getPOIType()},d.prototype.getKinds=function(){var e=new Set;return this._layers.forEach(function(t){e.add(t.getKind())}.bind(this)),e},d.prototype.getKindsWithPOI=function(){var e=new Set;return this._layers.forEach(function(t){var i=t.getKind();this._kindsWithPOI.has(i)&&e.add(t.getKind())}.bind(this)),e},d.prototype.deleteLayers=function(){this._layers.forEach(function(e,t){this.deleteLayer(e)}.bind(this))},d.prototype.destroy=function(){this.deleteLayers(),this._layers.clear(),delete this._layers,this._layerListView.destroy(),delete this._layerListView,delete this._rootBag,delete this._decorationBag,delete this._viewer,delete this._parentContainer,delete this._controller},d.prototype.hideLayer=function(e){var t=e.getID(),i=this._layers.get(t);i&&i._view&&(i.hide(),i._view.hide(),e.publish())},d.prototype.getHiddenLayers=function(){var e=[];return this._layers.forEach(function(t,i){t.isLayerVisible()||e.push(t)}),e},d.prototype.getUnclusteredLayers=function(){var e=[];return this._layers.forEach(function(t,i){("poi"===t.options.kind&&!t.isLayerVisible()||t.isClustered&&!t.isClustered())&&e.push(t)}),e},d.prototype._randomColor=function(){for(var e=!1,t=null,i=0;!e&&i<25;){t=Math.floor(15728640*Math.random()+1048576).toString(16),e=!0;for(var o=0;o<this._layerGroupColors.length;o++)this._hexColorDelta(this._layerGroupColors[o].slice(1,this._layerGroupColors[o].length),t)>.3&&(e=!1);i++}return"#"+t},d.prototype._hexColorDelta=function(e,t){var i=parseInt(e.substring(0,2),16),o=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16),s=parseInt(t.substring(0,2),16),r=parseInt(t.substring(2,4),16),a=parseInt(t.substring(4,6),16),l=255-Math.abs(i-s),d=255-Math.abs(o-r),h=255-Math.abs(n-a);return((l/=255)+(d/=255)+(h/=255))/3},d.prototype._getNewColor=function(){var e="#ADADAD";return this._coloredLayersMap&&this._coloredLayersMap.size<this._colorStreamJSON.length-1&&(e=this._colorStreamJSON[this._coloredLayersMap.size]),e},d.prototype._bindEvents=function(e){e.subscribe({event:"delete"},function(e){this.deleteLayer(e.layer),this.publish({event:"layerDeleted",data:e})}.bind(this)),e.subscribe({event:"modified"},function(e){this.publish({event:"layerModified",data:e})}.bind(this))},d.prototype.publish=function(e){this.getModelEvents().publish(e)},d.prototype.subscribe=function(e,t){return this.getModelEvents().subscribe(e,t)},d.prototype.unsubscribe=function(e){this.getModelEvents().unsubscribe(e)},d.prototype.getModelEvents=function(){return this._modelEvents},d}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerKPICommunicationManager",["UWA/Class","DS/PADUtils/PADCommandProxy","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/Selection/CSOManager","DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADUtilsServices","DS/PADServices/ws/WSAccess","DS/ENOPAD3DViewer/utils/PAD3DViewerCapturePOI","DS/ENOPAD3DViewer/utils/PAD3DViewerDisplay3DVolume"],function(e,t,i,o,n,s,r,a,l,d,h,c){"use strict";return e.extend({name:"PAD3DViewerKPICommunicationManager",_KPIVisuEventToken:null,_KPICommunicationProxy:null,initKPICommunicationManager:function(){return new Promise(function(e){this._context.isInterwidgetComAvailable()&&!this._KPICommunicationProxy?(this._KPICommunicationProxy=t.create({events:{onGetSessionContent:function(e){this.getSessionContent(e)}.bind(this),onCapturePOI:function(e){this._capturePOI(e)}.bind(this),onDisplay3DVolume:function(e){this._display3DVolume(e)}.bind(this)}}),this._KPIVisuEventToken=n.subscribe({event:"/VISU/"},function(e){switch(e.eventType){case"@onViewpointEndMove":this.viewpointUpdate()}}.bind(this)),e()):e()}.bind(this))},disposeKPICommunicationManager:function(){this._KPIVisuEventToken&&(n.unsubscribe(this._KPIVisuEventToken),this._KPIVisuEventToken=null)},destroyKPICommunicationManager:function(){this._KPICommunicationProxy&&(this._KPICommunicationProxy.destroy(),delete this._KPICommunicationProxy),this._parent()},_capturePOI:function(e){!1===h.isInitialized()&&h.initialize(),h.capturePOI(e)},_display3DVolume:function(e){var t=!1;e.new&&e.new.box&&e.new.box&&e.new.box.autoComputeBoxParamsFromCSO&&!0===e.new.box.autoComputeBoxParamsFromCSO&&(t=!0),e.new&&e.new.sphere&&e.new.sphere&&e.new.sphere.autoComputeSphereParamsFromCSO&&!0===e.new.sphere.autoComputeSphereParamsFromCSO&&(t=!0);var i=r.get();if(t&&i&&i.length){var n,s,a=i,l=new o.Vector3(0,0,0),d=new o.Vector3(0,0,0),h=0,p=null,u=null,g=new o.Matrix4,_=new o.Matrix4;a.forEach(function(e){if(a[h]){var t=a[h].pathElement.getLastElement(!0).getBoundingBox().clone();g=a[h].pathElement.getWorldMatrix(),t.applyMatrix4(g);var i=t.min,o=t.max;0===h?(l.x=Math.min(i.x,o.x),l.y=Math.min(i.y,o.y),l.z=Math.min(i.z,o.z),d.x=Math.max(i.x,o.x),d.y=Math.max(i.y,o.y),d.z=Math.max(i.z,o.z)):(l.x=Math.min(Math.min(i.x,o.x),l.x),l.y=Math.min(Math.min(i.y,o.y),l.y),l.z=Math.min(Math.min(i.z,o.z),l.z),d.x=Math.max(Math.max(i.x,o.x),d.x),d.y=Math.max(Math.max(i.y,o.y),d.y),d.z=Math.max(Math.max(i.z,o.z),d.z))}h++}),n=l,s=d,(u=new o.Vector3(l.x,l.y,l.z)).applyMatrix4(_),(p=new o.Vector3(l.x,l.y,l.z)).applyMatrix4(_);var f=new o.Vector3(d.x,l.y,l.z);f.applyMatrix4(_);var v=new o.Vector3(l.x,d.y,l.z);v.applyMatrix4(_);var m=new o.Vector3(l.x,l.y,d.z);m.applyMatrix4(_);var b,y,P=new o.Vector3(f.x-p.x,f.y-p.y,f.z-p.z),D=new o.Vector3(v.x-p.x,v.y-p.y,v.z-p.z),I=new o.Vector3(m.x-p.x,m.y-p.y,m.z-p.z),S=(new o.Vector3).copy(P).multiplyScalar(.5),C=(new o.Vector3).copy(D).multiplyScalar(.5),w=(new o.Vector3).copy(I).multiplyScalar(.5),x=(new o.Vector3).copy(p);if(x.add(S),x.add(C),x.add(w),_.setPosition(x),g=_,e.new&&e.new.box&&!0===e.new.box.autoComputeBoxParamsFromCSO&&(b=e.new.box),e.new&&e.new.sphere&&!0===e.new.sphere.autoComputeSphereParamsFromCSO&&(y=e.new.sphere),b){console.log(" data.new.id "+e.new.id);var O=new o.Vector3(1,0,0),A=new o.Vector3(0,1,0),M=new o.Vector3(0,0,1),N=Math.abs(s.x-n.x),V=Math.abs(s.y-n.y),E=Math.abs(s.z-n.z);O.setLength(N),A.setLength(V),M.setLength(E);var T=[];T.push(O),T.push(A),T.push(M);var R=new o.Vector3(u.x,u.y,u.z),L=(new o.Matrix4).setFromArray(g.elements).decompose();L&&R.sub(L[0]),u=R,T&&u&&g&&(b.axes=T,b.cornerPoint=u,b.matrix=g.elements)}if(y){var F=Math.sqrt(Math.pow(d.x-l.x,2)+Math.pow(d.y-l.y,2)+Math.pow(d.z-l.z,2))/2;x&&g&&(y.center=x,y.radius=F)}}!1===c.isInitialized()&&c.initialize(),c.display3DVolume(e)},viewpointUpdate:function(){var e={widgetId:t.appId(),viewpoint:this._context.getViewpointParameters()};this._KPICommunicationProxy.viewpointUpdate(JSON.stringify(e))},getSessionContent:function(){const e=this.getRoots();let o,n=[],s="",r=[],a={},d={};const h=[],c={widgetId:t.appId(),rootIds:[],contents:[],viewpoint:this._context.getViewpointParameters(),filterSpecifications:[],filterSpecs:null};if(e.length){let t=0;const p=()=>{for(let e=0;e<h.length;++e)this.getBIProxy().removeEvent(h[e]);this._externalKPICommandProxy.sessionContent(c)};for(let u=0;u<e.length;++u)if(s=i.getNodeID(e[u]),n.push(s),e[u].getCVFilterQuery?(o="V1",d=e[u].getCVFilterQuery(this.getBIProxy(),o)?e[u].getCVFilterQuery(this.getBIProxy(),o):null):(o="V2",d=this.getBIProxy().getFilterSpec(s,{V2:{}})),a[s]={version:o,spec:d},r.push(a),c.rootIds.push(e[u].modelIdentification),"R2V_FeatureState"===e[u].getUserData()){const e=this._context._loadedSoI,t=Object.keys(e);for(let i=0;i<t.length;++i){const o=e[t[i]];if(o.options.data.states.length)for(let e=0;e<o.options.data.states.length;++e)o.options.data.states[e].resourceid===s&&(c.contents.push({rootId:o.options.data.states[e].featureOfInterestId,selectedId:o.options.data.states[e].resourceid,service:o.options.data.serviceId,type:o.options.data.soiData.type}),p())}}else{const o=Date.now();h.push(this.getBIProxy().addEvent(`GetFilterSpec-${u}-${o}`,function(i,o){1===o.status&&o.publicSpec?c.filterSpecifications.push({rootId:i,specification:o.publicSpec}):0===o.status&&null!==o.error&&console.warn(o.error.title,o.error.message),++t===e.length&&p()}.bind(this,s))),this.getBIProxy().getPublicFilterSpecification&&this.getRootStats(s)?(this.getBIProxy().getPublicFilterSpecification({rootId:s,NGFUXId:this._context.getNGFUXID(),widgetId:l.getWidgetId(),eventName:`GetFilterSpec-${u}-${o}`}),c.contents.push({rootId:s,selectedId:"",service:this.getRootStats(s).serviceId||"3DSpace",type:i.getNodeType(e[u])})):this._externalKPICommandProxy.sessionContent(c)}}else this._externalKPICommandProxy.sessionContent(c)}})}),define("DS/ENOPAD3DViewer/models/PAD3DViewerNode",["DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DViewerTypesDictionary"],function(e,t){"use strict";function i(e,t,i){if((t=e.length)>1)for(;i=--t;)for(;i--;)e[t]===e[i]&&e.splice(i,1);return e}return e.extend({className:"PAD3DViewerNode",_id:null,_type:null,_treeOrder:null,_loadedStream:null,_BIColor:null,_sequence_filter:null,_config_filter:null,_CVFilterQuery:null,_globalType:null,init:function(e){this._parent(),e.id&&(this._id=e.id),e.type&&(this._type=e.type),e.BIColor&&(this._BIColor=e.BIColor),e.treeOrder&&(this._treeOrder=e.treeOrder),e.globalType&&(this._globalType=e.globalType),e.sequence_filter&&(this._sequence_filter=e.sequence_filter),e.config_filter&&(this._config_filter=e.config_filter),e.CVFilterQuery&&(this._CVFilterQuery=e.CVFilterQuery)},getID:function(){return this._id},_setID:function(e){this._id=e},getDid:function(){return console.warn("Deprecated: did is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController"),null},getCgrUrl:function(){return console.warn("Deprecated: cgr url is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController"),null},getThbUrl:function(){return console.warn("Deprecated: thb url is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController"),null},getLoadedStream:function(){return this._loadedStream},setLoadedStream:function(e){this._loadedStream=e},getType:function(){return this._type},getGlobalType:function(){return this._globalType},getBIColor:function(){return this._BIColor},setBIColor:function(e){this._BIColor=e},getTreeOrder:function(){return this._treeOrder},getSequenceFilter:function(){return UWA.clone(this._sequence_filter,!0)},setSequenceFilter:function(e){this._sequence_filter=e},getConfigFilter:function(){return UWA.clone(this._config_filter,!0)},setConfigFilter:function(e){this._config_filter=e},getCVFilterQuery:function(){return UWA.clone(this._CVFilterQuery,!0)},setCVFilterQuery:function(e){this._CVFilterQuery=e},isPLMInstance:function(){return-1!==t.get().instances.indexOf(this.getType())||"ds6w:Instance"===this.getGlobalType()},isPLMRepInstance:function(){return-1!==t.get().repInstances.indexOf(this.getType())||"ds6w:RepInstance"===this.getGlobalType()},isPLMRepReference:function(){return-1!==t.get().repReferences.indexOf(this.getType())||"ds6w:Document"===this.getGlobalType()},isPLMReference:function(){return-1!==t.get().references.indexOf(this.getType())||"ds6w:Part"===this.getGlobalType()},is3DLeaf:function(){return-1!==t.get().representations.indexOf(this.getType())||"ds6w:Document"===this.getGlobalType()},equals:function(e){var t=!1;return e.getID&&(t=this.getID()===e.getID()),t},getSiblings:function(){var e=[],t=this;return this.parents.forEach(function(i){i.children.forEach(function(i){i.equals(t)||e.push(i)})}),i(e)},getReferences:function(){var e=[];return this.isPLMInstance()?e=this.children:this.isPLMReference()?e.push(this):this.isPLMRepReference()?this.parents.forEach(function(t){e=e.concat(t.parents)}):this.isPLMRepInstance()&&(e=this.parents),i(e)},isLeaf:function(){var e=!0;return this.children.forEach(function(t){t.isPLMRepInstance&&!t.isPLMRepInstance()&&(e=!1)}),this.isPLMReference()&&e},getRootReferences:function(e){return e||(e=[]),1===this.parents.length&&"RootBag"===this.parents[0].name?(e.push(this),i(e)):(this.parents.forEach(function(t){t.getRootReferences&&t.getRootReferences(e)}),i(e))}})}),define("DS/ENOPAD3DViewer/models/PAD3DViewerNodeModel",["UWA/Class","DS/ENOPAD3DViewer/models/PAD3DViewerNode","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/Visualization/IdPathMatcher","DS/Mesh/MeshUtils","DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/CoreEvents/ModelEvents","DS/3DXMTiles/OOCManager","DS/3DXMTiles/OOCModel3DHandler","DS/RenderingMaterial/PLMMaterialFactory"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_){"use strict";return e.extend({className:"PAD3DViewerNodeModel",init:function(e){var t=this;this._parent(e),this._modelEvents=new p,this._nodeIndex={},this._rootLog=[],this._hiddenRootIds=[],this._modelLoader=null,this._parsingRunning=!1,this._withRepLoading=!0,window.localStorage.getItem("ENOPADNoGeometry")&&(this._withRepLoading=!1),this._selectiveLoadingActivated=h.getSetting("enopad3dviewer_dynamicRepLoading"),this._supportPgpBasedOnDescription=h.getSetting("supportPgpBasedOnDescription"),this._getFcsUrlsCB=e.getFcsUrlsCB,this._nodeIndex[this.getRootBagId()]=new o("RootBag"),e.viewer.addNode(this._nodeIndex[this.getRootBagId()]),this._decorationBag=new o("DecorationBag"),e.viewer.addNode(this._decorationBag),this._loadingBoxesBag=new o("LoadingBoxesBag"),e.viewer.addNode(this._loadingBoxesBag);var r=new n;if(r.addElement(this._nodeIndex[this.getRootBagId()]),this._nodeIndex[this.getRootBagId()].path=r,this._modelLoader=new s(e.viewer.getWebGLContext(),!1),this._modelLoader.setViewer(e.viewer),this._modelLoader.setFileType("cgr"),this._modelLoader.setRenderCallback(e.viewer.render,1e3),this._modelLoader.setCGRNewInfra(!0),this._modelLoader.setSceneGraph(this._nodeIndex[this.getRootBagId()]),this._selectiveLoadingActivated){this._modelLoader.setKeepLoaderMode(!0),e.viewer.budgetedRenderManager.setBudget(.1);var l={enableOcclusionTest:h.getSetting("enopad3dviewer_occlusionTest"),config:"full",fullOOC:!1};navigator.userAgent.match(/iPad/i)?(e.viewer.setSmallRenderTargetPicking(!0),l.config="medium"):navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&(e.viewer.setSmallRenderTargetPicking(!0),l.config="restricted");var d=void 0!==e.appOOCManagerOptions?UWA.extend(l,e.appOOCManagerOptions):l;this._OOCManager=new u(e.viewer,d),this._OOCManager.setTargetNode(this.getRootBag()),this._OOCManager.setOnStartLoadingCB(e.startLoadingCB),this._OOCManager.setOnEndLoadingCB(e.endLoadingCB),this._OOCManager.setOnSwitchRepCB(e.representationLoadedCB),this._OOCManager.setUnloadLeafReferenceCB(function(e){var i=t.getNode({id:e});if(i){for(var o=i.children.length-1;o>=0;o--)"PAD3DViewerCGRNode"===i.children[o].className&&i.remove(i.children[o]);this.publish({event:"onLeafReferenceUnloaded",data:{id:e}})}}.bind(this)),this._OOCManager.setOnLeafReferenceLoadedCB(function(e,t){t&&t.nodes&&t.nodes.forEach(function(e){e.className="PAD3DViewerCGRNode"}),this.publish({event:"onLeafReferenceLoaded",data:{id:e}})}.bind(this)),this._OOCManager.setTargetNode(this.getRootBag()),this._OOCManager.setPerformancesOptions({pauseLoadingDuringViewpointMove:!0}),e.viewer.getIdPathMatcher()||e.viewer.setIdPathMatcher(new a({idToNodeCB:function(e){return this.getNode({id:e})}.bind(this),nodeToIdCB:function(e){return e===this.getRootBag()?this.getRootBagId():i.getNodeID(e)}.bind(this),isNodeRepRefCB:function(e){return i.isRepReference(e)}})),this._model3DHandler=new g({getSecurityParamsCB:function(){return{securityCtx:h.getSetting("pad_security_ctx"),tenant:c.getPlatformId(),service3DSpaceUrl:c.get3DSpaceUrl(),userLogin:c.getUser().login}},oocManager:this._OOCManager}),c.isCloud()&&this._model3DHandler.setAutoRedirect(!0),this._model3DHandler.setFileType(h.getSetting("enopad3dviewer_streamFileType")?h.getSetting("enopad3dviewer_streamFileType"):"cgr"),this._model3DHandler.setLoadModelOptions({proxyurl:"none"}),h.getSetting("enopad3dviewer_useStaticURL")&&this._model3DHandler.setRedirectUrlCB&&this._model3DHandler.setRedirectUrlCB(function(e,t){this._getFcsUrlsCB({urls:e,callbacks:{onComplete:function(e){e.results&&t(e.results)},onFailure:function(i){for(var o=[],n=0;n<e.length;n++)o.push(null);t(o)}}})}.bind(this)),this._OOCManager.registerHandlers({repRef:this._model3DHandler})}},getRootBagId:function(){return"rootBag"},getRootLog:function(){return this._rootLog.slice(0)},addToRootLog:function(e){this._rootLog.push(e)},getHiddenRootIds:function(e){return void 0!==e?this._hiddenRootIds[e]:this._hiddenRootIds},destroy:function(){this._modelLoader.abort(),delete this._modelLoader,delete this._nodeIndex,delete this._hiddenRootIds,delete this._rootLog,this._modelEvents&&delete this._modelEvents,this._parent()},_parseAttributes:function(e,t){var i=null,o=e.length,n=0;for(t.did=null,t.type=null,t.globalType=null,t.pid=null,t.thbUrl=null,t.cgrUrl=null,t.matrix=null,t.treeOrder=null,t.hide=null,t.pgpOptions=null,t.inheritance=null,t.orientation=null,n=0;n<o;n++)if("did"===(i=e[n]).name)t.did=i.value;else if("type"===i.name)t.type=i.value;else if("ds6w:type"===i.name)t.type=i.value;else if("ds6w:globalType"===i.name)t.globalType=i.value;else if("physicalid"===i.name)t.pid=i.value;else if("resourceid"===i.name)t.pid=i.value;else if("thumbnail_3d"===i.name)t.thbUrl=i.value;else if("cgr"===i.name)t.cgrUrl=i.value;else if("stepcgr"===i.name)t.stepcgrUrl=i.value;else if("TreeOrder"===i.name)t.treeOrder=parseFloat(i.value);else if("ro.plminstance.V_description"===i.name&&this._supportPgpBasedOnDescription)"tmpHide"===i.value&&(t.hide=!0);else if("matrixtxt"===i.name&&""!==i.value){if(t.matrix=null,"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==i.value&&"1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"!==i.value&&"1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"!==i.value){t.matrix=new r.Matrix4;var s=i.value.split(/[,]/);t.matrix.elements[0]=parseFloat(s[0]),t.matrix.elements[1]=parseFloat(s[1]),t.matrix.elements[2]=parseFloat(s[2]),t.matrix.elements[4]=parseFloat(s[3]),t.matrix.elements[5]=parseFloat(s[4]),t.matrix.elements[6]=parseFloat(s[5]),t.matrix.elements[8]=parseFloat(s[6]),t.matrix.elements[9]=parseFloat(s[7]),t.matrix.elements[10]=parseFloat(s[8]),t.matrix.elements[12]=parseFloat(s[9]),t.matrix.elements[13]=parseFloat(s[10]),t.matrix.elements[14]=parseFloat(s[11])}}else"ro.pgpshowextension.v_pgp_show"===i.name.toLowerCase()||"bo.pgpshowextension.v_pgp_show"===i.name.toLowerCase()?(null===t.pgpOptions&&(t.pgpOptions=[]),"true"===i.value.toLowerCase()?t.pgpOptions.push({value:!0,type:"hideShow"}):t.pgpOptions.push({value:!1,type:"hideshow"})):"bo.pgpcolorextension.v_pgp_colorrgb.asstring"===i.name.toLowerCase()||"ro.pgpcolorextension.v_pgp_colorrgb.asstring"===i.name.toLowerCase()?(null===t.pgpOptions&&(t.pgpOptions=[]),t.pgpOptions.push({value:i.value,type:"color"})):"bo.pgpopacityextension.v_pgp_opacity"===i.name.toLowerCase()||"ro.pgpopacityextension.v_pgp_opacity"===i.name.toLowerCase()?(null===t.pgpOptions&&(t.pgpOptions=[]),t.pgpOptions.push({value:i.value,type:"opacity"})):"bo.pgpinheritanceextension.v_pgp_inheritance"===i.name.toLowerCase()||"ro.pgpinheritanceextension.v_pgp_inheritance"===i.name.toLowerCase()?t.inheritance=i.value:"ds6wg:xcadorientationext.v_worldorientation"===i.name.toLowerCase()?t.orientation=parseInt(i.value):"cgrwms"===i.name?t.cgrwms=i.value:"3dthbwms"===i.name&&(t["3dthbwms"]=i.value);t.stepcgrUrl&&(t.cgrUrl=t.stepcgrUrl,delete t.stepcgrUrl),t.globalType||"VPMRepInstance"!==t.type||(t.globalType="ds6w:RepInstance")},_parseBoundingBox:function(e){return new r.Box3(new r.Vector3(parseFloat(e.min[0]),parseFloat(e.min[1]),parseFloat(e.min[2])),new r.Vector3(parseFloat(e.max[0]),parseFloat(e.max[1]),parseFloat(e.max[2])))},buildFromJSON:function(e){var t=this,o=void 0!==e.hidden&&e.hidden;t._rootId=null,t._nbCGRToLoad=0,t._nbCGRLoaded=0,t.nbCgrLoaded=0,t.nbThbLoaded=0;var n=!0,s=[],r=[],a=new Map,l=[],p={references:[],instances:[],occurrences:[],hiddenPaths:[]},g=null,f=!1,v={},m=null,b=!1,y=function(){t._nbCGRToLoad>0&&(t.load3DProbe.end(),delete t.load3DProbe);var i=s.slice(0),o=r.slice(0),n=t._rootId;e.callbacks.onComplete({id:n,createdPaths:i,selectedPaths:o,pgpOptions:p,BS:m,orientation:g,expandCut:!0===b?b:void 0}),t._nbCGRToLoad=null,t._nbCGRLoaded=null,t._rootId=null,s=null,r=null,e=null,p=null,t=null};if(!t._selectiveLoadingActivated){this._modelLoader.setOnLoadedCallback(y),this._modelLoader.setOnLoadedProductStructureCallback(function(i){i&&i.nodes&&i.nodes.forEach(function(e){e.className="PAD3DViewerCGRNode"}),t._nbCGRLoaded++,e.callbacks.onCGRLoad({nbCGRLoaded:t._nbCGRLoaded,nbCGRToLoad:t._nbCGRToLoad})}),this._modelLoader.onErrorCB=function(i){t._nbCGRLoaded++,e.callbacks.onCGRLoad({nbCGRLoaded:t._nbCGRLoaded,nbCGRToLoad:t._nbCGRToLoad})}}this._parsingRunning=!0,this.parsingProbe=d.createProbe("queryResultParsing");var P=!1,D=e.json.results.length,I=0,S={nbRef:0,nbNewRef:0,nbRep:0,nbNewRep:0,nbInst:0,nbNewInst:0,nbUrl:0,nbNewUrl:0,nbObj:0,nbPath:0,pgpOnRef:0,pgpOnInst:0,pgpOnOcc:0},C=new Date;for(I=0;I<D;I++){var w=e.json.results[I];if(void 0!==w.attributes){S.nbObj++;var x,O={};t._parseAttributes(w.attributes,O),a.set(O.did,O.pid);var A=t.getNode({id:O.pid});if(!A){l.push(O.pid),!0===O.hide&&(v[O.pid]=!0),A=t.createNode({id:O.pid,type:O.type,globalType:O.globalType,matrix:O.matrix,treeOrder:O.treeOrder});var M=null,N=null;if(t._selectiveLoadingActivated&&(w.boundingbox&&(M=(N=this._parseBoundingBox(w.boundingbox))?N.getBoundingSphere():null,N.max.x<N.min.x&&(O.thbUrl||O.cgrUrl?M=null:M.radius=0),(null!==M&&null!==m&&M.radius>m.radius||null===m&&null!==M)&&(m=M)),-1!==e.rootIds.indexOf(O.pid)&&M&&M.radius>0&&(m=M,P=!0)),A.is3DLeaf()&&(O.thbUrl||O.cgrUrl)){var V=null,E=null;"thumbnail"===e.streamToLoad&&O.thbUrl?(x=O.thbUrl,t._selectiveLoadingActivated?(V=u.RepType.pr,E=O["3dthbwms"]):A.setLoadedStream("thumbnail"),t.nbThbLoaded++):(x=O.cgrUrl,t._selectiveLoadingActivated?(V=u.RepType.av1,E=O.cgrwms):A.setLoadedStream("cgr"),t.nbCgrLoaded++),c.isCloud()&&t._selectiveLoadingActivated&&(E=O.cgrwms),0===t._nbCGRToLoad&&(t.load3DProbe=d.createProbe("3DLoading")),t._selectiveLoadingActivated?x&&t._withRepLoading&&(t._OOCManager.registerLeafReference(O.pid,{handler:this._model3DHandler,handlerType:"repRef",url:x,boundingBox:M&&M.radius>0?N:void 0,boundingSphere:M,node:A,type:V,wms:E}),n&&(n=!1,t._OOCManager.forceReferenceLoad(O.pid,null))):x&&t._withRepLoading&&(t._nbCGRToLoad++,t._modelLoader.loadModel({filename:x,format:"cgr",requestsOptions:{proxymode:"passport"}},A))}i.isReference(A)?S.nbNewRef++:i.isRepReference(A)?(S.nbNewRep++,(O.thbUrl||O.cgrUrl)&&S.nbNewUrl++):S.nbNewInst++}if(i.isReference(A)?S.nbRef++:i.isRepReference(A)?(S.nbRep++,(O.thbUrl||O.cgrUrl)&&S.nbUrl++):S.nbInst++,null!=O.pgpOptions)for(var T=0;T<O.pgpOptions.length;T++){var R={id:O.pid,value:O.pgpOptions[T].value,type:O.pgpOptions[T].type,inheritance:O.inheritance};"ds6w:Part"===O.globalType||"ds6w:Document"===O.globalType?(p.references.push(R),S.pgpOnRef++):(p.instances.push(R),S.pgpOnInst++)}f||-1===e.rootIds.indexOf(O.pid)||(g=parseInt(O.orientation),f=!0)}else if(void 0!==w.path){var L=a.get(""+w.path[0]),F=[L];if(null===t._rootId||t._rootId!==L){t._rootId=L;var k=!1;if(e.parent){for(var B=e.parent.children,G=0;G<B.length;G++)if(B[G].getID&&B[G].getID()===t._rootId){k=!0;break}var U=t.getNode({id:t._rootId});k||o||e.parent.add(U)}}var z=t._rootId;if(null!==z){S.nbPath++;var W=!1;for(t.getNode({id:z}),G=1;G<w.path.length;G++){var H=a.get(""+w.path[G]);void 0===H&&(H=String(w.path[G]));if(F.push(H),v[H]){var j=UWA.clone(F);j.push(a.get(""+w.path[G+1])),p.hiddenPaths.push(j)}t.isNodeAlreadyAttached(H,z)||(t.attachNode({id:H,parentId:z}),W=!0),z=H}W&&s.push(F),r.push(F)}}else if(void 0!==w.pgp_overload){S.pgpOnOcc++;for(var Q=Object.keys(w.pgp_overload),q=Object.values(w.pgp_overload),X=0;X<q.length;X++){if("string"==typeof Q[X]){Q[X]=Q[X].split(",");for(var K=0;K<Q[X].length;K++)Q[X][K]=a.get(""+Q[X][K])}q[X]["PGPColorExtension.V_PGP_Colorrgb"]?p.occurrences.push({path:Q[X],value:q[X]["PGPColorExtension.V_PGP_Colorrgb"],type:"color",inheritance:q[X]["PGPInheritanceExtension.V_PGP_Inheritance"]}):q[X]["PGPColorExtension.V_PGP_ColorRGB"]&&p.occurrences.push({path:Q[X],value:q[X]["PGPColorExtension.V_PGP_ColorRGB"],type:"color",inheritance:q[X]["PGPInheritanceExtension.V_PGP_Inheritance"]}),q[X]["PGPOpacityExtension.V_PGP_Opacity"]&&p.occurrences.push({path:Q[X],value:q[X]["PGPOpacityExtension.V_PGP_Opacity"],type:"opacity",inheritance:q[X]["PGPInheritanceExtension.V_PGP_Inheritance"]}),void 0!==q[X]["PGPShowExtension.V_PGP_Show"]&&p.occurrences.push({path:Q[X],value:"true"===q[X]["PGPShowExtension.V_PGP_Show"].toLowerCase(),type:"hideshow"}),!q[X]["PGPInheritanceExtension.V_PGP_Inheritance"]||void 0!==q[X]["PGPColorExtension.V_PGP_Colorrgb"]&&void 0!==q[X]["PGPColorExtension.V_PGP_ColorRGB"]||void 0!==q[X]["PGPOpacityExtension.V_PGP_Opacity"]||p.occurrences.push({path:Q[X],type:"inheritance",inheritance:q[X]["PGPInheritanceExtension.V_PGP_Inheritance"]})}}else w.material_overload?(_.setParams({messageFromIndex:w.material_overload,jsonVersion:"1.0",rootId:e.rootIds[0],getNodeID:function(e){return this.getNode({id:e})}.bind(this),getNodeFromID:function(e){return this.getNode({id:e})}.bind(this),getDepth:function(e){return 1}.bind(this),retrieveIRPathFromIIPath:function(e){for(var t=[],o=0;o<e.length;o++){var n=this.getNode({id:e[o]});if(t.push(e[o]),i.isInstance(n)&&o+1<e.length){var s=this.getNode({id:e[o+1]});if(i.isInstance(s)){var r=n.children[0];t.push(i.getNodeID(r))}}}return t}.bind(this),getSecurityParamsCB:function(){return{securityCtx:h.getSetting("pad_security_ctx"),tenant:c.getPlatformId(),service3DSpaceUrl:c.get3DSpaceUrl(),userLogin:c.getUser().login}}}),_.computeMaterials({rootId:e.rootIds[0]})):void 0!==w.status&&"EXPAND_WAS_CUT_MAX_OUTPUT_PATHS"===w.status&&(b=!0)}t.parsingProbe.end(),delete t.parsingProbe;var Z=new Date;t.publish({event:"parsingComplete",data:{timing:Z-C,infos:S}}),e.json=null,delete e.json,t._parsingRunning=!1,t._selectiveLoadingActivated&&"addRoot"===e.intent&&!0===e.reframe&&e.callbacks.onReframe({BS:m,rootBS:P}),(p.hiddenPaths.length||p.references.length||p.instances.length||p.occurrences.length)&&t.publish({event:"PGPPostProcess",data:p}),t.publish({event:"onUrlLoaded",data:{nbCgrLoaded:t.nbCgrLoaded,nbThbLoaded:t.nbThbLoaded}}),l.length&&t.publish({event:"newNodes",data:{newNodes:l}}),(0===t._nbCGRToLoad||t._selectiveLoadingActivated)&&y()},reparentNode:function(e){for(var t,i=this,o=0;o<e.json.results.length;o++){var n=e.json.results[o];if(void 0!==n.attributes){var s={};if(i._parseAttributes(n.attributes,s),s.pid===e.createdInstID&&!(t=i.getNode({id:s.pid}))){t=i.createNode({id:s.pid,type:s.type,globalType:s.globalType,matrix:s.matrix,treeOrder:s.treeOrder});break}}}return e.json=null,delete e.json,e.newParent.getID&&i.attachNode({id:e.createdInstID,parentId:e.newParent.getID()}),e.oldInstance.children.forEach(function(t){t.getID&&e.oldInstance.getID&&(i.detachNode({id:t.getID(),parentId:e.oldInstance.getID()}),i.attachNode({id:t.getID(),parentId:e.createdInstID}))}),i.removeNode({id:e.oldInstance.getID()}),t},insertExistingNode:function(e){for(var t,i=0;i<e.json.results.length;i++){var o=e.json.results[i];if(void 0!==o.attributes){var n={};if(this._parseAttributes(o.attributes,n),n.pid===e.createdInstID&&!(t=this.getNode({id:n.pid}))){t=this.createNode({id:n.pid,type:n.type,globalType:n.globalType,matrix:n.matrix,treeOrder:n.treeOrder});break}}}return e.json=null,delete e.json,e.parent.getID&&e.toInsert.getID&&(this.attachNode({id:e.createdInstID,parentId:e.parent.getID()}),this.attachNode({id:e.toInsert.getID(),parentId:e.createdInstID})),t},isNodeAlreadyAttached:function(e,t){for(var i=!1,o=this.getNode({id:e}).parents,n=0;n<o.length;n++)if(o[n]&&o[n].getID&&o[n].getID()===t){i=!0;break}return i},createNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if("string"!=typeof e.id)throw new Error("No id defined");if("string"!=typeof e.type)throw new Error("No type defined");var i=new t({id:e.id,type:e.type,globalType:e.globalType,treeOrder:e.treeOrder});return e.matrix&&i.setMatrix(e.matrix),this._nodeIndex[String(e.id)]=i,i},removeNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id){for(var t=this._rootLog.length-1;t>=0;t--)Array.isArray(this._rootLog[t])&&this._rootLog[t][0]===e.id&&(_.onRemovedRoot&&_.onRemovedRoot(e.id),this._rootLog.splice(t,1));var i=this.getNode({id:e.id});i&&(i.parents.length<=1?(!0===e.removeDetached&&i.isDetached&&(i.isDetached=!1),!0!==i.isDetached&&(this._removeChildren(i),i.parents.forEach(function(e){e.remove(i)}),delete this._nodeIndex[e.id],i.is3DLeaf()&&this._selectiveLoadingActivated&&this._OOCManager&&this._OOCManager.isRegistered(i.getID())&&this._OOCManager.unregisterLeafReference(i.getID()))):this.detachNode({id:e.id,parentId:this.getRootBagId()}))}else console.error("No id defined")},removeRoot:function(e){this.removeNode(e)},_removeChildren:function(e){if(e){var t=this,i=e.children;i&&(i.forEach(function(e){1===e.parents.length&&(e.getID?-1===t.getHiddenRootIds().indexOf(e.getID())&&(e.is3DLeaf()&&t._selectiveLoadingActivated&&t._OOCManager&&t._OOCManager.isRegistered(e.getID())&&t._OOCManager.unregisterLeafReference(e.getID()),delete t._nodeIndex[e.getID()],t._removeChildren(e)):t._removeChildren(e))}),i.forEach(function(t){e.remove(t)}))}},detachNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id)if(void 0!==e.parentId){var t=this.getNode({id:e.id});t.isDetached=!0;var i=this.getNode({id:e.parentId});t&&i&&i.remove(t)}else console.error("No parentId defined");else console.error("No id defined")},attachNode:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id)if(void 0!==e.parentId){var t=this.getNode({id:e.id});t.isDetached=!1;var i=this.getNode({id:e.parentId});t&&i&&i.add(t)}else console.error("No parentId defined");else console.error("No id defined")},updateNode:function(e,t){var i=null;if("object"!=typeof e)return console.error("updateNode: There is no parameter defined."),i;if("string"!=typeof e.id)return console.error("updateNode: There is no id defined."),i;if("object"!=typeof t)return console.error("updateNode: There is no new parameter defined."),i;if("string"!=typeof t.id)return console.error("updateNode: There is no new id defined."),i;if(!(i=this.getNode({id:e.id})))throw new Error("updateNode: Node not found.");return t.matrix?i.setMatrix(t.matrix):(i._setID(t.id),this._nodeIndex[t.id]=i,delete this._nodeIndex[e.id]),i},switchNodeVisuStreamOnDemand:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.data))throw new Error("No input data defined");if("function"!=typeof e.callbacks.onURLLoad)throw new Error("No onURLLoad callback function defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback function defined");var t=this;t._nbURLToLoad=e.data.length,t._nbURLLoaded=0,t.nbCgrLoaded=0,t.nbThbLoaded=0;var i=null;if(t._selectiveLoadingActivated)i=function(){t._nbURLToLoad--,t._nbURLLoaded++,0===t._nbURLToLoad&&e.callbacks.onComplete({nbUrlLoaded:t._nbURLLoaded})};else{var o=function(i){i&&i.nodes&&i.nodes.forEach(function(e){e.className="PAD3DViewerCGRNode"}),t._nbURLLoaded++,e.callbacks.onURLLoad({nbURLLoaded:t._nbURLLoaded,nbURLToLoad:t._nbURLToLoad})};t._modelLoader.setOnLoadedCallback(function(){e.callbacks.onComplete({nbUrlLoaded:t._nbURLLoaded})}),t._modelLoader.setOnLoadedProductStructureCallback(o),t._modelLoader.onErrorCB=o}e.data.forEach(function(o){var n=o.url,s=t.getLoadedStream(o.node),r=t.getRequestedStream(o.node);if(!n||o.stream===s&&o.stream===r)t._nbURLToLoad--;else{for(var a=o.node.children.length-1;a>=0;a--)"PAD3DViewerCGRNode"===o.node.children[a].className&&o.node.remove(o.node.children[a]);var l=null;"cgr"===o.stream?(l=u.RepType.av1,t.nbCgrLoaded++):(l=u.RepType.pr,t.nbThbLoaded++),t._selectiveLoadingActivated?(t._OOCManager.setReferenceLoadModelOptions(o.node.getID(),{applicativeContainers:e.applicativeContainers?e.applicativeContainers:void 0}),t._OOCManager.switchRepresentation(o.node.getID(),{url:n,type:l,wms:o.wms},i)):(o.node.setLoadedStream(o.stream),t._modelLoader.loadModel({filename:n,format:"cgr",requestsOptions:{proxymode:"passport"}},o.node,!1,{applicativeContainers:e.applicativeContainers?e.applicativeContainers:void 0}))}}),t.publish({event:"onUrlLoaded",data:{nbCgrLoaded:t.nbCgrLoaded,nbThbLoaded:t.nbThbLoaded}}),t._nbURLToLoad||e.callbacks.onComplete({nbUrlLoaded:t._nbURLLoaded})},refreshStream:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.data))throw new Error("No input data defined");if("function"!=typeof e.callbacks.onURLLoad)throw new Error("No onURLLoad callback function defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback function defined");var t=this;t._nbURLToLoad=e.data.length,t._nbURLLoaded=0,t.nbCgrLoaded=0,t.nbThbLoaded=0;var i=null;if(t._selectiveLoadingActivated)i=function(){t._nbURLToLoad--,0===t._nbURLToLoad&&e.callbacks.onComplete()};else{var o=function(i){i&&i.nodes&&i.nodes.forEach(function(e){e.className="PAD3DViewerCGRNode"}),t._nbURLLoaded++,e.callbacks.onURLLoad({nbURLLoaded:t._nbURLLoaded,nbURLToLoad:t._nbURLToLoad})};t._modelLoader.setOnLoadedCallback(function(){e.callbacks.onComplete()}),t._modelLoader.setOnLoadedProductStructureCallback(o),t._modelLoader.onErrorCB=o}e.data.forEach(function(o){var n=o.url;if(n){for(var s=o.node.children.length-1;s>=0;s--)"PAD3DViewerCGRNode"===o.node.children[s].className&&o.node.remove(o.node.children[s]);if(t._selectiveLoadingActivated){var r="cgr"===o.stream?u.RepType.av1:u.RepType.pr;t._OOCManager.setReferenceLoadModelOptions(o.node.getID(),{applicativeContainers:e.applicativeContainers}),t._OOCManager.switchRepresentation(o.node.getID(),{url:n,type:r,wms:o.wms},i)}else o.node.setLoadedStream(o.stream),t._modelLoader.loadModel({filename:n,format:"cgr",requestsOptions:{proxymode:"passport"}},o.node,!1,{applicativeContainers:e.applicativeContainers})}else t._nbURLToLoad--}),t.publish({event:"onUrlLoaded",data:{nbCgrLoaded:t.nbCgrLoaded,nbThbLoaded:t.nbThbLoaded}}),t._nbURLToLoad||e.callbacks.onComplete()},getRootBag:function(){return this._nodeIndex.rootBag},getNode:function(e){return this._nodeIndex[e.id]},getUserData:function(e){var t;return this._selectiveLoadingActivated&&this._OOCManager.isRegistered(e.id)?this._OOCManager.getUserData(e.id):(t=this.getNode({id:e.id}))?t.getUserData():null},getRoot:function(e){return this.getNode(e)},abort:function(){for(;this._parsingRunning;);this._modelLoader.abort()},getDecorationBag:function(){return this._decorationBag},getLoadingBoxesBag:function(){return this._loadingBoxesBag},publish:function(e){this.getModelEvents().publish(e)},subscribe:function(e,t){return this.getModelEvents().subscribe(e,t)},unsubscribe:function(e){this.getModelEvents().unsubscribe(e)},getModelEvents:function(){return this._modelEvents},isNodeLocked:function(e){return this._OOCManager?this._OOCManager.getSceneGraphLockCounter(e)>0:null},forceReferencesLoad:function(e){if("object"==typeof e)return new Promise(function(t,i,o){for(var n=[],s=0;s<e.ids.length;++s)this._OOCManager.isRegistered(t[s])&&n.push(new Promise(function(e,t){this._OOCManager.forceReferenceLoad(e,t)}.bind(this,t[s])));Promise.all(n).then(i)}.bind(this,e.ids));console.error("Incorrect options type in forceReferenceLoad()")},setForceReferencesLoad:function(e){if("object"!=typeof e)throw new Error("PAD3DViewerNodeModel : No input data in setForceReferencesLoad()");if(!Array.isArray(e.data))throw new Error("PAD3DViewerNodeModel : Incorrect input data type in setForceReferencesLoad()");return this._OOCManager?new Promise(function(e,t,i){for(var o=[],n=0;n<e.length;++n)this._OOCManager.isRegistered(e[n].id)&&(e[n].state?o.push(new Promise(function(e,t,i){this._OOCManager.setForceReferenceLoad(e,t,i)}.bind(this,e[n].id,e[n].state))):this._OOCManager.setForceReferenceLoad(e[n].id,e[n].state));Promise.all(o).then(t)}.bind(this,e.data)):(console.warn("Not supported out of OOC context"),new Promise(function(e){return e()}))},lockNodes:function(e){if("object"==typeof e){if(this._OOCManager)for(var t=0;t<e.ids.length;++t)this._OOCManager.addSceneGraphLock(e.ids[t])}else console.error("Incorrect options type in lockNodes()")},unlockNodes:function(e){if("object"==typeof e){if(this._OOCManager)for(var t=0;t<e.ids.length;++t)this._OOCManager.removeSceneGraphLock(e.ids[t])}else console.error("Incorrect options type in unlockNodes()")},getReferenceBoundingSphere:function(e){var t=null,o=this.getNode({id:e});return this._OOCManager&&o&&i.isRepReference(o)&&(t=this._OOCManager.getReferenceBoundingSphere(e).clone()),t},getReferenceBoundingBox:function(e){var t=null,o=this.getNode({id:e});return this._OOCManager&&o&&i.isRepReference(o)&&(t=this._OOCManager.getReferenceBoundingBox(e).clone()),t},pause:function(){this._OOCManager&&this._OOCManager.setPauseLoading(!0)},resume:function(){this._OOCManager&&this._OOCManager.setPauseLoading(!1)},addUserQueue:function(){},removeUserQueue:function(){},displayCandidateQueue:function(e,t){e?this._OOCManager.setCandidateQueueRendererParams(!0,{displayIntermediateReferences:!0,repRefAttributes:{color:new r.Color(t.repColor),opacity:.3,dimension:2},refAttributes:{color:new r.Color(t.assemblyColor),opacity:1,dimension:1},rootNode:this.getLoadingBoxesBag()}):this._OOCManager.setCandidateQueueRendererParams(!1)},setLoadingBoxesPickable:function(e){this._OOCManager&&this._OOCManager.setLoadingBoxesPickable&&(e?this._OOCManager.setLoadingBoxesPickable(l.PICKABLE):this._OOCManager.setLoadingBoxesPickable(l.NODRAWHL))},getOOCSelectedReferenceID:function(){var e=null;return this._OOCManager&&(e=this._OOCManager.getSelectedReference("cso")),e},isReferenceComplete:function(e){var t=null;if(this._OOCManager&&e){var o=this.getNode({id:e});o&&i.isRepReference(o)&&(t=this._OOCManager.isReferenceComplete(e))}return t},setDefaultLoadModelOptions:function(e){this._OOCManager&&this._OOCManager.setDefaultLoadModelOptions&&this._OOCManager.setDefaultLoadModelOptions(e)},getDefaultLoadModelOptions:function(){var e=null;return this._OOCManager&&this._OOCManager.getDefaultLoadModelOptions&&(e=this._OOCManager.getDefaultLoadModelOptions()),e},getConfig:function(){var e="full";return navigator.userAgent.match(/iPad/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1?e="medium":navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&(e="restricted"),e},getLoadedStream:function(e){var t=null;if(this._OOCManager)switch(this.getRepType(e)){case u.RepType.pr:t="thumbnail";break;case u.RepType.av1:t="cgr"}else t=e.getLoadedStream();return t},getRequestedStream:function(e){var t=null;if(this._OOCManager)switch(this.getRequestedRepType(e)){case u.RepType.pr:t="thumbnail";break;case u.RepType.av1:t="cgr"}else t=e.getLoadedStream();return t},getRepType:function(e){var t=null;return this._OOCManager&&e&&(t=this._OOCManager.getRepType(e.getID())),t},getRequestedRepType:function(e){var t=null;return this._OOCManager&&e&&(t=this._OOCManager.getRequestedRepType(e.getID())),t},_updatePositionMatrix:function(e){var t={elements:[]},i=e.hasPositioningMatrix;t.elements[0]=parseFloat(i[0]),t.elements[1]=parseFloat(i[1]),t.elements[2]=parseFloat(i[2]),t.elements[3]=parseFloat(0),t.elements[4]=parseFloat(i[3]),t.elements[5]=parseFloat(i[4]),t.elements[6]=parseFloat(i[5]),t.elements[7]=parseFloat(0),t.elements[8]=parseFloat(i[6]),t.elements[9]=parseFloat(i[7]),t.elements[10]=parseFloat(i[8]),t.elements[11]=parseFloat(0),t.elements[12]=parseFloat(i[9]),t.elements[13]=parseFloat(i[10]),t.elements[14]=parseFloat(i[11]),t.elements[15]=parseFloat(1);var o={id:String(e.instance)},n={id:String(e.instance),matrix:t};return this.updateNode(o,n)},declareUnsupportedRoot:function(e){console.warn("Model that are not tile node will soon be totally unsupported. Please upgrade")},removeUnsupportedRootFromMap:function(e){console.warn("Model that are not tile node will soon be totally unsupported. Please upgrade")},isRootSupported:function(e){return console.warn("Model that are not tile node will soon be totally unsupported. Please upgrade"),!0},isRepReference:function(){console.warn("Model that are not tile node will soon be totally unsupported. Please upgrade")}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerFilterController",["UWA/Class","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADPromise","DS/PADUtils/views/PADFilterCancel","DS/PADUtils/PADWSAccess","DS/PADServices/utils/GlobalModelEvents","DS/PADServices/settings/AppSettings","DS/PADServices/utils/GlobalUtils","DS/ENOXInterWdgCom/LinkManager"],function(e,t,i,o,n,s,r,a,l,d,h,c){"use strict";return e.extend({initFilterController:function(){return new Promise(e=>{const t=e=>{!0!==this.isStandaloneFilterAvailable()||c.isWidgetSynchronizing()||this.applyFilter(e,!1)};require(["DS/PADUtils/PADUtilsServices","DS/ENOFilterBIUX/FilterBIComponentProxy"],(i,o)=>{const s=this._context.getWidget()&&this._context.getWidget().id?this._context.getWidget().id:"fakeWidgetIDFallback",r=i.getAppId();let a=n.getSetting("activateVolumeFilter")?n.getSetting("activateVolumeFilter"):0;if(a=!(!this.isVolumeFilterAvailable()||!0!==a&&1!==a)||0,this._BIProxy=new o({tenant:i.getPlatformId(),processingMode:"appProcessing",ExpandSynthesisON:!0,colorize:!0,widgetId:s,volumeFilterAvailable:a,NGFUXId:this._context.getNGFUXID(),appId:r,synthesis_priority:2,enableTags:!0,shareFilterSpec:!0,appQueryParam:{graph:n.getSetting("enopad3dviewer_graphDefinitionForExpand")},selection:{}}),c.setPreviousNGFUXID(this._context.getNGFUXID()),this._BIProxy.resetNGFilterUI({widgetId:i.getWidgetId()}),n.addEvent("onX3dPlatformId",e=>{this._BIProxy&&this._BIProxy.updateTenant(e)}),n.addEvent("onPad_security_ctx",e=>{this._BIProxy&&this._BIProxy.setDefaultSecurityContext&&this._BIProxy.setDefaultSecurityContext(e)}),this._BIProxy.setDefaultSecurityContext&&this._BIProxy.setDefaultSecurityContext(n.getSetting("pad_security_ctx")),this._BIProxy.addEvent("ApplyNGFilter",t,this),this._BIProxy.addEvent("FilterBISelectionEvent",this._onFilterSelect,this),this._BIProxy.addEvent("NGFilter_Volume",this._onNGFilterVolume,this),this._BIProxy.addEvent("NGFilter_Close",this._onFilterClose,this),this.subscribe({event:"onRefreshBegin"},()=>{this._clearRootEvents()}),this.subscribe({event:"onRefreshCompleted"},()=>{this._restoreRootEvents(),this._BIProxy.refreshTagger()}),"function"==typeof this._BIProxy.setNGFilterOptions&&this._BIProxy.setNGFilterOptions({expandServices:"expand3d",expandIntent:this.isReadOnly()?"fullPaths":"partialPaths",appID:r}),!0===n.getSetting("synthesisModeOnInstance")?this._BIProxy.setSynthesisMode("flat"):this._BIProxy.setSynthesisMode("occurrence"),n.addEvent("onSynthesisModeOnInstance",this.onSynthesisModeOnInstance.bind(this)),!0===n.getSetting("splitActivation")&&this._BIProxy.setHighDepthTagsAvailability(!0),l.publish({event:"ENXModel/Root/FBIProxy",data:{HasFilter:this._BIProxy.HasFilter.bind(this._BIProxy),getCtxForSharing:this._BIProxy.getCtxForSharing.bind(this._BIProxy)}}),d.getSetting("redirectQueryToSGI")&&"function"==typeof this._BIProxy._addURLParam){let e="redirectQueryToSGI=true&expandIndexUnit=3DSpaceTransformedForIFC";this._BIProxy._addURLParam({services:"progressive",param:e})}e()})})},onSynthesisModeOnInstance:function(e){this._BIProxy&&(!0===e?this._BIProxy.setSynthesisMode("flat"):this._BIProxy.setSynthesisMode("occurrence"))},retrieveFilters:function(e){var t=n.getSetting("authoringFilterEnabled"),i=n.getSetting("authoringFilterEnabledForMultiRoot"),o=t&&(i||0===this._rootIds.length);if((!this._isAuthored()||this._isAuthored()&&o)&&!0===this.isStandaloneFilterAvailable()&&e.authorizedWithKind)if(e.authorizedWithKind.Filter&&e.authorizedWithKind.Filter.length>1)this._multiFilterRetriever(e.authorizedWithKind.Filter,0);else{const t=e.authorizedWithKind.Filter||{};this._retrieveFilter(t)}},_multiFilterRetriever:function(e,t){void 0===t&&(t=0),t<e.length&&this._retrieveFilter([e[t]]).then(()=>{this._multiFilterRetriever(e,++t)})},_retrieveFilter:function(e,t=!0,i=!0){return new Promise(o=>{this._BIProxy.retrieveFilters({filterObjects:e,callback:e=>{if(e.success.length){for(let o=0;o<e.success.length;++o){this.getRoot({id:e.success[o].rootId})?this.publish({event:"onRootAlreadyExisting"}):!0===n.getSetting("enopad3dviewer_lightNodeModel")?(this.publish({event:"onBeginFilterApplied"}),this.addRoots({objects:[{filterId:e.success[o].filterId,path:[e.success[o].rootId]}]},!1,t,i,function(e){this.publish({event:"onFilterApplied",data:{filter:{objects:[{filterId:e.filterId,path:[e.rootId]}]}}})}.bind(this,e.success[o]))):this.applyFilter(e.success[o].filter,!1,e.success[o])}o()}e.failure.length&&(console.error("Failed to retrieve filters",e.failure),this.publish({event:"onRetrieveFilterFailure",data:e}),o())}})})},removeFilterFullReload:function(e){return new Promise((t,i)=>{if(this._isAuthored())i("Filtering operation not permitted in authoring");else if(!0===this.isStandaloneFilterAvailable()){this.publish({event:"onBeginFilterRemoved",data:{id:e}}),this._clearRootEvents(),this.removeRoots({pids:e},!1,!1);const i=[];for(let t=0;t<e.length;t++)i.push({path:[e[t]]});this.addRoots({objects:i},!1,!0,!1,()=>{this._restoreRootEvents(),t()})}else t()})},applyFilter:function(e,t,i,r,a){this._isAuthored()||(void 0===r&&(r=!1),void 0===a&&(a=!1),s.createPromise(s=>{let l=[];this._context._filterPanelOpen=!1,this.getRoots().length&&!this._context._physicalId.length&&this._context._physicalId.push(o.getNodeID(this.getRoots()[0])),this.publish({event:"onEnableUX"}),0!==this._context._volumePanel&&this._context.publish({event:"onVolumeOpen",data:{closePanel:!0}});let d=!1;var h=!1;let c=!1;if(!0===this._wait4Filter&&(!0===n.getSetting("enopad3dviewer_lightNodeModel")&&(c=!0),h=!0,d=!0,delete this._wait4Filter),!0===this._useWrapToRemoveWhenFilter&&(this._useWrap=!1),e)if(e.CVQuery3D||e.empty){if(!e.empty&&e.CVQuery3D){const o=e.filterRootIds;l=[],this.publish({event:"onBeginFilterApplied"}),this._clearRootEvents();var p=this.subscribe({event:"onEndRootRemoved"},function(e){this.unsubscribe(p),e&&this.resumeProgressiveLoading()}.bind(this,c));let s=!0;for(let t=0;t<o.length;++t){d||o[t]&&this.getNode({id:o[t]})&&(s=!1),a&&(s=!1),this.removeRoots({pids:[o[t]]},!1,!1);const n=void 0!==i?i.filterId:void 0!==e.filterId?e.filterId:void 0;l.push({path:[o[t]],CVQuery3D:e.CVQuery3D,filterId:n})}this.addRoots({objects:l},!1,!0,s,function(e){this._restoreRootEvents(),this.publish({event:"onFilterApplied",data:{filter:{objects:e}}}),!0===n.getSetting("enopad3dviewer_lightNodeModel")&&h&&this.onSetTagsWithExpandSynthesis()}.bind(this,l)),t&&this._commandProxy&&this._commandProxy.applyFilter(e)}else if(!0===e.empty){if(e.filterRootIds)for(let t=0;t<e.filterRootIds.length;++t)this.removeFilterFromRoot(e.filterRootIds[t])}else{const e=this.getRoots();for(let t=0;t<e.length;++t)e[t].setCVFilterQuery(void 0)}s()}else{if(e.sequence_filter||e.config_filter){const i=e.root_physicalid,o=e.sequence_filter,s=e.config_filter;l=[];let c=!0;d||i&&this.getNode({id:i})&&(c=!1),a&&(c=!1),l.push({path:[i],sequence_filter:o,configBin:s}),this.publish({event:"onBeginFilterApplied"}),this._clearRootEvents(),this.removeRoots({pids:[i]},!1,!1),this.addRoots({objects:l},!1,r,c,function(e){this._restoreRootEvents(),this.publish({event:"onFilterApplied",data:{filter:{objects:e}}}),!0===n.getSetting("enopad3dviewer_lightNodeModel")&&h&&this.onSetTagsWithExpandSynthesis()}.bind(this,l)),t&&this._commandProxy&&this._commandProxy.applyFilter(e)}else if(e.root_physicalid){const t=this.getNode({id:e.root_physicalid});t.setSequenceFilter(void 0),t.setConfigFilter(void 0)}else{const e=this.getRoots();for(let t=0;t<e.length;++t)e[t].setSequenceFilter(void 0),e[t].setConfigFilter(void 0)}s()}else console.error("No parameter pass")}))},replaceFilter:function(e){return new Promise((t,n)=>{if(this._isAuthored())n("Filtering operation not permitted in authoring");else{const n=[{envId:i.getPlatformId(),serviceId:"3DSpace",objectId:e,objectType:"ENOStrRefinementSpecification"}];this._BIProxy.retrieveFilters({filterObjects:n,callback:n=>{const s=(e,t)=>{e&&this.addRoots({objects:[{path:[e],filterId:t}],loadWithFilter:!0,tenant:i.getPlatformId()},dispatch)},r=this.getRoots(),a=[];for(let e=0;e<n.success.length;++e)if(0===r.length)s(n.success[e].rootId,n.success[e].filterId),t();else{for(let t=0;t<r.length;++t)if(n.success[e].rootId===o.getNodeID(r[t])){this.getBIProxy().resetNGFilterUI({widgetId:i.getWidgetId(),NGFUXId:this._context.getNGFUXID(),appId:i.getAppId(),rootIds:[n.success[e].rootId]});const t=this.getRoot({id:n.success[e].rootId});t.setCVFilterQuery&&t.setCVFilterQuery(void 0),a.push(n.success[e].rootId),this.applyFilter(n.success[e].filter,!1,n.success[e])}t()}this.publish({event:"onFilterReplaced",data:{oldId:a,newId:e}})}})}})},_onFilterSelect:function(e){if(this._isAuthored())return this._BIProxy.setSelectStatus({status:!0}),void this._onTaggerSelectInAuthoring();let t=this.subscribe({event:"onSearchCompleted"},()=>{this.unsubscribe(t),this._BIProxy.setSelectStatus({status:!0})}),i=this.subscribe({event:"onSearchFailure"},()=>{this.unsubscribe(i),this._BIProxy.setSelectStatus({status:!0})});this.search({taggerSelect:e})},_onNGFilterVolume:function(e){require(["DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADPromise","DS/Selection/CSOManager"],(t,i,n)=>{if(n.empty(),e.action){let s=!0,r=i.getPromises().slice();i.createPromise(a=>{Promise.all(r).then(()=>{r=null;const l=[],d=[];let h=null;const c=t.getCommand("VolumeQueryHdr",this._context._context);this._context.publish({event:"onVolumeOpen",data:{changeType:e.volume}});const p=n.get();if(0==this._context._volumePanel&&(this._context.getRoots().length&&(e.volume?Array.isArray(e.volume.root_path_physicalid[0])&&("proximity"==e.volume.type?null==(h=this._context.unstreamPath(e.volume.root_path_physicalid[0]))?(s=!1,this._context.publish({event:"onVolumeOpen",data:{error:!0}})):(l.push({pathElement:h}),n.add(l)):0==p.length&&(d.push(e.volume.root_path_physicalid[0][0]),h=this._context.unstreamPath(d),l.push({pathElement:h}),n.add(l))):0==p.length&&(d.push(o.getNodeID(this._context.getRoots()[0])),h=this._context.unstreamPath(d),l.push({pathElement:h}),n.add(l))),s))if(c&&c.begin)c.begin();else if(this._executionContext&&this._executionContext.getComponent){const t=this._executionContext.getComponent("Viewer");t&&t.getCommandHandler&&null!==t.getCommandHandler()&&t._executeCommand({handlerId:"ENO3DVolumeQueryCmd",args:{changeType:e.volume,biData:e}})}0!==this._context.getRoots().length&&1!=this._context._controller._wait4Filter||(this._context._filterDrop=!0,this._context._controller.publish({event:"onEnableUX"}),this._context._controller.publish({event:"onDisableActionBar"}));let u=i.getPromises().slice();i.createPromise(t=>{Promise.all(u).then(()=>{u=null,s&&this._context.publish({event:"onVolumeOpen",data:{biData:e}}),t()})},"volumeFilterUpdate"),a()})},"volumeFilter")}else 0!==this._context._volumePanel&&this._context.publish({event:"onVolumeOpen",data:{closePanel:!0}})})},_onFilterClose:function(e){this.publish({event:"onEnableUX"}),this.fromProxy=!1,!0===this._wait4Filter&&"left"===e.panel&&(delete this._wait4Filter,!0===this._context._filterPanelOpen?(this._context._filterPanelOpen=!1,this.confirmModal=new r({callback:e=>{this.filterCancelCB(e),!1===this.fromProxy&&this._commandProxy.filterCancel({widget:"3D",result:e})}})):this.filterCancelCB(!0)),!0===this._useWrapToRemoveWhenFilter&&(this._useWrap=!1)},filterCancelCB:function(e){!1===this.fromProxy&&(!1!==e?!0===this.isStandaloneFilterAvailable()?(!0===n.getSetting("enopad3dviewer_lightNodeModel")?this.resumeProgressiveLoading():this.expand({paths:[[this._rootIds[this._rootIds.length-1]]]},!1,!0,!0),this.onSetTagsWithExpandSynthesis(),this._getStaticMappingExcludedOccurrences({serviceId:this.getRootStats(this._rootIds[this._rootIds.length-1]).serviceId,data:{rootPhID:this._rootIds[this._rootIds.length-1]}})):this.expand({paths:[[this._rootIds[this._rootIds.length-1]]]},!1,!0,!0):!1===e&&(!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._context._controller._engineState<=0&&this.resumeProgressiveLoading(),this.removeRoots({pids:this._context._filterRootIds},!0,!0)))},_clearRootEvents:function(){!0===this.isStandaloneFilterAvailable()&&(this._cbCounter--,this.unsubscribe(this._biRootAddedEvents),this.unsubscribe(this._biRootRemovedEvents),this._biRootAddedEvents=-1,this._biRootRemovedEvents=-1,this.publish({event:"onRootUpdateStart"}))},_restoreRootEvents:function(){!0===this.isStandaloneFilterAvailable()&&(this._cbCounter++,0===this._cbCounter&&(this._biRootAddedEvents=this.subscribe({event:"onRootAdditionTransactionComplete"},this.onSetTagsWithExpandSynthesis.bind(this)),this._biRootRemovedEvents=this.subscribe({event:"onEndRootRemoved"},this._rootRemovedProxyEvent.bind(this)),this.publish({event:"onRootUpdateEnd"})))},isStandaloneFilterAvailable:function(){return n.getSetting("enopad3dviewer_FilterAvailable")},isVolumeFilterAvailable:function(){return!0},isSlaveFilterAvailable:function(){return"SLAVE"===this._biMode},removeFilterFromRoot:function(e,t){const i=this.getRoot({id:e});n.getSetting("enopad3dviewer_lightNodeModel")?this.removeFilterFullReload([e]).then(()=>{this.publish({event:"onFilterRemoved",data:{id:e}})}).catch(function(e){console.error(e)}):i&&null!==i.getCVFilterQuery()&&void 0!==i.getCVFilterQuery()&&(this.publish({event:"onBeginFilterRemoved",data:{id:e}}),i.setCVFilterQuery&&i.setCVFilterQuery(void 0),this.publish({event:"onFilterRemoved",data:{id:e}}))},getPrdIdFromFilterId:function(e){return this._BIProxy.RetrievePrdFromFilterId(e)},refreshAppliedFilters:function(){if(!this._isAuthored()){const e=this.getRoots();for(let t=0;t<e.length;++t){const i=o.getNodeID(e[t]);this.isFiltered(i).hasFilter&&this.removeFilterFromRoot(i,!0)}}},isFiltered:function(e){let t=!1;return e&&(t=this._BIProxy.HasFilter(e)),t},getShareFilterSpec:function(e){const i=this.getBIProxy().getCtxForSharing(),n=this.getRoots();i.roots=[],i.rootsIds=[];for(let s=0;s<e.items.length;++s)for(let r=0;r<n.length;++r)if(o.getNodeID(n[r])===e.items[s].objectId){const a={id:e.items[s].objectId,hasFilter:!1};o.isFiltered(n[r],t.get())&&(a.hasFilter=!0),i.roots.push(a),i.rootsIds.push(e.items[s].objectId)}return i},dropShareFilterSpec:function(e,t,i){if(e.biProxyCtx.rootsIds){for(let t=0;t<e.biProxyCtx.rootsIds.length;++t){this.getRoot({id:e.biProxyCtx.rootsIds[t]})&&(this.publish({event:"onRootAlreadyExisting"}),e.biProxyCtx.rootsIds.splice(t,1))}e.biProxyCtx.rootsIds.length>0&&this._BIProxy.areRootsSharable(e.biProxyCtx.rootsIds,e.biProxyCtx).then(o=>{this._processShareFilterSpecResponse(e,o,t,i)}).catch(e=>{console.error(e)})}else{const t=[];for(let i=0;i<e.data.items.length;++i)t.push(e.data.items[i].objectId);this._BIProxy.areRootsSharable(t,e.biProxyCtx).then(t=>{this._processShareFilterSpecResponse(e,t,!1,i)}).catch(e=>{console.error(e)})}},_processShareFilterSpecResponse:function(e,t,o,n){for(let s=0;s<t.length;++s)if(!0===t[s].hasFilter)if(this._isAuthored()){this._onFilterInAuthoring();const e=[{path:[t[s].rootId]}];this.addRoots({objects:e},o,!0,n,null)}else this._BIProxy.resetNGFilterUI({widgetId:i.getWidgetId(),NGFUXId:this._context.getNGFUXID(),appId:i.getAppId(),rootIds:[t[s]]}),this._BIProxy.shareFilterSpec({fromRootId:t[s].rootId,fromSourceCtx:e.biProxyCtx,fromDropOnFilter:1===t.length&&e.fromFilter,callback:e=>{if(e.success.length)for(let i=0;i<e.success.length;++i)this._commandProxy.drop({pids:[t[s].rootId]}),setTimeout(function(e){this.applyFilter(e.filter,o,e)}.bind(this,e.success[i]),500);e.failure.length&&console.error("Failed to retrieve filters",e.failure)}});else{const e=[{path:[t[s].rootId]}];this.addRoots({objects:e},o,!0,n,null)}},_onFilterInAuthoring:function(){this.publish({event:"onFilterWithAuthoring"})},_onTaggerSelectInAuthoring:function(){this.publish({event:"onTaggerSelectWithAuthoring"})}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewer3DClusterController",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions","DS/ENOPAD3DViewer/utils/PAD3DOctree","DS/ENOPAD3DViewer/views/PAD3DPushpinNodeGroup","DS/ENOPAD3DViewer/views/PAD3DPOINodeNew"],function(e,t,i,o,n,s,r,a,l){return e.extend({_intRenderPCSNumMaxPOIs:0,_bCheckForMaxNodes:!1,_bCheckForMaxNodes_POITotalCount:5e3,_maxNodesToBeConsideredForRender:7e3,_isetVisib_outsideProjn:[],_isetVisib_outsideProj_str:[],_isetVisibility:[],_isetVisibility_str:[],_intRenderPCSNumMaxPOIs_layer:0,_update3DCluster:function(e,t){if("3d"===s.getClusteringType()){var o=this._model.getRootBag().getBoundingBox();this._groups&&this._groups.clear(),this._groupNodes&&this._groupNodes.removeChildren();var n=this._layers.get("POIs");if(n&&n.size>0){this._poisQuadTree&&(this._poisQuadTree.clear(),this._poisQuadTree=null);var l=e*t/5,d={x:(o.max.x+o.min.x)/2,y:(o.max.y+o.min.y)/2,z:(o.max.z+o.min.z)/2},h=Math.max(Math.abs(o.max.x-d.x),Math.max(Math.abs(o.max.y-d.y),Math.abs(o.max.z-d.z))),c={min:{x:d.x-(h+=.25*h),y:d.y-h,z:d.z-h},max:{x:d.x+h,y:d.y+h,z:d.z+h}};if(r._vpBBox=c,r.maxDepth=0,r.minDepth=null,r.maxDist=0,r.minDist=null,r.averageDist=0,r._sumDist=0,r._sumSums=0,!1===s.isMemPCS()&&(this._poisQuadTree=new r({box:c,minArea:l,viewpoint:this._context.getViewpoint(),viewerSize:{width:e,height:t}})),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){this._poisQuadTree=new r({box:c,minArea:1*l,viewpoint:this._context.getViewpoint(),viewerSize:{width:e,height:t},mem:1,id:0,iReductionFactor_VPBox:this._GE_VPBox_ReductionFactor}),this._intRenderPCSNumMaxPOIs=0;var p=[],u=[],g=[],_=[],f=0,v=0;n.forEach(function(e){var t=e;this._layerPOIsIdInstancingNodeMap&&this._layerPOIsIdInstancingNodeMap.get(t.getID())&&(f+=this._layerPOIsIdInstancingNodeMap.get(t.getID()).size),p[v]=0,u[v]=0,g[v]="",_[v]=0,this._vNumOfsinglePOIsinDisplay4Layer[v]=0,v++}.bind(this)),f>this._bCheckForMaxNodes_POITotalCount&&(this._bCheckForMaxNodes=!0),v=0}if(n.forEach(function(o){var n=o;if(n.isLayerVisible())if(n.isClustered()){if(!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){for(var l=0;l<12;l++)this._isetVisibility[l]=0,this._isetVisib_outsideProjn[l]=0,this._isetVisib_outsideProj_str[l]="",1===l||7===l||10===l?(1===l&&(this._isetVisibility_str[1]=" Single_InsideVPBox_NOT_FROM_OCTREE "),7===l&&(this._isetVisibility_str[7]=" Cluster "),10===l&&(this._isetVisibility_str[10]=" SingleinGrp ")):this._isetVisibility_str[l]="";this._intRenderPCSNumMaxPOIs_layer=0;var d=o.getNode3DBag(),h=new Map,c=new Map;if("\n  ------ Layer ID ------ "+n.getID()+" ------ Layer ID ------- ",!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){if(d&&d.children)for(var _=d.children,f=0;f<_.length;f++)_[f].className;if(d&&d.children)for(var m=d.children,b=0;b<m.length;b++)if("PAD3DPOINode"===m[b].className){var y=m[b].children;if(m[b]&&y&&y.length){var P=m[b].children;if((this._pinnedPOIExclusionMap.size||this._whiteListPOI&&this._whiteListPOI.size)&&P&&P.length){"\n  ------------------------ ","\n  @ 216 --- this._whiteListPOI ---- "+this._whiteListPOI.size,"\n  @ 216 --- children[j].children ---- "+m[b].children.length,"\n  ------------------------ ";var D=[],I=[],S=[],C=[];this._pinnedPOIExclusionMap.forEach(function(e,t){if(e._layerId===n.getID()){for(var i=P.length-1;i>=0;i--)P[i]&&n.getID()===P[i]._layerId&&P[i].name===e._name&&("\n  ^^^^^^^^^ @ _pinnedPOIExclusionMap MATCH FOUND  with child idx "+i+" , "+e._label+" , "+e._layerId+" , "+e._name,D.push(i));for(var o=P.length-1;o>=0;o--)if(n.getID()===P[o]._layerId){for(var s=!1,r=0;r<D.length;r++){o===D[r]&&(s=!0)}s||I.push(o)}}}.bind(this)),this._whiteListPOI.size&&this._whiteListPOI.forEach(function(e,t){if(e)if(e.node&&e.node._type&&e.node._name)"\n  @ _whiteListPOI "+t+", "+e.node._type+", "+e.node._name;else if("\n  @ _whiteListPOI "+t+" , "+e._label+" , "+e._layerId+" , "+e._name,n.getID()===e._layerId)for(var i=P.length-1;i>=0;i--)P[i]&&n.getID()===P[i]._layerId&&P[i].name===e._name&&("\n  ^^^^^^^^^ @ _whiteListPOI MATCH FOUND  with child idx "+i+", "+t+" , "+e._label+" , "+e._layerId+" , "+e._name,S.push(i));for(var o=P.length-1;o>=0;o--)if(n.getID()===P[o]._layerId){for(var s=!1,r=0;r<S.length;r++){o===S[r]&&(s=!0)}s||C.push(o)}}.bind(this));var w=m[b].children;if(w&&w.length){for(var x=" ",O=" ",A=[],M=" ",N=" ",V=0;V<S.length;V++)N+=", ",N+=S[V],M+=", ",S[V]<w.length&&(M+=w[S[V]].name,A.push(w[S[V]].name));for(var E=0;E<D.length;E++)N+=", ",N+=S[E],M+=", ",D[E]<w.length&&(M+=w[D[E]].name,A.push(w[D[E]].name));"\n  sKeepIdx "+N,"\n  sKeepIdxNames "+M;for(var T=w.length-1;T>=0;T--)if(n.getID()===w[T]._layerId){for(var R=!1,L=!1,F=0;F<S.length;F++)T===S[F]&&(R=!0);for(var k=0;k<D.length;k++)T===D[k]&&(L=!0);R||L||(O+=", ",O+=T,x+=", ",x+=w[T].name)}"\n  sRemoveIdx "+O,"\n  sRemoveIdxNames "+x;for(var B=m[b].children.length-1;B>=0;B--){bOKToRemove=!0;for(var G=0;G<A.length;G++)A[G]===m[b].children[B].name&&(bOKToRemove=!1);bOKToRemove&&m[b].removeChild(m[b].children[B])}"\n  ------ children[j].children.length  ------ AFTER REMOVE CHILD ------- ","\n  ------ "+m[b].children.length+" ------- ","\n  ------ children[j].children.length  ------ AFTER REMOVE CHILD ------- "}"\n  @ 380 --- this._whiteListPOI ---- "+this._whiteListPOI.size,"\n  @ 380 --- children[j].children ---- "+m[b].children.length,"\n  ------------------------ "}else"\n  @ 385 --- removeAllChildren ",m[b].removeChildren()}}if(d&&d.children){var U=d.children;for(f=0;f<U.length;f++)U[f].className}}}this._poisQuadTree.empty();var z=this._context.getViewpoint().position,W=(new i.Vector3).subVectors(this._context.getViewpoint().target,z),H=this._proximityGroups.get(n.getID());if(H&&H.size>0)for(var j=H.values(),Q=j.next();!Q.done;){var q=Q.value;if(n.getID()===q.layerID)if(this._whiteListPOI.has(q.node._name)||this._poisQuadTree.isPointInsideViewpointBox(q.position))!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(q.node._isVisible||((!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(q.node.setOpacity(1),q.node.setVisibility(!0),this._isetVisibility[0]++),this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++)),!1===s.isMemPCS()&&(q.node.setOpacity(1),q.node.setVisibility(!0));else{var X={layer:n.getID(),node:q.node,pois:q.pois,coord3D:q.position,name:q.name},K={position3D:q.position,data:X};this._poisQuadTree&&this._poisQuadTree.insert(K),this._isetVisib_outsideProjn[0]++}Q=j.next()}if(!1===s.isMemPCS())var Z=this._layerPOIsIdInstancingNodeMap.get(n.getID());if(!0===s.isClusteringEnabled()&&!0===s.isMemPCS())Z=this._layerPOIsIdInstancingNodeMapMaster.get(n.getID());z=this._context.getViewpoint().position,W=(new i.Vector3).subVectors(this._context.getViewpoint().target,z);var J=this._context.getViewpoint();if(Z&&Z.size>0&&n.isClustered()){var Y=Z.values(),$=Y.next();Z.size;for(;!$.done;){var ee=$.value;if(!ee.instancingPOI){var te=ee.getPosition();if(!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){var ie=!1,oe=!1;!0===(oe=this._poisQuadTree.isPointInsideViewpointBox(te))&&(oe=this._isPointInside_Projection(te,z,W,J,e,t),0);var ne=this._tooltipNodesPinnedMap.get(n.getID());(this._whiteListPOI.has(n.getID()+"_"+ee.instanceId)||oe||ne&&ne.has(ee.instanceId))&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(this._proximityGroupedPOIs.get(ee.instanceId+"_"+ee._layerId)||(","+ee.instanceId,this._seedNewNode(ee,n,h,c,1,1,v),this._isetVisibility[1]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++,ie=!0))}if(!1===s.isMemPCS()){ne=this._tooltipNodesPinnedMap.get(n.getID());(this._whiteListPOI.has(n.getID()+"_"+ee.instanceId)||this._poisQuadTree.isPointInsideViewpointBox(te)||ne&&ne.has(ee.instanceId))&&(ee.setOpacity(1),ee.setVisibility(!0))}var se=!1,re=(ee.instanceId,n.getID(),this._proxGroupPOIsForLayer.get(n.getID()));if(re&&re.size>0){var ae=re.get(ee.instanceId);ae&&(se=!0)}ne=this._tooltipNodesPinnedMap.get(n.getID());if(!1===s.isMemPCS())if(!se&&!(this._whiteListPOI.has(n.getID()+"_"+ee.instanceId)||this._poisQuadTree.isPointInsideViewpointBox(te)||ne&&ne.has(ee.instanceId))&&W.x*(te.x-z.x)+W.y*(te.y-z.y)+W.z*(te.z-z.z)>0){X={layer:n.getID(),node:ee,instanceId:ee.instanceId,coord3D:ee.getPosition(),color:ee.getColorPOI(),id:ee.getId(),label:ee.getLabelPOI()};var le={position3D:ee.getPosition(),data:X};this._poisQuadTree&&this._poisQuadTree.insert(le)}else!se&&(this._whiteListPOI.has(n.getID()+"_"+ee.instanceId)||this._poisQuadTree.isPointInsideViewpointBox(te)||ne&&ne.has(ee.instanceId))?(ee.setOpacity(1),ee.setVisibility(!0)):(ee.isVisible()&&ee.setVisibility(!1),0);if(!0===s.isClusteringEnabled()&&!0===s.isMemPCS())if(!se&&!(this._whiteListPOI.has(n.getID()+"_"+ee.instanceId)||oe||ne&&ne.has(ee.instanceId))&&W.x*(te.x-z.x)+W.y*(te.y-z.y)+W.z*(te.z-z.z)>0){var de=!1,he=J.project((new i.Vector3).copy(te));he&&he.x>20&&he.y>32&&he.x<e&&he.y<t&&(de=!0);X={layer:n.getID(),node:ee,instanceId:ee.instanceId,coord3D:ee.getPosition(),color:ee.getColorPOI(),id:ee.getId(),label:ee.getLabelPOI()},le={position3D:ee.getPosition(),data:X};this._poisQuadTree&&de&&this._poisQuadTree.insert(le)}else!se&&(this._whiteListPOI.has(n.getID()+"_"+ee.instanceId)||oe||ne&&ne.has(ee.instanceId))?oe&&ie||(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(ee.setOpacity(1),ee.setVisibility(!0),this._isetVisibility[2]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++):(ee.isVisible()&&ee.setVisibility(!1),0)}$=Y.next()}}else if(this._proximityGroups&&this._proximityGroups.size>0&&this._proximityGroups&&this._proximityGroups.size>0){W=(new i.Vector3).subVectors(this._context.getViewpoint().target,z);this._proximityGroups.forEach(function(o){o.forEach(function(o){if(n.getID()===o.layerID)if(this._layerController.getLayer(o.layerID)){var r=this._context.getViewpoint().project((new i.Vector3).copy(o.position));r&&r.x>20&&r.y>32&&r.x<e&&r.y<t?(!1===s.isMemPCS()&&o.node.setVisibility(!0),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(o.node.setVisibility(!0),this._isetVisibility[3]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++)):o.node.setVisibility(!1)}else o.node.setVisibility(!1)}.bind(this))}.bind(this))}var ce=[];if(r.minDist!==r.maxDist)var pe=r.minDist-r.maxDist;else pe=1e-7;var ue=.8/pe,ge=1-ue*r.minDist;if(this._poisQuadTree.getLeaves(ce),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){for(var _e=0,fe="",ve=0,me="",be="",ye=0,Pe=0;Pe<ce.length;++Pe)ce[Pe].content&&(be+=", "+ce[Pe].content.length),!0===ce[Pe].hideAll&&(be+=", (HA: "+ce[Pe].content.length+"), "),!0===ce[Pe].displayAll&&(me+=","+ce[Pe].content.length,"\n  -- displayAll -- "+n.getID()+" ---  ( nDivtmp "+Pe+", of "+ce.length+" ("+ce[Pe].content.length+" ) ",g[v]=""+n.getID()),ce[Pe].content.length>1?(_e+=ce[Pe].content.length,fe+=","+ce[Pe].content.length,ve++,"\n  --- "+n.getID()+" ---  ( nDivtmp "+Pe+", of "+ce.length+" ("+ce[Pe].content.length+" ) "," ( nDivtmp "+Pe+", of "+ce.length+" ("+ce[Pe].content.length+" ) "):1===ce[Pe].content.length&&(ye++,_e+=ce[Pe].content.length,"\n  -- SINGLE POI -- "+n.getID()+" ---  ( nDivtmp "+Pe+", of "+ce.length+" ("+ce[Pe].content.length+" ) ");var De={len:ce.length,lennonSingleleaves:ve,lennonSingleleavesStr:fe,lenSinglePOICount:ye,lenStr:be,more:ve,moreStr:fe,displayAll:me};p[v]=De,u[v]=_e,v++}!1===s.isMemPCS()&&(Z=this._layerPOIsIdInstancingNodeMap.get(n.getID()));for(var Ie=0;Ie<ce.length;++Ie){var Se=ce[Ie].content,Ce=ce[Ie].center.x,we=ce[Ie].center.y,xe=ce[Ie].center.z,Oe=this._context.getViewpoint().position.x-Ce,Ae=this._context.getViewpoint().position.y-we,Me=this._context.getViewpoint().position.z-xe;(Ue=ue*Math.sqrt(Oe*Oe+Ae*Ae+Me*Me)+ge)>.92&&(Ue=1),Ue<=.25&&(Ue=.25);var Ne=ce[Ie].size;if(n.getGroupView())n.getGroupView();if(ce[Ie].displayAll)for(var Ve=0;Ve<Se.length;Ve++){if((Ee=Se[Ve])&&!Ee.isInProxGroup)(Re=Ee.data.node)&&(!1===s.isMemPCS()&&(Re.setOpacity(1),Re.setVisibility(!0)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(this._seedNewNode(Re,n,h,c,4,1,v),this._isetVisibility[4]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++));else if(Ee&&Ee.isInProxGroup){if(Te=this._proximityGroups.get(Ee.layerId))(Re=Te.get(Ee.isInProxGroup).node)&&(!1===s.isMemPCS()&&(Re.setOpacity(1),Re.setVisibility(!0)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(Re.setOpacity(1),Re.setVisibility(!0),this._isetVisibility[5]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++))}}else if(ce[Ie].hideAll)for(Ve=0;Ve<Se.length;Ve++){var Ee;if((Ee=Se[Ve])&&!Ee.isInProxGroup)(Re=Ee.data.node)&&Re.isVisible()&&Re.setVisibility(!1);else if(Ee&&Ee.isInProxGroup){var Te,Re;if(Te=this._proximityGroups.get(Ee.layerId))if((Re=Te.get(Ee.isInProxGroup).node)&&Re.isVisible())if(!1===s.isMemPCS()&&(Re.setOpacity(1),Re.setVisibility(!0)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS())this._isPointInside_Projection(Re._position,z,W,J,e,t)&&("\n  setVisibility to 816 "+Re.instanceId,(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(Re.setOpacity(1),Re.setVisibility(!0),this._isetVisibility[6],this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++))}}else if(Se.length>1){if("2d"===s.getClusteringType()||"3d"===s.getClusteringType())if(ce[Ie].onlyOneProx||ce[Ie].displayAll){if(null!==ce[Ie].onlyOneProx&&!ce[Ie].displayAll){Ce=ce[Ie].center.x,we=ce[Ie].center.y,xe=ce[Ie].center.z,Oe=this._context.getViewpoint().position.x-Ce,Ae=this._context.getViewpoint().position.y-we,Me=this._context.getViewpoint().position.z-xe;if((Ue=ue*Math.sqrt(Oe*Oe+Ae*Ae+Me*Me)+ge)>.92&&(Ue=1),Ue<=.25&&(Ue=.25),!1===s.isMemPCS()&&(ce[Ie].onlyOneProx.data.node.setVisibility(!0),ce[Ie].onlyOneProx.data.node.setOpacity(Ue)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){var Le=new i.Vector3(ce[Ie].center.x,ce[Ie].center.y,ce[Ie].center.z);this._isPointInside_Projection(Le,z,W,J,e,t)?(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(ce[Ie].onlyOneProx.data.node.setVisibility(!0),this._isetVisibility[8]++,ce[Ie].onlyOneProx.data.node.setOpacity(Ue),this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++):this._isetVisib_outsideProjn[8]++}}}else{var Fe=new a({parent:this._groupNodes,fillColor:n.getColor(),position:{x:Ce,y:we,z:xe},position3D:{x:Ce,y:we,z:xe},opacity:Ue,number:Ne,name:"PAD3DPOIGroupNode"+Ie+"_"+n.getID(),layerID:n.getID(),type:"2DClusteringNode",scale:n.getPOIScale(),icon:n.getPOIIcon(),onHoverCallback:this._onHoveroverPOINodeGroupcallback.bind(this),outHoverCallback:this._outHoveroverPOINodeGroupcallback.bind(this)});if(this._groups.set("PAD3DPOIGroupNode"+Ie+"_"+n.getID(),{pois:Se,layer:n.getID(),layerID:n.getID(),position3D:{x:Ce,y:we,z:xe},position:{x:Ce,y:we,z:xe},node:Fe,name:"PAD3DPOIGroupNode"+Ie+"_"+n.getID(),layerGroupView:n.getGroupView()}),!1===s.isMemPCS()&&Fe.setVisibility(!0),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){var ke=new i.Vector3(ce[Ie].center.x,ce[Ie].center.y,ce[Ie].center.z);this._isPointInside_Projection(ke,z,W,J,e,t)?(Fe.setVisibility(!0),this._isetVisibility[7]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++):(this._isetVisib_outsideProjn[7]++,this._isetVisib_outsideProj_str[7]+=","+Se.length)}}else for(var Be=0;Be<elems.length;Be++){var Ge=elems[Be].node;Ge&&(!1===s.isMemPCS()&&(Ge.setOpacity(Ue),Ge.setVisibility(!0)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(Ge.setOpacity(Ue),Ge.setVisibility(!0),this._isetVisibility[9]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++))}Se.length}else if(1===Se.length&&Se[0]){var Ue,ze=Se[0].data.node;Oe=this._context.getViewpoint().position.x-Ce,Ae=this._context.getViewpoint().position.y-we,Me=this._context.getViewpoint().position.z-xe;(Ue=ue*Math.sqrt(Oe*Oe+Ae*Ae+Me*Me)+ge)>.92&&(Ue=1),Ue<=.25&&(Ue=.25),ze&&(!1===s.isMemPCS()&&(ze.setOpacity(Ue),ze.setVisibility(!0)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(this._isetVisibility[10]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++,this._seedNewNode(ze,n,h,c,10,Ue,v)))}}!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(this._layerPOIsIdInstancingNodeMap.set(n.getID(),h),this._layerPOIsIdInstancingIndexMap.set(n.getID(),c))}else if(this._proximityGroups&&this._proximityGroups.size>0&&this._proximityGroups&&this._proximityGroups.size>0){z=this._context.getViewpoint().position,W=(new i.Vector3).subVectors(this._context.getViewpoint().target,z);var We=this._proximityGroups.get(n.getID());We&&We.forEach(function(o){if(this._layerController.getLayer(o.layerID)){var n=this._context.getViewpoint().project((new i.Vector3).copy(o.position));n&&n.x>20&&n.y>32&&n.x<e&&n.y<t?(!1===s.isMemPCS()&&(o.node.setVisibility(!0),o.node.render()),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&(!this._bCheckForMaxNodes||this._bCheckForMaxNodes&&this._intRenderPCSNumMaxPOIs<this._maxNodesToBeConsideredForRender)&&(o.node.setVisibility(!0),o.node.render(),this._isetVisibility[11]++,this._intRenderPCSNumMaxPOIs++,this._intRenderPCSNumMaxPOIs_layer++)):(o.node.setVisibility(!1),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()&&this._isetVisib_outsideProjn[11]++)}else o.node.setVisibility(!1)}.bind(this))}}.bind(this)),!0===s.isClusteringEnabled()&&!0===s.isMemPCS()){this._vNumLeavesOfLayer=p,this._vNumOfPOIsInLeavesOfLayer=u,this._vNumOfdisplayAllPOIsInLeavesOfLayer=g;for(var m=[],b=0;b<12;b++)1===b||7===b||10===b?(1===b&&(m[1]=" 1_11_Single_INSIDE_VPBox_NOT_FROM_OCTREE "),7===b&&(m[7]=" 7_11_Cluster "),10===b&&(m[10]=" 10_11_SingleinGrp ")):m[b]="";this._vStrOfPOIs=m}}}},_isPointInside_Projection:function(e,t,o,n,s,r){var a=!1;if(n)if(o.x*(e.x-t.x)+o.y*(e.y-t.y)+o.z*(e.z-t.z)>0){var l=n.project((new i.Vector3).copy(e));a=!!(l&&l.x>20&&l.y>32&&l.x<s&&l.y<r)}else a=!1;return a},_seedNewNode:function(e,t,o,n,r,a,d){var h,c,p,u,g,_;if(t){var f=t.getNode3DBag();if(f&&f.children)for(var v=f.children,m=0;m<v.length;m++)"PAD3DPOINode"===v[m].className&&(h=v[m])}h&&t&&e&&(!0===e.instancingPOI?(p=e.position,u=e.label,g=e.id,_=e.color):(p=e._position,u=e._label,g=e._poiId,_=e._fillColor),p&&(this._vNumOfsinglePOIsinDisplay4Layer&&(this._vNumOfsinglePOIsinDisplay4Layer[d]+=1),(c=new l({context:this._context,parent:h,fillColor:_,position:new i.Vector3(p.x,p.y,p.z),instanceId:e.instanceId,poiId:g,name:"PAD3DPOINode_"+e.instanceId,label:u,layerId:t.getID(),scale:t.getPOIScale(),icon:t.getPOIIcon(),poiType:s.getPOIType(),pickability:e.pickability,enablePOIPanel:void 0===e.enablePOIPanel||e.enablePOIPanel,onHoverCallback:this._onHoveroverPOINodecallback.bind(this),outHoverCallback:this._outHoveroverPOINodecallback.bind(this)}))&&o&&n&&(o.set(e.instanceId,c),n.set(e.instanceId,g),a?c.setOpacity(a):c.setOpacity(1),c.setVisibility(!0))));return c}})}),define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerPOIGroupEngine",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Visualization/SceneGraphUtils","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADPromise","DS/PADUtils/PADUtilsServices","DS/PADServices/utils/PADTrackerManager","DS/ENOPAD3DViewer/mixins/_PAD3DViewerTooltipController","DS/ENOPAD3DViewer/mixins/_PAD3DViewer2DClusterController","DS/ENOPAD3DViewer/mixins/_PAD3DViewer3DClusterController","DS/Visualization/ThreeJS_DS","DS/ENOPAD3DViewer/views/PAD3DPOINodeNew","DS/ENOPAD3DViewer/views/PAD3DPushpinNodeGroup","DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/ENOPAD3DViewer/utils/PAD3DViewer3DProximityServices","DS/ENOPAD3DViewer/views/PAD3DPOIPanel","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_,f,v,m,b,y,P,D){"use strict";return t.extend(p,u,g,{name:"PAD3DViewerPOIGroupEngine",_visuEventOnEndMove:null,_realMove:!1,_poisQuadTree:null,_groups:null,_proximityGroups:null,_threeDGroups:[],_doubleClickFlag:!1,_clicked:!1,_hiddenLayersNum:0,_groupNodes:null,_factorPOI:10,_selectedGroup:null,_clustersPerLine:null,_preselectedPOI:null,_preselectedGroup:null,_preselectedGroupHoverNode:null,_preselectedSinglePOIHoverNode:null,_preselectedSinglePOINode:null,_bhoverOverGroupNode:!1,_bHoverOverPOIHoverTooltip:!1,_bHoverOverPOIHoverTooltip_Pin_as_clicked:!1,_bHoverOverPinnedToUnpinned_clicked:!1,_preselectionTokensGroups:[],_selectionTokensGroups:[],_blockPanelOpening:!1,_poiGroupCommandProxy:null,_proximityGroupedPOIs:null,_proxGroupPOIsForLayer:null,_proximityGroupsInitDone:null,_selectedProxGrp:null,_POIIdGroupedPOIs:null,_pinnedPOIExclusionMap:null,_blockPanelUpdate:0,_blockPanelUpdate_dbg:0,_timeoutViewpointEnd:null,_updateClustersInProgress:!1,_updateDblClickInProgress:!1,_doNotInvokePOIClusterUpdate:!1,_vNumLeavesOfLayer:[],_vNumOfPOIsInLeavesOfLayer:[],_vNumOfdisplayAllPOIsInLeavesOfLayer:[],_vNumOfsinglePOIsinDisplay4Layer:[],_vStrOfPOIs:[],_i_ondblClick:0,_i_onSingleMouseClick:0,_i_onDoubleMouseClick:0,_i_onHoverSinglePOI_active:0,_i_onHoverNodeGroup_active:0,_i_onHoverInstancingPOI_active:0,_POIPanelClickedPOIPos:null,_POIPanelClickedPOI_HL:null,_POIPanelClickedPOIGeom_HL:null,setupPOIGroupEngine:function(e){if(this._proximityGroupedPOIs||(this._proximityGroupedPOIs=new Map),this._POIIdGroupedPOIs||(this._POIIdGroupedPOIs=new Map),this._proxGroupNameLayerId||(this._proxGroupNameLayerId=new Map),this._groupNodes||(this._groupNodes=new m("PAD3DPOIGroupNode"),this._groupNodes.className="PAD3DPOIGroupNode",this.getDecorationBag().addChild(this._groupNodes)),this._proximityGroupsInitDone||(this._proximityGroupsInitDone=new Map),this._proximityGroups||(this._proximityGroups=new Map),this._proxGroupPOIsForLayer||(this._proxGroupPOIsForLayer=new Map),this._tooltipNodes||(this._tooltipNodes=new m("PAD3DPOITooltipNode"),this._tooltipNodes.className="PAD3DPOITooltipNode",this.getDecorationBag().addChild(this._tooltipNodes),this._tooltipNodesMap=new Map),this._tooltipNodesPinnedMap||(this._tooltipNodesPinnedMap=new Map),this._abortCB&&this._context.unsubscribe(this._abortCB),this._abortCB=this._context.subscribe({event:"onRootRemoved"},function(e){this._tooltipFrame&&!this._tooltipFrame.isClosed()&&(this._tooltipFrame.hide(),this._blockPanelUpdate=0),this.stopPOIClusters()}.bind(this)),!0===D.isClusteringEnabled()&&!0===D.isMemPCS()&&window.addEventListener("dblclick",this.ondblClickGE.bind(this)),!0===D.isClusteringEnabled()&&!0===D.isMemPCS()&&window.addEventListener("click",this.onClickGE.bind(this)),require(["DS/PADUtils/PADCommandProxy"],function(e){this._poiGroupCommandProxy=e.create()}.bind(this)),l.subscribe("DS/PADUtils/PADCommandProxy/select",this._reportSelectForProbe.bind(this)),this._pinnedPOIExclusionMap=new Map,this._clustersPerLine=Math.floor(Math.sqrt(D.getMaxClusters())),this._groups=new Map,this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)}),this._tooltipFrame.hide(),D.setGroupEngineInit(!0),this._visuEventOnEndMove||(this._visuEventOnEndMove=i.subscribe({event:"/VISU/"},function(e){if(e.eventType&&"@onMoveEvent"===e.eventType){var t=!1;if(e.from&&e.from.externalPath&&e.from.externalPath.length>1&&"PAD3DZOINode"===e.from.externalPath[e.from.externalPath.length-1].className?t=!0:e.from&&e.from.externalPath&&e.from.externalPath.length>2&&"PAD3DPOITooltipNode"===e.from.externalPath[1].className&&(t=!0),t||this._tooltipNodes&&this._tooltipNodes.children&&1===this._tooltipNodes.children.length&&"ZOITooltip"===this._tooltipNodes.children[0].className&&this._tooltipNodes.removeChildren(),e.eventID,"@pickMesh"===e.eventID&&(this._blockPanelUpdate_dbg=0,e.from&&e.from.externalPath&&"PAD3DZOINode"===e.from.externalPath[e.from.externalPath.length-1].className)){var i,o=e.from.externalPath[e.from.externalPath.length-1].id,n=this._zoneIdToLayerMap.get(o);if(n){var s,r=this._tooltipNodesPinnedMap.get(n);if(r){if(r&&r.has(o)){var a=r.get(o);a&&(a._POIObject._node&&a._POIObject._node.id===path[j+1].id&&a._POIObject._name===path[j+1].name||a._POIObject.instanceId)&&(s=a)}}else if(this._layers.get("ZOIs")){var l=this._layers.get("ZOIs").get(n).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned");l&&l&&l.getChildren().forEach(function(e){o===e.name&&(s=e)}.bind(this))}}if(s)i=s,this._preselectedSinglePOIHoverNode_ExistingFound=!0;else{this._preselectedSinglePOIHoverNode_ExistingFound=!1,this._tooltipNodes||(this._tooltipNodes=new m("PAD3DPOITooltipNode"),this._tooltipNodes.className="PAD3DPOITooltipNode",this.getDecorationBag().addChild(this._tooltipNodes),this._tooltipNodesMap=new Map),this._tooltipNodes.removeChildren();(i=this._createHoverTooltip(e.from.externalPath[e.from.externalPath.length-1],"ZOI","ZOI",n,this,!1,!1,!1,!1,e.point))&&i.render()}this._preselectedSinglePOIHoverNode=i}}switch(e.eventType){case"@onClickEvent":if(1===this._i_onSingleMouseClick&&(1===this._i_onHoverSinglePOI_active||1===this._i_onHoverInstancingPOI_active||1===this._i_onHoverNodeGroup_active||2===this._i_onHoverNodeGroup_active)){this._i_onSingleMouseClick=0;var d=c.getPADTracker({eventCategory:"usage",eventAction:"3d_singleClick_stats"});1===this._i_onHoverSinglePOI_active&&(d.persDim.pd2="Single POI"),1===this._i_onHoverInstancingPOI_active&&(d.persDim.pd2="Instancing POI"),1===this._i_onHoverNodeGroup_active&&(d.persDim.pd2="POI Group"),2===this._i_onHoverNodeGroup_active&&(d.persDim.pd2="POI Proximity Group"),d.trackPageEvent()}break;case"@onViewpointChange":this._realMove&&clearTimeout(this._timeoutViewpointEnd),this._realMove=!0,this._tooltipNodes&&this._tooltipNodes.children&&this._tooltipNodes.children.length>0&&this._tooltipNodes.removeChildren();break;case"@onViewpointEndMove":case"@onViewpointEndMove_bis":this._realMove&&(this._realMove=!1,this._updatePOIClustersTimedout(),this._tooltipNodes&&this._tooltipNodes.removeChildren())}}.bind(this))),this._selectionTokensGroups&&this._selectionTokensGroups.length>0){for(var t=0;t<this._selectionTokensGroups.length;++t)o.unsubscribe(this._selectionTokensGroups[t]);this._selectionTokensGroups=[]}this._selectionTokensGroups.push(o.onPostAdd(this._onClickGroup.bind(this))),this._selectionTokensGroups.push(o.onEmpty(this._emptyAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._leaveHoverAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._onClickGroup.bind(this)))},_reportSelectForProbe:function(e){},onClickGE:function(){this._i_onSingleMouseClick=1},ondblClickGE:function(){if(this._i_onDoubleMouseClick=1,1===this._i_onDoubleMouseClick&&(1===this._i_onHoverSinglePOI_active||1===this._i_onHoverInstancingPOI_active||1===this._i_onHoverNodeGroup_active||2===this._i_onHoverNodeGroup_active)){this._i_onDoubleMouseClick=0;var e=c.getPADTracker({eventCategory:"usage",eventAction:"3d_doubleClick_stats"});1===this._i_onHoverSinglePOI_active&&(e.persDim.pd2="Single POI"),1===this._i_onHoverInstancingPOI_active&&(e.persDim.pd2="Instancing POI"),1===this._i_onHoverNodeGroup_active&&(e.persDim.pd2="POI Group"),2===this._i_onHoverNodeGroup_active&&(e.persDim.pd2="POI Proximity Group"),e.trackPageEvent()}this._i_ondblClick=1,this._blockPanelUpdate_dbg=0},setup3DProximityGroups_new:function(e,t){D.setProximityMergingActive(!0);var i=this._layers.get("POIs");if(i&&i.size>0){var o,n=i.get(e),s=new Map;if(this._proximityGroups||(this._proximityGroups=new Map),this._proximityGroups.set(e,s),this._proxGroupPOIsForLayer&&(this._proxGroupPOIsForLayer.has(e)?o=this._proxGroupPOIsForLayer.get(e):(o=new Map,this._proxGroupPOIsForLayer.set(e,o))),n.isVisible()&&n.isProximityMerged()){this._proximityGroupsInitDone.set(e,!0);var r=new Map;(A=n.getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity"))&&A.removeChildren();var a,l=[];if(!1===D.isMemPCS()&&this._layerPOIsIdInstancingNodeMap&&this._layerPOIsIdInstancingNodeMap.size)a=this._layerPOIsIdInstancingNodeMap.get(e);else if(!0===D.isClusteringEnabled()&&!0===D.isMemPCS()&&this._layerPOIsIdInstancingNodeMapMaster&&this._layerPOIsIdInstancingNodeMapMaster.size)a=this._layerPOIsIdInstancingNodeMapMaster.get(e);else{for(var d=this._pois.length,h=this._pois.length-t,c=new Map,p=h;p<d;p++){var u=5*(p-h+1),g=new _.Vector3(this._pois[p].position.x,this._pois[p].position.y,this._pois[p].position.z);void 0===(C=this._pois[p].color)&&n.getStyles()&&this._pois[p].style&&n.getStyles().has(this._pois[p].style)&&(C=n.getStyles().get(this._pois[p].style).color),c.set(u,{instanceId:u,color:C,id:this._pois[p].id,label:this._pois[p].label,position:g,instancingPOI:!0})}a=c}if(a&&a.size>0){for(var f=a.values(),b=f.next();!b.done;){var P=b.value;if(P.instancingPOI){var I=P.position;void 0===(C=P.color)&&n.getStyles()&&void 0!==P.style&&n.getStyles().has(P.style)&&(C=n.getStyles().get(P.style).color);var S={position3D:I,data:{layer:e,node:P,instanceId:P.instanceId,coord3D:I,color:C,id:P.id,label:P.label}};l.push(S)}else{var C;I=P.getPosition();void 0===(C=P.getColorPOI())&&n.getStyles()&&void 0!==P.style&&n.getStyles().has(P.style)&&(C=n.getStyles().get(P.style).color);S={position3D:I,data:{layer:e,node:P,instanceId:P.instanceId,coord3D:I,color:C,id:P.getId(),label:P.getLabelPOI()}};l.push(S)}b=f.next()}var w=this._context.getRoots();if(w&&w.length)for(var x=y.getLayerGroupsBy3DProximity({context:this._context,bbox:w[0],layerPOIData:l,proximityThreshold:n.getProximityThreshold(),octree_Depth:1}),O=0;O<x.length;O++){var A,M="PAD3DPOIProximityGroup_"+O+"_"+e,N=x[O],V=0,E=0,T=0;if(N.pois.length){for(var R=0;R<N.pois.length;R++){N.pois[R].layerId=e,N.pois[R].isInProxGroup=M,N.pois[R].position3D=N.pois[R].data.coord3D;var L=N.pois[R].id,F=a.get(L),k=F.instanceId+"_"+e;if(F&&!F.instancingPOI){F.setVisibility(!1),this._proximityGroupedPOIs.set(k,{poi:F,groupName:M}),r.set(F.instanceId,{poi:F,groupName:M}),F.instanceId&&o&&o.set(F.instanceId,{pos:N.pois[R].position3D,isInstancing:F.instancingPOI});var B=F.getPosition();V+=B.x,E+=B.y,T+=B.z}else L&&o&&o.set(L,{pos:N.pois[R].position3D,isInstancing:F.instancingPOI}),this._proximityGroupedPOIs.set(k,{poi:F,groupName:M}),r.set(F.instanceId,{poi:F,groupName:M}),V+=N.pois[R].data.coord3D.x,E+=N.pois[R].data.coord3D.y,T+=N.pois[R].data.coord3D.z}V/=N.pois.length,E/=N.pois.length,T/=N.pois.length}if(N.position3D=new _.Vector3(V,E,T),(A=n.getNode3DBag().getChildByName("PAD3DPOIGroupNode_Proximity"))||((A=new m("PAD3DPOIGroupNode_Proximity")).className="PAD3DPOIProximityNode",n.getNode3DBag().addChild(A)),A){var G=new v({parent:A,fillColor:n.getColor(),position:N.position3D,number:N.pois.length,type:"3DClusteringNode",name:M,layerID:e,scale:n.getPOIScale(),icon:n.getPOIIcon(),onHoverCallback:this._onHoveroverPOINodeGroupcallback.bind(this),outHoverCallback:this._outHoveroverPOINodeGroupcallback.bind(this)});D.isClusteringEnabled()||G.setVisibility(!0),this._proxGroupNameLayerId.set(M,e),s.set(M,{pois:N.pois,layer:e,layerID:e,position:N.position3D,node:G,layerGroupView:n.getGroupView()})}}}this._POIIdGroupedPOIs.set(e,r)}}},setup3DProximityGroups:function(e){D.isProximityMergingActive()||(this._POIIdGroupedPOIs?this._POIIdGroupedPOIs.clear():this._POIIdGroupedPOI=new Map,this._proximityGroupedPOIs?this._proximityGroupedPOIs.clear():this._proximityGroupedPOIs=new Map,D.setProximityMergingActive(!0));var t=this._layers.get("POIs");if(t&&t.size>0){var i=t.get(e);this._proximityGroupsInitDone.get(i.getID())||this.setup3DProximityGroups_new(i.getID(),0)}},_hideGroupsForLayer:function(e){var t=e.getID(),i=this._groupNodes.getChildren();this._groupNodes.removeChildren(),this._tooltipFrame&&this._tooltipFrame.hide();for(var o=0;o<i.length;++o){var n=this._groups.get(i[o].name);n&&n.layerID!==t&&this._groupNodes.addChild(i[o])}this._layerController.setCustomHeaderVisibility(e.getKind(),!0),setTimeout(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this),50)},_isReframeAllowed:function(){return 1!=this._context.getViewer().get360Mode()},_updatePOIClustersTimedout:function(){clearTimeout(this._timeoutViewpointEnd),this._timeoutViewpointEnd=setTimeout(function(){"2d"!==D.getClusteringType()&&"3d"!==D.getClusteringType()&&!0!==D.isProximityMergingActive()||(this._layerController.getKindsWithPOI().forEach(function(e){this._layerController.setCustomHeaderVisibility(e,!0)}.bind(this)),setTimeout(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this),50));this._tooltipNodes&&this._tooltipNodes.removeChildren()}.bind(this),1e3)},_updatePOIClusters:function(){return new Promise(function(e){var t,i,o=new Date;if(this._context){if(this._context.getViewpoint())var n=this._context.getViewpoint().position;this._context.getViewer()&&(t=this._context.getViewer().SCREEN_WIDTH,i=this._context.getViewer().SCREEN_HEIGHT)}if(this._updateClustersInProgress=!0,this._context)if("3d"===D.getClusteringType()){if(!1===D.isMemPCS()&&this._update3DCluster(t,i),!0===D.isClusteringEnabled()&&!0===D.isMemPCS()){this._vNumLeavesOfLayer=[],this._vNumOfPOIsInLeavesOfLayer=[],this._vNumOfdisplayAllPOIsInLeavesOfLayer=[],this._vNumOfsinglePOIsinDisplay4Layer=[],this._vStrOfPOIs=[],this._GE_VPBox_ReductionFactor=1,this._update3DCluster(t,i);var s=0;if(this._vNumOfsinglePOIsinDisplay4Layer)for(var r=0;r<this._vNumOfsinglePOIsinDisplay4Layer.length;r++)this._vNumOfsinglePOIsinDisplay4Layer[r]&&this._vNumOfsinglePOIsinDisplay4Layer[r]>0&&(s+=this._vNumOfsinglePOIsinDisplay4Layer[r]);var a=0,l=0,d=0,h=0;if(this._vNumLeavesOfLayer)for(var p=this._vNumLeavesOfLayer.length,u=0;u<p;u++)this._vNumLeavesOfLayer[u]&&this._vNumLeavesOfLayer[u].len&&(this._vNumLeavesOfLayer[u].len,this._vNumLeavesOfLayer[u].len+", ",this._vNumLeavesOfLayer[u].lenStr+";;; ",this._vNumLeavesOfLayer[u].lennonSingleleavesStr+" :: ",l+=this._vNumLeavesOfLayer[u].lennonSingleleaves,d+=this._vNumLeavesOfLayer[u].lenSinglePOICount);if(this._vNumOfsinglePOIsinDisplay4Layer)for(var g=this._vNumOfsinglePOIsinDisplay4Layer.length,f=0;f<g;f++)this._vNumOfsinglePOIsinDisplay4Layer[f]>0&&(a+=this._vNumOfsinglePOIsinDisplay4Layer[f]);a;var v=this._layers.get("POIs");this._proximityGroups&&this._proximityGroups.size>0&&v&&v.size>0&&v.forEach(function(e){var t=this._proximityGroups.get(e.getID()+"");t&&(h+=t.size)}.bind(this));var m=new Date-o;m/=1e3;var b=s+d;if((A=c.getPADTracker({eventCategory:"usage",eventAction:"3d_updatePOI_stats"})).persVal.pv2=l,A.persVal.pv3=h,A.persVal.pv4=b,A.persVal.pv5=m,A.trackPageEvent(),this._vNumLeavesOfLayer){var y=this._vNumLeavesOfLayer.length;if(v&&v.size>0&&(y=0,v.forEach(function(e){e.isLayerVisible()&&y++}.bind(this))),s>100&&s>100*y){this._vNumLeavesOfLayer=[],this._vNumOfPOIsInLeavesOfLayer=[],this._vNumOfdisplayAllPOIsInLeavesOfLayer=[];for(var P=[],I=0;I<this._vNumOfsinglePOIsinDisplay4Layer.length;I++)this._vNumOfsinglePOIsinDisplay4Layer.pop();this._vNumOfsinglePOIsinDisplay4Layer=P,this._vStrOfPOIs=[],this._GE_VPBox_ReductionFactor=2,s>3e3&&s<=6e3?this._GE_VPBox_ReductionFactor=3:s>6e3&&s<=9e3?this._GE_VPBox_ReductionFactor=4:s>9e3&&(this._GE_VPBox_ReductionFactor=5),this._update3DCluster(t,i);var S=0;if(this._vNumOfsinglePOIsinDisplay4Layer)for(r=0;r<this._vNumOfsinglePOIsinDisplay4Layer.length;r++)this._vNumOfsinglePOIsinDisplay4Layer[r]&&this._vNumOfsinglePOIsinDisplay4Layer[r]>0&&(S+=this._vNumOfsinglePOIsinDisplay4Layer[r]);var C=0,w=0,x=0;if(this._vNumLeavesOfLayer)for(p=this._vNumLeavesOfLayer.length,u=0;u<p;u++)this._vNumLeavesOfLayer[u]&&this._vNumLeavesOfLayer[u].len&&(this._vNumLeavesOfLayer[u].len,this._vNumLeavesOfLayer[u].len+", ",this._vNumLeavesOfLayer[u].lenStr+";;; ",this._vNumLeavesOfLayer[u].lennonSingleleavesStr+" :: ",w+=this._vNumLeavesOfLayer[u].lennonSingleleaves,x+=this._vNumLeavesOfLayer[u].lenSinglePOICount);if(this._vNumOfsinglePOIsinDisplay4Layer)for(g=this._vNumOfsinglePOIsinDisplay4Layer.length,f=0;f<g;f++)this._vNumOfsinglePOIsinDisplay4Layer[f]>0&&(C+=this._vNumOfsinglePOIsinDisplay4Layer[f]);C;var O=new Date-o;O/=1e3;var A,M=S+x;(A=c.getPADTracker({eventCategory:"usage",eventAction:"3d_updatePOI_refine_stats"})).persVal.pv2=w,A.persVal.pv3=h,A.persVal.pv4=M,A.persVal.pv5=O,A.trackPageEvent(),this._vNumLeavesOfLayer=[],this._vNumOfPOIsInLeavesOfLayer=[],this._vNumOfdisplayAllPOIsInLeavesOfLayer=[];for(I=0;I<this._vNumOfsinglePOIsinDisplay4Layer.length;I++)this._vNumOfsinglePOIsinDisplay4Layer.pop();this._vNumOfsinglePOIsinDisplay4Layer=P,this._vStrOfPOIs=[]}}}e()}else if("2d"===D.getClusteringType())this._update2DCluster(t,i),e();else if(this._proximityGroups&&this._proximityGroups.size>0){n=this._context.getViewpoint().position;var N=(new _.Vector3).subVectors(this._context.getViewpoint().target,n);(v=this._layers.get("POIs"))&&v.size>0&&v.forEach(function(e){var o=e;if(o.isLayerVisible()){var s=this._proximityGroups.get(o.getID()+"");s&&s.forEach(function(e){if(N.x*(e.position.x-n.x)+N.y*(e.position.y-n.y)+N.z*(e.position.z-n.z)>0){var o=this._context.getViewpoint().project((new _.Vector3).copy(e.position));o&&o.x>20&&o.y>32&&o.x<t&&o.y<i?e.node.setVisibility(!0):e.node.setVisibility(!1)}else e.node.setVisibility(!1)}.bind(this))}}.bind(this)),e()}else this._updateClustersInProgress=!1,e()}.bind(this))},_endClusterUpdate:function(){this._updateClustersInProgress=!1,this.publish({event:"onEndClustering",data:{groupingParameters:D.getGroupingParameters(),memPCS:D.isMemPCS()}}),this._context.getViewer().render(),this._layerController.getKindsWithPOI().forEach(function(e){this._layerController.setCustomHeaderVisibility(e,!1)}.bind(this))},_onClickGroup:function(){if(!this._blockPanelOpening){if(this._selectionTokensGroups.length>0){for(var e=0;e<this._selectionTokensGroups.length;++e)o.unsubscribe(this._selectionTokensGroups[e]);this._selectionTokensGroups=[],this._selectionTokensGroups.push(o.onPostAdd(this._onClickGroup.bind(this))),this._selectionTokensGroups.push(o.onEmpty(this._emptyAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._leaveHoverAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._onClickGroup.bind(this)))}if(!0===D.isClusteringEnabled()&&!0===D.isMemPCS()&&this._i_ondblClick,this._clicked)this._doubleClickFlag=!0,setTimeout(function(){this._doubleClickFlag=!1,this._clicked=!1}.bind(this),800);else{var t=null,i=o.get();for(e=0;e<i.length;e++)if(i[e].pathElement&&i[e].pathElement.externalPath)for(var n=i[e].pathElement.externalPath,s=0;s<n.length;s++)(n[s].className&&"PAD3DPOIGroupNode"===n[s].className||"PAD3DPOIProximityNode"===n[s].className||"PAD3DPOINode"===n[s].className)&&(this._clicked=n[s+1].name,t=i[e].pathElement);if(t){for(e=0;e<this._selectionTokensGroups.length;++e)o.unsubscribe(this._selectionTokensGroups[e]);this._selectionTokensGroups=[],this._selectionTokensGroups.push(o.onPostAdd(this._onClickGroup.bind(this))),this._selectionTokensGroups.push(o.onEmpty(this._emptyAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._leaveHoverAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._onClickGroup.bind(this)))}}setTimeout(function(){var e=o.get();if(!1===D.isMemPCS()){for(var t=[],i=0;i<e.length;i++)if(e[i].pathElement&&e[i].pathElement.externalPath)for(var n=e[i].pathElement.externalPath,s=0;s<n.length;s++){if("PAD3DPOIGroupNode"===n[s].className||"PAD3DPOIProximityNode"===n[s].className)if(this._doubleClickFlag){if(this._doubleClickFlag&&this._clicked&&n[s+1].name&&this._clicked===n[s+1].name){r=n[s+1].name;if(!(C=this._groups.get(r)))if((R=r.split("_")).length>2){a=r.replace(R[0]+"_"+R[1]+"_","");(L=this._proximityGroups.get(a))&&(C=L.get(r))}this._tooltipFrame?this._tooltipFrame.isClosed()&&(this._tooltipFrame.show(),this._blockPanelUpdate=0):this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)});l=this._layerController.getLayerGroupView(C.layerID);this._tooltipFrame.attachedId=r.split("_")[0].replace("PAD3DPOIGroupNode",""),C.layerGroupView=l,t.push(C),this._reframeOnGroup(C),this._tooltipFrame.show(),this._clicked=!1,this._doubleClickFlag=!1}}else{var r=n[s+1].name;if(this._selectedGroup&&this._selectedGroup.setHighlight(!1),!(C=this._groups.get(r)))if((R=r.split("_")).length>2){var a=r.replace(R[0]+"_"+R[1]+"_","");(L=this._proximityGroups.get(a))&&(C=L.get(r))}this._tooltipFrame?this._tooltipFrame.isClosed()&&(this._blockPanelUpdate=0,this._tooltipFrame.show()):this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)});var l=this._layerController.getLayerGroupView(C.layerID);this._tooltipFrame.attachedId=r.split("_")[0].replace("PAD3DPOIGroupNode",""),C.layerGroupView=l,t.push(C),this._tooltipFrame.show(),this._selectedGroup=C.node,this._selectedGroup.setHighlight(!0),this._context.getViewer().render()}if("PAD3DPOINode"===n[s].className){var d=null,h=null,c=null,p=null,u=null,g=null;u=n[s].name;var _=n[s+1].name;if(-1===e[i].pathElement.getLastElement(!0).name.indexOf("PAD3DPOINode")){u=_;if(g=e[i].pathElement.instanceId,(p=this._layerPOIsIdInstancingNodeMap.get(u).get(g))&&p.instancingPOI)if(w=this._layer_instancing_to_visible_for_Hover.get(u))if(w.has(g))(x=w.get(g))>-1&&(g=x,p=this._layerPOIsIdInstancingNodeMap.get(u).get(g));p&&(d=p.label,h=p.id,c=p.color)}else g=parseInt(_.split("_")[1]),(p=this._layerPOIsIdInstancingNodeMap.get(u).get(g))&&(d=p.getLabelPOI(),h=p.getId(),c=p.getColorPOI(),u=p.getLayerID());if(this._selectedGroup&&this._selectedGroup.setHighlight(!1),p){var f={layerID:u,isSinglePOI:!0,pois:[{layer:u,layerId:u,data:{instanceId:g,label:d,id:h,color:c}}]};if(!1!==p.enablePOIPanel){this._tooltipFrame?this._tooltipFrame.isClosed()&&(this._tooltipFrame.show(),this._blockPanelUpdate=0):this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)});var v=this._layerController.getLayerGroupView(u);this._tooltipFrame.attachedId=n[s+1].name,f.layerGroupView=v,t.push(f),this._tooltipFrame.show()}}this._context.getViewer().render(),this._clicked=!1,this._doubleClickFlag=!1}if("PAD3DPOIProximityNode"===n[s].className)if((R=(r=n[s+1].name).split("_")).length>2){a=r.replace(R[0]+"_"+R[1]+"_","");(L=this._proximityGroups.get(a))&&(C=L.get(r)),C&&this._whiteListPOI.set(r,C.node)}}if(t&&t.length>0&&(this._blockPanelUpdate>0?this._blockPanelUpdate=0:(this._tooltipFrame.setContentsPOIGroups(t),this._tooltipFrame.show()),1===t.length&&!0===this._context._reframeFocus&&!0===this._context._focusTooltip))if(t[0].node&&"proximity"===t[0].node._typeDraw);else{var m=!0,b=!1,y=!1;if(p&&(p.instancingPOI||p.setVisibility(!0)),p){var I=!1;if(t[0].layerID&&this._layers.get("POIs")&&this._layers.get("POIs").get(t[0].layerID))if(H=this._layers.get("POIs").get(t[0].layerID).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"))for(var S=0;S<H.children.length&&!I;S++)H.children[S].name===p.instanceId&&(I=!0);I||this._createTooltip_and_pinTooltip_forFocRef(p,this,m,b,y,t[0].layerID)}}this._clicked=!1,this._doubleClickFlag=!1}if(!0===D.isClusteringEnabled()&&!0===D.isMemPCS()){for(t=[],i=0;i<e.length;i++)if(e[i].pathElement&&e[i].pathElement.externalPath)for(n=e[i].pathElement.externalPath,s=0;s<n.length;s++){if("PAD3DPOIGroupNode"===n[s].className||"PAD3DPOIProximityNode"===n[s].className)if(this._doubleClickFlag){if(this._doubleClickFlag&&this._clicked&&n[s+1].name&&this._clicked===n[s+1].name){r=n[s+1].name;if(!(C=this._groups.get(r)))if((R=r.split("_")).length>2){a=r.replace(R[0]+"_"+R[1]+"_","");(L=this._proximityGroups.get(a))&&(C=L.get(r))}this._tooltipFrame?this._tooltipFrame.isClosed()&&(this._tooltipFrame.show(),this._blockPanelUpdate=0):this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)});l=this._layerController.getLayerGroupView(C.layerID);this._tooltipFrame.attachedId=r.split("_")[0].replace("PAD3DPOIGroupNode",""),C.layerGroupView=l,t.push(C),this._reframeOnGroup(C),this._tooltipFrame.show(),this._clicked=!1,this._doubleClickFlag=!1,1===this._i_ondblClick&&(this._i_ondblClick=0)}}else{var C,r=n[s+1].name;if(this._selectedGroup&&this._selectedGroup.setHighlight(!1),!(C=this._groups.get(r)))if((R=r.split("_")).length>2){var a=r.replace(R[0]+"_"+R[1]+"_","");(L=this._proximityGroups.get(a))&&(C=L.get(r))}this._tooltipFrame?this._tooltipFrame.isClosed()&&(this._blockPanelUpdate=0,this._tooltipFrame.show()):this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)});var l=this._layerController.getLayerGroupView(C.layerID);this._tooltipFrame.attachedId=r.split("_")[0].replace("PAD3DPOIGroupNode",""),C.layerGroupView=l,t.push(C),this._tooltipFrame.show(),this._selectedGroup=C.node,this._selectedGroup.setHighlight(!0),this._context.getViewer().render()}if("PAD3DPOINode"===n[s].className){d=null,h=null,c=null,p=null,u=null,g=null;u=n[s].name;_=n[s+1].name;if(-1===e[i].pathElement.getLastElement(!0).name.indexOf("PAD3DPOINode")){var w,x;u=_;if(g=e[i].pathElement.instanceId,(p=this._layerPOIsIdInstancingNodeMap.get(u).get(g))&&p.instancingPOI)if(w=this._layer_instancing_to_visible_for_Hover.get(u))if(w.has(g))(x=w.get(g))>-1&&(g=x,p=this._layerPOIsIdInstancingNodeMap.get(u).get(g));p&&(d=p.label,h=p.id,c=p.color)}else{if(g=parseInt(_.split("_")[1]),!(p=this._layerPOIsIdInstancingNodeMap.get(u).get(g))){var O,A=this._layers.get("POIs");A&&A.size>0&&(O=A.get(u));var M=this._layerPOIsIdInstancingNodeMapMaster.get(u).get(g);this._seedNewNode(M,O,this._layerPOIsIdInstancingNodeMap.get(u),this._layerPOIsIdInstancingIndexMap.get(u),100,1),p=this._layerPOIsIdInstancingNodeMap.get(u).get(g)}p&&(d=p.getLabelPOI(),h=p.getId(),c=p.getColorPOI(),u=p.getLayerID())}this._selectedGroup&&this._selectedGroup.setHighlight(!1);var N=g+"_"+u,V=!1;if(this._proximityGroupedPOIs&&this._proximityGroupedPOIs.get(N)&&(V=!0),p&&!V){f={layerID:u,isSinglePOI:!0,pois:[{layer:u,layerId:u,data:{instanceId:g,label:d,id:h,color:c}}]};if(!1!==p.enablePOIPanel)if(this._blockPanelUpdate>0);else{this._tooltipFrame?this._tooltipFrame.isClosed()&&(this._tooltipFrame.show(),this._blockPanelUpdate=0):this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)});v=this._layerController.getLayerGroupView(u);this._tooltipFrame.attachedId=n[s+1].name,f.layerGroupView=v;for(var E=!1,T=0;T<t.length;T++)t[T]&&t[T].pois.length&&1===t[T].pois.length&&t[T].layerID===f.layerID&&t[T].pois.length===f.pois.length&&t[T].pois[0].data.instanceId===f.pois[0].data.instanceId&&t[T].pois[0].data.label===f.pois[0].data.label&&(E=!0);E||t.push(f),this._tooltipFrame.isClosed()&&this._tooltipFrame.show()}}this._context.getViewer().render(),this._clicked=!1,this._doubleClickFlag=!1}var R;if("PAD3DPOIProximityNode"===n[s].className)if((R=(r=n[s+1].name).split("_")).length>2){var L;a=r.replace(R[0]+"_"+R[1]+"_","");(L=this._proximityGroups.get(a))&&(C=L.get(r)),C&&this._whiteListPOI.set(r,C.node)}}var F=0;if(111===this._blockPanelUpdate_dbg&&F++,this._blockPanelUpdate>0&&(this._blockPanelUpdate=0),t&&t.length>0)if(this._blockPanelUpdate>0);else{var k,B=this._layers.get("POIs");if(B&&B.size>0&&(k=B.get(t[0].layerID)),k)for(var G=0;G<t[0].pois.length;G++){var U;M=this._layerPOIsIdInstancingNodeMapMaster.get(t[0].layerID).get(t[0].pois[G].data.instanceId);this._layerPOIsIdInstancingNodeMap.get(t[0].layerID)&&this._layerPOIsIdInstancingNodeMap.get(t[0].layerID).size&&(U=this._layerPOIsIdInstancingNodeMap.get(t[0].layerID).get(t[0].pois[G].data.instanceId));N=M.instanceId+"_"+M._layerId;var z=!1;if(this._proximityGroupedPOIs&&this._proximityGroupedPOIs.get(N)&&(z=!0),!U&&!z){this._seedNewNode(M,k,this._layerPOIsIdInstancingNodeMap.get(t[0].layerID),this._layerPOIsIdInstancingIndexMap.get(t[0].layerID),100,1);var W=this._layerPOIsIdInstancingNodeMap.get(t[0].layerID).get(t[0].pois[G].data.instanceId);W&&W.setVisibility(!1)}}if(t.length&&(111===this._blockPanelUpdate_dbg||(this._tooltipFrame.setContentsPOIGroups(t),this._tooltipFrame.show())),1===t.length&&!0===this._context._reframeFocus&&!0===this._context._focusTooltip)if(t[0].node&&"proximity"===t[0].node._typeDraw);else{m=!0,b=!1,y=!1;if(W&&W.setVisibility(!0),U){var H;I=!1;if(t[0].layerID&&this._layers.get("POIs")&&this._layers.get("POIs").get(t[0].layerID))if(H=this._layers.get("POIs").get(t[0].layerID).getNode3DBag().getChildByName("PAD3DPOITooltipNodePinned"))for(S=0;S<H.children.length&&!I;S++)H.children[S].name===U.instanceId&&(I=!0);I||this._createTooltip_and_pinTooltip_forFocRef(U,this,m,b,y,t[0].layerID)}}F===t.length&&(1===t.length||(this._blockPanelUpdate_dbg=0))}this._clicked=!1,this._doubleClickFlag=!1,this._updateDblClickInProgress=!1,this.publish({event:"onEndClickDblClick",data:{groupingParameters:D.getGroupingParameters()}})}}.bind(this),200)}},_reframeOnGroup:function(e){var t=e.pois,i=this._calcPoisBS(t);this._context.getViewpoint().control.moveTo({target:i.center,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:3*i.radius,duration:400}),setTimeout(function(e){if(e.pois.length<1500)if("3DClusteringNode"===e.node._type)this._whiteListPOI.set(e.node._name,e.node);else for(var t=0;t<e.pois.length;t++)if(e.pois[t].isInProxGroup&&""!==e.pois[t].isInProxGroup){var i=e.pois[t].isInProxGroup;if(i){var o=i.split("_");if(o.length>2){var n=i.replace(o[0]+"_"+o[1]+"_",""),s=this._proximityGroups.get(n);if(s){var r=s.get(i);this._whiteListPOI.set(i,r.node)}}}}else{this._whiteListPOI.set(e.layer+"_"+e.pois[t].data.instanceId,e.pois[t].data.node)}this._layerController.getKindsWithPOI().forEach(function(e){this._layerController.setCustomHeaderVisibility(e,!0)}.bind(this)),setTimeout(function(){this._updatePOIClusters().then(()=>{"function"==typeof this._endClusterUpdate&&this._endClusterUpdate()})}.bind(this),50)}.bind(this,e),450)},_calcPoisBS:function(e){for(var t,i={x:0,y:0,z:0},o=0,n=null,s=null,r=null,a=null,l=null,d=null,h=0;h<e.length;h++)n=n?Math.max(e[h].position3D.x,n):e[h].position3D.x,r=r?Math.max(e[h].position3D.y,r):e[h].position3D.y,l=l?Math.max(e[h].position3D.z,l):e[h].position3D.z,s=s?Math.min(e[h].position3D.x,s):e[h].position3D.x,a=a?Math.min(e[h].position3D.y,a):e[h].position3D.y,d=d?Math.min(e[h].position3D.z,d):e[h].position3D.z,i.x=i.x+e[h].position3D.x,i.y=i.y+e[h].position3D.y,i.z=i.z+e[h].position3D.z;for(o=n-(t={x:i.x/e.length,y:i.y/e.length,z:i.z/e.length}).x,h=0;h<e.length;h++){var c=e[h].position3D.x-t.x,p=e[h].position3D.y-t.y,u=e[h].position3D.z-t.z,g=Math.sqrt(c*c+p*p+u*u);g>o&&(o=g)}return{radius:o,center:t}},_leaveHoverAction:function(){this._updateClustersInProgress||this._whiteListPOI.clear(),this._selectedGroup&&(this._selectedGroup.setHighlight(!1),this._selectedGroup=null)},_emptyAction:function(){var e=o.get();this._whiteListPOI.clear(),e.length<1&&(this._whiteListPOI.clear(),this._selectedGroup&&(this._selectedGroup.setHighlight(!1),this._selectedGroup=null,this._context.getViewer().render())),this._selectedProxGrp&&(this._selectedProxGrp.setHighlight(!1),this._selectedProxGrp=null)},isPOIGroups:function(){return D.isClusteringEnabled()},_reframeOnPOI:function(e,t){var i=e.resourceid;null!=e.revealPoiId&&(i=e.revealPoiId);var s,r=!1,l=!1,d=e.instanceid;if(t&&t.pois&&null!=i&&null!=i&&t.pois.length>0){for(var c=0;c<this._selectionTokensGroups.length;++c)o.unsubscribe(this._selectionTokensGroups[c]);this._selectedProxGrp&&(this._selectedProxGrp.setHighlight(!1),this._selectedProxGrp=null),this._selectionTokensGroups=[];var p,u=null,g=[],_=[],f=[];o.empty(),n.empty(),this._whiteListPOI.clear(),d?f.push(d):f=this.getPOINodeInstanceId(i);for(var v=0;v<f.length;v++){var m=f[v];p=this.getPOILayerId(i);var b,y=this._layerController.getLayer(p);if(this._POIIdGroupedPOIs&&this._POIIdGroupedPOIs.has(p)&&(b=this._POIIdGroupedPOIs.get(p)),!0===D.isClusteringEnabled()&&!0===D.isMemPCS()&&y.isClustered()&&(!b||b&&!b.has(m)))if(this._updateDblClickInProgress=!0,e&&(e.resourceid?e.resourceid:e.id),y){var I,S=this._layerPOIsIdInstancingNodeMapMaster.get(p).get(m);this._layerPOIsIdInstancingNodeMap.get(p)&&this._layerPOIsIdInstancingNodeMap.get(p).size&&(I=this._layerPOIsIdInstancingNodeMap.get(p).get(m)),I||(I=this._seedNewNode(S,y,this._layerPOIsIdInstancingNodeMap.get(p),this._layerPOIsIdInstancingIndexMap.get(p),100,1)),I.setVisibility(!0);for(var C=a.buildPathesLeadingToNode(I.getNode(),this._model.getDecorationBag()),w=0;w<C.length;w++)this._selectedPOI.push({id:i,path:C[w]}),_.push({pathElement:C[w]});g.push(m,I)}if(b&&b.has(m)){s={version:"1.1",paths:[],POIs:[e.resourceid],POIGroups:[],sharedID:h.getSharedId(),fromPanel:!0,noClear:!0},r=!0;var x,O=b.get(m).groupName;if(O)if(O.split("_").length>2){var A=this._proximityGroups.get(p);A&&(x=A.get(O))}if(x){x.node.setVisibility(!0),x.node.setHighlight(!0),this._selectedProxGrp=x.node,g.push({id:O,node:x.node});var M=a.buildPathesLeadingToNode(x.node.getNode(),this._model.getDecorationBag());M&&M[0]&&_.push({pathElement:M[0]});var N=[];for(c=0;c<x.pois.length;c++)N.push(x.pois[c].data.id);s.POIGroups.push({id:O,POIs:N}),this._isReframeAllowed()&&this._context.getViewpoint().control.moveTo({target:x.position,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400})}if(t.openPanel){this._blockPanelOpening=!0,(E=this._layerPOIsIdInstancingNodeMap.get(p).get(m))&&E.instancingPOI?(E.label,E.color):E&&(E.getLabelPOI(),E.getColorPOI());this._layerController.getLayerGroupView(p);this._tooltipFrame?this._tooltipFrame.show():this._tooltipFrame=new P({renderTo:this._context.getFrameWindow().getImmersiveFrame(),clickOnPOICB:this._reframeOnPOI.bind(this)})}l=!0}else{var V=!1;!0===D.isClusteringEnabled()&&!0===D.isMemPCS()&&this._layerPOIsIdInstancingNodeMapMaster.get(t.layerID)&&this._layerPOIsIdInstancingNodeMapMaster.get(t.layerID).get(e.instanceid)&&this._layerPOIsIdInstancingNodeMapMaster.get(t.layerID).get(e.instanceid).instancingPOI&&(V=!0),(t.isSinglePOI||t.openPanel)&&(this._blockPanelOpening=!0),p=this.getPOILayerId(i);var E,T=this._layerPOIsIdInstancingNodeMap.get(p);if(T)if((E=T.get(m))&&(E.getPosition?u=E.getPosition():(u=E.position,V=!0)),!V&&E&&E.getPosition&&!1===D.isMemPCS()){E.setVisibility(!0),u=E.getPosition();for(C=a.buildPathesLeadingToNode(E.getNode(),this._model.getDecorationBag()),w=0;w<C.length;w++)this._selectedPOI.push({id:i,path:C[w]}),_.push({pathElement:C[w]})}else if(E&&E.position){var R=this.unstreamPOIInstancingId(m,p);u=E.position,R&&_.push({pathElement:R})}}}if(this._isReframeAllowed())for(var L=0;L<t.pois.length;L++)if(t.pois[L].data.id===i&&(!d||d&&t.pois[L].data.instanceId===d)){var F=t.pois[L];!1===D.isMemPCS()&&g.push({id:p+"_"+t.pois[L].data.instanceId,node:t.pois[L].data.node});var k=this._poiInstanceInfoMap.get(p).get(t.pois[L].data.instanceId);if(k&&k.position&&!k.path&&!k.resourceid)u?this._context.getViewpoint().control.moveTo({target:u,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400}):F.position3D&&this._context.getViewpoint().control.moveTo({target:F.position3D,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400});else if(k){if(k.path){R=this.buildPathFromArray(k.path,!0);_.push({pathElement:R}),l&&s.paths.push(k.path),r||(u?this._context.getViewpoint().control.moveTo({target:u,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400}):this._context.getViewpoint().control.moveTo({target:F.position3D,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400}))}else if(k.resourceid){var B=this.getNode({id:k.resourceid});if(B){var G=a.buildPathesLeadingToNode(B,this._model.getRootBag());r||(u?this._context.getViewpoint().control.moveTo({target:u,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400}):this._context.getViewpoint().control.moveTo({target:F.position3D,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400}));for(var U=0;U<G.length;U++)_.push({pathElement:G[U]})}else this._context.getViewpoint().control.moveTo({target:F.position3D,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400})}}else this._context.getViewpoint().control.moveTo({target:F.position3D,orientation:this._context.getViewpoint().control.orientation.clone(),distanceToTarget:300,duration:400})}l&&(this._context.lockSelectionBroadcast(!0),this._poiGroupCommandProxy.select(s),setTimeout(function(){this._context.lockSelectionBroadcast(!1)}.bind(this),400),this._blockPanelOpening=!0);var z=!1;if(setTimeout(function(){z=!0},5e3),_.length<50)for(var W=0;W<_.length&&!z;W++)o.add(_[W]),n.add(_[W]);else for(var H=Math.max(Math.ceil(_.length/50),3),j=0;j<H&&!z;j++){var Q=[];Q=j<H-1?_.slice(50*j,50*(j+1)):_.slice(50*j,_.length);for(var q=0;q<Q.length&&!z;q++)o.add(Q[q]),n.add(Q[q])}for(var X=0;X<g.length;X++)this._whiteListPOI.set(g[X].id,g[X].node);this._updatePOIClustersTimedout();this._selectionTokensGroups.push(o.onPostAdd(this._onClickGroup.bind(this))),this._selectionTokensGroups.push(o.onEmpty(this._emptyAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._leaveHoverAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._onClickGroup.bind(this))),this._blockPanelOpening=!1,this._endClustHLReframe&&(this.unsubscribe(this._endClustHLReframe),this._endClustHLReframe=null),this._endClustHLReframe=this.subscribe({event:"onEndClustering"},function(){this.unsubscribe(this._endClustHLReframe);for(var e=0;e<this._selectionTokensGroups.length;++e)o.unsubscribe(this._selectionTokensGroups[e]);if(this._blockPanelOpening=!0,!0===D.isClusteringEnabled()&&!0===D.isMemPCS())if(_.length<50)for(var t=0;t<_.length;t++)o.add(_[t]),n.add(_[t]);else for(var i=Math.max(Math.ceil(_.length/50),3),s=0;s<i;s++){var r=[];r=s<i-1?_.slice(50*s,50*(s+1)):_.slice(50*s,_.length);for(var a=0;a<r.length;a++)o.add(r[a]),n.add(r[a])}this._selectionTokensGroups.push(o.onPostAdd(this._onClickGroup.bind(this))),this._selectionTokensGroups.push(o.onEmpty(this._emptyAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._leaveHoverAction.bind(this))),this._selectionTokensGroups.push(o.onPostRemove(this._onClickGroup.bind(this))),this._blockPanelOpening=!1,this._doubleClickFlag=!1}.bind(this))}},streamPOIGroup:function(e,t){var i=e.externalPath[e.externalPath.length-1].name;if(void 0!==i&&this._groups){var o=this._groups.get(i);if(!o&&i){var n=i.split("_");if(n.length>1){var s=i.replace(n[0]+"_"+n[1]+"_",""),r=this._proximityGroups.get(s);r&&(o=r.get(i))}}if(o&&o.pois){for(var a={POIs:[],id:i},l=0;l<o.pois.length;++l)a.POIs.push(o.pois[l].data.id);t.push(a)}}},stopPOIClusters:function(){D.resetParameters(),this._groupNodes&&(this._groupNodes.removeChildren(),this.getDecorationBag().remove(this._groupNodes),delete this._groupNodes),this._abortCB&&this._context.unsubscribe(this._abortCB),this._proximityNodes&&(this._proximityNodes.removeChildren(),this.getDecorationBag().remove(this._proximityNodes),delete this._proximityNodes),this._tooltipNodes&&this._tooltipNodes.removeChildren(),this._poiGroupCommandProxy&&(this._poiGroupCommandProxy.destroy(),delete this._poiGroupCommandProxy),this._proxGroupNameLayerId&&delete this._proxGroupNameLayerId,delete this._groups,delete this._proxGroupPOIsForLayer,delete this._proximityGroups,delete this._layerGroupViews,delete this._tooltipNodesPinnedMap,this._tooltipFrame&&(this._tooltipFrame.hide(),this._tooltipFrame.deletePanel(),delete this._tooltipFrame),i.unsubscribe(this._visuEventOnEndMove),delete this._visuEventOnEndMove;for(var e=0;e<this._selectionTokensGroups.length;++e)o.unsubscribe(this._selectionTokensGroups[e]);this._selectedProxGrp&&(this._selectedProxGrp.setHighlight(!1),this._selectedProxGrp=null),this._selectionTokensGroups=[],this._updateClustersInProgress=!1}})}),define("DS/ENOPAD3DViewer/controller/PAD3DViewerController",["UWA/Core","UWA/Class","UWA/Promise","DS/CoreEvents/ModelEvents","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSession","DS/PADUtils/PADPromise","DS/PADUtils/views/PADAlert","DS/ENOPAD3DViewer/mixins/_PAD3DViewerFilterController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerBIController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerExternalKPIController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerKPICommunicationManager","DS/ENOPAD3DViewer/mixins/_PAD3DViewerPOIGroupEngine","DS/ENOPAD3DViewer/mixins/_PAD3DViewerMaterialViewController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerPCSTracker","DS/ENOPAD3DViewer/mixins/_PAD3DViewerRootStatsController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerMIRController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerNMIRDMUOperatorController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerPGPController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerR2VController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerPointCloudStylingController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerStaticMappingController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerFlexibleAssemblyController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerTransparencyController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerMoveRootController","DS/ENOPAD3DViewer/controller/PAD3DLayerController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerLayerInterface","DS/Visualization/SceneGraphUtils","DS/PADUtils/views/PADProgressBar","DS/Visualization/PathElement","DS/PADUtils/PADProbes","DS/PADUtils/PADUtilsServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/ViscaURLServicesJS/VisuRepServices","DS/ViewerCommandsExt/ViewerScreenshotUtils","DS/ENOXInterWdgCom/LinkManager"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_,f,v,m,b,y,P,D,I,S,C,w,x,O,A,M,N,V,E,T,R,L,F,k,B){"use strict";var G=t.extend(d,h,c,u,g,_,p,f,v,m,b,y,P,x,D,I,S,C,{name:"PAD3DViewerController",init:function(e){this._parent(e),this._model=null,this._modelEvents=null,this._commandProxy=null,this._rootIds=[],this._delegatedRootCB=new Map,this._loadingQueue=[],this._operationInProgress=!1,this._BIProxy=null,this._defaultStreamToLoad=null,this._stepcgrAvailableForRole=!1,this._executionContext=e.executionContext,this._promises=[],this._runningQuery=null,this._useWrap=!1,this._sessionCBTokens=[],this._configFilter=null,this._modelEvents=new o,this._querySuccess=!0,this._engineState=1,this._rolePromise=e.rolePromise,this._initModel(e),this._setDefaultStreamToLoad(n.getSetting("enopad3dviewer_CGRorTHB"));var t=n.getWebAPI_Options("navigate3D");n.getSetting("supportPgpBasedOnDescription")&&(t.select_rel.push("ro.plminstance.V_description"),n.setWebAPI_Options("navigate3D",t),n.setWebAPI_Options("volumeQuery",t)),n.getSetting("supportWorldOrientation")&&!n.getSetting("enopad3dviewer_lightNodeModel")&&(t.select_bo.push("ds6wg:XCADOrientationExt.V_WorldOrientation"),n.setWebAPI_Options("navigate3D",t),n.setWebAPI_Options("volumeQuery",t));var i=require("DS/PADUtils/PADUtilsServices"),s=this;i.getGrantedRoles(function(e){s._stepcgrAvailableForRole=!1;for(var o=0;o<e.length;o++)if("SXX"===e[o].id&&(!e[o].platforms||e[o].platforms&&e[o].platforms.indexOf(i.getPlatformId())>-1)){s._stepcgrAvailableForRole=!0;break}s._stepcgrAvailableForRole&&(t.computeCGRsNThumbnails=["thumbnail_3d","stepcgr","cgr"],t.computeCGRs=["stepcgr","cgr"],n.setWebAPI_Options("navigate3D",t),n.setWebAPI_Options("volumeQuery",t))}),this._context=e.context,this._BIProxy=e.BIProxy,this._initInterwidgetCom(),this.setWrapUsage(!1);var a=this.isReadOnly();r.softInit(a,a),this._sessionCBTokens.push(r.subscribe({event:"authoringStateModified"},function(e){if(s.publish({event:"onAuthoringSwitch",data:{state:e.authored}}),!s.isReadOnly()&&s._BIProxy&&s._BIProxy._biFilter)if(e.authored){let e=n.getSetting("authoringFilterEnabled"),t=n.getSetting("authoringFilterEnabledForMultiRoot");e&&(t||1===s._rootIds.length)?require(["DS/PADServices/utils/PConfigUtils"],function(e){let t=[];s._rootIds.forEach(function(i){let o=s._BIProxy._biFilter.getFilterSpec(i,{V2:{}}),n=e.validateFIlters(o,!0);n&&!n.isValid&&t.push(i)}),s._BIProxy._biFilter.removeRoots(t)}):s._BIProxy._biFilter.removeRoots(s._rootIds)}else s._BIProxy._biFilter.setTagsWithExpandSynthesis&&s._rootIds.length>0&&s._BIProxy._biFilter.setTagsWithExpandSynthesis(s._rootIds)})),this._sessionCBTokens.push(r.subscribe({event:"useIndexPreferenceModified"},function(e){s.publish({event:"onIndexAvalabilityChange",data:{availability:e.useIndexPreference}})})),n.addEvent("onEnopad3dviewer_CGRorTHB",function(e){s&&(s._defaultStreamToLoad="HIGH"===e?"cgr":"thumbnail")})},destroy:function(){if(this.disposeRootStatsController(),this.disposeMaterialController(),this.disposeKPICommunicationManager(),this.disposeStaticMappingController(),this.disposeFlexibleAssemblyController(),this._model&&(this._model.destroy(),delete this._model),this._commandProxy&&(this._commandProxy.destroy(),delete this._commandProxy),this._modelEvents&&delete this._modelEvents,this._sessionCBTokens.length){for(var e=0;e<this._sessionCBTokens.length;e++)r.unsubscribe(this._sessionCBTokens[e]);this._sessionCBs=null}this.destroyBIController(),this._rootIds=null,this._promises=null,this._BIProxy=null,this._parent()},_initInterwidgetCom:function(){var e=this;this._context.isInterwidgetComAvailable()&&require(["DS/PADUtils/PADCommandProxy","DS/PADUtils/PADUtilsServices"],function(t,o){e._commandProxy=t.create({events:{onDrop:function(t){if(require("DS/PADUtils/PADUtilsServices").updatePlatformId(t.tenant),t.pids||t.paths)e.addRoots(t,!1);else if(t.rootsWithFilters)for(var i=0;i<t.rootsWithFilters.length;++i){e.getRoot({id:t.rootsWithFilters[i].rootId})?e.publish({event:"onRootAlreadyExisting"}):!0===n.getSetting("enopad3dviewer_lightNodeModel")?(e.publish({event:"onBeginFilterApplied"}),e.addRoots({objects:[{filterId:t.rootsWithFilters[i].filterId,path:[t.rootsWithFilters[i].rootId]}],loadWithFilter:t.loadWithFilter,tenant:t.tenant},!1,!0,!0,function(e){this.publish({event:"onFilterApplied",data:{filter:{objects:[{filterId:e.filterId,path:[e.rootId]}]}}})}.bind(e,t.rootsWithFilters[i]))):e.applyFilter(t.rootsWithFilters[i].filter,!1)}else t.R2Vs&&e.addR2Vs({objects:t.R2Vs,reframe:!0,displayNotif:!0,dispatch:!1})},onRemove:function(t){B.isWidgetSynchronizing()||e.removeRoots(t,!1)},onDetach:function(t){e.detachRoots(t,!1)},onAttach:function(t){e.attachRoots(t,!1)},onCleanAll:function(){e.flushModel(!1)},onPadRefresh:function(t){t.TitleInfo?e.publish({event:"onContentNameModified",data:{TitleInfo:t.TitleInfo}}):(e.switchAuthoringMode(!0,"PADSession_enabling_authored_mode",!1),e._parseAuthoringTransaction(t))},onRefreshModel:function(){e.refresh(!1)},onPadExpand:function(t){!1===t?l.displayNotification({msg:T.find_in_context_no_result,eventID:"info"}):(!0===n.getSetting("enopad3dviewer_lightNodeModel")?e.unlockChildrenFromProgressiveExpand(t):(t.singleAdd=!1,e.expand(t,!1,!0,!1)),!0===t.updatePager&&(e._context.updatePager=!0,e._context.pagerData=t.paths))},onUpdatePosMatrix:function(t){var o=[];if(t.instances){a.createPromise(function(i,s){var r=0;e.switchAuthoringMode(!0,!1,"PADSession_disabling_index_authoring"),t.instances.forEach(function(t){if(e._model._updatePositionMatrix(t)){var i=e.buildPathFromArray(t.nodePath);i&&o.push(i)}else n.getSetting("enopad3dviewer_lightNodeModel")&&r++}),r&&e.publish({event:"onAuthoringIgnored",data:{reason:r===t.instances.length?"authoringOperation_aborted_unknownObject":"authoringOperation_partiallyProcessed_unknownObject"}}),e.forceRefresh(),i()},"posMatrixUpdate");var s=a.getPromises().slice();i.all(s).then(function(i){s=null,e.publish({event:"onEndMatriceUpdate",data:t})})}},onDisableFilterWaiting:e._disableFilterWaiting.bind(e),onSearchInApp:function(t){e.search&&e.search({searchQuery:t.query})},onRetrieveFilterFailure:function(t){e._retrieveFilterFailure(t)},onFilterCancel:function(e){void 0!==e.result?this.filterCancelCB(e.result):!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._context._controller._engineState<=0&&this.resumeProgressiveLoading(),this.confirmModal&&this.confirmModal.cancelModal&&(this.fromProxy=!0,this.confirmModal.cancelModal.modals&&this.confirmModal.cancelModal.modals.current&&this.confirmModal.cancelModal.modals.current.destroy&&this.confirmModal.cancelModal.modals.current.destroy())}.bind(e)}})})},screenshot:function(e){k.b64Screenshot({viewer:this._context.getFrameWindow().getViewer(),noBlink:!!e&&e.noBlink}).then(e=>{B.publish("DS/ExternalWdgtCom/captureSnapshot",{content:{stream:e,size:{height:this._context.getFrameWindow().getViewer().SCREEN_HEIGHT,width:this._context.getFrameWindow().getViewer().SCREEN_WIDTH}}})})},onMove3D:function(e){this._commandProxy.update2DPosMatrix(e)},isFilterOpen:function(e){e&&e({filterAvailable:this.isStandaloneFilterAvailable()})},_isAuthored:function(){return r.determineAuthoredFlag()},_initModel:function(e){var t=this,i=function(){this._rolePromise.then(this.initPCSTracker.bind(this,{model:this._model})).then(this.initFilterController.bind(this)).then(function(){this.initRootStatsController(),this.initBIController(),this.initPGPController(),this.initStaticMappingController(),this.initFlexibleAssemblyController(),this.initMoveRootController(),this.initExternalKPIController().then(this.initMaterialViewController.bind(this)).then(function(){this._layerController=new w({renderTo:this._context.getFrameWindow().getImmersiveFrame(),rootBag:this.getRootBag(),decorationBag:this.getDecorationBag(),viewer:this._context.getViewer(),controller:this}),this.initKPICommunicationManager().then(function(){e.readyCB&&e.readyCB()})}.bind(this))}.bind(this))}.bind(this);e.tileModel=void 0!==e.tileModel&&e.tileModel,!0===n.getSetting("enopad3dviewer_lightNodeModel")?require(["DS/ENOPAD3DViewer/models/PAD3DViewerTileNodeModel"],function(o){t._model=new o({viewer:e.viewer,startLoadingCB:t._startProgressiveLoad.bind(t),endLoadingCB:t._endProgressiveLoad.bind(t),representationLoadedCB:t._representationLoaded.bind(t),cycleDetectedCB:t._cycleDetectedCB.bind(t),appOOCManagerOptions:e.appOOCManagerOptions,expandCB:function(e,i,o){t.expand(e,i,o)},fetchCB:t.getAttributes,handleBoxCB:function(e){return t._completeSessionWithBoxForWalk(e)},getFcsUrlsCB:function(e){t.getFcsUrls(e)},rootStatsController:t}),i(),t._model.subscribe({event:"colorOverridePostProcess"},function(e){t.is3DLeafColorizeActivated()&&t.colorizeNewNodes(e)}),t._model.subscribe({event:"onUrlLoaded"},function(e){t.publish({event:"onUrlLoaded",data:e})})}):require(["DS/ENOPAD3DViewer/models/PAD3DViewerNodeModel"],function(o){t._model=new o({viewer:e.viewer,startLoadingCB:t._startProgressiveLoad.bind(t),endLoadingCB:t._endProgressiveLoad.bind(t),representationLoadedCB:t._representationLoaded.bind(t),appOOCManagerOptions:e.appOOCManagerOptions,getFcsUrlsCB:function(e){t.getFcsUrls(e)}}),i(),t._model.subscribe({event:"onUrlLoaded"},function(e){t.publish({event:"onUrlLoaded",data:e})}),t._model.subscribe({event:"onLeafReferenceLoaded"},function(e){t.publish({event:"onLeafReferenceLoaded",data:e})}),t._model.subscribe({event:"onLeafReferenceUnloaded"},function(e){t.publish({event:"onLeafReferenceUnloaded",data:e})})})},getHiddenRootIds:function(e){return void 0!==e?this._model.getHiddenRootIds(e):this._model.getHiddenRootIds()},checkIfEmpty:function(){return!this.getNbRoots()&&!this.getHiddenRootIds().length},_startAsync:function(e){this._operationInProgress=!0,e=void 0===e?{}:e,this.publish({event:"startAsync",data:e})},_startProgressiveLoad:function(){this.publish({event:"onStartProgressiveLoad"})},_stopAsync:function(e){this._operationInProgress=!1,this._runningQuery=null,this.publish({event:"stopAsync",data:e})},_endProgressiveLoad:function(e){this.publish({event:"onEndProgressiveLoad",data:e})},_representationLoaded:function(e){this.publish({event:"onRepresentationLoaded",data:e})},_cycleDetectedCB:function(e){this.publish({event:"onCycleDetected",data:e})},switchAuthoringMode:function(e,t,i){e===this._isAuthored()||this.isReadOnly()||r.setAuthoringState(e,i,t)},_parseAuthoringTransaction:function(e){var t=this,o=e.transactions;if(o){t.publish({event:"onAuthoringTransactionBegin"});for(var n=0;n<o.length;n++){var s=o[n];if(s.reParent)t.reparent(s.reParent);else if(s.insertExisting)if(s.insertExisting.inserted&&s.insertExisting.inserted.length>1)for(var r=0;r<s.insertExisting.inserted.length;r++){var l={created:[s.insertExisting.created[r]],inserted:[s.insertExisting.inserted[r]],modified:[s.insertExisting.modified[r]]};t.insertExisting(l)}else t.insertExisting(s.insertExisting)}var d=a.getPromises().slice();i.all(d).then(function(){d=null,t.publish({event:"onAuthoringTransactionEnd"})})}else e.detach&&t.unparent(e.detach)},_processLoadingQueue:function(){if(!this.isRunning()){var e=this._loadingQueue.splice(0,1);e.length&&(e[0].serviceId&&"r2vsurvey"===e[0].serviceId.toLowerCase()?this._loadR2V(e[0]):this._load(e[0]))}},_load:function(t){var i=this;t.userFeedback=void 0===t.userFeedback||t.userFeedback;var o=t.reframe,a=t.path,l=t.paths,d=t.structure,h=t.configBin,c=t.sequence_filter,p=t.CVQuery3D,u=t.id,g=t.parent,_=void 0!==t.hidden&&t.hidden,f=!!t.forceIndex&&t.forceIndex,v=i._useWrap?i._wait4Filter?"expand3D":"wrap":"expand3D",m=t.fromLoadJSON,b=parseInt(n.getSetting("webapi_timeout")),y=void 0!==t.expand_iter?t.expand_iter:"-1",P=n.getSetting("enopad3dviewer_navigate_wrap_density")?n.getSetting("enopad3dviewer_navigate_wrap_density"):4,D=e.clone(n.getWebAPI_Options("navigate3D"),!0),I={expand_iter:y,select_bo:D.select_bo,select_rel:D.select_rel,compute_select_bo:"thumbnail"===this.getDefaultStreamToLoad()?D.computeCGRsNThumbnails:D.computeCGRs,intent:"explore_3D",authored:i._isAuthored(),debug:n.getSetting("enopad_webapis_debug"),boundingbox:i._withBoundingBoxes(),fcs_url_mode:n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0,find_in_context:t.findInCtx?[{"q.query":t.findInCtx}]:void 0,find_in_context_physicalid:t.find_in_context_physicalid?t.find_in_context_physicalid:void 0,findPaths:t.findPaths,option:i._useWrap>0&&!t.findInCtx?{density:"string"!=typeof P?P.toString():P}:void 0,config_filter:void 0!==h?h:void 0,sequence_filter:void 0!==c?c:void 0,max_count_path:t.max_count_path?t.max_count_path:void 0,get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0};!1===this.isViewerInMaterialMode()?this._dataLoadedWithoutMaterial=!0:this._dataLoadedWithoutMaterial=!1,!0===n.getSetting("enopad3dviewer_lightNodeModel")&&i.is3DLeafColorizeActivated()&&i._colorMap&&(-1===I.select_bo.indexOf(i._colorMap.predicate)&&I.select_bo.push(i._colorMap.predicate),-1===I.select_rel.indexOf(i._colorMap.predicate)&&I.select_rel.push(i._colorMap.predicate));var S=void 0!==t.progressiveExpand?t.progressiveExpand:!0===n.getSetting("enopad3dviewer_lightNodeModel")&&!i._useWrap;S&&(v="progressiveExpand",I.frustumDefinition=this._context._getFrustumDefinition(),I.frustumDefinition.pixel_culling=void 0!==t.pixelCulling?""+Math.max(t.pixelCulling,this._getMaxPixelCulling()):this._getMaxPixelCulling());var C="",w=!1,x=!1;function O(){g=null,a=null,_=null,h=null,u=null,I=null,t=null,i=null}if(a&&(a.length>1?w=!0:u=a[0]),l&&(x=!0),w?(I.root_path_physicalid=[a],I.rootPhID=a[0],C=a[0]):x?(I.root_path_physicalid=l,I.rootPhID=l[0][0],C=l[0][0]):(I.root_physicalid=u,I.rootPhID=u,C=u),p&&!i._isAuthored()){f=!0;var M=p;I.find_in_context&&(M=i._context.getBIController()._BIProxy.completeCVQueryWithAppSpecs(p,{find_in_context:I.find_in_context},!0));var V=e.clone(M,!0);"wrap"===v&&(V.union?(V.union.wrap=V.union.expand3d,delete V.union.expand3d,V.union.wrap.forEach(function(e){e.option=I.option})):V.intersect?(V.intersect.wrap=V.intersect.expand3d,delete V.intersect.expand3d,V.intersect.wrap.forEach(function(e){e.option=I.option})):V.minus&&(V.minus.wrap=V.minus.expand3d,delete V.minus.expand3d,V.minus.wrap.forEach(function(e){e.option=I.option}))),delete I.root_physicalid,delete I.root_path_physicalid,delete I.find_in_context,delete I.expand_iter,delete I.option,I=e.extend(I,V,!0)}this.navQueryProbe=x?N.createProbe("Expand"+y+" - "+l.length+" paths"):N.createProbe("navigateQuery");var L=i;function F(e,s){var l;i.navQueryProbe&&(i.navQueryProbe.end(),delete i.navQueryProbe);try{l="string"==typeof e?JSON.parse(e):e}catch(e){return i._stopAsync({userFeedback:t.userFeedback}),t.onFailure&&t.onFailure(),void O()}if("CLOUDVIEW_ERROR__SUMMARY"!==(!!l.error&&l.error.errorCode))if(l.authoringMode&&!0===l.authoringMode&&r.setAuthoringState(!0,"PADSession_disabling_index_from_server",!0),A.setText(E.parsingResponse),!l.results||0===l.results.length||!i.isRunning()||1===l.results.length&&void 0!==l.results[0].status)if(t.findInCtx||t.findPaths){if(i._stopAsync({userFeedback:t.userFeedback}),t.onComplete){var d=l.results&&1===l.results.length&&void 0!==l.results[0].status?l.results[0].status:void 0;t.onComplete({tooManyPath:d}),O()}}else if(t.taggerSelect){if(i._stopAsync({userFeedback:t.userFeedback}),t.onComplete){d=l.results&&1===l.results.length&&void 0!==l.results[0].status?l.results[0].status:void 0;t.onComplete({taggerSelect:t.taggerSelect,pathCount:l.results.length,tooManyPath:d}),O()}}else if(!t.sequence_filter&&!t.CVQuery3D||S)S?(i._stopAsync({userFeedback:t.userFeedback}),t.onFailure&&(t.onFailure(),O())):(i._stopAsync({userFeedback:t.userFeedback}),i._isAuthored()||i.isReadOnly()?t.onFailure&&(t.onFailure(e),O()):(r.setAuthoringState(!0,T.PADSession_disabling_index_object_not_found,!0),i._load(t)));else{i._stopAsync({userFeedback:t.userFeedback});var p={filterMessage:T.sequence_filter_error,display:!0,eventID:"info"};t.CVQuery3D&&(t.CVQuery3DToStoreOnObject=t.CVQuery3D,delete t.CVQuery3D,t.expand_iter="0",t.progressiveExpand=!1,t.blockNbChildren=!0,i._loadingQueue.push(t),i._operationInProgress=!1),t.onFailure&&(t.onFailure(p),O())}else i._model.buildFromJSON({fromLoadJSON:m,rootIds:[C],json:l,filteredBBox:s&&s.min&&s.max?s:void 0,reframe:o,parent:g,hidden:_,forceLoad:t.forceLoad,partialOpen:void 0!==a&&a.length>1,partialOpenPath:void 0!==a&&a.length>1?a:null,progressiveExpand:S,expand3DType:v,streamToLoad:i.getDefaultStreamToLoad(),nbRoot:i.getNbRoots(),intent:t.intent,elasticLoadingGranted:n.getSetting("enopad3dviewer_lightNodeModel")?i._elasticLoadingGranted:void 0,blockNbChildren:t.blockNbChildren,extraAttribute:i._colorMap?i._colorMap.predicate:void 0,callbacks:{onCGRLoad:function(e){t&&t.onProgress&&t.onProgress(e)},onReframe:function(e){i.publish({event:"onReframe",data:e})},onComplete:function(e){if(i){i._stopAsync({userFeedback:t.userFeedback});var o=i.getRoot({id:C});o?(R.isPLMNode(o)&&(t.CVQuery3D=t.CVQuery3D||t.CVQuery3DToStoreOnObject,t.configBin?o.setConfigFilter(h):o.setConfigFilter(void 0),t.sequence_filter?o.setSequenceFilter(c):o.setSequenceFilter(void 0),t.CVQuery3D?o.setCVFilterQuery(t.CVQuery3D):o.setCVFilterQuery(void 0)),t.onComplete&&t.onComplete(e)):t.onFailure&&t.onFailure(),l=null,O()}}}});else{i._stopAsync({userFeedback:t.userFeedback});var u=!1,f=!1;if(!i._isAuthored()&&!i.isReadOnly())for(var b=0;b<l.error.errors.length;b++)"CLOUDVIEW_ERROR__INVALID_PATH_QUERY"===l.error.errors[b].errorCode||"CLOUDVIEW_ERROR__INVALID_ROOTS"===l.error.errors[b].errorCode?u=!0:"VOLUME_QUERIES_DISABLED"===l.error.errors[b].errorCode&&(f=!0);if(u)r.setAuthoringState(!0,T.PADSession_disabling_index_object_not_found,!0),i._load(t);else if(f)t.CVQuery3D&&(i._operationInProgress=!1,delete t.CVQuery3D,t.expand_iter="0",t.progressiveExpand=!1,t.blockNbChildren=!0,i._load(t),i.publish({event:"onVQDisabled"}));else if(t.onFailure){var y={filterMessage:T.cannot_insert_branch};t.onFailure(y,null,null)}O()}}i._abortLoading=function(){L._interruptLoading(C),L._stopAsync({userFeedback:t.userFeedback}),t.onCancel&&t.onCancel(),O()},i._pauseLoading=function(){L._runningQuery&&(L._pauseQuery(),L._stopAsync({userFeedback:t.userFeedback}),t.onCancel&&t.onCancel(),O())},i._startAsync(!1===t.cancelable?{userFeedback:t.userFeedback}:{onCancel:i.abortLoading.bind(i),userFeedback:t.userFeedback}),i.publish({event:"onBeginRootLoading"}),A.setText(E.queryRunning);var k=!i._useWrap&&!f&&!i.isReadOnly();if(d)n.getSetting("enopad3dviewer_lightNodeModel")?this._fillRootStats({data:{rootPhID:C,fromLocalJSON:!0},FBIProxy:this._BIProxy._biFilter,onComplete:function(e,i){this._model.buildFromJSON({rootIds:[e],json:i,reframe:o,intent:"addRoot",callbacks:{onCGRLoad:function(e){t&&t.onProgress&&t.onProgress(e)},onReframe:function(e){this.publish({event:"onReframe",data:e})}.bind(this),onComplete:function(t){this._model.freezeRoot(e)}.bind(this)}})}.bind(this,C)},function(e){e(d)}.bind(this,F),t,d.rootStats):F(d);else{var B={serviceId:t.serviceId,enopad_webapis:k,withFrustumFilter:void 0===t.withFrustumFilter?i.isLargeDataStructure(C):t.withFrustumFilter,data:I,expand3DType:v,timeout:b,onComplete:F,onCancel:t.userFeedback?void 0:t.onCancel?t.onCancel:void 0,onFailure:function(e,o,n){var s;i.navQueryProbe&&(i.navQueryProbe.end(),delete i.navQueryProbe);try{s="string"==typeof o?JSON.parse(o):o,i._stopAsync({userFeedback:t.userFeedback}),i._isAuthored()||!s||!s.error||"CLOUDVIEW_ERROR__INVALID_ROOT"!==s.error.errorCode&&-1===s.error.errorMessage.search("No input query root")?t.onFailure&&t.onFailure(e,o,n):(r.setAuthoringState(!0,T.PADSession_disabling_index_object_not_found,!0),i._load(t)),O()}catch(o){i._stopAsync({userFeedback:t.userFeedback}),t.onFailure&&t.onFailure(e,null,n),O()}},onTimeout:function(){i.navQueryProbe&&(i.navQueryProbe.end(),delete i.navQueryProbe),i._stopAsync({userFeedback:t.userFeedback}),t.onTimeout&&t.onTimeout(),O()}};!p||"progressiveExpand"===v||n.getSetting("enopad3dviewer_lightNodeModel")||n.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")?"progressiveExpand"===v&&n.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")?(B.readOnly=this.isReadOnly(),B.FBIProxy=this._BIProxy._biFilter,"addRoot"===t.intent?this.fillRootStats(B,t):(B.overrides=i._context.getViewer().getSceneGraphOverrideSetManager().exportIdPathOverrides("position"),i._runningQuery=s.progressiveExpand(B))):(t.findInCtx||t.find_in_context_physicalid||t.findPaths||t.taggerSelect)&&n.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")?(B.FBIProxy=this._BIProxy._biFilter,B.data.searchQuery=t.findInCtx?t.findInCtx:t.find_in_context_physicalid,B.data.subPaths=t.findPaths?t.findPaths:void 0,B.data.taggerSelect=t.taggerSelect,this._runningQuery=s.searchV2(B)):(delete B.data.rootPhID,delete B.serviceId,i._runningQuery=s.navigate(B)):(delete B.data.rootPhID,delete B.serviceId,i._runningQuery=s.multiexpand(B))}},getAttributes:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.ids))throw new Error("No input ids defined");if(!Array.isArray(e.attributes))throw new Error("No attributes to load defined");if("object"!=typeof e.callbacks)throw new Error("No callbacks function defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback function defined");if("function"!=typeof e.callbacks.onFailure)throw new Error("No onFailure callback function defined");for(var t=[],i=[],o=0;o<e.attributes.length;o++){var r=e.attributes[o];switch(r){case"type_icon_url":t.push("icon");break;case"cgr":this._stepcgrAvailableForRole&&t.push("stepcgr"),t.push(r),t.push("assembly_cgr");break;case"thumbnail_3d":case"thumbnail_2d":case"svg":t.push(r);break;default:i.push(r)}}s.fetch({enopad_webapis:!this.isReadOnly(),pids:e.ids,data:{authored:e.authored?e.authored:this._isAuthored(),intent:"fetch_3D",select_file:t.length?t:void 0,select_predicate:i.length?i:void 0,fcs_url_mode:n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0},onComplete:function(t){var i="string"==typeof t?JSON.parse(t):t;if(!i.results||0===i.results.length){var o=new Error("Cannot find object with the physicalid "+e.ids);throw e.callbacks.onFailure(o),o}i.results.length!==e.ids.length&&console.warn("Warning : some results are missing from input");for(var n={},s=0;s<i.results.length;s++){var r=i.results[s];if(void 0!==r.attributes){for(var a=null,l={},d=0;d<r.attributes.length;d++){var h=r.attributes[d];"resourceid"===h.name?a=h.value:"assembly_cgr"===h.name?l.cgr=h.value:l[h.name]||(l[h.name]=h.value)}l.stepcgr&&(l.cgr=l.stepcgr,delete l.stepcgr),n[a]=l}}e.callbacks.onComplete(n)},onFailure:function(t,i,o){e.callbacks.onFailure(t)}})},addFilter:function(e,t,i){if(this.isStandaloneFilterAvailable()){if(!e.filter_objects){for(var o=[],s=0;s<e.length;++s)o.push({envId:V.getPlatformId(),serviceId:"3DSpace",contextId:n.getSetting("pad_security_ctx")?n.getSetting("pad_security_ctx"):void 0,objectId:e[s].objectId,objectType:"ENOStrRefinementSpecification",displayType:"Advanced Filter"});e=o}this._retrieveFilter(e,t,!i)}else this.isSlaveFilterAvailable()&&this._commandProxy.addFilter(e)},volumeQueryFilter:function(e,t,i){var o=this,r=!!e.completion&&e.completion,a=o.getRootBag(),d=parseInt(n.getSetting("webapi_timeout")),h={enopad_webapis:!1,data:e.data,timeout:d,onComplete:function(n){var s;try{s="string"==typeof n?JSON.parse(n):n}catch(t){return o.publish({event:"onLoadingFailure",data:{message:E.cannotParseQueryResult}}),e.callbacks.onFailure(t),void i()}if("CLOUDVIEW_ERROR__SUMMARY"===(!!s.error&&s.error.errorCode))return e.callbacks.onFailure({errors:s.error.errors}),void i();if(!s.results)return e.callbacks.onFailure(),void i();if(r)o._model.buildFromJSON({rootIds:e.rootIds,json:s,parent:a,hidden:!1,forceLoad:!0,streamToLoad:o.getDefaultStreamToLoad(),nbRoot:o.getNbRoots(),callbacks:{onCGRLoad:function(e){o.nbCGRToLoad=e.nbCGRToLoad,o.publish({event:"onProgress",data:{progress:Math.floor(e.nbCGRLoaded/e.nbCGRToLoad*100),message:E.displaying3D+": "+e.nbCGRLoaded+" of "+e.nbCGRToLoad+" "+E.parts,reframe:!1}})},onComplete:function(e){e.createdPaths&&(t.createdPaths=t.createdPaths.concat(e.createdPaths)),e.selectedPaths&&(t.selectedPaths=t.selectedPaths.concat(e.selectedPaths)),!0===e.expandCut&&l.displayNotification({msg:E.tooManyResultFound,eventID:"warning"}),i()}}});else{var d=[];A.setText(E.parsingResponse);for(var h={},c=0;c<s.results.length;c++){var p=s.results[c];if(void 0!==p.attributes){for(var u="",g="",_=0;_<p.attributes.length;_++){var f=p.attributes[_];"did"===f.name?u=f.value:"physicalid"===f.name&&(g=f.value)}h[u]=g}if(void 0!==p.path){var v=[];for(_=0;_<p.path.length;_++){var m=h[p.path[_].toString()];m&&v.push(m)}if(v.length){var b=o.buildPathFromArray(v);b&&d.push(b)}}}n.selectedPaths&&(t.selectedPaths=t.selectedPaths.concat(n.selectedPaths)),i()}},onFailure:function(t,n,s){o._stopAsync(),o._querySuccess=!1,e.callbacks.onFailure(t,n,s),i()}};h.data.max_output_paths=n.getSetting("enopad3dviewer_max_count_in_vq"),!0===n.getSetting("enopad3dviewer_lightNodeModel")?(this._transformVolumeQueryFormat(h),h.FBIProxy=this._BIProxy._biFilter,e.rootIds&&e.rootIds.length>0&&(h.data.rootPhID=e.rootIds[0]),h.overrides=o._context.getViewer().getSceneGraphOverrideSetManager().exportIdPathOverrides("position"),s.volumeQueryV2(h)):e.data.union||e.data.intersect||e.data.minus?s.multiexpand(h):s.volumeQuery(h)},_transformVolumeQueryFormat:function(e){var t=e.data.volume_filter;if(t)if(t.box){e.data.volume_filter.box_filter=e.data.volume_filter.box,delete e.data.volume_filter.box;var i=e.data.volume_filter.box_filter.corner_min,o=e.data.volume_filter.box_filter.corner_max,n=e.data.volume_filter.box_filter.transformation_matrix;e.data.volume_filter.box_filter.corner_min=[],e.data.volume_filter.box_filter.corner_max=[],e.data.volume_filter.box_filter.transformation_matrix=[];for(var s=0;s<i.length;++s)e.data.volume_filter.box_filter.corner_min.push(parseFloat(i[s]));for(s=0;s<o.length;++s)e.data.volume_filter.box_filter.corner_max.push(parseFloat(o[s]));for(s=0;s<n.length;++s)e.data.volume_filter.box_filter.transformation_matrix.push(parseFloat(n[s]))}else if(t.sphere){e.data.volume_filter.sphere_filter=e.data.volume_filter.sphere,delete e.data.volume_filter.sphere,e.data.volume_filter.sphere_filter.radius=parseFloat(e.data.volume_filter.sphere_filter.radius);var r=e.data.volume_filter.sphere_filter.center;e.data.volume_filter.sphere_filter.center=[];for(s=0;s<r.length;++s)e.data.volume_filter.sphere_filter.center.push(parseFloat(r[s]))}else t.assemblyshape&&(e.data.volume_filter.assembly_shape_filter=e.data.volume_filter.assemblyshape,e.data.volume_filter.assembly_shape_filter.assembly_shape_path={physical_id_path:[]},e.data.volume_filter.assembly_shape_filter.assembly_shape_path.physical_id_path=e.data.volume_filter.assembly_shape_filter.root_path_physicalid[0],e.data.volume_filter.assembly_shape_filter.distance=parseFloat(e.data.volume_filter.assembly_shape_filter.distance),delete e.data.volume_filter.assembly_shape_filter.root_path_physicalid,delete e.data.volume_filter.assemblyshape)},volumeQuery:function(t){if("object"!=typeof t)throw new Error("No parameter defined");if("object"!=typeof t.data)throw new Error("No input data defined");if("object"!=typeof t.callbacks)throw new Error("No callbacks function defined");if("function"!=typeof t.callbacks.onComplete)throw new Error("No onComplete callback function defined");if("function"!=typeof t.callbacks.onFailure)throw new Error("No onFailure callback function defined");var o=this;o._startAsync(),this._filterCheckPromise=[];o.getRootBag();var s=[],r=[],l=e.clone(n.getWebAPI_Options("navigate3D"),!0);t.data.boundingbox=void 0===t.data.boundingbox?o._withBoundingBoxes():t.data.boundingbox,t.data.select_bo=void 0===t.data.select_bo?l.select_bo:t.data.select_bo,t.data.select_rel=void 0===t.data.select_rel?l.select_rel:t.data.select_rel,t.data.compute_select_bo=void 0===t.data.compute_select_bo?"thumbnail"===this.getDefaultStreamToLoad()?l.computeCGRsNThumbnails:l.computeCGRs:t.data.compute_select_bo,t.data.get_materials=this.needToGetMaterials(),t.data.materialParameters=!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0,this._dataLoadedWithoutMaterial=this.isViewerInMaterialMode(),t.data.fcs_url_mode=n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0;for(var d=[],h=0;h<t.data.root_path_physicalid.length;h++)d.push(t.data.root_path_physicalid[h][0]);if(d){A.setText(E.queryRunning);for(h=0;h<d.length;++h){var c=o.getRoot({id:d[h]});c.getConfigFilter()||c.getSequenceFilter()||c.getCVFilterQuery(o._BIProxy,"V1")?s.push(d[h]):r.push(d[h])}var p={createdPaths:[],selectedPaths:[]};if(s.length>0){var u=e.clone(t,!0);s.forEach(function(t){var i=o.getRoot({id:t});if(n.getSetting("enopad3dviewer_lightNodeModel"))u.root_path_physicalid=[[t]];else{u.data.config_filter=i.getConfigFilter(),u.data.sequence_filter=i.getSequenceFilter();var s=i.getCVFilterQuery(o._BIProxy,"V1");if(s){var r=o._BIProxy.completeCVQueryWithAppSpecs(s,{volume_filter:u.data.volume_filter},!0);delete u.data.volume_filter,delete u.data.root_path_physicalid,u.data=e.extend(u.data,r)}else u.data.config_filter&&u.data.volume_filter&&u.data.volume_filter.assemblyshape&&(u.data.volume_filter.assemblyshape.config_filter=u.data.config_filter)}u.rootIds=[t],o._filterCheckPromise.push(a.createPromise(function(e){o.volumeQueryFilter(u,p,e)},"filterCheckPromise"))})}if(r.length>0)for(h=0;h<r.length;h++)o._filterCheckPromise.push(a.createPromise(function(i){var n=e.clone(t,!0);n.data.root_path_physicalid=[[r[h]]],n.rootIds=[r[h]],o.volumeQueryFilter(n,p,i)},"filterCheckPromise"));var g=a.getPromises().slice();o._filterCheckPromise&&i.all(g).then(function(){g=null,t.callbacks.onComplete({createdPaths:p.createdPaths,selectedPaths:p.selectedPaths,querySuccess:o._querySuccess}),o._stopAsync(),p.createdPaths.length&&o.publish({event:"onCompletionCompleted",data:{nbPathLoaded:p.createdPaths.length,rootNodes:[o.getNode({id:p.createdPaths[0][1]})],reframe:!1}}),delete o._filterCheckPromise})}},switchNodeVisuStreamOnDemand:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.data))throw new Error("No input data defined");var t=a.getPromises().slice();a.createPromise(function(e,o,n){i.all(t).then(function(e){t=null;var s=[],r="thumbnail"===e.data[0].stream?"thumbnail_3d":"cgr",a="cgr"===e.data[0].stream||V.isCloud()?"cgrwms":"3dthbwms";(function(e,t,o){return new i(function(e,t,i,o){this.getAttributes({ids:e,attributes:[i,a],callbacks:{onComplete:function(n){for(var s=[],r=0;r<e.length;r++)s.push({node:t[r].node,stream:t[r].stream,url:n[e[r]][i],wms:n[e[r]][a]});o(s)},onFailure:function(e){o()}}})}.bind(this,e,t,o))}).bind(this);this._startAsync();for(var l=e.data.length-1;l>=0;l--){var d=e.data[l].node,h=this.getLoadedStream(d),c=this.getRequestedStream(d);e.data[l].stream!==h||e.data[l].stream!==c?s.push(R.getNodeID(e.data[l].node)):e.data.splice(l,1)}s.reverse();var p=[];if(s.length>0){for(;s.length>1e3;)p.push(this.switchNodeVisuStream(s.slice(0,1e3),e.data.slice(0,1e3),r,a)),s=s.slice(1e3),e.data=e.data.slice(1e3);p.push(this.switchNodeVisuStream(s,e.data,r,a)),i.all(p).then(function(e,t){if("ERROR"===t[0])return this._stopAsync(),this.publish({event:"onStreamSwitchFailure"}),e.callbacks&&e.callbacks.onFailure&&e.callbacks.onFailure(),void n();for(var i=[],s=0;s<t.length;s++)t[s]&&t[s][0]&&(i=i.concat(t[s]));i.length?this._model.switchNodeVisuStreamOnDemand({data:i,autoLock:void 0===e.autoLock||e.autoLock,noMeshInRAM:e.noMeshInRAM,applicativeContainers:void 0===e.applicativeContainers?void 0:e.applicativeContainers,callbacks:{onURLLoad:function(e){this.publish({event:"onProgress",data:{progress:Math.floor(e.nbURLLoaded/e.nbURLToLoad*100),message:E.displaying3D+": "+e.nbURLLoaded+" of "+e.nbURLToLoad+" "+E.parts,reframe:!1}})}.bind(this),onComplete:function(t){this._stopAsync(),this._loadingQueue.length&&this._processLoadingQueue(),this.publish({event:"onStreamSwitched"}),e.callbacks&&e.callbacks.onComplete&&e.callbacks.onComplete(t),o()}.bind(this)}}):(this._stopAsync(),this.publish({event:"onStreamSwitchFailure"}),e.callbacks&&e.callbacks.onFailure&&e.callbacks.onFailure(),n())}.bind(this,e))}else this._stopAsync(),this.publish({event:"onStreamSwitched"}),e.callbacks&&e.callbacks.onComplete&&e.callbacks.onComplete({nbUrlLoaded:0}),o()}.bind(this,e))}.bind(this,e))},expand:function(e,t,o,s){if(o=void 0===o||o,s=void 0!==s&&s,"object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.paths){e.reframe&&(s=e.reframe),e.singleAdd=void 0===e.singleAdd||e.singleAdd,e.intent=void 0===e.intent?"expand":e.intent,!0===n.getSetting("enopad3dviewer_lightNodeModel")&&(e.progressiveExpand=!0);var r=this,l=[],d=a.getPromises().slice();if(e.singleAdd)for(var h=0;h<e.paths.length;h++){var c=e.paths[h];a.createPromise(function(t,i){var a=c[0],d=Array.isArray(a)?a[0]:a,h=r.getNode({id:Array.isArray(a)?a[0]:a}),p=n.getSetting("enopad3dviewer_lightNodeModel")&&r.getRootStats(d)?r.getRootStats(d).serviceId:"3DSpace";if(h){var u={cancelable:!1,serviceId:p,path:c,parent:r.getRootBag(),hidden:!1,intent:e.intent,progressiveExpand:e.progressiveExpand,withFrustumFilter:e.withFrustumFilter,expand_iter:e.expand_iter,forceLoad:e.forceLoad,sequence_filter:h.getSequenceFilter&&h.getSequenceFilter()?h.getSequenceFilter():void 0,configBin:h.getConfigFilter&&h.getConfigFilter()?h.getConfigFilter():void 0,CVQuery3D:h.getCVFilterQuery&&h.getCVFilterQuery(r._BIProxy,"V1")?h.getCVFilterQuery(r._BIProxy,"V1"):void 0,resolve:t,onComplete:function(i){var n=new M;n.addElement(r.getRootBag());for(var a=0;a<c.length-1;a++){var l=r.getNode({id:c[a]});l&&n.addElement(l)}r.publish({event:"onExpandCompleted",data:{path:n,rootNodes:h,displayNotif:o}}),t&&t(),r._loadingQueue.length?r._processLoadingQueue():(e.onComplete&&e.onComplete(),r.publish({event:"onComplete",data:{BS:i.BS,reframe:s,displayNotif:o}}))},onProgress:function(e){r.publish({event:"onProgress",data:{progress:Math.floor(e.nbCGRLoaded/e.nbCGRToLoad*100),message:E.displaying3D+": "+e.nbCGRLoaded+" of "+e.nbCGRToLoad+" "+E.parts,reframe:!1}})},onFailure:function(){r.publish({event:"onLoadingFailure",data:{message:T.generic_service_failure,displayNotif:o}}),t&&t(),r._loadingQueue.length?r._processLoadingQueue():(e.onFailure&&e.onFailure(),r.publish({event:"onComplete",data:{reframe:s,displayNotif:o}}))},onTimeout:function(){r.publish({event:"onLoadingFailure",data:{message:E.timeout,displayNotif:o}}),t&&t(),r._loadingQueue.length?r._processLoadingQueue():(e.onFailure&&e.onFailure(),r.publish({event:"onComplete",data:{reframe:s,displayNotif:o}}))}};l.push(u)}else console.warn("No root found"),t&&t()},"expand")}else{var p=(c=e.paths)[0][0],u=r.getRoot({id:p}),g=n.getSetting("enopad3dviewer_lightNodeModel")&&r.getRootStats(p)?r.getRootStats(p).serviceId:"3DSpace";a.createPromise(function(t,i){var n={cancelable:!1,serviceId:g,paths:c,userFeedback:!1,parent:r.getRootBag(),hidden:!1,resolve:t,progressiveExpand:e.progressiveExpand,withFrustumFilter:e.withFrustumFilter,expand_iter:e.expand_iter,forceLoad:e.forceLoad,pixelCulling:e.pixelCulling,sequence_filter:u.getSequenceFilter&&u.getSequenceFilter()?u.getSequenceFilter():void 0,configBin:u.getConfigFilter&&u.getConfigFilter()?u.getConfigFilter():void 0,CVQuery3D:u.getCVFilterQuery&&u.getCVFilterQuery(r._BIProxy,"V1")?u.getCVFilterQuery(r._BIProxy,"V1"):void 0,onComplete:function(i){if(t&&t(),r._loadingQueue.length)r._processLoadingQueue();else{e.onComplete&&e.onComplete(i);for(var n=[],a=0;a<c.length-1;a++)n.push(r.buildPathFromArray(c[a]));r.publish({event:"onExpandCompleted",data:{paths:n,rootNodes:u,displayNotif:o}}),r.publish({event:"onComplete",data:{reframe:s,displayNotif:o}})}},onFailure:function(){r.publish({event:"onLoadingFailure",data:{message:T.generic_service_failure,displayNotif:o}}),t&&t(),r._loadingQueue.length?r._processLoadingQueue():(e.onFailure&&e.onFailure(),r.publish({event:"onComplete",data:{reframe:s,displayNotif:o}}))},onCancel:function(){r.publish({event:"onLoadingCancel"}),t&&t(),r._loadingQueue.length?r._processLoadingQueue():e.onFailure&&e.onFailure()},onTimeout:function(){r.publish({event:"onLoadingFailure",data:{message:E.timeout,displayNotif:o}}),t&&t(),r._loadingQueue.length?r._processLoadingQueue():(e.onFailure&&e.onFailure(),r.publish({event:"onComplete",data:{reframe:s,displayNotif:o}}))}};l.push(n)},"expand")}i.all(d).then(function(e){d=null;for(var t=0;t<l.length;t++){var i=l[t];r._loadingQueue.push(i)}r._processLoadingQueue()})}else console.error("No paths array defined")},addRoots:function(e,t,o,s,r){var d,h=this,c=[];if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.pids||void 0!==e.paths||void 0!==e.structures||void 0!==e.objects||void 0!==e.rootsWithFilters){if(void 0!==o&&"boolean"!=typeof o)throw new Error("displayNotif not correctely defined");s=void 0===s||s;var p,u=void 0!==e.objects?e.objects:[],g=void 0!==e.pids_hidden?e.pids_hidden:[],_={};if(e.pids)for(d=0;d<e.pids.length;d++){var f=e.pids[d];u.push({id:f,hidden:g.indexOf(f)>=0})}if(e.paths)for(d=0;d<e.paths.length;d++){var v=e.paths[d];u.push({path:v,hidden:g.indexOf(v[0])>=0})}if(e.rootsWithFilters){var m=!1;for(d=0;d<e.rootsWithFilters.length;d++){f=e.rootsWithFilters[d].rootId;if(-1===c.indexOf(f)){c.push(f);var b=e.rootsWithFilters[d].filter.config_filter,y=e.rootsWithFilters[d].filter.sequence_filter,P=e.rootsWithFilters[d].filter.CVQuery3D;u.push({id:f,configBin:b,sequence_filter:y,CVQuery3D:P,hidden:g.indexOf(f)>=0})}else m=!0}!0===m&&l.displayNotification({msg:T.filterMultipleSameRoot,eventID:"warning"})}if(e.structures)for(d=0;d<e.structures.length;d++)u.push(e.structures[d]);for(!0===e.loadWithFilter&&(!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this.pauseProgressiveLoading(),p="0",this.publish({event:"onDisableUX"}),this._wait4Filter=!0),d=0;d<u.length;d++){var D=u[d];D.id&&(_.pids||(_.pids=[]),_.pids.push(D.id)),D.path&&(_.paths||(_.paths=[]),_.paths.push(D.path))}o=void 0===o||o;var I=[],S=a.getPromises().slice();for(d=0;d<u.length;d++){var C=u[d];a.createPromise(function(t,i){var a=null,l=null,d=null,c=null,u=void 0!==C.configBin?C.configBin:void 0,g=void 0!==C.sequence_filter?C.sequence_filter:void 0,_=void 0!==C.hidden&&C.hidden,f=void 0!==C.CVQuery3D?C.CVQuery3D:void 0,v=void 0!==C.filterId?C.filterId:void 0;C.structure&&C.rootID?(l=void 0!==C.validForServerCall&&C.validForServerCall,a=C.structure,d=C.rootID,c=[C.rootID],C.refreshDelegationCB&&h._delegatedRootCB.set(C.rootID,C.refreshDelegationCB)):C.id?(d=C.id,c=[C.id]):C.path&&(d=C.path[0],c=C.path);var m={cancelable:!0,reframe:s,path:c,structure:a,validForServerCall:l,parent:h.getRootBag(),hidden:_,configBin:u,sequence_filter:g,CVQuery3D:f,resolve:t,intent:"addRoot",expand_iter:p,loadWithFilter:e.loadWithFilter,serviceId:void 0!==C.serviceId?C.serviceId:"3DSpace",onComplete:function(i){s=!n.getSetting("enopad3dviewer_dynamicRepLoading")&&!n.getSetting("enopad3dviewer_lightNodeModel")&&s;var l=new M;l.addElement(h.getRootBag());for(var p=0;p<=c.length-1;p++){var u=h.getNode({id:c[p]});u&&l.addElement(u)}-1===h._rootIds.indexOf(d)&&(h._rootIds.push(d),_&&-1===h.getHiddenRootIds().indexOf(d)&&h.getHiddenRootIds().push(d));var g=!!a||void 0;g?h._model.declareUnsupportedRoot(d):h._model.addToRootLog(c),h.publish({event:"onRootAdded",data:{fromLoadJSON:g,path:l,rootLog:h._model.getRootLog(),isFiltered:e.loadWithFilter,filterId:v,id:d,idPath:c,displayNotif:o,reframe:s,inContext:c.length>1,hidden:this.hidden,BS:i.BS,orientation:i.orientation,serviceId:C.serviceId}}),t&&t(),h._loadingQueue.length?h._processLoadingQueue():(h.publish({event:"onComplete",data:{reframe:s,BS:i.BS,intend:"addRoot"}}),h.publish({event:"onRootAdditionTransactionComplete",data:{loadWithFilter:e.loadWithFilter}}),r&&r())},onProgress:function(e){h.publish({event:"onProgress",data:{progress:Math.floor(e.nbCGRLoaded/e.nbCGRToLoad*100),message:E.displaying3D+": "+e.nbCGRLoaded+" of "+e.nbCGRToLoad+" "+E.parts,reframe:s}})},onFailure:function(e,i,n){var a=null,l=null;a=e&&e.filterMessage?e.filterMessage:T.generic_service_failure,e&&e.eventID&&(l=e.eventID);var d="string"==typeof i?JSON.parse(i):i;d&&d.error&&d.error.errorCode&&T[d.error.errorCode]&&(a=T[d.error.errorCode]);var c=e&&!0===e.display?e.display:o;h.publish({event:"onLoadingFailure",data:{displayNotif:c,message:a,eventID:l}}),t&&t(),h._loadingQueue.length?h._processLoadingQueue():(h.publish({event:"onComplete",data:{reframe:s}}),r&&r({onFailure:!0}))},onTimeout:function(){h.publish({event:"onLoadingFailure",data:{displayNotif:o,message:E.timeout}}),t&&t(),h._loadingQueue.length?h._processLoadingQueue():(h.publish({event:"onComplete",data:{reframe:s}}),r&&r())},onCancel:function(){if(h.removeRoots({pids:[d]}),t&&t(),h._loadingQueue.length){var e=h._loadingQueue.splice(0,1);e[0]&&e[0].onCancel&&e[0].onCancel()}else h.publish({event:"onLoadingCanceled",data:{message:E.loadingCanceled}}),h.publish({event:"onComplete",data:{reframe:s}}),r&&r()}};I.push(m)},"addRoot")}if(i.all(S).then(function(e){S=null;for(var t=0;t<I.length;t++){for(var i=I[t],o=i.path,s=!1,r=0;r<h._model.getRootLog().length;r++){var a=h._model.getRootLog()[r];if(a.length===o.length){s=!0;for(var l=0;l<o.length;l++)a[l]!==o[l]&&(s=!1);if(s)break}}s?(h.publish({event:"onRootAlreadyExisting",data:{id:o[0]}}),i.resolve()):(i.hidden||(i.hidden=h.getHiddenRootIds().indexOf(i.path[0])>-1),h._loadingQueue.push(i))}!0===n.getSetting("enopad3dviewer_initializeWithWrap")&&h.setWrapUsage(!0),h._processLoadingQueue(),!0===n.getSetting("enopad3dviewer_initializeWithWrap")&&h.setWrapUsage(!1)}),(t||void 0===t)&&h._commandProxy){var w=require("DS/PADUtils/PADUtilsServices");_.tenant=w.getPlatformId(),!0===e.loadWithFilter&&(_.loadWithFilter=!0),h._commandProxy.drop(_)}}else console.error("No ids or paths array defined")},attachRoot:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.id){this._model.attachNode({id:e.id,parentId:this.getRootBagId()})}else console.error("No ids array defined")},attachRoots:function(e,t){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.pids){var o=this,n=a.getPromises().slice();a.createPromise(function(s,r){i.all(n).then(function(i){n=null;for(var r=0;r<e.pids.length;r++){var a=e.pids[r],l=o.getNode({id:a});if(l){o.attachRoot({id:a});for(var d=o.getHiddenRootIds().length-1;d>=0;d--)if(o.getHiddenRootIds(d)===a){o.getHiddenRootIds().splice(d,1);break}var h=o.getRootBagPath();h.addElement(l),o.publish({event:"onRootAttached",data:{path:h,id:a}})}}(t||void 0===t)&&o._commandProxy&&o._commandProxy.attach(e),s()})},"attachRoot")}else console.error("No ids array defined")},removeRoots:function(e,t,o){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.pids){o=void 0===o?void 0===e.reframe||e.reframe:o;var n=this,s=!1,r=a.getPromises().slice(),l=0;a.createPromise(function(a,d){i.all(r).then(function(i){r=null;for(var d=0;d<e.pids.length;d++){var h=e.pids[d],c=n.getRoot({id:h}),p=n.getNode({id:h});if(c){if(n.publish({event:"onBeginRootRemoved",data:{dispatch:t,fromTimeline:!!e&&e.fromTimeline}}),!0===e.removeDetached&&(s=!0),n._model.removeRoot({id:h,intent:e.intent,removeDetached:s}),n._rootIds.indexOf(h)>-1){n._rootIds.splice(n._rootIds.indexOf(h),1);for(var u=n.getHiddenRootIds().length-1;u>=0;u--)if(n.getHiddenRootIds(u)===h){n.getHiddenRootIds().splice(u,1);break}}var g=n.getRootBagPath();g.addElement(p),n.publish({event:"onRootRemoved",data:{path:g,id:h,reframe:o,rootLog:n._model.getRootLog(),dispatch:t,fromTimeline:!!e&&e.fromTimeline}}),++l}}(t||void 0===t)&&n._commandProxy&&n._commandProxy.remove(e),a(),l>0&&n.publish({event:"onEndRootRemoved",data:{ids:e.pids,fromRefresh:e.fromRefresh,fromWidgetLink:e.fromWidgetLink,fromTimeline:!!e&&e.fromTimeline}}),o=null,n=null})},"RemoveRoot")}else console.error("No ids array defined")},detachRoots:function(e,t){if("object"!=typeof e)throw new Error("No parameter defined");if(void 0!==e.pids){var o=this,n=a.getPromises().slice();a.createPromise(function(s,r){i.all(n).then(function(i){n=null;for(var r=0;r<e.pids.length;r++){var a=e.pids[r],l=o.getNode({id:a});if(l&&-1===o.getHiddenRootIds().indexOf(a)){o._model.detachNode({id:a,parentId:o.getRootBagId()}),o.getHiddenRootIds().push(a);var d=o.getRootBagPath();d.addElement(l),o.publish({event:"onRootDetached",data:{path:d,id:a}})}}(t||void 0===t)&&o._commandProxy&&o._commandProxy.detach(e),s()})},"detachRoot")}else console.error("No ids array defined")},unparent:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.deleted))throw new Error("No deleted objects streamed");for(var t=0,i=0;i<e.deleted.length;i++){var o=e.deleted[i],s=null;if(s=!0===n.getSetting("enopad3dviewer_lightNodeModel")?this.isRegistered(o):this.getNode({id:o})){this.publish({event:"onBeginDelete",data:{pathToReparent:n.getSetting("enopad3dviewer_lightNodeModel")?o:s,deletedNodeId:n.getSetting("enopad3dviewer_lightNodeModel")?o:void 0}});var r=null;n.getSetting("enopad3dviewer_lightNodeModel")||(r=R.getRootReferences(s)),this._model.removeNode({id:o}),this.publish({event:"onEndDelete",data:{pathToReparent:n.getSetting("enopad3dviewer_lightNodeModel")?o:s,deletedNodeId:n.getSetting("enopad3dviewer_lightNodeModel")?o:void 0,rootNodes:r}})}else t++}!0===n.getSetting("enopad3dviewer_lightNodeModel")&&(t?(this.publish({event:"onAuthoringIgnored",data:{reason:t===e.deleted.length?"authoringOperation_aborted_unknownObject":"authoringOperation_partiallyProcessed_unknownObject"}}),t!==e.deleted.length&&(this.switchAuthoringMode(!0,!1,"PADSession_disabling_index_authoring"),this.forceRefresh())):(this.switchAuthoringMode(!0,!1,"PADSession_disabling_index_authoring"),this.forceRefresh()))},reparent:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.deleted))throw new Error("No deleted objects streamed");if(!Array.isArray(e.modified))throw new Error("No modified objects streamed");if(!Array.isArray(e.created))throw new Error("No created objects streamed");this.switchAuthoringMode(!0,!1,"PADSession_disabling_index_authoring"),!0===n.getSetting("enopad3dviewer_lightNodeModel")?this._reparentForOOC(e):this._reparent(e)},_reparent:function(t){var o=a.getPromises().slice();a.createPromise(function(r,a){i.all(o).then(function(i){o=null;var a=this.getNode({id:t.deleted[0]}),l=this.getNode({id:t.modified[0]}),d=t.created[0];if(a&&l&&d){this.publish({event:"onBeginReparent",data:{pathToReparent:null,reparentedInstance:a}});var h=parseInt(n.getSetting("webapi_timeout")),c=e.clone(n.getWebAPI_Options("navigate3D"),!0),p={root_physicalid:R.getNodeID(l),expand_iter:"1",select_bo:c.select_bo,select_rel:c.select_rel,compute_select_bo:"thumbnail"===this.getDefaultStreamToLoad()?c.computeCGRsNThumbnails:c.computeCGRs,intent:"explore_3D",authored:this._isAuthored(),boundingbox:this._withBoundingBoxes(),debug:n.getSetting("enopad_webapis_debug"),get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0,fcs_url_mode:n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0};this._dataLoadedWithoutMaterial=!this.isViewerInMaterialMode(),this._startAsync(),A.setText(E.queryRunning),s.navigate({enopad_webapis:!this.isReadOnly(),data:p,timeout:h,expand3DType:"expand3D",onComplete:function(e){var t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){return this._stopAsync(),r(),void this.publish({event:"onReparentFailure",data:{message:E.cannotParseQueryResult}})}if(A.setText(E.parsingResponse),0===t.results.length)this._stopAsync(),r(),this.publish({event:"onReparentFailure",data:{message:E.cannotLoadSuchObject}});else{var i=this._model.reparentNode({json:t,oldInstance:a,newParent:l,createdInstID:d});this._stopAsync(),r(),this.publish({event:"onEndReparent",data:{path:null,createdNode:i,modifiedNode:l,rootNodes:l.getRootReferences()}})}}.bind(this),onFailure:function(e,t,i){this._stopAsync(),r(),this.publish({event:"onReparentFailure",data:{message:T.generic_service_failure}})}.bind(this),onTimeout:function(e,t,i){this._stopAsync(),r(),this.publish({event:"onReparentFailure",data:{message:E.timeout}})}.bind(this)})}}.bind(this))}.bind(this),"reparent")},_reparentForOOC:function(t){var o=a.getPromises().slice();a.createPromise(function(r,a){i.all(o).then(function(i){o=null;var a=t.deleted[0],l=t.modified[0],d=Array.isArray(t.inserted[0])?t.inserted[0][t.inserted[0].length-1]:t.inserted[0],h=t.created[0];if(this.isRegistered(a)&&this.isRegistered(l)&&this.isRegistered(d)&&h){this.publish({event:"onBeginReparent",data:{oldInstanceId:a,newParentId:l,newInstanceId:h,movedRefId:d}});var c=e.clone(n.getWebAPI_Options("navigate3D"),!0),p={root_path_physicalid:[[l,h,d]],expand_iter:"0",select_bo:c.select_bo,select_rel:c.select_rel,compute_select_bo:"thumbnail"===this.getDefaultStreamToLoad()?c.computeCGRsNThumbnails:c.computeCGRs,intent:"explore_3D",authored:this._isAuthored(),boundingbox:!0,debug:n.getSetting("enopad_webapis_debug"),get_materials:this.needToGetMaterials(),materialParameters:!0===this.needToGetMaterials()?this.getMaterialParametersForQuery():void 0,fcs_url_mode:"REDIRECT"};this._dataLoadedWithoutMaterial=!this.isViewerInMaterialMode(),this._startAsync(),A.setText(E.queryRunning),s.navigateV2({enopad_webapis:!this.isReadOnly(),readOnly:this.isReadOnly(),data:p,timeout:6e4,expand3DType:"expand3D",onComplete:function(e){var t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){return this._stopAsync(),r(),void this.publish({event:"onReparentFailure",data:{message:E.cannotParseQueryResult}})}if(A.setText(E.parsingResponse),t.results&&0!==t.results.length){this._model.reparentNode({json:t,oldInstanceId:a,newParentId:l,newInstanceId:h,movedRefId:d,streamToLoad:"cgr"}),this.lockNodes({ids:[d]});var i=this.getNode({id:h});this.unlockNodes({ids:[d]}),this._stopAsync(),this.forceRefresh(),r(),this.publish({event:"onEndReparent",data:{createdNode:i,oldInstanceId:a,newParentId:l,newInstanceId:h,movedRefId:d}})}else this._stopAsync(),r(),this.publish({event:"onReparentFailure",data:{message:E.cannotLoadSuchObject}})}.bind(this),onFailure:function(){this._stopAsync(),r(),this.publish({event:"onReparentFailure",data:{message:T.generic_service_failure}})}.bind(this),onTimeout:function(){this._stopAsync(),r(),this.publish({event:"onReparentFailure",data:{message:E.timeout}})}.bind(this)})}else r(),this.publish({event:"onAuthoringIgnored",data:{reason:"authoringOperation_aborted_unknownObject"}})}.bind(this))}.bind(this),"reparent")},insertExisting:function(e){if("object"!=typeof e)throw new Error("No parameter defined");if(!Array.isArray(e.inserted))throw new Error("No inserted objects streamed");if(!Array.isArray(e.modified))throw new Error("No modified objects streamed");if(!Array.isArray(e.created))throw new Error("No created objects streamed");this.switchAuthoringMode(!0,!1,"PADSession_disabling_index_authoring"),!0===n.getSetting("enopad3dviewer_lightNodeModel")?this._insertExistingForOOC(e):this._insertExisting(e)},_insertExisting:function(t){var o=this,r=t.inserted[0],l=a.getPromises().slice();a.createPromise(function(a,d){i.all(l).then(function(i){l=null,Array.isArray(t.inserted[0])||(console.log("No inserted paths streamed"),t.inserted=[t.inserted],r=t.modified);var d=t.inserted[0][t.inserted[0].length-1],h=o.getNode({id:d}),c=o.getNode({id:t.modified[0]});if(!c)throw new Error("Object to modify not found");var p=t.created[0];if(h){var u=parseInt(n.getSetting("webapi_timeout")),g=e.clone(n.getWebAPI_Options("navigate3D"),!0),_={root_path_physicalid:[r],expand_iter:"-1",select_bo:g.select_bo,select_rel:g.select_rel,compute_select_bo:"thumbnail"===o.getDefaultStreamToLoad()?g.computeCGRsNThumbnails:g.computeCGRs,intent:"explore_3D",authored:o._isAuthored(),boundingbox:o._withBoundingBoxes(),debug:n.getSetting("enopad_webapis_debug"),get_materials:o.needToGetMaterials(),materialParameters:!0===o.needToGetMaterials()?o.getMaterialParametersForQuery():void 0,fcs_url_mode:n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0};o._dataLoadedWithoutMaterial=!o.isViewerInMaterialMode(),o._startAsync(),A.setText(E.queryRunning),s.navigate({enopad_webapis:!o.isReadOnly(),data:_,expand3DType:"expand3D",timeout:u,onComplete:function(e){var t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){return o._stopAsync(),a(),void o.publish({event:"onInsertExistingFailure",data:{message:E.cannotParseQueryResult}})}if(A.setText(E.parsingResponse),0===t.results.length)o._stopAsync(),a(),o.publish({event:"onInsertExistingFailure",data:{message:E.cannotLoadSuchObject}});else{A.setText(E.inserting);var i=o._model.insertExistingNode({json:t,toInsert:h,parent:c,createdInstID:p});o._stopAsync(),a(),o.publish({event:"onInsertExisting",data:{insertedNode:h,modifiedNode:c,createdNode:i,rootNodes:c.getRootReferences()}})}},onFailure:function(e,t,i){o._stopAsync(),a(),o.publish({event:"onInsertExistingFailure",data:{message:T.generic_service_failure}})},onTimeout:function(e,t,i){o._stopAsync(),a(),o.publish({event:"onInsertExistingFailure",data:{message:E.timeout}})}})}else{var f=t.modified[0],v=t.inserted[0][t.inserted[0].length-1],m=t.created[0];o._loadingQueue.push({cancelable:!1,id:f,path:r,expand_iter:"-1",resolve:a,onComplete:function(e){var t=o.getNode({id:f}),i=o.getNode({id:v}),n=o.getNode({id:m});t&&i&&o.publish({event:"onInsertExisting",data:{insertedNode:i,modifiedNode:t,createdNode:n,rootNodes:t.getRootReferences()}}),a&&a()},onFailure:function(){o.publish({event:"onInsertExistingFailure",data:{message:T.generic_service_failure}}),a&&a()},onTimeout:function(){o.publish({event:"onInsertExistingFailure",data:{message:E.timeout}}),a&&a()},onProgress:function(e){o.publish({event:"onProgress",data:{progress:Math.floor(e.nbCGRLoaded/e.nbCGRToLoad*100),message:E.displaying3D+": "+e.nbCGRLoaded+" of "+e.nbCGRToLoad+" "+E.parts,reframe:!1}})}}),o._processLoadingQueue()}})},"insertExisting")},_insertExistingForOOC:function(t){var o=a.getPromises().slice();a.createPromise(function(r,a){i.all(o).then(function(i){o=null;var a=t.inserted[0],l=a[a.length-1],d=t.modified[0],h=t.created[0];if(this.isRegistered(d))if(this.isRegistered(l)){var c=e.clone(n.getWebAPI_Options("navigate3D"),!0),p={root_path_physicalid:[a],expand_iter:"0",select_bo:c.select_bo,select_rel:c.select_rel,compute_select_bo:c.computeCGRs,intent:"explore_3D",authored:this._isAuthored(),boundingbox:!0,debug:n.getSetting("enopad_webapis_debug"),get_materials:!1,fcs_url_mode:n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0};this._dataLoadedWithoutMaterial=!this.isViewerInMaterialMode(),this._startAsync(),A.setText(E.queryRunning),s.navigateV2({enopad_webapis:!this.isReadOnly(),readOnly:this.isReadOnly(),data:p,expand3DType:"expand3D",timeout:6e4,onComplete:function(e){var t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){return this._stopAsync(),r(),void this.publish({event:"onInsertExistingFailure",data:{message:E.cannotParseQueryResult}})}if(A.setText(E.parsingResponse),t.results&&0!==t.results.length){A.setText(E.inserting),this._model.insertExistingNode({json:t,rootIds:[a[0]],insertedNodeId:l,newParentId:d,newInstanceId:h,streamToLoad:"cgr"}),this.forceRefresh(),this.lockNodes({ids:[l]});var i=this.getNode({id:h}),o=this.getNode({id:l});this.unlockNodes({ids:[l]}),this._stopAsync(),r(),this.publish({event:"onInsertExisting",data:{insertedNodeId:l,newParentReferenceId:d,newInstanceId:h,contextRootId:a[0],createdNode:i,insertedNode:o}})}else this._stopAsync(),r(),this.publish({event:"onInsertExistingFailure",data:{message:E.cannotLoadSuchObject}})}.bind(this),onFailure:function(){this._stopAsync(),r(),this.publish({event:"onInsertExistingFailure",data:{message:T.generic_service_failure}})}.bind(this),onTimeout:function(){this._stopAsync(),r(),this.publish({event:"onInsertExistingFailure",data:{message:E.timeout}})}.bind(this)})}else{c=e.clone(n.getWebAPI_Options("navigate3D"),!0),p={root_path_physicalid:[a],expand_iter:"-1",select_bo:c.select_bo,select_rel:c.select_rel,compute_select_bo:c.computeCGRs,intent:"explore_3D",authored:this._isAuthored(),boundingbox:!0,debug:n.getSetting("enopad_webapis_debug"),get_materials:!1,fcs_url_mode:n.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0};this._dataLoadedWithoutMaterial=!this.isViewerInMaterialMode(),this._startAsync(),A.setText(E.queryRunning),s.navigateV2({enopad_webapis:!this.isReadOnly(),readOnly:this.isReadOnly(),data:p,expand3DType:"expand3D",timeout:6e4,onComplete:function(e){var t;try{t="string"==typeof e?JSON.parse(e):e}catch(e){return this._stopAsync(),r(),void this.publish({event:"onInsertExistingFailure",data:{message:E.cannotParseQueryResult}})}if(A.setText(E.parsingResponse),t.results&&0!==t.results.length){A.setText(E.inserting),this._model.insertExistingNode({json:t,rootIds:[a[0]],insertedNodeId:l,newParentId:d,newInstanceId:h,streamToLoad:"cgr"}),this.forceRefresh(),this.lockNodes({ids:[l]});var i=this.getNode({id:h}),o=this.getNode({id:l});this.unlockNodes({ids:[l]}),this._stopAsync(),r(),this.publish({event:"onInsertExisting",data:{insertedNodeId:l,newParentReferenceId:d,newInstanceId:h,contextRootId:a[0],createdNode:i,insertedNode:o}})}else this._stopAsync(),r(),this.publish({event:"onInsertExistingFailure",data:{message:E.cannotLoadSuchObject}})}.bind(this),onFailure:function(){this._stopAsync(),r(),this.publish({event:"onInsertExistingFailure",data:{message:T.generic_service_failure}})}.bind(this),onTimeout:function(){this._stopAsync(),r(),this.publish({event:"onInsertExistingFailure",data:{message:E.timeout}})}.bind(this)})}else r(),this.publish({event:"onAuthoringIgnored",data:{reason:"authoringOperation_aborted_unknownObject"}})}.bind(this))}.bind(this),"insertExisting")},_replaceInstances:function(e){var t=this;e.dispatch=void 0===e.dispatch||e.dispatch;var o=t.getPromises(),n=o.slice(),s=i.deferred();return i.all(n).then(function(i){n.splice(0,n.length),t.publish({event:"onBeginReplaceInstance"});for(var o=[],r=[],a=0;a<e.data.length;a++){var l={id:String(e.data[a].oldId)},d={id:String(e.data[a].newId)},h=t._model.updateNode(l,d);"boolean"!=typeof h?o.push(h):r.push(e.data[a])}e.dispatch&&t._commandProxy.padRefresh({transactions:[{replaceInstances:{couples:e.data}}]}),t.publish({event:"onEndReplaceInstance",data:{nodes:o,ids:r}}),s.resolve(o),t=null}),s.name="UpdateNode",o.push(s),s.promise},replaceInstances:function(e,t){if("object"!=typeof e)throw new Error("replaceInstances: There is no parameter defined.");var i=[];if(void 0!==e.data&&0!==e.data.length){var o=null,s=0,r=null;this.switchAuthoringMode(!0,!0,"PADSession_disabling_index_authoring");for(var a=0;a<e.data.length;a++)if((r=this.getNode({id:String(e.data[a].oldId)}))?(R.isInstance(r)||(o="replaceInstances: One or several nodes are not instances."),i.push(e.data[a])):n.getSetting("enopad3dviewer_lightNodeModel")?s++:o="replaceInstances: One or several Ids are invalid.",o){if(t&&t.onFailure)return void t.onFailure.call(null,o);throw new Error(o)}if(s){if(!i.length)return this.publish({event:"onAuthoringIgnored",data:{reason:"authoringOperation_aborted_unknownObject"}}),void(t&&t.onFailure&&t.onFailure.call(null,o));e.data=i,this.publish({event:"onAuthoringIgnored",data:{reason:"authoringOperation_partiallyProcessed_unknownObject"}})}this._replaceInstances(e).then(function(){t&&t.onComplete&&t.onComplete.apply(null,arguments)})}else console.error("replaceInstances: Id pairs array is not defined.")},buildPathFromArray:function(e,t){for(var i=this.getRootBagPath(),o=this.getRoots(),n=!1,s=0;s<o.length;++s)R.getNodeID(o[s])===e[0]&&(n=!0);if(!1===n)return null;for(s=0;s<e.length;s++){var r=this.getNode({id:e[s]});if(r)i.addElement(r);else if(!t)return console.warn(e[s]+" does not exist"),null}return i},buildArrayFromPath:function(e){var t=[];if(e&&e.externalPath&&e.externalPath.length)for(var i=0;i<e.externalPath.length;i++){var o=e.externalPath[i];R.isModelNode(o)&&t.push(R.getNodeID(o))}return t},buildArrayFromPathWithType:function(e,t,i){var o=[];if(e.externalPath&&e.externalPath.length){for(var n=0;n<e.externalPath.length;n++){var s=e.externalPath[n];R.isModelNode(s)&&(o.push(R.getNodeID(s)),R.getNodeType(s)&&(i[R.getNodeID(s)]={type:R.getNodeType(s)}))}t.push(o)}},flushModel:function(e,t,i,o){this.removeRoots({pids:this._rootIds.slice(0),removeDetached:!0,fromRefresh:i,fromWidgetLink:o},!1,t),e&&this._commandProxy&&this._commandProxy.cleanAll()},search:function(e){var t=this.getRoots(),o=this,s=a.getPromises().slice(),r=[];if(t.length>0)for(var l=[],d=0,h=0,c=0,p=0;p<t.length;p++){var u=!0;Array.isArray(e.paths)&&(u=o.isRootSupported(R.getNodeID(t[p]))),u&&a.createPromise(function(i,s,a){var u={cancelable:!1,forceIndex:!0,findInCtx:e.searchQuery,findPaths:e.paths,taggerSelect:e.taggerSelect,path:[R.getNodeID(t[p])],parent:o._model.getRootBag(),sequence_filter:o._model.getRoot({id:R.getNodeID(t[p])}).getSequenceFilter(),configBin:o._model.getRoot({id:R.getNodeID(t[p])}).getConfigFilter(),CVQuery3D:o._model.getRoot({id:R.getNodeID(t[p])}).getCVFilterQuery(o._BIProxy,"V1"),resolve:s,intent:"searchInDsBoard",progressiveExpand:!1,expand_iter:"-1",forceLoad:!0,max_count_path:n.getSetting("enopad3dviewer_max_count_in_search"),onComplete:function(r){++c;var a=0;if(r.memoryFull){for(var p=0;p<r.results.length;++p)if(r.results[p].Path){++a;var u=r.results[p].matching_lengths;if(u)for(var g=[r.results[p].Path.length],_=0;_<u.length;++_){var f=u[_];f%2==0&&f+1<=r.results[p].Path.length&&(f+=1),-1===g.indexOf(f)&&++a}}r.pathCount=a}if(r&&r.selectedPaths&&r.selectedPaths.length){var v=[],m=[];for(p=0;p<r.selectedPaths.length;p++){l.push(r.selectedPaths[p]),o.lockNodes({ids:[r.selectedPaths[p][r.selectedPaths[p].length-1]]});var b=o.buildPathFromArray(r.selectedPaths[p]);b&&R.is3DLeaf(b.externalPath[b.externalPath.length-1])||(1===r.selectedPaths[p].length?m.push(r.selectedPaths[p]):v.push(r.selectedPaths[p]))}if(void 0!==e.paths||void 0!==e.taggerSelect||!v.length&&!m.length||n.getSetting("enopad3dviewer_lightNodeModel")&&(!n.getSetting("enopad3dviewer_lightNodeModel")||o.isLargeDataStructure(i))){if(c===t.length){var y={selectedPaths:l,searchQuery:e.searchQuery,taggerSelect:e.taggerSelect,memoryFull:r.memoryFull,pathCount:a,findPaths:e.paths};l.length===parseInt(n.getSetting("enopad3dviewer_max_count_in_search"))+1&&(o.publish({event:"onSearchTooManyPath",data:y}),y.selectedPaths.pop()),o.publish({event:"onSearchCompleted",data:y})}}else++d,o.expand({paths:m.length?m:v,expand_iter:"-1",singleAdd:!1,onComplete:function(){if(++h===d&&c===t.length){var i={selectedPaths:l,searchQuery:e.searchQuery,taggerSelect:e.taggerSelect,memoryFull:r.memoryFull,pathCount:a};r.selectedPaths.length>parseInt(n.getSetting("enopad3dviewer_max_count_in_search"))&&(o.publish({event:"onSearchTooManyPath",data:r}),i.selectedPaths.pop()),o.publish({event:"onSearchCompleted",data:i})}},onFailure:function(){o.publish({event:"onSearchFailure",data:r})}},!1,!1)}else c===t.length&&(e.paths?r.findPaths=!0:e.searchQuery&&(r.searchQuery=!0),o.publish({event:"onSearchCompleted",data:r}));s&&s(),o._loadingQueue.length?o._processLoadingQueue():o.publish({event:"onComplete",data:{reframe:!1}})},onFailure:function(i){if(++c,l.length){if(c===t.length){var r={selectedPaths:l,searchQuery:e.searchQuery,taggerSelect:e.taggerSelect,findPaths:e.paths};l.length===parseInt(n.getSetting("enopad3dviewer_max_count_in_search"))+1&&(o.publish({event:"onSearchTooManyPath",data:r}),r.selectedPaths.pop()),o.publish({event:"onSearchCompleted",data:r})}}else c===t.length&&o.publish({event:"onSearchFailure",data:i});s&&s(),o._loadingQueue.length?o._processLoadingQueue():o.publish({event:"onComplete",data:{reframe:!1}})},onTimeout:function(e){o.publish({event:"onSearchFailure",data:e}),s&&s(),o._loadingQueue.length?o._processLoadingQueue():o.publish({event:"onComplete",data:{reframe:!1}})}};r.push(u)}.bind(this,t[p].getIdentificationObject()),"search")}else o.publish({event:"onSearchCompleted",data:{selectedPaths:[],searchQuery:e.searchQuery,taggerSelect:e.taggerSelect,findPaths:e.paths}});i.all(s).then(function(e){s=null;for(var t=0;t<r.length;t++){var i=r[t];o._loadingQueue.push(i)}o._processLoadingQueue()})},refresh:function(e){for(var t=this._rootIds.slice(),o=this._model.getRootLog(),n=this.getHiddenRootIds().slice(),s=[],r=t.concat(n),a=[],l=0;l<r.length;l++){var d={filter:{}},h=this.getRoot({id:r[l]});if(h.getConfigFilter&&(d.filter.config_filter=h.getConfigFilter()),h.getSequenceFilter&&(d.filter.sequence_filter=h.getSequenceFilter()),h.getCVFilterQuery&&(d.filter.CVQuery3D=h.getCVFilterQuery(this._BIProxy,"V1")),d.filter.config_filter||d.filter.sequence_filter||d.filter.CVQuery3D){d.rootId=r[l],s.push(d);for(var c=o.length-1;c>=0;c--)Array.isArray(o[c])&&o[c][0]===r[l]&&o.splice(c,1)}if(R.isTileSetNode(this.getNode({id:r[l]}))){for(c=o.length-1;c>=0;c--)Array.isArray(o[c])&&o[c][0]===r[l]&&o.splice(c,1);a.push({objectId:r[l],serviceId:this.getRootStats(r[l]).serviceId,objectType:R.getNodeType(this.getNode({id:r[l]}))})}}if(t.length){this.publish({event:"onRefreshBegin"}),this.flushModel(!1,!1,!0);var p=function(){if(this._delegatedRootCB.size>0){for(var e=[],t=Array.from(this._delegatedRootCB.entries()),o=0;o<t.length;++o)e.push(t[o][1](t[o][0]));i.all(e).then(function(){this._delegatedRootCB.clear(),e=[]}.bind(this)).finally(function(){this.publish({event:"onRefreshCompleted"})}.bind(this))}else this.publish({event:"onRefreshCompleted"})}.bind(this),u=0,g=this.subscribe({event:"onRootRemoved"},function(){++u===t.length&&(this.unsubscribe(g),(o.length||s.length)&&this.addRoots({paths:o.length>0?o:void 0,rootsWithFilters:s.length>0?s:void 0,pids_hidden:n},!1,!1,!1,function(e){e&&e.onFailure&&this._context.getWidget().setTitle(""),p()}.bind(this)),a.length&&this.addR2Vs({objects:a,reframe:!1,displayNotif:!1,dispatch:!1}).then(p),o.length||s.length||a.length||p())}.bind(this));e&&this._commandProxy&&this._commandProxy.refreshModel()}},refreshGeometry:function(e){var t=this,o=a.getPromises().slice();a.createPromise(function(e,n,s){i.all(o).then(function(e){o=null;for(var i={},s=[],r=0;r<e.ids.length;r++)i[e.ids[r]]="thumbnail"===R.getLoadedStream(this.getNode({id:e.ids[r]}),this._context)?"thumbnail_3d":R.getLoadedStream(this.getNode({id:e.ids[r]}),this._context);this._startAsync(),this.getAttributes({ids:e.ids,attributes:["cgr","thumbnail_3d","cgrwms","3dthbwms"],callbacks:{onComplete:function(o){for(var r=[],a=0,l=0;l<e.ids.length;l++)o[e.ids[l]][i[e.ids[l]]]?(s[a]={node:t.getNode({id:e.ids[l]}),stream:R.getLoadedStream(t.getNode({id:e.ids[l]}),t._context),url:o[e.ids[l]][i[e.ids[l]]],wms:"cgr"===o[e.ids[l]][i[e.ids[l]]]||V.isCloud()?o[e.ids[l]].cgrwms:o[e.ids[l]]["3dthbwms"]},a++):r.push(e.ids[l]);t._model.refreshStream({data:s,applicativeContainers:e.applicativeContainers,noMeshInRAM:e.noMeshInRAM,callbacks:{onURLLoad:function(e){t.publish({event:"onProgress",data:{progress:Math.floor(e.nbURLLoaded/e.nbURLToLoad*100),message:E.displaying3D+": "+e.nbURLLoaded+" of "+e.nbURLToLoad+" "+E.parts,reframe:!1}})},onComplete:function(i){t._stopAsync(),t.publish({event:"onGeometryRefreshed"}),r.length&&(i?i.ignoredIds=r:i={ignoredIds:r}),e.onComplete(i),n()}}})},onFailure:function(i){t._stopAsync(),t.publish({event:"onRefreshGeometryFailure"}),e.onFailure(i),n()},onTimeout:function(){t._stopAsync(),t.publish({event:"onRefreshGeometryFailure"}),e.onTimeout(),n()}}})}.bind(this,e))}.bind(this,e))},forceReferencesLoad:function(e){Array.isArray(e.ids)?this._model.forceReferencesLoad(e).then(function(){e.callback&&e.callback()}):console.error("Controller forceReferencesLoad(): Given array is not an array of IDs.")},setForceReferencesLoad:function(e){if("object"!=typeof e)throw new Error("PAD3DViewerController setforceReferencesLoad(): No input data");if(!Array.isArray(e.data))throw new Error("PAD3DViewerController setforceReferencesLoad(): Given options do not contain data array");this._model.setForceReferencesLoad(e).then(function(){e.callback&&e.callback()})},lockNodes:function(e){Array.isArray(e.ids)?this._model.lockNodes(e):console.error("Controller lockNodes(): Given array is not an array of IDs.")},unlockNodes:function(e){Array.isArray(e.ids)?this._model.unlockNodes(e):console.error("Controller unlockNodes(): Given array is not an array of IDs.")},switchNodeVisuStream:function(e,t,o,s){return new i(function(i,s){"cgr"!==o&&"thumbnail_3d"!==o&&console.log("Stream to load is neither cgr nor thumbnail_3d",o);var r={user:V.getUser().login,tenant:V.getPlatformId(),securityCtx:n.getSetting("pad_security_ctx"),spaceUrl:V.get3DSpaceUrl(),viscaUrl:V.getPlatformURL("3dvisucontentaccess"),onCompleteCB:function(e){var n=[];if(e.length){e.length!==t.length&&console.warn("Not all geometries can be switched");for(let t=0;t<e.length;++t)e[t]&&e[t].url&&e[t].version?n.push({node:this.getNode({id:e[t].boid}),stream:o,url:e[t].url,wms:e[t].version}):console.warn("Unknown response formatting from GetStaticUrls.onCompleteCB");i(n)}else console.log("Failed to switch, no URL returned by GetStaticUrls"),i("ERROR")}.bind(this),onFailureCB:function(e){console.error(e),i("ERROR")}},a={source:"3DSpace",type:"cgr"===o?"av1":"pr"};F.prototype.GetStaticUrls(r,a,e)}.bind(this))},isRunning:function(){return this._operationInProgress},publish:function(e){this.getModelEvents().publish(e)},subscribe:function(e,t){return this.getModelEvents().subscribe(e,t)},unsubscribe:function(e){this.getModelEvents().unsubscribe(e)},getModelEvents:function(){return this._modelEvents},getNbRoots:function(){return this.getRoots().length},getRoots:function(){return this.getRootBag().children},getRootBagPath:function(){return this.getRootBag().path.clone()},getRootBagId:function(){return this._model.getRootBagId()},getRootBag:function(){return this._model.getRootBag()},_setDefaultStreamToLoad:function(e){"boolean"==typeof e?e=e?"cgr":"thumbnail":"string"==typeof e&&("HIGH"===e?e="cgr":"OPTIMIZED"===e&&(e="thumbnail")),e&&(this._defaultStreamToLoad=e,this.publish({event:"onDefaultStreamChanged",data:{newStream:e}}))},getDefaultStreamToLoad:function(){return this._defaultStreamToLoad},getPromises:function(){return a.getPromises()},setWrapUsage:function(e){this._useWrap=e},getDecorationBag:function(){return this._model.getDecorationBag()},getLoadingBoxesBag:function(){return this._model.getLoadingBoxesBag()},getNode:function(e){e.id||new Error("No id defined");var t=null;return this._model&&(t=this._model.getNode(e)),t},getUserData:function(e){e.id||new Error("No id defined");var t=null;return this._model&&(t=this._model.getUserData(e)),t},getRoot:function(e){e.id||new Error("No id defined");var t=null;return this._model&&(t=this._model.getRoot(e)),t},abortLoading:function(){this._abortLoading&&(this._abortLoading(),this._abortLoading=null)},_interruptLoading:function(e){this._runningQuery&&this._runningQuery.cancel(),this._model.abort(e)},pauseLoading:function(){this._pauseLoading&&(this._pauseLoading(),this._pauseLoading=null)},_pauseQuery:function(e){this._runningQuery&&this._runningQuery.cancel()},getReferenceBoundingSphere:function(e){return this._model.getReferenceBoundingSphere(e)},getReferenceBoundingBox:function(e){return this._model.getReferenceBoundingBox(e)},getInstanceParentReferenceId:function(e){return this._model.getInstanceParentReferenceId(e)},getInstanceChildReferenceId:function(e){return this._model.getInstanceChildReferenceId(e)},pauseProgressiveLoading:function(){--this._engineState,0===this._engineState&&(this._model.pause(),this.pauseLoading())},resumeProgressiveLoading:function(){++this._engineState,this._engineState>0&&this._model.resume()},unlockChildrenFromProgressiveExpand:function(e){if(e&&e.paths&&e.paths.length)for(var t=0;t<e.paths.length;t++){var i=e.paths[t],o=i[0],n=this.getRootStats(o);n.initialPathes=n.initialPathes.concat([i]),n.pathesToExpand=n.pathesToExpand.concat([i]),this._model.declareTreeModified(o)}},getFcsUrls:function(e){if(!Array.isArray(e.urls))throw new Error("No urls defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback defined");if("function"!=typeof e.callbacks.onFailure)throw new Error("No onFailure callback defined");var t=0;var i=function(e){var t={},i=document.createElement("a");i.href=e;for(var o,n=i.search.substring(1).split("&"),s=0;s<n.length;s++){var r=n[s].split("=");t[r[0]]=(o=r[1],decodeURIComponent((o+"").replace(/\+/g,"%20")))}return t},o={data:{boproxies:[]},onComplete:function(t){try{var i="object"!=typeof t?JSON.parse(t):t;e.callbacks.onComplete(i)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}};for(t=0;t<e.urls.length;t++){var n=i(e.urls[t]);n.boid&&n.format&&n.filename&&o.data.boproxies.push(n)}o.data.boproxies.length&&s.getFcsUrls(o)},registerOverrideSet:function(e){!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._model.registerOverrideSet(e)},setOverrideCB:function(e,t,i){!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._model.setOverrideCB(e,t,i)},hasOverrideCB:function(e,t){var i=!1;return!0===n.getSetting("enopad3dviewer_lightNodeModel")&&(i=this._model.hasOverrideCB(e,t)),i},removeOverrideSet:function(e){!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._model.removeOverrideSet(e)},createReferenceIterator:function(e){if(!0===n.getSetting("enopad3dviewer_lightNodeModel"))return this._model.createReferenceIterator(e)},getOOCSelectedReferenceID:function(){return this._model.getOOCSelectedReferenceID()},getIdPathesLeadingToReference:function(e){if(!0===n.getSetting("enopad3dviewer_lightNodeModel"))return this._model.getIdPathesLeadingToReference(e)},isRegistered:function(e){return this._model.isRegistered(e)},_withBoundingBoxes:function(){return this._context.isSelectiveLoadingActivated()},_disableFilterWaiting:function(e){if(!0===this._wait4Filter){delete this._wait4Filter,this.publish({event:"onEnableUX"});var t={paths:[],intent:"addRoot"};if(Array.isArray(e.rootIds)){for(var i=0;i<e.rootIds.length;i++)t.paths.push([e.rootIds[i]]);var o=!n.getSetting("enopad3dviewer_dynamicRepLoading")&&!n.getSetting("enopad3dviewer_lightNodeModel");!0===this.isStandaloneFilterAvailable()&&!0===n.getSetting("enopad3dviewer_lightNodeModel")?this.resumeProgressiveLoading():this.expand(t,!1,!1,o),this.onSetTagsWithExpandSynthesis()}this._context._filterDrop=!1}navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)||this._context.publish({event:"onVolumeOpen",data:{closePanel:!0}})},_retrieveFilterFailure:function(e){this.isStandaloneFilterAvailable()||this.publish({event:"onRetrieveFilterFailure",data:e})},get3DLayerController:function(){return this._layerController},isReferenceComplete:function(e){return this._model.isReferenceComplete(e)},setDefaultLoadModelOptions:function(e){return this._model.setDefaultLoadModelOptions(e)},getDefaultLoadModelOptions:function(){return this._model.getDefaultLoadModelOptions()},getLoadedStream:function(e){return this._model.getLoadedStream(e)},getRequestedStream:function(e){return this._model.getRequestedStream(e)},forceRefresh:function(){!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._model.forceRefresh()},_getRootLog:function(){return this._model.getRootLog()},addUserQueue:function(e){!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._model.addUserQueue(e)},removeUserQueue:function(e){!0===n.getSetting("enopad3dviewer_lightNodeModel")&&this._model.removeUserQueue(e)},updateInstance:function(e,t){if(this._model.updateInstance){this.switchAuthoringMode(!0,!0,"PADSession_disabling_index_authoring");try{this._model.updateInstance(e,t)}catch(e){throw new Error("Update instance failed")}this.publish({event:"onInstanceUpdated",data:{modifiedInstanceId:e,newParams:t}})}},_getIRPathFromIIPath:function(e){var t=e;return!0===n.getSetting("enopad3dviewer_lightNodeModel")&&(t=this._model._getIRPathFromIIPath(e)),t},isReadOnly:function(){return!n.getSetting("enopad_webapis")},_getMaxPixelCulling:function(){var e=this._context.getViewer().getPixelCulling?this._context.getViewer().getPixelCulling("static"):this._context.getViewer()._effectSettings.PixelCulling.static,t=this._context.getViewer().getPixelCulling?this._context.getViewer().getPixelCulling("dynamic"):this._context.getViewer()._effectSettings.PixelCulling.dynamic,i=n.getSetting("enopad3dviewer_pixelCulling_progressiveExpand");return Math.max(i,Math.min(e,t))},declareUnsupportedRoot:function(e){this._model.declareUnsupportedRoot(e)},removeUnsupportedRootFromMap:function(e){this._model.removeUnsupportedRootFromMap(e)},isRootUnsupported:function(e){return!this.isRootSupported(e)},isRootSupported:function(e){return this._model.isRootSupported(e)},notifyRootVisibilityChange:function(e,t){this._model&&e&&this._model.notifyRootVisibilityChange(e,t)},getExecutionContext:function(){return this._executionContext},getWorldMatrix:function(e){return this._model.getWorldMatrix(e)}});return e.namespace("DS/ENOPAD3DViewer/controller/PAD3DViewerController",G)}),define("DS/ENOPAD3DViewer/PAD3DViewer",["css!DS/ENOPAD3DViewer/ENOPAD3DViewer","UWA/Core","UWA/Controls/Abstract","DS/ENOPAD3DViewer/controller/PAD3DViewerController","DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine","DS/ENOPAD3DViewer/mixins/_PAD3DViewerStartupViewAutoloader","DS/ENOPAD3DViewer/mixins/_PAD3DViewerViewpointController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerSearchResultsView","DS/PADServices/utils/AttributesMgtV2","DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/FrameWindow3D","DS/Visualization/PathElement","DS/Visualization/SceneGraphUtils","DS/Visualization/WorldOrientation","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/i3DXCompassServices/i3DXCompassPubSub","DS/CoreEvents/ModelEvents","DS/Utilities/Utils","DS/PADUtils/PADProbes","DS/PADUtils/PADPromise","DS/PADUtils/PADTypesMgt","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADWSAccess","DS/PADUtils/PADWebInWinServices","DS/PADServices/utils/GlobalUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","UWA/Utils/InterCom","UWA/Promise","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOXTriptych/js/ENOXTriptych","DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/views/PAD3DRootListMgt","DS/ENOPAD3DViewer/views/PAD3DFindInContextColorized","DS/ENOPAD3DViewer/views/PAD3DSOITimelineView","DS/ENOPAD3DViewer/mixins/PAD3DViewerWidgetLink","DS/PADServices/utils/GlobalModelEvents","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS","DS/Utilities/UUID","DS/ENOXInterWdgCom/LinkManager","DS/UIKIT/Modal"],function(e,t,i,o,n,s,r,a,l,d,h,c,p,u,g,_,f,v,m,b,y,P,D,I,S,C,w,x,O,A,M,N,V,E,T,R,L,F,k,B,G,U,z,W,H,j,Q,q,X,K,Z){"use strict";var J={version:"2.0",results:[],structures:[],viewpoint:[]},Y=!1;return i.extend(n,U,z,s,r,a,H,W,{name:"ENOPAD3DViewer",init:function(e){this._pcsPrefix=e.pcsPrefix?e.pcsPrefix:"",!1!==e.activateProbes&&window.top.performance.mark(this._pcsPrefix+"init_pad3dviewer_begin"),this._padintercom=null,this._frmWindow=null,this._viewer=null,this._layout=null,this._UILoader=null,this._lockCSONotification=!1,this._lockCSONotificationEmpty=!1,this._modelEvents=null,this._controller=null,this._applicativeData={},this._controllerTokens=[],this._csoTokens=[],this._psoTokens=[],this._hsoTokens=[],this._filteredIdToReload=[],this._hideShowController=null,this._authorizeSet3DStructure=!1,this._isVolumeFilter=!1,this._isFilterOpen=!1,this._volumePanel=0,this._physicalId=[],this._hideShowControllerTokens=[],this._dndCB=[],this._defaultProgressBarVisibility=null,this._automaticReframePolicy=null,this._displayOnceReadOnlyNotif=!0,this._mouse={x:0,y:0},this._readyCheckPromises=[],this._platformServicesInitPromise=null,this._actionBarTokens=[],this._robotVisibility=!0,this._defaultContextualBarVisibility=!0,this._openWithMenuAvailability=!1,this._defaultContextualMenuVisibility=!0,this._propertiesCommandAvailability=!0,this._BIController=null,this._firstInit=!0,this._interwidgetComAvailability=!0,this._loadingDelegations=null,this._dropZoneContainer=null,this._actionBarCloseEvt=-1,this._actionBarOpenEvt=-1;var t=e.widget;this._lang=t?t.lang:e.windowOptions?e.windowOptions.language:"en",this.getWidget=function(){return t},h.setSetting("eno3dviewer_infrastructure_version","afr"),window.nearFarBigScale=!0,A.initialize(e),this.setAutomaticReframePolicy(void 0===e.windowOptions.automaticReframePolicy||e.windowOptions.automaticReframePolicy),this.setDefaultProgressBarVisibility(void 0===e.windowOptions.defaultProgressBarVisibility||e.windowOptions.defaultProgressBarVisibility),null===h.app_context&&(h.set_app_context("enopad3dviewer",!0),h.setSetting("lang",this._lang)),null!==e.authorizedRootTypes&&Array.isArray(e.authorizedRootTypes)&&this.setAuthorizedRootTypes(e.authorizedRootTypes),e&&void 0!==e.useWidgetLink&&null!==e.useWidgetLink&&h.setSetting("activateWidgetLink",e.useWidgetLink),!1===e.allowAuthoring?h.setSetting("enopad_webapis",!1):h.setSetting("enopad_webapis",!0),void 0!==e.activateProbes&&h.setSetting("probes_activated",e.activateProbes),h.setSetting("enopad3DViewer_enableStatusInfo",void 0===e.windowOptions.enableStatusInfo||e.windowOptions.enableStatusInfo),h.setSetting("enopad3dviewer_roles",[]),!0===e.enableFiltering&&h.setSetting("enopad3dviewer_FilterAvailable",!0),!0===e.debugVisuCommand&&h.setSetting("enopad3dviewer_debugvisucommand",!0),void 0!==e.supportWorldOrientation&&h.setSetting("supportWorldOrientation",e.supportWorldOrientation),void 0!==e.visuProgressiveTileModel&&(h.setSetting("enopad3dviewer_lightNodeModel",e.visuProgressiveTileModel),h.setSetting("enopad3dviewer_useNewProgressiveExpandAPI",e.visuProgressiveTileModel),h.setSetting("enopad3dviewer_useStaticURL",e.visuProgressiveTileModel)),h.setSetting("readOnlyDashboard",!("undefined"==typeof widget||!self.widget.readOnly)&&self.widget.readOnly),this._authorizeSet3DStructure=void 0===e.authorizeSet3DStructure||e.authorizeSet3DStructure,this._isVolumeFilter=void 0!==e.isVolumeFilter&&e.isVolumeFilter,this._propertiesCommandAvailability=void 0!==e.propertiesCommandAvailability?e.propertiesCommandAvailability:this._propertiesCommandAvailability,this.initProbe=S.createProbe("PAD3DViewer_init"),this._parent(e),void 0!==e.interwidgetComAvailability&&(this._interwidgetComAvailability=e.interwidgetComAvailability),void 0!==e.loadingDelegations&&this.setLoadingDelegations(e.loadingDelegations),void 0!==e.loadCGRAsDefaultStream&&h.setSetting("enopad3dviewer_CGRorTHB",e.loadCGRAsDefaultStream),void 0!==e.dynamicRepLoading&&(h.setSetting("enopad3dviewer_dynamicRepLoading",e.dynamicRepLoading),h.setSetting("enopad3dviewer_useStaticURL",!0)),void 0!==e.supportPgpBasedOnDescription&&h.setSetting("supportPgpBasedOnDescription",e.supportPgpBasedOnDescription),void 0!==e.selectionFilter&&h.setSetting("enopad3dviewer_selectionFilter",e.selectionFilter),void 0!==e.binaryPrimitives&&(q._BinaryPrimitives=e.binaryPrimitives),void 0!==e.useQualityManager&&(e.viewerOptions.useQualityManager=e.useQualityManager),void 0!==e.enableOcclusionTest?h.setSetting("enopad3dviewer_occlusionTest",e.enableOcclusionTest):h.setSetting("enopad3dviewer_occlusionTest",!0),void 0===e.windowOptions.openWithContextualMenuVisibility&&(e.windowOptions.openWithContextualMenuVisibility=!1),this._modelEvents=new D,!0===h.getSetting("activateWidgetLink")&&"undefined"!=typeof widget&&this.setupWidgetLink(),e.widget&&e.widget.lang&&h.setSetting("lang",e.widget.lang),e.offline?this._platformServicesInitPromise=new R(function(e){e()}):this.connectToPlatform(e),e.getPlatformServicesInBackground||e.offline||this._readyCheckPromises.push(this._platformServicesInitPromise),this._buildSkeleton(e),this._buildComponent(e),R.all(this._readyCheckPromises).then(function(){if(this._changeAction=new V({ctrl:this._controller}),this._readyCheckPromises=[],h.getSetting("enopad3dviewer_rotateFocusMode")&&this.getViewpoint()._setFocusMode(Q._FOCUS_MODE.ROTATION),this.setupLoadingBoxesEngine(),h.addEvent("onEnopad3dviewer_displayCandidateQueue",function(e){this.setupLoadingBoxesEngine()}.bind(this)),h.addEvent("onEnopad3dviewer_displayCandidateQueue_color",function(e){this.setLoadingBoxesColor(e),this.setupLoadingBoxesEngine()}.bind(this)),!this.isSelectiveLoadingActivated()&&x.isCloud()&&this.setDefaultStreamToLoad(!0),void 0!==e.windowOptions.defaultStatusBarVisibility&&"boolean"==typeof e.windowOptions.defaultStatusBarVisibility&&this.displayStatusBar(e.windowOptions.defaultStatusBarVisibility),this.publish({event:"onReady",data:this}),h.getSetting("probes_activated")&&this._trackPCS(),this.isSelectiveLoadingActivated()){var t=this.getActionBar();!0===this.getOption("enableSidePanel")&&t&&t.inject(this.elements.main)}h.getSetting("enopad3dviewer_lightNodeModel")||console.warn("DEPRECATED 3DEXPERIENCER2021x_FD05: PAD3DViewer must now be used in visuProgressiveTileModel mode aka Out Of Core. Please set the parameter, older versions are not supported anymore"),this._initSOITimelineView()}.bind(this))},isSelectiveLoadingActivated:function(){return h.getSetting("enopad3dviewer_dynamicRepLoading")||h.getSetting("enopad3dviewer_lightNodeModel")},connectToPlatform:function(e){this._platformServicesInitPromise=new R(function(t){x.app_initialization(function(){this._retrieveSessionRoles().then(this._retrieveVISnVIOStatus()).then(function(){h.addEvent("onX3dPlatformId",function(){this._retrieveVISnVIOStatus(),this.getViewer()&&this.getViewer().updatePlatformPreferences()}.bind(this),this),e&&e.securityContext&&e.securityContextList?(h.setSetting("pad_security_ctx",e.securityContext),h.setSetting("pad_security_ctx_list",e.securityContextList),t()):this._retrieveSecurityContext(e).then(function(){e.readyCB||(e.readyCB=function(){}),e.readyCB(),t()})}.bind(this))}.bind(this),e.plateformServices)}.bind(this)),this._appUUID=X.v4(),this._readyCheckPromises.push(l.initialize({defaultAttributesJSON:"DS/ENOPAD3DViewer/assets/json/AttributesMgt.json",appAttributesJSON:e.appAttributesJSON,uuid:this._appUUID}))},_retrieveSessionRoles:function(){return new R(function(e){x.getGrantedRoles(function(t){h.setSetting("enopad3dviewer_roles",t),this.publish({event:"grantedRoleRetrieved",data:h.getSetting("enopad3dviewer_roles")}),e()}.bind(this))}.bind(this))},_retrieveVISnVIOStatus:function(){return new R(function(e){x.getVISnVIOStatus(function(t){h.setSetting("enopad3dviewer_VISnVIOStatus",t.hasLicense),this.publish({event:"VISnVIOStatusRetrieved",data:h.getSetting("enopad3dviewer_VISnVIOStatus")}),e()}.bind(this))}.bind(this))},_retrieveSecurityContext:function(e){return new R(function(t){let i=e.widget?e.widget.getValue("pad_security_ctx"):void 0;x.getSecurityContext(function(e){e&&e.securityContext&&e.securityContextList&&(h.setSetting("pad_security_ctx",i&&i.length>0?i:e.securityContext),h.setSetting("pad_security_ctx_list",e.securityContextList)),t()}.bind(this))}.bind(this))},render:function(){return!0===this.getOption("enableSidePanel")?this.elements.triptych:this},getPropertiesFacet:function(){return this.getOption("propertiesFacet")?this.getOption("propertiesFacet"):[]},destroy:function(){var e=this;if(this._frmWindow){this._actionBarTokens.forEach(function(t){e._frmWindow.removeActionBarCallback&&e._frmWindow.removeActionBarCallback(t)});var t=e.getActionBar();t&&(-1!==e._actionBarCloseEvt&&t.removeCallback(e._actionBarCloseEvt),-1!==e._actionBarOpenEvt&&t.removeCallback(e._actionBarOpenEvt)),this._frmWindow.dispose(),delete this._frmWindow}this._viewer&&delete this._viewer,this._commandProxy&&(this._commandProxy.padDestroy(),this._commandProxy.destroy(),delete this._commandProxy),this._controller&&(this._controllerTokens.forEach(function(t){e._controller.unsubscribe(t)}),this._controller.destroy(),delete this._controller,delete this._controllerTokens),b&&(this._csoTokens.forEach(function(e){b.unsubscribe(e)}),delete this._csoTokens),m&&(this._psoTokens.forEach(function(e){m.unsubscribe(e)}),delete this._psoTokens),y&&(this._hsoTokens.forEach(function(e){y.unsubscribe(e)}),delete this._hsoTokens),this._hideShowController&&(this._hideShowControllerTokens.forEach(function(t){e._hideShowController.unsubscribe(t)}),this._hideShowController.destroy(),delete this._hideShowController,delete this._hideShowControllerTokens),this._BIController&&(this._BIController.destroy(),delete this._BIController),this._layout&&(this._layoutActivatedTokenBegin&&(this._layout.unsubscribe(this._layoutActivatedTokenBegin),delete this._layoutActivatedTokenBegin),this._layoutActivatedTokenEnd&&(this._layout.unsubscribe(this._layoutActivatedTokenEnd),delete this._layoutActivatedTokenEnd),this._layout.destroy(),delete this._layout),this.getStatusBar()&&this.getStatusBar().destroy(),this._dndCB&&this._dndCB.length&&(this.elements.container.removeEventListener("dragenter",this._dndCB[0]),this.elements.container.removeEventListener("dragover",this._dndCB[1]),this.elements.container.removeEventListener("dragleave",this._dndCB[2]),this.elements.container.removeEventListener("dragend",this._dndCB[3]),this.elements.container.removeEventListener("drop",this._dndCB[4]),delete this._dndCB),this.disposeLoadingBoxesEngine(),this.disposeRootListMgt(),e=null,p.reset(),h.destroy(),l.deleteMapping({uuid:this._appUUID}),this._parent()},checkIfEmpty:function(){return this.getController().checkIfEmpty()},_buildSkeleton:function(e){var i=this;if(!t.is(this.elements.container)){this.elements.container=t.createElement("div",{class:"enopad3Dviewer_container"}),this.getOption("css_view_class")&&this.elements.container.addClassName(this.getOption("css_view_class"));var o="enopad3Dviewer_3dcontainer";o+=x.isTouchDevice()?" touch-mode":"",this.elements.view_container=t.createElement("div",{class:o}).inject(this.elements.container);var n=function(){!0===h.getSetting("enopad3dviewer_debugvisucommand")&&t.createElement("span",{class:"fonticon fonticon-chart-gauge-angular enopad3dviewer_3dcontainer_debugvisuicon",id:"pad3dviewer_debugVisuCommandID"}).inject(i.elements.container).addEventListener("click",function(){(new B).execute()})};if(h.getSetting("enopad3DViewer_enableStatusInfo")){var s=new R(function(t){this._platformServicesInitPromise.then(function(){this.isSelectiveLoadingActivated()?require(["DS/PADUtils/views/PADStatusBar"],function(i){this.elements.padstatusbar=new i({renderTo:!0===this.getOption("enableSidePanel")?this.elements.main:this.elements.container,withLoader:!0,perfoDebug:!0===h.getSetting("enopad3dviewer_debugvisucommand"),onPlay:function(){this.getController().resumeProgressiveLoading(),this.getStatusBar()&&this.getStatusBar().restorePreviousLabel()}.bind(this),onPause:function(){this.getController().pauseProgressiveLoading(),(this.getController().getRoots().length>0||this._checkHiddenRoots())&&this.getStatusBar()&&this.getStatusBar().pauseProgresslabel()}.bind(this),onPerfoClicked:function(){(new B).execute()},onDragEvent:function(e){var t=this.set3DDragDropData(b.get());e.dataTransfer.setData("Text",JSON.stringify(t))}.bind(this),onSetStartupViewClicked:this._onSetStartupViewClicked.bind(this),onWidgetLinkOptionsClicked:this._openWLOptionsPanel.bind(this)}),this._setupStartupViewAutoloader(e),t()}.bind(this)):require(["DS/PADUtils/views/PADStatusInfos"],function(e){i.elements.padstatus=new e({renderTo:i.elements.container,events:{onShow:function(){var t=b.get();i.elements.padstatus.setStatus(e.buildStatus({Tenant:x.getPlatformId(),tree_content:{nbObjectsSelected:t.length}}))}},withProgress:h.getSetting("enopad3DViewer_lightLoaderForBackgroundLoad"),attention:L.progressiveExpandFullMemory}),n(),t()})}.bind(this))}.bind(this));e.getPlatformServicesInBackground||this._readyCheckPromises.push(s)}else n();c.render({renderTo:this.elements.view_container})}if(!0===this.getOption("enableSidePanel")){this.elements.main=t.createElement("div",{class:"enopad3Dviewer_mainTriptych"}),this.elements.borderedLayout=t.createElement("div",{class:"enopad3Dviewer_borderedLayout"}).inject(document.body),this.elements.right=t.createElement("div",{class:"enopad3Dviewer_rightTriptych rightSidePanel"});var r={left:{resizable:!0,originalState:"close",overMobile:!0,minWidth:300,withClose:!0},container:this.elements.main,withtransition:!0,withoverflowhidden:!0,right:{resizable:!0,originalState:"close",overMobile:!0,minWidth:250,withClose:!1}};this.elements.triptych=new k,this.elements.triptych.init(r,i.createRootListSlidder(),this.elements.container,this.elements.right),i.elements.triptych.togglePanel=function(e){"left"===e?i.elements.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"}):i.elements.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"})},i.elements.triptych._modelEvents.subscribe({event:"triptych-clicked-overlay"},function(e){j.publish({event:"ENXViews/Triptych/onOverlayClick",data:e})}),require(["DS/ApplicationFrame/CommandsManager"],function(e){e.getCommand("RootPanel")&&RootPanel.addCallback()}),i.publish({event:"on3DTriptychReady"})}},_buildComponent:function(e){var i=e.windowOptions?e.windowOptions:{};i.actionbar_corrected=e.actionbar_corrected,this._lang&&(i.language=this._lang);var o=h.getLayout_options("frmWindow_opts"),n=t.extend(o,i,!0);this.setDefaultContextualBarVisibility(n.defaultContextualBarVisibility),this.setDefaultContextualMenuVisibility(n.defaultContextualMenuVisibility),this.setOpenWithMenuAvailability(n.openWithContextualMenuVisibility),void 0!==e.selectiveLoading?h.setSetting("enopad3dviewer_selectiveLoading",e.selectiveLoading):e.widget&&e.widget.getValue("enopad3dviewer_selectiveLoading")&&h.setSetting("enopad3dviewer_selectiveLoading",e.widget.getValue("enopad3dviewer_selectiveLoading")),this._initFrameWindow(n)},_initModelController:function(e){var t=this;e=void 0!==e?e:{};var i=new R(function(i){t._controller=new o({viewer:t._viewer,context:t,selectiveLoading:e.selectiveLoading,initializeWithWrap:!0===h.getSetting("enopad3dviewer_initializeWithWrap"),appOOCManagerOptions:e.OOCManagerOptions,rolePromise:t._platformServicesInitPromise,readyCB:function(){t._controllerTokens.push(t._controller.subscribe({event:"onRootDetached"},function(e){t._viewer.render({updateInfinitePlane:!0}),t.reframe(),t.publish({event:"onRootDetached",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onContentNameModified"},function(e){t.publish({event:"onContentNameModified",data:e.TitleInfo})})),t._controllerTokens.push(t._controller.subscribe({event:"onFilterApplied"},function(e){t.isSelectiveLoadingActivated()&&t.getController().getAttributes({ids:e.filter.objects[0].path,attributes:["ds6w:label"],callbacks:{onComplete:function(i){t.getStatusBar()&&t.getStatusBar().setFilter({id:e.filter.objects[0].path[0],message:i[e.filter.objects[0].path[0]]["ds6w:label"]})},onFailure:function(e){console.warn("Failed : "+e)}}}),t.publish({event:"onFilterApplied",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onFilterWithAuthoring"},function(e){var i={msg:F.dropFilteredRootAuth,eventID:"warning"};t.displayNotification(i)})),t._controllerTokens.push(t._controller.subscribe({event:"onTaggerSelectWithAuthoring"},function(e){t.displayNotification({msg:F.taggerSelectAuth,eventID:"warning"})})),t._controllerTokens.push(t._controller.subscribe({event:"onStaticMappingApplied"},function(e){t.publish({event:"onStaticMappingApplied",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onFlexibleAssemblyApplied"},function(e){t.publish({event:"onFlexibleAssemblyApplied",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRetrieveFilterFailure"},function(e){for(var i=0;i<e.failure.length;i++){var o={msg:e.failure[i].msg,eventID:e.failure[i].eventID};t.displayNotification(o)}t.checkIfEmpty()?(t._dropZoneContainer&&t._dropZoneContainer.show("drop"),t.publish({event:"onEmptyView"})):t._dropZoneContainer&&t._dropZoneContainer.hide()})),t._controllerTokens.push(t._controller.subscribe({event:"onSearchCompleted"},function(e){e.searchQuery?t._findInContext(e):e.findPaths?t._findPaths(e):e.taggerSelect&&t._taggerSelect(e)})),t._controllerTokens.push(t._controller.subscribe({event:"onSearchFailure"},function(e){t.displayNotification({eventID:"error",msg:L.searchInContextFailed}),t.publish({event:"onSearchFailure",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onSearchTooManyPath"},function(e){e.taggerSelect?t.displayNotification({eventID:"warning",msg:F.tooManyResultSelectInApp.replace("{maxResult}",h.getSetting("enopad3dviewer_max_count_in_search"))}):t.displayNotification({eventID:"warning",msg:L.tooManyResultFoundV2.replace("{maxResult}",h.getSetting("enopad3dviewer_max_count_in_search"))})})),t._controllerTokens.push(t._controller.subscribe({event:"onRootAttached"},function(e){t._dropZoneContainer&&t._dropZoneContainer.hide(),t._viewer.render({updateInfinitePlane:!0}),t.reframe(),t.publish({event:"onRootAttached",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginRootRemoved"},function(e){!1===e.dispatch&&t.lockSelectionBroadcast(!0)})),t._controllerTokens.push(t._controller.subscribe({event:"onRootRemoved"},function(e){if(t.getController().getNbRoots()||t.getController().getHiddenRootIds().length||!t._dropZoneContainer||(t._dropZoneContainer.show("drop"),t.getStatusBar()&&(t.getStatusBar().setIsPaused(!1),t.getStatusBar().resetPreviousLabel(),t.getStatusBar().setLoader({status:"off"}))),t._viewer.render({updateInfinitePlane:!0}),e.reframe)if(!0===h.getSetting("enopad3dviewer_lightNodeModel")){if(t.getController()._model.getOOCManager().getReframeBoundingSphere){var i=t.getController()._model._OOCManager.getReframeBoundingSphere();0!==i.radius?t.reframe(i):t.reframe()}}else t.reframe();t.publish({event:"onRootRemoved",data:e}),!1===e.dispatch&&t.lockSelectionBroadcast(!1)})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginReplaceInstance"},function(){t.publish({event:"onBeginReplaceInstance"})})),t._controllerTokens.push(t._controller.subscribe({event:"onEndReplaceInstance"},function(e){t.publish({event:"onEndReplaceInstance",data:e}),t.publish({event:"onModelUpdated",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onEndMatriceUpdate"},function(e){t._viewer.render({updateInfinitePlane:!0}),t.publish({event:"onEndMatriceUpdate",data:e}),t.publish({event:"onModelUpdated",data:{rootNodes:t.getRoots()}})})),t._controllerTokens.push(t._controller.subscribe({event:"onUnsupportedType"},function(e){(t.displayNotification({msg:F.replace(F.get("unsupported_type"),{type:e.displayType,name:e.displayName}),eventID:"warning"}),0!==t.getRoots().length||t._checkHiddenRoots())||j.getModelEvents().publish({event:"ENXViews/WelcomePanel/activate"})})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginRootLoading"},function(e){t._lastReframeRequiered=0,t._dropZoneContainer&&t._dropZoneContainer.hide(),t.publish({event:"onBeginRootLoading"})})),t._controllerTokens.push(t._controller.subscribe({event:"onProgress"},function(e){t.getDefaultProgressBarVisibility()?(c.setText(e.message),e.progress%20==0&&e.progress!==t._lastReframeRequiered&&(t._lastReframeRequiered=e.progress,e.reframe?t.reframe():t._viewer.render({updateInfinitePlane:!0}))):t.publish({event:"onProgress",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRootAdded"},function(e){t._viewer.render({updateInfinitePlane:!0}),h.getSetting("supportWorldOrientation")&&t.getRoots().length+t.getController().getHiddenRootIds().length===1&&(1===e.orientation?(t._viewer.setWorldOrientation(v.YUpXRight),t.reframe(e.BS)):t._viewer.setWorldOrientation(v.ZUpYRight)),t._dropZoneContainer&&t._dropZoneContainer.hide(),e.reframe&&t.reframe(e.BS),e.displayNotif&&(e.hidden?t.displayNotification({eventID:"info",msg:L.addonDetachedRootSuccessNotif}):t.displayNotification({eventID:"success",msg:e.inContext?L.addRootInContextSuccessNotif:L.addRootSuccessNotif})),!0===t._controller._wait4Filter&&(t._filterRootIds=[e.id],t._filterPanelOpen=!0),t.publish({event:"onRootAdded",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRootUpdateStart"},function(e){t.publish({event:"onRootUpdateStart",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRootUpdateEnd"},function(e){t.publish({event:"onRootUpdateEnd",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginFilterApplied"},function(e){t.publish({event:"onBeginFilterApplied",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onReframe"},function(e){window.ENOPADNoReframe||t.getViewer().get360Mode()||(e.BS&&t.getViewpoint().reframe(void 0,0,e.BS),e.rootBS||setTimeout(function(){t.reframe()},3e3))})),t._controllerTokens.push(t._controller.subscribe({event:"onR2VLoaded"},function(e){t.publish({event:"onR2VLoaded",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"rootStatsRetrieved"},function(e){!e||0!==e.size.flat&&0!==e.size.occ&&0!==e.size.leaf||t.displayNotification({eventID:"info",msg:L.statsRetrieved_emptyStructure}),t.publish({event:"rootStatsRetrieved",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRootAlreadyExisting"},function(e){K.isWidgetSynchronizing()||t.displayNotification({eventID:"info",msg:L.rootAlreadyLoadedNotif}),t._dropZoneContainer&&t._dropZoneContainer.hide(),t.publish({event:"onRootAlreadyExisting",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRootAdditionTransactionComplete"},function(e){t.publish({event:"onRootAdditionTransactionComplete",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onComplete"},function(e){t.isSelectiveLoadingActivated()||t._viewer.render({updateInfinitePlane:!0}),e.reframe&&t.reframe(e.BS),"addRoot"===e.intend&&t.publish({event:"onComplete",data:{intend:"addRoot"}}),t.publish({event:"onLoadingComplete"}),!0===t.updatePager&&(t.updatePager=!1,t.publish({event:"onUpdatePager",data:t.pagerData}))})),t._controllerTokens.push(t._controller.subscribe({event:"onLoadingFailure"},function(e){if(t._controller.getNbRoots()||t._checkHiddenRoots()||!t._dropZoneContainer||t._controller.isRunning()||t._dropZoneContainer.show("drop"),e.displayNotif){var i=L.addRootFailureNotif,o="error";e&&e.message&&(i=e.message),e&&e.eventID&&(o=e.eventID),t.displayNotification({eventID:o,msg:i})}t.publish({event:"onLoadingFailure",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onLoadingCanceled"},function(e){t._controller.getNbRoots()||t._checkHiddenRoots()||!t._dropZoneContainer||t._dropZoneContainer.show("drop");var i=L.addRootFailureNotif;e&&e.message&&(i=e.message),t.displayNotification({eventID:"info",msg:i}),t.publish({event:"onLoadingCanceled"})})),t._controllerTokens.push(t._controller.subscribe({event:"startAsync"},function(e){var i=t.getActionBar();void 0===e||void 0===e.userFeedback||e.userFeedback?(i&&i._afr.elements.container.addClassName("enopad3Dviewer_actionbar_disabled"),t.getDefaultProgressBarVisibility()?(c.on(void 0,e.onCancel,F.PADProgressBar_cancelAll),t.isSelectiveLoadingActivated()&&t.getStatusBar()&&t.getStatusBar().setLoader({status:"hide"})):t.publish({event:"onStartAsync"})):t.publish({event:"onStartAsync"})})),t._controllerTokens.push(t._controller.subscribe({event:"stopAsync"},function(e){var i=t.getActionBar();void 0===e||void 0===e.userFeedback||e.userFeedback?(i&&i._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled"),t.getDefaultProgressBarVisibility()?(c.off(),t.isSelectiveLoadingActivated()&&t.getStatusBar()&&t.getStatusBar().setLoader({status:"show"})):t.publish({event:"onStopAsync"})):t.publish({event:"onStopAsync"})})),t._controllerTokens.push(t._controller.subscribe({event:"onMove"},function(e){t.publish({event:"onMove",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onEndReparent"},function(e){if(e.createdNode){for(var i=t.getController().getRootBag(),o=f.buildPathesLeadingToNode(e.createdNode,i),n=[],s=0;s<o.length;s++)n.push({pathElement:o[s]});t.lockSelectionBroadcast(!0),b.add(n),y.add(n),t.lockSelectionBroadcast(!1)}t._viewer.render({updateInfinitePlane:!0}),t.reframe(),t.displayNotification({eventID:"success",msg:L.reparentSuccessful}),t.publish({event:"onEndReparent",data:e}),t.publish({event:"onModelUpdated",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onInstanceUpdated"},function(e){t.publish({event:"onInstanceUpdated",data:e}),t.publish({event:"onModelUpdated",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onAuthoringIgnored"},function(e){t.displayNotification({eventID:"info",msg:L[e.reason]})})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginReparent"},function(e){t.publish({event:"onBeginReparent",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onReparentFailure"},function(e){var i=L.reparentFailure;e&&e.message&&(i=e.message),t.displayNotification({eventID:"error",msg:i,key:"pad3dViewer-onReparent-failure"}),t.publish({event:"onReparentFailure"})})),t._controllerTokens.push(t._controller.subscribe({event:"onInsertExistingFailure"},function(e){var i=L.insertFailure;e&&e.message&&(i=e.message),t.displayNotification({eventID:"error",msg:i,key:"pad3dViewer-onInsertExisting-failure"}),t.publish({event:"onInsertExistingFailure"})})),t._controllerTokens.push(t._controller.subscribe({event:"onInsertExisting"},function(e){if(e.createdNode&&e.insertedNode){for(var i=t.getController().getRootBag(),o=f.buildPathesLeadingToNode(e.createdNode,i),n=[],s=0;s<o.length;s++)o[s].addElement(e.insertedNode),n.push({pathElement:o[s]});b.add(n),y.add(n)}t._viewer.render({updateInfinitePlane:!0}),t.reframe(),t.displayNotification({eventID:"success",msg:L.insertSuccessful}),t.publish({event:"onInsertExisting",data:e}),t.publish({event:"onModelUpdated",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onStreamSwitched"},function(e){t.publish({event:"onStreamSwitched"}),t.publish({event:"onModelUpdated",data:{rootNodes:t.getRoots()}})})),t._controllerTokens.push(t._controller.subscribe({event:"onStreamSwitchFailure"},function(e){t.publish({event:"onStreamSwitchFailure"})})),t._controllerTokens.push(t._controller.subscribe({event:"onGeometryRefreshed"},function(e){t.publish({event:"onGeometryRefreshed"}),t.publish({event:"onModelUpdated",data:{rootNodes:t.getRoots()}})})),t._controllerTokens.push(t._controller.subscribe({event:"onRefreshGeometryFailure"},function(e){t.publish({event:"onRefreshGeometryFailure"})})),t._controllerTokens.push(t._controller.subscribe({event:"onEndDelete"},function(e){t._viewer.render({updateInfinitePlane:!0}),t.reframe(),t.displayNotification({eventID:"success",msg:L.deleteSuccessful}),t.publish({event:"onEndDelete",data:e}),t.publish({event:"onModelUpdated",data:e}),t.lockSelectionBroadcast(!1)})),t._controllerTokens.push(t._controller.subscribe({event:"onCompletionCompleted"},function(e){t._viewer.render({updateInfinitePlane:!0}),t.displayNotification({eventID:"info",msg:e.nbPathLoaded+L.completionCompleted}),t.publish({event:"onCompletionCompleted"}),t.publish({event:"onModelUpdated",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginDelete"},function(e){t.lockSelectionBroadcast(!0),t.publish({event:"onBeginDelete",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onDefaultStreamChanged"},function(e){if(e.newStream){var i="cgr"===e.newStream;t.changeVisuModeCmdAvailability(i)}t.publish({event:"onDefaultStreamChanged",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onIndexAvalabilityChange"},function(e){t.publish({event:"onIndexAvalabilityChange",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onEndRootRemoved"},function(e){if(t.publish({event:"onEndRootRemoved",data:e}),t.getStatusBar()){const e=t.getController().getRoots();let i=!1;for(let o=0;o<e.length;++o)if(t.getController().getBIProxy().HasFilter(e[o].getModelIdentification())){i=!0;break}!1===i&&t.getStatusBar().clearFilter()}})),t._controllerTokens.push(t._controller.subscribe({event:"onRefreshCompleted"},function(e){t._controller.getNbRoots()||t._checkHiddenRoots()||!t._dropZoneContainer||t._dropZoneContainer.show("drop"),t.displayNotification({eventID:"info",msg:L.refreshCompleted}),t.publish({event:"onRefreshCompleted",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRefreshBegin"},function(e){t.publish({event:"onRefreshBegin",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onAuthoringSwitch"},function(e){if(e.message&&""!==e.message&&t.displayNotification({eventID:"info",msg:e.message}),t.getController().refreshAppliedFilters(),!0===e.state){for(var i=t.getController().getRoots(),o=!1,n=0;n<i.length;++n){var s=N.getNodeID(i[n]);t.getController().isLargeDataStructure(s)&&(o=!0,t.getController().freezeRoot(s))}o&&t.displayNotification({eventID:"warning",msg:L.sessionFrozenFollowingAuthoringOperation})}t.publish({event:"onAuthoringSwitch",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onColorizeInAuthoring"},function(){t.displayNotification({msg:L.colorizeInAuthoring,eventID:"warning"})})),t._controllerTokens.push(t._controller.subscribe({event:"onAuthoringTransactionBegin"},function(){b.empty(),y.empty(),t.publish({event:"onAuthoringTransactionBegin"})})),t._controllerTokens.push(t._controller.subscribe({event:"onAuthoringTransactionEnd"},function(){t.publish({event:"onAuthoringTransactionEnd"})})),t._controllerTokens.push(t._controller.subscribe({event:"onExpandCompleted"},function(e){e.displayNotif&&t.displayNotification({eventID:"info",msg:L.expandCompleted}),t.publish({event:"onExpandCompleted"}),t.publish({event:"onModelUpdated",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onDisableUX"},function(e){t.elements.container.blockUX||(t.elements.container.blockUX=new Z({className:"disableMainUX",closable:!1,body:"",visible:!0}),t.elements.container.blockUX.inject(document.body))})),t._controllerTokens.push(t._controller.subscribe({event:"onEnableUX"},function(e){var i=t.getActionBar();t.elements.container.blockUX&&(t.elements.container.blockUX.destroy(),delete t.elements.container.blockUX),t.elements.container.blockActionBar&&(t.elements.container.blockActionBar.destroy(),delete t.elements.container.blockActionBar),document.querySelector(".enopad3Dviewer_actionbar_disabled")&&i&&i._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")})),t._controllerTokens.push(t._controller.subscribe({event:"onDisableActionBar"},function(e){var i=t.getActionBar();i&&i._afr.elements.container.addClassName("enopad3Dviewer_actionbar_disabled")})),t._controllerTokens.push(t._controller.subscribe({event:"PGPPostProcess"},function(e){if(e.hiddenPaths&&e.hiddenPaths.length){var i=[];e.hiddenPaths.forEach(function(e){var o=t.unstreamPath(e);i.push(o)}),t.getHideShowController().hide({paths:i,dispatch:!1})}(e.references&&e.references.length||e.instances&&e.instances.length||e.occurrences&&e.occurrences.length)&&t.getHideShowController().applyPGP(e)})),t._controllerTokens.push(t._controller.subscribe({event:"onParsingInterruptedMemoryFull"},function(e){t.displayNotification({eventID:"warning",title:L.parsingInterruptedMemoryFull.title,subtitle:L.parsingInterruptedMemoryFull.subtitle,msg:L.parsingInterruptedMemoryFull.message}),t.publish({event:"onParsingInterruptedMemoryFull",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onRepresentationLoaded"},function(e){t.publish({event:"onRepresentationLoaded",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onCycleDetected"},function(e){t.displayNotification({eventID:"error",title:L.cycleDetected.title,subtitle:L.cycleDetected.subtitle,msg:L.cycleDetected.message})})),t._controllerTokens.push(t._controller.subscribe({event:"onStartProgressiveLoad"},function(e){t.isSelectiveLoadingActivated()&&t.getStatusBar()&&(t.getStatusBar().setLoader({status:"on"}),t.getStatusBar().setProgressLabel(L.PADStatus_loadingData),t.getStatusBar().clearWarning()),t.publish({event:"onStartProgressiveLoad",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onEndProgressiveLoad"},function(e){t.isSelectiveLoadingActivated()&&t.getStatusBar()&&(t.getStatusBar().setLoader({status:"off"}),0!==t.getRoots().length||t._checkHiddenRoots()?!0===e.memoryFull?t.getStatusBar().setCustomProgressLabel({label:L.PADStatus_loadingStopped,tooltip:L.progressiveExpandFullMemory,severity:"warning"}):t.getStatusBar().setCustomProgressLabel({label:L.PADStatus_loadingComplete,tooltip:L.PADStatus_loadingComplete,severity:"success"}):(t.getStatusBar().setIsPaused(!1),t.getStatusBar().resetProgressLabel())),t.publish({event:"onEndProgressiveLoad",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onBeginFilterRemoved"},function(e){t.publish({event:"onBeginFilterRemoved",data:e})}));var e=!1;t._controllerTokens.push(t._controller.subscribe({event:"onFilterRemoved"},function(i){this._filteredIdToReload.push(i.id),this.getStatusBar()&&this.getStatusBar().clearFilter({id:i.id}),h.getSetting("enopad3dviewer_lightNodeModel")||!1===e&&(e=!0,require(["DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel"],function(i){new i({container:t.elements.container,events:{onValidate:function(t){e=!1,t&&this.getController().removeFilterFullReload(this._filteredIdToReload),this._filteredIdToReload=[]}.bind(this)}})}.bind(this))),this.publish({event:"onFilterRemoved",data:i})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"onBIColorize"},function(e){this.publish({event:"onBIColorize",data:e})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"onBIUnColorize"},function(e){this.publish({event:"onBIUnColorize",data:e})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"on3DLeafColorize"},function(e){this.publish({event:"on3DLeafColorize",data:e})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"on3DLeafUnColorize"},function(e){this.publish({event:"on3DLeafUnColorize",data:e})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"onTreeColorize"},function(e){this.publish({event:"onTreeColorize",data:e})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"onTreeUnColorize"},function(e){this.publish({event:"onTreeUnColorize",data:e})}.bind(t))),t._controllerTokens.push(t._controller.subscribe({event:"onUrlLoaded"},function(e){t.publish({event:"onUrlLoaded",data:{nbCgrLoaded:e.nbCgrLoaded,nbThbLoaded:e.nbThbLoaded}})})),t._controllerTokens.push(t._controller.subscribe({event:"onVQDisabled"},function(e){t.displayNotification({eventID:"warning",title:L.queryFailed_VQDisabled.title,subtitle:L.queryFailed_VQDisabled.subtitle,msg:L.queryFailed_VQDisabled.message})})),t._controllerTokens.push(t._controller.subscribe({event:"onLeafReferenceLoaded"},function(e){t.publish({event:"onLeafReferenceLoaded",data:e})})),t._controllerTokens.push(t._controller.subscribe({event:"onLeafReferenceUnloaded"},function(e){t.publish({event:"onLeafReferenceUnloaded",data:e})})),t.subscribe({event:"onFilterDropped"},function(){t.clearWidgetBorder()}),t._controllerTokens.push(t._controller.subscribe({event:"onSOIDropped"},function(e){t.publish({event:"onSOIDropped",data:e})})),i()}})});return this._readyCheckPromises.push(i),i},getCommandContext:function(){return this._context},changeVisuModeCmdAvailability:function(e){},_initHideShowController:function(){var e=this;require(["DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController"],function(t){e._hideShowController=new t({context:e,viewer:e._viewer}),e._hideShowControllerTokens.push(e._hideShowController.subscribe({event:"onHide"},function(t){e.publish({event:"onHide",data:t})})),e._hideShowControllerTokens.push(e._hideShowController.subscribe({event:"onShow"},function(t){e.publish({event:"onShow",data:t})})),e._hideShowControllerTokens.push(e._hideShowController.subscribe({event:"onExclusiveShow"},function(t){e.publish({event:"onExclusiveShow",data:t})}))})},_initFrameWindow:function(e){var t=this;p.set(this),e.context=void 0===e.context?null:e.context,e.viewerOptions.showReferenceAxisSystem=void 0===e.viewerOptions.showReferenceAxisSystem||e.viewerOptions.showReferenceAxisSystem;var i=null;e.workbench&&e.workbenchModule&&(i={workbench:e.workbench,workbenchModule:e.workbenchModule,ignoreResetCommandManager:e.ignoreResetCommandManager},delete e.workbench,delete e.workbenchModule),this._context=e.context,this._readyCheckPromises.push(new R(function(o){e.uiOptions.displayTree=!1,t.fWInitProbe=S.createProbe("FrameWindow3D_init"),t.viewerInitProbe=S.createProbe("3DViewer_init"),h.getSetting("probes_activated")&&window.top.performance.mark(t._pcsPrefix+"frameWindowInitBegin"),t._frmWindow=new g(e).inject(t.elements.view_container),t._frmWindow.onReady(function(){if(t._viewer=t._frmWindow.getViewer(),t._robotVisibility=e.robotVisibility,e.viewerOptions.showReferenceAxisSystem&&t._viewer.setRobot(t._robotVisibility,{snapOnFace:!0}),t._viewer.setPicking(e.viewerOptions.highlight),t._viewer.setPrePicking(e.viewerOptions.pHighlight),t._viewer.displayPoints(!0),q.getWebVisualizationLevel()<424&&t.getViewpoint().setDefaultController(!0,e.mouseProfile),void 0!==e.viewpointProjectionType){var n="PERSPECTIVE"===e.viewpointProjectionType?0:1;t.getViewpoint().setProjectionType(n)}t.viewerInitProbe.end(),delete t.viewerInitProbe,t.defAbDisplayProbe=S.createProbe("defaultActionBarDisplay"),t.defAbReadyProbe=S.createProbe("defaultActionBarReady"),t._frmWindow.getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange(),e.contextualMenuContent&&e.contextualMenuContent.workbenchName&&e.contextualMenuContent.module&&e.contextualMenuContent.fileName&&(t._frmWindow.getContextualUIManager().register({workbenchName:e.contextualMenuContent.workbenchName,module:e.contextualMenuContent.module,cmdPrefix:"",context:t.getCommandContext(),onContextualMenuReady:function(i,o){var n=t.getViewer();if(t._defaultContextualMenuVisibility&&void 0!==o&&void 0!==o.XmousePositionWithDevPxRatio&&void 0!==o.YmousePositionWithDevPxRatio&&n){var s=[];if(0===n.pick({xPix:o.XmousePositionWithDevPxRatio,yPix:o.YmousePositionWithDevPxRatio},"mesh",!0).path.length){var r=e.contextualMenuContent.emptiness.display,a=e.contextualMenuContent.emptiness.ambiences;r&&r.length&&(M.isMobileDevice()&&r.indexOf("VisuQMCommand")>-1&&r.splice(r.indexOf("VisuQMCommand"),1),r.length&&s.push({name:"PAD3DViewerDisplaySection",line:1,resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:r})),a&&a.length&&s.push({name:"PAD3DViewerAmbiencesSection",line:1,resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:a})}else{var l=b.get();if(l.length>0&&t._areValidPaths(l)){var d=e.contextualMenuContent.geometry.firstLevel,h=e.contextualMenuContent.geometry.toggleVisu;if(d)for(var c=0;c<d.length;c++){var p=d[c];("ActionBar_Attributes"!==p||"ActionBar_Attributes"===p&&t._propertiesCommandAvailability)&&s.push({name:p,line:1,hdr_list:[p]})}else console.error("DEPRECATED : impossible to generate contextual menu. Format for contextual menu must be changed");h&&s.push({name:"PAD3DViewerToggleGeometrySection",line:1,resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:h})}}return s.length?{cmdList:s}:void 0}},onContextualBarReady:function(e,i){var o=t.getViewer();if(t._defaultContextualBarVisibility&&void 0!==i&&void 0!==i.XmousePositionWithDevPxRatio&&void 0!==i.YmousePositionWithDevPxRatio&&o&&!(0===o.pick({xPix:i.XmousePositionWithDevPxRatio,yPix:i.YmousePositionWithDevPxRatio},"mesh",!0).path.length)){var n=[],s=b.get();return s.length>0&&t._areValidPaths(s)&&1===s.length&&(2===s[0].pathElement.externalPath.length?n.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]}):n.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]})),n.length?{cmdList:n}:void 0}}}),t._frmWindow.getContextualUIManager().register({workbenchName:"ENOPAD3DViewerOpenWith",module:"ENOPAD3DViewer",fileName:"ENOPAD3DViewerOpenWith.xml",cmdPrefix:"",context:t.getCommandContext(),merge:!0,onContextualMenuReady:function(e,i){var o=t.getViewer();if(t.isOpenWithMenuAvailable()&&void 0!==i&&void 0!==i.XmousePositionWithDevPxRatio&&void 0!==i.YmousePositionWithDevPxRatio&&o){var n=[];if(!(0===o.pick({xPix:i.XmousePositionWithDevPxRatio,yPix:i.YmousePositionWithDevPxRatio},"mesh",!0).path.length)){var s=b.get();s.length>0&&t._areValidPaths(s)&&n.push({name:"PAD3DViewerOpenWithSection",line:1,resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DViewerOpenIn3DMkp","PAD3DViewerOpenInCV5","PAD3DViewerOpenInPF"]})}return n.length?{cmdList:n}:void 0}}})),!i&&h.getSetting("probes_activated")&&(window.top.performance.mark(t._pcsPrefix+"frameWindowInitDone"),window.top.performance.measure(t._pcsPrefix+"frameWindowInit",t._pcsPrefix+"frameWindowInitBegin",t._pcsPrefix+"frameWindowInitDone")),t._initModelController(e).then(function(){i&&(t.loadActionBar(i),t._actionBarTokens.push(t._frmWindow.onActionBarReady(function(){t._firstInit?(t._firstInit=!1,t._controller._setDefaultStreamToLoad(h.getSetting("enopad3dviewer_CGRorTHB")),t.defAbReadyProbe.end(),delete t.defAbReadyProbe,t.fWInitProbe.end(),delete t.fWInitProbe,t.initProbe.end(),delete t.initProbe):t.abReadyProbe&&(t.abReadyProbe.end(),delete t.abReadyProbe),t.publish({event:"onActionBarReady",data:t}),h.getSetting("probes_activated")&&(window.top.performance.mark(t._pcsPrefix+"frameWindowInitDone"),window.top.performance.measure(t._pcsPrefix+"frameWindowInit",t._pcsPrefix+"frameWindowInitBegin",t._pcsPrefix+"frameWindowInitDone")),t._readyCheckPromises&&i&&o()}))),t._initHideShowController(),e.allowDnD&&t._initDnD(),t._initInterwidgetCom(),t._initCSOEvent(e),t.initFindInContextColorizedSubscription(),void 0!==e.BIMode&&(t.getController().toggleBetweenStandaloneAndSlaveMode(e.BIMode),"STANDALONE"===e.BIMode&&(t._isVolumeFilter=!1)),setTimeout(function(){t.publish({event:"onViewerReady",data:t}),i||o()})})})}))},_checkHiddenRoots:function(){return 0!==(this._controller.getHiddenRootIds()?this._controller.getHiddenRootIds().length:0)},_initDnD:function(){var e=this;h.getSetting("activate_newDropInvite")||require(["DS/PADUtils/views/PADDnDInvite"],function(t){function i(t){t.preventDefault(),e.addWidgetBorder(),t.shiftKey?e._dropZoneContainer.show("add_as_object"):e._dropZoneContainer.show("add_in_context")}function o(t){e.clearWidgetBorder(),0!==e.getRoots().length||e._checkHiddenRoots()?e._dropZoneContainer.hide():e._dropZoneContainer.show("drop")}function n(t){if(t.preventDefault(),t.stopPropagation(),e.elements.container.contains(t.target)){e._dropZoneContainer.hide();var i=!0;t.shiftKey&&(i=!1),e.addRootNodesFromContent({dndEvent:t,dispatch:!0,inContext:i}),e.clearWidgetBorder()}}function s(t){t.preventDefault(),e.clearWidgetBorder(),t.shiftKey?e._dropZoneContainer.show("add_as_object"):e._dropZoneContainer.show("add_in_context")}function r(t){null!=t.relatedTarget&&t.relatedTarget.classList.contains("paddnd_invite_container")||(e._dropZoneContainer.hide(),0===e.getRoots().length&&e._dropZoneContainer.show(),e.clearWidgetBorder())}e._dropZoneContainer=new t({renderTo:e.elements.container,mode:"inviteWithFilter",filterActive:h.getSetting("enopad3dviewer_FilterAvailable"),dropOnInvite:function(e){n(e)}}),e._dndCB[0]=i,e._dndCB[1]=o,e._dndCB[2]=n,e._dndCB[3]=s,e._dndCB[4]=r,e.elements.container.addEventListener("dragenter",s),e.elements.container.addEventListener("dragover",i),e.elements.container.addEventListener("dragleave",r),e.elements.container.addEventListener("dragend",o),e.elements.container.addEventListener("drop",n)})},addRootNodesFromContent:function(e){var t=this;e.dispatch=void 0===e.dispatch||e.dispatch,e.inContext=void 0===e.inContext||e.inContext;var i=null;e.json3DXContent&&(i="string"==typeof e.json3DXContent?JSON.parse(e.json3DXContent):e.json3DXContent);var o=e.dndEvent?{dataTransfer:e.dndEvent.dataTransfer}:void 0,n=null;e.dndEvent&&(n=x.deserializeDroppedData(e.dndEvent)),w.retrieveAuthorizedObjects({displayNotif:!1,behavior:e.inContext?"WITH_CONTEXT":"WITHOUT_CONTEXT",X3DContentId:i||void 0,dnd_event:o||void 0,callback:function(i){if(i.unauthorized_objects.length&&i.unauthorized_objects.forEach(function(e){t._loadingDelegations&&t._loadingDelegations["_"+e.objectType]?((0,t._loadingDelegations["_"+e.objectType])(e),!0):(t.displayNotification({msg:F.replace(F.get("unsupported_type"),{type:e.displayType,name:e.displayName}),eventID:"warning"}),0!==t.getRoots().length||t._checkHiddenRoots()||j.getModelEvents().publish({event:"ENXViews/WelcomePanel/activate"}))}),0===i.authorized_objects.length)0===t.getRoots().length&&!t._checkHiddenRoots()&&t._dropZoneContainer&&t._dropZoneContainer.show("drop");else{var o=t.getRoots(),s=i.authorized_objects;x.multiTenantMgt(s,o,function(o){if(o.isMultiTenant)i.isMultiTenant&&i.invalidTenant&&0===t.getRoots().length&&!t._checkHiddenRoots()&&t._dropZoneContainer&&t._dropZoneContainer.show("drop");else if(i.authorizedWithKind){if(i.authorizedWithKind.Product&&i.authorizedWithKind.Product.length>0){var s=[];i.authorizedWithKind.Product.forEach(function(t){var i=t.path&&e.inContext?t.path.map(function(e){return e.resourceid}):[t.objectId];s.push({path:i,serviceId:t.serviceId})});var r={};if(e.dndEvent&&e.dndEvent.dataTransfer?r=n:e.json3DXContent&&e.json3DXContent.biProxyCtx&&(r=e.json3DXContent),r.fromFilter=e.fromFilter||!1,r.biProxyCtx)return void t.getController().dropShareFilterSpec(r,e.dispatch,t.getAutomaticReframePolicy());t.addRoots({objects:s},e.dispatch)}if(i.authorizedWithKind.Filter&&i.authorizedWithKind.Filter.length>0){var a=h.getSetting("authoringFilterEnabled"),l=h.getSetting("authoringFilterEnabledForMultiRoot"),d=a&&(l||0===t._controller._rootIds.length);!G.determineAuthoredFlag()||G.determineAuthoredFlag()&&d?!0===t.getController().isStandaloneFilterAvailable()?(t._commandProxy&&!0===e.dispatch&&t._commandProxy.dropFilter3D({droppedFilters:i.authorizedWithKind.Filter,broadcast:!1}),t.getController().retrieveFilters(i)):!0===t.getController().isSlaveFilterAvailable()?t._commandProxy.dropFilter3D({droppedFilters:i.authorizedWithKind.Filter}):0===t.getRoots().length&&!t._checkHiddenRoots()&&t._dropZoneContainer&&t._dropZoneContainer.show("drop"):(t.displayNotification({eventID:"warning",msg:F.filterInAuthoring}),0===t.getRoots().length&&!t._checkHiddenRoots()&&t._dropZoneContainer&&t._dropZoneContainer.show("drop"))}if(i.authorizedWithKind.Change&&i.authorizedWithKind.Change.length>0&&t.loadChange({objects:i.authorizedWithKind.Change}),i.authorizedWithKind.R2V&&i.authorizedWithKind.R2V.length>0){s=[];i.authorizedWithKind.R2V.forEach(function(e){s.push(e)}),t.addR2Vs({objects:s,reframe:!0,displayNotif:!0,dispatch:!0})}}else{s=[];i.authorized_objects.forEach(function(t){var i=t.path&&e.inContext?t.path.map(function(e){return e.resourceid}):[t.objectId];s.push({path:i})}),t.addRoots({objects:s},e.dispatch)}t=null})}},version:"2.0"})},_areValidPaths:function(e){var t=!0;if(e)for(var i=0;i<e.length;i++)if(!N.isAModelPath(e[i].pathElement)){t=!1;break}return t},_initCSOEvent:function(e){if(this.isInterwidgetComAvailable()){var t=function(){if(!this._lockCSONotification&&!this._lockCSONotificationEmpty){var e=[],t=[],i=[],o=[],n={},s=[],r=b.get(),a=null,l={version:"1.1",paths:e,POIs:t,POIGroups:i,ZOIs:o,attributes:n,sharedID:x.getSharedId(),focusOn:this._reframeFocus};r.forEach(function(s){N.isAModelPath(s.pathElement)&&this.streamPathWithType(s.pathElement,e,n),N.isAPOIPath(s.pathElement)&&(a=N.getPOILayerId(s.pathElement),this.streamPOI(s.pathElement,a,t)),N.isAPOIGroupPath(s.pathElement)&&this.streamPOIGroup(s.pathElement,i),N.isAZOIPath(s.pathElement)&&this.streamZOI(s.pathElement,o)}.bind(this));let D=!1,I=!1,S=!1;var c=0;b.get()&&(c=b.get().length);var p=0;t&&t.length&&(p=t.length,D=!0);var u=0;i&&i.length&&(i.forEach(function(e){e&&(u+=e.POIs.length)}.bind(this)),S=!0);var g=0;if(o&&o.length&&(g=o.length,I=!0),p>0||g>0||u>0){var _=d.getPADTracker({eventCategory:"usage",eventAction:"3d_selectEvent_stats"});_.setEventData({eventLabel:"outgoing_selection",eventValue:p+u+g}),_.persDim.pd2="Outgoing Selection",_.persDim.pd3=D&&I||S&&I?"POI and ZOI":D?"POI":I?"ZOI":S?"POI Group":"error",_.persVal.pv2=p+u,_.persVal.pv3=g,_.persVal.pv4=c,_.trackPageEvent()}if(h.getSetting("authorizeChangeControl")){var f=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");l.changeControl=f.get()}var v=!!this._searchRecent&&this._searchRecent;if(!0===v&&(l.searchDone=v),this._commandProxy.select(l),!0===this._authorizeSet3DStructure)if(e&&e.forEach(function(e){s.push(e[e.length-1])}),this.set3DXContentData({nodes2Open:s,selectedPaths:l}),!0!==h.getSetting("settypes")){var m=this.set3DStructure4OpenInCV5({nodes2Open:s,selectedPaths:l}),y=JSON.stringify(m);P.publish("setStructure",{structure:y})}else this.setTypesFor3D(l)}}.bind(this);function i(e){if(e&&e.pathElement&&e.pathElement.externalPath.length&&N.isAModelPath(e.pathElement)){for(var t=e.pathElement,i=t.getLastElement(!0);t&&!N.isReference(i)&&t.externalPath.length>2;)(t=t.getParentPath())&&(i=t.getLastElement(!0));return e.pathElement=t,e}return e}function o(e){if(!this._lockCSONotification&&"PRODUCT"===h.getSetting("enopad3dviewer_selectionFilter"))if(e instanceof Array){var t=0,o=e.length;for(t=0;t<o;t++)e[t].event&&i.call(this,e[t])}else e.event&&i.call(this,e)}b.onPostAdd&&this._csoTokens.push(b.onPostAdd(t)),this.isSelectiveLoadingActivated()&&b.onChange&&this._csoTokens.push(b.onChange(I.debounce(function(){if(this.getStatusBar()){for(var e=b.get(),t=0,i=0;i<e.length;++i)null!==e[i].pathElement&&++t;t?this.getStatusBar().setSelection({length:t}):this.getStatusBar().clearSelection()}}.bind(this)))),b.onPostRemove?this._csoTokens.push(b.onPostRemove(t)):this._csoTokens.push(b.onRemove(I.debounce(t,100))),this._csoTokens.push(b.onPreEmpty(function(){this._lockCSONotificationEmpty=!0}.bind(this))),this._csoTokens.push(b.onEmpty(function(){this._lockCSONotificationEmpty=!1,this._lockCSONotification||this._commandProxy.select({paths:[],sharedID:x.getSharedId(),focusOn:this._reframeFocus})}.bind(this))),this._psoTokens.push(m.onPreAdd(o.bind(this))),this._csoTokens.push(b.onPreAdd(o.bind(this))),this._hsoTokens.push(y.onPreAdd(o.bind(this)))}},set3DXContentData:function(e){var i=this;if(!Array.isArray(e.nodes2Open))throw new Error("set3DXContentData: Invalid init parameter nodes2Open");var o=t.is(widget)&&widget.id?"padcompassSocket_"+widget.id:"padcompassSocket";if(null===this._padintercom&&(this._padintercom=new T.Socket(o),this._padintercom.subscribeServer("com.ds.compass",window.parent)),0===e.nodes2Open.length)this._padintercom.dispatchEvent("onResetX3DContent",{},o);else{var n={protocol:"3DXContent",version:"1.0",source:widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"ENOSTDE_AP",data:{items:[]}};e.selectedPaths.paths.forEach(function(t){var o=t[t.length-1],s=null;h.getSetting("enopad3dviewer_lightNodeModel")&&i.getController().getRootStats&&i.getController().getRootStats(t[0])&&(s=i.getController().getRootStats(t[0]).serviceId);n.data.items.push({envId:x.getPlatformId(),serviceId:s||"3DSpace",contextId:h.getSetting("pad_security_ctx")?h.getSetting("pad_security_ctx"):void 0,objectId:o,objectType:e.selectedPaths.attributes[o].type,path:function(t){var i=[];return t.forEach(function(t){i.push({resourceid:t,type:e.selectedPaths.attributes[t].type})}),i}(t)})}),i._padintercom.dispatchEvent("onSetX3DContent",n,o)}},set3DDragDropData:function(e){var t={protocol:"3DXContent",version:"1.1",source:this.getWidget()&&this.getWidget().getValue("x3dAppId")?this.getWidget().getValue("x3dAppId"):"tmp",widgetId:x.getWidgetId(),data:{items:[]}},i=this;e.forEach(function(e){if(N.isAModelPath(e.pathElement)){var o=i.streamPath(e.pathElement),n=i.getController().getNode({id:o[o.length-1]});o.length;for(var s=[],r=0;r<o.length;++r){var a=i.getController().getNode({id:o[r]});s.push({resourceid:o[r],type:N.getNodeType(a)})}t.data.items.push({envId:x.getPlatformId(),serviceId:"3DSpace",contextId:h.getSetting("pad_security_ctx")?h.getSetting("pad_security_ctx"):void 0,objectId:N.getNodeID(n),objectType:N.getNodeType(n),path:s})}});var o=this.getController().getShareFilterSpec(t.data);return o.roots&&o.roots.length>0&&(t.biProxyCtx=o),t},buildStructure:function(e,t,i,o){var n=0;for(var s in e){var r;!0===t[s].selected&&(0===o.length||o.length>0&&-1!==o.indexOf(t[s].nodeId))?i.push({id:t[s].idx,show:t[s].show,select:t[s].selected,children:[]}):i.push({id:t[s].idx,show:t[s].show,children:[]}),(r=this.buildStructure(e[s],t,i[n].children,o))&&i.push({children:r}),n++}},setTypesFor3D:function(e){var t=this;Y||(P.subscribe("setTypesCallback",function(i){if(i.widgetId===x.getWidgetId()){var o=[],n={},s=[],r=[],a=[],l=b.get(),d=t.getController()._model.getRootBag(),h=[],c={version:"1.1",paths:o,attributes:n};t.getRoots().forEach(function(e){h.push(N.getNodeID(e))});for(var p=0;p<l.length;p++){var u=l[p];if(N.isAModelPath(u.pathElement)){var g=u.pathElement,_=g.getLastElement(!0),v=N.getNodeID(_);if(-1!==h.indexOf(v)&&o.push([v]),N.is3DLeaf(_))t.streamPathWithType(u.pathElement,o,n);else{if(N.isPLMNode(_)){var m={};_.traverse(function(e){if(N.is3DLeaf(e)){var t=N.getNodeID(e);if(t&&!m[t])m[t]=!0,f.buildPathesLeadingToNode(e,d).forEach(function(e){g.isAParentOf(e)&&s.push(e)})}})}else{for(;!N.is3DLeaf(_);)_=(g=g.getParentPath()).getLastElement(!0);s.push(g)}s.forEach(function(e){t._hideShowController.isVisible(e)||a.push(N.getNodeID(e.getLastElement(!0))),t.streamPathWithType(e,o,n)})}}}o&&o.forEach(function(e){r.push(e[e.length-1])}),t.setTypesForOFW({nodes2Open:r,hiddenNodes:a,selectedPaths:c},function(o){var n=t.getViewpoint(),s=E.buildViewPoint(n);null!==s&&o.viewpoint.push(s),e.changeControl&&(o.workUnder=e.changeControl);var r=JSON.stringify(o),a={appId:i.appId,widgetId:i.widgetId,fileName:"-file",fileContent:r};P.publish("launchApp",a)})}}),Y=!0);var i={widgetId:t.getWidget().id};b.get().length>0?P.publish("setTypes",i):P.publish("resetType")},setTypesForOFW:function(e,i){if(!Array.isArray(e.nodes2Open))throw new Error("settypes_open_in_web: Invalid init parameter nodes2Open");var o,n=t.clone(J),s=[],r=[],a="",l=0,d=0,h=1,c={},p={},u=[];for(var g in e.selectedPaths.paths.forEach(function(i){var g,_=function(t){return-1!==e.nodes2Open.indexOf(t)};for(1===i.length&&u.push(i[0]),l=0;l<i.length;l++)a=i[l],-1===s.indexOf(a)&&(n.results.push({id:h.toString(),phid:a}),c[a]={idx:h,localid:d},p[d]={idx:h.toString(),nodeId:a,show:(g=a,-1===e.hiddenNodes.indexOf(g)),selected:_(a)},h++,d++,s.push(a));o=r,i.forEach(function(e){var i=c[e];i&&(t.is(o[i.localid])||(o[i.localid]={}),o=o[i.localid])})}),r){var _,f=[];!0===p[g].selected&&(0===u.length||u.length>0&&-1!==u.indexOf(p[g].nodeId))?f.push({id:p[g].idx,show:p[g].show,select:p[g].selected,children:[]}):f.push({id:p[g].idx,show:p[g].show,children:[]}),(_=this.buildStructure(r[g],p,f[0].children,u))&&f.push({children:_}),n.structures.push({structure:f})}i(n)},set3DStructure4OpenInCV5:function(e){if(!Array.isArray(e.nodes2Open))throw new Error("setStructure_4_open_in_cv5: Invalid init parameter nodes2Open");var i,o={version:"1",structures:{references:[],connections:[],trees:{}}},n=[],s="",r=0,a=0,l={};return e.selectedPaths.paths.forEach(function(d){var h=function(t){return-1!==e.nodes2Open.indexOf(t)};for(r=0;r<d.length;r++)s=d[r],-1===n.indexOf(s)&&(r%2!=0?(o.structures.connections.push({physicalid:d[r],localid:a+""}),l[s]={localid:a,selected:h(s)},a++,n.push(s)):(o.structures.references.push({physicalid:d[r],type:e.selectedPaths.attributes[d[r]].type,localid:a+""}),l[s]={localid:a,selected:h(s)},a++,n.push(s)));i=o.structures.trees,d.forEach(function(e){var o=l[e];t.is(i[o.localid])||(i[o.localid]={},o.selected&&(i[o.localid].selected=o.selected)),i=i[o.localid]})}),o},_initInterwidgetCom:function(){var e=this;this.isInterwidgetComAvailable()&&require(["DS/PADUtils/PADCommandProxy","DS/CoreEvents/Events"],function(t,i){e._commandProxy=t.create({events:{onSetCurrentViewpoint:function(t){e._onSetCurrentViewpoint(t)},onSharedAlert:function(t){var i=C.getPromises().slice();C.createPromise(function(o,n){R.all(i).then(function(n){i=null,0!==e.getRoots().length||e._checkHiddenRoots()?e._dropZoneContainer.hide():e._dropZoneContainer.show("drop"),e.displayNotification(t),o()})},"SharedAlert")},onFilterWarn:function(t){var i=C.getPromises().slice();C.createPromise(function(o,n){R.all(i).then(function(n){i=null,0!==e.getRoots().length||e._checkHiddenRoots()?e._dropZoneContainer.hide():e._dropZoneContainer.show("drop");var s="";switch(t){case"inauthoring":s=F.filterInAuthoring;break;case"notactivated":s=F.filterNotActivated}e.displayNotification({eventID:"warning",msg:s}),o()})},"FilterWarn")},onFocusChange:function(t){t.sharedID==x.getSharedId()&&e.publish({event:"onFocusChange",data:t})},onChangeControlDlgOpen:function(e){"2D"===e.widget&&h.setSetting("changeControlDlgOpen",e.isOpen)},onSelect:function(i,o){var n=C.getPromises().slice();C.createPromise(function(s,r){R.all(n).then(function(r){if(n=null,!0===i.focusOn&&i.sharedID&&i.sharedID!==x.getSharedId())return console.log("Call from another instance hence not selecting"),void s();e.lockSelectionBroadcast(!0);try{var a=[],l=!1;if(i.paths){var c=[];"2"===i.version?i.paths.forEach(function(e){var t=[];e.forEach(function(e){t.push(e.resourceid)}),c.push(t)}):c=i.paths,c.forEach(function(t){if(t.length){var i=e.unstreamPath(t);i&&a.push({pathElement:i})}}),l=a.length!==i.paths.length}if(i.POIGroups&&i.POIGroups.length>0&&!i.fromPanel)(u=e.getController().unstreamPOIGroup(i.POIGroups[0])).length>0&&u.forEach(function(e){a.push({pathElement:e})});else if(i.POIs&&!i.fromPanel)for(var p=0;p<i.POIs.length;p++){var u;(u=e.getController().unstreamPOI4Select(i.POIs[p])).length>0&&u.forEach(function(e){a.push({pathElement:e})})}else i.ZOIs&&(a=e.getController().unstreamZOIs(i.ZOIs));if(i.referenceIds)for(var g=e.getController().getRootBag(),_=[],v=0;v<i.referenceIds.length;v++){var m=e.getController().getNode({id:i.referenceIds[v]});m&&(_=f.buildPathesLeadingToNode(m,g));for(p=0;p<_.length;p++)a.push({pathElement:_[p]})}if(!0===i.exclusiveShow){var P=a.map(function(e){return e.pathElement});e._hideShowController.exclusiveShow({paths:P})}let n=K.getLinked()&&!0===h.getSetting("activateWidgetLink"),r=!!n&&K.getLinked().filter(e=>e.id===o.originWidgetId).length>0;a.length&&!i.noClear?(b.empty(),y.empty(),b.add(a),y.add(a)):!(n&&r||!n&&o.appid===t.appId())||!0===i.focusOn||l||i.noClear||(b.empty(),y.empty());var D=d.getPADTracker({eventCategory:"usage",eventAction:"3d_selectEvent_stats"});let x=!1,O=!1,A=!1;var I=0;b.get()&&(I=b.get().length);var S=0;i&&i.POIs&&i.POIs.length&&(S=i.POIs.length,x=!0);var C=0;i&&i.ZOIs&&i.ZOIs.length&&(C=i.ZOIs.length,O=!0);var w=0;i&&i.POIGroups&&i.POIGroups.length&&(i.POIGroups.forEach(function(e){e&&(w+=e.POIs.length)}.bind(this)),A=!0),D.setEventData({eventLabel:"incoming_selection",eventValue:S+w+C}),(x||O||A)&&(D.persDim.pd2="Incoming Selection",D.persDim.pd3=x&&O||A&&O?"POI and ZOI":x?"POI":O?"ZOI":A?"POI Group":"error",D.persVal.pv3=S+w,D.persVal.pv4=C,D.persVal.pv5=I,D.trackPageEvent())}finally{e.lockSelectionBroadcast(!1),s()}})},"select")},onReframeSelection:function(){e.reframe()},onFocus:function(t){let o=!1,n=!1,s=!1,r=!1;var a=0;t&&t.POIs&&(a=t.POIs.length,t.POIs.length&&(o=!0));var l=0;t&&t.ZOIs&&(l=t.ZOIs.length,t.ZOIs.length&&(n=!0));var c=0;t&&t.paths&&(c=t.paths.length,t.paths.length&&(s=!0));var p,g=0;(t.POIGroups&&t.POIGroups.length&&(t.POIGroups.forEach(function(e){e&&(g+=e.POIs.length)}.bind(this)),r=!0),t&&"reframe"===t.intent)&&((p=d.getPADTracker({eventCategory:"usage",eventAction:"3d_reframeEvent_stats"})).persDim.pd2=o&&n||r&&n?"POI and ZOI":o?"POI":n?"ZOI":r?"POI Group":s?"Path":"error",p.persVal.pv2=a,p.persVal.pv3=l,p.persVal.pv4=g,p.persVal.pv5=c,p.trackPageEvent());t&&"focus"===t.intent&&((p=d.getPADTracker({eventCategory:"usage",eventAction:"3d_focusEvent_stats"})).persDim.pd2=o&&n||r&&n?"POI and ZOI":o?"POI":n?"ZOI":r?"POI Group":s?"Path":"error",p.persVal.pv2=a,p.persVal.pv3=l,p.persVal.pv4=g,p.persVal.pv5=c,p.trackPageEvent());let _=i.subscribe({event:"/VISU/"},function(e){"@onViewpointBeginMove"===e.eventType&&(i.unsubscribe(_),K.unsubscribe("DS/ExternalWdgtCom/ViewPointSync"))}),v=i.subscribe({event:"/VISU/"},function(t){"@onViewpointEndMove"===t.eventType&&(i.unsubscribe(v),K.subscribe("DS/ExternalWdgtCom/ViewPointSync",e._onViewPointSync.bind(e)))});var m=function(t){for(var i=[],o=[],n=[],s=0;s<t.length;s++)if((i=e.getController().unstreamPOI(t[s])).length>0)for(var r=0;r<i.length;r++)o.push(i[r]);E.reframeOn({paths:o,viewpoint:e.getViewpoint(),context:e});for(s=0;s<t.length;s++)if((i=e.getController().unstreamPOI4Select(t[s])).length>0)for(r=0;r<i.length;r++)n.push({pathElement:i[r]});n.length&&(b.empty(),y.empty(),b.add(n),y.add(n))};if(!0===h.getSetting("enopad3dviewer_lightNodeModel")){if(!(t.paths||t.referenceIds||t.POIs||t.ZOIs))return void console.error("No path to focus on or call from another 3D widget reference");if("reframe"===t.intent){var P=[];if(t.paths)return t.paths.forEach(function(t){if(t.length){var i=e.unstreamPath(t);i&&P.push(i)}}),void E.reframeOn({paths:P,viewpoint:e.getViewpoint()});if(t.POIs&&t.POIs.length&&m(t.POIs),t.ZOIs&&t.ZOIs.length){var D=e.getController().unstreamZOIs(t.ZOIs);if(D.length){b.empty(),y.empty(),b.add(D),y.add(D);P=[];for(var I=0;I<D.length;I++)P.push(D[I].pathElement);E.reframeOn({paths:P,viewpoint:e.getViewpoint()})}}}else{var S=u.getCommand("PAD3DViewerNavigateOnSelectionHdr",e.getCommandContext());if(S)if(t.paths)S.execute(t.paths);else if(t.referenceIds){for(var w=[],x=[],O=[],A=0;A<t.referenceIds.length;A++)e.getController().getNode({id:t.referenceIds[A]})?x=x.concat(f.buildPathesLeadingToNode(e.getController().getNode({id:t.referenceIds[A]}),e.getController().getRootBag())):O.push(t.referenceIds[A]);if(O.length)R.all(e.getController()._loadPOI(O)).then(function(t){for(var i=0;i<t.length;i++)t[i]&&(w=w.concat(t[i]));for(var o=0;o<x.length;o++)w.push(e.streamPath(x[o]));S.execute(w)});else{for(var M=0;M<x.length;M++)w.push(e.streamPath(x[M]));S.execute(w)}}else t.POIs&&t.POIs.length?S.execute(t.POIs,"POIs",t.displayPOITooltip):t.ZOIs&&t.ZOIs.length&&S.execute(t.ZOIs,"ZOIs")}}else{var N=C.getPromises().slice();C.createPromise(function(i,o){R.all(N).then(function(o){if(N=null,!t.paths&&!t.referenceIds&&!t.POIs)return console.error("No path to focus on or call from another 3D widget reference"),void i();if("reframe"===t.intent){var n=[];t.paths&&(t.paths.forEach(function(t){if(t.length){var i=e.unstreamPath(t);i&&n.push(i)}}),E.reframeOn({paths:n,viewpoint:e.getViewpoint()}),i()),t.POIs.length&&(m(t.POIs),i())}else{var s=u.getCommand("PAD3DViewerNavigateOnSelectionHdr",e.getCommandContext());if(s){if(t.paths)s.execute(t.paths).then(function(){i()});else if(t.referenceIds){for(var r=[],a=[],l=0;l<t.referenceIds.length;l++){e.getController().getNode({id:t.referenceIds[l]})&&(a=f.buildPathesLeadingToNode(e.getController().getNode({id:t.referenceIds[l]}),e.getController().getRootBag()));for(var d=0;d<a.length;d++){var h=e.streamPath(a[d]);h.length&&r.push(h)}}s.execute(r).then(function(){i()})}}else i(),console.warn("Missing focus command. Add 'PAD3DViewerNavigateOnSelectionHdr' to your workbench to use focus")}})},"focusOn")}},onPadDestroy:function(t){e.publish({event:"onWidgetDestroyed",data:t})},onRequestViewPoint:function(){var t=e.getViewpoint(),i=E.buildViewPoint(t);e._commandProxy.updateViewPoint(i)}}})})},displayNotification:function(e){require(["DS/PADUtils/views/PADAlert"],function(t){t.displayNotification(e),this.isSelectiveLoadingActivated()&&this.getStatusBar()&&this.getStatusBar().setLatestNotification({notification:e})}.bind(this))},streamPath:function(e){return this._controller.buildArrayFromPath(e)},streamPathWithType:function(e,t,i){return this._controller.buildArrayFromPathWithType(e,t,i)},streamPOI:function(e,t,i){return this.getController().streamPOI(e,t,i)},streamPOIGroup:function(e,t){return this.getController().streamPOIGroup(e,t)},streamZOI:function(e,t){return this.getController().streamZOI(e,t)},unstreamPath:function(e,t){return this._controller.buildPathFromArray(e,t)},loadActionBar:function(e){e.context=this.getCommandContext(),this.abReadyProbe=S.createProbe("actionBarReady"),e.language=this._lang;var t={};if(this.isSelectiveLoadingActivated()){var i=this.getCommandContext(),o=u.getCommandCheckHeader("PAD3DToggleStatusBarHdr",i);t=o&&o.getState&&o.getState()?x.isTouchDevice()?{bottom:"38px"}:{bottom:"24px"}:{bottom:"0"}}var n=this.getActionBar();n?n.loadModel(e):this.getFrameWindow()&&(this.getFrameWindow().loadActionBar(e),n=this.getActionBar()),!0===this.getOption("enableSidePanel")&&n&&(n.inject(this.elements.main),n.elements.container.setStyles(t))},displayTree:function(e){e?this._frmWindow.getTree().show():this._frmWindow.getTree().hide()},getBIController:function(){return this._controller},author:function(e){this._controller.switchAuthoringMode(e)},addR2Vs:function(e){return new R(function(t,i){this._controller.addR2Vs(e).then(t).catch(i)}.bind(this))},addRoots:function(e,t,i){void 0!==e.pids||void 0!==e.paths||void 0!==e.objects?(void 0===e.pids&&void 0===e.paths||console.warn("The usage of pids or paths is deprecated, please use objects"),t=void 0===t||t,i=void 0===i||i,this._controller.addRoots(e,t,i,this.getAutomaticReframePolicy())):console.error("No PIDs or paths or objects array defined")},addFilter:function(e){this._controller.addFilter(e)},loadJSON:function(e,t){if(!Array.isArray(e.data)||Array.isArray(e.data)&&0===e.data.length)throw new Error("No data defined");for(var i=0;i<e.data.length;i++){if("string"!=typeof e.data[i].rootID)throw new Error("No rootID defined for the data n°"+(i+1));if("object"!=typeof e.data[i].structure)throw new Error("No structure defined for the data n°"+(i+1))}this._controller.addRoots({structures:e.data},!1,t,this.getAutomaticReframePolicy())},removeRoots:function(e,t){void 0!==e.pids?(this.getStatusBar()&&this.getStatusBar().clearFilter({ids:e.pids}),this._controller.removeRoots(e,t)):console.error("No PID array defined")},fadeRootOut:function(e){return new R(t=>{if(void 0===e.pids)return void console.error("No PID array defined");var i=this.getHideShowController()._sceneGraphOverrideSet.getUniqueOverrideFromNodeId(e.pids[0]);i||(i=this.getHideShowController()._sceneGraphOverrideSet.createNodeIdOverride(e.pids[0]));let o=1;const n=setInterval(()=>{i.setOpacity(o,!0),o<=0&&(clearInterval(n),this.getHideShowController()._sceneGraphOverrideSet.deleteOverride(i),e.reframe=!1,this.removeRoots(e,!1),t()),o-=.05;const s=Math.pow(10,2);o=Math.round(o*s)/s,this._viewer.render({updateInfinitePlane:!0})},50)})},empty:function(e,t){this.getStatusBar()&&this.getStatusBar().clearFilter(),e=void 0===e||e,this._controller.flushModel(e,!1,!1,t)},publish:function(e){this.getModelEvents().publish(e)},subscribe:function(e,t){return this.getModelEvents().subscribe(e,t)},unsubscribe:function(e){this.getModelEvents().unsubscribe(e)},getRootBagPath:function(){return this._controller.getRootBagPath()},getRoots:function(){return N.getRoots(this)},getModelEvents:function(){return this._modelEvents},reframe:function(e){this.getViewer().get360Mode()||(e?this._frmWindow.getViewpoint().reframe(null,void 0,e):this._frmWindow.getViewpoint().reframe())},reframeSelection:function(){this._commandProxy.reframeSelection()},setCurrentLayout:function(e){var t=this;e&&!this._layoutActivatedTokenBegin&&(this._layoutActivatedTokenBegin=e.subscribe({event:"onLayoutComputationBegin"},function(){t.publish({event:"onLayoutComputationBegin"})}),this._layoutActivatedTokenEnd=e.subscribe({event:"onLayoutComputationEnd"},function(){t.publish({event:"onLayoutComputationEnd"})})),this._layout=e},getViewer:function(){return this._viewer},getCommandProxy:function(){return this._commandProxy},getHideShowController:function(){return this._hideShowController},getViewpoint:function(){if(this._frmWindow)return this._frmWindow.getViewpoint()},getViewpointParameters:function(){if(this.getViewpoint())return E.buildViewPoint(this.getViewpoint())},_getFrustumDefinition:function(){if(this.getViewer()&&this.getViewpoint())return E._getFrustumDefinition(this.getViewer(),this.getViewpoint())},getLevelSelectorCommand:function(e){var t=u.getCommand("LevelSelectorHdr",this.getCommandContext());if(t)e(t);else{var i=this,o="DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd".replace(/\./g,"/");require(["DS/ApplicationFrame/CommandFactory",o],function(o,n){t=o._createCommand(n,{context:i.getCommandContext(),ID:"LevelSelectorHdr"}),e(t),i=null})}},getContentName:function(e){if("object"!=typeof e.callbacks)throw new Error("No callbacks function defined");if("function"!=typeof e.callbacks.onComplete)throw new Error("No onComplete callback function defined");if(h.getSetting("enopad3dviewer_lightNodeModel"))this._controller.getContentName().then(function(e,t){e(t)}.bind(this,e.callbacks.onComplete));else{var t=this.getRoots(),i="",o=1===t.length&&0===this._controller.getHiddenRootIds().length?N.getNodeID(t[0]):null;if(null===o&&0===t.length&&1===this._controller.getHiddenRootIds().length&&(o=this._controller.getHiddenRootIds(0)),o){var n=this;this._controller.getAttributes({ids:[o],attributes:["ds6w:label"],callbacks:{onComplete:function(t){(n.getRoots().length>0||n._controller.getHiddenRootIds().length>0)&&t[o]&&(i=t[o]["ds6w:label"]),e.callbacks.onComplete({contentName:i}),n=null},onFailure:function(){e.callbacks.onFailure&&e.callbacks.onFailure({contentName:i}),n=null}}})}else t.length+this._controller.getHiddenRootIds().length>1?(i=t.length+this._controller.getHiddenRootIds().length+" "+L.contentNameSuffix,e.callbacks.onComplete({contentName:i})):e.callbacks.onComplete({contentName:i})}},setRobotVisibility:function(e){this._robotVisibility=e,this._viewer.getRobot&&this._viewer.getRobot()&&this._viewer.getRobot().setVisibility(e)},isRobotVisible:function(){return this._robotVisibility},setDefaultContextualBarVisibility:function(e){this._defaultContextualBarVisibility=e},setDefaultProgressBarVisibility:function(e){this._defaultProgressBarVisibility=e},getDefaultProgressBarVisibility:function(){return this._defaultProgressBarVisibility},setAutomaticReframePolicy:function(e){this._automaticReframePolicy=e},getAutomaticReframePolicy:function(){return!window.ENOPADNoReframe&&this._automaticReframePolicy},isInterwidgetComAvailable:function(){return this._interwidgetComAvailability},isDefaultContextualBarVisible:function(){return this._defaultContextualBarVisibility},setDefaultContextualMenuVisibility:function(e){this._defaultContextualMenuVisibility=e},setOpenWithMenuAvailability:function(e){this._openWithMenuAvailability=e},isOpenWithMenuAvailable:function(){return this._openWithMenuAvailability},isDefaultContextualMenuVisible:function(){return this._defaultContextualMenuVisibility},getController:function(){return this._controller},getFrameWindow:function(){return this._frmWindow},getActionBar:function(){var e=null;return this.getFrameWindow()&&(e=this.getFrameWindow().getActionBar()),e},deactivateCurrentLayout:function(e){var t=this,i=C.getPromises().slice();C.createPromise(function(o,n){R.all(i).then(function(n){i=null;var s=!1;if(t._layout&&(s=t._layout.isActive())&&t._layout.deactivate(!1),e.disableCommand){var r=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");r&&r.setAttribute("style","opacity: 0.5; pointer-events: none !important; -webkit-filter: grayscale(100%);")}return o(),s})},"deactivateLayout")},activateCurrentLayout:function(){this._layout&&!this._layout.isActive()&&this._layout.activate();var e=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");e&&e.setAttribute("style","")},getCurrentLayout:function(){return this._layout},refresh:function(e){e=void 0===e||e,this._controller.refresh(e)},search:function(e){if("string"==typeof e.searchQuery){var t=this;require(["DS/PADServices/utils/PredefinedQueryUtils"],function(i){i.isPredefinedQry(e.searchQuery).then(function(i){e.searchQuery=i,t._controller.search(e)})})}},freezeProgressiveLoading:function(){this.getController().pauseProgressiveLoading(),this.getStatusBar()&&this.getStatusBar().disableProgress()},unfreezeProgressiveLoading:function(){this.getController().resumeProgressiveLoading(),this.getStatusBar()&&this.getStatusBar().enableProgress()},setLoadingDelegations:function(e){if("object"!=typeof e)throw new Error("Wrong parameter for setLoadingDelegations");this._loadingDelegations=e},getDecorationBag:function(){return this._controller.getDecorationBag()},lockSelectionBroadcast:function(e){this._lockCSONotification=e},setAuthorizedRootTypes:function(e){for(var t=[],i=h.getSetting("supported_root_types"),o=0;o<e.length;o++)i.indexOf(e[o])>-1&&t.push(e[o]);h.setSetting("authorized_root_types",t)},setDefaultStreamToLoad:function(e){h.setSetting("enopad3dviewer_CGRorTHB",e),this.getController()._setDefaultStreamToLoad(e)},loadChange:function(e){this._changeAction&&this._changeAction.loadChange({app:this,changes:e.objects})},addWidgetBorder:function(){!0===this.getOption("enableSidePanel")?this.elements.borderedLayout.addClassName("bordered"):this.elements.container.addClassName("bordered")},clearWidgetBorder:function(){!0===this.getOption("enableSidePanel")?this.elements.borderedLayout.removeClassName("bordered"):this.elements.container.removeClassName("bordered")},displayStatusBar:function(e){var t=this.getCommandContext(),i=u.getCommandCheckHeader("PAD3DToggleStatusBarHdr",t);i?i.setState(e):this._displayStatusBar(e)},_displayStatusBar:function(e){var t=this.getActionBar(),i=this.getCommandContext(),o=u.getCommandCheckHeader("PAD3DToggleStatusBarHdr",i);if(!0===e||o&&o.getState&&o.getState()){var n={};n=x.isTouchDevice()?{bottom:"38px"}:{bottom:"24px"},t.elements.container.setStyles(n),this.getStatusBar()&&this.getStatusBar().open()}else t.elements.container.setStyle("bottom","0"),this.getStatusBar()&&this.getStatusBar().close()},getStatusBar:function(e){return this.elements.padstatusbar},openStoredObjects:function(e){if(e.unserializedData&&e.unserializedData.data.items.length>0){var t=x.getPlatformId();return t&&e.unserializedData.data.items.forEach(function(e){e.envId=t}),this.openDroppedObjects(e)}var i=this,o=function(e,t,i,n){void 0===i&&(i=[]);var s,r=Object.keys(t),a=r.length;for(s=0;s<a;s++){var l,d=Object.keys(t[r[s]]).length;if(0===d){var h;(h=void 0===n?[]:n.slice()).push(r[s]);var c=h.join(",");if(-1===i.indexOf(c)){i.push(c);var p={path:h};e.push(p)}}else for(l=0;l<d;l++){var u;(u=void 0===n?[]:n.slice()).push(r[s]),o(e,t[r[s]],i,u)}}};return new R(function(t){var n=[];if(e.products&&Object.getOwnPropertyNames(e.products).length){var s=new R(function(t){var n=C.getPromises();R.all(n).then(function(){var n=[];if(o(n,e.products),n.length){if(!0===e.withFilter)var s=i.subscribe({event:"onRootAdded"},function(o){i.unsubscribe(s),t(),G.isAuthoring()?(i.getController()._disableFilterWaiting({rootIds:[o.id]}),i.displayNotification({msg:F.filterInAuthoring,eventID:"warning"})):!0!==e.fromProxy?require(["DS/ApplicationFrame/CommandsManager"],function(e){var t=e.getCommand("DefineFilterHdr",i.getCommandContext());t&&(t.setAppParams({widgetId:x.getWidgetId(),appId:x.getSharedId(),selectedId:o.id}),t.begin(),i._filterPanelOpen=!0,i._filterRootIds=[o.id])}):!0===e.fromProxy&&(i._filterPanelOpen=!0,i._filterRootIds=[o.id])});i.addRoots({objects:n,loadWithFilter:e.withFilter},!1)}else t()})});s.name="AddRoots",n.push(s)}if(e.filters){var r=Object.getOwnPropertyNames(e.filters);if(r.length){var a=new R(function(t){var o=C.getPromises();R.all(o).then(function(){for(var o=[],n=x.getPlatformId(),s=0;s<r.length;s++)o.push({envId:n,serviceId:"3DSpace",objectId:r[s],objectType:"ENOStrRefinementSpecification"});var a={protocol:"3DXContent",version:"1.1",source:x.getAppId(),widgetId:x.getWidgetId(),data:{items:o}},l=("boolean"!=typeof e.fromAutoReload||!0!==e.fromAutoReload)&&e.broadcast;i.addRootNodesFromContent({json3DXContent:a,inContext:!1,dispatch:l}),t()})});a.name="AddFilters",n.push(a)}}e.pointClouds&&e.pointClouds.length&&i.addR2Vs({objects:e.pointClouds,reframe:!0,displayNotif:!0,dispatch:!0}),R.all(n).then(function(){t()})})},openDroppedObjects:function(e){var i=this;return new R(function(o){if("FILTER"===e.behavior||!0===e.withFilter){if(G.isAuthoring()){i.displayNotification({msg:F.filterInAuthoring,eventID:"warning"});var n=!!t.is(e.broadcast,"boolean")&&e.broadcast;return i.addRootNodesFromContent({json3DXContent:e.unserializedData,inContext:!e.behavior||"WITH_CONTEXT"===e.behavior,dispatch:n}),void o()}if(e.unserializedData.biProxyCtx){if(e.unserializedData.data.items.length>1){n=!!t.is(e.broadcast,"boolean")&&e.broadcast;i.addRootNodesFromContent({json3DXContent:e.unserializedData,inContext:!e.behavior||"WITH_CONTEXT"===e.behavior,dispatch:n,fromFilter:!0})}else require(["DS/ApplicationFrame/CommandsManager"],function(t){var n=t.getCommand("FilterDropObjects",i.getCommandContext());n?n.execute(e.unserializedData,!0,!0):console.error("PAD3DViewer## FilterDropObjects command is undefined"),o(n&&e.unserializedData?void 0:{error:"noCommandAvailable"})});return void o()}require(["DS/ApplicationFrame/CommandsManager"],function(t){var n=t.getCommand("FilterDropObjects",i.getCommandContext());n?n.execute(e.unserializedData,e.fromProxy,!0):console.error("PAD3DViewer## FilterDropObjects command is undefined"),o(n&&e.unserializedData?void 0:{error:"noCommandAvailable"})})}else{n="boolean"==typeof e.broadcast&&e.broadcast;i.addRootNodesFromContent({json3DXContent:e.unserializedData,inContext:!e.behavior||"WITH_CONTEXT"===e.behavior,dispatch:n}),o()}})},_openObjectsFromWL:function(e){if(!e.filter)return this.openDroppedObjects(e);{let i=0,o=[];const n=t=>{for(let e=0;e<o.length;++e)this.getController().getBIProxy().removeEvent(o[e]);if(0===t.status&&null!==t.error)this.displayNotification({eventID:t.error.level,title:t.error.title,msg:t.error.message});else{if("APPLY"===e.filter.intent){const e=this.subscribe({event:"onRootAdded"},()=>{this.unsubscribe(e),j.getModelEvents().publish({event:"ENXViews/WelcomePanel/closeLandingPage"})});return}e.withFilter=!0,this.openDroppedObjects(e)}},s=e.unserializedData.data.items;for(let r=0;r<s.length;++r){var t=`DroppedFilterSpec-${r}`;o.push(t),this.getController().getBIProxy().addEvent(t,e=>{++i===s.length&&n(e)}),this.getController().getBIProxy().setPublicFilterSpecification({rootId:s[r].objectId,rootAlias:s[r].displayName,specification:e.filter.specification,applyFilter:"APPLY"===e.filter.intent?1:0,displayFilter:"WAIT"===e.filter.intent?1:0,eventName:t})}}},getPCSTrackerResult:function(e){var t=window.top.performance.getEntriesByName(e);return t.length>0?t[t.length-1]:void 0},_trackPCS:function(){window.top.performance.mark(this._pcsPrefix+"init_pad3dviewer_done"),window.top.performance.measure(this._pcsPrefix+"build3DViewer",this._pcsPrefix+"init_pad3dviewer_begin",this._pcsPrefix+"init_pad3dviewer_done");var e=d.getPADTracker({eventCategory:"performance",eventAction:"3d_component_init"}),t=this.getPCSTrackerResult(this._pcsPrefix+"build3DViewer"),i=this.getPCSTrackerResult(this._pcsPrefix+"frameWindowInit");e.setEventData({eventLabel:"3dviewer_loading_duration",eventValue:t?t.duration:0}),e.addMultivaluedEventData("3d_component_init",{frameWindowInit_start:i?i.startTime:0,frameWindowInit_duration:i?i.duration:0}),e.trackPageEvent()},getApplicativeData:function(){return this._applicativeData},registerDefaultContextMenu:function(e){h.getLayout_options("frmWindow_opts").contextualMenuContent=e},getNGFUXID:function(e){const t=this.getWidget()&&this.getWidget().id?this.getWidget().id:"fakeWidgetIDFallback";let i;return i=h.getSetting("activateWidgetLink")?K.getSourceWidgetId()&&K.getSyncFeature("Content")&&e?K.getSourceWidgetId():t:x.getSharedId()}})});