define("DS/DMUBaseUIWebAppCommon/DMUWebAppController",["UWA/Class","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/PADUtils/PADUtilsServices","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/CATWebUXComponents/CATWebUXUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseExperience/DMUContextManager","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","i18n!DS/DMUBaseUIWebAppCommon/assets/nls/DMUBaseUIWebAppCommon"],function(e,t,r,a,n,o,l,i,s,d,c,g,u,m,C,p,h){"use strict";return e.extend({init:function(e){this._parent(e);var u,D,f,S=(e||{}).ctxViewer,M=C.getEventsController({viewer:S.getViewer()}),U=!1;this.setSlideShowController=function(e){u=e},this.setValidatedObjCreationFlag=function(e){U=e};this.loadContext=function(e,t,r,a,n){var g;t&&n&&e&&(g=f&&f.objectId===e.reviewId?f:e,l.multiTenantMgt([g],o.getRoots(S),function(e){if(!e.isMultiTenant&&("_DMUValidationValidation"===r||"_DMUValidationExposedPresentation"===r)){var t={};t.reviewId=g.objectId,t.context=S,t.displayName=g.displayName,t.displayType=g.displayType?g.displayType:"DMUValidationValidation"===g.objectType?"Review":void 0,t.type="_DMUValidationValidation"===r?"DMUValidationValidation":"DMUValidationExposedPresentation",t.readOnly=!1,t.cbRootAdded=function(){f=g},t.cbOK=async function(e){let t=!1;e&&!0===e.sameReview&&(t=!0);var r=await c.createReviewContext({context:S}),a=(D||(D=s.giveDMUSlidesController({context:S.getFrameWindow()})),D),o=r.getValidation(),l=o.getLoadedRepRefs();l.length>0&&a&&(a=s.giveDMUSlidesController({context:S.getFrameWindow()}),n.autoReframe=!1,"DMUValidationValidation"!==g.objectType||t||l[0].getMarkupContent()&&a.setActiveSlide(l[0].getMarkupContent().getSlides()[0]));var i,u,m=[];let p=o.getHighlights();if(p&&p.length)for(i=0;i<p.length;i++)m.push(p[i]);if(u=[],o){var h=o.getLoadedRepRefs();for(i=0;i<h.length;i++)if(h[i].getMarkupContent()){u=u.concat(h[i].getMarkupContent().getSlides());for(let e=0;e<h[i].getMarkupContent().getSlides().length;e++){var f=h[i].getMarkupContent().getSlides()[e].getDMUObjects();for(let e=0;e<f.length;e++)f[e].getDMUComments&&(u=u.concat(f[e].getDMUComments()))}}}var U=function(e,t){d.giveDMUCommentsController({context:S.getFrameWindow()}).applyComment({commentId:e,markupId:t})};for(let e=0;e<u.length;e++)for(let r=0;r<m.length;r++)if(m[r].getAttribute("sPresentationSlideID")===u[e].getAttribute("sUuid")){if(m[r].getPlmID()===g.objectId)if("DMUSlide"===u[e].getType())a&&a.setActiveSlide(u[e]);else if("DMUComment"===u[e].getType()){let a=u[e].getAttribute("sUuid"),n=m[r].getAttribute("sRepRefMarkupID");if(t)U(a,n);else{let e=M.addEvent("on2DDocumentLoadSuccess",function(){U(a,n),M.removeEvent(e)})}}t||n.highlightInitialization({highlight:m[r],slide:u[e]})}M.addEvent("onReplyExpandRequest",function(e){var t=C.getReviewContext({viewer:S.getFrameWindow().getViewer()}),r=t.getValidation();M.fireEvent("onGetMarkupJsonEvt",{markup:r.getRepRef(e.data.id),onLoadingCompleted:function(e,o){r.setCurrentMarkup(o),M.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(){var e=t.getCurrentSessionMarkup();o.setMarkupContent(e),e.setMarkupOwner(o),a&&a.setActiveSlide(e.getSlides()[0]),e.setReadOnly(t.isReadOnly());let l=r.getHighlightsData();if(l&&l.length)for(u=e.getSlides(),i=0;i<l.length;i++)for(var s=0;s<u.length;s++)l[i].slideId===u[s].getAttribute("sUuid")&&n.highlightInitialization({highlight:l[i],slide:u[s]})}})}})})},t.cbFailed=function(){},n.loadValidation(t),i.setSlidePreferences({context:S.getFrameWindow(),preferences:{displayNominal:!1,displayInWork:!1}})}}))},this.createSharedPreferences=function(e){e&&e.addPreferences([{nls:h.markerPrefTitle,id:"MarkerPreferences",type:"section",preferences:[{nls:h.validatedStampMarkerLabel,id:"MarkerValidatedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_MarkerValidatedStampLabel")||p.defaultValidatedStampLabel},getDefaultValue:function(){return p.defaultValidatedStampLabel},setValue:function(e){e!==localStorage.getItem("CATWebUXMePreferences_MarkerValidatedStampLabel")&&localStorage.setItem("CATWebUXMePreferences_MarkerValidatedStampLabel",e)}},{nls:h.rejectedStampMarkerLabel,id:"MarkerRejectedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_MarkerRejectedStampLabel")||p.defaultRejectedStampLabel},getDefaultValue:function(){return p.defaultRejectedStampLabel},setValue:function(e){e!==localStorage.getItem("CATWebUXMePreferences_MarkerRejectedStampLabel")&&localStorage.setItem("CATWebUXMePreferences_MarkerRejectedStampLabel",e)}}]},{nls:h.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:h.firstProductColor,id:"CompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareFirstColor")?localStorage.getItem("CATWebUXMePreferences_CompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareFirstColor",e)}},{nls:h.secondProductColor,id:"CompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareSecondColor")?localStorage.getItem("CATWebUXMePreferences_CompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareSecondColor",e)}},{nls:h.compare3DCommonColor,id:"Compare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare3DCommonColor",e)}},{nls:h.compare2DCommonColor,id:"Compare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare2DCommonColor",e)}}]},{nls:h.slideSectionTitle,id:"SlidePreferences",type:"section",preferences:[{nls:h.slideNameFromFeature,id:"SlideNameFromFeature",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_SlideNameFromFeature")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_SlideNameFromFeature"))&&localStorage.setItem("CATWebUXMePreferences_SlideNameFromFeature",e?"true":"false")}},{nls:h.slideTitleDisplayLbl,id:"DisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle"))&&localStorage.setItem("CATWebUXMePreferences_DisplaySlideTitle",e?"true":"false")}},{nls:h.preferences.slideCaptureSpecLayers,id:"CaptureSpecLayers",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_CaptureSpecLayers")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_CaptureSpecLayers"))&&localStorage.setItem("CATWebUXMePreferences_CaptureSpecLayers",e?"true":"false")}}]}])},this.removeSharedPreferences=function(e){e&&e.removePreferences(["MarkerPreferences","ComparePreferences","SlidePreferences"])},this._onContextualBarReadyCB=function(){var e,r,a=[],n=t.get();if(n.length){for(var l,i=!1,s=null,d=!1,c=0;c<n.length;c++){for(l=n[c].pathElement.clone();l&&l.internalPath.length;)l=l.getParentPath();if(l.getLastElement(!0).getAnnotationClassType||l.getLastElement(!0).getDMUType)return{cmdList:[]};s=o.getLastReference(l);let e=!S.getController().isRootSupported||S.getController().isRootSupported(o.getNodeID(s.getLastElement(!0)));s&&o.isReference(s.getLastElement(!0))&&e?i=!0:s=null}var g=n[n.length-1];g&&g.event&&g.event.lastPosition&&g.event.startPosition&&(e=g.event.startPosition,r=g.event.lastPosition,e.x>=r.x-3&&e.x<=r.x+3&&e.y>=r.y-3&&e.y<=r.y+3)&&g.pathElement.externalPath.length>2&&g.pathElement.externalPath[0]===S.getRootBagPath().getLastElement(!0)&&(d=!0);var u=C.getReviewContext({context:S}),p=u?u.getCurrentSessionMarkup():null;let t="3D"===C.getCurrentReviewContext()||"ITF"===C.getCurrentReviewContext();if(p&&p.getActiveFlag()&&!p.isReadOnly()&&p.isVisible()&&p.getCurrentSlide()&&!U){if(i&&t&&a.push({name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}),s&&s.externalPath&&s.externalPath.length&&t){var h=m.getDMUSceneDisplayController({context:S});h&&!h.getCurrentComparedObjectIDPaths()&&a.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]}),a.push({name:"DMUPositionOverloadStr",line:1,hdr_list:["DMUPositionOverloadHdr"]})}}else i&&t&&a.push({name:"HideShowStr",line:1,hdr_list:["HideShowHdr"]});d&&t?a.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}):1===n.length&&g&&g.pathElement&&g.pathElement.getParentPath().isEqual(S.getRootBagPath())&&t&&a.push({name:"RemoveRootStr",line:1,hdr_list:["RemoveRootHdr"],type:"handler",identifier:"ENO3DRemoveRootCmd"})}return{cmdList:a}},this._applyFlag=function(e,t){for(var r,n=0;n<e.length;n++)(r=a.getCommand(e[n],S.getCommandContext()))||(r=a.getCommandCheckHeader(e[n],S.getCommandContext())),r&&(t?r.enable():r.disable())},this._onContextualMenuReadyCB=function(e,a){var l=[];if(u&&u.getActiveState())return{cmdList:l};var i=C.getReviewContext({context:S}),s=t.get(),d=!S.getViewer().get2DMode(),c=n.getManager({name:"DMUUserExperienceManager",context:S.getFrameWindow()}),m={x:a.XmousePositionWithDevPxRatio,y:a.YmousePositionWithDevPxRatio};if(0===(c?c.pick(m,"mesh"):S.getViewer().pick({xPix:m.x,yPix:m.y},"mesh",!0).path).length){var p=r.get(),h=p&&p[0]&&p[0].pathElement?p[0].pathElement.getLastElement(!0):null,D=h&&h.getDMUType?h.getDMUType():"";if("DMUSlide"===D||"DMUFormat"===D||"DMUComment"===D||"DMUMarkup"===D||"DMUValidationExposedPresentation"===D||"DMUValidationCheck"===D||"Checks"===D||"Highlights"===D)return{cmdList:l};l=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:!g.isMobile()&&d?["VisuQMCommand","PAD3DToggleStatusBarHdr"]:["PAD3DToggleStatusBarHdr"]},{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]}else if(s.length){var f=i?i.getCurrentSessionMarkup():null,M=!1,U=!1,P=!1,v=f&&!f.isReadOnly()&&f.isVisible();for(let e=0;e<s.length;e++){if(f&&!f.isReadOnly()&&f.isVisible()){var b=f.getOrCreateOccurrenceOverloader(s[e]);if(!M)if(b&&b.isOverloadedInCurrentSlide())M=!0;else{let t=s[e].pathElement.clone();t.getParentPath()&&o.isInstance(t.getParentPath().getLastElement(!0))&&(b=f.getOrCreateOccurrenceOverloader({pathElement:t.getParentPath()}))&&b.isOverloadedInCurrentSlide()&&(M=!0)}}for(var A=!0,V=0;V<s[e].pathElement.externalPath.length;V++)s[e].pathElement.externalPath[V].getDMUType&&(U=!0,A=!1);A&&(P=!0)}var y=!1;if(c&&(y=c.areOccurenceOverloadsCopied()),M&&(l=l.concat([{line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}])),P&&y&&(l=l.concat([{line:1,name:"DMUPasteStr",hdr_list:["DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["DMUPasteSpecialHdr"]}])),!U){let e=!S.getController().isRootSupported||s.length>=1&&s[0].pathElement.externalPath.length>=2&&S.getController().isRootSupported(o.getNodeID(s[0].pathElement.externalPath[1]));if(d&&e&&l.push({line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]}),l.push({line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]}),v&&d&&e){var I=!1;let e,t;for(let r=0;r<s.length;r++){for(e=s[r].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if((t=o.getLastReference(e))&&o.isReference(t.getLastElement(!0))){I=!0;break}}t&&t.externalPath.length<=2&&(I=!1),I&&l.push({line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]})}l.push({line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]}),d&&e&&l.push({line:1,name:"PAD3DViewerToggleGeometrySection",resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DToggleSimplifiedHdr","PAD3DToggleAccurateHdr"]})}}return{cmdList:l}},this.highlightInitialization=function(e){e&&e.slide&&e.slide.addAssociatedHighlightData&&e.highlight&&e.slide.addAssociatedHighlightData({id:e.highlight.getPlmID(),rating:e.highlight.getRating(),hasIssue:Boolean(e.highlight._lIssuesIDs.length),hasImpactedChecks:Boolean((e.highlight.getAssociatedCheck()||[]).length)})}}})});