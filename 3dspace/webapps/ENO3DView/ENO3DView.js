define("DS/ENO3DView/mixins/ENO3DViewCommandStateManager",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADSession","DS/Selection/CSOManager"],function(e,t,i,n,o){"use strict";function s(){}return s.prototype._buildCommandsState=function(){return new Promise(e=>{0===this.getRoots().length&&this._removeRootUpdateCommands(),this._geometryQualityavailableForRole=!1,this._setGeometryQualityAvailabilityForRoles(),0===o.get().length&&this.disableCmd("ActionBar_Attributes"),o.onPostAdd(function(){this._updateCommandsForGeometryQuality(),this.getController()._isLargeDataSelected()?(this.disableCmd("ENO3DOpenAppCmd"),this.disableCmd("OpenWithCatiaAction"),this.disableCmd("OpenWithFinderAction"),this.disableCmd("OpenWithMarkupAction")):(this.enableCmd("ENO3DOpenAppCmd"),this.enableCmd("OpenWithCatiaAction"),this.enableCmd("OpenWithFinderAction"),this.enableCmd("OpenWithMarkupAction"))}.bind(this)),o.onEmpty(function(){this._updateCommandsForGeometryQuality(),this.disableCmd("ENO3DOpenAppCmd"),this.disableCmd("OpenWithCatiaAction"),this.disableCmd("OpenWithFinderAction"),this.disableCmd("OpenWithMarkupAction")}.bind(this)),o.onRemove(function(){this._updateCommandsForGeometryQuality(),this.getController()._isLargeDataSelected()?(this.disableCmd("ENO3DOpenAppCmd"),this.disableCmd("OpenWithCatiaAction"),this.disableCmd("OpenWithFinderAction"),this.disableCmd("OpenWithMarkupAction")):(this.enableCmd("ENO3DOpenAppCmd"),this.enableCmd("OpenWithCatiaAction"),this.enableCmd("OpenWithFinderAction"),this.enableCmd("OpenWithMarkupAction"))}.bind(this)),this.getController()._isLargeDataSelected()?(this.disableCmd("ENO3DOpenAppCmd"),this.disableCmd("OpenWithCatiaAction"),this.disableCmd("OpenWithFinderAction"),this.disableCmd("OpenWithMarkupAction")):(this.enableCmd("ENO3DOpenAppCmd"),this.enableCmd("OpenWithCatiaAction"),this.enableCmd("OpenWithFinderAction"),this.enableCmd("OpenWithMarkupAction")),n.subscribe({event:"authoringStateModified"},e=>{this._updateCommandsForAuthoring(e.authored),this._updateCommandsForGeometryQuality()}),this.subscribe({event:"onStreamSwitched"},()=>{this._updateCommandsForGeometryQuality()}),this._updateCommandsForGeometryQuality(),e()})},s.prototype._addRootUpdateCommands=function(){this.enableCmd("ENO3DCleanViewCmd"),this.enableCmd("ENO3DVolumeQueryCmd"),this.enableCmd("ENO3DDefineFilterCmd"),this._updateCommandsForSupportedRoot()},s.prototype._removeRootUpdateCommands=function(){this.getController().getNbRoots()||this.getController().getHiddenRootIds().length||(this.disableCmd("ENO3DCleanViewCmd"),this.disableCmd("ENO3DVolumeQueryCmd"),this.disableCmd("ENO3DDefineFilterCmd")),this._updateCommandsForSupportedRoot()},s.prototype._updateCommandsForSupportedRoot=function(){const t=this.getRoots();let i=!1,n=0,o=0;for(let a=0;a<t.length;++a){var s=e.getNodeID(t[a]);this.getController().isRootSupported(s)&&(i=!0),e.isTileSetNode(t[a])&&this.getController().getRootStats(s)&&"r2vsurvey"===this.getController().getRootStats(s).serviceId&&(o++,!0===this.getController().has360(s)&&n++)}if(i?(this.enableCmd("ENO3DRevealDocumentsCmd"),this.enableCmd("ENO3DRelationalNavigatorCmd"),this.enableCmd("ENO3DVolumeQueryCmd"),this.enableCmd("ENO3DDefineFilterCmd")):(this.disableCmd("ENO3DRevealDocumentsCmd"),this.disableCmd("ENO3DRelationalNavigatorCmd"),this.disableCmd("ENO3DVolumeQueryCmd"),this.disableCmd("ENO3DDefineFilterCmd")),o>=0)if(1===o&&1===n){var a=null===window.localStorage.getItem("SoITimeline360ModeState")||JSON.parse(window.localStorage.getItem("SoITimeline360ModeState"));!this.getViewer().get360Mode()&&a&&(this._applyPhoto360FromCmd({action:!0}),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DPhoto360ModeAuto",eventValue:"ON"}),t.trackPageEvent()})),this.enableCheck("ENO3DTogglePhoto360ModeChk")}else this.getViewer().get360Mode()&&(this._applyPhoto360FromCmd({action:!1}),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DPhoto360ModeAuto",eventValue:"OFF"}),t.trackPageEvent()})),this.disableCheck("ENO3DTogglePhoto360ModeChk")},s.prototype._updateCommandsForAuthoring=function(e){!0===e?this.disableCmd("ENO3DDefineFilterCmd"):this.enableCmd("ENO3DDefineFilterCmd")},s.prototype._updateCommandsForGeometryQuality=function(){var t=o.get(),i=t.length,n=this._getAllLeavesForGeometryQuality(t,2);if(0===n.length)return this.disableCmd("OptimizedQualityCmd"),void this.disableCmd("HighQualityCmd");if(this._isGeometryQualityAvailable("optimized"))if(0===i)this.disableCmd("OptimizedQualityCmd");else if(1===i){if(1===n.length)if(s=this.getController().getNode({id:n[0]}))"thumbnail"===e.getLoadedStream(s,this)?this.disableCmd("OptimizedQualityCmd"):this.enableCmd("OptimizedQualityCmd");else this.disableCmd("OptimizedQualityCmd");else this.enableCmd("OptimizedQualityCmd")}else this.enableCmd("OptimizedQualityCmd");else this.disableCmd("OptimizedQualityCmd");if(this._isGeometryQualityAvailable("high"))if(0===i)this.disableCmd("HighQualityCmd");else if(1===i){var s;if(1===n.length)if(s=this.getController().getNode({id:n[0]}))"cgr"===e.getLoadedStream(s,this)?this.disableCmd("HighQualityCmd"):this.enableCmd("HighQualityCmd");else this.disableCmd("HighQualityCmd");else this.enableCmd("HighQualityCmd")}else this.enableCmd("HighQualityCmd");else this.disableCmd("HighQualityCmd")},s.prototype._setGeometryQualityAvailabilityForRoles=function(){t.isCloud()?(t.getVISnVIOStatus(e=>{e.hasLicense?(this._geometryQualityavailableForRole=!0,this._updateCommandsForGeometryQuality()):t.getGrantedRoles(e=>{this._geometryQualityavailableForRole=!1;for(var i=0;i<e.length;i++)if("InternalDS"===e[i].id&&(!e[i].platforms||e[i].platforms&&e[i].platforms.indexOf(t.getPlatformId())>-1)){this._geometryQualityavailableForRole=!0;break}this._updateCommandsForGeometryQuality()})}),this._VISnVIORetrievedToken=this.subscribe({event:"VISnVIOStatusRetrieved"},this._checkGeometryQualityAvailabilityForRoles.bind(this))):(this._geometryQualityavailableForRole=!0,this._updateCommandsForGeometryQuality())},s.prototype._checkGeometryQualityAvailabilityForRoles=function(){if(i.getSetting("enopad3dviewer_VISnVIOStatus"))this._geometryQualityavailableForRole=!0;else{const e=i.getSetting("enopad3dviewer_roles");this._geometryQualityavailableForRole=!1;for(let i=0;i<e.length;++i)if("InternalDS"===e[i].id&&(!e[i].platforms||e[i].platforms&&e[i].platforms.indexOf(t.getPlatformId())>-1)){this._geometryQualityavailableForRole=!0;break}}this._updateCommandsForGeometryQuality()},s.prototype._isGeometryQualityAvailable=function(e){return("optimized"!==e||!n.determineAuthoredFlag())&&this._geometryQualityavailableForRole},s.prototype._getAllLeavesForGeometryQuality=function(t,i){var n={};function o(t){if(e.is3DLeaf(t)){var i=e.getNodeID(t);n[i]||(n[i]=!0)}}for(var s=0;s<t.length;s++){var a=t[s].pathElement;if(e.isAModelPath(a)){var r=a.getLastElement(!0);if(e.is3DLeaf(r)){var l=e.getNodeID(r);n[l]||(n[l]=!0)}else if(e.isPLMNode(r))r.traverse(o);else{for(;!e.is3DLeaf(r)&&"RootBag"!==r.name;)r=(a=a.getParentPath()).getLastElement(!0);l=e.getNodeID(r);n[l]||(n[l]=!0)}}if(void 0!==i&&Object.keys(n).length>=i)break}return Object.keys(n)},s}),define("DS/ENO3DView/mixins/ENO3DViewStatusBar",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/Selection/CSOManager"],function(e,t,i,n){"use strict";function o(){}return o.prototype.createStatusBar=async function(e,i){this._DEBUG&&console.log("ENO3DViewStatusBar.createStatusBar called");const n=await this.loadSource("DS/PADUtils/views/PADStatusBar"),o=await this.loadSource("DS/PADServices/settings/AppSettings");this.elements.padstatusbar=new n({renderTo:this.getWafrUIFrame()._privateGetStatusBarWrapper(),withLoader:!0,sgiActivation:o.getSetting("activateSGI"),perfoDebug:!0===t.getSetting("enopad3dviewer_debugvisucommand"),onPlay:this._onStatusBarPlay.bind(this),onPause:this._onStatusBarPause.bind(this),onPerfoClicked:this._onStatusBarPerfoClicked.bind(this),onDragEvent:this._onStatusBarDragEvent.bind(this),onSetStartupViewClicked:this._onSetStartupViewClicked.bind(this),onWidgetLinkOptionsClicked:this._openWLOptionsPanel.bind(this),onToggleSGI:this.__toggleSGI.bind(this)}),this._initStatusBarState(),e()},o.prototype._onStatusBarPlay=function(){this.getController().resumeProgressiveLoading(),this.getStatusBar()&&this.getStatusBar().restorePreviousLabel()},o.prototype._onStatusBarPause=function(){this.getController().pauseProgressiveLoading(),(this.getController().getRoots().length>0||this._checkHiddenRoots())&&this.getStatusBar()&&this.getStatusBar().pauseProgresslabel()},o.prototype._onStatusBarPerfoClicked=async function(){(new(await this.loadSource("DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd"))).execute()},o.prototype._onStatusBarDragEvent=function(e){const t=this._buildDragDataFromCSO(n.get());e.dataTransfer.setData("Text",JSON.stringify(t))},o.prototype._buildDragDataFromCSO=function(n){this._DEBUG&&console.log("ENO3DViewStatusBar._buildDragDataFromCSO called with",n);const o={protocol:"3DXContent",version:"1.1",source:i.getAppId(),widgetId:i.getWidgetId(),data:{items:[]}};for(let s=0;s<n.length;++s)if(e.isAModelPath(n[s].pathElement)){const a=this.streamPath(n[s].pathElement),r=this.getController().getNode({id:a[a.length-1]}),l=[];for(let t=0;t<a.length;++t){const i=this.getController().getNode({id:a[t]});l.push({resourceid:a[t],type:e.getNodeType(i)})}o.data.items.push({envId:i.getPlatformId(),serviceId:"3DSpace",contextId:t.getSetting("pad_security_ctx")?t.getSetting("pad_security_ctx"):void 0,objectId:e.getNodeID(r),objectType:e.getNodeType(r),path:l})}const s=this.getController().getShareFilterSpec(o.data);return s.roots&&s.roots.length>0&&(o.biProxyCtx=s),o},o.prototype._initStatusBarState=function(){this._DEBUG&&console.log("ENO3DViewStatusBar._initStatusBarState called");let e=!0;null===window.localStorage.getItem("ENO3DViewStatusBarExpandState")?t.getSetting("enopad3dviewer_defaultStatusBarVisibility")?e=t.getSetting("enopad3dviewer_defaultStatusBarVisibility"):window.localStorage.setItem("ENO3DViewStatusBarExpandState",!0):(e="true"===window.localStorage.getItem("ENO3DViewStatusBarExpandState"))||this.displayStatusBar(!1),this.getCommandHandler().isCheckExecutable&&!0===this.getCommandHandler().isCheckExecutable("ENO3DToggleStatusBarCmd")&&this.getCommandHandler().setCheckState({id:"ENO3DToggleStatusBarCmd",state:e})},o.prototype._displayStatusBar=function(e){this._DEBUG&&console.log("ENO3DViewStatusBar._displayStatusBar called"),!0===e?this.getStatusBar()&&(this.getStatusBar().open(),this.getWafrUIFrame()._privateSetStatusBarWrapperVisibility(!0),window.localStorage.setItem("ENO3DViewStatusBarExpandState",!0)):this.getStatusBar()&&(this.getStatusBar().close(),this.getWafrUIFrame()._privateSetStatusBarWrapperVisibility(!1),window.localStorage.setItem("ENO3DViewStatusBarExpandState",!1))},o.prototype.displayStatusBar=function(e){this._DEBUG&&console.log("ENO3DViewStatusBar.displayStatusBar called"),this._displayStatusBar(e)},o.prototype.__toggleSGI=async function(){let e=require("DS/PADServices/settings/AppSettings"),t=require("DS/PADServices/ws/WSAccess"),i=!e.getSetting("redirectQueryToSGI");await t.setMePreferences({repositories:[{name:"ProductExplorerRepository",preferences:[{name:"ENOSCEN_SGI_REDIRECT",value:""+i}]}]}),e.setSetting("redirectQueryToSGI",i),this.elements.padstatusbar.updateSGIActivationStatus(i)},o.prototype.updateSGIActivationStatus=function(e){this.elements.padstatusbar.updateSGIActivationStatus(e)},o}),define("DS/ENO3DView/views/PADLayerPointCloudElevationView",["DS/TreeModel/TreeDocument","i18n!DS/ENO3DView/assets/nls/ENO3DView","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils","DS/PADServices/utils/GlobalModelEvents","DS/Controls/ColorPicker","DS/Controls/Slider","DS/Controls/ComboBox","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/Controls/TooltipModel"],function(e,t,i,n,o,s,a,r,l,h){"use strict";function d(e){this.options=e||{},this.elements={},this._nbChildren=1,this._elementSize=150,this._tokensXSO=[],this._minBbox=null,this._maxBbox=null,this._mdlEvts=new i,this._axis="z",this._currentUnit={nls:"mm",unit:"Millimeter"},this._buildContent()}function c(e,t){for(var i="",n=0;n<3;n++){var o=e.substring(2*n,2+2*n),s=t.substring(2*n,2+2*n),a=parseInt(o,16),r=parseInt(s,16);i+=("0"+Math.floor(a+.5*(r-a)).toString(16).toUpperCase()).slice(-2)}return i}return d.prototype.getHeader=function(){return t.pointCloudElevationLayer.title},d.prototype.getIcon=function(){return{iconPath:n.getWebappsAssetUrl("ENO3DCommands","icons/32/I_ENO3DPointCloudElevationCmd.png")}},d.prototype.render=function(){return this.elements.container},d.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var n=0;n<t.length;++n){var o=t[n];o.options.layerId&&o.options.layerId===e.options.layerId&&null===i&&(i=n)}if(i>=0)return i}},d.prototype._onSelectLayer=function(e){this.elements.container.classList.remove("pointCloudStyling-unfocused"),this.elements.container.classList.add("pointCloudStyling-focused"),this.options.model.getXSO().isEmpty()&&(this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:this.options.model.getChildren()[0],xso:this.options.model.getXSO()}}),this.options.model.getXSO().add(this.options.model.getChildren()[0]),o.publish({event:"ENXDISC_AP/PointCloudStyling/SelectLayer",data:{kind:"elevation",fromLayerPanel:!0===e}}))},d.prototype._buildContent=function(){this._minColor="00f1ff",this._maxColor="ff0000",this.middleColor=c(this._minColor,this._maxColor),this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container"),this.elements.container.classList.add("pointCloudElevation-layers-view"),this.elements.container.classList.add("pointCloudStyling-unfocused"),this.elements.container.addEventListener("click",this._onSelectLayer.bind(this)),this.options.model=new e,this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this.options.model.getXSO().empty(),this.elements.container.classList.contains("pointCloudStyling-focused")&&(this.elements.container.classList.remove("pointCloudStyling-focused"),this.elements.container.classList.add("pointCloudStyling-unfocused")),this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this.options.model.getXSO().empty(),this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this.elements.comboContainer=document.createElement("div"),this.elements.comboContainer.classList.add("pointCloudElevation-comboContainer"),this.elements.container.appendChild(this.elements.comboContainer),this.elements.comboLabel=document.createElement("p"),this.elements.comboLabel.innerHTML=t.pointCloudElevationLayer.comboLabel,this.elements.comboContainer.appendChild(this.elements.comboLabel),this.elements.axisCombo=new r({elementsList:[{label:"X",value:"x"},{label:"Y",value:"y"},{label:"Z",value:"z"}],selectedIndex:2,domId:"pointCloudElevation-comboContainer"}),this.elements.axisCombo.inject(this.elements.comboContainer),this.elements.axisCombo.addEventListener("change",function(){o.publish({event:"ENXDISC_AP/PointCloudStyling/ChangeElevationParameters",data:{axis:this.elements.axisCombo.value}}),this._axis=this.elements.axisCombo.value,this.resetSlider()}.bind(this)),this.elements.axisHelp=UWA.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question elevation-axis-tooltip"}),this.elements.axisHelp.tooltipInfos=new h({shortHelp:t.pointCloudElevationLayer.tooltip}),this.elements.comboContainer.appendChild(this.elements.axisHelp),this.elements.minMaxGraduationContainer=document.createElement("div"),this.elements.minMaxGraduationContainer.classList.add("pointCloudElevation-minMaxGraduationContainer"),this.elements.container.appendChild(this.elements.minMaxGraduationContainer),this.elements.minMaxGraduation=document.createElement("div"),this.elements.minMaxGraduation.classList.add("pointCloudElevation-minMaxGraduation"),this.elements.minMaxGraduationContainer.appendChild(this.elements.minMaxGraduation),this.elements.minGraduationText=document.createElement("p"),this.elements.minGraduationText.classList.add("pointCloudElevation-graduationText"),this.elements.minMaxGraduation.appendChild(this.elements.minGraduationText),this.elements.maxGraduationText=document.createElement("p"),this.elements.maxGraduationText.classList.add("pointCloudElevation-graduationText"),this.elements.minMaxGraduation.appendChild(this.elements.maxGraduationText),this.elements.graduation=document.createElement("table"),this.elements.graduation.classList.add("pointCloudElevation-table");for(let e=0;e<10;e++){let e=document.createElement("td");e.classList.add("pointCloudElevation-gradientGraduation"),this.elements.graduation.appendChild(e)}this.elements.container.appendChild(this.elements.graduation),this.elements.gradient=document.createElement("div"),this.elements.gradient.classList.add("pointCloudElevation-gradient"),this.elements.container.appendChild(this.elements.gradient),this.elements.colorChooserContainer=document.createElement("div"),this.elements.colorChooserContainer.classList.add("pointCloudElevation-colorChooserContainer"),this.elements.container.appendChild(this.elements.colorChooserContainer),this.elements.minColorPicker=new s({value:"00f1ff"}),this.elements.minColorPicker.getContent().addClassName("pointCloudElevation-minColorPicker"),this.elements.colorChooserContainer.appendChild(this.elements.minColorPicker.getContent()),this.elements.maxColorPicker=new s({value:"ff0000"}),this.elements.maxColorPicker.getContent().addClassName("pointCloudElevation-maxColorPicker"),this.elements.colorChooserContainer.appendChild(this.elements.maxColorPicker.getContent()),this.elements.minColorPicker.addEventListener("change",function(e){this._minColor=e.dsModel.value,this._onColorPickerChange("min")}.bind(this)),this.elements.maxColorPicker.addEventListener("change",function(e){this._maxColor=e.dsModel.value,this._onColorPickerChange("max")}.bind(this)),o.subscribe({event:"ENXDISC_AP/PointCloudStyling/GetBoundingBox"},this._updateBoundingBox.bind(this)),this._loadMePreferences().then(function(){o.publish({event:"ENXDISC_AP/PointCloudStyling/GetBoundingBox",data:{get:!0}})}.bind(this))},d.prototype._updateBoundingBox=function(e){if(e.min&&e.max){this._minBbox=e.min,this._maxBbox=e.max,this._minCursorValue=this._minBbox[this._axis],this._middleCursorValue=(this._minBbox[this._axis]+this._maxBbox[this._axis])/2,this._maxCursorValue=this._maxBbox[this._axis],this._percentageMin=0,this._localPercentageMiddle=50,this._globalPercentageMiddle=50,this._percentageMax=100,this.elements.gradient.style.background="linear-gradient(90deg, #"+this._minColor+" "+this._percentageMin+"%, #"+this._middleColor+" "+this._globalPercentageMiddle+"%, #"+this._maxColor+" "+this._percentageMax+"%)",this.elements.minGraduationText.innerHTML=""+Math.round(l.convert(this._minCursorValue,"length","mm",this._currentUnit.unit))+this._currentUnit.nls,this.elements.maxGraduationText.innerHTML=""+Math.round(l.convert(this._maxCursorValue,"length","mm",this._currentUnit.unit))+this._currentUnit.nls;let t=this.elements.minMaxGraduation.clientWidth,i=t*(this._percentageMin/100),n=t*(this._percentageMax/100),o=i-this.elements.minGraduationText.clientWidth/2,s=n+this.elements.maxGraduationText.clientWidth/2;this.elements.minGraduationText.style["margin-left"]=o>=0?"-"+this.elements.minGraduationText.clientWidth/2+"px":"-"+i+"px",this.elements.maxGraduationText.style["margin-right"]=s<t?"-"+this.elements.maxGraduationText.clientWidth/2+"px":"-"+(t-n)+"px",this.elements.minColorPicker.getContent().style.left=this._percentageMin+"%",this.elements.maxColorPicker.getContent().style.right="100"-this._percentageMax+"%",this.elements.minMaxGraduation.style["margin-left"]=this._percentageMin+"%",this.elements.minMaxGraduation.style["margin-right"]="100"-this._percentageMax+"%",this.elements.boundarySlider&&(this.elements.container.removeChild(this.elements.boundarySlider.getContent()),delete this.elements.boundarySlider),this.elements.boundarySlider=new a({value:[this._minCursorValue,this._middleCursorValue,this._maxCursorValue],minValue:this._minCursorValue,maxValue:this._maxCursorValue,valuePopupFlag:!1,stepValue:1,sliderButtonStyle:"accurate",domId:"pointCloudElevation-slider"}),this.elements.container.insertBefore(this.elements.boundarySlider.getContent(),this.elements.colorChooserContainer),this.elements.boundarySlider.getContent().addEventListener("endEdit",this._onSliderEndEdit.bind(this)),this.elements.boundarySlider.getContent().addEventListener("change",this._onSliderChange.bind(this))}},d.prototype._onSliderEndEdit=function(e){let t=this._maxBbox[this._axis]-this._minBbox[this._axis],i=e.dsModel.value;i=i.map(e=>(e-this._minBbox[this._axis])/t),o.publish({event:"ENXDISC_AP/PointCloudStyling/ChangeElevationParameters",data:{boundaries:i}})},d.prototype._onSliderChange=function(e){let t=e.dsModel.value[0]!==this._minCursorValue,i=e.dsModel.value[1]!==this._middleCursorValue,n=e.dsModel.value[2]!==this._maxCursorValue;this._minCursorValue=e.dsModel.value[0],this._middleCursorValue=(e.dsModel.value[0]+e.dsModel.value[2])/2,this._maxCursorValue=e.dsModel.value[2],t||n?e.dsModel.value[1]=e.dsModel.value[0]+(e.dsModel.value[2]-e.dsModel.value[0])*(this._localPercentageMiddle/100):i&&(this._localPercentageMiddle=(e.dsModel.value[1]-this._minBbox[this._axis])/(this._maxBbox[this._axis]-this._minBbox[this._axis])*100);let o=this._maxBbox[this._axis]-this._minBbox[this._axis];this._percentageMin=100*(e.dsModel.value[0]-this._minBbox[this._axis])/o,this._percentageMax=100*(e.dsModel.value[2]-this._minBbox[this._axis])/o,this._globalPercentageMiddle=100*(e.dsModel.value[1]-this._minBbox[this._axis])/o,this._middleColor=c(this._minColor,this._maxColor),this.elements.gradient.style.background="linear-gradient(90deg, #"+this._minColor+" "+this._percentageMin+"%, #"+this._middleColor+" "+this._globalPercentageMiddle+"%, #"+this._maxColor+" "+this._percentageMax+"%)",this.elements.minColorPicker.getContent().style.left=this._percentageMin+"%",this.elements.maxColorPicker.getContent().style.right="100"-this._percentageMax+"%",this.elements.minMaxGraduation.style["margin-left"]=this._percentageMin+"%",this.elements.minMaxGraduation.style["margin-right"]="100"-this._percentageMax+"%",this.elements.minGraduationText.innerHTML=""+Math.round(l.convert(this._minCursorValue,"length","mm",this._currentUnit.unit))+this._currentUnit.nls,this.elements.maxGraduationText.innerHTML=""+Math.round(l.convert(this._maxCursorValue,"length","mm",this._currentUnit.unit))+this._currentUnit.nls;let s=this.elements.minMaxGraduation.clientWidth,a=s*(this._percentageMin/100),r=s*(this._percentageMax/100),h=a-this.elements.minGraduationText.clientWidth/2,d=r+this.elements.maxGraduationText.clientWidth/2;this.elements.minGraduationText.style["margin-left"]=h>=0?"-"+this.elements.minGraduationText.clientWidth/2+"px":"-"+a+"px",this.elements.maxGraduationText.style["margin-right"]=d<s?"-"+this.elements.maxGraduationText.clientWidth/2+"px":"-"+(s-r)+"px"},d.prototype._onColorPickerChange=function(e){let t;this._middleColor=c(this._minColor,this._maxColor),this.elements.gradient.style.background="linear-gradient(90deg, #"+this._minColor+" "+this._percentageMin+"%, #"+this._middleColor+" "+this._globalPercentageMiddle+"%, #"+this._maxColor+" "+this._percentageMax+"%)",t="min"===e?{min:this._minColor,middle:this._middleColor}:{middle:this._middleColor,max:this._maxColor},o.publish({event:"ENXDISC_AP/PointCloudStyling/ChangeElevationParameters",data:{colors:t}})},d.prototype.selectItemIdx=function(e){this._onSelectLayer(!0)},d.prototype.addChild=function(e){this._nbChildren=1,e.options.onlyKind=!0,this.options.model.addChild(e)},d.prototype.removeChildren=function(){this._nbChildren=0,this.options.model.empty(),this.options.model.getXSO().empty(),this.elements.container.classList.remove("pointCloudStyling-focused"),this.elements.container.classList.add("pointCloudStyling-unfocused"),this._minColor="00f1ff",this._middleColor=c("00f1ff","ff0000"),this._maxColor="ff0000",this.elements.axisCombo.value="z",this.elements.gradient.style.background="linear-gradient(90deg, #00f1ff 0%, #ff0000 100%)",this.elements.minColorPicker.value="00f1ff",this.elements.maxColorPicker.value="ff0000",this.resetSlider(),this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:d.layerName}}),o.publish({event:"ENXDISC_AP/PointCloudStyling/RemoveStyling",data:{kind:"elevation"}})},d.prototype.getModelEvents=function(){return this._mdlEvts},d.prototype._loadMePreferences=function(){return new Promise(function(e,t){l.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay"]}]).then(function(t){t.repositories.length&&t.repositories[0].preferences&&t.repositories[0].preferences.length&&(this._currentUnit={nls:(e=>l.Length&&l.Length[e]&&l.Length[e].symbol?l.Length[e].symbol:"mm")(t.repositories[0].preferences[0].value),unit:t.repositories[0].preferences[0].value},this._decimalRO=t.repositories[0].preferences[1].value),e()}.bind(this)).catch(t)}.bind(this))},d.prototype.resetSlider=function(){this._minCursorValue=this._minBbox[this._axis],this._middleCursorValue=(this._minBbox[this._axis]+this._maxBbox[this._axis])/2,this._maxCursorValue=this._maxBbox[this._axis],this.elements.minGraduationText.innerHTML=""+Math.round(l.convert(this._minCursorValue,"length","mm",this._currentUnit.unit))+this._currentUnit.nls,this.elements.maxGraduationText.innerHTML=""+Math.round(l.convert(this._maxCursorValue,"length","mm",this._currentUnit.unit))+this._currentUnit.nls,this.elements.boundarySlider.minValue=this._minCursorValue,this.elements.boundarySlider.maxValue=this._maxCursorValue,this.elements.boundarySlider.value=[this._minCursorValue,this._middleCursorValue,this._maxCursorValue],this._percentageMin=0,this._localPercentageMiddle=50,this._globalPercentageMiddle=50,this._percentageMax=100},d.layerName="pointCloudElevation",d}),define("DS/ENO3DView/views/PADLayerPointCloudClassificationView",["DS/Utilities/UUID","DS/TreeModel/TreeDocument","DS/DataGridView/DataGridView","i18n!DS/ENO3DView/assets/nls/ENO3DView","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils","DS/TreeModel/TreeNodeModel","DS/Controls/ComboBox","DS/PADServices/utils/GlobalModelEvents","DS/Controls/TooltipModel"],function(e,t,i,n,o,s,a,r,l,h){"use strict";const d=[{label:"0 - Never Classified",children:null,grid:{"pointCloud:classif":"0","pointCloud:color":"b6b6b6","pointCloud:filter":!0}},{label:"1 - Unclassified",children:null,grid:{"pointCloud:classif":"1","pointCloud:color":"aaaaaa","pointCloud:filter":!0}},{label:"2 - Ground",children:null,grid:{"pointCloud:classif":"2","pointCloud:color":"aa5500","pointCloud:filter":!0},selected:!0},{label:"3 - Low Vegetation",children:null,grid:{"pointCloud:classif":"3","pointCloud:color":"00aaaa","pointCloud:filter":!0}},{label:"4 - Medium Vegetation",children:null,grid:{"pointCloud:classif":"4","pointCloud:color":"55ff55","pointCloud:filter":!0},selected:!0},{label:"5 - High Vegetation",children:null,grid:{"pointCloud:classif":"5","pointCloud:color":"00aa00","pointCloud:filter":!0}},{label:"6 - Building",children:null,grid:{"pointCloud:classif":"6","pointCloud:color":"ff5555","pointCloud:filter":!0}},{label:"7 - Low Point (Noise)",children:null,grid:{"pointCloud:classif":"7","pointCloud:color":"aa0000","pointCloud:filter":!0}},{label:"8 - Model Key/Reserved",children:null,grid:{"pointCloud:classif":"8","pointCloud:color":"555555","pointCloud:filter":!0}},{label:"9 - Water",children:null,grid:{"pointCloud:classif":"9","pointCloud:color":"55ffff","pointCloud:filter":!0}},{label:"10 - Rail",children:null,grid:{"pointCloud:classif":"10","pointCloud:color":"aa00aa","pointCloud:filter":!0}},{label:"11 - Road Surface",children:null,grid:{"pointCloud:classif":"11","pointCloud:color":"000000","pointCloud:filter":!0}},{label:"12 - Overlap/Reserved",children:null,grid:{"pointCloud:classif":"12","pointCloud:color":"555555","pointCloud:filter":!0}},{label:"13 - Wire–Guard (Shield)",children:null,grid:{"pointCloud:classif":"13","pointCloud:color":"ffff55","pointCloud:filter":!0}},{label:"14 - Wire–Conductor (Phase)",children:null,grid:{"pointCloud:classif":"14","pointCloud:color":"ffff55","pointCloud:filter":!0}},{label:"15 - Transmission Tower",children:null,grid:{"pointCloud:classif":"15","pointCloud:color":"ff55ff","pointCloud:filter":!0}},{label:"16 - Wire-Structure Connector",children:null,grid:{"pointCloud:classif":"16","pointCloud:color":"ffff55","pointCloud:filter":!0}},{label:"17 - Bridge Deck",children:null,grid:{"pointCloud:classif":"17","pointCloud:color":"5555ff","pointCloud:filter":!0}},{label:"18 - High Noise",children:null,grid:{"pointCloud:classif":"18","pointCloud:color":"646464","pointCloud:filter":!0}}];function c(e){this.options=e||{},this.elements={},this._nbChildren=21,this._elementSize=24,this._toolbarOffset=45,this._updatingRows=!1,this._updatingToolbar=!1,this._tokensXSO=[],this.options.columns=[{alignment:"center",dataIndex:"pointCloud:filter",width:"10px",typeRepresentation:"boolean",editableFlag:!0,sortableFlag:!1,resizableFlag:!1,visibleFlag:!0,editionPolicy:"EditionInPlace"},{dataIndex:"tree",text:"Label",visibleFlag:!0,selectableFlag:!1},{text:"Value",alignment:"center",dataIndex:"pointCloud:classif",typeRepresentation:"string",width:"60px",editableFlag:!1,sortableFlag:!1,resizableFlag:!1,visibleFlag:!1},{alignment:"center",dataIndex:"pointCloud:color",width:"10px",typeRepresentation:"color",editableFlag:!0,sortableFlag:!1,resizableFlag:!1,visibleFlag:!0,selectableFlag:!1,editionPolicy:"EditionInPlace"}],this.options.dgvOptions={columns:this.options.columns,defaultcolumndef:{typerepresentation:"string"},rowSelection:"single",columnSelection:"none",cellSelection:"none",cellActivationFeedback:"row",showRowBorderFlag:!1,showAlternateBackgroundFlag:!1,cellPreselectionFeedback:"none",layoutOptions:{cellHeight:this._elementSize,rowsHeader:!1,columnsHeader:!1},showBackgroundFlag:!1},this._mdlEvts=new o,this.elements.customHeader=UWA.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question eno-classification-colorization-tooltip"}),this.elements.customHeader.tooltipInfos=new h({shortHelp:n.pointCloudClassificationLayer.headerTooltip,moreHelpCB:function(){window.open("https://www.asprs.org/wp-content/uploads/2010/12/LAS_Specification.pdf","_blank")}}),this._buildContent()}return c.prototype.getHeader=function(){return n.pointCloudClassificationLayer.title},c.prototype.getIcon=function(){return{iconPath:s.getWebappsAssetUrl("ENO3DCommands","icons/32/I_ENO3DPointCloudClassificationCmd.png")}},c.prototype.getItemIdx=function(e){var t=this.options.model.getChildren(),i=null;if(t&&t.length>0){for(var n=0;n<t.length;++n){var o=t[n];o.options.layerId&&o.options.layerId===e.options.layerId&&null===i&&(i=n)}if(i>=0)return i}},c.prototype.render=function(){return this.elements.container},c.prototype._onSelectLayer=function(e){this.elements.container.classList.remove("pointCloudStyling-unfocused"),this.elements.container.classList.add("pointCloudStyling-focused"),this.options.model.getXSO().isEmpty()&&(this._mdlEvts.publish({event:"PAD3DLayer/xsoPreAdd",data:{selected:this.options.model.getChildren()[0],xso:this.options.model.getXSO()}}),this.options.model.getXSO().add(this.options.model.getChildren()[0]),l.publish({event:"ENXDISC_AP/PointCloudStyling/SelectLayer",data:{kind:"classification",fromLayerPanel:!0===e}}))},c.prototype._buildContent=function(){this.elements.container=document.createElement("div"),this.elements.container.classList.add("PAD3DLayerDefaultView-container"),this.elements.container.classList.add("pointCloudClassification-layers-view"),this.elements.container.classList.add("pointCloudStyling-unfocused"),this.elements.comboContainer=document.createElement("div"),this.elements.comboContainer.classList.add("PAD3DPointCloudClassificationComboContainer"),this.elements.container.appendChild(this.elements.comboContainer);let n=UWA.extend({identifier:"DataGridView-3DLayerDefault-"+e.v4()},this.options.dgvOptions),o=this.options.dgv=new i(n);this.options.classesModel=new t,this.options.model=new t,o.treeDocument=this.options.classesModel,this.elements.container.addEventListener("click",this._onSelectLayer.bind(this)),this._tokensXSO.push(this.options.model.getXSO().onPostRemove(function(e){this.options.model.getXSO().empty(),this.elements.container.classList.contains("pointCloudStyling-focused")&&(this.elements.container.classList.remove("pointCloudStyling-focused"),this.elements.container.classList.add("pointCloudStyling-unfocused")),this._mdlEvts.publish({event:"PAD3DLayer/xsoRemove",data:{selected:e,xso:this.options.model.getXSO()}})}.bind(this))),this._tokensXSO.push(this.options.model.getXSO().onEmpty(function(e){this.options.model.getXSO().empty(),this._mdlEvts.publish({event:"PAD3DLayer/xsoEmpty",data:{selected:e,xso:this.options.model.getXSO()}}),this.options.dgv.setActiveCell(-1)}.bind(this))),o.getContent().addClassName("PAD3DLayerDefaultView-dgv"),o.getContent().style.top="49px",this.elements.container.appendChild(o.getContent());let s={entries:[{id:"filterSelect",dataElements:{typeRepresentation:"boolean",value:!0,displayLabel:!1,position:"near",label:"Select/Unselect All"},onNodeUpdate:e=>{if(!this._updatingRows&&!this._updatingToolbar){let t=e.getAttributeValue("data"),i=this.options.classesModel.getChildren();this._updatingRows=!0;for(let e=0;e<i.length;e++){i[e].setAttribute("pointCloud:filter",t)}t?l.publish({event:"ENXDISC_AP/PointCloudStyling/ShowClasses",data:{all:!0}}):l.publish({event:"ENXDISC_AP/PointCloudStyling/HideClasses",data:{all:!0}}),this._updatingRows=!1}}},{id:"Label",dataElements:{typeRepresentation:"string",label:"All",displayLabel:!0,readOnly:!0}}],typeRepresentations:{}};this._toolbar=o.setToolbar(s),this.elements.comboContainer.appendChild(this._toolbar.getContent()),this.options.classesModel.onNodeModelUpdate(e=>{if(!this._updatingRows){let t=0,i=this.options.classesModel.getChildren();for(let e=0;e<i.length;e++)i[e].getAttributeValue("pointCloud:filter")&&t++;let n=o.getToolbar().getNodeModelByID("filterSelect").getAttributeValue("data");if(t===i.length?!0!==n&&(this._updatingToolbar=!0,o.getToolbar().updateNodeModel("filterSelect",{grid:{data:!0}}),this._updatingToolbar=!1):0===t?!1!==n&&(this._updatingToolbar=!0,o.getToolbar().updateNodeModel("filterSelect",{grid:{data:!1}}),this._updatingToolbar=!1):void 0!==n&&(this._updatingToolbar=!0,o.getToolbar().updateNodeModel("filterSelect",{grid:{data:void 0}}),this._updatingToolbar=!1),e.data.attributes.hasOwnProperty("pointCloud:color")){let t=e.data.attributes["pointCloud:color"],i=e.data.nodeModel.getAttributeValue("pointCloud:classif");l.publish({event:"ENXDISC_AP/PointCloudStyling/ChangeClassColor",data:{updatedClass:i,color:t}})}else if(e.data.attributes.hasOwnProperty("pointCloud:filter")){let t=e.data.attributes["pointCloud:filter"],i=parseInt(e.data.nodeModel.getAttributeValue("pointCloud:classif"));t?l.publish({event:"ENXDISC_AP/PointCloudStyling/ShowClasses",data:{addedClasses:[i]}}):l.publish({event:"ENXDISC_AP/PointCloudStyling/HideClasses",data:{removedClasses:[i]}})}}})},c.prototype.selectItemIdx=function(e){this._onSelectLayer(!0)},c.prototype.addChild=function(e){this._nbChildren=21,e.options.onlyKind=!0,this.options.model.addChild(e),this.options.classesModel.prepareUpdate(),this._classifNodes=JSON.parse(JSON.stringify(d)),this._classifNodes.forEach(e=>{let t=new a(e);this.options.classesModel.addChild(t)}),this.options.classesModel.pushUpdate()},c.prototype.removeChildren=function(){this._nbChildren=0,this.options.model.empty(),this.options.model.getXSO().empty(),this.options.classesModel.empty(),this.elements.container.classList.remove("pointCloudStyling-focused"),this.elements.container.classList.add("pointCloudStyling-unfocused"),this._mdlEvts.publish({event:"PAD3DLayer/removeLayer",data:{layerName:c.layerName}}),l.publish({event:"ENXDISC_AP/PointCloudStyling/RemoveStyling",data:{kind:"classification"}})},c.prototype.getModelEvents=function(){return this._mdlEvts},c.prototype.getCustomHeader=function(){return this.elements.customHeader},c.layerName="pointCloudClassification",c}),define("DS/ENO3DView/mixins/ENO3DViewManipulations",["DS/UIKIT/Modal"],function(e){"use strict";function t(){}return t.prototype.displayNotification=async function(e){this._DEBUG&&console.log("ENO3DViewManipulations.displayNotification called"),(await this.loadSource("DS/PADUtils/views/PADAlert")).displayNotification(e),this.getStatusBar()&&this.getStatusBar().setLatestNotification({notification:e})},t.prototype.toggleSidePanel=function(e){return this._DEBUG&&console.log("ENO3DViewManipulations.toggleSidePanel called"),new Promise((t,i)=>{"right"===e.side?"open"===e.action?(this.getTriptych()._modelEvents.publish({event:"triptych-show-panel",data:e.side}),t()):"close"===e.action?(this.getTriptych()._modelEvents.publish({event:"triptych-hide-panel",data:e.side}),t()):i("ENO3DViewManipulations.toggleSidePanel, invalid action value, must be open or close"):i("ENO3DViewManipulations.toggleSidePanel, invalid side value, must be left or right")})},t.prototype.toggleTimelineView=function(e){return this._DEBUG&&console.log("ENO3DViewManipulations.toggleTimelineView called"),new Promise((t,i)=>{this.toggleSOITimelinesVisibility(e.action),t()})},t.prototype.togglePhoto360Mode=function(e){return this._DEBUG&&console.log("ENO3DViewManipulations.togglePhoto360Mode called"),new Promise((t,i)=>{e.autoSwitch||window.localStorage.setItem("SoITimeline360ModeState",e.action),this._applyPhoto360FromCmd(e),!0===e.action?require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DPhoto360ModeON"}),t.trackPageEvent()}):require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DPhoto360ModeOFF"}),t.trackPageEvent()}),t()})},t.prototype.togglePointCloudMinimap=function(e){return this._DEBUG&&console.log("ENO3DViewManipulations.togglePointCloudMinimap called"),new Promise((t,i)=>{this._toggleMinimap(e.action),t()})},t.prototype.reframe=function(e){this._DEBUG&&console.log("ENO3DViewManipulations.reframe called"),this.getViewer().get360Mode()||(e?this.getViewpoint().reframe(null,void 0,e):this.getViewpoint().reframe())},t.prototype.reframeSelection=function(){this._DEBUG&&console.log("ENO3DViewManipulations.reframeSelection called"),this.getCommandProxy().reframeSelection()},t.prototype.addWidgetBorder=function(){this._DEBUG&&console.log("ENO3DViewManipulations.addWidgetBorder called"),!0===this.getOption("enableSidePanel")?this.elements.borderedLayout.addClassName("bordered"):this.elements.container.addClassName("bordered")},t.prototype.clearWidgetBorder=function(){this._DEBUG&&console.log("ENO3DViewManipulations.clearWidgetBorder called"),!0===this.getOption("enableSidePanel")?this.elements.borderedLayout.removeClassName("bordered"):this.elements.container.removeClassName("bordered")},t.prototype._enableUX=function(){this._DEBUG&&console.log("ENO3DViewManipulations._enableUX called"),this._blockUXCounter&&(this._blockUXCounter--,0===this._blockUXCounter&&this.getDOMElement("blockUX")&&(this.getDOMElement("blockUX").destroy&&this.getDOMElement("blockUX").destroy(),this.elements.blockUX={},this.publish({event:"ENO3DStopLockView"})))},t.prototype._disableUX=function(){this._DEBUG&&console.log("ENO3DViewManipulations._disableUX called"),this._blockUXCounter||(this._blockUXCounter=0),0===this._blockUXCounter&&(this.elements.blockUX=new e({className:"disableMainUX",closable:!1,body:"",visible:!0}),this.getDOMElement("blockUX").inject(document.body),this.publish({event:"ENO3DStartLockView"})),this._blockUXCounter++},t.prototype._showRootListPanel=function(){this._DEBUG&&console.log("ENO3DViewManipulations._showRootListPanel called"),this._rootListPanel.show(),this.getCommandHandler().setCheckState({id:"ToggleLeftSidePanel",state:!0})},t.prototype._hideRootListPanel=function(){this._DEBUG&&console.log("ENO3DViewManipulations._hideRootListPanel called"),this._rootListPanel.hide(),this.getCommandHandler().setCheckState({id:"ToggleLeftSidePanel",state:!1})},t.prototype.displayTree=function(){this._DEBUG&&console.log("ENO3DViewManipulations.displayTree called"),console.warn("DEPRECATED : This method relies on the frame window, which does not exists in Wafr v2 widget.")},t}),define("DS/ENO3DView/views/ENO3DMinimapCanvas",["css!DS/ENO3DView/ENO3DView.css","DS/Utilities/Dom","DS/PADServices/utils/GlobalModelEvents"],function(e,t,i){"use strict";const n="canvas";function o(e){this.options=e||{},this.elements={},this.options=Object.assign({positionUser:null,startAngle:0},this.options),this._localModelEvents=e.modelEvents,this.json={},this.images={},this.add=!1,this.drag=!1,this.rotate=!1,this.check=!1,this.onUser=!1,this.onSight=!1,this.onPoint=!1,this.zoomX=0,this.zoomY=0,this.ratiox=0,this.ratioy=0,this.user={id:"user",coord:{x:-1,y:-1,tempx:-1,tempy:-1,newx:-1,newy:-1},sight:{x:0,y:0},color:"#ffffff"},this.angle=this.options.startAngle,this.canva=t.createElement("canvas",{class:n+"-minimap"}),this.image=new Image,this.point_img=new Image;const i=this.canva.getContext("2d");this.__trackTransforms(i),this.__canvaFunctions()}return o.prototype.imageFullVisible=async function(){const e=this.canva.getContext("2d"),t=this.xOffset,i=this.yOffset,n=this.newWidth,o=this.newHeight;e.save(),e.translate(t+n/2,i+o/2),e.rotate(-this.angle*Math.PI/180),e.translate(-(t+n/2),-(i+o/2));const s=Math.round(((this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+((this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a),a=Math.round(((this.newWidth+this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+((this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a),r=Math.round(((this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+((this.newHeight+this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a),l=Math.round(((this.newWidth+this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+((this.newHeight+this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a),h=Math.round(-((this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+((this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a),d=Math.round(-((this.newWidth+this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+((this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a),c=Math.round(-((this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+((this.newHeight+this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a),p=Math.round(-((this.newWidth+this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(t+n/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+((this.newHeight+this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+(i+o/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a);return e.restore(),s>=0&&s<=this.canva.width&&a>=0&&a<=this.canva.width&&r>=0&&r<=this.canva.width&&l>=0&&l<=this.canva.width&&h>=0&&h<=this.canva.height&&d>=0&&d<=this.canva.height&&c>=0&&c<=this.canva.height&&p>=0&&p<=this.canva.height},o.prototype.__checkPosition=async function(){const e=this.canva.getContext("2d");if(0!=this.ratiox&&0!=this.ratioy&&!await this.imageFullVisible()){const t=this.canva.width/4,i=this.canva.height/4,n=this.xOffset,o=this.yOffset,s=this.newWidth,a=this.newHeight;e.translate(n+s/2,o+a/2),e.rotate(-this.angle*Math.PI/180),e.translate(-(n+s/2),-(o+a/2));const r=((this.user.coord.x/this.ratiox+this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(n+s/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+((this.user.coord.y/this.ratioy+this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(o+a/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+(n+s/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a,l=-((this.user.coord.x/this.ratiox+this.xOffset+e.getTransform().e/e.getTransform().a)*e.getTransform().a-(n+s/2+e.getTransform().e/e.getTransform().a)*e.getTransform().a)*Math.sin((360-this.angle)*Math.PI/180)+((this.user.coord.y/this.ratioy+this.yOffset+e.getTransform().f/e.getTransform().a)*e.getTransform().a-(o+a/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a)*Math.cos((360-this.angle)*Math.PI/180)+(o+a/2+e.getTransform().f/e.getTransform().a)*e.getTransform().a;r<t&&e.translate((t-r)/e.getTransform().a,0),r>this.canva.width-t&&e.translate((this.canva.width-t-r)/e.getTransform().a,0),l<i&&e.translate(0,(i-l)/e.getTransform().a),l>this.canva.height-i&&e.translate(0,(this.canva.height-i-l)/e.getTransform().a),e.translate(n+s/2,o+a/2),e.rotate(this.angle*Math.PI/180),e.translate(-(n+s/2),-(o+a/2))}},o.prototype.__draw=async function(){this.__drawImage(),this.newWidth&&(this.__drawPoints(),this.__drawUser())},o.prototype.__drawSight=async function(){const e=this.canva.getContext("2d"),t=this.__getNormTrans(),i=this.newWidth/100/(t.a/3);let n=Math.atan(this.user.sight.y/this.user.sight.x)*(180/Math.PI);n=this.user.sight.x>0?90+n:270+n,this.sightangle=n;const o=this.user.coord.x/this.ratiox+this.xOffset,s=this.user.coord.y/this.ratioy+this.yOffset;e.save(),e.translate(o,s),e.rotate(n*Math.PI/180),e.translate(-o,-s),this.sight=new Path2D;const a=6*i;e.globalAlpha=.6,e.beginPath(),this.sight.moveTo(o-a/6,s),this.sight.lineTo(o-a/6-Math.sin(Math.PI/6)*i*2,s-a+Math.cos(Math.PI/6)*i),this.sight.lineTo(o+a/6,s),this.sight.moveTo(o+a/6+Math.sin(Math.PI/6)*i*2,s-a+Math.cos(Math.PI/6)*i),this.sight.lineTo(o+a/6,s),this.sight.lineTo(o-a/6-Math.sin(Math.PI/6)*i*2,s-a+Math.cos(Math.PI/6)*i);const r=e.createLinearGradient(o,s-3*i,o,s-5*i);r.addColorStop(0,"#42A2DA"),r.addColorStop(1,"transparent"),e.fillStyle=r,e.fill(this.sight),e.restore()},o.prototype.__drawImage=async function(){const e=this.canva,t=this.canva.getContext("2d");if(t.save(),t.setTransform(1,0,0,1,0,0),t.fillStyle="#292929",t.fillRect(0,0,e.width,e.height),t.restore(),0!=this.image.height){const i=this.image.width/this.image.height;this.newWidth=e.width,this.newHeight=this.newWidth/i,this.newHeight>e.height&&(this.newHeight=e.height,this.newWidth=this.newHeight*i),this.xOffset=this.newWidth<e.width?(e.width-this.newWidth)/2:0,this.yOffset=this.newHeight<e.height?(e.height-this.newHeight)/2:0,this.ratiox=this.image.width/this.newWidth,this.ratioy=this.image.height/this.newHeight,t.drawImage(this.image,this.xOffset,this.yOffset,this.newWidth,this.newHeight)}},o.prototype.__drawUser=function(){const e=this.user.coord.x,t=this.user.coord.y,i=this.__getNormTrans();if(this.user.coord.x==this.user.coord.newx&&this.user.coord.y==this.user.coord.newy||-1==this.user.coord.newx)this.__drawSight(),this.__drawPointUser(e/this.ratiox+this.xOffset,t/this.ratioy+this.yOffset,this.newWidth/100/(i.a/3)),this.check=!0;else{const e=30;this.user.coord.x=this.user.coord.x+(this.user.coord.newx-this.user.coord.tempx)/e,this.user.coord.y=this.user.coord.y+(this.user.coord.newy-this.user.coord.tempy)/e,this.__drawSight(),this.__drawPointUser(this.user.coord.x/this.ratiox+this.xOffset,this.user.coord.y/this.ratioy+this.yOffset,this.newWidth/100/(i.a/3)),Math.abs(this.user.coord.x-this.user.coord.newx)<.01&&Math.abs(this.user.coord.y-this.user.coord.newy)<.01&&(this.user.coord.x=this.user.coord.newx,this.user.coord.y=this.user.coord.newy),this.check&&this.__checkPosition(),this.myTimeout=setTimeout(()=>{this.__draw()},500/e)}},o.prototype.__drawPointUser=async function(e,t,i){const n=this.canva.getContext("2d");this.pointUser=new Path2D,n.fillStyle=this.user.color,n.beginPath(),this.pointUser.arc(e,t,i,0,2*Math.PI,!0),n.fillStyle="#368EC4",n.fill(this.pointUser),n.strokeStyle="white",n.lineWidth=i/5,n.stroke(this.pointUser)},o.prototype.__drawPoints=async function(){const e=this.canva.getContext("2d"),t=this.__getNormTrans();for(let i=0,n=this.json.length;i<n;i++){const n=this.json[i].coord,o=n.x/this.ratiox+this.xOffset,s=n.y/this.ratioy+this.yOffset;e.fillStyle=this.json[i].color,e.save(),e.translate(o,s),e.rotate(-this.angle*Math.PI/180),e.translate(-o,-s),this.__drawPinPhotoInverted(o,s,this.newWidth/100/(t.a/3)),e.restore()}},o.prototype.__drawPin=async function(e,t,i){const n=this.canva.getContext("2d"),o=i/1.5,s=i/4.5,a=1.333*i;n.beginPath(),n.arc(e,t-a,o,0,2*Math.PI,!0),n.moveTo(e+s,t-a),n.arc(e,t-a,s,0,2*Math.PI,!0),n.fill("evenodd"),n.beginPath(),n.moveTo(e,t),n.lineTo(e-Math.sin(Math.PI/6)*o,t-a+Math.cos(Math.PI/6)*o),n.lineTo(e+Math.sin(Math.PI/6)*o,t-a+Math.cos(Math.PI/6)*o),n.fill()},o.prototype.__drawCamera=async function(e,t,i){const n=this.canva.getContext("2d"),o=2*i/6,s=2*i/15,a=2*i,r=2*i/1.5;n.beginPath(),n.rect(e-a/2,t-r/2,a,r),n.moveTo(e,t),n.arc(e,t,o,0,2*Math.PI,!1),n.moveTo(e+a/3,t-r/4),n.arc(e+a/3,t-r/4,s,0,2*Math.PI,!1),n.fill("evenodd"),n.beginPath(),n.rect(e-a/4,t-(r/2+r/8),a/2,r/8),n.fill()},o.prototype.__drawPinPhoto=async function(e,t,i){const n=this.canva.getContext("2d"),o=i/1.5,s=i/2.25,a=1.333*i;n.beginPath(),n.arc(e,t-a,o,0,2*Math.PI,!0),n.moveTo(e+s,t-a),n.arc(e,t-a,s,0,2*Math.PI,!0),n.fill("evenodd"),n.beginPath(),n.moveTo(e,t),n.lineTo(e-Math.sin(Math.PI/6)*o,t-a+Math.cos(Math.PI/6)*o),n.lineTo(e+Math.sin(Math.PI/6)*o,t-a+Math.cos(Math.PI/6)*o),n.fill(),this.__drawPhoto(e,t-a,i/4),n.strokeStyle=n.fillStyle,n.lineWidth=o/10,n.beginPath(),n.moveTo(e,t),n.lineTo(e,t-o),n.stroke()},o.prototype.__drawPinPhotoInverted=async function(e,t,i){const n=this.canva.getContext("2d"),o=i/1.5,s=1.333*i,a=n.fillStyle;n.beginPath(),n.arc(e,t-s,o,0,2*Math.PI,!0),n.fill(),n.beginPath(),n.fillStyle="white";const r=i/7.5,l=i/18.75,h=o,d=i/2.25;n.rect(e-h/2,t-s-d/2,h,d),n.moveTo(e,t),n.arc(e,t-s,r,0,2*Math.PI,!1),n.moveTo(e+h/3,t-s-d/4),n.arc(e+h/3,t-s-d/4,l,0,2*Math.PI,!1),n.rect(e-h/4,t-s-(d/2+d/8),h/2,d/8),n.fill("evenodd"),n.fillStyle=a,n.beginPath(),n.moveTo(e,t),n.lineTo(e-Math.sin(Math.PI/6)*o,t-s+Math.cos(Math.PI/6)*o),n.lineTo(e+Math.sin(Math.PI/6)*o,t-s+Math.cos(Math.PI/6)*o),n.fill()},o.prototype.__draw360=async function(e,t,i){const n=this.canva.getContext("2d"),o=i,s=Math.floor(o/1.6);n.strokeStyle=n.fillStyle,n.lineWidth=s/5,n.beginPath(),n.arc(e,t,o,0,2*Math.PI,!1),n.stroke(),n.moveTo(e,t+o),n.ellipse(e,t,o,o/3,Math.PI/2,0,1.6*Math.PI,!0),n.moveTo(e,t+o),n.ellipse(e,t,o,o/3,Math.PI/2,0,1.8*-Math.PI,!1),n.moveTo(e,t-o),n.ellipse(e,t,o,o/3,Math.PI/2,Math.PI,1.4*Math.PI,!1),n.moveTo(e,t-o),n.ellipse(e,t,o,o/3,Math.PI/2,Math.PI,.65*Math.PI,!0),n.stroke(),n.moveTo(e-o,t),n.ellipse(e,t,o,o/3,Math.PI,0,1.35*Math.PI),n.moveTo(e-o,t),n.ellipse(e,t,o,o/3,Math.PI,0,1.8*Math.PI,!0),n.stroke(),n.textAlign="center",n.font=`bolder ${s}px Arial`,n.fillText("360",e,t+s/3)},o.prototype.__drawCustomImg=async function(e,i,o){const s=this.canva.getContext("2d"),a=t.createElement("canvas",{class:n});a.width=1e3,a.height=1e3;const r=a.getContext("2d");r.drawImage(this.point_img,0,0,1e3,1e3),r.globalCompositeOperation="source-in",r.fillStyle=s.fillStyle,r.fillRect(0,0,this.canva.width,this.canva.height),s.drawImage(a,e-o,i-o,2*o,2*o)},o.prototype.__checkScale=async function(e){const t=await this.__getNormTrans();let i=0;return i=this.canva.height>this.canva.width?this.canva.width:this.canva.height,i/=Math.sqrt(Math.pow(this.newWidth,2)+Math.pow(this.newHeight,2)),t.a*e<i?e=i/t.a:t.a*e>100&&(e=100/t.a),e},o.prototype.__zoom=async function(e){const t=this.canva.getContext("2d");e=await this.__checkScale(e);const i=t.transformedPoint(this.zoomX,this.zoomY);t.translate(i.x,i.y),t.scale(e,e),t.translate(-i.x,-i.y),this.__draw()},o.prototype.__zoomUser=async function(e){const t=this.canva.getContext("2d");e=await this.__checkScale(e),t.translate(this.user.coord.x/this.ratiox+this.xOffset,this.user.coord.y/this.ratioy+this.yOffset),t.scale(e,e),t.translate(-(this.user.coord.x/this.ratiox+this.xOffset),-(this.user.coord.y/this.ratioy+this.yOffset)),await this.__checkPosition(),this.__draw()},o.prototype.__zoomFit=async function(){const e=this.canva.getContext("2d");e.setTransform(1,0,0,1,0,0),this.zoomX=0,this.zoomY=0,e.translate(this.xOffset+this.newWidth/2,this.yOffset+this.newHeight/2),e.rotate(this.angle*Math.PI/180),e.translate(-(this.xOffset+this.newWidth/2),-(this.yOffset+this.newHeight/2)),this.__draw()},o.prototype.__rotate=async function(e){const t=this.canva.getContext("2d");this.angle=this.angle+e,this.angle>360&&(this.angle=this.angle-360),t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canva.width,this.canva.height),t.restore(),t.translate(this.xOffset+this.newWidth/2,this.yOffset+this.newHeight/2),t.rotate(e*Math.PI/180),t.translate(-(this.xOffset+this.newWidth/2),-(this.yOffset+this.newHeight/2)),this.__draw()},o.prototype.__setWidth=async function(e){this.canva.width=e},o.prototype.__setHeight=async function(e){this.canva.height=e},o.prototype.__setPosUser=async function(e,t,i){-1==this.user.coord.x&&-1==this.user.coord.y||1==i?(this.user.coord.x=e,this.user.coord.y=t):(e<0&&(e=0),t<0&&(t=0),e>this.image.width&&0!=this.image.width&&(e=this.image.width),t>this.image.height&&0!=this.image.height&&(t=this.image.height)),this.user.coord.tempx=this.user.coord.x,this.user.coord.tempy=this.user.coord.y,this.user.coord.newx=e,this.user.coord.newy=t},o.prototype.__setZoomPos=async function(e,t){this.zoomX=e,this.zoomY=t},o.prototype.__setImage=function(e){return new Promise(t=>{const i=new Image;i.src=e,this.images[e]?(this.image=this.images[e],t()):i.decode().then(()=>{this.images[e]=i,this.image=i,t()})})},o.prototype.__setSight=async function(e,t){this.user.sight.x=e,this.user.sight.y=t},o.prototype.__changeIdLevel=async function(e){return new Promise(t=>{this.options.positionUser.idLevel=e.id,this.__setImage(e.url).then(()=>{if(this.json=[],e.acquisitionPoints)for(let t=0;t<e.acquisitionPoints.length;t++){const i={};i.id=e.acquisitionPoints[t].id,i.coord={},i.coord.x=e.acquisitionPoints[t].coord.x.valueOf(),i.coord.y=this.image.height-e.acquisitionPoints[t].coord.y.valueOf(),i.color=e.acquisitionPoints[t].color,this.json.push(i)}t()})})},o.prototype.__getNormTrans=function(){let e={};const t=this.canva.getContext("2d");return t.save(),t.translate(this.xOffset+this.newWidth/2,this.yOffset+this.newHeight/2),t.rotate(-this.angle*Math.PI/180),t.translate(-(this.xOffset+this.newWidth/2),-(this.yOffset+this.newHeight/2)),e=t.getTransform(),t.restore(),e},o.prototype.__handlemove=async function(e,t,i,n,o,s){let a=0,r=0,l=0;null!=e.offsetX&&null!=e.offsetY?(a=e.offsetX,r=e.offsetY):(l=this.canva.getBoundingClientRect(),a=e.touches[0].clientX-l.left,r=e.touches[0].clientY-l.top);const h=this.canva.getContext("2d");let d=h.transformedPoint(a,r);if(s)if(t)this.drag=!0,h.translate(d.x-t.x,d.y-t.y),this.__draw();else if(n)d.x=d.x-this.xOffset,d.y=d.y-this.yOffset,this.__setPosUser(d.x*this.ratiox,d.y*this.ratioy,!0),this.check=!1,this.__draw(),this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/GetViewPoint",data:{idLevel:this.options.positionUser.idLevel,x:this.user.coord.newx,y:this.image.height-this.user.coord.newy,duration:100,updateOnlyEnd:!0,draggingUser:!0}});else if(i){const e=this.user.coord.x/this.ratiox+this.xOffset,t=this.user.coord.y/this.ratioy+this.yOffset;let i=Math.atan2(d.y-t,d.x-e)*(180/Math.PI);i=d.x-e>0?(d.y,90+i):d.y-t>0?90+i:450+i,this.diff=i-this.sightangle,this.diff=-this.diff*Math.PI/180;const n=this.user.sight.x*Math.cos(this.diff)+this.user.sight.y*Math.sin(this.diff),o=-this.user.sight.x*Math.sin(this.diff)+this.user.sight.y*Math.cos(this.diff);this.user.sight.x=n,this.user.sight.y=o,this.__draw(),this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/SetView",data:{x:this.user.sight.x,y:-this.user.sight.y}})}else if(o){const e=this.canva.width/2,t=this.canva.height/2;let i=Math.atan2(d.y-t,d.x-e)*(180/Math.PI);const n=(i=d.x-e>0?(d.y,90+i):d.y-t>0?90+i:450+i)-o;this.__rotate(n),this.__draw()}await this.__hover(a,r),this.__changecursor()},o.prototype.__hover=async function(e,t){if(null!=this.newWidth){const i=this.canva.getContext("2d");let n=i.transformedPoint(e,t);n.x=n.x-this.xOffset,n.y=n.y-this.yOffset;const o=await this.__getNormTrans();if(this.onPoint=!1,-1!=await this.__findPoint(n.x*this.ratiox,n.y*this.ratioy,this.canva.width/100/(o.a/3)*this.ratiox,this.canva.width/100/(o.a/3)*this.ratioy)&&(this.onPoint=!0),i.isPointInPath(this.pointUser,e,t))this.onUser=!0;else{const n=this.user.coord.x/this.ratiox+this.xOffset,o=this.user.coord.y/this.ratioy+this.yOffset;i.save(),i.translate(n,o),i.rotate(this.sightangle*Math.PI/180),i.translate(-n,-o),this.onUser=!1,i.isPointInPath(this.sight,e,t)?this.onSight=!0:this.onSight=!1,i.restore()}}},o.prototype.__changecursor=async function(){this.add?this.canva.style.cursor="crosshair":this.rotate?this.canva.style.cursor="move":this.drag?this.canva.style.cursor="grabbing":this.onUser?this.canva.style.cursor="grab":this.onPoint?this.canva.style.cursor="pointer":this.onSight?this.canva.style.cursor="grab":this.canva.style.cursor="default"},o.prototype.__findPoint=async function(e,t,i,n){let o=[];let s={};for(let s=0,a=this.json.length;s<a;s++){let a=this.json[s];a.coord.x<e+1.5*i&&a.coord.x>e-1.5*i&&a.coord.y<t+2*n*1.5&&a.coord.y>t-.5*n*1.5&&o.push(a)}if(o.length>0){let i=9999999;if(o.length>1)for(let n=0;n<o.length;n++){let a=o[n],r=Math.sqrt(Math.pow(e-a.coord.x,2)+Math.pow(t-a.coord.y,2));r<i&&(i=r,s=a)}else s=o[0];return s}return-1},o.prototype.__canvaFunctions=async function(){const e=this.canva.getContext("2d"),t=this.canva;let n,o,s,a,r,l,h=!1;t.onmousewheel=function(e){const t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0,i=Math.pow(1.1,t);this.__setZoomPos(e.offsetX,e.offsetY),this.__zoom(i),r=e.offsetX,l=e.offsetY,this.__hover(r,l),this.__changecursor()}.bind(this),t.onmousedown=async function(t){null!=t.offsetX&&null!=t.offsetY&&(r=t.offsetX,l=t.offsetY),h=!0;const d=e.transformedPoint(r,l);if(this.rotate){const e=this.canva.width/2,t=this.canva.height/2;a=Math.atan2(d.y-t,d.x-e)/Math.PI*180,a=d.x-e>0?(d.y,90+a):d.y-t>0?90+a:450+a}else this.onUser?(i.publish({event:"ENO3DView/ENO3DMinimap/ChangeUpdate",data:!1}),s=e.transformedPoint(r,l),this.drag=!0):this.onSight?(i.publish({event:"ENO3DView/ENO3DMinimap/ChangeUpdate",data:!1}),o=e.transformedPoint(r,l),this.drag=!0):n=e.transformedPoint(r,l);this.__changecursor()}.bind(this),t.onmouseup=function(){if(h=!1,o){this.diff=-this.diff*Math.PI/180;const e=this.user.sight.x*Math.cos(this.diff)+this.user.sight.y*Math.sin(this.diff),t=-this.user.sight.x*Math.sin(this.diff)+this.user.sight.y*Math.cos(this.diff);this.user.sight.x=e,this.user.sight.y=t,i.publish({event:"ENO3DView/ENO3DMinimap/ChangeUpdate",data:!0}),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DMinimap-usage"});t.setEventData({eventLabel:"ENO3DMinimap-setSight"}),t.trackPageEvent()})}s&&(this.check=!1,require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DMinimap-usage"});t.setEventData({eventLabel:"ENO3DMinimap-setViewpoint"}),t.trackPageEvent()}),this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/GetViewPoint",data:{idLevel:this.options.positionUser.idLevel,x:this.user.coord.newx,y:this.image.height-this.user.coord.newy,draggingUser:!1}}),i.publish({event:"ENO3DView/ENO3DMinimap/ChangeUpdate",data:!0})),this.drag=!1,n=null,a=null,o=null,s=null}.bind(this),t.onmousemove=function(e){this.__handlemove(e,n,o,s,a,h)}.bind(this),t.onmouseleave=function(){n=null,this.drag=!1}.bind(this),t.ondblclick=async function(i){if(require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DMinimap-usage"});t.setEventData({eventLabel:"ENO3DMinimap-setViewpoint"}),t.trackPageEvent()}),this.newWidth){r=i.offsetX,l=i.offsetY;let n=e.transformedPoint(r,l);if(n.x=n.x-this.xOffset,n.y=n.y-this.yOffset,this.onPoint){const e=await this.__getNormTrans();let i=await this.__findPoint(n.x*this.ratiox,n.y*this.ratioy,t.width/100/(e.a/3)*this.ratiox,t.width/100/(e.a/3)*this.ratioy);this.__setPosUser(i.coord.x,i.coord.y,!1)}else this.__setPosUser(n.x*this.ratiox,n.y*this.ratioy,!1);this.check=!1,this.__draw(),this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/GetViewPoint",data:{idLevel:this.options.positionUser.idLevel,x:this.user.coord.newx,y:this.image.height-this.user.coord.newy,updateOnlyEnd:!0,draggingUser:!1}})}}.bind(this);const d=0;t.ontouchstart=async function(t){const i=this.canva.getBoundingClientRect();if(r=t.touches[0].clientX-i.left,l=t.touches[0].clientY-i.top,h=!0,await this.__hover(r,l),this.rotate){pt=e.transformedPoint(r,l);const t=this.canva.width/2,i=this.canva.height/2;a=Math.atan2(pt.y-i,pt.x-t)/Math.PI*180,a=pt.x-t>0?(pt.y,90+a):pt.y-i>0?90+a:450+a}else this.onUser?(s=e.transformedPoint(r,l),this.drag=!0):this.onSight?(o=e.transformedPoint(r,l),this.drag=!0):n=e.transformedPoint(r,l);this.__changecursor();const c=(new Date).getTime()-d;if(c<400&&c>0){d=0;const e=t.target.getBoundingClientRect(),i=t.targetTouches[0].pageX-e.left,n=t.targetTouches[0].pageY-e.top;t.offsetX=i,t.offsetY=n,this.ondblclick(t)}else d=(new Date).getTime()}.bind(this),t.ontouchmove=function(e){this.__handlemove(e,n,o,s,a,h)}.bind(this),t.ontouchend=function(e){if(h=!1,o){this.diff=-this.diff*Math.PI/180;const e=this.user.sight.x*Math.cos(this.diff)+this.user.sight.y*Math.sin(this.diff),t=-this.user.sight.x*Math.sin(this.diff)+this.user.sight.y*Math.cos(this.diff);this.user.sight.x=e,this.user.sight.y=t,this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/SetView",data:{x:this.user.sight.x,y:-this.user.sight.y}})}s&&(this.check=!1,this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/GetViewPoint",data:{idLevel:this.options.positionUser.idLevel,x:this.user.coord.newx,y:this.image.height-this.user.coord.newy,draggingUser:!1}})),this.drag=!1,n=null,a=null,o=null,s=null}.bind(this)},o.prototype.__trackTransforms=function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=t.createSVGMatrix();e.getTransform=function(){return i};var n=[],o=e.save;e.save=function(){return n.push(i.translate(0,0)),o.call(e)};var s=e.restore;e.restore=function(){return i=n.pop(),s.call(e)};var a=e.scale;e.scale=function(t,n){return i=i.scaleNonUniform(t,n),a.call(e,t,n)};var r=e.rotate;e.rotate=function(t){return i=i.rotate(180*t/Math.PI),r.call(e,t)};var l=e.translate;e.translate=function(t,n){return i=i.translate(t,n),l.call(e,t,n)};var h=e.transform;e.transform=function(n,o,s,a,r,l){const d=t.createSVGMatrix();return d.a=n,d.b=o,d.c=s,d.d=a,d.e=r,d.f=l,i=i.multiply(d),h.call(e,n,o,s,a,r,l)};var d=e.setTransform;e.setTransform=function(t,n,o,s,a,r){return i.a=t,i.b=n,i.c=o,i.d=s,i.e=a,i.f=r,d.call(e,t,n,o,s,a,r)};var c=t.createSVGPoint();e.transformedPoint=function(e,t){return c.x=e,c.y=t,c.matrixTransform(i.inverse())},e.reset=function(i,n){var o=t.createSVGMatrix();e.setTransform(o.a,o.b,o.c,o.d,o.e,o.f)}},o.prototype.getHTML=function(){return this.canva},o}),define("DS/ENO3DView/mixins/ENO3DViewPreferenceManager",[],function(){"use strict";function e(){}return e.prototype.test=function(){this._DEBUG&&console.log("ENO3DViewPreferenceManager.displayNotification called")},e}),define("DS/ENO3DView/views/ENO3DMinimapToolbar",["css!DS/ENO3DView/ENO3DView.css","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/Tweakers/GeneratedToolbar"],function(e,t,i){"use strict";const n="minimap";function o(e){this.elements={},this.options=e||{},this.options=Object.assign({nbfloor:null,toolbarMap:null,level:0},this.options),this._localModelEvents=e.modelEvents,this.iconList=["level-low wux-ui-3ds","level-medium wux-ui-3ds","level-high wux-ui-3ds","level-high wux-ui-3ds"];let o=[];for(let e=0;e<this.options.nbfloor;e++){let i;i=e>2?this.iconList[2]:this.iconList[e],o.push({type:"PushItem",title:t.minimap.selectionMenu.floor+" "+e,icon:{iconName:i,fontIconFamily:1},action:{callback:function(){this.elements.toolbarMap.updateNodeModel("selectionMenu",{icon:{iconName:i,fontIconFamily:1}}),this._localModelEvents.publish({event:"ENO3DView/ENO3DMinimap/GetLevel",data:{idLevel:e}})}.bind(this)}})}this.options.toolbarMap={entries:[{id:"rotateImage",dataElements:{typeRepresentation:"functionIcon",value:()=>{this.canva.rotate=!this.canva.rotate},icon:{iconName:"rotate-cw wux-ui-3ds",fontIconFamily:1},tooltip:{title:t.minimap.rotateImage.title,shortHelp:t.minimap.rotateImage.subtitle}}},{id:"plus",dataElements:{typeRepresentation:"functionIcon",value:()=>{this.canva.__zoomUser(Math.pow(1+Math.abs(.24)/2,1))},icon:{iconName:"zoom-in wux-ui-3ds",fontIconFamily:1},tooltip:{title:t.minimap.zoomin.title,shortHelp:t.minimap.zoomin.subtitle}}},{id:"minus",dataElements:{typeRepresentation:"functionIcon",value:()=>{this.canva.__setZoomPos(this.canva.canva.width/2,this.canva.canva.height/2),this.canva.__zoom(Math.pow(1+Math.abs(-.24)/2,-1))},icon:{iconName:"zoom-out wux-ui-3ds",fontIconFamily:1},tooltip:{title:t.minimap.zoomout.title,shortHelp:t.minimap.zoomout.subtitle}}},{id:"zoomFit",dataElements:{typeRepresentation:"functionIcon",value:()=>{this.canva.__zoomFit()},icon:{iconName:"zoom-fit wux-ui-3ds",fontIconFamily:1},tooltip:{title:t.minimap.zoomfit.title,shortHelp:t.minimap.zoomfit.subtitle}}},{id:"selectionMenu",title:"Floor selection",dataElements:{typeRepresentation:"functionMenuIcon",icon:{iconName:this.iconList[this.options.level],fontIconFamily:1},value:{menu:o},tooltip:{title:t.minimap.selectionMenu.title,shortHelp:t.minimap.selectionMenu.subtitle}}},{id:"chevronMenuIcon",dataElements:{typeRepresentation:"chevronMenuIcon",label:t.minimap.chevronMenuIcon.title,value:{menu:[{id:"taskbar",type:"PushItem",title:t.minimap.chevronMenuIcon.menu.taskbar.reduce,action:{callback:function(){20==parseInt(document.defaultView.getComputedStyle(this.footer).width)?(this.elements.toolbarMap.updateNodeModel("taskbar",{title:t.minimap.chevronMenuIcon.menu.taskbar.reduce}),this.footer.style.width="175px"):(this.elements.toolbarMap.updateNodeModel("taskbar",{title:t.minimap.chevronMenuIcon.menu.taskbar.expand}),this.footer.style.width="20px")}.bind(this)},tooltip:{title:t.minimap.chevronMenuIcon.menu.taskbar.title,shortHelp:t.minimap.chevronMenuIcon.menu.taskbar.subtitle}}]},position:"far",category:"3"}}]};let s=i.prototype.createTreeDocument(this.options.toolbarMap);this.elements.toolbarMap=new i({overflowManagement:"dropdown",direction:"horizontal",items:s,touchMode:!1}),this.elements.toolbarMap.getContent().addClassName(n+"-toolbarMap")}return o.prototype.__setCanva=async function(e){this.canva=e},o.prototype.__setFooter=async function(e){this.footer=e},o.prototype.__updateIcon=async function(e){let t="";t=e>2?this.iconList[2]:this.iconList[e],this.elements.toolbarMap.updateNodeModel("selectionMenu",{icon:{iconName:t,fontIconFamily:1}})},o.prototype.getHTML=function(){return this.elements.toolbarMap.getContent()},o}),define("DS/ENO3DView/mixins/ENO3DViewAccessors",["DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i){"use strict";function n(){}return n.prototype.getWidgetComponent=function(){return this.getComponentFromIdentifier(this._identifiers.widget)},n.prototype.getWidget=function(){return this.getWidgetComponent().getSessionWidget()},n.prototype.getLandingPageComponent=function(){return this.getComponentFromIdentifier(this._identifiers.landingPage)},n.prototype.get3DViewer=function(){return this._viewer},n.prototype.getTriptych=function(){return this._triptych},n.prototype.getCommandContext=function(){return this._context},n.prototype.getDefaultProgressBarVisibility=function(){return this._defaultProgressBarVisibility},n.prototype.getAutomaticReframePolicy=function(){return!window.ENOPADNoReframe&&this._automaticReframePolicy},n.prototype.getApplicativeData=function(){return this._applicativeData},n.prototype.getPropertiesFacet=function(){return e.getSetting("propertiesFacet")?e.getSetting("propertiesFacet"):[]},n.prototype.getContentName=function(e){return new Promise((t,i)=>{this._controller.getContentName().then(i=>{e&&e.callbacks&&e.callbacks.onComplete&&e.callbacks.onComplete(i),t(i)}).catch(t=>{e&&e.callbacks&&e.callbacks.onFailure&&e.callbacks.onFailure(t),i(t)})})},n.prototype.getRootBagPath=function(){return this._controller.getRootBagPath()},n.prototype.getRoots=function(){return this._controller.getRootBag().children},n.prototype.getViewer=function(){return this._viewer},n.prototype.getController=function(){return this._controller},n.prototype.getBIController=function(){return this._controller},n.prototype.getHideShowController=function(){return this._hideShowController},n.prototype.getModelEvents=function(){return this._modelEvents},n.prototype.getCommandProxy=function(){return this._commandProxy},n.prototype.getDecorationBag=function(){return this._controller.getDecorationBag()},n.prototype.getViewpoint=function(){return this._viewpoint},n.prototype.getViewpointParameters=function(){if(this.getViewpoint())return t.buildViewPoint(this.getViewpoint())},n.prototype.getStatusBar=function(e){return this.elements.padstatusbar},n.prototype.getCurrentLayout=function(){return this._layout},n.prototype.getFrameWindow=function(e){const t=this._viewer;return t.getImmersiveFrame=(()=>this.getWafrUIFrame().getImmersiveFrame()),t.getTree=function(){return{show:function(){},hide:function(){}}},t.getViewer=function(){return t},t.getViewpoint=function(){return this.getViewpoint()}.bind(this),t.getContextualUIManager=function(){return this.getComponentFromIdentifier(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager()}.bind(this),t.getUIFrame=function(){return this.getComponentFromIdentifier(WAfrStandardComponentKey.UIFrame).getUIFrame()}.bind(this),t.getActionBar=function(){return null},t},n.prototype.getDOMElement=function(e){return void 0!==this.elements[e]?this.elements[e]:"widgetWrapper"===e?void 0!==widget.elements&&void 0!==widget.elements.wrapper?widget.elements.wrapper:this.elements.container:null},n.prototype._getFrustumDefinition=function(){if(this.getViewer()&&this.getViewpoint())return t._getFrustumDefinition(this.getViewer(),this.getViewpoint())},n.prototype.setDefaultContextualBarVisibility=function(e){this._defaultContextualBarVisibility=e},n.prototype.setDefaultProgressBarVisibility=function(e){this._defaultProgressBarVisibility=e},n.prototype.setAutomaticReframePolicy=function(e){this._automaticReframePolicy=e},n.prototype.setDefaultContextualMenuVisibility=function(e){this._defaultContextualMenuVisibility=e},n.prototype.setOpenWithMenuAvailability=function(e){this._openWithMenuAvailability=e},n.prototype.lockSelectionBroadcast=function(e){this._lockCSONotification=e},n.prototype.setLoadingDelegations=function(e){if("object"!=typeof e)throw new Error("Wrong parameter for setLoadingDelegations");this._loadingDelegations=e},n.prototype.setAuthorizedRootTypes=function(t){const i=[],n=e.getSetting("supported_root_types");for(let e=0;e<t.length;++e)n.indexOf(t[e])>-1&&i.push(t[e]);e.setSetting("authorized_root_types",i)},n.prototype.setDefaultStreamToLoad=function(t){e.setSetting("enopad3dviewer_CGRorTHB",t),this.getController()._setDefaultStreamToLoad(t)},n.prototype.setRobotVisibility=function(e){this._robotVisibility=e,this._viewer.getRobot&&this._viewer.getRobot()&&this._viewer.getRobot().setVisibility(e)},n.prototype.isRobotVisible=function(){return this._robotVisibility},n.prototype.isInterwidgetComAvailable=function(){return this._interwidgetComAvailability},n.prototype.isDefaultContextualBarVisible=function(){return this._defaultContextualBarVisibility},n.prototype.isOpenWithMenuAvailable=function(){return this._openWithMenuAvailability},n.prototype.isDefaultContextualMenuVisible=function(){return this._defaultContextualMenuVisibility},n.prototype.isSelectiveLoadingActivated=function(){return e.getSetting("enopad3dviewer_dynamicRepLoading")||e.getSetting("enopad3dviewer_lightNodeModel")},n.prototype.checkIfEmpty=function(){return this.getController().checkIfEmpty()},n.prototype._areValidPaths=function(e){if(e)for(let t=0;t<e.length;++t)if(!i.isAModelPath(e[t].pathElement))return!1;return!0},n}),define("DS/ENO3DView/mixins/ENO3DViewEventManager",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADPromise","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/Utilities/Utils","DS/Visualization/WorldOrientation","DS/Visualization/SceneGraphUtils","DS/ENOXInterWdgCom/LinkManager","DS/CoreEvents/Events","DS/i3DXCompassServices/i3DXCompassPubSub"],function(e,t,i,n,o,s,a,r,l,h,d,c,p,u,g,m,_,f,v,C){"use strict";function y(){}return y.prototype._registerControllerEvents=function(){this._controllerTokens.push(this._controller.subscribe({event:"onRootDetached"},this._onRootDetachedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onContentNameModified"},this._onContentNameModifiedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onFilterApplied"},this._onFilterAppliedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onFilterWithAuthoring"},this._onFilterWithAuthoringCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRetrieveFilterFailure"},this._onRetrieveFilterFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onTaggerSelectWithAuthoring"},this._onTaggerSelectWithAuthoringCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onStaticMappingApplied"},this._onStaticMappingAppliedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onFlexibleAssemblyApplied"},this._onFlexibleAssemblyAppliedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onSearchCompleted"},this._onSearchCompletedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onSearchFailure"},this._onSearchFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onSearchTooManyPath"},this._onSearchTooManyPathCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootAttached"},this._onRootAttachedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginRootRemoved"},this._onBeginRootRemovedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootRemoved"},this._onRootRemovedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginReplaceInstance"},this._onBeginReplaceInstanceCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEndReplaceInstance"},this._onEndReplaceInstanceCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEndMatriceUpdate"},this._onEndMatriceUpdateCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onUnsupportedType"},this._onUnsupportedTypeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginRootLoading"},this._onBeginRootLoadingCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onProgress"},this._onProgressCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootAdded"},this._onRootAddedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootUpdateStart"},this._onRootUpdateStartCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootUpdateEnd"},this._onRootUpdateEndCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginFilterApplied"},this._onBeginFilterAppliedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onReframe"},this._onReframeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"rootStatsRetrieved"},this._onRootStatsRetrievedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootAlreadyExisting"},this._onRootAlreadyExistingCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRootAdditionTransactionComplete"},this._onRootAdditionTransactionComplete.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onComplete"},this._onCompleteCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onLoadingFailure"},this._onLoadingFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onLoadingCanceled"},this._onLoadingCanceledCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"startAsync"},this._startAsyncCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"stopAsync"},this._stopAsyncCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onMove"},this._onMoveCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEndReparent"},this._onEndReparentCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onInstanceUpdated"},this._onInstanceUpdatedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onAuthoringIgnored"},this._onAuthoringIgnoredCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginReparent"},this._onBeginReparentCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onReparentFailure"},this._onReparentFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onInsertExistingFailure"},this._onInsertExistingFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onInsertExisting"},this._onInsertExistingCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onStreamSwitched"},this._onStreamSwitchedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onStreamSwitchFailure"},this._onStreamSwitchFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onGeometryRefreshed"},this._onGeometryRefreshedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRefreshGeometryFailure"},this._onRefreshGeometryFailureCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEndDelete"},this._onEndDeleteCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onCompletionCompleted"},this._onCompletionCompletedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginDelete"},this._onBeginDeleteCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onDefaultStreamChanged"},this._onDefaultStreamChangedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onIndexAvalabilityChange"},this._onIndexAvalabilityChangeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEndRootRemoved"},this._onEndRootRemovedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRefreshCompleted"},this._onRefreshCompletedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRefreshBegin"},this._onRefreshBeginCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onAuthoringSwitch"},this._onAuthoringSwitchCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onColorizeInAuthoring"},this._onColorizeInAuthoring.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onAuthoringTransactionBegin"},this._onAuthoringTransactionBeginCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onAuthoringTransactionEnd"},this._onAuthoringTransactionEndCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onExpandCompleted"},this._onExpandCompletedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onDisableUX"},this._onDisableUXCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEnableUX"},this._onEnableUXCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onDisableActionBar"},this._onDisableActionBarCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"PGPPostProcess"},this._PGPPostProcessCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onParsingInterruptedMemoryFull"},this._onParsingInterruptedMemoryFullCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRepresentationLoaded"},this._onRepresentationLoadedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onStartProgressiveLoad"},this._onStartProgressiveLoadCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onEndProgressiveLoad"},this._onEndProgressiveLoadCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBeginFilterRemoved"},this._onBeginFilterRemovedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onFilterRemoved"},this._onFilterRemovedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBIColorize"},this._onBIColorizeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onBIUnColorize"},this._onBIUnColorizeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"on3DLeafColorize"},this._on3DLeafColorizeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"on3DLeafUnColorize"},this._on3DLeafUnColorizeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onTreeColorize"},this._onTreeColorizeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onTreeUnColorize"},this._onTreeUnColorizeCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onUrlLoaded"},this._onUrlLoadedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onVQDisabled"},this._onVQDisabledCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onLeafReferenceLoaded"},this._onLeafReferenceLoadedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onLeafReferenceUnloaded"},this._onLeafReferenceUnloadedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onR2VLoaded"},this._onR2VLoadedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onRealAssetLoaded"},this._onRealAssetLoadedCB.bind(this))),this._controllerTokens.push(this._controller.subscribe({event:"onSOIDropped"},this._onSOIDroppedCB.bind(this)))},y.prototype._onRootDetachedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRootDetachedCB called"),this._viewer.render({updateInfinitePlane:!0}),this.reframe(),this.publish({event:"onRootDetached",data:e})},y.prototype._onContentNameModifiedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onContentNameModifiedCB called"),this.publish({event:"onContentNameModified",data:e.TitleInfo})},y.prototype._onFilterAppliedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFilterAppliedCB called"),this.getController().getAttributes({ids:e.filter.objects[0].path,attributes:["ds6w:label"],callbacks:{onComplete:t=>{this.getStatusBar()&&this.getStatusBar().setFilter({id:e.filter.objects[0].path[0],message:t[e.filter.objects[0].path[0]]["ds6w:label"]})},onFailure:e=>{console.warn(`Failed to apply filter : ${e}`)}}}),this.publish({event:"onFilterApplied",data:e})},y.prototype._onFilterWithAuthoringCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFilterWithAuthoringCB called"),this.displayNotification({msg:t.dropFilteredRootAuth,eventID:"warning"})},y.prototype._onRetrieveFilterFailureCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRetrieveFilterFailureCB called");for(let t=0;t<e.failure.length;++t)this.displayNotification({msg:e.failure[t].msg,eventID:e.failure[t].eventID});this.checkIfEmpty()?(this._dropZoneContainer&&this._dropZoneContainer.show("drop"),this.publish({event:"onEmptyView"})):this._dropZoneContainer&&this._dropZoneContainer.hide()},y.prototype._onTaggerSelectWithAuthoringCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onTaggerSelectWithAuthoringCB called"),this.displayNotification({msg:t.taggerSelectAuth,eventID:"warning"})},y.prototype._onStaticMappingAppliedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onStaticMappingAppliedCB called"),this.publish({event:"onStaticMappingApplied",data:e})},y.prototype._onFlexibleAssemblyAppliedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFlexibleAssemblyAppliedCB called"),this.publish({event:"onFlexibleAssemblyApplied",data:e})},y.prototype._onSearchCompletedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onSearchCompletedCB called"),e.searchQuery?this._findInContext(e):e.findPaths?this._findPaths(e):e.taggerSelect&&this._taggerSelect(e),this.publish({event:"onSearchCompleted",data:e})},y.prototype._onSearchFailureCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onSearchFailureCB called"),this.displayNotification({eventID:"error",msg:e.searchInContextFailed}),this.publish({event:"onSearchFailure",data:t})},y.prototype._onSearchTooManyPathCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onSearchTooManyPathCB called"),this.displayNotification({eventID:"warning",msg:e.tooManyResultFoundV2.replace("{maxResult}",l.getSetting("enopad3dviewer_max_count_in_search"))})},y.prototype._onRootAttachedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRootAttachedCB called"),this._dropZoneContainer&&this._dropZoneContainer.hide(),this._viewer.render({updateInfinitePlane:!0}),this.reframe(),this.publish({event:"onRootAttached",data:e})},y.prototype._onBeginRootRemovedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginRootRemovedCB called"),!1===e.dispatch&&this.lockSelectionBroadcast(!0)},y.prototype._onRootRemovedCB=function(e){if(this._DEBUG&&console.log("ENO3DViewEventManager._onRootRemovedCB called"),this.getController().getNbRoots()||this.getController().getHiddenRootIds().length||!this._dropZoneContainer||(this._dropZoneContainer.show("drop"),this.getStatusBar()&&(this.getStatusBar().setIsPaused(!1),this.getStatusBar().resetPreviousLabel(),this.getStatusBar().setLoader({status:"off"}))),this._viewer.render({updateInfinitePlane:!0}),e.reframe&&this.getController()._model.getOOCManager().getReframeBoundingSphere){const e=this.getController()._model._OOCManager.getReframeBoundingSphere();0!==e.radius?this.reframe(e):this.reframe()}this._removeRootUpdateCommands(),this.publish({event:"onRootRemoved",data:e}),!1===e.dispatch&&this.lockSelectionBroadcast(!1)},y.prototype._onBeginReplaceInstanceCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginReplaceInstanceCB called"),this.publish({event:"onBeginReplaceInstance"})},y.prototype._onEndReplaceInstanceCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onEndReplaceInstanceCB called"),this.publish({event:"onEndReplaceInstance",data:e}),this.publish({event:"onModelUpdated",data:e})},y.prototype._onEndMatriceUpdateCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onEndMatriceUpdateCB called"),this._viewer.render({updateInfinitePlane:!0}),this.publish({event:"onEndMatriceUpdate",data:e}),this.publish({event:"onModelUpdated",data:{rootNodes:this.getRoots()}})},y.prototype._onUnsupportedTypeCB=function(e){if(this.displayNotification({msg:t.replace(t.get("unsupported_type"),{type:e.displayType,name:e.displayName}),eventID:"warning"}),0===this.getRoots().length&&!this._checkHiddenRoots()){GlobalModelEvents.getModelEvents().publish({event:"ENXViews/WelcomePanel/activate"})}},y.prototype._onBeginRootLoadingCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginRootLoadingCB called"),this._lastReframeRequiered=0,this._dropZoneContainer&&this._dropZoneContainer.hide(),this.publish({event:"onBeginRootLoading"})},y.prototype._onProgressCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onProgressCB called"),this.getDefaultProgressBarVisibility()?(h.setText(e.message),e.progress%20==0&&e.progress!==this._lastReframeRequiered&&(this._lastReframeRequiered=e.progress,e.reframe?this.reframe():this._viewer.render({updateInfinitePlane:!0}))):this.publish({event:"onProgress",data:e})},y.prototype._onRootAddedCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onRootAddedCB called"),this._viewer.render({updateInfinitePlane:!0}),this.getRoots().length+this.getController().getHiddenRootIds().length===1&&(1===t.orientation?(this._viewer.setWorldOrientation(m.YUpXRight),this.reframe(t.BS)):this._viewer.setWorldOrientation(m.ZUpYRight)),this._dropZoneContainer&&this._dropZoneContainer.hide(),t.reframe&&this.reframe(t.BS),t.displayNotif&&(t.hidden?this.displayNotification({eventID:"info",msg:e.addonDetachedRootSuccessNotif}):this.displayNotification({eventID:"success",msg:t.inContext?e.addRootInContextSuccessNotif:e.addRootSuccessNotif})),!0===this._controller._wait4Filter&&(this._filterRootIds=[t.id],this._filterPanelOpen=!0),this._addRootUpdateCommands(),this.publish({event:"onRootAdded",data:t})},y.prototype._onRootUpdateStartCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRootUpdateStartCB called"),this.publish({event:"onRootUpdateStart",data:e})},y.prototype._onRootUpdateEndCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRootUpdateEndCB called"),this.publish({event:"onRootUpdateEnd",data:e})},y.prototype._onBeginFilterAppliedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginFilterAppliedCB called"),this.publish({event:"onBeginFilterApplied",data:e})},y.prototype._onReframeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onReframeCB called"),window.ENOPADNoReframe||(e.BS&&this.getViewpoint().reframe(void 0,0,e.BS),e.rootBS||setTimeout(()=>{this.reframe()},3e3))},y.prototype._onRootStatsRetrievedCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onRootStatsRetrievedCB called"),!t||0!==t.size.flat&&0!==t.size.occ&&0!==t.size.leaf||this.displayNotification({eventID:"info",msg:e.statsRetrieved_emptyStructure}),this.publish({event:"rootStatsRetrieved",data:t})},y.prototype._onRootAlreadyExistingCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onRootAlreadyExistingCB called"),this.displayNotification({eventID:"info",msg:e.rootAlreadyLoadedNotif}),this._dropZoneContainer&&this._dropZoneContainer.hide(),this.publish({event:"onRootAlreadyExisting",data:t})},y.prototype._onRootAdditionTransactionComplete=function(e){this.publish({event:"onRootAdditionTransactionComplete",data:e})},y.prototype._onCompleteCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onCompleteCB called"),e.reframe&&this.reframe(e.BS),"addRoot"===e.intend&&this.publish({event:"onComplete",data:{intend:"addRoot"}}),this.publish({event:"onLoadingComplete"}),!0===this.updatePager&&(this.updatePager=!1,this.publish({event:"onUpdatePager",data:this.pagerData}))},y.prototype._onLoadingFailureCB=function(t){if(this._DEBUG&&console.log("ENO3DViewEventManager._onLoadingFailureCB called"),this._controller.getNbRoots()||this._checkHiddenRoots()||!this._dropZoneContainer||this._controller.isRunning()||this._dropZoneContainer.show("drop"),t.displayNotif){let i=e.addRootFailureNotif;const n="error";t&&t.message&&(i=t.message),t&&t.eventID&&(n=t.eventID),this.displayNotification({eventID:n,msg:i})}this.publish({event:"onLoadingFailure",data:t})},y.prototype._onLoadingCanceledCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onLoadingCanceledCB called"),this._controller.getNbRoots()||this._checkHiddenRoots()||!this._dropZoneContainer||this._dropZoneContainer.show("drop");let i=e.addRootFailureNotif;t&&t.message&&(i=t.message),this.displayNotification({eventID:"info",msg:i}),this.publish({event:"onLoadingCanceled"})},y.prototype._startAsyncCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._startAsyncCB called"),(void 0===e||void 0===e.userFeedback||e.userFeedback)&&this.getDefaultProgressBarVisibility()?(h.on(void 0,e.onCancel,t.PADProgressBar_cancelAll),this.getStatusBar()&&this.getStatusBar().setLoader({status:"hide"})):this.publish({event:"onStartAsync"})},y.prototype._stopAsyncCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._stopAsyncCB called"),(void 0===e||void 0===e.userFeedback||e.userFeedback)&&this.getDefaultProgressBarVisibility()?(h.off(),this.getStatusBar()&&this.getStatusBar().setLoader({status:"show"})):this.publish({event:"onStopAsync"})},y.prototype._onMoveCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onMoveCB called"),this.publish({event:"onMove",data:e})},y.prototype._onEndReparentCB=function(t){if(this._DEBUG&&console.log("ENO3DViewEventManager._onEndReparentCB called"),t.createdNode){const e=this.getController().getRootBag(),i=_.buildPathesLeadingToNode(t.createdNode,e),n=[];for(let e=0;e<i.length;++e)n.push({pathElement:i[e]});this.lockSelectionBroadcast(!0),d.add(n),c.add(n),this.lockSelectionBroadcast(!1)}this._viewer.render({updateInfinitePlane:!0}),this.reframe(),this.displayNotification({eventID:"success",msg:e.reparentSuccessful}),this.publish({event:"onEndReparent",data:t}),this.publish({event:"onModelUpdated",data:t})},y.prototype._onInstanceUpdatedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onInstanceUpdatedCB called"),this.publish({event:"onInstanceUpdated",data:e}),this.publish({event:"onModelUpdated",data:e})},y.prototype._onAuthoringIgnoredCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onAuthoringIgnoredCB called"),this.displayNotification({eventID:"info",msg:e[t.reason]})},y.prototype._onBeginReparentCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginReparentCB called"),this.publish({event:"onBeginReparent",data:e})},y.prototype._onReparentFailureCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onReparentFailureCB called");const i=e.reparentFailure;t&&t.message&&(i=t.message),this.displayNotification({eventID:"error",msg:i}),this.publish({event:"onReparentFailure"})},y.prototype._onInsertExistingFailureCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onInsertExistingFailureCB called");const i=e.insertFailure;t&&t.message&&(i=t.message),this.displayNotification({eventID:"error",msg:i}),this.publish({event:"onInsertExistingFailure"})},y.prototype._onInsertExistingCB=function(t){if(this._DEBUG&&console.log("ENO3DViewEventManager._onInsertExistingCB called"),t.createdNode&&t.insertedNode){const e=this.getController().getRootBag(),i=_.buildPathesLeadingToNode(t.createdNode,e),n=[];for(let e=0;e<i.length;++e)i[e].addElement(t.insertedNode),n.push({pathElement:i[e]});d.add(n),c.add(n)}this._viewer.render({updateInfinitePlane:!0}),this.reframe(),this.displayNotification({eventID:"success",msg:e.insertSuccessful}),this.publish({event:"onInsertExisting",data:t}),this.publish({event:"onModelUpdated",data:t})},y.prototype._onStreamSwitchedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onStreamSwitchedCB called"),this.publish({event:"onStreamSwitched"}),this.publish({event:"onModelUpdated",data:{rootNodes:this.getRoots()}})},y.prototype._onStreamSwitchFailureCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onStreamSwitchFailureCB called"),this.publish({event:"onStreamSwitchFailure"})},y.prototype._onGeometryRefreshedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onGeometryRefreshedCB called"),this.publish({event:"onGeometryRefreshed"}),this.publish({event:"onModelUpdated",data:{rootNodes:this.getRoots()}})},y.prototype._onRefreshGeometryFailureCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRefreshGeometryFailureCB called"),this.publish({event:"onRefreshGeometryFailure"})},y.prototype._onEndDeleteCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onEndDeleteCB called"),this._viewer.render({updateInfinitePlane:!0}),this.reframe(),this.displayNotification({eventID:"success",msg:e.deleteSuccessful}),this.publish({event:"onEndDelete",data:t}),this.publish({event:"onModelUpdated",data:t}),this.lockSelectionBroadcast(!1)},y.prototype._onCompletionCompletedCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onCompletionCompletedCB called"),this._viewer.render({updateInfinitePlane:!0}),this.displayNotification({eventID:"info",msg:t.nbPathLoaded+e.completionCompleted}),this.publish({event:"onCompletionCompleted"}),this.publish({event:"onModelUpdated",data:t})},y.prototype._onBeginDeleteCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginDeleteCB called"),this.lockSelectionBroadcast(!0),this.publish({event:"onBeginDelete",data:e})},y.prototype._onDefaultStreamChangedCB=function(e){if(this._DEBUG&&console.log("ENO3DViewEventManager._onDefaultStreamChangedCB called"),e.newStream){const t="cgr"===e.newStream;this.changeVisuModeCmdAvailability(t)}this.publish({event:"onDefaultStreamChanged",data:e})},y.prototype._onIndexAvalabilityChangeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onIndexAvalabilityChangeCB called"),this.publish({event:"onIndexAvalabilityChange",data:e})},y.prototype._onEndRootRemovedCB=function(e){if(this._DEBUG&&console.log("ENO3DViewEventManager._onEndRootRemovedCB called"),this.publish({event:"onEndRootRemoved",data:e}),this.getStatusBar()){const e=this.getController().getRoots();let t=!1;for(let i=0;i<e.length;++i)if(this.getController().getBIProxy().HasFilter(e[i].getModelIdentification())){t=!0;break}!1===t&&this.getStatusBar().clearFilter()}},y.prototype._onRefreshCompletedCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onRefreshCompletedCB called"),this._controller.getNbRoots()||this._checkHiddenRoots()||!this._dropZoneContainer||this._dropZoneContainer.show("drop"),this.displayNotification({eventID:"info",msg:e.refreshCompleted}),this.publish({event:"onRefreshCompleted",data:t})},y.prototype._onRefreshBeginCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRefreshBeginCB called"),this.publish({event:"onRefreshBegin",data:e})},y.prototype._onAuthoringSwitchCB=function(t){if(this._DEBUG&&console.log("ENO3DViewEventManager._onAuthoringSwitchCB called"),t.message&&""!==t.message&&this.displayNotification({eventID:"info",msg:t.message}),this.getController().refreshAppliedFilters(),!0===t.state){const t=this.getController().getRoots();let o=!1;for(let e=0;e<t.length;++e){var n=i.getNodeID(t[e]);this.getController().isLargeDataStructure(n)&&(o=!0,this.getController().freezeRoot(n))}o&&this.displayNotification({eventID:"warning",msg:e.sessionFrozenFollowingAuthoringOperation})}this.publish({event:"onAuthoringSwitch",data:t})},y.prototype._onColorizeInAuthoring=function(){this._DEBUG&&console.log("ENO3DViewEventManager._onColorizeInAuthoring called"),this.displayNotification({msg:e.colorizeInAuthoring,eventID:"warning"})},y.prototype._onAuthoringTransactionBeginCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onAuthoringTransactionBeginCB called"),d.empty(),c.empty(),this.publish({event:"onAuthoringTransactionBegin"})},y.prototype._onAuthoringTransactionEndCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onAuthoringTransactionEndCB called"),this.publish({event:"onAuthoringTransactionEnd"})},y.prototype._onExpandCompletedCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onExpandCompletedCB called"),t.displayNotif&&this.displayNotification({eventID:"info",msg:e.expandCompleted}),this.publish({event:"onExpandCompleted"}),this.publish({event:"onModelUpdated",data:t})},y.prototype._onDisableUXCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onDisableUXCB called"),this._disableUX()},y.prototype._onEnableUXCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onEnableUXCB called"),this._enableUX()},y.prototype._onDisableActionBarCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onDisableActionBarCB called")},y.prototype._PGPPostProcessCB=function(e){if(this._DEBUG&&console.log("ENO3DViewEventManager._PGPPostProcessCB called"),e.hiddenPaths&&e.hiddenPaths.length){const i=[];for(let n=0;n<e.hiddenPaths.length;++n){var t=this.unstreamPath(e.hiddenPaths[n]);i.push(t)}this.getHideShowController().hide({paths:i,dispatch:!1})}(e.references&&e.references.length||e.instances&&e.instances.length||e.occurrences&&e.occurrences.length)&&this.getHideShowController().applyPGP(e)},y.prototype._onParsingInterruptedMemoryFullCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onParsingInterruptedMemoryFullCB called"),this.displayNotification({eventID:"warning",msg:e.parsingInterruptedMemoryFull}),this.publish({event:"onParsingInterruptedMemoryFull",data:t})},y.prototype._onRepresentationLoadedCB=function(e){this.publish({event:"onRepresentationLoaded",data:e})},y.prototype._onStartProgressiveLoadCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onStartProgressiveLoadCB called"),this.getStatusBar()&&(this.getStatusBar().setLoader({status:"on"}),this.getStatusBar().setProgressLabel(e.PADStatus_loadingData),this.getStatusBar().clearWarning()),this.publish({event:"onStartProgressiveLoad",data:t})},y.prototype._onEndProgressiveLoadCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onEndProgressiveLoadCB called"),this.getStatusBar()&&(this.getStatusBar().setLoader({status:"off"}),0!==this.getRoots().length||this._checkHiddenRoots()?!0===t.memoryFull?this.getStatusBar().setCustomProgressLabel({label:e.PADStatus_loadingStopped,tooltip:e.progressiveExpandFullMemory,severity:"warning"}):this.getStatusBar().setCustomProgressLabel({label:e.PADStatus_loadingComplete,tooltip:e.PADStatus_loadingComplete,severity:"success"}):(this.getStatusBar().setIsPaused(!1),this.getStatusBar().resetProgressLabel())),this.publish({event:"onEndProgressiveLoad",data:t})},y.prototype._onBeginFilterRemovedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBeginFilterRemovedCB called"),this.publish({event:"onBeginFilterRemoved",data:e})},y.prototype._onFilterRemovedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFilterRemovedCB called"),this._filteredIdToReload.push(e.id),this.getStatusBar()&&this.getStatusBar().clearFilter({id:e.id}),this.publish({event:"onFilterRemoved",data:e})},y.prototype._onBIColorizeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBIColorizeCB called"),this.publish({event:"onBIColorize",data:e})},y.prototype._onBIUnColorizeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onBIUnColorizeCB called"),this.publish({event:"onBIUnColorize",data:e})},y.prototype._on3DLeafColorizeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._on3DLeafColorizeCB called"),this.publish({event:"on3DLeafColorize",data:e})},y.prototype._on3DLeafUnColorizeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._on3DLeafUnColorizeCB called"),this.publish({event:"on3DLeafUnColorize",data:e})},y.prototype._onTreeColorizeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onTreeColorizeCB called"),this.publish({event:"onTreeColorize",data:e})},y.prototype._onTreeUnColorizeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onTreeUnColorizeCB called"),this.publish({event:"onTreeUnColorize",data:e})},y.prototype._onUrlLoadedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onUrlLoadedCB called"),this.publish({event:"onUrlLoaded",data:{nbCgrLoaded:e.nbCgrLoaded,nbThbLoaded:e.nbThbLoaded}})},y.prototype._onVQDisabledCB=function(t){this._DEBUG&&console.log("ENO3DViewEventManager._onVQDisabledCB called"),this.displayNotification({eventID:"warning",msg:e.queryFailed_VQDisabled})},y.prototype._onLeafReferenceLoadedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onLeafReferenceLoadedCB called"),this.publish({event:"onLeafReferenceLoaded",data:e})},y.prototype._onLeafReferenceUnloadedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onLeafReferenceUnloadedCB called"),this.publish({event:"onLeafReferenceUnloaded",data:e})},y.prototype._registerViewEvents=function(){this.subscribe({event:"onFilterDropped"},this._onFilterDroppedCB.bind(this))},y.prototype._onFilterDroppedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFilterDroppedCB called"),this.clearWidgetBorder()},y.prototype._registerHideShowEvents=function(){this._hideShowControllerTokens.push(this._hideShowController.subscribe({event:"onHide"},this._onHideCB.bind(this))),this._hideShowControllerTokens.push(this._hideShowController.subscribe({event:"onShow"},this._onShowCB.bind(this))),this._hideShowControllerTokens.push(this._hideShowController.subscribe({event:"onExclusiveShow"},this._onExclusiveShowCB.bind(this)))},y.prototype._onHideCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onHideCB called"),this.publish({event:"onHide",data:e})},y.prototype._onShowCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onShowCB called"),this.publish({event:"onShow",data:e})},y.prototype._onExclusiveShowCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onExclusiveShowCB called"),this.publish({event:"onExclusiveShow",data:e})},y.prototype._registerDnDEvents=function(){this._dndTokens[0]=this._DnDDragOverCB.bind(this),this._dndTokens[1]=this._DnDDragEndCB.bind(this),this._dndTokens[2]=this._DnDDropCB.bind(this),this._dndTokens[3]=this._DnDDragEnterCB.bind(this),this._dndTokens[4]=this._DnDDragLeaveCB.bind(this),this.elements.container.addEventListener("dragenter",this._DnDDragEnterCB.bind(this)),this.elements.container.addEventListener("dragover",this._DnDDragOverCB.bind(this)),this.elements.container.addEventListener("dragleave",this._DnDDragLeaveCB.bind(this)),this.elements.container.addEventListener("dragend",this._DnDDragEndCB.bind(this)),this.elements.container.addEventListener("drop",this._DnDDropCB.bind(this)),this._isMouseOver=!1,this.elements.container.addEventListener("mouseenter",()=>{this._isMouseOver=!0}),this.elements.container.addEventListener("mouseleave",()=>{this._isMouseOver=!1}),this.elements.container.addEventListener("mouseover",()=>{this._isMouseOver=!0})},y.prototype._unregisterDnDEvents=function(){if(d)for(let e=0;e<this._csoTokens.length;++e)d.unsubscribe(this._csoTokens[e]);if(p)for(let e=0;e<this._psoTokens.length;++e)p.unsubscribe(this._psoTokens[e]);if(c)for(let e=0;e<this._hsoTokens.length;++e)c.unsubscribe(this._hsoTokens[e])},y.prototype._DnDDragOverCB=function(e){e.preventDefault(),this.addWidgetBorder(),e.shiftKey?this._dropZoneContainer.show("add_as_object"):this._dropZoneContainer.show("add_in_context")},y.prototype._DnDDragEndCB=function(e){this.clearWidgetBorder(),0!==this.getRoots().length||this._checkHiddenRoots()?this._dropZoneContainer.hide():this._dropZoneContainer.show("drop")},y.prototype._DnDDropCB=function(e){if(e.preventDefault(),e.stopPropagation(),this.getDOMElement("container").contains(e.target)){this._dropZoneContainer.hide();let t=!0;e.shiftKey&&(t=!1),this.addRootNodesFromContent({dndEvent:e,dispatch:!0,inContext:t}),this.clearWidgetBorder()}},y.prototype._DnDDragEnterCB=function(e){e.preventDefault(),this.clearWidgetBorder(),e.shiftKey?this._dropZoneContainer.show("add_as_object"):this._dropZoneContainer.show("add_in_context")},y.prototype._DnDDragLeaveCB=function(e){null!=e.relatedTarget&&e.relatedTarget.classList.contains("paddnd_invite_container")||(this._dropZoneContainer.hide(),0===this.getRoots().length&&this._dropZoneContainer.show(),this.clearWidgetBorder())},y.prototype._getProxyEvents=function(){return{onSetCurrentViewpoint:this._onSetCurrentViewpointCB.bind(this),onSharedAlert:this._onSharedAlertCB.bind(this),onFilterWarn:this._onFilterWarnCB.bind(this),onFocusChange:this._onFocusChangeCB.bind(this),onChangeControlDlgOpen:this._onChangeControlDlgOpenCB.bind(this),onSelect:this._onSelectCB.bind(this),onReframeSelection:this._onReframeSelectionCB.bind(this),onFocus:this._onFocusCB.bind(this),onPadDestroy:this._onPadDestroyCB.bind(this),onRequestViewPoint:this._onRequestViewPointCB.bind(this)}},y.prototype._onSetCurrentViewpointCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onSetCurrentViewpointCB called"),this._onSetCurrentViewpoint(e)},y.prototype._onSharedAlertCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onSharedAlertCB called");let t=s.getPromises().slice();s.createPromise((i,n)=>{Promise.all(t).then(n=>{t=null,0!==this.getRoots().length||this._checkHiddenRoots()?this._dropZoneContainer.hide():this._dropZoneContainer.show("drop"),this.displayNotification(e),i()})},"SharedAlert")},y.prototype._onFilterWarnCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFilterWarnCB called");let i=s.getPromises().slice();s.createPromise((n,o)=>{Promise.all(i).then(o=>{i=null,0!==this.getRoots().length||this._checkHiddenRoots()?this._dropZoneContainer.hide():this._dropZoneContainer.show("drop");let s="";switch(e){case"inauthoring":s=t.filterInAuthoring;break;case"notactivated":s=t.filterNotActivated}this.displayNotification({eventID:"warning",msg:s}),n()})},"FilterWarn")},y.prototype._onFocusChangeCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFocusChangeCB called"),e.sharedID==a.getSharedId()&&this.publish({event:"onFocusChange",data:e})},y.prototype._onChangeControlDlgOpenCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onChangeControlDlgOpenCB called"),"2D"===e.widget&&l.setSetting("changeControlDlgOpen",e.isOpen)},y.prototype._onSelectCB=function(e,t){this._DEBUG&&console.log("ENO3DViewEventManager._onSelectCB called");let i=s.getPromises().slice();s.createPromise((n,o)=>{Promise.all(i).then(o=>{if(i=null,!0===e.focusOn&&e.sharedID&&e.sharedID!==a.getSharedId())return console.log("Call from another instance hence not selecting"),void n();this.lockSelectionBroadcast(!0);try{let i=[],o=!1;if(e.paths){let t=[];if("2"===e.version)for(let i=0;i<e.paths.length;++i){const n=[];for(let t=0;t<e.paths[i].length;++t)n.push(e.paths[i][t].resourceid);t.push(n)}else t=e.paths;for(let e=0;e<t.length;++e)if(t[e].length){const n=this.unstreamPath(t[e]);n&&i.push({pathElement:n})}o=i.length!==e.paths.length}if(e.POIGroups&&e.POIGroups.length>0&&!e.fromPanel){const t=this.getController().unstreamPOIGroup(e.POIGroups[0]);if(t.length>0)for(let e=0;e<t.length;++e)i.push({pathElement:t[e]})}else if(e.POIs&&!e.fromPanel)for(let t=0;t<e.POIs.length;++t){const n=this.getController().unstreamPOI4Select(e.POIs[t]);if(n.length>0)for(let e=0;e<n.length;++e)i.push({pathElement:n[e]})}else e.ZOIs&&(i=this.getController().unstreamZOIs(e.ZOIs));if(e.referenceIds){const t=this.getController().getRootBag();let n=[];for(let o=0;o<e.referenceIds.length;++o){const s=this.getController().getNode({id:e.referenceIds[o]});s&&(n=_.buildPathesLeadingToNode(s,t));for(let e=0;e<n.length;++e)i.push({pathElement:n[e]})}}if(!0===e.exclusiveShow){const e=i.map(e=>e.pathElement);this._hideShowController.exclusiveShow({paths:e})}let s=f.getLinked()&&!0===l.getSetting("activateWidgetLink"),a=!!s&&f.getLinked().filter(e=>e.id===t.originWidgetId).length>0;i.length&&!e.noClear?(d.empty(),c.empty(),d.add(i),c.add(i)):!(s&&a||!s&&t.appid===r.appId())||!0===e.focusOn||o||e.noClear||e.noClear||(d.empty(),c.empty())}finally{this.lockSelectionBroadcast(!1),n()}})},"select")},y.prototype._onReframeSelectionCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onReframeSelectionCB called"),this.reframe()},y.prototype._onFocusCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onFocusCB called");let t=!1,i=!1,s=!1,a=!1,r=!1,l=0;e&&e.POIs&&(l=e.POIs.length,e.POIs.length&&(t=!0));let h=0;e&&e.ZOIs&&(h=e.ZOIs.length,e.ZOIs.length&&(i=!0));let p=0;e&&e.paths&&(p=e.paths.length,e.paths.length&&(s=!0));let u=0;e.POIGroups&&e.POIGroups.length&&(e.POIGroups.forEach(e=>{e&&(u+=e.POIs.length)}),a=!0);let g=0;var m;(e&&e.referenceIds&&(g=e.referenceIds.length,e.referenceIds.length&&(r=!0,g=e.referenceIds.length)),e&&"reframe"===e.intent)&&((m=o.getPADTracker({eventCategory:"usage",eventAction:"3d_reframeEvent_stats"})).persDim.pd2=t&&i||a&&i||r&&i||s&&i?"POI and ZOI":t?"POI":i?"ZOI":a?"POI Group":s?"Path":r?"ReferenceId":"error",m.persVal.pv2=l,m.persVal.pv3=h,m.persVal.pv4=u,m.persVal.pv5=p,m.persVal.pv6=g,m.trackPageEvent());e&&"focus"===e.intent&&((m=o.getPADTracker({eventCategory:"usage",eventAction:"3d_focusEvent_stats"})).persDim.pd2=t&&i||a&&i||r&&i||s&&i?"POI and ZOI":t?"POI":i?"ZOI":a?"POI Group":s?"Path":r?"ReferenceId":"error",m.persVal.pv2=l,m.persVal.pv3=h,m.persVal.pv4=u,m.persVal.pv5=p,m.persVal.pv6=g,m.trackPageEvent());let C=v.subscribe({event:"/VISU/"},e=>{"@onViewpointBeginMove"===e.eventType&&(v.unsubscribe(C),f.unsubscribe("DS/ExternalWdgtCom/ViewPointSync"))}),y=v.subscribe({event:"/VISU/"},e=>{"@onViewpointEndMove"===e.eventType&&(v.unsubscribe(y),f.subscribe("DS/ExternalWdgtCom/ViewPointSync",this._onViewPointSync.bind(this)))});const D=e=>{for(var t=[],i=[],o=[],s=0;s<e.length;s++)if((t=this.getController().unstreamPOI(e[s])).length>0)for(var a=0;a<t.length;a++)i.push(t[a]);n.reframeOn({paths:i,viewpoint:this.getViewpoint(),context:this});for(s=0;s<e.length;s++)if((t=this.getController().unstreamPOI4Select(e[s])).length>0)for(a=0;a<t.length;a++)o.push({pathElement:t[a]});o.length&&(d.empty(),c.empty(),d.add(o),c.add(o))};if(e.paths||e.referenceIds||e.POIs||e.ZOIs)if("reframe"===e.intent){var b=[];if(e.paths)return e.paths.forEach(e=>{if(e.length){var t=this.unstreamPath(e);t&&b.push(t)}}),void n.reframeOn({paths:b,viewpoint:this.getViewpoint()});if(e.POIs&&e.POIs.length&&D(e.POIs),e.ZOIs&&e.ZOIs.length){var w=this.getController().unstreamZOIs(e.ZOIs);if(w.length){d.empty(),c.empty(),d.add(w),c.add(w);b=[];for(var E=0;E<w.length;E++)b.push(w[E].pathElement);n.reframeOn({paths:b,viewpoint:this.getViewpoint()})}}}else if(e.paths)this._executeCommand({handlerId:"ENO3DNavigateOnSelectionCmd",args:{paths:e.paths}});else if(e.referenceIds){for(var S=[],P=[],O=[],M=0;M<e.referenceIds.length;M++)this.getController().getNode({id:e.referenceIds[M]})?P=P.concat(_.buildPathesLeadingToNode(this.getController().getNode({id:e.referenceIds[M]}),this.getController().getRootBag())):O.push(e.referenceIds[M]);if(O.length)Promise.all(this.getController()._loadPOI(O)).then(e=>{for(var t=0;t<e.length;t++)e[t]&&(S=S.concat(e[t]));for(var i=0;i<P.length;i++)S.push(this.streamPath(P[i]));this._executeCommand({handlerId:"ENO3DNavigateOnSelectionCmd",args:{paths:S}})});else{for(var B=0;B<P.length;B++)S.push(this.streamPath(P[B]));this._executeCommand({handlerId:"ENO3DNavigateOnSelectionCmd",args:{paths:S}})}}else if(e.POIs&&e.POIs.length){var I=!1;e&&!0===e.displayPOITooltip&&(I=!0),this._executeCommand({handlerId:"ENO3DNavigateOnSelectionCmd",args:{paths:e.POIs,kind:"POIs",focusTooltip:I}})}else e.ZOIs&&e.ZOIs.length&&this._executeCommand({handlerId:"ENO3DNavigateOnSelectionCmd",args:{paths:e.ZOIs,kind:"ZOIs"}});else console.error("No path to focus on or call from another 3D widget reference")},y.prototype._onPadDestroyCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onPadDestroyCB called"),this.publish({event:"onWidgetDestroyed",data:e})},y.prototype._onRequestViewPointCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRequestViewPointCB called");const t=this.getViewpoint(),i=n.buildViewPoint(t);this._commandProxy.updateViewPoint(i)},y.prototype._registerCSOEvents=function(){this._CSOAddCB=this._CSOAddCB.bind(this),this._CSOChangeCB=this._CSOChangeCB.bind(this),this._CSOPreEmptyCB=this._CSOPreEmptyCB.bind(this),this._CSOEmptyCB=this._CSOEmptyCB.bind(this),this._CSOCheckPathCB=this._CSOCheckPathCB.bind(this),d.onPostAdd&&this._csoTokens.push(d.onPostAdd(this._CSOAddCB)),this.isSelectiveLoadingActivated()&&d.onChange&&this._csoTokens.push(d.onChange(g.debounce(this._CSOChangeCB))),d.onPostRemove?this._csoTokens.push(d.onPostRemove(this._CSOAddCB)):this._csoTokens.push(d.onRemove(g.debounce(this._CSOAddCB,100))),this._csoTokens.push(d.onPreEmpty(this._CSOPreEmptyCB)),this._csoTokens.push(d.onEmpty(this._CSOEmptyCB)),this._viewer.onPreAddRemoveXSO?this._viewer.onPreAddRemoveXSO(this._CSOCheckPathCB.bind(this)):(this._psoTokens.push(p.onPreAdd(this._CSOCheckPathCB)),this._csoTokens.push(d.onPreAdd(this._CSOCheckPathCB)),this._hsoTokens.push(c.onPreAdd(this._CSOCheckPathCB)))},y.prototype._CSOAddCB=function(){if(!this._lockCSONotification&&!this._lockCSONotificationEmpty){var e=[],t=[],n=[],s=[],r={},h=[],c=d.get(),p=null,u={version:"1.1",paths:e,POIs:t,POIGroups:n,ZOIs:s,attributes:r,sharedID:a.getSharedId(),focusOn:this._reframeFocus};c.forEach(function(o){i.isAModelPath(o.pathElement)&&this.streamPathWithType(o.pathElement,e,r),i.isAPOIPath(o.pathElement)&&(p=i.getPOILayerId(o.pathElement),this.streamPOI(o.pathElement,p,t)),i.isAPOIGroupPath(o.pathElement)&&this.streamPOIGroup(o.pathElement,n),i.isAZOIPath(o.pathElement)&&this.streamZOI(o.pathElement,s)}.bind(this));let E=!1,S=!1,P=!1;var g=0;d.get()&&(g=d.get().length);var m=0;t&&t.length&&(m=t.length,E=!0);var _=0;n&&n.length&&(n.forEach(function(e){e&&(_+=e.POIs.length)}.bind(this)),P=!0);var f=0;if(s&&s.length&&(f=s.length,S=!0),m>0||f>0||_>0){var v=o.getPADTracker({eventCategory:"usage",eventAction:"3d_selectEvent_stats"});v.setEventData({eventLabel:"outgoing_selection",eventValue:m+_+f}),v.persDim.pd2="Outgoing Selection",v.persDim.pd3=E&&S||P&&S?"POI and ZOI":E?"POI":S?"ZOI":P?"POI Group":"error",v.persVal.pv2=m+_,v.persVal.pv3=f,v.persVal.pv4=g,v.trackPageEvent()}if(l.getSetting("authorizeChangeControl")){var y=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");u.changeControl=y.get()}var D=!!this._searchRecent&&this._searchRecent;if(!0===D&&(u.searchDone=D),this._commandProxy.select(u),!0===this._authorizeSet3DStructure)if(e&&e.forEach(function(e){h.push(e[e.length-1])}),this.set3DXContentData({nodes2Open:h,selectedPaths:u}),!0!==l.getSetting("settypes")){var b=this.set3DStructure4OpenInCV5({nodes2Open:h,selectedPaths:u}),w=JSON.stringify(b);C.publish("setStructure",{structure:w})}else this.setTypesFor3D(u)}},y.prototype._CSOChangeCB=function(){if(this.getStatusBar()){const e=d.get();let t=0;for(let i=0;i<e.length;++i)null!==e[i].pathElement&&++t;t?(this.getStatusBar().setSelection({length:t}),this.enableCmd("ActionBar_Attributes")):(this.getStatusBar().clearSelection(),this.disableCmd("ActionBar_Attributes"))}},y.prototype._CSOPreEmptyCB=function(){this._lockCSONotificationEmpty=!0},y.prototype._CSOEmptyCB=function(){this._lockCSONotificationEmpty=!1,this._lockCSONotification||this._commandProxy.select({paths:[],sharedID:a.getSharedId(),focusOn:this._reframeFocus})},y.prototype._CSOCheckPathCB=function(e){function t(e){if(e&&e.pathElement&&e.pathElement.externalPath.length&&i.isAModelPath(e.pathElement)){let t=e.pathElement,n=t.getLastElement(!0);for(;t&&!i.isReference(n)&&t.externalPath.length>2;)(t=t.getParentPath())&&(n=t.getLastElement(!0));return e.pathElement=t,e}return e}if(!this._lockCSONotification&&"PRODUCT"===l.getSetting("enopad3dviewer_selectionFilter"))if(e instanceof Array){var n=0,o=e.length;for(n=0;n<o;n++)(e[n].event||this._viewer.onPreAddRemoveXSO)&&t.call(this,e[n])}else(e.event||this._viewer.onPreAddRemoveXSO)&&t.call(this,e)},y.prototype._onR2VLoadedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onR2VLoadedCB called"),this.publish({event:"onR2VLoaded",data:e})},y.prototype._onRealAssetLoadedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onRealAssetLoadedCB called"),this.publish({event:"onRealAssetLoaded",data:e})},y.prototype._onSOIDroppedCB=function(e){this._DEBUG&&console.log("ENO3DViewEventManager._onSOIDroppedCB called"),this.publish({event:"onSOIDropped",data:e})},y}),define("DS/ENO3DView/controller/ENO3DPagerNavigationController",["UWA/Promise","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADPager","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/Visualization/ThreeJS_DS","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/ENOPAD3DViewer/utils/PAD3DPOIGroupingOptions"],function(e,t,i,n,o,s,a,r,l){"use strict";function h(e){if(h.instance)return h.instance._idsPath=e.args.paths,h.instance._kind=e.args.kind,h.instance._focusTooltip=e.args.focusTooltip,this._viewer&&(this._viewer._focusTooltip=e.args.focusTooltip),h.instance.beginExecute(),h.instance;h.instance=this,this._CBTokens=[],this._view=null,this._selection=[],this._selectedIdx=null,this._previousCB=null,this._nextCB=null,this._closeCB=null,this._csoChangeCB=null,this._escapeCB=null,this._lockedNodes=[],this.useModelBoundingSphere=!1,this._idsPath=e.args.paths,this._kind=e.args.kind,this._focusTooltip=e.args.focusTooltip,this.ec=e.executionContext,this._viewer=this.ec.getComponent("Viewer"),this._viewer&&(this._viewer._focusTooltip=e.args.focusTooltip),this.beginExecute()}return h.prototype.destroy=function(){this._viewer._focusTooltip=!1,this._focusTooltip=!1},h.prototype.beginExecute=function(){this._viewer&&(this._viewer._focusTooltip=this._focusTooltip),this._CBTokens.push(this._viewer.subscribe({event:"onUpdatePager"},e=>{this.updatePager(e)})),this._CBTokens.push(this._viewer.subscribe({event:"onFocusChange"},e=>{this.focusChange(e)})),this._escapeCB=(e=>{27===e.keyCode&&this.endExecute()}),this.prepareCSOData(this._idsPath).then(e=>{document.addEventListener("keyup",this._escapeCB),this.useModelBoundingSphere=e,this._selectedIdx=0;var i;i=t.get().slice(),this._internalCSOChange=!1,"POIs"!==this._kind&&"ZOIs"!==this._kind||(this._selection=[]);for(var n=0;n<i.length;n++)null!==i[n].pathElement&&this._selection.push(i[n]);this._selection.length>1?(null===this._view&&(this._previousCB=function(){this.focusChange({operation:"previous"})}.bind(this),this._nextCB=function(){this.focusChange({operation:"next"})}.bind(this),this._reframeAllCB=function(){if(this._selection.length){const e=[];for(let t=0;t<this._selection.length;++t)this._selection[t].pathElement&&e.push(this._selection[t].pathElement);if("POIs"===this._kind||"ZOIs"===this._kind?s.reframeOn({paths:e,viewpoint:this._viewer.getViewpoint(),context:this._viewer}):s.reframeOnCandidates({paths:e,viewpoint:this._viewer.getViewpoint(),context:this._viewer}),"POIs"===this._kind&&!0===this._viewer._focusTooltip){this._viewer.getController()._createNode_and_Tooltip_and_pinTooltip_forFocRef(e,this._viewer.getController(),!0,!1,!0)}}}.bind(this),this._selectAllCB=function(){this.restoreSelection()}.bind(this),this._closeCB=function(){this.endExecute()}.bind(this),this._view=new o({renderTo:this._viewer.getDOMElement("container"),context:this._viewer,callbacks:{onPrevious:this._previousCB,onNext:this._nextCB,onSelectAll:this._selectAllCB,onReframeAll:this._reframeAllCB,onClose:this._closeCB}})),"POIs"===this._kind?this.reframeOnPOI():"ZOIs"===this._kind?this.reframeOnZOI():this.reframeOn(e),this._view.show(),this._csoChangeCB=t.onRemove(function(){this._internalCSOChange||this._viewer.getController()._updateClustersInProgress||this.endExecute()}.bind(this))):1===this._selection.length?("POIs"===this._kind?this.reframeOnPOI():"ZOIs"===this._kind?this.reframeOnZOI():this.reframeOn(e),this._csoChangeCB=t.onRemove(function(){this._internalCSOChange||this._viewer.getController()._updateClustersInProgress||this.endExecute()}.bind(this))):(console.log("CSO selection is empty"),this.endExecute()),require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t,i){var n=t.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});n.setEventData({eventLabel:"PAD3DViewerNavigateOnSelectionCmd",eventValue:e?e.length:0}),n.trackPageEvent()}.bind(this,this._selection))})},h.prototype.endExecute=function(e){this._viewer.getController().unlockNodes({ids:this._lockedNodes}),this._viewer.getController()&&this._viewer.getController()._clean_allTooltip_from_isFromFocusRefCmd(this._viewer.getController()),this._viewer._reframeFocus=!1,this._viewer._focusTooltip=!1,this._focusTooltip=!1,this._selection=[],this._selectedIdx=null,this._previousCB=null,this._nextCB=null,this._selectAllCB=null,this._reframeAllCB=null,this._closeCB=null,this._lockedNodes=[];for(let e=0;e<this._CBTokens.length;++e)this._viewer.unsubscribe(this._CBTokens[e]);this._csoChangeCB&&t.unsubscribe(this._csoChangeCB),this._escapeCB&&document.removeEventListener("keyup",this._escapeCB),e&&e.performingAgain||this._view&&this._view.visible&&this._view.hide()},h.prototype.prepareCSOData=function(n){return new e(e=>{const o=e=>{this._viewer.lockSelectionBroadcast(!0),this.originalSelection=e;let n=[];t.empty(),i.empty();const o=this._viewer.getController().getHiddenRootIds();if("POIs"===this._kind)for(let t=0;t<e.length;++t){const i=this._viewer.getController().unstreamPOI(e[t]);if(i&&i.length)for(let e=0;e<i.length;++e)n.push({pathElement:i[e]})}else if("ZOIs"===this._kind)n=this._viewer.getController().unstreamZOIs(e);else for(let t=0;t<e.length;++t)if(-1===o.indexOf(e[t][0])){const i=this._viewer.unstreamPath(e[t]);n.push({pathElement:i})}n.length&&(t.add(n),i.add(n)),this._viewer.lockSelectionBroadcast(!1)},s=[];if("POIs"!==this._kind&&"ZOIs"!==this._kind)for(let e=0;e<n.length;++e)null===this._viewer.unstreamPath(n[e])&&s.push(n[e]);0===s.length?(o(n),e(!0)):this._viewer.getController().expand({paths:s,withFrustumFilter:!1,expand_iter:"0",singleAdd:!1,onComplete:t=>{if("object"==typeof t){for(let e=0;e<n.length;++e)this._lockedNodes.push(n[e][n[e].length-1]);this._viewer.getController().lockNodes({ids:this._lockedNodes}),o(n),e(!0)}else console.error("Incorrect data type in expand onComplete()")}})})},h.prototype.updatePager=function(e){const t=[];e.forEach(e=>{const i=this._viewer.unstreamPath(e);t.push({pathElement:i})}),this._selection=t,this._selectedIdx=0,"POIs"===this._kind?this.reframeOnPOI():"ZOIs"===this._kind?this.reframeOnZOI():this.reframeOn(this.useModelBoundingSphere)},h.prototype.focusChange=function(e){"POIs"===this._kind&&!0===this._viewer._focusTooltip&&(this._viewer.render(),this._viewer.getController()._clean_allTooltip_from_isFromFocusRefCmd(this._viewer.getController())),this._selection&&this._selection.length>0&&("previous"==e.operation&&("POIs"===this._kind?(this._selectedIdx--,this.reframeOnPOI()):"ZOIs"===this._kind?(this._selectedIdx--,this.reframeOnZOI()):(this._selectedIdx--,this.reframeOn(this.useModelBoundingSphere))),"next"==e.operation&&("POIs"===this._kind?(this._selectedIdx++,this.reframeOnPOI()):"ZOIs"===this._kind?(this._selectedIdx++,this.reframeOnZOI()):(this._selectedIdx++,this.reframeOn(this.useModelBoundingSphere))))},h.prototype.restoreSelection=function(){let e=[];if(this._viewer.lockSelectionBroadcast(!0),this.originalSelection.length)for(let t=0;t<this.originalSelection.length;++t)if("POIs"===this._kind){const i=this._viewer.getController().unstreamPOI4Select(this.originalSelection[t]);for(let t=0;t<i.length;++t)null!==i[t]&&e.push({pathElement:i[t]})}else if("ZOIs"===this._kind)e=this._viewer.getController().unstreamZOIs(this.originalSelection);else{const i=this._viewer.unstreamPath(this.originalSelection[t]);null!==i&&e.push({pathElement:i})}this._internalCSOChange=!0,i.empty(),t.empty(),i.add(e),t.add(e),this._internalCSOChange=!1,this._viewer.lockSelectionBroadcast(!1),"POIs"===this._kind&&setTimeout(()=>{this._viewer.getController()._tooltipFrame&&!this._viewer.getController()._tooltipFrame.isClosed()&&this._viewer.getController()._tooltipFrame.hide()},200)},h.prototype.reframeOn=function(e){-1===this._selectedIdx&&(this._selectedIdx=this._selection.length-1);const n=this._selectedIdx%this._selection.length;if(this._view){const e=n+1+"/"+this._selection.length;this._view.setLabel(e)}this._internalCSOChange=!0,this._viewer._reframeFocus=!0,this._viewer.lockSelectionBroadcast(!0),t.empty(),i.empty(),t.add(this._selection[n]),i.add(this._selection[n]),this._internalCSOChange=!1,this._viewer.lockSelectionBroadcast(!1),(this._viewer.getHideShowController()&&!this._viewer.getHideShowController().isVisible(this._selection[n].pathElement)&&1===this._viewer._viewer.getVisibleSpace()||this._viewer.getHideShowController()&&this._viewer.getHideShowController().isVisible(this._selection[n].pathElement)&&0===this._viewer._viewer.getVisibleSpace())&&this._viewer.displayNotification({eventID:"info",msg:r.swapToSeeSelection});let o=null;const l=this._viewer.getController().buildArrayFromPath(this._selection[n].pathElement);if(l&&l.length>0&&this._viewer.getController()._model.getWorldMatrix){const e=this._viewer.getController().getReferenceBoundingSphere(l[l.length-1]);if(e){var h=this._viewer.getController()._model.getWorldMatrix(l);e.applyMatrix4(h);const t=this._selection[n].pathElement.getBoundingSphere();let i=new a.Sphere;!t||t.isNaN()||t.empty()?i=e:e.mergeWithSphere(t,i),o=function(e,t){if(t&&!t.isNaN()){const i=t.clone();e?e.mergeWithSphere(i,e):e=i}return e}(o,i),s.reframeOn({BS:o,viewpoint:this._viewer.getViewpoint()})}else s.reframeOn({paths:[this._selection[n].pathElement],viewpoint:this._viewer.getViewpoint()})}else s.reframeOn({paths:[this._selection[n].pathElement],viewpoint:this._viewer.getViewpoint()})},h.prototype.reframeOnPOI=function(){-1===this._selectedIdx&&(this._selectedIdx=this._selection.length-1);const e=this._selectedIdx%this._selection.length;if(this._view){var n=e+1+"/"+this._selection.length;this._view.setLabel(n)}this._internalCSOChange=!0,this._viewer._reframeFocus=!0,this._viewer.lockSelectionBroadcast(!0),t.empty(),i.empty(),t.add(this._selection[e]),i.add(this._selection[e]),this._viewer.lockSelectionBroadcast(!1);const o=this._selection[e].pathElement.getLastElement(!0);let s,a,r,h,d,c,p;if(o.name.indexOf("PAD3DPOINode")>-1){let e;if(o.getLayerID&&(s=o.getLayerID()),o._layerId&&(s=o._layerId),o.name&&(e=o.name.split("_")),(a=e[e.length-1])&&(a=parseInt(a)),s&&(r=this._viewer.getController()._layerPOIsIdInstancingNodeMap.get(s)),!0===l.isMemPCS()&&this._viewer.getController()._layerPOIsIdInstancingNodeMapMaster&&this._viewer.getController()._layerPOIsIdInstancingNodeMapMaster.size){const e=this._viewer.getController()._layerPOIsIdInstancingNodeMapMaster.get(s);if(e){const t=e.get(a),i=this._viewer.getController()._layers.get("POIs").get(s);this._viewer.getController()._seedNewNode(t,i,this._viewer.getController()._layerPOIsIdInstancingNodeMap.get(s),this._viewer.getController()._layerPOIsIdInstancingIndexMap.get(s),100,1);r=this._viewer.getController()._layerPOIsIdInstancingNodeMap.get(s)}}r&&(p=r.get(a))&&(h=p.getLabelPOI(),c=p.getId(),d=p.getColorPOI())}else a=this._selection[e].pathElement.instanceId,(s=o.name)&&(r=this._viewer.getController()._layerPOIsIdInstancingNodeMap.get(s)),r&&(p=r.get(a)),h=p.label,c=p.id,d=p.color;if(p){const e={resourceid:c,instanceid:a},t={layerID:s,layer:s,openPanel:!0,pois:[{layer:s,data:{instanceId:a,label:h,id:c,color:d}}]};this._viewer.getController()._reframeOnPOI(e,t),this._internalCSOChange=!1}},h.prototype.reframeOnZOI=function(){-1===this._selectedIdx&&(this._selectedIdx=this._selection.length-1);const e=this._selectedIdx%this._selection.length;if(this._view){const t=e+1+"/"+this._selection.length;this._view.setLabel(t)}this._internalCSOChange=!0,this._viewer._reframeFocus=!0,this._viewer.lockSelectionBroadcast(!0),t.empty(),i.empty(),t.add(this._selection[e]),i.add(this._selection[e]),this._viewer.lockSelectionBroadcast(!1),s.reframeOn({paths:[this._selection[e].pathElement],viewpoint:this._viewer.getViewpoint()}),this._internalCSOChange=!1},h}),define("DS/ENO3DView/views/ENO3DMinimap",["css!DS/ENO3DView/ENO3DView.css","DS/Utilities/Dom","DS/ENO3DView/views/ENO3DMinimapCanvas","DS/ENO3DView/views/ENO3DMinimapToolbar"],function(e,t,i,n){"use strict";function o(e){this.elements={},this.options=e||{},this.options=Object.assign({nbfloor:1,nbbasement:0,positionUser:null,info:null,startAngle:0},this.options),this._localModelEvents=e.modelEvents,this.__create()}return o.prototype.__create=async function(){this.elements.proposalUX=t.createElement("div",{class:"minimap-proposalUX"}),this.elements.canva=new i({positionUser:this.options.positionUser,startAngle:this.options.startAngle,modelEvents:this._localModelEvents}),this.elements.proposalUX.appendChild(this.elements.canva.getHTML()),this.elements.footer=t.createElement("div",{class:"minimap-footer"}),this.elements.proposalUX.appendChild(this.elements.footer),this.elements.toolbar=new n({nbfloor:this.options.nbfloor,level:this.options.positionUser.idLevel,modelEvents:this._localModelEvents}),this.elements.toolbar.__setCanva(this.elements.canva),this.elements.toolbar.__setFooter(this.elements.footer),this.elements.footer.appendChild(this.elements.toolbar.getHTML())},o.prototype._floorSelectedCb=function(e){},o.prototype.__setSizeCanva=async function(){this.elements.canva.__setWidth(parseInt(document.defaultView.getComputedStyle(this.elements.proposalUX).width)),this.elements.canva.__setHeight(parseInt(document.defaultView.getComputedStyle(this.elements.proposalUX).height))},o.prototype.__updateLevel=function(e){return require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DMinimap-usage"});t.setEventData({eventLabel:"ENO3DMinimap-setLevel"}),t.trackPageEvent()}),new Promise(t=>{this.elements.canva.__changeIdLevel(e).then(()=>{t()})})},o.prototype.__updateUser=function(e){e.y=this.elements.canva.image.height-e.y,this.elements.canva.__setPosUser(e.x,e.y,!1)},o.prototype.__UpdateState=async function(e,t){this.elements.toolbar.__updateIcon(e.id),this.init?(this.__updateUser(t),this.elements.canva.__draw()):(await this.elements.canva.__changeIdLevel(e),this.__updateUser(t),this.init=!0,this.elements.canva.__draw(),this.elements.canva.__zoomFit())},o.prototype.__setSight=async function(e,t){this.elements.canva.__setSight(e,t)},o.prototype.setSight=async function(e,t){this.elements.canva.__setSight(e,t)},o.prototype.__resizeCanva=function(){let e=this.elements.canva.canva.getContext("2d"),t=this.elements.canva.canva.width,i=this.elements.canva.canva.height;e.save(),this.__setSizeCanva(),e.restore();let n=this.elements.canva.canva.width/t,o=this.elements.canva.canva.height/i;e.setTransform(e.getTransform().a,e.getTransform().b,e.getTransform().c,e.getTransform().d,e.getTransform().e*n,e.getTransform().f*o),this.elements.canva.__draw()},o.prototype.refreshCanva=function(){this.__resizeCanva(),this.elements.canva.__zoomFit()},o.prototype.getHTML=function(){return this.elements.proposalUX},o.prototype.delete=function(){delete this.elements.proposalUX,delete this.elements.canva,delete this.elements.footer,delete this.elements.toolbar},o}),define("DS/ENO3DView/views/ENO3DMinimapPanel",["css!DS/ENO3DView/ENO3DView.css","DS/PADServices/utils/PlatformURL","DS/Windows/Panel","DS/ENO3DView/views/ENO3DMinimap","DS/CoreEvents/ModelEvents","DS/R2VMinimap/R2VMinimapServices","DS/PADServices/utils/GlobalModelEvents"],function(e,t,i,n,o,s,a){"use strict";function r(e){this._parentContainer=e.renderTo,this.model=null,this._group=null,this._localModelEvents=new o,this.elements={},this._subs=[],this.initialized=!1,this.view={eye:{x:null,y:null,z:null},sight:{x:null,y:null,z:null},up:{x:null,y:null,z:null}},this._data=e.data,this._events=e.events,this._icon=e.icon}return r.prototype._buildPanel=function(){this.deletePanel(),this.elements.container=document.createElement("div"),this.elements.container.classList.add("ENO3DMinimapPanel-container"),this.elements.minimap=document.createElement("div"),this.elements.minimap.classList.add("ENO3DMinimapPanel-minimap"),this.elements.container.appendChild(this.elements.minimap),this.elements.panel||(this.elements.panel=new i({title:this._data["ds6w:label"]?this._data["ds6w:label"]:"Minimap",icon:this._icon,immersiveFrame:this._parentContainer,identifier:"ENO3DMinimapPanel",position:{offsetX:this._parentContainer.elements.container.offsetWidth-250,offsetY:0},width:250,height:250,minWidth:250,minHeight:250,content:this.elements.container,allowedDockAreas:12,titleBarVisibleFlag:!0,maximizeButtonFlag:!0,closeButtonFlag:!1,resizableFlag:!0}),this.elements.panel.hide()),this.__addListeners()},r.prototype.__supListeners=function(){for(let e=0;e<this._subs.length;e++)this._localModelEvents.unsubscribe(this._subs[e])},r.prototype.__addListeners=function(){this.elements.panel.addEventListener("resize",function(){this.minimap&&this.minimap.__resizeCanva()}.bind(this)),this.elements.panel.addEventListener("placeChange",function(e){this.minimap&&(this.minimap.__resizeCanva(),this.minimap.refreshCanva())}.bind(this)),this.elements.panel.addEventListener("contentVisibleStateChange",function(e){setTimeout(()=>{this.minimap&&this.minimap.refreshCanva()},100)}.bind(this)),this._localModelEvents.subscribe({event:"ENO3DView/ENO3DMinimap/View"},this.__updView.bind(this)),this._subs.push(this._localModelEvents.subscribe({event:"ENO3DView/ENO3DMinimap/GetLevel"},async function(e){let t=await this.minimapServices.getInformationForLevel(e.idLevel);await this.minimap.__updateLevel(t),require(["DS/PADServices/utils/PADTrackerManager"],i=>{var n=i.getPADTracker({eventCategory:"usage",eventAction:"3d_minimap_stats"});n.setEventData({eventLabel:"minimap_level_change",eventValue:this.minimapServices.hasMinimap()?1:0}),n.persVal.pv2=this.minimap.options.nbfloor,n.persVal.pv3=e.idLevel,n.persVal.pv4=t&&t.acquisitionPoints?t.acquisitionPoints.length:0,n.trackPageEvent()}),this.minimap.elements.canva.__draw()}.bind(this))),this._subs.push(this._localModelEvents.subscribe({event:"ENO3DView/ENO3DMinimap/GetViewPoint"},function(e){let t=this.minimapServices.getViewpointFromPosition(e.idLevel,e.x,e.y);e.duration||(e.duration=500),this.view.eye.x=t.x,this.view.eye.y=t.y,this.view.eye.z=t.z,!0!==e.draggingUser&&a.publish({event:"ENO3DView/ENO3DMinimap/set",data:{focus:this.view.focus,fov:this.view.fov,projection:this.view.projection,near:this.view.near,far:this.view.far,up:this.view.up,eye:{x:t.x,y:t.y,z:t.z},sight:this.view.sight,duration:e.duration,sightchange:!1,updateOnlyEnd:e.updateOnlyEnd}})}.bind(this))),this._subs.push(this._localModelEvents.subscribe({event:"ENO3DView/ENO3DMinimap/SetView"},async function(e){this.view.sight.x=e.x,this.view.sight.y=e.y,this.view.up.x=1e-7,this.view.up.y=1e-7,this.view.up.z=.9999999,a.publish({event:"ENO3DView/ENO3DMinimap/set",data:{focus:this.view.focus,fov:this.view.fov,projection:this.view.projection,near:this.view.near,far:this.view.far,up:this.view.up,eye:{x:this.view.eye.x,y:this.view.eye.y,z:this.view.eye.z},sight:this.view.sight,duration:0,sightchange:!0,updateOnlyEnd:!1}})}.bind(this))),this._subs.push(this._localModelEvents.subscribe({event:"ENO3DView/ENO3DMinimap/UpdateView"},async function(e){this.view=e,this._updateFromView(e)}.bind(this)))},r.prototype.init=function(e){return new Promise((i,o)=>{if(this.elements.minimap&&this.elements.minimap.hasChildNodes()&&this.elements.minimap.removeChild(this.elements.minimap.firstChild),this._data&&this._data.resourceid&&e){this.minimapServices=new s,this.setView(e);var a={psId:this._data.resourceid,getURL:async function(e){return await t.getPlatformURL(e)}};this.minimapServices.initialize(a).then(async()=>{try{if(this.initialized=!0,!0===this.minimapServices.hasMinimap()){let e=await this.minimapServices.getNumberOfLevel(),t=await this.minimapServices.getPositionOnMinimap(this.view.eye),i=await this.minimapServices.getInformationForLevel(t.idLevel);this._buildPanel(),this.minimap=await new n({nbfloor:e,positionUser:t,info:i,startAngle:0,modelEvents:this._localModelEvents}),this.minimap.setSight(this.view.sight.x,-this.view.sight.y),this.minimap.__UpdateState(i,t.pointInMap),require(["DS/PADServices/utils/PADTrackerManager"],e=>{var n=e.getPADTracker({eventCategory:"usage",eventAction:"3d_minimap_stats"});n.setEventData({eventLabel:"minimap_init",eventValue:this.minimapServices.hasMinimap()?1:0}),n.persVal.pv2=this.minimap.options.nbfloor,n.persVal.pv3=t.idLevel,n.persVal.pv4=i&&i.acquisitionPoints?i.acquisitionPoints:0,n.trackPageEvent()}),this.__updView("map"),this.minimap.__resizeCanva(),this.publish({event:"ENO3DView/ENO3DMinimap/MinimapInitialized",data:{hasMinimap:!0,id:this._data.resourceid}})}else this.publish({event:"ENO3DView/ENO3DMinimap/MinimapInitialized",data:{hasMinimap:!1,id:this._data.resourceid}});i()}catch(e){console.warn("Error on minimap initialize : "+e),this.publish({event:"ENO3DView/ENO3DMinimap/MinimapInitialized",data:{hasMinimap:!1,id:this._data.resourceid}}),o()}})}})},r.prototype.publish=function(e){this._localModelEvents.publish({event:e.event,data:e.data})},r.prototype.subscribe=function(e){return this._localModelEvents.subscribe({event:e.event},e.callback)},r.prototype.unsubscribe=function(e){return this._localModelEvents.unsubscribe(e)},r.prototype.__draw=function(){this.minimap.elements.canva.__draw()},r.prototype.__resizeCanva=function(){this.minimap.__resizeCanva()},r.prototype._updateFromView=async function(e){if(this.minimapServices){let t=await this.minimapServices.getPositionOnMinimap(e.eye),i=await this.minimapServices.getInformationForLevel(t.idLevel);this.minimap&&(this.minimap.setSight(e.sight.x,-e.sight.y),this.minimap.__UpdateState(i,t.pointInMap))}},r.prototype.setView=function(e){this.view.eye.x=e.eye[0].x,this.view.eye.y=e.eye[0].y,this.view.eye.z=e.eye[0].z,this.view.far=e.far,this.view.focus=e.focus,this.view.fov=e.fov,this.view.near=e.near,this.view.projection=e.projection,this.view.sight.x=e.sight[0].x,this.view.sight.y=e.sight[0].y,this.view.sight.z=e.sight[0].z,this.view.up.x=e.up[0].x,this.view.up.y=e.up[0].y,this.view.up.z=e.up[0].z},r.prototype.getView=function(){return this.view},r.prototype.getResourceId=function(){return this._data.resourceid},r.prototype.updateView=function(e){this.minimap&&this.minimap.updateView(e)},r.prototype.__updView=function(e){switch(e){case"map":this.__updMap()}},r.prototype.__updMap=function(){return!1===this.minimapServices.hasMinimap()?void this.setVisibility(!1):void this.elements.minimap.appendChild(this.minimap.getHTML())},r.prototype.isInitialized=function(){return!!this.minimapServices&&this.minimapServices.options.isInitialize},r.prototype.hasMinimap=function(){return!(!this.minimapServices||!0!==this.minimapServices.options.isInitialize||"function"!=typeof this.minimapServices.hasMinimap)&&this.minimapServices.hasMinimap()},r.prototype.close=function(){this.setVisibility(!1),"function"==typeof this._events.closeMinimap&&this._events.closeMinimap(this._data.resourceid),this.deletePanel()},r.prototype.setVisibility=function(e){!0===e?(this.elements.panel&&this.elements.panel.show(),this.minimap&&this.minimap.refreshCanva()):!1===e&&this.elements.panel&&this.elements.panel.hide()},r.prototype.deletePanel=function(){this.__supListeners(),this.elements&&this.elements.container&&(this.elements.container.innerHTML=""),this.elements.panel&&this.elements.panel.hide(),this.minimap&&(this.minimap.delete(),delete this.minimap),delete this.elements.panel,delete this.elements.container},r}),define("DS/ENO3DView/mixins/ENO3DViewR2VMinimapManager",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/PADServices/utils/GlobalModelEvents","DS/ENO3DView/views/ENO3DMinimapPanel","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/WebappsUtils/WebappsUtils","DS/Utilities/Utils","DS/ENOXInterWdgCom/LinkManager"],function(e,t,n,o,s,a,r,l){"use strict";return{_sessionStart:null,_createminimap:null,_visuEventOnEndMoveMinimap:null,_rootRemovedMinimap:null,_loadingFailureMinimap:null,_onlyUpdateEnd:!0,_UpdateMinimap:!0,_hasMinimap:!1,_loadedMinimaps:[],_soiData:[],_minimapData:{},_minimapList:[],_initR2VMinimapManager:function(){this.subscribe({event:"onR2VLoaded"},this._onR2VLoadedMinimap.bind(this)),this.subscribe({event:"onSOIDropped"},this._onSOIDroppedMinimap.bind(this))},_onSOIDroppedMinimap:function(e){let t=e.states;for(var i=0;i<t.length;i++)this._soiData[t[i].resourceid]={data:t[i],soiId:e.resourceid}},_onR2VLoadedMinimap:function(s){let h=s.rootPhID;Object.keys(this._loadedMinimaps).length;-1===this._minimapList.indexOf(h)&&this._minimapList.push(h),this._loadedMinimaps[h]||(this._loadedMinimaps[h]=new o({renderTo:this.getFrameWindow().getImmersiveFrame(),data:this._soiData[h]&&this._soiData[h].data?this._soiData[h].data:{},icon:a.getWebappsAssetUrl("ENO3DCommands","icons/32/I_ENO3DShowPointCloudMinimap.png"),events:{closeMinimap:e=>{const t=this._minimapList.indexOf(e);this._minimapList.splice(t,1)}}}),this._minimapList&&this._minimapList.length>1&&this._loadedMinimaps[this._minimapList[this._minimapList.length-1]]&&this._loadedMinimaps[this._minimapList[this._minimapList.length-2]]&&this._loadedMinimaps[this._minimapList[this._minimapList.length-1]].elements.panel&&this._loadedMinimaps[this._minimapList[this._minimapList.length-1]].elements.panel.attachToWindow(this._loadedMinimaps[this._minimapList[this._minimapList.length-2]].elements.panel,WUXSnapAreaEnum.InsideArea,"after"));var d=this.getViewpointParameters();if(this._loadedMinimaps[h]){this._loadedMinimaps[h].init(d).then(()=>{this._loadedMinimaps[h].initialized=!0,!0===this._hasMinimap||this._loadedMinimaps[h].hasMinimap()?(this._hasMinimap=!0,this._minimapList.length>1?(this._loadedMinimaps[this._minimapList[this._minimapList.length-1]]&&this._loadedMinimaps[this._minimapList[this._minimapList.length-2]]&&this._loadedMinimaps[this._minimapList[this._minimapList.length-1]].elements.panel&&this._loadedMinimaps[this._minimapList[this._minimapList.length-1]].elements.panel.attachToWindow(this._loadedMinimaps[this._minimapList[this._minimapList.length-2]].elements.panel,WUXSnapAreaEnum.InsideArea,"after"),this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&!0===this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&this._loadedMinimaps[h].setVisibility(!0)):this._loadedMinimaps[h]&&this._loadedMinimaps[h].hasMinimap()&&this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&!0===this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&this._loadedMinimaps[h].setVisibility(!0),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DMinimapAutoChk",eventValue:"Enable"}),t.trackPageEvent()}),this.enableCheck("ENO3DTogglePointCloudMinimapChk")):!1===this._hasMinimap&&(!0===this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&this.getCommandHandler().setCheckState({id:"ENO3DTogglePointCloudMinimapChk",state:!1}),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DMinimapAutoChk",eventValue:"NoMinimap"}),t.trackPageEvent()}),this.disableCheck("ENO3DTogglePointCloudMinimapChk"),this._toggleMinimap("hide"))}).catch(()=>{});let o=n;o.subscribe({event:"ENO3DView/ENO3DMinimap/ChangeUpdate"},async function(e){this._UpdateMinimap=e}.bind(this)),o.subscribe({event:"ENO3DView/ENO3DMinimap/set"},async function(e){var i=this.getViewpoint();this._lockViewpointSync=!1,l.publish("DS/ExternalWdgtCom/SetViewpointSyncMaster"),this.getViewer().get360Mode()&&!e.sightchange?i.contextAwareMoveTo({eyePosition:new t.Vector3(e.eye.x,e.eye.y,e.eye.z),upDirection:new t.Vector3(e.up.x,e.up.y,e.up.z),sightDirection:new t.Vector3(e.sight.x,e.sight.y,e.sight.z),distanceToTarget:e.focus,duration:0},{allow360:!0}):i.moveTo({eyePosition:new t.Vector3(e.eye.x,e.eye.y,e.eye.z),upDirection:new t.Vector3(e.up.x,e.up.y,e.up.z),sightDirection:new t.Vector3(e.sight.x,e.sight.y,e.sight.z),distanceToTarget:e.focus,duration:e.duration});var n=Object.keys(this._loadedMinimaps),o=n.length;for(let t=0;t<o;t++)this._loadedMinimaps[n[t]].publish({event:"ENO3DView/ENO3DMinimap/UpdateView",data:e})}.bind(this)),this._visuEventOnEndMoveMinimap||(this._visuEventOnEndMoveMinimap=e.subscribe({event:"/VISU/"},function(e){if(this._UpdateMinimap)switch(e.eventType){case"@onViewpointChange":if(this._realMoveMinimap=!0,!this._onlyUpdateEnd){var t=this.getViewpointParameters(),i=Object.keys(this._loadedMinimaps),n=i.length;for(let e=0;e<n;e++)this._loadedMinimaps[i[e]].setView(t),this._loadedMinimaps[i[e]].publish({event:"ENO3DView/ENO3DMinimap/UpdateView",data:this._loadedMinimaps[i[e]].getView()})}break;case"@onViewpointEndMove":if(this._realMoveMinimap){r.debounce(()=>{this._realMoveMinimap=!1;var e=this.getViewpointParameters(),t=Object.keys(this._loadedMinimaps),i=t.length;for(let n=0;n<i;n++)this._loadedMinimaps[t[n]].setView(e),this._loadedMinimaps[t[n]].publish({event:"ENO3DView/ENO3DMinimap/UpdateView",data:this._loadedMinimaps[t[n]].getView()})},1e3)();break}}}.bind(this))),this._rootRemovedMinimap||(this._rootRemovedMinimap=this.subscribe({event:"onRootRemoved"},e=>{let t=Object.keys(this._loadedMinimaps);var i=!1;if(e.id){const t=this._minimapList.indexOf(e.id);this._minimapList.splice(t,1)}e.id&&this._loadedMinimaps[e.id]&&(this._loadedMinimaps[e.id].close(),delete this._loadedMinimaps[e.id]);for(let o=0;o<t.length;o++)if(this._loadedMinimaps[t[o]]&&t[o]!==e.id)if(!0===this._loadedMinimaps[t[o]].isInitialized())!0===this._loadedMinimaps[t[o]].hasMinimap()&&(i=!0,this._updateMinimapState(),this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&!0===this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&this._loadedMinimaps[t[o]].setVisibility(!0));else if(!1===this._loadedMinimaps[t[o]].isInitialized()&&!i){i=null;var n=this._loadedMinimaps[t[o]].subscribe({event:"ENO3DView/ENO3DMinimap/MinimapInitialized",callback:e=>{this._loadedMinimaps[t[o]].unsubscribe(n),!0!==i&&(!1===e.hasMinimap?(this._hasMinimap=!1,this._updateMinimapState()):(this._hasMinimap=!0,this._updateMinimapState(),this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&!0===this.getCommandHandler().getCheckState({id:"ENO3DTogglePointCloudMinimapChk"})&&this._loadedMinimaps[t[o]].setVisibility(!0)))}})}!1===i&&(this._hasMinimap=!1,this._updateMinimapState()),0===Object.keys(this._loadedMinimaps)&&(this.unsubscribe(this._rootRemovedMinimap),delete this._rootRemovedMinimap)})),this._loadingFailureMinimap||(this._loadingFailureMinimap=this.subscribe({event:"onLoadingFailure"},e=>{let t=Object.keys(this._loadedMinimaps);if(t.length>0){for(let e=0;e<t.length;e++)this._loadedMinimaps[t[e]].close();const e=this._loadedMinimaps.indexOf(t[i]);this._loadedMinimaps.splice(e,1)}0===Object.keys(this._loadedMinimaps)&&(this.unsubscribe(this._loadingFailureMinimap),delete this._loadingFailureMinimap)}))}},_toggleMinimap:function(e){if(this._loadedMinimaps){var t,i=Object.keys(this._loadedMinimaps),n=i.length;for(t=0;t<n;t++){var o=this._loadedMinimaps[i[t]];o&&"show"===e?!0===o.initialized&&(this._visibility=!0,o.setVisibility(!0),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DShowPointCloudMinimap"}),t.trackPageEvent()})):o&&"hide"===e&&(o.setVisibility(!1),this._visibility=!1,require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});t.setEventData({eventLabel:"ENO3DHidePointCloudMinimap"}),t.trackPageEvent()}))}}},_setMinimapSOIVisibility:function(e,t){!0===t?e.setVisibility(!0):!1===t&&e.setVisibility(!1)},_updateMinimapState:function(){!0===this._hasMinimap?this.enableCheck("ENO3DTogglePointCloudMinimapChk"):this.getCommandHandler().setCheckState({id:"ENO3DTogglePointCloudMinimapChk",state:!1}).then(()=>{this.disableCheck("ENO3DTogglePointCloudMinimapChk"),e.unsubscribe(this._visuEventOnEndMoveMinimap),this._visuEventOnEndMoveMinimap=null}).catch(()=>{e.unsubscribe(this._visuEventOnEndMoveMinimap),this._visuEventOnEndMoveMinimap=null})}}}),define("DS/ENO3DView/ENO3DView",["css!DS/ENO3DView/ENO3DView","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENO3DUtils/ENO3DBaseComponent","UWA/Controls/Abstract","UWA/Core","DS/ENO3DView/mixins/ENO3DViewManipulations","DS/ENO3DView/mixins/ENO3DViewStatusBar","DS/ENO3DView/mixins/ENO3DViewAccessors","DS/ENO3DView/mixins/ENO3DViewEventManager","DS/ENO3DView/mixins/ENO3DViewPreferenceManager","DS/ENO3DView/mixins/ENO3DViewCommandStateManager","DS/PADUtils/PADWebInWinServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADSharedSettings","DS/PADUtils/PADSession","DS/PADUtils/PADProbes","DS/Visualization/ThreeJS_DS","DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction","DS/PADUtils/PADUtilsServices","DS/Utilities/UUID","DS/PADServices/utils/AttributesMgtV2","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine","DS/ENOPAD3DViewer/mixins/_PAD3DViewerStartupViewAutoloader","DS/ENOPAD3DViewer/views/PAD3DRootListMgt","DS/ENOPAD3DViewer/views/PAD3DFindInContextColorized","DS/ENOPAD3DViewer/mixins/_PAD3DViewerViewpointController","DS/ENOPAD3DViewer/mixins/PAD3DViewerWidgetLink","DS/ENOPAD3DViewer/mixins/_PAD3DViewerSearchResultsView","DS/ENOPAD3DViewer/views/PAD3DSOITimelineView","DS/ENO3DView/mixins/ENO3DViewR2VMinimapManager","DS/ENOXTriptych/js/ENOXTriptych","DS/Visualization/WebGLV6Viewer","DS/Visualization/Viewpoint","DS/ENOPAD3DViewer/controller/PAD3DViewerController","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","DS/PADUtils/PADTypesMgt","UWA/Utils/InterCom","DS/i3DXCompassServices/i3DXCompassPubSub","DS/PADServices/utils/GlobalModelEvents","DS/PADServices/settings/AppSettings","DS/PADUtils/PADPromise","DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd","DS/Visualization/SceneGraphUtils","DS/ENO3DCommands/ENO3DRightSidePanelCmd","DS/ENOXInterWdgCom/LinkManager","DS/Windows/Panel"],function(e,t,i,n,o,s,a,r,l,h,d,c,p,u,g,m,_,f,v,C,y,D,b,w,E,S,P,O,M,B,I,x,N,V,T,A,k,U,R,L,F,G,W,z,X,H,j,Z,Q,q,K){"use strict";var Y=!1;function J(e){n.call(this,e),this._appConfigPath=e.appConfigPath,this._options=e,this._identifiers={widget:e.widgetIdentifier||"Widget",landingPage:e.landingPageIdentifier},this.name="ENO3DView",this._padintercom=null,this._frmWindow=null,this._viewer=null,this._layout=null,this._UILoader=null,this._dropZoneContainer=null,this.elements={},this._controller=null,this._hideShowController=null,this._BIController=null,this._modelEvents=null,this._changeAction=null,this._controllerTokens=[],this._csoTokens=[],this._psoTokens=[],this._hsoTokens=[],this._hideShowControllerTokens=[],this._dndTokens=[],this._actionBarTokens=[],this._layoutActivatedTokenBegin=null,this._layoutActivatedTokenEnd=null,this._actionBarCloseEvt=-1,this._actionBarOpenEvt=-1,this._lockCSONotification=!1,this._lockCSONotificationEmpty=!1,this._authorizeSet3DStructure=!1,this._isVolumeFilter=!1,this._isFilterOpen=!1,this._robotVisibility=!0,this._defaultContextualBarVisibility=!0,this._openWithMenuAvailability=!1,this._defaultContextualMenuVisibility=!0,this._propertiesCommandAvailability=!0,this._firstInit=!0,this._interwidgetComAvailability=!0,this._defaultProgressBarVisibility=null,this._automaticReframePolicy=null,this._filteredIdToReload=[],this._readyCheckPromises=[],this._physicalId=[],this.initProbe=null,this._applicativeData={},this._platformServicesInitPromise=null,this._loadingDelegations=null,this._volumePanel=0,this._triptych=null,this._rootListPanel={},this._rightSidePanelCmd=null}return J.prototype=Object.create(n.prototype),J.prototype=Object.assign(J.prototype,o.prototype),J.prototype=Object.assign(J.prototype,a.prototype),J.prototype=Object.assign(J.prototype,r.prototype),J.prototype=Object.assign(J.prototype,l.prototype),J.prototype=Object.assign(J.prototype,h.prototype),J.prototype=Object.assign(J.prototype,d.prototype),J.prototype=Object.assign(J.prototype,c.prototype),J.prototype=Object.assign(J.prototype,E.prototype),J.prototype=Object.assign(J.prototype,S.prototype),J.prototype=Object.assign(J.prototype,P.prototype),J.prototype=Object.assign(J.prototype,O.prototype),J.prototype=Object.assign(J.prototype,M.prototype),J.prototype=Object.assign(J.prototype,I.prototype),J.prototype=Object.assign(J.prototype,x),J.prototype=Object.assign(J.prototype,N),J.prototype=Object.assign(J.prototype,B.prototype),J.prototype.constructor=J,J.prototype.initialize=function(){return this._DEBUG&&console.log("ENO3DView.initialize called"),new Promise((e,t)=>{if(!0===this._isComponentInitialized)e();else{u.setSetting("eno3dviewer_infrastructure_version","wafr");const i=()=>{this._initSettings().then(e=>this._connectToPlatform(e)).then(e=>this._readSGIPreference(e)).then(e=>this._widgetLinkConfiguration(e)).then(e=>this._finalizeInit(e)).then(this._viewReady.bind(this)).then(e).catch(t)};null===u.app_context?this._appConfigPath?this._assignAppConfig().then(i.bind(this)).catch(t):(u.set_app_context("eno3dviewerinfra",!0),u.setSetting("lang",this._lang),i()):i()}})},J.prototype.clean=function(){return this._DEBUG&&console.log("ENO3DView.clean called"),new Promise((e,t)=>{e()})},J.prototype.destroy=function(){return this._DEBUG&&console.log("ENO3DView.destroy called"),new Promise((e,t)=>{if(delete this._identifiers,delete this._components,this._commandProxy&&(this._commandProxy.padDestroy(),this._commandProxy.destroy()),this._unregisterDnDEvents(),this._hideShowController){for(let e=0;e<this._hideShowControllerTokens.length;++e)this._hideShowController.unsubscribe(this._hideShowControllerTokens[e]);this._hideShowController.destroy()}if(this._BIController&&this._BIController.destroy(),this._controller){for(let e=0;e<this._controllerTokens.length;++e)this._controller.unsubscribe(this._controllerTokens[e]);this._controller.destroy()}if(this._frmWindow){for(let e=0;e<this._actionBarTokens.length;++e)this._frmWindow.removeActionBarCallback&&this._frmWindow.removeActionBarCallback(this._actionBarTokens[e]);this._frmWindow.dispose()}this._layout&&(this._layoutActivatedTokenBegin&&this._layout.unsubscribe(this._layoutActivatedTokenBegin),this._layoutActivatedTokenEnd&&this._layout.unsubscribe(this._layoutActivatedTokenEnd),this._layout.destroy()),this.getStatusBar()&&this.getStatusBar().destroy(),this._dndTokens&&this._dndTokens.length&&(this.elements.container.removeEventListener("dragenter",this._dndTokens[0]),this.elements.container.removeEventListener("dragover",this._dndTokens[1]),this.elements.container.removeEventListener("dragleave",this._dndTokens[2]),this.elements.container.removeEventListener("dragend",this._dndTokens[3]),this.elements.container.removeEventListener("drop",this._dndTokens[4])),this.disposeLoadingBoxesEngine(),this.disposeRootListMgt(),w.reset(),u.destroy(),D.deleteMapping({uuid:this._appUUID}),this._rightSidePanelCmd.destroy(),this.destroyParent().then(e)})},J.prototype._viewReady=function(){return this._DEBUG&&console.log("ENO3DView._viewReady called"),new Promise(e=>{this.getExecutionContext().setContext("ViewerReady",!0),this._isComponentInitialized=!0,e()})},J.prototype._assignAppConfig=function(){return this._DEBUG&&console.log("ENO3DView._assignAppConfig called"),new Promise((e,t)=>{this.loadSource(`text!${this._appConfigPath}`).then(i=>{try{u.setApp("object"==typeof i?i:JSON.parse(i),"eno3dviewerinfra",!1),u.setSetting("enopad3dviewer_staticMappingSupportActivated",!0),e()}catch(e){console.error("ENO3DView._assignAppConfig : Could not JSON.parse the provided AppConfig"),t()}}).catch(t)})},J.prototype._initSettings=function(){return this._DEBUG&&console.log("ENO3DView._initSettings called"),new Promise((e,t)=>{window.nearFarBigScale=!0;const i={windowOptions:u.getLayout_options("view_options"),enableSidePanel:!0,propertiesFacet:s.is(u.getSetting("propertiesFacet"),"array")?u.getSetting("propertiesFacet"):[]};o.call(this,i),p.initialize({widget:this.getWidget()}),this.setAutomaticReframePolicy(!0),this.setDefaultProgressBarVisibility(!0),u.setSetting("enopad3dviewer_roles",[]),u.setSetting("enopad3dviewer_lightNodeModel",!0),u.setSetting("enopad3dviewer_useNewProgressiveExpandAPI",!0),u.setSetting("enopad3dviewer_useStaticURL",!0),u.setSetting("readOnlyDashboard",!(!this.getWidget()||!this.getWidget().readOnly)&&this.getWidget().readOnly),this._authorizeSet3DStructure=!0,this._isVolumeFilter=u.getSetting("enopad3dviewer_volumeFilterAvailability"),this._propertiesCommandAvailability=u.getSetting("enopad3dviewer_propertiesCommandAvailability"),this.initProbe=_.createProbe("PAD3DViewer_init"),this._interwidgetComAvailability=u.getSetting("enopad3dviewer_interwidgetComAvailability"),u.setSetting("enopad3dviewer_occlusionTest",!0),require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENO3DView-usage"});t.setEventData({eventLabel:"ENO3DViewPickingFilter"}),t.persDim.pd2=u.getSetting("enopad3dviewer_selectionFilter"),t.trackPageEvent()}),this._modelEvents=this.getModelEvent();try{w.set(this),e(i)}catch(e){t(e)}})},J.prototype._connectToPlatform=function(e){return this._DEBUG&&console.log("ENO3DView._connectToPlatform called with",e),new Promise((t,i)=>{!0===u.getSetting("enopad3dviewer_offlineMode")?(this._platformServicesInitPromise=new Promise(e=>e()),t(e)):(this._platformServicesInitPromise=new Promise((t,i)=>{C.app_initialization(()=>{this._retrieveSessionRoles().then(this._retrieveVISnVIOStatus()).then(()=>{u.addEvent("onX3dPlatformId",()=>{this._retrieveVISnVIOStatus(),this.getViewer()&&this.getViewer().updatePlatformPreferences()},this),this._retrieveSecurityContext(e).then(()=>{e.readyCB||(e.readyCB=(()=>{})),e.readyCB(),t(e)}).catch(i)}).catch(i)},e.plateformServices)}),this._platformServicesInitPromise.then(()=>t(e)).catch(i),this._appUUID=y.v4(),this._readyCheckPromises.push(D.initialize({defaultAttributesJSON:"DS/ENOPAD3DViewer/assets/json/AttributesMgt.json",appAttributesJSON:e.appAttributesJSON,uuid:this._appUUID}))),u.getSetting("enopad3dviewer_getPlatformServicesInBackground")||u.getSetting("enopad3dviewer_offlineMode")||this._readyCheckPromises.push(this._platformServicesInitPromise)})},J.prototype._retrieveSessionRoles=function(){return this._DEBUG&&console.log("ENO3DView._retrieveSessionRoles called"),new Promise(e=>{C.getGrantedRoles(t=>{u.setSetting("enopad3dviewer_roles",t),this.publish({event:"grantedRoleRetrieved",data:u.getSetting("enopad3dviewer_roles")}),e()})})},J.prototype._retrieveVISnVIOStatus=function(){return this._DEBUG&&console.log("ENO3DView._retrieveVISnVIOStatus called"),new Promise(e=>{C.getVISnVIOStatus(t=>{u.setSetting("enopad3dviewer_VISnVIOStatus",t.hasLicense),this.publish({event:"VISnVIOStatusRetrieved",data:u.getSetting("enopad3dviewer_VISnVIOStatus")}),e()})})},J.prototype._retrieveSecurityContext=function(e){return this._DEBUG&&console.log("ENO3DView._retrieveSecurityContext called"),new Promise(e=>{let t=null!==this.getWidget()?this.getWidget().getValue("pad_security_ctx"):void 0;C.getSecurityContext(i=>{i&&i.securityContext&&i.securityContextList&&(u.setSetting("pad_security_ctx",t&&t.length>0?t:i.securityContext),u.setSetting("pad_security_ctx_list",i.securityContextList)),e()})})},J.prototype._widgetLinkConfiguration=function(e){return this._DEBUG&&console.log("ENO3DView._widgetLinkConfiguration called"),new Promise((t,i)=>{"undefined"!=typeof widget?(this.setupWidgetLink(),null!==this.getLandingPageComponent()?this.getLandingPageComponent().createLandingPage().then(t.bind(this,e)).catch(i):t(e)):t(e)})},J.prototype._readSGIPreference=function(e){this._DEBUG&&console.log("ENO3DView._readSGIPreference called with",e);var t=Promise.resolve(e);return!0===X.getSetting("activateSGI")&&(t=new Promise(t=>{require(["DS/MePreferencesClientAPI/MePreferencesClientAPI","DS/PlatformAPI/PlatformAPI"],(i,n)=>{n.subscribe("com.ds.mep:onPrefUpdate",this.__preferencesUpdated.bind(this)),i.readPreferences([{Repository:"ProductExplorerRepository",PreferenceNames:["ENOSCEN_SGI_REDIRECT"]}]).then(i=>{X.setSetting("redirectQueryToSGI","true"===i.repositories[0].preferences[0].value),t(e)}).catch(()=>{t(e)})})})),t},J.prototype.__preferencesUpdated=function(e){this._DEBUG&&console.log("ENO3DView.__preferencesUpdated called with",e);try{let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++){let i=t.repositories[e];if("ProductExplorerRepository"===i.name){let e=i.preferences;for(let t=0;t<e.length;t++)if("ENOSCEN_SGI_REDIRECT"===e[t].name){let i="true"===e[t].value.toLowerCase(),n=require("DS/PADServices/settings/AppSettings");i!==n.getSetting("redirectQueryToSGI")&&(n.setSetting("redirectQueryToSGI",i),this.refresh(!1))}}}}catch(e){console.warn("Cannot parse preferences")}},J.prototype._finalizeInit=function(e){return this._DEBUG&&console.log("ENO3DView._finalizeInit called"),new Promise(t=>{this._buildSkeleton(e).then(()=>this._buildComponent(e)).then(()=>this._buildCommandsState()).then(()=>{this._changeAction=new v({ctrl:this.getController()}),this._readyCheckPromises=[],u.getSetting("enopad3dviewer_rotateFocusMode")&&this.getViewpoint()._setFocusMode(A._FOCUS_MODE.ROTATION),this.setupLoadingBoxesEngine(),u.addEvent("onEnopad3dviewer_displayCandidateQueue",()=>{this.setupLoadingBoxesEngine()}),u.addEvent("onEnopad3dviewer_displayCandidateQueue_color",e=>{this.setLoadingBoxesColor(e),this.setupLoadingBoxesEngine()}),null===window.localStorage.getItem("ENO3DViewViewerAmbience")?window.localStorage.setItem("ENO3DViewViewerAmbience","VisuWhiteExperienceOCACmd"):this._executeCommand({handlerId:window.localStorage.getItem("ENO3DViewViewerAmbience")}),this._initSOITimelineView(),this.getController().initPointCloudStyling(),this._initR2VMinimapManager(),u.getSetting("probes_activated")&&this._trackPCS(),this._isComponentInitialized=!0,t()})})},J.prototype._appReady=function(e){this._DEBUG&&console.log("ENO3DView._appReady called"),e||(null!==this.getLandingPageComponent()&&null!==this.getLandingPageComponent().getLandingPage()&&(this.getLandingPageComponent().getLandingPage().setViewer(this,!0),this.getLandingPageComponent().getLandingPage().appReady()),this._buildCommandsState().then(()=>{this.publish({event:"onReady",data:this})}))},J.prototype._buildSkeleton=function(e){return this._DEBUG&&console.log("ENO3DView._buildSkeleton called with",e),new Promise((t,i)=>{if(this.elements.container=s.createElement("DIV"),this.getDOMElement("container").classList.add("eno3dview"),!0===C.isTouchDevice()&&this.getDOMElement("container").classList.add("touch-mode"),this.getWafrUIFrame().getViewerLayout().appendChild(this.getDOMElement("container")),u.getSetting("enopad3DViewer_enableStatusInfo")){var n=new Promise((e,t)=>{this._platformServicesInitPromise.then(()=>{this.createStatusBar(()=>{this._setupStartupViewAutoloader({activateStartupViewAutoloader:u.getSetting("enopad3dviewer_activateStartupViewAutoloader")}),e()},t)})});e.getPlatformServicesInBackground||this._readyCheckPromises.push(n)}else{if(!0===u.getSetting("enopad3dviewer_debugvisucommand"))s.createElement("span",{class:"fonticon fonticon-chart-gauge-angular enopad3dviewer_3dcontainer_debugvisuicon",id:"pad3dviewer_debugVisuCommandID"}).inject(this.elements.container).addEventListener("click",()=>{(new j).execute()})}this.elements.right=s.createElement("div",{class:"enopad3Dviewer_rightTriptych rightSidePanel"}),this.elements.borderedLayout=s.createElement("div",{class:"eno3dview_borderedLayout"}).inject(document.body);const o={left:{},container:this.getDOMElement("container"),withtransition:!0,withoverflowhidden:!0,right:{resizable:!0,originalState:"close",overMobile:!0,minWidth:250,withClose:!1}};try{this._triptych=new V,this._triptych.init(o,null,null,this.elements.right),this.elements.triptych=this._triptych,this._triptych.togglePanel=(e=>{"left"===e?this._triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"}):(this._triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"}),!1===this._triptych.getRightOpen()&&this.getComponentFromIdentifier(WAfrStandardComponentKey.HandlerComponent).setCheckState({id:"ToggleRightSidePanel",state:!1}))}),this._triptych._modelEvents.subscribe({event:"triptych-hide-panel"},e=>{"left"===e&&!0===this._triptych.getLeftOpen()&&this.getComponentFromIdentifier(WAfrStandardComponentKey.HandlerComponent).setCheckState({id:"ToggleLeftSidePanel",state:!1})}),this._rightSidePanelCmd=new Q({executionContext:this.getExecutionContext()}),this._triptych._modelEvents.subscribe({event:"triptych-clicked-overlay"},e=>{z.publish({event:"ENXViews/Triptych/onOverlayClick",data:e})}),this.subscribe({event:"toggleSidePanel"},this.toggleSidePanel.bind(this)),this.subscribe({event:"toggleTimelineView"},this.toggleTimelineView.bind(this)),this.subscribe({event:"togglePhoto360Mode"},this.togglePhoto360Mode.bind(this)),this.subscribe({event:"togglePointCloudMinimap"},this.togglePointCloudMinimap.bind(this)),this.loadSource("DS/PADServices/utils/PlatformURL").then(e=>{e.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0})}),this.publish({event:"on3DTriptychReady"}),b.render({renderTo:this.getDOMElement("triptych").getMainPanelContainer()}),t()}catch(e){this._DEBUG&&console.error("ENO3DView._buildSkeleton : Something wrong happened with ENOXTriptych construction"),i(e)}})},J.prototype._buildComponent=function(e){return this._DEBUG&&console.log("ENO3DView._buildComponent called with",e),new Promise((e,i)=>{const n=u.getLayout_options("frmWindow_opts")||{};this._lang&&(n.language=this._lang),this._initWebGLViewer(n).then(()=>{this._rootListPanel=new K({title:t.rootList,icon:{iconName:"list",fontIconFamily:WUXManagedFontIcons.Font3DS},immersiveFrame:this.getFrameWindow().getImmersiveFrame(),content:this.createRootListSlidder({noTitle:!0}),width:300,minWidth:300,height:"auto",minHeight:112,floatableFlag:!0,snappableFlag:!0,allowedDockAreas:13,verticallyStretchableFlag:!0,collapsibleFlag:!0,closeButtonFlag:!0,autoCloseFlag:!1}),this._rootListPanel.hide(),this._rootListPanel.addEventListener("close",this._hideRootListPanel.bind(this)),this._rootListPanel.immersiveFrame.dockWindow(this._rootListPanel,WUXDockAreaEnum.LeftDockArea,{attachToOtherDockedWindow:!0}),e()}).catch(i)})},J.prototype._initWebGLViewer=function(e){return this._DEBUG&&console.log("ENO3DView._initWebGLViewer called with",e),new Promise((t,i)=>{const n=new Promise((t,i)=>{this.fWInitProbe=_.createProbe("FrameWindow3D_init"),this.viewerInitProbe=_.createProbe("3DViewer_init"),u.getSetting("probes_activated")&&window.top.performance.mark(`${this._pcsPrefix}frameWindowInitBegin`);var n=u.getLayout_options("frmWindow_opts").viewerOptions;n.div=this._triptych.getMainPanelContainer(),f._BinaryPrimitives=!0,this._viewer=new T(n),this._viewpoint=new A({viewer:this._viewer}),this._viewer.addViewpoint(this._viewpoint),this._viewer.setRenderMode("@Edge",!0),this._viewer.setV6Ambience(),this._viewpoint.onMove(this._viewer.render),this._robotVisibility=e.robotVisibility,e.viewerOptions.showReferenceAxisSystem&&this._viewer.setRobot(this._robotVisibility,{snapOnFace:!0}),this._viewer.setPicking(e.viewerOptions.highlight),this._viewer.setPrePicking(e.viewerOptions.pHighlight),this._viewer.displayPoints(!0),f.getWebVisualizationLevel()<424&&this.getViewpoint().setDefaultController(!0,e.mouseProfile),this.viewerInitProbe.end(),delete this.viewerInitProbe,u.getSetting("probes_activated")&&(window.top.performance.mark(`${this._pcsPrefix}frameWindowInitDone`),window.top.performance.measure(`${this._pcsPrefix}frameWindowInit`,`${this._pcsPrefix}frameWindowInitBegin`,`${this._pcsPrefix}frameWindowInitDone`)),this._initModelController(e).then(()=>{this._initHideShowController(),this._initDnD(),this._initInterwidgetCom(),this._initCSO(),this.initFindInContextColorizedSubscription(),void 0!==e.BIMode&&this.getController().toggleBetweenStandaloneAndSlaveMode(e.BIMode),setTimeout(()=>{this.publish({event:"onViewerReady",data:this}),t()})}).catch(i)});this._readyCheckPromises.push(n),n.then(t).catch(i)})},J.prototype._initModelController=function(e){this._DEBUG&&console.log("ENO3DView._initModelController called with",e),e=void 0!==e?e:{};const t=new Promise(t=>{this._controller=new k({viewer:this._viewer,context:this,selectiveLoading:!0,initializeWithWrap:!1,appOOCManagerOptions:e.OOCManagerOptions,rolePromise:this._platformServicesInitPromise,executionContext:this.getExecutionContext(),readyCB:()=>{this._registerControllerEvents(),this._registerViewEvents(),t()}})});return this._readyCheckPromises.push(t),t},J.prototype._initHideShowController=function(){this._DEBUG&&console.log("ENO3DView._initHideShowController called"),this.loadSource("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController").then(e=>{this._hideShowController=new e({context:this,viewer:this._viewer}),this._registerHideShowEvents()})},J.prototype._initDnD=function(){this._DEBUG&&console.log("ENO3DView._initDnD called"),!0!==u.getSetting("enopad3dviewer_allowDnD")||u.getSetting("activate_newDropInvite")||this.loadSource("DS/PADUtils/views/PADDnDInvite").then(e=>{this._dropZoneContainer=new e({renderTo:this.getDOMElement("container"),mode:"inviteWithFilter",filterActive:u.getSetting("enopad3dviewer_FilterAvailable"),dropOnInvite:this._DnDDropCB.bind(this)}),this._registerDnDEvents()})},J.prototype._initInterwidgetCom=function(){this._DEBUG&&console.log("ENO3DView._initInterwidgetCom called"),this.isInterwidgetComAvailable()&&this.loadSource("DS/PADUtils/PADCommandProxy").then(e=>{this._commandProxy=e.create({events:this._getProxyEvents()})})},J.prototype._initCSO=function(){this._DEBUG&&console.log("ENO3DView._initCSO called"),this.isInterwidgetComAvailable()&&this._registerCSOEvents()},J.prototype.addRootNodesFromContent=function(e){this._DEBUG&&console.log("ENO3DView.addRootNodesFromContent called with",e),e.dispatch=void 0===e.dispatch||e.dispatch,e.inContext=void 0===e.inContext||e.inContext;let t=null;e.json3DXContent&&(t="string"==typeof e.json3DXContent?JSON.parse(e.json3DXContent):e.json3DXContent);const n=e.dndEvent?{dataTransfer:e.dndEvent.dataTransfer}:void 0;let o=!1;var s=e.dndEvent&&e.dndEvent.dataTransfer?JSON.parse(e.dndEvent.dataTransfer.getData("Text")):null;F.retrieveAuthorizedObjects({displayNotif:!1,X3DContentId:t||void 0,dnd_event:n||void 0,version:"2.0",callback:t=>{if(t.unauthorized_objects.length)for(let e=0;e<t.unauthorized_objects.length;++e)if(this._loadingDelegations&&this._loadingDelegations["_"+t.unauthorized_objects[e].objectType]){(0,this._loadingDelegations["_"+t.unauthorized_objects[e].objectType])(t.unauthorized_objects[e]),o=!0}else if(this.displayNotification({msg:i.replace(i.get("unsupported_type"),{type:t.unauthorized_objects[e].displayType,name:t.unauthorized_objects[e].displayName}),eventID:"warning"}),0===this.getRoots().length&&!this._checkHiddenRoots()){z.getModelEvents().publish({event:"ENXViews/WelcomePanel/activate"})}if(0===t.authorized_objects.length)0===this.getRoots().length&&!this._checkHiddenRoots()&&this._dropZoneContainer&&this._dropZoneContainer.show("drop");else{const n=this.getRoots(),o=t.authorized_objects;C.multiTenantMgt(o,n,n=>{if(n.isMultiTenant)t.isMultiTenant&&t.invalidTenant&&0===this.getRoots().length&&!this._checkHiddenRoots()&&this._dropZoneContainer&&this._dropZoneContainer.show("drop");else if(t.authorizedWithKind){if(t.authorizedWithKind.Product&&t.authorizedWithKind.Product.length>0){const i=[];for(let n=0;n<t.authorizedWithKind.Product.length;++n){const o=t.authorizedWithKind.Product[n],s=o.path&&e.inContext?o.path.map(e=>e.resourceid):[o.objectId];i.push({path:s,serviceId:o.serviceId})}let n={};if(e.dndEvent&&e.dndEvent.dataTransfer?n=s:e.json3DXContent&&e.json3DXContent.biProxyCtx&&(n=e.json3DXContent),n.fromFilter=e.fromFilter||!1,n.biProxyCtx)return void this.getController().dropShareFilterSpec(n,e.dispatch,this.getAutomaticReframePolicy());this.addRoots({objects:i},e.dispatch)}if(t.authorizedWithKind.Filter&&t.authorizedWithKind.Filter.length>0&&(m.determineAuthoredFlag()?(this.displayNotification({eventID:"warning",msg:i.filterInAuthoring}),0===this.getRoots().length&&!this._checkHiddenRoots()&&this._dropZoneContainer&&this._dropZoneContainer.show("drop")):!0===this.getController().isStandaloneFilterAvailable()?(this._commandProxy&&!0===e.dispatch&&this._commandProxy.dropFilter3D({droppedFilters:t.authorizedWithKind.Filter,broadcast:!1}),this.getController().retrieveFilters(t)):!0===this.getController().isSlaveFilterAvailable()?this._commandProxy.dropFilter3D({droppedFilters:t.authorizedWithKind.Filter}):0===this.getRoots().length&&!this._checkHiddenRoots()&&this._dropZoneContainer&&this._dropZoneContainer.show("drop")),t.authorizedWithKind.Change&&t.authorizedWithKind.Change.length>0&&this.loadChange({objects:t.authorizedWithKind.Change}),t.authorizedWithKind.R2V&&t.authorizedWithKind.R2V.length>0){const e=[];t.authorizedWithKind.R2V.forEach(t=>{e.push(t)}),this.addR2Vs({objects:e,reframe:!0,displayNotif:!0,dispatch:!0})}}else{const i=[];for(let n=0;n<t.authorized_objects.length;++n){const o=t.authorized_objects[n],s=o.path&&e.inContext?o.path.map(e=>e.resourceid):[o.objectId];i.push({path:s})}this.addRoots({objects:i},e.dispatch)}})}}})},J.prototype.addRoots=function(e,t,i){this._DEBUG&&console.log("ENO3DView.addRoot called with",e,t,i),void 0!==e.pids||void 0!==e.paths||void 0!==e.objects?(void 0===e.pids&&void 0===e.paths||console.warn("The usage of pids or paths is deprecated, please use objects"),t=void 0===t||t,i=void 0===i||i,this._controller.addRoots(e,t,i,this.getAutomaticReframePolicy())):console.error("No PIDs or paths or objects array defined")},J.prototype.addFilter=function(e){this._DEBUG&&console.log("ENO3DView.addFilter called with",e),this._controller.addFilter(e)},J.prototype.loadJSON=function(e,t){if(this._DEBUG&&console.log("ENO3DView.loadJSON called",e,t),!Array.isArray(e.data)||Array.isArray(e.data)&&0===e.data.length)throw new Error("No data defined");for(let t=0;t<e.data.length;++t){if("string"!=typeof e.data[t].rootID)throw new Error("No rootID defined for the data n°"+(t+1));if("object"!=typeof e.data[t].structure)throw new Error("No structure defined for the data n°"+(t+1))}this._controller.addRoots({structures:e.data},!1,t,this.getAutomaticReframePolicy())},J.prototype.removeRoots=function(e,t){this._DEBUG&&console.log("ENO3DView.removeRoots called with",e),void 0!==e.pids?(this.getStatusBar()&&this.getStatusBar().clearFilter({ids:e.pids}),this._controller.removeRoots(e,t)):console.error("No PID array defined")},J.prototype.fadeRootOut=function(e){return this._DEBUG&&console.log("ENO3DView.fadeRootOut called wtih",e),new Promise(t=>{if(void 0===e.pids)return void console.error("No PID array defined");let i=this.getHideShowController()._sceneGraphOverrideSet.getUniqueOverrideFromNodeId(e.pids[0]);i||(i=this.getHideShowController()._sceneGraphOverrideSet.createNodeIdOverride(e.pids[0]));let n=1;const o=setInterval(()=>{i.setOpacity(n,!0),n<=0&&(clearInterval(o),this.getHideShowController()._sceneGraphOverrideSet.deleteOverride(i),e.reframe=!1,this.removeRoots(e,!1),t()),n-=.05;const s=Math.pow(10,2);n=Math.round(n*s)/s,this._viewer.render({updateInfinitePlane:!0})},50)})},J.prototype.empty=function(e,t){this._DEBUG&&console.log("ENO3DView.empty called with",e,t),this.getStatusBar()&&this.getStatusBar().clearFilter(),e=void 0===e||e,this._controller.flushModel(e,!1,!1,t)},J.prototype.openStoredObjects=function(e){if(this._DEBUG&&console.log("ENO3DView.openSotredObject called with",e),e.unserializedData&&e.unserializedData.data.items.length>0){const t=C.getPlatformId();if(t)for(let i=0;i<e.unserializedData.data.items.length;++i)e.unserializedData.data.items[i].envId=t;return this.openDroppedObjects(e)}const t=(e,i,n,o)=>{void 0===n&&(n=[]);const s=Object.keys(i);for(let a=0;a<s.length;++a){const r=Object.keys(i[s[a]]);if(0===r.length){let t=[];void 0!==o&&(t=o.slice()),t.push(s[a]);const i=t.join(",");-1===n.indexOf(i)&&(n.push(i),e.push({path:t}))}else for(let l=0;l<r.length;++l){let r=[];void 0!==o&&(r=o.slice()),r.push(s[a]),t(e,i[s[a]],n,r)}}};return new Promise(n=>{const o=[];if(e.products){if(Object.getOwnPropertyNames(e.products).length){const n=new Promise(n=>{const o=H.getPromises();Promise.all(o).then(()=>{const o=[];if(t(o,e.products),o.length){if(!0===e.withFilter){const t=this.subscribe({event:"onRootAdded"},o=>{this.unsubscribe(t),n(),m.isAuthoring()?(this.getController()._disableFilterWaiting({rootIds:[o.id]}),this.displayNotification({msg:i.filterInAuthoring,eventID:"warning"})):!0!==e.fromProxy?this._executeCommand({handlerId:"ENO3DDefineFilterCmd"}):!0===e.fromProxy&&(this._filterPanelOpen=!0,this._filterRootIds=[o.id])})}this.addRoots({objects:o,loadWithFilter:e.withFilter},!1)}else n()})});n.name="AddRoots",o.push(n)}}if(e.filters){var s=Object.getOwnPropertyNames(e.filters);if(s.length){var a=new Promise(t=>{var i=H.getPromises();Promise.all(i).then(()=>{for(var i=[],n=C.getPlatformId(),o=0;o<s.length;o++)i.push({envId:n,serviceId:"3DSpace",objectId:s[o],objectType:"ENOStrRefinementSpecification"});var a={protocol:"3DXContent",version:"1.1",source:C.getAppId(),widgetId:C.getWidgetId(),data:{items:i}},r=("boolean"!=typeof e.fromAutoReload||!0!==e.fromAutoReload)&&e.broadcast;this.addRootNodesFromContent({json3DXContent:a,inContext:!1,dispatch:r}),t()})});a.name="AddFilters",o.push(a)}}e.pointClouds&&e.pointClouds.length&&this.addR2Vs({objects:e.pointClouds,reframe:!0,displayNotif:!0,dispatch:!0}),Promise.all(o).then(()=>{n()})})},J.prototype.openDroppedObjects=function(e){return this._DEBUG&&console.log("ENO3DView.openDroppedObjects called with",e),new Promise(t=>{if("FILTER"===e.behavior||!0===e.withFilter){if(m.isAuthoring()){this.displayNotification({msg:i.filterInAuthoring,eventID:"warning"});const n=!!s.is(e.broadcast,"boolean")&&e.broadcast;return this.addRootNodesFromContent({json3DXContent:e.unserializedData,inContext:!e.behavior||"WITH_CONTEXT"===e.behavior,dispatch:n}),void t()}if(e.unserializedData.biProxyCtx){if(e.unserializedData.data.items.length>1){const t=!!s.is(e.broadcast,"boolean")&&e.broadcast;this.addRootNodesFromContent({json3DXContent:e.unserializedData,inContext:!e.behavior||"WITH_CONTEXT"===e.behavior,dispatch:t,fromFilter:!0})}else this.loadSource("DS/ENOPAD3DViewer/commands/PAD3DViewerFilterDropObjectsCmd").then(i=>{const n=new i;n.execute(e.unserializedData,!0,!0),t(n&&e.unserializedData?void 0:{error:"noCommandAvailable"})}).catch(e=>{console.error(e)});return void t()}this.loadSource("DS/ENOPAD3DViewer/commands/PAD3DViewerFilterDropObjectsCmd").then(i=>{const n=new i;n.execute(e.unserializedData,e.fromProxy,!0),t(n&&e.unserializedData?void 0:{error:"noCommandAvailable"})}).catch(e=>{console.error(e)})}else{const i="boolean"==typeof e.broadcast&&e.broadcast;this.addRootNodesFromContent({json3DXContent:e.unserializedData,inContext:!e.behavior||"WITH_CONTEXT"===e.behavior,dispatch:i}),t()}})},J.prototype._openObjectsFromWL=function(e){if(this._DEBUG&&console.log("ENO3DView._openObjectsFromWL called with",e),!e.filter)return this.openDroppedObjects(e);{let i=0,n=[];const o=t=>{for(let e=0;e<n.length;++e)this.getController().getBIProxy().removeEvent(n[e]);if(0===t.status&&null!==t.error)this.displayNotification({eventID:t.error.level,title:t.error.title,msg:t.error.message});else{if("APPLY"===e.filter.intent){const e=this.subscribe({event:"onRootAdded"},()=>{this.unsubscribe(e),z.getModelEvents().publish({event:"ENXViews/WelcomePanel/closeLandingPage"})});return}e.withFilter=!0,this.openDroppedObjects(e)}},s=e.unserializedData.data.items;for(let a=0;a<s.length;++a){var t=`DroppedFilterSpec-${a}`;n.push(t),this.getController().getBIProxy().addEvent(t,e=>{++i===s.length&&o(e)}),this.getController().getBIProxy().setPublicFilterSpecification({rootId:s[a].objectId,rootAlias:s[a].displayName,specification:e.filter.specification,applyFilter:"APPLY"===e.filter.intent?1:0,displayFilter:"WAIT"===e.filter.intent?1:0,eventName:t})}}},J.prototype.buildStructure=function(e,t,i,n){this._DEBUG&&console.log("ENO3DView.buildStructure called with",e,t,i,n);let o=0;for(let s in e){let a=[];!0===t[s].selected&&(0===n.length||n.length>0&&-1!==n.indexOf(t[s].nodeId))?i.push({id:t[s].idx,show:t[s].show,select:t[s].selected,children:[]}):i.push({id:t[s].idx,show:t[s].show,children:[]}),(a=this.buildStructure(e[s],t,i[o].children,n))&&i.push({children:a}),++o}},J.prototype.refresh=function(e){this._DEBUG&&console.log("ENO3DView.refresg called with",e),e=void 0===e||e,this._controller.refresh(e)},J.prototype.search=function(e){this._DEBUG&&console.log("ENO3DView.search called with",e),"string"==typeof e.searchQuery&&this.loadSource("DS/PADServices/utils/PredefinedQueryUtils").then(t=>{t.isPredefinedQry(e.searchQuery).then(t=>{e.searchQuery=t,this._controller.search(e)})})},J.prototype.freezeProgressiveLoading=function(){this._DEBUG&&console.log("ENO3DView.freezeProgressiveLoading called"),this.getController().pauseProgressiveLoading(),this.getStatusBar()&&this.getStatusBar().disableProgress()},J.prototype.unfreezeProgressiveLoading=function(){this._DEBUG&&console.log("ENO3DView.unfreezeProgressiveLoading called"),this.getController().resumeProgressiveLoading(),this.getStatusBar()&&this.getStatusBar().enableProgress()},J.prototype.loadChange=function(e){this._DEBUG&&console.log("ENO3DView.loadChange called with",e),this._changeAction&&this._changeAction.loadChange({app:this,changes:e.objects})},J.prototype.author=function(e){this._DEBUG&&console.log("ENO3DView.author called with",e);let t=!0;"boolean"==typeof e&&(t=e),this._controller.switchAuthoringMode(e)},J.prototype.addR2Vs=function(e){return this._DEBUG&&console.log("ENO3DView.addR2Vs called with",e),new Promise(t=>{this._controller.addR2Vs(e).then(t)})},J.prototype._checkHiddenRoots=function(){return this._DEBUG&&console.log("ENO3DView._checkHiddenRoots called"),0!==(this._controller.getHiddenRootIds()?this._controller.getHiddenRootIds().length:0)},J.prototype.activateCurrentLayout=function(){this._DEBUG&&console.log("ENO3DView.activateCurrentLayout called"),this._layout&&!this._layout.isActive()&&this._layout.activate();var e=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");e&&e.setAttribute("style","")},J.prototype.deactivateCurrentLayout=function(e){this._DEBUG&&console.log("ENO3DView.deactivateCurrentLayout called with",e);let t=H.getPromises().slice();H.createPromise((i,n)=>{Promise.all(t).then(n=>{t=null;let o=!1;if(this._layout&&(o=this._layout.isActive())&&this._layout.deactivate(!1),e.disableCommand){var s=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");s&&s.setAttribute("style","opacity: 0.5; pointer-events: none !important; -webkit-filter: grayscale(100%);")}return i(),o})},"deactivateLayout")},J.prototype.changeVisuModeCmdAvailability=function(e){this._DEBUG&&console.log("ENO3DView.changeVisuModeCmdAvailability called with",e),console.error("ENO3DView.changeVisuModeCmdAvailability : This method is not anymore exposed and won't perform anything.")},J.prototype.streamPath=function(e){return this._DEBUG&&console.log("ENO3DView.streamPath called with",e),this._controller.buildArrayFromPath(e)},J.prototype.streamPathWithType=function(e,t,i){return this._DEBUG&&console.log("ENO3DView.streamWithType called with",e,t,i),this._controller.buildArrayFromPathWithType(e,t,i)},J.prototype.streamPOI=function(e,t,i){return this._DEBUG&&console.log("ENO3DView.streamPOI called with",e,t,i),this.getController().streamPOI(e,t,i)},J.prototype.streamPOIGroup=function(e,t){return this._DEBUG&&console.log("ENO3DView.streamPOIGroup called with",e,t),this.getController().streamPOIGroup(e,t)},J.prototype.streamZOI=function(e,t){return this._DEBUG&&console.log("ENO3DView.streamZOI called with",e,t),this.getController().streamZOI(e,t)},J.prototype.unstreamPath=function(e,t){return this._DEBUG&&console.log("ENO3DView.unstreamPath called with",e,t),this._controller.buildPathFromArray(e,t)},J.prototype.set3DXContentData=function(e){if(this._DEBUG&&console.log("ENO3DView.set3DXContentData called with",e),!Array.isArray(e.nodes2Open))throw new Error("set3DXContentData: Invalid init parameter nodes2Open");const t=s.is(widget)&&widget.id?`padcompassSocket_${widget.id}`:"padcompassSocket";if(null===this._padintercom&&(this._padintercom=new G.Socket(t),this._padintercom.subscribeServer("com.ds.compass",window.parent)),0===e.nodes2Open.length)this._padintercom.dispatchEvent("onResetX3DContent",{},t);else{const i={protocol:"3DXContent",version:"1.0",source:widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"ENOSTDE_AP",data:{items:[]}},n=t=>{const i=[];for(let n=0;n<t.length;++n)i.push({resourceid:t[n],type:e.selectedPaths.attributes[t[n]].type});return i};for(let t=0;t<e.selectedPaths.paths.length;++t){const o=e.selectedPaths.paths[t];let s=null;this.getController().getRootStats&&this.getController().getRootStats(o[0])&&(s=this.getController().getRootStats(o[0]).serviceId);const a=o[o.length-1];i.data.items.push({envId:C.getPlatformId(),serviceId:s||"3DSpace",contextId:u.getSetting("pad_security_ctx")?u.getSetting("pad_security_ctx"):void 0,objectId:a,objectType:e.selectedPaths.attributes[a].type,path:n(o)})}this._padintercom.dispatchEvent("onSetX3DContent",i,t)}},J.prototype.setTypesFor3D=function(e){this._DEBUG&&console.log("ENO3DView.setTypesFor3D called with",e),Y||(W.subscribe("setTypesCallback",t=>{if(t.widgetId===C.getWidgetId()){const i=[],n={},o=[],s=[],a=[],r=U.get(),l=this.getController()._model.getRootBag(),h=[],d={version:"1.1",paths:i,attributes:n},c=this.getRoots();for(let e=0;e<c.length;++e)h.push(R.getNodeID(c[e]));for(let e=0;e<r.length;++e)if(R.isAModelPath(r[e].pathElement)){let t=r[e].pathElement,s=t.getLastElement(!0);const d=R.getNodeID(s);if(-1!==h.indexOf(d)&&i.push([d]),R.is3DLeaf(s))this.streamPathWithType(r[e].pathElement,i,n);else{if(R.isPLMNode(s)){const e={};s.traverse(i=>{if(R.is3DLeaf(i)){const n=R.getNodeID(i);if(n&&!e[n]){e[n]=!0;const s=Z.buildPathesLeadingToNode(i,l);for(let e=0;e<s.length;++e)t.isAParentOf(path)&&o.push(s[e])}}})}else{for(;!R.is3DLeaf(s);)s=(t=t.getParentPath()).getLastElement(!0);o.push(t)}for(let e=0;e<o.length;++e)this._hideShowController.isVisible(o[e])||a.push(R.getNodeID(o[e].getLastElement(!0))),this.streamPathWithType(o[e],i,n)}}if(i)for(let e=0;e<i.length;++e){const t=i[e];s.push(t[t.length-1])}this.setTypesForOFW({nodes2Open:s,hiddenNodes:a,selectedPaths:d},i=>{const n=this.getViewpoint(),o=L.buildViewPoint(n);null!==o&&i.viewpoint.push(o),e.changeControl&&(i.workUnder=e.changeControl),W.publish("launchApp",{appId:t.appId,widgetId:t.widgetId,fileName:"-file",fileContent:JSON.stringify(i)})})}}),Y=!0);const t={widgetId:widget.id};U.get().length>0?W.publish("setTypes",t):W.publish("resetType")},J.prototype.setTypesForOFW=function(e,t){if(this._DEBUG&&console.log("ENO3DView.setTypesForOFW called with",e,t),!Array.isArray(e.nodes2Open))throw new Error("settypes_open_in_web: Invalid init parameter nodes2Open");const i=s.clone({version:"2.0",results:[],structures:[],viewpoint:[]}),n=[],o=[];let a,r="",l=1,h=0;const d={},c={},p=[],u=t=>-1!==e.nodes2Open.indexOf(t),g=t=>-1===e.hiddenNodes.indexOf(t),m=e=>{const t=d[e];t&&(s.is(a[t.localid])||(a[t.localid]={}),a=a[t.localid])};for(let t=0;t<e.selectedPaths.paths.length;++t){const s=e.selectedPaths.paths[t];1===s.length&&p.push(s[0]);for(let e=0;e<s.length;++e)r=s[e],-1===n.indexOf(r)&&(i.results.push({id:l.toString(),phid:r}),d[r]={idx:l,localid:h},c[h]={idx:l.toString(),nodeId:r,show:g(r),selected:u(r)},++l,++h,n.push(r));a=o,s.forEach(m)}for(var _ in o){const e=[];let t=[];!0===c[_].selected&&(0===p.length||p.length>0&&-1!==p.indexOf(c[_].nodeId))?e.push({id:c[_].idx,show:c[_].show,select:c[_].selected,children:[]}):e.push({id:c[_].idx,show:c[_].show,children:[]}),(t=this.buildStructure(o[_],c,e[0].children,p))&&e.push({children:t}),i.structures.push({structure:e})}t(i)},J.prototype.set3DStructure4OpenInCV5=function(e){if(this._DEBUG&&console.log("ENO3DView.set3DStructure4OpenInCV5 called with",e),!Array.isArray(e.nodes2Open))throw new Error("setStructure_4_open_in_cv5: Invalid init parameter nodes2Open");const t={version:"1",structures:{references:[],connections:[],trees:{}}},i=[];let n,o="",a=0,r={};const l=e=>{const t=r[e];s.is(n[t.localid])||(n[t.localid]={},t.selected&&(n[t.localid].selected=t.selected)),n=n[t.localid]},h=t=>-1!==e.nodes2Open.indexOf(t);for(let s=0;s<e.selectedPaths.paths.length;++s){const d=e.selectedPaths.paths[s];for(let n=0;n<d.length;++n)o=d[n],-1===i.indexOf(o)&&(n%2!=0?(t.structures.connections.push({physicalid:d[n],localid:a+""}),r[o]={localid:a,selected:h(o)},++a,i.push(o)):(t.structures.references.push({physicalid:d[n],type:e.selectedPaths.attributes[d[n]].type,localid:a+""}),r[o]={localid:a,selected:h(o)},++a,i.push(o)));n=t.structures.trees,d.forEach(l)}return t},J.prototype.getNGFUXID=function(e){this._DEBUG&&console.log("ENO3DView.getNGFUXID called with",e);const t=widget&&widget.id?widget.id:"fakeWidgetIDFallback";let i;return i=u.getSetting("activateWidgetLink")?q.getSourceWidgetId()&&q.getSyncFeature("Content")&&e?q.getSourceWidgetId():t:C.getSharedId()},J.prototype.setCurrentLayout=function(e){this._DEBUG&&console.log("ENO3DView.setCurrentLayout called with",e),e&&!this._layoutActivatedTokenBegin&&(this._layoutActivatedTokenBegin=e.subscribe({event:"onLayoutComputationBegin"},()=>{this.publish({event:"onLayoutComputationBegin"})}),this._layoutActivatedTokenEnd=e.subscribe({event:"onLayoutComputationEnd"},()=>{this.publish({event:"onLayoutComputationEnd"})})),this._layout=e},J.prototype.getLevelSelectorCommand=function(e){this._DEBUG&&console.log("ENO3DView.getLevelSelectorCommand called with",e),console.error("ENO3DView.getLevelSelectorCommand : This method is not anymore exposed and won't perform anything.")},J.prototype.render=function(){return this._DEBUG&&console.log("ENO3DView.render called"),this._triptych},J.prototype.getPCSTrackerResult=function(e){this._DEBUG&&console.log("ENO3DView.getPCSTrackerResult called with",e);const t=window.top.performance.getEntriesByName(e);return t.length>0?t[t.length-1]:void 0},J.prototype._trackPCS=function(){this._DEBUG&&console.log("ENO3DView._trackPCS called")},J.prototype.canBeParallelized=function(){return this._DEBUG&&console.log("ENO3DView.canBeParallelized called"),!1},J});