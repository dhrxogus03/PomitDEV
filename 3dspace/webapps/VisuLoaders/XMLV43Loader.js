define("DS/VisuLoaders/XMLV43Loader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Visualization/PathElement","DS/Visualization/SceneGraph","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/Visualization/LoaderUtils","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/CGRReader","DS/ZipJS2/ZipJS2","DS/ZipJS2/LoaderInflate"],function(e,r,t,a,n,i,l,o,s,d,u,f,c,p,m,h,v){"use strict";var g={TECHREP:{module:"DS/SIMAnimationWebMdl",file:"SIMAnimationRepRefUnstreamer"},CDS:{module:"DS/CATAssemblySolverWeb",file:"CATAsmWebJsonUnstreamer"}};return function(n,l){var d=!1,u=!1,f=n,b=void 0;e.supportedExtensions&&(b=!!e.supportedExtensions.elementIndexUint||void 0);var N,x,C=[],M=!1,D=null,A=void 0!==l?l:null,R=null,S=null,T=null,k=null,y=null,E=!0,w=null,I=4,L=null,W=[],B=!1,U=0,F=0,P=4,V=0,G=[],X=null,_=null,O="TESSELLATED",q=[],j=[],z=((new Date).getTime(),!1),H=!1,$=!1,J=!1,Z=!1,Y=!1,K=!1,Q=null,ee=null,re={},te=[],ae=!0,ne=!1,ie=!1,le=!1,oe=!1,se=!1,de=!1,ue=[],fe=!1,ce={},pe={},me=null,he=2,ve=[],ge={};function be(e,r,t,a,n,i){if(d)if(document.implementation&&document.implementation.createDocument){var l=new XMLHttpRequest;l.overrideMimeType&&l.overrideMimeType(t),"blob"===r&&(l.responseType="blob"),"arraybuffer"===r&&(l.responseType="arraybuffer"),l.onreadystatechange=function(){if(4===l.readyState)if(0===l.status||200===l.status){if(l.response&&"blob"===l.responseType){var r=new Blob([l.response],{type:t});a(r,e,i)}l.response&&"arraybuffer"===l.responseType?a(l.response,e,i):l.responseXML?a(l.responseXML,e,i):l.responseText?a(l.responseText,e,i):(console.error("XMLV43Loader: Empty or non-existing file ("+e+")"),void 0!==n&&n(e))}else void 0!==n&&n(e)},l.open("GET",e,!0),l.send(null)}else alert("Don't know how to parse XML!"),void 0!==n&&n(e);else{var o=e.replace(/^.*[\\\/]/,""),s=D.find(o);if(s&&V<P)V++,"blob"===r?s.getBlob(t).then(function(r){if(V--,G.length>0){var t=G[0];be(t.url,t.type,t.mime,t.cbLoad,t.cbError,t.args),G.splice(0,1)}a(r,e,i)}):"arraybuffer"===r?s.getUint8Array(t).then(function(r){if(V--,G.length>0){var t=G[0];be(t.url,t.type,t.mime,t.cbLoad,t.cbError,t.args),G.splice(0,1)}a(r.slice().buffer,e,i)}):"xml"===r?s.getText().then(function(r){if(V--,G.length>0){var t=G[0];be(t.url,t.type,t.mime,t.cbLoad,t.cbError,t.args),G.splice(0,1)}try{var l=(new DOMParser).parseFromString(r,"text/xml");a(l,e,i)}catch(r){void 0!==n&&n(e)}}):"string"===r&&s.getRope().then(function(r){if(V--,G.length>0){var t=G[0];be(t.url,t.type,t.mime,t.cbLoad,t.cbError,t.args),G.splice(0,1)}a(r,e,i)});else if(V>=P)G.push({url:e,type:r,mime:t,cbLoad:a,cbError:n,args:i});else if(void 0!==n&&n(e),G.length>0){var u=G[0];G.splice(0,1),be(u.url,u.type,u.mime,u.cbLoad,u.cbError,u.args)}}}function Ne(e){if(e instanceof Object){var r="Error loading 3DXML : "+e.url+"\n";switch(e.type){case"LOAD":case"LOAD_ARCHIVE":r+="Could not load the 3DXML file.";break;case"LOAD_ENTRY":r+="Could not read Zip entries for this 3DXML.";break;case"PARSE":r+="Could not parse XML data.";break;case"REPFORMAT":r+="Rep format is not supported.";break;case"VERSION":r+="This version is not supported.";break;case"REVIEW_MISSING":r+="3DXML file does not contain any review data, only briefcase."}}r+="The model is not found, corrupted or not entirely supported.",console.warn(r)}this.abort=function(){if(C=[],F=0,null!==L){for(var e=0;e<L.length;++e)null!==L[e]&&(L[e].terminate(),L[e].onmessage=null);W=[],B=!1,L=null}w&&(w=null),Ce()},this.load=function(e,r,t,a,n,i,l,o,s,f,c,m,v,g,b,x,w,I,P,V,G,_,q,j,J,Q){M?C.push({url:e,readyCallback:r,progressCallback:a,doneCallback:n,errorCallback:i,filterNavReps:l,refreshTime:o,readDeco:s,newInfra:f,optimizeCurvedPipes:J,udlMode:Q,primWithBS:c,repWithBS:j,edgeTrans:m,withSG:v,withBlanking:g,sharedBuff:b,nmir:x,ssb:w,sag:I,bagUUID:q,sagInfo:P,uvrWorker:V,iapplicativeContainers:G,processText:_,repWithBS:j}):(M=!0,N=e,e instanceof Object&&(N=e.serverurl?e.serverurl:"",N+=e.filename?e.filename:"",e.loaderSettings&&e.loaderSettings.uncompressed&&(d=!!e.loaderSettings.uncompressed,"3DX"!==(O=e.loaderSettings.repType?e.loaderSettings.repType:"CGR")||X||(X=new p))),ae=m,ne=_,le=b,oe=x,X&&(X.setSharedBuffers(le),X.setNoMeshInRAM(oe)),R=function(e){F--,null!==k&&k({loaded:U-F,total:U});(new Date).getTime();A&&A({hack:!0,updateInfinitePlane:!0,budgeted:!!F});for(var r=0;r<ue.length;r++){var t=ue[r];if(void 0!==t){var a=t.occPath._getRenderableOccurrences();if(a.length){for(var n=0;n<a.length;n++)t.material&&(t.material.force=!0,a[n]._3dxmlMaterial=t.material,a[n].material=t.material),null!==t.visible&&(a[n].visible=t.visible,a[n]._occurrence.visible=t.visible);ue[r]=void 0}}}if(F<=0){for(r=0;r<L.length;++r)null!==L[r]&&(L[r].terminate(),L[r].onmessage=null);if(W=[],B=!1,L=null,null!==T){var i=T;Ce(),i()}}},S=r,T=n,k=a,y=i,u=l,z=s,$=c,H=J,j=j,Z=w,Y=I,K=q,P=P,E=V,function(e){if(te=[],e)for(var r in e)te.push(r)}(ee=G),se=v,de=g,d?be(e+"/CATMaterialRef.3dxml","xml","text/xml",Me,function(e){Me(null,0,!0)}):(D=new h.fs.FS,e.blob?D.importBlob(e.blob,{useXHR:!1,useRangeHeader:!1,preventHeadRequest:!0}).then(function(){be(N+"/CATMaterialRef.3dxml","xml","text/xml",Me,function(e){be(N+"/CATMaterialDisciplines.3dxml","xml","text/xml",Me,function(e){Me(null,0,!0)})})},i||Ne):D.importHttpContent(e,{useXHR:!1,useRangeHeader:!1,preventHeadRequest:!0}).then(function(){be(N+"/CATMaterialRef.3dxml","xml","text/xml",Me,function(e){be(N+"/CATMaterialDisciplines.3dxml","xml","text/xml",Me,function(e){Me(null,0,!0)})})},i||Ne)))};var xe=this.load;function Ce(){if(D=null,S=null,T=null,k=null,y=null,N="",U=0,F=0,V=0,G=[],O="TESSELLATED",q=[],j=[],(new Date).getTime(),_&&(_.abort(),_=null),ue=[],fe=!1,ce={},pe={},x="",me=null,he=2,ve=[],ge={},M=!1,C.length){var e=C.shift();xe(e.url,e.readyCallback,e.progressCallback,e.doneCallback,e.errorCallback,e.filterNavReps,e.refreshTime,e.readDeco,e.newInfra,e.primWithBS,e.edgeTrans,e.withSG,e.withBlanking,e.sharedBuff,e.nmir,e.ssb,e.sag,e.uvrWorker,e.iapplicativeContainers,e.processText,e.bagUUID,e.repWithBS,e.optimizeCurvedPipes,e.udlMode)}}function Me(e,r,t){if(void 0===t||!t){var a=e.firstChild;if("Model_3dxml"!==a.nodeName)return;for(var n=0;n<a.childNodes.length;n++){var i=a.childNodes[n];if("CATMaterialRef"===i.nodeName)for(var l=0;l<i.childNodes.length;l++){var o=i.childNodes[l];if("CATMatReference"===o.nodeName||"MaterialDomainInstance"===o.nodeName||"MaterialDomain"===o.nodeName){var s=o.getAttribute("id"),d=o.getAttribute("name");switch(o.nodeName){case"CATMatReference":void 0!==ce[s]?ce[s].name=d:ce[s]={name:d};break;case"MaterialDomainInstance":for(var u=0,f=0,c=0;c<o.childNodes.length;c++)"IsAggregatedBy"===(g=o.childNodes[c]).nodeName?u=g.textContent:"IsInstanceOf"===g.nodeName&&(f=g.textContent);ce[s]={parent:u,instance:f},void 0!==ce[u]?ce[u].instance=s:ce[u]={instance:s};break;case"MaterialDomain":var p,m=o.getAttribute("associatedFile"),h=o.getAttribute("format");p=m.split("urn:3DXML:"),m=p[1];var v=!0;for(c=0;c<o.childNodes.length;c++){var g,b=(g=o.childNodes[c]).textContent;if("V_MatDomain"===g.nodeName&&"RENDERING"!==b.toUpperCase()){v=!1;break}}if(!v)break;void 0!==ce[s]?(ce[s].filename=m,ce[s].format=h):ce[s]={filename:m,format:h}}}}}}be(N+"/CATRepImage.3dxml","xml","text/xml",De,function(e){be(N+"/PLMDmtDocument.3dxml","xml","text/xml",De,function(e){De(null,0,!0)})})}function De(e,r,t){if(void 0===t||!t){var a=e.firstChild;if("Model_3dxml"!==a.nodeName)return;for(var n=0;n<a.childNodes.length;n++){var i=a.childNodes[n];if("CATRepImage"===i.nodeName)for(var l=0;l<i.childNodes.length;l++){var o=i.childNodes[l];if("CATRepresentationImage"===o.nodeName){var s=o.getAttribute("id"),d=(o.getAttribute("name"),o.getAttribute("format"),o.getAttribute("associatedFile").split("urn:3DXML:"));pe[s]={filename:d[1],buffer:null}}}}}var u=0;for(var f in pe)pe.hasOwnProperty(f)&&u++;Re(u?u-1:0)}function Ae(e,r){var t=0,a=null;for(var n in e)if(e.hasOwnProperty(n)){if(t===r){a=n;break}t++}return a}function Re(e){if(-1!==e){var r,t=Ae(pe,e);if(void 0===pe[t]||void 0===pe[t].filename||""===pe[t].filename)Re(e-1);else{var a=/(?:\.([^.]+))?$/.exec(pe[t].filename)[1],n="image/";"jpg"===a&&(a="jpeg"),n+=a;var i="blob";"dds"===a&&(n="application/octet-stream",i="arraybuffer"),be(N+"/"+pe[t].filename,i,n,Se,(r=e,function(){Re(r-1)}),e)}}else{var l=0;for(var o in ce)ce.hasOwnProperty(o)&&l++;Te(l?l-1:0)}}function Se(e,r,t){var a=Ae(pe,t);pe[a].buffer=e,Re(t-1)}function Te(e){if(-1!==e){var r=Ae(ce,e);void 0===ce[r]||void 0===ce[r].filename?Te(e-1):"UVR"!==ce[r].format?be(N+"/"+ce[r].filename,"xml","text/xml",ke,function(){},e):Te(e-1)}else be(N+"/Manifest.xml","xml","text/xml",ye)}function ke(e,r,t){var a={shading:"Phong",DiffuseMapWrap:[],DiffuseMapRepeat:[0,0]},n=e.firstChild;if("Osm"===n.nodeName){for(var i=0;i<n.childNodes.length;i++){var l=n.childNodes[i],o="Feature"===l.nodeName&&l.getAttribute("Alias");if(o&&-1!==o.indexOf("RenderingFeature"))for(var s=0;s<l.childNodes.length;s++){var d=l.childNodes[s];if("Attr"===d.nodeName){var u=d.getAttribute("Type"),f=d.getAttribute("Value"),c=d.getAttribute("Name");switch(u){case"int":switch(f=parseInt(f,10),a[c]=f,c){case"WrappingModeU":f&&(a.DiffuseMapWrap[0]="repeat",a.DiffuseMapRepeat[0]=1);break;case"WrappingModeV":f&&(a.DiffuseMapWrap[1]="repeat",a.DiffuseMapRepeat[1]=1);break;case"PreviewType":switch(parseInt(f)){case 0:a.mappingFunction="SPHERICAL_ENV_MAP";break;case 2:a.mappingFunction="USER_MAPPING"}}break;case"double":switch(c){case"DiffuseColor":a.colorDiffuse=Ue(f);break;case"SpecularColor":a.colorSpecular=Ue(f);break;case"AmbientColor":a.colorAmbient=Ue(f);break;case"SpecularExponent":a.shininess=128*parseFloat(f);break;case"SpecularCoef":a.specularCoef=parseFloat(f);break;case"Reflectivity":a.reflectivityCoef=parseFloat(f);break;case"Transparency":a.transparency=parseFloat(f),a.transparent=a.transparency>0}break;case"boolean":switch(f="true"===f,c){case"AlphaTest":a.alphaTest=f?.5:0;break;default:a[c]=f}break;case"external":var p=[];p=f.split("urn:3DXML:"),p=(f=p[1]).split("#"),f=p[0];var m=p[1];"TextureImage"===c&&pe[m]&&pe[m].buffer&&(a.DiffuseMap=pe[m])}}}}if(void 0!==t){var h=Ae(ce,t);void 0===ce[h]&&(ce[h]={}),a.type="material3DXML",ce[h].params=a}Te(t-1)}else Te(t-1)}function ye(e,r){var t=e.firstChild;if(t&&t.childNodes)for(var a=0;a<t.childNodes.length;a++){var n=t.childNodes[a];switch(n.nodeName){case"Root":x=n.textContent}}be(N+"/"+x,"xml","text/xml",Ee,function(e){var r=y||Ne;r&&r({url:e,type:"REVIEW_MISSING"})})}function Ee(n,l){var o=n.firstChild;if(o&&"Model_3dxml"===o.nodeName){for(var s=0;s<o.childNodes.length;s++)if("Header"!==(te=o.childNodes[s]).nodeName){if("ProductStructure"===te.nodeName){var d=te.getAttribute("root");for(H=0;H<te.childNodes.length;H++)if("Reference3D"===(pe=te.childNodes[H]).nodeName||"Instance3D"===pe.nodeName||"ReferenceRep"===pe.nodeName||"InstanceRep"===pe.nodeName){var f=pe.getAttribute("id"),p=pe.getAttribute("name"),m=new i;switch(pe.nodeName){case"Reference3D":void 0===ve[f]?ve[f]=m:m=ve[f];var h=d===f&&null===me;h&&(me=m);for(var v=0;v<pe.childNodes.length;v++){var b=pe.childNodes[v];if(h&&"Extension"===b.nodeName)for(var x=0;x<b.childNodes.length;x++){var C=b.childNodes[x];"V_WorldOrientation"===C.nodeName&&(he=parseInt(C.textContent,10))}else"V_Name"===b.nodeName&&(p=b.textContent)}break;case"Instance3D":case"InstanceRep":ve[f]=m;var M="",D="",R=null;for(v=0;v<pe.childNodes.length;v++)if("IsAggregatedBy"===(b=pe.childNodes[v]).nodeName)M=b.textContent;else if("IsInstanceOf"===b.nodeName)D=b.textContent;else if("RelativeMatrix"===b.nodeName){var P=Pe(b.textContent);null===R&&(R=new e.Matrix4),R.set(P[0],P[3],P[6],P[9],P[1],P[4],P[7],P[10],P[2],P[5],P[8],P[11],0,0,0,1)}else"V_Name"===b.nodeName&&(p=b.textContent);null!==R&&(m._matrix=R),""!==M&&""!==D&&(void 0===ve[M]&&(ve[M]=new i),ve[M].addChild(m),void 0===ve[D]&&(ve[D]=new i),m.addChild(ve[D]));break;case"ReferenceRep":for(void 0===ve[f]?ve[f]=m:m=ve[f],v=0;v<pe.childNodes.length;v++)"V_Name"===(b=pe.childNodes[v]).nodeName&&(p=b.textContent);D="";var V,G=pe.getAttribute("format");G&&"string"==typeof G&&(V=G.toUpperCase());var X,_=pe.getAttribute("associatedFile");"UVR"!==V&&"TESSELLATED"!==V||("3DX"===O?G="3DX":"CGR"===O?G="CGR":(G=V,O=V)),X=_.split("urn:3DXML:");var z={file:_=X[1],format:G,node:m};void 0!==q[_]?q[_].push(m):(q[_]=[m],"ifc"!==a.getExtension(_)&&j.push(z)),ge[m.id]=z}m.name=p,m.productType=pe.nodeName,m.persistentId=f,m.getPersistentId=function(){return this.persistentId}}}}else for(var H=0;H<te.childNodes.length;H++)if("SchemaVersion"===(pe=te.childNodes[H]).nodeName&&pe.textContent.substring(0,1)<4){var Z=y||Ne;return void(Z&&Z({url:l,type:"VERSION"}))}for(s=0;s<o.childNodes.length;s++)if("DefaultView"===(te=o.childNodes[s]).nodeName)for(H=0;H<te.childNodes.length;H++)"DefaultViewProperty"===(pe=te.childNodes[H]).nodeName&&we(pe);for(s=0;s<o.childNodes.length;s++){var te;if("CATMaterial"===(te=o.childNodes[s]).nodeName)for(H=0;H<te.childNodes.length;H++){var pe;"CATMatConnection"===(pe=te.childNodes[H]).nodeName&&Ie(pe)}}}if(u&&me&&me.traverse(function(e,r){var t=r.indexOf(e);if(-1!==t){r.splice(t,1),"ReferenceRep"===e.productType&&ge[e.id]&&(console.log(ge[e.id]),-1!==(t=j.indexOf(ge[e.id]))&&j.splice(t,1));for(var a=0;a<e.children.length;a++)r.push(e.children[a]);return!1}if("Reference3D"===e.productType){var n=[],i=!1;for(a=0;a<e.children.length;a++){var l=e.children[a];i=i||"Instance3D"===l.productType,"InstanceRep"===l.productType&&n.push(l)}if(i)for(a=0;a<n.length;a++)r.push(n[a])}return!1},new Array),be(N+"/ProductCDS.json","string","text/string",function(e,r){var t=g.CDS.module+"/"+g.CDS.file;require([t],function(r){var t=new r;t.unstream(e)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing.");var a=y||Ne;a&&a({url:r,type:"LOAD_ENTRY"})})},function(){}),j.length)!function(){if(fe){for(var e=0;e<ue.length;e++){var n=ue[e];if(void 0!==n&&n.matrix){var i=n.occPath._getOccurrences();if(i.length)for(var l=0;l<i.length;l++)i[l]._relativeMatrix=n.matrix,i[l]._setFrom3dxml(!0)}}me&&me._updateMatrix()}if("3DX"!==O){if(null!==L){for(var e=0;e<I;++e)L[e].terminate();L[e].onmessage=null}L=null,W=[],B=!1;var o="";if(E||"TESSELLATED"===O)if(null===L){var s=t.matchUrl(r.getWebappsBaseUrl(),window.location)?null:"Passport",d=[],u={provider:"FILE",filename:"AmdLoader.js",serverurl:r.getWebappsBaseUrl()+"AmdLoader/",module:"AmdLoader",requiredAuth:s},f={provider:"FILE",filename:"EasySax.js",serverurl:r.getWebappsBaseUrl()+"EasySax/",module:"EasySax",requiredAuth:s},p={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:s},m={provider:"FILE",filename:"Mesh.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:s},h={provider:"FILE",filename:"CGRFile.js",serverurl:r.getWebappsBaseUrl()+"Formats/",module:"Formats",requiredAuth:s};"UVR"===O||"CGR"===O?(o={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:r.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:s},(d=[u,p,m,h,o]).realWorkerUrl=r.getWebappsBaseUrl()+"Workers/CGRWorkerNewInfra.js"):"TESSELLATED"===O&&(o={provider:"FILE",filename:"XMLV43Worker.js",serverurl:r.getWebappsBaseUrl()+"Workers/",module:"Workers",requiredAuth:s},(d=[u,f,p,m,o]).realWorkerUrl=r.getWebappsBaseUrl()+"Workers/XMLV43Worker.js"),a.getWorkerBlobFromSpecs(d,function(e){L=[];for(var r={processText:ne,udlMode:ie,edgeTransparency:ae,sharedBuffers:le,noMeshInRAM:oe,primitiveWithBS:$,withBlanking:de,repWithBS:J,withSAG:Y,udlMode:ie,sagInfo:Q,withBagUUID:K},t=0;t<I;++t)L[t]=new Worker(e);for(var t=0;t<I;++t)!function(e){L[e].onmessage=function(t){var a=t.data;if(a.loaded)W.push(e),B||(B=!0,Be(S));else{var n=q[a.node];F--,a.CGR&&(r.fromCGR=!0),c.processData(n,a,{materialLibrary:ce,baseUrl:N},se,r,function(e){a.applicativesContainers&&Le(a.applicativesContainers,ee,n),null!==k&&k({loaded:U-F,total:U});(new Date).getTime();A&&A({hack:!0,updateInfinitePlane:!0,budgeted:!!F});for(var r=0;r<ue.length;r++){var t=ue[r];if(void 0!==t){var i=t.occPath._getRenderableOccurrences();if(i.length){for(var l=0;l<i.length;l++)t.material&&(t.material.force||(t.material.force=!0),i[l]._3dxmlMaterial=t.material,i[l].material=t.material),null!==t.visible&&(i[l].visible=t.visible,i[l]._occurrence.visible=t.visible);ue[r]=void 0}}}if(F<=0){if(null!==L)for(var r=0;r<L.length;++r)null!==L[r]&&(L[r].terminate(),L[r].onmessage=null);if(w&&(w=null),W=[],B=!1,L=null,null!==T){var o=T;if(Ce(),o(),ee)for(var s in ee)ee[s].doneCallback&&(re&&re[s]&&ee[s].doneCallback?ee[s].doneCallback(re[s]):ee[s].doneCallback([]))}}})}}}(t)})}else B&&Be(S);else w?Be(S):require(["DS/Formats/CGRFile"],function(e){w=e,Be(S)},function(e){var r=e.requireModules&&e.requireModules[0];console.log("Module "+r+" is missing."),y&&y()})}else Be(S)}();else{var xe=T;Ce(),xe()}}function we(r){for(var t=[],a=!0,n=!1,i=null,l=null,d=new e.Color,u=1,f=0;f<r.childNodes.length;f++){var c=r.childNodes[f];if("OccurenceId"===c.nodeName){for(var p=0;p<c.childNodes.length;p++)if("id"===(v=c.childNodes[p]).nodeName){var m="",h=[];(h=(m=(h=v.textContent.split("urn:3DXML:"))[1]).split("#"))[0],m=h[1],void 0===ve[m]||0!==t.length&&ve[m]===t[t.length-1]||t.push(ve[m])}}else if("GraphicProperties"===c.nodeName)for(p=0;p<c.childNodes.length;p++){var v;if("SurfaceAttributes"===(v=c.childNodes[p]).nodeName)for(var g=0;g<v.childNodes.length;g++){var b=v.childNodes[g];if("Color"===b.nodeName&&(n=!0,d.r=parseFloat(b.getAttribute("red")),d.g=parseFloat(b.getAttribute("green")),d.b=parseFloat(b.getAttribute("blue")),b.getAttribute("alpha")&&(u=parseFloat(b.getAttribute("alpha"))),-1===d.r))return}else"GeneralAttributes"===v.nodeName&&v.getAttribute("visible")&&(a="true"===v.getAttribute("visible"))}else if("RelativePosition"===c.nodeName){var N=Pe(c.textContent);(l=new e.Matrix4).set(N[0],N[3],N[6],N[9],N[1],N[4],N[7],N[10],N[2],N[5],N[8],N[11],0,0,0,1)}}n&&((i=(new o).getMaterialFromGAS({color:d,opacity:u})).force="forceGeomTypeFACE");for(var x=t.length>0,C=[],M=t.length-1;x&&0!==M;){for(var D=t[M],A=t[M-1];D!==A;){C.unshift(D);var R=D.getParents();if(R.length>1||0===R.length){x=!1;break}D=R[0]}M--}x&&(C.unshift(t[0]),ue.push({occPath:new s(C),material:i,matrix:l,visible:a})),l&&(fe=!0)}function Ie(e){e.getAttribute("id"),e.getAttribute("name");for(var r="",t=[],a=null,n=0;n<e.childNodes.length;n++){var i=e.childNodes[n];if("IsAggregatedBy"===i.nodeName)i.textContent;else if("PLMRelation"===i.nodeName)for(var l=0;l<i.childNodes.length;l++){var o=i.childNodes[l];if("C_Role"===o.nodeName)r=o.textContent;else if("Ids"===o.nodeName)for(var d=0;d<o.childNodes.length;d++){var u=o.childNodes[d];if("id"===u.nodeName)if("CATMaterialMadeOfLink"===r||"CATMaterialDressByLink"===r)void 0===ve[u.textContent]||0!==t.length&&ve[u.textContent]===t[t.length-1]||(t.push(ve[u.textContent]),void 0!==ve[u.textContent].children[0]&&t.push(ve[u.textContent].children[0]));else if("CATMaterialToReferenceLink"===r){var f=[],c=(f=u.textContent.split("urn:3DXML:"))[1];a={file:(f=c.split("#"))[0],id:c=f[1]}}}}}null!==a&&ue.push({occPath:new s(t),material:Fe(a.id),visible:null})}var Le=function(e,r,t){if(r&&e)for(var a in r){var n=r[a].errorCallback,i=r[a].binaryOutput;if(e[a]){var l=e[a];if(i){re[a]||(re[a]=[]);for(var o=0;o<t.length;o++)re[a].push({node:t[o],data:l})}else{if(!l){n(),delete r[a];continue}var s=l.buffer.subarray(l.options.offset,l.options.compressed+l.options.offset);if(s.length<=2){n(),delete r[a];continue}if(120!==s[0]){n(),delete r[a];continue}if(218!==s[1]){n(),delete r[a];continue}var d=s.subarray(2,l.options.compressed),u=(new v).Inflate(d),f=new TextDecoder("UTF-8").decode(u);for(re[a]||(re[a]=[]),o=0;o<t.length;o++)re[a].push({node:t[o],xml:f})}}}};function We(){if(F--,k&&k({loaded:U-F,total:U}),0===F){if(null!==L){for(var e=0;e<L.length;++e)null!==L[e]&&(L[e].terminate(),L[e].onmessage=null);W=[],B=!1,L=null}if(w&&(w=null),T){var r=T;if(Ce(),r(),ee)for(var t in ee)ee[t].doneCallback&&(re&&re[t]&&ee[t].doneCallback?ee[t].doneCallback(re[t]):ee[t].doneCallback([]))}}}function Be(e){F=j.length,U=F;for(var r=0;r<j.length;r++){var t=j[r],a=t.file,n=t.format,l=t.node;if(void 0!==a){var o=N+"/"+a,s=o,u=q[a];if(""!==a)if("3DX"===n)s+=".3dxc",X.load({url:s,concat:!0,zipped:!1,primitives:!0,reps:!0,ssb:!1,destinationNodes:u,readyCallback:function(e){F--,null!==k&&k({loaded:U-F,total:U});(new Date).getTime();if(A&&A({hack:!0,updateInfinitePlane:!0,budgeted:!!F}),F<=0&&null!==T){var r=T;Ce(),r()}},gasSharing:!0});else if(!E&&w&&"UVR"===n)!function(e,r){be(o,"arraybuffer","text/plain",function(r){var t={processText:ne,udlMode:ie,fromCGR:!0,edgeTransparency:ae,sharedBuffers:le,noMeshInRAM:oe,primitiveWithBS:$,withBlanking:de,repWithBS:J,withSAG:Y,sagInfo:Q,withBagUUID:K},a=new Uint8Array(r),n=new w([],!1,$,se,ie,b,Z,Y,ne,Q,K,J,H,de);n.setFileBuffer(a);var i=n.open(),l=q[e];F--,c.processData(l,i,{materialLibrary:ce,baseUrl:N},void 0,t)})}(a);else if(L)switch(n){case"UVR":case"CGR":"CGR"===n&&(s=s.replace(".3DRep",".cgr"));var p={renderCallback:null,readyCallback:R,doneCallback:null,errorCallback:function(){We(),y()},progressCallback:k};if(d){_||(_=new m(f,null,{keepLoader:!0}));var h={isBuffer:!1,destination:u[0],readDeco:z,optimizeCurvedPipes:H,primWithBS:$,withBlanking:de,repWithBS:J,smartStaticBatching:Z,withSAG:Y,withBagUUID:K,sagInfo:Q,edgeTransparency:ae,sharedBuffers:le,noMeshInRAM:oe,withSceneGraph:se};_.load({serverurl:s},p,h)}else!function(e,r){be(o,"arraybuffer","text/plain",function(t,a){var n=W[r%W.length];L&&L[n].postMessage({inputFile:t,node:e,readDecoration:z,primitiveWithBS:$,withBlanking:de,repWithBS:J,smartStaticBatching:Z,withSAG:Y,withBagUUID:K,sagInfo:Q,applicativesContainers:te,withSceneGraph:se,uint32Index:b,processText:ne,uvr:!0,optimizeCurvedPipes:H},[t])})}(a,r);break;case"TESSELLATED":!function(e,r){be(o,"string","text/plain",function(t,a){var n=W[r%W.length];L&&L[n].postMessage({path:t,node:e,uint32Index:b})},function(e){var r=y||Ne;We(),r&&r({url:e,type:"LOAD_ENTRY"})})}(a,r);break;default:g[n]?function(e,r,t){be(o,"xml","text/xml",function(a,n){var i=g[r].module+"/"+g[r].file;require([i],function(r){(new r).unstream(a,e,t),We()},function(e){var r=e.requireModules&&e.requireModules[0];console.log("Module "+r+" is missing.");var t=y||Ne;We(),t&&t({url:n,type:"REPFORMAT"})})},function(e){var r=y||Ne;We(),r&&r({url:e,type:"REPFORMAT"})})}(a,n,l):We()}else We()}}e&&(null===me&&(me=new i),e(me,he))}function Ue(e){var r=[],t=new RegExp(/\[([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?))\]/),a=t.exec(e);return null!==a?(r[0]=parseFloat(RegExp.$1),r[1]=parseFloat(RegExp.$2),r[2]=parseFloat(RegExp.$3)):null!==(a=(t=new RegExp(/\[([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?)),([0,1]|(?:[0-9]?\.[0-9]*(?:[eE][-+][0-9]+)?))\]/)).exec(e))&&(r[0]=parseFloat(RegExp.$1),r[1]=parseFloat(RegExp.$2),r[2]=parseFloat(RegExp.$3),r[3]=parseFloat(RegExp.$4)),r}function Fe(r){var t=new o,a=ce[r];if(void 0===a)return null;var n=ce[a.instance];if(void 0===n)return null;var i=ce[n.instance];return void 0===i?null:(void 0===i.material&&void 0!==i.params?(i.material=t.getMaterial3DXML(i.params,N,"XMLV43"),i.material.force=!0):void 0===i.params&&(i.material=e.MaterialUtils.createMatteFaceMaterial(),i.material.force=!0),i.material)}function Pe(e){for(var r=function(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}(e),t=[],a=0,n=r.length;a<n;a++)t.push(parseFloat(r[a]));return t}}});