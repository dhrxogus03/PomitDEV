define("DS/MPFTopBarMultiShopsComponent/TopBarMultiShopsComponent",["UWA/Core","UWA/Promise","UWA/Utils","UWA/Class/View","DS/MPFDataProxy/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFShopModel/ShopFactory","DS/MPFShopModel/ShopCollection","DS/UIKIT/DropdownMenu","DS/PlatformAPI/PlatformAPI"],function(e,t,s,i,n,o,h,a,l,c){"use strict";return i.extend({className:"mpf-shop-selector",setup:function(e={}){this.shops=null,this.selectedLabId=e.selectedLabId,this.selectedLabName="",this.targetContainer=e.targetContainer,this.onInitCB=e.onInit,this.onRefreshCB=e.onRefresh,this.onSelectionCB=e.onSelection,this.marketplaceService=e.service,this.container.setStyles({position:"absolute","text-align":"left"}),c.subscribe("newLabSelectedRequest",this.onNewLabSelectedRequest.bind(this)),c.subscribe("newLabCreated",this._onNewLabCreated.bind(this)),c.publish("topBarMultiShopsReady"),this._loadData()},_loadData:function(){return n.fetchPromise({service:this.marketplaceService}).then(function(e){const s=o.getInstance(e);return t.all([s.getFactory(o.Types.SHOP),s.getFactory(o.Types.PERSON)])}).then(e=>(this.shopFactory=e[0],this.personFactory=e[1],this.me=this.personFactory.createModel("me"),this.shops=this.shopFactory.createCollection(h.Types.ME),t.all([this._fetchShops(),this.me.fetchPromise()]))).then(this._initShop.bind(this))},_isEmpAmdin:function(e){const t=s.parseQuery(window.location.search).esid;return e.getRoles().filter(function(e){return"Admin"===e.Role&&e.Project===t}).length>0},_initShop:function(){let e;this._isEmpAmdin(this.me)&&this.selectedLabId?(e=this.shops.get(this.selectedLabId))?(this.selectedLabName=e.getName(),this._callInitCallBack(e,!0)):(e=this.shopFactory.createModel(h.Types.SHOP,{id:this.selectedLabId})).fetchPromise({uc2:!0}).then(()=>{this.selectedLabName=e.getName(),this._callInitCallBack(e,!0)}):this.shops.isEmpty()||(e=this.shops.get(this.selectedLabId),1!==this.shops.size()&&e||(e=this.shops.first(),this._setSelectedLab(e.id)),this._callInitCallBack(e))},render:function(){return this.container.setContent(),this.menu&&this.menu.destroy(),this.menu=new l({position:"bottom right",items:this._createItems(),target:this.targetContainer,renderTo:this.container,events:{onClick:(e,t)=>{t.id!==this.selectedLabId&&(this._setSelectedLab(t.id),c.publish("newLabSelected",{id:this.selectedLabId,text:t.text,from:"TopBarMultiShops"}),this.onSelectionCB&&this.onSelectionCB({id:this.selectedLabId,text:t.text,shopsCount:this.shops.size()}))}}}),this.menu.elements.container.setStyles({"max-height":"80vh","overflow-y":"auto"}),this},destroy:function(){c.unsubscribe("newLabSelectedRequest"),c.unsubscribe("newLabCreated"),this.menu&&this.menu.destroy(),this.menu=null,this.shops=null,this.selectedLabId=null,this.selectedLabName=null,this.targetContainer=null,this.onInitCB=null,this.onRefreshCB=null,this.onSelectionCB=null,this.marketplaceService=null,this.shopFactory=null,this.personFactory=null,this.me=null,this._parent()},setTarget:function(e){this.targetContainer=e,this.container.inject(e,"after")},onNewLabSelectedRequest:function(t){t&&"CompanyEcosystem"===t.from?t.id!==this.selectedLabId?(this.oldSelectedLabId=this.selectedLabId,this.selectedLabId=t.id,this._initShop()):t.backToPreviousLab&&e.is(this.oldSelectedLabId)&&(this.selectedLabId=this.oldSelectedLabId,this.oldSelectedLabId=null,this._initShop()):this._publishSelectedLab()},_createItems:function(){const e=this;return this.shops.map(function(t){const s=t.id===e.selectedLabId;return{text:t.get("shopName"),id:t.id,selected:s,selectable:!s}})},_fetchShops:function(){return this.shops.fetchPromise({expand:[]})},_getShopName:function(e){const t=this.shops.get(e);return void 0!==t?t.getName():""},_publishSelectedLab:function(){const e=this._getShopName(this.selectedLabId);c.publish("newLabSelected",{id:this.selectedLabId,text:e,from:"TopBarMultiShops"})},_onNewLabCreated:function(e){return this._fetchShops().then(()=>{this._setSelectedLab(e.id),this._notifyNewLabSelected(),this._callRefreshCallBack(),this._notifyLabChanged(e.topic)})},_setSelectedLab:function(e){this.selectedLabId=e,this.selectedLabName=this._getShopName(this.selectedLabId)},_notifyNewLabSelected:function(){c.publish("newLabSelected",{id:this.selectedLabId,text:this.selectedLabName,from:"TopBarMultiShops"})},_callInitCallBack:function(e,t){const s=t?this.shops.size()||1:this.shops.size();this.onInitCB&&this.onInitCB({id:e.get("id"),text:e.get("shopName"),shopsCount:s})},_callRefreshCallBack:function(){this.onRefreshCB&&this.onRefreshCB({id:this.selectedLabId,text:this.selectedLabName,shopsCount:this.shops.size()})},_notifyLabChanged:function(e){c.publish(e,{event:"labChanged",target:"service-information"})}})});