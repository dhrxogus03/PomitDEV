define("DS/DMUPlaySection/DMUClippingRobot",["UWA/Class","DS/DMUMeasurable/DMUManipulableClippingPlane","DS/DMUMeasurable/DMUToolsMaths","DS/Visualization/ThreeJS_DS","DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUMeasurable/DMUMeasurable","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUSwitchRepService","DS/DMUMeasurable/DMUSectionPosService","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/PathElement","DS/Ruler/Ruler","DS/Ruler/AngularRuler","DS/Robot/LineTranslationNode","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/DMUMeasurable/DMUPreVisuNode3D","DS/DMUMeasurable/DMUMeasureEnums"],function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,v,f,m,S,h,C,b,y,M,P,w,D,x,V,A){"use strict";return e.extend({init:function(e,N){this._parent();var _,R,T,O,E=e,I=E.getFrameWindow(),U=I.getViewer(),B=m,L=S,k=h,F=E.getAppType(),z=new d({viewer:U}),W=!1,G=!1,j=!1,H=!1,X=!1;this.isManipulationOnGo=function(){return j||X||H};var Y=E.manipulationInformationCB,J={clearTimeout:void 0,lockedNodeIds:[]};function Z(){J&&J.clearTimeout&&(J.clearTimeout(),J.clearTimeout=void 0)}function q(){z&&J&&(z.unlockNodes({nodeIDsToUnlock:J.lockedNodeIds,nodeIDsToUnlockMeshInRAM:J.lockedNodeIds}),J.lockedNodeIds=[])}var Q,K,$,ee,te,ie,ne,oe,re,ae=this,le=[],se=[],ce={origin:new n.Vector3,initOrigin:new n.Vector3,direction:null,initValue:null,value:null,origin3D:null},ue={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},pe=function(){var e=(new n.Vector3).copy(E.getUDirection()),t=(new n.Vector3).copy(E.getVDirection()),i=(new n.Vector3).copy(E.getNormal()),o=(new n.Matrix4).makeBasis(e,t,i.negate()),r=(new n.Vector3).copy(E.getCenter());return o.setPosition(r),o},ge=!1,de=function(e){var t=e;if(t){var i=t.clone().normalize();i.x>.9995||i.y>.9995||i.z>.9995?t=i:(-i.x>.9995||-i.y>.9995||-i.z>.9995)&&(ge=!0,t=i.negate())}return t},ve=function(){return c.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value},fe=function(){return c.readPreferences({name:"cke",PreferenceNames:["Angle"]}).preferences[0].value},me=function(e){re=null;var t=new n.Vector3,i=new n.Vector3,o=new n.Vector3;return e.extractBasis(t,i,o),o.x>.9995||-o.x>.9995||o.y>.9995||-o.y>.9995||o.z>.9995||-o.z>.9995?(re=new n.Vector3(0,0,0),oe=re.clone()):(re=(new n.Vector3).getPositionFromMatrix(e),oe=re.clone()),re};N?(oe=N,re=N):me(pe()),this._getRulerOriginPos=function(){return oe?oe.clone():oe};var Se=function(e){var t=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"mesh",!1);if(0!==t.path.length&&t.path[0]){var i,o=t.path[0];return(i=o&&o.getWorldMatrix?(new n.Vector3).getPositionFromMatrix(o.getWorldMatrix()):new n.Vector3(0,0,0))&&(ce.origin3D=i.clone(),oe=i.clone(),re=i.clone()),o?{origin3D:i}:void 0}},he=function(e,t){if(K&&e&&(e.axis||e.manipulator.axis)){var i=(new n.Vector3).copy(e.axis?e.axis:e.manipulator.axis);ue.direction=i;var o=t?E.getVDirection():E.getUDirection();!function(e,t){if(K){var i=(new n.Vector3).copy(e);K.direction=i.negate(),K.setValue(0),K.initValue=K.value,K.origin=(new n.Vector3).copy(E.getCenter()),K.originVector=(new n.Vector3).copy(t),K.display()}}(e.axis?e.axis:e.manipulator.axis,o)}};this.buildRobot=function(){if(!_){j=!1,H=!1,X=!1;var e=U.picking.primitive,c=U.pPicking.primitive,d={},m={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},S=function(e){var t,i,o,r,a,l,s=e.clone();return t=(s=s.negate()).x,i=s.y,o=s.z,r=Math.abs(t),a=Math.abs(i),l=Math.abs(o),r>=a&&r>=l?t>0?new n.Vector3(1,0,0):new n.Vector3(-1,0,0):a>r&&a>=l?i>0?new n.Vector3(0,1,0):new n.Vector3(0,-1,0):l>r&&l>a?o>0?new n.Vector3(0,0,1):new n.Vector3(0,0,-1):s},h=function(e){e&&(e.drawMode="Section",ae._preVisuNode?ae._preVisuNode.buildPreVisuNode({data:e}):(ae._preVisuNode=new V(U),ae._preVisuNode.buildPreVisuNode({data:e}),ae._preVisuNode.setNoZ(!0),ae._preVisuNode.setPickable(D.PICKTHROUGH),U&&(M.getSceneRoot(U).add(ae._preVisuNode),U.render())),ae._preVisuNode.setVisibility(U.getVisibleSpace()))},C=function(){ae._preVisuNode&&(M.getSceneRoot(U).remove(ae._preVisuNode),U.render(),ae._preVisuNode.removeChildren(),ae._preVisuNode.remove(),ae._preVisuNode=void 0)},b=function(e){var t=(new n.Matrix4).copy(ee),i=(new n.Matrix4).setPosition((new n.Vector3).getPositionFromMatrix(te)),o=(new n.Matrix4).getInverse(i).multiply(t),r=(new n.Matrix4).copy(e).multiply(o),a=(new n.Matrix4).copy(i).multiply(r);E.setPlaneGeometryCB({referential:a})};_=new o({frameWindow:I,lightDisplay:"3dPlay"===F,getRulerUnitCB:ve,getAngularRulerUnitCB:fe,checkDirforRuler:de});var y=pe();_.setPosition({robotMatrix:y,translationRulerOrigin:me(y)}),ce.origin3D=re;var w=E.getCenter();ce.origin=w.clone(),ce.initOrigin=w.clone(),ce.baseOrigin=w.clone(),_.setVisibility(!0),_.robotOrigin3DCompute=Se,_.moveRulerOrigin=function(){E.setClippingRepVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})},_.moveRulerOriginEnd=function(){E.setClippingRepVisibility(!0)},_.robotMatrixCompute||(_.robotMatrixCompute=function(e){Z(),G=!0,T&&B.remove({pathElement:T});var t=l.getViewpointInfo(U.currentViewpoint),i=e.viewer.pick(e.viewer.getMousePosition(e.event.from[0].getCurrentPosition(e.viewer.canvas)),"primHybrid",!0);if(i.path.length>0&&i.path[0]&&z&&(m.none||!(x(!0)||0===m.point&&0===m.center&&0===m.axisSystem&&0===m.line&&0===m.plane&&0===m.cylinder&&1===m.surface))){var o=z.switchToAV1({path:i.path[0],lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){J.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(J.lockedNodeIds||(J.lockedNodeIds=[]),t.forEach(function(e){-1===J.lockedNodeIds.indexOf(e)&&J.lockedNodeIds.push(e)}))},onFailureCB:function(){J.clearTimeout=void 0}});if(o&&o.clearTimeout&&(J.clearTimeout=o.clearTimeout),o&&o.nodeIDsOfAlreadyLoadedNode&&o.nodeIDsOfAlreadyLoadedNode.length){var r=[];o.nodeIDsOfAlreadyLoadedNode.forEach(function(e){-1===J.lockedNodeIds.indexOf(e)&&(r.push(e),J.lockedNodeIds.push(e)),r&&r.length&&(z.lockNodes({nodeIDsTolock:r,nodeIDsTolockMeshInRAM:r}),r=[])})}}if(0!==i.path.length&&i.path[0]&&i.position){d.axisX=void 0,d.axisY=void 0,d.axisZ=void 0,d.position=void 0;var a,s,c=i.path[0];i.normal&&(a=i.normal),i.position&&(s=i.position);var v=!1,f={};if(m.none||m.axisSystem||x()){var b=c,y=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var i=e.externalPath[t];if(M.isPLMNode(i))break;if("AxisSystems"===i.name)return t}return 0}(b);if(y||x()){if(t&&t.sight){var P;if(m.none||m.axisSystem){b&&b.getWorldMatrix?P=b.getWorldMatrix():(P=(new n.Matrix4).makeBasis(new n.Vector3(1,0,0),new n.Vector3(0,1,0),new n.Vector3(0,0,1))).setPosition(new n.Vector3(0,0,0));var w=b.externalPath[y+1];if(Boolean(w)&&Boolean(w.getMatrixWorld())){for(var D=new k,V=0;V<=y+1;V++)D.addElement(b.externalPath[V]);var N=D.getWorldMatrix();N&&(P=N)}for(var _=[],R=0;R<y+2;R++){var E=b.externalPath[R];_.push(E)}_.length&&(T=new k(_),B.add({pathElement:T}))}else{var I=c;P=I.getWorldMatrix(),x()&&(P=(I=function(e){var t=e;return e.pathElement=new k,t.externalPath.some(function(t){return e.pathElement.addElement(t),t&&M.is3DLeaf(t)}),t.internalPath.length>0&&(e.originalPathElement=t),e}(c)).getWorldMatrix())}var F=P.clone(),j=new n.Vector3,H=new n.Vector3,X=new n.Vector3;if(F.extractBasis(j,H,X),s=(new n.Vector3).getPositionFromMatrix(F),(a=function(e,t,i,n){if(e||t&&i&&n){var o,r=t,a=void 0,l=e.clone();return l=l.negate(),t&&(a=o=l.angleTo(t),r=t),i&&(o=l.angleTo(i))<a&&(a=o,r=i),n&&(o=l.angleTo(n))<a&&(a=o,r=n),r}}(t.sight,j,H,X))&&(a.equals(j.clone())||a.equals(j.clone().negate())?(f.axis1=H,f.axis2=X):a.equals(H.clone())||a.equals(H.clone().negate())?(f.axis1=j,f.axis2=X):(a.equals(X.clone())||a.equals(X.clone().negate()))&&(f.axis1=H,f.axis2=j)),x()){var Y=[],q=(new n.Matrix4).makeBasis(f.axis1,f.axis2,a);q.setPosition(s),Y.worldMatrix=q,Y.resultType=A.ResultType.PRODUCT,h(Y)}v=!0}v||(a=void 0,s=void 0,v=!0)}}var Q,K,$=M.isOOCTileSetNodeInPath(c);if(c&&!v&&(c.getLastElement().sgNode||$)){var ee;if($){var te=(new n.Matrix4).getInverse(c.getWorldMatrix()),ie=i.position,ne=ie.clone().applyMatrix4(te);ee=new u({canonic:{type:g.GeometryType.POINT,position:ne},pathElement:c,selpoint:ie})}else ee=new u({primitive:c.getLastElement().sgNode,pathElement:c,selpoint:i.position});var oe=ee.getType();switch(ae._preVisuNode&&O!==oe&&C(),oe){case g.GeometryType.POINT:G=!1,m.none||m.point?(h(ee),t&&t.sight&&(a=S(t.sight))):(a=void 0,s=void 0);break;case g.GeometryType.LINE:if(G=!1,m.none||m.line){if(h(ee),t&&t.sight){var re=ee.getPoints(),le=new n.Vector3;le.subVectors(re.beginPoint,re.endPoint).normalize();var se=le.dot(t.sight);a=le.multiplyScalar(se>0?1:-1).negate(),s=i.position}}else a=void 0,s=void 0;break;case g.GeometryType.CIRCLE:G=!1,m.none||m.center?(h(ee),t&&t.sight&&(a=S(t.sight)),s=ee.getCenter()):(a=void 0,s=void 0);break;case g.GeometryType.SPHERE:case g.GeometryType.SURFACE:case g.GeometryType.PLANE:if(oe===g.GeometryType.SPHERE&&!m.surface)break;var ce=i.normal;if(!ce.length()&&oe===g.GeometryType.PLANE){let e=ee.getPlane();e&&e.normal&&(ce=ee.getPlane().normal)}if(m.none||m.plane||m.surface){if(m.none&&oe===g.GeometryType.SURFACE||m.surface&&(!m.plane||oe===g.GeometryType.SURFACE))ee.normal=ce,ee.resultType=A.ResultType.SURFACE,W=!1,O===oe&&(W=!0),O=oe,ee.onlyUpdatePos=W;else if(m.plane&&!m.surface&&oe!==g.GeometryType.PLANE){a=void 0,s=void 0;break}h(ee),a=ce}else a=void 0,s=void 0;break;case g.GeometryType.CYLINDER:case g.GeometryType.CONE:if(m.none||m.cylinder){h(ee),a=i.normal;var ue=ee.getPoints(),pe=i.position.toArray(),ge=ue.beginPoint.toArray(),de=ee.getAxis().toArray(),ve=a.toArray(),fe=p.computeTwoLinesDistance(pe,ve,ge,de).aPosition2;s=new n.Vector3(fe[0],fe[1],fe[2])}else m.surface?(W=!1,O===oe&&(W=!0),O=oe,ee.onlyUpdatePos=W,ee.resultType=A.ResultType.SURFACE,ee.normal=i.normal,h(ee),s=i.position,a=i.normal):(a=void 0,s=void 0);break;default:a=void 0,s=void 0}}else if(!v&&(m.surface||m.none)){var me=[];me.normal=i.normal;var Se=i.position;me.getSelPoint=function(){return Se},me.resultType=A.ResultType.SURFACE,W=!1,O===A.ResultType.SURFACE&&(W=!0),O=A.ResultType.SURFACE,me.onlyUpdatePos=W,h(me)}if(!a||!s)return U.setPicking({displayHL:!1}),U.setPrePicking({displayHL:!1}),void(c&&(B.empty(),L.empty()));if(U.setPicking({displayHL:!0}),U.setPrePicking({displayHL:!0}),a.negate(),a.normalize(),v&&f&&f.axis1&&f.axis2)Q=f.axis1,K=f.axis2;else{var he=M.getXYAxisDirFromZ(a.clone());he.xDir&&he.yDir&&(Q=he.xDir,K=he.yDir)}d.axisX=Q.clone(),d.axisY=K.clone(),d.axisZ=a.clone(),d.position=s.clone();var Ce=(new n.Matrix4).makeBasis(Q,K,a.negate()),be=(new n.Vector3).copy(s);return Ce.setPosition(be),{robotMatrix:Ce}}ae._preVisuNode&&C()}),function(){_.moveBegin=function(e){ae.clearRulers(),X=!0,"translation"===e.kind?function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){R&&R.setVisibleFlag(!0);var i=E.getPlaneGeometryCB();ee=(new n.Matrix4).copy(i.referential),te=e.robotMatrix,Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):function(e){if(j=!0,R&&R.setVisibleFlag(!0),Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=E.getPlaneGeometryCB();ee=(new n.Matrix4).copy(i.referential),"ruler"===e.from&&"rotation"===e.kind&&ee.setPosition(E.getCenter()),te=e.robotMatrix,Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)},_.move=function(e){X=!0,e&&("ruler"===e.from?"translation"===e.kind?function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=E.getCenter(!0),n=E.getPlaneGeometryCB().referential;n.setPosition(i.clone().add(e.translationVector)),E.setPlaneGeometryCB({referential:n}),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):(function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,o=e.axis.clone().dot(E.getUDirection()),r=e.axis.clone().dot(E.getVDirection());i.areEqual(Math.abs(r),1,"float")?(n=i.isLessOrEqual(r,0)?-e.rotationAngle:e.rotationAngle,ee=ee.rotateY(n),E.setPlaneGeometryCB({referential:ee,toRelocate:!0})):(n=i.isLessOrEqual(o,0)?-e.rotationAngle:e.rotationAngle,ee=ee.rotateX(n),E.setPlaneGeometryCB({referential:ee,toRelocate:!0})),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.ROTATION,evt:e.event})}}(e),me(e.robotMatrix)):"robot"===e.from&&("translation"===e.kind?function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=(new n.Matrix4).makeTranslation(e.translationVector.x,e.translationVector.y,e.translationVector.z);b(i),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.TRANSLATION,evt:e.event})}}(e):(function(e){if(j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=e.axis,o=e.rotationAngle,r=(new n.Matrix4).makeRotationAxis(i,o);b(r),Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.ROTATION,evt:e.event})}}(e),me(e.robotMatrix))))},_.moveEnd=function(e){"translation"===e.kind?function(e){Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})&&(ee=void 0,te=void 0),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:e.event}),j=!1}(e):function(e){j=!1,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})&&(ee=void 0,te=void 0);var i=pe();_.setPosition({robotMatrix:i,translationRulerOrigin:me(i),doNotResetRuler:1}),ce.origin3D=re,Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:e.event})}(e),X=!1};_.moveRobotBegin=function(i){Z(),ae.clearRulers(),j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:i.event})&&(x()||(e=U.picking.primitive,c=U.pPicking.primitive,1!==e&&U.setPicking({primitive:1}),1!==c&&U.setPrePicking({primitive:1})),E.setClippingRepVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:i.event}))},_.moveRobot=function(e){j=!0,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER,evt:e.event})&&(E.setClippingRepVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.CENTER,evt:e.event}))},_.moveRobotEnd=function(i){if(j=!1,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.CENTER})){ae._preVisuNode&&C(),E.setClippingRepVisibility(!0);var o,r,a=E.getPlaneGeometryCB().referential;if(d.axisX&&d.axisY&&d.axisZ&&d.position){if(a.makeBasis(d.axisX,d.axisY,d.axisZ),a.setPosition(d.position),!E.isBoxMode||!E.isBoxMode()){var l=P.computeBoundingBox(U,void 0,E.isPersistentClippingCB,function(){return s.getContextViewer({viewer:U})}),u=v.computePlaneDim(l,a,G);u&&(u.fPlaneSizeV&&u.fPlaneSizeU&&(o=u.fPlaneSizeU,r=u.fPlaneSizeV),u.plane&&((a=u.plane).extractBasis(d.axisX,d.axisY,d.axisZ),d.position=(new n.Vector3).getPositionFromMatrix(a)))}var p=E.computePlaneCenter(a);p&&a.setPosition(p),E.setPlaneGeometryCB({referential:a,uSize:o,vSize:r,uStep:o?o/20:void 0,vStep:r?r/20:void 0});var g=(new n.Matrix4).makeBasis(d.axisX,d.axisY,d.axisZ.clone().negate()),f=(new n.Vector3).copy(d.position);g.setPosition(f),_.setPosition({robotMatrix:g,translationRulerOrigin:me(g)});var m=(new n.Vector3).getPositionFromMatrix(g);ce.origin=m.clone(),ce.initOrigin=m.clone(),ce.baseOrigin=m.clone(),ce.origin3D=re}}x()||(U.setPicking({primitive:e}),U.setPrePicking({primitive:c})),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.CENTER,evt:i.event}),Z(),q(),O=void 0,W=!1}}(),function(){var e=localStorage.getItem("SectionSelectionFilter");e&&12===e.length&&e.startsWith("0-")&&(m.point="1"===e.charAt(2)?1:0,m.center="1"===e.charAt(3)?1:0,m.axisSystem="1"===e.charAt(4)?1:0,m.line="1"===e.charAt(5)?1:0,m.plane="1"===e.charAt(6)?1:0,m.cylinder="1"===e.charAt(7)?1:0,m.surface="1"===e.charAt(8)?1:0,m.product="1"===e.charAt(9)?1:0,0===m.point&&0===m.center&&0===m.axisSystem&&0===m.line&&0===m.plane&&0===m.cylinder&&0===m.surface&0===m.product?m.none=1:m.none=0);var t=function(){if(R){m={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,surface:0,product:0},R.getActiveState("point")&&(m.none=0,m.point=1),R.getActiveState("center")&&(m.none=0,m.center=1),R.getActiveState("axisSystem")&&(m.none=0,m.axisSystem=1),R.getActiveState("line")&&(m.none=0,m.line=1),R.getActiveState("plane")&&(m.none=0,m.plane=1),R.getActiveState("cylinder")&&(m.none=0,m.cylinder=1),R.getActiveState("surface")&&(m.none=0,m.surface=1),R.getActiveState("product")&&(m.none=0,m.product=1);var e="0-"+m.point+m.center+m.axisSystem+m.line+m.plane+m.cylinder+m.surface+m.product+"-1";localStorage.setItem("SectionSelectionFilter",e)}};if(!R){var i={};i.point=f.point,i.center=f.center,i.axisSystem=f.axisSystem,i.line=f.line,i.plane=f.plane,i.cylinder=f.cylinder,i.surface=f.surface,i.product=f.product;var n=a.getWebappsAssetUrl("DMUMeasure","icons/32/");(R=new r({body:I.getUIFrame(),frmWindow:I,Idpanel:"SectionSelectionFilter",classpanel:"SectionSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:i.point,url:n+"I_Meas_Point.png",callback:t,bexclude:!1,bstateActif:m.point},{type:"element",id:"center",nls:i.center,url:n+"I_Meas_PointCircle.png",callback:t,bexclude:!1,bstateActif:m.center},{type:"element",id:"axisSystem",nls:i.axisSystem,url:n+"I_Meas_Axis.png",callback:t,bexclude:!1,bstateActif:m.axisSystem},{type:"element",id:"line",nls:i.line,url:n+"I_Meas_Line.png",callback:t,bexclude:!1,bstateActif:m.line},{type:"element",id:"plane",nls:i.plane,url:n+"I_Meas_Plane.png",callback:t,bexclude:!1,bstateActif:m.plane},{type:"element",id:"cylinder",nls:i.cylinder,url:n+"I_Meas_Cylinder.png",callback:t,bexclude:!1,bstateActif:m.cylinder},{type:"element",id:"surface",nls:i.surface,url:n+"I_Meas_Surface.png",callback:t,bexclude:!1,bstateActif:m.surface},{type:"element",id:"product",nls:i.product,url:n+"I_Meas_Product.png",callback:t,bexclude:!1,bstateActif:m.product}]}))&&(R.build(),R.setVisibleFlag(!0))}}()}function x(e){return!(1!==m.product||0!==m.point||0!==m.center||0!==m.axisSystem||0!==m.line||0!==m.plane||0!==m.cylinder||!e&&0!==m.surface)}};var Ce=function(){(Q=new C(I,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:"3dPlay"===F})).setVisibilityFree(!0);var e,i,o;(se=[]).push(Q.subscribe("OriginManipulateBegin",function(){e=Q.displayOrigin,i=(Q.origin3DPos||Q.origin).clone()})),Q.onOriginManipulator=function(n){if(o=null,Se){var r=Se({event:n.event,viewer:U});(o=r&&r.origin3D)&&Y({fromRobot:!0,action:t.ManipulationAction.DO,type:t.ManipulationType.CENTER})}return Q.displayOrigin=e,o?(Q.displayOrigin=!0,E&&E.setClippingRepVisibility(!1),o.clone()):i},se.push(Q.subscribe("OriginManipulateEnd",function(){_&&_.setPosition({translationRulerOrigin:o?o.clone():o}),ce.origin3D=o?o.clone():o,E&&E.setClippingRepVisibility(!0)})),se.push(Q.subscribe("RulerManipulateBegin",function(e){var i;i=e,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&(_&&_.setVisibility(!1),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:i.event}))})),se.push(Q.subscribe("RulerManipulate",function(e){!function(e){if(Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:e.event})){var i=E.getPlaneGeometryCB().referential,o=(new n.Vector3).getPositionFromMatrix(i);i.setPosition(o.clone().add(e.translationVector)),E.setPlaneGeometryCB({referential:i}),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.TRANSLATION,evt:e.event})}ae.updateRobotPos()}(e)})),se.push(Q.subscribe("RulerManipulateEnd",function(e){var i;i=e,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.TRANSLATION,evt:i.event})&&_&&_.setVisibility(!0),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.TRANSLATION,evt:i.event}),ae.updateRobotPos()}))},be=function(){(K=new b(I,{radius:150,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:"3dPlay"===F})).setVisibilityFree(!0);(le=[]).push(K.subscribe("AngularRulerManipulateBegin",function(e){!function(e){if(Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var i=E.getPlaneGeometryCB();ee=(new n.Matrix4).copy(i.referential),_&&(te=(new n.Matrix4).copy(_.getMatrix()),_.setVisibility(!1)),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}}(e)})),le.push(K.subscribe("AngularRulerManipulate",function(e){!function(e){if(Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:e.event})){var n,o=e.direction.clone().dot(E.getUDirection()),r=e.direction.clone().dot(E.getVDirection());i.areEqual(Math.abs(r),1,"float")?(n=i.isLessOrEqual(r,0)?-e.diffAngle:e.diffAngle,E.setPlaneGeometryCB({referential:ee.rotateY(n*Math.PI/180)})):(n=i.isLessOrEqual(o,0)?-e.diffAngle:e.diffAngle,E.setPlaneGeometryCB({referential:ee.rotateX(n*Math.PI/180)})),Y({fromRobot:!0,action:t.ManipulationAction.BEGIN,type:t.ManipulationType.ROTATION,evt:e.event})}ae.updateRobotPos(!1,!0)}(e)})),le.push(K.subscribe("AngularRulerManipulateEnd",function(e){var i;i=e,Y({fromRobot:!0,action:t.ManipulationAction.ENABLE,type:t.ManipulationType.ROTATION,evt:i.event})&&(ee=void 0,_&&_.setVisibility(!1)),Y({fromRobot:!0,action:t.ManipulationAction.END,type:t.ManipulationType.ROTATION,evt:i.event}),ae.updateRobotPos(!1,!0)}))};return this.clean=function(){this.isManipulationOnGo()||(ge=!1,_&&(_.destroy(),_=null),R&&(R.clear(),R=null),ie&&(U.removeNode(ie),ie.removeChildren(),ie.remove(),ie=void 0),Q&&se&&se.length>0&&(se.forEach(function(e){Q.unsubscribe(e)}),se=[]),K&&le&&le.length>0&&(le.forEach(function(e){K.unsubscribe(e)}),le=[]),Z(),q(),this.clearRulers())},this.update=function(e){void 0!==e&&"boolean"==typeof e&&(void 0===e||X||_.setVisibility(!e),R&&R.setVisibleFlag(!e))},this.updateRobotPos=function(e,t){if(_){var i=!1;U.getVisibleSpace()||(i=!0),ae.update(i);var n=pe();if(t?_.setPosition({robotMatrix:n,translationRulerOrigin:me(n),doNotResetRuler:j}):_.setPosition({robotMatrix:n,doNotResetRuler:j}),t){var o=E.getCenter();ce.origin=o.clone(),ce.initOrigin=o.clone(),ce.baseOrigin=o.clone(),ce.origin3D=re}}e&&ae.clearRulers()},this.updateOnTranslationBegin=function(e){if(H=!0,ge=!1,$=e.intersection.position,this.clearAngularRuler(),Q||Ce(),!ie){ie=new x;var t={position:new n.Vector3(0,0,0),touchMode:!1},i=new w({name:"fixedSizeNode3D",ratio:7}),o=new y(t);o.name="arrowTranslationNode",o.mat.color=new n.Color("#1B6E9C"),o.mat.opacity=1,o.setNoZ(!0),i.addChild(o),U&&ie&&(ie.addChild(i),U.addNode(ie),U.render())}ie&&(ie.setMatrix(pe().setPosition($.clone())),ie.setVisibilityInTree(!1),ie.setVisibility(U.getVisibleSpace()),ie.setPickable(D.PICKTHROUGH));var r=(new n.Vector3).copy(e.manipulator.axis).negate();r=de(r);var a=E.getCenter().clone(),l=(new n.Vector3).copy(r).multiplyScalar((new n.Vector3).copy(ce.baseOrigin).sub(a).dot(r));ce.initOrigin=(new n.Vector3).copy(a).add(l);var s=(new n.Vector3).copy(ce.initOrigin);ce.origin3D&&(s=new n.Line3(ce.initOrigin,(new n.Vector3).copy(ce.initOrigin).add(r)).closestPointToPoint(ce.origin3D,!1));ce.origin=s;var c=(new n.Vector3).copy(ce.origin).sub(a).dot(r);if(ce.direction=r,ce.value=s.distanceTo(a)*(c>0?-1:1),ce.initValue=ce.value,Q){var u=r.clone().negate().normalize().multiplyScalar(ce.value);Q.origin=$.clone().add(u),Q.origin3DPos=ce.origin3D,ne=ce.value,Q.initOrigin=ce.initOrigin,Q.setValue(ce.value),Q.direction=ce.direction,Q.initValue=ce.initValue,Q.displayOrigin=Boolean(ce.origin3D),Q.unit=ve(),Q.display(),Q.beginManipulation()}this.updateRobotPos(),_&&!X&&_.setVisibility(!0)},this.snapTranslationCallback=function(e){var t=e.translationVector;if(Q){var i=Q.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.snapRotationCallback=function(e){var t={value:180*e.angle/Math.PI,axis:e.axis};if(ue&&ue.direction&&ue.direction.dot(e.axis)<0&&(t.value=360-t.value),K){var i=K.getSnappedRotationValue(e);0===i.returnCode&&(t={value:i.snappedRotationAngle,axis:i.axis})}return t},this.updateOnTranslation=function(e){if(H=!0,Q){var t=ce.value;ce.value=ce.initValue+e.translationVector.length()*(ce.direction.dot(e.translationVector)>0?1:-1),Q.setValue(ce.value);var i=pe(),o=new n.Vector3,r=new n.Vector3,a=new n.Vector3;t&&t>ce.value&&(i.extractBasis(o,r,a),a.negate(),i.makeBasis(o,r,a));var l=(new n.Vector3).copy(e.manipulator.axis).normalize(),s=ne-ce.value;ge&&(i.extractBasis(o,r,a),a.negate(),i.makeBasis(o,r,a),s=ce.value-ne);var c=l.multiplyScalar(s),u=$.clone().add(c);ie.setMatrix(i.setPosition(u.clone()))}else!Q&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator});this.updateRobotPos()},this.updateOnTranslationEnd=function(){ge=!1,H=!1,_&&!X&&_.setVisibility(!0),ie&&ie.setVisibility(!U.getVisibleSpace()),Q&&(Q.endManipulation(),Q.display()),ie&&(U.removeNode(ie),ie.removeChildren(),ie.remove(),ie=void 0),$=void 0},this.updateOnRotationBegin=function(e,t){this.clearLinearRuler(),K||be(),he(e,t),this.updateRobotPos(),_&&!X&&_.setVisibility(!0),K&&(K.display(),K.beginManipulation())},this.updateOnRotation=function(e,t){K||this.updateOnRotationBegin({axis:e.axis},t),function(e){if(K&&e){var t=(new n.Vector3).copy(e.axis),o=K.direction.dot(t),r=i.isLessThan(o,0)?2*Math.PI-e.angle:e.angle;K.setValue(K.initValue+180*r/Math.PI),K.refresh()}}(e),this.updateRobotPos(!1,!0)},this.updateOnRotationEnd=function(){_&&!X&&_.setVisibility(!0),K&&(K.display(),K.endManipulation())},this.clearRulers=function(){this.clearLinearRuler(),this.clearAngularRuler()},this.clearLinearRuler=function(){Q&&Q.clear()},this.clearAngularRuler=function(){K&&K.clear()},this}})}),define("DS/DMUPlaySection/DMUSectionImport",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e){this.importData=function(t,i,n){t&&i&&e&&("Clipping"===t.type&&t.PropertiesSection&&!t.PropertiesSection.Hatching&&(t.PropertiesSection.Hatching={},t.PropertiesSection.Hatching.Display=!1),i.fillObjectAttributes(e,t,n),i.registerForPostImport(e))},this.afterImport=function(){e&&e.fireEvent("onDMUObjectInitialized",{dmuObject:e})}}})}),define("DS/DMUPlaySection/DMUStoreyNavigratorController",["UWA/Class","DS/PADUtils/PADSettingsMgt","DS/CAT3DWebStoreyComponents/CAT3DWebStoreyNavigatorControler"],function(e,t,i){"use strict";var n,o=[],r=[];function a(e,t,i){e&&t&&r.push({buildingRootID:t,storeyInfo:"NoData",context:e}),i&&i()}function l(e,t){if(!t||!e||!e.context)var i;e&&e.getBuidlingRootID&&(i=e.getBuidlingRootID(),t.SetRootForStoreys([i]));var n=e.context,o=e.storyeRetrivalFailCB;t.GetStoreys().then(function(l){if(l&&l.length){let o,a;i&&function(e){let t=!1;if(e.context&&e.buildingRootID){for(var i=0;i<r.length;i++)r[i].context===e.context&&(r[i].buildingRootID===e.buildingRootID?(t=!0,r[i].storeyInfo=e.storeyInfo,r[i].isActive=e.isActive):r[i].isActive=!1);t||r.push(e)}}({buildingRootID:i,storeyInfo:l,context:e.context,isActive:!0}),n&&(o=n.getFrameWindow(),n.getViewer&&(a=n.getViewer())),t.CreateStoreyNavigator({frameWindow:o,viewer:a}),e.storyeRetrivalSuccessCB&&e.storyeRetrivalSuccessCB(t)}else a(n,i,o)},function(){a(n,i,o)})}return e.singleton({init:function(){i||window.require(["DS/CAT3DWebStoreyComponents/CAT3DWebStoreyNavigatorControler"],function(e){i=e})},getDMUStoreyNavigratorController:function(e){var n=this.giveDMUStoreyNavigratorController(e);if(!n&&e&&e.context&&i){let r,a,s=e.context;s&&(r=s.getFrameWindow(),s.getViewer&&(a=s.getViewer())),n=new i({securityContext:t.getSetting("pad_security_ctx"),frameWindow:r,viewer:a}),o.push({context:e.context,storeyNavigratorController:n}),l(e,n)}return n?Object.freeze(n):n},initNavigatoreUI:function(e){if(e&&e.context){var t=e.storeyNavigatorControler?e.storeyNavigatorControle:this.giveDMUStoreyNavigratorController(e);t?l(e,t):t=this.getDMUStoreyNavigratorController(e)}},giveDMUStoreyNavigratorController:function(e){var t;if(e&&e.context)for(var i=0;i<o.length;i++)if(o[i].context===e.context){t=o[i].storeyNavigratorController;break}return t?Object.freeze(t):t},getStoreyInfo:function(e,t){if(e&&t){for(var i,n=0;n<r.length;n++)r[n].context===t&&r[n].buildingRootID===e&&r[n].isActive&&(i=r[n].storeyInfo);return i}},isNoDataOnStoreyOfRoot:function(e,t){let i=!1;if(!e||!t)return i;for(var n=0;n<r.length;n++)r[n].context===t&&r[n].buildingRootID===e&&(i="NoData"===r[n].storeyInfo);return i},clearStoreyNavigratorController:function(e){if(e&&e.context){for(var t=0;t<o.length;t++)if(o[t].context===e.context){o[t].storeyNavigratorController&&o[t].storeyNavigratorController.DestroyStoreyNavigator(),o.splice(t,1),n&&(n=void 0);break}!function(e){if(e)for(var t=0;t<r.length;t++)r[t].context===e&&r.splice(t,1)}(e.context)}},setActivateClippingActionFlag:function(e){n=e},getActivateClippingActionFlag:function(){return n}})}),define("DS/DMUPlaySection/DMUClippingManipulationTool",["UWA/Core","UWA/Class","DS/Controls/Slider","DS/Controls/SpinBox","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/CATWebUXPreferences/CATWebUXPreferencesManager","css!DS/DMUPlaySection/DMUPlaySection.css"],function(e,t,i,n,o,r,a,l){"use strict";return t.extend({init:function(t){var s=t||{};this._parent(s);var c=this,u=s.iReviewContext,p=0;if(s.frameWindow&&!(isNaN(s.initValue)||isNaN(s.initMinValue)||isNaN(s.initMaxValue)||isNaN(s.initManipRange))){(s.initValue<s.initMinValue||s.initValue>s.initMaxValue)&&(s.initValue=.5*(s.initMinValue+s.initMaxValue));var g,d,v=s.viewType?s.viewType:"ExploreView";s.initStepValue=void 0!==s.initStepValue&&s.initStepValue>0?parseFloat(s.initStepValue):p/10;var f="Millimeter",m=a.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value;if("number"==typeof s.initManipRange){var S,h,C,b;p=r.convert(s.initManipRange,"Length",f,m);var y={},M=v,P="ExploreView"===M,w=!0;c.bPerformRefreshOrCreate=!0;var D=new e.Element("div",{class:"DMUSectionTranslationSliderSpinnerContainer",styles:{opacity:0}}).inject(s.frameWindow.getUIFrame());s.hasCompareObject&&D.setStyles({top:"70px"});var x=1,V=r.convert(s.initMinValue,"Length",f,m),A=r.convert(s.initMaxValue,"Length",f,m);if("number"==typeof s.initStepValue){var N=Math.abs(A-V);x=s.initStepValue<N?s.initStepValue:N}var _=o.getWebappsBaseUrl()+"DMUBaseCommands/assets/icons/32/";new e.createElement("img",{class:"WebSectionImg",src:_+"I_WebClippingTool.png",styles:{left:"0px"}}).inject(D),C=e.createElement("div",{class:"TranslationSliderContainer",styles:{display:!0===P?"":"none"}}).inject(D),(S=new i({minValue:V,maxValue:A,stepValue:x,value:r.convert(s.initValue,"Length",f,m)}).inject(C)).getTextFromValue=function(){var e="true"===a.readPreferences({name:"cke",PreferenceNames:["TrailingZeros"]}).preferences[0].value;return a.convertUnitValueToString("Length",r.convert(this.value,"Length",m,"Millimeter"),u,!0,!1,e)},S.addEventListener("beginEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.beginManipulation&&s.iOwner.beginManipulation(),c.bPerformRefreshOrCreate=!0}),S.addEventListener("change",function(){c.bPerformRefreshOrCreate=!1,s.onChangeSliderCB&&s.onChangeSliderCB(S.value),s.iOwner&&s.iOwner.doManipulation&&s.iOwner.doManipulation(),c.bPerformRefreshOrCreate=!0}),S.addEventListener("endEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.endManipulation&&s.iOwner.endManipulation(),c.bPerformRefreshOrCreate=!0});var R=a.readPreferences({name:"cke",PreferenceNames:["LengthDisplay"]}),T=parseFloat(R.preferences[0].value);b=e.createElement("div",{class:"TranslationSpinnerContainer",styles:{display:!1===P?"":"none"}}).inject(D),(h=new n({minValue:V,maxValue:A,stepValue:x,value:r.convert(s.initValue,"Length",f,m),units:r.Length[m].symbol,decimals:T}).inject(b)).elements.container.addClassName("TranslationSpinner"),h.addEventListener("beginEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.beginManipulation&&s.iOwner.beginManipulation(),c.bPerformRefreshOrCreate=!0}),h.addEventListener("change",function(){c.bPerformRefreshOrCreate=!1,s.onChangeSpinnerCB&&s.onChangeSpinnerCB(h.value),s.iOwner&&s.iOwner.doManipulation&&s.iOwner.doManipulation(),c.bPerformRefreshOrCreate=!0}),h.addEventListener("endEdit",function(){c.bPerformRefreshOrCreate=!1,s.iOwner&&s.iOwner.endManipulation&&s.iOwner.endManipulation(),c.bPerformRefreshOrCreate=!0}),y.onFreeZoneResize||(s.frameWindow.getImmersiveFrame().addEventListener("freeZoneResize",O),y.onFreeZoneResize=1),setTimeout(function(){D&&(O(),D.setStyles({opacity:1}))},50),this.setActiveView=function(e){"ExploreView"===e?(void 0!==C&&C.setStyle("display",""),void 0!==b&&b.setStyle("display","none"),M="ExploreView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider()):"DetailedView"===e&&(void 0!==C&&C.setStyle("display","none"),void 0!==b&&b.setStyle("display",""),M="DetailedView",t.iOwner&&t.iOwner.refreshSlider&&t.iOwner.refreshSlider())},this.getActiveView=function(){return M},this.setValue=function(e,t){isNaN(e)||(e=r.convert(e,"Length",f,m),"Slider"===t&&S?(S._properties&&S._properties.value&&(S._properties.value.value=e),S._updateCursor&&S._updateCursor()):"Spinner"===t&&h&&(h.value=e))},this.getValue=function(e){return"Slider"===e&&S?S.value:"Spinner"===e&&h?h.value:void 0},this.setRangeValues=function(e,t,i){isNaN(e)||isNaN(t)||(e=r.convert(e,"Length",f,m),t=r.convert(t,"Length",f,m),"Slider"===i&&S?(S.minValue=e,S.maxValue=t):"Spinner"===i&&h&&(h.minValue=e,h.maxValue=t))},this.getRangeValues=function(e){return"Slider"===e&&S?{minValue:S.minValue,maxValue:S.maxValue}:"Spinner"===e&&h?{minValue:h.minValue,maxValue:h.maxValue}:void 0},this.getSpinnerUnit=function(){if(h)return h.units},this.getSpinnerDecimalValue=function(){if(h)return h.decimals},this.getVisibleFlag=function(e){return"Slider"===e&&C?"none"!==C.getStyle("display"):"Spinner"===e&&b?"none"!==b.getStyle("display"):w},this.setVisibleFlag=function(e){w=e,D.setStyle("display",w?"":"none")},this.update=function(e){if(null!=e){var t="Slider";"DetailedView"===M&&(t="Spinner"),void 0!==e.minValue&&void 0!==e.maxValue&&c.setRangeValues(e.minValue,e.maxValue,t),void 0!==e.value&&c.setValue(e.value,t)}},this.subscribeToPrefChangeEvt=function(e){null!=e&&(g||(g=l.givePreferenceManager({context:s.frameWindow}))&&e.event&&e.cb&&(d=g.subscribe(e.event,e.cb)))},this.unsubscribeToPrefChangeEvt=function(){g&&(d=g.unsubscribe(d)),g=d=null},this.clean=function(){t.frameWindow&&D&&D.parentNode===t.frameWindow.getUIFrame()&&t.frameWindow.getUIFrame().removeChild(D),y.onFreeZoneResize&&s.frameWindow&&s.frameWindow.getImmersiveFrame().removeEventListener("freeZoneResize",O),D=null,y={},t.iOwner&&t.iOwner._movegauge&&(t.iOwner._movegauge=null),c.unsubscribeToPrefChangeEvt()},v!==M&&this.setActiveView(v)}}function O(){if(D){var e=s.frameWindow.getImmersiveFrame().getFreeZone().getSize();if(e.width){var t=0,i=s.frameWindow.getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea),n=i.getContainedWindows();if(n&&(1===n.length&&n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||1===n.length&&!n[0].isAWindowGroup())){for(var o=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,r=!1,a=0;a<o.length;a++)o[a].visibleFlag&&(r=!0);if(r&&!i.collapseDockingZoneFlag){var l=i._collapserSize;t=i.dockingZoneSize+l}}else i.interactiveDockAreaVisibleFlag&&(t=i.dockingZoneSize);let c=125;s.hasCompareObject&&(c=137.5),t+=e.width/2-c,D.setStyles({left:t+"px"})}}}}})}),define("DS/DMUPlaySection/DMUSectionPosPreVisuNode3D",["DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsAvatars","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUToolsMaterial","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/SceneGraphFactory"],function(e,t,i,n,o,r,a,l,s){"use strict";return n.extend({init:function(c){this._parent();var u,p,g=c;function d(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)}function v(e,t,n){var o=function(e,t){var n=(new i.Projector).projectVector(t.clone(),e.viewpoints[0].getCamera()),o=Math.round((0-n.y)*(e.canvas.offsetHeight/2)+e.canvas.offsetHeight/2),r=Math.round(n.x*(e.canvas.offsetWidth/2)+e.canvas.offsetWidth/2);return{top:o,left:r,bottom:e.canvas.offsetHeight-o,right:e.canvas.offsetWidth-r,inWindow:o>0&&o<e.canvas.offsetHeight&&r>0&&r<e.canvas.offsetWidth}}(e,t),a=function(e,t,n){var o=new i.Vector3((t-window.pageXOffset)/e.canvas.offsetWidth*2-1,-(n-window.pageYOffset)/e.canvas.offsetHeight*2+1,.5),r=(new i.Projector).pickingRay(o,e.currentViewpoint.camera);return{position:r.ray.origin,direction:r.ray.direction}}(e,o.left+n,o.top);return r.computePointLineDistance(t.toArray(),a.position.toArray(),a.direction.toArray()).distance}var f={};f.preSolidLine=a.retrieveMaterialFromGAS({color:new i.Color(16753920),lineWidth:window.devicePixelRatio,pattern:o.LinePatternEnum.SOLID}),f.dotDashedLineBlack=a.retrieveMaterialFromGAS({color:new i.Color(0),lineWidth:window.devicePixelRatio+1,pattern:o.LinePatternEnum.DOTDASHED}),f.crossPointPreHighlight=a.retrieveMaterialFromGAS({symbol:1,size:10,color:new i.Color(65535)}),f.preFaceMaterial=a.retrieveMaterialFromGAS({color:new i.Color(16753920),opacity:1}),f.preFaceMaterial.force=!0,f.preSolidLine.force=!0,f.preFaceMaterial.line=f.preSolidLine,this.getAxisNode=function(i){var n,o,r,a=i.getType()===e.GeometryType.CIRCLE,l=a?{beginPoint:i.getCenter().clone(),endPoint:i.getCenter().clone()}:i.getPoints();n=i.getAxis().clone();var s=a?60:30,c=v(g,l.beginPoint,s);return n.normalize().multiplyScalar(c),o=l.beginPoint.clone().sub(n),r=l.endPoint.clone().add(n),t.createLineNode(o,r,f.dotDashedLineBlack)},this.getPointNode=function(e){if(e)return f.crossPointPreHighlight.force=!0,s.createPointsNode({positions:e.clone().toArray(),material:f.crossPointPreHighlight})};var m=new n;d(this,m),this.buildPreVisuNode=function(e){if(e&&e.data&&e.data.point&&e.data.normal){m.removeChildren();var i=e.data.point,n=e.data.normal,o=g.currentViewpoint,r=v(g,i,40);u=t.createRectangleNode(r,r,i,n,f.preFaceMaterial,!1),p||(p=t.createArrowNormalNode(o)),p&&p.setMatrix(l.getMatFromNormWithPos(n,i)),d(m,u),d(m,p),e.data.measurable&&e.data.toShowAxisVisu()&&d(m,this.getAxisNode(e.data.measurable,!0))}},this.remove=function(){m&&(m.removeChildren(),m.remove(),m=void 0),u&&(u.removeChildren(),u.remove(),u=void 0),p&&(p.removeChildren(),p.remove(),p=void 0)}}})}),define("DS/DMUPlaySection/DMUToolsSection",["DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUToolsSceneGraph","DS/WebPolyPlanarSectionOper/WebPolyPlanarSectionOper","DS/DMUPlaySection/DMUStoreyNavigratorController"],function(e,t,i,n,o,r,a,l,s,c,u,p){"use strict";var g={computeSectionCurvesUsingPolyPlanarOperator:function(e,t,i){var n=new u(e);return n?n.Run(t,i):{}},computeSectionPlaneReferencial:function(o,a,l,s){var c=new i.Vector3((a.max.x+a.min.x)/2,(a.max.y+a.min.y)/2,(a.max.z+a.min.z)/2),u=n.getViewpointInfo(o.currentViewpoint),p=e.dot(u.sight.toArray(),[1,0,0]),g=e.dot(u.sight.toArray(),[0,1,0]),d=e.dot(u.sight.toArray(),[0,0,1]),v=Math.abs(p),f=Math.abs(g),m=Math.abs(d),S=new i.Matrix4;if(s&&"Automatic"!==s?S=function(e,t){let n=e;var o;switch(t.toLowerCase()){case"x":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateY(-Math.PI/2).setPosition(o);break;case"y":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateX(Math.PI/2).setPosition(o);break;case"z":o=(new i.Vector3).getPositionFromMatrix(n),n=(new i.Matrix4).rotateY(Math.PI).setPosition(o)}return n}(S,s):r.isLessOrEqual(v,f)||r.isLessOrEqual(v,m)?r.isLessOrEqual(f,m)?r.isLessThan(d,0)&&S.rotateY(Math.PI):r.isLessThan(g,0)?S.rotateX(Math.PI/2):S.rotateX(-Math.PI/2):r.isLessOrEqual(p,0)?S.rotateY(-Math.PI/2):S.rotateY(Math.PI/2),S.setPosition(c),l){var h=t.computePlaneDim(a,S,!1,!0);if(!isNaN(h.fSliceOffset)&&h.fSliceOffset>0){var C=this.computePlaneCenter(S,2*h.fSliceOffset,!0);C&&S.setPosition(C)}}return S},checkLineIntersection:function(e,t){var i=e[0][0],n=e[0][1],o=e[1][0],r=e[1][1],a=t[0][0],l=t[0][1],s=t[1][0],c=t[1][1],u={x:null,y:null,bIsOnLine1:!1,bIsOnLine2:!1},p=(c-l)*(o-i)-(s-a)*(r-n);if(0===p)return u;var g=n-l,d=i-a,v=(o-i)*g-(r-n)*d;return g=((s-a)*g-(c-l)*d)/p,d=v/p,u.x=i+g*(o-i),u.y=n+g*(r-n),g>0&&g<1&&(u.bIsOnLine1=!0),d>0&&d<1&&(u.bIsOnLine2=!0),u},trimPolylines:function(e,t){var n,o=[];t&&(n=[[[t.min.x,t.min.y],[t.max.x,t.min.y]],[[t.max.x,t.min.y],[t.max.x,t.max.y]],[[t.max.x,t.max.y],[t.min.x,t.max.y]],[[t.min.x,t.max.y],[t.min.x,t.min.y]]]);var r,a,l,s,c=!1,u=0,p=0,d=0;for(u=0;u<e.length;u++){a=e[u]._Vertices.length,c=!1;var v=[];for(p=0;p<a;p++)if(l=new i.Vector2(e[u]._Vertices[p][0],e[u]._Vertices[p][1]),!t||t&&t.containsPoint(l))v.push([e[u]._Vertices[p][0],e[u]._Vertices[p][1],e[u]._Vertices[p][2]]),c=!0;else{r=p,c&&(r=--p,c=!1);var f=!1;if(r<a-1)for(d=0;d<n.length;d++)(s=g.checkLineIntersection(n[d],[[e[u]._Vertices[r][0],e[u]._Vertices[r][1]],[e[u]._Vertices[r+1][0],e[u]._Vertices[r+1][1]]])).bIsOnLine1&&s.bIsOnLine2&&(v.push([s.x,s.y,e[u]._Vertices[r][2]]),f=!0);!f&&v.length>0&&(o.push(v),v=[])}v.length>0&&o.push(v)}return o},getEditCmd:function(e){var t=o.getContextViewer({viewer:e});return s.getEditCmd(t)},getClippingCmd:function(e){var t=o.getContextViewer({viewer:e});return s.getClippingCmd(t)},computePlaneCenter:function(e,t,n){var o=t,r=(new i.Vector3).getPositionFromMatrix(e);if(!isNaN(o)&&n){var a=e.decompose(),l=new i.Vector3(0,0,1).applyQuaternion(a[1]).normalize();l.negate(),l=l.multiplyScalar(o/2),r=r.add(l)}return r},computeClippingSlice:function(e,t){if(e&&e.radius&&e.center){var n=e.radius;if(t){var o=t.decompose(),r=(new i.Vector3).getPositionFromMatrix(t),s=new i.Vector3(0,0,1).applyQuaternion(o[1]).normalize(),c=e.center;s=s.multiplyScalar(n),c=c.add(s);var u=s.clone().normalize(),p=a.computeTwoPlanesDistance(r.toArray(),u.toArray(),c.toArray(),u.toArray());p&&0===p.returnCode&&p.relationship===l.Relationship.PARRALLEL&&(n=p.distance)}return n}},cleanClippingVisu:function(e){let t=o.giveEventsController({viewer:e});t&&t.fireEvent("onEditCommandEnd");let i=o.getReviewContext({viewer:e});if(i){let e=s.retriveClippingObjsFromSlide(i);e&&e.forEach(function(e){if(e){var t=e.getNode();t&&(t.setPickingInManipulationModeForLineTraslation(!0),t.cleanClippingRobot())}})}},initClippingVisu:function(e,t){if(!e||!t)return;let i=o.giveEventsController({viewer:e});i&&i.fireEvent("initClippingVisu",t)},getRootsForClipping:function(e){let t=o.getReviewContext({viewer:e});if(t&&t.getReviewCtxInformation){let e=t.getReviewCtxInformation();if(e&&e.contextId)return[c.getNodeFromID(e.contextId)]}return c.getRootReferences(e)},isClippingEligibleForStoreyMode:function(e,t){for(var i=g.getRootsForClipping(e),n=0;n<i.length;n++)if(i[n]){let e=c.getNodeType(i[n]);if("Building"===e||"AecSite"===e){let e=c.getNodeID(i[n]);if(!p.isNoDataOnStoreyOfRoot(e,t))return i[n]}}},getBuildingRootData:function(e,t,i){if(!e)return;let n,o;i&&(o=[]);let r=!1;if(t){let e=c.getNodeType(t);if("Building"===e||"AecSite"===e){r=!0;let e={rootNode:t,ID:c.getNodeID(t)};i?o.push(e):o=e}}if(!r){n=g.getRootsForClipping(e);for(var a=0;a<n.length;a++)if(n[a]){var l=n[a];let e=c.getNodeType(l);if("Building"===e||"AecSite"===e){let e={rootNode:l,ID:c.getNodeID(l)};if(!i){o=e;break}o.push(e)}}}return o},getStoreyinfoOnSlide:function(e){if(!e)return;let t;var i=o.getReviewContext({viewer:e});if(i&&i.getCurrentSessionMarkup){var n=i.getCurrentSessionMarkup();if(n){var r=n.getCurrentSlide();if(r){var a=r.getEnvironmentOverload();t="string"==typeof a.state.sContructionItemId?a.state.sContructionItemId:void 0}}}return t},setStoreyinfoOnSlide:function(e,t){if(!t||!e||"string"!=typeof t)return;let i=t;var n=o.getReviewContext({viewer:e});if(n&&n.getCurrentSessionMarkup){var r=n.getCurrentSessionMarkup();let e;if(r){if(r){let t=n.getRestrictions(r);t.markup&&void 0!==t.markup.canEdit&&(e=t.markup.canEdit)}if(r&&r.getActiveFlag()&&r.isVisible()&&!r.isReadOnly()&&r.getCurrentSlide&&r.getCurrentSlide()&&e){var a=r.getCurrentSlide();if(!r.isReadOnly()){var l=a.getEnvironmentOverload();l&&l.state&&(l.state.sContructionItemId=i,a.updateEnvironmentOverload(l),a.fireEvent("onDMUSlideSessionInfoChanged",{dmuObject:a,info:"storeyId"}))}}}}return i}};return g}),define("DS/DMUPlaySection/DMUClippingNode3D",["UWA/Core","DS/DMUBaseUI/DMUNode3D","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUManipulableClippingPlane","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ClippingContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/PADUtils/PADSettingsMgt","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUClippingRobot","DS/Ruler/Ruler","DS/SceneGraphNodes/FixedSizeNode3D","DS/Robot/LineTranslationNode","DS/Mesh/Mesh","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"].concat(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"]),function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,v,f,m,S,h,C,b,y){"use strict";var M=e.Class.extend({init:function(e){var t=e.frameWindow,i=e.getAppType,n=e.nodeInfo,r=e.viewer,a=e.type,u=e.originPlaneType,p=!1;this.isManipulationOnGO=function(){return p};var g,d,v,f,b,y,M=[];function P(){g=new m(t,{displayOrigin:!1,offset:20,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:"3dPlay"===i()});(d=[]).push(g.subscribe("RulerManipulateBegin",function(e){!function(e){if(p=!0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:e.event})){var t=n.getPlaneGeometryCB(a);f=(new s.Vector3).getPositionFromMatrix(t.referential),n.manipulationInformationCB({action:o.ManipulationAction.BEGIN,type:o.ManipulationType.TRANSLATION,evt:e.event})}}(e)})),d.push(g.subscribe("RulerManipulate",function(e){!function(e){if(p=!0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:e.event})){if(f){var t=n.getPlaneGeometryCB(a);f=(new s.Vector3).getPositionFromMatrix(t.referential)}var i=f.clone().add(e.translationVector);n.setPlaneGeometryCB({newCenter:i,from:a,UpdateRobotpos:!0}),n.manipulationInformationCB({action:o.ManipulationAction.DO,type:o.ManipulationType.TRANSLATION,evt:e.event})}}(e)})),d.push(g.subscribe("RulerManipulateEnd",function(e){var t;t=e,p=!1,f=void 0,n.manipulationInformationCB({action:o.ManipulationAction.ENABLE,type:o.ManipulationType.TRANSLATION,evt:t.event}),n.manipulationInformationCB({action:o.ManipulationAction.END,type:o.ManipulationType.TRANSLATION,evt:t.event})}))}function w(){return n.getPlaneGeometryCB(a).referential}P(),this.updateOnTranslationBegin=function(e){if(p=!0,f=e.intersection.position,"ConstructionItem"===u?(y||(y=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB().referential)),M.origin3D=y):M.origin3D=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB(u).referential),g||P(),!b){b=new c;var t={position:new s.Vector3(0,0,0),touchMode:!1},i=new S({name:"fixedSizeNode3D",ratio:7}),o=new h(t);o.name="arrowTranslationNode",o.mat.color=new s.Color("#1B6E9C"),o.mat.opacity=1,o.setNoZ(!0),i.addChild(o),r&&b&&(b.addChild(i),r.addNode(b),r.render())}b&&(b.setMatrix(w().setPosition(f.clone())),b.setVisibilityInTree(!1),b.setVisibility(r.getVisibleSpace()),b.setPickable(C.PICKTHROUGH));var d=(new s.Vector3).copy(e.manipulator.axis).negate(),m=(new s.Vector3).getPositionFromMatrix(n.getPlaneGeometryCB(a).referential);M.initOrigin=m.clone();var D=(new s.Vector3).copy(M.initOrigin);M.origin3D&&(D=new s.Line3(M.initOrigin,(new s.Vector3).copy(M.initOrigin).add(d)).closestPointToPoint(M.origin3D,!1));M.origin=D;var x=(new s.Vector3).copy(M.origin).sub(m).dot(d);if(M.direction=d,M.value=D.distanceTo(m)*(x>0?-1:1),M.initValue=M.value,g){var V=d.clone().negate().normalize().multiplyScalar(M.value);g.origin=f.clone().add(V),g.origin3DPos=M.origin3D,v=M.value,g.initOrigin=M.initOrigin,g.setValue(M.value),g.direction=M.direction,g.initValue=M.initValue,g.unit=l.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value,g.display(),g.beginManipulation()}},this.setOrigin=function(e){y=e},this.snapTranslationCallback=function(e){var t=e.translationVector;if(g){var i=g.getSnappedTranslationVector(e);0===i.returnCode&&(t=i.snappedTranslationVector)}return t},this.updateOnTranslation=function(e){if(p=!0,g){var t=M.value;M.value=M.initValue+e.translationVector.length()*(M.direction.dot(e.translationVector)>0?1:-1),g.setValue(M.value);var i=w();if(t&&t<M.value){var n=new s.Vector3,o=new s.Vector3,r=new s.Vector3;i.extractBasis(n,o,r),r.negate(),i.makeBasis(n,o,r)}var a=(new s.Vector3).copy(e.manipulator.axis).normalize().multiplyScalar(v-M.value),l=f.clone().add(a);b.setMatrix(i.setPosition(l.clone()))}else!g&&e.intersection&&e.manipulator&&this.updateOnTranslationBegin({intersection:e.intersection,manipulator:e.manipulator})},this.updateOnTranslationEnd=function(){p=!1,b&&b.setVisibility(!r.getVisibleSpace()),g&&(g.endManipulation(),g.display()),b&&(r.removeNode(b),b.removeChildren(),b.remove(),b=void 0),f=void 0},this.clear=function(){p||(g&&g.clear(),g=null)}}});return t.extend({init:function(e){var t;this._parent({frmWindow:e._frmWindow,getType:e.getType});var l,m=this;m.clippingNode=!0;var S,h,P,w,D,x,V,A,N,_,R,T,O,E,I,U,B,L=!1,k=!1,F=!1,z=null,W=!1,G=new s.Plane,j=new s.Plane,H=new s.Plane,X=new s.Plane,Y=new s.Plane,J=new s.Plane,Z=new s.Plane,q=[],Q=[],K=[],$=new s.Box3,ee=1,te=function(e){if(e&&(e.setFrustumCulled&&e.setFrustumCulled(!1),e.children))for(var t=0;t<e.children.length;t++)te(e.children[t])},ie=function(){var e=!1;return d&&d.getSetting("enopad3dviewer_lightNodeModel")&&(e=!0),e};function ne(t){var i=e.getAttribute("fXDirSize");"Right"!==t&&"Left"!==t||(i=e.getAttribute("fSliceOffset"));var n=e.getAttribute("fYDirSize");return"Top"!==t&&"Bottom"!==t||(n=e.getAttribute("fSliceOffset")),{referential:e._getPlanReferential(t),uSize:i,vSize:n,uStep:e.getAttribute("fXDirGridStep"),vStep:e.getAttribute("fYDirGridStep"),sliceOffset:e.getAttribute("fSliceOffset"),planeType:e.getAttribute("sPlaneBoxMode")}}function oe(){m._robot||(l||(l=v.getEditCmd(e._viewer)),l&&((l.isRunning()||l.isPaused())&&v.cleanClippingVisu(e._viewer),v.initClippingVisu(e._viewer,e)))}function re(){return m._robot}function ae(t){if(t&&(t.uSize||t.vSize||t.uStep||t.vStep||t.referential)){if(t.uSize&&e.setAttribute("fXDirSize",t.uSize),t.vSize&&e.setAttribute("fYDirSize",t.vSize),t.uStep&&e.setAttribute("fXDirGridStep",t.uStep),t.vStep&&e.setAttribute("fYDirGridStep",t.vStep),t.referential){var i=t.referential.clone();if(t.toRelocate&&!e.isSinglePlaneMode()){var n=e.getPlaneCenter(i);i.setPosition(n)}e.setAttribute("mPlaneReferential",i),e.modifyPlaneReferential(i)}}else{var o,r,a,l=t.newCenter,c=!0;switch(t.from){case"Top":r="Bottom",a="fYDirSize";break;case"Bottom":r="Top",a="fYDirSize";break;case"Right":r="Left",a="fXDirSize";break;case"Left":r="Right",a="fXDirSize";break;case"Back":r=void 0,a="fSliceOffset",c=!1;break;default:(o=ne().referential).setPosition(l),c=!1,e.isSinglePlaneMode()||(r="Back",a="fSliceOffset")}if(a){var u=(new s.Vector3).getPositionFromMatrix(ne(r).referential);if(l&&u){var p=u.distanceTo(l),g=e.getAttribute(a);if(e.setAttribute(a,p),c&&p){var d=u.clone().sub(l.clone()).normalize();d.multiplyScalar(.5*(g-p));var v=ne(),f=(new s.Vector3).getPositionFromMatrix(v.referential);o=v.referential,f=f.clone().add(d).clone(),o.setPosition(f)}}}o&&e.setAttribute("mPlaneReferential",o)}t.UpdateRobotpos&&m._robot&&m._robot.updateRobotPos()}function le(){var t=o.State.STANDARD;return e.isInEdition()&&(t=o.State.INEDITION),t}function se(){return e.isSectionDisplayed()}function ce(){var t={mode:o.DisplayMode.PLANE,fillColor:e.getAttribute("cFillStyleColor"),opacity:e.getAttribute("fOpacity")};return"Grid"===e.getAttribute("sDisplayPlaneMode")&&(t.mode=o.DisplayMode.GRID),t}function ue(t){var n=!0;if(!t||t.type!==o.ManipulationType.TRANSLATION&&t.type!==o.ManipulationType.ROTATION&&t.type!==o.ManipulationType.RESIZE&&t.type!==o.ManipulationType.CENTER)return n;switch(t.action){case o.ManipulationAction.ENABLE:void 0===U&&(U=!e.isEditable()||function(){var t=a.isManipulationAllowed({viewer:e._viewer});if("boolean"==typeof t)return!t;var n=i.checkIfCommandIsRunning(e._viewer);return n&&"SelectiveSectionContextCmdHdr"===i.getCurrentCommand(e._viewer)&&(u.addInCSO(e,!1),n=!1),n}()||!e.isInEdition()),n=!U;break;case o.ManipulationAction.BEGIN:var r=Boolean(t.fromRobot);e.clearAllRuler(r),U||(t.type===o.ManipulationType.CENTER&&(m.enableClipping(!1),e._viewer.setSectionCapping(!1)),e.beginManipulation());break;case o.ManipulationAction.DO:U||e.doManipulation();break;case o.ManipulationAction.END:U?e.isClippingPlaneVisible()&&e.endManipulation(t.evt,!0):(t.type===o.ManipulationType.CENTER&&(m.enableClipping(!0),e._viewer.setSectionCapping(!0)),e.endManipulation(t.evt)),U=void 0;break;case o.ManipulationAction.LONG_HOLD:U||e.onLongHold()}return n}function pe(t){var i=e.isEditable();return new o({viewer:e._viewer,frameWindow:e._frmWindow,bTranslationManipulator:i,sType:t,getState:le,getShowState:se,getGeometry:ne,setGeometry:ae,getDisplayInformation:ce,getManipulationInformation:ue,appType:e._typeApps,context:e._context,initRobotCB:oe,getRobotCB:re,ruler:"NormalMode"!==e.getAttribute("sPlaneBoxMode")?new M({frameWindow:e._frmWindow,getAppType:m.getAppType,nodeInfo:m,viewer:e._viewer,type:t,originPlaneType:e.isConstructionItemMode()?"ConstructionItem":function(e){if(!e)return"Back";var t;switch(e){case"Back":break;case"Top":t="Bottom";break;case"Bottom":t="Top";break;case"Right":t="Left";break;case"Left":t="Right"}return t}(t)}):void 0,storeyMode:e.isConstructionItemMode()})}function ge(t){var i=e.getAttribute("sPlaneBoxMode");"Grid"!==e.getAttribute("sDisplayPlaneMode")&&("Back"!==t||"SliceMode"!==i&&"BoxMode"!==i||(D?D.update():((D=pe(t)).setName(b.sectionplane),(P=new c).setVisibilityInTree(!1),m.addChild(P),P.addChild(D))),"BoxMode"===i&&("Top"===t?R?R.update():((R=pe(t)).setName(b.sectionplane),(x=new c).setVisibilityInTree(!1),m.addChild(x),x.addChild(R)):"Bottom"===t?T?T.update():((T=pe(t)).setName(b.sectionplane),(V=new c).setVisibilityInTree(!1),m.addChild(V),V.addChild(T)):"Right"===t?O?O.update():((O=pe(t)).setName(b.sectionplane),(A=new c).setVisibilityInTree(!1),m.addChild(A),A.addChild(O)):"Left"===t&&(E?E.update():((E=pe(t)).setName(b.sectionplane),(N=new c).setVisibilityInTree(!1),m.addChild(N),N.addChild(E)))))}function de(){var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||(n=e.getAttribute("fSliceOffset"));var a=e.getAttribute("fXDirGridStep"),l=e.getAttribute("fYDirGridStep");a||(a=t/10),l||(l=i/10);var c=e.getAttribute("iGridAbsoluteMode");_=new g({window:e._frmWindow,viewer:e._viewer,context:r.getContextViewer({viewer:e._viewer}),nbMaxLabel:300,stepRequiredX:a,stepRequiredY:l,stepRequiredZ:0===n?0:a,gridMatrix:(new s.Matrix4).copy(e._getPlanReferential()),freeZoneDim:e._viewer.canvas.getBoundingClientRect(),id:"Section",owner:h,isEditable:!1,isLabelManipulable:!1,isAbsoluteMode:1===c})}function ve(){var i=e.isSectionDisplayed()&&(e.isInEdition()||e.isClippingPlaneVisible());i||m.clearAllRulers(),e._bIsInShowSpace||(i=!i);var n=i;if(e._bVisible&&(n=!i),"NoPlane"===e.getAttribute("sDisplayPlaneMode")&&i&&(i=!i),w)if(w.setVisibility(i),w.setVisibilityFree(n),!e.isEditable()&&m._robot)m._robot.update(Boolean(e._bIsInShowSpace));else if(m._robot){var o;!1===(e._bIsInShowSpace?i:!i)?(o=!i,m._robot.update(o)):(o=!e.isInEdition(),e._bIsInShowSpace||(o=!o)),m._robot.update(o)}D&&(D.setVisibility(i),D.setVisibilityFree(n)),R&&(R.setVisibility(i),R.setVisibilityFree(n)),T&&(T.setVisibility(i),T.setVisibilityFree(n)),O&&(O.setVisibility(i),O.setVisibilityFree(n)),E&&(E.setVisibility(i),E.setVisibilityFree(n)),function(){var i=e.getAttribute("sPlaneBoxMode"),n=(new s.Matrix4).translate(new s.Vector3(0,0,.1));w&&w.setMatrix(n),D&&D.setMatrix(n),R&&R.setMatrix(n),T&&T.setMatrix(n),O&&O.setMatrix(n),E&&E.setMatrix(n),h.setMatrix(e._getPlanReferential()),"SliceMode"!==i&&"BoxMode"!==i||!P||P.setMatrix(e._getPlanReferential("Back")),"BoxMode"===i&&(x&&x.setMatrix(e._getPlanReferential("Top")),V&&V.setMatrix(e._getPlanReferential("Bottom")),A&&A.setMatrix(e._getPlanReferential("Right")),N&&N.setMatrix(e._getPlanReferential("Left")));var o=e.getAttribute("sSectionRender"),a=e.isSectionDisplayed(),l=!1!==e.getAttribute("bClippingActiveState");L&&a&&S&&o!==S&&"NoCut"!==S&&(e._viewer.removeClippingPlane(G),j&&e._viewer.removeClippingPlane(j),m.enableClipping(!1),e._viewer.setSectionCapping(!1),L=!1),S=o,t||(t=r.getContextViewer({viewer:e._viewer})),a&&!L&&y&&t&&y.getSectionVisibilityFlag(t)&&y.setSectionVisibilityFlag(t,!1);if("CutOneSide"===o&&(!L&&l&&a&&(L=!0,e._viewer.setSectionCappingMaterial(G,null),e._viewer.addClippingPlane(G,z),"SliceMode"===i?e._viewer.addClippingPlane(H,z):"BoxMode"===i&&(e._viewer.addClippingPlane(H,z),e._viewer.addClippingPlane(X,z),e._viewer.addClippingPlane(Y,z),e._viewer.addClippingPlane(Z,z),e._viewer.addClippingPlane(J,z)),m.enableClipping(!0),e._viewer.setSectionCapping(!0)),L&&!a&&(L=!1,e._viewer.removeClippingPlane(G),"SliceMode"===i?e._viewer.removeClippingPlane(H):"BoxMode"===i&&(e._viewer.removeClippingPlane(X),e._viewer.removeClippingPlane(Y),e._viewer.removeClippingPlane(Z),e._viewer.removeClippingPlane(J)),m.enableClipping(!1),e._viewer.setSectionCapping(!1)),L&&a&&!e._viewer.getSectionCapping()&&e._viewer.setSectionCapping(l)),"OnlyContour"===o){if(!L&&a){L=!0;var c=(new s.Matrix4).copy(e._getPlanReferential());j.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),j.applyMatrix4(c.rotateX(Math.PI)),e._viewer.addClippingPlane(G,z),e._viewer.addClippingPlane(j,z),m.enableClipping(!0),e._viewer.setSectionCapping(!1)}L&&!a&&(L=!1,e._viewer.removeClippingPlane(G),e._viewer.removeClippingPlane(j),m.enableClipping(!1),e._viewer.setSectionCapping(!1))}}(),G.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),G.applyMatrix4(e._getPlanReferential()),"SliceMode"!==e.getAttribute("sPlaneBoxMode")&&"BoxMode"!==e.getAttribute("sPlaneBoxMode")||(H.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),H.applyMatrix4(e._getPlanReferential("Back"))),"BoxMode"===e.getAttribute("sPlaneBoxMode")&&(X&&(X.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),X.applyMatrix4(e._getPlanReferential("Top"))),Y&&(Y.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Y.applyMatrix4(e._getPlanReferential("Bottom"))),J&&(J.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),J.applyMatrix4(e._getPlanReferential("Right"))),Z&&(Z.setFromNormalAndCoplanarPoint(new s.Vector3(0,0,1),new s.Vector3(0,0,0)),Z.applyMatrix4(e._getPlanReferential("Left"))))}function fe(t,i){if(Array.isArray(t))for(var n=0;n<t.length;n++)fe(t[n],i);else if(t.enableClippingPlane(G,i),"OnlyContour"===e.getAttribute("sSectionRender"))t.enableClippingPlane(j,i);else{var o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||t.enableClippingPlane(H,i),"BoxMode"===o&&(t.enableClippingPlane(X,i),t.enableClippingPlane(Y,i),t.enableClippingPlane(J,i),t.enableClippingPlane(Z,i))}}function me(e){w&&w.setPickable(e),D&&D.setPickable(e),R&&R.setPickable(e),T&&T.setPickable(e),O&&O.setPickable(e),E&&E.setPickable(e)}m.enableClipping=function(t){var i;if(m){Q&&fe(Q,!1),ie()&&I&&(n.removeSceneGraphOverrideSet(e._viewer,I),I=null),function(){var t,i,o,r;q=[],K=[];var a=e.collectCutObjects();t=a.CutObjects,i=a.CutObjectsOOC,F=a.bIsPartial,ee=a.cutUncutMode;var l=0,s=0;if(F)if(ie())for(l=i.length,s=0;s<l;s++){var c=i[s];c&&K.push(c)}else for(l=t.length,s=0;s<l;s++)(o=t[s])&&(r=n.getLastInstance(o),q.push(r.getLastElement()));else{var u=e._viewer.getVisibleSpace();!1===e._bIsInShowSpace&&!1===u&&"Markup"!==e.getParent().getType()||(q=n.getRootReferences(e._viewer))}}();var o=r.getContextViewer({viewer:e._viewer});if(o){var a=o.getController();if(a){var l=a.get3DLayerController();if(l)l.getLayers().forEach(function(e){e.getNode3DBag()&&q.push(e.getNode3DBag())}),t?B||(B=l.subscribe({event:"layerCreated"},function(e){var i=[],n=l.getLayer(e.id);if(n){n.getNode3DBag()&&i.push(n.getNode3DBag()),fe(i,t)}})):(l.unsubscribe(B),B=null)}}Q=q,fe(q,t),t?function(t){if(t&&t.length>0){I=n.createSceneGraphOverrideSet(e._viewer);var i=[];if(i.push(G),"OnlyContour"===e.getAttribute("sSectionRender"))i.push(j);else{var o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||i.push(H),"BoxMode"===o&&(i.push(X),i.push(Y),i.push(J),i.push(Z))}if(ee){var r=n.getOverrides(I,{idPaths:K});if(r&&r.length){var a=new p;a.setPlanes(i),r.forEach(function(e){e.setClippingContext(a)})}}else{var l=n.getRootReferences(e._viewer);for(let e=0;e<l.length;e++){let t=n.buildPathElement(l[e]);if(t){let e=[];e.push(t);let o=n.getOverrides(I,{pathElements:e});if(o&&o.length){let e=new p;e.setPlanes(i);for(let t=0;t<o.length;t++)o[t].setClippingContext(e)}}}var s=n.getOverrides(I,{idPaths:K});if(s&&s.length){var c=new p;c.setExcludeFromClippingPlanes(i),c.setEnableClippingProfile("off"),s.forEach(function(e){e.setClippingContext(c)})}}}}(K):ie()&&e.removeCurvesAndHatching();var s=n.getSceneRoot(e._viewer).children;for(i=0;i<s.length;i++)s[i].toBeSectionned&&s[i].enableClippingPlane(G,t);W=t}},m.isClippingEnabled=function(){return W},m.clean=function(t){if(m.clearAllRulers(!0),t&&m._robot&&m.cleanClippingRobot(),m){var i=n.getRootReferences(e._viewer);ie()&&e.removeCurvesAndHatching(),fe(i,!1),fe(Q,!1),e._viewer.setSectionCappingMaterial(G,null),e._viewer.removeClippingPlane(G),G=new s.Plane,e._viewer.removeClippingPlane(j),j=new s.Plane,e._viewer.removeClippingPlane(H),H=new s.Plane,e._viewer.removeClippingPlane(X),X=new s.Plane,e._viewer.removeClippingPlane(Y),Y=new s.Plane,e._viewer.removeClippingPlane(Z),Z=new s.Plane,e._viewer.removeClippingPlane(J),J=new s.Plane,w&&w.clean(),_&&h&&(_.deleteGrids({owner:h,fromStorage:!0}),_.setActiveState(!1)),m.removeChildren(),h=P=w=D=null,x=V=A=N=_=null,R=T=O=E=null,q.length=0,Q.length=0,L=!1,k=!1,F=!1,U=void 0,z=null}},m.resetClippingFlag=function(){L=!1},m.update=function(t){if(m)if(e&&e.isConstructionItemMode()&&!e.isBuidlingRootAvailable(void 0,!0))e.resetToNormalMode();else{t&&m.clean();var i=void 0;if(e.isCustomColorSorce("Capping")&&(i=e.getAttribute("cCappingColor")),i!==z&&(z=i),h||h||((h=new c).setVisibilityInTree(!1),m.addChild(h),"Grid"!==e.getAttribute("sDisplayPlaneMode")?((w=new pe).setName(b.sectionplane),h.addChild(w),ge("Back"),ge("Top"),ge("Bottom"),ge("Right"),ge("Left")):de(),m.addChild(e.getSectionCurveNode()),te(m)),m.setName(e.getAttribute("sName")),w&&w.update(),_&&h&&(_.deleteGrids({owner:h,fromStorage:!0}),e.isSectionDisplayed()||_.setActiveState(!1)),"Grid"!==e.getAttribute("sDisplayPlaneMode")){var n=e.getAttribute("sPlaneBoxMode");"SliceMode"!==n&&"BoxMode"!==n||(ge("Back"),"BoxMode"===n&&(ge("Top"),ge("Bottom"),ge("Right"),ge("Left")))}else _&&h&&e.isSectionDisplayed()?function(){_.setActiveState(!0);var t=e.getAttribute("fXDirSize"),i=e.getAttribute("fYDirSize"),n=0,o=e.getAttribute("sPlaneBoxMode");"SliceMode"!==o&&"BoxMode"!==o||(n=e.getAttribute("fSliceOffset")),$&&$.set(new s.Vector3(-t/2,-i/2,0),new s.Vector3(t/2,i/2,n)),_.drawGrids({specifications:[{BBox:$}]})}():e.isSectionDisplayed()&&de();var o=null,r=!1;e.getAttribute("bSectionCurvesVisible")&&e.isSectionCurveComputationNeeded()&&(o=function(){e.isSecondaryViewerShow()&&e.renderSecondaryViewer()},r=!0),e.manageCurvesAndHatching({computeCurves:r,action:o}),ve()}},m._getManpForRobot=function(){if(w)return w},m.updateRobotPos=function(e){m._robot&&m._robot.updateRobotPos(e)},m.manageLock=function(t){var i=!0;return m&&t!==k?(k=t,m.update(),i=!1):function(){if(w&&w._updateManipulators(),D&&D._updateManipulators(),R&&R._updateManipulators(),T&&T._updateManipulators(),O&&O._updateManipulators(),E&&E._updateManipulators(),m._robot){var t=0!==e._viewer.getVisibleSpace(),i=le()===o.State.INEDITION;i||(r=!1,l||(l=v.getEditCmd(e._viewer)),l&&(r=l.isRunning()),i=r);var n=!(t&&i);m._robot.update(n)}var r}(),i},m.isLocked=function(){return k},m.getFrameWindow=function(){return e._frmWindow},m.getAppType=function(){return e._typeApps},m.getCenter=function(e){var t=ne(),i=(new s.Vector3).getPositionFromMatrix(t.referential),n=t.planeType;if(!(e||"BoxMode"!==n&&"SliceMode"!==n||isNaN(t.sliceOffset))){var o=t.referential.decompose(),r=new s.Vector3(0,0,1).applyQuaternion(o[1]);r=r.normalize().multiplyScalar(t.sliceOffset/2),i=i.add(r)}return i},m.computePlaneCenter=function(t){return v.computePlaneCenter(t,e.getAttribute("fSliceOffset"),!e.isSinglePlaneMode())},m.getNormal=function(){var e=ne().referential.decompose();return new s.Vector3(0,0,1).applyQuaternion(e[1])},m.getUDirection=function(){var e=ne().referential.decompose();return new s.Vector3(1,0,0).applyQuaternion(e[1])},m.getVDirection=function(){var e=ne().referential.decompose();return new s.Vector3(0,1,0).applyQuaternion(e[1])},m.getPlaneGeometryCB=function(e){return ne(e)},m.setPlaneGeometryCB=function(e){ae(e)},m.manipulationInformationCB=function(e){return ue(e)},m.setClippingRepVisibility=function(e){w&&w._setPlaneVisibility(e),D&&D._setPlaneVisibility(e),R&&R._setPlaneVisibility(e),T&&T._setPlaneVisibility(e),O&&O._setPlaneVisibility(e),E&&E._setPlaneVisibility(e)},m.setPickingInManipulationModeForLineTraslation=function(e){w&&w.setPickingInManipulationModeForLineTraslation(e),D&&D.setPickingInManipulationModeForLineTraslation(e),R&&R.setPickingInManipulationModeForLineTraslation(e),T&&T.setPickingInManipulationModeForLineTraslation(e),O&&O.setPickingInManipulationModeForLineTraslation(e),E&&E.setPickingInManipulationModeForLineTraslation(e)},m.setRobot=function(e){m._robot=e,!w||e&&P||w.setRobot(e)},m.getRobot=function(){return m._robot},m.isBoxMode=function(){return"BoxMode"===e.getAttribute("sPlaneBoxMode")},m.clearAllRulers=function(e){w&&w.clearRuler(),D&&D.clearRuler(),R&&R.clearRuler(),T&&T.clearRuler(),O&&O.clearRuler(),E&&E.clearRuler(),!e&&m._robot&&m._robot.updateRobotPos()},m.initClippingRobot=function(t){e.isConstructionItemMode()||(m._robot||m.setRobot(new f(m,t)),m._robot.buildRobot())},m.cleanClippingRobot=function(){m._robot&&m._robot.clean(),m._robot=null},m.isClippingNode=function(){return!0},m.isPersistentClippingCB=function(){return"DMUTemporaryBag"!==e.getParent().getType()},e.isSectionDisplayed()&&m.update(),m._eventController=r.giveEventsController({viewer:e._viewer}),m.cbTokenForSetUnSetPickThrough=[],m._eventController&&(m.cbTokenForSetUnSetPickThrough.push(m._eventController.addEvent("onSetPickThroughtRequest",()=>{me(C.PICKTHROUGH)})),m.cbTokenForSetUnSetPickThrough.push(m._eventController.addEvent("onUnsetPickThroughRequest",()=>{me(C.PICKABLE)}))),m.clearEventToken=function(){m._eventController&&m.cbTokenForSetUnSetPickThrough&&m.cbTokenForSetUnSetPickThrough.forEach(e=>{m._eventController.removeEvent(e)})},m.setRulerOrigin=function(e){w&&w.setRulerOrigin&&w.setRulerOrigin(e)},m.getCurrentStoreyOrigin=function(){e.getCurrentStoreyOrigin()}}})}),define("DS/DMUPlaySection/DMUClippingBase",["DS/DMUBaseExperience/DMUOverloadableObject","DS/Visualization/Node3D","DS/DMUPlaySection/DMUToolsSection","DS/DMUPlaySection/DMUClippingManipulationTool","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUMeshCreation","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUToolsMaths","DS/DMUMeasurable/DMUMathsVector3D","DS/DMUMeasurable/DMUSectionPosService","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseUIControllers/DMUMarkupsController","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/DMUPlaySection/DMUClippingNode3D","DS/DMUPlaySection/DMUSectionImport","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXPreferences/DMUClippingPrefService","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUModelServices","DS/DMUControls/DMUWarningPanel","DS/DMUControls/EXPNotify","DS/DMUPlaySection/DMUStoreyNavigratorController","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"],function(e,t,i,n,o,r,a,l,s,c,u,p,g,d,v,f,m,S,h,C,b,y,M,P,w,D,x,V,A,N,_,R,T){"use strict";var O=[{name:"mPlaneReferential",type:"Matrix4",JSONname:"PropertiesSection.PlaneReferential",defaultValue:new d.Matrix4},{name:"fXDirSize",type:"float",JSONname:"PropertiesSection.XDirSize"},{name:"fYDirSize",type:"float",JSONname:"PropertiesSection.YDirSize"},{name:"fSliceOffset",type:"float",JSONname:"PropertiesSection.SliceOffset"},{name:"sPlaneBoxMode",type:"string",JSONname:"PropertiesSection.PlaneBoxMode",defaultValue:"NormalMode"},{name:"bSectionCurvesVisible",type:"bool",JSONname:"PropertiesSection.SectionCurvesVisible",defaultValue:!1},{name:"bCustomCappingColor",type:"bool",JSONname:"PropertiesSection.GraphicProperties.Capping.customColor"},{name:"cCappingColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.Capping.color"},{name:"bCustomContourColor",type:"bool",JSONname:"PropertiesSection.GraphicProperties.LineStyle.customColor"},{name:"cLineStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.LineStyle.color"},{name:"sLineStylePattern",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.pattern"},{name:"fLineStyleThicknessIndex",type:"float",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thicknessIndex",defaultValue:1},{name:"cFillStyleColor",type:"Color",JSONname:"PropertiesSection.GraphicProperties.FillStyle.color",defaultValue:new d.Color(3575492)},{name:"fOpacity",type:"float",JSONname:"PropertiesSection.GraphicProperties.FillStyle.opacity",defaultValue:.5},{name:"bVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.visible",defaultValue:!0},{name:"bClippingPlaneVisible",type:"bool",JSONname:"PropertiesSection.GraphicProperties.clippingPlanesVisible"},{name:"sTargetIds",type:"listStrings",JSONname:"targetIds",defaultValue:[]},{name:"sDisplayPlaneMode",type:"string",JSONname:"PropertiesSection.DisplayPlaneMode",defaultValue:"Plane"},{name:"sDisplayContourMode",type:"string",JSONname:"PropertiesSection.DisplayContourMode",defaultValue:"Contour"},{name:"sSectionRender",type:"string",JSONname:"PropertiesSection.SectionRender",defaultValue:"CutOneSide"},{name:"bPartialClippingMode",type:"bool",JSONname:"PropertiesSection.PartialClippingMode"},{name:"sUpdateAndFreezeMode",type:"string",JSONname:"PropertiesSection.UpdateAndFreezeMode",defaultValue:"Update"},{name:"fXDirGridStep",type:"float",JSONname:"PropertiesSection.XDirGridStep"},{name:"fYDirGridStep",type:"float",JSONname:"PropertiesSection.YDirGridStep"},{name:"vTranslationValue",type:"float",JSONname:"PropertiesSection.TranslationValue",defaultValue:0},{name:"iGridAbsoluteMode",type:"int",JSONname:"PropertiesSection.GridAbsoluteMode",defaultValue:1},{name:"sLinkedObjectId",type:"string",JSONname:"linkedObjectId"},{name:"mRelativePosition",type:"Matrix4",JSONname:"relativePosition"},{name:"iCutUncutMode",type:"int",JSONname:"PropertiesSection.CutUncutMode"},{name:"bClipping",type:"bool",JSONname:"PropertiesSection.Clipping"},{name:"bClippingActiveState",type:"bool",JSONname:"PropertiesSection.ClippingActiveState"},{name:"fLineStyleThickness",type:"int",JSONname:"PropertiesSection.GraphicProperties.LineStyle.thickness"}];return e.extend({init:function(e){var E,I,U=e.viewer,B=e.expParent,L=e.typeApps,k=e.modeType,F=e.sectionEditCmd,z=e.context,W=e.clippingPrecisePosCmd,G=e.sType?e.sType:"Clipping",j=e.contextbarLib,H=e.propertiesLib,X=e.nodeClass,Y=this;if(this.storeyMode=e.isStoreyMode,this.csoList=e.csoList,this._parent(U,B),this._frmWindow&&(this._executionContext=this._frmWindow.getExecutionContext?this._frmWindow.getExecutionContext():this._frmWindow.getContextualUIManager&&this._frmWindow.getContextualUIManager()?this._frmWindow.getContextualUIManager()._executionContext:void 0),this.addParameters(O),z)this._context=z;else{var J,Z=h.getContextViewer({reviewContext:h.getReviewContext({viewer:U})});Z&&(J=Z.getCommandContext()),this._context=J||"Default"}this.setAttribute("sType",G),W&&(E=W),this._sectionObjectMode=k,this._tokenModelEvent=[],F?I=F:(I=i.getEditCmd(U))&&(I.isRunning()||I.isPaused())&&I.cancel(),Y._typeApps=L,Y.updateAppType=function(e){e&&(Y._typeApps=e)},this._nSectionCurvesNode=new t,this._nSectionCurvesNode.getDMUType=function(){return Y.getType()},this._nSectionCurvesNode.contourNode=!0;var q=new t,Q=!0,K=(new d.Matrix4).makeScale(10,0,0),$=!0,ee=[],te=[],ie=[],ne=[],oe=[],re=!1,ae=!1,le=null,se=[],ce=null,ue=null,pe=!1,ge=!0,de=[];this._translationValue=0;var ve=!1;this._vTranslationValue=50;var fe=j||"DS/DMUSection/DMUClippingContextualBar",me=[],Se=0;var he,Ce=h.getContextViewer({reviewContext:h.getReviewContext({viewer:U})}),be=Ce.subscribe({event:"onRepresentationLoaded"},function(){if(Y.getAttribute("sLinkedObjectId")){var e=Y.getAttribute("sLinkedObjectId");if(null!=e)e.length>0&&(!function(){if(Y.getAttribute("sLinkedObjectId")&&Y.getAttribute("mRelativePosition")){var e=Y.getAttribute("sLinkedObjectId");if(null!=e&&e.length>0){var t=Y.getAttribute("mRelativePosition"),i=new d.Matrix4;i.getInverse(t);var n=e[0],o=D.getAbsolutePositionMatrix(Y,i,n);if(null!=o){var r={attribute:"mPlaneReferential",value:o.rotateX(Math.PI)};Y.set(r),Y.getNode().updateRobotPos(!0),Y._viewer.render()}}}}(),Ce.unsubscribe(be))}}),ye=function(){return l.isOOC(M,Y._viewer)};function Me(){Y._bBox=Y.getBB(),Y._bSphere=s.computeBoundingSphere(Y._viewer,ie,function(){return!0},function(){return h.getContextViewer({viewer:Y._viewer})});var e=new d.Vector3((Y._bBox.max.x+Y._bBox.min.x)/2,(Y._bBox.max.y+Y._bBox.min.y)/2,(Y._bBox.max.z+Y._bBox.min.z)/2),t=Math.ceil(Math.max(2*Y._bSphere.radius,Y._bBox.max.distanceTo(Y._bBox.min))),i=Y.getCenter(),n=-1,o=1,r=0,a=!1,l=Y.getNormal().normalize();l=function(e){var t=e;if(t){var i=t.clone().normalize();i.x>.9995||i.y>.9995||i.z>.9995?t=i.negate():(-i.x>.9995||-i.y>.9995||-i.z>.9995)&&(t=i)}return t}(l),Y._dotXNormal=l.clone().dot(new d.Vector3(1,0,0)),Y._dotYNormal=l.clone().dot(new d.Vector3(0,1,0)),Y._dotZNormal=l.clone().dot(new d.Vector3(0,0,1));var c,u=e.clone().projectOnVector(l.clone()),p=i.clone().projectOnVector(l.clone());Y._vProjBoxCenterOnPlaneNormal=i.clone().add(u.clone().sub(p.clone())),Y._centerNearPlane=(new d.Vector3).addVectors(Y._vProjBoxCenterOnPlaneNormal,l.clone().multiplyScalar(.5*t)),Y._centerFarPlane=(new d.Vector3).subVectors(Y._vProjBoxCenterOnPlaneNormal,l.clone().multiplyScalar(.5*t));let g,v=Y.getNode();if(v&&(g=v.getRobot()),g&&(c=g._getRulerOriginPos()),null==c&&(c=i.clone()),null!=c){var f=Y._centerNearPlane.clone().distanceTo(i.clone()),m=Y._centerFarPlane.clone().distanceTo(i.clone()),S=l.clone().negate(),C=c.clone().projectOnVector(l.clone()),b=(C=i.clone().add(C.clone().sub(p.clone()))).clone().sub(i.clone()),y=C.clone().sub(Y._centerFarPlane.clone()),M=C.clone().sub(Y._centerNearPlane.clone()),P=b.clone().normalize().dot(S.clone().normalize()),w=y.clone().normalize().dot(S.clone().normalize()),D=M.clone().normalize().dot(S.clone().normalize());r=i.clone().distanceTo(C.clone()),o=Y._centerFarPlane.clone().distanceTo(C.clone()),n=Y._centerNearPlane.clone().distanceTo(C.clone()),P>.9995&&(r=-r),w>.9995&&(o=-o),D>.9995&&(n=-n),Math.abs(f+m-t)<=.001||(f>m?(r=o,a=!0):f<m&&(r=n,a=!0))}return{value:r,minValue:n,maxValue:o,manipRange:t,bSectionPlaneOutOfmanipRange:a}}function Pe(e){if(void 0!==a.getValue(Y,"vTranslationValue")){var t=w.convert(e,"length",S.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value,"mm");a.setValue(t,Y,"vTranslationValue")}}function we(){if(!Y.isSinglePlaneMode()||!Y.isSectionDisplayed())return;var e=Me();Y.setTranslationValue(e.value,!1),Y._movegauge&&(Y._movegauge.unsubscribeToPrefChangeEvt(),Y._movegauge.clean(),Y._movegauge=null);let t=!1,i=h.getReviewContext({viewer:Y._viewer});if(B){let e;if("DMUTemporaryBag"===B.getType())e=B.getDMUObjects("DMUCompare3D");else if(i){let t=i.getCurrentSessionMarkup();t.getCurrentSlide()&&(e=t.getCurrentSlide().getDMUObjects("DMUCompare3D"))}e&&e.length&&(t=!0)}if(!Y.isConstructionItemMode()&&x.manipulation.getStatus()){Y.clearOtherslider();var o=S.readPreferences({name:"cke",PreferenceNames:["Length"]}).preferences[0].value;Y._movegauge=new n({iOwner:Y,iReviewContext:i,frameWindow:Y._frmWindow,runningApp:Y._typeApps,initValue:e.value,initMinValue:e.minValue,initMaxValue:e.maxValue,initStepValue:x.manipulation.getIncrementValToSet(o),initManipRange:e.manipRange,onChangeSliderCB:Pe,onChangeSpinnerCB:Pe,notifyOutOfRange:e.bSectionPlaneOutOfmanipRange,hasCompareObject:t,viewType:"3dPlay"===Y._typeApps||x.manipulation.isExploreView()?"ExploreView":"DetailedView"}),Y._movegauge&&Y._movegauge.subscribeToPrefChangeEvt&&Y._movegauge.subscribeToPrefChangeEvt({event:"onPreferencesChanged",cb:he})}}function De(e){null!==Y._nSectionCurvesNode&&Y._nSectionCurvesNode.removeChildren(),e||(null!==q&&q.removeChildren(),re=!0),ne=[],oe=[]}function xe(){me.length>0&&de.length>0&&de.forEach(function(e){e&&e.removeSectionCappingMaterial()}),de=[],me=[],ae=!0,Se=0}function Ve(e,t){var i;if(e.length>0&&t.length>0){var n=Y.getAttribute("sLineStylePattern"),o=Y.getAttribute("fLineStyleThickness");o||(o=Y.getAttribute("fLineStyleThicknessIndex"));var a=r.createPolylines(e,t,o,n);(i=v.createMeshNode(a)).name=T.sectioncurves,i.measurable=!0}return i}function Ae(e,t){var i=Ve(e,t);i&&q.add(i)}function Ne(e,n,o){for(var r=[],a=[],l=e.aAllPolygons.length,s=Y.getAttribute("cLineStyleColor"),c=Y.isCustomColorSorce("Contour"),u=0;u<l;u++){var p=i.trimPolylines(e.aAllPolygons[u]._Polylines,o);p.length>0&&(r.push(p),a.push(c?s:e.aAllColors[u]),ne.push(p),oe.push(c?s:e.aAllColors[u]))}!function(e,i,n){if(Q||Y.isSecondaryViewerShow()){var o=Ve(i,n);if(o){var r=new t;r.name=T.sectioncurves,r.measurable=!0,r.getDMUType=function(){return Y.getType()},r.add(o),e&&r.setMatrix(e),Y._nSectionCurvesNode.add(r)}Y._nSectionCurvesNode.setVisibility(Y._bIsInShowSpace)}Y.isSecondaryViewerShow()&&Ae(i,n)}(n,r,a)}function _e(e){e?Y.setSectionCurveUpdateStatus(!0):Y.setSectionCurveUpdateStatus(!1),Y.refreshNode(),Y._viewer.render()}function Re(){var e=[],t=Y.getAttribute("sTargetIds"),i=t.length,n=h.getReviewContext({viewer:Y._viewer});if(n){var o=n.getCurrentSessionMarkup();if(o){var r=o.getAttribute("oLinksManager");if(r&&i>0)for(var a=0;a<i;a++){var l,s=r.getChildWithID(t[a]);s&&(l=r.getOccurrenceIdPath(s.path)),l&&e.push(l)}}}return e}if(this.cleanLockedInRAMNodes=function(){if(se.length>0&&ce){for(var e=0;e<se.length;e++)ce.unlockRepresentationMeshInRAM(se[e]);se=[]}},this.unsuscribeOnRepLoading=function(){le&&(ue&&ue.unsubscribe(le),le=null)},this.isSectionDisplayed=function(){return Y.isVisible()&&Y.getActiveFlag()&&Y.isDisplayed()&&Y.getAttribute("bVisible")},this.isSectionUpdateReq=function(){return(Y.isTemporaryClipping()||Y.isVisible())&&Y.getActiveFlag()&&Y.isDisplayed()&&Y.getAttribute("bVisible")},this.isClippingPlaneVisible=function(){return!0===Y.getAttribute("bClippingPlaneVisible")},this._cleanManipulationTool=function(){Y._movegauge&&(Y._movegauge.unsubscribeToPrefChangeEvt(),Y._movegauge.clean(),Y._movegauge=null)},Y._buildManipulationTool=function(){Y.isSectionDisplayed()&&(Y._movegauge&&Y._movegauge.getVisibleFlag()||(we(),Y._movegauge&&Y._movegauge.setVisibleFlag(!0)))},he=function(){Y._movegauge&&Y._movegauge.getVisibleFlag()&&(Y._movegauge.unsubscribeToPrefChangeEvt(),Y._movegauge.clean(),Y._movegauge=null,we(),Y._movegauge&&Y._movegauge.setVisibleFlag(!0))},this.refreshSlider=function(){if(!Y._movegauge||Y._movegauge.bPerformRefreshOrCreate){if(ve=!0,Y._movegauge){var e=Me();Y._movegauge.update({value:e.value,minValue:e.minValue,maxValue:e.maxValue,stepValue:localStorage.getItem("IncrementValue"),notifyOutOfRange:e.bSectionPlaneOutOfmanipRange}),Y.setTranslationValue(e.value,!1),Y._movegauge&&Y._movegauge.setVisibleFlag(!0)}ve=!1}},this._viewer){var Te;this._bIsInShowSpace=0!==this._viewer.getVisibleSpace();var Oe,Ee,Ie=function(e){Te&&clearTimeout(Te),Te=setTimeout(function(){if(Te=null,!Y||!Y._viewer||!Y.isSectionDisplayed())return;Y._bUpdateOnModelChange=!0;let t=Y.getNode();if(t)if(Y.isConstructionItemMode()&&e){let e,o,r=i.getBuildingRootData(Y._viewer,void 0,!0),a=!1,l=!1;if(ue||(ue=h.getContextViewer({viewer:Y._viewer})),r)for(var n=0;n<r.length;n++)if(a||r[n]&&r[n].ID&&(a=!0,e=r[n]),(o=R.getStoreyInfo(r[n]?r[n].ID:void 0,ue))&&o.length){l=!0;break}if(!a||!l)if(a){if(!l){R.clearStoreyNavigratorController({context:ue});let n=e=>{let t=e.GetPosition3D();Y.updateClippingPosAndOrientation(t),i.setStoreyinfoOnSlide(Y._viewer,e.GetCurrentStorey()),Y.manageNavigatorEdition(),Y._viewer.render()},o=()=>{if(localStorage.setItem("DMUClippingBoxMode","NormalMode"),Y.setAttribute("sPlaneBoxMode","NormalMode"),t){let e=t.getRobot();e||(t.initClippingRobot(),e=t.getRobot()),e&&e.updateRobotPos()}Y.refreshNode(),Y._viewer.render()};Y._storeyNavigatorcntroller=R.getDMUStoreyNavigratorController({context:ue,getBuidlingRootID:()=>e?r.ID:void 0,storyeRetrivalSuccessCB:n,storyeRetrivalFailCB:o})}}else Y.resetToNormalMode(t)}else t.resetClippingFlag(),Y.refreshNode();Y._viewer.render(),Y._bUpdateOnModelChange=void 0},100)},Ue=h.giveEventsController({viewer:this._viewer});if(Ue&&!this._tokenModelEvent.length)Ee=Ue.addEvent(f.Events.EXPRootModifiedEvent,function(){Ie(!0)}),this._tokenModelEvent.push(Ee),Ee=Ue.addEvent(f.Events.EXPMoveEvent,Ie),this._tokenModelEvent.push(Ee),Ee=Ue.addEvent(f.Events.EXPHideShowEvent,Ie),this._tokenModelEvent.push(Ee),Ee=Ue.addEvent(f.Events.EXPModelUpdatedEvent,Ie),this._tokenModelEvent.push(Ee),Ee=Ue.addEvent(f.Events.EXPLineLayoutComputationBeginEvent,function(){Y.isSectionDisplayed()&&(Oe=Y.isVisible(),Y.setVisibleFlag(!1,!1,!0),Y.refreshNode(),Y._viewer.render())}),this._tokenModelEvent.push(Ee),Ee=Ue.addEvent(f.Events.EXPLineLayoutComputationEndEvent,function(){"boolean"==typeof Oe&&(Y.setVisibleFlag(Oe,!1,!0),Oe=void 0,Ie())}),this._tokenModelEvent.push(Ee),ye()||(Ee=Ue.addEvent(f.Events.EXPStartProgressiveLoad,function(){De(),xe(),Y._bLoadingInProgress=!0,_e(!1),Y._bPreviousLoadingInProgress=!0}),this._tokenModelEvent.push(Ee),Ee=Ue.addEvent(f.Events.EXPEndProgressiveLoad,function(){Y._bLoadingInProgress=!1,_e(!0),Y._bPreviousLoadingInProgress=!1}),this._tokenModelEvent.push(Ee));if(!Y._tokenOnPimCtrlOpacityChange){require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){ue||(ue=h.getContextViewer({viewer:Y._viewer})),Y._pimCtrl=e.giveItfCtrl({pad3DViewer:ue}),Y._pimCtrl&&(Y.itfZeroOpacityflag=!0,Y._tokenOnPimCtrlOpacityChange=Y._pimCtrl.subscribe("onOpacityChange",function(e){e.data&&(0===e.data.oldValue&&0!==e.data.newValue||0!==e.data.oldValue&&0===e.data.newValue)&&(0===e.data.newValue?Y.itfZeroOpacityflag=!0:Y.itfZeroOpacityflag=!1,Ie())}))})}var Be=m.getDMUMarkupsController({context:this._viewer,frmWindow:this._frmWindow});Be&&Be.registerMarker(this)}this.initAuthoringData=function(){-1!==h.getAuthoringFeatureTypes().indexOf("Section")&&(-1===h.getAuthoringFeatureTypes().indexOf("Section")||Y.getContextualCommandList||require([fe],function(e){var t=new e;Y.getContextualCommandList=t.getContextualCommandList,Y.getSharedContextualCommandList=t.getSharedContextualCommandList,Y.getSharedHeaderTypes=t.getSharedHeaderTypes,t.setCheckCmdHdrState&&(Y.setCheckCmdHdrState=t.setCheckCmdHdrState),t.applyStateToContextHdr&&(Y.applyStateToContextHdr=t.applyStateToContextHdr),"ProgressiveVisuLoading"!==Y._typeApps&&(Y.getSharedContextualMenuCommandList=t.getSharedContextualMenuCommandList,Y.getContextualMenuCommandList=t.getContextualMenuCommandList),t.register({frmWindow:Y._frmWindow,type:Y.getType()});var i=1===C.get().length?C.get()[0].pathElement.clone():null;i&&i.getLastElement(!0).getDMUType&&(i.getLastElement(!0)===Y.getNode()||i.getLastElement(!0)===Y._nSectionCurvesNode)&&(C.empty(),C.add({pathElement:i}))}),Y.getPropertiesObject||"ProgressiveVisuLoading"===Y._typeApps||require([H||"DS/DMUSection/DMUClippingProperties"],function(e){var t=new e(Y);Y.getPropertiesObject=function(){return t}}))},this.removeAuthoringData=function(){-1!==h.getAuthoringFeatureTypes().indexOf("Section")&&-1!==h.getAuthoringFeatureTypes().indexOf("Section")&&require([fe],function(e){var t=new e;Y.getContextualCommandList=null,Y.getSharedContextualCommandList=null,Y.getSharedHeaderTypes=null,Y.getSharedContextualMenuCommandList=null,Y.getContextualMenuCommandList=null,Y.setCheckCmdHdrState=null,Y.applyStateToContextHdr=null,t.unregister({frmWindow:Y._frmWindow})})};var Le=new y(Y);this.importData=Le.importData,this.afterImport=Le.afterImport,this.initAuthoringData(),this.getDMUObjectFromPathElement=function(e){if(e)for(var t=e.clone();t;){if(t.getLastElement(!0)===Y.getNode())return Y;t=t.getParentPath()}};var ke=!1;this.getDoNotEndEditCmdState=function(){return ke},this._startEditCommand=function(){if(E)Y.removeCurvesAndHatching(),E.begin(),E=void 0;else{if(I=i.getEditCmd(Y._viewer)){var e=Y.getNode();if(e){let t,i=e.getRobot();i&&(t=i._getRulerOriginPos()),e.initClippingRobot(t)}}"DMUClipping"===this.getType()&&(Y._movegauge?this.refreshSlider():we())}},this._endEditCommand=function(){if(I=i.getEditCmd(this._viewer),this.getDoNotEndEditCmdState()||!I||I.isEnding&&I.isEnding()||!I.isRunning()&&!I.isPaused())this.getDoNotEndEditCmdState()&&(ke=!1);else{i.cleanClippingVisu(this._viewer);var e=Y.getNode();e&&e.setRobot(null)}};var Fe=this.setReadOnly;function ze(){let e=i.getEditCmd(Y._viewer);e&&(e.isRunning()||e.isPaused())&&e.cancel()}this.setReadOnly=function(e,t){var i=Boolean(t);Fe(e,i),Y.getNode()&&Y.getNode().update(!0),this.setStoreyNavigatorEditionState(!e)};let We=this.setDisplayedFlag;this.setDisplayedFlag=function(e){let t=Y.isConstructionItemMode(),i=t?this._storeyNavigatorcntroller:void 0;t&&!i&&(i=R.giveDMUStoreyNavigratorController({context:h.getContextViewer({viewer:this._viewer})}),this._storeyNavigatorcntroller=i),e?i&&(i.ShowStoreyNavigator(),this.isReadOnly()||this.manageNavigatorEdition(!0)):(i&&i.HideStoreyNavigator(),this.isInEdition()&&ze()),We(e)};let Ge=this.setVisibleFlag;this.setVisibleFlag=function(e,t,i){i||(!e&&this.isInEdition()?ze():(this.manageNavigatorEdition(),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.ShowStoreyNavigator())),Ge(e,t)},this.removeCurvesAndHatching=function(){De(),xe(),this.cleanLockedInRAMNodes(),this.unsuscribeOnRepLoading()},this.manageCurvesAndHatching=function(e){if(!Y._posCmdActive&&(Y.promiseToResolve&&Y.promiseToResolve.length&&(Y.promiseToResolve.forEach(e=>{e("CancelOnDemand")}),Y.promiseToResolve=[]),Y._bClipping||"DMUSection"!==Y.getType()||!this.isReadOnly()||"BoxMode"!==Y.getAttribute("sPlaneBoxMode")||"OnlyContour"===Y.getAttribute("sSectionRender"))){ye()||(De(),xe());var t,n=Y.getAttribute("mPlaneReferential");"BoxMode"===Y.getAttribute("sPlaneBoxMode")&&(t=new d.Box2);var o=Y.getAttribute("fXDirSize"),r=Y.getAttribute("fYDirSize"),a=Y.getAttribute("bHatchingDisplay"),s=e.computeCurves;if(t&&t.set(new d.Vector2(-o/2,-r/2),new d.Vector2(o/2,r/2)),s&&$&&Y.isSectionDisplayed()&&(Q||Y.isSecondaryViewerShow())||Y.isSectionDisplayed()&&a&&ge&&Y.isHatchingUpdateNeeded()){Y.removeCurvesAndHatching(),K=n.clone(),re=!1,ae=!1;var c=function(s,c){var u=[],p=[];if(Y._bIsInShowSpace?s.forEach(function(e){e&&e.getLastElement&&!l.isOOCTileSetNode(e.getLastElement(!0))&&u.push(e)}):c.forEach(function(e){e&&e.getLastElement&&!l.isOOCTileSetNode(e.getLastElement(!0))&&p.push(e)}),Y._bIsInShowSpace&&u.length>0||!Y._bIsInShowSpace&&p.length>0){if(e.computeCurves&&$&&Y.isSectionDisplayed()&&(Q||Y.isSecondaryViewerShow())){var g=n;if(Ne(i.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,t),"SliceMode"!==Y.getAttribute("sPlaneBoxMode")&&"BoxMode"!==Y.getAttribute("sPlaneBoxMode")||(g=Y._getPlanReferential("Back"),Ne(i.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,t)),"BoxMode"===Y.getAttribute("sPlaneBoxMode")){var v=Y.getAttribute("fSliceOffset");t&&t.set(new d.Vector2(-o/2,-v/2),new d.Vector2(o/2,v/2)),g=Y._getPlanReferential("Top"),Ne(i.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,t),g=Y._getPlanReferential("Bottom"),Ne(i.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,t),t&&t.set(new d.Vector3(-v/2,-r/2,0),new d.Vector3(v/2,r/2,0)),g=Y._getPlanReferential("Right"),Ne(i.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,t),g=Y._getPlanReferential("Left"),Ne(i.computeSectionCurvesUsingPolyPlanarOperator(Y._viewer,g,Y._bIsInShowSpace?u:p),g,t)}e.action&&e.action(),Y._viewer.render()}var f="Single"===Y.getAttribute("sHatchingAnglesMode");Y.isSectionDisplayed()&&a&&ge&&function(e){var t=Y.getAttribute("cHatchingColor")?Y.getAttribute("cHatchingColor").getHexString():void 0,i=Y.getAttribute("fHatchingLineStyleThickness"),n=Y.getAttribute("fHatchingSingleAngleValue"),o=Y.getAttribute("fHatchingPitchValue")?Y.getAttribute("fHatchingPitchValue")*window.devicePixelRatio:void 0,r=void 0;if(Y.isCustomColorSorce("Capping")&&(r=Y.getAttribute("cCappingColor")),e.cutObjects&&e.cutObjects.length>0){var a;if(0===me.length)if("Single"===e.anglesMode)a=new d.ScreenSizeHatchingMeshMaterial({stripesDirection:new d.Vector2(Math.cos(n),Math.sin(n)),stripesColor:"#"+t,stripesWidth:i,spaceColor:r,autoSpaceColor:void 0===r,spaceWidth:o*window.devicePixelRatio}),me.push(a);else if("Various"===e.anglesMode){let e=[30*Math.PI/180,-30*Math.PI/180,60*Math.PI/180,-60*Math.PI/180];for(let n=0;n<e.length;n++)a=new d.ScreenSizeHatchingMeshMaterial({stripesDirection:new d.Vector2(Math.cos(e[n]),Math.sin(e[n])),stripesColor:"#"+t,stripesWidth:i,spaceColor:r,autoSpaceColor:void 0===r,spaceWidth:o}),me.push(a)}if(1===me.length)e.cutObjects.forEach(function(e){if(e){var t=e.getLastElement();t&&-1===de.indexOf(t)&&(t.setSectionCappingMaterial(me[0]),de.push(t))}});else if(4===me.length)for(let t=0;t<e.cutObjects.length;t++){var l=e.cutObjects[t];if(l){var s=l.getLastElement();s&&-1===de.indexOf(s)&&(s.setSectionCappingMaterial(me[Se%4]),Se++,de.push(s))}}Y._viewer.render()}}({cutObjects:Y._bIsInShowSpace?u:p,anglesMode:f?"Single":"Various"})}},u=!1;if(ye()&&(u=!0),u){if(ue||(ue=h.getContextViewer({viewer:Y._viewer})),ce||ue&&(ce=ue.getController()),ce&&ue){var p=l.getRootReferences(Y._viewer,!0),g=[],v=[];if(Y.isSinglePlaneMode()){var f=Y.getCenter(),m=Y.getUDirection(),S=Y.getVDirection(),C={origin:[f.x.toString(),f.y.toString(),f.z.toString()],u_direction:[m.x.toString(),m.y.toString(),m.z.toString()],v_direction:[S.x.toString(),S.y.toString(),S.z.toString()]};if(p.length>0)for(var b=0;b<p.length;b++)v.push(ce.completeSessionWithClippingOperatorCandidates({path:ce.buildArrayFromPath(l.buildPathElement(p[b])),sectionPlane:C,meshInRAM:s}))}if("SliceMode"===Y.getAttribute("sPlaneBoxMode")){var y=Y.getCenter(),M=Y.getUDirection(),w=Y.getVDirection(),D={origin:[y.x.toString(),y.y.toString(),y.z.toString()],u_direction:[M.x.toString(),M.y.toString(),M.z.toString()],v_direction:[w.x.toString(),w.y.toString(),w.z.toString()]},x=Y.getCenter(Y._getPlanReferential("Back")),V=Y.getUDirection(Y._getPlanReferential("Back")),A=Y.getVDirection(Y._getPlanReferential("Back")),N={origin:[x.x.toString(),x.y.toString(),x.z.toString()],u_direction:[V.x.toString(),V.y.toString(),V.z.toString()],v_direction:[A.x.toString(),A.y.toString(),A.z.toString()]};if(p.length>0)for(var _=0;_<p.length;_++)v.push(ce.completeSessionWithClippingOperatorCandidates({path:ce.buildArrayFromPath(l.buildPathElement(p[_])),sectionPlane:D,meshInRAM:s})),v.push(ce.completeSessionWithClippingOperatorCandidates({path:ce.buildArrayFromPath(l.buildPathElement(p[_])),sectionPlane:N,meshInRAM:s}))}else if("BoxMode"===Y.getAttribute("sPlaneBoxMode")){var R=Y.getAttribute("fSliceOffset"),O=new d.Vector3(r,o,R),E=(new d.Matrix4).copy(n);E.rotateZ(-Math.PI/2),E.translate(new d.Vector3(-r/2,-o/2,0));var I=[E.elements[0],E.elements[1],E.elements[2],E.elements[4],E.elements[5],E.elements[6],E.elements[8],E.elements[9],E.elements[10],E.elements[12],E.elements[13],E.elements[14]],U={corner_min:[0,0,0],corner_max:[O.x,O.y,O.z],transformation_matrix:I,intersection_mode:"across"};if(p.length>0)for(var B=0;B<p.length;B++)v.push(ce.completeSessionWithClippingOperatorCandidates({path:ce.buildArrayFromPath(l.buildPathElement(p[B])),box:U,meshInRAM:s}))}var L=function(e){if(Y.promiseToResolve=[],e.length>0){e.forEach(function(e){if(e.selectedPaths.length>0){var t=Re();e.selectedPaths.forEach(function(e){var i=e.length;if(t.length>0){for(var n=!1,o=0;o<t.length;o++){var r=t[o],a=r.length;if(a<i)for(var l=0;l<a;l++){if(r[l]!==e[l]){n=!1;break}n=!0}if(n)break}n&&g.push(e)}i>0&&s&&se.push(e[i-1])}),t.length>0?g.push.apply(g,t):g.push.apply(g,e.selectedPaths)}}),le||(le=ue.subscribe({event:"onRepresentationLoaded"},function(e){if(s&&ce.hasMeshInRAM(e)||a&&!s){for(var t=[],i=0;i<g.length;i++)-1!==g[i].indexOf(e)&&t.push(ce.buildPathFromArray(g[i]));if(t.length>0){for(var n=[],o=[],r=0;r<t.length;r++)l.parseForLeafNodes(t[r],Y._viewer,n,o,Boolean(Y.itfZeroOpacityflag));c(n,o)}}}));for(var t=[],i=[],n=0;n<g.length;n++){var o=g[n][g[n].length-1];if(ce.isReferenceComplete(o)&&(s&&ce.hasMeshInRAM(o)||a&&!s)){var r=ce.buildPathFromArray(g[n]);l.parseForLeafNodes(r,Y._viewer,t,i,Boolean(Y.itfZeroOpacityflag))}}c(t,i)}},k=function(){P&&P.displayNotification({eventID:"warning",msg:T.notifyComputeContourfailure}),Y.unsuscribeOnRepLoading(),De(),xe(),re=!1};Y.isConstructionItemMode()?v.forEach(e=>{Promise.race([e,new Promise(e=>{Y.promiseToResolve||(Y.promiseToResolve=[]),Y.promiseToResolve.push(e)})]).then(function(e){"string"!=typeof e&&L([e])},function(){Y.promiseToResolve=[],k()})}):Promise.all(v).then(function(e){L(e)},function(){k()})}}else Y.collectCutObjects(),c(ee,te)}}},this._getPlanReferential=function(e){var t=new d.Matrix4;if(Y.getAttribute("mPlaneReferential")&&(t=t.copy(Y.getAttribute("mPlaneReferential")),e)){var i=Y.getAttribute("fSliceOffset");"Back"===e?(t.rotateX(Math.PI),t.translate(new d.Vector3(0,0,-i))):"Top"===e?(t.rotateX(-Math.PI/2),t.translate(new d.Vector3(0,-i/2,-Y.getAttribute("fYDirSize")/2))):"Bottom"===e?(t.rotateX(Math.PI/2),t.translate(new d.Vector3(0,i/2,-Y.getAttribute("fYDirSize")/2))):"Left"===e?(t.rotateY(Math.PI/2),t.translate(new d.Vector3(-i/2,0,-Y.getAttribute("fXDirSize")/2))):"Right"===e&&(t.rotateY(-Math.PI/2),t.translate(new d.Vector3(i/2,0,-Y.getAttribute("fXDirSize")/2)))}return t},this.isSectionCurveComputationNeeded=function(){var e=!1;if(!Y._bLoadingInProgress)if(Y._bUpdateOnModelChange)e=Y._bUpdateOnModelChange;else{var t=Y.getAttribute("mPlaneReferential");Y.isSectionDisplayed()&&(re||!u.areMatrixEqual(K.elements,t.elements)||Y._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isHatchingUpdateNeeded=function(){var e=!1;if(!Y._bLoadingInProgress)if(Y._bUpdateOnModelChange)e=Y._bUpdateOnModelChange;else{var t=Y.getAttribute("mPlaneReferential");Y.isSectionDisplayed()&&(ae||!u.areMatrixEqual(K.elements,t.elements)||Y._bPreviousLoadingInProgress)&&(e=!0)}return e},this.isSecondaryViewerShow=function(){return Y._iViewerSecondaryWindow&&Y._iViewerSecondaryWindow.isShow()};var je=!1,He=!1;this.isManipulationOnGo=function(){return je||Y._posCmdActive},this.beginManipulation=function(){je=!0,He=!1,ge=!1,this.getAttribute("bHatchingDisplay")&&this.getNode().isClippingEnabled()&&(this.getNode().enableClipping(!1),xe(),this.getNode().enableClipping(!0)),Y.isSecondaryViewerShow()||($=!1),$||Y._viewer.picking.primitive&&Y.getAttribute("bSectionCurvesVisible")&&Y._viewer.setRenderMode("SectionLine",!0),pe=!1,Y._movegauge&&Y.refreshSlider?Y.refreshSlider():we()},this.doManipulation=function(e){je=!0,He=!0,ye()&&($=!1,De(!0),this.cleanLockedInRAMNodes()),void 0===e&&_e(!1),Y.updatePosToStoreyNavigator(),Y._viewer.render(),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():we()},this.addOrRemoveFromCSO=function(e){var t={pathElement:l.buildPathElement(Y.getNode())};C.isIn(t)?e||C.remove(t):e&&C.add(t)},this.endManipulation=function(e,t){if($=!0,ge=!0,Y.updatePosToStoreyNavigator(),!pe){var i={pathElement:l.buildPathElement(Y.getNode())};e&&e.from&&(ke=!0,!e||e&&!e.from[0].event.ctrlKey?(C.empty(),C.add(i)):C.isIn(i)?C.remove(i):C.add(i),ke&&(ke=!1))}if(t)return!0;_e(!0),Y._viewer.picking.primitive&&Y._viewer.setRenderMode("SectionLine",!1),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():we(),je=!1,He&&Y.fireEvent("onDMUObjectAttributeModified",{dmuObject:Y}),He=!1,Y.fireEvent("onEndSectionManipulation",{dmuObject:Y})},this.onLongHold=function(){pe=!0},this.setObjects=function(e,t){if(e&&e.length>0){ie||(ie=[]);var n=e.length,o=Y.getParent();if(o&&o.getOccurence){for(var r,a,s=Y.getAttribute("sTargetIds"),c=0;c<n;c++)if(r=o.getOccurence({pathElement:e[c]},!0))if((a=s.indexOf(r.id))>=0){var u=s.slice(0,a),p=s.slice(a+1);s=u.concat(p);var g=ie.slice(0,a),d=ie.slice(a+1);ie=g.concat(d)}else s.push(r.id),ie.push(e[c]);Y.setAttribute("sTargetIds",s)}if(!t){var v=l.computeBoundingBox(Y._viewer,ie),f=Math.max(v.max.x-v.min.x,v.max.y-v.min.y,v.max.z-v.min.z),m=i.computeSectionPlaneReferencial(Y._viewer,v);Y.getNode()&&Y.getNode().resetClippingFlag(),Y.setAttribute("fXDirSize",f),Y.setAttribute("fYDirSize",f),Y.modifyPlaneReferential(m),Y.getNode()&&Y.getNode().updateRobotPos(!0)}}},this.collectCutObjects=function(){var e=[],t=!1,i=1;if(0===ee.length&&0===te.length){var n=h.getContextViewer({viewer:Y._viewer});if(ye())(e=Re())&&e.length>0&&(t=!0,void 0!==Y.getAttribute("iCutUncutMode")&&(i=Y.getAttribute("iCutUncutMode")));else{var o=function(){if(!ie||0===ie.length){ie=[];var e=Y.getAttribute("sTargetIds"),t=e.length,i=h.getReviewContext({viewer:Y._viewer});if(i){var n=i.getCurrentSessionMarkup();if(n){var o=n.getAttribute("oLinksManager");if(o&&t>0)for(var r,a=0;a<t;a++)(r=o.getOccurrencePathElement(e[a]))&&ie.push(r)}}}return ie}();if(o&&o.length>0){t=!0;for(var r=o.length,a=0;a<r;a++)l.parseForLeafNodes(o[a],Y._viewer,ee,te,Boolean(Y.itfZeroOpacityflag))}else l.parseForLeafNodesOfScene(n,ee,te,Boolean(Y.itfZeroOpacityflag))}}return t||(t=ie&&ie.length>0),{CutObjects:ee,NoCutObjects:te,CutObjectsOOC:e,bIsPartial:t,cutUncutMode:i}},this.onViewerEventCB=function(e){var t=!0,i=h.getReviewContext({viewer:this._viewer});if(i&&(!i.isVisible()||i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isVisible())&&(t=!1),t){Y.getNode()&&Y.getNode().onViewerEventCB&&Y.getNode().onViewerEventCB(e);var n=0!==Y._viewer.getVisibleSpace();if("beginExplodeCmd"===e.eventType){Y._bIsInShowSpace===n&&Y.setVisibleFlag(!1,!1,!0);var o={pathElement:l.buildPathElement(Y.getNode())};C.isIn(o)?C.remove(o):(o={pathElement:l.buildPathElement(Y._nSectionCurvesNode)},C.isIn(o)&&C.remove(o)),Y.refreshNode(),Y.getNode().enableClipping(!1),Y._viewer.setSectionCapping(!1)}else"endExplodeCmd"===e.eventType&&(Y._bIsInShowSpace===n&&Y.setVisibleFlag(!0,!1,!0),Y.refreshNode(),Y.getNode().enableClipping(!0),Y._viewer.setSectionCapping(!0))}},this.setSectionCurveUpdateStatus=function(e){Q=e};var Xe=this.refreshNode;this.refreshNode=function(e){if(Y.getNode()&&(!B.isImporting||B.isImporting&&!B.isImporting())){ee=[],te=[];var t=Y.isSectionDisplayed();Y.getNode().update(e),Y._viewer.render(),!t&&Y._iViewerSecondaryWindow&&Y._iViewerSecondaryWindow.clear(),Xe()}},this.manageLock=function(e){var t,i=!1;if(B&&"DMUTemporaryBag"===B.getType()&&(i=!0),i)t="boolean"==typeof e?e:!!this._viewer._lockUnlockCmd&&this._viewer._lockUnlockCmd.getState();else{var n=!this._bClippingPlaneVisible;Y.getNode()&&(t=!Y.isInEdition()&&n)}Y.getNode()&&Y.getNode().manageLock(t)},this.sectionToXYZ=function(e){let t=Y.getAttribute("sPlaneBoxMode");"BoxMode"!==t&&(e=this.updateClippingSize(e)),Y.modifyPlaneReferential(e),Y.getNode()&&Y.getNode().updateRobotPos(!0),Y._viewer.render(),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():we(),"BoxMode"===t&&Y.fireEvent("onDMUObjectAttributeModified",{dmuObject:Y}),Y.fireEvent("onEndSectionManipulation",{dmuObject:Y})},this.updateClippingSize=function(e){var t=e,i=this.getBB(),n=p.computePlaneDim(i,e,!1,!1,!0);if(n){if(n.fPlaneSizeV&&n.fPlaneSizeU){var o=n.fPlaneSizeU,r=n.fPlaneSizeV;Y.setAttribute("fXDirSize",o),Y.setAttribute("fYDirSize",r),Y.setAttribute("fXDirGridStep",o/20),Y.setAttribute("fYDirGridStep",r/20)}n.plane&&(t=n.plane)}return t},this.sectionToX=function(){var e=Y.getClippingCenter(),t=(new d.Matrix4).rotateY(-Math.PI/2).setPosition(e);t.setPosition(Y.getPlaneCenter(t)),Y.sectionToXYZ(t)},this.sectionToY=function(){var e=Y.getClippingCenter(),t=(new d.Matrix4).rotateX(Math.PI/2).setPosition(e);t.setPosition(Y.getPlaneCenter(t)),Y.sectionToXYZ(t)},this.sectionToZ=function(e,t){var i=Y.getClippingCenter(),n=(new d.Matrix4).rotateY(Math.PI).setPosition(i);n.setPosition(e?t||new d.Vector3(0,0,0):Y.getPlaneCenter(n)),Y.sectionToXYZ(n)},this.sectionFlip=function(){var e={attribute:"mPlaneReferential",value:Y.getAttribute("mPlaneReferential").rotateX(Math.PI)};Y.set(e),Y.getNode()&&Y.getNode().updateRobotPos(!0),Y.refreshNode(),Y._viewer.render(),Y._movegauge&&Y.refreshSlider?Y.refreshSlider():we(),this.updatePosToStoreyNavigator(),"BoxMode"===Y.getAttribute("sPlaneBoxMode")&&Y.fireEvent("onDMUObjectAttributeModified",{dmuObject:Y}),Y.fireEvent("onEndSectionManipulation",{dmuObject:Y})},this.sectionViewpoint=function(){var e=Y.getAttribute("mPlaneReferential"),t=1.5*Y.getAttribute("fXDirSize"),i=e.decompose(),n=i[0],r=i[1],a=new d.Vector3(1,0,0).applyQuaternion(r),l=new d.Vector3(0,1,0).applyQuaternion(r),s=new d.Vector3(0,0,1).applyQuaternion(r),u=a.dot(new d.Vector3(0,0,1)),p=l.dot(new d.Vector3(0,0,1)),g=Math.abs(u),v=Math.abs(p),f=a;if(c.isZero(g)&&c.isZero(v)){var m=o.getViewpointInfo(Y._viewer.currentViewpoint),S=a.dot(m.sight),h=l.dot(m.sight),C=Math.abs(S),b=Math.abs(h);c.isLessOrEqual(b,C)?c.isLessOrEqual(C,b)||(f=a.multiplyScalar(c.isLessThan(S,0)?-1:1)):f=l.multiplyScalar(c.isLessThan(h,0)?-1:1)}else c.isLessOrEqual(v,g)?c.isLessOrEqual(g,v)||(f=a.multiplyScalar(c.isLessThan(u,0)?-1:1)):f=l.multiplyScalar(c.isLessThan(p,0)?-1:1);o.moveViewpoint({freeZoneSize:Y._frmWindow.getImmersiveFrame().getFreeZone().getBoundingClientRect(),viewerSize:{width:Y._frmWindow.getViewer().SCREEN_WIDTH,height:Y._frmWindow.getViewer().SCREEN_HEIGHT},viewpoint:Y._viewer.currentViewpoint,target:n,sightDirection:s,upDirection:f,targetDistance:t,duration:400}),Y.getNode()&&Y.getNode().updateRobotPos(!0)},this.sectionCut=function(e){var t=e;a.setValue(t,Y,"sSectionRender")},this.sectionGrid=function(){var e;e="Plane"===a.getValue(Y,"sDisplayPlaneMode")?"Grid":"Plane",a.setValue(e,Y,"sDisplayPlaneMode")},this.sectionSlice=function(){a.setValue("SliceMode",Y,"sPlaneBoxMode"),a.setValue(20,Y,"fSliceOffset")},this.getTranslationValue=function(){return Y._translationValue},this.setTranslationValue=function(e,t){if(!1===t||!0===ve)Y._translationValue=e;else{var i=Y.getCenter(),n=Y.getNormal();n=function(e){var t=e;if(t){var i=t.clone().normalize();i.x>.9995||i.y>.9995||i.z>.9995?t=i.negate():(-i.x>.9995||-i.y>.9995||-i.z>.9995)&&(t=i)}return t}(n);var o=i.clone(),r=Y._centerNearPlane.distanceTo(Y._centerFarPlane),a=Y._centerNearPlane.distanceTo(i.clone()),l=Y._centerFarPlane.distanceTo(i.clone());if(Math.abs(a+l-r)<=.001){var s=Y.getTranslationValue();o=i.clone().add(n.clone().normalize().multiplyScalar(s-e))}else{var c=Y.getTranslationValue();a<l?o=Y._centerNearPlane.clone().add(n.clone().normalize().multiplyScalar(c-e)):a>l&&(o=Y._centerFarPlane.clone().add(n.clone().normalize().multiplyScalar(c-e)))}Y._translationValue=e;var u=Y.getAttribute("mPlaneReferential");u.setPosition(o),Y.modifyPlaneReferential(u),Y.getNode().updateRobotPos(!0),Y._viewer.render()}},this.modifyPlaneReferential=function(e){if(e){var t={attribute:"mPlaneReferential",value:Y.getAttribute("mPlaneReferential").copy(e)};Y.set(t),Y.getNode().update()}},this.getCenter=function(e){var t=e||Y.getAttribute("mPlaneReferential");return(new d.Vector3).getPositionFromMatrix(t)},this.getClippingCenter=function(){var e=Y.getAttribute("mPlaneReferential"),t=(new d.Vector3).getPositionFromMatrix(e),i=Y.getAttribute("sPlaneBoxMode");if("BoxMode"===i||"SliceMode"===i){var n=Y.getNode();if(n&&n.getCenter)t=n.getCenter();else{var o=Y.getAttribute("fSliceOffset");if(!isNaN(o)){var r=e.decompose(),a=new d.Vector3(0,0,1).applyQuaternion(r[1]);a=a.normalize().multiplyScalar(o/2),t=t.add(a)}}}return t},this.getPlaneCenter=function(e){return i.computePlaneCenter(e,this.getAttribute("fSliceOffset"),!this.isSinglePlaneMode())},this.getNormal=function(e){var t=(e||Y.getAttribute("mPlaneReferential")).decompose();return new d.Vector3(0,0,1).applyQuaternion(t[1])},this.computePlaneRef=function(e,t,i){let n=e;var o;n||(n=this.getNormal().negate().normalize());var r=!1;if(i&&n){let e=n.angleTo(this.getNormal().normalize());(c.isZero(e)||c.isZero(Math.PI-e))&&(r=!0)}var a=n.negate().normalize(),s=this.getBB();let u=t&&!r?t:this.getClippingCenter();if(s){let e=s.center();if(e&&a&&u){let t=g.computePointLineDistance(u.toArray(),e.toArray(),a.toArray()).aPosition;t&&(u=new d.Vector3(t[0],t[1],t[2]))}}var p=l.getXYAxisDirFromZ(a.clone());return p.xDir&&p.yDir&&(o=(new d.Matrix4).makeBasis(p.xDir,p.yDir,a)).setPosition(u),o},this.getUDirection=function(e){var t=(e||Y.getAttribute("mPlaneReferential")).decompose();return new d.Vector3(1,0,0).applyQuaternion(t[1])},this.getVDirection=function(e){var t=(e||Y.getAttribute("mPlaneReferential")).decompose();return new d.Vector3(0,1,0).applyQuaternion(t[1])},this.renderSecondaryViewer=function(){Y._iViewerSecondaryWindow&&Y._iViewerSecondaryWindow.render()},this.getSectionCurvesFor2DViwer=function(){return ne.length>0&&Ae(ne,oe),q},this.getSectionCurveNode=function(){return Y._nSectionCurvesNode},this.removeSectionCurve=function(){De()},this.setNode(X?new X(this):new b(this)),this.displayWarning=function(e,t){var i=Y._frmWindow,n=e,o=t;Y.warningPanel&&Y.warningPanel.destroy(),Y.warningPanel=new N({title:T.warningDlg.title,message:T.warningDlg.message,checkboxMessage:null,checked:!0,frmWindow:i,callbacks:{onValidateCB:async function(){let e=n.getAttribute?{}:n;n.getAttribute&&(e=await A.getObjectDefinition(n));let t=new V({viewer:i.getViewer(),experience:o});Y.getNode().clean(!0),Y.importData(e,t,o),Y.refreshNode(!0),Y.afterImport(),Y.updatePosToStoreyNavigator()},onCancelCB:function(){},onCloseCB:function(){}}})},this.notifyWrongPaste=function(e){var t=Y._frmWindow;Y._notify&&Y._notify.destroy(),this._notify=new _({body:t.getUIFrame(),type:"error",message:e?T.warningDlg.errMessageCtoS:T.warningDlg.errMessageStoC})};var Ye=this.setInEdition;let Je;this.setInEdition=function(e,t,i){if(null!=t){Ye(e);var n=Y.getNode();if(i)n&&(e&&n.initClippingRobot(),n.update());else if(Y.isEditable())if(this.manageNavigatorEdition(),e){var o=s.isManipulationAllowed({viewer:Y._viewer}),r=a.checkIfCommandIsRunning(Y._viewer)&&!o;if(n){var l=n._getManpForRobot();r||l||(r=!0)}if(!r){let t=Y.getNode();t&&t.manageLock(!e)&&t.update(),Y._startEditCommand()}}else Y._movegauge&&!this.getDoNotEndEditCmdState()&&(Y._movegauge.unsubscribeToPrefChangeEvt(),Y._movegauge.clean(),Y._movegauge=null),Y.getNode()&&!this.getDoNotEndEditCmdState()&&Y.getNode().manageLock(!e),Y._endEditCommand()}},Je=!0,addEventListener("custom:StoreyChanged",e=>{Y&&Y.isSectionUpdateReq()&&Je&&Y.isConstructionItemMode()&&e&&e.detail&&Y.updateClippingPosAndOrientation(e.detail,!0)}),addEventListener("custom:OrientationChanged",e=>{Y&&Y.isSectionUpdateReq()&&Je&&Y.isConstructionItemMode()&&e&&e.detail&&Y.updateClippingPosAndOrientation(e.detail,!0)}),this.unRegisterStoreyEvents=function(){Je&&(Je=!1,removeEventListener("custom:StoreyChanged",()=>{}),removeEventListener("custom:OrientationChanged",()=>{}),this.setStoreyNavigatorVisu(!1))},Y._eventController||(Y._eventController=h.giveEventsController({viewer:Y._viewer})),Y._eventController&&(Y.editclippingCmdEventToken&&Y.editclippingCmdEventToken.length||(Y.editclippingCmdEventToken=[],Y.editclippingCmdEventToken.push(Y._eventController.addEvent("onEditCommandStart",()=>{Y._buildManipulationTool()})),Y.editclippingCmdEventToken.push(Y._eventController.addEvent("onEditCommandEnd",()=>{Y._cleanManipulationTool()}))))},getBB:function(){let e=this._viewer;return s.computeBoundingBox(e,void 0,()=>!0,()=>h.getContextViewer({viewer:e}))},retriveCurrentStoreyInfo:function(){if(!this.isConstructionItemMode())return;let e=i.getStoreyinfoOnSlide(this._viewer);if(e)return e;let t=R.giveDMUStoreyNavigratorController({context:h.getContextViewer({viewer:this._viewer})});return t?t.GetCurrentStorey():void 0},updateStoreyNav:function(e){var t=this;if(!this.isConstructionItemMode())return;let n=this._storeyNavigatorcntroller;n||(n=R.giveDMUStoreyNavigratorController({context:h.getContextViewer({viewer:this._viewer})}));let o=e||i.getStoreyinfoOnSlide(this._viewer);n?(o&&n.SetCurrentStorey(o),this.updatePosToStoreyNavigator()):(n=R.getDMUStoreyNavigratorController({context:h.getContextViewer({viewer:t._viewer}),getBuidlingRootID:()=>{var e=i.getBuildingRootData(t._viewer);return e?e.ID:void 0},storyeRetrivalSuccessCB:e=>{o&&e.SetCurrentStorey(o),t.updatePosToStoreyNavigator(),t.manageNavigatorEdition()},storyeRetrivalFailCB:()=>{localStorage.setItem("DMUClippingBoxMode","NormalMode"),t.setAttribute("sPlaneBoxMode","NormalMode"),t.refreshNode(!0)}}),this._storeyNavigatorcntroller=n)},setStoreyNavigatorVisu:function(e){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=R.giveDMUStoreyNavigratorController({context:h.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&(e?(this._storeyNavigatorcntroller.ShowStoreyNavigator(),this.isReadOnly()||this.manageNavigatorEdition(!0)):this._storeyNavigatorcntroller.HideStoreyNavigator()))},setStoreyNavigatorEditionState:function(e){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=R.giveDMUStoreyNavigratorController({context:h.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.SetEditMode(e))},manageNavigatorEdition:function(e){if(!this.isConstructionItemMode())return;let t="DMUTemporaryBag"!==this.getParent().getType(),n=t?this.isInEdition():e;if("boolean"==typeof n){if(t&&this._storeyNavigatorcntroller){let e=i.getStoreyinfoOnSlide(this._viewer);e&&this.updateStoreyNav(e)}this.setStoreyNavigatorEditionState(n)}},manageNavigatoreVisu:function(e){this.setStoreyNavigatorVisu(e)},isBuidlingRootAvailable:function(e,t){if(!this.isConstructionItemMode())return!0;let n=e||h.getContextViewer({viewer:this._viewer});if(n){let e=i.isClippingEligibleForStoreyMode(this._viewer,n);if(!e)return!1;if(!t){let t=i.getBuildingRootData(this._viewer,e);if(!R.getStoreyInfo(t?t.ID:void 0,n))return!1}}return!0},manageConstrutionItemModeafterClone:function(){if(this.isConstructionItemMode()&&"DMUTemporaryBag"!==this.getParent().getType()){let e=h.getContextViewer({viewer:this._viewer});if(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=R.giveDMUStoreyNavigratorController({context:e})),!this._storeyNavigatorcntroller)return;if(!this.isBuidlingRootAvailable(e))return void this.resetToNormalMode();let t=i.getStoreyinfoOnSlide(this._viewer);t&&(this._storeyNavigatorcntroller.SetCurrentStorey(t),this.updatePosToStoreyNavigator(),i.setStoreyinfoOnSlide(this._viewer,this._storeyNavigatorcntroller.GetCurrentStorey()))}},updatePosToStoreyNavigator:function(){this.isConstructionItemMode()&&(this._storeyNavigatorcntroller||(this._storeyNavigatorcntroller=R.giveDMUStoreyNavigratorController({context:h.getContextViewer({viewer:this._viewer})})),this._storeyNavigatorcntroller&&this._storeyNavigatorcntroller.SetPosition3D(this.getNormal().negate().normalize(),this.getClippingCenter()))},updateClippingPosAndOrientation:function(e,t,n){if(!e||!e.position&&!e.Position3D&&!e.orientedDirection&&!e.OrientedDirection)return;let o=e.position||e.Position3D,r=e.orientedDirection||e.OrientedDirection;o&&(o=o.clone()),r&&(r=r.clone()),e.UUID&&i.setStoreyinfoOnSlide(this._viewer,e.UUID);let a=this.computePlaneRef(r,o,n);this.getNode().clearAllRulers();var l={attribute:"mPlaneReferential",value:a=this.updateClippingSize(a)};if(this.set(l),this.getNode().setRulerOrigin(o),this.updatePosToStoreyNavigator(),this.refreshNode(),t){let e=s.getClippingCmd(h.getContextViewer({viewer:this._viewer}));!1===e.getState()&&e.setState(!0)}},manageClippingCmd:function(){var e=s.getClippingCmdService();e&&e.updateClippingCommandState({contextViewer:h.getContextViewer({viewer:this._viewer}),reviewContext:h.getReviewContext({viewer:this._viewer})})},remove:function(){if(this.promiseToResolve&&this.promiseToResolve.length&&this.promiseToResolve.forEach(e=>{e("CancelOnDemand")}),this.promiseToResolve=null,this.unRegisterStoreyEvents(),this._movegauge&&(this._movegauge.unsubscribeToPrefChangeEvt(),this._movegauge.clean(),this._movegauge=null),"DMUTemporaryBag"===this.getParent().getType()){let e=s.getClippingCmd(h.getContextViewer({viewer:this._viewer}));e&&e.getState&&!0===e.getState()&&e.setState(!1)}var e=this.getNode();this.setAttribute("bClippingActiveState",!1),this.setVisibleFlag(!1,!1,!0),e.update(),e.clean(!0),e.cleanClippingRobot(!0);let t=i.getEditCmd(this._viewer);t&&(t.isRunning()||t.isPaused()?t.cancel():i.cleanClippingVisu(this._viewer)),e.setRobot(null),this.unsuscribeOnRepLoading(),this.cleanLockedInRAMNodes();var n=m.giveDMUMarkupsController({context:this._viewer});n&&n.unregisterMarker(this),m.unreferenceDMUMarkupsController({context:this._viewer});var o=h.giveEventsController({viewer:this._viewer});if(o)for(var r=0;r<this._tokenModelEvent.length;r++)o.removeEvent(this._tokenModelEvent[r]);this._tokenModelEvent=[],o&&this.editclippingCmdEventToken&&this.editclippingCmdEventToken.forEach(e=>{o.removeEvent(e)}),this._pimCtrl&&this._tokenOnPimCtrlOpacityChange&&(this._tokenOnPimCtrlOpacityChange&&this._pimCtrl.unsubscribe(this._tokenOnPimCtrlOpacityChange),this._tokenOnPimCtrlOpacityChange=null,this._pimCtrl=null),e.clean(),e.clearEventToken(),this._viewer.setSectionCapping(!1),this._iViewerSecondaryWindow&&this._iViewerSecondaryWindow.clear(),this._parent()},retriveClippingObjs:function(e){var t=function(e){if(e)return h.getReviewContext({viewer:e})};return function(e){return e&&e.getDMUObjects?((i=e.getDMUObjects("DMUClipping"))&&0===i.length&&(i=e.getDMUObjects("DMUSection")),i.length>0&&(t=i),t):[];var t,i}(function(e){var i=t(e);if(!i)return;function n(e){let t;return!!(e&&((!(t=e.getDMUObjects("DMUClipping"))||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let o,r=!1,a=!1,l=i.getCurrentSessionMarkup();l&&l.getActiveFlag()&&l.isVisible()&&l.getCurrentSlide&&(r=n(o=l.getCurrentSlide()));var s=i.getTransientReviewBag();return a=n(s),r||o&&!a?o:s}(e))},clearAllRuler:function(e){let t=this.retriveClippingObjs(this._viewer,!0);t&&t.length&&t.forEach(function(t){if(t){t.getNode().clearAllRulers(e)}})},clearOtherslider:function(){let e=this.retriveClippingObjs(this._viewer,!0);e&&e.length&&e.forEach(function(e){e&&e._cleanManipulationTool&&e._cleanManipulationTool()})},cleanNode:function(){this.getNode()&&this.getNode().clean()},setAttribute:function(e,t){"fLineStyleThicknessIndex"===e&&this._parent("fLineStyleThickness",null),this._parent(e,t)},isCustomColorSorce:function(e){var t;if("Capping"===e){t=this.getAttribute("bCustomCappingColor");let e=this.getAttribute("cCappingColor");null==t?t=Boolean(e):e||(t=!1)}if("Contour"===e){t=this.getAttribute("bCustomContourColor");let e=this.getAttribute("cLineStyleColor");null==t?t=Boolean(e):e||(t=!1)}return t},isSinglePlaneMode:function(){let e=this.getAttribute("sPlaneBoxMode");return"NormalMode"===e||"ConstructionItemMode"===e},isConstructionItemMode:function(){return"ConstructionItemMode"===this.getAttribute("sPlaneBoxMode")},getClippingModeForDragDrop:function(){return this.isConstructionItemMode()?"NormalMode":this.getAttribute("sPlaneBoxMode")},resetToNormalMode:function(e){this.setStoreyNavigatorVisu(!1),this.getNode().clean();if(this._lastClippingDefHdr=void 0,localStorage.setItem("DMUClippingBoxMode","NormalMode"),this.setAttribute("sPlaneBoxMode","NormalMode"),e){let t=e.getRobot();t||(e.initClippingRobot(),t=e.getRobot()),t&&t.updateRobotPos()}this.refreshNode()},isTemporaryClipping:function(){return"DMUTemporaryBag"===this.getParent().getType()}})}),define("DS/DMUPlaySection/DMUSection",["DS/DMUPlaySection/DMUClippingBase"],function(e){"use strict";return e.extend({init:function(e){e.sType="Section",this._parent(e)}})}),define("DS/DMUPlaySection/DMUClipping",["DS/DMUPlaySection/DMUClippingBase","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=[{name:"bHatchingDisplay",type:"bool",JSONname:"PropertiesSection.Hatching.Display",defaultValue:!0},{name:"cHatchingColor",type:"Color",JSONname:"PropertiesSection.Hatching.GraphicProperties.color",defaultValue:new t.Color(0)},{name:"fHatchingLineStyleThickness",type:"float",JSONname:"PropertiesSection.Hatching.GraphicProperties.LineStyle.thicknessIndex",defaultValue:1},{name:"sHatchingAnglesMode",type:"string",JSONname:"PropertiesSection.Hatching.AnglesMode",defaultValue:"Various"},{name:"fHatchingSingleAngleValue",type:"float",JSONname:"PropertiesSection.Hatching.SingleAngleValue",defaultValue:.523599},{name:"fHatchingPitchValue",type:"float",JSONname:"PropertiesSection.Hatching.HatchingPitchValue",defaultValue:10}];return e.extend({init:function(e){this._parent(e),this.addParameters(i)}})}),define("DS/DMUPlaySection/DMUClippingService",["UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUPlaySection/DMUClipping","DS/DMUPlaySection/DMUToolsSection","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUMeasurable/DMUSectionPosService","DS/CATWebUXPreferences/DMUClippingPrefService","DS/DMUBaseCommands/EXPToolsWUX","DS/Visualization/ThreeJS_DS","DS/DMUPlaySection/DMUStoreyNavigratorController","i18n!DS/CATWebUXPreferences/assets/nls/CATWebUXPreferences"],function(e,t,i,n,o,r,a,l,s,c,u,p){"use strict";var g,d=function(e){if(e)return t.getReviewContext({viewer:e})},v=function(e){var t=d(e);if(t){var i=t.getCurrentSessionMarkup();return(!i||i&&!i.getActiveFlag()||i&&i.getActiveFlag()&&!i.isVisible()||i&&i.getActiveFlag()&&i.isVisible()&&i.isReadOnly()||i&&i.getActiveFlag()&&i.isVisible()&&!i.isReadOnly()&&!i.getCurrentSlide())&&(i=t.getTransientReviewBag()),i}};var f=function(e){return e&&e.getDMUObjects?((!(i=e.getDMUObjects("DMUClipping"))||i&&0===i.length)&&(i=e.getDMUObjects("DMUSection")),i.length>0&&(t=i),t):[];var t,i},m=function(e){var i=t.getContextViewer({viewer:e});return i?i.getCommandContext():"Default"};function S(e,i,n){if(!e||!i||!n)return;var l,s,c=i.sliceOffset,u=function(){return"DMUTemporaryBag"!==e.getParent().getType()},p=function(){return t.getContextViewer({viewer:n})};let g="NormalMode"!==i.boxMode&&"ConstructionItemMode"!==i.boxMode;var d=i.bbox?i.bbox:r.computeBoundingBox(n,i.objForBB,u,p),v=Math.max(d.max.x-d.min.x,d.max.y-d.min.y,d.max.z-d.min.z),f=i.planeReferential||o.computeSectionPlaneReferencial(n,d,g,i.planeDir),m=g&&!c,S=a.computePlaneDim(d,f,!1,m);if(m){var h=r.computeBoundingSphere(n,i.objForBB,u,p);c=isNaN(S.fSliceOffset)?o.computeClippingSlice(h,f):S.fSliceOffset}i.planeSizeU&&i.planeSizeV?(s=i.planeSizeV,l=i.planeSizeU):(l=v,s=v,S&&S.fPlaneSizeV&&S.fPlaneSizeU&&(i.planeSizeV||(s=S.fPlaneSizeV),i.planeSizeU||(l=S.fPlaneSizeU))),e.setAttributes([{name:"mPlaneReferential",value:f},{name:"fXDirSize",value:l},{name:"fYDirSize",value:s},{name:"fXDirGridStep",value:l/20},{name:"fYDirGridStep",value:s/20},{name:"fSliceOffset",value:c}])}var h={setClippingParameters:async function(l,s){var u=this,g=await async function(e){if(e){var n=t.getReviewContext({viewer:e});return n||(n=await i.createReviewContext({context:t.getContextViewer({viewer:e})})),n}}(l);if(g){var d=s.appType||"3dReview",v=!isNaN(s.indexOfClippingObj)&&s.indexOfClippingObj>0?s.indexOfClippingObj:0,f=s.sectionCommandMode,S=[],h=function(){var t=u.retriveClippingObjs(l),i=g.getTransientReviewBag();if(i)return(!(S=i.getDMUObjects("DMUClipping"))||S&&0===S.length)&&(S=i.getDMUObjects("DMUSection")),S.length>0?t=S[v]:((t=new n({viewer:l,expParent:i,typeApps:d,modeType:f,context:m(l),sectionEditCmd:o.getEditCmd(l)})).setAttributes([{name:"sID",value:i.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:i.computeNewName({object:t,prefix:p.sectionPrefix||"Section"})}]),i.addDMUObject&&(i.addDMUObject(t),t.fireEvent("onDMUObjectInitialized",{dmuObject:t}))),t}();if(h){var C,b,y=r.computeBoundingBox(l),M=Math.max(y.max.x-y.min.x,y.max.y-y.min.y,y.max.z-y.min.z),P=s.planeReferential||o.computeSectionPlaneReferencial(l,y);if(s.planeSizeU&&s.planeSizeV)b=s.planeSizeV,C=s.planeSizeU;else{C=M,b=M;var w=a.computePlaneDim(y,P,!0);w&&(w.fPlaneSizeV&&w.fPlaneSizeU&&(s.planeSizeV||(b=w.fPlaneSizeV),s.planeSizeU||(C=w.fPlaneSizeU)),w.plane&&!s.planeReferential&&(P=w.plane))}var D=s.opacity;D&&(D/=255);var x=function(e){if(e&&3===e.length)return new c.Color("rgb("+e[0]+","+e[1]+","+e[2]+")")};let e=s.sectionCurvesVisible;h.setAttributes([{name:"mPlaneReferential",value:P},{name:"fXDirSize",value:C},{name:"fYDirSize",value:b},{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:s.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"fXDirGridStep",value:C/20},{name:"fYDirGridStep",value:b/20},{name:"sPlaneBoxMode",value:s.boxMode||"NormalMode"},{name:"fSliceOffset",value:s.sliceOffset||0},{name:"fOpacity",value:isNaN(D)?.5:D},{name:"bSectionCurvesVisible",value:e},{name:"bClipping",value:!0},{name:"bHatchingDisplay",value:s.hatchingDisplay},{name:"cHatchingColor",value:x(s.hatchingColor)},{name:"fHatchingLineStyleThickness",value:s.hatchingLineStyleThickness},{name:"sHatchingAnglesMode",value:s.hatchingAnglesMode},{name:"fHatchingSingleAngleValue",value:s.hatchingSingleAngleValue},{name:"fHatchingPitchValue",value:s.hatchingPitchValue}]),h.setAttribute("bCustomCappingColor",s.isCustomCappingColor),s.cappingColor&&h.setAttribute("cCappingColor",x(s.cappingColor)),h.setAttribute("bCustomContourColor",s.isCustomContourColor),s.lineStyleColor&&h.setAttribute("cLineStyleColor",x(s.lineStyleColor)),s.lineStyleThicknessIndex&&h.setAttribute("fLineStyleThicknessIndex",s.lineStyleThicknessIndex),s.lineStylePattern&&h.setAttribute("sLineStylePattern",s.lineStylePattern),s.fillStyleColor&&h.setAttribute("cFillStyleColor",x(s.fillStyleColor)),void 0!==s.clippingPlaneVisible&&h.setAttribute("bClippingPlaneVisible",s.clippingPlaneVisible),h.setInEdition(!1);var V=h.getNode();V&&V.update(!0),h.manageClippingCmd()}}},createClipping:function(i,r){if(d(i)){var a,s=r.appType||"3dReview",c=r.sectionCommandMode,v=r.precisePosCmd||void 0,f=function(e){var t=d(e);if(!t)return;var i=t.getCurrentSessionMarkup();let n=!0;if(i){let e=t.getRestrictions(i);e.markup&&void 0!==e.markup.canEdit&&(n=e.markup.canEdit)}return i&&i.getActiveFlag()&&i.isVisible()&&!i.isReadOnly()&&n&&i.getCurrentSlide()?i:t.getTransientReviewBag()}(i);if(f){var C;C=new n({viewer:i,expParent:f,typeApps:s,modeType:c,context:m(i),clippingPrecisePosCmd:v,sectionEditCmd:o.getEditCmd(i),csoList:r.csoList,isStoreyMode:"ConstructionItemMode"===r.boxMode}),v&&(C._posCmdActive=!0),C.setAttributes([{name:"sID",value:f.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:f.computeNewName({object:C,prefix:p.clippingPrefix})}]);var b=f;if(f.getCurrentSlide&&(b=f.getCurrentSlide()),b.addDMUObject&&(b.addDMUObject(C),a=!0),C){if(function(e,t,i){if(e&&t&&i){var n=t.boxMode||"NormalMode",o=t.sectionCommandMode;S(e,t,i),e.setAttributes([{name:"sDisplayPlaneMode",value:"Plane"},{name:"sDisplayContourMode",value:"Contour"},{name:"sSectionRender",value:t.sectionRender||"CutOneSide"},{name:"sPartialClippingMode",value:!1},{name:"sUpdateAndFreezeMode",value:"Update"},{name:"sPlaneBoxMode",value:n},{name:"fOpacity",value:void 0!==t.opacity?t.opacity:.2},{name:"bSectionCurvesVisible",value:t.sectionCurvesVisible||"ProgressiveVisuLoading"!==o&&l.contour.getComputeContourStatus()},{name:"bClipping",value:!0},{name:"bClippingActiveState",value:!0},{name:"bClippingPlaneVisible",value:Boolean(t.bDisplayPermanently)},{name:"bHatchingDisplay",value:t.isHatchingDisplayed},{name:"cHatchingColor",value:t.hatchingColor},{name:"fHatchingLineStyleThickness",value:t.hatchingThickness},{name:"sHatchingAnglesMode",value:t.hatchingAnglesMode},{name:"fHatchingSingleAngleValue",value:t.hatchingSingleAngleValue},{name:"fHatchingPitchValue",value:t.hatchingPitchValue}]),e.setAttribute("bCustomCappingColor",t.isCustomCappingColor),t.cappingColor&&e.setAttribute("cCappingColor",t.cappingColor),e.setAttribute("bCustomContourColor",t.isCustomContourColor),t.lineStyleColor&&e.setAttribute("cLineStyleColor",t.lineStyleColor),t.lineStyleThicknessIndex&&e.setAttribute("fLineStyleThicknessIndex",t.lineStyleThicknessIndex),t.fillStyleColor&&e.setAttribute("cFillStyleColor",t.fillStyleColor)}}(C,r,i),"ConstructionItemMode"===r.boxMode){let e=e=>{let t=e.GetPosition3D();C.updateClippingPosAndOrientation(t),o.setStoreyinfoOnSlide(i,e.GetCurrentStorey())},n=()=>{var e=o.getEditCmd(i);localStorage.setItem("DMUClippingBoxMode","NormalMode"),C.setAttribute("sPlaneBoxMode","NormalMode"),h.resetClipping(C,i),e&&!e.isRunning()&&e.begin()};var y=t.getContextViewer({viewer:i});let a=o.getBuildingRootData(i,r.buildingRoot),l=u.getStoreyInfo(a?a.ID:void 0,y);if(y&&a&&(l&&l.length||u.clearStoreyNavigratorController({context:y})),g=u.giveDMUStoreyNavigratorController({context:y})){g.ShowStoreyNavigator(),g.SetEditMode(!0),o.setStoreyinfoOnSlide(i,g.GetCurrentStorey());let e=g.GetPosition3D();C.updateClippingPosAndOrientation(e)}else g=u.getDMUStoreyNavigratorController({context:y,getBuidlingRootID:()=>a?a.ID:void 0,storyeRetrivalSuccessCB:e,storyeRetrivalFailCB:n})}a&&C.fireEvent("onDMUObjectInitialized",{dmuObject:C});var M=C.getNode();M&&M.update(),i.render()}return C}}},resetClipping:function(e,t){if(e&&t){S(e,l.getDefaultClippingProp(),t);var i=e.getNode();i&&i.update(!0),t.render()}},resizeClippingFromObject:function(e,t,i){if(e&&i){S(e,t,i);var n=e.getNode();n&&n.update(!0),i.render()}},retriveCurrentReview:function(e){return v(e)},retriveClippingObjs:function(e){var t=v(e);if(t)return t.getCurrentSlide&&(t=t.getCurrentSlide()),f(t)},retriveClippingObjsFromSlide:function(e){var t=this.retriveClippingObjs(e);if(!t||!t.length){var i=function(e){var t=d(e);if(!t)return;function i(e){let t;return!!(e&&((!(t=e.getDMUObjects("DMUClipping"))||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let n,o=!1,r=!1,a=t.getCurrentSessionMarkup();a&&a.getActiveFlag()&&a.isVisible()&&a.getCurrentSlide&&(o=i(n=a.getCurrentSlide()));var l=t.getTransientReviewBag();return r=i(l),o||n&&!r?n:l}(e);t=f(i)}return t},activateClipping:function(e,i){let n=t.getContextViewer({viewer:i});r.activateClipping(e,n)},deActivateClipping:function(e,i,n){let o=t.getContextViewer({viewer:i});e&&e.length||!g||g.HideStoreyNavigator(),r.deActivateClipping(e,o,n)},editClipping:async function(e,t,i){var n=t,r=!0===n.fromContextcmd,a=!i,c=o.getEditCmd(e);if(!e)return;var p=this.retriveClippingObjsFromSlide(e);let g=!1;var d;(!p||p.length<=0)&&a&&(p=[],d=n&&n.getDefaultValues?await n.getDefaultValues():l.getDefaultClippingProp(),p.push(this.createClipping(e,d)),g=!0);if(p&&p.length&&!(p.length<0)){var v=p.length>1;p.forEach(function(e){var t=e.getAttribute("bClippingActiveState");a&&!t&&(e.setAttribute("bClippingActiveState",a),e.setVisibleFlag(!0,!1,!0)),e.getNode().clearAllRulers(),e.setInEdition(a,r,v),v||e._posCmdActive||(a?s.addInCSO(e):e.addOrRemoveFromCSO()),e.isConstructionItemMode()&&!g&&a&&e.setStoreyNavigatorVisu(!0),u.getActivateClippingActionFlag()&&g&&e.isTemporaryClipping()&&e.isConstructionItemMode()||u.setActivateClippingActionFlag(!1)}),r&&(a?c.begin():c.cancel()),u.getActivateClippingActionFlag()&&(u.setActivateClippingActionFlag(!1),c&&c.isRunning()&&c.cancel()),e.render()}},setStoreyNavigatorVisibility:function(e){g&&(e?g.ShowStoreyNavigator():g.HideStoreyNavigator())}};return h});