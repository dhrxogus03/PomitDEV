define("DS/MPFOrderComponent/NoOrderConfirmationSectionCommand",["UWA/Class/View","DS/MPFUtils/MPFUtils"],function(e,t){"use strict";let r;const s=e.extend({className:"mpf-command mpf-hidden",render:function(){return this},isOn:t.doNothing,isOff:t.doNothing,setOn:t.doNothing,setOff:t.doNothing,hide:t.doNothing,show:t.doNothing});return s.getInstance=function(){return r||(r=new s),r},s}),define("DS/MPFOrderComponent/OrderConfirmationSectionCommand",["UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFFiniteStateMachine/FiniteStateMachine"],function(e,t,r){"use strict";const s=Object.freeze({ON:"ON",OFF:"OFF"}),n=Object.freeze({COMMAND_ON:"commandOn",COMMAND_OFF:"commandOff"}),i=e.extend({className:"mpf-command",setup:function(e){e||(e={}),this.icon=e.icon,this.iconOff=e.iconOff,this.label=e.label,this.labelOff=e.labelOff,this.stateMachine=this._createStateMachine(),this.button=this._createButton()},render:function(){return this.container.setContent(this.button),this},isOn:function(){return this.stateMachine.getState()===s.ON},setOn:function(){this._changeState(s.ON)},setOff:function(){this._changeState(s.OFF)},hide:function(){this.button.hide()},show:function(){this.button.show()},_changeState:function(e){this.stateMachine.changeState(e),this.stateMachine.getState()===s.OFF?(this.button.setIcon(this.icon),this.button.setValue(this.label)):(this.button.setIcon(this.iconOff),this.button.setValue(this.labelOff))},_onClickHandler:function(){this.stateMachine.getState()===s.OFF?(this._changeState(s.ON),this.dispatchEvent(n.COMMAND_ON)):(this._changeState(s.OFF),this.dispatchEvent(n.COMMAND_OFF))},_createButton:function(){return new t({value:this.label,icon:this.icon,className:"link",events:{onClick:this._onClickHandler.bind(this)}})},_createStateMachine:function(){return new r({state:s.OFF,states:[s.OFF,s.ON],transitions:[{from:s.ON,to:s.OFF},{from:s.OFF,to:s.ON}]})}});return i.Events=Object.freeze(n),i}),define("DS/MPFOrderComponent/OrderConfirmationSection",["UWA/Class/View"],function(e){"use strict";return e.extend({className:"mpf-section",setup:function(e={}){this.title=e.title,this.commands=Array.isArray(e.commands)?e.commands:[],this.body=Array.isArray(e.body)?e.body:[]},render:function(){return this.container.setContent([{tag:"div",class:"mpf-header",html:[{tag:"h5",class:"mpf-title",text:this.title},{tag:"div",class:"mpf-commands",html:this.commands}]},{tag:"div",class:"mpf-body",html:this.body}]),this},destroy:function(){this.stopListening(),this.commands=null,this.body=null,this._parent(),this.container=null}})}),define("DS/MPFOrderComponent/OrderTypeToItemNameDictionnary",["DS/MPFMap/BiMap","i18n!DS/MPFOrderComponent/assets/nls/OrderComponent"],function(e,t){"use strict";const r=new e;return r.put("MP3DP_PrintRequest",t.get("printBaseline")),r.put("MPENG_EngineeringItem",t.get("engineeringBaseline")),r.put("MP_DeliveryServiceRequest",t.get("shipping")),r.put("MP3DP_FinishRequest",t.get("finish")),r.put("MP_AdditionalServiceRequest",t.get("additionalServices")),r.put("MP_QuoteRequest",t.get("pricePerQuote")),r}),define("DS/MPFOrderComponent/OrderConfirmationHelper",["UWA/Core","UWA/Class","UWA/Promise","DS/MPFServices/MarketplaceServices","DS/MPFCartModel/CartModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFVirtualIbanModel/VirtualIbanFactory","DS/MPFModalConfiguratorComponent/OrderPaymentMethodSection","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFCartPaymentModel/WaitForPaymentFactory"],function(e,t,r,s,n,i,o,a,c,d,l){"use strict";const h=Object.freeze({CC_TOKEN:"ccTokenPaymentPage",CC_PAYMENT:"creditCardPaymentPage",BANK_TRANSFER:"bankTransfer",UNIFIED_PAYMENTS_INTERFACE:"upiPage",NONE:"none"}),m=t.extend();return m.preparePayment=function(e){let t,n,i=r.resolve(),o=!1;return e.paymentInfo.method===a.PaymentMethod.COUPON?(t=h.NONE,o=!0,m._setCartStatusForCoupon(e),e.service===s.MAKE&&(i=m._waitForPaymentCompletion.bind(this,{cart:e.cart,service:e.service}))):e.paymentInfo.method===a.PaymentMethod.CB?"addCB"===e.paymentInfo.value?(t=h.CC_PAYMENT,m._prepareCart(e)):(t=h.CC_TOKEN,n=m._getCardTokenPaymentData(e)):e.paymentInfo.method===a.PaymentMethod.UNIFIED_PAYMENTS_INTERFACE?(t=h.CC_PAYMENT,m._prepareCart(e)):(t=h.BANK_TRANSFER,i=m._getIbans.bind(null,e)),m._saveCart(e.cart).then(m._acceptQuote.bind(null,e.cartQuote)).then(i).then(function({ibans:e,iframe:r}={}){return{paymentPage:t,ibans:e,iframe:r,wasPaymentSuccessful:o,ccToken:n}})},m._waitForPaymentCompletion=function({cart:e,service:t}){return c.fetchPromise({service:t}).then(e=>d.getInstance(e)).then(e=>e.getFactories([d.Types.WAIT_FOR_PAYMENT])).then(t=>{return t[0].createModel(l.Types.CART,null,{parentResourceId:e.get("id")}).fetchPromise()})},m._prepareCart=function(e){const t={},r=e.cartPsp,s=e.cartPsp.isScaEnabled(),i=e.cart.getState()!==n.States.PAYMENT_INITIATED&&e.cart.getState()!==n.States.PAYMENT_REFUSED;if((r.usesPaymentPageRedirection()||s&&i)&&(t.currentState=n.States.PENDING_PAYMENT),r.usesPaymentPageRedirection()){const e=new URL(window.location.href);e.pathname+="/payment-result",t.cartContextUrl=e.href}return"1"===e.paymentInfo.CreditCardTokenMultiUse&&(t.CreditCardTokenMultiUse="1"),Object.keys(t).length>0&&e.cart.set(t),t},m._getPspIFrame=function(t){return{iframe:e.createElement("iframe",{src:t.cart.getPaymentUrl()})}},m._getCardTokenPaymentData=function(e){return e.paymentInfo.CreditCardToken},m._setCartStatusForCoupon=function(e){e.cart.set(n.Fields.STATE,n.States.PENDING_PAYMENT)},m._acceptQuote=function(e){const t={};return t[i.Fields.STATE]="ACCEPTED",e.fetchPromise().then(e.savePromise.bind(e,t,{patch:!0}))},m._saveCart=function(e){return e.hasPendingChanges()?e.savePromise(e.getPendingChanges(),{patch:!0}):r.resolve()},m._getIbans=function(e){if(e.service===s.CLICK_AND_BUY||e.service===s.IFWELOOP||e.service===s.SUBSCRIPTIONS||e.service===s.INNOVATE){const t=e.virtualIbanFactory.createCollection(o.Types.COMPANY);return t.setParentResourceId(e.cart.getCompanyID()),t.fetchPromise({currency:e.cart.getCurrency()}).then(function(e){return{ibans:e}})}return r.resolve()},m.PaymentPages=h,m}),define("DS/MPFOrderComponent/OrderDetailsComponent",["UWA/Core","UWA/String","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFOrderComponent/OrderTypeToItemNameDictionnary","i18n!DS/MPFOrderComponent/assets/nls/OrderComponent"],(e,t,r,s,n,i,o,a,c,d)=>{"use strict";return r.extend({className:"mpf-order-details table-responsive",setup(e){e||(e={}),s.requiredOfPrototype(e.cart,i,"options.cart must be a CartModel"),s.requiredOfPrototype(e.cartItems,a,"options.cartItems must be a CartItemCollection"),this._parent(e),this.service=e.service,this.cart=e.cart,this.cartItems=e.cartItems,this.locale=e.locale||"fr-FR",this.itemsSortedByOffer=this._groupItemsByOfferId(),this.table=this._createTable()},render(){return this.container.setContent([this.table,this._createInfoMessage()]),this},_groupItemsByOfferId(){var t=[];const r=this.cartItems.filter(e=>e.getQuantity()>0).sort((e,t)=>t.getType()===o.Types.MAKE_REQUEST||t.getType()===o.Types.ENGINEERING_REQUEST?1:e.getType()===o.Types.MAKE_REQUEST||e.getType()===o.Types.ENGINEERING_REQUEST?-1:0);return this.service===n.CLICK_AND_BUY?(r.forEach(r=>{const s=r.getOfferId();if(""!==s){const n=t.find(e=>e.offerId===s);e.is(n)?n.items.push(r):t.push({offerId:s,items:[r]})}else t.push({offerId:s,items:[r]})}),t):r},_createTable(){const t=this.cart.getGrossAmountTotal().toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"});return e.createElement("table",{class:"table table-condensed",html:[this._createTableHeader(),this._createTableBody(),this._createTableFooter(t)]})},_createOrderItemEntry(t,r){let s;const n=this.cart.getCurrency(),i=t.getUnitNetAmount().toLocaleString(this.locale,{style:"currency",currency:n,currencyDisplay:"code"}).replace(n,"").trim(),a=t.getUnitTaxesAmount().toLocaleString(this.locale,{style:"currency",currency:n,currencyDisplay:"code"}).replace(n,"").trim(),d=t.getTotalGrossAmount().toLocaleString(this.locale,{style:"currency",currency:n,currencyDisplay:"code"});return t.getType()===o.Types.SOFTWARE_REQUEST||t.getType()===o.Types.INNOVATE_REQUEST?s=t.get("ProductDisplayName"):(s=t.get("AdditionalServiceName")||t.get("FinishName"))||(s=c.get(t.getType(),t.getName())),e.createElement("tr",{html:[e.createElement("td",{class:r?"mpf-body-item offer":"mpf-body-item",text:r?"- "+s:s}),e.createElement("td",{class:"mpf-body-quantity",text:parseInt(t.getQuantity())}),e.createElement("td",{text:t.isPriceDisplayable()?i:"-"}),e.createElement("td",{text:t.isPriceDisplayable()?a:"-"}),e.createElement("td",{text:t.isPriceDisplayable()?d:"-"})]})},_createOfferEntry(t){const r=this.cart.getCurrency(),s=t.reduce((e,t)=>e+=parseFloat(t.getUnitNetAmount()),0).toLocaleString(this.locale,{style:"currency",currency:r,currencyDisplay:"code"}).replace(r,"").trim(),n=t.reduce((e,t)=>e+=parseFloat(t.getUnitTaxesAmount()),0).toLocaleString(this.locale,{style:"currency",currency:r,currencyDisplay:"code"}).replace(r,"").trim(),i=t.reduce((e,t)=>e+=parseFloat(t.getTotalGrossAmount()),0).toLocaleString(this.locale,{style:"currency",currency:r,currencyDisplay:"code"});return e.createElement("tr",{html:[e.createElement("td",{class:"mpf-body-item",text:t[0].get("title")}),e.createElement("td",{class:"mpf-body-quantity",text:parseInt(t[0].getOfferQuantity())}),e.createElement("td",{text:s}),e.createElement("td",{text:n}),e.createElement("td",{text:i})]})},_createTableBody(){const t=this.itemsSortedByOffer.map(e=>{if(this.service===n.CLICK_AND_BUY){const t=""!==e.offerId;if(t){const r=e.items.map(e=>this._createOrderItemEntry(e,t));return r.unshift(this._createOfferEntry(e.items)),r}return this._createOrderItemEntry(e.items[0],t)}return this._createOrderItemEntry(e)});return e.createElement("tbody",{html:t.flat()})},_createTableHeader:()=>e.createElement("thead",{html:e.createElement("tr",{html:[{tag:"th",text:d.get("item"),class:"mpf-header-item"},{tag:"th",text:d.get("quantity"),class:"mpf-header-quantity"},{tag:"th",text:d.get("unitPrice")},{tag:"th",text:d.get("taxes")},{tag:"th",text:d.get("totalAmountWithTaxes")}]})}),_createTableFooter:t=>e.createElement("tfoot",{html:e.createElement("tr",{html:[e.createElement("td"),e.createElement("td"),e.createElement("td"),e.createElement("td",{text:d.get("total")}),e.createElement("td",{text:t})]})}),_createInfoMessage(){const r=this.cart.getMinOrderCost();if(e.is(r)){if(parseFloat(r,10)>0){const s=t.format(d.get("messageMinOrderCost"),r,this.cart.getCurrency());return e.createElement("div",{class:"info-message",text:s})}}},destroy(){this.cart=null,this.cartItems=null,this.locale=null,this.table=null,this._parent(),this.container=null}})}),define("DS/MPFOrderComponent/OrderConfirmationAddressForm",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFBuyer/BuyerType","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFAddressFormComponent/AddressFormComponentV2","i18n!DS/MPFOrderComponent/assets/nls/OrderComponent"],function(e,t,r,s,n,i,o,a,c,d,l){"use strict";const h=Object.freeze({SAVE:"onSaveClicked",CANCEL:"onCancelCLicked"}),m=e.extend({className:"mpf-order-confirmation-address-form",setup(e={}){t.requiredOfPrototype(e.countries,n,"options.countries must be a CountryCollection"),t.requiredOfPrototype(e.addressFactory,r,"options.addressFactory must be an AddressFactory"),t.requiredOfPrototype(e.billingAddressHelper,o,"options.billingAddressHelper must be a BillingAddressHelper"),this.countries=e.countries,this.addressFactory=e.addressFactory,this.billingAddressHelper=e.billingAddressHelper,this.presetCountry=e.presetCountry,this.company=e.company,this.billingAddressHelper.getBuyerType()!==i.INDIVIDUAL&&t.requiredOfPrototype(e.company,s,"options.company must be a CompanyModel"),this.billingAddressHelper.isBuyerTypeEditable()&&(this.billingAddressHelper.isCompanyBuyer()||this.billingAddressHelper.isBillingInfoComplete())&&(this.buyerTypeSelector=this._createBuyerTypeSelector())},render(){const e=[{tag:"div",class:"mpf-command-line",html:[this._createSaveButton().render(),this._createCancelButton().render()]}];return this.buyerTypeSelector&&e.push(this.buyerTypeSelector.render()),this.addressForm&&this.addressForm.destroy(),this.addressForm=this._createAddressForm(),e.push(this.addressForm.render()),this.container.setContent(e),this},save(){return this.billingAddressHelper.createBillingAddress(this.addressForm.addressModel.omit()).savePromise()},destroy(){this.stopListening(),this.buyerTypeSelector&&this.buyerTypeSelector.destroy(),this.addressForm&&this.addressForm.destroy(),this.buyerTypeSelector=null,this.addressForm=null,this.company=null,this.addressFactory=null,this.billingAddressHelper=null,this._parent(),this.container=null},_createSaveButton(){const e=new a({icon:"floppy",iconOff:"floppy",label:l.get("save"),labelOff:l.get("save")});return this.listenTo(e,"commandOn",()=>{this.addressForm.validate()&&this.dispatchEvent(h.SAVE)}),this.listenTo(e,"commandOff",()=>{this.addressForm.validate()&&this.dispatchEvent(h.SAVE)}),e},_createCancelButton(){const e=new a({icon:"wrong",iconOff:"wrong",label:l.get("cancel"),labelOff:l.get("cancel")});return this.listenTo(e,"commandOn",this.dispatchEvent.bind(this,h.CANCEL)),this.listenTo(e,"commandOff",this.dispatchEvent.bind(this,h.CANCEL)),e},_createBuyerTypeSelector(){const e=new c({model:this.company});return this.listenTo(e,c.Events.ON_CHANGE,e=>{this.billingAddressHelper.setBuyerType("company"===e?i.COMPANY:i.INDIVIDUAL),this.render()}),e},_createAddressForm(){const e=this.billingAddressHelper.createBillingAddress(),t=this.company&&!!this.company.getCountry(),r=this.buyerTypeSelector&&this.buyerTypeSelector.getSelectedType()===c.Types.COMPANY||!this.buyerTypeSelector&&this.billingAddressHelper.getBuyerType()===i.COMPANY,s=r&&t||1===this.countries.size()&&!!this.presetCountry,n=this.presetCountry||r&&this.company.getCountry();return new d({addressModel:e,addressConstraints:this.addressFactory.addressesConstraints,countries:this.countries,countryReadOnly:s,horizontalLayout:!0,preSetCountry:n})}});return m.Events=h,m}),define("DS/MPFOrderComponent/OrderConfirmationPage",["UWA/Core","UWA/Class/View","UWA/Promise","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFShopModel/ShopModel","DS/MPFCompanyModel/CompanyModel","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFPspModel/PspModel","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCartModel/CartItemFactory","DS/MPFVirtualIbanModel/VirtualIbanFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFOrderComponent/OrderConfirmationHelper","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFCartQuoteComponent/CartQuoteDownloadLink","DS/MPFModalConfiguratorComponent/OrderSummaryDetailsSection","DS/MPFModalConfiguratorComponent/CouponSection","DS/MPFModalConfiguratorComponent/BillingInformationSection","DS/MPFOrderComponent/OrderConfirmationAddressForm","DS/MPFModalConfiguratorComponent/OrderPaymentMethodSection","DS/MPFModalConfiguratorComponent/OrderAgreementsSection","DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSectionV2","DS/MPFClickAndBuyComponent/checkout/LegalAgreementsSection","DS/MPFInnovateComponent/checkout/InnovateTermsAndConditions","i18n!DS/MPFOrderComponent/assets/nls/OrderComponent","css!DS/MPFOrderComponent/MPFOrderComponent"],(e,t,r,s,n,i,o,a,c,d,l,h,m,u,p,y,C,g,f,S,A,P,F,M,D,E,O,_,b,T,I,v,N,B,w,k,L,R,U)=>{"use strict";const H=Object.freeze({QUOTE_DOWNLOADED:"quoteDownloaded",STATE_CHANGE:"stateChange",VALID:"valid",INVALID:"invalid"}),V=Object.freeze({LOADING:"loading",NEW_ADDRESS_FORM:"newAddressForm",PAGE_DISPLAYED:"pageDisplayed"}),Q=t.extend({className:"mpf-order-confirmation-page",setup(t={}){o.requiredOfPrototype(t.me,c,"options.me must be a PersonModel"),o.requiredOfPrototype(t.cart,d,"options.cart must be a CartModel"),o.requiredOfPrototype(t.cartQuote,h,"options.cartQuote must be a CartQuoteModel"),o.requiredOfPrototype(t.cartPsp,y,"options.cartPsp must be a PspModel"),o.requiredOfPrototype(t.billingAddressHelper,_,"options.billingAddressHelper must be a BillingAddressHelper"),o.requiredOfPrototype(t.personAddresses,C,"options.personAddresses must be an AddressCollection"),o.requiredOfPrototype(t.countries,g,"options.countries must be a CountryCollection"),o.requiredOfPrototype(t.cardTokens,f,"options.cardTokens must be a PaymentCardTokenCollection"),o.requiredOfPrototype(t.cartItemFactory,A,"options.cartItemFactory must be a CartItemFactory"),o.requiredOfPrototype(t.addressFactory,S,"options.addressFactory must be an AddressFactory"),o.requiredOfPrototype(t.tcContractFactory,F,"options.tcContractFactory must be a TCContractFactory"),o.requiredOfPrototype(t.virtualIbanFactory,P,"options.virtualIbanFactory must be a VirtualIbanFactory"),t.buyerType===a.COMPANY&&(o.requiredOfPrototype(t.company,u,"options.company must be a CompanyModel"),o.requiredOfPrototype(t.companyAddresses,C,"options.companyAddresses must be a AddressCollection")),this.me=t.me,this.company=t.company,this.cart=t.cart,this.cartQuote=t.cartQuote,this.cartPsp=t.cartPsp,this.personAddresses=t.personAddresses,this.companyAddresses=t.companyAddresses,this.countries=t.countries,this.cardTokens=t.cardTokens,this.cartItemFactory=t.cartItemFactory,this.addressFactory=t.addressFactory,this.tcContractFactory=t.tcContractFactory,this.virtualIbanFactory=t.virtualIbanFactory,this.billingAddressHelper=t.billingAddressHelper,this.locale=t.locale||"fr-FR",this.service=t.service,this.bankTransferActive=t.bankTransferActive,this.periodicitiesAlreadyPurchased=t.periodicitiesAlreadyPurchased,this.hasCountryChanged=t.hasCountryChanged,this.state=e.is(this.cart.get("BillTo"))&&""!==this.cart.get("BillTo")?V.PAGE_DISPLAYED:V.LOADING,t.service===i.IFWELOOP||t.service===i.SUBSCRIPTIONS?(o.requiredOfPrototype(t.softwareAgreement,p,"options.softwareAgreement must be a SoftwareAgreementModel"),this.softwareAgreement=t.softwareAgreement):t.service===i.CLICK_AND_BUY?(o.requiredOfPrototype(t.softwareAgreement,p,"options.softwareAgreement must be a SoftwareAgreementModel"),o.requiredOfPrototype(t.tcDocumentFactory,M,"options.tcDocumentFactory must be a TCDocumentFactory"),this.softwareAgreement=t.softwareAgreement,this.tcDocumentFactory=t.tcDocumentFactory):t.service===i.INNOVATE?(o.requiredOfPrototype(t.shop,m,"options.shop must be a ShopModel"),o.requiredOfPrototype(t.tcDocumentFactory,M,"options.tcDocumentFactory must be a TCDocumentFactory"),o.requiredOfPrototype(t.softwareAgreement,p,"options.softwareAgreement must be a SoftwareAgreementModel"),this.shop=t.shop,this.tcDocumentFactory=t.tcDocumentFactory,this.softwareAgreement=t.softwareAgreement):(o.requiredOfPrototype(t.shop,m,"options.shop must be a ShopModel"),o.requiredOfPrototype(t.tcDocumentFactory,M,"options.tcDocumentFactory must be a TCDocumentFactory"),this.shop=t.shop,this.tcDocumentFactory=t.tcDocumentFactory),this.alert=this._createAlert(),this.cartQuoteLink=this._createQuoteLink(),this.orderSummarySection=this._createOrderSummarySection(),this.couponSection=this._createCouponSection(),this.billingInfoSection=this._createBillingInfoSection(),this.orderAddressForm=this._createOrderAddressForm(),this.paymentMethodSection=this._createPaymentMethodSection(),this.legalSection=this._createLegalSection(),this._sendTrackingPage()},render(){let t;return this.state===V.NEW_ADDRESS_FORM?t=[this.alert,this.orderAddressForm.render()]:(t=[this.alert,this.cartQuoteLink.render(),this.orderSummarySection.render(),e.is(this.couponSection)?this.couponSection.render():null,this.billingInfoSection.render(),this.paymentMethodSection.render(),this.legalSection.render()],this.service===i.CLICK_AND_BUY&&this.hasCountryChanged&&t.unshift(this._displayCountryInfoMessage())),this.container.setContent(t),this.state===V.LOADING&&s.mask(this.container),this},isValid(){const t=!e.is(this.couponSection)||this.couponSection.isValid();return this.billingInfoSection.isValid()&&this.paymentMethodSection.isValid()&&this.legalSection.isChecked()&&t},save(){if(this.isValid()){const e=this.paymentMethodSection.getPaymentMethod();return this.legalSection.save().then(O.preparePayment.bind(null,{me:this.me,cart:this.cart,cartPsp:this.cartPsp,cartQuote:this.cartQuote,virtualIbanFactory:this.virtualIbanFactory,service:this.service,paymentInfo:e}))}return this.alert.add({className:"error",message:U.get("errorFieldsInfo")}).show(),r.reject()},changeState(e){this.state!==e&&(this.state=e,this.state!==V.LOADING?(s.unmask(this.container),this.render()):s.mask(this.container),this.dispatchEvent(H.STATE_CHANGE,this.state))},destroy(){this.stopListening(),this.cartQuoteLink.destroy(),this.orderSummarySection.destroy(),this.couponSection&&this.couponSection.destroy(),this.billingInfoSection.destroy(),this.orderAddressForm.destroy(),this.paymentMethodSection.destroy(),this.legalSection.destroy(),this.billingAddressHelper=null,this.me=null,this.cart=null,this.cartQuote=null,this.cartPsp=null,this.addresses=null,this.countries=null,this.cardTokens=null,this.cartItemFactory=null,this.addressFactory=null,this.tcContractFactory=null,this.virtualIbanFactory=null,this._parent(),this.container=null},_saveNewAddress(){this.changeState(V.LOADING),this.orderAddressForm.save().then(e=>(this.companyAddresses&&e.isCompanyAddress?this.companyAddresses.push(e):this.personAddresses.push(e),this._updateBillingAddress(e))).then(()=>{this.changeState(V.PAGE_DISPLAYED)}).catch(()=>{this._showBillingInfoUpdateError(),this.changeState(V.NEW_ADDRESS_FORM)})},_updateBillingAddress(e){return this.billingAddressHelper.patchBillingAddress(e).then(({hasCountryChanged:e})=>{this.hasCountryChanged=e,this.billingAddressHelper.isCompanyBuyer()||this.cart.getPaymentMethod()!==d.PaymentMethods.DEFERRED_BANK_TRANSFER||this.cart.setPaymentMethod(d.PaymentMethods.BANK_CARD)}).then(this._sendTrackingEvent.bind(this,"Billing.InformationSent")).catch(this._showBillingInfoUpdateError.bind(this))},_showBillingInfoUpdateError(e){console.error(e);const t=Object.prototype.isPrototypeOf.call(Error.prototype,e)&&e.message.length>0?e.message:U.get("errorBillingInfo");this.alert.add({className:"error",message:t}).show()},_hidePaymentMethod(e){!1!==e?this.paymentMethodSection.hide():this.paymentMethodSection.show()},_updatePaymentCoupon(){return this.paymentMethodSection.updatePaymentCoupon()},_checkPaymentMethodWithCoupon(){this.service===i.CLICK_AND_BUY&&this.paymentMethodSection.checkPaymentMethodWithCoupon()},_onQuoteDownloadOk(){this._sendTrackingEvent("Billing.QuoteDownloaded"),this.dispatchEvent(H.QUOTE_DOWNLOADED)},_onQuoteDownloadError(){this._sendTrackingEvent("Billing.QuoteDownloadFailed"),this.alert.add({className:"error",message:U.get("quoteDownloadFailed")}).show()},_displayCountryInfoMessage:()=>e.createElement("div",{class:"alert-message alert-primary alert-has-icon",html:[e.createElement("span",{class:"icon fonticon"}),e.createElement("span",{text:U.get("cartUpdatedWithBillingInfo")})]}),_onChangePaymentMethodError(t){const r=e.is(t)&&"Error.BankTransferNotAllowed"===t.errorCode?e.is(t.errorMsg)?t.errorMsg:U.get("bankTransferNotAllowed"):U.get("errorPaymentMethod");this.scroller.scrollTo(0,0,200),this.alert.add({className:"error",message:r}).show()},_dispatchValidity(){this.dispatchEvent(this.isValid()?H.VALID:H.INVALID)},_createAlert:()=>new n({visible:!1,autoHide:!0,hideDelay:5e3}),_createQuoteLink(){const e=new b({quote:this.cartQuote});return this.listenTo(e,b.Events.CLICKED,this._sendTrackingEvent.bind(this,"Billing.DownloadQuoteClicked")),this.listenTo(e,b.Events.ERROR,this._onQuoteDownloadError.bind(this)),this.listenTo(e,b.Events.QUOTE_DOWNLOADED,this._onQuoteDownloadOk.bind(this)),e},_createCouponSection(){const e=this.service===i.MAKE&&this.cartPsp.getPsp()===y.Psp.STRIPE,t=this.service===i.CLICK_AND_BUY;if(e||t){const e=new I({service:this.service,cart:this.cart,title:U.get("addCoupon"),locale:this.locale});return this.listenTo(e,I.Events.VALID,this._dispatchValidity.bind(this)),this.listenTo(e,I.Events.INVALID,this._dispatchValidity.bind(this)),this.listenTo(e,I.Events.HIDE_PAYMENT_METHOD_SECTION,this._hidePaymentMethod.bind(this,!0)),this.listenTo(e,I.Events.SHOW_PAYMENT_METHOD_SECTION,this._hidePaymentMethod.bind(this,!1)),this.listenTo(e,I.Events.COUPON_ADDED,this._updatePaymentCoupon.bind(this)),this.listenTo(e,I.Events.COUPON_REMOVED,this._updatePaymentCoupon.bind(this)),e}},_createOrderSummarySection(){return new T({title:U.get("orderSummaryTitle"),cart:this.cart,cartItemFactory:this.cartItemFactory,service:this.service,locale:this.locale})},_createBillingInfoSection(){const e=new v({me:this.me,company:this.company,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,billingAddressHelper:this.billingAddressHelper,addressFactory:this.addressFactory,cart:this.cart,cartPsp:this.cartPsp,countries:this.countries,service:this.service,title:U.get("billingInformation")});return this.listenTo(e,v.Events.NEW_ADDRESS_FORM,this.changeState.bind(this,V.NEW_ADDRESS_FORM)),this.listenTo(e,v.Events.VALID,this._dispatchValidity.bind(this)),this.listenTo(e,v.Events.INVALID,this._dispatchValidity.bind(this)),this.listenTo(e,v.Events.ADDRESS_SELECTION,e=>{this.changeState(V.LOADING),this._updateBillingAddress(e).finally(this.changeState.bind(this,V.PAGE_DISPLAYED))}),e},_createOrderAddressForm(){const e=this.service===i.CLICK_AND_BUY;let t,r=this.countries;if(e&&(this.cart.hasMakerItems()||this.cart.hasEduItems())){const e=this.personAddresses&&this.personAddresses.first().getCountry(),s=this.companyAddresses&&this.companyAddresses.first().getCountry();(r=this.countries.clone()).reset(this.countries.filter(t=>t.getIso3()===s||t.getIso3()===e)),t=r.first().getIso3()}const s=new N({billingAddressHelper:this.billingAddressHelper,company:this.company,countries:r,addressFactory:this.addressFactory,presetCountry:t});return this.listenTo(s,N.Events.SAVE,this._saveNewAddress.bind(this)),this.listenTo(s,N.Events.CANCEL,()=>{this._sendTrackingEvent("Billing.CancelClicked"),this.changeState(V.PAGE_DISPLAYED)}),s},_createPaymentMethodSection(){const e=new B({billingAddressHelper:this.billingAddressHelper,cart:this.cart,service:this.service,title:U.get("paymentMethodTitle"),cardTokens:this.cardTokens,bankTransferActive:this.bankTransferActive,cartPsp:this.cartPsp});return this.listenTo(e,B.Events.VALID,this._dispatchValidity.bind(this)),this.listenTo(e,B.Events.INVALID,this._dispatchValidity.bind(this)),this.listenTo(e,B.Events.ON_CHANGE_METHOD_ERROR,this._onChangePaymentMethodError.bind(this)),e},_createLegalSection(){let e;const t=this.billingAddressHelper.getBuyer();return e=this.service===i.IFWELOOP||this.service===i.SUBSCRIPTIONS?new w({service:this.service,cart:this.cart,cartItems:this.cartItemFactory.createCollection("",this.cart.getItems()),buyer:t,softwareAgreement:this.softwareAgreement,tcContractFactory:this.tcContractFactory}):this.service===i.CLICK_AND_BUY?new L({cart:this.cart,buyer:t,softwareAgreement:this.softwareAgreement,tcContractFactory:this.tcContractFactory,tcDocumentFactory:this.tcDocumentFactory}):this.service===i.INNOVATE?new R({cart:this.cart,shop:this.shop,buyer:t,billingAddressHelper:this.billingAddressHelper,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,softwareAgreement:this.softwareAgreement}):new k({service:this.service,billingAddressHelper:this.billingAddressHelper,shop:this.shop,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,cartItems:this.cartItemFactory.createCollection("",this.cart.getItems()),cart:this.cart}),this.listenTo(e,"validSection",this._dispatchValidity.bind(this)),this.listenTo(e,"invalidSection",this._dispatchValidity.bind(this)),e},_sendTrackingPage:function(){const e=this.billingAddressHelper.getBuyer(),t=this.billingAddressHelper.getBuyerType(),r=D.createPageBuilder({url:"/checkout/OrderSummary"}).addDimension(E.MARKETPLACE_SERVICE,this.serviceRequest);l.addTrackerInformation(r,this.cart),r.addDimension(E.BUYER_ID,e.id).addDimension(E.BUYER_TYPE,t.name).addDimension(E.PSP,this.cartPsp.getPsp()).send()},_sendTrackingEvent:function(e){const t=this.billingAddressHelper.getBuyer(),r=this.billingAddressHelper.getBuyerType(),s=D.createEventBuilder({category:"Checkout",action:e}).addDimension(E.MARKETPLACE_SERVICE,this.serviceRequest);l.addTrackerInformation(s,this.cart),s.addDimension(E.BUYER_ID,t.id).addDimension(E.BUYER_TYPE,r.name).addDimension(E.PSP,this.cartPsp.getPsp()).send()}});return Q.States=V,Q.Events=H,Q});