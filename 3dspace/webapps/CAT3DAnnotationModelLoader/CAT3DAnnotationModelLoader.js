/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationLoader",["UWA/Class","UWA/Core","DS/Visualization/Node3D","DS/Visualization/LoaderUtils","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/GenericOverride","DS/Visualization/PathElement","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationModel/CAT3DAnnotationNode","DS/CAT3DAnnotationModel/CAT3DAnnotationViewNode","DS/CAT3DAnnotationModel/CAT3DAnnotationSetNode","DS/CAT3DAnnotationModel/CAT3DAnnotationRootNode","DS/CAT3DAnnotationModel/CAT3DAnnotationCaptureNode","DS/CAT3DAnnotationModel/CAT3DAnnotationDIFCaptureNode","DS/CAT3DAnnotationModel/CAT3DAnnotationAttributeNode"],function(e,t,n,o,i,a,r,l,s,d,f,c,h,g,u,p){"use strict";return e.extend({init:function(e){var A=e||{};this._parent(A);var v=this;let S=s.getPreference("CATWebUXMePreferences_Units"),T=!0;var D=function(e){if(e.getNodeType&&"Mesh3D"===e.getNodeType())return e;for(var t=e.children,n=0;n<t.length;n++){var o=D(t[n]);if(o)return o}},C=function(e){e.setPickParent&&e.setPickParent(!0);for(var t=e.children,n=0;n<t.length;n++)C(t[n])},m=function(e,t,n){t&&8===t.getAnnotationSupertype()||e.disableClipping(!0),n&&n.textureInBlack&&e.whiteVectorInBlack&&e.whiteVectorInBlack();var o=D(e);if(o&&(o.setShadow(!1,!1),o.setSSAO(!1),o.setVisibilityInTree(!1)),C(e),t){var i=e.children[0].isVisible();e.children[0].setVisibility(!0);var a=e.getBoundingSphere();(a.radius>0||a.pixelRadius>0)&&(t.addChild(e),t.setVisibility(i))}};function b(e){if(!e)return;let t=e.createOverrideSetManager(),n=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(n);let o=n.createOverride(new r([e]));o&&(o.setColor(a.NO_COLOR,!0),o.setOpacity(a.NO_OPACITY,!0),o.resetMaterial())}function y(e,t,i){if(t[e]&&t[e].reps){var a=new n(t.name+"_"+e);i&&a.disableClipping(!0),o.processData([a],t[e],void 0,!0);var r=D(a);return r&&(r.setVisibilityInTree(!1),r.setShadow(!1,!1),r.excludeFromHighlight(!0,!0),r.setNoZ(!1)),b(a),a}}this.hasTheTextBeenProcessed=function(){return T},this.createAnnotationSet=function(e,n){for(var o=new c(t.extend(n,{onAnnotationAttrModifiedCB:e},!0)),i=0;i<12;i++){var a=new h({rootType:i+1});a.setVisibility(i+1!==11),o.addChild(a)}return b(o),o},this.postProcessViewsAndCaptures=function(e){var t,n,o,i=e.getRootAnnotationNode("RootCaptures"),a=e.getRootAnnotationNode("RootViews");if(a&&a.children.length)for(t=0;t<a.children.length;t++){var r=(o=a.children[t]).getMultiSectionData?o.getMultiSectionData():null;if(r&&r.views)for(n=0;n<r.views.length;n++)a.children[r.views[n]-1].setIsSubView(!0)}if(i&&i.children.length&&a&&a.children.length)for(t=0;t<i.children.length;t++){var l=i.children[t],s=l.getPointedView();if(s)for(n=0;n<a.children.length;n++)(o=a.children[n]).getAnnotationID()===s&&o.setAssociatedCapture(l.getAnnotationID())}},this.buildAnnotVisualization=function(e){if(e&&e.buildVisualization){var t=e.getAttributeParam();"4"===e.getAttributeCategory()?14!==e.getAttributeType()&&32!==e.getAttributeType()||t&&t.length&&t.forEach(function(t){"ANGLE"===t.Magnitude&&(t.Nls=l.convertUnitValueToString(t.Value,"Angle",S.Angle,S.AngleCalcDisplay,S.TrailingZeros,{displaySymbol:14!==e.getAttributeType()})),"LENGTH"===t.Magnitude&&(t.Nls=l.convertUnitValueToString(t.Value,"Length",S.Length,S.LengthCalcDisplay,S.TrailingZeros,{displaySymbol:!0,displaySpace:!0}))}):"6"===e.getAttributeCategory()&&(4!==e.getAttributeType()&&5!==e.getAttributeType()&&6!==e.getAttributeType()||t&&t.length&&t.forEach(function(e){"LENGTH"===e.Magnitude&&(e.Nls=l.convertUnitValueToString(e.Value,"Length",S.Length,S.LengthCalcDisplay,S.TrailingZeros,{displaySymbol:!0,displaySpace:!0}))})),e.buildVisualization(t)}},this.loadAnnotation=function(e){var t,a,r,l=function(t,n,o){var i=Object.keys(t);if(i.length){for(var a,r={category:o,onAnnotationAttrModifiedCB:"TPSAttribute"===t.nodeXMLtype?e.cb:function(){}},s=0;s<i.length;s++)"childrenAttr"===i[s]?a=t[i[s]]:r[i[s]]=t[i[s]];var d=new p(r);n.addChild(d);var f=[];if("6"===d.getAttributeCategory()&&31===d.getAttributeType()){var c=d.getAttributeParam();c&&c.length&&(f=c.slice()).push({Name:"CSName",Value:d.getAnnotationName()})}if(a&&a.length)for(var h=0;h<a.length;h++)a[h].params=a[h].params?a[h].params.concat(f):f,l(a[h],d,o);v.buildAnnotVisualization(d)}};if(6!==e.nodeInfo.type){if("AnnotationSet"===e.nodeInfo.nodeXMLtype){if((e.nodeInfo.standards||e.nodeInfo.standardNorms)&&(e.annotationSetNode.getSemanticStandards=function(){return{standards:e.nodeInfo.standards,defaultSpecs:e.nodeInfo.standardNorms,stdName:e.nodeInfo.standard}}),e.nodeInfo.hyperlinksData&&e.nodeInfo.hyperlinksData.length){var c=[];for(t=0;t<e.nodeInfo.hyperlinksData.length;t++)e.nodeInfo.hyperlinksData[t].type>0&&2&e.nodeInfo.hyperlinksData[t].type&&c.push(e.nodeInfo.hyperlinksData[t]);c.length&&(e.annotationSetNode.getLinkedDataRelatedInfos=function(){return c})}}else if("TPSAttribute"===e.nodeInfo.nodeXMLtype||"TPSAttributes"===e.nodeInfo.nodeXMLtype){if(!e.nodeInfo.tpsID){var h=e.annotationSetNode.getRootAnnotationNode("RootAttributes").children,u=0;for(t=0;t<h.length;t++)e.annotationSetNode.getRootAnnotationNode("RootAttributes").children[t].isRootAttribute()&&u++;e.nodeInfo.isRootAttribute=!0,e.nodeInfo.type=47,e.nodeInfo.tpsID="root_"+u}l(e.nodeInfo,e.annotationSetNode.getRootAnnotationNode("RootAttributes"),e.nodeInfo.category)}else{var A=Object.keys(e.nodeInfo);if(A.length){for(var S={onAnnotationAttrModifiedCB:e.cb,reps:[]},D=0;D<A.length;D++)if("cappingRep"===A[D])S.cappingRep=y("cappingRep",e.nodeInfo,!0);else if("surfaceNormalRep"===A[D])S.surfaceNormalRep=y("surfaceNormalRep",e.nodeInfo);else if("planeInfos"===A[D]){var C=e.nodeInfo.planeInfos.direction;S.viewDirection=new i.Vector3(C.x,C.y,C.z);var b=e.nodeInfo.planeInfos.normal;S.viewNormal=new i.Vector3(b.x,b.y,b.z);var L=e.nodeInfo.planeInfos.origin;S.viewOrigin=new i.Vector3(L.x,L.y,L.z)}else S[A[D]]=e.nodeInfo[A[D]];if(r=-1,"TPS"===e.nodeInfo.nodeXMLtype||"TPSCG"===e.nodeInfo.nodeXMLtype?r=(a=new d(S)).getAnnotationSupertype()+1:"TPSView"===e.nodeInfo.nodeXMLtype?(r=0,a=new f(S)):"TPSCap"===e.nodeInfo.nodeXMLtype&&(r=1,a=new g(S)),-1===r||!e.annotationSetNode||!e.annotationSetNode.children[r]||(!(F=a)||null===F.getAnnotationType()||void 0===F.getAnnotationType()||isNaN(F.getAnnotationType())||"tps"===F.getAnnotationClassType()&&(F.getAnnotationType()>56||F.getAnnotationType()<=0))||(e.annotationSetNode.children[r].addChild(a),e.nodeInfo.rootIndex=r),-1===e.nodeInfo.nodeXMLtype.indexOf("TPSAttribute")&&(void 0!==e.nodeInfo.toleranceZoneValue&&(a.getAnnotationToleranceZoneValue=function(){return e.nodeInfo.toleranceZoneValue}),void 0!==e.nodeInfo.dimensionLimits&&(a.getAnnotationDimensionLimits=function(){return e.nodeInfo.dimensionLimits}),void 0!==e.nodeInfo.genTol&&(a.getGeneralTolerance=function(){return e.nodeInfo.genTol}),void 0!==e.nodeInfo.tabLimit&&(a.getTabulatedLimit=function(){return e.nodeInfo.tabLimit}),e.nodeInfo.hyperlinksData&&e.nodeInfo.hyperlinksData.length)){var P=[];for(t=0;t<e.nodeInfo.hyperlinksData.length;t++)e.nodeInfo.hyperlinksData[t].type>0&&2&e.nodeInfo.hyperlinksData[t].type&&P.push(e.nodeInfo.hyperlinksData[t]);P.length&&(a.getLinkedDataRelatedInfos=function(){return P})}e.nodeInfo.reps&&(x=e.nodeInfo,I=e.processText,N=e.annotationSetNode.getContextType(),R=a,E={textureInBlack:s.getPreference("CATWebUXMePreferences_WhiteVectorAsBlack"),edgeTransparency:1!==N&&2!==N&&3!==N,processText:I},x.reps[0]&&x.reps[0].reps&&(M=new n,o.processData([M],x.reps[0],void 0,!0,E,function(){m(M,R,E)})),x.reps[1]&&x.reps[1].reps&&(T=!1,O=new n,o.processData([O],x.reps[1],void 0,!0,E,function({textHasBeenProcessed:e}={}){T=e||T,m(O,R,E)})))}}var x,I,N,R,M,O,E,F;if("TTRS"===e.nodeInfo.nodeXMLtype)e.annotationSetNode.addTTRS(e.nodeInfo);else if("RefFrame"===e.nodeInfo.nodeXMLtype)e.annotationSetNode.addReferenceFrame(e.nodeInfo);else if(a){if(void 0!==e.nodeInfo.val){var V=a.getAnnotationSupertype();1!==V&&2!==V&&8!==V&&9!==V&&(a.getAnnotationToleranceValue=function(){return e.nodeInfo.val})}void 0!==e.nodeInfo.trep&&(a.getAnnotationTTRSRep=function(){return e.nodeInfo.trep}),void 0!==e.nodeInfo.ref&&(a.getAnnotationReferenceFrame=function(){return e.nodeInfo.ref}),void 0!==e.nodeInfo.def&&(a.isDefaultAnnotation=function(){return 0!==e.nodeInfo.def}),void 0!==e.nodeInfo.grou&&(a.getGeometricalAttachmentList=function(){return e.nodeInfo.grou}),void 0!==e.nodeInfo.datumTargets&&(a.getDatumTargetList=function(){return e.nodeInfo.datumTargets}),void 0!==e.nodeInfo.associatedBasicDims&&(a.getAssociatedBasicDims=function(){return e.nodeInfo.associatedBasicDims}),void 0!==e.nodeInfo.auxiliaryFeatures&&(a.getAuxiliaryFeatures=function(){return e.nodeInfo.auxiliaryFeatures})}}},this.loadDIFAnnotation=function(e){if(e&&e.infos&&e.type&&e.annotSet&&"DIFCapture"===e.type){let t=e.annotSet.getRootAnnotationNode("RootCaptures");t&&(m(e.infos.visuinfo.node3D),t.addChild(new u({name:e.infos.Name,uuid:e.infos.ID||e.infos.iD,representation:e.infos.visuinfo.node3D,plane:e.infos.visuinfo.plane,up:e.infos.visuinfo.up})))}}}})}),define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader",["UWA/Class","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/Visualization/AnnotationServices","DS/WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/CoreEvents/ModelEvents","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADSettingsMgt","DS/Visualization/PathElement","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationLoader","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/DibUDLWebLoader/CATDibUDLWebLoaderForAnnotationSet","DS/PADUtils/PADUtilsServices","i18n!DS/CAT3DAnnotationModelLoader/assets/nls/CAT3DAnnotationModelLoader"],function(e,t,n,o,i,a,r,l,s,d,f,c,h,g,u,p,A,v){"use strict";const S={CATFTASetCtxTypeV5Std:1,CATFTASetCtxTypeV5ARM:2,CATFTASetCtxTypeV5Prd:3,CATFTASetCtxTypeV6Std:4,CATFTASetCtxTypeV6Prd:5};var T=e.extend({init:function(e){this._parent(e);var T,D=this,C=new r,m=0,b=e.ctxViewer,y=e.favoriteCtxManager,L=null,P=new o,x=[],I=null,N=0,R=!1;let M=0;var O=[],E=[],F={},V=[],w=[],k=[],U=[],W=[],B=[],X=[];let _=[],G=[];var z,q,j=[],Z={},H=0,J=0,Y=!1,K=!1,Q=[],$=null;function ee(e,t){if(!t.length)return e;if(e)for(var n=e.getChildrenPathes(),o=0;o<n.length;o++)if(h.getNodeID(n[o].getLastElement(!0))===t[0])return ee(n[o],t.splice(1,t.length-1))}function te(e,t){if(e&&e.length){for(var n=[],o=e.length-1;o>=0;o--)-1!==B.indexOf(e[o])&&(n.push(e[o]),B.splice(B.indexOf(e[o]),1));if(n.length){var i=b.getController();n.forEach(function(e){i.unlockRepresentationMeshInRAM(e)}),i.unlockNodes({ids:e}),i.setForceReferencesLoad({data:e.map(function(e){return{id:e,state:!1}})})}}t&&t()}function ne(e,t,n,o,i){return new Promise(a=>{let r=0;const l=function(t){(r+=t)===e.length&&a()},s=function(e){if(e&&e.ignoredIds&&e.ignoredIds.length){let t=[];e.ignoredIds.forEach(function(e){let n=E.indexOf(e);-1!==n&&E.splice(n,1),t.push(e)}),te(t),l(t.length)}},d=function(e){if(m&&e&&e.node){let t=h.getNodeID(e.node);if(t){let a=E.indexOf(t);if(-1!==a&&E.splice(a,1),e.xml)if(!F[t]||F[t]&&!F[t].embeddedSetLoaded){F[t]||(F[t]={embeddedSetLoaded:!0});const a=i&&i[t]?i[t]:void 0;Pe(e.node,e.xml,n,o,a).then(function(){l(1)})}else te([t]),l(1);else te([t]),l(1)}}};"refresh"===t?b.getController().refreshGeometry({ids:e,applicativeContainers:{V4V5_FDT:{errorCallBack:d,doneCallback:d}},onComplete:s,onFailure:s,onTimeout:s}):b.getController().switchNodeVisuStreamOnDemand({data:e.map(function(e){return{node:b.getController().getNode({id:e}),stream:"cgr"}}),applicativeContainers:{V4V5_FDT:{errorCallBack:d,doneCallback:d}},callbacks:{onURLLoad:function(){},onComplete:s,onFailure:s,onTimeout:s}})})}function oe(e,t){var n=[];if(e.externalPath.forEach(function(e){e.treeOrder||!h.isInstance(e)&&!h.isRepInstance(e)||n.push(h.getNodeID(e))}),n.length&&"3DXML"!==h.getLoadedAssetType()){var o=function(){M--,t&&t()},i=["TreeOrder","ro.plminstance.V_treeorder"];M++,b.getController().getAttributes({ids:n,attributes:i,callbacks:{onComplete:function(e){if(m){for(var t,a=0;a<n.length;a++)(t=e[n[a]][i[0]]?e[n[a]][i[0]]:e[n[a]][i[1]])&&(b.getController().getNode({id:n[a]}).treeOrder=parseFloat(t));o()}else M--},onFailure:o,onTimeout:o}})}else t&&t()}this.setActiveState=function(e){if(P&&e!==m&&(0===m||1===m||2===m)){if(m=e,K=!0,Le(),1===e||2===e){L||(L=new g),ye(),Z.onRemoveRoot||(Z.onRemoveRoot=b.subscribe({event:"onRootRemoved"},ge),Z.on3DPlayAssetChanged=b.subscribe({event:"on3DPlayAssetChanged"},function(){ge({path:b.getRootBagPath()})}),Z.onRootAttached=b.subscribe({event:"onRootAttached"},ue),Z.onRootDetached=b.subscribe({event:"onRootDetached"},pe),Z.onHide=b.subscribe({event:"onHide"},Se),Z.onShow=b.subscribe({event:"onShow"},Te),Z.onRefreshBegin=b.subscribe({event:"onRefreshBegin"},De),Z.onRefreshCompleted=b.subscribe({event:"onRefreshCompleted"},Ce)),1!==e||Z.onAddRoot||(y&&(J=y.subscribe({event:"onFavoriteContextLoading"},de)),Z.onAddRoot=b.subscribe({event:"onRootAdded"},he),Z.onLoadingComplete=b.subscribe({event:"onLoadingComplete"},ve),H=c.subscribe("onPreferenceModified",se),re());var t=b.getController().getDefaultLoadModelOptions();(z=t?t.CGRWithSG:void 0)||(t?t.CGRWithSG=!0:t={CGRWithSG:!0},b.getController().setDefaultLoadModelOptions(t)),ce(),(q=u.getPreferenceManager({context:b.getFrameWindow()}))&&($=q.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)if("cke"===t.repositories[e].name)for(let n=0;n<t.repositories[e].preferences.length;n++){let o=t.repositories[e].preferences;["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"].includes(o[n].name)&&Ie()}})),T=b.getViewer().antiAliasing,b.getViewer().setAntiAliasing("MSAA")}else{if(T&&T!==b.getViewer().antiAliasing&&"MSAA"===b.getViewer().antiAliasing&&b.getViewer().setAntiAliasing(T),q&&($&&(q.unsubscribe($),$=null),u.unreferencePreferenceManager({context:b.getFrameWindow()}),q=null),!z){var n=b.getController().getDefaultLoadModelOptions();n||(n={}),n.CGRWithSG=void 0,b.getController().setDefaultLoadModelOptions(n)}var o;N>0&&(N=1,Ve());var i=Object.keys(Z);for(o=0;o<i.length;o++)b.unsubscribe(Z[i[o]]);if(Z={},H&&(c.unsubscribe(H),H=0),J&&y&&(y.unsubscribe(J),J=0),w.splice(0,w.length),V.length){for(o=V.length-1;o>=0;o--)V[o].annotationSetNode.parents[0].removeChild(V[o].annotationSetNode);var a=V.map(e=>e.annotationSetNode);V.length=0,Ee("onAnnotationSetRemoved",{nodes:a})}O.forEach(e=>{e&&e.resolve&&e.resolve()}),O.length=0,te(B),B.length=0,U.length=0,W.length=0,G.length=0,_.length=0,F={},E.length=0,Q.length=0,M=0,b.getViewer().render()}Ee("onAnnotModelLoaderActiveStateChanged",{state:e}),K=!1}},this.clear=function(){D.setActiveState(0),b=L=P=D=C=Z=null,x=w=O=null,E=F=G=_=V=W=X=null},this.getActiveState=function(){return m},this.removeDIFAnnotationSet=function({id:e}){if(V.length){let t=[];for(let n=V.length-1;n>=0;n--)if(V[n].annotationSetNode.getAnnotationUuid()===e){V[n].annotationSetNode.parents[0].removeChild(V[n].annotationSetNode),t.push(V[n].annotationSetNode);let e=h.getNodeID(V[n].fatherNode);-1!==_.indexOf(e)&&_.splice(_.indexOf(e),1),V.splice(n,1);break}t.length&&(w.length=0,Ee("onAnnotationSetRemoved",{nodes:t}))}},this.getOrderedAnnotationSetPaths=function(){var e=[];if(!m)return e;var t=b.getRootBagPath();if(0===w.length){var n=[],o=[];V.forEach(function(e){let t=e.annotationSetNode;var n,i;k.some(function(o){if(o.getLastElement(!0)===e.fatherNode)return i=o.clone(),t.parents[0]===b.getDecorationBag()?n=fe(t):(n=o.clone()).addElement(t),!0}),n||(n=fe(t))&&(i=t.parents[0]!==b.getDecorationBag()?n.getParentPath():fe(e.fatherNode)),n&&i&&o.push({annotSetPath:n,referencePath:i})});for(var i=0;i<o.length;i++){var a=!0;for(let e=0;e<W.length;e++)if(W[e].path.isAParentOf(o[i].referencePath)){a=!1;break}a&&n.push(o[i])}var r=function(e){var t=e.getLastElement(!0);if(t.getTreeOrder?t.getTreeOrder():t.treeOrder)return!0;for(var n=e.getChildrenPathes(),o=0;o<n.length;o++){if(!0===r(n[o]))return!0}},l=function(e){for(var n=[],o=e;!o.isEqual(t);){var i=o.getLastElement(!0),a=i.getTreeOrder?i.getTreeOrder():i.treeOrder;a=a||0,n.splice(0,0,a),o=o.getParentPath()}return n},s=function(e,t){if(0===e.length)return!0;if(0===t.length)return!1;for(var n=Math.max(e.length,t.length),o=0;o<n;o++)if(e[o]!==t[o])return e[o]>t[o];return!1};o=[];for(var d=function(e){var t=!0;for(let i=0;i<n.length;i++)if(e.isEqual(n[i].referencePath)){for(let e=0;e<o.length;e++)if(o[e].annotSetPath.isEqual(n[i].annotSetPath)){t=!1;break}n[i]&&t&&o.push(n[i]);break}let i=e.getChildrenPathes();for(let e=0;e<i.length;e++)d(i[e])},f=t.getChildrenPathes(),c=0;c<f.length;c++){var h;if(o=[],r(f[c])){var g=[];for(h=0;h<n.length;h++)f[c].isAParentOf(n[h].referencePath)&&g.push({index:l(n[h].referencePath.getParentPath()),data:n[h]});var u=[];for(h=0;h<g.length;h++){var p=g[h].index,A=g[h].data;if(0===o.length)o.push(A),u.push(p);else{var v=!1;for(let e=0;e<u.length&&s(p,u[e]);e++){if(e===u.length-1){o.push(A),u.push(p),v=!0;break}if(s(u[e+1],p)){o.splice(e+1,0,A),u.splice(e+1,0,p),v=!0;break}}v||(o.splice(0,0,A),u.splice(0,0,p))}}}else d(f[c]);w=w.concat(o)}}if(w&&w.length)for(var S=0;S<w.length;S++)e.push(w[S]);return e},this.getLoadedAnnotationSets=function(){return V.map(e=>e.annotationSetNode)},this.subscribe=function(e,t){if(e&&t)return C.subscribe({event:e},t)},this.unsubscribe=function(e){C&&e&&C.unsubscribe(e)},this.isRunning=function(){return M>0},this.hasAlreadyBeenLoaded=function(e,t){return!!e&&(t?-1!==X.indexOf(e):-1!==G.indexOf(e)||-1!==_.indexOf(e))},this.setAnnotationSetFavoriteCtxPath=function(e){if(e){var t,n=!1;for(t=0;t<k.length;t++)k[t].getLastElement(!0)===e.getLastElement(!0)&&(c.removeA3EWidgetPref({path:k[t],pref:"A3EAnnotSetsLoaded"}),k[t]=e.clone(),n=!0);n||(k.push(e.clone()),oe(e)),w.length=0,D.getOrderedAnnotationSetPaths().forEach(function(t){if(e.isAParentOf(t.referencePath)){var n=t.annotSetPath.getLastElement(!0);c.saveA3EWidgetPref({path:t.annotSetPath,pref:"A3EAnnotSetsLoaded",data:{visibility:n.isVisible(),ctxType:n.getContextType()}})}})}};var ie=function(e,t,n){let o,i=!1,a=e.children;for(o=0;o<a.length;o++)a[o].getAnnotationClassType&&"tpsAnnotationSet"===a[o].getAnnotationClassType()&&(i=!0);if(!i){let o=h.getNodeID(e),i=h.isRepRef(o);if(o&&(i&&-1===G.indexOf(o)||!i&&-1===_.indexOf(o))&&h.getNodeType(e))if(h.is3DLeaf(e)){let n=!0;for(let o=0;o<t.length;o++)if(t[o]===e){n=!1;break}n&&(i?G.push(o):_.push(o),t.push(e))}else if(h.isReference(e)){let t=!0;for(let o=0;o<n.length;o++)if(n[o]===e){t=!1;break}t&&(i?G.push(o):_.push(o),n.push(e))}}if(a&&a.length)for(o=0;o<a.length;o++)ie(a[o],t,n)};function ae(e){if(!e||!m||!e.productIds)return[];let t=[];return e.productIds.forEach(e=>{t.push(new Promise(function(t){let o=function(){let n=E.indexOf(e);-1!==n&&E.splice(n,1),t()};const i=new p;i.getAnnotationSetIDAssociatedToProductID({physicalid:e,serverUrl:A.get3DSpaceUrl(),securityContext:d.getSetting("pad_security_ctx"),onComplete:t=>{if(t&&t.length){const a=[];t.forEach(t=>{a.push(new Promise(o=>{t?i.loadModel({data:{physicalid:t,dataType:"DIFAnnotationSet"},serverUrl:A.get3DSpaceUrl(),securityContext:d.getSetting("pad_security_ctx"),onComplete:()=>{let a=b.getController().getNode({id:e});if(a){let r=function(r){const l=r&&r[t]&&r[t]["ds6w:label"]?r[t]["ds6w:label"]:v.DefaultAnnotationSetName;let s,d=L.createAnnotationSet(le,{name:l,uuid:t});for(let e=0;e<k.length;e++)if(k[e].getLastElement(!0)===a){s=k[e].clone();break}if(s){for(;s&&!h.isInstance(s.getLastElement(!0));)s=s.getParentPath();s&&d.setMatrix((new n.Matrix4).copy(s.getWorldMatrix(b.getViewer())))}b.getDecorationBag().addChild(d),V.push({annotationSetNode:d,fatherNode:a}),F[e]||(F[e]={}),F[e].difSetLoaded=!0,i.getAnnotationSetMBDCaptures({onSuccess:e=>{e&&e.length&&e.forEach(e=>{L.loadDIFAnnotation({infos:e.Childs&&e.Childs.length?e.Childs[0]:e,annotSet:d,type:"DIFCapture"})}),Ee("onAnnotationSetLoaded",{partNode:a,node:d}),b.getViewer().render(),o()}})};b.getController().getAttributes({ids:[t],attributes:["ds6w:label"],callbacks:{onComplete:r,onFailure:r}})}else o()}}):o()}))}),Promise.all(a).then(o)}else o()},onFailure:o})}))}),t}this.loadFTALightModel=async function(e){if(!e||!m||!e.path&&!e.idPath)return;let t,n,o,i,a,r,l,s=e.ctxTypes&&1===e.ctxTypes.length&&e.ctxTypes[0]===S.CATFTASetCtxTypeV5ARM,f=[],c=[],g=[],u=function(e,t){return-1===G.indexOf(e)&&-1===_.indexOf(e)&&(g.push(e),t?G.push(e):_.push(e),!0)},p=function(e,t,n){if(e){let o=e.getReferenceId();u(o)&&e.isRepRef()?-1===t.indexOf(o)&&-1===E.indexOf(o)&&(E.push(o),t.push(o)):(-1===n.indexOf(o)&&-1===E.indexOf(o)&&(E.push(o),n.push(o)),e.getChildren().forEach(function(e){p(e.getReferenceIterator(),t,n)}))}},A=e.idPath?e.idPath[e.idPath.length-1]:e.path?h.getNodeID(e.path.getLastElement(!0)):null;if(!A)return;if(s&&-1!==X.indexOf(A))return;let T,C=h.getLoadedAssetType(),y=e.path?e.path.clone():null,L=function(){if(!y&&e.idPath){let t=ee(b.getRootBagPath(),e.idPath);t&&(y=t.clone(),D.setAnnotationSetFavoriteCtxPath(y))}},P=V.length,x=[];if(!0!==d.getSetting("enopad3dviewer_lightNodeModel")||"3DXML"===C){let d=[],g=[];if(L(),y){if(t=y.getLastElement(!0),e.loadChildren)ie(t,d,g);else if(s||e.ctxTypes&&e.ctxTypes.length){if(h.is3DLeaf(t))u(A)&&d.push(t);else if(h.isReference(t))for(a=t.children,i=0;i<a.length;i++)1===(r=a[i].children).length&&h.isReference(r[0])&&1===(l=r[0].children).length&&h.isRepInstance(l[0])&&h.is3DLeaf(l[0].children[0])&&u(h.getNodeID(l[0].children[0]))&&d.push(l[0].children[0])}else if(u(A))if(h.is3DLeaf(t))d.push(t);else if(h.isReference(t))for(c.push(A),E.push(A),a=t.children,i=0;i<a.length;i++)if(h.isRepInstance(a[i])){let e=a[i].children[0];u(h.getNodeID(e))&&h.is3DLeaf(e)&&d.push(e)}for(o=0;o<d.length;o++)t=d[o],n=h.getNodeID(t),"3DXML"===C?t.xml&&(x.push(Pe(t,t.xml,e.ctxTypes)),t.xml=null):-1===E.indexOf(n)&&(E.push(n),f.push(n));if("3DXML"!==C)for(o=0;o<g.length;o++)n=h.getNodeID(g[o]),-1===E.indexOf(n)&&(E.push(n),f.push(n))}}else{let t=b.getController().createReferenceIterator(A);if(!t)return;if(e.loadChildren)p(t,f,c);else if(s||e.ctxTypes&&e.ctxTypes.length)if(t.isRepRef())u(A)&&-1===E.indexOf(A)&&(E.push(A),f.push(A));else{if(a=t.getChildren(),e.conditions){const e=a.map(e=>e.getReferenceIterator().getReferenceId());T=await new Promise(t=>{b.getController().getAttributes({ids:e,attributes:["ds6w:label"],callbacks:{onComplete:e=>{const n={};e&&Object.keys(e).forEach(t=>{n[t]=e[t]["ds6w:label"]}),t(n)},onFailure:()=>{t(e)}}})})}for(i=0;i<a.length;i++){const e=a[i].getReferenceIterator().getReferenceId();let t=a[i].getReferenceIterator().getChildren();1===t.length&&t[0].getReferenceIterator().isRepRef()&&(n=t[0].getReferenceIterator().getReferenceId(),u(n)&&-1===E.indexOf(n)&&(E.push(n),f.push(n),T&&(T[n]=T[e],delete T[e])))}}else if(u(A))if(t.isRepRef())-1===E.indexOf(A)&&(E.push(A),f.push(A));else for(c.push(A),E.push(A),a=t.getChildren(),i=0;i<a.length;i++)(t=a[i].getReferenceIterator()).isRepRef()&&(n=t.getReferenceId(),u(n)&&-1===E.indexOf(n)&&(E.push(n),f.push(n)))}s&&X.push(A);let I=!1;M++;let N=function(){I&&Ve(),M--;let e=setInterval(()=>{D?D.isRunning()||(clearInterval(e),V.length>P?Oe({eventID:"success",msg:v.AnnotationSetLoadedSuccessfullyLbl}):g&&g.length&&Oe({eventID:"info",msg:v.NoAnnotationSetLoadedLbl})):clearInterval(e)},100)};if(f.length)(R=f,new Promise(function(e){if(R&&R.length){for(var t=[],n=0;n<R.length;n++)-1===B.indexOf(R[n])&&t.push(R[n]);if(t.length){var o=b.getController();t.forEach(function(e){o.lockRepresentationMeshInRAM(e)}),B=B.concat(t),o.lockNodes({ids:R}),o.setForceReferencesLoad({data:R.map(function(e){return{id:e,state:!0}}),callback:e})}else e()}})).then(()=>{L();let n="3DXML"!==C?ae({productIds:f.concat(c)}):[];n&&n.length&&(x=x.concat(n));let o=c,i=[],a=[];f.forEach(function(e){t=b.getController().getNode({id:e});let n=h.getLoadedStream(t,b);t&&h.is3DLeaf(t)&&n?"thumbnail"===n?a.push(e):i.push(e):o.push(e)}),te(o),(i.length||a.length)&&(Fe(),I=!0,x.push(function(e,t,n,o,i){return new Promise(a=>{if(!e||!t||!e.length&&!t.length)return void a();const r=[];e.length&&r.push(ne(e,"refresh",n,o,i)),t.length&&r.push(ne(t,"switch",n,o,i)),Promise.all(r).then(a)})}(i,a,e.ctxTypes,e.conditions,T))),x.length?Promise.all(x).then(N):N()});else if(c.length){let e="3DXML"!==C?ae({productIds:f.concat(c)}):[];e&&e.length?Promise.all(e).then(N):x&&x.length?Promise.all(x).then(N):N()}else N();var R},this.getDirectChildrenAnnotSets=function(e){var t,n=[],o=e.getLastElement(!0),i=D.getOrderedAnnotationSetPaths();if(h.is3DLeaf(o))for(t=0;t<i.length;t++)e.getLastElement(!0)===i[t].referencePath.getLastElement(!0)&&n.push(i[t]);else if(h.isReference(o))for(t=0;t<i.length;t++){var a=be(i[t]);a&&a.getLastElement(!0)===e.getLastElement(!0)&&n.push(i[t])}return n};var re=function(){for(var e=b.getRoots(),t=0;t<e.length;t++)Q.push({id:h.getNodeID(e[t]),counter:0});Ae()},le=function(e,t){e&&e.getAnnotationClassType&&t&&"visibility"===t&&Ee("onAnnotationVisibilityModified",{node:e})},se=function(e){if("CATWebUXMePreferences_LoadLevelAssemblyAnnotations"===e.preference&&!0===e.value){let e=b.getRootBagPath().getChildrenPathes();for(let t=0;t<e.length;t++)D.loadFTALightModel({path:e[t],ctxTypes:[S.CATFTASetCtxTypeV6Prd]})}if("CATWebUXMePreferences_LoadARMAnnotations"===e.preference&&!0===e.value){let e=b.getRootBagPath().getChildrenPathes();for(let t=0;t<e.length;t++)D.loadFTALightModel({path:e[t],ctxTypes:[S.CATFTASetCtxTypeV5ARM]})}if("CATWebUXMePreferences_LoadFirstAssemblyLevelAnnotations"===e.preference&&!0===e.value||"CATWebUXMePreferences_FirstAssemblyLevelAnnotationsPrefix"===e.preference||"CATWebUXMePreferences_FirstAssemblyLevelAnnotationsSuffix"===e.preference){let e=b.getRootBagPath().getChildrenPathes();for(let t=0;t<e.length;t++){let n={assemblyPrefix:c.getPreference("CATWebUXMePreferences_FirstAssemblyLevelAnnotationsPrefix")||"",assemblySuffix:c.getPreference("CATWebUXMePreferences_FirstAssemblyLevelAnnotationsSuffix")||""},o={[S.CATFTASetCtxTypeV5Std]:n,[S.CATFTASetCtxTypeV5ARM]:c.getPreference("CATWebUXMePreferences_LoadARMAnnotations")?void 0:n,[S.CATFTASetCtxTypeV5Prd]:n,[S.CATFTASetCtxTypeV6Std]:n,[S.CATFTASetCtxTypeV6Prd]:c.getPreference("CATWebUXMePreferences_LoadLevelAssemblyAnnotations")?void 0:n};D.loadFTALightModel({path:e[t],ctxTypes:Object.values(S),conditions:o})}}},de=function(e){j=j.concat(e)};function fe(e){let t,n=b.getDecorationBag(),o=b.getController(),i=b.getRootBagPath().getLastElement(!0);if(e){let r=e.parents[0];if(r===n)return new f([r,e]);if(k.some(function(n){if(e.getAnnotationClassType&&n.getLastElement(!0)===e.parents[0]||!e.getAnnotationClassType&&n.getLastElement(!0)===e)return t=n.clone(),e.getAnnotationClassType&&t.addElement(e),!0}),!t){let r=e,l=[],s=!1;for(;!s&&r;){if(-1!==l.indexOf(r))return;if(l.unshift(r),"3DXML"===h.getLoadedAssetType()){if(1===r.parents.length&&r.parents[0]===i){s=!0;break}r=r.parents[0]}else{let e=r.parents.filter(e=>{if(e&&(e===i||e===n||e.getAnnotationClassType||h.getNodeID(e)&&o.getNode({id:h.getNodeID(e)})))return e});for(var a=0;a<e.length;a++){if(1===e.length&&e[a]===i){s=!0;break}if(e[a].getAnnotationClassType||h.getNodeID(e[a])&&o.getNode({id:h.getNodeID(e[a])})){r=e[a];break}}}}s&&l.length&&l.unshift(i),t=new f(l)}}return t}function ce(){b.getRootBagPath().getChildrenPathes().some(function(e){return b.getController().isLargeDataStructure(h.getNodeID(e.getLastElement(!0)))&&l.displayNotification({eventID:"info",msg:v.ConsiderRefiningYourDataLbl}),!0})}var he=function(e){w.length=0,Q.push({id:h.getNodeID(e.path.getLastElement(!0)),counter:0}),ce(),Ae()},ge=function(e){var t,n,o=[];for(t=k.length-1;t>=0;t--)e.path.isAParentOf(k[t])&&k.splice(t,1);for(t=V.length-1;t>=0;t--)fe(V[t].fatherNode)||(o.push(V[t].annotationSetNode),V[t].annotationSetNode.parents[0]===b.getDecorationBag()&&b.getDecorationBag().removeChild(V[t].annotationSetNode),V.splice(t,1));for(t=O.length-1;t>=0;t--)fe(O[t].node)||(O[t].resolve&&O[t].resolve(),O.splice(t,1));for(t=x.length-1;t>=0;t--)x[t].loadedData&&!fe(x[t].loadedData.node)&&(Ee("onNoAnnotationSetLoaded",{partNode:x[t].loadedData.node,loadingAlreadyStarted:!0}),x[t].loadedData.resolve(),x[t].loadedData=null,x[t].terminate(),ye(t));if(h.getLoadedAssetType())e.path.externalPath.forEach(function(e){var t=h.getNodeID(e);-1!==(n=G.indexOf(t))&&G.splice(n,1),-1!==(n=_.indexOf(t))&&_.splice(n,1),F[t]&&delete F[t],-1!==(n=X.indexOf(t))&&X.splice(n,1),-1!==(n=U.indexOf(t))&&U.splice(n,1)});else{var i=[];for(t=G.length-1;t>=0;t--)b.getController().getNode({id:G[t]})||(-1!==(n=B.indexOf(G[t]))&&i.push(G[t]),-1!==(n=X.indexOf(G[t]))&&X.splice(n,1),F[G[t]]&&delete F[G[t]],G.splice(t,1));for(t=_.length-1;t>=0;t--)b.getController().getNode({id:_[t]})||(-1!==(n=B.indexOf(_[t]))&&i.push(_[t]),-1!==(n=X.indexOf(_[t]))&&X.splice(n,1),F[_[t]]&&delete F[_[t]],_.splice(t,1));for(t=U.length-1;t>=0;t--)b.getController().getNode({id:U[t]})||U.splice(t,1);te(i)}w.length=0,o.length&&Ee("onAnnotationSetRemoved",{nodes:o})},ue=function(e){for(var t=0;t<W.length;t++)if(W[t].detached&&e.path.isEqual(W[t].path)){W[t].hidden?W[t].detached=!1:W.splice(t,1);break}Ee("onAnnotationParentVisibilityModified")},pe=function(e){for(var t=!1,n=0;n<W.length;n++)if(e.path.isEqual(W[n].path)){W[n].detached=!0,t=!0;break}t||W.push({path:e.path.clone(),hidden:!1,detached:!0}),Ee("onAnnotationParentVisibilityModified")};function Ae(){if(Q.length&&!Y&&m){for(var e=b.getRootBagPath().getChildrenPathes(),t=!0===d.getSetting("enopad3dviewer_lightNodeModel"),n=Q.length-1;n>=0;n--){var o,i,a=Q[n],r=!t||"3DXML"===h.getLoadedAssetType()||a.counter>=10;for(o=0;o<e.length;o++)if(h.getNodeID(e[o].getLastElement(!0))===a.id){i=e[o];break}if(i){if(!r){var l=b.getController().createReferenceIterator(a.id);l&&(l.isRepRef()||l.getChildren().length)&&(r=!0)}if(r){Q.splice(n,1);var s=[],f=[];for(o=0;o<j.length;o++)if(j[o].root===h.getNodeID(i.getLastElement(!0))){var g=j[o].instances&&j[o].instances.length?j[o].instances:[j[o].origin];if(t)f.push(g);else{for(var u=i.clone(),p=0;p<g.length;p++)u=me(u,g[p]);u&&!u.isEqual(i)&&s.push(u.clone())}j.splice(o,1);break}if(s.length||f.length){for(o=0;o<s.length;o++)D.loadFTALightModel({path:s[o]});for(o=0;o<f.length;o++)D.loadFTALightModel({idPath:f[o]})}else{var A=c.getA3EWidgetAnnotSetsLoadedPref({path:i});if(A&&A.length)for(var v=0;v<A.length;v++)!1===A[v].visibility&&U.push(A[v].idPath[A[v].idPath.length-1]),D.loadFTALightModel(A[v]);else{D.loadFTALightModel({path:i});let e,t=[];if(c.getPreference("CATWebUXMePreferences_LoadARMAnnotations")&&t.push(S.CATFTASetCtxTypeV5ARM),c.getPreference("CATWebUXMePreferences_LoadLevelAssemblyAnnotations")&&t.push(S.CATFTASetCtxTypeV6Prd),c.getPreference("CATWebUXMePreferences_LoadFirstAssemblyLevelAnnotations")){t=Object.values(S);let n={assemblyPrefix:c.getPreference("CATWebUXMePreferences_FirstAssemblyLevelAnnotationsPrefix")||"",assemblySuffix:c.getPreference("CATWebUXMePreferences_FirstAssemblyLevelAnnotationsSuffix")||""};e={[S.CATFTASetCtxTypeV5Std]:n,[S.CATFTASetCtxTypeV5ARM]:c.getPreference("CATWebUXMePreferences_LoadARMAnnotations")?void 0:n,[S.CATFTASetCtxTypeV5Prd]:n,[S.CATFTASetCtxTypeV6Std]:n,[S.CATFTASetCtxTypeV6Prd]:c.getPreference("CATWebUXMePreferences_LoadLevelAssemblyAnnotations")?void 0:n}}t.length&&D.loadFTALightModel({path:i,ctxTypes:t,conditions:e})}}}else a.counter++}}Q.length||(j.length=0)}}var ve=function(){m&&(Q.forEach(function(e){e.counter++}),Ae())},Se=function(e){if(e&&e.paths){for(var t,n=0;n<e.paths.length;n++)if((t=e.paths[n]).getLastElement||(t=ee(b.getRootBagPath(),e.paths[n])),t){for(var o=!1,i=0;i<W.length;i++)if(t.isEqual(W[i].path)){W[i].hidden=!0,o=!0;break}o||W.push({path:t.clone(),hidden:!0,detached:!1})}Ee("onAnnotationParentVisibilityModified")}},Te=function(e){if(e&&e.paths){for(var t,n=0;n<e.paths.length;n++)if((t=e.paths[n]).getLastElement||(t=ee(b.getRootBagPath(),e.paths[n])),t)for(var o=0;o<W.length;o++)W[o].hidden&&t.isEqual(W[o].path)&&(W[o].detached?W[o].hidden=!1:W.splice(o,1));Ee("onAnnotationParentVisibilityModified")}},De=function(){Y=!0,te(B),B.length=0,w.splice(0,w.length)},Ce=function(){Y=!1,N>0&&(N=1,Ve()),Le(),ye(),Ae()},me=function(e,t){if(e){var n=e.getLastElement(!0);if(h.getNodeID(n)===t)return e;for(var o=e.getChildrenPathes(),i=0;i<o.length;i++){var a=me(o[i],t);if(a)return a}}},be=function(e){for(var t,n=e.referencePath.clone(),o=b.getRootBagPath(),i=!1;n&&!n.isEqual(o);){if(t=n.getLastElement(!0),h.is3DLeaf(t)&&n.getParentPath().isEqual(o))return n;if(h.isReference(t)){if(2!==e.annotSetPath.getLastElement(!0).getContextType())return n;if(i)return n;i=!0}n=n.getParentPath()}},ye=function(e){var n=i.getWebappsBaseUrl(),o=t.matchUrl(n,window.location)?null:"Passport";void 0===e&&x.splice(0,x.length),a.getWorkerBlobFromSpecs([{provider:"FILE",filename:"AmdLoader.js",serverurl:n+"AmdLoader/",requiredAuth:o},{provider:"FILE",filename:"ThreeJS_Base.js",serverurl:n+"Mesh/",requiredAuth:o},{provider:"FILE",filename:"Mesh.js",serverurl:n+"Mesh/",requiredAuth:o},{provider:"FILE",filename:"CGRFile.js",serverurl:n+"Formats/",requiredAuth:o},{provider:"FILE",filename:"EasySax.js",serverurl:n+"EasySax/",requiredAuth:o},{provider:"FILE",filename:"CAT3DAnnotationLoadWorker.js",serverurl:n+"CAT3DAnnotationWorkers/",requiredAuth:o}],function(t){if(x)if(void 0===e)for(var n=0;n<4;n++){var o=new Worker(t);o.onmessage=Me,x.push(o)}else x[e]=new Worker(t),x[e].onmessage=Me})},Le=function(){for(var e=0;e<x.length;e++)x[e].loadedData&&x[e].loadedData.resolve(),x[e].terminate();x.splice(0,x.length),O.forEach(e=>{e&&e.resolve&&e.resolve()}),O.splice(0,O.length),E.splice(0,E.length)},Pe=function(e,t,n,o,i){return new Promise(a=>{var r=setInterval(function(){if(4===x.length){clearInterval(r);for(let r=0;r<x.length;r++)if(!x[r].loadedData)return Ee("onAnnotationSetBeginLoad",{partNode:e}),x[r].loadedData={annotationSets:{},node:e,xml:t,ctxTypes:n,resolve:a},void x[r].postMessage({xmlData:t,loadingIndex:r,ctxTypes:n,conditions:o,nodeName:i});O.push({annotationSets:{},node:e,xml:t,ctxTypes:n,conditions:o,nodeName:i,resolve:a})}},50)})},xe=function(e){if(12!==e.children.length)return!1;for(var t=0;t<e.children.length;t++)if(0!==e.children[t].children.length)return!0;return!1};function Ie(){if(L){var e=function(t){t&&t.getAnnotationClassType&&(L.buildAnnotVisualization(t),t.children.forEach(e))};V.forEach(function(t){var n=t.annotationSetNode.getRootAnnotationNode("RootAttributes");if(n)for(var o=0;o<n.children.length;o++)e(n.children[o])}),b.getViewer().render()}}var Ne,Re,Me=function(e){if(m){var n,o,i=e.data.loadingIndex;if(void 0!==i){var a=x[i].loadedData.node;if(!a)return x[n].loadedData&&x[n].loadedData.resolve&&x[n].loadedData.resolve(),x[n].loadedData=null,x[i].terminate(),void ye(i);var r=h.getNodeID(a);if(!0===e.data.done){var l=Object.keys(x[i].loadedData.annotationSets),s=h.getNodeID(a);if(!0===e.data.loadingCancelled){for(n=0;n<l.length;n++)o=x[i].loadedData.annotationSets[l[n]],a.removeChild(o),o.splice(o.indexOf(o),1);-1!==U.indexOf(r)&&U.splice(U.indexOf(r),1),-1!==G.indexOf(s)&&G.splice(G.indexOf(s),1),F[s]&&(F[s].difSetLoaded?F[s].embeddedSetLoaded=!1:delete F[s]),!0===e.data.error?Ee("onAnnotationSetLoadingFailed",{partNode:a}):Ee("onNoAnnotationSetLoaded",{partNode:a,loadingAlreadyStarted:!0})}else{var d=function(e){if(m){var t=v.TesselatedTextRepsMissing;e[s]["ds6w:label"]&&(t+=e[s]["ds6w:label"]+" / "),t+=o.getAnnotationName(),Ee("onAnnotationSetPartiallyLoaded",{partNode:a,node:o,message:t})}},f=function(){m&&Ee("onAnnotationSetPartiallyLoaded",{partNode:a,node:o,message:v.TesselatedTextRepsMissing+o.getAnnotationName()})};for(n=0;n<l.length;n++)if(o=x[i].loadedData.annotationSets[l[n]],L.postProcessViewsAndCaptures(x[i].loadedData.annotationSets[l[n]]),e.data.loadingPartiallyFailed)if(!x[i].loadedData.hasFailedOnce&&x[i].loadedData.xml){a.removeChild(o),V.splice(V.map(e=>e.annotationSetNode).indexOf(o),1),-1!==U.indexOf(r)&&U.splice(U.indexOf(r),1);var c=x[i].loadedData;c.hasFailedOnce=!0;var g=t.loadXml(c.xml);c.xml=t.xmlToString(g),O.push(c),window&&window.console&&window.console.warn("Error while loading annotations of : "+h.getNodeID(a)+". FTA light model is converted and reloaded.")}else Ee("onAnnotationSetPartiallyLoaded",{partNode:a,node:o});else xe(o)?e.data.hasTesseletedTextReps||L.hasTheTextBeenProcessed()?Ee("onAnnotationSetLoaded",{partNode:a,node:o}):h.getLoadedAssetType()?Ee("onAnnotationSetPartiallyLoaded",{partNode:a,node:o,message:v.TesselatedTextRepsMissing+o.getAnnotationName()}):b.getController().getAttributes({ids:[s],attributes:["ds6w:label"],callbacks:{onComplete:d,onFailure:f}}):(a.removeChild(o),V.splice(V.map(e=>e.annotationSetNode).indexOf(o),1),-1!==U.indexOf(r)&&U.splice(U.indexOf(r),1),Ee("onNoAnnotationSetLoaded",{partNode:a,loadingAlreadyStarted:!0}))}if(x[i].loadedData.resolve(),x[i].loadedData=null,O.length){var u;for(n=O.length-1;n>=0;n--)O[n]&&!O[n].node?(O[n]&&O[n].resolve&&O[n].resolve(),O.splice(n,1)):O[n]&&O[n].node&&(u=n);x[i].loadedData={node:O[u].node,annotationSets:{},hasFailedOnce:O[u].hasFailedOnce,xml:O[u].xml,resolve:O[u].resolve},x[i].postMessage({xmlData:O[u].xml,loadingIndex:i,ctxTypes:O[u].ctxTypes,conditions:O[u].conditions,nodeName:O[u].nodeName}),O.splice(u,1)}}else{var p=e.data.node;if(x[i].loadedData.annotationSets[e.data.annotSetID])o=x[i].loadedData.annotationSets[e.data.annotSetID];else{var A=!0;-1!==U.indexOf(r)&&(A=!1,U.splice(U.indexOf(r),1)),o=L.createAnnotationSet(le,p),A||o.setVisibility(!1),a.addChild(o),V.push({annotationSetNode:o,fatherNode:a}),x[i].loadedData.annotationSets[e.data.annotSetID]=o}p&&L.loadAnnotation({nodeInfo:p,annotationSetNode:o,processText:e.data.processText,cb:le})}b.getViewer().render()}}};function Oe(e){e&&("error"===e.eventID||"warning"===e.eventID?l.displayNotification(e):(Ne&&clearTimeout(Ne),(!Re||e&&"success"===e.eventID)&&(Re=e),Ne=setTimeout(function(){Ne=null,D&&(D.isRunning()?Oe(Re):(l.displayNotification(Re),Re=null))},1e3)))}var Ee=function(e,t){if(b){var n,o=t||{};o.path=fe(o.node);var i=!h.getLoadedAssetType();if("onAnnotationSetLoaded"===e||"onAnnotationSetPartiallyLoaded"===e)o.path&&o.node&&(i&&c.saveA3EWidgetPref({path:o.partNode?fe(o.partNode):o.path,pref:"A3EAnnotSetsLoaded",data:{visibility:o.node.isVisible(),ctxType:o.node.getContextType()}}),w.length=0,"onAnnotationSetPartiallyLoaded"===e&&Oe({eventID:"warning",msg:o.message&&L&&L.hasTheTextBeenProcessed()?o.message:v.AnnotationSetPartiallyLoadedLbl}));else if("onAnnotationSetRemoved"===e){if(!Y&&!K&&i&&o.nodes&&o.nodes.length)for(n=0;n<o.nodes.length;n++)c.removeA3EWidgetPref({nodeID:h.getNodeID(o.nodes[n]),pref:"A3EAnnotSetsLoaded"});w.splice(0,w.length)}else"onAnnotationSetLoadingFailed"===e?Oe({eventID:"error",msg:v.AnnotationSetLoadedFailedLbl}):"onAnnotationSetLoadingCanceled"===e?Oe({eventID:"info",msg:v.AnnotationSetLoadedCanceledLbl}):"onAnnotationVisibilityModified"===e?o.path&&o.node&&"tpsAnnotationSet"===o.node.getAnnotationClassType()&&i&&(c.removeA3EWidgetPref({path:o.path,pref:"A3EAnnotSetsLoaded"}),c.saveA3EWidgetPref({path:o.path,pref:"A3EAnnotSetsLoaded",data:{visibility:o.node.isVisible(),ctxType:o.node.getContextType()}})):"onAnnotationParentVisibilityModified"===e&&(w.length=0);o&&o.path&&("onAnnotationSetLoaded"===e||"onAnnotationSetPartiallyLoaded"===e)?oe(o.path,function(){C.publish({event:e,data:o,context:D})}):C.publish({event:e,data:o,context:D})}},Fe=function(){I&&(clearTimeout(I),I=null),I=setTimeout(function(){N=1,Ve()},2e4),1===++N&&setTimeout(()=>{!D||N<=0||!m||R||(R=!0,s.on(v.LoadingAnnotationsLbl,function(){var e,t=[],n=[];for(e=x.length-1;e>=0;e--)if(x[e].loadedData){var o=x[e].loadedData.node,i=h.getNodeID(o);t.push(o),n.push(h.getNodeID(o));for(var a=Object.keys(x[e].loadedData.annotationSets),r=0;r<a.length;r++)o.removeChild(x[e].loadedData.annotationSets[a[r]]),-1!==U.indexOf(i)&&U.splice(U.indexOf(i),1);x[e].loadedData.resolve(),x[e].loadedData=null}for(e=O.length-1;e>=0;e--)t.push(O[e].node),n.push(h.getNodeID(O[e].node)),O[e].resolve&&O[e].resolve();for(O.length=0,Le(),ye(),te(n=n.concat(E)),e=n.length;e>=0;e--)-1!==G.indexOf(n[e])&&G.splice(G.indexOf(n[e]),1),F[n[e]]&&(F[n[e]].difSetLoaded?F[n[e]].embeddedSetLoaded=!1:delete F[n[e]]);E.length=0,t.forEach(function(e){Ee("onAnnotationSetLoadingCanceled",{partNode:e})})}))},3e3)},Ve=function(){I&&(clearTimeout(I),I=null),--N<0&&(N=0),0===N&&R&&(s.off(),R=!1)}}}),D=[];return e.singleton({init:function(){},getAnnotationModelLoader:function(e){if(e&&e.context){for(var t=!1,n=0;n<D.length;n++)if(D[n].context===e.context){t=!0;break}return t||D.push({context:e.context,modelLoader:new T({ctxViewer:e.context,favoriteCtxManager:e.favoriteCtxManager})}),this.giveAnnotationModelLoader(e)}},giveAnnotationModelLoader:function(e){if(e&&e.context){for(var t,n,o=0;o<D.length;o++)if(D[o].context===e.context){n=D[o],t=n.modelLoader;break}if(t)return Object.freeze({CONTEXT_TYPE_ANNOT_SET:S,setActiveState:function(e){t&&t.setActiveState(e)},getActiveState:function(){if(t)return t.getActiveState()},loadFTAModel:function(e){t&&t.loadFTALightModel(e)},removeDIFAnnotationSet:function(e){t&&t.removeDIFAnnotationSet(e)},setAnnotationSetFavoriteCtxPath:function(e){t&&t.setAnnotationSetFavoriteCtxPath(e)},hasAlreadyBeenLoaded:function(e,n){if(t)return t.hasAlreadyBeenLoaded(e,n)},getLoadedAnnotationSets:function(){if(t)return t.getLoadedAnnotationSets()},getOrderedAnnotationSetPaths:function(){if(t)return t.getOrderedAnnotationSetPaths()},getDirectChildrenAnnotSets:function(e){if(t)return t.getDirectChildrenAnnotSets(e)},isRunning:function(){if(t)return t.isRunning()},subscribe:function(e,n){if(t)return t.subscribe(e,n)},unsubscribe:function(e){t&&t.unsubscribe(e)},loadFTALightModel:function(e,n,o,i){window.console.warn("DEPRECATED API. Use loadFTAModel method instead"),t&&t.loadFTALightModel({path:e,loadChildren:o,ctxTypes:i})}})}},unreferenceAnnotationModelLoader:function(e){if(e&&e.context)for(var t=0;t<D.length;t++)if(D[t].context===e.context)return D[t].modelLoader&&D[t].modelLoader.clear(),void D.splice(t,1)}})});