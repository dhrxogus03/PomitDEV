define("DS/XCADSTEPDocument/STEPInputDocument",["DS/XCADInputDocuments/XCADInputDocument","DS/XCADInputDocuments/XCADRepresentation","DS/XCADSTEPDocument/STEPTessellatedRepresentation","DS/XCADSTEPDocument/STEPTessellatedAnnotationRepresentation","DS/XCADSTEPDocument/STEPProductRepresentation","DS/XCADSTEPDocument/STEPProduct","DS/XCADInputDocuments/XCADFaceData","DS/Mesh/ThreeJS_Base","DS/XCADLoader/XCADError"],function(e,s,t,n,r,i,o,E,a){"use strict";s.XCAD_TESSELLATED_REPRESENTATION,s.XCAD_TESSELLATED_ANNOTATION_REPRESENTATION;var T=/\(([^)]+)\)/g,c=/([^,]+)/g;return e.extend(function(){this.bodyColors=[],this.overridingFaceColors=[],this.assyProducts=[],this.tesselatedReps=[],this.annotationTesselatedReps=[],this.annotationDefaultView=[],this.stepEntities=[],this.curveFont=[],this.curveWidth=[],this.rootProducts=[],this.nbCpxTriFace=0,this.nbWire=0,this.CoordSystem={Coord:!1,Origin:void 0,Axis:void 0,RefDir:void 0},this.nbInstPart=0,this.geomRepresToshapeRepres=[]},{zipped:!1,requestResponseType:"arraybuffer",stepTokenizeComplexEntity:function(e,s){var t=0,n="";s.length=0;for(var r=0;r<e.length;r++)"("===e[r]?(t>=1&&(n+=e[r]),t++):")"===e[r]?--t>=1&&(n+=e[r],1===t&&(s.push(n),n="")):n+=e[r]},stepGetNodeIdFromCpxEntity:function(e){var s=this.stepEntities[e],t=[];this.stepTokenizeComplexEntity(s,t);var n=[];this.stepTokenizeArgs(t[3],n);var r=[];return this.stepTokenizeArgs(n[0],r),r},_stepGetEntityType:function(e){var s,t=this.stepEntities[e];void 0!==t&&(s="("===t[0]?-1!==t.indexOf("TESSELLATED_GEOMETRIC_SET")?"TESSELLATED_GEOMETRIC_SET":"[COMPLEX_STEP_ENTITY]":t.match(/^\w+/)[0]);return{first:s,second:t}},close:function(){void 0!==this._internalRepresentationIndex&&delete this._internalRepresentationIndex},getProductReference:function(e){return new i(this,this.assyProducts[e])},getRepresentation:function(e){var i;if(void 0!==this._internalRepresentationIndex)e===s.XCAD_TESSELLATED_REPRESENTATION&&(i=new t(this,this._internalRepresentationIndex));else if(0===Object.keys(this.assyProducts).length&&0!==this.tesselatedReps.length&&e===s.XCAD_TESSELLATED_REPRESENTATION)i=new t(this,this.tesselatedReps[0]);else if(0!==this.annotationTesselatedReps.length&&e===s.XCAD_TESSELLATED_ANNOTATION_REPRESENTATION)i=new n(this,this.annotationTesselatedReps);else if(0!==Object.keys(this.assyProducts).length&&e===s.XCAD_PRODUCT_REPRESENTATION){i=new r(this,s.XCAD_PRODUCT_REPRESENTATION,"root");var o,E=this.getRootProducts();if(E.length>0)o=E[0];else for(var a in this.assyProducts)if(this.assyProducts[a].isRoot){o=a;break}var T=this.getProductReference(o);i.addRootProduct(T)}return i},getRootProducts:function(){return this.rootProducts},serialize:function(){return JSON.stringify(this)},unserialize:function(e){let s=JSON.parse((new TextDecoder).decode(e));this.nbCpxTriFace=s.nbCpxTriFace,this.nbInstPart=s.nbInstPart,this.nbWire=s.nbWire,this.CoordSystem=s.CoordSystem,this.bodyColors=s.bodyColors,this.overridingFaceColors=s.overridingFaceColors,this.assyProducts=s.assyProducts,this.tesselatedReps=s.tesselatedReps,this.annotationTesselatedReps=s.annotationTesselatedReps,this.annotationDefaultView=s.annotationDefaultView,this.stepEntities=s.stepEntities,this.curveFont=s.curveFont,this.curveWidth=s.curveWidth,this.rootProducts=s.rootProducts},stepTokenizeArgs:function(e,s){if(void 0!==e){s.length=0;e.substr(e.indexOf("(")+1,e.lastIndexOf(")")).match(/(\'[a-zA-Z0-9\s.,+-_#()~:&\\\"]*\')*(\([()]*(\([^()]*\)[^()]*)*\))*(\([a-zA-Z0-9\s.,-_#]*\))*(\.[a-zA-Z0-9\s.,-_#]*\.)*(\#?\-?[0-9]+[.-E0-9]*)*(\$)*/g).filter(function(e){return""!=e}).forEach(e=>{if("string"==typeof e&&e.startsWith("'")&&e.endsWith("'")&&(e=e.slice(1,-1)),e.indexOf("\\X2\\")>=0){var t=e.substr(e.indexOf("\\X2\\")+4,e.indexOf("\\X0\\")).match(/.{1,4}/g);t.forEach((e,s,t)=>{t[s]="0x"+e});var n=String.fromCharCode.apply(String,t);e=e.substr(0,e.indexOf("\\X2\\"))+n+e.substr(e.indexOf("\\X0\\")+4,e.length-1)}s.push(e)})}},initialize:async function(e){var s=[];if("string"==typeof e)s[0]=e;else{var t=new TextDecoder("utf-8");if(e.byteLength>268435456){let n=0,r=268435456,i=0;for(;r<e.byteLength;)s[i]=t.decode(e.slice(n,r)),i++,n=r+1,r+=268435456;s[i]=t.decode(e.slice(n,e.byteLength))}else s[0]=t.decode(e)}if(""!==s[0]){for(var n=1;n<s.length;n++){let e=s[n].indexOf("\n#"),t=s[n].substring(0,e+1);s[n-1]+=t,s[n]=s[n].slice(e+1,s[n].length)}if(null===s[0].match(/FILE_SCHEMA\s*\(\s*\(\s*\'\s*AP242/))return console.error("Only STEP AP242 file are supported"),(r=new a).setError("XCADLoader/XCADLoader","error.STP_UNSUPPORT",null),r;var r,i=!0;for(n=0;n<s.length;n++)null!=s[n].match(/#\d+=TESSELLATED_SHAPE_REPRESENTATION/)&&(i=!1);if(!0===i)return console.error("Only STEP file with tessellated data are supported"),(r=new a).setError("XCADLoader/XCADLoader","error.NO_TESSELLATION",null),r;for(n=0;n<s.length;n++)s[n]=s[n].replace(/\r?\n/g,""),s[n]=s[n].replace(/\/\*.*\*\//g,""),s[n]=s[n].split(";");e="";var o=this,l=[],d=[],u=[],f=[],A=[],h=[],p=[],R=[],O=[],_=[],g=/^(#[0-9]+)\=(.+)$/,N=/^\w+/,S="";for(n=0;n<s.length;n++){S=s[n];for(var C=0;C<S.length;C++){var I=S[C].match(g);if(null!==I){var b=I[2].match(N);if(null===b&&("("===I[2][0]&&(b=["[COMPLEX_STEP_ENTITY]"]),I[2].includes("ANNOTATION_OCCURRENCE")&&(b=["ANNOTATION_CURVE_OCCURRENCE"])),null===b)console.error("STEPInputDocument::initialize entityType is null");else{var D=I[1].substring(1);switch(this.stepEntities[D]=I[2],b[0]){case"TESSELLATED_SHAPE_REPRESENTATION":case"TESSELLATED_SHAPE_REPRESENTATION_WITH_ACCURACY_PARAMETERS":this.tesselatedReps.push(I[1]);break;case"STYLED_ITEM":l.push(D);break;case"OVER_RIDING_STYLED_ITEM":d.push(D);break;case"CONTEXT_DEPENDENT_SHAPE_REPRESENTATION":u.push(D);break;case"SHAPE_REPRESENTATION_RELATIONSHIP":f.push(D);break;case"PROPERTY_DEFINITION_REPRESENTATION":A.push(D);break;case"SHAPE_DEFINITION_REPRESENTATION":p.push(D);break;case"APPLIED_EXTERNAL_IDENTIFICATION_ASSIGNMENT":R.push(D);break;case"COMPLEX_TRIANGULATED_FACE":this.nbCpxTriFace++;break;case"TESSELLATED_WIRE":this.nbWire++;break;case"SHAPE_REPRESENTATION":h.push(D);break;case"DRAUGHTING_CALLOUT":case"ANNOTATION_CURVE_OCCURRENCE":case"ANNOTATION_FILL_AREA_OCCURRENCE":this.annotationTesselatedReps.push(D);break;case"DEFAULT_MODEL_GEOMETRIC_VIEW":this.annotationDefaultView.push(D)}}}}s[n].length=0}for(C=0;C<this.annotationTesselatedReps.length;C++)y(this.annotationTesselatedReps[C],l,d);var P=function(e){let s=void 0;if(0!=e.length){var t=[];o.stepTokenizeArgs(o.stepEntities[e],t);let r=t[3].substr(1);o.stepTokenizeArgs(o.stepEntities[r].substring(o.stepEntities[r].indexOf("REPRESENTATION("),o.stepEntities[r].length-2),t),s=t[2].substr(1,t[2].length-2).match(c);for(var n=0;n<s.length;n++)s[n]=s[n].substring(s[n].indexOf("#")+1,s[n].length)}return s}(this.annotationDefaultView);null!=P&&(this.annotationTesselatedReps=P);for(C=0;C<l.length;C++)x(l[C],!0);for(C=0;C<d.length;C++)x(d[C],!1);if(u.length>0){for(C=0;C<h.length;C++){var v=[];this.stepTokenizeArgs(this.stepEntities[h[C]],v),"[COMPLEX_STEP_ENTITY]"===L(v[2].substr(1)).first&&(this.geomRepresToshapeRepres[v[2].substr(1)]="#"+h[C].toString())}for(C=0;C<f.length;C++)U(f[C],"internal");for(C=0;C<p.length;C++)U(p[C],"alternative");for(C=0;C<R.length;C++)z(R[C]);for(C=0;C<A.length;C++)U(A[C],"external");for(C=0;C<u.length;C++)k(u[C])}else o.nbInstPart++}function L(e){var s,t=o.stepEntities[e];void 0!==t&&(s="("===t[0]||"("===t[1]?-1!==t.indexOf("TESSELLATED_GEOMETRIC_SET")?"TESSELLATED_GEOMETRIC_SET":"[COMPLEX_STEP_ENTITY]":t.match(/^\w+/)[0]);return{first:s,second:t}}function x(e,s){let t=[],n=void 0;var r=L(e);if("[COMPLEX_STEP_ENTITY]"===r.first){var i=[];o.stepTokenizeArgs(r.second,i);let e=void 0;if(s?e=i[5].substr(1,i[5].length-2).match(c):r.second.includes("TESSELLATED_ANNOTATION_OCCURRENCE")?e=i[3].substr(1,i[3].length-2).match(c):r.second.includes("ANNOTATION_CURVE_OCCURRENCE")?e=i[4].substr(1,i[4].length-2).match(c):console.log("TODO : "+r.second),t[0]=e[0].substr(1,e[0].length-2),s)n=e[1].substr(1);else{var a=L(e[1].substr(1));o.stepTokenizeArgs(a.second,i),r.second.includes("TESSELLATED_ANNOTATION_OCCURRENCE")?n=i[3].substr(2,i[3].length-4).substr(1):r.second.includes("ANNOTATION_CURVE_OCCURRENCE")?n=i[1].substr(1,i[1].length-2).substr(1):console.log("TODO : "+r.second)}}else{let s=o.stepEntities[e].substring(12,o.stepEntities[e].lastIndexOf(")")).match(c);var l=!1;n=s[2].substr(1),t=s[1].substr(1,s[1].length-2).match(c)}for(var d=0;d<t.length;d++){var u=t[d];if("PRESENTATION_STYLE_ASSIGNMENT"===(C=L(u.substr(1))).first){let e=C.second.substr(C.second.indexOf("((")+1,C.second.indexOf("))")-2).match(T),t=e[0].substr(1,e[0].length-2).match(c);for(var f=0;f<t.length;f++){var A=L((u=t[f]).substr(1));if("SURFACE_STYLE_USAGE"===A.first){var h=L(u=A.second.substring(A.second.indexOf("#")+1,A.second.indexOf(")")));if("SURFACE_SIDE_STYLE"===h.first){let e=h.second.substring(h.second.indexOf("#"),h.second.indexOf("))")).match(c);for(var p=0;p<e.length;p++){var R=L((u=e[p]).substr(1));if("SURFACE_STYLE_FILL_AREA"===R.first){var O=L(u=R.second.substring(R.second.indexOf("#")+1,R.second.indexOf(")")));if("FILL_AREA_STYLE"===O.first){let e=O.second.substring(O.second.indexOf("#"),O.second.indexOf("))")).match(c);for(var _=0;_<e.length;_++){var g=L((u=e[_]).substr(1));if("FILL_AREA_STYLE_COLOUR"===g.first){var N=L(u=g.second.substring(g.second.indexOf("#")+1,g.second.indexOf(")")));if("COLOUR_RGB"===N.first){let e=N.second.substring(N.second.indexOf("(")+1,N.second.indexOf(")")).match(c);s?o.bodyColors[n]=[e[1],e[2],e[3]]:o.overridingFaceColors[n]=[e[1],e[2],e[3]]}else if("DRAUGHTING_PRE_DEFINED_COLOUR"===N.first){let e=N.second.substring(N.second.indexOf("('")+2,N.second.indexOf("')"));(b=new E.Color).setStyle(e),e.startsWith("gre")&&(b.g=1),s?o.bodyColors[n]=[b.r,b.g,b.b]:o.overridingFaceColors[n]=[b.r,b.g,b.b]}}}}}else if("SURFACE_STYLE_RENDERING_WITH_PROPERTIES"===R.first){let e=R.second.substring(R.second.indexOf("(#")+2,R.second.indexOf(")"));var S=L(e);if("SURFACE_STYLE_TRANSPARENT"===S.first){let s=S.second.substring(S.second.indexOf("(")+1,S.second.indexOf(")"));null!=o.bodyColors[n]?s<=1&&s>=0?o.bodyColors[n][3]=1-s:l&&console.log("Warning: transparency value must be between [0-1] ("+s+") for entity: "+e):null!=o.overridingFaceColors[n]&&(s<=1&&s>=0?o.overridingFaceColors[n][3]=1-s:l&&console.log("Warning: transparency value must be between [0-1] ("+s+") for entity: "+e))}}}}}else if("CURVE_STYLE"===A.first){var C,I=[];if(o.stepTokenizeArgs(A.second,I),"COLOUR_RGB"===(C=L(u=A.second.substring(A.second.indexOf("),#")+3,A.second.lastIndexOf(")")))).first){let e=C.second.substring(C.second.indexOf("(")+1,C.second.indexOf(")")).match(c);o.bodyColors[n]=[e[1],e[2],e[3]]}else if("DRAUGHTING_PRE_DEFINED_COLOUR"===C.first){let e=C.second.substring(C.second.indexOf("('")+2,C.second.indexOf("')"));var b;(b=new E.Color).setStyle(e),e.startsWith("gre")&&(b.g=1),o.bodyColors[n]=[b.r,b.g,b.b]}var D=I[2].match(/\((.*?)\)/);if(D&&(o.curveWidth[n]=parseFloat(D[1])),"DRAUGHTING_PRE_DEFINED_CURVE_FONT"===(C=L((u=I[1]).substr(1))).first){let e=C.second.substring(C.second.indexOf("('")+2,C.second.indexOf("')"));o.curveFont[n]=e}}}}}}function y(e,s,t){var n=[],r=L(e);if("[COMPLEX_STEP_ENTITY]"===r.first)o.stepEntities[e].includes("OVER_RIDING_STYLED_ITEM")?t.push(e):o.stepEntities[e].includes("STYLED_ITEM")&&s.push(e);else if("ANNOTATION_FILL_AREA_OCCURRENCE"===r.first||"ANNOTATION_CURVE_OCCURRENCE"===r.first)s.push(e);else if("DRAUGHTING_CALLOUT"===r.first){o.stepTokenizeArgs(o.stepEntities[e],n);let t=n[1].substr(1,n[1].length-2).match(c);for(var i=0;i<t.length;i++){var E=t[i];s.push(E.substr(1))}}else"CAMERA_MODEL_D3"===r.first||console.log("processAnnotation "+r.first+" not yet supported ")}function k(e){var s=[];o.stepTokenizeArgs(o.stepEntities[e],s);var t,n=s[0].substr(1),r=s[1].substr(1),i=[];o.stepTokenizeComplexEntity(o.stepEntities[n],i);var a=[];o.stepTokenizeArgs(i[0],a);var T=a[2],c=a[3],l=[];o.stepTokenizeArgs(i[1],l);var d=L(l[0].substr(1));if("ITEM_DEFINED_TRANSFORMATION"===d.first){var u=[];o.stepTokenizeArgs(d.second,u);var f=u[2];t=function(e,s){var t={},n=[],r=[],i=[],a=[],T=[],c=[];o.stepTokenizeArgs(o.stepEntities[e],n),n[1]=n[1].substr(1),n[2]=n[2].substr(1),n[3]=n[3].substr(1),o.stepTokenizeArgs(o.stepEntities[n[1]],r),o.stepTokenizeArgs(r[1],i),o.stepTokenizeArgs(o.stepEntities[n[2]],r),o.stepTokenizeArgs(r[1],a),o.stepTokenizeArgs(o.stepEntities[n[3]],r),o.stepTokenizeArgs(r[1],T),o.stepTokenizeArgs(o.stepEntities[s],n),n[1]=n[1].substr(1),n[2]=n[2].substr(1),n[3]=n[3].substr(1),o.stepTokenizeArgs(o.stepEntities[n[1]],r),o.stepTokenizeArgs(r[1],c),o.stepTokenizeArgs(o.stepEntities[n[2]],r),o.stepTokenizeArgs(r[1],[]),o.stepTokenizeArgs(o.stepEntities[n[3]],r),o.stepTokenizeArgs(r[1],[]),t.rotation=new E.Matrix3;var l=new E.Vector3(a[0],a[1],a[2]),d=new E.Vector3(T[0],T[1],T[2]),u=new E.Vector3;return u.crossVectors(l,d),t.rotation.set(T[0],T[1],T[2],u.x,u.y,u.z,a[0],a[1],a[2]),t.translation=new E.Vector3(i[0]-c[0],i[1]-c[1],i[2]-c[2]),t}(u[3].substr(1),f.substr(1))}var A=[];o.stepTokenizeArgs(o.stepEntities[r],A);var h=[];o.stepTokenizeArgs(o.stepEntities[A[2].substr(1)].replaceAll("*",""),h);var p=h[0],R=m(h[3]),O=R[0],g=R[1],N=(R=m(h[4]))[0],S=R[1];if(null!==O&&null!==N){if(O in o.assyProducts||(o.assyProducts[O]={referenceName:g,isRoot:!0,childrenList:[],geomRep:_[c]},o.rootProducts.push(O)),N in o.assyProducts){o.assyProducts[N].isRoot=!1;var C=o.rootProducts.indexOf(N);-1!=C&&o.rootProducts.splice(C,1)}else o.assyProducts[N]={referenceName:S,isRoot:!1,childrenList:[],geomRep:_[T]};o.assyProducts[O].childrenList.push({instanceName:p,productReferenceIdx:N,transfo:t}),void 0!==o.assyProducts[N].geomRep&&o.nbInstPart++}}function m(e){var s=null,t=null;if(null==e)return[s,t];var n=L(e.substr(1));if("PRODUCT_DEFINITION"===n.first){var r=[];if(o.stepTokenizeArgs(n.second,r),"PRODUCT_DEFINITION_FORMATION_WITH_SPECIFIED_SOURCE"===(n=L(r[r.length-2].substr(1))).first){var i=[];if(o.stepTokenizeArgs(n.second,i),"PRODUCT"===(n=L(i[2].substr(1))).first){var E=[];o.stepTokenizeArgs(n.second,E),s=i[2],t=E[0]}}}return[s,t]}function z(e){var s=[];o.stepTokenizeArgs(o.stepEntities[e],s);var t=[];o.stepTokenizeArgs(s[3],t),"DOCUMENT_FILE"===L(t[0].substr(1)).first&&(O[t[0]]=s[0])}function U(e,s){if("external"===s){var t=[];o.stepTokenizeArgs(o.stepEntities[e],t);var n=L(t[0].substr(1)),r=L(t[1].substr(1));if("PROPERTY_DEFINITION"===n.first&&"SHAPE_REPRESENTATION"===r.first){var i=[];o.stepTokenizeArgs(n.second,i),_[t[1]]={type:"external",location:O[i[2]]}}}else if("internal"===s){var E=[];o.stepTokenizeArgs(o.stepEntities[e],E),_[E[2]]={type:"internal",location:E[3]}}else if("alternative"===s){t=[];o.stepTokenizeArgs(o.stepEntities[e],t);n=L(t[0].substr(1));if("TESSELLATED_SHAPE_REPRESENTATION"===(r=L(t[1].substr(1))).first){i=[];o.stepTokenizeArgs(r.second,i);var a=o.geomRepresToshapeRepres[i[2].substr(1)];_[a]={type:"internal",location:t[1]}}}}}})});