define("DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmdEngine",["UWA/Core","UWA/Class","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/WebappsUtils/WebappsUtils","UWA/Promise","i18n!DS/ENONextGenFilterCmd/assets/nls/ENONextGenFilterCmd","DS/Windows/ImmersiveFrame","DS/Windows/Dialog","DS/CollectionView/ResponsiveLargeTilesCollectionView","DS/Controls/Button","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBISettings","DS/Utilities/Utils"],function(e,t,i,n,o,s,r,a,l,d,c,h,_,g,p,u,v){"use strict";return t.extend({init:function(e){this._getSelectorManager=e.getSelectorManager,this._getAppParams=e.getAppParams,this._getRoots=e.getRoots,this._getSelection=e.getSelection,this._isCmdActivated=!1,this._rootsRevisionInSession={},this._selectionCrossWidget=-1,this._selectByEvent=-1,n.subscribe("NGFilter.SetDefaultSecurityContext",this._onSetSecurityContext.bind(this))},execute:function(){if(n.publish("NGFilter_LaunchFilterCmd"),this._onCriterionBeingEdited({}),this._isCmdActivated){var e=this._getAppParams.call();this._NGFUXId=e.NGFUXId||e.appId,this._appId=e.appId,this._launchAdvFilter().then(function(){})}else{var t=this;this._initialize().then(function(){t._isCmdActivated=!0,t._launchAdvFilter().then(()=>{})},function(e){i.error("Error Filter Command: "+e)})}},getCmdAvailability:function(){return this._SelectedID?1:0},_onSelectByENOEvent:function(e){this._selectionCrossWidget=1,this._selectByEvent=-1===this._selectByEvent?1:this._selectByEvent,this._selectByEvent&&this._setSelectionFromEvent(e)},_onSelectByPADUtilsEvent:function(e){this._selectionCrossWidget=1,this._selectByEvent=-1===this._selectByEvent?0:this._selectByEvent,!this._selectByEvent&&this._setSelectionFromEvent(e)},_setSelectionFromEvent:v.debounce(function(e){let t=this;if(this._isCmdActivated&&!this._isCriterionBeingEdited&&e.data.paths&&e.data.paths.length){if(this._widgetId===e.metadata.originWidgetId){let e=this._getRootsAndSelection(!1);this._completeRootsInfos(e).then(function(){t._setSelectionAndUpdateFilter(e)})}}},500),_checkSelection:v.debounce(function(e){let t=this;if(1>this._selectionCrossWidget&&(this._selectionCrossWidget=0,e&&this._isCmdActivated&&!this._isCriterionBeingEdited)){var i=this._getRootsAndSelection(!1);this._completeRootsInfos(i).then(function(){t._setSelectionAndUpdateFilter(i)})}},200),_initialize:function(){var e=this;return new Promise(function(t,o){e._widget=widget;var s=Date.now(),r=e._getAppParams.call(),a=Date.now()-s;e._displayInternalDurationTrace("Command.getAppParams",a),e._NGFUXId=r.NGFUXId||r.appId,e._appId=r.appId,e._widgetId=r.widgetId,e._tenantId=r.tenantId||e._getTenantId();var l=e._NGFUXId+"-"+e._widgetId;e._defaultSC=sessionStorage.getItem("NGFilter_SecurityContext_"+l),e._queryFormat=sessionStorage.getItem("NGFilter_ExpandType_"+l)||p.getQueryFormat(),e._expandIntent=sessionStorage.getItem("NGFilter_ExpandIntent_"+l)||p.getExpandIntent(),s=Date.now(),e._SelectorManager=e._getSelectorManager.call();var d=Date.now()-s;if(e._displayInternalDurationTrace("Command.getSelectorManager",d),e._SelectorManager){var c=e._SelectorManager.onPostAdd,h=e._SelectorManager.onPostRemove,_=e._SelectorManager.onEmpty;if(c&&h&&_)e._SelectorManager.onPostAdd(e._checkSelection.bind(e)),e._SelectorManager.onPostRemove(e._checkSelection.bind(e)),e._SelectorManager.onEmpty(e._checkSelection.bind(e));else{var g=(c?"":" onPostAdd()")+(h?"":" onPostRemove()")+(_?"":" onEmpty()");i.error("Function not implemented = "+g),o(g)}}else e._selectionCrossWidget=1;p.setPerformanceTracker(e._widgetId,"NGF-Cmd_App_Data","NGFilter_Cmd",{AppParams_duration:a,SelectorManager_duration:d},0),n.subscribe("NGFilter.RemoveFilter",e._onRemoveFilter.bind(e)),n.subscribe("NGF_Criterion_Edition",e._onCriterionBeingEdited.bind(e)),n.subscribe("DS/ENO/select",e._onSelectByENOEvent.bind(e)),n.subscribe("DS/PADUtils/PADCommandProxy/select",e._onSelectByPADUtilsEvent.bind(e)),t()})},_launchAdvFilter:function(){var e=this;return p.setUsageTracker(this._widgetId,"NGF-Launch-Filter",this._getAppId()),new Promise(function(t,i){var n=e._getRootsAndSelection(!0),o=n.roots,s=o?o.length:0;s?e._completeRootsInfos(n).then(function(){if(n.label=[],o.forEach(function(e){n.label.push([e.label])}),1===s)e._setSelectionAndUpdateFilter(n),e._openFilterPanel();else if(1===n.path.length)if(1===n.path[0].length){for(var i=n.path[0][0],r=0;r<n.roots.length;r++)if(i===n.roots[r].id){n.label=[n.label[r]],n.roots=[n.roots[r]];break}e._setSelectionAndUpdateFilter(n),e._openFilterPanel()}else e._displayAndSelectRoot(o,n.path);else e._displayAndSelectRoot(o,n.path);t()}):t()})},_onSetSecurityContext:function(e){this._NGFUXId===e.NGFUXId&&this._defaultSC!==e.securityContext&&(this._defaultSC=e.securityContext)},_setFocusToWidget:function(){this._widget&&this._widget.dispatchEvent("onViewRequest",{focus:!0})},_completeRootsInfos:function(e){var t=this;return new s(function(n,o){var s=e.roots||[];if(s&&s.length){var r=!1,a=!1,l=[];if(s.forEach(e=>{l.push({rootId:e.id,serviceId:e.serviceId}),r=!(!r&&e.label),t._rootsRevisionInSession[e.id]||(t._rootsRevisionInSession[e.id]={}),e.revision=t._rootsRevisionInSession[e.id].revision?t._rootsRevisionInSession[e.id].revision:e.revision,a=!(!a&&e.revision)}),1!==s.length||r){var d=["ds6w:label","ds6wg:revision"],c=p.getDisplaySeparator(),h=[];(r||a)&&(h=h.concat(u.getOption("displayRoot_AttributesTitle"))||d,r&&h.push("ds6w:label"),a&&h.push("ds6wg:revision")),h=[...new Set(h)];var _=u.getOption("displayRoot_AttributesLevel1")||[],v=u.getOption("displayRoot_AttributesLevel2")||[],m=h.concat(_).concat(v);m=(m=[...new Set(m)]).length?m:d,g.getPredicatesInfosFromIds(l,m,!0,t._defaultSC).then(e=>{s.forEach(i=>{var n=e.find(e=>i.id===e.id);if(n){i.thumbnail=n.thumbnail,i.icon=n.icon;let e=n.predicates.length;var o=[];if(r&&(i.label="",h.forEach(t=>{for(var i=0;i<e;i++){var s=n.predicates[i];if(s.name.endsWith(t)){o.push(s.dispValue||s.value);break}}}),o.length&&(i.label=o.join(c))),a)for(var s=0;s<e;s++){var l=n.predicates[s];if("ds6wg:revision"===l.name){i.revision=l.value,t._rootsRevisionInSession[i.id].revision=i.revision;break}}i.values="";var d=["values","description"];[_,v].forEach((t,s)=>{o=[],t.forEach(t=>{for(var i=0;i<e;i++){var s=n.predicates[i];if(s.name.endsWith(t)){o.push(s.value);break}}}),o.length&&(i[d[s]]=o.join(c))})}}),n()},function(e){i.error("Advanced Filter: Error to retrieve Roots infos !"),n()})}else a?t._retrieveRevision(l).then(function(e){s.forEach(i=>{i.revision=e[i.id]||"",t._rootsRevisionInSession[i.id].revision=i.revision}),n()}):(t._rootsRevisionInSession[s[0].id].revision=s[0].revision,n())}else n()})},_retrieveRevision:function(e){var t=this,n={};e.length;return new s(function(o,s){g.getPredicatesInfosFromIds(e,["ds6wg:revision"],!1,t._defaultSC).then(function(t){e.forEach(e=>{var i,o=e.rootId,s=t.findIndex(e=>o===e.id);-1!==s&&(s=(i=t[s].predicates).findIndex(function(e){return"ds6wg:revision"===e.name})),n[o]=-1===s?"":i[s].value}),o(n)},function(e){i.error("Advanced Filter: Error to retrieve Roots revisions !"),o(n)})})},_getRootsAndSelection:function(e){var t,i={},n=void 0,o=Date.now();(n=this._getRoots.call()).forEach(e=>{e.serviceId=e.serviceId||"3DSpace"}),t=Date.now()-o,this._displayInternalDurationTrace("Command.getRoots",t);o=Date.now();var s=this._getSelection.call(),r=Date.now()-o;this._displayInternalDurationTrace("Command.getSelection",r);var a=0!==this._selectionCrossWidget||!1!==s.directSelection;if(a=!!this._isSelectionBeingEdited||a,!e){var l=[];if(s.path.forEach(e=>{var t=n.find(t=>e[0]===t.id);t&&l.push(t.serviceId)}),s.serviceId=l,!(!s.path||1!==s.path.length||1!==s.path[0].length)){if(this._isCmdActivated){let e=this._getAppParams.call();this._NGFUXId=e.NGFUXId||e.appId,this._appId=e.appId}n=[{id:s.path[0][0],label:s.label?s.label[0][0]:void 0,serviceId:s.serviceId[0]}]}else n=void 0,p.setUsageTracker(this._widgetId,"NGF-Cmd_App_Selection",this._getAppId())}return a&&(i={roots:n,path:s.path,label:s.label,serviceId:s.serviceId}),p.setPerformanceTracker(this._widgetId,"NGF-Cmd_App_Selection","NGFilter_Cmd",{RootsSelection_duration:t,Selection_duration:r},1),i},_setSelectionAndUpdateFilter:function(e){if(this._SelectedID=void 0,e.roots){if(!this._isSelectionBeingEdited){let t=e.roots[0];this._SelectedID=t.id,this._setFocusToWidget(),this._updateFilterPanel(e)}}else if(e.path&&e.path.length){1>this._selectionCrossWidget&&(e.NGFUXId=this._NGFUXId,e.widgetId=this._widgetId,n.publish("NGFilter.OccPath",e))}},_updateFilterPanel:function(e){var t=e.roots[0];if(this._SelectedID=t.id,this._NGFUXId&&this._widgetId){var i=sessionStorage.getItem("NGFilter_AppQueryParam_"+this._NGFUXId+"_"+this._widgetId);i=i?JSON.parse(i):{};var o={appId:this._NGFUXId,widgetId:this._widgetId,rootID:this._SelectedID,rootAlias:t.label,cmdArgs:this.cmdArgs,widgetTenant:this._tenantId,appQueryParam:i,referenceTime:Date.now(),NGFUXId:this._NGFUXId,rootRevision:t.revision,securityContext:this._defaultSC,queryFormat:this._queryFormat,expandIntent:this._expandIntent,rootServiceId:t.serviceId};n.publish("Frame3DXInfra.Update",{type:"Filter",options:o})}},_getTenantId:function(){var e="OnPremise";return this._widget&&(e=this._widget.getValue("x3dPlatformId")||e),e},_getAppId:function(){return this._widget&&this._widget.getValue("x3dAppId")||""},_openFilterPanel:function(){n.publish("Frame3DXInfra.Open",{identifier:"Filter_"+this._NGFUXId+"_"+this._widgetId+"_"+this._SelectedID})},_displayAndSelectRoot:function(e,t){var i=Date.now(),n=this._buildRootTiles(e);this._displayInternalDurationTrace("displayAndSelectRoot / buildRootTiles, ",Date.now()-i);var o=new a({identifier:"NGF_RootsToFilter"});o.inject(document.body);var s=this,d=new l({domId:"NGF_RootsToFilter",immersiveFrame:o,width:490,height:270,title:r.get("RootsToFilter"),content:n,modalFlag:!0,resizableFlag:!0,closeButtonFlag:!1,buttons:{Ok:new c({emphasize:"secondary",disabled:!0,onClick:s._onOKDialog.bind(s)}),Close:new c({onClick:s._onCloseDialog.bind(s)})}});if(n.onSelectionAdd(function(e){s._selectedTile=e.options.rootToFilter,d.buttons.Ok.disabled=!s._selectedTile}),n.onSelectionRemove(function(e){0===n.getTreeDocument().getSelectedNodes().length&&(d.buttons.Ok.disabled=!0)}),n.onReady(function(e){s._displayInternalDurationTrace("displayAndSelectRoot / rootTiles.onReady, ",Date.now()-i),s._rootToSelect&&n.selectNodeModel(s._rootToSelect),s._displayInternalDurationTrace("displayAndSelectRoot / rootTiles.onReady.selectNodeModel, ",Date.now()-i)}),t&&1===t.length){var h=t[0]&&t[0].length?t[0][0]:"";if(h.length){var _=n.getTreeDocument().getChildren();this._rootToSelect=_.find(e=>h===e.options.rootToFilter.id)}}},_onOKDialog:function(e){var t={roots:[this._selectedTile],path:[[this._selectedTile.id]],label:[[this._selectedTile.label]]};let i=this;this._completeRootsInfos(t).then(function(){i._setSelectionAndUpdateFilter(t),i._openFilterPanel(),e.dsModel.dialog.close()})},_onCloseDialog:function(e){this._selectedTile=void 0,e.dsModel.dialog.close(),n.publish("Frame3DXInfra.onPanelClose",{tag:"dataFilterPanelCtn"})},_buildRootTiles:function(e){for(var t=o.getWebappsAssetUrl("ENONextGenFilterCmd","icons/32/I_DefaultRootFilterThumbnail.png"),i=new h({shouldAcceptDrag:function(){return!1}}),n=e.length,s=0;s<n;s++){var r=new _({label:e[s].label+(e[s].revision?" - "+e[s].revision:""),subLabel:e[s].values,thumbnail:e[s].thumbnail||t,icons:[e[s].icon],multipleTitleLineNumber:!1,emptyStatusbarVisibleFlag:!!e[s].filtered,statusbarIcons:e[s].filtered?["filter"]:[],rootToFilter:e[s],description:e[s].description});i.addChild(r)}var a=new d({model:i,useDragAndDrop:!1,selectionBehavior:{unselectAllOnEmptyArea:!0,toggle:!0,canMultiSelect:!1,canInteractiveMultiselectWithCheckboxClick:!1,enableShiftSelection:!1,enableFeedbackForActiveCell:!1}});return a.model=i,a},_onRemoveFilter:function(e){if(this._NGFUXId===e.NGFUXId&&e&&e.rootIds){var t=this;e.rootIds.forEach(e=>delete t._rootsRevisionInSession[e])}},_onCriterionBeingEdited:function(e){let t=e.type,i=e.state;this._isCriterionBeingEdited=i&&t?1:0,this._isSelectionBeingEdited=this._isCriterionBeingEdited&&"context"===t?1:0},_displayInternalDurationTrace:function(e,t){p.isDebugActive("elapsedTime")&&console.log("=====> "+e+" / elapsed time (ms) = "+t)}})}),define("DS/ENONextGenFilterCmd/commands/ENOAdvancedFIlterCmdV2.js",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmdEngine","UWA/Core","UWA/Class","DS/Logger/Logger"],function(e,t,i,n){"use strict";return i.extend({getAppParams:function(){n.error("Filter Command ......  The getAppParams() function is not implemented !");return{}},getSelectorManager:function(){n.error("Filter Command ......   The getSelectorManager() function is not implemented !")},getRoots:function(){},getSelection:function(){return{}},beginExecute:function(){if(!this._isCmdActivated&&(this._advFilter=new e({getSelectorManager:this.getSelectorManager.bind(this),getAppParams:this.getAppParams.bind(this),getRoots:this.getRoots.bind(this),getSelection:this.getSelection.bind(this)}),this._isCmdActivated=!0,this.getAppParams)){var t=this.getAppParams();this._appId=t.appId,this._widgetId=t.widgetId,this._NGFUXId=t.NGFUXId||this._appId}this._advFilter.execute()},getAvailability:function(){return this._isCmdActivated&&this._advFilterMgr?this._advFilterMgr.getCmdAvailability():0}})}),define("DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmd",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmdEngine","UWA/Core","DS/ApplicationFrame/Command","DS/Logger/Logger"],function(e,t,i,n){"use strict";return i.extend({getAppParams:function(){n.error("Filter Command ......  The getAppParams() function is not implemented !");return{}},getSelectorManager:function(){n.error("Filter Command ......   The getSelectorManager() function is not implemented !")},getRoots:function(){},getSelection:function(){return{}},init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1});var t=[],i=[],n=arguments[0].arguments;if(Array.isArray(n)&&n.length)for(var o=n.length,s=0;s<o;s++)t.push(n[s].ID),i.push(n[s].Value);this.cmdArgs={id:t,values:i},this._isCmdActivated=!1},execute:function(){if(!this._isCmdActivated&&(this._advFilterMgr=new e({getSelectorManager:this.getSelectorManager.bind(this),getAppParams:this.getAppParams.bind(this),getRoots:this.getRoots.bind(this),getSelection:this.getSelection.bind(this)}),this._isCmdActivated=!0,this.getAppParams)){var t=this.getAppParams();this._appId=t.appId,this._widgetId=t.widgetId,this._NGFUXId=t.NGFUXId||this._appId}this._advFilterMgr.execute()},getAvailability:function(){return this._isCmdActivated&&this._advFilterMgr?this._advFilterMgr.getCmdAvailability():0}})});