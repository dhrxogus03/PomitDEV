define("DS/CAT3DWInfraUI/CAT3DWHandleManipulator",["UWA/Core","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Manipulators/PointHandle","DS/CoreEvents/Events","DS/WebUtils/ContextedSingleton","DS/WebappsUtils/WebappsUtils","DS/CAT3DWSceneObject/CAT3DWConnectableObject"],function(t,e,i,o,n,s,a,r,l){"use strict";var h=n.extend({init:function(t){if(!t.media&&!t.group)throw Error('"DS/CAT3DWInfraUI/CAT3DWHandleManipulator" constructor missing config parameter "media" or "group"');if(!t.planeChoiceNode)throw Error('"DS/CAT3DWInfraUI/CAT3DWHandleManipulator" constructor missing config parameter "planeChoiceNode"');if(this._parent(t),this.name=t.name||"",this._viewer=t.viewer,this._planeChoiceNode=t.planeChoiceNode,this._refPlane=new i.Plane,this._setReferencePlane(),this.annotationManager=a.get(null,"ANNOTATION_MANAGER"),this._mediaController=t.mediaController,t.media?this.objects=[t.media]:t.group&&this.setGroup(t.group),this.setMatrix((new i.Matrix4).setPosition(this._getPosition())),this._isRotationActivated=!0,this._isScaleActivated=!0,this._isSnappingForImageActivated=!0,this._maxSuccessfulScaleRatio=1,this._authorizeTextScaling=!0,this._onBeginPreactivateCB=this._onBeginPreactivate.bind(this),this.subscribe("BeginPreactivate",this._onBeginPreactivateCB),this._onEndPreactivateCB=this._onEndPreactivate.bind(this),this.subscribe("EndPreactivate",this._onEndPreactivateCB),this._onBeginManipulateCB=this._onBeginManipulate.bind(this),this._onManipulateCB=this._onManipulate.bind(this),this._onEndManipulateCB=this._onEndManipulate.bind(this),this.subscribe("BeginManipulate",this._onBeginManipulateCB),this.subscribe("Manipulate",this._onManipulateCB),this.subscribe("EndManipulate",this._onEndManipulateCB),this._beginManipulateCB=t.beginManipulate,this._manipulateCB=t.manipulate,this._endManipulateCB=t.endManipulate,this._updateAllOtherHandlers=t.updateAll,this._subscribeEvents(),"rotationHandler"===t.name){var e=r.getWebappsAssetUrl("CAT3DWInfraUI","/icons/CAT3DWRotateHandle.png"),o=new i.ImageUtils._loadTextureWithProxy(e,void 0,null,null,i.ImageUtils.crossOriginPolicy);this.pointMat.map=o}},dispose:function(){if(this._group&&(this._group=null),this._manipulator&&(this.sceneGraph.add(this),this._manipulator=null),this.unsubscribe("BeginPreactivate",this._onBeginPreactivateCB),this.unsubscribe("EndPreactivate",this._onEndPreactivateCB),this.unsubscribe("BeginManipulate",this._onBeginManipulateCB),this.unsubscribe("Manipulate",this._onManipulateCB),this.unsubscribe("EndManipulate",this._onEndManipulateCB),this._viewer.currentViewpoint.setControlActive(!0),this._objectsPickability){for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}this.objects=null,this._viewer=null,this._unsubscribeEvents(),this._parent()},subscribe:function(t,e){this["_"+t+"Token"]&&this.unsubscribe(this["_"+t+"Token"]),this["_"+t+"Token"]=this._parent(t,e)},unsubscribe:function(t){this["_"+t+"Token"]&&(this._parent(this["_"+t+"Token"]),this["_"+t+"Token"]=null)},_subscribeEvents:function(){this._onViewpointToken||(this._onViewpointToken=s.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType?this.update(!0):"@onViewpointEndMove"===t.eventType&&this.update(!0)}.bind(this)))},_unsubscribeEvents:function(){this._onViewpointToken&&s.unsubscribe(this._onViewpointToken),this._onViewpointToken=null},setManipulationCallbacks:function(t,e,i){this._beginManipulateCB=t,this._manipulateCB=e,this._endManipulateCB=i},setGroup:function(t){this._group=t,this.objects=this._group.getObjects(),this.update(!1)},hideManipulator:function(){this.setVisibility(!1)},showManipulator:function(){this._group&&this._group.isLocked()||this.setVisibility(!0)},getManipulatedObject:function(){return this._group?this._group:this.objects[0]},getLastTimestamp:function(){return this._timestamp},isActivated:function(){return this._activated||this._manipulating},setReferencePlane:function(t){this._refPlane=t},getReferencePlane:function(){return this._refPlane},setRotationActivation:function(t){this._isRotationActivated=t},isRotationActivated:function(){return this._isRotationActivated},setScaleActivation:function(t){this._isScaleActivated=t},isScaleActivated:function(){return this._isScaleActivated},setSnappingForImageActivation:function(t){this._isSnappingForImageActivated=t},isSnappingForImageActivated:function(){return this._isSnappingForImageActivated},update:function(t=!0,e){t&&this._updateAllOtherHandlers&&this._updateAllOtherHandlers(e),this.isPaused()||(this.setMatrix((new i.Matrix4).setPosition(this._getPosition())),this._viewer.render())},pause:function(){this._manipulator||(this._manipulator=this,this.sceneGraph.remove(this),this._unsubscribeEvents()),this._viewer.render()},isPaused:function(){return!!this._manipulator},resume:function(){this._manipulator&&(this._manipulator=null,this.sceneGraph.add(this),this._subscribeEvents(),this.update(!1)),this._viewer.render()},move:function(t){var e=this.getMatrix(),o=(new i.Vector3).getPositionFromMatrix(e);o.add(t),e.setPosition(o),this.setMatrix(e)},getScreenPosition:function(){return e.compute2DPointFrom3DPoint(this._getPosition(),this._viewer)},_onBeginPreactivate:function(){if(!this._manipulating){this._objectsPickability=[];for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]=this.objects[t].getPickable(),this.objects[t].setPickable(o.NOPICKABLE)}this._activated=!0},_onEndPreactivate:function(){if(!this._manipulating&&this._objectsPickability){for(var t=0;t<this.objects.length;t++)this._objectsPickability[t]&&this.objects[t].setPickable(o.PICKABLE);this._objectsPickability=null}this._activated=!1},_onBeginManipulate:function(t){this._timestamp=Date.now(),this.setPickable(o.PICKTHROUGH);var n=this._getPosition(),s=e.compute2DPointFrom3DPoint(n,this._viewer);if(this._planeChoiceNode)this._refPlane.setFromNormalAndCoplanarPoint(this._planeChoiceNode.getNormal().negate(),this._planeChoiceNode.getCenter()),this._refPlaneU=this._planeChoiceNode.getUDirection();else{this._refPlane||(this._refPlane=(new i.Plane).setFromNormalAndCoplanarPoint((new i.Vector3).subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.camera.position).normalize(),new i.Vector3(0,0,0)));var r=this._viewer.currentViewpoint.getUpDirection(),l=this._refPlane.normal;this._viewer.currentViewpoint.getSightDirection().dot(l)>0&&l.negate(),this._refPlaneU=(new i.Vector3).crossVectors(r,l),this._refPlaneU.normalize()}const h=this.getManipulatedObject();this._originalMatrix=h.getCurrentTransformation?h.getCurrentTransformation():h.getMatrix();const c=(new i.Vector3).getPositionFromMatrix(this._originalMatrix);this._originalTranslationMatrix=(new i.Matrix4).makeTranslation(c.x,c.y,c.z),this._originalRotation=(new i.Matrix4).extractRotation(this._originalMatrix),this._originalMatrix.setPosition(new i.Vector3(0,0,0)),this._refOrigin2D=e.compute2DPointFrom3DPoint(c,this._viewer),this._centerOnRefPlane=this._refPlane.projectPoint(c),this._rotationVector=(new i.Vector3).subVectors(this._refPlane.projectPoint(n),this._centerOnRefPlane).normalize(),this._angleConeHeigth=180*new i.Vector3(1,0,0).angleTo(new i.Vector3(s.x,s.y,0).sub(new i.Vector3(this._refOrigin2D.x,this._refOrigin2D.y,0)))/Math.PI,this._rotationActivated=!1;var d=new i.Vector3,p=new i.Vector3,u=new i.Vector3;this._originalRotation.extractBasis(d,p,u);var g=d.dot(this._refPlaneU),m=new i.Vector3;Math.abs(g)>.5?(m.copy(d),this._originalRight=new i.Vector3(1,0,0)):(g=p.dot(this._refPlaneU),Math.abs(g)>.5?(m.copy(p),this._originalRight=new i.Vector3(0,1,0)):(m.copy(u),this._originalRight=new i.Vector3(0,0,1))),g<0&&(m.negate(),this._originalRight.negate());var f=(new i.Vector3).crossVectors(this._refPlane.normal,m),b=this._refPlaneU.dot(f)>0?1:-1;this._snapMatrix=(new i.Matrix4).makeRotationAxis(this._refPlane.normal,b*m.angleTo(this._refPlaneU)),this._manipulating=!0,this._beginManipulateCB&&this._beginManipulateCB(t);let v=h.getManipulatorsPositions();if(this._widthMargin=0,h.getPreciseCorners){let t=v.topLeft.distanceTo(v.topRight),e=(v=h.getPreciseCorners()).topLeft.distanceTo(v.topRight);this._widthMargin=(t-e)/2}let _=()=>{let t=(new i.Vector3).subVectors(this.movingCorner,this.fixedCorner);this._fixedToMovingCornerDistance=t.length(),this._fixedToMovingCornerDir=t.normalize()};if(this._lastTimestamp=Date.now(),"bottomRightHandler"===this.name)this.movingCorner=v.bottomRight,this.fixedCorner=v.topLeft,this._scaleVector=new i.Vector3(1,1,1),_();else if("bottomLeftHandler"===this.name)this.movingCorner=v.bottomLeft,this.fixedCorner=v.topRight,this._scaleVector=new i.Vector3(1,1,1),_();else if("topRightHandler"===this.name)this.movingCorner=v.topRight,this.fixedCorner=v.bottomLeft,this._scaleVector=new i.Vector3(1,1,1),_();else if("topLeftHandler"===this.name)this.movingCorner=v.topLeft,this.fixedCorner=v.bottomRight,this._scaleVector=new i.Vector3(1,1,1),_();else if("rightCenterHandler"===this.name)this.movingCorner=v.topRight.clone().sub(v.bottomRight).multiplyScalar(.5).add(v.bottomRight),this.fixedCorner=v.topLeft.clone().sub(v.bottomLeft).multiplyScalar(.5).add(v.bottomLeft),this._scaleVector=new i.Vector3(0,1,0),_();else if("leftCenterHandler"===this.name)this.movingCorner=v.topLeft.clone().sub(v.bottomLeft).multiplyScalar(.5).add(v.bottomLeft),this.fixedCorner=v.topRight.clone().sub(v.bottomRight).multiplyScalar(.5).add(v.bottomRight),this._scaleVector=new i.Vector3(0,1,0),_();else if("topCenterHandler"===this.name)this.movingCorner=v.topLeft.clone().sub(v.topRight).multiplyScalar(.5).add(v.topRight),this.fixedCorner=v.bottomLeft.clone().sub(v.bottomRight).multiplyScalar(.5).add(v.bottomRight),this._scaleVector=new i.Vector3(1,0,0),_();else if("bottomCenterHandler"===this.name)this.movingCorner=v.bottomLeft.clone().sub(v.bottomRight).multiplyScalar(.5).add(v.bottomRight),this.fixedCorner=v.topLeft.clone().sub(v.topRight).multiplyScalar(.5).add(v.topRight),this._scaleVector=new i.Vector3(1,0,0),_();else if("connectionHandlerPointA"===this.name){this._isScaleActivated=!1;let t=this.objects[0].getConnection();this._previousDepth=t.getView().getDepth();let e=a.get(null,"HISTORY_MANAGER");e&&e.registerAction(this._lastTimestamp,[t],!1)}else if("connectionHandlerPointB"===this.name){this._isScaleActivated=!1;let t=this.objects[0].getConnection();this._previousDepth=t.getView().getDepth();let e=a.get(null,"HISTORY_MANAGER");e&&e.registerAction(this._lastTimestamp,[t],!1)}},_onManipulate:function(){const t=new i.Matrix4,o=new i.Vector3,n=new i.Matrix4,s=new i.Vector3;let a,r,l;return function(h){var c=h.event.from[0]._currentPosition,d=h.viewer.canvas.getBoundingClientRect().top,p=h.viewer.canvas.getBoundingClientRect().left;c=new i.Vector2(c.x-p,c.y-d);var u=e.compute3DPointFrom2DPoint(c,this._refPlane,this._viewer);if(this.isRotationActivated()&&"rotationHandler"===this.name&&!this._rotationActivated){var g=180*new i.Vector3(1,0,0).angleTo(new i.Vector3(c.x,c.y,0).sub(new i.Vector3(this._refOrigin2D.x,this._refOrigin2D.y,0)))/Math.PI;this._rotationActivated=Math.abs(this._angleConeHeigth-g)>5}if(this._rotationActivated){var m=new i.Matrix4,f=(new i.Vector3).subVectors(u,this._centerOnRefPlane).normalize(),b=(new i.Vector3).crossVectors(this._rotationVector,f),v=this._rotationVector.dot(f),_=1/(1+v);if(m.set(b.x*b.x*_+v,b.y*b.x*_-b.z,b.z*b.x*_+b.y,0,b.x*b.y*_+b.z,b.y*b.y*_+v,b.z*b.y*_-b.x,0,b.x*b.z*_-b.y,b.y*b.z*_+b.x,b.z*b.z*_+v,0,0,0,0,1),this.isSnappingForImageActivated()&&(this.objects.length>1||!this.objects[0].parents||"images"===this.objects[0].parents[0].name||"comparisons"===this.objects[0].parents[0].name||"texts"===this.objects[0].parents[0].name||"links"===this.objects[0].parents[0].name||"stickers"===this.objects[0].parents[0].name)){var D=m.clone().multiply(this._originalRotation),w=this._originalRight.clone().applyMatrix4(D),x=180*w.angleTo(this._refPlaneU)/Math.PI;if(x<=5||x>=85&&x<=95||x>=175&&x<=185){var y=(new i.Vector3).crossVectors(this._refPlane.normal,w),I=this._refPlaneU.dot(y)>0?-1:1;x=x>=85&&x<=95?90*I:x<=5?0:180,D.makeRotationAxis(this._refPlane.normal,x*Math.PI/180),D.multiply(this._snapMatrix),m.copy(D)}}n.copy(this._originalTranslationMatrix),n.multiply(m),n.multiply(this._originalMatrix),1===this.objects.length?this.objects[0].setTransformation(this._timestamp,n,!0):this._group.setTransformation(this._timestamp,n,!0),this.update(),this._viewer.render(),this._manipulateCB&&this._manipulateCB()}if("rotationHandler"!==this.name){const g=this.getManipulatedObject();if(a=g.getCurrentTransformation?g.getCurrentTransformation():g.getMatrix(),this.isScaleActivated()&&this._authorizeTextScaling?(s.subVectors(u,this.fixedCorner),(r=s.dot(this._fixedToMovingCornerDir)-this._widthMargin)<.1&&(r=.1),u.copy(this._fixedToMovingCornerDir).multiplyScalar(r).add(this.fixedCorner),o.copy(this._fixedToMovingCornerDir).multiplyScalar(.5*r).add(this.fixedCorner),l=r/this._fixedToMovingCornerDistance,t.makeScale(this._scaleVector.x?this._scaleVector.x*l:1,this._scaleVector.y?this._scaleVector.y*l:1,this._scaleVector.z?this._scaleVector.z*l:1)):(t.identity(),o.getPositionFromMatrix(a)),n.makeTranslation(o.x,o.y,o.z),n.multiply(this._originalMatrix),n.multiply(t),1===this.objects.length){if("connectionHandlerPointA"===this.name||"connectionHandlerPointB"===this.name){var T=e.compute3DPointFrom2DPoint(c,this._refPlane,this._viewer),C=this.objects[0].getConnection(),A=C.getConnectionPointA(),P=C.getConnectionPointB();const t=new i.Vector2(h.event.from[0]._currentPosition.x-p,h.event.from[0]._currentPosition.y-d);let o=this._doPickingDown(t);if(o){this._pickedObject!==this.previouslyPickedObject&&("connectionHandlerPointB"===this.name?this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==A.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject):"connectionHandlerPointA"===this.name&&this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==P.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject)),this._activateFeedback(this._pickedObject),this.previouslyPickedObject=this._pickedObject;let t=this._pickedObject;if(C.setAutoMode(!1),"connectionHandlerPointB"===this.name){if(t&&t.getID()!==A.getPointedObject().getID()){let e=t.getMediaObj?t.getMediaObj():t;P.setPointedObject({pointedObject:e});let n=e.getView().getCorners(),s=Math.abs(n.topRight.y-n.topLeft.y),a=Math.abs(n.bottomLeft.x-n.topLeft.x),r=(o.x-n.topLeft.x)/a*100,l=(o.y-n.topLeft.y)/s*100,h=new i.Vector3(r,l,50);P.setRelativePosition(h),P.setPosition(T),C.updateView({connectionPointB_ID:e.getID(),connectionPointB_position:T,connectionPointB_relativePosition:h,isAutoMode:!1,timestamp:this._lastTimestamp})}}else if("connectionHandlerPointA"===this.name&&t&&t.getID()!==P.getPointedObject().getID()){let e=t.getMediaObj?t.getMediaObj():t;A.setPointedObject({pointedObject:e});let n=e.getView().getCorners(),s=Math.abs(n.topRight.y-n.topLeft.y),a=Math.abs(n.bottomLeft.x-n.topLeft.x),r=(o.x-n.topLeft.x)/a*100,l=(o.y-n.topLeft.y)/s*100,h=new i.Vector3(r,l,50);A.setRelativePosition(h),A.setPosition(T),C.updateView({connectionPointA_ID:e.getID(),connectionPointA_position:T,connectionPointA_relativePosition:h,isAutoMode:!1,timestamp:this._lastTimestamp})}this._pickedObject=null,C.getView().setDepth(1/0),this._viewer.render()}else"connectionHandlerPointA"===this.name?this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==P.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject):"connectionHandlerPointB"===this.name&&this.previouslyPickedObject&&this.previouslyPickedObject.getID()!==A.getPointedObject().getID()&&this._deactivateFeedback(this.previouslyPickedObject),C.setAutoMode(!1),"connectionHandlerPointA"===this.name?(A.setMockObject(T),A.setRelativePosition(null),C.updateView({connectionPointA_ID:null,connectionPointA_position:T,connectionPointA_relativePosition:null,isAutoMode:!1,timestamp:this._lastTimestamp})):"connectionHandlerPointB"===this.name&&(P.setMockObject(T),P.setRelativePosition(null),C.updateView({connectionPointB_ID:null,connectionPointB_position:T,connectionPointB_relativePosition:null,isAutoMode:!1,timestamp:this._lastTimestamp})),this._viewer.render()}else this.objects[0].setTransformation(this._timestamp,n,!0);this.objects[0].parents&&"bbox"===this.objects[0].parents[0].name&&this.objects[0].updateShadowNode(this._refPlane)}else this._group.setTransformation(this._timestamp,n,!0);this.update(),this._viewer.render(),this._manipulateCB&&this._manipulateCB(h)}}}(),_onEndManipulate:function(t){if(this._originalMatrix=null,this._originalRotation=null,this.setPickable(o.PICKABLE),"connectionHandlerPointA"===this.name||"connectionHandlerPointB"===this.name){var e=this.objects[0].getConnection();null!==e.getConnectionPointA().getRelativePosition()&&null!==e.getConnectionPointB().getRelativePosition()&&e.getView().setDepth(this._previousDepth),e.setTransientPermanent();var i=a.get(null,"HISTORY_MANAGER");i&&i.registerAction(this._lastTimestamp,[e],!1)}var n=0;if(this._objectsPickability)for(n=0;n<this.objects.length;n++)this._objectsPickability[n]&&this.objects[n].setPickable(o.PICKABLE);if(this._endManipulateCB&&this._endManipulateCB(t),this._manipulating=!1,this._activated)for(n=0;n<this.objects.length;n++)this._objectsPickability[n]&&this.objects[n].setPickable(o.NOPICKABLE);else this._viewer.currentViewpoint.setControlActive(!0);this.update(!0,this.objects)},_getReferenceCorner:function(){if("CAT3DWModel"===this.objects[0].getType()&&"Interactive3D"===this.objects[0].getMediaObj().getDataService().getValue("viewType"))return this.objects[0].getBboxViewCorner();let t,o,n,s,a,r,l=(t=this._group?this._group:this.objects[0]).getManipulatorsPositions();switch(l.topLeft&&(n=l.topLeft,s=l.topRight,a=l.bottomRight,r=l.bottomLeft),this.name){case"scaleRotateHandler":o=a;break;case"topLeftHandler":o=n;break;case"topRightHandler":o=s;break;case"bottomLeftHandler":o=r;break;case"bottomRightHandler":o=a;break;case"rotationHandler":o=h.getRotationHandlePosition(t),o=e.compute3DPointFrom2DPoint(o,this._refPlane,this._viewer);break;case"topCenterHandler":o=new i.Vector3((n.x+s.x)/2,(n.y+s.y)/2,(n.z+s.z)/2);break;case"bottomCenterHandler":o=new i.Vector3((r.x+a.x)/2,(r.y+a.y)/2,(r.z+a.z)/2);break;case"rightCenterHandler":o=new i.Vector3((a.x+s.x)/2,(a.y+s.y)/2,(a.z+s.z)/2);break;case"leftCenterHandler":o=new i.Vector3((r.x+n.x)/2,(r.y+n.y)/2,(r.z+n.z)/2);break;case"connectionHandlerPointA":o=l.positionManipulatorA;break;case"connectionHandlerPointB":o=l.positionManipulatorB}return o},_getPosition:function(){return this._getReferenceCorner()},_setReferencePlane:function(){this._planeChoiceNode&&(this._refPlane.setFromNormalAndCoplanarPoint(this._planeChoiceNode.getNormal().negate(),this._planeChoiceNode.getCenter()),this._refPlaneU=this._planeChoiceNode.getUDirection())},_doPickingDown:function(t){this._pickingController=this.annotationManager.getPickingController();let e=this._pickingController.pick(t,!0,!0);if(e&&e.path){let t=!1;if("model3DNode"===e.path.externalPath[0].name||"images"===e.path.externalPath[0].name||e.path.externalPath[0].name===this._rootLinksNodeName||e.path.externalPath[0].name===this._rootStickersNodeName||e.path.externalPath[0].name===this._rootComparisonNodeName||"texts"===e.path.externalPath[0].name)"model3DNode"===e.path.externalPath[0].name?this._pickedObject=e.path.externalPath[2]:this._pickedObject=e.path.externalPath[1],t=this._pickedObject.getMediaObj().isThirdPartySelected();else if("annotGroupNode"===e.path.externalPath[0].name){let i=this.annotationManager.getAnnotationFromAnnotId(e.path.externalPath[2].annotID);this._pickedObject=i,t=this._pickedObject.isThirdPartySelected()}return!t&&this._pickedObject?e.point.position:(this._pickedObject=null,!1)}return!1},_activateFeedback:function(t){t.activateSelectionFeedback?t.activateSelectionFeedback():t.setMultiSelected&&t.setMultiSelected()},_deactivateFeedback:function(t){t.deactivateSelectionFeedback?t.deactivateSelectionFeedback():t.setMultiDeselected&&t.setMultiDeselected()},_getPortNearest:function(t,e){let i=e.get2DPortPositions();return Object.keys(i).reduce(function(e,o){return Math.hypot(t.x-i[e].pointCoordinates.x,t.y-i[e].pointCoordinates.y)<Math.hypot(t.x-i[o].pointCoordinates.x,t.y-i[o].pointCoordinates.y)?e:o})}});return h.getRotationHandlePosition=function(t,o=!1){let n,s,a,r,l=t.getManipulatorsPositions();l.topLeft&&(n=l.topLeft,s=l.topRight,a=l.bottomLeft,r=l.bottomRight);let h=new i.Vector3((n.x+s.x)/2,(n.y+s.y)/2,(n.z+s.z)/2),c=new i.Vector3((a.x+r.x)/2,(a.y+r.y)/2,(a.z+r.z)/2),d=(new i.Vector3).addVectors(c,h).multiplyScalar(.5),p=e.compute2DPointFrom3DPoint(d,t._viewer),u=e.compute2DPointFrom3DPoint(h,t._viewer),g=(new i.Vector2).subVectors(p,u);g.normalize();let m,f=2*p.distanceTo(u);return m=o?f>50?45:f-5:f>50?50:f,g.multiplyScalar(-m),(new i.Vector2).addVectors(g,u)},t.namespace("DS/CAT3DWInfraUI/CAT3DWHandleManipulator",h)}),define("DS/CAT3DWInfraUI/CAT3DWRenameReplaceDialog",["UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/LineEditor","DS/ApplicationFrame/FrameWindowsManager","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWRenameReplaceDialog"],function(t,e,i,o,n,s,a,r){"use strict";function l(t,e,i){return(t.replace(/\.[^.]*$/,"")||e)+"."+i}return{generateRenameReplaceDialog:function(e,h,c,d,p){var u="replace",g=new n({type:"radio",label:r.get("ReplaceOption"),checkFlag:!0}),m=new n({type:"radio",label:r.get("RenameOption")}),f=new s({sizeInCharNumber:40,value:d+"."+p,disabled:!0}),b=new t.createElement("div",{styles:{"margin-left":"22px","margin-top":"5px"},html:'<p style="margin-bottom:4px;">'+r.get("RenameDescription")+"</p>"});f.inject(b);var v=new t.createElement("div",{styles:{"margin-left":"10px","margin-top":"7px","margin-bottom":"15px"}});t.createElement("div",{styles:{"margin-bottom":"7px"}}).inject(v).textContent=c+"."+p,g.inject(v),m.inject(v),b.inject(v);var _=new t.createElement("div",{styles:{width:350,"margin-top":"10px","margin-left":"7px"},html:"<p>"+r.get("ReplaceDialogMessage")+"</p>"});v.inject(_);var D=a.getFrameWindow(),w=new i({immersiveFrame:D.getImmersiveFrame(),title:r.get("ReplaceDialogTitle"),closeButtonFlag:!1,content:_,buttons:{Ok:new o({label:r.get("ReplaceDialogAccept"),onClick:function(t){f.value=l(f.value,d,p);var i={type:u,newFilename:f.value};e(i)}}),Cancel:new o({onClick:function(t){h()}})}});return m.addEventListener("change",function(t){f.disabled=!m.checkFlag,u=m.checkFlag?"rename":"replace"}),f.addEventListener("blur",function(t){f.value=l(f.value,d,p)}),w}}}),define("DS/CAT3DWInfraUI/CAT3DWAssistantTool",["DS/Manipulators/Manipulator","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","UWA/Core"],function(t,e,i){"use strict";var o=e.extend({init:function(t,e,i,o){i||(i=e.getUIFrame());var n={body:i,viewer:t,frmWindow:e,heightElem:"28",widthElem:"28",offset:(o=o||{}).offset?o.offset:{x:-9,y:10},title:"Assistant tools Control",mode:o.mode?o.mode:"horizontal",dir:"left",lJsonElement:[]};this._parent(n),this.setVisibleFlag(!1)}});return i.namespace("DS/CAT3DWInfraUI/CAT3DWAssistantTool",o)}),define("DS/CAT3DWInfraUI/CAT3DWCopyLinkDialog",["UWA/Core","DS/Windows/Dialog","DS/ApplicationFrame/FrameWindowsManager","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWCopyLinkDialog","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i,o){"use strict";return{generateCopyLinkDialog:function(n,s){var a=s?o.get("RootFolderErrorMsg"):o.get("MainMsg"),r=new t.createElement("div",{class:"copylinkdialog-maindiv",html:"<p>"+a+"</p>"}),l=new t.createElement("div",{class:"copylinkdialog-copylinkdiv"});l.inject(r);var h=new t.createElement("input",{class:"copylinkdialog-sharebylinkinput"});h.value=n,h.disabled=!0,h.inject(l);var c=new t.createElement("button",{class:"copylinkdialog-copylinkbtn"});c.onclick=function(e){!function(e){var i=document.createElement("textarea");if(i.value=e,document.body.appendChild(i),t.Utils.Client.Platform.ios||t.Utils.Client.Platform.ipad){i.contentEditable=!0,i.readOnly=!0;var o=document.createRange();o.selectNodeContents(i);var n=window.getSelection();n.removeAllRanges(),n.addRange(o),i.setSelectionRange(0,i.value.length)}else i.select();document.execCommand("copy"),document.body.removeChild(i)}(n)},c.inject(l),new t.createElement("i",{class:"fonticon fonticon-link"}).inject(c),new t.createElement("span",{html:"  "+o.get("CopyLinkBtn")}).inject(c);var d=new t.createElement("div",{class:"copylinkdialog-openlinkdiv",html:"<p>"+o.get("OpenLinkMsg")+"</p>"});d.inject(r);var p=new t.createElement("button",{class:"copylinkdialog-openlinkbutton"});p.onclick=function(t){p.blur(),window.open(n,"_blank")},p.inject(d),new t.createElement("i",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-in-a-new-window"}).inject(p),new t.createElement("span",{html:"  "+o.get("OpenLinkBtn")}).inject(p);var u=i.getFrameWindow();return new e({immersiveFrame:u.getImmersiveFrame(),title:o.get("CopyLinkDialogTitle"),modalFlag:!0,content:r})}}}),define("DS/CAT3DWInfraUI/CAT3DWDataModelConverter",["UWA/Class","DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils","DS/Visualization/ThreeJS_DS"],function(t,e,i){"use strict";var o=t.extend({init:function(t){this._version=t.version,this._webapp=t.webapp,this._platformId=t.platformId,this._platformUrl=t.platformUrl,this._originUrl=t.originUrl,this._appName=t.appName,this._viewer=t.viewer,this._viewpoint=t.viewpoint,this._versionMap=new Map,this._versionMap.set("1.0",null),this._versionMap.set("2.0",this._from1Dot0To2Dot0.bind(this)),this._versionMap.set("2.1",this._from2Dot0To2Dot1.bind(this)),this._versionMap.set("3.0",this._from2Dot1To3Dot0.bind(this)),this._versionMap.set("4.0",this._from3Dot0To4Dot0.bind(this)),this._versionMap.set("5.0",this._from4Dot0To5Dot0.bind(this))},convertToLatestVersion:function(t){return new Promise(async function(e,i){var o=JSON.parse(t).ver;if(console.log("[CAT3DWDataModelConverter] START CONVERSION ..."),console.log("[CAT3DWDataModelConverter] The current version is "+this._version),console.log("[CAT3DWDataModelConverter] The json version is "+o),o!==this._version){if(!this._versionMap.has(o))return console.error("[CAT3DWDataModelConverter] The JSON version does not match any known version"),void i();var n=t,s=1;for(var[a,r]of this._versionMap)parseFloat(a)<=parseFloat(o)?s=a:(console.log("[CAT3DWDataModelConverter] From "+s+" to "+a),r&&(n=await r(n)),s=a);console.log("[CAT3DWDataModelConverter] ... CONVERSION FINISHED"),e(n)}else e(t)}.bind(this))},_from1Dot0To2Dot0:function(t){return new Promise(function(e){var i=JSON.parse(t);i.ver="2.0";var o=[];if(i.Textboxes&&i.Textboxes.length)for(let t=0;t<i.Textboxes.length;t++){let e=i.Textboxes[t],n={id:"",matrix:e.matrix,selectionGroupID:e.selectionGroupID,color:e.color,backgroundColor:"",text:e.text,renderDepth:e.renderDepth,locked:""},s=new UWA.Element("div",{styles:{position:"fixed",display:"block"}}),a=new UWA.Element("div",{styles:{fontSize:"66px",lineHeight:"90px",paddingTop:"0px",paddingLeft:"10px",paddingBottom:"0px",paddingRight:"10px"}}).inject(s);new UWA.Element("div",{styles:{whiteSpace:"pre",textAlign:"left"}}).inject(a).setText(e.text),s.inject(document.body),n.inputDimensions=a.getSize(),s.destroy(),s=null,o.push(n)}i.Textboxes=o,e(JSON.stringify(i))}.bind(this))},_from2Dot0To2Dot1:function(t){return new Promise(function(e){var o=JSON.parse(t);if(o.ver="2.1",o.Textboxes&&o.Textboxes.length)for(let t=0;t<o.Textboxes.length;t++){let e="",n=o.Textboxes[t];if(n.matrix){e=new i.Matrix4;let s=JSON.parse(n.matrix);if(e.setFromArray(s.elements),!n.worldDimensions){let n=e.getScaleOnAxisX(),s=e.getScaleOnAxisY(),a=e.getScaleOnAxisZ(),r=100;o.Textboxes[t].worldDimensions={width:r*n,height:r*s};let l=(new i.Matrix4).extractPosition(e),h=(new i.Matrix4).extractRotation(e);l.multiply(h);let c=(new i.Matrix4).makeScale(a,a,a);l.multiply(c),e=l}o.Textboxes[t].matrix=JSON.stringify(e)}}e(JSON.stringify(o))}.bind(this))},_from2Dot1To3Dot0:function(t){return new Promise(async function(n){var s=JSON.parse(t);if(s.links=[],s.ver="3.0",this._webapp===o.APP_3DWHITEBOARD){var a=new e({platformId:this._platformId,platformUrl:this._platformUrl,originUrl:this._originUrl,appName:this._appName}),r=function(t){return new Promise(function(e){var i=t.trim();i.startsWith("http://")||i.startsWith("https://")||(i="https://"+i),a.processLink(i).then(function(t){t.notreachable?e():e(t)}.bind(this))}.bind(this))}.bind(this),l=[];if(s.Textboxes&&s.Textboxes.length)for(let t=0;t<s.Textboxes.length;t++){if(s.Textboxes[t].backgroundColor){l.push(s.Textboxes[t]);continue}let e=s.Textboxes[t].text;if(!a.isLinkFormat(e.trim())){l.push(s.Textboxes[t]);continue}let o=await r(e);if(!o){l.push(s.Textboxes[t]);continue}let n=s.Textboxes[t];o.content||(o.content={});let p={id:n.id,renderDepth:n.renderDepth,url:o.url,locked:n.locked,selectionGroupID:n.selectionGroupID,matrix:"",linkData:{type:o.type,content_type:o.content_type,view_type:"small"}},u="";if(n.matrix){let t=new i.Matrix4,e=JSON.parse(n.matrix);t.setFromArray(e.elements);var h=new i.Vector3,c=new i.Quaternion,d=new i.Vector3;t.decompose(h,c,d);let o=n.worldDimensions.width/100;u=(new i.Matrix4).compose(h,c,new i.Vector3(o,o,1))}u&&(p.matrix=JSON.stringify(u)),"internal"===o.type?(p.smallViewThumbnailSubject6wuri=o.content.thumbnail_id,p.smallViewThumbnailPublished=o.content.thumbnail_published):p.smallViewThumbnailUrl=o.content.thumbnail_blob_url,o.content.title&&(p.linkData.title=o.content.title),o.content.author&&(p.linkData.author=o.content.author),o.content.community&&(p.linkData.community=o.content.community),o.content.description&&(p.linkData.description=o.content.description),o.content.mediaType&&(p.linkData.mediaType=o.content.mediaType),o.content.hostname&&(p.linkData.hostname=o.content.hostname),s.links.push(p)}s.Textboxes=l}else s.Textboxes=[];n(JSON.stringify(s))}.bind(this))},_from3Dot0To4Dot0:function(t){return new Promise(async function(e){var i=JSON.parse(t);i.stickers||this._webapp!==o.APP_3DWHITEBOARD||(i.stickers=[]),i.ver="4.0",e(JSON.stringify(i))}.bind(this))},_from4Dot0To5Dot0:function(t){return new Promise(async function(e){var i=JSON.parse(t);if(i.Textboxes&&i.Textboxes.length)for(let t=0;t<i.Textboxes.length;t++){if(i.Textboxes[t].inputDimensions){let e=i.Textboxes[t].inputDimensions;i.Textboxes[t].inputDimensions={width:e.width/3,height:e.height/3}}i.Textboxes[t].fontStyle="normal",i.Textboxes[t].fontWeight="normal",i.Textboxes[t].textAlign="left",i.Textboxes[t].fontFamily="GochiHand",i.Textboxes[t].fontSize=22,i.Textboxes[t].lineHeight=30}i.ver="5.0",e(JSON.stringify(i))}.bind(this))}});return o.APP_3DWHITEBOARD="3dwhiteboard",o.APP_3DSKETCH="3dsketch",o}),define("DS/CAT3DWInfraUI/CAT3DSKHistoryManager",["UWA/Class","DS/ApplicationFrame/CommandsManager","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CoreEvents/Events"],function(t,e,i,o){"use strict";var n=t.extend({init:function(t){this._annotationManager=t.annotationManager,this._mediaController=t.mediaController,this._objectsStateID={},this._actionsHistory=[],this._undoableActions=[],this._redoableActions=[],this._objectActionList=[],this._objectList=[],this._isWhiteboard="whiteboard"===i.getPreferenceValue("appMode"),this._selectionCmd=e.getCommand("SelectionCmd"),this._debugTraces=!1,this._undoStack=[],this._redoStack=[],this._V2=!0},registerAction:function(t,e,i=!1){let s=[];for(let i=0;i<e.length;i++)e[i].hasAction(t)&&s.push(e[i]);s.length?(i?this._undoStack=[]:this._undoStack.push({timestamp:t,objects:s}),this._redoStack=[]):i&&(this._undoStack=[]),o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{timestamp:t,objects:s,isEmpty:!!i,isRedoEmpty:!0,updateType:n.UPDATE_TYPE.NEW_ACTION}})},registerLayersChange:function(){this._objectActionList=[],this._objectList=[],this._registerLayersChange()&&this._registerNewAction(n.UPDATE_TYPE.NEW_COMPLEX_ACTION)},_registerLayersChange:function(){let t=this._mediaController.getDepthOrder();if(!t.length)return!1;var e,i=void 0,o=null,s=t,a=this._objectsStateID.LAYERS;return a?(i=a.updateID,a.updateID++,o=n.ACTION.EDITED):((a={object:this._mediaController,objectType:n.DATA_TYPE.LAYERS,updateID:0,actions:{}}).actions[n.ACTION.EDITED]=[{actionsIndex:this._actionsHistory.length,objectsIndex:this._objectActionList.length}],this._objectsStateID.LAYERS=a,o=n.ACTION.CREATED),e=a.updateID,this._objectActionList.push({id:"LAYERS",type:n.DATA_TYPE.LAYERS,precedentUpdateID:i,newUpdateID:e,action:o,actionData:s}),this._objectList.push(this._mediaController),!0},_registerNewAction:function(t){var e={timestamp:Date.now(),objectActionList:this._objectActionList},i={objects:this._objectList,updateType:t,isEmpty:0===this._undoStack.length,isRedoEmpty:0===this._redoStack.length,action:e,states:[]};o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:i}),this._objectActionList=[],this._objectList=[]},dumpHistoryStackToJson:function(){return JSON.stringify(this._actionsHistory)},restoreHistoryStackFromJson:function(t){this._actionsHistory=JSON.parse(t)},_isUndoEmpty:function(){return 0===this._undoableActions.length},_isRedoEmpty:function(){return 0===this._redoableActions.length},undo:function(){let t=this._undoStack.pop();if(t){this._selectionCmd._removeAllSelections();for(let e=0;e<t.objects.length;e++)t.objects[e].undoAction(t.timestamp);this._selectionCmd.selectObjects(t.objects,!0),this._redoStack.push(t),o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{timestamp:t.timestamp,objects:t.objects,isEmpty:0===this._undoStack.length,isRedoEmpty:0===this._redoStack.length,updateType:n.UPDATE_TYPE.UNDO}})}},redo:function(){let t=this._redoStack.pop();if(t){this._selectionCmd._removeAllSelections();for(let e=0;e<t.objects.length;e++)t.objects[e].redoAction(t.timestamp);this._selectionCmd.selectObjects(t.objects,!0),this._undoStack.push(t),o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{timestamp:t.timestamp,objects:t.objects,isEmpty:0===this._undoStack.length,isRedoEmpty:0===this._redoStack.length,updateType:n.UPDATE_TYPE.REDO}})}},clear:function(){this._actionsHistory=[],this._undoableActions=[],this._redoableActions=[],o.publish({event:"CAT3DSKUpdateAnnotationHistoryEvent",data:{isEmpty:this._isUndoEmpty(),isRedoEmpty:this._isRedoEmpty(),updateType:n.UPDATE_TYPE.CLEAR}})}});return n.ACTION={CREATED:0,DISCARDED:1,MOVED:2,EDITED:3},n.UPDATE_TYPE={NEW_ACTION:0,NEW_COMPLEX_ACTION:1,UNDO:2,REDO:3,CLEAR:4},n.DATA_TYPE={SKETCH:0,MEDIA:1,GROUP:2,LAYERS:3,CONNECTION:4},n}),define("DS/CAT3DWInfraUI/CAT3DWCanvasLimits",["DS/CAT3DWInfra/CAT3DWPreferenceManager"],function(t){"use strict";const e={get MPLimit(){return t.getPreferenceValue("R2VPerspectiveModeOn")?2e6:5e6},areDimensionsWithinLimits:function(t,i){return!t||!i||t*i<e.MPLimit}};return e}),define("DS/CAT3DWInfraUI/CAT3DWLoader",["UWA/Class","DS/Controls/Loader","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWLoader","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i){var o=t.extend({init:function(){this._loaderDiv=null,this._loader=null,this._container=null,this._defaultText=i.get("defaultLoader"),this._defaultFadeDuration=500},initialize:function(t){this._container=t},show:function(t,e){document.getElementById("x3DPhotoLoader")?this.reset():this._createLoader(),t&&(this._loader.text=t),null!=e&&(this._loader.fadeDuration=e),this._loader.on(),this._loaderDiv.show()},update:function(t){document.getElementById("x3DPhotoLoader")||this.show(),this._loader.update(t)},on:function(t){this._loader.on(t)},showSuccessAndhide:function(){document.getElementById("x3DPhotoLoader")&&(this._successDiv.show(),this._loader.elements.progressBar.emphasize="success",this._loader.text="",this._loaderDiv.hide(),setTimeout(function(){this._successDiv.hide(),this.reset()}.bind(this),1500))},showFailureAndhide:function(){document.getElementById("x3DPhotoLoader")&&(this._failureDiv.show(),this._loader.elements.progressBar.emphasize="high-attention",this._loader.text="",this._loaderDiv.hide(),setTimeout(function(){this._loaderDiv.hide(),this.reset()}.bind(this),1500))},hide:function(){document.getElementById("x3DPhotoLoader")&&(this._loaderDiv.hide(),this.reset())},reset:function(){this._loader.text=this._defaultText,this._loader.fadeDuration=this._defaultFadeDuration,this._loader.elements.progressBar.statusFlag=!1,this._loader.elements.progressBar.infiniteFlag=!0},remove:function(){this._loaderDiv.empty(),this._loaderDiv=null,this._loader=null},_createLoader:function(){this._loaderDiv=new UWA.Element("div",{class:"loader",id:"x3DPhotoLoader"}).inject(this._container);var t=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._loaderDiv),i=new UWA.Element("div",{class:"loader-content"}).inject(t);this._loader=new e({text:this._defaultText,fadeDuration:this._defaultFadeDuration}).inject(i),this._successDiv=new UWA.Element("div",{class:"loader loaderSuccessOrFailure"}).inject(this._container);var o=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._successDiv),n=new UWA.Element("div",{class:"loader-content"}).inject(o);n.classList.add("wux-ui-3ds","wux-ui-3ds-5x","wux-ui-3ds-check"),n.style="color:green;",this._successDiv.hide(),this._failureDiv=new UWA.Element("div",{class:"loader loaderSuccessOrFailure"}).inject(this._container);var s=new UWA.Element("div",{class:"loader-wrapper"}).inject(this._failureDiv),a=new UWA.Element("div",{class:"loader-content"}).inject(s);a.classList.add("wux-ui-3ds","wux-ui-3ds-5x","wux-ui-3ds-attention"),a.style="color:red;",this._failureDiv.hide()}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWLoader",o.singleton())}),define("DS/CAT3DWInfraUI/CAT3DWInternalClipboard",["UWA/Class","UWA/Core"],function(t,e){"use strict";var i=t.extend({init:function(t){this._debugMode=t,this._mediaToCopy=null},empty:function(){this._mediaToCopy=null},isEmpty:function(){return!this._mediaToCopy},getCopiedMedia:function(){if(!this._mediaToCopy)return null;var t=this._getClone(this._mediaToCopy);if(this._mediaToCopy.objects){let e=[];for(let t=0;t<this._mediaToCopy.objects.length;t++){let i=this._getClone(this._mediaToCopy.objects[t]);e.push(i)}t.objects=e}return t},_getClone:function(t){var e=Object.assign({},t);return t.object?e.object=Object.assign({},t.object):t.annot,e},writeText:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeLink:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,t.getDataService().getValue("isReady")||(i.object.linkData.view_type=void 0),i.object.mediaOccId=t.getMediaOccId(),i.object.fullViewUrl=t.getFullViewUrl(),i.object.smallViewThumbnailUrl=t.getSmallViewThumbnailUrl(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeSticker:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeImage:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getDataService().getData().url,i.object.cropData=t.getDataService().getData().cropData,i.object.file=t.getFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeVideo:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getTexture().image.currentSrc,i.object.streams=t.getDataService().getData().streams,i.object.thumbnailURL=t.getDataService().getData().thumbnailURL,i.object.currentStream=t.getDataService().getData().currentStream,i.object.file=t.getFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeModel:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getDataService().getData().url,i.object.file=t.getFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),Promise.resolve()},writeHybridModel:function(t,e){var i;e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy);var o=t.getTextureClone();return i.object=t.stream(),i.object.imagepublished=void 0,i.object.mediaIdImage=void 0,i.object.id=void 0,i.object.renderDepth=void 0,i.object.url=t.getDataService().getData().url,i.object.file=t.getModelFile(),i.object.mediaOccId=t.getMediaOccId(),i.type=t.getType(),i.previousID=t.getID(),i.object.viewType=t.getDataService().getData().viewType,i.object.viewMode=t.getDataService().getData().viewMode,i.object.shadingMode=t.getDataService().getData().shadingMode,i.object.sessionData=t.getDataService().getData().sessionData,i.object.spaceData=t.getDataService().getData().spaceData,i.object.imageurl=o.image.currentSrc,i.object.fileImage=t.getImageFile(),i.previousPositionModel=t.getModelView().getMatrix().clone(),i.title=t.getDataService().getData().title,i.extension=t.getDataService().getData().extension,i.mediaType=t.getDataService().getData().mediaType,i.filetype=t.getDataService().getData().filetype,i.title_thumbnail=t.getDataService().getData().title_thumbnail,i.extension_thumbnail=t.getDataService().getData().extension_thumbnail,i.mediaType_thumbnail=t.getDataService().getData().mediaType_thumbnail,i.filetype_thumbnail=t.getDataService().getData().filetype_thumbnail,i.isVideo=!1,Promise.resolve()},writeComparison:function(t,e){var i;if(e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.object=t.stream(),i.object.id=void 0,i.object.renderDepth=void 0,i.type=t.getType(),i.objects=[],i.object.comparisonInfo&&i.object.comparisonInfo.img1){let e=t.getImageMedia(i.object.comparisonInfo.img1.id);if(e){let t={};"CAT3DWModel"===e.getType()?this.writeHybridModel(e,t):"CAT3DWImage"===e.getType()&&this.writeImage(e,t),t.tag="image1",i.objects.push(t)}}if(i.object.comparisonInfo&&i.object.comparisonInfo.img2){let e=t.getImageMedia(i.object.comparisonInfo.img2.id);if(e){let t={};"CAT3DWModel"===e.getType()?this.writeHybridModel(e,t):"CAT3DWImage"===e.getType()&&this.writeImage(e,t),t.tag="image2",i.objects.push(t)}}return Promise.resolve()},writeAnnot:function(t,e){var i;return e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.type=t.getType(),i.annot=t,i.previousID=t.getID(),Promise.resolve()},writeGroupOrMultiselection:function(t,e){var i;let o;e?i=e:(this.empty(),this._mediaToCopy={},i=this._mediaToCopy),i.type=t.getType(),i.objects=[],i.layeredObjects=[];const n=(t,e)=>{switch(o=t.getType()){case"CAT3DWText":this.writeText(t.getMediaObj(),e);break;case"CAT3DSKLink":this.writeLink(t.getMediaObj(),e);break;case"CAT3DSKSticker":this.writeSticker(t.getMediaObj(),e);break;case"CAT3DWImage":this.writeImage(t.getMediaObj(),e);break;case"CAT3DWVideo":this.writeVideo(t.getMediaObj(),e);break;case"CAT3DWModel":this.writeHybridModel(t.getMediaObj(),e);break;case"CAT3DSKAnnotationShape":this.writeAnnot(t,e);break;case"CAT3DSKGroupOfObjects":this.writeGroupOrMultiselection(t,e);break;case"CAT3DSKComparison":this.writeComparison(t,e);break;default:throw new Error("unknown type of object",o)}},s=t.getLayeredObjects();for(let t=0;t<s.length;t++)i.layeredObjects.push(s[t].getID());const a=t.getObjects();for(let t=0;t<a.length;t++){let e={};n(a[t],e),i.objects.push(e)}}});return e.namespace("DS/CAT3DWInfra/CAT3DWInternalClipboard",i)}),define("DS/CAT3DWInfraUI/CAT3DW3DDriveDialog",["UWA/Core","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/ComboBox","DS/TreeModel/TreeNodeModel","DS/Tree/FileTreeView","DS/TreeModel/TreeDocument","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CAT3DWInfra/CAT3DW3DDriveUtils","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DW3DDriveDialog"],function(t,e,i,o,n,s,a,r,l,h){"use strict";var c=0,d=null,p=null,u=new Map,g=null,m=null,f=null,b=[],v=0,_=function(t,e){this.service=t,this.name=e,this.folderList=new Map},D=function(t,e,i,o,n){this.title=t,this.extension=n,this.path=o,this.id=e,this.node=i,this.children=[]};function w(t,e,i,o){var s=new n({label:t,icons:e?[{iconName:"3dpart"}]:"folder",children:e?null:[]});o?o.addChild(s):p.addRoot(s);var a=b[c].folderList.get(i);if(a)a.node=s;else{var r=o?u.get(o).path+"\\"+t:t;a=new D(t,i,s,r,e),b[c].folderList.set(i,a),o&&u.get(o).children.push(a)}u.set(s,a)}function x(){p.removeRoots(),u.clear(),w(h.get("myfiles"),null,"DSROOT",null),w(h.get("sharedwithme"),null,"sharedwithme",null)}function y(t,e){var i=[],o=[];e.forEach(function(t){if(null!==t.extension&&""!==t.extension){var e="."+t.extension;null!=f&&f.includes(e)&&o.push(t)}else i.push(t)}),i.sort(function(t,e){return t.title>e.title?1:-1}),i.forEach(function(e){w(e.title,null,e.id,t)}),o.sort(function(t,e){return t.title>e.title?1:-1}),o.forEach(function(e){w(e.title,e.extension,e.id,t)})}function I(){var e=new t.createElement("div",{class:"3ddrivebrowser-treediv"});return p=new a({useAsyncPreExpand:!0}),(d=new s({treeDocument:p})).inject(e),p.onPreExpand(function(t){t&&function(t){if(t&&t.data&&t.data.nodeModel){var e=t.data.nodeModel,i=u.get(e);if(i&&t.target){var o=i.id,n=b[c].service;if(Array.isArray(e.options.children)&&e.options.children.length<1){var s=u.get(e);if(!(s.children.length>0))return l.getFolderContentsInTenant(o,n).then(function(i){Array.isArray(i.items)&&i.items.length>0&&y(e,i.items),t.target.preExpandDone()}).catch(function(){return t.target.preExpandDone(),!1});y(e,s.children),t.target.preExpandDone()}else t.target.preExpandDone()}else t.target.preExpandDone()}}(t)}),d.onNodeClick(function(t){t&&t.nodeModel&&function(t){if(t){var e=u.get(t);e&&(console.log(e.path),t.isSelected()?(g.disabled=!1,m=t):(g.disabled=!0,m=null))}}(t.nodeModel)}),p.getXSO().onEmpty(function(){m=null,g.disabled=!0}),e}function T(n,s){var a=new t.createElement("div");(function(){for(var e=0;e<b.length;++e)if(b[e].service.platformId===widget.getValue("x3dPlatformId")){c=e;break}var i=new t.createElement("div",{styles:{padding:"10px"}});new t.createElement("img",{styles:{width:"25px"},src:require.toUrl("DS/SWXWebUI/assets/icons/32/SWXWeb3DDriveIcon.png")}).inject(i);var n=new o({domId:"3ddrivebrowser-combo",elementsList:b.map(t=>t.name),selectedIndex:c,enableSearchFlag:!1});return n.addEventListener("change",function(t){t&&t.dsModel&&(c=t.dsModel.selectedIndex,x())}),n.inject(i),i})().inject(a),I().inject(a),x(),g=new i({label:h.get("OKButton"),disabled:!0,onClick:function(t){var e=null;if(m){var i=u.get(m);e={fileId:i.id,filePath:i.path,fileName:i.title,tenant:b[c].service}}s(e)}});var r=new e({immersiveFrame:n,title:h.get("BrowseDialogTitle"),closeButtonFlag:!1,resizableFlag:!0,touchMode:!0,minWidth:300,width:300,modalFlag:!0,content:a,buttons:{Cancel:new i({onClick:function(t){s()}}),Ok:g}});return r.addEventListener("startResize",function(t){t&&(v=t.srcElement.clientHeight)}),r.addEventListener("stopResize",function(t){if(t){var e=t.srcElement.clientHeight-v;r.height-=e}}),r}return{generate3DDriveBrowser:async function(t,e,i){b=[];for(var o=await async function(){return new Promise(function(t){r.getServiceUrl({serviceName:"3DDrive",onComplete:function(e){t(e)}})})}(),n=await async function(){return new Promise(function(t){return r.getPlatformServices({onComplete:function(e){t(e),console.log("data "+e)}})}).then(function(t){return t.map(function(t){return t.displayName})})}(),s=0;s<o.length;++s)if("url"in o[s]){var a=new _(o[s],n[s]);b.push(a)}f=i;var l=T(t,e);return document.getElementById("3ddrivebrowser-combo").style.width="250px",Promise.resolve(l)}}}),define("DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle",["DS/CAT3DWInfraUI/CAT3DWHandleManipulator","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/MaterialApplication","UWA/Class","UWA/Core"],function(t,e,i,o,n,s,a,r){"use strict";var l=a.extend({init:function(t){this._parent(t),this._viewer=t.viewer,t.updateAll=this.updateAll.bind(this),this._createManipulators(this._getListOfManipulatorNames(),t),this.rotationHandler=this._manipulators.find(t=>"rotationHandler"===t.name),t.media?this.objects=[t.media]:t.group&&this.setGroup(t.group),this.createLineNode()},_getListOfManipulatorNames:function(){return["bottomRightHandler","bottomLeftHandler","topRightHandler","topLeftHandler","rotationHandler"]},_createManipulators:function(e,i){if(this._manipulators)for(let t of this._manipulators)t.dispose();this._manipulators=[];for(let o of e)i.name=o,this._manipulators.push(new t(i))},updateAll:function(){for(let t of this._manipulators)t.update(!1);this._lineNode&&(this.disposeLineNode(),this.createLineNode())},createLineNode:function(){let a=this._manipulators.find(t=>"topLeftHandler"===t.name),r=(new e.Vector3).getPositionFromMatrix(a.getMatrix());a=this._manipulators.find(t=>"topRightHandler"===t.name);let l,h=(new e.Vector3).getPositionFromMatrix(a.getMatrix());l=this._group?this._group:this.objects[0],a=this._manipulators.find(t=>"rotationHandler"===t.name);let c=t.getRotationHandlePosition(l,!0),d=[c=n.compute3DPointFrom2DPoint(c,a.getReferencePlane(),this._viewer),new e.Vector3((r.x+h.x)/2,(r.y+h.y)/2,(r.z+h.z)/2)];this._lineNode=o.createLineNode({points:d,drawMode:i.ConnectivityTypeEnum.LINES,editable:!0}),this._lineNode.setPickable(i.PICKTHROUGH),this._lineNode.setExcludeFromBounding(!0),this._lineNode.setMaterialApplication(new s({lineMaterial:this._buildDottedBorderMaterial()})),this._viewer.getRootNode().getChildByName("sceneUINode").addChild(this._lineNode),this._lineNode.setNoZ(!0)},disposeLineNode:function(){this._lineNode&&(this._viewer.getRootNode().getChildByName("sceneUINode").removeChild(this._lineNode),this._lineNode=null)},_buildDottedBorderMaterial:function(){var t=new e.LineBasicMaterial({color:new e.Color("#42A2DA"),force:!0,transparent:!0,opacity:1,lineWidth:2});return t.depthTest=!0,t.depthWrite=!1,t.polite=!0,t.politeMaterial=t.clone(),t.politeMaterial.opacity=.15,t.politeMaterial.depthTest=!1,t.politeMaterial.depthWrite=!1,t},setManipulationCallbacks:function(t,e,i){for(let o of this._manipulators)o.setManipulationCallbacks(t,e,i)},removeManipulationCallbacks:function(){for(let t of this._manipulators)t.setManipulationCallbacks(null,null,null)},dispose:function(){for(let t of this._manipulators)t.dispose();this._manipulators=null,this.disposeLineNode(),this._parent()},setGroup:function(t){this._group=t,this.objects=this._group.getObjects(),this.update()},hideManipulator:function(){this.disposeLineNode();for(let t of this._manipulators)t.setVisibility(!1)},showManipulator:function(){if(!this._group||!this._group.isLocked()){this.disposeLineNode(),this.createLineNode();for(let t of this._manipulators)t.setVisibility(!0)}},getManipulatedObject:function(){return this._group?this._group:this.objects[0]},getLastTimestamp:function(){let t,e=0;for(let i of this._manipulators)(t=i.getLastTimestamp())>e&&(e=t);return e},isActivated:function(){for(let t of this._manipulators)if(t.isActivated())return!0;return!1},setReferencePlane:function(t){for(let e of this._manipulators)e.setReferencePlane(t)},setRotationActivation:function(t){for(let e of this._manipulators)e.setRotationActivation(t)},isRotationActivated:function(){for(let t of this._manipulators)if(t.isRotationActivated())return!0;return!1},setScaleActivation:function(t){for(let e of this._manipulators)e.setScaleActivation(t)},isScaleActivated:function(){for(let t of this._manipulators)if(t.isScaleActivated())return!0;return!1},setSnappingForImageActivation:function(t){for(let e of this._manipulators)e.setSnappingForImageActivation(t)},isSnappingForImageActivated:function(){for(let t of this._manipulators)if(t.isSnappingForImageActivated())return!0;return!1},update:function(){for(let t of this._manipulators)t.update(!1)},updateRotationHandler:function(){this.rotationHandler&&this.rotationHandler.update(!0)},pause:function(){this.disposeLineNode();for(let t of this._manipulators)t.pause()},isPaused:function(){let t=!0;for(let e of this._manipulators)t=t&&e.isPaused();return t},resume:function(){for(let t of this._manipulators)t.resume()},getScreenPosition:function(){for(let t of this._manipulators)if(t.isActivated())return t.getScreenPosition()}});return r.namespace("DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle",l)}),define("DS/CAT3DWInfraUI/CAT3DWPointerEvents",["UWA/Class","DS/Core/PointerEvents"],function(t,e){"use strict";var i=t.extend({init:function(){this._palmThreshold=40},initialize:function(){document.addEventListener(e.POINTERDOWN,this._onPointerDown.bind(this)),document.addEventListener(e.POINTERMOVE,this._onPointerMove.bind(this)),document.addEventListener(e.POINTERUP,this._onPointerUp.bind(this)),document.addEventListener(e.POINTERHIT,this._onPointerHit.bind(this))},getPalmThreshold:function(){return this._palmThreshold},_onPointerDown:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSDOWN,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var o=this._createEvent(i.POINTERDOWN,t);t.target.dispatchEvent(o)}}},_onPointerMove:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSMOVE,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var o=this._createEvent(i.POINTERMOVE,t);t.target.dispatchEvent(o)}}},_onPointerUp:function(t){if(!this._isPalm(t)){var e=this._createEvent(i.POINTERSUP,t);if(e.nbFingers=this._getNbFingers(t),t.target.dispatchEvent(e),!(this._getNbFingers(t)>1)){var o=this._createEvent(i.POINTERUP,t);t.target.dispatchEvent(o)}}},_onPointerHit:function(t){if(!(this._isPalm(t)||this._getNbFingers(t)>1)){var e=this._createEvent(i.POINTERHIT,t);t.target.dispatchEvent(e)}},_isMobile:function(){var t=navigator.userAgent;return!!new RegExp("Mobile").test(t)},_isPalm:function(t){if(this._isMobile()||!t.touches||!t.touches.length)return!1;for(var e=!1,i=0;i<t.touches.length;i++){var o=t.touches[0];(o.radiusX>this._palmThreshold||o.radiusY>this._palmThreshold)&&(e=!0)}return e},_getNbFingers:function(t){return t.touches?t.touches.length:0},_createEvent:function(t,e){var i=new MouseEvent(t,e);return i.oldPreventDefault=i.preventDefault,i.oldStopPropagation=i.stopPropagation,i.oldStopImmediatePropagation=i.stopImmediatePropagation,i.touchFlag=e.touchFlag,i.preventDefault=function(t){i.oldPreventDefault(),e.preventDefault()},i.stopPropagation=function(t){i.oldStopPropagation(),e.stopPropagation()},i.stopImmediatePropagation=function(t){i.oldStopImmediatePropagation(),e.stopImmediatePropagation()},i}});return i.POINTERDOWN="CAT3DWPointerDown",i.POINTERSDOWN="CAT3DWPointersDown",i.POINTERMOVE="CAT3DWPointerMove",i.POINTERSMOVE="CAT3DWPointersMove",i.POINTERUP="CAT3DWPointerUp",i.POINTERSUP="CAT3DWPointersUp",i.POINTERHIT="CAT3DWPointerHit",UWA.namespace("DS/CAT3DWInfraUI/CAT3DWPointerEvents",i)}),define("DS/CAT3DWInfraUI/CAT3DWClipboard",["UWA/Class","UWA/Utils/Client","DS/WAFData/WAFData"],function(t,e,i){"use strict";var o=UWA.Class.extend({init:function(t,e){this._debugMode=t,this._isODT=e},writeText:function(t,i){return new Promise(function(n,s){if(this._isODT)return console.warn("Dont write text in the clipboard in ODT context"),void setTimeout(function(){n()},200);if(navigator.clipboard&&navigator.clipboard.writeText&&!i)navigator.clipboard.writeText(t).then(function(){this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard : "+t,"background-color:rgba(0, 255, 0, 0.1);color: green"),n()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write text in the clipboard"),t&&console.error(t)),s({error:t,errortype:o.ERRORWRITETEXT})}.bind(this));else if(navigator.clipboard&&navigator.clipboard.write&&i){var a=new Blob([i.outerHTML],{type:"text/html"}),r=new Blob([t],{type:"text/plain"}),l=[e.Platform.android?new ClipboardItem({"text/plain":r}):new ClipboardItem({"text/plain":r,"text/html":a})];navigator.clipboard.write(l).then(function(){this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),n()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write text in the clipboard"),t&&console.error(t)),s({error:t,errortype:o.ERRORWRITETEXT})}.bind(this))}else{this._debugMode&&console.error("FAILED to write image in the clipboard due to navigator/OS incompatibility reason"),e.Engine.firefox&&i&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var h=o.ERRORCOMPATIBILITYWRITE;e.Engine.firefox&&i&&(h=o.ERRORCOMPATIBILITYFIREFOXWRITE),s({error:null,errortype:h})}}.bind(this))},writeImage:function(t,i){return new Promise(function(n,s){if(this._isODT)return console.warn("Dont write image in the clipboard in ODT context"),void setTimeout(function(){n()},200);if(navigator.clipboard&&navigator.clipboard.write){var a=new Blob([i.outerHTML],{type:"text/html"}),r=[e.Platform.android?new ClipboardItem({"image/png":t}):new ClipboardItem({"image/png":t,"text/html":a})];navigator.clipboard.write(r).then(function(){this._debugMode&&console.log("%c SUCCESS - Image copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),n()}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to write image in the clipboard"),t&&console.error(t)),s({error:t,errortype:o.ERRORWRITEIMAGE})}.bind(this))}else if("http:"===document.location.protocol)this._debugMode&&console.error("FAILED to write image in the clipboard due to security reason"),s({error:new Error("Run app in secure context"),errortype:o.ERRORPERMISSIONDENIED});else{this._debugMode&&console.error("FAILED to write image in the clipboard due to navigator/OS incompatibility reason"),e.Engine.firefox&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var l=o.ERRORCOMPATIBILITYWRITE;e.Engine.firefox&&(l=o.ERRORCOMPATIBILITYFIREFOXWRITE),s({error:null,errortype:l})}}.bind(this))},read:function(){return new Promise(function(t,e){if(this._isODT)return console.warn("Dont read data in the clipboard in ODT context"),void setTimeout(function(){t({data:"",type:o.TYPETEXT})},200);this.readText().then(function(i){i&&" "===i?e({error:null,errortype:o.ERROREMPTY}):this.readData().then(function(i){if(i&&i.length){var n=i[0],s={},a=0,r=function(){++a===n.types.length&&(s.type&&s.data?t(s):e({error:null,errortype:o.ERRORINVALIDDATA}))};n.types&&n.types.length||e({error:null,errortype:o.ERRORINVALIDDATA});for(var l=0;l<n.types.length;l++)"image/png"===n.types[l]?n.getType(n.types[l]).then(function(t){s.data=URL.createObjectURL(t),s.type=o.TYPEIMAGE,r()}).catch(function(){r()}):"text/plain"===n.types[l]?n.getType(n.types[l]).then(function(t){t.text().then(function(t){s.data=t,s.type=o.TYPETEXT,r()}).catch(function(){r()})}).catch(function(){r()}):"text/html"===n.types[l]?n.getType(n.types[l]).then(function(t){t.text().then(function(t){var e=document.createRange().createContextualFragment(t);s.html=e;var i=e.querySelectorAll("img");!s.type&&i.length?this._requestImage(i[0].src).then(function(t){s.data=t,s.type=o.TYPEIMAGE,r()}).catch(function(){r()}):r()}.bind(this)).catch(function(){r()})}.bind(this)).catch(function(){r()}):"text/uri-list"===n.types[l]?n.getType(n.types[l]).then(function(t){t.text().then(function(t){s.type?r():this._requestImage(t).then(function(t){s.data=t,s.type=o.TYPEIMAGE,r()}).catch(function(){r()})}.bind(this)).catch(function(){r()})}.bind(this)).catch(function(){r()}):r()}else e({error:null,errortype:o.ERROREMPTY})}.bind(this)).catch(function(t){e(t)})}.bind(this)).catch(function(t){e(t)})}.bind(this))},readText:function(){return new Promise(function(t,i){navigator.clipboard&&navigator.clipboard.readText&&!this._isSamsungBrowser()?navigator.clipboard.readText().then(function(e){this._debugMode&&console.log("%c SUCCESS - Text read in the clipboard : "+e,"background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to read text in the clipboard"),t&&console.error(t)),i({error:t,errortype:o.ERRORREADTEXT})}.bind(this)):e.Engine.firefox?this.readData().then(function(e){for(var i=e[0],o=0;o<i.types.length;o++)if("text/plain"===i.types[o]){i.getType(i.types[o]).then(function(e){e.text().then(function(e){this._debugMode&&console.log("%c SUCCESS - Text read in the clipboard : "+e,"background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this))});break}}).catch(function(t){this._debugMode&&(console.error("FAILED to read text in the clipboard"),t.error&&console.error(t.error)),i({error:t.error,errortype:t.errortype})}.bind(this)):"http:"===document.location.protocol?(this._debugMode&&console.error("FAILED to read text in the clipboard due to security reason"),i({error:new Error("Run app in secure context"),errortype:o.ERRORPERMISSIONDENIED})):(this._debugMode&&console.error("FAILED to read text in the clipboard due to navigator/OS incompatibility reason"),i({error:null,errortype:o.ERRORCOMPATIBILITYREAD}))}.bind(this))},readData:function(){return new Promise(function(t,i){if(navigator.clipboard&&navigator.clipboard.read&&!this._isSamsungBrowser())navigator.clipboard.read().then(function(e){this._debugMode&&console.log("%c SUCCESS - Data read in the clipboard","background-color:rgba(0, 255, 0, 0.1);color: green"),t(e)}.bind(this)).catch(function(t){this._debugMode&&(console.error("FAILED to read data in the clipboard"),t&&console.error(t)),i({error:t,errortype:o.ERRORREADDATA})}.bind(this));else if("http:"===document.location.protocol)this._debugMode&&console.error("FAILED to read data in the clipboard due to security reason"),i({error:new Error("Run app in secure context"),errortype:o.ERRORPERMISSIONDENIED});else{this._debugMode&&console.error("FAILED to read data in the clipboard due to navigator/OS incompatibility reason"),e.Engine.firefox&&console.warn("Set to true dom.events.asyncClipboard.clipboardItem, dom.events.asyncClipboard.read, dom.events.testing.asyncClipboard preferences in about:config");var n=o.ERRORCOMPATIBILITYREAD;e.Engine.firefox&&(n=o.ERRORCOMPATIBILITYFIREFOXREAD),i({error:null,errortype:n})}}.bind(this))},_requestImage:function(t){return new Promise(function(e,o){i.proxifiedRequest(t,{method:"GET",type:"blob",onComplete:function(t){if(t.type.includes("image/")){var i=URL.createObjectURL(t);e(i)}else o()},onFailure:function(t){t&&console.error(t),o()}})})},writeTextInCPD:function(t,e,i){e?(e.setData("text/plain",t),i&&e.setData("text/html",i.outerHTML),this._debugMode&&console.log("%c SUCCESS - Text copied to clipboard : "+t,"background-color:rgba(0, 255, 0, 0.1);color: green")):this._debugMode&&console.warn("An event.clipboardData must be provided")},writeImageInCPD:function(t,e,i){i?(i.setData("image/png",t),i.setData("text/html",e.outerHTML),this._debugMode&&console.log("%c SUCCESS - Image copied to clipboard","background-color:rgba(0, 255, 0, 0.1);color: green")):this._debugMode&&console.warn("An event.clipboardData must be provided")},readInCPD:function(t){if(!t)return this._debugMode&&console.warn("An event.clipboardData must be provided"),{error:null,errortype:o.ERROREMPTY};var e=this.readTextInCPD(t);if(e&&" "===e)return{error:null,errortype:o.ERROREMPTY};var i=this.readDataInCPD(t);if(!i||!i.length)return{error:null,errortype:o.ERROREMPTY};for(var n={},s=0;s<i.length;s++)if("file"===i[s].kind&&"image/png"===i[s].type){var a=i[s].getAsFile();n.type=o.TYPEIMAGE,a&&(n.data=URL.createObjectURL(a))}else if("string"===i[s].kind&&"text/plain"===i[s].type)n.data=t.getData("text/plain"),n.type=o.TYPETEXT;else if("string"===i[s].kind&&"text/html"===i[s].type){var r=t.getData("text/html"),l=document.createRange().createContextualFragment(r);n.html=l}else"string"===i[s].kind&&"text/uri-list"===i[s].type&&(n.type||(n.type=o.TYPELINK,n.data=t.getData("text/uri-list")));if(n.type===o.TYPEIMAGE&&!n.data&&n.html){var h=n.html.querySelector("img");n.data=h.src}return n.type&&n.data?n:{error:null,errortype:o.ERRORINVALIDDATA}},readTextInCPD:function(t){return t.getData("text")},readDataInCPD:function(t){return t.items},empty:function(){return this.writeText(" ")},_isSamsungBrowser:function(){return navigator.userAgent.match(/SamsungBrowser/i)}});return o.TYPETEXT="typetext",o.TYPEIMAGE="typeimage",o.TYPELINK="typelink",o.ERROREMPTY="errorempty",o.ERRORINVALIDDATA="errorinvaliddata",o.ERRORREADTEXT="errorreadtext",o.ERRORWRITETEXT="errorwritetext",o.ERRORWRITEIMAGE="errorwriteimage",o.ERRORREADDATA="errorreaddata",o.ERRORCOMPATIBILITYFIREFOXWRITE="errorcompatibilityfirefoxwrite",o.ERRORCOMPATIBILITYFIREFOXREAD="errorcompatibilityfirefoxread",o.ERRORPERMISSIONDENIED="errorpermissiondenied",o.ERRORCOMPATIBILITYWRITE="errorcompatibilitywrite",o.ERRORCOMPATIBILITYREAD="errorcompatibilityread",UWA.namespace("DS/CAT3DWInfraUI/CAT3DWClipboard",o)}),define("DS/CAT3DWInfraUI/CAT3DWHandleResources",["UWA/Class","UWA/Promise","DS/RuntimeView/NLSManager"],function(t,e,i){"use strict";var o=t.extend({load:function(t,o){return new e(function(e,n){t||(console.warn("Using a invalid syntax... Should specify the module."),n());var s=t+"/"+o;i.onResourceLoaded({resourceFile:s},function(){if(this._manager&&this._manager._listOfResources){var t=this._manager._listOfResources;e(t[s][o])}else n()}),i.loadResource({resourceFile:s,resourceConverter:function(t){return t='{"'+(t=(t=(t=(t=t.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"")).replace(/(\r\n|\r|\n|\u0085|\u000C|\u2028|\u2029)/g,"")).replace(/\s+(?=([^"]*"[^"]*")*[^"]*$)/g,"")).replace(/[=]/g,'":').replace(/;/g,',"')).substring(0,t.length-2)+"}",function(t){var e,i,o,n={};for(var s in t){e=n;for(var a=(i=s.split(".")).pop();i.length;){o=i.shift();var r=UWA.typeOf(e[o]);r&&"object"!==r&&"array"!==r&&(e[o]={_value:e[o]}),"Case"===o&&(isNaN(a)||(a=parseInt(a)),"array"!==r&&(e[o]=[])),e=e[o]=e[o]||{}}"array"==UWA.typeOf(e)?e.push({id:"True"===a||"False"===a?Boolean("True"===a):a,_value:t[s]}):e[a]?e[a]._value=t[s]:e[a]=t[s]}return n}(UWA.Json.decode(t))}})})}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWHandleResources",o.singleton())}),define("DS/CAT3DWInfraUI/CATLSLadibug",["UWA/Core","UWA/Class","WebappsUtils/WebappsUtils"],function(t,e,i){"use strict";var o=e.singleton({init:function(){this._logList=[],this._initialized=!1},initialize:function(){this._initialized||(this._initialized=!0,this._createUI(),this._createButton(),this._rewriteConsoleLog())},log:function(e,i){void 0===e?e="undefined":null===e?e="null":"string"!=typeof e&&(e=JSON.stringify(e)),this._logList.push(e);for(var o=e.indexOf("error")>0?"error":i,n=e.split("\n"),s=[],a={},r=0;r<n.length;r++)a={tag:"div"},r>0&&"error"===o&&!n[r].match(/^\s{0,}at\s/)?a.text="at "+n[r]:a.text=n[r],r>0&&(a.styles={marginLeft:"25px"}),s.push(a);new t.Element("div",{class:"ladibug-log "+o,html:s}).inject(this._content,"bottom"),this._content.scrollTop=this._content.scrollHeight},displayImage:function(e){new t.Element("div",{class:"ladibug-log image",html:[{tag:"img",src:e}]}).inject(this._content,"bottom"),this._content.scrollTop=this._content.scrollHeight},toggle:function(){this._body.hasClassName("hide")?(this._body.removeClassName("hide"),this._content.scrollTop=this._content.scrollHeight):this._body.addClassName("hide")},isVisible:function(){return this._button&&!this._button.hasClassName("hide")},show:function(){this.initialize(),this._body.removeClassName("hide"),this._button.removeClassName("hide"),this._content.scrollTop=this._content.scrollHeight},hide:function(){this.initialize(),this._body.addClassName("hide"),this._button.addClassName("hide")},_rewriteConsoleLog:function(){console.log=function(t){this.log(t)}.bind(this),console.error=function(t){var e=t;"string"!=typeof t&&(e=t.stack),this.log(e,"error")}.bind(this),console.warn=function(t){this.log(t,"warn")}.bind(this),console.time=function(t){this.log(t,"time")}.bind(this),console.timeEnd=function(t){this.log(t,"time")}.bind(this),console.info=function(t){this.log(t)}.bind(this),window.addEventListener("error",function(t){var e=t.error;"string"==typeof e?this.log(e,"error"):e.stack&&(e.message&&-1===e.stack.indexOf(e.message)&&this.log(e.constructor.name+": "+e.message,"error"),this.log(e.stack,"error"))}.bind(this)),console.image=function(t){this.displayImage(t)}.bind(this)},_createUI:function(){this._body=new t.Element("div",{id:"ladibug-body",class:"hide"}).inject(document.body),this._topBar=new t.Element("div",{id:"ladibug-topbar"}).inject(this._body),new t.Element("span",{class:"ladibug-title",text:"Lad'iBug"}).inject(this._topBar),this._content=new t.Element("div",{class:"ladibug-content"}).inject(this._body),this._dragElement()},_createButton:function(){this._button=new t.Element("div",{id:"ladibug-button",html:{tag:"img",src:i.getWebappsAssetUrl("CAT3DWInfraUI","icons/CAT3DWLadibug.png")},events:{click:this.toggle.bind(this)}}).inject(document.body)},_dragElement:function(){this._pos1=0,this._pos2=0,this._pos3=0,this._pos4=0,this._topBar.onmousedown=this._dragDown.bind(this),this._topBar.ontouchstart=this._dragDown.bind(this)},_dragDown:function(t){var e,i;(t=t||window.event).preventDefault(),t.changedTouches?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY),this._pos3=e,this._pos4=i,document.onmouseup=this._closeDragElement.bind(this),document.ontouchend=this._closeDragElement.bind(this),document.onmousemove=this._elementDrag.bind(this),document.ontouchmove=this._elementDrag.bind(this)},_elementDrag:function(t){var e,i;(t=t||window.event).preventDefault(),t.changedTouches?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY),this._pos1=this._pos3-e,this._pos2=this._pos4-i,this._pos3=e,this._pos4=i,this._body.style.top=this._body.offsetTop-this._pos2+"px",this._body.style.left=this._body.offsetLeft-this._pos1+"px"},_closeDragElement:function(){document.onmouseup=null,document.onmousemove=null,document.ontouchend=null,document.ontouchmove=null}});return t.namespace("DS/CAT3DPhotoNR/CATLSLadibug",o)}),define("DS/CAT3DWInfraUI/CAT3DWProgressBar",["UWA/Class","UWA/Core","DS/Controls/ProgressBar","i18n!DS/CAT3DWInfraUI/assets/nls/CAT3DWProgressBar","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i,o){"use strict";var n=t.extend({init:function(t){this._parentContainer=t.container,this._id=t.id?t.id:this._getUniqueId(),this._container=null,this._overlay=null,this._label=t.label?t.label:o.get("defaultLabel"),this._hideTimeouts=[]},show:function(){if(this._clearTimeouts(),this._container)return this._container.setStyle("opacity",1),void this._container.show();this._container=new e.Element("div",{id:this._id,class:"CAT3DWProgressBar"}).inject(this._parentContainer),this._overlay||(this._overlay=new e.Element("div",{class:"CAT3DWProgressBar-overlay"}).inject(this._parentContainer));var t=new e.Element("div",{class:"progressBar-container"}).inject(this._container),o=new e.Element("div",{class:"progressBar-wrap"}).inject(t);new e.Element("span",{class:"progressBar-label",text:this._label}).inject(o),new i({displayStyle:"lite",infiniteFlag:!0,emphasize:"info"}).inject(o)},hide:function(){this._clearTimeouts(),this._hideTimeouts.push(setTimeout(function(){this._container&&(this._container.setStyle("opacity",0),this._hideTimeouts.push(setTimeout(function(){this._container&&(this._container.destroy(),this._container=null)}.bind(this),200))),this._overlay&&this._hideTimeouts.push(setTimeout(function(){this._overlay&&(this._overlay.destroy(),this._overlay=null)}.bind(this),200))}.bind(this),400))},_clearTimeouts:function(){for(;this._hideTimeouts.length>0;)clearTimeout(this._hideTimeouts.shift())},_getUniqueId:function(){var t="CAT3DWPB_";return t+=(new Date).getUTCMilliseconds()}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWProgressBar",n)}),define("DS/CAT3DWInfraUI/CAT3DWHandleErrors",["UWA/Class","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/Notifications/NotificationsManagerViewOnConsole","DS/CAT3DWInfraUI/CAT3DWHandleResources","css!DS/CAT3DWInfraUI/CAT3DWInfraUI"],function(t,e,i,o,n){"use strict";var s,a=t.extend({SUCCESS:"success",INFORMATION:"info",WARNING:"warning",ERROR:"error",init:function(){this._notificationsList=[]},initialize:function(){s={},n.load("CAT3DWInfraUI","CAT3DWHandleErrors").then(function(t){return s=t,1},function(){}),void 0===window.notifs&&(window.notifs=e),void 0===window.notifsDisp&&(window.notifsDisp=o),i.setNotificationManager(window.notifs)},DisplayGeneralMessage:function(t){this.DisplayMessage(this.getResource(t),this.getSeverity(t))},setGeneralErrorMessage:function(t,e,o,n){switch(n=n.toLowerCase()){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:n=this.ERROR}var s={level:n,title:t,subtitle:e,message:o,sticky:!1},a=window.notifs.addNotif(s);this._notificationsList.push(a),n===this.ERROR?setTimeout(function(t){i.removeNotification(t)}.bind(this,a),6e3):n===this.WARNING&&setTimeout(function(t){i.removeNotification(t)}.bind(this,a),4e3)},modifyErrorMessage:function(t,e,i,o,n){switch(n){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:n=this.ERROR}var s={level:n,title:e,subtitle:i,message:o,sticky:!1};window.notifs.modifyNotif(t,s)},DisplayMessage:function(t,e){switch(e){case this.SUCCESS:case this.INFORMATION:case this.WARNING:case this.ERROR:break;default:e=this.ERROR}var i={level:e,title:s.Title[e],message:t,sticky:!1};window.notifs.addNotif(i)},clearAllErrors:function(){for(var t=this._notificationsList.length,e=0;e<t;e++)i.removeNotification(this._notificationsList[e])},getSeverityFromInt:function(t){var e=this.ERROR;switch(t){case 0:e=this.SUCCESS;break;case 1:case 2:e=this.ERROR;break;case 3:e=this.WARNING;break;case 4:e=this.INFORMATION;break;default:t=this.ERROR}return e},getSeverity:function(t){"string"!=typeof t&&(t=t._value);var e=t.split(".");if(e.length<2)return this.ERROR;switch(e[1].toUpperCase()){case"SUCCESS":return this.SUCCESS;case"INFO":return this.INFORMATION;case"WARNING":return this.WARNING;case"ERROR":default:return this.ERROR}},getResource:function(t){"string"!=typeof t&&(t=t._value);var e='Unknown resource id "'+t+'"',i=t.split(".");if(i.length<2)return e;for(var o=s,n=1;n<i.length;n++){if(!o.hasOwnProperty(i[n]))return e;o=o[i[n]]}return o}});return UWA.namespace("DS/CAT3DWInfraUI/CAT3DWHandleErrors",a.singleton())}),define("DS/CAT3DWInfraUI/CAT3DWCropBoxUI",["UWA/Class","UWA/Core","DS/Visualization/ThreeJS_DS","DS/CAT3DWInfraUI/CAT3DWPointerEvents"],function(t,e,i,o){"use strict";return t.extend({init:function(t){this.srcImage=new Image,this.srcImage.onload=function(){this._cropBoxUIOptions=e.extend(t,{actualImageWidth:this.srcImage.width,actualImageHeight:this.srcImage.height}),this.buildUI(this._cropBoxUIOptions)}.bind(this),this.srcImage.crossOrigin="use-credentials",this.srcImage.src=t.imageURL},onMouseDown:function(t){this.isDragging=!0,this.initialTop=parseInt(this.cropBox.style.top),this.initialLeft=parseInt(this.cropBox.style.left);let e=new i.Vector2(this.mouseDownPos.x,this.mouseDownPos.y),o=t.clientX-this.masterContainer.getBoundingClientRect().x,n=t.clientY-this.masterContainer.getBoundingClientRect().y,s=new i.Vector2(o,n);this.actualWidthOfImageNode=parseInt(this.container.style.width),this.actualHeightOfImageNode=parseInt(this.container.style.height);let a=new i.Vector2(this.topLeft.x-this.topRight.x,this.topLeft.y-this.topRight.y),r=new i.Vector2(this.topLeft.x-this.bottomLeft.x,this.topLeft.y-this.bottomLeft.y),l=new i.Vector2(this.initialLeft,this.initialTop),h=l.length(),c=0,d=0;if(h>0){let t=Math.atan(a.y/a.x);this.topRight.x<this.topLeft.x&&(t+=Math.PI);let e=Math.atan(l.y/l.x);e<.5*-Math.PI&&(e+=Math.PI);let i=t+e;c=Math.cos(i)*h,d=Math.sin(i)*h}let p=(new i.Vector2).subVectors(new i.Vector2(c+e.x,d+e.y),s);this._dx_1=p.dot(a)/a.length(),this._dy_1=p.dot(r)/r.length(),t.preventDefault(),t.stopPropagation()},onMouseMove:function(t){if(this.isDragging){let e,o,n,s=parseInt(this.cropBox.style.width),a=parseInt(this.cropBox.style.height),r=new i.Vector2(this.mouseDownPos.x,this.mouseDownPos.y),l=t.clientX-this.masterContainer.getBoundingClientRect().x,h=t.clientY-this.masterContainer.getBoundingClientRect().y,c=new i.Vector2(l,h),d=(new i.Vector2).subVectors(r,c),p=0,u=0,g="",m="",f="",b="",v=new i.Vector2(this.topLeft.x-this.topRight.x,this.topLeft.y-this.topRight.y),_=new i.Vector2(this.topRight.x-this.topLeft.x,this.topRight.y-this.topLeft.y),D=new i.Vector2(this.topLeft.x-this.bottomLeft.x,this.topLeft.y-this.bottomLeft.y),w=new i.Vector2(this.topRight.x-this.bottomRight.x,this.topRight.y-this.bottomRight.y),x=new i.Vector2(this.bottomRight.x-this.topRight.x,this.bottomRight.y-this.topRight.y),y=new i.Vector2(this.bottomLeft.x-this.bottomRight.x,this.bottomLeft.y-this.bottomRight.y),I=new i.Vector2(this.bottomRight.x-this.bottomLeft.x,this.bottomRight.y-this.bottomLeft.y);switch(this.targetElem){case"top-left-handle":p=d.dot(v)/v.length(),u=d.dot(D)/D.length(),s=this.actualWidthOfImageNode-p-this.fixedPosition.right,a=this.actualHeightOfImageNode-u-this.fixedPosition.bottom,s+this.fixedPosition.right>this.actualWidthOfImageNode&&(s=this.actualWidthOfImageNode-this.fixedPosition.right),a+this.fixedPosition.bottom>this.actualHeightOfImageNode&&(a=this.actualHeightOfImageNode-this.fixedPosition.bottom),f=this.fixedPosition.bottom+"px",b=this.fixedPosition.right+"px";break;case"top-handle":u=d.dot(D)/D.length(),(a=this.actualHeightOfImageNode-u-this.fixedPosition.bottom)+this.fixedPosition.bottom>this.actualHeightOfImageNode&&(a=this.actualHeightOfImageNode-this.fixedPosition.bottom),f=this.fixedPosition.bottom+"px",b=this.fixedPosition.right+"px",m=this.fixedPosition.left+"px";break;case"top-right-handle":p=d.dot(_)/_.length(),u=d.dot(w)/w.length(),(s=this.actualWidthOfImageNode-p-this.fixedPosition.left)+this.fixedPosition.left>this.actualWidthOfImageNode&&(s=this.actualWidthOfImageNode-this.fixedPosition.left),(a=this.actualHeightOfImageNode-u-this.fixedPosition.bottom)+this.fixedPosition.bottom>this.actualHeightOfImageNode&&(a=this.actualHeightOfImageNode-this.fixedPosition.bottom),f=this.fixedPosition.bottom+"px",m=this.fixedPosition.left+"px";break;case"right-handle":p=d.dot(_)/_.length(),(s=this.actualWidthOfImageNode-p-this.fixedPosition.left)+this.fixedPosition.left>this.actualWidthOfImageNode&&(s=this.actualWidthOfImageNode-this.fixedPosition.left),m=this.fixedPosition.left+"px",g=this.fixedPosition.top+"px",f=this.fixedPosition.bottom+"px";break;case"bottom-right-handle":p=d.dot(I)/I.length(),u=d.dot(x)/x.length(),s=this.actualWidthOfImageNode-p-this.fixedPosition.left,a=this.actualHeightOfImageNode-u-this.fixedPosition.top,s+this.fixedPosition.left>this.actualWidthOfImageNode&&(s=this.actualWidthOfImageNode-this.fixedPosition.left),a+this.fixedPosition.top>this.actualHeightOfImageNode&&(a=this.actualHeightOfImageNode-this.fixedPosition.top),g=this.fixedPosition.top+"px",m=this.fixedPosition.left+"px";break;case"bottom-handle":u=d.dot(x)/x.length(),(a=this.actualHeightOfImageNode-u-this.fixedPosition.top)+this.fixedPosition.top>this.actualHeightOfImageNode&&(a=this.actualHeightOfImageNode-this.fixedPosition.top),g=this.fixedPosition.top+"px",m=this.fixedPosition.left+"px",b=this.fixedPosition.right+"px";break;case"bottom-left-handle":p=d.dot(y)/y.length(),u=d.dot(x)/x.length(),s=this.actualWidthOfImageNode-p-this.fixedPosition.right,a=this.actualHeightOfImageNode-u-this.fixedPosition.top,s+this.fixedPosition.right>this.actualWidthOfImageNode&&(s=this.actualWidthOfImageNode-this.fixedPosition.right),a+this.fixedPosition.top>this.actualHeightOfImageNode&&(a=this.actualHeightOfImageNode-this.fixedPosition.top),g=this.fixedPosition.top+"px",b=this.fixedPosition.right+"px";break;case"left-handle":p=d.dot(y)/y.length(),(s=this.actualWidthOfImageNode-p-this.fixedPosition.right)+this.fixedPosition.right>this.actualWidthOfImageNode&&(s=this.actualWidthOfImageNode-this.fixedPosition.right),g=this.fixedPosition.top+"px",b=this.fixedPosition.right+"px",f=this.fixedPosition.bottom+"px";break;case"center-handle":o=(e=(new i.Vector2).subVectors(r,c)).dot(v)/v.length(),n=e.dot(D)/D.length(),""!==this.cropBox.style.left&&((m=o-this._dx_1)<0?m=0:m>this.actualWidthOfImageNode-s&&(m=this.actualWidthOfImageNode-s),m+="px"),""!==this.cropBox.style.top&&((g=n-this._dy_1)<0?g=0:g>this.actualHeightOfImageNode-a&&(g=this.actualHeightOfImageNode-a),g+="px")}this.cropBox.setStyles({width:(s<60?60:s)+"px",height:(a<60?60:a)+"px",top:g,left:m,right:b,bottom:f}),this.croppedImage.setStyles({top:g?"-"+g:"",left:m?"-"+m:"",right:b?"-"+b:"",bottom:f?"-"+f:""}),t.preventDefault()}},onMouseUp:function(t){if(this.isDragging){this.isDragging=!1;let e=0,i=0;e=""!==this.cropBox.style.top?parseInt(this.cropBox.style.top):""!==this.cropBox.style.bottom?parseInt(this.container.style.height)-(parseInt(this.cropBox.style.bottom)+parseInt(this.cropBox.style.height)):0,i=""!==this.cropBox.style.left?parseInt(this.cropBox.style.left):""!==this.cropBox.style.right?parseInt(this.container.style.width)-(parseInt(this.cropBox.style.right)+parseInt(this.cropBox.style.width)):0,this.cropBox.setStyles({top:e+"px",left:i+"px"}),t.preventDefault()}},buildUI:function(t){this.isDragging=!1,this.mouseDownPos=null,this.fixedPosition={},this.targetElem="";let i=0,n=0,s=0,a=0;i=void 0===t.cropSectionTop?t.topLeft.y:t.cropSectionTop*(t.imageWidth/t.actualImageWidth),n=void 0===t.cropSectionLeft?t.topLeft.x:t.cropSectionLeft*(t.imageHeight/t.actualImageHeight),s=(t.cropSectionWidth,t.imageWidth),a=(t.cropSectionHeight,t.imageHeight),this.topLeft=t.topLeft,this.topRight=t.topRight,this.bottomRight=t.bottomRight,this.bottomLeft=t.bottomLeft,this.masterContainer=new e.Element("div",{id:"cropbox-ui-container",styles:{width:"100%",height:"100%",position:"absolute",top:"0px",left:"0px","background-color":"rgba(0, 0, 0, 0.5)"}}).inject(t.container);let r="translate("+(t.centerX-.5*s)+"px, "+(t.centerY-.5*a)+"px) ",l="rotate("+t.angle*(180/Math.PI)+"deg)";this.angle=t.angle;this.container=new e.Element("div",{id:"full-background-image",styles:{position:"absolute",top:"0px",left:"0px",width:s+"px",height:a+"px","pointer-events":"auto",transform:r+l,opacity:.2,"background-image":"url("+t.imageURL+")","background-size":"contain","background-repeat":"no-repeat"}}).inject(this.masterContainer),this.actualImageBlackOverlay=new e.Element("div",{id:"actual-image-black-overlay",styles:{position:"absolute",top:"0px",left:"0px",width:s+"px",height:a+"px","background-color":"rgba(0, 0, 0, 0.6)",transform:r+l}}).inject(this.masterContainer),this.cropBox=new e.Element("div",{id:"image-crop-box",styles:{width:t.cropSectionWidth?t.cropSectionWidth*(t.imageWidth/t.actualImageWidth):t.imageWidth+"px",height:t.cropSectionWidth?t.cropSectionHeight*(t.imageHeight/t.actualImageHeight):t.imageHeight+"px",top:t.cropSectionTop?i:"0px",left:t.cropSectionLeft?n:"0px",position:"absolute",overflow:"hidden"}}).inject(this.actualImageBlackOverlay),this.cropBox.addEvent(o.POINTERDOWN,function(t){this.targetElem="center-handle",this.mouseDownPos=this.topLeft,this.onMouseDown(t)}.bind(this)),this.croppedImage=new e.Element("img",{id:"cropped-image",src:t.imageURL,styles:{width:s+"px",height:a+"px",top:t.cropSectionTop?-i:"0px",left:t.cropSectionLeft?-n:"0px",position:"absolute","pointer-events":"none"}}).inject(this.cropBox),new e.Element("div",{id:"top-left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 31,1 31,8 8,8 8,31 1,31 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"0px",left:"0px",cursor:"nw-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="top-left-handle",this.mouseDownPos=this.topLeft,this.fixedPosition={bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height)),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width))},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"top-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="30" height="8" stroke="black" stroke-width="2" fill="white" x="1" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"0px",left:"calc(50% - 10px)",cursor:"n-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="top-handle",this.mouseDownPos={x:.5*(this.topLeft.x+this.topRight.x),y:.5*(this.topLeft.y+this.topRight.y)},this.fixedPosition={bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height)),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width)),left:parseInt(this.cropBox.style.left)},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"top-right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 31,1 31,31 24,31 24,8 1,8 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"0px",right:"0px",cursor:"ne-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="top-right-handle",this.mouseDownPos=this.topRight,this.fixedPosition={left:parseInt(this.cropBox.style.left),bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height))},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="8" height="30" stroke="black" stroke-width="2" fill="white" x="23" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",right:"0px",top:"calc(50% - 10px)",cursor:"e-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="right-handle",this.mouseDownPos={x:.5*(this.topRight.x+this.bottomRight.x),y:.5*(this.topRight.y+this.bottomRight.y)},this.fixedPosition={top:parseInt(this.cropBox.style.top),left:parseInt(this.cropBox.style.left),bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height))},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"bottom-right-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="31,31 31,1 24,1 24,24 1,24 1,31 31,31"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"0px",right:"0px",cursor:"se-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="bottom-right-handle",this.mouseDownPos=this.bottomRight,this.fixedPosition={top:parseInt(this.cropBox.style.top),left:parseInt(this.cropBox.style.left)},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"bottom-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="30" height="8" stroke="black" stroke-width="2" fill="white" x="1" y="23"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"0px",left:"calc(50% - 10px)",cursor:"s-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="bottom-handle",this.mouseDownPos={x:.5*(this.bottomRight.x+this.bottomLeft.x),y:.5*(this.bottomRight.y+this.bottomLeft.y)},this.fixedPosition={top:parseInt(this.cropBox.style.top),left:parseInt(this.cropBox.style.left),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width))},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"bottom-left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><polygon stroke="black" stroke-width="2" stroke-linecap="butt" fill="white" points="1,1 1,31 31,31 31,24 8,24 8,1 1,1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",bottom:"0px",left:"0px",cursor:"sw-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="bottom-left-handle",this.mouseDownPos=this.bottomLeft,this.fixedPosition={top:parseInt(this.cropBox.style.top),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width))},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"left-handle",html:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve"><rect width="8" height="30" stroke="black" stroke-width="2" fill="white" x="1" y="1"/></svg>',styles:{height:"20px",width:"20px",position:"absolute",top:"calc(50% - 10px)",left:"0px",cursor:"w-resize","z-index":1}}).inject(this.cropBox).addEvent(o.POINTERDOWN,function(t){this.targetElem="left-handle",this.mouseDownPos={x:.5*(this.bottomLeft.x+this.topLeft.x),y:.5*(this.bottomLeft.y+this.topLeft.y)},this.fixedPosition={top:parseInt(this.cropBox.style.top),right:parseInt(this.container.style.width)-(parseInt(this.cropBox.style.left)+parseInt(this.cropBox.style.width)),bottom:parseInt(this.container.style.height)-(parseInt(this.cropBox.style.top)+parseInt(this.cropBox.style.height))},this.onMouseDown(t)}.bind(this)),new e.Element("div",{id:"center-handle",styles:{height:"8px",width:"8px",position:"absolute",top:"calc(50% - 4px)",left:"calc(50% - 4px)",cursor:"crosshair","z-index":1,"background-color":"white",border:"1px solid black"}}).inject(this.cropBox),this.masterContainer.addEvent(o.POINTERMOVE,this.onMouseMove.bind(this)),this.masterContainer.addEvent(o.POINTERUP,this.onMouseUp.bind(this)),this.masterContainer.addEventListener("mouseleave",this.onMouseUp.bind(this))},getCropInfo:function(t,e){let i=parseInt(this.cropBox.style.top),o=parseInt(this.cropBox.style.left),n=parseInt(this.cropBox.style.width),s=parseInt(this.cropBox.style.height),a=this.srcImage.width/t;return{srcData:{width:this.srcImage.width,height:this.srcImage.height},cropData:{top:i*a,left:o*a,width:n*a,height:s*a,hRatio:n/t,vRatio:s/e}}},dispose:function(){this.actualImageBlackOverlay&&(this.actualImageBlackOverlay.remove(),this.actualImageBlackOverlay=void 0),this.container&&(this.container.remove(),this.container=void 0),this.masterContainer&&(this.masterContainer.remove(),this.masterContainer=void 0)}})}),define("DS/CAT3DWInfraUI/CAT3DWAnnotHandleManipulator",["DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle","UWA/Core"],function(t,e){"use strict";var i=t.extend({init:function(t){t.mode="AnnotShapeEdit",this._parent(t)},_getListOfManipulatorNames:function(){return["bottomRightHandler","bottomLeftHandler","topRightHandler","topLeftHandler","rotationHandler","bottomCenterHandler","topCenterHandler","leftCenterHandler","rightCenterHandler"]},updateAll:function(t){if(t){this.objects=t;for(let e of this._manipulators)e.objects=t}this._parent(t)}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWAnnotHandleManipulator",i)}),define("DS/CAT3DWInfraUI/CAT3DWManageManipulators",["DS/CAT3DWInfraUI/CAT3DWResizeAndRotateHandle","UWA/Class","UWA/Core","DS/CAT3DWInfraUI/CAT3DWAnnotHandleManipulator"],function(t,e,i,o){"use strict";var n=e.extend({assignManipulator:function(e){return"CAT3DSKAnnotationShape"===e.media.getType()?new o(e):new t(e)},assignManipulatorToGroup:function(e){var i=new t({viewer:e.viewer,sceneGraph:e.sceneGraph,group:e.group,mediaController:e.mediaController,planeChoiceNode:e.planeChoiceNode});i.pause(),e.group.handle=i,e.group.setHandle(i)}});return i.namespace("DS/CAT3DWInfraUI/CAT3DWManageManipulators",n)}),define("DS/CAT3DWInfraUI/CAT3DWCanvasServices",["UWA/Class","UWA/Core","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfraUI/CAT3DWCanvasLimits"],function(t,e,i,o){"use strict";return t.extend({createCanvas:function(t){var i=t||{},n=new e.Element("canvas");return i.id&&(n.id=i.id),o.areDimensionsWithinLimits(i.width,i.height)||console.warn("[CAT3DWCanvasServices] "+i.tag+" : the dimensions of the canvas exceed the safety limits. A memory crash may occur."),i.height&&(n.height=i.height),i.width&&(n.width=i.width),n},resizeCanvas:function(t,e,i){var o=this.createCanvas({width:e,height:i,tag:"resizeCanvas"});return o.getContext("2d").drawImage(t,0,0,o.width,o.height),o},loadImage:function(t,e,o,n){var s=new Image;s.onload=function(){o&&o(s)},s.onerror=function(e){console.error("Failed to load image "+t),n&&n(e)},s.crossOrigin=e?"anonymous":i.getPreferenceValue("CrossOrigin"),s.src=t},loadVideo:function(t,e,o,n){var s=document.createElement("video");s.addEventListener("loadedmetadata",function(){o&&o(s)}),s.onerror=function(e){console.error("Failed to load video "+t),n&&n(e)},s.crossOrigin=e?"anonymous":i.getPreferenceValue("CrossOrigin"),s.src=t},getOptimizedDataUrlFromUrl:function(t,e,i,o,n){this.loadImage(t,!1,function(t){var s=this.getOptimizedDataUrlFromImg(t,e,i,n);o&&o(s)}.bind(this))},getOptimizedDataUrlFromImg:function(t,e,i,o){var n=e||2e3,s=i||1500,a=this._getNewDimensions(t,n,s),r=this.createCanvas({width:a.width,height:a.height,tag:"getOptimizedDataUrlFromImgCanvas"}),l=r.getContext("2d");l.fillStyle="white",l.fillRect(0,0,a.width,a.height),l.drawImage(t,0,0,a.width,a.height);var h=r.toDataURL(o||"image/jpeg");return r=null,l=null,h},getDataUrlFromImg:function(t,e){var i,n=this.createCanvas({tag:"getDataUrlFromImgCanvas"}),s=null,a=e||"image/jpeg";if(o.areDimensionsWithinLimits(t.width,t.height))n.height=t.height,n.width=t.width,s=n.getContext("2d"),"image/jpeg"!==a&&"image/jpg"!==a||(s.fillStyle="white",s.fillRect(0,0,n.width,n.height)),s.drawImage(t,0,0,t.width,t.height);else{var r=t.width/t.height,l=Math.floor(Math.sqrt(o.MPLimit/r)),h=Math.floor(r*l);n.height=l,n.width=h,s=n.getContext("2d"),"image/jpeg"!==a&&"image/jpg"!==a||(s.fillStyle="white",s.fillRect(0,0,n.width,n.height)),s.drawImage(t,0,0,t.width,t.height,0,0,h,l)}i=n.toDataURL(a);var c={height:n.height,width:n.width};return n=null,s=null,{dataUrl:i,dimensions:c}},getCanvasFromImageUrl:function(t){return new Promise(function(e){this.loadImage(t,!1,function(t){var i=this.createCanvas({width:t.width,height:t.height,tag:"getCanvasFromImageUrlCanvas"});i.getContext("2d").drawImage(t,0,0,t.width,t.height),e(i)}.bind(this),function(){e(null)})}.bind(this))},getBlobUrlFromImg:function(t,e,i,o){this.getDataUrlFromImgSrc(t,function(t,i){var n=this.getBlobUrlFromDataUrl(t,o);e(n,i)}.bind(this),o,i)},getBlobFromCanvas:function(t,e){if(!t)return null;var i=e||"image/jpg",o=t.toDataURL(i);return this.getBlobFromDataUrl(o,i)},getBlobUrlFromCanvas:function(t,e){if(!t)return null;var i=e||"image/jpg",o=t.toDataURL(i);return this.getBlobUrlFromDataUrl(o,i)},getBlobUrlFromDataUrl:function(t,e){if(!t)return"";var i=this._fromBase64ToBlob(t,e);return this._fromBlobToImage(i)},getBlobFromDataUrl:function(t,e){return t?this._fromBase64ToBlob(t,e):""},getBlobFromImageSrc:function(t,e,i,o){this.getDataUrlFromImgSrc(t,function(t){var o=this.getBlobFromDataUrl(t,i);e(o)}.bind(this),i,o)},getDataUrlFromImgSrc:function(t,e,i,o){this.loadImage(t,!1,function(t){var o=this.getDataUrlFromImg(t,i).dataUrl;e(o,{width:t.width,height:t.height}),t=null}.bind(this),o)},getBlobFromVideoSrc:function(t,e,i,o){this.getDataUrlFromVideoSrc(t,function(t){var o=this.getBlobFromDataUrl(t,i);e(o)}.bind(this),i,o)},getDataUrlFromVideoSrc:function(t,e,i,o){this.loadVideo(t,!1,function(t){var o=this.getDataUrlFromImg(t,i).dataUrl;e(o,{width:t.width,height:t.height}),t=null}.bind(this),o)},base64ToArrayBuffer:function(t){for(var e=window.atob(t),i=e.length,o=new Uint8Array(i),n=0;n<i;n++)o[n]=e.charCodeAt(n);return o.buffer},imageToBuffer:function(t,e){var i=e||"image/jpeg",o=this.getDataUrlFromImg(t,i).dataUrl,n=this.getDataUrlFromImg(t,i).dimensions;return{imgBuffer:this.base64ToArrayBuffer(o.split(",")[1]),newDimensions:n}},_fromBase64ToBlob:function(t,e){return this._b64toBlob(t.split(",")[1],e)},_fromBlobToImage:function(t){return URL.createObjectURL(t)},_b64toBlobNoType:function(t){for(var e=atob(t),i=e.length,o=new Uint8Array(i),n=0;n<i;n++)o[n]=e.charCodeAt(n);return new Blob([o],{type:""})},_b64toBlob:function(t,e){for(var i=e||"image/jpeg",o=atob(t),n=o.length,s=new Uint8Array(n),a=0;a<n;a++)s[a]=o.charCodeAt(a);return new Blob([s],{type:i})},_getNewDimensions:function(t,e,i){var o=t.width,n=t.height;return o>n?o>e&&(n*=e/o,o=e):n>i&&(o*=i/n,n=i),{width:o,height:n}},StringToArrayBuffer:function(t){return this.StringToUint8Array(t).buffer},StringToBinary:function(t){var e,i,o,n,s,a;for(s=t.length,e=[],n=!1,o=a=0;0<=s?a<s:a>s;o=0<=s?++a:--a){if((i=String.prototype.charCodeAt.call(t,o))>255){n=!0,e=null;break}e.push(i)}return!0===n?unescape(encodeURIComponent(t)):String.fromCharCode.apply(null,Array.prototype.slice.apply(e))},StringToUint8Array:function(t){var e,i,o,n,s,a;for(i=(e=this.StringToBinary(t)).length,o=new ArrayBuffer(i),n=new Uint8Array(o),s=a=0;0<=i?a<i:a>i;s=0<=i?++a:--a)n[s]=String.prototype.charCodeAt.call(e,s);return n},getCroppedImageUrl:function(t,e,i){if(!t||!e||!i)return;let o=new Image;o.onload=(()=>{let t=e.top,n=e.left,s=e.width,a=e.height,r=this.createCanvas({width:s,height:a,tag:"getCroppedImageUrlCanvas"});r.getContext("2d").drawImage(o,n,t,s,a,0,0,s,a),r.toBlob(t=>{let e=URL.createObjectURL(t);r.remove(),r=void 0,i(e)})}),o.crossOrigin="use-credentials",o.src=t},_getCroppedImageUrlFromActualImage:function(t,e,i){if(!t||!e||!i)return;let o=e.top,n=e.left,s=e.width,a=e.height,r=this.createCanvas({width:s,height:a,tag:"_getCroppedImageUrlCanvas"});r.getContext("2d").drawImage(t,n,o,s,a,0,0,s,a),r.toBlob(function(t){try{let e=URL.createObjectURL(t);r.remove(),r=void 0,i(e)}catch(t){console.log(t),i(null)}})},_createTextureImageFromSVG:function(t){let i=new Blob([t.svgString],{type:"image/svg+xml"}),o=URL.createObjectURL(i),n=t.width,s=t.height,a=new Image;a.width=n,a.height=s,a.onload=function(i){let o=new e.Element("canvas",{width:n,height:s});o.getContext("2d").drawImage(a,0,0,n,s),o.toBlob(function(e){let i=URL.createObjectURL(e);t.onTextureImageCreatedCB(i)},{type:"image/jpeg"})},a.src=o},cropImageFromCanvas:function(t){var e,i,o,n=t.getContext("2d",{willReadFrequently:!0}),s=t.width,a=t.height,r={x:[],y:[]},l=n.getImageData(0,0,t.width,t.height),h=-1,c=-1,d=-1,p=-1;for(i=0;i<a;i++)for(e=0;e<s;e++)o=4*(i*s+e),l.data[o+3]>0&&(r.x.push(e),r.y.push(i),-1===h?(h=e,d=e,c=i,p=i):(e<=h&&(h=e),e>=d&&(d=e),i<=c&&(c=i),i>=p&&(p=i)));s=1+d-h,a=1+p-c;var u=n.getImageData(h,c,s,a);t.width=s,t.height=a,n.putImageData(u,0,0)}})}),define("DS/CAT3DWInfraUI/CAT3DWPublishServices",["UWA/Class","UWA/Core","DS/ApplicationFrame/FrameWindowsManager","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/ZipJS/zip","DS/CAT3DWInfraUI/CAT3DWCanvasServices"],function(t,e,i,o,n,s){"use strict";var a=t.extend({getScreenShot:function(t){var e;t.viewer?e=t.viewer:i.getFrameWindow().getViewer()&&(e=i.getFrameWindow().getViewer());var n=e.currentViewpoint,a=o.getPreferenceValue("MobileMode"),r=null,l=null;if(t.quality?"low"===t.quality?l=a?2097152:33554432:"medium"===t.quality?l=a?4194304:67108864:"high"===t.quality&&(l=a?16777216:268435456):l=16777216,t.width&&t.height){let e=t.width,i=t.height,o=e*i,n=Math.sqrt(l/o);n<1&&(e*=n,i*=n),r={width:Math.floor(e),height:Math.floor(i)}}else{let t=e.SCREEN_WIDTH*window.devicePixelRatio,i=e.SCREEN_HEIGHT*window.devicePixelRatio,o=t*i,n=Math.sqrt(l/o);n>1&&(n=Math.floor(n)),r={width:Math.floor(t*n),height:Math.floor(i*n)}}r.data=new Uint8ClampedArray(4*r.width*r.height),r.bufferWidth=r.width,r.bufferHeight=r.height,n.getControl().update(),e.renderToTarget(r,n);var h,c,d,p,u=new Uint8ClampedArray(4*r.width*r.height),g=r.height,m=r.width,f=4*m;for(c=0;c<g;c++)for(d=c*m*4,p=(g-c)*m*4-f,h=f;h--;)u[d+h]=r.data[p+h],u[d+h];var b=(new s).createCanvas({width:r.width,height:r.height,tag:"PublishScreenshotCanvas"}),v=b.getContext("2d"),_=new ImageData(u,b.width,b.height);v.putImageData(_,0,0),t.onSuccess(b)},zip:function(t){return new Promise(function(e,i){var o=null,s=function(t){if(0===t.length)o.close(function(t){e(t)});else{var i=t.shift(),a=null;"text"===i.type?a=new n.TextReader(i.data):"blob"===i.type&&(a=new n.BlobReader(i.data)),o.add(i.filename,a,function(){s(t)})}},a=new n.BlobWriter;n.createWriter(a,function(e){o=e,s(t)},function(){console.log("zip creation error"),i()})})},unzip:function(t,e){return new Promise(function(i){var o=new n.BlobReader(t);n.createReader(o,function(t){var o=t;o.getEntries(function(t){var s=t.find(function(t){return t.filename===e});s&&s.getData(new n.TextWriter,function(t){var e=t.target.result;o.close(function(){i(e)})})})},function(){console.log("zip error")})})}});return e.namespace("DS/CAT3DWInfraUI/CAT3DWPublishServices",a)});