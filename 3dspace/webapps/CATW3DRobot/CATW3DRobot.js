define("DS/CATW3DRobot/CATC3DRobotSnapPanel",["UWA/Core","UWA/Class","DS/Windows/Panel","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Controls/LineEditor","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/CATW3DRobot/assets/nls/CATC3DRobotSnapPanel","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Controls/Button","DS/CATWebUXComponents/DMUCommandsManager","DS/CoreEvents/Events","css!DS/CATW3DRobot/CATW3DRobot"],function(e,t,n,i,o,a,r,l,s,u,c,d){"use strict";return t.extend({init:function(t){let p=window.widget&&window.widget.lang?window.widget.lang:void 0;const m=new Intl.NumberFormat(p).format(1.1).replaceAll("1","");var g=t.immersiveFrame,v=Object.assign({},t.w3dRobot.getLengthUnit()),h=Object.assign({},t.w3dRobot.getAngleUnit()),b=r.Length[v.unit].ratio,f=r.Angle[h.unit].ratio,y=i.get(),M=y._viewer.getRobot(),x=y._viewer,w=s.giveMoveManager({context:y}),V=new e.Element("div"),C=new a({}),P=[];C.elements.inputField.setStyles({height:"0px",border:"0px"}),C.elements.container.setStyles({fontSize:"0px"}),C.inject(V);var D=new e.Element("div",{html:l.translation}).inject(V);P.push({type:"X",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Length",label:l.translationX}),P.push({type:"Y",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Length",label:l.translationY}),P.push({type:"Z",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Length",label:l.translationZ}),new e.Element("div",{html:l.rotation}).inject(D).setStyles({"padding-top":"10px"}),P.push({type:"U",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Angle",label:l.rotationU}),P.push({type:"V",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Angle",label:l.rotationV}),P.push({type:"W",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(D),magnitude:"Angle",label:l.rotationW});var E=0;const R=new Map;R.set(0,0),R.set(1,0),R.set(2,0);var A,S=new o.Vector3,T=new o.Vector3,F=new o.Vector3,L=x.getMousePosition({x:i._context.getFrameWindow().getContextualUIManager()._mousePos.x,y:i._context.getFrameWindow().getContextualUIManager()._mousePos.y}),k=0;function W(e,t){return"string"==typeof e&&(e=parseFloat((e||"").replace(m,"."))),isNaN(e)?(e=t.mksVal,isNaN(e)&&(e=0)):e="Length"===t.magnitude?e/b:e/f,e}function O(e,t){"string"==typeof e&&(e=parseFloat(e)),isNaN(e)&&(e=t.mksVal),isNaN(e)&&(e=0),"Length"===t.magnitude?e*=b:((e%=2*Math.PI)<0&&(e+=2*Math.PI),e*=f);let n="Length"===t.magnitude?v.decimalPlaceRO:h.decimalPlaceRO;return e=Math.round(e*Math.pow(10,n))/Math.pow(10,n),e="Length"===t.magnitude?e.toString().replace(".",m)+" "+r.Length[v.unit].symbol:e.toString().replace(".",m)+" "+r.Angle[h.unit].symbol}function N(e,t){k=1,P[e].editDiv.value=O(t,P[e]),k=0}function B(e){k=1,P[e].editDiv._myInput.select(),P[e].editDiv._giveFocus(),k=0}for(let t=0;t<6;t++)new e.Element("span",{text:P[t].label}).inject(P[t].mainDiv),P[t].editDiv=new a({value:O(0,P[t]),selectAllOnFocus:!0}),P[t].editDiv.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),P[t].editDiv.inject(P[t].mainDiv);var I=new u({label:l.save,emphasize:"primary",disabled:!0,showLabelFlag:!0}).inject(D);I.elements.button.setStyles({margin:"8px"});var G=new u({label:l.cancel,emphasize:"secondary",showLabelFlag:!0}).inject(D),U=function(e,t,n){e._modelEvent.publish({event:"LineTranslationBegin",data:{eventChannel:"LineTranslationBegin",target:e.target,intersection:t,manipulator:n}})},_=function(e,t,n,i){e._modelEvent.publish({event:"LineTranslationEnd",data:{eventChannel:"LineTranslationEnd",target:e.target,intersection:t,manipulator:n,FromPanel:i}})},X=function(e,t,n,i){e._modelEvent.publish({event:"RotationBegin",data:{eventChannel:"RotationBegin",target:e.target,intersection:t,manipulator:n,angle:event.dsModel.value,axis:i}})},Y=function(e,t){e._modelEvent.publish({event:"RotationEnd",data:{eventChannel:"RotationEnd",target:e.target,fromPanel:t}})},j=function(e){let t,n,i;return M.getMatrix().extractBasis(S,T,F),"X"===e.type?(t=M.arrowX,n="arrowX",i=S):"Y"===e.type?(t=M.arrowY,n="arrowY",i=T):"Z"===e.type&&(t=M.arrowZ,n="arrowZ",i=F),t.manipulatedPaths=[],t.manipulatedPaths[0]={externalPath:[],internalPath:[]},t.manipulatedPaths[0].externalPath[0]={name:n},t.axis=i,t},H=function(e){let t,n;return M.getMatrix().extractBasis(S,T,F),"U"===e.type?(t=M.rotationArcYZ,n=S):"V"===e.type?(t=M.rotationArcXZ,n=T):"W"===e.type&&(t=M.rotationArcXY,n=F),{manip:t,axis:n}};[0,1,2].forEach(e=>{P[e].editDiv.addEventListener("focus",function(t){if(!k){P[e].mksVal=W(t.dsModel.value,P[e]);var n=x.pick(L,"mesh",!0),i=j(P[e]);M&&(U(M,n,i),_(M,n,i,!0))}}),P[e].editDiv.addEventListener("change",function(t){if(!k){let l=W(t.dsModel.value,P[e]);var n=x.pick(L,"mesh",!0),i=j(P[e]),a=(r=P[e],M.getMatrix().extractBasis(S,T,F),(new o.Vector3).copy("X"===r.type?S:"Y"===r.type?T:F)).setLength(1e3*(l-P[e].mksVal));P[e].mksVal=l,M&&(U(M,n,i),function(e,t,n,i,a){e._modelEvent.publish({event:"LineTranslationManipulation",data:{eventChannel:"LineTranslationManipulation",target:e.target,translationVector:t,intersection:n,manipulator:i,FromPanel:a}}),e.setMatrix((new o.Matrix4).copy(e.getMatrix()).setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()).add(t))),E=1}(M,a,n,i,!0),N(e,l),_(M,n,i,!0))}var r}),P[e].editDiv.addEventListener("blur",function(e){e.stopPropagation()})}),[3,4,5].forEach(e=>{P[e].editDiv.addEventListener("focus",function(){if(!k){A!==P[e].type&&(N(e,0),R.set(e-3,0));var t=x.pick(L,"mesh",!0),n=H(P[e]);M&&(X(M,t,n.manip,n.axis),Y(M,!0),A=P[e].type)}}),P[e].editDiv.addEventListener("change",function(t){if(!k){let r=W(t.dsModel.value,P[e]);var n=x.pick(L,"mesh",!0),i=H(P[e]),a=r-R.get(e-3);R.set(e-3,r),M&&(X(M,n,i.manip,i.axis),function(e,t,n,i,a,r){e._modelEvent.publish({event:"RotationManipulation",data:{eventChannel:"RotationManipulation",target:e.target,intersection:t,manipulator:n,angle:a,axis:i,FromPanel:r}});var l=(new o.Matrix4).makeRotationAxis(i,a).multiply((new o.Matrix4).extractRotation(e.getMatrix()));M.setMatrix(l.setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()))),E=1}(M,n,i.manip,i.axis,a,!0),N(e,r),Y(M,!0),A=P[e].type)}}),P[e].editDiv.addEventListener("blur",function(e){e.stopPropagation()})});var Z=function(e,t){return e.x.toFixed(3)===t.x.toFixed(3)&&e.y.toFixed(3)===t.y.toFixed(3)&&e.z.toFixed(3)===t.z.toFixed(3)},q=function(e){return Z(e,M.arrowX.manipulator.axis)?0:Z(e,M.arrowY.manipulator.axis)?1:Z(e,M.arrowZ.manipulator.axis)?2:-1},z=function(e){return Z(e,M.rotationArcYZ.axis)?3:Z(e,M.rotationArcXZ.axis)?4:Z(e,M.rotationArcXY.axis)?5:-1};t.w3dRobot._rulerformed(function(e){if(k=1,"arrowX"===e.direction){let t=M.getMatrix().getPosition().x-e.cposition.x;P[0].mksVal=t/1e3,N(0,P[0].mksVal),B(0)}else if("arrowY"===e.direction){let t=M.getMatrix().getPosition().y-e.cposition.y;P[1].mksVal=t/1e3,N(1,P[1].mksVal),B(1)}else if("arrowZ"===e.direction){let t=M.getMatrix().getPosition().z-e.cposition.z;P[2].mksVal=t/1e3,N(2,P[2].mksVal),B(2)}k=0}),t.w3dRobot.rulerCB(function(e){if("RulerManipulate"===e.eventName){let t=q(e.direction);t>=0&&(P[t].mksVal=e.value/1e3,N(t,P[t].mksVal),B(t))}else if("AngularRulerManipulate"===e.eventName){let t=z(e.direction);if(t>=0){let n=e.diffAngle/180*Math.PI;N(t,n+R.get(t-3)),B(t),R.set(t-3,n+R.get(t-3))}}else if("AngularRulerManipulateBegin"===e.eventName){let t=z(e.direction);if(t>=0){let n=e.value/180*Math.PI;N(t,n),R.set(t-3,n),A=P[t].type}}}),t.w3dRobot.manipCB(function(e){switch(e.Rulerchannel){case"LineTranslationManipulation":if(!e.Rulersource){let t=q(e.Rulerdirection);t>=0&&(P[t].mksVal=e.Rulervalue/1e3,N(t,P[t].mksVal),B(t))}break;case"RotationBegin":if(!e.Rulersource){let t=z(e.Rulerdirection);t>=0&&A!==P[t].type&&(N(3,0),N(4,0),N(5,0),B(t),R.set(t-3,0))}break;case"RotationManipulation":if(!e.Rulersource){let t=z(e.Rulerdirection),n=e.Rulervalue/180*Math.PI;t>=0&&(N(t,n),B(t),R.set(t-3,n),A=P[t].type)}break;case"PlaneTranslationManipulation":var n,i,a=(new o.Vector3).getPositionFromMatrix(M.getMatrix()),r=(new o.Vector3).copy(M.arrowX.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(M.arrowX.manipulator.axis)),l=(new o.Vector3).copy(M.arrowY.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(M.arrowY.manipulator.axis)),s=(new o.Vector3).copy(M.arrowZ.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(M.arrowZ.manipulator.axis));n=(new o.Vector3).copy(a).add(r);var u=(new o.Vector3).copy(n).sub(a).dot(M.arrowX.manipulator.axis);i=n.distanceTo(a)*(u>0?-1:1),P[0].mksVal=i/1e3,N(0,P[0].mksVal),n=(new o.Vector3).copy(a).add(l),u=(new o.Vector3).copy(n).sub(a).dot(M.arrowY.manipulator.axis),i=n.distanceTo(a)*(u>0?-1:1),P[1].mksVal=i/1e3,N(1,P[1].mksVal),n=(new o.Vector3).copy(a).add(s),u=(new o.Vector3).copy(n).sub(a).dot(M.arrowZ.manipulator.axis),i=n.distanceTo(a)*(u>0?-1:1),P[2].mksVal=i/1e3,N(2,P[2].mksVal),0===e.vector.x?B(1):B(0)}});var K=c.getCommand("CAT3DComposeMoveHdr",i.get()._context);K&&K.isRunning()&&(E=1);var J=this._panel=new n({immersiveFrame:g,content:V,icon:{iconName:"part-position wux-ui-3ds",fontIconFamily:window.WUXManagedFontIcons.Font3DS},visibleFlag:!0,minWidth:170,height:"auto",maxHeight:660,currentDockArea:8,allowedDockAreas:15,position:{my:"right",at:"right",of:g},collapsibleFlag:!1,verticallyStretchableFlag:!0,closeButtonFlag:!1,resizableFlag:!0,activeFlag:!1}),Q=function(){P[0].mksVal=0,P[1].mksVal=0,P[2].mksVal=0,k=0,R.set(0,0),R.set(1,0),R.set(2,0)};M.subscribe("ScreenPlaneTranslationBegin",function(){J.destroy(),Q()}),M.subscribe("ScreenPlaneTranslationEnd",function(){J.destroy(),Q()}),w.subscribe("onCancelMove",function(){J.destroy(),Q()}),w.subscribe("onValidateMove",function(){K&&K.cancel(),J.destroy(),Q()}),w.subscribe("Move",function(){E=1,I.disabled=!1}),I.addEventListener("buttonclick",function(){w.terminateMove({save:!0}),y.getExecutionContext&&d.publish({event:"onCommandStart/BEGIN",data:{_id:y.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}})}),G.addEventListener("buttonclick",function(){if(E)w.terminateMove({save:!1}),(K=c.getCommand("CAT3DComposeMoveHdr",i.get()._context))&&K.cancel();else{var e=c.getCommand("CAT3DComposeRobotSnapMoveHdr",i.get()._context),t=c.getCommand("CAT3DComposeWidgetDefaultHdr",i.get()._context);e._isRunning?e.end():t.end(),J.destroy(),Q()}y.getExecutionContext&&d.publish({event:"onCommandStart/BEGIN",data:{_id:y.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getDefaultCommand()}})});let $=function(e){let t=e.which||e.keyCode;27===t?J&&(J.destroy(),Q(),document.body.removeEventListener("keydown",$)):13===t?J&&E&&(J.destroy(),Q(),document.body.removeEventListener("keydown",$)):9!==t||J.activeFlag||(J.activeFlag=!0)};document.body.addEventListener("keydown",$),this.setLengthUnit=function(t){if(!e.equals(v,t)){v=Object.assign({},t),b=r.Length[v.unit].ratio;for(let e=0;e<3;e++)N(e,P[e].mksVal)}},this.setAngleUnit=function(t){if(!e.equals(h,t)){h=Object.assign({},t),f=r.Angle[h.unit].ratio;for(let e=3;e<6;e++)N(e,R.get(e-3))}}}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATW3DRobot/CATW3DRobot",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DRobot/CATC3DRobotSnapPanel"],function(e,t,n,i,o,a,r,l,s,u,c,d,p,m,g,v,h,b,f){"use strict";var y=150,M=150,x=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var n=e.externalPath[t];if(h.isPLMNode(n))break;if("AxisSystems"===n.name)return!0}return!1},w=function(e){var t=[];return o.get().forEach(function(n){var i=e.getMoveReferent(n.pathElement);i&&t.push({path:i})}),t},V=function(){o.get().forEach(function(e){i.isIn(e)||i.add(e)})},C=function(){o.get().forEach(function(e){i.remove(e)})},P=function(e,t){e.scalingNodeX.setVisibility(!1),e.scalingNodeY.setVisibility(!1),e.scalingNodeZ.setVisibility(!1);var n=!t||!t.hasOwnProperty("translate")||"boolean"!=typeof t.translate||t.translate;e.arrowX.setVisibility(n),e.arrowY.setVisibility(n),e.arrowZ.setVisibility(n),n=!t||!t.hasOwnProperty("rotate")||"boolean"!=typeof t.rotate||t.rotate,e.rotationArcXY.setVisibility(n),e.rotationArcXZ.setVisibility(n),e.rotationArcYZ.setVisibility(n),n=!t||!t.hasOwnProperty("translatePlane")||"boolean"!=typeof t.translatePlane||t.translatePlane,e.translationPlaneXY.setVisibility(n),e.translationPlaneXZ.setVisibility(n),e.translationPlaneYZ.setVisibility(n),n=!t||!t.hasOwnProperty("robotMove")||"boolean"!=typeof t.robotMove||t.robotMove,e.robotHandle.setVisibility(n)},D=e.extend({init:function(e){var D,E,R,A=e.context,S=A.getFrameWindow(),T=A.getViewer(),F=g.giveMoveManager({context:A}),L=m.getMoveReferentManager({context:A}),k=s.getConstraintsController({context:A}),W=S.getContextualUIManager(),O="",N=new p,B=this,I=0,G=new t.Vector3,U=function(e){var n={},i=null;if(e.translationVector)i=k.simulateMoveWithCst({translation:e.translationVector});else if(e.rotationMatrix){var o=[[e.rotationMatrix.elements[0],e.rotationMatrix.elements[4],e.rotationMatrix.elements[8]],[e.rotationMatrix.elements[1],e.rotationMatrix.elements[5],e.rotationMatrix.elements[9]],[e.rotationMatrix.elements[2],e.rotationMatrix.elements[6],e.rotationMatrix.elements[10]]];i=k.simulateMoveWithCst({rotation:o})}if(i&&i.matrix){var a=(new t.Matrix4).multiplyMatrices(i.matrix,e.objectMoved.path.getWorldMatrix());n.worldMatrix=a}return n},_=function(){var e=o.get();(e.length>1||k.count()>0&&1===e.length&&!k.isLevelConstrained(L.getMoveReferent(e[0].pathElement)))&&k.deleteAllCst()},X=!0,Y={},j={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},H={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3};if(S)if(A)if(F)if(L){T.setRobot(!0,{snapOnFace:!1,showOnlyManipulated:!1});var Z=T.getRobot();P(Z),Z.setAddToCSO(!1),Z.setAddToHSO(!1),Z.setDisplayScalingNodes(!1),Z.setMoveMode("CALLBACK_ONLY"),Z.setCheckTarget(!1),Z.CallBackEventHandlerViewPoint();var q,z,K,J,Q,$,ee,te,ne=[],ie=[],oe=[],ae={},re=null,le=null,se=[],ue=[],ce={origin:new t.Vector3,initOrigin:new t.Vector3,direction:null,initValue:null,value:null},de={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},pe=!1,me=null,ge=function(){ie.length||(ie.push(F.subscribe("MoveBegin",function(){Q=Z.getMatrix(),J=(new t.Matrix4).getInverse(z.getWorldMatrix()).multiply(Q)})),ie.push(F.subscribe("Move",function(e){if(J&&Q){if(e.from===ae)return;if(Ge(),this.isVisible()&&this.setVisibility(!1),"Persistent"===e.moveMode){var t=z.getWorldMatrix().multiply(J);Z.setMatrix(t)}}}.bind(this))),ie.push(F.subscribe("MoveEnd",function(e){if(J&&Q){if("Cancelled"===e.status&&Z.setRobotMatrix(Q),e.from===ae)return;if(this.setVisibility(!0),"Moved"===e.status){var t=z.getWorldMatrix().multiply(J);Z.setRobotMatrix(t)}me={},J=Q=void 0}}.bind(this))))}.bind(this),ve=function(){ie.forEach(function(e){F.unsubscribe(e)}),ie.length=0,te=null},he=function(e){var t=null,n=A.getRootBagPath().getLastElement(!0);return e.some(function(e){return!!e.externalPath.some(function(e){return n===e})&&(t=e,!0)}),t},be=function(e,t){var n={pathElement:null},i=A.getRootBagPath().getLastElement(!0);if(i&&e&&e.externalPath&&e.externalPath.some(function(e){return i===e})&&(n.pathElement=e),Y.filterPath&&n.pathElement&&t&&t.event){var o=t.event.gesture?t.event.gesture.getEvents()[0]:t.event.from[0],a=T.pick(T.getMousePosition(o.getCurrentPosition(T.canvas)),"primHybrid",!0);(n=Y.filterPath({pathElement:he(a.path)}))&&(n.normal=a.normal)}if(n.pathElement&&!x(n.pathElement)&&!n.pathElement.internalPath.length)for(;!h.isPLMNode(n.pathElement.getLastElement(!0));)n.pathElement=n.pathElement.getParentPath();return n};Z.setSnapFilterCallback(function(e){return be(e).pathElement}),Z.setSnapTranslationCallback(function(e){if(0!==w(L).length){if($){var t=$.getSnappedTranslationVector(e);return 0!==t.returnCode?null:t.snappedTranslationVector}return e.translationVector}}),Z.setSnapRotationCallback(function(e){if(0===w(L).length)return{};if(ee){var t=ee.getSnappedRotationValue(e);return 0!==t.returnCode?{value:void 0,axis:null}:{value:t.snappedRotationAngle,axis:t.axis}}var n=180*e.angle/Math.PI;return de.direction.dot(e.axis)<0&&(n=360-n),{value:n,axis:e.axis}});var fe=function(){$&&($.direction=null,$.origin=new t.Vector3,$.origin3DPos=null,$.setValue(0)),ee&&(ee.direction=null,ee.origin=null,ee.originVector=null,ee.setValue(0)),Ge()},ye=new c("RobotLocalAxisSystem"),Me=new c("RobotPrevisuNode");Me.exludeFromBounding(!0),Me.setVisibilityFree(!0),Me.setVisibilityInTree(!1),Me.setPickable(l.PICKTHROUGH),Me.setNoZ(!0),T.addNode(Me),Me.updateDisplay=function(e,t,n){Me.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&Me.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var xe=new r({headLength:10,arrowLength:50,arrowWidth:2,head:r.types.ARROW,colors:{colorX:new l.Color(1,0,0,0),colorY:new l.Color(0,1,0,0),colorZ:new l.Color(0,0,1,0)}});ye.exludeFromBounding(!0),ye.setVisibilityFree(!0),ye.setVisibilityInTree(!1),ye.setPickable(l.PICKTHROUGH),ye.addChild(xe),ye.updateDisplay=function(e){if(0===ye.parents.length&&T.addNode(ye),e.visibility&&e.pathElement&&0===e.pathElement.internalPath.length){if(Y&&Y.getFiltersState&&Y.getFiltersState().surface){for(var t,n=e.pathElement.externalPath.length-1;n>=0&&!t;n--)h.isRepReference(e.pathElement.externalPath[n])&&(t=e.pathElement.externalPath[n]);if(t){var i=h.getNodeID(t);if(i&&!A.getController().hasMeshInRAM(i))return}}ye.setMatrix(e.pathElement.getWorldMatrix()),ye.setVisibility(!0)}e.visibility||ye.setVisibility(!1)},ye.updateDisplay({visibility:!1});var we=null,Ve=new n("RobotLocalAxisSystem",T,!1,!1);Ve.exludeFromBounding(!0),Ve.setVisibilityFree(!0),Ve.setVisibilityInTree(!1),Ve.setPickable(l.PICKTHROUGH),Ve.setVisibility(!1),P(Ve,{robotMove:!1,translate:!1}),Ve.updateDisplay=function(e){var t,n,i,o;0===Ve.parents.length&&T.addNode(Ve),e.visibility&&e.pathElement&&(we&&(clearInterval(we),we=null),Ve.setMatrix(e.pathElement.getWorldMatrix()),t=Ve.fixedSizeNode3D,n=we,i=T,o=4,t.setRatio(o/10),n=setInterval(function(){if(11===o)return clearInterval(n),void(n=null);o++,t.setRatio(4*o/10),i.render()},10),Ve.setVisibility(!0),X&&Z.setVisibility(!1)),e.visibility||(clearInterval(we),we=null,Ve.setVisibility(!1),X&&Z.setVisibility(!0))};var Ce,Pe,De,Ee,Re,Ae,Se=function(){require(["DS/LevelSelector/LevelSelector"],function(e){e.destroyView()}),W.hideContextualMenus()},Te=function(){if(Se(),z){let n=Boolean(A.getExecutionContext),i=[{name:"CATW3DRobotLevelSelectorStr",line:1,hdr_list:["CATW3DRobotLevelSelectorHdr"],type:"handler",identifier:"CATW3DRobotLevelSelectorHdr"}];if(w(L).some(function(e){var t=e.path.getMatrix();return 1!==t.elements[0]||1!==t.elements[5]||1!==t.elements[10]||1!==t.elements[15]||0!==t.elements[1]||0!==t.elements[2]||0!==t.elements[3]||0!==t.elements[4]||0!==t.elements[6]||0!==t.elements[7]||0!==t.elements[8]||0!==t.elements[9]||0!==t.elements[11]||0!==t.elements[12]||0!==t.elements[13]||0!==t.elements[14]})&&i.push({name:"CATW3DSetIdentityPositionStr",line:1,hdr_list:["CATW3DSetIdentityPositionHdr"],type:"handler",identifier:"CATW3DSetIdentityPositionHdr"}),i.length>0)if(n)W._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:i}}},context:A.getCommandContext(),workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}]});else{var e=T.currentViewpoint.project((new t.Vector3).getPositionFromMatrix(Z.getMatrix()));W.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:i}},context:A.getCommandContext(),workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}],x:e.x+45,y:e.y-45})}}},Fe=function(){Z.arrowX.mat.opacity=.2,Z.arrowY.mat.opacity=.2,Z.arrowZ.mat.opacity=.2,Z.translationPlaneYZ.planeMat.opacity=.2,Z.translationPlaneXY.planeMat.opacity=.2,Z.translationPlaneXZ.planeMat.opacity=.2,Z.rotationArcYZ.planeMat.opacity=.2,Z.rotationArcXZ.planeMat.opacity=.2,Z.rotationArcXY.privilegedPlaneMat.opacity=.2},Le=function(){Z.setToNonGhostState()},ke=function(e){var n,i,o;if(D&&D(e),"RulerManipulateBegin"===e.eventName||"AngularRulerManipulateBegin"===e.eventName){Se(),C(z,F),Ce=new t.Vector3,Pe=0;var a={objectsMoved:w(L),from:ae,moveMode:"Persistent"};"AngularRulerManipulateBegin"===e.eventName&&(me={},a.axis=(new t.Vector3).copy(e.direction),a.center=(new t.Vector3).getPositionFromMatrix(Z.getMatrix())),F.onMoveBegin(a)}else if("RulerManipulate"===e.eventName){if(!(o=w(L)).length)return;_(),n={objectsMoved:o,from:ae},e.rulerDragged||V(),Ce.add(e.translationVector),Z.setMatrix((new t.Matrix4).copy(Q).setPosition((new t.Vector3).getPositionFromMatrix(Q).add(Ce))),0===k.count()||0===n.objectsMoved.length?n.vector=Ce:(i=U({translationVector:e.translationVector,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),F.onMove(n),T.render()}else if("AngularRulerManipulate"===e.eventName){if(!(o=w(L)).length)return;_(),n={objectsMoved:o,from:ae},e.rulerDragged||V();var r=e.diffAngle*Math.PI/180;Pe+=r;var l=(new t.Matrix4).makeRotationAxis(e.direction,Pe).multiply((new t.Matrix4).extractRotation(Q));Z.setMatrix(l.setPosition((new t.Vector3).getPositionFromMatrix(Q))),de.value=ee.value;var s=(new t.Matrix4).makeRotationAxis(e.direction,r);0===k.count()||0===n.objectsMoved.length?n.angle=Pe:(i=U({rotationMatrix:s,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),F.onMove(n),T.render()}else if("RulerManipulateEnd"===e.eventName||"AngularRulerManipulateEnd"===e.eventName){V();var u={from:ae,status:"Moved"};"Cancelled"===e.status?u.status="Cancelled":Z.setRobotMatrix(Z.getMatrix()),F.onMoveEnd(u)}},We=function(e){if(N.publish({event:"onRobotMoveBegin"}),z){var n;T.setCursor("pointer"),Se(),Ge(),I=0,G=new t.Vector3,O="",C(z,F),n=e.manipulator,[Z.arrowX,Z.arrowY,Z.arrowZ,Z.translationPlaneYZ,Z.translationPlaneXY,Z.translationPlaneXZ,Z.rotationArcYZ,Z.rotationArcXZ,Z.rotationArcXY].forEach(function(e){e&&e.manipulator&&e.manipulator!==n&&e.setToGhostState()}),Z.robotHandle.setToGhostState();var i,o={objectsMoved:w(L),from:ae,moveMode:"Persistent"};if("LineTranslationBegin"===e.eventChannel){for(var a=0;a<e.manipulator.manipulatedPaths[0].externalPath.length;a++)if(e.manipulator.manipulatedPaths[0].externalPath[a].name.startsWith("arrow")){O=e.manipulator.manipulatedPaths[0].externalPath[a].name;break}i=(new t.Vector3).copy(e.manipulator.axis);var r=(new t.Vector3).getPositionFromMatrix(Z.getMatrix()),l=(new t.Vector3).copy(i).multiplyScalar((new t.Vector3).copy(ce.baseOrigin).sub(r).dot(i));ce.initOrigin=(new t.Vector3).copy(r).add(l);var s=(new t.Vector3).copy(ce.initOrigin),u=null;me&&"string"==typeof O&&(O.match("arrowX")&&me.X3Dpos?u=(new t.Vector3).copy(me.X3Dpos):O.match("arrowY")&&me.Y3Dpos?u=(new t.Vector3).copy(me.Y3Dpos):O.match("arrowZ")&&me.Z3Dpos&&(u=(new t.Vector3).copy(me.Z3Dpos)),u&&(s=new t.Line3(ce.initOrigin,(new t.Vector3).copy(ce.initOrigin).add(i)).closestPointToPoint(u,!1))),ce.origin=s;var c=(new t.Vector3).copy(ce.origin).sub(r).dot(i);ce.direction=i,ce.value=s.distanceTo(r)*(c>0?-1:1),ce.initValue=ce.value,$&&($.origin=ce.origin,$.origin3DPos=u,$.initOrigin=ce.initOrigin,$.setValue(ce.value),$.direction=ce.direction,$.initValue=ce.initValue,$.displayOrigin=!$.origin.equals($.initOrigin),$.unit=j.unit,$.display(),$.beginManipulation())}else if("RotationBegin"===e.eventChannel){me={},o.center=(new t.Vector3).getPositionFromMatrix(Z.getMatrix()),i=(new t.Vector3).copy(e.manipulator.axis);var d={Rulervalue:ee.value,Rulerdirection:i,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};if(E&&E(d),!de.direction||0===Math.round(100*i.dot(de.direction))||!function(){for(var e=new v(z.externalPath);e&&!h.isPLMNode(e.getLastElement(!0));)e=e.getParentPath();if(!de.path)return de.path=e,!0;var t=!!e&&e.isEqual(de.path);return de.path=e,t}()){var p=new t.Vector3,m=new t.Vector3,g=new t.Vector3;Z.getMatrix().extractBasis(p,m,g),p.normalize(),m.normalize();var b=Math.round(100*p.dot(i)),f=Math.round(100*m.dot(i));0===b?de.originVector=(new t.Vector3).copy(p):0===f&&(de.originVector=(new t.Vector3).copy(m)),de.value=0,de.direction=i}o.axis=(new t.Vector3).copy(de.direction),de.origin=(new t.Vector3).getPositionFromMatrix(Z.getMatrix()),de.initValue=de.value,ee&&(ee.originVector=de.originVector,ee.setValue(de.value),ee.origin=de.origin,ee.direction=de.direction,ee.initValue=de.initValue,ee.unit=H.unit,ee.display(),ee.beginManipulation())}F.onMoveBegin(o)}},Oe=function(e){if(z){if(T.setCursor("pointer"),"LineTranslationManipulation"===e.eventChannel){if(ce.value=ce.initValue+e.translationVector.length()*(ce.direction.dot(e.translationVector)>0?1:-1),$){var n={Rulervalue:ce.value,Rulerdirection:ce.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};E&&E(n),$.setValue(ce.value)}}else if("RotationManipulation"===e.eventChannel){me={};var i=(new t.Vector3).copy(e.axis),o=de.direction.dot(i)<0?2*Math.PI-e.angle:e.angle;if(de.value=de.initValue+180*o/Math.PI,ee.setValue(de.value),ee){var a={Rulervalue:ee.value,Rulerdirection:de.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};E&&E(a)}}_();var r,l={objectsMoved:w(L),from:ae};if(e.translationVector)0===k.count()||0===l.objectsMoved.length?l.vector=e.translationVector:(r=U({translationVector:(new t.Vector3).subVectors(e.translationVector,G),objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix),G=e.translationVector;else{if(0===k.count()||0===l.objectsMoved.length)l.angle=e.angle;else{var s=(new t.Matrix4).makeRotationAxis(e.axis,e.angle-I);(r=U({rotationMatrix:s,objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix)}I=e.angle}if("PlaneTranslationManipulation"===e.eventChannel){var u={vector:l.vector,Rulerchannel:"PlaneTranslationManipulation"};E&&E(u)}F.onMove(l),T.render()}},Ne=function(e){z&&(Te(),V(),Le(),"LineTranslationEnd"===e.eventChannel?$&&($.endManipulation(),$.display()):"RotationEnd"===e.eventChannel&&ee&&(ee.endManipulation(),ee.display()),F.onMoveEnd({from:ae,status:"Moved"}),N.publish({event:"onRobotMoveEnd"}))},Be=!1,Ie=function(e){X&&("@onViewpointBeginMove"===e.eventType?Be=!0:"@onViewpointChange"===e.eventType?Be&&(Z.setVisibility(!1),T.render()):"@onViewpointEndMove"===e.eventType&&(Z.setVisibility(!0),Be=!1,T.render()))};require(["DS/CATWebUXComponents/DMUCommandsManager"],function(e){e.onCommandStart(function(e){ne.length&&("CATW3DRobotLevelSelectorHdr"===e._id?(W.hideContextualMenus(),K&&K.externalPath&&e.setRobotParams({pathContext:K,pathCurrent:z,doNotModifyCSO:!0,selectCB:function(e){He({pathElement:e.pathElement})}})):"CATW3DSetIdentityPositionHdr"===e._id?(W.hideContextualMenus(),Ue()):"CAT3DComposeWidgetDefaultHdr"===e._id||"CAT3DComposeMoveHdr"===e._id?(q||(q=u.subscribe({event:"/VISU/"},Ie)),"CAT3DComposeWidgetDefaultHdr"===e._id&&Ue()):"LevelSelectorHdr"===e._id||"HideShowHdr"===e._id||"CAT3DComposeMoveCmd"===e._id||("CAT3DComposeMoveHdr"===e._id&&A.getExecutionContext?Ue():"exclusive"===e._mode&&Ue()))},A.getCommandContext&&A.getCommandContext()?A.getCommandContext():void 0)}),this.setVisibility=function(e){if("boolean"==typeof e){e?(q||(q=u.subscribe({event:"/VISU/"},Ie)),$&&$.setVisibleFlag(!0),ee&&ee.setVisibleFlag(!0)):q&&($&&$.setVisibleFlag(!1),ee&&ee.setVisibleFlag(!1),u.unsubscribe(q),q=void 0),X=e;var t=Z.isVisible();return t&&e||!t&&!e?0:(Z.setVisibility(e),T.render(),0)}},this.isVisible=function(){return!!X&&Z.isVisible()},this.setSelectionFilter=function(e){Y=e&&e.filterPath?e:{}},this.setLengthUnit=function(e){j=Object.assign({},e),$&&$.getVisibleFlag()&&($.unit=j.unit,$.display()),te&&te.setLengthUnit(j)},this.getLengthUnit=function(){return j},this.setAngleUnit=function(e){H=Object.assign({},e),ee&&ee.getVisibleFlag()&&(ee.unit=H.unit,ee.display()),te&&te.setAngleUnit(H)},this.getAngleUnit=function(){return H},this.rulerCB=function(e){D=e},this.manipCB=function(e){E=e},this._rulerformed=function(e){R=e},this.modifyTargetAndPosition=He,this.addCoordPanel=Xe,this.hasTarget=function(){return Boolean(z)},this.subscribe=function(e,t){return"onRobotMoveBegin"===e||"onRobotMoveEnd"===e?N.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return N.unsubscribe(e)},this.activate=function(){ne.length||(ne.push(Z.subscribe("LineTranslationBegin",function(e){We(e)})),ne.push(Z.subscribe("RotationBegin",function(e){We(e)})),ne.push(Z.subscribe("ScalingBegin",function(e){We(e)})),ne.push(Z.subscribe("PlaneTranslationBegin",function(e){We(e)})),ne.push(Z.subscribe("LineTranslationManipulation",function(e){Oe(e)})),ne.push(Z.subscribe("RotationManipulation",function(e){Oe(e)})),ne.push(Z.subscribe("ScalingManipulation",function(e){Oe(e)})),ne.push(Z.subscribe("PlaneTranslationManipulation",function(e){Oe(e)})),ne.push(Z.subscribe("LineTranslationEnd",function(e){Ne(e)})),ne.push(Z.subscribe("RotationEnd",function(e){Ne(e)})),ne.push(Z.subscribe("ScalingEnd",function(e){Ne(e)})),ne.push(Z.subscribe("PlaneTranslationEnd",function(e){Ne(e)})),ne.push(Z.subscribe("ScreenPlaneTranslationBegin",function(e){Ye(),T.setCursor("pointer"),ve(),Fe(),Se(),C(z,F)})),ne.push(Z.subscribe("ScreenPlaneTranslationManipulation",function(e){!function e(t){if(Ae||(Ae=!0,N.publish({event:"onRobotMoveBegin"})),Re&&Re.cancel&&Re.cancel(),Re=null,T.setCursor("pointer"),Ge(),t.intersection.path.length){var n=t.intersection.path[0],i=be(n,t),o=i.pathElement;Y.getFiltersState&&(Re=b.switchToAV1withMesh({pathElement:n,pad3DViewer:A,selectionFilter:Y.getFiltersState(),onComplete:function(){e(t),Re=null},onFailure:function(){Re=null}})),z&&o&&z.isEqual(o)||(z=o?o.clone():null,o?x(o)?(ye.updateDisplay({visibility:!1}),Ve.updateDisplay({pathElement:o,visibility:!0})):(ye.updateDisplay({pathElement:o,visibility:!0}),Ve.updateDisplay({visibility:!1})):(ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}))),Me.updateDisplay(i,t.intersection.position,i.normal),je(i,t.intersection.position)}else je(),Me.updateDisplay(),ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}),z=null}(e)})),ne.push(Z.subscribe("ScreenPlaneTranslationEnd",function(e){!function(e){if(Ae=!1,A.getExecutionContext){let t=A.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent);e.event&&e.event.eventType&&"@onLeftMouseUpEvent"===e.event.eventType&&e.target&&t.executeHandler({id:"CAT3DComposeMoveHdr"})}Re&&Re.cancel&&Re.cancel(),Re=null;var n=be(e.target,e);if(z=n.pathElement,K=z,Z.target=z,me={},Le(),Ge(),ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}),z){var a=je(n,e.intersection.position);i.empty(),o.empty(),i.add(n),o.add({pathElement:n.pathElement,event:e.event,position:e&&e.intersection&&e.intersection.position,equivalentGeometry:n.equivalentGeometry}),ce.origin=(new t.Vector3).getPositionFromMatrix(a),ce.initOrigin=(new t.Vector3).getPositionFromMatrix(a),ce.baseOrigin=(new t.Vector3).getPositionFromMatrix(a),$&&($.initOrigin=ce.initOrigin,$.origin=ce.origin,me={})}fe();let r=require("DS/PADUtils/PADSettingsMgt").getSetting("enopad3dviewer_flexibleAssemblySupportActivated"),l=A.getController&&A.getController().hasAnyEffectiveFlexibleAssembly();require("DS/PADUtils/PADSettingsMgt").getSetting("useIndexAccleration")&&r&&l||!z?(ee&&(de={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),ve(),V(),e.target&&Ue()):(ge(),window.top.__C3D_ROBOTSNAP_PANELDISPLAY||("CATC3D_AP"===window.widget.data.appId||window.top.__C3D_ROBOTSNAP_PANELDISPLAYFORCE)&&Xe({immersiveFrame:S.getImmersiveFrame(),w3dRobot:B,robotP:e.intersection.position}),Te()),Me.removeChildren(),N.publish({event:"onRobotMoveEnd"})}(e)}))),oe.length||(oe.push(A.subscribe({event:"onRootRemoved"},function(e){_e([e])})),oe.push(A.subscribe({event:"onRootDetached"},function(e){_e([e])})),oe.push(A.subscribe({event:"onHide"},function(e){var t=[];e.paths.forEach(function(e){t.push({path:e})}),_e(t)})),oe.push(A.subscribe({event:"onBeginReparent"},function(){Ue()}))),q=u.subscribe({event:"/VISU/"},Ie)},this.deactivate=function(){ne.forEach(function(e){Z.unsubscribe(e)}),ne.length=0,oe.forEach(function(e){A.unsubscribe(e)}),oe.length=0,ve(),u.unsubscribe(q),q=null},this.unreference=function(){this.deactivate(),T.setRobot(!1),T.removeNode(ye),T.removeNode(Ve),Ge(),se.forEach(function(e){$.unsubscribe(e)}),ue.forEach(function(e){ee.unsubscribe(e)}),k&&k.unreference(),Z=A=S=T=F=L=k=me=N=null,re=le=W=Y=$=te=ee=ye=Ve=null}}else window.console.error("A move referent component must be defined");else window.console.error("A move manager component must be defined");else window.console.error("A context must be defined");else window.console.error("A frame window must be defined");function Ge(){$&&$.clear(),ee&&ee.clear()}function Ue(){Z.ScreenPlaneTranslationEndCB({intersection:{}})}function _e(e){z&&Array.isArray(e)&&e.some(function(e){if(e.path&&e.path.externalPath.length>1&&e.path.isAParentOf(z)||e.id&&e.id===h.getNodeID(z.externalPath[1]))return Ue(),!0})}function Xe(e){te||((te=new f(e)).setLengthUnit(j),te.setAngleUnit(H))}function Ye(){$&&ee||pe||(pe=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(e,n){S&&($=new e(S,{displayOrigin:!1,offset:y,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1}),re||(re=$.subscribe("OriginManipulateBegin",function(){Ee=null,De||(De=(new t.Vector3).copy($.origin))}),se.push(re)),le||(le=$.subscribe("OriginManipulateEnd",function(){me||(me={}),O.match("arrowX")?me.X3Dpos=Ee?(new t.Vector3).copy(Ee):null:O.match("arrowY")?me.Y3Dpos=Ee?(new t.Vector3).copy(Ee):null:O.match("arrowZ")&&(me.Z3Dpos=Ee?(new t.Vector3).copy(Ee):null),R&&R({direction:O,cposition:Ee}),Ee=null,a.empty()}),se.push(le)),$.onOriginManipulator=function(e){var n,i=null,o=Math.pow(10,6),r=T.pick(T.getMousePosition(e.event.from[0].getCurrentPosition(T.canvas)),Y.filterPath?"primHybrid":"mesh",!1);if(0===r.path.length||!r.path[0])return $.displayOrigin=!1,Ee=null,De;if(n=Y.filterPath?Y.filterPath({pathElement:he(r.path)}):{pathElement:he(r.path)},a.empty(),!n||!n.pathElement)return h.isAModelPath(r.path[0])&&a.add({pathElement:r.path[0]}),$.displayOrigin=!1,De;if(void 0!==n&&n&&n.equivalentGeometry){var l=0;switch(n.equivalentGeometry.getType()){case d.GeometryType.POINT:i=n.equivalentGeometry.getPoint();break;case d.GeometryType.CYLINDER:case d.GeometryType.CONE:var s=n.equivalentGeometry.getEndPoints(),u=new t.Line3(s.beginPoint,s.endPoint);(l=Math.round(u.delta().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=u.center());break;case d.GeometryType.CIRCLE:(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=n.equivalentGeometry.getCenter());break;case d.GeometryType.PLANE:case d.GeometryType.REFPLANE:0!==(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)&&l!==Math.round(Math.PI*o)/o||(i=r.position);break;case d.GeometryType.SPHERE:i=n.equivalentGeometry.getCenter();break;case d.GeometryType.AXISSYSTEM:i=(new t.Vector3).getPositionFromMatrix(n.equivalentGeometry.getMatrix());break;default:i=null}}return i||(n.pathElement.internalPath.length=0,Y.getFiltersState?Y.getFiltersState().product&&(i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())):i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())),a.add(n),i?($.displayOrigin=!0,Ee=(new t.Vector3).copy(i),i):($.displayOrigin=!1,Ee=null,De)},$.setVisibilityFree(!0),se.push($.subscribe("RulerManipulateBegin",function(e){ke(e)})),se.push($.subscribe("RulerManipulate",function(e){ke(e)})),se.push($.subscribe("RulerManipulateEnd",function(e){ke(e)})),(ee=new n(S,{radius:M,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0})).setVisibilityFree(!0),ue.push(ee.subscribe("AngularRulerManipulateBegin",function(e){ke(e)})),ue.push(ee.subscribe("AngularRulerManipulate",function(e){ke(e)})),ue.push(ee.subscribe("AngularRulerManipulateEnd",function(e){ke(e)})))}))}function je(e,n){if(e&&e.pathElement){Z.connect();var i=e.normal;delete e.normal;var o,a,r,l=e.pathElement.getWorldMatrix(),s=(new t.Vector3).copy(n);if(e.equivalentGeometry){var u,c=e.equivalentGeometry.getType();if(c===d.GeometryType.POINT)s=e.equivalentGeometry.getPoint();else if(c===d.GeometryType.LINE||c===d.GeometryType.CYLINDER||c===d.GeometryType.CONE){var p=e.equivalentGeometry.getEndPoints(),m=new t.Line3(p.beginPoint,p.endPoint);u=m.delta(),s=m.closestPointToPoint(s)}else c===d.GeometryType.CIRCLE?(u=e.equivalentGeometry.getNormal(),s=e.equivalentGeometry.getCenter()):c===d.GeometryType.PLANE||c===d.GeometryType.REFPLANE?u=e.equivalentGeometry.getNormal():c===d.GeometryType.SPHERE?s=e.equivalentGeometry.getCenter():c===d.GeometryType.SURFACE?u=i:c===d.GeometryType.AXISSYSTEM&&(s=null);u&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),u.normalize(),(new t.Vector3).crossVectors(o,u).length()<1e-9?(o.copy(a).projectOnPlane(u),o.normalize()):(o.projectOnPlane(u),o.normalize()),a.crossVectors(u,o),a.normalize(),l.makeBasis(o,a,u)),s&&l.setPosition(s),Z.setRobotMatrix(l)}else Y&&Y.getFiltersState&&Y.getFiltersState().surface?(i&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),i.normalize(),(new t.Vector3).crossVectors(o,i).length()<1e-9?(o.copy(a).projectOnPlane(i),o.normalize()):(o.projectOnPlane(i),o.normalize()),a.crossVectors(i,o),a.normalize(),l.makeBasis(o,a,i)),l.setPosition(s),Z.setRobotMatrix(l)):Z.setRobotMatrix(l.setPosition(s));return l}Z.disconnect()}function He(e){z=be(e.pathElement).pathElement,K||(K=z),Ye(),z?Z.connect():Z.disconnect(),Z.target=z;var n=Z.getMatrix(),i=z.getWorldMatrix();i.setPosition(e.robotPosition||(new t.Vector3).getPositionFromMatrix(n)),ce.origin=(new t.Vector3).getPositionFromMatrix(i),ce.initOrigin=(new t.Vector3).getPositionFromMatrix(i),ce.baseOrigin=(new t.Vector3).getPositionFromMatrix(i),$&&($.initOrigin=ce.initOrigin,$.origin=ce.origin,me={}),ee&&(de={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),Z.setRobotMatrix(i),fe(),ge()}}}),E=[];return e.singleton({init:function(){},giveMove3DRobot:function(e){var t;return e&&e.context&&(t=null,E.some(function(n){return n.context===e.context&&(t=n.enveloppe)})),t},getMove3DRobot:function(e){var t;if(e&&e.context&&(E.some(function(n){return n.context===e.context&&(t=n.enveloppe)}),!t)){var n=new D({context:e.context}),i=e.context.setRobotVisibility,o=e.context.isRobotVisible;n.activate();var a={unreference:function(){n&&(n.unreference(),n=null,E.some(function(e,t){if(e.enveloppe===a)return E.splice(t,1),e.context.setRobotVisibility=i,i=null,e.context.isRobotVisible=o,o=null,a=null,!0}))},setVisibility:function(e){return n?n.setVisibility(e):null},isVisible:function(){return n?n.isVisible():null},setSelectionFilter:function(e){return n?n.setSelectionFilter(e):null},setLengthUnit:function(e){return n?n.setLengthUnit(e):null},getLengthUnit:function(){return n?n.getLengthUnit():null},setAngleUnit:function(e){return n?n.setAngleUnit(e):null},getAngleUnit:function(){return n?n.getAngleUnit():null},hasTarget:function(e){return n?n.hasTarget(e):null},modifyTargetAndPosition:function(e){return n?n.modifyTargetAndPosition(e):null},addCoordPanel:function(e){return n?n.addCoordPanel(e):null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){return n?n.unsubscribe(e):null},rulerCB:function(e){return n?n.rulerCB(e):null},manipCB:function(e){return n?n.manipCB(e):null},_rulerformed:function(e){return n?n._rulerformed(e):null}};Object.freeze(a),e.context.setRobotVisibility=function(e){return a?a.setVisibility(e):null},e.context.isRobotVisible=function(){return a?a.isVisible():null},E.push({context:e.context,enveloppe:a}),t=a}return t}})});