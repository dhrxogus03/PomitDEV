define("DS/R2VMinimap/R2VMinimapServices",["DS/WAFData/WAFData"],function(i){"use strict";function t(i){this.options=i||{},this.options=Object.assign({isInitialize:!1,subs:[]},this.options),this.assets={},this.tileSets={},this.acquisitionPoints={},this.minimapInfo={}}function e(i){return"string"==typeof i&&"{"===i.charAt(0)?JSON.parse(i):i}return t.prototype.initialize=async function(i){void 0===i&&reject("R2VMinimapServices## Feature state ID not set"),this.options.r2vsurveyURL=await i.getURL("r2vsurvey");let t=i.psId,e=this.options.r2vsurveyURL+"/enovia/resources/r2v/v1/modeler/featurestate/"+t+"/assets",n={method:"GET",headers:{"Content-Type":"application/json"}};try{this.assets=JSON.parse(await this.__executeRequest(e,n))}catch(i){console.error("Error in assets retrieving:",i)}if(this.hasMinimap()){let i=this.options.r2vsurveyURL+"/enovia/resources/r2v/v1/modeler/minimap/"+t;n={method:"GET",headers:{"Content-Type":"application/json"}};try{let t=await this.__executeRequest(i,n);this.minimapInfo=t.result}catch(i){console.error("Error in getting minimap info:",i)}}let o=this.options.r2vsurveyURL+"/enovia/resources/r2v/v1/modeler/tileset",s={resourceId:t};n={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(s)};try{this.tileSets=(await this.__executeRequest(o,n)).tileSets}catch(i){console.error("Error in tileSets retrieving:",i)}if(this.hasAcquisitionPoints())for(let i=0;i<this.tileSets.length;i++)if("360"==this.tileSets[i].contentTypes[0]){let t=this.tileSets[i].baseTileURL+this.tileSets[i].rootURI;n={method:"GET",headers:{"Content-Type":"application/json"}};try{let i=JSON.parse(await this.__executeRequest(t,n));for(let t=1;t<i.length;++t){let e=i[t].json.matrix,n=e[12],o=e[13],s=e[14],a={};a.x=n,a.y=o,a.z=s;let r=this.getPositionOnMinimap(a),h="floor"+r.idLevel;this.acquisitionPoints.hasOwnProperty(h)||(this.acquisitionPoints[h]=[]);let p=this.acquisitionPoints[h].length+1,m={};m.id=p,m.coord=r.pointInMap,m.color="#EA4F37",this.acquisitionPoints[h].push(m)}}catch(i){console.error("Error while retrieving acquisitions points",i)}}this.options.isInitialize=!0},t.prototype.hasMinimap=function(){let i=!1;for(let t=0;t<this.assets.length;t++){if("Minimap"==this.assets[t].type){i=!0;break}}return i},t.prototype.hasAcquisitionPoints=function(){let i=!1;for(let t=0;t<this.assets.length;t++){let e=this.assets[t];if("360Image"==e.type||"Image360"==e.type){i=!0;break}}return i},t.prototype.getNumberOfLevel=function(){return!0!==this.options.isInitialize&&console.warn("R2VMinimapServices## Not initialize"),this.minimapInfo.floorNumbers},t.prototype.getInformationForLevel=function(i){let t="floor"+i;return{id:i,url:this.minimapInfo.colorUrls[i],acquisitionPoints:this.acquisitionPoints[t]}},t.prototype.getPositionOnMinimap=function(i){if(null==i||0==Object.keys(this.minimapInfo).length)return{idLevel:0,pointInMap:{x:Math.floor(this.minimapInfo.width/2),y:Math.floor(this.minimapInfo.height/2)}};let t=i.x,e=i.y,n=i.z,o=this.minimapInfo.width,s=this.minimapInfo.height,a=Math.floor(o*(t-this.minimapInfo.bboxMinX)/(this.minimapInfo.bboxMaxX-this.minimapInfo.bboxMinX)),r=Math.floor(s*(e-this.minimapInfo.bboxMinY)/(this.minimapInfo.bboxMaxY-this.minimapInfo.bboxMinY));a<0?a=0:a>o&&(a=o-1),r<0?r=0:r>s&&(r=s-1);let h=0;for(var p=this.minimapInfo.minHeights.length-1;p>=0;p--)if(n>this.minimapInfo.minHeights[p]){h=p;break}return{idLevel:h,pointInMap:{x:a,y:r}}},t.prototype.getViewpointFromPosition=function(i,t,e){var n={};return n.x=this.minimapInfo.bboxMinX+t/this.minimapInfo.width*(this.minimapInfo.bboxMaxX-this.minimapInfo.bboxMinX),n.y=this.minimapInfo.bboxMinY+e/this.minimapInfo.height*(this.minimapInfo.bboxMaxY-this.minimapInfo.bboxMinY),n.z=this.minimapInfo.maxHeights[i],n},t.prototype.__executeRequest=async function(t,n){return new Promise((o,s)=>{n.onComplete=function(i){var t={success:!0};i&&(t=e(i)),o(t)},n.onFailure=function(i,t){t&&(t=e(t)),s(t)},n.onTimeout=function(i,t){t&&(t=e(t)),s(t)},"POST"!==n.method||"string"==typeof n.data||n.data instanceof Blob||n.data instanceof FormData||(n.data=JSON.stringify(n.data)),i.authenticatedRequest(t,n)})},t});