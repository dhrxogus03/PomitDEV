define("DS/CAT3DWMedia/CAT3DWMediaDataService",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(){this._parent(),this._data={},this._saveData=[]},setValue:function(e,t){return this._data[e]=t,this._data[e]},setValues:function(e){for(var t in e)this.setValue(t,e[t])},getValue:function(e){return this._data[e]},getData:function(){return JSON.parse(JSON.stringify(this._data))},setData:function(e){return this._data=JSON.parse(JSON.stringify(e)),this._data},save:function(){this._saveData.push(JSON.parse(JSON.stringify(this._data)))},forgetChg:function(){this._saveData.length<=0?console.warn("Error during forgetChg : No data has been saved"):this._data=JSON.parse(JSON.stringify(this._saveData.pop()))},clearSave:function(){this._saveData=[]}});return UWA.namespace("DS/CAT3DWMedia/CAT3DWMediaDataService",t)}),define("DS/CAT3DWMedia/CAT3DWMediaView",["UWA/Core","DS/ApplicationFrame/FrameWindowsManager","DS/CAT3DWSceneObject/CAT3DWConnectableObject","DS/CAT3DWInfra/CAT3DWLogger","DS/CAT3DWVisu/CAT3DWVisuServices","DS/Visualization/MaterialApplication","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/CAT3DWVisu/CAT3DWNode3DHyperlink"],function(e,t,i,a,n,s,r,o,d){"use strict";var c=r.extend(i,{init:function(e,i){this._parent(e.getID()),this._media=e,this._saveMatrix=[];var a=t.getFrameWindow();this._viewer=a.getViewer(),this._viewpoint=a.getViewpoint(),i.addChild(this),this._selectionMaterialApp=new s({lineMaterial:n.getSelectionMaterial()}),this._coSelectionMaterialApp=new s({lineMaterial:n.getCoselectionMaterial()})},initialize:function(){this._viewer.render()},getMediaObj:function(){return this._media},getManipulatorsPositions:function(){return this.getCorners()},dispose:function(){this._media=null,this._saveMatrix=[]},setMatrix:function(e,t){t||a.error("CAT3DWMediaView.setMatrix is deprecated, please use setTransformation !"),this.isLocked()||this._parent(e)},applyMatrix:function(e){a.error("CAT3DWMediaView.applyMatrix is deprecated, please use setTransformation !"),this.isLocked()||this._parent(e)},updateHyperlinkNode:function(){var e=this.getChildren(),t=null;if(this._media.getHyperlink()||"CAT3DSKLink"===this.getType()){for(var i=0;i<e.length;i++)"CAT3DWNode3DHyperlink"===e[i].getName()&&(t=e[i]);var a=1;if("CAT3DWVideo"===this.getType()?a=1.4:"CAT3DWText"===this.getType()?a=.6:"CAT3DSKLink"===this.getType()&&(a=.4),null===t){var n=new d(this.getCorners(),this.getMatrixWorld(),a);this.addChild(n)}else t.update(this.getCorners(),this.getMatrixWorld(),a)}else if(!this._media.getHyperlink()){e=this.getChildren();for(var s=0;s<e.length;s++)"CAT3DWNode3DHyperlink"===e[s].getName()&&(e[s].deleteNode(),this.removeChild(e[s]))}},save:function(){this._saveMatrix.push(JSON.parse(JSON.stringify(this.getMatrix())))},forgetChg:function(){if(this._saveMatrix.length<=0)a.warn("Error during forgetChg : No matrix has been saved");else{var e=(new o.Matrix4).copy(JSON.parse(JSON.stringify(this._saveMatrix.pop())));this.setMatrix(e),this._viewer.render()}},clearSave:function(){this._saveMatrix=[]},isAlive:function(){return this._media.isAlive()},getID:function(){return this._media.getID()},getType:function(){return this._media.getType()},lock:function(e,t){t||this._media.lock(e,!0)},unlock:function(e,t){t||this._media.unlock(e,!0)},isLocked:function(){return this._media.isLocked()},group:function(e,t){return this._media.group(e,t)},ungroup:function(e){return this._media.ungroup(e)},isGrouped:function(){if(this._media)return this._media.isGrouped()},getGroupID:function(){return this._media.getGroupID()},activateSelectionFeedback:function(){this.isGrouped()||(this._selectionNode?this._materialType!==n.MATERIAL_TYPE.SELECTION&&(this._materialType=n.MATERIAL_TYPE.SELECTION,this._selectionNode.removeMaterialApplication(),this._selectionNode.setMaterialApplication(this._selectionMaterialApp)):(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this._materialType=n.MATERIAL_TYPE.SELECTION,this._selectionNode.setMaterialApplication(this._selectionMaterialApp),this.addChild(this._selectionNode)),this._selectionNode.setVisibility(!0))},deactivateSelectionFeedback:function(){this._selectionNode&&this._materialType===n.MATERIAL_TYPE.SELECTION&&this._selectionNode.setVisibility(!1)},activateThirdPartySelectionFeedback:function(e){this._selectionNode?this._selectionNode.removeMaterialApplication():(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this.addChild(this._selectionNode)),this._materialType=n.MATERIAL_TYPE.CUSTOM,this._selectionNode.setMaterialApplication(new s({lineMaterial:n.getCustomMaterial(e||new o.Color("rgb(92,92,92)"),!1,.75)})),this._selectionNode.setVisibility(!0)},deactivateThirdPartySelectionFeedback:function(){this._selectionNode&&this._materialType===n.MATERIAL_TYPE.CUSTOM&&this._selectionNode.setVisibility(!1)},activateCoselectionFeedback:function(){this._selectionNode?this._materialType!==n.MATERIAL_TYPE.COSELECTION&&(this._materialType=n.MATERIAL_TYPE.COSELECTION,this._selectionNode.removeMaterialApplication(),this._selectionNode.setMaterialApplication(this._coSelectionMaterialApp)):(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this._materialType=n.MATERIAL_TYPE.COSELECTION,this._selectionNode.setMaterialApplication(this._coSelectionMaterialApp),this.addChild(this._selectionNode)),this._selectionNode.setVisibility(!0)},deactivateCoselectionFeedback:function(){this._selectionNode&&this._materialType===n.MATERIAL_TYPE.COSELECTION&&this._selectionNode.setVisibility(!1)},_rebuildSelectionNode:function(){if(this._selectionNode){const e=this._selectionNode.isVisible(),t=this._selectionNode.getMaterialApplication();this.removeChild(this._selectionNode),this._selectionNode=void 0,e&&(this._selectionNode=this._createSelectionNode(),this._selectionNode.setNoZ(!0),this.addChild(this._selectionNode),this._selectionNode.setMaterialApplication(t),this._selectionNode.setVisibility(!0))}},undoAction:function(e){return this._media.undoAction(e)},redoAction:function(e){return this._media.redoAction(e)},setTransformation:function(e,t,i){return this._media.setTransformation(e,t,i)},getCurrentTransformation:function(){return this._media.getCurrentTransformation()},setProperties:function(e,t,i){return this._media.setProperties(e,t,i)},getCurrentProperties:function(){return this._media.getCurrentProperties()},setTransientPermanent:function(){return this._media.setTransientPermanent()},_transformationUpdate:function(e){this.setMatrix(e,!0),this.updateHyperlinkNode()},_propertiesUpdate:function(){},stream:function(e){return this._media.stream(e)},getAction:function(e){return this._media.getAction(e)},setAction:function(e,t){this._media.setAction(e,t)},hasAction:function(e){return this._media.hasAction(e)},getMoveData:function(){throw new Error("Must be implemented")},setMoveData:function(){throw new Error("Must be implemented")},getCenter:function(){var e=this.getMatrixWorld();return this._getRectangleCenter(e)},get2DPortPositions:function(){let e=new o.Vector2,t=new o.Vector2,i=new o.Vector2,a=new o.Vector2,n=this.getCorners(),s=n.topRight.clone().sub(n.topLeft).multiplyScalar(.5).add(n.topLeft),r=n.topLeft.clone().sub(n.bottomLeft);e.set(r.x,r.y).normalize();let d=n.bottomLeft.clone().sub(n.bottomRight).multiplyScalar(.5).add(n.bottomRight);t=e.clone().negate();let c=n.bottomLeft.clone().sub(n.topLeft).multiplyScalar(.5).add(n.topLeft),h=n.bottomLeft.clone().sub(n.bottomRight);i.set(h.x,h.y).normalize();let l=n.topRight.clone().sub(n.bottomRight).multiplyScalar(.5).add(n.bottomRight);return a=i.clone().negate(),{top:{pointCoordinates:new o.Vector2(s.x,s.y),normal:e},bottom:{pointCoordinates:new o.Vector2(d.x,d.y),normal:t},left:{pointCoordinates:new o.Vector2(c.x,c.y),normal:i},right:{pointCoordinates:new o.Vector2(l.x,l.y),normal:a}}}});return e.namespace("DS/CAT3DWMedia/CAT3DWMediaView",c)}),define("DS/CAT3DWMedia/CAT3DWMediaManager",["DS/ApplicationFrame/FrameWindowsManager","DS/CoreEvents/Events","UWA/Class"],function(e,t,i){"use strict";return i.extend({init:function(){this._id=0,this._idGroup=0,this._mediaList=[],this._rootNode=null},initialize:function(){var t=e.getFrameWindow();this._viewer=t.getViewer()},createMediaInGroup:function(e,t){if(!e)return-1;if(e.group){if("number"!=typeof e.group||e.group<0||e.group>=this._mediaList.length||!this._mediaList[e.group])return-1}else e.group=0;e.parentNode=this._rootNode,e.viewer=this._viewer,e.callback=t;var i=this.createMediaObject(e);return this._mediaList[e.group].push(i),i.initialize(e),i},createMediaObject:function(){throw new Error("'DS/CAT3DWMedia/CAT3DWMediaManager' is an abstract class. You must implement this function.")},createNewGroup:function(){return this._mediaList[this._idGroup]=[],this._idGroup++},getMedia:function(e){for(var t=null,i=0;i<this._mediaList.length;i++)if(this._mediaList[i])for(var a=0;a<this._mediaList[i].length;a++)if(this._mediaList[i][a].getID()===e){t=this._mediaList[i][a];break}return t},getMediasInGroup:function(e){return"number"!=typeof e||e<0||e>=this._mediaList.length?null:this._mediaList[e]},getNbMediasInGroup:function(e){var t=0,i=this.getMediasInGroup(e);return i&&(t=i.length),t},getMediaInGroup:function(e,t){if("number"==typeof e&&e>-1&&e<this._mediaList.length&&this._mediaList[e])for(var i=0;i<this._mediaList[e].length;i++)if(this._mediaList[e][i].getID()===t)return this._mediaList[e][i];return null},getNbMedias:function(){for(var e=0,t=0;t<this._mediaList.length;t++)e+=this.getNbMediasInGroup(t);return e},getAllMedias:function(){var e,t,i=[],a=null;for(e=0;e<this._mediaList.length;e++)if(a=this._mediaList[e])for(t=0;t<a.length;t++)i[i.length]=a[t];return i},removeMedia:function(e){if(e){for(var t=e.getID(),i=null,a=null,n=0;n<this._mediaList.length;n++)if(this._mediaList[n])for(var s=0;s<this._mediaList[n].length;s++)if(this._mediaList[n][s].getID()===t){i=n,a=s;break}e.dispose(),null!==i&&null!==a&&this._mediaList[i].splice(a,1),this._viewer.render()}},reset:function(e){this._mediaList=[],this._rootNode&&(this._rootNode.removeChildren(),this._rootNode=null),t.publish({event:this.getResetEvent(),data:e})},getResetEvent:function(){return"CAT3DWMediaManagerReset"},getRootNode:function(){return this._rootNode}})}),define("DS/CAT3DWMedia/CAT3DWMedia",["UWA/Core","DS/CAT3DWMedia/CAT3DWMediaDataService","DS/CAT3DWSceneObject/CAT3DWConnectableObject","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS"],function(e,t,i,a,n){"use strict";var s=i.extend({init:function(e){this._id=e.id,this._matrix=new n.Matrix4,e.mediaOccId&&(this._mediaOccId=e.mediaOccId),this._parentNode=e.parentNode,this._viewer=e.viewer,this.getDataService().setValue("thirdPartyColor",null),this._mediaView=this.createMediaView(this._parentNode,e),e.matrix&&this._matrix.copy(e.matrix),this._onTransformationCallbacks=[],this._parent(e),this._matrix.copy(this.getCurrentTransformation()),this._mediaView.setMatrix(this._matrix,!0)},update:function(e){this._id=e.id,e.mediaOccId&&(this._mediaOccId=e.mediaOccId),this.getDataService().setValue("updateData",e)},getUpdateData:function(){return{id:this._id,mediaOccId:this._mediaOccId}},dispose:function(){this._parentNode.remove(this._mediaView),this._mediaView.dispose(),this._mediaView=null},subscribeTransformation:function(e){this._onTransformationCallbacks.push(e)},unSubscribeTransformation:function(e){const t=this._onTransformationCallbacks.indexOf(e);this._onTransformationCallbacks.splice(t,1)},createMediaView:function(){throw new Error("You must implement this function")},getID:function(){return this._id},getMediaOccId:function(){return this._mediaOccId},getType:function(){return"CAT3DWMedia"},select:function(){this._mediaView.activateSelectionFeedback(),this.isSelected()||(this.getDataService().setValue("selected",!0),a.publish({event:"CAT3DSKSelectMediaEvent",data:{mediaID:this.getID(),type:this.getType()}}))},deselect:function(){this._mediaView.deactivateSelectionFeedback(),this.isSelected()&&(this.getDataService().setValue("selected",!1),a.publish({event:"CAT3DSKDeselectMediaEvent",data:{mediaID:this.getID(),type:this.getType()}}))},isSelected:function(){return this.getDataService().getValue("selected")},coselect:function(){!this.isAlive()||this.isSelected()||this.isGrouped()||this._mediaView.activateCoselectionFeedback()},decoselect:function(){this._mediaView.deactivateCoselectionFeedback()},lock:function(e,t){this._parent(e),t||this.getView().lock(e,!0)},unlock:function(e,t){this._parent(e),t||this.getView().unlock(e,!0)},get2DPortPositions:function(e){return this.getView().get2DPortPositions(e)},getCenter:function(){return this.getView().getCenter()},get2DProjectedPosition:function(e,t,i){return this.getView().get2DProjectedPosition(e,t,i)},getDataService:function(){return this._mediaData||(this._mediaData=new t),this._mediaData},getMatrix:function(){return this._matrix},getView:function(){return this._mediaView},save:function(){this.getDataService().save(),this.getView().save()},forgetChg:function(){this.getDataService().forgetChg()},clearSavedData:function(){this.getDataService().clearSave(),this.getView().clearSave()},getInititalState:function(){let e=this._parent();return e.transformation.matrixArray=this.getMatrix().toArray(),e},_transformationUpdate:function(e){this._matrix.copy(e),this.getView()._transformationUpdate(e);for(let e=0;e<this._onTransformationCallbacks.length;e++)this._onTransformationCallbacks[e](this)},_propertiesUpdate:function(e){this._parent(e),this._mediaView.updateHyperlinkNode()},stream:function(e){let t=this._parent(e);return t.id=this.getID(),t.mediaId=this.getDataService().getValue("mediaId"),t.locked=this.isLocked(),t.matrix=this._mediaView.getMatrix(),t.renderDepth=this._mediaView.getDepth(),t},thirdPartySelect:function(e){this.getView().activateThirdPartySelectionFeedback(e.color),this.getDataService().setValue("thirdPartyUserInfo",e)},thirdPartyDeselect:function(){this.getView().deactivateThirdPartySelectionFeedback(),this.getDataService().setValue("thirdPartyUserInfo",null)},isThirdPartySelected:function(){return!!this.getDataService().getValue("thirdPartyUserInfo")},getThirdPartyUserInfo:function(){return this.getDataService().getValue("thirdPartyUserInfo")},callOnMediaSaveCB:function(e){if(!e.error){this.getDataService().setValue("mediaId",e.mediaId),this.getDataService().setValue("published",e.published);var t=this.getMediaOccId();if(e.mapOfMediaOccIdToMedia)for(let i=0;i<e.mapOfMediaOccIdToMedia.get(t).length;i++)e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("mediaId",e.mediaId),e.mapOfMediaOccIdToMedia.get(t)[i].getDataService().setValue("published",e.published)}this._onMediaSavedCB&&(this.getView()&&this._onMediaSavedCB(),this._onMediaSavedCB=null)},onMediaSaved:function(e){this._onMediaSavedCB=e}});return e.namespace("DS/CAT3DWMedia/CAT3DWMedia",s)});