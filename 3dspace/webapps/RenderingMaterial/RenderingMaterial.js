define("DS/RenderingMaterial/CachedRequest",[],function(){const e=-2,t=-1,a=0,n=1;return class{constructor(e,t){this._physicalID=e,this._callbacks=[],this._processCallbacksOnFail=!t,this._status=a,this._result={data:null,type:null}}requiresRetry(){return this._status===t}processCallback(r){switch(this._status){case a:this._callbacks.push(r);break;case n:r(this._result.data,this._result.type);break;case e:this._processCallbacksOnFail&&r(null,null);break;case t:break;default:throw new Error(`Unexpected state (${this._status}) for : ${this._physicalID}`)}}onTimeout(){this._status=t}onFailure(){this._status=e,this._result.data=null,this._result.type=null,this._processCallbacksOnFail&&this._processQueuedCallbacks()}onSuccess(e,t){this._status=n,this._result.data=e,this._result.type=t,this._processQueuedCallbacks()}_processQueuedCallbacks(){for(;0!==this._callbacks.length;)this._callbacks.pop()(this._result.data,this._result.type)}}}),define("DS/RenderingMaterial/PLMMaterialFactoryLegacy",["DS/Visualization/MaterialConnection","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/MaterialApplication","DS/Visualization/InternalSceneGraph","DS/Visualization/PLMMaterialConnectionFactory","DS/Visualization/PLMMaterialServicesItf","DS/Visualization/SceneGraphUtils","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/WAFData/WAFData","DS/RenderingMaterialLib/MaterialMappingServices"],function(e,t,a,n,r,o,i,s,l,c,u,p,m){"use strict";const d={FAILED:-2,RETRY:-1,PENDING:0,SUCCEEDED:1};class f{constructor(e,t){this._physicalID=e,this._callbacks=[],this._processCallbacksOnFail=!t,this._status=d.PENDING,this._result={data:null,type:null}}requiresRetry(){return this._status===d.RETRY}processCallback(e){switch(this._status){case d.PENDING:this._callbacks.push(e);break;case d.SUCCEEDED:e(this._result.data,this._result.type);break;case d.FAILED:this._processCallbacksOnFail&&e(null,null);break;case d.RETRY:break;default:console.error("[PLMMaterialFactory][cache] unexpected state (",this._status,") for : ",this._physicalID)}}onTimeout(){this._status=d.RETRY}onFailure(){this._status=d.FAILED,this._result.data=null,this._result.type=null,this._processCallbacksOnFail&&this._processQueuedCallbacks()}onSuccess(e,t){this._status=d.SUCCEEDED,this._result.data=e,this._result.type=t,this._processQueuedCallbacks()}_processQueuedCallbacks(){for(;0!==this._callbacks.length;){this._callbacks.pop()(this._result.data,this._result.type)}}}var g=new Map,h=new Map,_=new Map,v=new Map;i.setParams({loadAppearanceCB:function e(t,a,n){var r=v.get(t.appearanceId);null!=r&&null!=r._material?a(t,r):setTimeout(e.bind(null,t,a,n),100)}});var y=new Map,b=new Array,M=new Map,x=0;const F=["exr","tif","tiff"];var w=new u,I=1,C=function(e){if(e)return{matrix:[e["ds6wg:catmatconnection.v_matrix_1"],e["ds6wg:catmatconnection.v_matrix_2"],e["ds6wg:catmatconnection.v_matrix_3"],0,e["ds6wg:catmatconnection.v_matrix_4"],e["ds6wg:catmatconnection.v_matrix_5"],e["ds6wg:catmatconnection.v_matrix_6"],0,e["ds6wg:catmatconnection.v_matrix_7"],e["ds6wg:catmatconnection.v_matrix_8"],e["ds6wg:catmatconnection.v_matrix_9"],0,e["ds6wg:catmatconnection.v_matrix_10"],e["ds6wg:catmatconnection.v_matrix_11"],e["ds6wg:catmatconnection.v_matrix_12"],1],mapType:e["bo.catmatconnection.v_mappingtype"],scale:e["bo.catmatconnection.v_scaleratio"],mapFocus:e["bo.catmatconnection.v_focusmode"],offset:[e["bo.catmatconnection.v_offsetu"],e["bo.catmatconnection.v_offsetv"]],repeat:[e["bo.catmatconnection.v_repeatu"],e["bo.catmatconnection.v_repeatv"]],angle:e["bo.catmatconnection.v_angle2d"],layer:e["bo.catmatconnection.v_layer"],isKindOf:e["ds6w:type"],matpen:e["matPen.jsonstreamstorage"]}},S=function(e,t,a){this.messageFromIndex=e,this.getNodeFromID=t,this.getSecurityParams=a};return S.prototype.onRemovedRoot=function(e){for(const t of v.keys())t.includes(e)&&(v.delete(t),i.removeMaterialConnection(t))},S.prototype.setParams=function(e){null==e.rootId&&(e.rootId=0);var t=1;null!=e.jsonVersion&&(t=e.jsonVersion),2==t?(I=2,function(e,t){var a=e.materials;if(null!=a)for(var n in Object.keys(a))null!=(o=a[n].resourceid)&&((l=null!=g[o])||(g[o]=a[n]["bo.dsc_matref_rep_rendering.visappearance"]));var r=e.connections;if(null!=r)for(var n in Object.keys(r)){var o;null!=(o=r[n].resourceid)&&((l=null!=h[o])||(h[o]=C(r[n])))}var i=e.materials_overload;if(null!=i)for(var n in Object.keys(i)){var s={path:i[n].path,material:i[n].material,connection:i[n].connection},l=!1;if(null!=_[t])for(var c in _[t])if(s.path.length===_[t][c].path.length&&s.material===_[t][c].material&&s.connection===_[t][c].connection){var u=!0;for(var p in s.path)if(s.path[p]!==_[t][c].path[p]){u=!1;break}u&&(l=!0)}l||(null==_[t]&&(_[t]=new Array),_[t].push(s))}}(e.messageFromIndex,e.rootId)):(this.messageFromIndex=e.messageFromIndex||null,function(e,t){if(e){var a=e.materials;if(a){var n=Object.keys(a);for(var r in n)(s=Object.keys(a[n[r]])[0])&&((c=null!=g[s])||(g[s]=a[r][s]))}for(var r in n=Object.keys(e))if("materials"!=n[r]){var o=e[n[r]];for(var i in o){var s,l={path:n[r].split(","),material:o[i].material,connection:o[i].connection};if(l){var c=!1;if(null!=_[t])for(var u in _[t])if(l.path.length===_[t][u].path.length&&l.material===_[t][u].material&&l.connection===_[t][u].connection){var p=!0;for(var m in l.path)if(l.path[m]!==_[t][u].path[m]){p=!1;break}p&&(c=!0)}c||(null==_[t]&&(_[t]=new Array),_[t].push(l))}l.connection&&(s=l.connection)&&((c=null!=h[s])||(h[s]=o[i]))}}}}(this.messageFromIndex,e.rootId)),this.getNodeFromID=e.getNodeFromID||null,this.retrieveIRPathFromIIPath=e.retrieveIRPathFromIIPath||null,this.getSecurityParams=e.getSecurityParamsCB||null,i.setParams({getNodeFromIdCB:this.getNodeFromID})},S.prototype.computeMaterials=function(e){const t="true"!==localStorage.getItem("RmaDisableTextureCache"),n="true"===localStorage.getItem("RmaDisableTextureFallback");var o=function(e,a){let r=function(){if(--x,b.length){let e=b.pop();s(e.physicalID,e.doneCB)}};if("0"===e)return console.warn("[PLMMaterialFactory] physicalID === 0, this means it is probably an old material where substance does not work. You can try to update the VisAppearanceAttribut"),a(null,null),void r();var o,i=null;if(t){let t=!0;if(y.has(e)?t=(i=y.get(e)).requiresRetry():(i=new f(e,n),y.set(e,i)),i.processCallback(a),!t)return void r()}this.getSecurityParams&&(o=this.getSecurityParams());var l="Substance_".length;if(e.includes("Substance_")){var c=e.indexOf("_",l),u=e.substring(l,c),m=e.substr(c+1);p.authenticatedRequest(o.service3DSpaceUrl+"/resources/fcsservices/fcs/mediaURL?boid="+u+"&format=1&filename="+u+"_%27EXTENDED%27.1="+m,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(n,o){console.info("[PLMMaterialFactory] Load Substance texture : "+e+" | Size: "+n.byteLength),M.delete(e),t?i.onSuccess(n,"png"):a(n,"png"),r()}.bind(this),onFailure:function(a,n,o){console.warn("[PLMMaterialFactory] Failed to get Substance texture : "+e),M.delete(e),t&&i.onFailure(),r()}.bind(this),onTimeout:function(){M.has(e)||M.set(e,0);let n=M.get(e);n<3?(M.set(e,n+1),console.warn("[PLMMaterialFactory] Timeout when trying to load Substance texture : "+e+" => Trying again. ("+n+")"),t&&i.onTimeout(),s(e,a)):(console.warn("[PLMMaterialFactory] Timeout when trying to load Substance texture : "+e+" => Max number of timeout reached. ("+M.get(e)+")"),M.delete(e),t&&(i.onFailure(),r()))}.bind(this)})}else p.authenticatedRequest(o.service3DSpaceUrl+"/cvservlet/fetch/v2?tenant="+o.tenant,{method:"POST",proxy:"passport",type:"json",responseType:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},data:JSON.stringify({label:o.userLogin+"fetch-"+e,physicalid:[e],locale:"en",tenant:o.tenant,select_predicate:["ds6wg:plmdmtdocument.v_primarymimetype","plmtdoc.stream.name"]}),onComplete:function(n,l){var c="png";if(n&&n.results&&n.results[0].attributes)for(var u=0;u<n.results[0].attributes.length;++u)"ds6wg:plmdmtdocument.v_primarymimetype"==n.results[0].attributes[u].name&&(c=n.results[0].attributes[u].value);if(F.includes(c))return console.warn("[PLMMaterialFactory] Unsupported texture type : "+c),t&&i.onFailure(),void r();p.authenticatedRequest(o.service3DSpaceUrl+"/resources/fcsservices/fcs/mediaURL?boid="+e+"&format=1&filename="+e+"_%27%27.1",{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(n,o){console.info("[PLMMaterialFactory] Load texture : "+e+" | Size: "+n.byteLength),M.delete(e),t?i.onSuccess(n,c):a(n,c),r()}.bind(this),onFailure:function(a,n,o){console.warn("[PLMMaterialFactory] Failed to get texture : "+e),M.delete(e),t&&i.onFailure(),r()}.bind(this),onTimeout:function(){M.has(e)||M.set(e,0);let n=M.get(e);n<3?(M.set(e,n+1),console.warn("[PLMMaterialFactory] Timeout when trying to load texture : "+e+" => Trying again. ("+n+")"),t&&i.onTimeout(),s(e,a)):(console.warn("[PLMMaterialFactory] Timeout when trying to load texture : "+e+" => Max number of timeout reached. ("+M.set(e)+")"),M.delete(e),t&&(i.onFailure(),r()))}.bind(this)})}.bind(this),onFailure:function(e,a,n){console.warn("[PLMMaterialFactory] Failed to load CATIPLMDmtDocument stream."),t&&i.onFailure(),r()},onTimeout:function(){console.warn("[PLMMaterialFactory] Timeout when trying to load CATIPLMDmtDocument stream."),t&&(i.onFailure(),r())}})}.bind(this),s=function(e,t){x>100?(b.unshift({physicalID:e,doneCB:t}),console.info("[PLMMaterialFactory] Maximum number of requests reached, queue in request pool: ",e)):(++x,o(e,t))}.bind(this),l=0;null!=e&&(l=e.rootId),null==l&&(l=0);for(var u=_[l].length,d=0;d<_[l].length;++d){var C=null,S=null,P=null;if(g[_[l][d].material]&&(1==I&&g[_[l][d].material].domains&&(g[_[l][d].material].domains[0]&&g[_[l][d].material].domains[0].default_key&&g[_[l][d].material].domains[0].default_key.visappearance&&(C=g[_[l][d].material].domains[0].default_key.visappearance),S=g[_[l][d].material].isKindOf),2==I&&(C=g[_[l][d].material],S=h[_[l][d].connection].isKindOf,P=h[_[l][d].connection].matpen)),C){C=JSON.parse(C);var D,T,L=_[l][d].path,A=_[l][d].connection,k=h[A],R=C.jsonVersion?C.jsonVersion:1,E=null!=C.mappingSemantics?C.mappingSemantics:m.CATMappingSemantic.LegacyMapping;if(null!=C.decoupledMapping&&(E=m.CATMappingSemantic.DecoupledMapping),C.dxm){if(D=C.referenceMapping,T=R>=3?C.texturesInfo:C.texturesSize,C.IsSubstance)continue;C=C.dxm}else D=null,T=null;null!=C.binaries&&(C.binaries.flag="3DPlay",C.binaries.forEach(function(e,t){null!=e.uri&&(delete e.uri,null!=e.byteLength&&delete e.byteLength,null==e.extUri&&(e.extUri="0"))}),null==D&&console.warn("[PLMMaterialFactory] We have textures but missing reference mapping values. VisAppearanceAttribut generation problem?"),null==T&&console.warn("[PLMMaterialFactory] We have textures but missing texture infos. VisAppearanceAttribut generation problem?"));var V=-1;if(D&&T&&C.textures){V=D.type,k.mapType&&(k.mapType=parseInt(k.mapType,10),0!=k.mapType&&(V=k.mapType-1));var j=C.textures;j&&j.forEach(function(e,t){var a={};if(k.repeat&&(k.repeat[0]=parseFloat(k.repeat[0]),k.repeat[1]=parseFloat(k.repeat[1]),0!=k.repeat[0]&&(a.repeat_u=1==Math.abs(k.repeat[0])),0!=k.repeat[1]&&(a.repeat_v=1==Math.abs(k.repeat[1])),0!=k.repeat[0]&&(a.flip_u=k.repeat[0]<0),0!=k.repeat[1]&&(a.flip_v=k.repeat[1]<0)),k.offset&&(k.offset[0]=parseFloat(k.offset[0]),k.offset[1]=parseFloat(k.offset[1]),0!=k.offset[0]&&(a.offset_u=1e3*k.offset[0]),0!=k.offset[1]&&(a.offset_v=1e3*k.offset[1])),k.scale&&(k.scale=parseFloat(k.scale),0!=k.scale)){a.scale_u=k.scale%1e6;var n=Math.floor(k.scale/1e6);a.scale_v=n>0?n/1e3:1}k.angle&&(k.angle=parseFloat(k.angle),0!=k.angle&&(a.angle=k.angle)),k.matrix&&(a.object_transform=k.matrix.map(function(e){return parseFloat(e)})),k.mapType&&(k.mapType=parseInt(k.mapType,10),0!=k.mapType&&(a.type=k.mapType-1)),k.mapFocus&&(k.mapFocus=parseInt(k.mapFocus,10),0!=k.mapFocus&&(a.mapFocus=k.mapFocus-1));var r={};r.repeat_u=D.repeat_u,r.repeat_v=D.repeat_v,r.offset_u=D.offset_u,r.offset_v=D.offset_v,r.angle=D.angle,r.flip_u=D.flip_u,r.flip_v=D.flip_v,r.scale_u=D.scale_u,r.scale_v=D.scale_u/D.scale_v,r.type=D.type,r.mapFocus=D.behavior;var o=null;R>=3&&T[t].mapping&&((o=T[t].mapping).scale_v=o.scale_u/o.scale_v);var i=null;i=E==m.CATMappingSemantic.DecoupledMapping?m.computeDecoupledMapping(r,a,o,T[t]):m.computeMapping(r,a,o,T[t]),e.uWrap=i.repeat_u,e.vWrap=i.repeat_v,e.mapping.slot&&(e.mapping.slot=null),e.mapping.uvTransform=i.uv_transform,e.mapping.operator={type:i.type,transform:i.object_transform}}.bind(this))}if(null!=C){var O=new c,N=new a,U=function(e,t,a,n,r){var o=null,s=null,l=null,c=null;if(r){var u=JSON.parse(r);(o=u.proxy)[0]&&(s=o[0].value),o[1]&&(l=o[1].value,u.version<=2&&0!=l||u.version>2?o[2]&&(c=o[2].value):l=null)}var p=this.retrieveIRPathFromIIPath(e);i.addMaterialConnection(e[0],{idPath:p,appearanceId:t,type:a,vLayer:parseInt(n,10),internalPath:s,cgmIdRep:l,cgmIdPrimitive:c?c[0]:null,cgmIdPrimitives:c,legacyUV:6==V})}.bind(this),$=function(){--u<=0&&(console.info("[PLMMaterialFactory] Cleanup texture cache"),y.clear())}.bind(this);if(L){var z=new r({faceMaterial:null}),q="APP#"+l+d;U(L,q,S.toLowerCase().includes("covering")?i.COVERAGE_MATERIAL:i.CORE_MATERIAL,k.layer,P),v.set(q,z),e&&null!=e._load3dxmBegin&&e._load3dxmBegin(A,C),O.loadMaterial({destinationNode:N,json:C,resourcesLibrary:w,binaryCallback:function(t,a){return e&&null!=e._load3dxmBinCallback&&e._load3dxmBinCallback(t),s(t,a)},doneCallback:function(t,a){var n=a.material;null!=n&&null!=t&&(t.setParameters({faceMaterial:n,enableDepth:!0}),e&&null!=e._load3dxmDoneCallback&&e._load3dxmDoneCallback(A,t)),$()}.bind(this,z),errorCallback:function(){e&&null!=e._load3dxmErrorCallback&&e._load3dxmErrorCallback(A),$()}.bind(this)})}}}}},new S}),define("DS/RenderingMaterial/MaterialRequestBuilder",[],function(){"use strict";return{getAggregatedProcessor:function(){return JSON.parse('{"materials":{ "uql" : "bo_46_plmentity_46_plm_95_externalid:\\"Applied%20Material\\""}}')},getMaterialAttributes:function(){return["ds6w:type","ds6wg:catmatconnection.v_matrix_1","ds6wg:catmatconnection.v_matrix_2","ds6wg:catmatconnection.v_matrix_3","ds6wg:catmatconnection.v_matrix_4","ds6wg:catmatconnection.v_matrix_5","ds6wg:catmatconnection.v_matrix_6","ds6wg:catmatconnection.v_matrix_7","ds6wg:catmatconnection.v_matrix_8","ds6wg:catmatconnection.v_matrix_9","ds6wg:catmatconnection.v_matrix_10","ds6wg:catmatconnection.v_matrix_11","ds6wg:catmatconnection.v_matrix_12","bo.catmatconnection.v_mappingtype","bo.catmatconnection.v_scaleratio","bo.catmatconnection.v_focusmode","bo.catmatconnection.v_offsetu","bo.catmatconnection.v_offsetv","bo.catmatconnection.v_repeatu","bo.catmatconnection.v_repeatv","bo.catmatconnection.v_angle2d","bo.catmatconnection.v_layer","bo.dsc_matref_rep_rendering.visappearance","matPen.jsonstreamstorage"]}}}),define("DS/RenderingMaterial/PLMMaterialFactory",["DS/Visualization/MaterialConnection","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/MaterialApplication","DS/Visualization/InternalSceneGraph","DS/Visualization/PLMMaterialConnectionFactory","DS/Visualization/PLMMaterialServicesItf","DS/Visualization/SceneGraphUtils","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/WAFData/WAFData","DS/RenderingMaterialLib/MaterialMappingCoreServices","DS/RenderingMaterialLib/VisuConversionHelpers","DS/RenderingMaterial/CachedRequest"],function(e,t,a,n,r,o,i,s,l,c,u,p,m,d,f){"use strict";const g=["PLANAR","SPHERICAL","FINITE_CYLINDRICAL","CUBIC","None","None","None","None","INFINITE_CYLINDRICAL"],h=["CLAMP_TO_EDGE","REPEAT"],_="true"===localStorage.getItem("RmaEnableLog");var v=new Map,y=new Map,b=new Map,M=new Map;i.setParams({loadAppearanceCB:async(e,t,a)=>{try{const n=M.get(e.appearanceId);t(e,await n)}catch(t){_&&console.error(`[AC][PLMMaterialFactory] Await load 3DXML: ${t.message}`),a(e)}}});var x=new Map,F=new Array,w=new Map,I=0;const C=["exr","tif","tiff"];var S=new u,P=1,D=function(e){if(!e)return null;return{matrix:[e["ds6wg:catmatconnection.v_matrix_1"],e["ds6wg:catmatconnection.v_matrix_2"],e["ds6wg:catmatconnection.v_matrix_3"],0,e["ds6wg:catmatconnection.v_matrix_4"],e["ds6wg:catmatconnection.v_matrix_5"],e["ds6wg:catmatconnection.v_matrix_6"],0,e["ds6wg:catmatconnection.v_matrix_7"],e["ds6wg:catmatconnection.v_matrix_8"],e["ds6wg:catmatconnection.v_matrix_9"],0,e["ds6wg:catmatconnection.v_matrix_10"],e["ds6wg:catmatconnection.v_matrix_11"],e["ds6wg:catmatconnection.v_matrix_12"],1],mapType:e["bo.catmatconnection.v_mappingtype"],scale:e["bo.catmatconnection.v_scaleratio"],mapFocus:e["bo.catmatconnection.v_focusmode"],offset:[e["bo.catmatconnection.v_offsetu"],e["bo.catmatconnection.v_offsetv"]],repeat:[e["bo.catmatconnection.v_repeatu"],e["bo.catmatconnection.v_repeatv"]],angle:e["bo.catmatconnection.v_angle2d"],layer:e["bo.catmatconnection.v_layer"],isKindOf:e["ds6w:type"],matpen:e["matPen.jsonstreamstorage"]}},T=function(e,t){return{reference:function(e){let t={};return t.repeat_u=e.referenceMapping.repeat_u,t.repeat_v=e.referenceMapping.repeat_v,t.offset_u=e.referenceMapping.offset_u,t.offset_v=e.referenceMapping.offset_v,t.angle=e.referenceMapping.angle,t.flip_u=e.referenceMapping.flip_u,t.flip_v=e.referenceMapping.flip_v,t.scale_u=e.referenceMapping.scale_u,t.scale_v=e.referenceMapping.scale_v,t.type=e.referenceMapping.type,t.mapFocus=e.referenceMapping.behavior,t}(t),connection:function(e){var t={};if(e.repeat&&(e.repeat[0]=parseFloat(e.repeat[0]),e.repeat[1]=parseFloat(e.repeat[1]),0!=e.repeat[0]&&(t.repeat_u=1==Math.abs(e.repeat[0])),0!=e.repeat[1]&&(t.repeat_v=1==Math.abs(e.repeat[1])),0!=e.repeat[0]&&(t.flip_u=e.repeat[0]<0),0!=e.repeat[1]&&(t.flip_v=e.repeat[1]<0)),e.offset&&(e.offset[0]=parseFloat(e.offset[0]),e.offset[1]=parseFloat(e.offset[1]),0!=e.offset[0]&&(t.offset_u=1e3*e.offset[0]),0!=e.offset[1]&&(t.offset_v=1e3*e.offset[1])),e.scale&&(e.scale=parseFloat(e.scale),0!=e.scale)){const a=1e6,n=1e3;t.scale_u=e.scale%a;const r=Math.floor(e.scale/a),o=r>0?r/n:1;t.scale_v=t.scale_u/o}return e.angle&&(e.angle=parseFloat(e.angle),0!=e.angle&&(t.angle=e.angle)),e.matrix&&(t.object_transform=e.matrix.map(function(e){return parseFloat(e)})),e.mapType&&(e.mapType=parseInt(e.mapType),0!=e.mapType&&(t.type=e.mapType-1)),e.mapFocus&&(e.mapFocus=parseInt(e.mapFocus),0!=e.mapFocus&&(t.mapFocus=e.mapFocus-1)),t}(e),channels:t.texturesInfo,mappingSemantic:t.mappingSemantic}},L=function(e){null!=e&&null!=e.dxm&&(null==e.jsonVersion&&(e.jsonVersion=1,e.IsSubstance&&(e.dxm=null)),e.jsonVersion<=2&&(e.texturesSize&&(e.texturesInfo=e.texturesSize,delete e.texturesSize),e.dxm&&e.dxm.textures?e.texturesInfo.length=e.dxm.textures.length:Array.isArray(e.texturesInfo)&&delete e.texturesInfo),null!=e.mappingSemantics?(e.mappingSemantic=e.mappingSemantics,delete e.mappingSemantics):null!=e.decoupledMapping&&(e.mappingSemantic=m.CATMappingSemantic.DecoupledMapping,delete e.decoupledMapping),null==e.mappingSemantic&&(e.mappingSemantic=m.CATMappingSemantic.LegacyMapping),A(e.dxm))},A=function(e){null!=e&&null!=e.binaries&&(e.binaries.flag="3DPlay",e.binaries.forEach(function(e,t){null!=e.uri&&(delete e.uri,null!=e.byteLength&&delete e.byteLength,null==e.extUri&&(e.extUri="0"))}))},k=function(e,a){const n=a.connection,r=a.reference,o=a.channels,i=a.mappingSemantic;if(!r||!o||!e.textures)return;!_||e.header&&"3.2"==e.header.version||console.warn("[AC][PLMMaterialFactory] Unsupported 3DXM version in VisAppearanceAttribute.");const s=m.computeApplicationMapping(r,n,i);e.textures.forEach(function(e,a){let l=null;null!=o[a]&&null!=o[a].mapping&&(l=o[a].mapping);const c=m.computeChannelMapping(r,n,l,o[a],i),u=m.combineMappingResults(s,c,i);e.uWrap=h[u.repeat_u?1:0],e.vWrap=h[u.repeat_v?1:0];const p=u.uv_transform.elements;null==e.mapping&&(e.mapping={}),e.mapping.slot=null,e.mapping.uvTransform=new Array(16),new t.Matrix4(p[0],p[3],0,p[6],p[1],p[4],0,p[7],0,0,1,0,0,0,0,1).flattenToArray(e.mapping.uvTransform),e.mapping.operator={},e.mapping.operator.type=g[u.type],u.object_transform&&(e.mapping.operator.transform=new Array(16),u.object_transform.flattenToArray(e.mapping.operator.transform)),delete e.uvTransform}.bind(this))},R=function(e,t){if(!Array.isArray(e.textures))return;const a=t.connection,n=t.reference,r=t.channels;for(let t=0;t<e.textures.length;t++){const o=null!=r[t].mapping?r[t].mapping:{};let i=!0;null!=a.repeat_u?i=a.repeat_u:null!=o.repeat_u?i=o.repeat_u:null!=n.repeat_u&&(i=n.repeat_u);let s=!0;null!=a.repeat_v?s=a.repeat_v:null!=o.repeat_v?s=o.repeat_v:null!=n.repeat_v&&(s=n.repeat_v);const l=e.textures[t];l.uWrap=h[i?1:0],l.vWrap=h[s?1:0]}},E=function(e){if(null==e.channels)return null;const a=m.computeApplicationMapping(e.reference,e.connection,e.mappingSemantic);let n={},r={};r.mappingType=d.GetVisMappingType(a.type),a.object_transform&&(r.mappingObjTransformation=a.object_transform),r.mappingUVTransformation=new t.Matrix3;for(let t of e.channels){const r=m.computeChannelMapping(e.reference,e.connection,t.mapping,t,e.mappingSemantic),o=m.combineMappingResults(a,r,e.mappingSemantic),i=d.GetVisParamDesc(t.id);i&&i.hasUvTransform()?n[i.uvTransformId]=o.uv_transform:_&&console.warn("[AC][PLMMaterialFactory] Invalid ID for texture")}return{matRefParams:n,matAppParams:r}},V=function(e){let t=e.dxm;if(!t||!t.textures||!e.texturesInfo)return!1;const a=t.materials[0];if(!a.type.startsWith("DSPBR"))return!1;if(e.jsonVersion>=4)return!0;let n=e.dxm.textures.length;const r=Object.keys(a);for(let o of r){const r=a[o];if("object"==typeof r&&"texture"in r){const a=r.texture,i=t.textures[a].image,s=t.images[i].binary;if(e.texturesInfo[s].id||(e.texturesInfo[s].id=o),0==--n)break}}return 0===n},j=function(e,t,a){this.messageFromIndex=e,this.getNodeFromID=t,this.getSecurityParams=a};return j.prototype.flushCache=function(){v=new Map,y=new Map,b=new Map,M.clear(),w.clear(),x.clear(),F.length=0},j.prototype.onRemovedRoot=function(e){for(const t of M.keys())t.includes(e)&&(M.delete(t),i.removeMaterialConnection(t))},j.prototype.setParams=function(e){null==e.rootId&&(e.rootId=0);var t=1;null!=e.jsonVersion&&(t=e.jsonVersion),2==t?(P=2,function(e,t){var a=e.materials;if(null!=a)for(var n in Object.keys(a))null!=(o=a[n].resourceid)&&((l=null!=v[o])||(v[o]=a[n]["bo.dsc_matref_rep_rendering.visappearance"]));var r=e.connections;if(null!=r)for(var n in Object.keys(r)){var o;null!=(o=r[n].resourceid)&&((l=null!=y[o])||(y[o]=D(r[n])))}var i=e.materials_overload;if(null!=i)for(var n in Object.keys(i)){var s={path:i[n].path,material:i[n].material,connection:i[n].connection},l=!1;if(null!=b[t])for(var c in b[t])if(s.path.length===b[t][c].path.length&&s.material===b[t][c].material&&s.connection===b[t][c].connection){var u=!0;for(var p in s.path)if(s.path[p]!==b[t][c].path[p]){u=!1;break}u&&(l=!0)}l||(null==b[t]&&(b[t]=new Array),b[t].push(s))}}(e.messageFromIndex,e.rootId)):(this.messageFromIndex=e.messageFromIndex||null,function(e,t){if(e){var a=e.materials;if(a){var n=Object.keys(a);for(var r in n)(s=Object.keys(a[n[r]])[0])&&((c=null!=v[s])||(v[s]=a[r][s]))}for(var r in n=Object.keys(e))if("materials"!=n[r]){var o=e[n[r]];for(var i in o){var s,l={path:n[r].split(","),material:o[i].material,connection:o[i].connection};if(l){var c=!1;if(null!=b[t])for(var u in b[t])if(l.path.length===b[t][u].path.length&&l.material===b[t][u].material&&l.connection===b[t][u].connection){var p=!0;for(var m in l.path)if(l.path[m]!==b[t][u].path[m]){p=!1;break}p&&(c=!0)}c||(null==b[t]&&(b[t]=new Array),b[t].push(l))}l.connection&&(s=l.connection)&&((c=null!=y[s])||(y[s]=o[i]))}}}}(this.messageFromIndex,e.rootId)),this.getNodeFromID=e.getNodeFromID||null,this.retrieveIRPathFromIIPath=e.retrieveIRPathFromIIPath||null,this.getSecurityParams=e.getSecurityParamsCB||null,i.setParams({getNodeFromIdCB:this.getNodeFromID})},j.prototype.computeMaterials=function(e){const t="true"!==localStorage.getItem("RmaDisableTextureCache"),n="true"===localStorage.getItem("RmaEnableLegacyMappingComputation"),o="true"===localStorage.getItem("RmaDisableTextureFallback");var s=function(e,a){let n=function(){if(--I,F.length){let e=F.pop();l(e.physicalID,e.doneCB)}};if("0"===e)return _&&console.debug("[AC][PLMMaterialFactory] physicalID === 0, this means it is probably an old material where substance does not work. You can try to update the VisAppearanceAttribut"),a(null,null),void n();var r,i=null;if(t){let t=!0;x.has(e)?t=(i=x.get(e)).requiresRetry():(i=new f(e,o),x.set(e,i));try{i.processCallback(a)}catch(e){_&&console.error(`[AC][PLMMaterialFactory] Cached request failed with: ${e.message}`)}if(!t)return void n()}this.getSecurityParams&&(r=this.getSecurityParams());var s="Substance_".length;if(e.includes("Substance_")){var c=e.indexOf("_",s),u=e.substring(s,c),m=e.substr(c+1);p.authenticatedRequest(`${r.service3DSpaceUrl}/resources/fcsservices/fcs/mediaURL?boid=${u}&format=1&filename=${u}_%27EXTENDED%27.1=${m}`,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(r,o){_&&console.debug(`[AC][PLMMaterialFactory] Load Substance texture : ${e} | Size: ${r.byteLength}`),w.delete(e),t?i.onSuccess(r,"png"):a(r,"png"),n()}.bind(this),onFailure:function(a,r,o){_?console.warn("[AC][PLMMaterialFactory] Failed to get Substance texture : "+e):console.warn("[Rendering Material] Failed to get Substance texture"),w.delete(e),t&&i.onFailure(),n()}.bind(this),onTimeout:function(){w.has(e)||w.set(e,0);let r=w.get(e);r<3?(w.set(e,r+1),_&&console.warn("[AC][PLMMaterialFactory] Timeout when trying to load Substance texture: "+`${e} => Trying again. (${r})`),t&&i.onTimeout(),l(e,a)):(_?console.warn("[AC][PLMMaterialFactory] Timeout when trying to load Substance texture : "+`${e} => Max number of timeout reached. (${w.get(e)})`):console.warn("[Rendering Material] Timeout while loading texture."),w.delete(e),t&&(i.onFailure(),n()))}.bind(this)})}else p.authenticatedRequest(r.service3DSpaceUrl+"/cvservlet/fetch/v2?tenant="+r.tenant,{method:"POST",proxy:"passport",type:"json",responseType:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},data:JSON.stringify({label:r.userLogin+"fetch-"+e,physicalid:[e],locale:"en",tenant:r.tenant,select_predicate:["ds6wg:plmdmtdocument.v_primarymimetype","plmtdoc.stream.name"]}),onComplete:function(o,s){var c="png";if(o&&o.results&&o.results[0].attributes)for(var u=0;u<o.results[0].attributes.length;++u)"ds6wg:plmdmtdocument.v_primarymimetype"==o.results[0].attributes[u].name&&(c=o.results[0].attributes[u].value);if(C.includes(c))return console.warn("[Rendering Material] Unsupported texture type : "+c),t&&i.onFailure(),void n();p.authenticatedRequest(`${r.service3DSpaceUrl}/resources/fcsservices/fcs/mediaURL?boid=${e}&format=1&filename=${e}_%27%27.1`,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(r,o){_&&console.debug(`[AC][PLMMaterialFactory] Load texture: ${e} | Size: ${r.byteLength}`),w.delete(e),t?i.onSuccess(r,c):a(r,c),n()}.bind(this),onFailure:function(a,r,o){_?console.warn("[AC][PLMMaterialFactory] Failed to get texture : "+e):console.warn("[Rendering Material] Failed to load texture."),w.delete(e),t&&i.onFailure(),n()}.bind(this),onTimeout:function(){w.has(e)||w.set(e,0);let r=w.get(e);r<3?(w.set(e,r+1),_&&console.warn("[AC][PLMMaterialFactory] Timeout when trying to load texture :"`${e} => Trying again. (${r})`),t&&i.onTimeout(),l(e,a)):(_?console.warn("[AC][PLMMaterialFactory] Timeout when trying to load texture: "+`${e} => Max number of timeout reached. (${w.set(e)})`):console.warn("[Rendering Material] Timeout while loading texture."),w.delete(e),t&&(i.onFailure(),n()))}.bind(this)})}.bind(this),onFailure:function(e,a,r){_?console.warn("[AC][PLMMaterialFactory] Failed to load CATIPLMDmtDocument stream."):console.warn("[Rendering Material] Failed to load texture."),t&&i.onFailure(),n()},onTimeout:function(){_?console.warn("[AC][PLMMaterialFactory] Timeout when trying to load CATIPLMDmtDocument stream."):console.warn("[Rendering Material] Timeout while loading texture."),t&&(i.onFailure(),n())}})}.bind(this),l=function(e,t){I>100?(F.unshift({physicalID:e,doneCB:t}),_&&console.debug("[AC][PLMMaterialFactory] Maximum number of requests reached, queue in request pool: ",e)):(++I,s(e,t))}.bind(this),u=0;null!=e&&(u=e.rootId),null==u&&(u=0);const d=b[u];for(var g=d.length,h=0;h<d.length;++h){const t=d[h];let o=null,s=null,p=null;const f=t.material,b=t.connection;if(v[f])if(1==P){if(v[f].domains&&v[f].domains[0]){const e=v[f].domains[0];e.default_key&&e.default_key.visappearance&&(o=e.default_key.visappearance),s=v[f].isKindOf}}else 2==P&&(o=v[f],s=y[b].isKindOf,p=y[b].matpen);if(!o){e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(b);continue}if(o=JSON.parse(o),L(o),null==o||null==o.dxm){console.error("[Rendering Material] Invalid material information."),e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(b);continue}let F=t.path;if(!F){e&&null!=e._onIndexErrorCallback&&e._onIndexErrorCallback(b);continue}const w=y[b],I=T(w,o),C=o.dxm;null!=C.binaries&&(null==I.reference&&_&&console.warn("[AC][PLMMaterialFactory] We have textures but missing reference mapping values. VisAppearanceAttribut generation problem?"),null==I.channels&&_&&console.warn("[AC][PLMMaterialFactory] We have textures but missing texture infos. VisAppearanceAttribut generation problem?"));let j=null!=I.reference.type?I.reference.type:-1;I.connection.type&&(j=I.connection.type);const O=V(o),N=n||!O;N?(_&&console.debug(`[AC][PLMMaterialFactory] Apply mapping by modifying 3DXM (legacy) for cnx: ${b}`),k(C,I)):R(C,I);var D=function(e,t,a,n,r){let o=null,s=null,l=null;if(r){const e=JSON.parse(r),t=e.proxy;t[0]&&(o=t[0].value),t[1]&&(s=t[1].value,e.version<=2&&0!=s||e.version>2?t[2]&&(l=t[2].value):s=null)}const c=this.retrieveIRPathFromIIPath(e);i.addMaterialConnection(e[0],{idPath:c,appearanceId:t,type:a,vLayer:n,internalPath:o,cgmIdRep:s,cgmIdPrimitive:l?l[0]:null,cgmIdPrimitives:l,legacyUV:j==m.CATMappingType.UV})}.bind(this),A=function(){--g<=0&&(_&&console.debug("[AC][PLMMaterialFactory] Cleanup texture cache"),x.clear())}.bind(this);const U=new r({faceMaterial:null}),$="APP#"+u+h;M.set($,new Promise((t,n)=>{e&&null!=e._load3dxmBegin&&e._load3dxmBegin(b,C);const r=new c,o=new a;r.loadMaterial({destinationNode:o,json:C,resourcesLibrary:S,binaryCallback:function(t,a){return e&&null!=e._load3dxmBinCallback&&e._load3dxmBinCallback(t),l(t,a)},doneCallback:function(a,r){A();const o=r.material;if(o&&a){if(!N){_&&console.debug(`[AC][PLMMaterialFactory] Apply mapping directly on material for cnx: ${b}`);const e=E(I);e&&(o.setPhysicalProperties(e.matRefParams),o.setMappingOperator(e.matAppParams.mappingType,e.matAppParams.mappingObjTransformation,e.matAppParams.mappingUVTransformation,!0))}a.setParameters({faceMaterial:o,enableDepth:!0}),e&&null!=e._load3dxmDoneCallback&&e._load3dxmDoneCallback(b,a,o),t(a)}else n(new Error(`Loaded material is null for cnx: ${b}`))}.bind(this,U),errorCallback:function(){A(),e&&null!=e._load3dxmErrorCallback&&e._load3dxmErrorCallback(b),n(new Error(`Failed to load material for cnx: ${b}`))}.bind(this)})})),D(F,$,s.toLowerCase().includes("covering")?i.COVERAGE_MATERIAL:i.CORE_MATERIAL,parseInt(w.layer),p)}},new j});