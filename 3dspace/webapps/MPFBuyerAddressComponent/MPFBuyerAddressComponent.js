define("DS/MPFBuyerAddressComponent/BuyerAddressPanelFooter",["UWA/Class/View","DS/UIKIT/Input/Button","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent"],function(e,s,t){"use strict";const r={ON_SAVE:"onSave",ON_CANCEL:"onCancel"},i=e.extend({className:"mpf-buyer-address-panel-footer mpf-footer",setup(e){this.readOnly=!0===e.readOnly,this.showCancelButton=!1!==e.showCancelButton,this.saveButton=this._createSaveButton(),this.cancelButton=this._createCancelButton()},render(){const e=[];return this.readOnly||(e.push(this.saveButton),this.showCancelButton&&e.push(this.cancelButton)),this.container.setContent(e),this},destroy(){this._parent(),this.container=null},setDisabled(e){e!==this.readOnly&&(this.readOnly=!1!==e,this.render())},_createSaveButton(){return new s({className:"primary",value:t.get("save"),events:{onClick:this.dispatchEvent.bind(this,r.ON_SAVE)}})},_createCancelButton(){return new s({value:t.get("cancel"),events:{onClick:this.dispatchEvent.bind(this,r.ON_CANCEL)}})}});return i.Events=Object.freeze(r),i}),define("DS/MPFBuyerAddressComponent/BuyerAddressCard",["UWA/Core","UWA/Class/View","DS/MPFAddressModel/AddressModel","css!DS/MPFUI/MPFUI"],function(e,s,t){"use strict";const r=Object.freeze({ON_SELECTED:"onSelected"}),i=s.extend({className:"mpf-address-card",domEvents:{click:"cardClicked"},setup:function(e){this._parent(e),this.buyer=e.buyer,this.showPhoneNumber=!0===e.showPhoneNumber,this.isSelectable=!1!==e.isSelectable,this.selected=!0===e.selected,this.model.get("addressLine0")||this.model.set("addressLine0",this._getAddressTitle()),this.isSelectable&&this.container.addClassName("mpf-selectable")},render:function(){const s=this.model;let r=[t.Fields.LINE1,t.Fields.LINE2,t.Fields.LINE3,t.Fields.LINE4,t.Fields.CITY,t.Fields.COUNTY,t.Fields.STATE,t.Fields.POSTAL_CODE,t.Fields.COUNTRY];return this.showPhoneNumber&&r.push(t.Fields.PHONE_NUMBER),(r=r.map(function(e){return s.get(e)}).filter(function(e){return e&&e.length>0}).map(function(s){return e.createElement("p",{class:"mpf-address-card-line",text:s})})).unshift(e.createElement("p",{class:"mpf-address-card-line title",text:this.model.get("addressLine0")})),this.container.setContent(r),this.selected?this.container.addClassName("selected"):this.container.removeClassName("selected"),this},destroy:function(){this.model=null,this._parent(),this.container=null},cardClicked:function(){this.isSelectable&&!this.selected&&(this.selected=!0,this.render(),this.dispatchEvent(r.ON_SELECTED,this.model))},setSelected:function(e){e!==this.selected&&(this.selected=e,this.render())},_getAddressTitle:function(){let e;return e=void 0!==this.buyer.defaults.registrationId?this.buyer.get("name"):this.buyer.get("firstName")+" "+this.buyer.get("lastName")}});return i.Events=r,i}),define("DS/MPFBuyerAddressComponent/BuyerAddressFormV2",["UWA/Class/View","UWA/Class/Promise","DS/MPFServices/ObjectService","DS/MPFAddressModel/AddressModel","DS/MPFPersonModel/PersonModel","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFBuyer/BuyerType","DS/MPFView/FieldTextInputV2","DS/MPFCompanyComponent/CompanyNameInput","DS/MPFCompanyComponent/CompanyRegistrationIdInput","DS/MPFCompanyComponent/CompanyTaxRegistrationIdInput","DS/MPFAddressFormComponent/AddressFormComponentV2","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent"],function(e,s,t,r,i,n,d,o,a,h,l,c,u,y,p){"use strict";const m=Object.freeze({BILLING:"billing",SHIPPING:"shipping"}),A=e.extend({className:"mpf-buyer-address-form-v2",setup:function(e){t.requiredOfPrototype(e.address,r,"options.address must be a AddressModel"),t.requiredOfPrototype(e.addressFactory,d,"options.addressFactory must be an AddressFactory"),t.requiredOfPrototype(e.companyFactory,o,"options.companyFactory must be a CompanyFactory"),t.requiredOfPrototype(e.countries,n,"options.countries must be a CountryCollection"),t.requiredOfPrototype(e.person,i,"options.person must be a PersonModel"),this.address=e.address,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.countries=e.countries,this.person=e.person,this.company=e.company,this.type=e.type||m.SHIPPING,this.buyerType=e.buyerType||(this.company?a.COMPANY:a.INDIVIDUAL),this.readOnly=!0===e.readOnly},render:function(){return this.stopListening(this.address),this._destroyBuyerInputs(),this._destroyAddressForm(),this.buyerInputs=this._createBuyerInputs(),this.addressForm=this._createAddressForm(),this.container.setContent([this.buyerInputs.map(function(e){return e.render()}),this.addressForm.inputs.map(function(e){return e.render()})]),this.addressForm._applyCountryFormatAddress(),this.listenTo(this.address,"onChange:"+r.Fields.COUNTRY,this._onChangeCountry.bind(this)),this},validate:function(){let e=!0;return this.buyerInputs.forEach(function(s){s.validate().isValid||(e=!1)}),this.addressForm.validate()&&e},save:function(){return this.buyerType===a.COMPANY?this._saveCompany().then(this._saveAddress.bind(this)):this._saveAddress()},setDisabled:function(e){e=!1!==e,this.readOnly=e,this.render()},setBuyerType:function(e){e!==this.buyerType&&(this.buyerType=e,this.buyerType!==a.COMPANY||this.company||(this.company=this.companyFactory.createModel(o.Types.COMPANY,null,{parentResourceId:this.person.get("id"),addressFactory:this.addressFactory})),this.render())},getBuyerType(){return this.buyerType},destroy:function(){this.stopListening(),this._destroyBuyerInputs(),this._destroyAddressForm(),this.address=null,this.addressFactory=null,this.companyFactory=null,this.countries=null,this.person=null,this.company=null,this._parent(),this.container=null},_saveCompany:function(){let e;return e=this.company.isNew()?this.company.savePromise():this.company.hasPendingChanges()?this.company.savePromise(this.company.getPendingChanges(),{patch:!0}):Promise.resolve()},_isCountryInputReadOnly:function(){return this.type===m.BILLING&&this.buyerType===a.COMPANY&&!this.company.isNew()&&!!this.company.getCountry()},_onChangeCountry:function(){this.type===m.BILLING&&this.buyerType===a.COMPANY&&"DEFAULT"!==this.address.getCountry()&&this.company.setCountry(this.address.getCountry()),this.addressForm._onCountryChange()},_saveAddress:function(){if(this.address.isNew()){const e=this.buyerType===a.COMPANY?d.Types.COMPANY:d.Types.ME,s=this.buyerType===a.COMPANY?this.company.get("id"):this.person.get("id");this.address.dataProxy=this.addressFactory.getDataProxy(e),this.address.setParentResourceId(s)}return this.address.set(r.Fields.IS_BILL_TO,"TRUE"),this.address.set(r.Fields.IS_SHIP_TO,"TRUE"),this.address.savePromise().catch(this._saveRetryForInvalidBillingAddress.bind(this))},_saveRetryForInvalidBillingAddress:function(e){let t;return this.type===m.BILLING?t=s.reject(e):(this.address.set(r.Fields.IS_BILL_TO,"FALSE"),t=this.address.savePromise()),t},_createBuyerInputs:function(){const e=[];return this.buyerType===a.COMPANY?(e.push(this._createCompanyNameInput()),this.type===m.BILLING&&(e.push(this._createCompanyTaxRegistrationIdInput()),e.push(this._createCompanyRegistrationIdInput()))):(e.push(this._createFirstNameInput()),e.push(this._createLastNameInput())),e},_destroyBuyerInputs(){this.buyerInputs&&this.buyerInputs.forEach(e=>e.destroy())},_createCompanyNameInput:function(){return new l({model:this.company,required:!0,dynamicValidation:!0,readOnly:this.readOnly})},_createCompanyTaxRegistrationIdInput:function(){return new u({model:this.company,readOnly:this.readOnly,required:!0,dynamicValidation:!0})},_createCompanyRegistrationIdInput:function(){return new c({model:this.company,readOnly:this.readOnly,required:!0,dynamicValidation:!0})},_createFirstNameInput:function(){return new h({model:this.person,fieldName:"firstName",fieldLabel:p.get("firstName"),required:!0,readOnly:!0,dynamicValidation:!0})},_createLastNameInput:function(){return new h({model:this.person,fieldName:"lastName",fieldLabel:p.get("lastName"),required:!0,readOnly:!0,dynamicValidation:!0})},_createAddressForm:function(){return this.type===m.BILLING&&this.buyerType===a.COMPANY&&!this.company.isNew()&&this.company.getCountry()&&this.address.isNew()&&this.address.set(r.Fields.COUNTRY,this.company.getCountry(),{silent:!0}),new y({addressModel:this.address,addressConstraints:this.addressFactory.getConstraints(),countries:this.countries,readOnly:this.readOnly,countryReadOnly:this.readOnly||this._isCountryInputReadOnly(),showPhoneNumber:!0,required:!0})},_destroyAddressForm(){this.addressForm&&this.addressForm.destroy()}});return A.Types=m,A}),define("DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFUtils/MPFUtils","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent"],function(e,s,t,r,i){"use strict";var n={ON_CHANGE:"onChange"},d={COMPANY:"company",PERSON:"person"},o=s.extend({className:"mpf-buyer-type",setup:function(e){this._parent(e),this.readOnly=!0===e.readOnly,this.inputs=[],this.selected=this.model&&void 0!==this.model.defaults.registrationId?d.COMPANY:d.PERSON,this.toggleName="buyerType_"+r.generateUUID()},domEvents:{click:"onClick"},render:function(){var s,r;return this.inputs=[new t({name:this.toggleName,value:d.PERSON,className:"primary",label:i.get("personAddress"),checked:this.selected===d.PERSON,disabled:this.readOnly}),new t({name:this.toggleName,value:d.COMPANY,className:"primary",label:i.get("companyAddress"),checked:this.selected===d.COMPANY,disabled:this.readOnly})],s=e.createElement("label",{class:"mpf-person",html:[this.inputs[0]]}),r=e.createElement("label",{class:"mpf-company",html:[this.inputs[1]]}),this.container.setContent([s,r]),this},onClick:function(){var e;(e=this.getSelectedType())!==this.selected&&(this.selected=e,this.dispatchEvent(n.ON_CHANGE,[this.selected]))},getSelectedType:function(){return this.inputs.filter(function(e){return e.isChecked()}).shift().getValue()},setReadOnly:function(e){this.readOnly=!0===e,this.render()},destroy:function(){this.model=null,this._parent(),this.container=null}});return o.Types=Object.freeze(d),o.Events=Object.freeze(n),o}),define("DS/MPFBuyerAddressComponent/BuyerAddressCardV2",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressModel","css!DS/MPFUI/MPFUI"],function(e,s,t,r,i){"use strict";const n=[i.Fields.LINE1,i.Fields.LINE2,i.Fields.LINE3,i.Fields.LINE4,i.Fields.CITY,i.Fields.COUNTY,i.Fields.STATE,i.Fields.POSTAL_CODE,i.Fields.COUNTRY],d=Object.freeze({ON_SELECTED:"onSelected"}),o=e.extend({className:"mpf-address-card-v2",domEvents:{click:"_onCardClicked"},setup({me:e,company:n,address:d,showPhoneNumber:o=!1,isSelectable:a=!0,isSelected:h=!1}={}){s.requiredOfPrototype(e,t,"options.me must be a PersonModel"),s.requiredOfPrototype(n,r,"options.company must be a CompanyModel"),s.requiredOfPrototype(d,i,"options.address must be an AddressModel"),this.me=e,this.company=n,this.address=d,this.showPhoneNumber=o,this.isSelectable=a,this.isSelected=h,this.isSelectable&&this.container.addClassName("mpf-selectable")},render(){const e=[];if(n.forEach(s=>{const t=this.address.get(s);t&&e.push({tag:"div",text:t})}),this.showPhoneNumber){const s=this.address.get(i.Fields.PHONE_NUMBER);s&&e.push({tag:"div",text:s})}return this.container.setContent([{tag:"div",class:"mpf-title",html:[{tag:"span",class:`fonticon fonticon-${this.address.isCompanyAddress?"building-office":"user"}`},{tag:"span",text:this.address.isCompanyAddress?this.company.getName():this.me.getFirstName()+" "+this.me.getLastName()}]},...e]),this.isSelected?this.container.addClassName("mpf-selected"):this.container.removeClassName("mpf-selected"),this},destroy(){this.me=null,this.company=null,this.address=null,this._parent(),this.container=null},_onCardClicked(){this.isSelectable&&!this.isSelected&&this.dispatchEvent(d.ON_SELECTED,this.address)},setSelected(e){e!==this.isSelected&&(this.isSelected=e,this.render())}});return o.Events=Object.freeze(d),o}),define("DS/MPFBuyerAddressComponent/BuyerAddressPanel",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFAddressModel/AddressModel","DS/MPFPersonModel/PersonModel","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFBuyer/BuyerType","DS/MPFView/EmptyView","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFBuyerAddressComponent/BuyerAddressFormV2","DS/MPFBuyerAddressComponent/BuyerAddressPanelFooter","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent","css!DS/MPFBuyerAddressComponent/MPFBuyerAddressComponent"],function(e,s,t,r,i,n,d,o,a,h,l,c,u,y,p,m,A){"use strict";const C=p.Types,f=Object.freeze({ON_CANCEL:"onCancel",ON_SAVE:"onSave",ON_ERROR:"onError"}),S=s.extend({className:"mpf-buyer-address-panel",setup:function(e){n.requiredOfPrototype(e.address,d,"options.address must be a AddressModel"),n.requiredOfPrototype(e.addressFactory,h,"options.addressFactory must be an AddressFactory"),n.requiredOfPrototype(e.companyFactory,l,"options.companyFactory must be a CompanyFactory"),n.requiredOfPrototype(e.countries,a,"options.countries must be a CountryCollection"),n.requiredOfPrototype(e.person,o,"options.person must be a PersonModel"),this.address=e.address,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.countries=e.countries,this.person=e.person,this.buyerType=this._getBuyerType(this.person),this.company=e.company||this.buyerType===c.COMPANY&&this._createCompany(),this.type=e.type||C.SHIPPING,this.buyerTypeLocked=!0===e.buyerTypeLocked,this.readOnly=!0===e.readOnly,this.showMyAddressesLink=!1!==e.showMyAddressesLink,this.showCancelButton=!1!==e.showCancelButton,this.countryReadOnly=e.countryReadOnly,this.title=e.title,this.serviceView=e.serviceView||u.getInstance(),this.alert=this._createAlert(),this.header=this._createHeader(),this.footer=this._createFooter()},render:function(){const e=[this.alert,this.header];return this.buyerTypeLocked||(this.buyerTypeSelectorInput=this._createBuyerTypeSelector(),e.push(this.buyerTypeSelectorInput.render())),this.form=this._createForm(),e.push(this.form.render()),e.push(this.serviceView.render()),e.push(this.footer.render()),this.container.setContent(e),this},validate:function(){return this.form.validate()},save:function(){if(this.validate())return r.mask(this.container),this.form.save().then(()=>{r.unmask(this.container),this.dispatchEvent(f.ON_SAVE,{address:this.address,buyerType:this.buyerType})}).catch(e=>{r.unmask(this.container),console.error(e),this.alert.add({className:"error",message:A.get("saveAddressError")}).show(),this.dispatchEvent(f.ON_ERROR,e)})},setDisabled:function(e){this.readOnly=!1!==e,this.buyerTypeSelectorInput&&this.buyerTypeSelectorInput.setReadOnly(this.readOnly),this.form&&this.form.setDisabled(this.readOnly),this.footer.setDisabled(this.readOnly)},destroy:function(){this.stopListening(),this.form&&this.form.destroy(),this.footer.destroy(),this.address=null,this.addressFactory=null,this.companyFactory=null,this.countries=null,this.person=null,this.company=null,this._parent(),this.container=null},_onBuyerTypeChange:function(e){this.buyerType=e===y.Types.COMPANY?c.COMPANY:c.INDIVIDUAL,this.form.setBuyerType(this.buyerType)},_createAlert:function(){return new i({visible:!1,autoHide:!0})},_createHeader:function(){return e.createElement("div",{class:"mpf-address-panel-header",html:[{tag:"h4",class:"mpf-title",text:this.title||this._getTitle()},this.showMyAddressesLink&&this._createMyAddressesLink()]})},_getTitle:function(){return A.get((this.address.isNew()?"create":"edit")+(this.type===C.SHIPPING?"ShippingAddress":"BillingAddress"))},_createMyAddressesLink:function(){return e.createElement("div",{class:"mpf-link btn-link-icon",html:[{tag:"span",class:"fonticon fonticon-back fonticon-clickable"},{tag:"a",class:"btn-link",text:A.get("addressList")}],events:{click:this.dispatchEvent.bind(this,f.ON_CANCEL)}})},_createBuyerTypeSelector:function(){const e=new y({model:this.buyerType===c.COMPANY?this.company:this.person});return this.listenTo(e,y.Events.ON_CHANGE,this._onBuyerTypeChange.bind(this)),e},_createForm:function(){return new p({address:this.address,person:this.person,company:this.company,addressFactory:this.addressFactory,companyFactory:this.companyFactory,countries:this.countries,readOnly:this.readOnly,type:this.type,buyerTypeLocked:this.buyerTypeLocked,countryReadOnly:this.countryReadOnly})},_createFooter:function(){const e=new m({readOnly:this.readOnly,showCancelButton:this.showCancelButton});return this.listenTo(e,m.Events.ON_SAVE,this.save.bind(this)),this.listenTo(e,m.Events.ON_CANCEL,this.dispatchEvent.bind(this,f.ON_CANCEL)),e},_createCompany(){return this.companyFactory.createModel(l.Types.COMPANY,null,{parentResourceId:this.person.get("id"),addressFactory:this.addressFactory})},_getBuyerType:e=>e.get(o.Fields.BUYER_TYPE)===c.INDIVIDUAL.name?c.INDIVIDUAL:c.COMPANY});return S.Events=f,S.Types=Object.freeze(C),S}),define("DS/MPFBuyerAddressComponent/BuyerAddressList",["UWA/Core","UWA/Class/View","DS/UIKIT/Scroller","DS/MPFBuyer/BuyerType","DS/MPFBuyerAddressComponent/BuyerAddressCard"],function(e,s,t,r,i){"use strict";const n=Object.freeze({ADDRESS_SELECTED:"AddressSelected"}),d=s.extend({className:"mpf-buyer-address-list",setup:function(e){this._parent(e),this.addressCards=[],this.buyer=e.buyer,this.buyerType=e.buyerType,this.showPhoneNumber=e.showPhoneNumber,this.isSelectable=!1!==e.isSelectable,this.isBillingAddress=!0===e.isBillingAddress,this.selectedAddress=this.isSelectable?e.selectedAddress||this._getDefaultSelection():null,this.scroller=null,this.listenTo(this.model,"onChange",this.render.bind(this))},render:function(){this._createAddressCards();const s=this.addressCards.map(function(e){return e.render()}),r=e.createElement("div",{class:"mpf-address-cards",html:s});return this.scroller=new t({element:r}),this.container.setContent(this.scroller),this},getSelectedAddress:function(){return this.selectedAddress},setSelectedAddress:function(e){const s=this.model.get(e);s&&(this.selectedAddress=s,this.addressCards.forEach(function(e){e.setSelected(e.model.id===s.id)}),this.dispatchEvent(n.ADDRESS_SELECTED,s))},scrollToSelectedAddress:function(){this.scroller&&this.scroller.scrollToElement(".selected")},removeClassName:function(e){this.container.removeClassName(e)},addClassName:function(e){this.container.addClassName(e)},size:function(){return this.addressCards.length},_isAddressesPersistedAndOfExpectedType:function(e){let s,t;return this.isBillingAddress?(s=e.isBillTo(),t=this.buyerType!==r.COMPANY||!this.buyer.getCountry()||this.buyer.getCountry()===e.getCountry()):(s=e.isShipTo(),t=!0),!e.isNew()&&s&&t},_createAddressCard:function(e){return new i({model:e,buyer:this.buyer,showPhoneNumber:this.showPhoneNumber,isSelectable:this.isSelectable,selected:!!this.selectedAddress&&this.selectedAddress.get("id")===e.get("id")})},_listenCardSeleted:function(e){this.isSelectable&&this.listenTo(e,i.Events.ON_SELECTED,this.setSelectedAddress.bind(this))},_stopListeningCardSelected:function(e){this.stopListening(e,i.Events.ON_SELECTED)},_createAddressCards:function(){this.addressCards.forEach(this._stopListeningCardSelected.bind(this)),this.addressCards=this._filterAddresses().map(this._createAddressCard.bind(this)),this.addressCards.forEach(this._listenCardSeleted.bind(this))},_filterAddresses:function(){return this.model.filter(this._isAddressesPersistedAndOfExpectedType.bind(this))},_getDefaultSelection:function(){const e=this._filterAddresses();return e.length>0?e[0]:null}});return d.Events=n,d}),define("DS/MPFBuyerAddressComponent/BuyerAddressListV2",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFBuyerAddressComponent/BuyerAddressCardV2"],function(e,s,t,r,i){"use strict";const n=Object.freeze({ON_ADDRESS_SELECTION:"onAddressSelection"}),d=e.extend({className:"mpf-buyer-address-list-v2",setup(e={}){s.requiredOfPrototype(e.me,t,"options.me must be a PersonModel"),s.requiredOfPrototype(e.company,r,"options.company must be a CompanyModel"),this.me=e.me,this.company=e.company,this.cards=[],this.selectedAddressId=null},render({addresses:e,selectedAddressId:t}){return s.requiredOfType(e,"array","options.addresses must be a array of AddressModel instances"),this.selectedAddressId=t,this._destroyCards(),this.cards=e.map(this._createCard.bind(this)),this.container.setContent(this.cards.map(e=>e.render())),this},validate(){return!!this.selectedAddressId},destroy(){this._destroyCards(),this.cards=null,this.me=null,this.company=null,this._parent(),this.container=null},_createCard(e){const s=new i({me:this.me,company:this.company,address:e,isSelectable:!0,isSelected:e.get("id")===this.selectedAddressId,showPhoneNumber:!0});return this.listenTo(s,i.Events.ON_SELECTED,this._onAddressSelection.bind(this)),s},_destroyCards(){this.cards.forEach(e=>{this.stopListening(e),e.destroy()})},_onAddressSelection(e){this.cards.forEach(s=>{s.setSelected(e===s.address)}),this.selectedAddressId=e.get("id"),this.dispatchEvent(n.ON_ADDRESS_SELECTION,e)}});return d.Events=n,d}),define("DS/MPFBuyerAddressComponent/BuyerAddressBookV2",["UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Modal","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFBuyer/BuyerType","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFBuyerAddressComponent/BuyerAddressFormV2","DS/MPFBuyerAddressComponent/BuyerAddressListV2","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent","css!DS/MPFBuyerAddressComponent/MPFBuyerAddressComponent"],function(e,s,t,r,i,n,d,o,a,h,l,c,u,y,p,m,A){"use strict";const C=Object.freeze({ADDRESS_SELECTED:"addressSelected",PAGE_CHANGED:"pageChanged",MODAL_CLOSED:"modalClosed"}),f=Object.freeze({FORM:"addressForm",LIST:"list"}),S=p.Types,F=e.extend({className:"mpf-buyer-address-book-v2",setup(e={}){i.requiredOfPrototype(e.cart,n,"options.cart must be a CartModel"),i.requiredOfPrototype(e.me,d,"options.me must be a PersonModel"),i.requiredOfPrototype(e.company,o,"options.company must be a CompanyModel"),i.requiredOfPrototype(e.personAddresses,a,"options.personAddresses must be a AddressCollection"),i.requiredOfPrototype(e.companyAddresses,a,"options.companyAddresses must be a AddressCollection"),i.requiredOfPrototype(e.countries,h,"options.countries must be a CountryCollection"),i.requiredOfPrototype(e.addressFactory,c,"options.addressFactory must be a AddressFactory"),i.requiredOfPrototype(e.companyFactory,l,"options.companyFactory must be a CompanyFactory"),this.cart=e.cart,this.me=e.me,this.company=e.company,this.personAddresses=e.personAddresses,this.companyAddresses=e.companyAddresses,this.countries=e.countries,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.addressType=e.addressType||S.SHIPPING,this.saveButton=this._createSaveButton(),this.cancelButton=this._createCancelButton(),this.modal=this._createModal(),this.list=this._createAddressList()},render({addressType:e,selectedAddress:s}={}){return e&&(this.addressType=e),this.selectedAddress=s,this.state=null,this._renderPage(),this.container.setContent(this.modal),this},show(){return this.modal.show(),this},hide(){this.modal.hide()},_renderPage(){const e=this.addressType===S.SHIPPING||!this.cart.get(n.Fields.SHIP_TO),s=this._getInitialBuyerType(),t=this._getValidAddresses({buyerType:s,isBuyerTypeEditable:e}),r=this._getSelectedAddressId();let i,d;const o=[];t.length<1&&(this.state=f.FORM),this.state===f.FORM?(i=this.addressType===S.BILLING?A.get("enterBillingAddress"):A.get("enterShippingAddress"),e&&(this.buyerTypeSelectorInput=this._createBuyerTypeSelector({buyerType:s}),o.push(this.buyerTypeSelectorInput.render())),this.form&&this.form.destroy(),this.form=this._createAddressForm({buyerType:s,isBuyerTypeEditable:e}),o.push(this.form.render()),this.saveButton.enable(),d=A.get("save")):(i=this.addressType===S.BILLING?A.get("selectBillingAddress"):A.get("selectShippingAddress"),o.push(this.list.render({addresses:t,selectedAddressId:r})),this.saveButton.setDisabled(!r),d=A.get("select")),this.modal.setHeader({tag:"h4",text:i}),this.modal.setBody([t.length>0&&this._renderLink(),...o]),this.saveButton.setValue(d)},async _save(){if(this.state===f.FORM?this.form.validate():this.list.validate()){if(this.state===f.FORM){this._setLoading(!0),this.selectedAddress=await this.form.save(),this._setLoading(!1),this.form.getBuyerType()===u.COMPANY?this.companyAddresses.push(this.selectedAddress):this.personAddresses.push(this.selectedAddress)}this.hide(),this.selectedAddress&&this.dispatchEvent(C.ADDRESS_SELECTED,{address:this.selectedAddress,addressType:this.addressType})}},destroy(){this.stopListening(),this.list.destroy(),this.buyerTypeSelectorInput&&this.buyerTypeSelectorInput.destroy(),this.form&&this.form.destroy(),this.modal.destroy(),this.list=null,this.buyerTypeSelectorInput=null,this.form=null,this.modal=null,this.addressType=null,this.selectedAddress=null,this.cart=null,this.me=null,this.company=null,this.personAddresses=null,this.companyAddresses=null,this.addressFactory=null,this.companyFactory=null,this._parent(),this.container=null},_setLoading(e=!0){e?s.mask(this.modal.getBody()):s.unmask(this.modal.getBody()),this.saveButton.load(e),this.cancelButton.setDisabled(e)},_getInitialBuyerType(){if(this.selectedAddress){const e=this.selectedAddress.get("id");return this.companyAddresses.get(e)?u.COMPANY:u.INDIVIDUAL}{const e=this.cart.get(n.Fields.BILL_TO);if(this.addressType===S.BILLING&&e)return this.companyAddresses.get(e)?u.COMPANY:u.INDIVIDUAL;{const e=this.cart.get(n.Fields.SHIP_TO);return e?this.companyAddresses.get(e)?u.COMPANY:u.INDIVIDUAL:this.companyAddresses.size()>0?u.COMPANY:this.personAddresses.size()>0?u.INDIVIDUAL:u.COMPANY}}},_getValidAddresses({buyerType:e,isBuyerTypeEditable:s}){if(this.addressType===S.BILLING){const t=[];if(s||e===u.COMPANY){const e=this.company.getCountry();this.companyAddresses.forEach(s=>{!s.isBillTo()||e&&s.getCountry()!==e||(s.isCompanyAddress=!0,t.push(s))})}return(s||e===u.INDIVIDUAL)&&this.personAddresses.forEach(e=>{e.isBillTo()&&t.push(e)}),t}return[...this.companyAddresses.filter(e=>e.isShipTo()).map(e=>(e.isCompanyAddress=!0,e)),...this.personAddresses.filter(e=>e.isShipTo())]},_getSelectedAddressId(){return this.selectedAddress?this.selectedAddress.get("id"):this.addressType===S.SHIPPING?this.cart.get(n.Fields.SHIP_TO):this.cart.get(n.Fields.BILL_TO)},_renderLink(){const e=this.state===f.FORM;return{tag:"div",class:"mpf-link",html:[{tag:"span",class:`fonticon fonticon-${e?"back":"plus"}`},{tag:"span",text:A.get(e?"addressList":"addAddress")}],events:{click:()=>{this.state=this.state===f.FORM?f.LIST:f.FORM,this._renderPage(),this.dispatchEvent(C.PAGE_CHANGED)}}}},_createBuyerTypeSelector({buyerType:e}){const s=new y({model:e===u.COMPANY?this.company:this.me});return this.listenTo(s,y.Events.ON_CHANGE,e=>{const s=e===y.Types.COMPANY?u.COMPANY:u.INDIVIDUAL;this.form.setBuyerType(s)}),s},_createAddressList(){const e=new m({me:this.me,company:this.company});return this.listenTo(e,m.Events.ON_ADDRESS_SELECTION,e=>{this.selectedAddress=e,this.saveButton.enable()}),e},_createAddressForm({buyerType:e,isBuyerTypeEditable:s}){const t=e===u.COMPANY;return new p({person:this.me,company:this.company,address:this.addressFactory.createModel(t?c.Types.COMPANY:c.Types.ME),countries:this.countries,addressFactory:this.addressFactory,companyFactory:this.companyFactory,buyerTypeLocked:!s,type:this.addressType,buyerType:e})},_createSaveButton(){return new t({className:"primary",events:{onClick:()=>{this._save().catch(e=>{console.error(e)})}}})},_createCancelButton(){return new t({value:A.get("cancel"),events:{onClick:()=>{this.hide()}}})},_createModal(){return new r({closable:!0,footer:[this.saveButton,this.cancelButton],events:{onHide:()=>{this.dispatchEvent(C.MODAL_CLOSED)}}})}});return F.Events=C,F.States=f,F.AddressTypes=S,F}),define("DS/MPFBuyerAddressComponent/BuyerAddressForm",["UWA/Core","UWA/Class/View","UWA/Promise","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFAddressModel/AddressModel","DS/MPFCountryModel/CountryCollection","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFCompanyComponent/CompanyForm","DS/MPFCompanyComponent/CompanyNameForm","DS/MPFPersonComponent/PersonNameForm","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFBuyer/BuyerType","DS/MPFError/ValidationError"],function(e,s,t,r,i,n,d,o,a,h,l,c,u,y){"use strict";return s.extend({className:"mpf-buyer-address-form",setup:function(e){this._parent(e),i.requiredOfPrototype(e.countries,d,"options.countries must be a CountryCollection"),this.address=e.address,this.buyer=e.buyer||null,this.buyerType=u.fromModel(this.buyer),this.addressFactory=e.addressFactory,this.buyerTypeLocked=!0===e.buyerTypeLocked,this.companyFactory=e.companyFactory,this.countryReadOnly=!0===e.countryReadOnly,this.isBillingAddress=!0===e.isBillingAddress,this.isCompany=this.buyerType===u.COMPANY,this.authorized=!0===e.authorized,this.countries=e.countries,this.showPhoneNumber=e.showPhoneNumber;const s=this._isBuyerTypeDetermined();s||this.isCompany||this._changeBuyerType("individual"),this.buyerTypeLocked||(this.buyerTypeSelector=new o({model:this.buyer,readOnly:s}),this.listenTo(this.buyerTypeSelector,"onChange",this.onBuyerTypeChange)),this.buyerForm=null,this.addressForm=null,this._initCountryListener()},render:function(){const e=[];return this.isCompany?this.buyerForm=this._createCompanyForm(this.buyer,this.isBillingAddress):this.buyerForm=new l({model:this.buyer,readOnly:!0,lockSave:!0,required:!0}),this.addressForm=new c({addressModel:this.address,addressConstraints:this.address.constraints,countries:this.countries,preSetCountry:this.preSetCountry,readOnly:!this.address.isNew(),countryReadOnly:this.countryReadOnly,showPhoneNumber:this.showPhoneNumber}),this.buyerTypeLocked||e.push(this.buyerTypeSelector.render()),e.push(this.buyerForm.render()),e.push(this.addressForm.render()),this.container.setContent(e),this},save:function(){const e=this.buyerForm.save.bind(this.buyerForm),s=this._saveBillingAddressPromise.bind(this);return r.mask(this.container),Promise.all([this._validateBuyerPromise(),this._validateAddressPromise()]).then(e).then(s).catch(function(e){const s=e instanceof Error?e:new Error("Unable to save buyer or address form");return Promise.reject(s)}).finally(()=>{r.unmask(this.container)})},validate:function(){return this.buyerForm.validate()&&this.addressForm.validate()},onBuyerTypeChange:function(e){this._changeBuyerType(e),this.render()},destroy:function(){this.stopListening(),this.buyerTypeSelector.destroy(),this.address=null,this.buyer=null,this.countries=null,this._parent(),this.container=null},addClassName:function(e){this.container.addClassName(e)},removeClassName:function(e){this.container.removeClassName(e)},clear:function(){this.addressForm&&this.addressForm.clear()},_isBuyerTypeDetermined:function(){const e=this.buyer.addresses.filter(function(e){return!e.isNew()}).length>0;return this.isCompany||e},_changeBuyerType:function(e){this.isCompany="company"===e,this._initCountryListener(),"company"===e?(this.userBuyer=this.buyer,this.isBillingAddress?(this.countryReadOnly=!this.address.isNew()&&this.address.getCountry(),this.buyer=this.companyFactory.createModel("me",{country:this.address.getCountry()})):(this.countryReadOnly=!1,this.buyer=this.companyFactory.createModel("me"))):this.userBuyer&&(this.buyer=this.userBuyer,this.countryReadOnly=!1)},_initCountryListener:function(){this.stopListening(this.address,"onChange:"+n.Fields.COUNTRY),this.isCompany&&this.isBillingAddress&&this.listenTo(this.address,"onChange:"+n.Fields.COUNTRY,this._onChangeCountry.bind(this))},_createCompanyForm:function(e,s){let t;return t=s&&this.authorized?new a({model:e,countries:this.countries,hideCountry:!0}):new h({model:e,readOnly:!e.isNew(),required:!0})},_onChangeCountry:function(){this.isCompany&&"DEFAULT"!==this.address.getCountry()&&this.buyer.set("country",this.address.getCountry())},_validateBuyerPromise:function(){const e=this;return new t(function(s,t){e.buyerForm.validate()?s():t(new y("Buyer validation failed"))})},_validateAddressPromise:function(){const e=this;return new t(function(s,t){e.addressForm.validate()?s():t(new y("Unable to save address"))})},_saveBillingAddressPromise:function(){let e;if(this.addressForm.addressModel.isNew())return this.isCompany?(e=this.buyer.get("name"),this.addressForm.addressModel.dataProxy=this.addressFactory.getDataProxy("companyAddress")):e=this.buyer.get("firstName")+" "+this.buyer.get("lastName"),this.addressForm.addressModel.set("isBillTo","TRUE"),this.addressForm.addressModel.set("isShipTo","TRUE"),this.addressForm.addressModel.parentResourceId=this.buyer.id,this.addressForm.addressModel.set("addressLine0",e),this.addressForm.savePromise().catch(this._saveRetryForShippingAddress.bind(this))},_saveRetryForShippingAddress:function(e){let s;return this.isBillingAddress?s=t.reject(e):(this.addressForm.addressModel.set("isBillTo","FALSE"),s=this.addressForm.savePromise()),s}})}),define("DS/MPFBuyerAddressComponent/BuyerAddressBook",["UWA/Core","UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressFactory","DS/MPFAddressModel/AddressModel","DS/MPFBuyerAddressComponent/BuyerAddressList","DS/MPFBuyerAddressComponent/BuyerAddressForm","DS/MPFBuyer/BuyerType","DS/MPFError/ValidationError","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFUrl/UrlUtils","i18n!DS/MPFBuyerAddressComponent/assets/nls/BuyerAddressComponent","css!DS/MPFBuyerAddressComponent/MPFBuyerAddressComponent"],function(e,s,t,r,i,n,d,o,a,h,l,c,u,y,p,m){"use strict";const A={CREATION:"creation",LIST:"list",SAVING:"saving"};return s.extend({className:"buyer-address-book",setup:function(e){e||(e={}),this._parent(e),n.requiredOfPrototype(e.countries,d,"options.countries must be a CountryCollection"),this.me=e.me,this.countries=e.countries,this.companyFactory=e.companyFactory,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.addressFactory=e.addressFactory,this.buyer=e.buyer||null,this.selectedAddress=e.selectedAddress||null,this.preSetCountry=!1!==e.preSetCountry,this.buyerTypeLocked=!0===e.buyerTypeLocked,this.countryReadOnly=!0===e.countryReadOnly,this.isBillingAddress=!0===e.isBillingAddress,this.showSelectButton=!1!==e.showSelectButton,this.showPhoneNumber=!0===e.showPhoneNumber&&!this.isBillingAddress,this.isCreationAllowed=this._isCreationAllowed(e),this.buyerType=c.fromModel(this.buyer),this.authorized=this._isAuthorizedToPatchCompany(),this.stateMachine=this._createStateMachine(),this.alertMessages=this._createAlertMessagesContainer(),this.listPageLink=this._createAddressListLink(),this.creationPageLink=this._createAddressCreationLink(),this.footer=this._createFooter(),e.className&&this.container.addClassName(e.className)},render:function(){return this.buyerAddressForm=this._createBuyerAddressForm(),this.addressList=this._createAddressList(),this.pages={list:this._renderAddressListPage(),creation:this._renderAddressCreationPage()},this.modal=this._createModal(this.pages,this.footer),this.stateMachine.getState()===A.CREATION?(this.footer[0].setValue(m.get("save")),this.footer[0].show(),this.pages.creation.removeClassName("hidden"),this.pages.list.addClassName("hidden")):(this.footer[0].setValue(m.get("select")),this._adaptSelectButtonState(),this.pages.creation.addClassName("hidden"),this.pages.list.removeClassName("hidden"),this.showSelectButton||this.footer[0].hide()),this.container.setContent(this.modal),this},show:function(){if(this.modal){const e=this.model.filter(function(e){return!e.isNew()}).length>0,s=this.isCreationAllowed&&!e?A.CREATION:A.LIST;this._changeActivePage(s),this.modal.show()}},hide:function(){this.stateMachine.getState()!==A.SAVING&&this.modal&&this.modal.hide()},saveAndOrSelect:function(){let e;this.stateMachine.getState()===A.CREATION?(this.footer[0].load(),this.footer[1].setDisabled(!0),this.stateMachine.changeState(A.SAVING),this.buyerAddressForm.save().then(()=>{this.errorMessageContainer&&this.errorMessageContainer.empty(),this.buyer.get("addressLine0")||(e=void 0!==this.buyer.defaults.registrationId?this.buyer.get("name"):this.buyer.get("firstName")+" "+this.buyer.get("lastName"),this.buyerAddressForm.address.set("addressLine0",e)),this.selectedAddress=this.buyerAddressForm.address,this.model.add(this.buyerAddressForm.address),this.hide(),this.stateMachine.changeState(A.CREATION),this.render(),this.dispatchEvent("onSelected",{ok:!0,selectedAddress:this.selectedAddress})}).catch(e=>{if(this.stateMachine.changeState(A.CREATION),this.dispatchEvent("onSelected",{ok:!1}),!(e instanceof u)){const s=e.toString()||m.get("saveAddressError");this.alertMessages.add({className:"error",message:s})}}).finally(()=>{this.footer[0].load(!1),this.footer[1].setDisabled(!1)})):(this.selectedAddress=this.addressList.getSelectedAddress(),this.dispatchEvent("onSelected",{ok:!0,selectedAddress:this.addressList.getSelectedAddress()}),this.hide())},getSelectedAddress:function(){return this.selectedAddress},destroy:function(){this.buyerAddressForm&&this.buyerAddressForm.destroy(),this.addressList&&this.addressList.destroy(),this.model=null,this.me=null,this.buyer=null,this.countries=null,this.addressFactory=null,this.companyFactory=null,this.cartFactory=null,this.cartItemFactory=null,this._parent(),this.container=null},_createFooter:function(){return[new r({className:"primary",events:{onClick:this.saveAndOrSelect.bind(this)},value:m.get("select")}),new r({value:m.get("cancel"),events:{onClick:this.hide.bind(this)}})]},_renderAddressListPage:function(){return e.createElement("div",{class:"mpf-page",html:[this.creationPageLink,this.addressList.render()]})},_renderAddressCreationPage:function(){return e.createElement("div",{class:"mpf-page",html:[this.listPageLink,this.buyerAddressForm.render()]})},_createAddressCreationLink:function(){let s;return this.isCreationAllowed&&(s=e.createElement("a",{class:"mpf-link",html:[{tag:"span",class:"fonticon fonticon-plus"},{tag:"span",text:m.get("addAddress")}],href:"#",events:{click:this._changeActivePage.bind(this,A.CREATION)}})),s},_createAddressListLink:function(){return e.createElement("a",{class:"mpf-link",html:[{tag:"span",class:"fonticon fonticon-back"},{tag:"span",text:m.get("addressList")}],href:"#",events:{click:this._changeActivePage.bind(this,A.LIST)}})},_changeActivePage:function(e){let s,t;e!==this.stateMachine.getState()&&Object.prototype.hasOwnProperty.call(this.pages,e)&&(this.stateMachine.changeState(e),(t=this.stateMachine.getState())===A.CREATION?(s=this.isBillingAddress?m.get("enterBillingAddress"):m.get("enterShippingAddress"),this.footer[0].setValue(m.get("save")),this.footer[0].show(),this.pages.creation.removeClassName("hidden"),this.pages.list.addClassName("hidden")):(s=this.isBillingAddress?m.get("selectBillingAddress"):m.get("selectShippingAddress"),this.footer[0].setValue(m.get("select")),this.pages.creation.addClassName("hidden"),this.pages.list.removeClassName("hidden"),this.showSelectButton||this.footer[0].hide()),this.modal.getHeader().getElement("h4").setText(s))},_createBuyerAddressForm:function(){const e=this._getBuyerCountry(),s=this._createAddress();return this.preSetCountry&&e&&s.set(a.Fields.COUNTRY,e),new l({address:s,buyer:this.buyer,addressFactory:this.addressFactory,buyerTypeLocked:this.buyerTypeLocked,companyFactory:this.companyFactory,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,countryReadOnly:this.countryReadOnly,isBillingAddress:this.isBillingAddress,preSetCountry:this.preSetCountry,authorized:this.authorized,countries:this.countries,showPhoneNumber:this.showPhoneNumber})},_createAddress:function(){let e;return this.buyerType===c.INDIVIDUAL?e=this.addressFactory.createModel(o.Types.ME):this.buyerType===c.COMPANY&&(e=this.addressFactory.createModel(o.Types.COMPANY),this.buyer.getCountry()&&e.set(a.Fields.COUNTRY,this.buyer.getCountry())),e.set(a.Fields.IS_SHIP_TO,"TRUE"),e.set(a.Fields.IS_BILL_TO,"TRUE"),e},_getBuyerCountry:function(){const e=this.buyer.get("country");if(e)return e;{const e=this.model.last();return e?e.getCountry():null}},_createModal:function(s,r){let i;i=this.stateMachine.getState()===A.CREATION?this.isBillingAddress?m.get("enterBillingAddress"):m.get("enterShippingAddress"):this.showSelectButton?this.isBillingAddress?m.get("selectBillingAddress"):m.get("selectShippingAddress"):this.isBillingAddress?m.get("billingAddresses"):m.get("shippingAddresses");const n=new t({header:e.createElement("h4",{text:i}),body:[this.alertMessages,s.creation,s.list],footer:this.footer,closable:!1,events:{onHide:this._onModalHide.bind(this)}});return this.alertMessages.getContent().setStyle("visibility","visible"),n},_onModalHide:function(){this.buyerAddressForm.clear()},_createStateMachine:function(){const e=this.isCreationAllowed&&this.model.isEmpty()?A.CREATION:A.LIST;return new y({state:e,states:[A.CREATION,A.LIST,A.SAVING],transitions:[{from:A.LIST,to:A.CREATION},{from:A.CREATION,to:A.LIST},{from:A.CREATION,to:A.SAVING},{from:A.SAVING,to:A.CREATION}]})},_createAlertMessagesContainer:function(){return new i({closable:!0,visible:!0,autoHide:!1})},_createAddressList:function(){this.addressList&&this.stopListening(this.addressList);const e=new h({model:this.model,buyer:this.buyer,buyerType:this.buyerType,isBillingAddress:this.isBillingAddress,showPhoneNumber:this.showPhoneNumber,selectedAddress:this.selectedAddress,isSelectable:this.showSelectButton});return this.listenTo(e,h.Events.ADDRESS_SELECTED,this._adaptSelectButtonState.bind(this)),e},_isAuthorizedToPatchCompany:function(){let s=!0;if(this.buyerType===c.COMPANY){this.buyerTypeLocked=!0;const t=this.buyer.getCountry();if(this.isBillingAddress&&t&&(this.countryReadOnly=!0,this.preSetCountry=t),""!==this.buyer.getEmpProjectName()&&e.is(this.me)){s=this.me.getRoles().some(e=>"Admin"===e.Role&&e.Project===this.buyer.getEmpProjectName())}else s=!0}return s},_isCreationAllowed:function(e){return!(p.from(window.location.href).isEmp()&&this.isBillingAddress)||!0===e.isCreationAllowed},_adaptSelectButtonState:function(){this.stateMachine.getState()===A.LIST&&this.showSelectButton&&this.addressList&&this.footer[0].setDisabled(!this.addressList.getSelectedAddress())}})});