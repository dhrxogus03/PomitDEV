define("DS/ModelLoader_3dskt/loader",["UWA/Core","UWA/Promise","DS/SceneGraphNodes/FixedSizeNode3D","DS/ZipJS/zip","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWThreeJsExtender","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CAT3DSKExperience/CAT3DSKAnnotationAbbreviationsExperience","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/Usage/TrackerAPI","DS/Plugins/UserRenderList","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices","DS/CAT3DWInfraUI/CAT3DWHandleErrors","DS/Visualization/MaterialApplication","DS/CAT3DWInfra/CAT3DWUrlServices","DS/Visualization/Ambience","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DWFileServices","DS/CAT3DWInfraUI/CAT3DWDataModelConverter"],function(e,t,i,r,a,n,o,s,d,l,c,h,m,u,p,g,f,y,v,D,w,x,S){"use strict";return e.Class.extend({init:function(e){this._parent(e),this._3dMediaCounter=0,this._2dMediaCounter=0,this.isR2V=null,this.texture=[],this._isMobileApp=!1,window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(this._isMobileApp=!0,w.setPreferenceValue("M3DEMobile",!0))},unzip:function(e){return new t(function(t){var i=new r.BlobReader(e);r.createReader(i,function(e){var i=e;i.getEntries(function(e){var a=e.find(function(e){return"sketch.json"===e.filename});a&&a.getData(new r.TextWriter,function(e){var r=e.target.result;i.close(function(){t(r)})})})},function(){console.log("zip error")})})},readJsonFile:function(e){return new t(function(t,i){var r={proxy:"none",type:"arraybuffer",timeout:6e5,onComplete:function(e){t(new Blob([e],{type:"application/zip"}))},onError:function(e){i(e)}};l.authenticatedRequest(e,r)})},getListPointFromCircle:function(e,t){for(var i=[],r=new o.Vector3(t.x,t.y,t.z),a=new o.Vector3(e.annotStartPoint.x,e.annotStartPoint.y,e.annotStartPoint.z),n=new o.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),s=e.geometry.radius,d=(new o.Vector3).subVectors(a,n).normalize(),l=(new o.Vector3).crossVectors(d,r).normalize(),c=2*Math.PI/e.pointsCount,h=0;h<2*Math.PI;h+=c){var m=n.x+s*Math.cos(h)*d.x+s*Math.sin(h)*l.x,u=n.y+s*Math.cos(h)*d.y+s*Math.sin(h)*l.y,p=n.z+s*Math.cos(h)*d.z+s*Math.sin(h)*l.z;i.push(new o.Vector3(m,u,p))}return i.push(i[0]),i},getListPointFromEllipse:function(e){for(var t=[],i=new o.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),r=new o.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z),a=new o.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z),n=e.geometry.majorAxis.length,s=e.geometry.minorAxis.length,d=2*Math.PI/e.pointsCount,l=0;l<2*Math.PI;l+=d){var c=i.x+n*Math.cos(l)*r.x+s*Math.sin(l)*a.x,h=i.y+n*Math.cos(l)*r.y+s*Math.sin(l)*a.y,m=i.z+n*Math.cos(l)*r.z+s*Math.sin(l)*a.z;t.push(new o.Vector3(c,h,m))}return t.push(t[0]),t},getListPointFromLine:function(e){var t=[],i=new o.Vector3(e.geometry.startPoint.x,e.geometry.startPoint.y,e.geometry.startPoint.z),r=new o.Vector3(e.geometry.endPoint.x,e.geometry.endPoint.y,e.geometry.endPoint.z);return t.push(i,r),t},getListPointFromRectangle:function(e){var t=[],i=new o.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),r=new o.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),a=new o.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z),n=new o.Vector3(e.geometry.vertexD.x,e.geometry.vertexD.y,e.geometry.vertexD.z);return t.push(i,r,a,n,i),t},getListPointFromTriangle:function(e){var t=[],i=new o.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),r=new o.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),a=new o.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z);return t.push(i,r,a,i),t},getListPointFromUnknown:function(e){for(var t=[],i=0;i<e.geometry.points.length;i++){var r=new o.Vector3(e.geometry.points[i].x,e.geometry.points[i].y,e.geometry.points[i].z);t.push(r)}return t},_getLineMaterial:function(e){var t={color:e.color,lineWidth:e.thickness*window.devicePixelRatio,opacity:e.opacity,transparent:!1,force:!0,isCPUPattern:!0,linecap:"round",needsUpdate:!0};return new o.LineBasicMaterial(t)},_getSphereMaterial:function(e){return new o.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!1,force:!0})},_applyOpacityStencilOp:function(e,t){if(t.opacity<1){var i=this._viewer.getUserPassManager(),r=new m("StencilOpacityPass"),a=i.createUserRenderPass("userRenderPass",r);a.setEnableStencilTest(!0),a.setEnableStencilWrite(!0),a._passes[0].stencilRef=100*t.opacity,a.setStencilFunc("NOTEQUAL"),a.setStencilOpsSeparate("REPLACE","REPLACE","KEEP","KEEP");var n=i.getSystemPass("main");i.insertUserPassAfterPass(a,n),e.setRenderPasses([r])}},draw:function(e,t,r){var n=this._getLineMaterial(r);if("point"!==t){var s={points:e},d=a.createLineNode(s);if(d.setName("3DSketch_Annot"),d.oldSetMaterial(n),this._annotContainer.add(d),"line"===t){var l=new i({name:"3DSketch_Linecap",ratio:1});this._annotContainer.addChild(l),l.setMatrix((new o.Matrix4).setPosition(e[0].clone()));var c=this._getSphereMaterial(r),h=a.createSphereNode({sag:3,radius:r.thickness/2,fill:!0,material:c});this._applyOpacityStencilOp(h,r),l.add(h)}this._applyOpacityStencilOp(d,r)}else this.drawPoint(e,r)},drawPoint:function(e,t){var r=new o.MeshBasicMaterial({color:t.color,transparent:!1,force:!0,opacity:t.opacity,side:o.DoubleSide}),n=new i({name:"CAT3DSketch-PointNode",ratio:1});this._annotContainer.addChild(n),n.setMatrix((new o.Matrix4).setPosition(e[0]));var s=a.createSphereNode({sag:20,radius:.5*t.thickness,material:r});n.add(s),this._applyOpacityStencilOp(s,t)},load3DModel:function(t,i,r){t=(new v).generateUrlWithSuffix(t),this._isMobileApp&&(t=e.Data.proxifyUrl(t,{proxy:"passport"}));var a=new c,n="model3DNode_"+this._3dMediaCounter;this._3dMediaCounter++;var d=new s(n);if(this._3DSKTContainer.addChild(d),a.setOnLoadedCallback(()=>{var e=d.getBoundingBox().center(),t=new o.Matrix4;t.makeTranslation(-e.x,-e.y,-e.z);for(var i=0;i<d.children.length;i++)d.children[i].setMatrix(t);this._viewer.render(),r&&r()}),a.setOnErrorCallback(function(e){console.error(e),r&&r()}),a.loadModel({filename:t,proxyurl:"none",withCredentials:!0},d),i){var l=new o.Matrix4;l.setFromArray(i),d.setMatrix(l)}},_onTextureLoaded:function(e,t,i){this.apply2Dtexture(this.texture[e],t,null),i&&i()},onLoadImageError:function(e){e&&e()},drawSketch:function(e){var i=JSON.parse(e);return this.isR2V=i.isR2V,w.setPreferenceValue("isR2V",this.isR2V),new t(function(e){if(i.ver)for(var t=(new d).processJSON(i,"expand").explodeStates,r=0;r<t.length;r++)if(0===t[r].id)for(var a=t[r].drawPlanes,n=0;n<a.length;n++){var s=a[n],l=s.annotList.filter(function(e){return e.isVisible});if(l.length)for(var c=null,h=0;h<l.length;h++){switch(l[h].type){case"circle":c=this.getListPointFromCircle(l[h],s.drawPlaneInfo.normal);break;case"ellipse":c=this.getListPointFromEllipse(l[h]);break;case"line":c=this.getListPointFromLine(l[h]);break;case"rectangle":c=this.getListPointFromRectangle(l[h]);break;case"triangle":c=this.getListPointFromTriangle(l[h]);break;case"unknownOpen":case"unknownClosed":c=this.getListPointFromUnknown(l[h]);break;case"point":c=[new o.Vector3(l[h].annotStartPoint.x,l[h].annotStartPoint.y,l[h].annotStartPoint.z)];break;default:c=this.getListPointFromUnknown(l[h])}this.draw(c,l[h].type,l[h].graphicalProp)}}e(i.ExternalRef)}.bind(this))},apply2Dtexture:function(e,t,i){var r,n="";i?(n="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,r=new s(n),this.VideoModelsNode.addChild(r)):(n="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,r=new s(n),this._3DSKTContainer.addChild(r)),e.flipY=!1;var d={width:-100,height:-100,fill:!0,noEdge:!0},l=a.createRectangleNode(d);l.setRenderPasses([this._beforeMainPass]),l.setMatrix((new o.Matrix4).setPosition(new o.Vector3(50,50,0)));var c=(new o.Matrix4).makeRotationX(Math.PI);if(r.addChild(l),r.setMatrix(t),l.applyMatrix(c),!(e.image.width<=0||e.image.height<=0)){var h=o.MaterialUtils.createMatteFaceMaterial({map:e,side:o.DoubleSide,force:!0,transparent:!0,depthTest:!1});i&&this.mapVid.set(r.name,i);var m=new y({faceMaterial:h});l.setMaterialApplication(m),this.textureLoaded=!0}},load2DModel:function(t,i,r,a,n){a!==x.STATUS_KO&&a!==x.STATUS_PROCESSING&&(t=(new v).generateUrlWithSuffix(t));this._isMobileApp&&(t=e.Data.proxifyUrl(t,{proxy:"passport"}));var s=new o.Matrix4;s.setFromArray(i),this.texture.push(null);var d=this.texture.length-1;r===x.TYPE_IMAGE||a===x.STATUS_PROCESSING?(this.texture[d]=o.ImageUtils.loadTexture3DWhiteboard(t,void 0,this._onTextureLoaded.bind(this,d,s,n),this.onLoadImageError.bind(this,n),"use-credentials",1),this.texture[d].magFilter=o.LinearMipMapLinearFilter,this.texture[d].minFilter=o.LinearFilter):n()},getMedias:function(i){var r=[];if(i&&i.media3D&&i.media3D.length)for(let e=0;e<i.media3D.length;e++)r.push({mediaId:i.media3D[e].mediaId,associatedData:{id:i.media3D[e].id,matrix:i.media3D[e].matrixModel?i.media3D[e].matrixModel:i.media3D[e].matrix}});if(i&&i.mediaId&&r.push({mediaId:i.mediaId,associatedData:{id:i.id,matrix:null}}),i&&i.media2D&&i.media2D.length&&!0===this.isR2V)for(let e=0;e<i.media2D.length;e++)r.push({mediaId:i.media2D[e].mediaId,associatedData:{id:i.media2D[e].id,matrix:i.media2D[e].matrix,background:i.media2D[e].background}}),!0===i.media2D[e].background&&(w.setPreferenceValue("camPosR2V",i.media2D[e].R2VCamera.camPos),w.setPreferenceValue("quatR2V",i.media2D[e].R2VCamera.quat),w.setPreferenceValue("fovR2V",i.media2D[e].R2VCamera.fov),w.setPreferenceValue("focalR2V",i.media2D[e].R2VCamera.focal),w.setPreferenceValue("imWidthR2V",i.media2D[e].R2VCamera.imWidth),w.setPreferenceValue("imHeightR2V",i.media2D[e].R2VCamera.imHeight));return r.length?new t(function(t){this._swymMediaServices.getMedias(r,function(e){u.mask(this._mask,"Loading "+e+"%")}.bind(this)).then(function(i){f.initialize();var r=null,a=null,n="",s=0,d=0,l=0;const c=()=>{++l===i.length&&t()};for(var h=0;h<i.length;h++)if(i[h].status===x.STATUS_PROCESSING&&i[h].type&&(n+=i[h].title+" ",d++),i[h].status===x.STATUS_KO&&i[h].type&&s++,i[h].format===x.FORMAT_3D&&i[h].status!==x.STATUS_PROCESSING&&(a=i[h].associatedData.matrix?(r=JSON.parse(i[h].associatedData.matrix)).elements:null,this.load3DModel(i[h].url,a,c)),i[h].format===x.FORMAT_2D||i[h].status===x.STATUS_PROCESSING)if(i[h].associatedData.background&&!0===i[h].associatedData.background){var m=new D({viewer:this._viewer});this._viewer.setAmbience(m);var u=i[h].url;u=(new v).generateUrlWithSuffix(u),this._isMobileApp&&(u=e.Data.proxifyUrl(u,{proxy:"passport"})),m.setBackGroundMap({url:u,mapping:new o.SimpleEnvMappingFit,hdr:!1}),c()}else r=JSON.parse(i[h].associatedData.matrix),this.load2DModel(i[h].url,r.elements,i[h].type,i[h].status,c);d&&(f.setGeneralErrorMessage(d+" media not yet processed. Try reloading when all medias are processed","",n,"warning"),t()),s&&(f.setGeneralErrorMessage(s+" media not available. Check your access rights","","","warning"),t())}.bind(this)).catch(function(e){e&&console.log(e)})}.bind(this)):new t(function(e){e()})},_convertJSON:function(e){return new Promise(function(t){this._DataModelConverter.convertToLatestVersion(e).then(function(e){t(e)}).catch(function(){t(e)})}.bind(this))},load:function(t,i,r,a){this._3DSKTContainer=new s("3DSKTContainer"),this._annotContainer=new s("annotContainer"),this._3DSKTContainer.addChild(this._annotContainer),this._viewer=t.viewer,this._maskContainer=e.createElement("div",{styles:{opacity:.7,pointerEvents:"none",position:"absolute",top:"0",width:"100%",height:"100%",zIndex:10,display:"none"}}).inject(document.body),this._mask=e.createElement("div",{styles:{position:"absolute",top:"0",width:"100%",height:"100%"}}).inject(this._maskContainer),u.mask(this._mask,"Loading");var n={};if(t.requestsOptions&&t.requestsOptions.serverurl)n.platformUrl=t.requestsOptions.serverurl;else{n.platformId=p.getTenant();try{!n.platformId&&parent.ds&&parent.ds.swymTenant&&(n.platformId=parent.ds.swymTenant)}catch(e){}}t.requestsOptions&&t.requestsOptions.appname&&(this._appname=t.requestsOptions.appname),"3dstory"!==this._appname&&(this._maskContainer.style.display="block"),this._swymMediaServices=new g(n),this._DataModelConverter=new S({version:"5.0",webapp:S.APP_3DSKETCH,platformId:w.getPreferenceValue("swymTenant"),platformUrl:n.platformUrl,viewer:this._viewer,viewpoint:this._viewer.currentViewpoint});var o=this._viewer.getUserPassManager();this._beforeMainPass=new m("BeforeMain");var d=o.createUserClearPass("userClearPass",this._beforeMainPass);d.setClearDepth(!0);var l=o.createUserRenderPass("userRenderPass",this._beforeMainPass),c=o.getSystemPass("main");o.insertUserPassBeforePass(d,c),o.insertUserPassBeforePass(l,d),this.readJsonFile(t.filename).then(this.unzip.bind(this)).then(this._convertJSON.bind(this)).then(this.drawSketch.bind(this)).then(this.getMedias.bind(this)).then(function(){u.unmask(this._mask),document.body.removeChild(this._maskContainer),i(this._3DSKTContainer),a(this._3DSKTContainer),this.isR2V||this._viewer.currentViewpoint.reframe(null,0),h.trackPageEvent({eventCategory:"3DSketch_Loader",eventAction:"3DSketch_LoadVisu",eventLabel:"Load visu of sketch in other apps",appID:"CAT3DSKT_AP"})}.bind(this)).catch(this._error)},_error:function(e){console.error(e)}})});