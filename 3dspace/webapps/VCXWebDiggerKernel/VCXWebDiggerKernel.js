var VCXGlobalDiggerCompare=(e,t)=>e.key-t.key,VCXGlobalDiggerCompareOpposite=(e,t)=>t.key-e.key;define("DS/VCXWebDiggerKernel/VCXDiggerKernel",["DS/Core/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/WebRBTree/WebRBTree","DS/WebRBTree/WebRBIterator","DS/VCXWebExperienceBase/VCXOverridesChangeServices","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,n,r,o,s,a,h,c){"use strict";var l=t.extend({init:function(){this._depth=0,this._zoomFactor=.5,this._zoomNavigation=0,this._mode=l.EMode.Zoom,this._attach=!0,this._attachP=null,this._lockViewpoint=!1,this._lockPlanes=!1,this._target=null,this._position=null,this._lockSynchronizeDiggerViewpoint=!1,this._previousVPTarget=new n.Vector3(0,0,0),this._previousVPOrientation=new n.Quaternion(0,0,0,0),this._lockCenter=!1,this._sphereCenter=null,this._doubleDirection=!1,this._lockPickability=!1,this._lockOpacity=!1,this._diggMode=l.EDigMode.Linear,this.distanceType=l.EDigDistance.Plan,this.boundingType=l.EDigBounding.Box,this._invertDirection=!1,this._lockUpdateDigger=!1,this.resetArray(),this._positionPx=null,this._radiusPx=null,this._torchFilter=!0,this._experienceBase=null,this._viewer=null,this._SceneGraphOverrideSet=null,this._SortTimer=null,this._updatePickabilityTimer=null,this.onChangeViewpoint=(e=>{if("@onViewpointChange"===e.eventType){if(!this.isFullViewer())return;if(this._lockSynchronizeDiggerViewpoint)return;if(!(this._viewer&&this._viewer.currentViewpoint&&this._viewer.currentViewpoint.getControl()&&e.viewpoint))return;if(this._diggMode!==l.EDigMode.Linear)return;if(this.getLockViewpoint())return;var t=this._viewer.currentViewpoint.target,i=this._viewer.currentViewpoint.getControl().orientation;if(i.equals(this._previousVPOrientation)&&t.equals(this._previousVPTarget))return;if(this._previousVPTarget.copy(t),this._previousVPOrientation.copy(i),this._mode!==l.EMode.Onion&&this._mode!==l.EMode.XRay)return;if(this.getLockPlanes())return;if(this._lockUpdateDigger)return;this._lockPickability=!0,this.updateDigger(),this._updatePickabilityTimer&&(window.clearTimeout(this._updatePickabilityTimer),this._updatePickabilityTimer=null),this._updatePickabilityTimer=window.setTimeout(()=>{window.clearTimeout(this._updatePickabilityTimer),this._updatePickabilityTimer=null,this._lockPickability=!1,this._lockOpacity=!0,this.updateDiggerContent(),this._lockOpacity=!1},500)}}),this.onPropertiesChanged=(e=>{if(e){e&&e.component&&e.component.IsKindOf("VCXComponentOccurrenceExt")&&console.log("change");var t=!1,i=e;for(var n in i._map)if(i._map.hasOwnProperty(n)){var r=i.GetPropertySet(n);for(var o in r._map){if(r._map.hasOwnProperty(o))"Actor.Opacity"===r._map[o]&&(t=!0)}}t&&(this._opacityObj=[])}}),this.onScenarioChanged=(()=>{void 0!==this._viewer&&null!==this._viewer&&(this.resetArray(),this._SceneGraphOverrideSet&&(this.removeOverrides(),this._SceneGraphOverrideSet=h.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer)),this.updateDigger())}),this._tokenChangeViewpoint=r.subscribe({event:"/VISU/"},this.onChangeViewpoint),this._tokenPropertiesChanged=r.subscribe({event:"VCX_PROPERTIES_CHANGED"},this.onPropertiesChanged),this._tokenScenarioChanged=r.subscribe({event:"VCX_CURRENT_SCENARIO_CHANGED"},this.onScenarioChanged),this._tokenSelectionAdd=r.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},()=>{this.onChangeCSO()}),this._tokenSelectionRemove=r.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},()=>{this.onChangeCSO()})},resetTorchInfo:function(){this._torchInfo={},this._torchInfo._isInTorchArray=[],this._torchInfo._nbModifiableInTorch=0},resetArray:function(e){void 0===e&&(e=!0),this._zOrder=[],this._zOppositeOrder=[],e&&(this._opacityObj=[],this._modifiableBBoxInWCS=[]),this._modifiableProjectMinMax={},this.resetTorchInfo()},dispose:function(){null!==this._tokenChangeViewpoint&&(r.unsubscribe(this._tokenChangeViewpoint),this._tokenChangeViewpoint=null),null!==this._tokenPropertiesChanged&&(r.unsubscribe(this._tokenPropertiesChanged),this._tokenPropertiesChanged=null),null!==this._tokenScenarioChanged&&(r.unsubscribe(this._tokenScenarioChanged),this._tokenScenarioChanged=null),this._tokenSelectionAdd&&(r.unsubscribe(this._tokenSelectionAdd),this._tokenSelectionAdd=null),this._tokenSelectionRemove&&(r.unsubscribe(this._tokenSelectionRemove),this._tokenSelectionRemove=null),this.resetArray()},isFullViewer:function(){return null===this._radiusPx},setMode:function(e){this._mode=e},getMode:function(){return this._mode},setAttach:function(e){this._attach=e},getAttach:function(){return this._attach},lockViewpoint:function(e){this._lockViewpoint=e},getLockViewpoint:function(){return this._lockViewpoint},lockPlanes:function(e){this._lockPlanes=e},getLockPlanes:function(){return this._lockPlanes},invertDirection:function(e){this._invertDirection=e},getInvertDirection:function(){return this._invertDirection},setDepth:function(e){this._depth=e},getDepth:function(){return this._depth},resetDepth:function(){this._depth=0},resetZoom:function(){this._zoomFactor=0},setZoom:function(e){this._zoomFactor=e},getZoom:function(){return this._zoomFactor},setDepthZoom:function(e){this._zoomNavigation=e},getDepthZoom:function(){return this._zoomNavigation},onChangeCSO:function(e){this._diggMode!==l.EDigMode.Spherical||this._lockCenter||(this.sortFrontToBack(),this.updateDiggerContent(!0))},getPositionPx:function(){return this._positionPx},getRadiusPx:function(){return this._radiusPx},setTorchFilter:function(e){this._torchFilter=e},getTorchFilter:function(){return this._torchFilter},removeOverrides:function(){this._SceneGraphOverrideSet&&(h.removeSceneGraphOverrideSet(this._experienceBase,this._SceneGraphOverrideSet,this._viewer),this._SceneGraphOverrideSet=null)},getBBoxInWCS:function(e){var t=e.getBoundingBox(null,this._viewer);return t.min.x===1/0||t.min.y===1/0||t.min.z===1/0||t.max.x===-1/0||t.max.y===-1/0||t.max.z===-1/0?null:(t.applyMatrix4(e.getWorldMatrix(this._viewer)),t)},projectBBox:function(e){},calcSphereCenterSelection:function(){var t=e.Selection.CSOManager.get();return this.calcSphereCenterArray(t)},calcSphereCenterArray:function(e){var t=null;if(e&&e.length){for(var i=0,n=0;n<e.length;n++){var r=e[n];if(r){var o=r.pathElement;if(o){var s=this.getBBoxInWCS(o);s&&(t?t.add(s.center()):t=s.center(),i++)}}}i>1&&t.divideScalar(i)}if(null===t){var a=this._experienceBase.getManager("VCXContextManager");if(a){var h=a.getRootPathElement();if(h)t=h.getBoundingBox(null,this._viewer).center()}}return t},calcProjection:function(e,t){var i=null,r=this._experienceBase.getManager("VCXContextManager").getMainViewer();if(r&&(i=r.currentViewpoint),null===i)return!1;this.getRadiusPx();for(var o=new n.Vector2,s=new n.Vector2,a=0;a<t.length;a++){var h=t[a],c=i.project(h);0==a?(o.x=c.x,o.y=c.y,s.x=c.x,s.y=c.y):(o.x=Math.min(o.x,c.x),o.y=Math.min(o.y,c.y),s.x=Math.max(s.x,c.x),s.y=Math.max(s.y,c.y))}var l=e.component&&e.component.QueryInterface("VCXIModifiable");return l?this._modifiableProjectMinMax[l.GetHashing()]={pntMin:o,pntMax:s}:this._modifiableProjectMinMax[e.refInstNode.getPathOfIDs().toString()]={pntMin:o,pntMax:s},!0},isInTorch:function(e){var t;if(!(e in this._modifiableProjectMinMax))return!1;var i=(t=this._modifiableProjectMinMax[e]).pntMin.clone(),n=t.pntMax.clone();if(this._attach){var r=this._attachP;r&&(i.x-=r.x,i.y-=r.y,n.x-=r.x,n.y-=r.y)}else{var o=this.getPositionPx();o&&(i.x-=o.x,i.y-=o.y,n.x-=o.x,n.y-=o.y)}var s=this.getRadiusPx();return i.x<=s&&n.x>=-s&&i.y<=s&&n.y>=-s},iterateComponents:function(e){const t=this._experienceBase.getManager("VCXCAT3DXModelManager"),i=this._experienceBase.getManager("VCXContextManager");if(t&&i&&i.isSupported("VCXProductIndexSupport")){const i=t.getProducts();for(let t in i){const n=i[t];n&&n.productIndex.traverseTree(t=>"VPMInstance"===t.type&&(e({refInstNode:t}),!1))}}else for(var n=this._experienceBase.ComponentsMap.GetComponentFromType("VCXWebComponentOccurrence"),r=0;r<n.length;r++){((s=n[r]).IsKindOf(["VCXComponentPoint","VCXComponentCurveWire","VCXComponentCompositePmi"])||s.IsMesh&&s.IsMesh())&&e({component:s})}var o=this._experienceBase.ComponentsMap.GetComponentFromType("VCXDressup_Spec");for(r=0;r<o.length;r++){var s;if(!(s=o[r]).IsKindOf(["VCXDigger_Spec","VCXViewport_Spec","CXPCameraActor_Spec"]))if(s.QueryInterface("W3AISGNodeHolder")){var a=1,h=s.QueryInterface("VCXIVisibility");h&&(a=h.GetVisibility()),a!==c.EVisState.Hidden&&e({component:s})}}},calcDistanceMinMax:function(e,t,i,r,o,s){var a=0;if(this._diggMode===l.EDigMode.Linear){if(this.distanceType===l.EDigDistance.Plan){var h=(new n.Vector3).subVectors(e,this._position);a=t.dot(h)}else if(this.distanceType===l.EDigDistance.Object){h=(new n.Vector3).subVectors(e,this._position);a=t.dot(h)>0?h.length():-h.length()}}else this._diggMode===l.EDigMode.Spherical&&(a=this._sphereCenter.distanceTo(e));r&&(s.zmin||(s.zmin=a),s.zmin=Math.min(a,s.zmin),this._diggMode===l.EDigMode.Spherical&&this.getInvertDirection()&&i.containsPoint(this._sphereCenter)&&(s.zmin=0)),o&&(s.zmax||(s.zmax=a),s.zmax=Math.max(a,s.zmax))},pushZOrder:function(e,t,i){var n={};n.key=t;var r=e.findIter(n);if(r){n=null;var o=r.data();void 0===o.list&&(o.list=[]),o.list.push(i)}else n.value=i,e.insert(n)},RBTreeToArray:function(e,t){for(var i=new s(e),n=i.next();null!==n;)t.push(n.value),n.list&&n.list.forEach(e=>{t.push(e)}),n=i.next()},RBTreeDataToArray:function(e,t,i){e.hasOwnProperty(t.value._ID)||(e[t.value._ID]=1,i.push(t.value)),t.list&&t.list.forEach(t=>{e.hasOwnProperty(t._ID)||(e[t._ID]=1,i.push(t))})},needForwardOrder:function(){return this._diggMode===l.EDigMode.Linear&&!this.getInvertDirection()||this._diggMode===l.EDigMode.Spherical&&this.getInvertDirection()},needBackwardOrder:function(){return this._diggMode===l.EDigMode.Spherical&&!this.getInvertDirection()||this._diggMode===l.EDigMode.Linear&&this.getInvertDirection()},computeInTorchInfo:function(e,t){for(var i={_isInTorchArray:[],_nbModifiableInTorch:0},n=0;n<e.length;n++){var r=e[n].component;if(r){var o=r.QueryInterface("VCXIModifiable");o&&(i._isInTorchArray[n]=this.isInTorch(o.GetHashing()),i._isInTorchArray[n]&&i._nbModifiableInTorch++)}else i._isInTorchArray[n]=this.isInTorch(e[n].refInstNode.getPathOfIDs().toString()),i._isInTorchArray[n]&&i._nbModifiableInTorch++}return i},sortMapDistance:function(e,t){this._zOrder=[];(new Date).getTime();if(this._doubleDirection)for(var i={},n=new s(e),r=new s(t),o=n.next(),a=r.next();null!==o&&null!==a;)this.RBTreeDataToArray(i,o,this._zOrder),this.RBTreeDataToArray(i,a,this._zOrder),o=n.next(),a=r.next();else this.needForwardOrder()?this.RBTreeToArray(e,this._zOrder):this.RBTreeToArray(t,this._zOrder)},sortFrontToBack:function(){if(this._mode!==l.EMode.XRay&&this._mode!==l.EMode.Onion)return void console.log("sortFrontToBack call not wanted!");(new Date).getTime();if(this._zOrder=[],this._zOppositeOrder=[],this._opacityObj=[],null==this._experienceBase)return;if(null==this._viewer.currentViewpoint)return;if(!this.getLockPlanes()||!this._target||!this._position){var e=this._viewer.currentViewpoint.target;this._target=new n.Vector3(e.x,e.y,e.z);var t=this._viewer.currentViewpoint.position;this._position=new n.Vector3(t.x,t.y,t.z)}this._diggMode===l.EDigMode.Spherical&&(this._lockCenter&&this._sphereCenter||(this._sphereCenter=this.calcSphereCenterSelection()));this.isFullViewer()||this.getTorchFilter();var r=this._doubleDirection||this.needForwardOrder(),s=this._doubleDirection||this.needBackwardOrder(),a=(new n.Vector3).subVectors(this._target,this._position);a.normalize();let h=new o(VCXGlobalDiggerCompare),d=new o(VCXGlobalDiggerCompareOpposite);this.iterateComponents(e=>{let t;const o=e.component;if(o){var u=o.QueryInterface("VCXIVisibility");if(u&&u.GetVisibility()===c.EVisState.Hidden)return;var p=o.QueryInterface("W3AISGNodeHolder").getPathElement();if(p){var _=p;if(!this._modifiableBBoxInWCS[i]){var g=_.getBoundingBox(null,this._viewer);if(g.min.x===1/0||g.min.y===1/0||g.min.z===1/0||g.max.x===-1/0||g.max.y===-1/0||g.max.z===-1/0)this._modifiableBBoxInWCS[i]=1/0;else{var f=_.getWorldMatrix(this._viewer);(t=g.clone()).applyMatrix4(f),this._modifiableBBoxInWCS[i]=t}}t=this._modifiableBBoxInWCS[i]}}else if(e&&e.refInstNode){if("VPMInstance"!==e.refInstNode.type)return;const i=e.refInstNode.getWorldMatrix(this._viewer),r=e.refInstNode.getData("boundingbox").min,o=e.refInstNode.getData("boundingbox").max;t=new n.Box3(new n.Vector3(r[0],r[1],r[2]),new n.Vector3(o[0],o[1],o[2])),i&&(t=t.applyMatrix4(i)),e.component=e.refInstNode.getComponent()}if(t!==1/0){var v=t.min,m=t.max,y=[];y.push(v),y.push(new n.Vector3(m.x,v.y,v.z)),y.push(new n.Vector3(m.x,m.y,v.z)),y.push(new n.Vector3(v.x,m.y,v.z)),y.push(m),y.push(new n.Vector3(v.x,m.y,m.z)),y.push(new n.Vector3(v.x,v.y,m.z)),y.push(new n.Vector3(m.x,v.y,m.z));var C=null;this._diggMode===l.EDigMode.Spherical&&this.getInvertDirection()&&(C=t.center(),y.push(C)),this.calcProjection(e,y);for(var x={zmin:null,zmax:null},S=0;S<y.length;S++)this.calcDistanceMinMax(y[S],a,t,r,s,x);r&&this.pushZOrder(h,x.zmin,e),s&&this.pushZOrder(d,x.zmax,e)}}),this.sortMapDistance(h,d)},_updateDiggerXRayContent:function(e){if(void 0===this._enopadViewer&&(this._enopadViewer=widget.enopadViewer||null),0!==e.length&&(this._SceneGraphOverrideSet||(this._SceneGraphOverrideSet=h.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._SceneGraphOverrideSet))){var t,i=e.length;this.isFullViewer()||!this.getTorchFilter()||this._torchInfo._isInTorchArray[0]||(this._torchInfo=this.computeInTorchInfo(e)),t=this.isFullViewer()||!this.getTorchFilter()?i:this._torchInfo._nbModifiableInTorch;for(var n=0,r=this._depth*t,o=0;o<i;o++){var s=this.isFullViewer()||!this.getTorchFilter()||this._torchInfo._isInTorchArray[o];s&&n++;var c=e[o];if(!c){console.log("_updateDiggerXRayContent: component null");continue}let t=c&&c.component&&c.component.QueryInterface("W3AISGNodeHolder").getPathElement(),i=c&&c.component&&c.component.QueryInterface("W3AISGNodeHolder").getPathOfIDs()&&c.component.QueryInterface("W3AISGNodeHolder").getPathOfIDs().ids||c.refInstNode&&c.refInstNode.getPathOfIDs();if(t||i){if(!this._lockPickability){var d=!(s&&n<r);a.Ghost(this._SceneGraphOverrideSet,this._enopadViewer?i:null,this._enopadViewer?null:t,!1,null,d?1:2)}if(!this._lockOpacity){var u=1;if(s&&n<r)if(this._mode===l.EMode.XRay){var p=n/r;u=.125*(p*=p)}else this._mode===l.EMode.Onion&&(u=0);if(void 0===this._opacityObj[o]||this._opacityObj[o]!==u){var _=null;if(t||i){var g=c&&c.component&&c.component.QueryInterface("VCXIModifiable");if(g&&null==(_=c&&c.component.globalAlpha)){var f=g.GetProperty("Actor.Opacity");f&&(_=f.GetPropertyValue().Value)}}_&&(u*=_),a.Ghost(this._SceneGraphOverrideSet,this._enopadViewer?i:null,this._enopadViewer?null:t,!0,u,0),this._opacityObj[o]=u}}}else console.log("_updateDiggerXRayContent: pathElement null")}}},updateDigger:function(){if(this._mode===l.EMode.XRay||this._mode===l.EMode.Onion){this.sortFrontToBack(),this.updateDiggerContent()}},updateDiggerContent:function(e){if(this._mode===l.EMode.XRay||this._mode===l.EMode.Onion){(new Date).getTime();0===this._zOrder.length&&this.sortFrontToBack(),this._updateDiggerXRayContent(this._zOrder)}e&&this._viewer.render()}});return l.EMode={Zoom:0,Onion:1,XRay:2,Detail:3},l.EDigMode={Linear:0,Cylindrical:1,Spherical:2},l.EDigDistance={Object:0,Plan:1},l.EDigBounding={Box:0,Sphere:1},l});