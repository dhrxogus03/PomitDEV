define("DS/3DXMTiles/CopyViscaURLServices",function(){"use strict";var e=function(){};function t(e){for(var t=e.split("&"),n={},i=0;i<t.length;i++){var r=t[i].split("=");"s"===r[0]?n.source=r[1]:"t"===r[0]?n.tenant=r[1]:"id"===r[0]?n.boid=r[1]:"f"===r[0]?n.filename=r[1]:"fmt"===r[0]?n.format=r[1]:"e"===r[0]?n.element=Number(r[1]):"v"===r[0]?n.version=r[1]:"ts"===r[0]?n.timestamp=r[1]:"type"===r[0]?n.type=r[1]:"sgn"===r[0]&&(n.signature=r[1])}return n}function n(e){if("Range"==e.name&&0==e.value.indexOf("bytes=")){var t=e.value.indexOf("-");if(t>0){const r="bytes=".length;var n=e.value.substring(r,t),i=e.value.substring(t+1);return Number(i)-Number(n)}}return-1}function i(e){var t=e;if("number"!=typeof t.element)return t;if(t.elements=[t.element],delete t.element,"number"!=typeof t.index)return t;if(t.indices=[t.index],delete t.index,Array.isArray(t.headers)&&1==t.headers.length){var i=n(t.headers[0]);i>=0&&(t.contentSize=i)}return t}return e.prototype.CreateURLsRequestBody=function(e,t){if(void 0!==e&&0!==e.length){for(var n={},i={files:[]},r=0;r<e.length;r++){if(void 0===e[r])return;i.files.push(e[r])}return"object"==typeof t&&"boolean"==typeof t.fallback&&t.fallback&&(i.fallback=!0),n.body=JSON.stringify(i),n}},e.prototype.IsURLFetchCompatible=function(e){return!e.toLowerCase().includes("&type=av")},e.prototype.CreateBatchURLAndBody=function(e,n){if(void 0!==e&&0!==e.length){for(var i={},r={files:[]},o=0;o<e.length;o++){if(void 0===e[o])return;var s=e[o].toLowerCase().search("api/v1/rep?");if(-1===s)return;0===o&&(i.url=e[o].substring(0,s)+"api/v1/reps");var a=t(e[o].substring(s+"api/v1/rep?".length,e[o].length));r.files.push(a)}return"object"==typeof n&&"boolean"==typeof n.allowPartial&&n.allowPartial&&(r.allowPartial=!0),"object"==typeof n&&"boolean"==typeof n.fallback&&n.fallback&&(r.fallback=!0),"object"==typeof n&&"string"==typeof n.emptyFallback&&n.emptyFallback.length>0&&(r.emptyFallback=emptyFallback),"object"==typeof n&&"boolean"==typeof n.checkVersion&&n.checkVersion&&(r.checkVersion=!0),i.body=JSON.stringify(r),i}},e.prototype.MergeBatchAnswer=function(e,t){if("object"==typeof e&&Array.isArray(e.files)){for(var r="number"==typeof t?t:0,o=[],s=0;s<e.files.length;s++){var a=e.files[s];if("object"==typeof a&&"string"==typeof a.url&&(Array.isArray(o[a.url])||(o[a.url]=[]),a.index=s,o[a.url].push(a),o[a.url][0].source!=a.source||o[a.url][0].boid!=a.boid))return}var d={files:[]};for(var l in o)h(o[l]);return d}function h(e){if(!Array.isArray(e)||0==e.length)return;const t="bytes=".length;for(var o=i(e[0]),s=1;s<e.length;s++)if("number"!=typeof o.contentSize||0!=r&&o.contentSize>=r)d.files.push(o),o=i(e[s]);else if(Array.isArray(e[s].headers)&&1==e[s].headers.length){var a=n(e[s].headers[0]);a<0?d.files.push(e[s]):0!=r&&o.contentSize+a>r?(d.files.push(o),o=i(e[s])):(o.contentSize+=a,o.elements.push(e[s].element),o.indices.push(e[s].index),o.headers[0].value+=","+e[s].headers[0].value.substring(t))}else d.files.push(e[s]);d.files.push(o)}},e.prototype.CreateFetchURLAndBody=function(e,n,i){if(void 0!==e&&0!==e.length&&void 0!==n&&n.length===e.length){for(var r={},o={files:[]},s=0;s<e.length;s++){if(void 0===e[s])return;var a=e[s].toLowerCase().search("api/v1/rep?");if(-1===a)return;0===s&&(r.url=e[s].substring(0,a)+"api/v1/fetch");var d=t(e[s].substring(a+"api/v1/rep?".length,e[s].length));d.correlationID=n[s],o.files.push(d)}return"object"==typeof i&&"number"==typeof i.splitTargetedSize&&i.splitTargetedSize>0&&(o.splitTargetedSize=i.splitTargetedSize),"object"==typeof i&&"boolean"==typeof i.allowPartial&&i.allowPartial&&(o.allowPartial=!0),"object"==typeof i&&"boolean"==typeof i.checkVersion&&i.checkVersion&&(o.checkVersion=!0),r.body=JSON.stringify(o),r}},e}),define("DS/3DXMTiles/OOCQuickOverrideSet",[],function(){"use strict";function e(e,t){this.referenceId=e,this.overrideCB=t}var t=0,n=function(e){this.oocManager=e,this._overrides=new Map,this._active=!1,this._id="_quick_"+t,t++};return n.prototype.setOverrideCB=function(t,n){n=n||null;var i=this._overrides.get(t);n?i||(i=new e(t,n),this._overrides.set(t,i)):i&&this._overrides.delete(t),this._active&&this.oocManager.setOverrideCB(t,n,this._id)},n.prototype.removeOverrideCB=function(e){this.setOverrideCB(e,null)},n.prototype.hasOverrideCB=function(e){var t=this._overrides.get(e);return!!t&&null!==t.overrideCB},n.prototype.setActive=function(e){var t=this.oocManager,n=this._id;(e=!!e)!==this._active&&(this._active=e,e?(t.registerOverrideSet(n),this._overrides.forEach(function(e,i){t.setOverrideCB(e.referenceId,e.overrideCB,n)})):t.removeOverrideSet(n))},n}),define("DS/3DXMTiles/DSTilesStylingFilterOperator",[],function(){"use strict";return class{constructor(){}buildShaderCode(e){throw new Error("missing implementation")}}}),define("DS/3DXMTiles/DSTilesForceLoadTransaction",[],function(){"use strict";var e=function({tileSet:e,onExploreCB:t,onLoadedCB:n,requestBoundingBox:i}){this.onExploreCB=t,this.onLoadedCB=n,this.tileSet=e,this.nodesToExplore=new Set,this.lockedNodesToExplore=new Set;let r=e.getRootNode();r.lockUnload(),this.lockedNodesToExplore.add(r),this.nodesToExplore.add(e.rootURI),this.toExpand=new Set,this.toDownload=new Set,this.forcedTileNodes=new Set,this.requestBoundingBox=i};function t(e,t,n,i){this.isError=e.isError(),this.uri=e.uri,this.geometricalError=e.geometricalError*i,this.isLeaf=e.isLeaf(),this.content=t?e.exportContent():null,this.contentType=null,e.contentSet&&1===e.contentSet.contents.length&&(this.contentType=e.contentSet.contents[0].type||null),this.hasContent=e.hasContent();var r,o=n?e.getDistanceToBoxCache():null;if(o)for(this.boundingBoxes=[],r=0;r<o.length;r++)this.boundingBoxes.push(o[r].boundingBox);else this.boundingBoxes=null}function n(){this.reset()}return e.prototype.update=function(){var e=[],i=[],r=this.nodesToExplore.size>0;for(this.tileSet.getRootNode().updateWorldMatrix();r;){for(r=!1,this.nodesToExplore.forEach(o=>{var s,a=this.tileSet.getTile(o),d=new n;if(a){if(this.lockedNodesToExplore.has(a)||(this.lockedNodesToExplore.add(a),a.lockUnload()),d.reset(),this.onExploreCB(new t(a,!1,this.requestBoundingBox,this.tileSet.unitScale),d),d._exploreChildren&&a.hasExpand()){for(s=0;s<a.childrenURIs.length;s++)i.push(a.childrenURIs[s]);a.isExpandLoaded()?r=!0:this.toExpand.add(o)}d._forceLoad&&a.hasContent()&&(a.isContentLoaded()?this.forcedTileNodes.add(a):this.toDownload.add(o),a.lockUnload()),e.push(o)}}),o=0;o<e.length;o++)this.nodesToExplore.delete(e[o]);for(e.length=0,o=0;o<i.length;o++)this.nodesToExplore.add(i[o]);i.length=0}var o,s=[];for(this.toExpand.forEach(e=>{if(this.tileSet.canExpand()){var t=this.tileSet.getTile(e);t.isExpandLoading()||this.tileSet.expandTile(t)}else s.push(e)}),this.toExpand.clear(),o=0;o<s.length;o++)this.toExpand.add(s[o]);for(0===this.nodesToExplore.size&&(this.lockedNodesToExplore.forEach(e=>{e.unlockUnload()}),this.lockedNodesToExplore.clear()),s=[],this.toDownload.forEach(e=>{if(this.tileSet.canLoadContent()){var t=this.tileSet.getTile(e);t.isContentLoading()||this.tileSet.loadTileContent(t),this.forcedTileNodes.add(t)}else s.push(e)}),this.toDownload.clear(),o=0;o<s.length;o++)this.toDownload.add(s[o]);var a=!0;return(this.nodesToExplore.size>0||this.toExpand.size>0||this.toDownload.size>0)&&(a=!1),a&&this.forcedTileNodes.forEach(e=>{e.isContentLoaded()||e.isError()||(a=!1)}),a&&this.onLoadingComplete(),a},e.prototype.onLoadingComplete=function(){var e=[];this.forcedTileNodes.forEach(n=>{e.push(new t(n,!0,this.requestBoundingBox,this.tileSet.unitScale))}),this.forcedTileNodes.clear(),setTimeout(()=>{this.onLoadedCB.call(null,e)},0)},n.prototype.exploreChildren=function(){this._exploreChildren=!0},n.prototype.forceLoad=function(){this._forceLoad=!0},n.prototype.reset=function(){this._exploreChildren=!1,this._forceLoad=!1},e}),define("DS/3DXMTiles/DSTilesExpander",[],function(){"use strict";var e=function(){};return e.prototype.isReady=function(){return!0},e.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},e.prototype.expand=function(e,t){setTimeout(t.onNodeExpandError.bind(t,e),0)},e}),define("DS/3DXMTiles/LDHOcclusionStatus",[],function(){return{unknown:"unknown",visible:"visible"}}),define("DS/3DXMTiles/InstancingFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],function(e,t,n){"use strict";var i=function(){};function r(e,t){if(0===t.length)return e;var n=new Float32Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}return i.prototype.buildInstancingBox=function(t){var n=t.matrices.length,i=t.matrices,r=t.boxes,o=t.colors,s=t.attributes||{},a=this.buildBoxMesh(s),d=this.buildMaterial(t);a.setMaterial(d);new e.Box3;return this.setUpMeshInstancingParameters(a,n,i,r,o),a.setExcludeFromBounding(!0),a.setFrustumCulled(!1),a},i.prototype.updateInstancingBox=function(t){var n=t.mesh,i=t.instancingParams.matrices.length,o=t.instancingParams.matrices,s=t.instancingParams.boxes,a=t.instancingParams.colors,d=new e.Box3,l=this.buildInstancingParameters(i,o,s,a,d),h=n.nbInstances+i;n.nbInstances=h;var c=t.mesh.mesh3js;c._instancingInfos.nbInstances=h;var u,p=c._instancingInfos.instanceAttribArrays,f=new Float32Array(h);for(u=0;u<h;u++)f[u]=5+5*u;p.instanceId.array=f,p.instanceId.isDynamic=!0;var g=p.instanceMatrix;g.array=r(g.array,l[0].data),g.isDynamic=!0;var m=p.instanceColor;m.array=r(m.array,l[1].data),m.isDynamic=!0;var S,y=t.indexesToHide;for(u=0;u<y.length;u+=2)S=3*y[u],m.array[S]=0,m.array[S+1]=0,m.array[S+2]=0;for(y=t.indexesToHideTmp,u=0;u<y.length;u+=2)S=3*y[u],m.array[S]=0,m.array[S+1]=0,m.array[S+2]=0;var v,M,L,T=t.indexesToShow,D=new e.Color;for(u=0;u<T.length;u+=2)S=3*T[u],v=T[u+1],D.setHex(v),m.array[S]=D.r,m.array[S+1]=D.g,m.array[S+2]=D.b;for(M=0;M<n._occurrences.length;M++)(L=n._occurrences[M].renderable)._instancingInfos.instanceAttribArrays.instanceId.isDynamic=!0,L._instancingInfos.instanceAttribArrays.instanceMatrix.isDynamic=!0,L._instancingInfos.instanceAttribArrays.instanceColor.isDynamic=!0},i.prototype.buildBoxMesh=function(n){if(1===n.dimension){var i,r=[new e.Vector3(0,0,0),new e.Vector3(1,0,0),new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,0),new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0),new e.Vector3(1,0,1),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(0,0,1),new e.Vector3(0,1,1),new e.Vector3(0,0,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(0,1,1),new e.Vector3(1,1,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(1,1,0)],o=[];for(i=0;i<r.length;i++)o.push(i);return t.createLineNode({points:r,drawMode:Mesh.ConnectivityTypeEnum.LINES,idx:o})}return t.createCuboidNodeFromBox3(new e.Box3(new e.Vector3(0,0,0),new e.Vector3(1,1,1)))},i.prototype.buildMaterial=function(t){var i=t.material,r=t.attributes;i||(i=1===r.dimension?new e.LineBasicMaterial({force:!0,opacity:r.opacity}):new e.MeshBasicMaterial({force:!0,opacity:r.opacity})),i._activatePDSFXMigrated("LDHInstancingPDSFX");i.setPDSFXVaryings({vLDHColor:{type:"v3"}});if(t.useDBuffer){i.defines=i.defines||{},i.defines.LDH_CORRECT_Z_FIGHT=!0;var o={depthBuffer:{type:"t2",value:t.depthBuffer}};i.setPDSFXUniforms(o),i.setPDSFXGlobalShaderCode(null,function(e){const t=e.variableHandler,i=e.functionHandler,r=e=>t.float(e),o=e=>t.vec4(e);return`\n                    \n                ${i.dF("getDepth","f",[i.prmV2("coord")])} {\n                    ${o("rgba_depth")}  = ${i.sample2DTexture((t=>e.getTextureUniform(t))("depthBuffer"),"coord")};\n                    ${r("depth")}  = ${((e,t,i)=>n.FunctionHandler.callFunction(e,t,i))("unpackRGBA","f",[i.prmV4("rgba_depth")])};\n                    if (depth > 1e-6) {\n                        return depth + DEPTH_PRECISION;\n                    }\n                    return 1.0;\n\n                }\n                ${i.dF("depthSampleTest","f",[i.prmV2("coord"),i.prmF("delta"),i.prmF("depth")])}{\n                    ${r("fDepth")}  = ${i.cF("getDepth","f",[i.prmV2("coord")])};\n                    if (fDepth < depth) {\n                        return delta;\n                    }\n                    return 0.0;\n                }\n                ${i.dF("correctZFighting","b",[])} {\n                    ${o("occlusionCLipPosition")}  = ${e.vGetClipSpacePosition()};\n                    ${(e=>t.vec2(e))("coord")}  = 0.5 + 0.5*occlusionCLipPosition.xy/occlusionCLipPosition.w;\n                    ${r("depth")}  = 0.5 + 0.5 * occlusionCLipPosition.z / occlusionCLipPosition.w;\n    \n                \n                    ${r("test")} = ${i.cF("depthSampleTest","f",[i.prmV2("coord"),i.prmF("1.0/9.0"),i.prmF("depth")])};\n                    if (test > 0.0) {\n                       return true;\n                    }\n                    return false;\n                }\n                `}),i.side=e.DoubleSide}return i.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){const n=e.variableHandler,i=e=>n.vec4(e);return`\n\t\t\t\t    ${i("localPosition")}  = ${i()}(${e.vGetAttribPosition()}, 1.0);\n\t\t\t\t    ${i("newPosition")}  = instanceMatrix*localPosition;\n\t\t\t\t    return newPosition.xyz;\n                `},ComputeVaryingValues:function(e,t){return`\n                    ${(t=>e.getVarying(t))("vLDHColor")} = instanceColor;\n                `}},{ComputeAlbedo:function(e,t){return`\n                    return ${(t=>e.getVarying(t))("vLDHColor")};\n                `},ComputeSpecularReflectance:function(e,t){const n=e.variableHandler;return`\n                    return ${(e=>n.vec3(e))()}(1.0, 1.0, 1.0);\n                `},ComputeDiscard:function(e,t){const n=e.functionHandler,i=t=>e.getVarying(t),r=e.userDefines;return`\n                    return (${i("vLDHColor")}.x == 0.0 && ${i("vLDHColor")}.y == 0.0 && ${i("vLDHColor")}.z == 0.0)\n                        ${r.LDH_CORRECT_Z_FIGHT?` || ${n.cF("correctZFighting","b",[])};`:";"}\n                `}}),i},i.prototype.buildInstancingParameters=function(t,n,i,r,o){var s,a,d,l,h,c,u,p=new Float32Array(16*t),f=new Float32Array(3*t),g=(new e.Matrix4,new e.Matrix4),m=new e.Vector3,S=new e.Matrix4,y=(new e.Matrix4,S);for(s=0;s<t;s++){for(d=n[s],c=i[s].clone(),m.set(c.max.x-c.min.x,c.max.y-c.min.y,c.max.z-c.min.z),g.makeTranslation(c.min.x,c.min.y,c.min.z),g.scale(m),S.multiplyMatrices(d,g),l=16*s,h=y.elements,a=0;a<16;a++)p[l+a]=h[a];l=3*s,u=r[s],f[l]=u.r,f[l+1]=u.g,f[l+2]=u.b}return[{data:p,type:"m4",attribName:"instanceMatrix",isFlattened:!0},{data:f,type:"v3",attribName:"instanceColor",isFlattened:!0}]},i.prototype.setUpMeshInstancingParameters=function(e,t,n,i,r,o){var s=this.buildInstancingParameters(t,n,i,r,o);e.setInstancingParameters(t,s)},new i}),define("DS/3DXMTiles/3DXMTilesUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/BufferGPUManager","DS/Visualization/Mesh3D"],function(e,t,n,i){"use strict";function r(t,n,i,r){this.center=t,this.radius=n,this.scale=i,null!==r?(this.matrixPosition=new e.Vector3,this.matrixPosition.getPositionFromMatrix(r)):this.matrixPosition=null}function o(e){this.boundingBox=e}function s(e){var t=n.mapGeomBufferSize.get(e.id);return t||(t=e.getBuffersMemorySize()),t}r.prototype.isNode3DCache=function(){return null!==this.matrixPosition},r.prototype.positionHasChanged=function(e){var t=e.elements;return t[12]!==this.matrixPosition.x||t[13]!==this.matrixPosition.y||t[14]!==this.matrixPosition.z},r.prototype.containsPoint=function(e){return this.center.distanceTo(e)<=this.radius};new e.Matrix4,new e.Vector3,new e.Vector3,new e.Matrix4;var a=e.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0}),d=new Set;return{computeScreenRadius:function(n,i,r,o,s,l,h){var c,u=n.center,p=n.radius;if(!(h||r.performFrustumCullingNoNearFar(p,u)))return-1;if(i.isOrtho)c=p/o;else{var f=i.matrixWorldInverse.elements;c=p/(o*Math.abs(f[2]*u.x+f[6]*u.y+f[10]*u.z+f[14]))}if(s&&!d.has(s)){d.add(s);var g=new e.Matrix4;g.setPosition(u);var m=t.createSphereNode({matrix:g,radius:p*l});m.setNoZ(!0),m.setMaterial(a),m.showKey=s,debugWebGLV6Viewer.getRootNode().addChild(m)}return c},computeScreenRadiusCache:function(n,i,o,s,d){var l=n?n.getMaxScaleOnAxis():1,h=o.radius*l,c=new e.Vector3;if(c.copy(o.center),n&&c.applyMatrix4(n),i&&c.applyMatrix4(i),s){var u=new e.Matrix4;u.setPosition(c);var p=t.createSphereNode({matrix:u,radius:h});p.setMaterial(a),debugWebGLV6Viewer.getRootNode().addChild(p)}return new r(c,h,l,d?n:null)},computeScreenRadiusCstComponent:function(e,t){if(e.isOrtho)return e.getCameraConstant(1,t.SCREEN_HEIGHT);var n=.5*t.SCREEN_HEIGHT;return n/=Math.tan(.5*e.fov*Math.PI/180),e.fullWidth&&(n*=e.fullWidth/e.width),n=1/n},computeDistanceToBoxCache:function(e,t){var n=t.clone();return n.applyMatrix4(e),new o(n)},computeMeshSize:function(e){var t=new Set,n=new Set,r=0;e.traverse(function(e){if(e instanceof i&&!t.has(e)){var o;t.add(e);var a=e.mesh3js.geometry;for(o=0;o<a.length;o++){var d,l,h,c=a[o];for(r+=s(c),d=0;d<c.drawingGroups.length;d++){var u;if(l=(h=c.drawingGroups[d]).material?h.material._getTextures():null)for(u=0;u<l.length;u++)l[u]&&n.add(l[u])}}}});var o=0;return n.forEach(e=>{var t=this.computeTextureSize(e);o+=t}),r+=o},computeTextureSize:function(e){let t=0,n=0;if(e.image&&e.image.width&&e.image.height&&(n=e.image.width*e.image.height*4,e.generateMipmaps&&(!e.mipmaps||0===e.mipmaps.length))){t=0;let n=e.image.width>>1,i=e.image.height>>1;for(;n>0&&i>0;)t+=n*i*4,n>>=1,i>>=1}if(e.mipmaps){let n,i;for(t=0,n=0;n<e.mipmaps.length;n++)t+=(i=e.mipmaps[n]).data?i.data.byteLength:0}return n+t}}}),define("DS/3DXMTiles/DSTilesChildLoader",[],function(){"use strict";return function(){}}),define("DS/3DXMTiles/LODSelector",["DS/Visualization/ThreeJS_DS","UWA/Class"],function(e,t){"use strict";return t.extend({init:function(){this.type=null,this.disableDowngrade=!1},setDisableDowngrade:function(e){this.disableDowngrade=!!e},getMaxLOD:function(){return 1},createJSON:function(e){return(e=e||{}).type=this.type,this.disableDowngrade&&(e.disableDowngrade=!0),e}})}),define("DS/3DXMTiles/ParsingStatus",[],function(){"use strict";class e{constructor(e){this._error=!!e,this._message=null,this._subErrors=null}copy(e){this._error=e._error,this._message=e._message,this._subErrors=e._subErrors}isOk(){return!this._error}setOk(){this._error=!1}setError(e,t,n){let i=(t?t+": ":"")+(e||"");this._error=!0,this._message=i||null,this._subErrors=n||null}}return e.isStylingAttributeName=function(e){return"string"==typeof e||e instanceof String},e.isNumberOrString=function(e){return"string"==typeof e||e instanceof String||null!==e&&isFinite(e)},e.isNumber=function(e){return null!==e&&isFinite(e)},e.error=function(t,n,i){let r=new e(!0);return r.setError(t,n,i),r},e.ok=new e(!1),e}),define("DS/3DXMTiles/OOCPath",[],function(){"use strict";var e=function(e,t){this.ids=[].concat(e),this._ldhReference=t};return e.prototype.isLeaf=function(e){var t=this.getLastId();return e.isLeaf(t)},e.prototype.isRoot=function(){return this.ids.length<=1},e.prototype.getLastId=function(){return this.ids[this.ids.length-1]},e.prototype.expandReference=function(e){var t=e.getInstRefJSON(this.getLastId());t.representation&&(this.ids.push(t.instanceId),this.ids.push(t.representation))},e.prototype.getLastInstanceId=function(){return this.ids.length>=3?this.ids[this.ids.length-2]:null},e.prototype.getParentReferenceId=function(){return this.ids.length>=3?this.ids[this.ids.length-3]:null},e.prototype.isCGR=function(){return-1!==this.ids[this.ids.length-1].indexOf(".cgr")},e.prototype.buildSubPath=function(t,n){var i=new e(this.ids,null);return i.ids.push(t),i.ids.push(n),i},e.buildFromReference=function(t,n,i,r){var o,s=null,a=-1;for(o=0;o<t._occurrences.length;o++){var d=t._occurrences[o];(i||d.viewpointTag!==r.viewpointTag&&(d._screenRadius>a||null===s))&&(a=d._screenRadius,s=d)}if(!s)return console.log("Could not find an occurrence for reference '"+t.referenceId+"'"),null;var l=[t.referenceId];n&&(s.viewpointTag=r.viewpointTag);var h=new e(l,t);return t.children.length>0&&(h.approximate=!0),h},e}),define("DS/3DXMTiles/AsyncCaller",function(){var e=null,t=[];function n(){var e,n;if(t.length>0){for(e=0;e<t.length;e++)(n=t[e])&&n.call(null);t.length=0}}return{call:function(i){t.push(i),null===e&&(e=setInterval(n,33))},multiCall:function(i){i&&(t=t.concat(i),null===e&&(e=setInterval(n,33)))}}}),define("DS/3DXMTiles/LDHReferenceUnloadStatus",[],function(){return{frozen:"frozen",unloadable:"unloadable",unloaded:"unloaded"}}),define("DS/3DXMTiles/UnloadManager",[],function(){"use strict";var e=-2,t=!!window.OOCForceExtendedMemory,n=window.performance.memory;n&&n.jsHeapSizeLimit>4e9&&(t=!0);var i={v0:{memoryLimitMb:512,memoryLimitGPUMb:512},full:{memoryLimitMb:t?512:256,memoryLimitGPUMb:t?2048:1024},medium:{memoryLimitMb:64,memoryLimitGPUMb:64},medium_plus:{memoryLimitMb:64,memoryLimitGPUMb:128},restricted:{memoryLimitMb:48,memoryLimitGPUMb:32}},r=function(t,n,r){var o;if("string"!=typeof t)o=t;else{let e="auto"===t?this.getConfig():t;o=i[e]}var s=o.memoryLimitMb,a=o.memoryLimitGPUMb;this.isRestricted="restricted"===t,this.oocManager=r,-2===e&&void 0!==window.OOCUnloadMemoryLimit&&(e=window.OOCUnloadMemoryLimit),this.config=t,this.unloadAlwaysTab=[!1,!1],this.hasUnloadAlways=!1,window.OOCUnloadAlways&&this.setUnloadAlwaysTab([!0,!0]),e>=0&&(s=e,a=e),this.memoryUsage=0,this.memoryUsageMeshInRAM=0,this.memoryUsageGPU=0,this.initialMemoryLimit=1024*s*1024,this.memoryLimit=this.initialMemoryLimit,this.meshInRAMRatio=0,this.memoryLimitMeshInRAM=0,this.memoryLimitGPU=1024*a*1024,this.usage=0,this.usageMeshInRAM=0,this.usageGPU=0,this.memoryPeak=0,this.memoryPeakGPU=0,this.flashMode=!1,this.flashUnload=!1,this.unloadThreshold=.95,this.emergencyUnloadThreshold=1.1,window.debugUnloadManager=this,this.hasMeshInRAM=!1,this.autoMeshInRAMChange=!1,this.autoMeshInRAM="auto"===n,this.meshInRAM="on"===n};return r.prototype.setHasMeshInRam=function(e){e&&!this.hasMeshInRAM&&(this.hasMeshInRAM=!0,this.meshInRAMRatio=.1,this.updateMeshInRAMLimits())},r.prototype.updateMeshInRAMLimits=function(){this.memoryLimitMeshInRAM=Math.floor(this.meshInRAMRatio*this.initialMemoryLimit),this.memoryLimit=this.initialMemoryLimit-this.memoryLimitMeshInRAM},r.prototype.setFlashMode=function(e){this.flashMode=e},r.prototype.tryToRaiseMeshInRAMLimit=function(){if(this.hasMeshInRAM&&.8*this.memoryLimitMeshInRAM<this.memoryUsageMeshInRAM){for(var e=this.meshInRAMRatio;e*this.initialMemoryLimit*.8<this.memoryUsageMeshInRAM&&(1-e)*this.initialMemoryLimit>this.memoryUsage&&e<.9;)e=1-.75*(1-e);this.meshInRAMRatio!==e&&(this.meshInRAMRatio=e,this.updateMeshInRAMLimits())}},r.prototype.restoreMemoryFromMeshInRAM=function(){var e=Math.min(this.memoryUsageMeshInRAM,this.memoryLimitMeshInRAM);0===this.memoryUsageMeshInRAM&&(this.hasMeshInRAM=!1),this.memoryLimit=this.initialMemoryLimit-e,this.memoryLimitMeshInRAM=e,this.meshInRAMRatio=this.memoryLimitMeshInRAM/this.initialMemoryLimit,this.tryToRaiseMeshInRAMLimit()},r.prototype.onReferenceMemoryDataChange=function(e,t,n){this.memoryUsage+=t.memory-e.memory,this.memoryUsageGPU+=t.memoryGPU-e.memoryGPU,(n||this.hasMeshInRAM)&&this.setHasMeshInRam(!0),this.memoryUsageMeshInRAM+=t.memoryMeshInRAM-e.memoryMeshInRAM,this.tryToRaiseMeshInRAMLimit(),this.autoMeshInRAM&&.25*this.initialMemoryLimit<this.memoryUsageMeshInRAM&&(this.autoMeshInRAM=!1,this.autoMeshInRAMChange=!0),this.updateUsage()},r.prototype.beforeLoadedNodesQueueTraversal=function(){this.flashUnload=!1,this.isUnloadNeeded()&&(this.flashUnload=!0,this.autoMeshInRAM&&(this.autoMeshInRAM=!1,this.autoMeshInRAMChange=!0))},r.prototype.afterLoadedNodesQueueTraversal=function(){this.flashUnload=!1},r.prototype.isLoadingAllowed=function(e){return this.tryToRaiseMeshInRAMLimit(),0===e?this.memoryUsageGPU<this.memoryLimitGPU&&(!this.hasMeshInRAM||this.memoryUsageMeshInRAM<this.memoryLimitMeshInRAM):this.memoryUsage<this.getMemoryLimit()},r.prototype.isUnloadSmalNodesRequired=function(){return this.memoryUsage>.9*this.getMemoryLimit()||this.memoryUsageGPU>.9*this.memoryLimitGPU||this.hasMeshInRAM&&this.memoryUsageMeshInRAM>.9*this.memoryLimitMeshInRAM},r.prototype.isEmergencyUnloadRequired=function(e,t){return 0===t?this.isEmergencyUnloadRequiredGPU(e):this.isEmergencyUnloadRequiredCPU(e)},r.prototype.isEmergencyUnloadRequiredCPU=function(e){return e=e||0,this.memoryUsage+e>=this.emergencyUnloadThreshold*this.getMemoryLimit()},r.prototype.isEmergencyUnloadRequiredGPU=function(e){e=e||0;var t=this.memoryUsageGPU+e>=this.emergencyUnloadThreshold*this.memoryLimitGPU;return this.hasMeshInRAM&&(t=t||this.memoryUsageMeshInRAM+e>=this.emergencyUnloadThreshold*this.memoryLimitMeshInRAM),t},r.prototype.isUnloadNeeded=function(e){return!!this.flashUnload||(void 0===e?this.isUnloadNeeded(0)||this.isUnloadNeeded(1):!!this.unloadAlwaysTab[e]||(this.tryToRaiseMeshInRAMLimit(),0===e?this.memoryUsageGPU>.8*this.memoryLimitGPU||this.hasMeshInRAM&&this.memoryUsageMeshInRAM>.8*this.memoryLimitMeshInRAM:this.memoryUsage>.8*this.getMemoryLimit()))},r.prototype.updateUsage=function(){this.usage=100*this.memoryUsage/this.getMemoryLimit(),this.usageGPU=100*this.memoryUsageGPU/this.memoryLimitGPU,this.usageMeshInRAM=100*this.memoryUsageMeshInRAM/this.memoryLimitMeshInRAM,this.memoryPeak=this.memoryUsage>this.memoryPeak?this.memoryUsage:this.memoryPeak,this.memoryPeakGPU=this.memoryUsageGPU>this.memoryPeakGPU?this.memoryUsageGPU:this.memoryPeakGPU},r.prototype.setUnloadAlwaysTab=function(e){this.unloadAlwaysTab=e,this.hasUnloadAlways=e[0]||e[1]},r.prototype.wouldDownloadCauseEmergencyUnload=function(e,t){if(0===t.type&&this.isRestricted){var n=t.getMemorizedReferenceSize(e);return n>=0&&this.isEmergencyUnloadRequired(n,0)}return!1},r.prototype.restoreAutoMeshInRAM=function(){this.autoMeshInRAM=!0,this.autoMeshInRAMChange=!1},r.prototype.getMemoryLimit=function(){return this.oocManager.getUsePickingAccelerationStructure()?this.memoryLimit-.05*this.memoryUsageGPU:this.memoryLimit},r.prototype.getConfig=function(){var e="full";return navigator.userAgent.match(/iPad/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1?e="medium":navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)&&(e="restricted"),e},r}),define("DS/3DXMTiles/UpdateNodeContentData",[],function(){"use strict";return class{constructor(e,t,n,i){this.node=e,this.content=t,this.updateVersion=n,this.onUpdatedCB=i}isStillValid(){return this.updateVersion===this.content.updatedContentVersion}}}),define("DS/3DXMTiles/MemoryBudgetManager",[],function(){"use strict";var e=function(e){this.budgets=new Map,this.alwaysUnload=!!window.OOCUnloadAlways,this.physicalLimits={cpu:e.initialMemoryLimit,gpu:e.memoryLimitGPU}};function t(e){this.name=e.name,this.memoryBudgetManager=e.memoryBudgetManager,this.physicalBudget=e.physicalBudget,this.currentLimit=0,this.theoreticalLimit=0,this.usage=0,this.active=!1,this.unloadFactor=e.unloadFactor||1,this.maxLimit=e.maxLimit||1/0,this.limitTarget=0,this.weight=e.weight||1,this.unloading=!1}return e.prototype.createBudget=function({name:e,physicalBudget:n,params:i}){var r=new t({name:e,memoryBudgetManager:this,physicalBudget:n,maxLimit:(i=i||{}).maxLimit,weight:i.weight,unloadFactor:i.unloadFactor});return this.budgets.set(e,r),r},e.prototype.getBudget=function(e){return this.budgets.get(e)||null},e.prototype.updateLimits=function(){var e={cpu:0,gpu:0},t={cpu:0,gpu:0};this.budgets.forEach((n,i)=>{if(n.active){var r=n.physicalBudget;e[r]+=n.weight,t[r]+=n.usage}});var n={cpu:this.physicalLimits.cpu-t.cpu,gpu:this.physicalLimits.gpu-t.gpu},i=!1,r={cpu:0,gpu:0};this.budgets.forEach((t,o)=>{if(t.active){var s=t.physicalBudget;t.theoreticalLimit=t.weight*t.memoryBudgetManager.physicalLimits[s]/e[s],t.currentLimit=n[s]<=0?t.theoreticalLimit:t.usage+t.weight*n[s]/e[s],t.currentLimit>t.maxLimit&&(i=!0,r[s]+=t.currentLimit-t.maxLimit,t.currentLimit=t.maxLimit)}else t.theoreticalLimit=0,t.currentLimit=0});for(var o={cpu:0,gpu:0};i;)e.cpu=0,e.gpu=0,o.cpu=r.cpu,o.gpu=r.gpu,r.cpu=0,r.gpu=0,i=!1,this.budgets.forEach((t,n)=>{if(t.active&&t.currentLimit!==t.maxLimit){var i=t.physicalBudget;e[i]+=t.weight}}),this.budgets.forEach((t,n)=>{if(t.active&&t.currentLimit!==t.maxLimit){var s=t.physicalBudget;t.currentLimit+=o[s]*t.weight/e[s],t.currentLimit>t.maxLimit&&(i=!0,r[s]+=t.currentLimit-t.maxLimit,t.currentLimit=t.maxLimit)}})},e.prototype.startUnload=function(){var e=!1,t=!1;this.budgets.forEach((e,n)=>{e.usage>=this.currentLimit&&(t=!0)}),t&&this.updateLimits();var n={cpu:!1,gpu:!1};return this.budgets.forEach((t,i)=>{t.active&&(t.isUnloadNeeded()||this.alwaysUnload)&&(e=!0,n[t.physicalBudget]=!0)}),this.budgets.forEach((e,t)=>{e.unloading=n[e.physicalBudget]}),e},e.prototype.endUnload=function(){this.budgets.forEach((e,t)=>{e.unloading=!1})},e.prototype.isLoadingAllowed=function(){var e=!0;return this.budgets.forEach((t,n)=>{t.isLoadingAllowed()||(e=!1)}),e},e.prototype.getMemoryUsageGPU=function(){var e=0;return this.budgets.forEach((t,n)=>{"gpu"===t.physicalBudget&&(e+=t.usage)}),e},t.prototype.updateUsage=function(e,t){this.active=!0,this.usage+=t-e},t.prototype.updateUsageDelta=function(e){this.active=!0,this.usage+=e},t.prototype.isLoadingAllowed=function(){return this.usage<=this.currentLimit||(this.active=!0,this.memoryBudgetManager.updateLimits(),this.usage<this.currentLimit)},t.prototype.isUnloadNeeded=function(){return 1!=this.unloadFactor&&this.usage>=this.unloadFactor*this.memoryBudgetManager.physicalLimits[this.physicalBudget]||!this.isLoadingAllowed()},e}),define("DS/3DXMTiles/DSTilesNodeReplaceStatus",[],function(){"use strict";return{onHold:"onHold",commited:"commited",uncommited:"uncommited",reloadParent:"reloadParent"}}),define("DS/3DXMTiles/DSTilesScoreComputer",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(){this.tmpBoundingBox=new e.Box3};return t.prototype.getSortingMetric=function(){throw new Error("unimplemented")},t}),define("DS/3DXMTiles/DSTilesRootEntry",[],function(){"use strict";return function(e){this.node=e.node}}),define("DS/3DXMTiles/PriorityQueue",[],function(){"use strict";var e=function(){this.reset()};e.prototype.reset=function(){this.tileNode=null,this.parent=null,this.less=null,this.more=null},e.prototype.check=function(){var e=[];!function t(n){e.indexOf(n)>-1?console.log("argl"):(e.push(n),n.less&&t(n.less),n.more&&t(n.more))}(this)},e.prototype.checkMinMax=function(e,t){var n=!0;return this.tileNode&&(this.tileNode.getScore()<e||this.tileNode.getScore()>t)&&(console.log("ERRRRRRRRRRREUUUUUUR"),n=!1),this.less&&!this.less.checkMinMax(e,t)&&(n=!1),this.more&&!this.more.checkMinMax(e,t)&&(n=!1),n},e.prototype.removeMin=function(e){var t=this.less;null!==t&&(null===t.less?(this.less=t.more,null!==this.less&&(this.less.parent=this),e.releaseHeapNode(t)):t.removeMin(e))},e.prototype.removeMax=function(e){var t=this.more;null!==t&&(null===t.more?(this.more=t.less,null!==this.more&&(this.more.parent=this),e.releaseHeapNode(t)):t.removeMax(e))},e.prototype.insert=function(e){e.tileNode.getScore()<this.tileNode.getScore()?null!==this.less?this.less.insert(e):(this.less=e,e.parent=this):null!==this.more?this.more.insert(e):(this.more=e,e.parent=this)},e.prototype.getMin=function(){return null===this.less?this:this.less.getMin()},e.prototype.getMax=function(){return null===this.more?this:this.more.getMax()},e.prototype.getTileNodes=function(e){null!==this.tileNode&&e.push(this.tileNode),this.more&&this.more.getTileNodes(e),this.less&&this.less.getTileNodes(e)};var t=function(e){this.size=0,this.sizeLimit=e,this.root=null,this.firstFreeHeapNode=null,this.minHeapValue=-1/0,this.maxHeapValue=1/0};t.prototype.getTileNodes=function(){var e=[];return null!==this.root&&this.root.getTileNodes(e),e},t.prototype.tryToInsertTileNodeMax=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.minHeapValue<e.getScore()){this.insert(e),t.min=null;var i=this.root.getMin();return this.minHeapValue=i.tileNode.getScore(),!0}return!1}if(this.minHeapValue<e.getScore()){i=this.root.getMin();t.min=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMin(this):this.setRoot(i.more),this.size--;var r=this.root.getMin();return this.minHeapValue=r.tileNode.getScore(),!0}return!1},t.prototype.tryToInsertTileNodeMin=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.maxHeapValue>e.getScore()){this.insert(e),t.max=null;var i=this.root.getMax();return this.maxHeapValue=i.tileNode.getScore(),!0}return!1}if(this.maxHeapValue>e.getScore()){i=this.root.getMax();t.max=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMax(this):this.setRoot(i.less),this.size--;var r=this.root.getMax();return this.maxHeapValue=r.tileNode.getScore(),!0}return!1},t.prototype.setRoot=function(e){null!==this.root&&this.releaseHeapNode(this.root),this.root=e,null!==e&&(e.parent=null)},t.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax(),t=e.tileNode;return this.removeMaxHeapNode(e),t},t.prototype.removeMaxHeapNode=function(e){null!==e.parent?e.parent.removeMax(this):this.setRoot(e.less),this.size--},t.prototype.removeMinHeapNode=function(e){null!==e.parent?e.parent.removeMin(this):this.setRoot(e.more),this.size--},t.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin(),t=e.tileNode;return this.removeMinHeapNode(e),t},t.prototype.getMinHeapNode=function(){return null!==this.root?this.root.getMin():null},t.prototype.getMaxHeapNode=function(){return null!==this.root?this.root.getMax():null},t.prototype.insert=function(e){var t=this.getHeapNode(e);null===this.root?this.setRoot(t):this.root.insert(t),this.size++},t.prototype.getHeapNode=function(t){var n;return this.firstFreeHeapNode?(n=this.firstFreeHeapNode,this.firstFreeHeapNode=n.more,n.reset()):n=new e,n.tileNode=t,n},t.prototype.releaseHeapNode=function(e,t){e.less=null,t&&t(e.tileNode),e.tileNode=null,e.more=this.firstFreeHeapNode,this.firstFreeHeapNode=e},t.prototype.releaseHeapNodeTree=function(e,t,n){null!==e.less&&(this.releaseHeapNodeTree(e.less,t+1,n),e.less=null),null!==e.more&&(this.releaseHeapNodeTree(e.more,t+1,n),e.more=null),this.releaseHeapNode(e,n)},t.prototype.reset=function(e){null!==this.root&&(this.releaseHeapNodeTree(this.root,0,e),this.root=null,this.minHeapValue=-1/0),this.size=0};var n=0,i=function(e){this.id=n++,this.nodeList=[],this.nbProcessedNodes=0,this.nodeListLength=0,this.listWasUpdated=!1,this.maxHeapNode=null,this.minHeapNode=null,this.negativeNodes=[],this.heap=new t(e||100)};i.prototype.fillHeapMax=function(e){var t,n,i,r={min:null},o=this.nodeListLength,a=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):a.tryToInsertTileNodeMax(t,r,0!==l)&&(n=r.min,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;s(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},i.prototype.fillHeapMin=function(e){var t,n,i,r={max:null},o=this.nodeListLength,a=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):a.tryToInsertTileNodeMin(t,r,0!==l)&&(n=r.max,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;s(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},i.prototype.getMaxNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var e,t=this.nodeListLength,n=-1,i=-1/0,r=null,o=0;for(e=0;e<t;e++)null!==(r=this.nodeList[e])&&r.isAlive()?r.getScore()>i&&(n=e,i=r.getScore()):o++;return n>-1?(r=this.nodeList[n],this.nodeList[n]=null):r=null,o>=this.nodeListLength?this.nodeListLength=0:o>200&&this.cleanNulls(!1),r},i.prototype.peekMaxNode=function(){if(!this.maxHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0?e=this.heap.root.getMax():this.negativeNodes.length>0&&(e=this.negativeNodes[this.negativeNodes.length-1]),this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null},i.prototype.peekMinNode=function(){if(!this.minHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0&&(e=this.heap.root.getMin()),this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null},i.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)},i.prototype.getMaxNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.heap.size>0?t=e?this.heap.getAndRemoveMaxTileNode():this.heap.getMaxNode():this.negativeNodes.length>0&&(t=this.negativeNodes.pop()),t},i.prototype.getMinNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.negativeNodes.length>0?t=this.negativeNodes.pop():this.heap.size>0&&(t=e?this.heap.getAndRemoveMinTileNode():this.heap.getMinNode()),t},i.prototype.checkIntegrity=function(e){var t,n=-1/0,i=1/0;if(this.heap.size>0)for(n=this.heap.root.getMin().tileNode.getScore(),i=this.heap.root.getMax().tileNode.getScore(),this.heap.root.checkMinMax(n,i)||console.log("checkMinMax has failed!!!"),t=0;t<(void 0!==e?e:this.nodeListLength);t++)this.nodeList[t]&&this.nodeList[t].getScore()>n&&console.log("found probleme!!!")},i.prototype.getMinNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var e,t=this.nodeListLength,n=-1,i=1/0,r=null,o=0;for(e=0;e<t;e++)null!==(r=this.nodeList[e])&&r.isAlive()?r.getScore()<i&&(n=e,i=r.getScore()):o++;return n>-1?(r=this.nodeList[n],this.nodeList[n]=null):r=null,o>=this.nodeListLength?this.nodeListLength=0:o>200&&this.cleanNulls(!1),r},i.prototype.cleanNulls=function(e){var t,n=this.nodeListLength,i=null,r=0;for(t=0;t<n;t++)null!==(i=this.nodeList[t])&&i.isAlive()?(this.nodeList[r]=i,r++):e&&t<this.nbProcessedNodes&&this.nbProcessedNodes--;this.nodeListLength=r,this.nodeList.length=this.nodeListLength},i.prototype.isEmpty=function(){return 0===this.heap.size&&0===this.nodeListLength&&0===this.negativeNodes.length},i.prototype.clear=function(e){var t;if(this.heap.reset(e),e)for(t=0;t<this.nodeListLength;t++)this.nodeList[t]&&e(this.nodeList[t]);this.nodeListLength=0,this.nbProcessedNodes=0,this.maxHeapNode=null,this.minHeapNode=null},i.prototype.resetOrder=function(e){var t,n=this.heap.getTileNodes();for(this.heap.reset(),t=0;t<n.length;t++)this.addNode(n[t]);for(t=0;t<this.negativeNodes.length;t++)this.addNode(this.negativeNodes[t]);if(this.negativeNodes.length=0,e){var i,r=0;for(t=0;t<this.nodeListLength;t++)(i=this.nodeList[t])&&e(i)&&(this.nodeList[r]=i,r++);this.nodeListLength=r}};var r=0;function o(e,t){var n,i=(n=r+=1831565813,n=Math.imul(n^n>>>15,1|n),(((n^=n+Math.imul(n^n>>>7,61|n))^n>>>14)>>>0)%(t-e)),o=e+(i=i<0?i+(t-e):i);return isFinite(o)?o:-1}function s(e,t,n,i){let r;for(r=0;r<t.length;r++){let s=t[r],a=o(n,i),d=e[s];a!==s&&a>=0&&(e[s]=e[a],e[a]=d)}}return i.prototype.addNode=function(e,t){this.nodeListLength>=this.nodeList.length?(this.nodeList.push(null),this.nodeListLength=this.nodeList.length):this.nodeList[this.nodeListLength++]=null,t?this.nodeList[this.nodeListLength-1]=e:function(e,t,n,i){if(i<=1)e[i-1]=t;else{var r=o(n,i);r<0&&(r=i-1),r>=i-1?e[i-1]=t:(e[i-1]=e[r],e[r]=t)}}(this.nodeList,e,this.nbProcessedNodes,this.nodeListLength),this.listWasUpdated=!0},i.prototype.peekMinHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMinHeapNode()},i.prototype.peekMaxHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMaxHeapNode()},i.prototype.traverseMin=function(e){var t,n,i;for((0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),t=this.negativeNodes.length-1;t>=0;t--){if(!e(this.negativeNodes[t]))return;this.negativeNodes.length--}do{i=!0,null!==(n=this.peekMinHeapNode())&&e(n.tileNode)&&(this.heap.removeMinHeapNode(n),i=!1)}while(!i)},i.prototype.traverseMinPlus=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t,n,i,r,o,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,r=this.negativeNodes.length-1;r>=0&&!n;r--)o=this.negativeNodes[r],i=!1,n=!1,e(o,d,a),this.negativeNodes.length--,i&&s.push(o);for(;!n;)n=!1,i=!1,null!==(t=this.peekMinHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):n=!0;for(r=0;r<s.length;r++)this.addNode(s[r],!1)},i.prototype.traverseMax=function(e){var t,n;do{n=!0,null!==(t=this.peekMaxHeapNode())&&e(t.tileNode)&&(this.heap.removeMaxHeapNode(t),n=!1)}while(!n)},i.prototype.traverseMaxPlus=function(e){var t,n,i,r,o=[],s=!1;function a(){i=!0}function d(){n=!0}do{n=!1,i=!1,null!==(t=this.peekMaxHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&o.push(t.tileNode),this.heap.removeMaxHeapNode(t))):s=!0}while(!n&&!s);for(r=this.negativeNodes.length-1;r>=0&&!n;r--){let t=this.negativeNodes[r];i=!1,n=!1,e(t,d,a),this.negativeNodes.length--,i&&o.push(t)}for(r=0;r<o.length;r++)this.addNode(o[r],!1)},i.prototype.removeNode=function(e){var t;for(this.resetOrder(),t=0;t<this.nodeListLength;t++)this.nodeList[t]===e&&(this.nodeList[t]=null)},i.prototype.getAllNodes=function(){var e,t,n=[];for(t=0;t<this.nodeListLength;t++)(e=this.nodeList[t])&&n.push(e);var i=this.heap.getTileNodes();return n.concat(i)},i.prototype.getMaxNodes=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getTileNodes()},i.prototype.getSize=function(){return this.cleanNulls(),this.nodeListLength+this.heap.size},i}),define("DS/3DXMTiles/OOCInstanceIterator",[],function(){"use strict";var e=function(e,t){this._referenceIterator=e,this._childData=t};return e.prototype.getReferenceIterator=function(){return this._referenceIterator},e.prototype.getInstanceId=function(){return this._childData.instanceId},e.prototype.getMatrix=function(){var e=this._childData.matrix;return e&&e.clone()},e.prototype.getNode=function(){return this._childData.node},e}),define("DS/3DXMTiles/Debug3DXMTiles",[],function(){var e=-1;return window.OOCGetProbes=function(){var e=-1,t=[];return measures=window.top.performance.getEntriesByType("measure"),measures=measures.concat(window.top.performance.getEntriesByType("mark")),measures.forEach(function(n){-1===e&&(e=n.startTime),"measure"===n.entryType?t.push({name:n.name,duration:n.duration,startTime:n.startTime-e,entryType:n.entryType}):t.push({name:n.name,startTime:n.startTime-e,entryType:n.entryType})}),t},{setSceneGraphMode:function(e){if("flat"===e)this.sceneGraphMode=0;else{if("dual"!==e)throw new Error("Unknown mode");this.sceneGraphMode=1}},sceneGraphMode:1,configs:{1:{modelDir:"../airbus/assets/airbusnew4/",instrefDir:"../airbus/assets/instref2/",assetsDir:"../airbus/assets/",toReplace:[],root:"XWB-A350-900-RR.instref"},2:{modelDir:"../airbus2/assets/3DXM/",instrefDir:"../airbus2/assets/InstRef/",assetsDir:"../airbus2/assets/",toReplace:["../airbus2/assets/NewCGRs/"],root:"XWB-A350-900-RR.instref"},3:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],root:"A350.instref"},4:{modelDir:"../airbus3/CGR/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/"],root:"A350.instref",cgr:!0},5:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],toReplaceAV1:"../airbus3/3dxm/",root:"A350.instref"}},probePrefix:"WebVisuOOC_",probeMap:new Map,probeIndex:0,startProbe:function(t){if(-1===e&&(e=window.OOCProbes?1:0),1===e){var n=this.probePrefix+t+"_"+this.probeIndex;this.probeIndex++,this.probeMap.set(t,n),window.top.performance.mark(n+"_begin")}},endProbe:function(t){if(1===e){var n=this.probeMap.get(t);this.probeMap.delete(t);var i=n+"_end";window.top.performance.mark(i);var r=n+"_begin";window.top.performance.measure(this.probePrefix+t,r,i)}}}}),define("DS/3DXMTiles/DSTilesConstantScoreComputer",[],function(){"use strict";var e=function(e){this.score=e.score||0,this.pixelError=e.pixelError||0};return e.prototype.computeScore=function(e,t,n){e.score=this.score,n&&(e.pixelError=this.pixelError)},e}),define("DS/3DXMTiles/LDHStats",[],function(){"use strict";var e={startNbLoadedModels:0,nbLoadedModels:0,startTime:0,nbBatches:0,bytesLoaded:0,history:[],occlusion:0,batchSize:0,flags:[],firstLoadTime:-1,endLoadingTime:-1,tts:-1,ttsTime:-1,onStartCGRLoading:function(){-1===this.firstLoadTime&&(this.firstLoadTime=Date.now())},init:function(){var e=window.localStorage.getItem("TileModelPreloadData");if(this.tts=-1,e){var t=JSON.parse(e);t.tts&&(this.tts=parseInt(t.tts))}0===this.startTime&&(this.startTime=Date.now(),this.history.push({time:this.startTime,nbLoadedModels:0,bytesLoaded:0}))},onNewViewpoint:function(){this.startNbLoadedModels=this.nbLoadedModels,this.firstLoadTime=-1,this.endLoadingTime=-1,this.ttsTime=-1},onEndLoading:function(){this.endLoadingTime=Date.now()},addFlag:function(e){this.flags.push(e)},onOcclusion:function(){this.occlusion++},computeInstantStats:function(){var e,t=Date.now(),n=0;for(e=0;e<this.history.length;e++)t-this.history[e].time>2e3&&(n=e);n>0&&this.history.splice(0,n);var i=this.history[0],r={mps:1e3*(this.nbLoadedModels-this.startNbLoadedModels)/(t-this.startTime),imps:(this.nbLoadedModels-i.nbLoadedModels)/(t-i.time)*1e3,batches:this.nbBatches,batchSize:this.nbBatches>0?this.batchSize/this.nbBatches:0,mbps:8e3*(this.bytesLoaded-i.bytesLoaded)/(1048576*(t-i.time)),occlusion:this.occlusion,flags:this.flags,modelLoadingTime:-1!==this.startLoadTime&&-1!==this.endLoadingTime?(this.endLoadingTime-this.firstLoadTime)/1e3:-1,ttsTime:this.ttsTime,firstLoadTime:this.firstLoadTime};return this.history.push({time:t,nbLoadedModels:this.nbLoadedModels,bytesLoaded:this.bytesLoaded}),r},onLoadedModel:function(e){e&&(this.bytesLoaded+=e),this.nbLoadedModels++,this.nbLoadedModels-this.startNbLoadedModels>=this.tts&&this.ttsTime<0&&(this.ttsTime=Date.now())},onStartBatch:function(e){this.nbBatches++,this.batchSize+=e},onEndBatch:function(e){this.nbBatches--,this.batchSize-=e}};return window.modelLoaderPoolStats=e,e}),define("DS/3DXMTiles/DSTilesSourceIdWithParams",[],function(){"use strict";return class{constructor(e,t){this.sourceId=e||null,this.params=t||null}}}),define("DS/3DXMTiles/PointCloudServices",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={parseBigInt:function(e){var t;try{t=BigInt("0xFFFFFFFFFFFFFFFF")}catch{t=JSBI.BigInt("0xFFFFFFFFFFFFFFFF")}return t},createTileContentFromBuffer:function(e,n){let i=new DataView(e);const r=new Uint8Array(e);let o=0,s=t.oldUnstream?i.getUint32(o):i.getUint32(o,!0);if(o+=4,2===s){let t=i.getUint32(o,!0);o+=4;const a=new TextDecoder("utf-8"),d=JSON.parse(a.decode(r.subarray(o,o+t)));o+=t;let l=i.getUint32(o,!0);o+=4;let h=i.getFloat32(o,!0);o+=4;let c,u=0;for(let e of d)u+=e.size;let p={buffer:c=o%4==0?r.subarray(o,o+l*u):new Uint8Array(e.slice(o,o+l*u)),attributes:[],points:l,spacing:h};for(let e of d)"DEF_POSITION"===e.name?p.attributes.push(this._buildPosition(e,u)):"DEF_COLOR"===e.name?p.attributes.push(this._buildColor(e,u)):this.pushStylingAttribute(p,e,u,n);return{version:s,geometry:p}}return null},_buildPosition:function(e,t){return{name:"position",offset:e.offset,size:e.size,count:3,stride:t}},_buildColor:function(e,t){return{name:"color",offset:e.offset,size:e.size,count:4,stride:t}},pushStylingAttribute:function(e,t,n,i){let r=i.get(t.name);if(r){let i=r.type;"integer"!==i&&"float"!==i||e.attributes.push({name:t.name,offset:t.offset,size:t.size,count:1,stride:n})}}};return t.bigIntZero=t.parseBigInt("0"),t.oldUnstream=!1,t}),define("DS/3DXMTiles/DSTilesNodeMemorySize",[],function(){"use strict";return function(e,t){this.memory=e||0,this.memoryGPU=t||0,this.memoryMeshInRAM=0}}),define("DS/3DXMTiles/ModelBank",["DS/QualityManager/QMController"],function(e){"use strict";var t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,n=function(){this.timeLimitDays=7,this.refreshTimeDays=1,this.debugData=window.ModelBank_debug_init,this.db=null,this.nbTickets=100,this.queue=[],this.referenceSet=new Set,this.metaMap=new Map,this.maxSize=0,this.size=0,this.initComplete=!1,this.nbTransactions=0,this.nbStartedTransactions=0,this.clearRequest=!1,this.initNeeded=!0};n.prototype.init=function(){if(this.initNeeded){this.initNeeded=!1;var n=this;this.maxSize=1024*e.getLocalCacheSize()*1024,this.debugData&&(void 0!==this.debugData.timeLimitDays&&(this.timeLimitDays=this.debugData.timeLimitDays),void 0!==this.debugData.refreshTimeDays&&(this.refreshTimeDays=this.debugData.refreshTimeDays),void 0!==this.debugData.maxSize&&(this.maxSize=this.debugData.maxSize));var i=t.open("modelsDBLocal",2);let r=0;i.onerror=function(e){console.log("error creating/accessing models database"),t.deleteDatabase("modelsDBLocal"),n.initComplete=!0},i.onsuccess=function(e){n.db=i.result;var t=n.db.transaction(["models","meta"],"readonly");t.objectStore("models").getAllKeys().onsuccess=function(e){var t;if(e.target.result)for(t=0;t<e.target.result.length;t++)n.referenceSet.add(e.target.result[t]);2===++r&&(n.initComplete=!0)},t.objectStore("meta").openCursor().onsuccess=function(e){var t,i=e.target.result;i?(void 0!==i.key&&(t=i.value,n.metaMap.set(i.key,t),n.size+=t.size||0),i.continue()):(n.debugData&&n.debugData.beforeCheckSizeCB&&n.debugData.beforeCheckSizeCB(n),n.removeOldData(),n.checkSize(),2===++r&&(n.initComplete=!0)),n.clearRequest&&(n.clear(),n.clearRequest=!1)},t.onerror=(()=>{this.initComplete=!0}),n.db.onerror=n.onDbError.bind(n)},i.onupgradeneeded=function(e){var t,n;t=e.target.result,n=e.oldVersion,console.log("Updating objectstore"),n<1&&t.createObjectStore("models"),n<2&&t.createObjectStore("meta")}}},n.prototype.onDbError=function(e){console.log("Db error")},n.prototype.removeOldData=function(){window.ModelBank_debug_init&&(window.ModelBank_debug_init.referenceSetSize=this.referenceSet.size,window.ModelBank_debug_init.metaMapSize=this.metaMap.size);var e=[],t=Date.now()-24*this.timeLimitDays*60*60*1e3;this.metaMap.forEach(function(n,i,r){n.time<t&&e.push(i)}),this.removeKeys(e)},n.prototype.removeKeys=function(e){if(e.length>0){var t,n,i,r,o=this.db.transaction(["models","meta"],"readwrite");for(n=0;n<e.length;n++)i=e[n],(t=this.metaMap.get(i))&&(this.size-=t.size),this.referenceSet.delete(i),this.metaMap.delete(i),o.objectStore("models").delete(i),r=o.objectStore("meta").delete(i),this.debugData&&this.debugData.onRemoveKeysCB&&(r.onsuccess=this.debugData.onRemoveKeysCB.bind(null,this))}},n.prototype.buildKey=function(e,t,n){return e+t.substring(7)+"@"+n},n.prototype.storeModelData=function(e,t,n,i,r){if(this.db){for(var o=this.db.transaction(["models","meta"],"readwrite"),s=0;s<e.length;++s){var a=t[s],d=e[s],l=this.buildKey(d,a,n);if(!this.referenceSet.has(l)){var h={time:Date.now(),wms:r[s],size:i[s].byteLength};try{o.objectStore("models").put(i[s],l),o.objectStore("meta").put(h,l),this.referenceSet.add(l),this.metaMap.set(l,h)}catch(e){}}}this.nbTransactions++,this.nbStartedTransactions++,o.oncomplete=(()=>{this.nbTransactions--})}},n.prototype.retrieveModelData=function(e,t,n,r,o,s){var a,d,l,h=[];if(!this.db)for(a=0;a<e.length;a++)setTimeout(s.bind(null,e[a]),0);var c=Date.now()-24*this.refreshTimeDays*60*60*1e3;for(a=0;a<e.length;++a){var u=e[a],p=e[a].referenceId;l=this.buildKey(p,t[a],n),(d=this.metaMap.get(l)).time<c&&h.push(l)}var f=0===h.length?this.db.transaction(["models"],"readonly"):this.db.transaction(["models","meta"],"readwrite");for(a=0;a<e.length;++a){u=e[a],p=e[a].referenceId;l=this.buildKey(p,t[a],n);var g=f.objectStore("models").get(l);g.onsuccess=function(e,t){return function(n){var i=n.target.result;r.onModelBankData(e,o,s,i||null,t)}}(u,l),g.onerror=function(e,t){return function(){i.removeKeys([t])}}(0,l)}var m=Date.now();for(a=0;a<h.length;a++)l=h[a],(d=this.metaMap.get(l))&&(d.time=m,f.objectStore("meta").put(d,l))},n.prototype.hasModelData=function(e,t,n,i){var r=this.buildKey(e,t,n),o=!1;if(this.referenceSet.has(r)){var s=this.metaMap.get(r);if(i&&s&&s.wms===i&&(o=!0),!o){this.referenceSet.delete(r),this.metaMap.delete(r);var a=this.db.transaction(["models","meta"],"readwrite");a.objectStore("models").delete(r),a.objectStore("meta").delete(r)}}return o},n.prototype.clear=function(){if(this.db){var e=this.db.transaction(["models","meta"],"readwrite");e.objectStore("models").clear(),e.objectStore("meta").clear(),this.referenceSet.clear(),this.metaMap.clear()}else this.clearRequest=!0},n.prototype.checkSize=function(){if(this.maxSize>=0&&this.size>this.maxSize){var e=Array.from(this.metaMap);e.sort(function(e,t){return e[1].time-t[1].time});var t,n=.8*this.maxSize,i=this.size,r=[];for(t=0;t<e.length&&i>n;t++)i-=e[t][1].size||0,r.push(e[t][0]);this.removeKeys(r)}},n.prototype.hasTileData=function(e,t){var n=e,i=!1;if(this.referenceSet.has(n)){var r=this.metaMap.get(n);if(t&&r&&r.wms===t&&(i=!0),!i){this.referenceSet.delete(n),this.metaMap.delete(n);var o=this.db.transaction(["models","meta"],"readwrite");o.objectStore("models").delete(n),o.objectStore("meta").delete(n)}}return i},n.prototype.retrieveTileData=function(e,t,n){var r,o,s,a=[];if(this.db){var d=Date.now()-24*this.refreshTimeDays*60*60*1e3;for(r=0;r<e.length;++r)s=e[r],(o=this.metaMap.get(s)).time<d&&a.push(s);var l=0===a.length?this.db.transaction(["models"],"readonly"):this.db.transaction(["models","meta"],"readwrite");for(r=0;r<e.length;++r){s=e[r];var h=l.objectStore("models").get(s);h.onsuccess=function(e,n){return function(n){var i=n.target.result;t(e,i)}}(r),h.onerror=function(e,t){return function(){i.removeKeys([t]),n(e)}}(r,s)}var c=Date.now();for(r=0;r<a.length;r++)s=a[r],(o=this.metaMap.get(s))&&(o.time=c,l.objectStore("meta").put(o,s))}else for(r=0;r<e.length;r++)setTimeout(n.bind(null,e[r]),0)},n.prototype.storeTileData=function(e,t,n){if(this.db){for(var i=this.db.transaction(["models","meta"],"readwrite"),r=0;r<e.length;++r){var o=e[r],s={time:Date.now(),wms:n[r],size:t[r].byteLength};i.objectStore("models").put(t[r],o),i.objectStore("meta").put(s,o),this.referenceSet.add(o),this.metaMap.set(o,s)}this.nbTransactions++,this.nbStartedTransactions++,i.oncomplete=(()=>{this.nbTransactions--})}};var i=new n;return i}),define("DS/3DXMTiles/DSTilesNodeStatus",[],function(){"use strict";return{waiting:"waiting",toLoad:"toLoad",loading:"loading",loaded:"loaded",error:"error",dead:"dead"}}),define("DS/3DXMTiles/ModelLoaderSingleton",["DS/Visualization/ModelLoader","DS/VisuLoaders/ThreeDXLoader"],function(e,t){"use strict";var n=function(){this.nbLoading=0,this.maxNbLoading=1,this.modelLoader=null,this.threeDXLoader=null,this.reuseMap=new i};n.prototype.isReady=function(){return this.nbLoading<this.maxNbLoading},n.prototype.loadFromBuffer=function(e,t,n,i,r,o,s,a){if(null!==e)switch((n=n||"cgr").toLowerCase()){case"3dxc":return this.load3DX.apply(this,arguments);default:return this.loadGeneric.apply(this,arguments)}else setTimeout(i,0)},n.prototype.createModelLoader=function(){var t=new e;return t.setKeepLoaderMode(!0),t.sharedBuffers=!1,t},n.prototype.createThreeDXLoader=function(){return new t},n.prototype.load3DX=function(e,t,n,i,r,o,s,a){var d=this.threeDXLoader;d||(d=this.createThreeDXLoader(),this.threeDXLoader=d),this.nbLoading++;var l=!1,h=!1;let c=()=>{o&&this.reuseMap.registerData(s,a.getUri(s.sourceId),t.children),i()};d.load({arrayBuffer:e,destinationNode:t,zipped:!1,concat:!0,doneCallback:e=>{h=!0,(0===e.nbTextures||l)&&(this.nbLoading--,c())},onTexturesLoadedCallback:e=>{l=!0,h&&(this.nbLoading--,c())},errorCallback:()=>{this.nbLoading--,o&&this.reuseMap.onError(s,a.getUri(s.sourceId)),r()}})},n.prototype.loadGeneric=function(e,t,n,i,r,o,s,a){var d=this.modelLoader;d||(d=this.createModelLoader(),this.modelLoader=d),this.nbLoading++,d.setSceneGraph(t),d.setFileType(n);var l=this;d.setOnLoadedProductStructureCallback(e=>{l.nbLoading--,d.setTargetNode(null),o&&this.reuseMap.registerData(s,a.getUri(s.sourceId),t.children),i()}),d.setOnErrorCallback(function(){l.nbLoading--,d.setTargetNode(null),o&&this.reuseMap.onError(s,a.getUri(s.sourceId)),r()});d.loadModelFromBuffer(e,t,{})},n.prototype.reuseStartLoading=function(e,t){this.reuseMap.startLoading(e,t.getUri(e.sourceId))},n.prototype.loadFromReuse=function(e,t,n,i,r){this.reuseMap.getNodesAndAddRef(i,r.getUri(i.sourceId),n=>{let i;for(i=0;i<n.length;i++)e.addChild(n[i]);t()},n)};class i{constructor(){this.sourceMap=new WeakMap}hasData(e,t){let n=this.sourceMap.get(e);return!!n&&n.hasData(t)}startLoading(e,t){let n=this.sourceMap.get(e);n||(n=new r,this.sourceMap.set(e,n)),n.startLoading(t)}registerData(e,t,n){let i=this.sourceMap.get(e);i&&i.registerData(t,n)}onError(e,t){let n=this.sourceMap.get(e);n&&n.onError(t)}release(e,t){let n=this.sourceMap.get(e);n&&n.release(t)}getNodesAndAddRef(e,t,n,i){let r=this.sourceMap.get(e);r?r.getNodesAndAddRef(t,n,i):i()}}class r{constructor(){this.nodeMap=new Map}registerData(e,t){if(t){let n=this.nodeMap.get(e);if(n){let e;for(n.nodes=[].concat(t),n.loaded=!0,n.addRef(),e=0;e<n.onLoadedCBs.length;e++)n.onLoadedCBs[e](t);n.onLoadedCBs=[],n.onErrorCBs=[]}}}onError(e){let t=this.nodeMap.get(e);if(t){let e;for(t.loaded=!1,t.error=!0,e=0;e<t.onErrorCBs.length;e++)t.onErrorCBs[e](nodes);t.onLoadedCBs=[],t.onErrorCBs=[]}}release(e){let t=this.nodeMap.get(e);t&&(t.release(),t.usecount<=0&&this.nodeMap.delete(e))}getNodesAndAddRef(e,t,n){let i=this.nodeMap.get(e);i?(i.addRef(),i.loaded?t(i.nodes):i.error?n():(i.onLoadedCBs.push(t),i.onErrorCBs.push(n))):n()}hasData(e){return!!this.nodeMap.get(e)}startLoading(e){let t=this.nodeMap.get(e);t||(t=new o,this.nodeMap.set(e,t)),t.loading=!0}}class o{constructor(e){this.usecount=0,this.loaded=!1,this.error=!1,this.onLoadedCBs=[],this.onErrorCBs=[],this.nodes=[]}addRef(){this.usecount++}release(){this.usecount--}}return new n}),define("DS/3DXMTiles/DSTilesWorldPosition",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t=function(){this.matrixArray=[null],this.inverseMatrixArray=[null],this.inverseMatrixUpToDate=!1};return t.prototype.setFromOccurrences=function(t,n){var i,r;for(this.matrixArray.length=t.length,this.inverseMatrixArray.length=t.length,i=0;i<t.length;i++)(r=new e.Matrix4).copy(t[i].matrix),n&&r.multiplyMatrices(r,n),this.matrixArray[i]=r;this.inverseMatrixUpToDate=!1},t.prototype.update=function(t){var n,i=t.parent&&t.parent.worldPosition;for(i&&(this.matrixArray.length=i.matrixArray.length,this.inverseMatrixArray.length=i.matrixArray.length),this.inverseMatrixUpToDate=!1,n=0;n<this.matrixArray.length;n++){var r;r=i&&i.matrixArray[n],t.matrix?r?(this.matrixArray[n]=new e.Matrix4,this.matrixArray[n].multiplyMatrices(r,t.matrix)):this.matrixArray[n]=t.matrix:this.matrixArray[n]=r,this.inverseMatrixArray[n]=null}},t.prototype.updateInverseMatrix=function(t){if(!this.inverseMatrixUpToDate){var n,i=t.parent;for(n=0;n<this.matrixArray.length;n++){var r=this.matrixArray[n];i&&i.worldPosition.matrixArray[n]===r&&(i.worldPosition.updateInverseMatrix(i),o=i.worldPosition.inverseMatrixArray[n]);var o=new e.Matrix4;r&&o.getInverse(r),this.inverseMatrixArray[n]=o}}this.inverseMatrixUpToDate=!0},t.prototype._getInverseMatrix=function(e){return this.inverseMatrixUpToDate||this.updateInverseMatrix(e),this.inverseMatrixArray[0]},t}),define("DS/3DXMTiles/LDHSwitchRepresentationData",[],function(){"use strict";var e=function(e){this.rep=e,this.onSwitchRepCBArray=null};return e.prototype.setRep=function(e){this.rep=e},e.prototype.addOnSwitchRepCB=function(e){e&&(null===this.onSwitchRepCBArray&&(this.onSwitchRepCBArray=[]),this.onSwitchRepCBArray.push(e))},e}),define("DS/3DXMTiles/DSTilesContent",[],function(){"use strict";return class{constructor(e,t){this.sourceId=e.source||null,this.type=e.type,this.format=e.format,this.uri=e.uri,this.etag=e.etag||null;var n=e.fileSize?parseFloat(e.fileSize):0;if(isFinite(n)||(n=0),this.fileSize=n,this.instances=e.instances||null,this.contentToken=null,this.updatedContentToken=null,this.updatedContentVersion=0,this.contentLoader=t.getContentLoader(e.type),!this.contentLoader)throw new Error("unknown content type '"+e.type+"'")}needsSgNode(){return this.contentLoader.needsSgNodePerContent()}replaceContentWithUpdated(e){if(!this.updatedContentToken||!e.isAlive())return;this.updatedContentToken&&!this.contentToken&&this.deleteContent(e,!0);let t=e.getContentVisible();t&&this.hideContent(e),this.deleteContent(e),this.contentToken=this.updatedContentToken,this.updatedContentToken=null,t&&this.showContent(e)}showContent(e){this.contentLoader.showContent(e,this)}hideContent(e){this.contentLoader.hideContent(e,this)}deleteContent(e,t){t?(this.updatedContentToken&&this.contentLoader.deleteContent(e,this,this.updatedContentToken),this.updatedContentToken=null):(this.contentToken&&this.contentLoader.deleteContent(e,this,this.contentToken),this.contentToken=null)}getContentToken(e){return e?this.updatedContentToken:this.contentToken}setContentToken(e,t){t?this.updatedContentToken=e:this.contentToken=e}getUri(e,t){let n=this.contentLoader.getURIPostFix(),i=t&&t.uriPostFix||"";return this.uri&&"string"!=typeof this.uri?this.uri[e]+(n||""):this.uri+i+(n||"")}getFormat(){return this.format}getSourceIdWithParamsArray(e){return this.contentLoader.getSourceIdWithParamsArray(this,e)}exportContent(e){return this.contentLoader.exportContent(e,this)}getSingleSource(e){return e.tileSet.getContentSource(this.sourceId)}getSingleSourceId(){return this.sourceId||"default"}setUpdatedContentVersion(e){this.updatedContentVersion=e}}}),define("DS/3DXMTiles/LDHReferenceStatus",[],function(){return{loading:"loading",loaded:"loaded",toLoad:"toLoad",toUnload:"toUnload",freezeUnload:"freezeUnload",dead:"dead",waiting:"waiting",error:"error"}}),define("DS/3DXMTiles/DSTilesR2VOctree",[],function(){"use strict";function e({tileNode:e}){this.root=new n({tileNode:e,cellCoords:new t(0,0,0,0),tree:this,parent:null})}function t(e,t,n,i){this.x=e,this.y=t,this.z=n,this.depth=i}function n({tileNode:e,cellCoords:t,tree:n,parent:i}){this.tree=n,this.cellCoords=t,this.tileNode=e,this.children=null,this.childCount=0,this.maxDepth=0,this.parent=i||null}return e.prototype.getSizeData=function(){var e=this.getMaxDepth(),t=Math.pow(2,e),n=new Float32Array(t*t*t);return this.root.writeDataToBuffer_traverse(n,e),n},e.prototype.getMaxDepth=function(){return this.root.maxDepth},e.prototype.addTileNode=function(e,t){if(e!==this.root.tileNode){var n=this.root.getTileNodeCellCoords(e,t);this.root.addTileNode(e,n)}},e.prototype.removeTileNode=function(e,t){if(e!==this.root.tileNode){var n=this.root.getTileNodeCellCoords(e,t);this.root.removeTileNode(e,n)}},n.prototype.getTileNodeCellCoords=function(e,n){var i=this.tileNode.getBoundingBox(),r=Math.pow(2,n),o=(i.max.x-i.min.x)/r,s=(i.max.y-i.min.y)/r,a=(i.max.z-i.min.z)/r,d=e.getBoundingBox(),l=(d.max.x+d.min.x)/2,h=(d.max.y+d.min.y)/2,c=(d.max.z+d.min.z)/2;return new t(Math.floor((l-i.min.x)/o),Math.floor((h-i.min.y)/s),Math.floor((c-i.min.z)/a),n)},t.prototype.buildChildCoords=function(e){var n=e%2,i=2&e?1:0,r=4&e?1:0;return new t((this.x<<1)+n,(this.y<<1)+i,(this.z<<1)+r,this.depth+1)},n.prototype.writeDataToBuffer_traverse=function(e,t){var n,i;if(this.tileNode&&this.writeDataToBuffer(e,t),this.children)for(n=0;n<this.children.length;n++)(i=this.children[n])&&i.writeDataToBuffer_traverse(e,t)},n.prototype.writeDataToBuffer=function(e,t){var n,i,r,o=this.tileNode.geometricalError,s=Math.pow(2,t-this.cellCoords.depth),a=s*this.cellCoords.x,d=s*this.cellCoords.y,l=s*this.cellCoords.z,h=Math.pow(2,t),c=h*h-s*s,u=h-s,p=a+h*d+h*h*l;for(r=0;r<s;r++){for(i=0;i<s;i++){for(n=0;n<s;n++)e[p]=o,p++;p+=u}p+=c}return o},n.prototype.getChildIndex=function(e){var t=Math.pow(2,e.depth-this.cellCoords.depth);return Math.floor(2*(e.x/t-this.cellCoords.x))+(Math.floor(2*(e.y/t-this.cellCoords.y))<<1)+(Math.floor(2*(e.z/t-this.cellCoords.z))<<2)},n.prototype.addTileNode=function(e,t){var i=this.getChildIndex(t);this.children||(this.children=[null,null,null,null,null,null,null,null]),t.depth===this.cellCoords.depth+1?(this.children[i]?this.children[i].tileNode=e:(this.children[i]=new n({tileNode:e,cellCoords:t,tree:this.tree,parent:this}),this.childCount++),this.updateMaxDepth()):(this.children[i]||(this.children[i]=new n({tileNode:null,cellCoords:this.cellCoords.buildChildCoords(i),tree:this.tree,parent:this}),this.childCount++),this.children[i].addTileNode(e,t))},n.prototype.removeTileNode=function(e,t){if(this.children){var n=this.getChildIndex(t),i=this.children[n];i&&(t.depth===this.cellCoords.depth+1?i.tileNode=null:i.removeTileNode(e,t),0!==i.childCount||i.tileNode||(this.children[n]=null,this.childCount--,0===this.childCount&&(this.children=null),this.updateMaxDepth()))}},n.prototype.updateMaxDepth=function(){var e,t,n=0;if(this.children)for(e=0;e<this.children.length;e++)(t=this.children[e])&&t.maxDepth+1>n&&(n=t.maxDepth+1);n!==this.maxDepth&&(this.maxDepth=n,this.parent&&this.parent.updateMaxDepth())},e}),define("DS/3DXMTiles/LDHHandler",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/VisuTools/OOCReplay"],function(e,t,n){"use strict";var i=function(e){this.type=e};i.prototype.handleReferences=function(e,t){},i.prototype.getBatchSize=function(){return 1},i.prototype.setRestricted=function(){},i.prototype.isReady=function(){return!1};var r=function(e){this.maxSize=e,this.references=[]};r.prototype.containsReference=function(e){return this.references.indexOf(e.referenceId)>=0},r.prototype.addReferenceIfPossible=function(e){return this.references.length<this.maxSize&&(this.references.push(e),!0)},r.prototype.isEmpty=function(){return 0===this.references.length},r.prototype.getSize=function(){return this.references.length},r.prototype.setReferencesLoading=function(e){var t,n,i=this.references;for(t=0;t<i.length;t++)(n=i[t]).isLoading()||n.setLoading(e)},i.prototype.handleBatch=function(e,t){this.handleReferences(e.references,t)},i.prototype.createBatch=function(){return new r(this.getBatchSize())},i.prototype.acceptsRepresentation=function(e,t){return!0},i.prototype.commitModelLoadedTransaction=function(e,t,i){var r=e.getActiveRepresentation();if(n.download&&n.recording&&r){let e=r.node;e&&(e.removeChildren(),i=[])}i&&i.nodes&&e.setCGRNodeNames(i.nodes,r);var o=t._ldhNodeManager;e.referenceId;e.showActiveRepresentation(o),e.setRepLoaded(!0),e.isAlive()&&o.onLeafReferenceLoadedCB&&o.onLeafReferenceLoadedCB(e.referenceId,i),r.updateMeshSize(e),e.updateMemorySizeNEW(o),t._startModelLoaderTransaction(),t._onRepLoaded(e),t._endModelLoaderTransaction()};var o={red:new e.MeshPhongMaterial({color:"#ffaaaa"}),green:new e.MeshPhongMaterial({color:"#aaffaa"})},s="ON"===window.localStorage.getItem("OOCColorMode");return i.prototype.dbgSetupNodes=function(e,t){if(s&&e){var n,i=o[t];for(n=0;n<e.length;n++)e[n].traverse(function(e){if("Mesh3D"===e.getNodeType()&&e.mesh3js)for(var t=0;t<e.mesh3js.geometry.length;t++)for(var n=e.mesh3js.geometry[t],r=0;r<n.drawingGroups.length;r++){var o=n.drawingGroups[r];4===o.glType&&(o.gas=i)}})}},i.prototype.getNodeUsage=function(){switch(this.type){case i.Model3DHandler:return t.REPRESENTATION_NODE;case i.TileSetHandler:return t.TILESET_NODE;default:return t.REFERENCE_NODE}},i.prototype.setRedirectUrlCB=function(){},i.prototype.setAutoRedirect=function(){},i.Model3DHandler=0,i.InstRefHander=1,i.TileSetHandler=2,i}),define("DS/3DXMTiles/DSTilesScreenRadiusScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],function(e,t,n){"use strict";var i=function(e){n.apply(this,arguments)};return i.prototype=Object.create(n.prototype),n.prototype.getSortingMetric=function(){return"screenRadius"},i.prototype.computeScore=function(t,n,i){var r=t.screenRadiusCache,o=t.getBoundingSphere(),s=!1;if(o){r||(r=e.computeScreenRadiusCache(t._getWorldMatrix(),null,o,!1,!1),t.screenRadiusCache=r);var a=n.viewpoint,d=n.cst,l=a.getEyePosition().distanceTo(r.center),h=0;if(l<r.radius||0===l)return h=1/0,t.score=h,void(i&&(t.pixelError=1/0));if(s=a._frustum.performFrustumCullingNoNearFar(r.radius,r.center)){var c=e.computeScreenRadius(r,a.camera,a._frustum,d);h=c>=5?c:-1}t.score=h}else t.score=1/0;t.pixelError=i&&s?this.computePixelError(t.geometricalError,r,n):-1},i}),define("DS/3DXMTiles/DSTilesHandler",["DS/3DXMTiles/DSTilesNodeMemorySize"],function(e){"use strict";var t=function(){};return t.prototype.isReady=function(){return!0},t.prototype.isThereEnoughMemoryToLoad=function(e,t){return!0},t.prototype.load=function(e,t){setTimeout(t.onLoadError.bind(t,e),0)},t.prototype.computeMemorySize=function(t){return new e(0,0)},t.prototype.removeRepresentation=function(e){},t}),define("DS/3DXMTiles/LDHInstRefHandler",["DS/3DXMTiles/LDHHandler"],function(e){"use strict";var t=function(){e.call(this,e.InstRefHander)};return t.prototype=Object.create(e.prototype),t}),define("DS/3DXMTiles/DSTilesDistanceScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],function(e,t,n){"use strict";var i=function(){};return(i.prototype=Object.create(n.prototype)).computeScore=function(t,n,i){var r=t.screenRadiusCache,o=t.getBoundingSphere(),s=!1;if(o){r||(r=e.computeScreenRadiusCache(t._getWorldMatrix(),null,o,!1,!1),t.screenRadiusCache=r);var a=n.viewpoint,d=a.getEyePosition().distanceTo(r.center),l=0;if(d<r.radius||0===d)return l=1/0,t.score=l,void(i&&(t.pixelError=1/0));(s=a._frustum.performFrustumCullingNoNearFar(r.radius,r.center))&&(l=1/d),t.score=l}else t.score=1/0;t.pixelError=i&&s?this.computePixelError(t.geometricalError,r,n):-1},i}),define("DS/3DXMTiles/DSTilesPixelErrorScoreComputer",["DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesScoreComputer"],function(e,t,n){"use strict";var i=function(e){n.apply(this,arguments)};return(i.prototype=Object.create(n.prototype)).getSortingMetric=function(){return"pixelError"},i.prototype.computeScore=function(t,n,i){var r=t.screenRadiusCache,o=t.getBoundingSphere();if(o){r||(r=e.computeScreenRadiusCache(t._getWorldMatrix(),null,o,!1,!1),t.screenRadiusCache=r);var s=n.viewpoint,a=n.cst,d=s.getEyePosition().distanceTo(r.center),l=0,h=-1;if(d<r.radius||0===d)return l=1/0,t.score=l,void(i&&(t.pixelError=1/0));s._frustum.performFrustumCullingNoNearFar(r.radius,r.center)&&(l=e.computeScreenRadius(r,s.camera,s._frustum,a)>=5?h=this.computePixelError(t.geometricalError,r,n):-1),t.score=l,t.pixelError=h}else t.score=1/0},i}),define("DS/3DXMTiles/DSTilesJSONContent",["DS/3DXMTiles/DSTilesContent"],function(e){"use strict";var t=function(t){e.call(this),this.json=t.json||{}};return t.prototype=Object.create(e.prototype),t}),define("DS/3DXMTiles/DSTilesContentLoader",["DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/DSTilesSourceIdWithParams"],function(e,t){"use strict";var n=function(e){this.budget=null,this.tilesManager=e.tilesManager};n.prototype.init=function(){this.budget||(this.budget=this.tilesManager.memoryManager.createBudget(this.getBudgetParams()))},n.prototype.getBudget=function(){return this.budget},n.prototype.isNodeVisible=function(e){return!0};var i=[new t("default",null)];return n.prototype.getSourceIdWithParamsArray=function(e){return e.sourceId?[new t(e.sourceId,null)]:i},n.prototype.isReady=function(){return!0},n.prototype.isThereEnoughMemoryToLoad=function(e,t){},n.prototype.loadContentFromBuffer=function({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,params:o}){setTimeout(r,0)},n.prototype.loadContentFromExistingData=function(e,t,n,i,r){setTimeout(r,0)},n.prototype.computeMemorySize=function(t,n){return new e(0,0)},n.prototype.showContent=function(e,t){},n.prototype.hideContent=function(e,t){},n.prototype.deleteContent=function(e,t,n){},n.prototype.exportContent=function(e,t){},n.prototype.onContentMetaDataUpdate=function(e){},n.prototype.needsSgNodePerContent=function(){return!1},n.prototype.setTileSetVisibility=function(e){},n.prototype.hasExistingData=function(e,t,n){return!1},n.prototype.onStartLoading=function(e,t,n){},n.prototype.needsDownload=function(){return!0},n.prototype.getURIPostFix=function(e,t){return null},n.prototype.createUpdatedContentTokenFromContentToken=function(e,t){return!1},n}),define("DS/3DXMTiles/LDHRepresentationLoader",["DS/Visualization/ModelLoader","DS/Visualization/LoaderUtils","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHStats","DS/Visualization/PLMMaterialConnectionFactory","DS/VisuTools/OOCReplay","DS/VisuTools/Downloader","DS/3DXMTiles/ModelBank"],function(e,t,n,i,r,o,s,a){"use strict";var d=i,l={statsInit:function(){d.init()},statsOnLoadedModel:function(){d.onLoadedModel()},modelLoader:new e,modelLoader3dx:new e,debug:!1,debugSaveToBank:!1,setDebug:function(e){this.debug=e},_loadModel:function(e,t,n,i,r,o,s,d){if(!this.debugSaveToBank||a.nbTransactions<10)this._loadModel_internal(e,t,n,i,r,o,s,d);else{let l=setInterval(()=>{a.nbTransactions<10&&(this._loadModel_internal(e,t,n,i,r,o,s,d),clearInterval(l))},100)}},_loadModel_internal:function(e,i,r,o,s,a,h,c){function u(e){n.endProbe("load_"+i.referenceId),d.onLoadedModel(),i.updateMemorySizeNEW(c),i=null,p.setTargetNode(null),o(g)}this.debug&&(e=this.removeTag(e)),t.__storeCGRNames=0,a||(e.endsWith(".cgr")?a="cgr":e.endsWith(".3dxc")&&(a="3dxc"));var p="3dxc"===a?this.modelLoader3dx:this.modelLoader;p.setKeepLoaderMode(!0);var f=null,g=i.getActiveRepresentation(),m=i.getPrimaryRepresentation();if(i.requestBuildSceneGraphHierarchy(!0),c.tryBuildSceneGraphHierarchy(),g!==m&&(f=g.buildNode()),f=g.node){p.setSceneGraph(f),(c.newLoadingBoxes||i.isSlave())&&i.removeBox(c),s&&(p.activateSmartLoading(s.getRenderer()),p.setRenderCallback(s.render,1e3)),p.setFileType(a||"xmlv43"),(e.endsWith(".cgr")||"cgr"===a?p.setOnLoadedProductStructureCallback:p.setOnLoadedCallback).call(p,function(e){n.endProbe("load_"+i.referenceId),d.onLoadedModel(),p.setTargetNode(null),r(e,g),i=null}),p.setOnErrorCallback(u),d.init();var S,y={filename:e,format:a||void 0,loaderSettings:{gasSharing:!0}};if(h)for(S in h)y[S]=h[S];var v={};!1,l.setupModelLoaderOptions(p,v,i,g,m,c,null),n.startProbe("load_"+i.referenceId),this.debugSaveToBank?this.debugHandleSaveToBank(p,y,v,i,g,f):p.loadModel(y,void 0,void 0,v)}else setTimeout(u,1)},debugHandleSaveToBank:function(e,t,n,i,r,o){let s=e.onLoadedCB,d=e.onLoadedPrdCB,l=e.onErrorCB;var h=new XMLHttpRequest;h.responseType="arraybuffer",h.onload=function(){var t=h.response;a.storeModelData([i.referenceId],[r.type],"DEBUG",[t],[r.wms]),e.onLoadedCB=s,e.onLoadedPrdCB=d,e.onErrorCB=l,e.loadModelFromBuffer(t,o,n)},h.onerror=l;let c=t.filename;h.open("GET",c,!0),h.send(null)},setupModelLoaderOptions:function(e,t,n,i,a,d,l){if(l&&o.download){let t=e.onLoadedPrdCB,i=new ArrayBuffer(l.byteLength);new Uint8Array(i).set(new Uint8Array(l)),e.onLoadedPrdCB=(()=>{s.download({filename:n.referenceId+".cgr",data:i,group:!0,onEndCB:()=>{t()}})})}var c=!1,u=!1,p=d.oocManager.getDefaultLoadModelOptions(),f=void 0;p&&(p.CGRWithSG&&(c=!0),p.CGRWithBlanking&&(u=!0),void 0!==p.noMeshInRAM&&(f=p.noMeshInRAM)),r.hasInternalPath(n.referenceId)&&(c=!0);var g=!1;n.isLegacyUV()&&(g=!0);var m,S=n.getLoadModelOptions();if(S)for(m in S)"CGRWithSG"===m?c=!!S[m]:"CGRWithBlanking"===m?u=!!S[m]:"noMeshInRAM"===m&&void 0!==S[m]?f=!!S[m]:"applicativeContainers"===m&&S[m]&&(t[m]=h(S[m]),t[m]&&(t[m].applicativeContainersNode=a.node));void 0!==f||i.noMeshInRAM,void 0!==f&&i.forceMeshInRAM(!f),e.setAccelerationStructure(d.oocManager.getUsePickingAccelerationStructure()),e.setCGRWithBlanking(u),e.setCGRWithSG(c),e.setNoMeshInRAM(n.getActiveRepresentation().noMeshInRAM),e.useDefaultTCSet=g},removeTag:function(e){var t=e.indexOf("#");if(t>=0){var n=e.lastIndexOf(".");return e.substring(0,t)+e.substring(n)}return e}};function h(e){var t,n={};for(t in e)n[t]=e[t];return n}return l.modelLoader.sharedBuffers=!1,l.modelLoader3dx.sharedBuffers=!1,l}),define("DS/3DXMTiles/LDHOccurrence",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/PathElement","DS/Visualization/IdPath"],function(e,t,n,i,r,o,s){"use strict";var a=new t.Matrix4,d=function(e,t){var n=e.reference;this.reference=n||null,n._occurrences.length>0&&e.manager.forceUpdateNode(n),n._occurrences.push(this),this.node=e.node||null,this.parent=e.parent||null,this.instanceData=e.instanceData||null,this.updateMatrix(e.manager);for(var i=0;i<n.children.length;++i){var r=n.children[i];new d({reference:r.reference,boundingSphere:r.reference.boundingSphere,node:null,manager:e.manager,parent:this,instanceData:r},t)}this.reference.requestBuildSceneGraphHierarchy(),this.viewpointTag=-1,this.reference.updateMemorySizeNEW(e.manager),this.reference._optional&&this.reference._optional.hasOverride()&&t&&t.add(this.reference)};d.prototype.updateMatrix=function(e){var n=this.parent?this.parent.matrix:null,i=this.getLocalMatrix(e);null===i?this.matrix=n||a:(this.matrix=new t.Matrix4,n?this.matrix.multiplyMatrices(n,i):this.matrix.copy(i))},d.getOccurrenceMatrix=function(e,n){return null===n?e:(new t.Matrix4).multiplyMatrices(e,n)},d.prototype.getChildren=function(){var e,t,n,i,r=[],o=[];for(n=0;n<this.reference.children.length;n++)if(e=this.reference.children[n].reference,-1===o.indexOf(e)){for(i=0;i<e._occurrences.length;i++)null!==(t=e._occurrences[i])&&t.parent===this&&r.push(t);o.push(e)}return r},d.prototype.getIdPath=function(e){if(this.parent){var t=this.parent.getIdPath(!1);return t.push(this.instanceData.instanceId),!e&&t.push(this.reference.referenceId),t}return[this.reference.referenceId]},d.prototype.removeFromSceneGraph=function(){this.node&&this.reference.node&&this.reference.node.removeChild(this.node)},d.prototype.detach=function(e){e&&e.add(this.reference),this.reference._removeOccurrenceFromList(this);var t,n=this.getChildren();for(t=0;t<n.length;t++)n[t].detach(e);this.parent=null},d.prototype.buildPathElement=function(){if(this.reference.node){for(var e,t=[],n=this;n;){if(t.unshift(n.reference.node),e=null,n.parent){if(!(e=n.parent.reference.getChildInstanceNode(n.instanceData.instanceId)))return null;t.unshift(e)}n=n.parent}return new o(t)}return null},d.prototype.getBoundingSphere=function(){var e=this.reference.getBoundingSphere(),t=null;return e&&(t=e.clone()).applyMatrix4(this.matrix),t};var l=new t.Matrix4;return d.prototype.getLocalMatrix=function(e){e.oocManager._findPositionOverride(this);var t=e.viewer.getSceneGraphOverrideSetManager(),n=e.viewer.getIdPathMatcher(),i=this.reference.referenceId,r=this.instanceData&&this.instanceData.instanceId,o=t._hasIdPathOverride(i),s=this.instanceData&&t._hasIdPathOverride(r),a=null,d=null,h=null,c=null,u=e.oocManager;if(o||(o=!!(a=u._findPositionOverride(this,!1))),s||(s=!!(d=u._findPositionOverride(this,!0))),o||s){var p=this.buildIdPath(n,e);return o&&!a&&(a=t._getIdPathPositionOverride(p)),s&&!d&&(p.removeLastId(),d=t._getIdPathPositionOverride(p)),a&&(h=a.getPosition())&&h.isIdentity()&&(h=null),d&&(c=d.getPosition()),c?c.isIdentity()&&(c=null):c=this.instanceData&&this.instanceData.matrix,h&&c?(l.multiplyMatrices(c,h),l):h||(c||null)}return this.instanceData?this.instanceData.matrix:null},d.prototype.buildIdPath=function(e,t){for(var n=this,i=this.getIdPath();n.parent;)n=n.parent;var r=t.targetNode;return i.unshift(e.nodeToId(r)),new s(i)},d}),define("DS/3DXMTiles/LDHReferenceRep",["DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHHandler","DS/Visualization/BufferGPUManager","DS/3DXMTiles/3DXMTilesUtils"],function(e,t,n,i,r){"use strict";var o=-10,s=0,a=10,d=function(e){e=e||{},this.node=null,this.meshSize=-1,this.src=e.url||e.src||null,this.meshInRAMStatus=s,this.active=!1,this.type=e.type,this.nextRep=null,this.wms=e.wms||0};return d.prototype.clone=function(){var e=new d;return e.src=this.src,e.wms=this.wms,e.type=this.type,e},d.prototype.setWMS=function(e){this.wms=e||0},d.prototype.setSrc=function(e){this.src=e},d.prototype.setUrlAndType=function(e,t){this.src=e,this.type=t},d.prototype.updateUrl=function(e){this.src=e},d.prototype.equals=function(e){return this.src===e.src&&this.noMeshInRAM===e.noMeshInRAM&&this.wms===e.wms},d.prototype.hasMeshInRAM=function(){return this.meshInRAMStatus>0},d.prototype.copyMissingParams=function(e){e&&(null===this.src&&(this.src=e.src),0===this.wms&&(this.wms=e.wms),this.meshInRAMStatus===s&&(this.meshInRAMStatus=e.meshInRAMStatus))},d.prototype.forceMeshInRAM=function(e){this.meshInRAMStatus=e?a:o},d.prototype.setMeshInRAM=function(e){this.meshInRAMStatus=e?a:o},d.prototype.isPartiallyDefined=function(){return null===this.src||this.meshInRAMStatus===s},d.prototype.isClearMeshInRAMOnly=function(e){return!!(e&&e.meshInRAMStatus<0&&e.src===this.src&&this.meshInRAMStatus>0&&e.wms===this.wms)},d.prototype.buildNode=function(){return this.node||(this.node=new e),this.node},d.prototype.getJSON=function(){return{src:this.src,meshInRAM:!this.noMeshInRAM}},d.prototype.clearMeshInRAM=function(){this.node&&this.node.traverse(function(e){e instanceof t&&e.forceNoMeshInRAM()}),this.meshInRAMStatus>0&&(this.meshInRAMStatus*=-1)},d.prototype.getMeshSize=function(){return-1!==this.meshSize?this.meshSize:0},d.prototype.updateMeshSize=function(e){var t=0;this.node&&this.node.children.length>0&&e.handler.type===n.Model3DHandler&&(t=r.computeMeshSize(this.node)),this.meshSize=t},d.prototype.isAV1=function(){return this.type===d.RepType.av1},d.prototype.isPR=function(){return this.type===d.RepType.pr},d.prototype.getSrc=function(){return this.src},Object.defineProperty(d.prototype,"noMeshInRAM",{get:function(){return this.meshInRAMStatus<0},set:function(){throw new Error("patata")}}),Object.defineProperty(d.prototype,"url",{get:function(){return this.src},set:function(e){this.src=e}}),d.RepType={none:"RepType##NONE",av1:"RepType##AV1",pr:"RepType##PR",rr:"RepType##RR"},d}),define("DS/3DXMTiles/DSTilesStylingRender",["DS/3DXMTiles/ParsingStatus","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";class n{constructor(){}addNeededAttributesToSet(e){throw new Error("missing implementation")}buildShaderCode(e){throw new Error("missing implementation")}buildShaderGlobalCode(e){return null}}return n.createFromJSON=function(e,t,n){let i,r=null;for(i=0;i<n.length&&!r;i++){let t=n[i];e.type===t.jsonType&&(r=t)}if(!r)return t.setError("Unknown render type","render"),null;let o=new r,s=o.setFromJSON(e);return s.error&&(o=null),t.copy(s),o},n.toShaderColor=function(e,n,i){let r=new t.Color(e);return`${n()}(${i()}(${r.r}), ${i()}(${r.g}), ${i()}(${r.b}))`},n}),define("DS/3DXMTiles/DSTilesNode",["DS/3DXMTiles/DSTilesNodeStatus","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesNodeReplaceStatus","DS/3DXMTiles/DSTilesNodeMemorySize","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/3DXMTiles/DSTilesWorldPosition"],function(e,t,n,i,r,o,s,a){"use strict";var d={inList:1,inToBeLoaded:2,inUnload:4,inToExpand:8},l={matrixUpdate:1,descendantMatrixUpdate:2,onHold:4,childrenOnHold:8,descendantToUnload:16,contentVisible:32,wished:64,toUnload:128,noWishedUnder:256,noVisibleUnder:512,dead:1024,noContent:2048},h=0;class c{constructor(t){this.id=h++,this.tileSet=t.tileSet,this.uri=t.uri,this.handler=null,this.expander=t.expander||null,this.childrenURIs=t.childrenURIs||[],this.childrenEtags=t.childrenEtags||null,this.children=null,t.childrenURIs&&0===t.childrenURIs.length&&(this.children=[]),this.parent=t.parent||null,this.mode=t.mode||c.Mode.add,this.scoreComputer=t.scoreComputer||null,this.score=-2,this.pixelError=-1,this.occlusionStatus=-2,this.matrix=t.matrix||null,this.worldPosition=new a,t.worldMatrix&&(this.worldPosition.matrixArray[0]=t.worldMatrix),this._boundingSphere=t.boundingSphere||null,this._boundingBox=t.boundingBox||null,this.geometricalError=t.geometricalError||0,this.contentSet=t.contentSet||null,this.contentLoaders=this.contentSet?this.contentSet.getContentLoaders():null,this._contentStatus=this.contentSet?e.waiting:e.loaded,this._expandStatus=this.childrenURIs.length>0?e.waiting:null,this.flags=0,this.sgNode=null,this.inListStatus=0,this.screenRadiusCache=null,this.distanceToBoxCache=null,this.lastUpdateIndex=-1,this.memorySize=new i,this.isLODMode()&&this.setChildrenOnHold(!0),this.queue=t.queue||null,this._debugBBox=null,this.lockLoadDate=0,this.unloadLock=0,this.descendantLocked=0,this.userData=t.userData,this.metaData=t.metaData,this.triggerMetric=t.triggerMetric||"pixelError"}computeScore(e,t){e>this.lastUpdateIndex&&(this.lastUpdateIndex=e,this.scoreComputer.computeScore(this,t,this.isLODMode()))}getScore(){return this.score}lockUnload(){this.unloadLock++;for(var e=this.parent;e;)e.descendantLocked=1,e=e.parent}unlockUnload(){this.unloadLock--;for(var e=this.parent;e;)e.descendantLocked=-1,e=e.parent}isUnloadLocked(){return this.unloadLock>0}updateDescendantLocked(){var e;if(-1===this.descendantLocked&&(this.descendantLocked=0,this.children))for(e=0;e<this.children.length;e++){var t=this.children[e];t.updateDescendantLocked(),(t.isUnloadLocked()||t.descendantLocked)&&(this.descendantLocked=1)}}getTriggerMetric(){return this.triggerMetric}getSortingMetric(){return this.tileSet.getSortingMetric()}isMorePrioritaryThan(e){return this.score>e.score}isLessPrioritaryThan(e){return this.score<e.score}isLeaf(){return!(this.childrenURIs&&this.childrenURIs.length>0)}isLODMode(){return this.mode===c.Mode.replaceLOD||this.mode===c.Mode.addLOD}isReplaceLODMode(){return this.mode===c.Mode.replaceLOD}isAddLODMode(){return this.mode===c.Mode.addLOD}needsSgNode(){return null!==this.matrix||this.contentSet&&this.contentSet.needsSgNode()}setSgNode(e){this.sgNode=e,e.setMatrix(this.matrix)}updateWorldPositionFromSgNode(){let e=this.getSgNode();e&&this.worldPosition.setFromOccurrences(e._occurrences)}buildSgNode(){null===this.sgNode&&(this.needsSgNode()?(this.sgNode=new r,this.sgNode.setUserData({dsTilesNode:this}),this.matrix&&this.sgNode.setMatrix(this.matrix),this.parent&&(this.parent.buildSgNode(),this.parent.sgNode.addChild(this.sgNode))):this.parent&&(this.sgNode=this.parent.getSgNode()))}hasChildren(){return!!(this.children&&this.children.length>0)}getSgNode(){return this.buildSgNode(),this.sgNode}addChild(e,t){if(null!==e.parent)throw new Error("node already has a parent");null===this.children&&(this.children=[]),e.getDescendantToUnload()&&this.setDescendantToUnload(!0),void 0===t?this.children.push(e):this.children[t]=e,e.parent=this,e.setMatrixUpdate(!0),this.traverse(function(e){var t=!1;return e.getMatrixUpdate()?t=!0:e.setMatrixUpdate(!0),t}),(this.getChildrenOnHold()||this.getOnHold())&&e.setOnHoldTree(),this.getRoot()._dbgCheckConsistency()}setOnHoldTree(e){var t=this;this.traverse(function(n){if(n.setChildrenOnHold(!0),n!==t||!e)return n.parent&&n.setDescendantToUnload(!0),!!n.getOnHold()||(n.hideContent(),n.setOnHold(!0),!1)})}activateChildren(e){if(this.children){var t,n;for(t=0;t<this.children.length;t++)(n=this.children[t]).getOnHold()&&(n.setOnHold(!1),e.registerDSTilesNode(n,!0));this.setChildrenOnHold(!1)}}updateWorldMatrix(e,t){if(e){var n=this.getMatrixUpdate()||t;if(n&&(this.parent?this.worldPosition.update(this):this.updateWorldPositionFromSgNode(),this.screenRadiusCache=null,this.distanceToBoxCache=null,this.setMatrixUpdate(!1)),n||this.getDescendantMatrixUpdate()){var i;if(this.children)for(i=0;i<this.children.length;i++)this.children[i]&&this.children[i].updateWorldMatrix(!0,!!n);this.setDescendantMatrixUpdate(!1)}}else{for(var r=this;r.parent;)r=r.parent;r.updateWorldMatrix(!0)}}_getWorldMatrix(){return this.worldPosition.matrixArray[0]}getWorldBoundingSphere(){this.updateWorldMatrix();var e=this.getBoundingSphere().clone();return e.applyMatrix4(this._getWorldMatrix()),e}getOccurrencesWorldBoundingSphere(){this.updateWorldMatrix();var e,n=null;for(e=0;e<this.worldPosition.matrixArray.length;e++){var i=this.getBoundingSphere();n=t.mergeBoundingSphereInto(n,i,this.worldPosition.matrixArray[0],0)}return n}setInList(e){this.inListStatus=e?this.inListStatus|d.inList:this.inListStatus&65535-d.inList}isInList(){return!!(this.inListStatus&d.inList)}isInToBeLoaded(){return!!(this.inListStatus&d.inToBeLoaded)}setInToBeLoaded(e){this.inListStatus=e?this.inListStatus|d.inToBeLoaded:this.inListStatus&65535-d.inToBeLoaded}isInUnload(){return!!(this.inListStatus&d.inUnload)}setInUnload(e){this.inListStatus=e?this.inListStatus|d.inUnload:this.inListStatus&65535-d.inUnload}isInToExpand(){return!!(this.inListStatus&d.inToExpand)}setInToExpand(e){this.inListStatus=e?this.inListStatus|d.inToExpand:this.inListStatus&65535-d.inToExpand}getMatrixUpdate(){return!!(this.flags&l.matrixUpdate)}setMatrixUpdate(e){e?(this.flags=this.flags|l.matrixUpdate,this.parent&&this.parent.setDescendantMatrixUpdate(!0)):this.flags=this.flags&65535-l.matrixUpdate}getDescendantMatrixUpdate(){return!!(this.flags&l.descendantMatrixUpdate)}setDescendantMatrixUpdate(e){e?(this.flags=this.flags|l.descendantMatrixUpdate,this.parent&&!this.parent.getDescendantMatrixUpdate()&&this.parent.setDescendantMatrixUpdate(!0)):this.flags=this.flags&65535-l.descendantMatrixUpdate}checkConsistency(){if(this.parent&&this.parent.getChildrenOnHold()&&!this.getOnHold())throw new Error("inconsistency!!");var e;for(e=0;this.children&&e<this.children.length;e++)this.children[e].checkConsistency()}getDead(){return!!(this.flags&l.dead)}setDead(t){this.flags=this.flags|l.dead,t.registerDSTilesNode(this,!0),this._contentStatus=e.dead,this._expandStatus=e.dead}getOnHold(){return!!(this.flags&l.onHold)}setOnHold(e){this.flags=e?this.flags|l.onHold:this.flags&65535-l.onHold}getNoContent(){return!!(this.flags&l.noContent)}setNoContent(e){this.flags=e?this.flags|l.noContent:this.flags&65535-l.noContent}getChildrenOnHold(){return!!(this.flags&l.childrenOnHold)}setChildrenOnHold(e){this.flags=e?this.flags|l.childrenOnHold:this.flags&65535-l.childrenOnHold}getDescendantToUnload(){return!!(this.flags&l.descendantToUnload)}setDescendantToUnload(e){e?(this.flags=this.flags|l.descendantToUnload,this.parent&&!this.parent.getDescendantToUnload()&&this.parent.setDescendantToUnload(!0)):this.flags=this.flags&65535-l.descendantToUnload}getToUnload(){return!!(this.flags&l.toUnload)}setToUnload(e){e?(this.flags=this.flags|l.toUnload,this.parent&&!this.parent.getDescendantToUnload()&&this.parent.setDescendantToUnload(!0)):this.flags=this.flags&65535-l.toUnload}getWished(){return!!(this.flags&l.wished)}setWished(e){this.flags=e?this.flags|l.wished:this.flags&65535-l.wished}getNoWishedUnder(){return!!(this.flags&l.noWishedUnder)}setNoWishedUnder(e){this.flags=e?this.flags|l.noWishedUnder:this.flags&65535-l.noWishedUnder}getNoVisibleUnder(){return!!(this.flags&l.noVisibleUnder)}setNoVisibleUnder(e){this.flags=e?this.flags|l.noVisibleUnder:this.flags&65535-l.noVisibleUnder}getContentVisible(){return!!(this.flags&l.contentVisible)}setContentVisible(e){this.flags=e?this.flags|l.contentVisible:this.flags&65535-l.contentVisible}traverseParents(e){!e(this)&&this.parent&&this.parent.traverseParents(e)}traverse(e){var t;if(!e(this)&&this.children)for(t=0;t<this.children.length;t++)this.children[t]&&this.children[t].traverse(e)}traverseBreadthFirst(e){var t,n=[this],i=0;for(i=0;i<n.length;i++){let r=n[i];if(!e(r)&&r.children)for(t=0;t<r.children.length;t++)n.push(r.children[t]);n[i]=null}n=null}traverseChildren(e){var t;if(this.children)for(t=0;t<this.children.length;t++)this.children[t]&&this.children[t].traverse(e)}hasContent(){return null!==this.contentSet}hasContentToken(){if(this.contentSet){let e;for(e=0;e<this.contentSet.contents.length;e++){if(this.contentSet.contents[e].contentToken)return!0}}return!1}getBoundingBox(){if(!this._boundingBox){var e=this._boundingSphere;if(!e)return null;var n=new t.Box3;n.min.x=e.center.x-e.radius,n.min.y=e.center.y-e.radius,n.min.z=e.center.z-e.radius,n.max.x=e.center.x+e.radius,n.max.y=e.center.y+e.radius,n.max.z=e.center.z+e.radius,this._boundingBox=n}return this._boundingBox}getBoundingSphere(){return this._boundingSphere?this._boundingSphere:this._boundingBox?(this._boundingBox.getBoundingSphere(u),u):null}isContentToLoad(){return this._contentStatus===e.toLoad}isContentLoaded(){return this._contentStatus===e.loaded}isContentLoading(){return this._contentStatus===e.loading}isContentWaiting(){return this._contentStatus===e.waiting}isExpandToLoad(){return this._expandStatus===e.toLoad}isExpandLoaded(){return this._expandStatus===e.loaded}isExpandLoading(){return this._expandStatus===e.loading}isExpandWaiting(){return this._expandStatus===e.waiting}isAlive(){return!this.getDead()}isLoading(){return this._contentStatus===c.loading||this._expandStatus===c.loading}isError(){return this._contentStatus===e.error||this._expandStatus===e.error}isWaiting(){return!(null!==this._contentStatus&&this._contentStatus!==e.waiting||null!==this._expandStatus&&this._expandStatus!==e.waiting)}hasExpand(){return null!==this._expandStatus}setContentStatus(t,n){if(null!==this._contentStatus){var i=this._contentStatus,r=i!==t;if(this._contentStatus=t,r){var o=!0;i===e.waiting&&t===e.toLoad&&(o=!1),t===e.toLoad&&this.tileSet.setNodeStartLoading(),n.registerDSTilesNode(this,o)}this.getRoot()._dbgCheckConsistency()}}setExpandStatus(t,n){if(null!==this._expandStatus){var i=this._expandStatus,r=i!==t;if(this._expandStatus=t,r){var o=!0;i===e.waiting&&t===e.toLoad&&(o=!1),t===e.toLoad&&this.tileSet.setNodeStartExpanding(),n.registerDSTilesNode(this,o)}this.getRoot()._dbgCheckConsistency()}}passVisibilityTest(){if(1===this.descendantLocked||this.isUnloadLocked())return!0;if(this.score>0){if(this.contentLoaders){let e=0,t=!1;for(e=0;e<this.contentLoaders.length;e++)this.contentLoaders[e].isNodeVisible(this)&&(t=!0);return t}return!0}return!1}passPixelErrorTest(){return 1!==this.descendantLocked&&(this.pixelError>=0&&this.pixelError<this.tileSet.maxPixelError)}showContent(){this.contentSet?!this.getContentVisible()&&this.contentSet.showContent(this)&&this.setContentVisible(!0):this.setContentVisible(!0)}hideContent(){this.contentSet?this.getContentVisible()&&this.contentSet.hideContent(this)&&this.setContentVisible(!1):this.setContentVisible(!1)}deleteContentTree(){let e,t,n=this.queue;for(e=0;e<this.children&&this.children.length;e++)(t=this.children[e]).deleteContentTree(n);this.hideContent(),this.deleteContent(n)}deleteContent(t){this.contentSet&&this.contentSet.deleteContent(this)&&(this.setContentVisible(!1),this.setContentStatus(e.waiting,t))}getRoot(){for(var e=this;e.parent;)e=e.parent;return e}addToHSO(e){if(e||s.empty(),this.handler)this.contentSet&&this.contentSet.addToHSO();else if(this.children){var t;for(t=0;t<this.children.length;t++)this.children[t].addToHSO(!0)}}checkVisibilityConsistency(){this.getContentVisible()?this.traverseChildren(e=>{if(e.getContentVisible())throw new Error("content visible inconsistency")}):this.traverseChildren(e=>{e.checkVisibilityConsistency()})}_dbgCheckConsistency(){}_dbgCheckOnHoldConsistency(){this.traverse(function(e){if(e.parent&&!e.getOnHold()&&e.parent.getChildrenOnHold())throw new Error("Inconsistency!!!")})}tryUnload(e){var t,n,i=[];for(this._dbgCheckConsistency(),this.tryUnload_internal(i,e),t=0;t<i.length;t++)(n=i[t].parent)&&n.setDescendantToUnload(!0);this.queue.cleanLists(),this._dbgCheckConsistency()}isUnloading(){if(this.contentLoaders){let t,n=!1;for(t=0;t<this.contentLoaders.length;t++){let i=this.contentLoaders[t];var e=i&&i.getBudget();e&&!e.unloading||(n=!0)}return n}return!0}isContentLoadingAllowed(){let e,t=!0;if(this.contentLoaders)for(e=0;e<this.contentLoaders.length;e++){let i=this.contentLoaders[e];var n=i&&i.getBudget();n&&n.isLoadingAllowed()||(t=!1)}else t=!1;return t}isExpandLoadingAllowed(){return!0}tryUnload_internal(e,t){var n=this.hasChildren()&&(this.getDescendantToUnload()||this.getChildrenOnHold()),i=!1,r=this.isUnloadLocked(),o=!r&&(this.getToUnload()||this.getOnHold())&&this.isUnloading(t);if(this.isWaiting())this.setToUnload(!1),i=!r;else if(o||n)if(this.isLoading())i=!1;else{var s,a=!0;if(this.children){let n=0;for(s=0;s<this.children.length;s++)this.children[s].tryUnload_internal(e,t)?n++:a=!1;n>0&&this.children.length}a?(this.setDescendantToUnload(!1),o&&(this.doUnload(),i=!0)):i=!1}else i=!1;return o&&!i&&e.push(this),i}doUnload(){var t=this.queue;if(this.handler&&this.getRepLoaded()&&this.handler.removeRepresentation(this),this.deleteContent(t),this.children&&this.children.length>0){var n,i;for(n=0;n<this.children.length;n++)(i=this.children[n]).setDead(t),i.tileSet.removeNode(i.uri),i.parent=null;this.children=null}this.setToUnload(!1),this.setExpandStatus(e.waiting,t),this.sgNode&&this.parent&&(this.parent.sgNode.removeChild(this.sgNode),this.sgNode=null)}destroy(){if(this.children&&this.children.length>0){var e;for(e=0;e<this.children.length;e++)this.children[e].destroy();this.children=null}var t=this.queue;this.handler&&this.getRepLoaded()&&this.handler.removeRepresentation(this),this.deleteContent(t),this.children=null,this.setDead(t),this.sgNode&&this.parent&&this.parent.sgNode.removeChild(this.sgNode),this.sgNode=null,this.parent=null}traverseUpdateNodes(e){if(!this.getOnHold()||this.descendantLocked){var t,n=!1,i=[],r=this.tileSet.progressiveMode;for(this.traverseBreadthFirst(e=>{var t=!1;if(e.passVisibilityTest()){e.setNoWishedUnder(!1);var o=!1;e.isAddLODMode()?o=!0:!e.passPixelErrorTest()&&e.hasChildren()||(o=!0);var s=e.isAddLODMode();r&&e.startLoading(s),o?(e.setWished(!0),r||e.startLoading(s)&&(n=!0),e.isReplaceLODMode()&&(e.traverseChildren(t=>!(!t.getNoWishedUnder()||e.getChildrenOnHold())||(t.setNoWishedUnder(!0),t.setWished(!1),t.setOnHold(!0),t.setChildrenOnHold(!0),!1)),e.setChildrenOnHold(!0),t=!0),e.isAddLODMode()&&e.passPixelErrorTest()&&(e.traverseChildren(t=>!(!t.getNoWishedUnder()||e.getChildrenOnHold())||(n=!0,t.hideContent(),t.setNoWishedUnder(!0),t.setWished(!1),t.setOnHold(!0),t.setChildrenOnHold(!0),!1)),e.setChildrenOnHold(!0),t=!0)):e.setWished(!1)}else e.getNoWishedUnder()||(i.push(e),t=!0);return t}),t=0;t<i.length;t++)i[t].setNoWishedUnder(!0),i[t].traverse(e=>{e.setNoWishedUnder(!0),e.setWished(!1)});n&&e.render(),!c.DBGUnloadSmallNodes&&this.isReplaceLODMode()&&this.traverseReplace(e)}}traverseReplace(e){if(!this.getOnHold())if(this.tileSet.progressiveMode)this.traverseReplaceProgressive(e);else{var t=!1;this.traverse(e=>{var n=!1;if(e.passVisibilityTest()){if(e.getContentVisible()&&!e.getWished()){var i,r=!0,o=[];if(e.traverse(e=>{if(e.getWished())return e.isContentLoaded()||(r=!1),o.push(e),!0}),r&&o.length>0)for(t=!0,e.hideContent(),i=0;i<o.length;i++)o[i].showContent();n=!0}e.getWished()&&(e.isContentLoaded()&&!e.getContentVisible()&&(t=!0,e.showContent(),e.traverseChildren(e=>{e.hideContent()})),n=!0)}return n}),t&&e.render()}}traverseReplaceProgressive(e){if(this.parent)throw new Error("unexpected");var t=new Set,n=new Set,i=new Set,r=this.parent?this.parent:this,o=!1;r.traverseReplaceProgressive_internal(t,n,i),t.forEach(e=>{e.showContent(),o=!0,e.traverseChildren(e=>{var t=!1;return e.getNoVisibleUnder()&&(t=!0),e.setNoVisibleUnder(),e.getContentVisible()&&e.hideContent(),t})}),n.forEach(e=>{e.hideContent(),o=!0}),i.forEach(e=>{e.traverse(e=>{var t=!1;return e.getNoVisibleUnder()&&(t=!0),e.getContentVisible()&&(o=!0,e.hideContent()),t})}),o&&e.render({budgeted:!0})}traverseReplaceProgressive_internal(e,t,n){if(this.setNoVisibleUnder(!1),this.hasContent()&&!this.getContentVisible()&&e.add(this),!this.passPixelErrorTest()&&this.children){var i,r,o=!0,s=!1;for(i=0;i<this.children.length;i++)(r=this.children[i]).passVisibilityTest()&&(s=!0,r.isContentLoaded()||(o=!1));if(this.hasContent()&&!o||!s)for(i=0;i<this.children.length;i++)r=this.children[i],n.add(r);else for(e.delete(this),this.hasContent()&&this.getContentVisible()&&t.add(this),i=0;i<this.children.length;i++)(r=this.children[i]).passVisibilityTest()?r.traverseReplaceProgressive_internal(e,t,n):n.add(r)}else if(this.children)for(i=0;i<this.children.length;i++)r=this.children[i],n.add(r)}startLoading(t){var n=this.queue,i=!1;return this.hasContent()&&!this.isError()&&(this.isContentLoaded()?t&&(this.showContent(),i=!0):this.hasContent()&&!this.isContentLoading()&&(this.setContentStatus(e.toLoad,n),this.isInToBeLoaded()||(n.nodesToLoadQueue.addNode(this),this.setInToBeLoaded(!0)))),i}exportContent(){return this.hasContent()&&this.isContentLoaded()&&this.contentSet?this.contentSet.exportContent(this):null}getDistanceToBoxCache(){return this.scoreComputer?this.scoreComputer.getDistanceToBoxCache(this):null}showBox(){f||(f=new r,window.debugWebGLV6Viewer.addNode(f));var e=this.getBoundingBox();f.removeChildren();var t=o.createCuboidNodeFromBox3(e,p),n=this._getWorldMatrix();n&&t.setMatrix(n),f.addChild(t),window.debugWebGLV6Viewer.render()}onTileSetContentMetaDataUpdate(){this.traverse(e=>{if(e.contentLoaders){let t;for(t=0;t<e.contentLoaders.length;t++)e.contentLoaders[t].onContentMetaDataUpdate(e)}})}getContentFileSize(){var e=0;return this.contentSet&&(e=this.contentSet.getFileSize()),e}getContentMetaData(){return this.metaData}getSourcesWithContents(e){return this.contentSet?this.contentSet.getSourcesWithContents(this,e):null}getSourceWithContents(e){return this.contentSet?this.contentSet.getSourceWithContents(e,this):null}hasContentType(e){return!!this.contentSet&&this.contentSet.hasContentType(e)}getContentUris(){return this.contentSet?this.contentSet.getUris():null}getContentSpec(){return this.contentSet?this.contentSet.getSpec():null}}var u=new t.Sphere,p=t.MaterialUtils.createShinyFaceMaterial({color:"blue",transparent:!0,opacity:.2,force:!0}),f=null;return Object.defineProperty(c.prototype,"flagsStr",{get:function(){var e,t=null;for(e in l)this.flags&l[e]&&(null===t?t="":t+=" ",t+=e);return t},set:function(e){throw new Error("forbidden")}}),c.Mode={add:"add",addLOD:"addLOD",replaceLOD:"replaceLOD"},c.PlusInfinity=new c({}),c.PlusInfinity.score=1/0,c.PlusInfinity.priority=1/0,c.MinusInfinity=new c({}),c.MinusInfinity.score=-1/0,c.MinusInfinity.priority=-1/0,c}),define("DS/3DXMTiles/LDHTileSetHandler",["DS/3DXMTiles/LDHHandler","DS/WAFData/WAFData","DS/Visualization/ThreeJS_DS"],function(e,t,n){"use strict";var i=function(t){this.type=e.TileSetHandler,this.getSecurityParamsCB=t&&t.getSecurityParamsCB||null,this.getDataCB=t&&t.getDataCB};return(i.prototype=Object.create(e.prototype)).isReady=function(){return!0},i.prototype.handleResolvedReference=function(e,t){var i,r=t.manager._ldhNodeManager,o=t.manager,s=r.tilesManager;e.setRepLoaded(!0),e.requestBuildSceneGraphHierarchy(!0),e.tryBuildSceneGraphHierarchy(!0,r),r.tryBuildSceneGraphHierarchy();var a,d=[];if((i=e.getActiveRepresentation().getSrc()).tileSets)for(a=0;a<i.tileSets.length;a++)d.push(this.createSingleTileSet(i.tileSets[a],s,r,t.manager,e,!0));else d.push(this.createSingleTileSet(i,s,r,t.manager,e,!1));Promise.all(d).then(i=>{var s,a,d,l,h=null,c=null;for(s=0;s<i.length;s++){if((d=i[s]).setPauseLoading(!1,"_init_",r),a=(l=d.getRootNode()).matrix,1!==d.unitScale){var u=new n.Matrix4;u.makeScale(d.unitScale,d.unitScale,d.unitScale),a?(a=a.clone()).multiplyMatrices(u,a):a=u}h=n.mergeBoundingSphereInto(h,l.getBoundingSphere(),a),c=n.mergeBoundingBoxInto(c,l.getBoundingBox(),a)}r.registerTileSets(e,i),e.hasBoundingElement()||(e.setBoundingElements(h,c,null),e.isRoot&&o._updateBoundingSphere()),o._startModelLoaderTransaction(),o._onRepLoaded(e),o.endInstRefGraphTransaction(),t.doneCB([e],[]),e.isRoot&&o._onRootReferenceLoaded(e.referenceId)}),e.lockUnload()},i.prototype.createSingleTileSet=function(e,t,n,i,r,o){let s=r.getNode();return t.createFromJSON(e,s,o)},i.prototype.isReferenceResolved=function(e){var t=e.getActiveRepresentation().getSrc();return t.tileSets||null!=t.rootURI&&null!=t.rootURI},i.prototype.handleBatch=function(e,t){var n,i,r=t.manager._ldhNodeManager,o=(t.manager,r.tilesManager,[]);for(n=0;n<e.references.length;n++)i=e.references[n],this.isReferenceResolved(i)?this.handleResolvedReference(i,t):o.push(i);var s=[],a=[];for(n=0;n<o.length;n++)(i=o[n]).getActiveRepresentation().getSrc().sourceId?(a.push(i),this.handleReferenceWithSourceId(i,t)):s.push(i);if(s.length)if(this.getDataCB){var d=[];for(n=0;n<s.length;n++)d.push(s[n].referenceId);this.getDataCB(d).then(this.onReferenceData.bind(this,s,t)).catch(()=>{t.doneCB([],s)})}else t.doneCB([],s)},i.prototype.onReferenceData=function(e,t,n){var i,r,o,s;for(i=0;i<e.length;i++)r={sourceId:(o=n[e[0].referenceId]).sourceId,resourceId:o.resourceId},(s=e[i]).getActiveRepresentation().src=r,this.handleReferenceWithSourceId(s,t)},i.prototype.handleReferenceWithSourceId=function(e,n){var i=e.getActiveRepresentation().getSrc(),r=i.sourceId,o=n.manager._ldhNodeManager.getServiceUrl(r),s=i.resourceId,a=o+({r2vsurvey:"/enovia/resources/r2v/v1/modeler",globe:"/datasupplier/dataset/3dstile"}[r]||"")+"/tileset"+(this.getSecurityParamsCB?"?tenant="+this.getSecurityParamsCB().tenant:""),d={resourceId:s};t.authenticatedRequest(a,{cors:!0,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify(d),onComplete:(t,i)=>{var r=JSON.parse(t);e.getActiveRepresentation().setSrc(r),this.handleResolvedReference(e,n)},onFailure:()=>{n.doneCB([],[e])}})},i}),define("DS/3DXMTiles/MultiPartLoader",["DS/3DXMTiles/ModelBank","DS/3DXMTiles/LDHStats","DS/Visualization/ModelLoader","DS/WAFData/WAFData","DS/3DXMTiles/LDHRepresentationLoader"],function(e,t,n,i,r){"use strict";var o=localStorage.getItem("OOCBoxDebug");function s(e,t,n){var i,r;for(i=t;i<e.length;i++){if(13===(r=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===r)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}return class{constructor({onModelLoaded:e,onModelError:t,manager:i,saveToBank:r}){this.onModelError=t||function(){},this.onModelLoaded=e||function(){},this.saveToBank=!!r,this.modelLoader=new n,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.manager=i,this.datas=[]}parseMultiPartData(n,i,r,s,a,d){var l,h=0,c=i.__file_count__;if(d)h=1;else if(c)h=parseInt(c);else for(l=0;l<r.length;l++)r[l]&&h++;var u=this;function p(e,n,i){o&&(e.byteSize=i),t.onLoadedModel(i),u.onModelLoaded(e,n,a)}function f(e){u.onModelError(e)}if(h>1){var g=0,m=0;for(l=0;l<h;l++){for(;!r[m]&&m<r.length-1;)m++;g=this.parsePart(new Int8Array(n),g,r,p,f,m,s),m++}var S,y=[],v=[],M=[],L=[];for(l=0;l<this.datas.length;l++)(D=r[this.datas[l].referenceIndex])&&(S=D.getActiveRepresentation(),y.push(D.referenceId),v.push(S.type),M.push(S.wms),L.push(this.datas[l].data));u.saveToBank&&(e.storeModelData(y,v,this.tenant,L,M),u.datas=[])}else{if(m=-1,d){var T=d.split("reference_");m=parseInt(T[1])}for(l=0;l<r.length;l++){var D,C;(D=r[l])&&(m<0||l===m)&&(this.saveToBank&&(C=D.getActiveRepresentation(),e.storeModelData([D.referenceId],[C.type],this.tenant,[n],[C.wms])),this.loadPart(n,D,p,f))}}}parsePart(e,t,n,i,r,o,a){var d,l,h,c=new TextDecoder,u=t,p=-1;do{u=(d=s(e,u,c)).index,(h=d.str).startsWith("Content-length:")&&(l=h.split(" "),p=parseInt(l[1])),a&&h.startsWith("X-CorelationID:")&&(l=h.split("reference_"),o=parseInt(l[1]))}while(p<0&&u<e.length);var f=n[o];if(u=(d=s(e,u,c)).index,p>0){var g=e.buffer.slice(u,u+p);if(this.saveToBank){var m=e.buffer.slice(u,u+p);this.datas.push({data:m,referenceIndex:o})}this.loadPart(g,f,i,r)}return u+p}loadPart(e,t,n,i){if(t){var o=t.getActiveRepresentation(),s=t.getPrimaryRepresentation(),a=o.node;if(a){var d=e.byteLength;this.modelLoader.setOnLoadedProductStructureCallback(function(e){n(t,e,d)}),this.modelLoader.setOnErrorCallback(function(){i(t)});var l={};r.setupModelLoaderOptions(this.modelLoader,l,t,o,s,this.manager,e),this.modelLoader.loadModelFromBuffer(e,a,l)}else i(t)}}loadFromFCSTicket(e,t,n,r){var o={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:t},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:(e,t)=>{this.parseMultiPartData(e,t,n,!1,r)},onFailure:()=>{let e;for(e=0;e<n.length;e++)this.onModelError(n[e]);console.log("checkout ERROR")}};i.authenticatedRequest(e,o)}}}),define("DS/3DXMTiles/DSTilesTileSetContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils"],function(e,t,n,i,r,o){"use strict";function s(e){this.tileSet=e}return class extends e{constructor(e){super(e=e||{})}getBudgetParams(){return{name:"json",physicalBudget:"cpu",params:{}}}isReady(){return!0}loadContentFromBuffer({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,params:o}){t.queue;let a=(new TextDecoder).decode(e),d=JSON.parse(a);this.tilesManager.createFromJSON(d,t.getSgNode(),!1).then(e=>{let t=new s(e);n.setContentToken(t),e.setVisibility(!1),e.setPauseLoading(!1,"_init_",this.tilesManager.ldhNodeManager),i()})}showContent(e,t){t.contentToken.tileSet.setVisibility(!0)}hideContent(e,t){t.contentToken.tileSet.setVisibility(!1)}deleteContent(e,t,n){this.tilesManager.removeTileSet(n.tileSet)}exportContent(e,t){}needsSgNodePerContent(){return!0}}}),define("DS/3DXMTiles/DSTilesMeshContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils"],function(e,t,n,i,r,o){"use strict";var s=function(t){t=t||{},e.call(this,t)};(s.prototype=Object.create(e.prototype)).getBudgetParams=function(){return{name:"mesh",physicalBudget:"gpu",params:{}}},s.prototype.isReady=function(){return n.isReady()},s.prototype.loadContentFromBuffer=function({data:e,node:t,content:i,onLoadedCB:r,onErrorCB:o,sourceId:s,params:d}){var l=t.queue;let h=t.tileSet.getContentSource(s);var c=new a(t,i,l);n.loadFromBuffer(e,c.targetSGNode,i.getFormat(),this.onModelLoaded.bind(this,c,r),this.onModelError.bind(this,c,o),!1,h,i)},s.prototype.onModelLoaded=function(e,t){var n=e.node;e.queue;n.isAlive()&&(e.content.setContentToken(e),e.computeMemorySize(),this.budget.updateUsage(0,e.geometrySize)),t()},s.prototype.onModelError=function(e,t){e.node,e.queue;t()},s.prototype.showContent=function(e,t){let n=t.contentToken;if(n){e=n.node;var i,r,o=n.targetSGNode,s=e.getSgNode();for(n.nodes.length=0,r=0;r<o.children.length;r++)i=o.children[r],s.addChild(i),n.nodes.push(i);o.removeChildren()}},s.prototype.hideContent=function(e,t){let n=t.contentToken;if(n){e=n.node;var i,r,o=n.targetSGNode,s=e.getSgNode();for(r=0;r<n.nodes.length;r++)i=n.nodes[r],s.removeChild(i),o.addChild(i)}},s.prototype.deleteContent=function(e,t,n){n&&(this.hideContent(e,t),this.budget.updateUsage(n.geometrySize,0),n.targetSGNode=null,n.geometrySize=0)},s.prototype.exportContent=function(e,t){let n=t.contentToken;if(n)return n.nodes.length>0?[].concat(n.nodes):[].concat(n.targetSGNode.children)},s.prototype.needsSgNodePerContent=function(){return!0};var a=function(e,t,n){this.node=e,this.content=t,this.queue=n,this.targetSGNode=new i,this.nodes=[],this.visible=!1,this.geometrySize=0};return a.prototype.computeMemorySize=function(){this.geometrySize=o.computeMeshSize(this.targetSGNode)},s}),define("DS/3DXMTiles/DSTilesPriorityQueue",["DS/3DXMTiles/DSTilesNode"],function(e){"use strict";var t=function(){this.reset()};t.prototype.reset=function(){this.tileNode=null,this.parent=null,this.less=null,this.more=null},t.prototype.check=function(){var e=[];!function t(n){e.indexOf(n)>-1?console.log("argl"):(e.push(n),n.less&&t(n.less),n.more&&t(n.more))}(this)},t.prototype.checkMinMax=function(e,t){var n=!0;return this.tileNode&&(this.tileNode.isLessPrioritaryThan(e)||this.tileNode.isMorePrioritaryThan(t))&&(console.log("ERRRRRRRRRRREUUUUUUR"),n=!1),this.less&&!this.less.checkMinMax(e,t)&&(n=!1),this.more&&!this.more.checkMinMax(e,t)&&(n=!1),n},t.prototype.removeMin=function(e){var t=this.less;null!==t&&(null===t.less?(this.less=t.more,null!==this.less&&(this.less.parent=this),e.releaseHeapNode(t)):t.removeMin(e))},t.prototype.removeMax=function(e){var t=this.more;null!==t&&(null===t.more?(this.more=t.less,null!==this.more&&(this.more.parent=this),e.releaseHeapNode(t)):t.removeMax(e))},t.prototype.insert=function(e){e.tileNode.isLessPrioritaryThan(this.tileNode)?null!==this.less?this.less.insert(e):(this.less=e,e.parent=this):null!==this.more?this.more.insert(e):(this.more=e,e.parent=this)},t.prototype.getMin=function(){return null===this.less?this:this.less.getMin()},t.prototype.getMax=function(){return null===this.more?this:this.more.getMax()},t.prototype.getTileNodes=function(e){null!==this.tileNode&&e.push(this.tileNode),this.more&&this.more.getTileNodes(e),this.less&&this.less.getTileNodes(e)};var n=function(t){this.size=0,this.sizeLimit=t,this.root=null,this.firstFreeHeapNode=null,this.minHeapNode=e.MinusInfinity,this.maxHeapNode=e.PlusInfinity};n.prototype.getTileNodes=function(){var e=[];return null!==this.root&&this.root.getTileNodes(e),e},n.prototype.tryToInsertTileNodeMax=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.minHeapNode.isLessPrioritaryThan(e)){this.insert(e),t.min=null;var i=this.root.getMin();return this.minHeapNode=i.tileNode,!0}return!1}if(this.minHeapNode.isLessPrioritaryThan(e)){i=this.root.getMin();t.min=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMin(this):this.setRoot(i.more),this.size--;var r=this.root.getMin();return this.minHeapNode=r.tileNode,!0}return!1},n.prototype.tryToInsertTileNodeMin=function(e,t,n){if(this.size<this.sizeLimit){if(!n||this.maxHeapNode.isMorePrioritaryThan(e)){this.insert(e),t.max=null;var i=this.root.getMax();return this.maxHeapNode=i.tileNode,!0}return!1}if(this.maxHeapNode.isMorePrioritaryThan(e)){i=this.root.getMax();t.max=i.tileNode,this.insert(e),null!==i.parent?i.parent.removeMax(this):this.setRoot(i.less),this.size--;var r=this.root.getMax();return this.maxHeapNode=r.tileNode,!0}return!1},n.prototype.setRoot=function(e){null!==this.root&&this.releaseHeapNode(this.root),this.root=e,null!==e&&(e.parent=null)},n.prototype.getAndRemoveMaxTileNode=function(){var e=this.root.getMax(),t=e.tileNode;return this.removeMaxHeapNode(e),t},n.prototype.removeMaxHeapNode=function(e){null!==e.parent?e.parent.removeMax(this):this.setRoot(e.less),this.size--},n.prototype.removeMinHeapNode=function(e){null!==e.parent?e.parent.removeMin(this):this.setRoot(e.more),this.size--},n.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin(),t=e.tileNode;return this.removeMinHeapNode(e),t},n.prototype.getMinHeapNode=function(){return null!==this.root?this.root.getMin():null},n.prototype.getMaxHeapNode=function(){return null!==this.root?this.root.getMax():null},n.prototype.insert=function(e){var t=this.getHeapNode(e);null===this.root?this.setRoot(t):this.root.insert(t),this.size++},n.prototype.getHeapNode=function(e){var n;return this.firstFreeHeapNode?(n=this.firstFreeHeapNode,this.firstFreeHeapNode=n.more,n.reset()):n=new t,n.tileNode=e,n},n.prototype.releaseHeapNode=function(e,t){e.less=null,t&&t(e.tileNode),e.tileNode=null,e.more=this.firstFreeHeapNode,this.firstFreeHeapNode=e},n.prototype.releaseHeapNodeTree=function(e,t,n){null!==e.less&&(this.releaseHeapNodeTree(e.less,t+1,n),e.less=null),null!==e.more&&(this.releaseHeapNodeTree(e.more,t+1,n),e.more=null),this.releaseHeapNode(e,n)},n.prototype.reset=function(t){null!==this.root&&(this.releaseHeapNodeTree(this.root,0,t),this.root=null,this.minHeapNode=e.MinusInfinity),this.size=0};var i=0,r=function(e){this.id=i++,this.nodeList=[],this.nbProcessedNodes=0,this.nodeListLength=0,this.listWasUpdated=!1,this.maxHeapNode=null,this.minHeapNode=null,this.negativeNodes=[],this.heap=new n(e||100)};r.prototype.fillHeapMax=function(e){var t,n,i,r={min:null},o=this.nodeListLength,s=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):s.tryToInsertTileNodeMax(t,r,0!==l)&&(n=r.min,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;a(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},r.prototype.fillHeapMin=function(e){var t,n,i,r={max:null},o=this.nodeListLength,s=this.heap,d=0,l=e?0:this.nbProcessedNodes,h=[];for(i=l;i<o;i++)null!==(t=this.nodeList[i])&&t.isAlive()?t.getScore()<0?(this.negativeNodes.push(t),this.nodeList[i]=null,d++):s.tryToInsertTileNodeMin(t,r,0!==l)&&(n=r.max,this.nodeList[i]=n,null===n?d++:h.push(i)):d++;a(this.nodeList,h,l,o),this.nbProcessedNodes=i,d>=this.nodeListLength?(this.nodeListLength=0,this.nbProcessedNodes=0):d>200&&this.cleanNulls(!0)},r.prototype.getMaxNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var t,n=this.nodeListLength,i=-1,r=e.MinusInfinity,o=null,s=0;for(t=0;t<n;t++)null!==(o=this.nodeList[t])&&o.isAlive()?o.isMorePrioritaryThan(r)&&(i=t,r=o):s++;return i>-1?(o=this.nodeList[i],this.nodeList[i]=null):o=null,s>=this.nodeListLength?this.nodeListLength=0:s>200&&this.cleanNulls(!1),o},r.prototype.peekMaxNode=function(){if(!this.maxHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0?e=this.heap.root.getMax():this.negativeNodes.length>0&&(e=this.negativeNodes[this.negativeNodes.length-1]),this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null},r.prototype.peekMinNode=function(){if(!this.minHeapNode){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var e=null;this.heap.size>0&&(e=this.heap.root.getMin()),this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null},r.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)},r.prototype.getMaxNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.heap.size>0?t=e?this.heap.getAndRemoveMaxTileNode():this.heap.getMaxNode():this.negativeNodes.length>0&&(t=this.negativeNodes.pop()),t},r.prototype.getMinNode=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t=null;return this.negativeNodes.length>0?t=this.negativeNodes.pop():this.heap.size>0&&(t=e?this.heap.getAndRemoveMinTileNode():this.heap.getMinNode()),t},r.prototype.checkIntegrity=function(e){var t,n=-1/0,i=1/0;if(this.heap.size>0)for(n=this.heap.root.getMin().tileNode,i=this.heap.root.getMax().tileNode,this.heap.root.checkMinMax(n,i)||console.log("checkMinMax has failed!!!"),t=0;t<(void 0!==e?e:this.nodeListLength);t++)this.nodeList[t]&&this.nodeList[t].isMorePrioritaryThan(n)&&console.log("found probleme!!!")},r.prototype.getMinNodeWithNoHeap=function(){if(null!==this.heap.root)throw new Error("Heap not empty");var t,n=this.nodeListLength,i=-1,r=e.PlusInfinity,o=null,s=0;for(t=0;t<n;t++)null!==(o=this.nodeList[t])&&o.isAlive()?o.isLessPrioritaryThan(r)&&(i=t,r=o):s++;return i>-1?(o=this.nodeList[i],this.nodeList[i]=null):o=null,s>=this.nodeListLength?this.nodeListLength=0:s>200&&this.cleanNulls(!1),o},r.prototype.cleanNulls=function(e){var t,n=this.nodeListLength,i=null,r=0;for(t=0;t<n;t++)null!==(i=this.nodeList[t])&&i.isAlive()?(this.nodeList[r]=i,r++):e&&t<this.nbProcessedNodes&&this.nbProcessedNodes--;this.nodeListLength=r,this.nodeList.length=this.nodeListLength},r.prototype.isEmpty=function(){return 0===this.heap.size&&0===this.nodeListLength&&0===this.negativeNodes.length},r.prototype.clear=function(e){var t;if(this.heap.reset(e),e)for(t=0;t<this.nodeListLength;t++)this.nodeList[t]&&e(this.nodeList[t]);this.nodeListLength=0,this.nbProcessedNodes=0,this.maxHeapNode=null,this.minHeapNode=null},r.prototype.resetOrder=function(e){var t,n=this.heap.getTileNodes();for(this.heap.reset(),t=0;t<n.length;t++)this.addNode(n[t]);for(t=0;t<this.negativeNodes.length;t++)this.addNode(this.negativeNodes[t]);if(this.negativeNodes.length=0,e){var i,r=0;for(t=0;t<this.nodeListLength;t++)(i=this.nodeList[t])&&e(i)&&(this.nodeList[r]=i,r++);this.nodeListLength=r}};var o=0;function s(e,t){var n,i=(n=o+=1831565813,n=Math.imul(n^n>>>15,1|n),(((n^=n+Math.imul(n^n>>>7,61|n))^n>>>14)>>>0)%(t-e)),r=e+(i=i<0?i+(t-e):i);return isFinite(r)?r:-1}function a(e,t,n,i){let r;for(r=0;r<t.length;r++){let o=t[r],a=s(n,i),d=e[o];a!==o&&a>=0&&(e[o]=e[a],e[a]=d)}}return r.prototype.addNode=function(e,t){this.nodeListLength>=this.nodeList.length?(this.nodeList.push(null),this.nodeListLength=this.nodeList.length):this.nodeList[this.nodeListLength++]=null,t?this.nodeList[this.nodeListLength-1]=e:function(e,t,n,i){if(i<=1)e[i-1]=t;else{var r=s(n,i);r<0&&(r=i-1),r>=i-1?e[i-1]=t:(e[i-1]=e[r],e[r]=t)}}(this.nodeList,e,this.nbProcessedNodes,this.nodeListLength),this.listWasUpdated=!0},r.prototype.peekMinHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMinHeapNode()},r.prototype.peekMaxHeapNode=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getMaxHeapNode()},r.prototype.traverseMin=function(e){var t,n,i;for((0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1),t=this.negativeNodes.length-1;t>=0;t--){if(!e(this.negativeNodes[t]))return;this.negativeNodes.length--}do{i=!0,null!==(n=this.peekMinHeapNode())&&e(n.tileNode)&&(this.heap.removeMinHeapNode(n),i=!1)}while(!i)},r.prototype.traverseMinPlus=function(e){(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMin(0===this.heap.size),this.listWasUpdated=!1);var t,n,i,r,o,s=[];function a(){i=!0}function d(){n=!0}for(n=!1,r=this.negativeNodes.length-1;r>=0&&!n;r--)o=this.negativeNodes[r],i=!1,n=!1,e(o,d,a),this.negativeNodes.length--,i&&s.push(o);for(;!n;)n=!1,i=!1,null!==(t=this.peekMinHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&s.push(t.tileNode),this.heap.removeMinHeapNode(t))):n=!0;for(r=0;r<s.length;r++)this.addNode(s[r],!1)},r.prototype.traverseMax=function(e){var t,n;do{n=!0,null!==(t=this.peekMaxHeapNode())&&e(t.tileNode)&&(this.heap.removeMaxHeapNode(t),n=!1)}while(!n)},r.prototype.traverseMaxPlus=function(e){var t,n,i,r,o=[],s=!1;function a(){i=!0}function d(){n=!0}do{n=!1,i=!1,null!==(t=this.peekMaxHeapNode())?(e(t.tileNode,d,a),n&&i||(i&&o.push(t.tileNode),this.heap.removeMaxHeapNode(t))):s=!0}while(!n&&!s);for(r=this.negativeNodes.length-1;r>=0&&!n;r--){let t=this.negativeNodes[r];i=!1,n=!1,e(t,d,a),this.negativeNodes.length--,i&&o.push(t)}for(r=0;r<o.length;r++)this.addNode(o[r],!1)},r.prototype.removeNode=function(e){var t;for(this.resetOrder(),t=0;t<this.nodeListLength;t++)this.nodeList[t]===e&&(this.nodeList[t]=null)},r.prototype.getAllNodes=function(){var e,t,n=[];for(t=0;t<this.nodeListLength;t++)(e=this.nodeList[t])&&n.push(e);var i=this.heap.getTileNodes();return n.concat(i)},r.prototype.getMaxNodes=function(){return(0===this.heap.size||this.listWasUpdated)&&(this.fillHeapMax(0===this.heap.size),this.listWasUpdated=!1),this.heap.getTileNodes()},r.prototype.getSize=function(){return this.cleanNulls(),this.nodeListLength+this.heap.size},r}),define("DS/3DXMTiles/DSTilesQueue",["DS/3DXMTiles/DSTilesPriorityQueue","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/UpdateNodeContentData"],function(e,t,n){"use strict";var i=function(t,n){this.sortingMetric=n,this.nodes=[],this.newNodes=[],this.contentsToUpdateSet=new Set,this.nodesToUpdateSet=new Set,this.nodesToLoadQueue=new e,this.nodesToExpandQueue=new e,this.unloadSmallNodesQueue=new e,this.tmpTraverseRoots=new Set,this.unloadSmallNodesInitNeeded=!0,this.queueSet=t,this.nbLoading=0,this.nbExpanding=0,this.updateIndex=0};i.prototype.registerRootNodeFromLink=function(e,t,n){var i=e.expander,r=this;i.loadNodeFromLink(e.link,function(n){e.node=n,r.registerDSTilesNode(n),r.registerRootNode(e),t(n)},n,this)},i.prototype.registerDSTilesNode=function(e,t){if(e.isAlive())e.isInUnload()||e.setInUnload(!0),e.isInList()?t&&this.forceUpdateNode(e):(e.setInList(!0),this.newNodes.push(e)),this.getLDHManager().requestUpdate(!1,!1);else if(e.isInToBeLoaded()&&(e.setInToBeLoaded(!1),this.nodesToLoadQueue.removeNode(e)),e.isInToExpand()&&(this.nodesToExpandQueue.removeNode(e),e.setInToExpand(!1)),e.isInUnload()&&e.setInUnload(!1),e.isInList()){var n=this.newNodes.indexOf(e);n>=0&&(this.newNodes[n]=null),(n=this.nodes.indexOf(e))>=0&&(this.nodes[n]=null),e.setInList(!1)}},i.prototype.unloadSmallNodes=function(e){var t,n,i=this.getTilesManager().memoryManager;if(this.unloadSmallNodesInitNeeded)for(this.unloadSmallNodesInitNeeded=!1,t=0;t<this.nodes.length;t++)(n=this.nodes[t])&&n.isContentLoaded()&&!n.getToUnload()&&this.unloadSmallNodesQueue.addNode(n);var r=!1,o=null;if(this.unloadSmallNodesQueue.traverseMinPlus((t,n,s)=>{t.getScore()<e||t.getOnHold()?t.isUnloadLocked()?s():(t.lockLoadDate=Date.now()+2e3,t.isReplaceLODMode()&&t.getContentVisible()&&(o||(o=new Set),o.add(t.getRoot())),t.deleteContent(this),i.isLoadingAllowed()&&n()):(r=!0,n())}),o){let e=this.getViewer();o.forEach(t=>{t.traverseReplaceProgressive(e)})}return r},i.prototype.getTilesManager=function(){return this.queueSet.tilesManager},i.prototype.getLDHManager=function(){return this.queueSet.tilesManager.ldhNodeManager},i.prototype.forceUpdateNode=function(e){this.nodesToUpdateSet.add(e)},i.prototype.updateNodes=function(e,t){var n;if(this.updateIndex++,!e)for(this.updateNodesToLoad(this.newNodes,t);this.nodesToUpdateSet.size>0;){var i=this.nodesToUpdateSet;this.nodesToUpdateSet=new Set,this.updateNodesToLoad(Array.from(i),t)}for(n=0;n<this.newNodes.length;n++)this.nodes.push(this.newNodes[n]);if(this.newNodes.length=0,this.nodesToUpdateSet.clear(),e&&this.resetNodesToLoad(),e)this.updateNodesToLoad(this.nodes,t);else{var r=this.getViewer();this.tmpTraverseRoots.forEach(e=>{e.traverseUpdateNodes(r)}),this.tmpTraverseRoots.clear()}},i.prototype.loadNodes=function(e,t){this.unloadSmallNodesInitNeeded=!0,this.unloadSmallNodesQueue.clear();var n=!1,i=this.getTilesManager().memoryManager,r=this,o=Date.now(),s=new Set;this.loadUpdatedContent(s),this.nodesToLoadQueue.traverseMaxPlus(function(e,t,a){if(e.isAlive()){var d=!1,l=e.tileSet;l.getPauseLoading()?e.setInToBeLoaded(!1):(l.canLoadContent()&&e.lockLoadDate<o&&(n||e.isContentLoadingAllowed(i)||(n=r.unloadSmallNodes(e.getScore())),e.isContentLoadingAllowed(i)&&e.isContentToLoad()&&!e.isError()&&(l.loadTileContent(e),s.add(l),r.nbLoading++,e.setInToBeLoaded(!1),d=!0)),d||(a(),t()))}}),s.forEach(e=>{e.flushLoadTileContent()}),s=new Set,this.nodesToExpandQueue.traverseMaxPlus(function(e,t,n){if(e.isAlive()){var o=!1,a=(e.expander,e.tileSet);!a.getPauseLoading()&&a.canExpand()&&e.isExpandLoadingAllowed(i)&&e.isExpandToLoad()&&!e.isError()&&(a.expandTile(e),s.add(a),r.nbExpanding++,e.setInToExpand(!1),o=!0),o||(n(),t())}}),s.forEach(e=>{e.flushExpandTile()})},i.prototype.loadUpdatedContent=function(e){let t,n=[],i=new Set;for(this.contentsToUpdateSet.forEach(e=>{let t=e.node,r=e.content,o=!1;t.isContentLoading()||(!r.contentToken||r.updatedContentVersion>e.updateVersion?o=!0:r.contentLoader.createUpdatedContentTokenFromContentToken(r,t)?o=!0:t.getContentVisible()||(o=!0,i.add(t)),o&&(e.onUpdatedCB(),n.push(e)))}),i.forEach(e=>{e.deleteContent(e.queue)}),t=0;t<n.length;t++)this.contentsToUpdateSet.delete(n[t]);n.length>0&&this.getLDHManager().requestUpdate(!1);for(n.length=0,this.contentsToUpdateSet.forEach(t=>{let i=t.node,r=i.tileSet;t.content;r.getPauseLoading()||!r.canLoadContent()||i.isContentLoading()||(e.add(r),r.updateNodeContent(t,this),n.push(t))}),t=0;t<n.length;t++)this.contentsToUpdateSet.delete(n[t])},i.prototype.cleanLists=function(){function e(e){var t,n=0;for(t=0;t<e.length;t++)null!==e[t]&&(e[n]=e[t],n++);e.length=n}e(this.nodes),e(this.newNodes)},i.prototype.onNodeLoaded=function(e){if(this.nbLoading--,e.tileSet.setNodeEndLoading(),e.isAlive()){e.setContentStatus(t.loaded,this);e.parent;e.isAddLODMode()&&e.getWished()&&e.showContent();var n=this.getLDHManager();e.isReplaceLODMode()&&this.tmpTraverseRoots.add(e.getRoot()),n.requestUpdate(!1,!1),n.viewer.render({budgeted:!0})}},i.prototype.onNodeLoadError=function(e){(this.nbLoading--,e.isAlive())&&(e.setContentStatus(t.error,this),e.tileSet.setNodeEndLoading(),this.getLDHManager().requestUpdate(!1,!1))},i.prototype.onNodeExpanded=function(e){(this.nbExpanding--,e.isAlive())&&(this.tmpTraverseRoots.add(e.getRoot()),e.setExpandStatus(t.loaded,this),e.tileSet.setNodeEndExpanding(),e.children||(e.children=[]),this.getLDHManager().requestUpdate(!1,!1))},i.prototype.onNodeExpandError=function(e){(this.nbExpanding--,e.isAlive())&&(e.setExpandStatus(t.error,this),e.tileSet.setNodeEndExpanding(),e.children=[],this.getLDHManager().requestUpdate(!1,!1))},i.prototype.computeTilesScore=function(e,n,i){var r,o,s;for(r=0;r<e.length;r++)if((o=e[r])&&!o.getOnHold()&&!o.isError())if(o.computeScore(this.updateIndex,n),o.passVisibilityTest()){if(o.setToUnload(!1),o.getChildrenOnHold()&&!o.passPixelErrorTest()&&(o.setChildrenOnHold(!1),o.children))for(s=0;s<o.children.length;s++)i.add(o.children[s]),o.children[s].setOnHold(!1);!o.hasExpand()||o.isExpandLoading()||o.isExpandLoaded()||(o.setExpandStatus(t.toLoad,this),o.isInToExpand()||(this.nodesToExpandQueue.addNode(o),o.setInToExpand(!0)))}else o.setToUnload(!0)},i.prototype.updateNodesToLoad=function(e,t){for(var n=e;n.length;){var i=new Set;this.computeTilesScore(n,t,i),n=Array.from(i)}},i.prototype.updateNodesToLoad_OLD=function(e,n){var i,r,o=!1,s=[];for(i=0;i<e.length;i++)!(r=e[i]).tileSet.getPauseLoading()&&r&&r.isAlive()&&!r.getOnHold()&&!r.isError()&&r.lastUpdateIndex<this.updateIndex&&(r.lastUpdateIndex=this.updateIndex,r.scoreComputer.computeScore(r,n,r.isLODMode()),r.passVisibilityTest()?(r.setToUnload(!1),!r.hasContent()||r.isContentLoading()||r.isContentLoaded()||(r.setContentStatus(t.toLoad,this),r.isInToBeLoaded()||(this.nodesToLoadQueue.addNode(r),r.setInToBeLoaded(!0))),!r.hasExpand()||r.isExpandLoading()||r.isExpandLoaded()||(r.setExpandStatus(t.toLoad,this),r.isInToExpand()||(this.nodesToExpandQueue.addNode(r),r.setInToExpand(!0))),r.isLODMode()&&s.push(r)):r.setToUnload(!0));for(i=0;i<s.length;i++)(r=s[i]).updateLODHierarchy(this)&&(o=!0);o&&this.getLDHManager().requestUpdate(!1,!1)};let r=0;return i.updateNodesContents=function(e,t,i){let o;for(r++,o=0;o<t.length;o++){let s=e[o],a=t[o],d=s.queue,l=new n(s,a,r,i);l.content.setUpdatedContentVersion(r),d.contentsToUpdateSet.add(l)}return r},i.prototype.resetNodesToLoad=function(){this.nodesToExpandQueue.clear(function(e){e.setInToExpand(!1)}),this.nodesToLoadQueue.clear(function(e){e.setInToBeLoaded(!1)})},i.prototype.getViewer=function(){return this.getLDHManager().viewer},i.prototype._dbgGetNodeFromURI=function(e){var t;for(t=0;t<this.nodes.length;t++)if(this.nodes[t].uri===e)return this.nodes[t];return null},i}),define("DS/3DXMTiles/DSTilesGenericScoreComputer",["DS/3DXMTiles/DSTilesScoreComputer","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/ThreeJS_DS"],function(e,t,n){"use strict";var r=function(e){this.minScreenRadius=e.minScreenRadius||5};return(r.prototype=Object.create(e.prototype)).getSortingMetric=function(){return this.sortingMetric},r.prototype.getScreenRadiusCache=function(e){var n=e.screenRadiusCache;if(!n){var i=e.getBoundingSphere();n=[];var r,o=e.worldPosition;for(r=0;r<o.matrixArray.length;r++)n.push(t.computeScreenRadiusCache(o.matrixArray[r],null,i,!1,!1));e.screenRadiusCache=n.length>0?n:null}return n},r.prototype.getDistanceToBoxCache=function(e){var n=e.distanceToBoxCache;if(!n||0===n.length){var i=e.getBoundingBox();n=[];var r,o=e.worldPosition;for(r=0;r<o.matrixArray.length;r++)n.push(t.computeDistanceToBoxCache(o.matrixArray[r],i));e.distanceToBoxCache=n.length>0?n:null}return n},r.prototype.computeScore=function(e,n,i){var r=e.getTriggerMetric(),o=e.getSortingMetric();if(e.getBoundingSphere()){var s,a,d,l=n.viewpoint,h=l.getEyePosition(),c=n.cst,u=this.getScreenRadiusCache(e),p=!1,f=-1/0;for(s=0;s<u.length;s++){if((d=u[s]).containsPoint(h))return e.score=1/0,void(e.pixelError=1/0);l._frustum.performFrustumCullingNoNearFar(d.radius,d.center)&&(a=t.computeScreenRadius(d,l.camera,l._frustum,c,!1,!1,!0))>=this.minScreenRadius&&(p=!0,f=a>f?a:f)}var g,m=0;if("pixelError"===o||i&&"pixelError"===r)for(m=-1/0,s=0;s<u.length;s++)m=(g=this.computePixelError(e.geometricalError,u[s],n))>m?g:m;var S=0;("distanceToBox"===o||i&&"distanceToBox"===r)&&(S=this.computeDistanceToBox(e,n));var y=1/0;if("distanceToSphere"===o){var v=1/0;for(s=0;s<u.length;s++)y=(d=u[s]).containsPoint(h)?0:y<(v=d.center.distanceTo(h)-d.radius)?y:v}var M=0,L=-1;if(p)switch(o){case"screenRadius":M=f;break;case"distanceToBox":M=1/S;break;case"distanceToSphere":M=1/y;break;case"pixelError":M=m}if(p&&i)switch(r){case"pixelError":L=m;break;case"distanceToBox":for(L=0,s=0;s<u.length;s++)d=u[s],S<e.geometricalError*d.scale&&(L=1/0)}e.score=M,e.pixelError=L}else e.score=1/0,i&&(e.pixelError=-1)},r.prototype.computeDistanceToBox=function(e,t){if(!e.getBoundingBox())return-1;var n,r=this.getDistanceToBoxCache(e),o=t.viewpoint.getEyePosition(),s=1/0;for(i=0;i<r.length;i++)s=(n=r[i].boundingBox.distanceToPoint(o))<s?n:s;return s},r.prototype.computePixelError=function(e,t,i){var r,o=i.viewpoint,s=t.radius,a=t.center,d=o.getEyePosition(),l=o.getSightDirection(),h=new n.Vector3(a.x-d.x,a.y-d.y,a.z-d.z),c=h.length();h.multiplyScalar((c-s)/c);var u=h.dot(l);if(u<0)r=1/0;else{var p=1/(u*i.cst);r=t.scale*e*p}return t.radius=s,t.center=a,r},r}),define("DS/3DXMTiles/DSTilesStylingRenderRamp",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingRender"],function(e,t){"use strict";class n extends t{constructor(){super(),this.attribute=null,this.values=[],this.colors=[]}setFromJSON(t){let n=[],i=t.attribute;e.isStylingAttributeName(i)?this.attribute=i:n.push(e.error("illegal attribute property","ramp"));let r,o=!1;for(r=0;r<t.values.length;r++){let n=t.values[r];e.isNumberOrString(n)?this.values.push(n):o=!0}for(o&&n.push(e.error("illegal value","ramp")),o=!1,r=0;r<t.colors.length;r++){let n=t.colors[r];e.isNumberOrString(n)?this.colors.push(n):o=!0}return o&&n.push(e.error("illegal color","ramp")),n.length?e.error("Error parsing ramp render","render",n):this.colors.length!==this.values.length+1?e.error("colors.length !== values.length+1","ramp"):e.ok}addNeededAttributesToSet(e){e.add(this.attribute)}buildShaderGlobalCode(e){const t=e.variableHandler,n=e.functionHandler,i=e=>n.prmF(e),r=e=>n.prmV3(e);return`\n            ${n.dF("computeInterpolatedColor","v3",[i("value"),i("value0"),i("value1"),r("color0"),r("color1")])} {\n                if(value0 == value1) {\n                    return color0;\n                } else {\n                    ${(e=>t.float(e))("k")} = (value - value0)/(value1 - value0);\n                    return (1.0 - k) * color0 + k*color1;\n                }\n            }\n            `}buildShaderCode(e){const i=e.variableHandler,r=e.functionHandler,o=e=>i.float(e),s=e=>i.vec3(e),a=e=>r.prmF(e),d=e=>r.prmV3(e);let l=`\n                ${s("color")} = ${n.toShaderColor(this.colors[this.colors.length-1],s,o)};\n                ${o("value")} = ${o()}(${this.attribute});\n            `;for(let e=0;e<this.values.length;e++){let n=this.values[e],i=t.toShaderColor(this.colors[e],s,o);if(0===e)l=`\n                        ${l}\n                        if (value <= ${o()}(${n})) {\n                            color = ${i};\n                        }\n                    `;else{let h=t.toShaderColor(this.colors[e-1],s,o),c=this.values[e-1];l=`\n                        ${l}\n                        else if (value <= ${o()}(${n})) {\n                            color = ${r.cF("computeInterpolatedColor","v3",[a("value"),a(`${o()}(${c})`),a(`${o()}(${n})`),d(`${h}`),d(`${i}`)])};\n                        }\n                    `}}return l=`\n                ${l}\n                return color;\n            `}}return n.jsonType="ramp",n}),define("DS/3DXMTiles/LDHCandidateListRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/PriorityQueue"],function(e,t,n,i,r,o,s,a,d){"use strict";var l=function(e){this.references=[],this.node=null,this.root=e,this.occurrences=[],this.preserveReferences=null,this.material=null,this.previousDimension=-1,this.lastClusters=null,this.priorityQueue=null};l.prototype.createMesh=function(n){if(2===n.dimension)return t.createCuboidNode({cornerPoint:new e.Vector3(0,0,0),firstAxis:new e.Vector3(1,0,0),secondAxis:new e.Vector3(0,1,0),thirdAxis:new e.Vector3(0,0,1)});if(1===n.dimension){var i,r=[new e.Vector3(0,0,0),new e.Vector3(1,0,0),new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,0),new e.Vector3(0,0,1),new e.Vector3(1,0,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0),new e.Vector3(1,0,1),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(0,0,1),new e.Vector3(0,1,1),new e.Vector3(0,0,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(0,1,1),new e.Vector3(1,1,1),new e.Vector3(1,0,1),new e.Vector3(1,1,1),new e.Vector3(1,1,0)],o=[];for(i=0;i<r.length;i++)o.push(i);return t.createLineNode({points:r,drawMode:s.ConnectivityTypeEnum.LINES,idx:o})}},l.prototype.clearRepresentation=function(){this.node&&(this.root.removeChild(this.node),this.node=null)},l.prototype.dispose=function(){this.clearRepresentation(),this.material&&this.material.dispose()};l.prototype.updateRepresentation=function(e,t){this.previousDimension!==e.dimension&&this.material&&(this.material.dispose(),this.material=null),this.material||(this.material=this.buildMaterial(e)),this.clearRepresentation();var n=this.createMesh(e);this.occurrences=[],n.setMaterial(this.material);var i=null;i=-1===e.clusters?this.createInstancingData(e):this.createInstancingData_cluster(e,t),this.setUpMeshInstancingParameters(n,i.nbInstances,i.matrices,i.colors),n.forceBoundingElements(!0,{box:i.boundingBox}),this.node=n,i.nbInstances>0&&this.root.addChild(n)},l.prototype.createInstancingData=function(t){t=t||{};var n,i,r,o,s=new e.Box3,a=this.computeNbInstances(),l=new Float32Array(16*a),h=new Float32Array(3*a),c=0,u=this.references,p=t.count;if(p){for(this.priorityQueue||(this.priorityQueue=new d),this.priorityQueue.clear(),n=0;n<this.references.length;n++)this.priorityQueue.addNode(this.references[n]);u=[],this.priorityQueue.traverseMax(function(e,t,n){return u.push(e),!(u.length>=p)})}for(n=0;n<u.length;n++)if((r=u[n]).isAlive())for(o=r.getOccurrences(),i=0;null!==o&&i<o.length;i++)this.fillInstancingData(r,o[i],c,l,h,s,t)&&(this.occurrences.push(o[i]),c++);return{boundingBox:s,nbInstances:a,matrices:l,colors:h}},l.prototype.computeNbInstances=function(){var e,t,n,i=0;for(e=0;e<this.references.length;e++)n=(t=this.references[e]).getOccurrences(),t.isAlive()&&null!==n&&(i+=n.length);return i},l.prototype.buildMaterial=function(t){var n=1===t.dimension?new e.LineBasicMaterial({force:!0,opacity:t.opacity,depthWrite:!1}):new e.MeshBasicMaterial({force:!0,opacity:t.opacity,depthWrite:!1});n._activatePDSFXMigrated("LDHCandidatePDSFX");n.setPDSFXVaryings({vCandidateColor:{type:"v3"}});return n.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){const n=e.variableHandler,i=e=>n.vec4(e);return`\n\t\t\t\t    ${i("localPosition")}  = ${i()}(${e.vGetAttribPosition()}, 1.0);\n\t\t\t\t    ${i("newPosition")}  = instanceMatrix*localPosition;\n\t\t\t\t    return newPosition.xyz;\n                `},ComputeVaryingValues:function(e,t){return`\n                    ${(t=>e.getVarying(t))("vCandidateColor")} = instanceColor;\n                `}},{ComputeAlbedo:function(e,t){return`\n                    return ${(t=>e.getVarying(t))("vCandidateColor")};\n                `},ComputeSpecularReflectance:function(e,t){const n=e.variableHandler;return`\n                    return ${(e=>n.vec3(e))()}(1.0, 1.0, 1.0);\n                `}}),n},l.prototype.getOccurrencesInXSO=function(e){var t,n,i=e.get(),r=null;for(t=0;t<i.length;t++){var o;if(void 0!==(n=i[t].pathElement).instanceId&&n.getLastElement()===this.node)if(r||(r=[]),o=this.getOccurrenceFromInstanceId(n.instanceId)){var s=o.reference;r.push(o),this.preserveReferences||(this.preserveReferences=[]),-1===this.preserveReferences.indexOf(s)&&this.preserveReferences.push(s)}}return r},l.prototype.getOccurrenceFromInstanceId=function(e){var t=e/5-1;return this.occurrences[t]},l.prototype.getInstanceId=function(e){return 5*(this.occurrences.indexOf(e)+1)},l.prototype.createSelectionRestoringData=function(){return this.preserveReferences=null,[{xso:n,occurrences:this.getOccurrencesInXSO(n)},{xso:i,occurrences:this.getOccurrencesInXSO(i)},{xso:r,occurrences:this.getOccurrencesInXSO(r)}]},l.prototype.restoreSelection=function(e){var t;for(t=0;t<e.length;t++){var n=e[t].xso,i=e[t].occurrences;i&&this.addOccurrencesToXSO(n,i)}},l.prototype.addOccurrencesToXSO=function(e,t){var n,i,r,s;for(n=0;n<t.length;n++)s=null,i=t[n],(r=this.getInstanceId(i))>0?(s=new o([this.root,this.node])).instanceId=r:i instanceof a?i.reference.node&&(s=i.buildPathElement()):(s=new o).setFromOccurrence(i),s&&e.add({pathElement:s})};var h=new e.Matrix4,c=new e.Matrix4,u=new e.Matrix4,p=new e.Matrix4,f=new e.Vector3;function g(e,t){this.center=e.center(),this.bbox=e,this.bbox.applyMatrix4(t),this.matrix=t,this.center.applyMatrix4(t),this.clusterIndex=-1}function m(){this.center=new e.Vector3,this.nodes=[]}l.prototype.fillInstancingData=function(e,t,n,i,r,o,s){var a=e.getBoundingBox();if(!a)return!1;a=a.clone();var d=t.matrix;h.copy(d),f.set(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z),u.identity(),p.identity(),u.translate(a.min),p.scale(f),h.multiplyMatrices(u,p),c.multiplyMatrices(d,h);var l,g=16*n,m=c.elements;for(l=0;l<16;l++)i[g+l]=m[l];var S=s.color.r,y=s.color.g,v=s.color.b;return r[g=3*n]=S,r[g+1]=y,r[g+2]=v,a.applyMatrix4(d),o.expandByPoint(a.min),o.expandByPoint(a.max),!0},l.prototype.getReferenceFromOccurrence=function(e){var t,n,i,r,o=0;for(t=0;t<this.references.length;t++)if((i=this.references[t]).isAlive())for(r=i.getOccurrences(),n=0;null!==r&&n<r.length;n++){if(this.occurrences[o]===e)return i.referenceId;o++}},l.prototype.setUpMeshInstancingParameters=function(e,t,n,i){var r={data:n,type:"m4",attribName:"instanceMatrix",isFlattened:!0},o={data:i,type:"v3",attribName:"instanceColor",isFlattened:!0};e.setInstancingParameters(t,[r,o])},g.prototype.selectCluster=function(e){var t,n,i=1/0,r=-1;for(t=0;t<e.length;t++)(n=e[t].center.distanceTo(this.center))<i&&(r=t,i=n);return r},window.myRnd=[];var S=void 0,y=0;function v(){var e;return void 0===S&&(S=window.WUXLDH_RndTable?window.WUXLDH_RndTable:null),S?(e=S[y],y=(y+1)%S.length,e):(e=Math.random(),window.myRnd.push(e),e)}return m.prototype.randomize=function(e){this.center.set(e.min.x+v()*(e.max.x-e.min.x),e.min.y+v()*(e.max.y-e.min.y),e.min.z+v()*(e.max.z-e.min.z))},m.prototype.resetNodes=function(){this.nodes=[]},m.prototype.updateCenter=function(){var e,t=this.nodes,n=this.center;if(t.length>0){for(n.set(0,0,0),e=0;e<t.length;e++)n.addVectors(n,t[e].center);n.multiplyScalar(1/t.length)}},m.prototype.buildBoundingBox=function(){var t,n,i=new e.Box3;for(t=0;t<this.nodes.length;t++)n=this.nodes[t],i.union(n.bbox);return i},l.prototype.createClusterData=function(e,t,n){var i=e.getBoundingBox(),r=t.matrix,o=new g(i.clone(),r);return o&&!o.bbox.containsPoint(n)?o:null},l.prototype.fillInstancingData_cluster=function(e,t,n,i,r,o,s,a){c.identity();var d=e.buildBoundingBox();if(d.containsPoint(a))return 0;s.union(d),d.size(t),c.scale(t),c.setPosition(d.min);var l,h=16*n,u=c.elements;for(l=0;l<16;l++)i[h+l]=u[l];var p=o.color.r,f=o.color.g,g=o.color.b;return r[h=3*n]=p,r[h+1]=f,r[h+2]=g,1},l.prototype.createInstancingData_cluster=function(t,n){var i,r,o=this.createClusters(t,n),s=new e.Box3,a=o.length,d=0,l=new Float32Array(16*a),h=new Float32Array(3*a),c=new e.Vector3(s.max.x-s.min.x,s.max.y-s.min.y,s.max.z-s.min.z);for(c.multiplyScalar(.02),c.set(100,100,100),i=0;i<o.length;i++)r=o[i],d+=this.fillInstancingData_cluster(r,c,d,l,h,t,s,n);return{boundingBox:s,nbInstances:a=d,matrices:l,colors:h}},l.prototype.createClusters=function(t,n){var i,r,o,s,a=[];for(i=0;i<this.references.length;i++)if((o=this.references[i]).isAlive())for(s=o.isSlave()?o.node._occurrences:o._occurrences,r=0;r<s.length;r++)(c=this.createClusterData(o,s[r],n))&&a.push(c);var d=new e.Box3;for(i=0;i<a.length;i++)d.expandByPoint(a[i].center);var l,h,c,u=t.clusters,p=this.lastClusters;if(!p||0===p.length&&a.length>0)for(p=[],i=0;i<u;i++)(l=new m).randomize(d),p.push(l);else for(i=0;i<p.length;i++)(l=p[i]).resetNodes();for(i=0;i<a.length;i++)p[h=(c=a[i]).selectCluster(p)].nodes.push(c),c.clusterIndex=h;for(var f=!!this.lastClusters;!f;){for(f=!0,i=0;i<p.length;i++)(l=p[i]).updateCenter(),l.nodes.length=0;for(i=0;i<a.length;i++)p[h=(c=a[i]).selectCluster(p)].nodes.push(c),c.clusterIndex!==h&&(f=!1,c.clusterIndex=h)}var g=[];for(i=0;i<p.length;i++)p[i].nodes.length>0&&g.push(p[i]);return this.lastClusters=g,g},l.prototype.clearClusters=function(){this.lastClusters=null},l}),define("DS/3DXMTiles/DSTilesQueueSet",["DS/3DXMTiles/DSTilesQueue"],function(e){"use strict";var t=function(e){this.tilesManager=e,this.queues=[]};return t.prototype.getQueueFromTileSet=function(t){var n,i,r=t.getSortingMetric();for(n=0;n<this.queues.length;n++)if((i=this.queues[n]).sortingMetric===r)return i;return i=new e(this,r),this.queues.push(i),i},t.prototype.updateNodes=function(e,t){var n;for(n=0;n<this.queues.length;n++)this.queues[n].updateNodes(e,t)},t.prototype.loadNodes=function(e,t){var n;for(n=0;n<this.queues.length;n++)this.queues[n].loadNodes(e,t)},t.prototype.isLoading=function(){var e,t;for(t=0;t<this.queues.length;t++)if((e=this.queues[t]).nbLoading>0||e.nbExpanding>0||e.contentsToUpdateSet.size>0)return!0;return!1},t.prototype.cleanLists=function(){for(i=0;i<this.queues.length;i++)this.queues[i].cleanLists()},t}),define("DS/3DXMTiles/LDHBatchModel3DHandlerVISCANoStream",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHStats","DS/3DXMTiles/LDHReferenceRep","DS/3DXMTiles/ModelBank"],function(e,t,n,i,r,o,s,a){"use strict";var d=0;function l(e,t){this.index=d++,this.context=e,this.references=[],this.size=t}var h=function(t,n,o){e.call(this,e.Model3DHandler),this.loadModelOptions=null,this.debug=!!t.debug,this.debugSingleMode=!!t.debugSingleMode,this.manager=null,this.tenant=null,this.loadingInProgress=!1,this.saveToBank=t.saveToBank,this.nbTickets=n,this.batchSize=this.debugSingleMode?1:o,this.modelLoader=new i,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.referenceToBatch=new Map,this.urlServices=new r,this.ODT=!1,this.maxTicketSize=t.maxTicketSize||0,this.getSecurityParamsCB=t.getSecurityParamsCB||null,this.batchAV1=void 0===t.batchAV1||t.batchAV1,this.datas=[]};(h.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},h.prototype.setRestricted=function(){},h.prototype.isReady=function(){return this.nbTickets>0},h.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},h.prototype.setRedirectUrlCB=function(){},h.prototype.setAutoRedirect=function(){};var c=document.createElement("a");h.prototype.getParams=function(e){var t={};c.href=e;for(var n,i=c.search.substring(1).split("&"),r=0;r<i.length;r++){var o=i[r].split("=");t[o[0]]=(n=o[1],decodeURIComponent((n+"").replace(/\+/g,"%20")))}return t};var u={url:"/i3dx/services/xmql",verb:"POST"};function p(e,t,n){var i,r;for(i=t;i<e.length;i++){if(13===(r=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===r)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}h.prototype.getMQLUrl=function(){return this.getMCSUrl()+u.url},h.prototype.getMCSUrl=function(){return this.getSecurityParamsCB().service3DSpaceUrl},h.prototype.buildMQLRequest=function(e,t){var n,i,r,o,s="[";for(n=0;n<e.length;n++)r=e[n].getActiveRepresentation(),n>0&&(s+=","),s+='{"correlationId":"'+(o=n+1)+'","filename":"'+((i=this.getParams(r.url)).filename||i.f)+'","format":"'+(i.format||i.fmt)+'","path":"'+o+'","physicalid":"'+(i.boid||i.id)+'"}';return s+="]",['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>get_checkout_ticket</function>","    <version>2.1.0</version>","    <params>",'      <param name="label">ticket</param>','      <param name="mcsurl">'+this.getMCSUrl()+"</param>",'      <param name="bops">[{"bops":'+s+',"store":"'+t+'"}]</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")},h.prototype.buildMQLSizeRequest=function(e,t){var n,i,r,o='"';for(n=0;n<e.length;n++){r=e[n].getActiveRepresentation(),n>0&&(o+=","),n+1;let s=(i=this.getParams(r.url)).boid||i.id;if(!s)return null;o+=""+s,t.push(i.filename||i.f)}o+='" ","';this.getMCSUrl();return['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>query_bus</function>","    <version>2.2.0</version>","    <params>",'      <param name="label">fetch</param>','      <param name="type">*</param>','      <param name="name">*</param>','      <param name="revision">*</param>','      <param name="vault">*</param>','      <param name="select">["physicalid","format.file.name","format.file.size","format.file.location"]</param>','      <param name="where">physicalid matchlist '+o+"</param>",'      <param name="dump">|</param>','      <param name="format">tcl</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")},h.prototype.doDebugSingleLoad=function(e,t){var i=this,r={type:"arraybuffer",onComplete:function(n,r){i.parseMultiPartData(n,r,e,t,!1)},onFailure:function(){i.errorCallbackTest(e,t),console.log("checkout ERROR")}},o=t[0].getActiveRepresentation();n.authenticatedRequest(o.url,r)},h.prototype.doCheckoutMQL=function(e,t,i,r){var o=/\{\{([^\}]*)\}\{([^\}]*)\}\}/.exec(e);if(o){var s=o[1],a=o[2],d=this,l={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:s},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:function(e,n){d.parseMultiPartData(e,n,t,i,!1,r)},onFailure:function(){d.errorCallbackTest(t,i),console.log("checkout ERROR")}};n.authenticatedRequest(a,l)}else this.errorCallbackTest(t,i)},h.prototype.loadPart=function(e,n,i,r){if(n){var o=n.getActiveRepresentation(),s=n.getPrimaryRepresentation(),a=o.node;if(a){var d=e.byteLength;this.modelLoader.setOnLoadedProductStructureCallback(function(e){i(n,e,d)}),this.modelLoader.setOnErrorCallback(function(){r(n)});var l={};t.setupModelLoaderOptions(this.modelLoader,l,n,o,s,this.manager,e),this.modelLoader.loadModelFromBuffer(e,a,l)}else r(n)}},h.prototype.parsePart=function(e,t,n,i,r,o,s){var a,d,l,h=new TextDecoder,c=t,u=-1;do{c=(a=p(e,c,h)).index,(l=a.str).startsWith("Content-length:")&&(d=l.split(" "),u=parseInt(d[1])),s&&l.startsWith("X-CorelationID:")&&(d=l.split("reference_"),o=parseInt(d[1]))}while(u<0&&c<e.length);var f=n[o];if(c=(a=p(e,c,h)).index,u>0){var g=e.buffer.slice(c,c+u);if(this.saveToBank){var m=e.buffer.slice(c,c+u);this.datas.push({data:m,referenceIndex:o})}this.loadPart(g,f,i,r)}return c+u};var f=localStorage.getItem("OOCBoxDebug");return h.prototype.parseMultiPartData=function(e,t,n,i,r,s,d){var l,h=0,c=t.__file_count__;if(d)h=1;else if(c)h=parseInt(c);else for(l=0;l<i.length;l++)i[l]&&h++;var u=this;function p(e,t,n){f&&(e.byteSize=n),o.onLoadedModel(n),u.onModelLoaded(e,t,s)}function g(e){u.onModelError(e)}if(h>1){var m=0,S=0;for(this.datas=[],l=0;l<h;l++){for(;!i[S]&&S<i.length-1;)S++;m=this.parsePart(new Int8Array(e),m,i,p,g,S,r),S++}var y,v=[],M=[],L=[],T=[];for(l=0;l<this.datas.length;l++)(C=i[this.datas[l].referenceIndex])&&(y=C.getActiveRepresentation(),v.push(C.referenceId),M.push(y.type),L.push(y.wms),T.push(this.datas[l].data));u.saveToBank&&!s&&a.storeModelData(v,M,this.tenant,T,L),u.datas=[]}else{S=-1;if(d){var D=d.split("reference_");S=parseInt(D[1])}for(l=0;l<i.length;l++){var C,R;(C=i[l])&&(S<0||l===S)&&(this.saveToBank&&!s&&(R=C.getActiveRepresentation(),a.storeModelData([C.referenceId],[R.type],this.tenant,[e],[R.wms])),this.loadPart(e,C,p,g))}}},h.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},h.prototype.updateTenant=function(){this.tenant=this.getSecurityParamsCB?this.getSecurityParamsCB().tenant:"#NONE#"},h.prototype.handleReferences=function(e,t){this.tenant||this.updateTenant(),this.manager=t.manager._ldhNodeManager;var n,i,r,s=this.manager;for(i=0;i<e.length;i++)r=(n=e[i]).getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0);s.tryBuildSceneGraphHierarchy();var a=[],d=[],h=[],c=new l(t,e.length);for(i=0;i<e.length;i++)(r=(n=e[i]).getActiveRepresentation()).url?(r!==n.getPrimaryRepresentation()&&r.buildNode(),r.node,this.isViscaUrl(r.url)&&!this.debugSingleMode?/*!this.activateVISCAElement || */this.urlServices.IsURLFetchCompatible(r.url)?d.push(n):h.push(n):a.push(n),c.references.push(n),this.referenceToBatch.set(n,c)):setTimeout(function(e){t.doneCB([],[e])}.bind(this,n),0);(a.length>0||d.length>0||h.length>0)&&(this.nbTickets--,o.onStartBatch(c.references.length),a.length>0&&(this.debugSingleMode?this.doDebugSingleLoad(c,a):this.downloadReferencesMQL(a,c,!1)),d.length>0&&this.requestVISCACheckoutTicket(d,c),h.length>0&&this.handleVISCAElementReferences(h,c,!1))},h.prototype.downloadReferencesMQL=function(e,t,n){this.maxTicketSize>0?this.requestMQLCheckoutTicket_size(e,t,n,this.maxTicketSize):this.requestMQLCheckoutTicket(e,t,n)},h.xmqlFetchToArray=function(e){var t,n,i,r,o=[],s=o,a=[o],d=null;if(e&&e.startsWith("fetch: ")){for(t=e.substring("fetch: ".length),n=0;n<t.length;n++)switch(i=t[n]){case"\n":case"\t":case"\r":break;case"{":d=null,r=[],s.push(r),a.push(r),s=r;break;case"}":null!==d&&(0===s.length&&s.push(d),d=null),a.pop(),s=a[a.length-1]||null;break;default:null===d?d=i:d+=i}if(1!==a.length)return null}return o},h.prototype.requestMQLCheckoutTicket_size=function(e,t,i,r){var o=this,s=this.getMQLUrl(),a=[],d=this.getSecurityParamsCB(),l=d.securityCtx?d.securityCtx:"preferred",c=d.userLogin||"",u=this.buildMQLSizeRequest(e,a,t);u?n.authenticatedRequest(s,{data:u,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain",SecurityToken:c+"|"+l},proxy:"passport",onComplete:function(n){var s,d,l,c,u=h.xmqlFetchToArray(n),p=new Map,f=new Map,g=[];for(l=0;l<u.length;l++)for(d=u[l],c=0;c<d[4].length;c++){p.set(d[4][c][0],parseInt(d[5][c][0]));let e=d[6][c][0];f.set(d[4][c][0],d[6][c][0]),g.indexOf(e)<0&&g.push(e)}var m,S,y=0,v=[];for(S=0;S<g.length;S++){for(l=0;l<e.length;l++){s=e[l],f.get(a[l])===g[S]&&(y+(m=p.get(a[l])||0)<r||0===y?(v.push(s),y+=m):(o.requestMQLCheckoutTicket(v,t,i,g[S]),v=[s],y=m))}v.length>0&&(o.requestMQLCheckoutTicket(v,t,i,g[S]),v=[],y=0)}},onFailure:function(n){console.log("mql size error"),o.requestMQLCheckoutTicket(e,t,i,"plmx")}}):setTimeout(()=>{this.errorCallbackTest(t,e)},0)},h.prototype.requestMQLCheckoutTicket=function(e,t,n,i){var r=this,o=this.getSecurityParamsCB(),s=o.securityCtx?o.securityCtx:"preferred",a=o.userLogin||"",d=this.getMQLUrl(),l=this.buildMQLRequest(e,i);this.authenticatedRequest_MQL(d,{data:l,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain",SecurityToken:a+"|"+s},proxy:"passport",onComplete:function(i){r.doCheckoutMQL(i,t,e,n)},onFailure:function(n){r.errorCallbackTest(t,e)}})},h.prototype.authenticatedRequest_MQL=function(e,t){n.authenticatedRequest(e,t)},h.prototype.requestVISCACheckoutTicket=function(e,t){var n,i,r=[],o=[];for(n=0;n<e.length;n++)i=e[n].getActiveRepresentation(),r.push(i.url),o.push("reference_"+n);var s=this.urlServices.CreateFetchURLAndBody(r,o,{allowPartial:!0,splitTargetedSize:this.maxTicketSize>0?this.maxTicketSize:void 0}),a=this.getSecurityParamsCB(),d=a.securityCtx?a.securityCtx:"preferred",l=this,h=s.url.replace("//api","/api");this.authenticatedRequest_VISCA(h,{method:"POST",data:s.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:d},onComplete:function(n){var i=JSON.parse(n);l.doCheckoutVISCA(i,t,e)},onFailure:function(n){l.errorCallbackTest(t,e)}})},h.prototype.authenticatedRequest_VISCA=function(e,t){n.authenticatedRequest(e,t)},h.prototype.authenticatedRequest_VISCA_element=function(e,t){n.authenticatedRequest(e,t)},h.prototype.doCheckoutVISCA=function(e,t,n){var i,r,o,s,a,d,l=e.ticketWrappers,h=e.filesNotFound,c=[],u=[];if(h){for(i=0;i<h.length;i++)if((r=(d=h[i]).correlationID)&&(o=r.split("reference_"),a=n[s=parseInt(o[1])],n[s]=null),a)if(d.emptyReason)"EmptyDerivedObject"===d.emptyReason?this.onModelLoaded(a,null,0,!1):this.onModelError(a);else{let e=a.getActiveRepresentation(),t=e&&e.url;t&&t.toLowerCase().indexOf("&e=")>=0?u.push(a):c.push(a)}c.length&&this.downloadReferencesMQL(c,t,!0),u.length&&this.handleVISCAElementReferences(u,t,!0)}if(l)for(i=0;i<l.length;i++)this.doTicketWrapperCheckout(l[i],t,n)},h.prototype.doTicketWrapperCheckout=function(e,t,n){var i=e.url,r=e.ticket,o=null;e.correlationIDs&&1===e.correlationIDs.length&&(o=e.correlationIDs[0]),this.doCheckoutVISCASingle(i,r,t,n,o)},h.prototype.doCheckoutVISCASingle=function(e,t,i,r,o){var s=this,a={cors:!0,timeout:36e5,method:this.ODT?"GET":"POST",data:{__fcs__jobTicket:t},type:"arraybuffer",async:!0,headers:{Accept:"text/plain"},onComplete:function(e,t){s.parseMultiPartData(e,t,i,r,!0,!1,o)},onFailure:function(){s.errorCallbackTest(i,r),console.log("checkout ERROR")}};n.authenticatedRequest(e,a)},h.prototype.errorCallbackTest=function(e,t){this.doneCB(e,t,!1)},h.prototype.onModelLoaded=function(e,t,n){var i=e.getActiveRepresentation();n&&(i.type=s.RepType.av1);var r=this.referenceToBatch.get(e),o=r.context.manager;this.commitModelLoadedTransaction(e,o,t),this.doneCB(r,[e],!0)},h.prototype.onModelError=function(e){var t=this.referenceToBatch.get(e);this.doneCB(t,[e],!1)},h.prototype.doneCB=function(e,t,n){var i,r,s=e.context,a=s.manager;for(i=0;i<t.length;i++)(r=t[i])&&(r.referenceId,this.referenceToBatch.delete(r),n?s.doneCB([r],[]):s.doneCB([],[r]),e.size--);0===e.size&&(this.nbTickets++,o.onEndBatch(e.references.length),a._ldhNodeManager.requestUpdate(!1,!1))},h.prototype.getBatchSize=function(){return this.batchSize},h.prototype.acceptsRepresentation=function(e,t){return!!this.batchAV1||!(!e||e.isAV1())},h.prototype.handleVISCAElementReferences=function(e,t,n){var i,r=[],o=new RegExp("&type=pr","i");for(i=0;i<e.length;i++){let t=e[i].getActiveRepresentation().url;n&&t&&(t=t.replace(o,"&type=av")),r.push(t)}var s=this.urlServices.CreateBatchURLAndBody(r,{allowPartial:!0,fallback:!0}),a=this.getSecurityParamsCB(),d=a.securityCtx?a.securityCtx:"preferred",l=this,h=s.url.replace("//api","/api");this.authenticatedRequest_VISCA_element(h,{method:"POST",data:s.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:d},onComplete:function(i){var r=JSON.parse(i);l.handleVISCAElementFetchResult(r,t,e,n)},onFailure:function(n){l.errorCallbackTest(t,e)}})},h.prototype.handleVISCAElementFetchResult=function(e,t,n,i){let r,o=this.urlServices.MergeBatchAnswer(e,this.maxTicketSize);for(r=0;r<o.files.length;r++){let e=o.files[r];this.handleVISCAElementFetchSingleResult(e,t,n,i)}},h.prototype.handleVISCAElementFetchSingleResult=function(e,t,i,r){let o,s=[];for(o=0;o<e.indices.length;o++)s.push(i[e.indices[o]]);if(!e.headers)return console.log("elementNotFound in /reps"),void this.errorCallbackTest(t,s);let a={Accept:"text/plain"};for(o=0;o<e.headers.length;o++)a[e.headers[o].name]=e.headers[o].value;n.authenticatedRequest(e.url,{cors:!0,timeout:36e5,method:"GET",type:"arraybuffer",async:!0,headers:a,onComplete:(e,n)=>{this.parseMultiPartData(e,n,t,s,!1,r)},onFailure:()=>{this.errorCallbackTest(t,s),console.log("checkout ERROR")}})},h}),define("DS/3DXMTiles/LDHHandlerMultiple",["DS/3DXMTiles/LDHHandler"],function(e){"use strict";var t=function(e){this.type=0,this.handlers=e.handlers,this.batchSize=e.batchSize||40,this.getSecurityParamsCB=e.getSecurityParamsCB||null};(t.prototype=Object.create(e.prototype)).setLoadModelOptions=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setLoadModelOptions(e)},t.prototype.setFileType=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setFileType(e)},t.prototype.setRedirectUrlCB=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setRedirectUrlCB(e)},t.prototype.setAutoRedirect=function(e){var t;for(t=0;t<this.handlers.length;t++)this.handlers[t].setAutoRedirect(e)},t.prototype.handleBatch=function(e,t){var n,i,r=this.handlers;for(n=0;n<r.length;n++)(i=e.batches[n]).isEmpty()||r[n].handleBatch(i,t)},t.prototype.createBatch=function(){return new n(this,this.batchSize)},t.prototype.isReady=function(){var e,t=this.handlers;for(e=0;e<t.length;e++)if(!t[e].isReady())return!1;return!0};var n=function(e,t){this.maxSize=t,this.handler=e,this.batches=[];var n,i=this.handler.handlers;for(n=0;n<i.length;n++)this.batches.push(i[n].createBatch())};return n.prototype.containsReference=function(e){var t;for(t=0;t<this.batches.length;t++)if(this.batches[t].containsReference(e))return!0;return!1},n.prototype.addReferenceIfPossible=function(e,t){var n,i=this.handler.handlers;for(t=t||e.getActiveRepresentation(),n=0;n<i.length;n++)if(i[n].acceptsRepresentation(t,e))return!!this.batches[n].addReferenceIfPossible(e,t);return!1},n.prototype.isEmpty=function(){var e;for(e=0;e<this.batches.length;e++)if(!this.batches[e].isEmpty())return!1;return!0},n.prototype.getSize=function(){var e,t=0;for(e=0;e<this.batches.length;e++)t+=this.batches[e].getSize();return t},n.prototype.setReferencesLoading=function(e){var t;for(t=0;t<this.batches.length;t++)this.batches[t].setReferencesLoading(e)},t}),define("DS/3DXMTiles/DSTilesStylingFilterOperatorInList",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperator"],function(e,t){"use strict";class n extends t{constructor(){super(),this.values=[],this.attribute=null}setFromJSON(t){let n=[];if(Array.isArray(t.inList)){let e;for(e=0;e<t.inList.length;e++)this.values.push(t.inList[e])}else n.push(e.error("illegal inList property","inList"));let i=t.attribute;return e.isStylingAttributeName(i)?this.attribute=i:n.push(e.error("illegal attribute property","inList")),n.length?e.error("Error parsing inList filter","filter",n):e.ok}addNeededAttributesToSet(e){e.add(this.attribute)}buildShaderCode(e){const t=e.variableHandler,n=e=>t.float(e);let i="";for(let e=0;e<this.values.length;e++){let t=this.values[e];i=0===e?`\n                        ${i}\n                        if(${n()}(${this.attribute})==${n()}(${t})) {\n                            return true;\n                        }\n                    `:`\n                        ${i}\n                        else if(${n()}(${this.attribute})==${n()}(${t})) {\n                            return true;\n                        }\n                    `}return i=`\n                ${i}\n                return false;\n            `}}return n.majorProperty="inList",n}),define("DS/3DXMTiles/LDHLoadingBoxManager",["DS/Visualization/ThreeJS_R57","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/3DXMTiles/PriorityQueue"],function(e,t,n,i){"use strict";var r=function(n,i){this.oocManager=n,this.queue=i,this.lastReferences=[],this.attributes=new o({dimension:2,color:new e.Color("red"),opacity:.1}),this.material=null,this.materialApplication=null,this.pickable=t.PICKABLE,this.maxNbBoxes=r.maxNbBoxes};r.maxNbBoxes=1e3,r.prototype.updateLoadingBoxes=function(){var e,t,n=this.queue.manager.occlusionTestEnabled,i=new Set,r=this.computeReferenceList(n);for(t=0;t<r.length;t++)(e=r[t]).requestBuildSceneGraphHierarchy(!0),e.lockUnload(),i.add(e);var o=this.queue.manager;for(o.tryBuildSceneGraphHierarchy(),t=0;t<r.length;t++)(e=r[t]).displayBox(o);for(t=0;t<this.lastReferences.length;t++)e=this.lastReferences[t],i.has(e)||e.removeBox(o),e.unlockUnload();this.lastReferences=r},r.prototype.removeBoxes=function(){var e,t,n=this.queue.manager;for(e=0;e<this.lastReferences.length;e++)(t=this.lastReferences[e]).removeBox(n),t.unlockUnload();this.lastReferences=[]},r.prototype.getMaterial=function(){var t;return null===this.material&&(t=this.attributes,this.material=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,transparent:t.opacity<1,force:!0})),this.material},r.prototype.getMaterialApplication=function(){return null===this.materialApplication&&(this.materialApplication=new n({faceMaterial:this.getMaterial(),layer:-1/0})),this.materialApplication},r.prototype.computeReferenceList=function(e){var t,n,i=[],r=this.queue,o=0,s=this.oocManager._getActiveRootLDHReferences();for(t=0;t<s.length;t++)0!==(n=s[t]).children.length||n.isLeaf()||i.push(s[t]);for(t=0;t<r.nodes.length;t++)n=r.nodes[t],this.shouldDisplayBox(n,e)&&(o+=n.getNbOccurrences(),i.push(n));return o>this.maxNbBoxes&&(i=this.selectBiggestReferences(i,this.maxNbBoxes)),i},r.prototype.selectBiggestReferences=function(e,t){var n,r=new i(t);for(n=0;n<e.length;n++)r.addNode(e[n]);var o=[],s=0;return r.traverseMaxPlus(function(e,n,i){o.push(e),(s+=e.getNbOccurrences())>t&&n()}),o},r.prototype.shouldDisplayBox=function(e,t){return!(!e.isInToBeLoaded()||t&&!e.isOcclusionVisible())},r.prototype.setParams=function(e){e=e||{},this.material=null,this.materialApplication=null,this.attributes.setParams(e.repRefAttributes)},r.prototype.dispose=function(){this.removeBoxes()},r.prototype.updateBoxes=function(){var e,t,n=this.oocManager._ldhNodeManager;for(e=0;e<this.lastReferences.length;e++)(t=this.lastReferences[e]).removeBox(n),t.displayBox(n)},r.prototype.setPickable=function(e){this.pickable=e,this.updateBoxes()};var o=function(e){this.color=e.color.clone(),this.opacity=e.opacity,this.count=e.count||0};return o.prototype.setParams=function(e){e.color&&(this.color=e.color.clone()),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.count&&(this.count=e.count||0)},r}),define("DS/3DXMTiles/LDHBatchModel3DHandlerBank",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/ModelLoader","DS/3DXMTiles/ModelBank"],function(e,t,n,i,r,o){"use strict";var s=function(e,n){t.call(this,t.Model3DHandler),this.loadModelOptions=null,this.manager=null,this.tenant=null,this.getSecurityParamsCB=e.getSecurityParamsCB||null,this.modelLoader=new r,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.modelLoader.sharedBuffers=!1,this.referenceToContext=new Map,this.toLoadQueue=[],this.maxNbLoading=40,this.nbTickets=120,this.nbLoading=0};(s.prototype=Object.create(t.prototype)).isReady=function(){return 0===this.nbLoading},s.prototype.setFileType=function(e){},s.prototype.setRedirectUrlCB=function(){},s.prototype.setAutoRedirect=function(){},s.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},s.prototype.updateTenant=function(){this.tenant=this.getSecurityParamsCB?this.getSecurityParamsCB().tenant:"#NONE#"},s.prototype.handleReferences=function(e,t){this.tenant||this.updateTenant(),this.manager=t.manager._ldhNodeManager;var n,i,r,s=this.manager,a=[];for(i=0;i<e.length;i++)n=e[i],this.referenceToContext.set(n,t),r=n.getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0),a.push(r.type);s.tryBuildSceneGraphHierarchy();var d=this.onModelLoaded.bind(this),l=this.onModelError.bind(this);for(i=0;i<e.length;i++)(r=(n=e[i]).getActiveRepresentation())!==n.getPrimaryRepresentation()&&r.buildNode(),r.node,this.nbLoading++;o.retrieveModelData(e,a,this.tenant,this,d,l)},s.prototype.onModelBankData=function(e,t,i,r,s){if(r){var a=e.getActiveRepresentation().node;if(!a)return void i(e);this.modelLoader.setOnLoadedProductStructureCallback(function(n){t(e,n)}),this.modelLoader.setOnErrorCallback(function(){o.removeKeys([s]),i(e)});var d=e.getActiveRepresentation(),l=e.getPrimaryRepresentation(),h={};n.setupModelLoaderOptions(this.modelLoader,h,e,d,l,this.manager,r),this.modelLoader.loadModelFromBuffer(r,a,h)}else o.removeKeys([s]),i(e)},s.prototype.onModelLoaded=function(e,t){this.nbLoading--;e.getActiveRepresentation();t&&t.nodes&&this.dbgSetupNodes(t.nodes,"green"),n.statsInit(),n.statsOnLoadedModel();e.referenceId;var i=this.referenceToContext.get(e);this.referenceToContext.delete(e);var r=i.manager;this.commitModelLoadedTransaction(e,r,t),i.doneCB([e],[])},s.prototype.onModelError=function(e){this.nbLoading--;e.referenceId;var t=this.referenceToContext.get(e);this.referenceToContext.delete(e),t.doneCB([],[e])},s.prototype.acceptsRepresentation=function(e,t){return this.tenant||this.updateTenant(),!!o.hasModelData(t.referenceId,e.type,this.tenant,e.wms)};var a=function(e){this.handler=e,this.references=[]};return a.prototype.containsReference=function(e){return this.references.indexOf(e)>=0},a.prototype.addReferenceIfPossible=function(e,t){return t=t||e.getActiveRepresentation(),!!(o.hasModelData(e.referenceId,t.type,this.handler.tenant,t.wms)&&this.references.length<this.handler.nbTickets)&&(this.references.push(e),!0)},a.prototype.isEmpty=function(){return 0===this.references.length},a.prototype.getSize=function(){return this.references.length},a.prototype.setReferencesLoading=function(e){var t,n,i=this.references;for(t=0;t<i.length;t++)(n=i[t]).isLoading()||n.setLoading(e)},s.prototype.handleBatch=function(e,t){this.handleReferences(e.references,t)},s.prototype.createBatch=function(){return new a(this)},s}),define("DS/3DXMTiles/DSTilesStylingFilter",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilterOperatorInList"],function(e,t){"use strict";return class{constructor(){this.rootOperator}setFromJSON(n){let i,r=[t],o=null;for(i=0;i<r.length&&!o;i++){let e=r[i];n.hasOwnProperty(e.majorProperty)&&(o=e)}if(!o)return e.error("Unknown filter","filter");let s=new o,a=s.setFromJSON(n);return a.isOk()&&(this.rootOperator=s),a}addNeededAttributesToSet(e){this.rootOperator&&this.rootOperator.addNeededAttributesToSet(e)}buildShaderCode(e){return this.rootOperator.buildShaderCode(e)}}}),define("DS/3DXMTiles/DSTilesContentSet",["DS/3DXMTiles/DSTilesContent"],function(e){"use strict";class t{constructor(e,t){this.contents=e,this.spec=t}getSize(){return this.contents.length}needsSgNode(){let e;for(e=0;e<this.contents.length;e++)if(this.contents[e].needsSgNode())return!0;return!1}showContent(e){let t;for(t=0;t<this.contents.length;t++)if(!this.contents[t].contentToken)return!1;for(t=0;t<this.contents.length;t++)this.contents[t].showContent(e);return!0}hideContent(e){let t;for(t=0;t<this.contents.length;t++)if(!this.contents[t].contentToken)return!1;for(t=0;t<this.contents.length;t++)this.contents[t].hideContent(e);return!0}deleteContent(e){let t;for(t=0;t<this.contents.length;t++)if(!this.contents[t].contentToken)return!1;for(t=0;t<this.contents.length;t++)this.contents[t].deleteContent(e);return!0}exportContent(e){let t,n=null;for(t=0;t<this.contents.length;t++){let i=this.contents[t].exportContent(e);i&&(n||(n=[]),n=n.concat(i))}return n}getSourcesWithContents(e,t){let i,r=new Map,o=t||this.contents;for(i=0;i<o.length;i++){let t=o[i];if(t){let i=t.getSourceIdWithParamsArray(e);if(i){let e;for(e=0;e<i.length;e++){let o=i[e],s=o.sourceId,a=r.get(s);a||(a=new n(s),r.set(s,a)),a.contents.push(t),a.sourceParams.push(o.params)}}}}let s=[];return r.forEach(e=>{s.push(e)}),s}getSourceWithContents(e,t){let n=this.getSourcesWithContents(t);if(!e)return 1===n.length?n[0]:null;{let t;for(t=0;t<n.length;t++)if(n[t].sourceId===e)return n[t]}return null}getContentLoaders(){let e,t=[];for(e=0;e<this.contents.length;e++){let n=this.contents[e].contentLoader;t.indexOf(n)<0&&t.push(n)}return t}getFileSize(){let e,t=0;for(e=0;e<this.contents.length;e++)t+=this.contents[e].fileSize;return t}hasContentType(e){let t;for(t=0;t<this.contents.length;t++)if(this.contents[t].type.toLowerCase()===e.toLowerCase())return!0;return!1}getUris(){let e,t=[];for(e=0;e<this.contents.length;e++)t.push(this.contents[e].uri);return t}getSpec(){return this.spec}}t.create=function(n,i){let r=null;if(n){let o=[];if(Array.isArray(n)){let t=0;for(t=0;t<n.length;t++)n[t].uri&&o.push(new e(n[t],i))}else n.uri&&o.push(new e(n,i));o.length>0&&(r=new t(o,n))}return r};class n{constructor(e,t){this.sourceId=e,this.contents=[],this.sourceParams=[],this.options=t||null}}return t}),define("DS/3DXMTiles/DSTilesTerrainContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/Visualization/ThreeJS_DS","DS/Visualization/ImageUtils","DS/Visualization/Mesh3D","DS/Mesh/Mesh","DS/3DXMTiles/DSTilesSourceIdWithParams"],function(e,t,n,i,r,o){"use strict";function s(e){const t=e.BYTES_PER_ELEMENT;if(1===t)return e;const n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0;e<n.length;e+=t)for(let i=0;i<t/2;i++){const r=t-1-i,o=n[e+i];n[e+i]=n[e+r],n[e+r]=o}return e}function a(e){this.sourceIds=[];for(let t in e.contentSources)this.sourceIds.push(t)}return class extends e{constructor(e){super(e),this.tileSetDataMap=new WeakMap,this.nbTickets=10}getBudgetParams(){return{name:"terrain",physicalBudget:"gpu"}}getSourceIdWithParamsArray(e,t){let n,i=this.getTileSetData(t.tileSet).sourceIds,r=[];for(n=0;n<i.length;n++)r.push(new o(i[n],{name:i[n]}));return r}isReady(){return this.nbTickets>0}isThereEnoughMemoryToLoad(e,t){return t.isLoadingAllowed()}_fetchElevation(e,t,n){for(let i of n.elevations)if(i.source===t){s(e=new Float32Array(e));const t=e.length-2;return{...i,data:e,num_vertices:t}}return null}_fetchMap(e,i,r){if(!e||0===e.byteLength)return null;for(let o in r.maps){const s=r.maps[o];if(s.source===i){let i=null;if("basis"!==s.type){const t=URL.createObjectURL(new Blob([e],{type:`image/${s.type}`}));i=new Promise((e,i)=>n.Utils.loadTexture(t,null,e,i))}else i=new Promise((n,i)=>t.ImageUtils.loadBasisTexture(new Uint8Array(e),null,n,i,!0,t.BasisUsage.RGB,!1,void 0));return{padding:0,...s,name:o,data:e,texture:i}}}return null}_computeBBox(e,n){let i=new t.Box3,r=n.boundaries&&n.boundaries.box;i.setFromJSON(r);let o=e.metaData&&e.metaData.terrain,s=Math.pow(2,o.level),a=(i.max.x-i.min.x)/s,d=(i.max.y-i.min.y)/s,l=o.coords[0],h=o.coords[1];return new t.Box3(new t.Vector3(i.min.x+l*a,i.min.y+h*d,i.min.z),new t.Vector3(i.min.x+(l+1)*a,i.min.y+(h+1)*d,i.max.z))}_initializeNode(e,n){const o=this._createMaterial(n),s=new t.BufferGeometryDS,a=new r.DrawingGroup(null,o,5,0,0);a.geometry=s,s.drawingGroups=[a];const d=new t.Mesh(s,o),l=new i(d,`Terrain/${e.uri}`);l.setUserData({dsTilesNode:e});const h=this._computeBBox(e,n);let c=new t.Vector3(h.min.x,h.min.y,0);return l.setMatrix((new t.Matrix4).setPosition(c)),c=c.negate(),this._updateMaterial(o,{bbox:h}),s.boundingBox=h.clone().translate(c),s.boundingSphere=e.getBoundingSphere().clone().translate(c),l.explicitBSphere.copy(s.boundingSphere),l.explicitBBox.copy(s.boundingBox),{mesh3D:l,bgds:s,material:o}}_updateElevation(e,t,n){const i=e.getBuffersMemorySize();e.clear();const r=n.size=Math.floor(Math.sqrt(n.num_vertices));e.layout.set({elevation:{bufferId:0,offset:0,stride:4,type:"float32"},index:{bufferId:1,offset:0,stride:4,type:"float32"}}),e.buffers[0]=n.data.subarray(0,n.num_vertices),e.buffers[1]=Float32Array.from({length:n.num_vertices},(e,t)=>t),e.vertexIndexArray=function({start_x:e,start_y:t,height:n,width:i,use32bitIndices:r,index_of:o}){const s=2*(n-1)*i,a=r?new Uint32Array(s):new Uint16Array(s);let d=0;for(let r=0;r+1<n;r++){const n=r%2==0?(n,i)=>a[d++]=o(e+n,t+r+i):(n,s)=>a[d++]=o(e+i-1-n,t+r+s);for(let e=0;e<i;e++)n(e,0),n(e,1)}return a}({start_x:n.padding,start_y:n.padding,width:r-2*n.padding,height:r-2*n.padding,use32bitIndices:n.num_vertices>65535,index_of:(e,t)=>e+t*r}),e.drawingGroups[0].count=e.vertexIndexArray.length,this._updateMaterial(t,{elevation:n});const o=e.getBuffersMemorySize();this.budget.updateUsageDelta(o-i)}_updateMap(e,t,n){t.texture=n,this._updateMaterial(e,{map:t})}loadContentFromBuffer({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,sourceId:o,params:s}){const a=t.tileSet.contentMetaData.terrain;n.contentToken||n.setContentToken(Object.assign({node:t},this._initializeNode(t,a)));const{bgds:d,material:l}=n.contentToken,h=this._fetchElevation(e,o,a);h&&this._updateElevation(d,l,h);const c=this._fetchMap(e,o,a);c?c.texture.then(e=>{this._updateMap(l,c,e),i()}).catch(r):i()}showContent(e,t){let n=t.contentToken;n.node.getSgNode().addChild(n.mesh3D)}hideContent(e,t){let n=t.contentToken;n.node.getSgNode().removeChild(n.mesh3D)}deleteContent(e,t){let n=t.contentToken;this.hideContent(e,t),n.mesh3D=null,n.bgds=null,n.material=null}exportContent(e,t){}getTileSetData(e){let t=this.tileSetDataMap.get(e);return t||(t=new a(e),this.tileSetDataMap.set(e,t)),t}_make_rect(e,n,i,r){return new t.Vector4(e,n,i-e,r-n)}_getMapWeight(e,t){return e.renderInfo.mapWeights[t]}_updateMaterial(e,{bbox:n,elevation:i,map:r}){if(n&&e.updatePDSFXUniform("rect_world",this._make_rect(n.min.x,n.min.y,n.max.x,n.max.y)),i&&e.updatePDSFXUniform("heightmap_shape",new t.Vector2(i.size,i.padding)),r){const{width:t,height:n}=r.texture.image,i=this._make_rect(r.padding/t,r.padding/n,(t-r.padding-1)/t,(n-r.padding-1)/n);e.updatePDSFXUniform(`terrain_${r.name}`,r.texture),e.updatePDSFXUniform(`terrain_${r.name}_rect`,i)}}_createMaterial(e){const n=new t.MeshBasicMaterial({opacity:e.renderInfo.opacity,side:t.DoubleSide,force:!0});n._activatePDSFXMigrated(),n.setPDSFXAttributes({elevation:{type:"f"},index:{type:"f"}});const i=this;n.setPDSFXGlobalShaderCode(function(e){const t=e.variableHandler,n=e.functionHandler,i=t=>e.getUniform(t),r=e=>t.int(e),o=e=>t.float(e),s=e=>t.vec2(e),a=e=>t.ivec2(e);return`\n                    ${n.dF("get_heightmap_coords","i2",[])} {\n                        ${r("iHShape")} = ${i("heightmap_shape")}.x;\n                        ${o("hShape")} = ${o()}(iHShape);\n                        return ${a()}(\n                            ${r()}(mod(index, hShape)),\n                            ${r()}(index) / iHShape\n                        );\n                    }\n                    ${n.dF("get_heightmap_uv","v2",[])} {\n                        ${a("iHShape")} = ${i("heightmap_shape")};\n                        ${a("heightCoords")} = ${n.cF("get_heightmap_coords","i2",[])};\n                        ${s("uv_")} = ${s()}(heightCoords - ${a()}(iHShape.y)) / ${s()}(iHShape.x - 2 * iHShape.y - 1);\n                        uv_.y = 1.0 - uv_.y;\n                        return uv_;\n                    }\n                    ${n.dF("get_heightmap_pos","v3",[])} {                 \n                        ${s("U")} = ${n.cF("get_heightmap_uv","v2",[])};\n                        return ${(e=>t.vec3(e))()}(U * ${i("rect_world")}.zw, elevation);\n                    }\n                `},function(t){const n=t.variableHandler,r=t.functionHandler,o=e=>t.getTextureUniform(e),s=e=>t.getUniform(e),a=e=>n.float(e),d=e=>n.vec3(e);let l=`\n                    ${r.dF("compute_normal","v3",[])} {   \n                        ${d("p")} = ${t.vGetViewPosition()}.xyz;\n                        ${d("x")}  = dFdx(p);\n                        ${d("y")}  = dFdy(p);\n                        ${d("normal")}  = normalize(cross(x, y));\n\n                        // counter the flipping that occur later in the code\n                        ${a("front_facing")} = 2.0 * ${a()}(${t.vIsFrontFacing()}) - 1.0;\n                        return normal * front_facing;\n                    }\n                    ${r.dF("sample_terrain_maps","v3",[r.prmV2("uv_")])} {   \n                        ${d("color")}  = ${d()}(0.0);\n                        ${a("weight")}  = 0.0;\n                `;for(let t in e.maps)l=`\n                        ${l}\n                        ${a(`w_${t}`)}  = ${a()}(${i._getMapWeight(e,t)});\n                        color += w_${t} * ${r.sample2DTexture(o(`terrain_${t}`),`${s(`terrain_${t}_rect`)}.xy + uv_ * ${s(`terrain_${t}_rect`)}.zw`)}.xyz;\n                        weight += w_${t};\n                    `;return l=`\n                    ${l}\n\t\t\t\t\treturn color / weight;\n                }\n                `});const r={rect_world:{type:"v4"},heightmap_shape:{type:"i2",stage:t.VertexStage,value:new t.Vector2(0,0)}};for(let n in e.maps)r[`terrain_${n}`]={type:"t2"},r[`terrain_${n}_rect`]={type:"v4",value:new t.Vector4};return n.setPDSFXUniforms(r),n.setPDSFXVaryings({heightmap_uv:{type:"v2"}}),n.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){const n=e.functionHandler;return`\n                        ${(t=>e.getVarying(t))("heightmap_uv")} = ${n.cF("get_heightmap_uv","v2",[])};\n                    `},ComputeObjectPosition:function(e,t){return`\n                        return ${e.functionHandler.cF("get_heightmap_pos","v3",[])};\n                    `}},{ComputeViewNormal:function(e,t){return`\n                        return ${e.functionHandler.cF("compute_normal","v3",[])};\n                    `},ComputeAlbedo:function(e,t){const n=e.variableHandler,i=e.functionHandler;return`       \n\t\t\t\t\t\t${(e=>n.vec2(e))("uv")}  = ${(t=>e.getVarying(t))("heightmap_uv")}.xy;\n\t\t\t\t\t\treturn ${i.cF("sample_terrain_maps","v3",[i.prmV2("uv")])} * abs(${i.cF("compute_normal","v3",[])}.z);\n                    `}}),n}}}),define("DS/3DXMTiles/DSTilesCustomContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/3DXMTiles/3DXMTilesUtils"],function(e,t,n,i,r,o){"use strict";var s=function(t){t=t||{},e.call(this,t),this.customContentManager=t.customContentManager};function a(){}return(s.prototype=Object.create(e.prototype)).getBudgetParams=function(){return this.customContentManager._getBudgetParams()},s.prototype.loadContentFromBuffer=function({data:e,node:t,content:n,onLoadedCB:i,onErrorCB:r,params:o}){n.setContentToken(new a),i()},s.prototype.showContent=function(e,t){this.customContentManager.createNodeCB({uri:e.uri,tileSet:e.tileSet.oocTileSet,parentNode:this.needsSgNodePerContent()?e.getSgNode():null})},s.prototype.hideContent=function(e,t){this.customContentManager.removeNodeCB({uri:e.uri,tileSet:e.tileSet.oocTileSet,parentNode:this.needsSgNodePerContent()?e.getSgNode():null})},s.prototype.deleteContent=function(e,t,n){},s.prototype.needsSgNodePerContent=function(){return!this.customContentManager.needsSgNodePerContentCB||this.customContentManager.needsSgNodePerContentCB()},s.prototype.needsDownload=function(){return!1},s}),define("DS/3DXMTiles/LDHBatchModel3DHandlerDOS",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/WAFData/WAFData","DS/3DXMTiles/MultiPartLoader"],function(e,t,n,i,r){"use strict";return class extends t{constructor(e){super(t.Model3DHandler),this.loadModelOptions=null,this.manager=null,this.tenant=null,this.getSecurityParamsCB=e.getSecurityParamsCB||null,this.referenceToContext=new Map,this.toLoadQueue=[],this.nbTickets=40,this.maxTicketSize=20971520,this.useBatch=e.useBatch,this.multiPartLoader=null}isReady(){return this.nbTickets>0}setFileType(e){}setLoadModelOptions(e){this.loadModelOptions=e}getBatchSize(){return 40}handleReferences(e,t){var n=this.getSecurityParamsCB();n.securityCtx&&n.securityCtx,n.userLogin,this.manager=t.manager._ldhNodeManager,this.multiPartLoader||(this.multiPartLoader=new r({onModelLoaded:this.onModelLoaded.bind(this),onModelError:this.onModelError.bind(this),manager:this.manager,saveToBank:!1}));var i,o,s,a=this.manager,d=[];for(o=0;o<e.length;o++)i=e[o],this.referenceToContext.set(i,t),s=i.getActiveRepresentation(),d.push(s.url),this.nbTickets--,i.requestBuildSceneGraphHierarchy(!0);a.tryBuildSceneGraphHierarchy();let l=d[0].indexOf("/file/"),h=d[0].substring(0,l);this.useBatch?this.downloadPerBatch(e,h,d,!0):this.downloadOneByOne(e,h,d)}downloadPerBatch(e,t,n,r){let o=t+"/batch/downloadticket";i.authenticatedRequest(o,{data:JSON.stringify(n),authentication:"passport",cors:!0,method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},proxy:"passport",onComplete:i=>{let o=JSON.parse(i),s=!1;if(r){let i,r=0,a=0;for(i=0;i<o.results.length;i++)if((r+=parseInt(o.results[i].filesize))>this.maxTicketSize||s&&i===o.results.length-1){s=!0;let o=e.slice(a,i+1),d=n.slice(a,i+1);this.downloadPerBatch(o,t,d,!1),a=i+1,r=0}}s||this.multiPartLoader.loadFromFCSTicket(o.url,o.ticket,e,!1)},onFailure:t=>{let n;for(n=0;n<e.length;n++)this.onModelError(e[n])}})}downloadOneByOne(e,t,r){let o=t+"/batch/fileurls";i.authenticatedRequest(o,{data:JSON.stringify(r),authentication:"passport",cors:!0,method:"POST",headers:{"Content-type":"application/json",Accept:"application/json"},proxy:"passport",onComplete:t=>{let i,r=JSON.parse(t);for(i=0;i<r.length;i++){let t=r[i].url,o=e[i];n._loadModel(t,o,this.onModelLoaded.bind(this,o),this.onModelError.bind(this,o),null,"cgr",this.loadModelOptions,this.manager)}},onFailure:t=>{let n;for(n=0;n<e.length;n++)this.onModelError(e[n])}})}onModelLoaded(e,t){this.nbTickets++,e.getActiveRepresentation(),t&&t.nodes&&this.dbgSetupNodes(t.nodes,"green"),n.statsInit(),n.statsOnLoadedModel(),e.referenceId;var i=this.referenceToContext.get(e);this.referenceToContext.delete(e);var r=i.manager;this.commitModelLoadedTransaction(e,r,t),i.doneCB([e],[])}onModelError(e){this.nbTickets++,e.referenceId;var t=this.referenceToContext.get(e);this.referenceToContext.delete(e),t.doneCB([],[e])}isDOSUrl(e){return e&&e.indexOf("-dos.")>=0&&e.indexOf("/file/")>=0}acceptsRepresentation(e,t){return this.isDOSUrl(e.url)}handleBatch(e,t){this.handleReferences(e.references,t)}}}),define("DS/3DXMTiles/OOCTilesCustomContentManager",["DS/3DXMTiles/DSTilesCustomContentLoader"],function(e){"use strict";var t=function({type:e,createNodeCB:t,removeNodeCB:n,needsSgNodePerContentCB:i}){this.type=e,this.createNodeCB=t,this.removeNodeCB=n,this.needsSgNodePerContentCB=i,this.budgetName="mesh",this.physicalBudget="gpu",this.contentLoader=null};return t.prototype._getBudgetParams=function(){return{name:this.budgetName,physicalBudget:this.physicalBudget,params:{}}},t.prototype._getContentLoader=function(t){return this.contentLoader||(this.contentLoader=new e({tilesManager:t,customContentManager:this}),this.contentLoader.init(t)),this.contentLoader},t}),define("DS/3DXMTiles/OOCReferenceIterator",["DS/3DXMTiles/OOCInstanceIterator"],function(e){"use strict";var t=function(e){this._reference=e};return t.prototype.getReferenceId=function(){return this._reference.referenceId},t.prototype.getParents=function(){var e,n=[];for(e=0;e<this._reference.parents.length;e++)n.push(new t(this._reference.parents[e]));return n},t.prototype.getChildren=function(){var n,i,r=[];for(i=0;i<this._reference.children.length;i++)n=this._reference.children[i],r.push(new e(new t(n.reference),n));return r},t.prototype.getNode=function(){return this._reference.getNode()},t.prototype.equals=function(e){return!!e&&this._reference===e._reference},t.prototype.isRepRef=function(){return this._reference.isLeaf()},t.prototype.getParentInstanceIterators=function(){var n,i=[],r=this._reference.parents;for(n=0;n<r.length;n++){var o,s=r[n],a=null;for(o=0;s.children[o];o++){var d=s.children[o];d.reference===this._reference&&(null===a&&(a={referenceIterator:new t(s),instanceIterators:[]}),a.instanceIterators.push(new e(a.referenceIterator,d)))}null!==a&&i.push(a)}return i},t}),define("DS/3DXMTiles/DSTilesContentSource",["DS/WAFData/WAFData","DS/Usage/TrackerAPI","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/ModelBank"],function(e,t,n,r){"use strict";var o=null,s=function(e,t,n,i){this.sourceId=e,this.tileSet=n,this.baseContentURL=t.baseContentURL||null,this.urlPostfix=t.urlPostFix||t.urlPostfix||null,this.contentURLPostfix=t.contentURLPostfix||null,this.contentBatchingURL=t.contentBatchingURL||null,this.currentContentBatch=null,this.currentBankBatch=null,this.maxBankBatchSize=20,this.loadedFromNetwork=0,this.loadedFromBank=0,o=i};s.prototype.buildContentURL=function(e){var t=e;return this.baseContentURL&&(t=this.baseContentURL+t),this.contentURLPostfix&&(t+=this.contentURLPostfix),this.urlPostfix&&(t+=this.urlPostfix),t},s.prototype.loadTileContent=function(e,t,i,o,s,a){if(e.setContentStatus(n.loading,e.queue),t.contentLoader.needsDownload())if(t.contentLoader.hasExistingData(e,t,this.sourceId))t.contentLoader.loadContentFromExistingData(e,t,this.sourceId,o.bind(null,e),s.bind(null,e));else{t.contentLoader.onStartLoading(e,t,this.sourceId);var d=t.getUri(this.sourceId,i),l=this.buildContentURL(d);this.tileSet.useBank&&t.etag&&r.hasTileData(l,t.etag)?this.addToBankBatch(e,t,i,o,s,a):this.contentBatchingURL&&this.tileSet.info.maxContentBatchSize>1?this.loadTileContent_multi(e,t,i,o,s,a):this.loadTileContent_single(e,t,l,i,o,s,a)}else setTimeout(()=>{t.contentLoader.loadContentFromBuffer({data:null,node:e,content:t,onLoadedCB:o.bind(null,e),onErrorCB:s.bind(null,e),sourceId:this.sourceId,params:i,updateContent:!!a})},0)},s.prototype.loadTileContent_single=function(t,n,i,r,o,s,a){this.tileSet.contentTickets--;var d=this;let l=new h(1,1/0);l.addContent(t,n,r,a,o,s),function n(){e.authenticatedRequest(i,{method:"GET",timeout:36e5,type:"arraybuffer",onComplete:(e,t,i)=>{var r=i?i.status:200;i&&202===i.status?setTimeout(n,3e4):204===r?d.loadContentFromBuffer({data:null,batch:l,index:0,fromBank:!1}):d.loadContentFromBuffer({data:e,batch:l,index:0,fromBank:!1})},onFailure:e=>{d.tileSet.contentTickets++,s(t)}})}()},s.prototype.loadContentFromBuffer=function({data:e,batch:t,index:n,fromBank:i}){let o=t.getContent(n),s=t.getNode(n),a=t.getOnLoadedCB(n),d=t.getOnErrorCB(n),l=t.getParams(n),h=t.getUpdateContentData(n);if(!h||h.isStillValid()){if(i?this.loadedFromBank++:this.loadedFromNetwork++,this.tileSet.useBank&&o.etag&&!i){let t=o.getUri(this.sourceId,l),n=this.buildContentURL(t);r.storeTileData([n],[e],[o.etag])}t.onContentLoaded(),t.isFullyLoaded()&&this.tileSet.contentTickets++,o.contentLoader.loadContentFromBuffer({data:e,node:s,content:o,onLoadedCB:()=>{a(s)},onErrorCB:()=>{d(s)},sourceId:this.sourceId,params:l,updateContent:!!h})}else a(s)},s.prototype.addToBankBatch=function(e,t,n,i,r,o){this.currentBankBatch||(this.currentBankBatch=this.createBankBatch()),this.currentBankBatch.addContent(e,t,n,o,i,r)&&(this.loadBankBatch(this.currentBankBatch),this.currentBankBatch=null)},s.prototype.loadBankBatch=function(e){let t=[];var n,i=e.getContentUris(this.sourceId);for(n=0;n<i.length;n++)t.push(this.buildContentURL(i[n]));this.tileSet.contentTickets--,r.retrieveTileData(t,(t,n)=>{this.loadContentFromBuffer({data:n,batch:e,index:t,fromBank:!0})},()=>{e.onFullError()})},s.prototype.createBankBatch=function(){return new h(this.maxBankBatchSize,1/0)};var a=window.OOCTilesTargetContentBatchFileSize||2097152;function d(e,t,n){var i,r;for(i=t;i<e.length;i++){if(13===(r=e[i]))return{str:n.decode(e.subarray(t,i)),index:i+2};if(10===r)break}return{str:n.decode(e.subarray(t,i)),index:i+1}}s.prototype.createContentBatch=function(){return new h(this.tileSet.getMaxContentBatchSize(),a)},s.prototype.loadTileContent_multi=function(e,t,n,i,r,o){this.currentContentBatch||(this.currentContentBatch=this.createContentBatch()),this.currentContentBatch.addContent(e,t,n,o,i,r)&&(this.downloadMultiPart(this.currentContentBatch),this.currentContentBatch=this.createContentBatch())},s.prototype.flushLoadTileContent=function(){this.currentContentBatch&&!this.currentContentBatch.isEmpty()&&(this.downloadMultiPart(this.currentContentBatch),this.currentContentBatch=this.createContentBatch()),this.currentBankBatch&&!this.currentBankBatch.isEmpty()&&(this.loadBankBatch(this.currentBankBatch),this.currentBankBatch=null)},s.prototype.downloadMultiPart=function(n){this.tileSet.contentTickets--;var i=n.getContentUris(this.sourceId),r=this.contentBatchingURL,s=null;o.odt&&(s=e,e=o.odt.FakeContentWAFData),e.authenticatedRequest(r,{cors:!0,timeout:36e5,method:"POST",data:JSON.stringify(i),async:!0,type:"arraybuffer",headers:{"Content-Type":"application/json"},onComplete:(e,i,r)=>{t.trackPageEvent({eventCategory:"WebVisualization",eventAction:"3DXMTiles",eventLabel:r&&function(e){var t=e.split("/");if(t.length>5){var n=t[t.length-1],i=t[t.length-1].indexOf("?");-1!==i&&(n=n.substring(0,i),t[t.length-1]=n);let e=t.slice(4,t.length);return e.join("/")}return 0===t[t.length-1].length?t[t.length-2]:t[t.length-1]}(r.url),appID:p,persDim:{pd1:u,pd2:p},persVal:{pv1:r&&r.timeoutTimer,pv2:e.byteLength}});var o={contentData:0,nextIndex:0},s=0,a=new Int8Array(e);do{(o=this.extractNextData(a,o.nextIndex)).contentData&&this.loadContentFromBuffer({data:o.contentData,batch:n,index:s,fromBank:!1}),s++}while(o.contentData)},onFailure:()=>{this.tileSet.contentTickets++,n.onFullError()}}),s&&(e=s)},s.prototype.extractNextData=function(e,t){var n,i,r,o=new TextDecoder,s=t,a=-1;do{s=(n=d(e,s,o)).index,(r=n.str).toLowerCase().startsWith("content-length:")&&(i=r.split(" "),a=parseInt(i[1]))}while((r.length>0||a<0)&&s<e.length);var l=null;return s=n.index,a>0&&(l=e.buffer.slice(s,s+a)),{contentData:l,nextIndex:s+a}};class l{constructor(e,t,n,i,r,o){this.node=e,this.content=t,this.params=n,this.updateContentData=i,this.onLoadedCB=r,this.onErrorCB=o}}class h{constructor(e,t){this.maxSize=e,this.targetFileSize=t,this.contents=[],this.toLoadCount=0,this.fileSize=0}addContent(e,t,n,i,r,o){return this.contents.push(new l(e,t,n,i,r,o)),this.fileSize+=t.fileSize,this.toLoadCount++,this.contents.length>=this.maxSize||this.fileSize>=this.targetFileSize}getSize(){return this.contents.length}onContentLoaded(){this.toLoadCount--}isFullyLoaded(){return this.toLoadCount<=0}getNode(e){return this.contents[e].node}getContent(e){return this.contents[e].content}getParams(e){return this.contents[e].params}getOnLoadedCB(e){return this.contents[e].onLoadedCB}getOnErrorCB(e){return this.contents[e].onErrorCB}getUpdateContentData(e){return this.contents[e].updateContentData}isEmpty(){return 0===this.contents.length}getContentUris(e){var t,n=[];for(t=0;t<this.contents.length;t++)n.push(this.contents[t].content.getUri(e,this.contents[t].params));return n}onFullError(){for(i=0;i<this.contents.length;i++){let e=this.contents[i].node;(0,this.contents[i].onErrorCB)(e)}}}var c="undefined"!=typeof widget&&null!==widget?widget:void 0,u=c?c.id:"no_widget",p=c?c.getValue("x3dAppId")?c.getValue("x3dAppId"):c.getValue("appId"):"no_widget_appid";return s}),define("DS/3DXMTiles/Default360ContentManager",["DS/3DXMTiles/OOCTilesCustomContentManager","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture"],function(e,t,n,i){"use strict";var r={canvasNodeTexture:null,createNode:function({uri:e,tileSet:r,parentNode:o}){this.canvasNodeTexture||(this.canvasNodeTexture=new i({width:10,height:10,drawCB:this.drawCanvasCB,alphaTest:.02}));var s=t.createCanvas2DNode({canvasNodeTexture:this.canvasNodeTexture,hotspot:new n.Vector2(25,25)});o.addChild(s)},removeNode:function({uri:e,tileSet:t,parentNode:n}){n.removeChildren()},drawCanvasCB:function(e,t){var n=e.width,i=e.height;t.fillStyle="red",t.fillRect(0,0,n,i)}},o=-1;function s(){return-1===o&&(o=window.OOC360RedDots?1:0),1===o}return new e({type:"360",displayRedDots:-1,createNodeCB:function({uri:e,tileSet:t,parentNode:n}){s()&&r.createNode({uri:e,tileSet:t,parentNode:n})},removeNodeCB:function({uri:e,tileSet:t,parentNode:n}){s()&&r.removeNodeCB({uri:e,tileSet:t,parentNode:n})},needsSgNodePerContentCB:function(){return s()}})}),define("DS/3DXMTiles/DSTilesR2VPointCloudContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/PointCloudServices","DS/Mesh/Mesh","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHStats","DS/3DXMTiles/DSTilesR2VOctree","DS/3DXMTiles/DSTilesSourceIdWithParams","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],function(e,t,n,i,r,o,s,a,d,l){"use strict";var h=!1;var c=function(t){e.call(this,t),this.rootSGNode=t.targetSGNode,this.buildUrlCB=t.buildUrlCB,this.materialMap=new WeakMap;let n=parseFloat(window.localStorage.getItem("OOCMinPointSize"))||4,i=parseFloat(window.localStorage.getItem("OOCMaxPointSize"))||255;this._ptMinSize=n,this._ptMaxSize=i,this._maxSpacing=0,this.nbTickets=10,this._dbgNoPickParent=!!window.OOCTilesNoPickParent,this._enableHighlight=!!window.OOCTilesR2VHighlight,h&&(this.octreeMap=new WeakMap),this.splattingFactor=1.3,this.roundPoints=-1};(c.prototype=Object.create(e.prototype)).setSplattingParameters=function(e){void 0!==e.splattingFactor&&(this.splattingFactor=e.splattingFactor),void 0!==e.minSize&&(this._ptMinSize=e.minSize),void 0!==e.maxSize&&(this._ptMaxSize=e.maxSize)},c.prototype.getBudgetParams=function(){return{name:"pointCloud",physicalBudget:"gpu",params:{maxLimit:251658240}}},c.prototype.isReady=function(){return this.nbTickets>0},c.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},c.prototype.loadContentFromBuffer=function({data:e,node:t,content:n,onLoadedCB:r,onErrorCB:o,params:a,updateContent:d}){let l=this.getStylingAttributesMap(t.tileSet);var h=t.queue;if(0===this._maxSpacing){var c=t.getBoundingBox(),p=c.min.distanceTo(c.max)/1e3;this._maxSpacing=p}var f=n.getContentToken(d);f||(f=new u(t,n,h),n.setContentToken(f,d));var g=i.createTileContentFromBuffer(e,l);if(g){let e=0;if(a&&a.attributes.length>0&&(e=a.index,f.attributes||(f.attributes=[]),f.attributes=f.attributes.concat(a.attributes)),f.geometries[e]=g.geometry,f.geometries.indexOf(null)<0){s.onLoadedModel(0);var m=g.geometry;let e=this.getMaterial(n,t);this.materialsInitialized=!0,this._maxSpacing=m.spacing,e.updatePDSFXUniform("uMaxSpacing",m.spacing),this.setupNode3D(f,f.geometries,e,l),f.computeMemorySize(),this.budget.updateUsage(0,f.size)}r()}else o()},c.prototype.getMaterial=function(e,t){let n=this.materialMap.get(t.tileSet),i=n?n.material:null,r=t.tileSet.styling;return i&&n.styling===r||(i=this.createMaterial(t.tileSet),this.materialMap.set(t.tileSet,{material:i,styling:r})),i},c.prototype.setupNode3D=function(e,t,n,i){var r=e.node;if(r.isAlive()){let o,s=0;for(o=0;o<t.length;o++)s+=t[o].buffer.byteLength;e.size=s,e.mesh3D=this.createNode3D(t,n,r,!0,i)}else e.content.setContentToken(null)},c.prototype.getOctreeFromContent=function(e){var t=this.octreeMap.get(e.root);return t||(t=new a({tileNode:e.root}),this.octreeMap.set(e.root,t)),t},c.prototype.showContent=function(e,t){let n=t.contentToken;if(!n)return;var i=n.mesh3D;if(!i)return;let r=this.getMaterial(t,e);(i.setMaterial(r),h)&&this.getOctreeFromContent(n).addTileNode(e,n.depth);var o=e.getSgNode();this._enableHighlight||(o.excludeFromHighlight(!0,!0),o.propagateXSOExclusion(!0)),0===i.parents.length&&o.addChild(i),n.mesh3D.setVisibilityFree(!1),this._dbgNoPickParent||i.setPickParent(!0),i.setVisibility(!0)},c.prototype.hideContent=function(e,t){let n=t.contentToken;if(n&&n.mesh3D){if(h)this.getOctreeFromContent(n).removeTileNode(n.node,n.depth);n.mesh3D.setVisibilityFree(!0),n.mesh3D.setVisibility(!1)}},c.prototype.deleteContent=function(e,t,n){n&&(n.release(),n.mesh3D=null,this.budget.updateUsage(n.size,0))},c.prototype.exportContent=function(e,t){let n=t.contentToken;if(n)return[n.mesh3D]},c.prototype.createNode3D=function(e,n,i,s,a){null!=this.geometry&&console.error(this.toString()+":geometry exist already !");var d=new t.BufferGeometryDS;d.noMeshInRAM=!0;let l,h=0;for(l=0;l<e.length;l++){let t=e[l];if(d.buffers[l]=t.buffer,t.attributes.constructor===Array)for(let e of t.attributes)if("position"===e.name&&3===e.count&&12===e.size)h=l,d.layout.set({position:{type:"float32x3",offset:e.offset,stride:e.stride,bufferId:l}});else if("color"===e.name&&4===e.count&&4===e.size)d.layout.set({ptCol:{type:"unorm8x3",offset:e.offset,stride:e.stride,bufferId:l},ptSize:{type:"unorm8",offset:e.offset+3,stride:e.stride,bufferId:l}});else{let t=a.get(e.name);if(t){let n=t.type;this.setLayoutFromType(d,e,n,l)||console.error("Error handling attribute: "+e)}}else for(let e in t.attributes){const n=t.attributes[e];d.layout.setAttribute(Object.assign({name:e},n,{bufferId:l}))}}d.boundingBox=i.getBoundingBox().clone(),d.boundingSphere=i.getBoundingSphere().clone();let c=new r.DrawingGroup(null,n,0,0,e[h].points);c.geometry=d,c.nonIndexed=!0,d.drawingGroups=[c];let u=new t.Mesh(d,n);u.hasPoint=!0;var p=new o(u,"OOCNode");p.explicitBSphere.copy(d.boundingSphere),p.explicitBBox.copy(d.boundingBox),p.setUserData({dsTilesNode:i}),p.setFrustumCulled(!1);i._getWorldMatrix();return p},c.prototype.setLayoutFromType=function(e,t,n,i){let r=null,o=t.name;switch(n){case"float":1===t.count&&4===t.size&&(r={type:"float32",offset:t.offset,stride:t.stride,bufferId:i});break;case"integer":1===t.count&&4===t.size&&(o=t.name+"_v2",r={type:"uint16x2",offset:t.offset,stride:t.stride,bufferId:i})}if(null!==r){let t={};return t[o]=r,e.layout.set(t),!0}return!1},c.prototype.getNodeMaterial=function(){return this._nodeMaterial},c.prototype.getLODMaterial=function(){return this._LODMaterial},c.prototype.createMaterial=function(e){let n=new t.ParticleBasicMaterial({force:!0});n._activatePDSFXMigrated();let i={uMinRamp:{type:"f",value:0},uMaxRamp:{type:"f",value:1},uMinPtSize:{type:"f",value:this._ptMinSize},uMaxPtSize:{type:"f",value:this._ptMaxSize},uMaxSpacing:{type:"f",value:this._maxSpacing},uDPR:{type:"f",value:t.getDevicePixelRatio()},splattingFactor:{type:"f",value:this.splattingFactor}};n.setPDSFXUniforms(i);n.setPDSFXVaryings({vScalar:{type:"f"},oocColor:{type:"v3"}});let r={ptSize:{type:"f"},ptCol:{type:"v3"}},o=this.getStylingAttributesMap(e);o.forEach((e,t)=>{if(!t.startsWith("Predefined3DSTiles_"))switch(e.type){case"integer":r[t+"_v2"]={type:"v2"};break;case"float":r[t]={type:"f"}}}),n.setPDSFXAttributes(r);let s=e.styling&&e.styling.getRules(),a=s&&s[0];const d=this;n.setPDSFXGlobalShaderCode(function(e){e.variableHandler;const t=e.functionHandler;e.userDefines;return`      \n                ${a&&a.render&&a.render.buildShaderGlobalCode(e)||""}\n\n                ${d.buildshader_declareAttributes(o,e)}\n\n                ${t.dF("isShowFilterVisible","b",[])}{\n                    ${d.buildshader_filter(a&&a.showFilter,e)}\n                }\n\n                ${t.dF("isRenderFilterVisible","b",[])}{\n                    ${d.buildshader_filter(a&&a.renderFilter,e)}\n                }\n\n                ${t.dF("computeColor","v3",[])}{\n                    ${d.buildshader_computeColor(a&&a.render,e)}\n                }\n            `},null);let h={ComputeCommonValues:function(e,t){return`\n                    ${d.buildshader_setAttributes(o,e)}\n                    `},ComputeVaryingValues:function(e,t){const n=e.variableHandler,i=e.functionHandler;e.userDefines;return`\n                        if (${i.cF("isRenderFilterVisible","b",[])}) {\n                            ${e.getVarying("oocColor")} = ${i.cF("computeColor","v3",[])};\n                        } else {\n                            ${e.getVarying("oocColor")} = pow(ptCol, ${n.vec3()}(2.2));\n                        }\n                    `},ProcessClipSpacePosition:function(e,t){const n=e.variableHandler,i=e.functionHandler,r=(e.userDefines,t[0]);return`\n                            if (!${i.cF("isShowFilterVisible","b",[])}) {            \n                                ${n.dereference()}${r}.x = -10.0;\n                                ${n.dereference()}${r}.y = -10.0;\n                                ${n.dereference()}${r}.w = 1.0;\n                            }\n                        `},ComputePointSize:function(e,t){const n=e.variableHandler,i=e.functionHandler,r=t=>e.getUniform(t);e.userDefines;return`           \n                            ${n.vec3("pos")} = ${e.vGetAttribPosition()};\n                            ${n.vec4("p")} = ${((e,t,n)=>l.FunctionHandler.callFunction(e,t,n))("computeModelViewPosition","v4",[i.prmV3("pos")])};\n                            ${n.float("spacingScale")}  = ptSize*length(modelMatrix[0]);\n                            ${n.float("spacing")}  = spacingScale * ${r("uMaxSpacing")} * ${r("splattingFactor")};\n\n                            ${n.mat4("projMatrix")}  = ${e.vGetProjectionMatrix()};\n                            //2*near/(top-bottom) for persp. 2/(top-bottom) for ortho.\n                            ${n.float("topBottomComposant")}  = projMatrix[1][1];\n                            ${n.float("pixelSpacingProjection")}  = (spacing)*${n.float()}(${e.vGetViewportSize()}.y)*(topBottomComposant/2.0);\n                            //-1 in persp, 0 in ortho\n                            ${n.float("perspectiveComposant")}  = projMatrix[2][3];\n                            //1 in ortho, 0 in persp\n                            ${n.float("orthographicComposant")}  = projMatrix[3][3];\n                            ${n.float("spacingInPixels")}  = pixelSpacingProjection * ( perspectiveComposant/p.z + orthographicComposant);\n\n                            return clamp( spacingInPixels, ${r("uMinPtSize")}, ${r("uMaxPtSize")} ) * ${r("uDPR")};\n                        `}},c={ComputeAlbedo:function(e,t){return`\n                    return ${e.getVarying("oocColor")};\n                `}};-1===this.roundPoints&&(this.roundPoints=window.OOCR2VRoundPoints?1:0),1===this.roundPoints&&(c.ComputeDiscard=function(e,t){const n=e.variableHandler;e.functionHandler;return`             \n                    ${n.vec2("p")} = ${e.vGetPointCoord()};\n                    ${n.vec2("v")} = ${n.vec2()} (0.5-p.x, 0.5-p.y);\n                    return length(v) > 0.5;\n                `}),n.setPDSFXOverridableFunctions(h,c);let u=this;return n._refreshPDSFXUniforms_private=function(e,n){e._fixedPointSize?(this.updatePDSFXUniform("uMinPtSize",e._fixedPointSize),this.updatePDSFXUniform("uMaxPtSize",e._fixedPointSize),this.updatePDSFXUniform("uDPR",1),this.updatePDSFXUniform("splattingFactor",1.3)):(this.updatePDSFXUniform("uMinPtSize",u._ptMinSize),this.updatePDSFXUniform("uMaxPtSize",u._ptMaxSize),this.updatePDSFXUniform("uDPR",t.getDevicePixelRatio()),this.updatePDSFXUniform("splattingFactor",u.splattingFactor))},n},c.prototype.buildshader_declareAttributes=function(e,t){let n="";const i=t.variableHandler;return e.forEach((e,t)=>{if(t.startsWith("Predefined3DSTiles_"))n=`\n                    ${n}\n                    ${(e=>i.float(e))(t)};\n                `;else switch(e.type){case"integer":n=`\n                            ${n}\n                            ${(e=>i.int(e))(t)};\n                        `}}),n},c.prototype.buildshader_setAttributes=function(e,t){let n="",i=!1;const r=t.variableHandler;return e.forEach((e,o)=>{if(i||(i=!0,n=`\n                    ${n}\n                    ${(e=>r.vec3(e))("_3dstiles_position")} = ${t.vGetAttribPosition()};\n                `),"Predefined3DSTiles_x"===o)n=`\n                    ${n}\n                    Predefined3DSTiles_x = _3dstiles_position.x;\n                `;else if("Predefined3DSTiles_y"===o)n=`\n                    ${n}\n                    Predefined3DSTiles_y = _3dstiles_position.y;\n                `;else if("Predefined3DSTiles_z"===o)n=`\n                    ${n}\n                    Predefined3DSTiles_z = _3dstiles_position.z;\n                `;else switch(e.type){case"integer":n=`\n                            ${n}\n                            ${o} = ${(e=>r.int(e))()}(${o}_v2.x + 65535.0*${o}_v2.y);\n                        `}}),n},c.prototype.buildshader_filter=function(e,t){return e?e.buildShaderCode(t):"return true;"},c.prototype.buildshader_computeColor=function(e,t){if(e){return e.buildShaderCode(t)}return`return pow(ptCol, ${t.variableHandler.vec3()}(2.2));\n            `},c.prototype.getStylingAttributesMap=function(e){let t=new Map;if(e.styling){let n,i=e.styling.getNeededAttributes();for(n=0;n<i.length;n++){let r=e.availableAttributesMap.get(i[n]);t.set(i[n],r)}}return t},c.prototype.createUpdatedContentTokenFromContentToken=function(e,t){let n=e.getContentToken(!1);if(!n)return null;let i=t.tileSet,r=i.styling&&i.styling.getNeededAttributes(),o=!1;if(r&&0!==r.length){let e;for(o=!0,e=0;e<r.length;e++)r[e].startsWith("Predefined3DSTiles_")||n.attributes&&!(n.attributes.indexOf(r[e])<0)||(o=!1)}else o=!0;if(o){let t=null;t=n.clone(),e.setContentToken(t,!0)}return o};new d("default",null);c.prototype.getSourceIdWithParamsArray=function(e,t){var n=[new d(e.getSingleSourceId(),null)];let i=t.tileSet,r=i.styling&&i.styling.getNeededAttributes();if(r){let t;for(t=0;t<r.length;t++)r[t].startsWith("Predefined3DSTiles_")||n.push(new d(e.getSingleSourceId(),{uriPostFix:"&m="+r[t],attributes:[r[t]],index:t+1}))}return n};class u{constructor(e,t,n){this.node=e,this.content=t,this.geometries=[null];let i=e.tileSet;if(this.attributes=null,this.useCount=[1],i.styling){let e,t=i.styling.getNeededAttributes();for(e=0;e<t.length;e++)t[e].startsWith("Predefined3DSTiles_")||this.geometries.push(null)}h&&(this.root=null,this.depth=0,this.updateRootAndDepth()),this.queue=n,this.mesh3D=null,this.size=0}addRef(){this.useCount[0]++}release(){(this.useCount[0]--,this.useCount[0]<=0)&&this.node.getSgNode().removeChild(this.mesh3D)}updateRootAndDepth(){var e=this.node;this.root=this.node,this.depth=-1;do{this.depth++,this.root=e,e=e.parent}while(e)}computeMemorySize(){return new n(0,this.size)}setTileSetVisibility(e){}clone(){let e=new u(this.node,this.content,this.queue);return e.attributes=this.attributes,e.geometries=this.geometries,e.useCount=this.useCount,h&&(e.root=this.root,e.depth=this.depth,e.updateRootAndDepth()),e.queue=this.queue,e.mesh3D=this.mesh3D,e.size=this.size,e.addRef(),e}}return c}),define("DS/3DXMTiles/DSTilesInstancingContentLoader",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/InstancingNode3D"],function(e,t,n,i,r,o){"use strict";class s{constructor(t,n,i){this.node=t,this.content=n,this.queue=i,this.instancingNode=new o;let r=n.instances;if(r){let t,n=[];for(t=0;t<r.length;t++){let i=r[t];if(i&&i.matrix){let t=new e.Matrix4;t.setFromJSON(i.matrix),n.push(t)}}n.length>0&&this.instancingNode.setInstancingParameters(n)}this.visible=!1,this.geometrySize=0}computeMemorySize(){this.geometrySize=r.computeMeshSize(this.instancingNode)}}return class extends t{constructor(e){super(e=e||{}),this.instancingRoot=null}getBudgetParams(){return{name:"instancedMesh",physicalBudget:"gpu",params:{}}}getInstancingRoot(){this.instancingRoot||(this.instancingRoot=new i,this.tilesManager.getOOCTargetNode().addChild(this.instancingRoot))}isReady(){return n.isReady()}hasExistingData(e,t,i){let r=e.tileSet.getContentSource(i);return n.reuseMap.hasData(r,t.uri)}onStartLoading(e,t,i){let r=e.tileSet.getContentSource(i);return n.reuseMap.startLoading(r,t.uri)}loadContentFromExistingData(e,t,i,r,o){var a=e.queue;let d=e.tileSet.getContentSource(i);var l=new s(e,t,a);n.loadFromReuse(l.instancingNode,this.onModelLoaded.bind(this,l,r),this.onModelError.bind(this,l,o),d,t)}loadContentFromBuffer({data:e,node:t,content:i,onLoadedCB:r,onErrorCB:o,sourceId:a,params:d}){var l=t.queue,h=new s(t,i,l);let c=t.tileSet.getContentSource(a);n.loadFromBuffer(e,h.instancingNode,i.getFormat(),this.onModelLoaded.bind(this,h,r),this.onModelError.bind(this,h,o),!0,c,i)}onModelLoaded(e,t){var n=e.node,i=(e.queue,e.content);n.isAlive()&&(i.setContentToken(e),e.computeMemorySize(),this.budget.updateUsage(0,e.geometrySize)),t()}onModelError(e,t){e.node,e.queue,t()}showContent(e,t){let n=t.contentToken;n&&n.node.getSgNode().addChild(n.instancingNode)}hideContent(e,t){let n=t.contentToken;n&&n.node.getSgNode().removeChild(n.instancingNode)}deleteContent(e,t,i){n.reuseMap.release(t.getSingleSource(e),t.uri),i&&(this.hideContent(e,i),this.budget.updateUsage(i.geometrySize,0),i.instancingNode.removeChildren(),i.instancingNode=null,i.geometrySize=0)}exportContent(e,t){let n=t.contentToken;if(n)return n.nodes.length>0?[].concat(n.nodes):[].concat(n.instancingNode.children)}needsSgNodePerContent(){return!0}}}),define("DS/3DXMTiles/DSTilesVolumeContentLoader",["DS/3DXMTiles/DSTilesContentLoader","DS/3DXMTiles/DSTilesNodeMemorySize","DS/3DXMTiles/ModelLoaderSingleton","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/VolumeRenderingManagerSimple"],function(e,t,n,i,r,o,s,a){"use strict";var d=function(t){if(t=t||{},e.call(this,t),this.buildUrlCB=t.buildUrlCB,this.viewer=t.viewer||debugWebGLV6Viewer,this.volumeManager=null,this.fromCGR=!1,this.needUpdateMetaData=!0,this.tileSet=null,this.contentMetaDataVersion=0,this.viewer){var n=this.viewer.getEffect("VolumeRendering");this.volumeManager=n?n.volumeManager:null}};(d.prototype=Object.create(e.prototype)).getBudgetParams=function(){return{name:"volume",physicalBudget:"gpu",params:{}}},d.prototype.onContentMetaDataUpdate=function(e){this.updateEffect(e.tileSet)},d.prototype.updateEffect=function(e){if(!this.volumeManager){this.viewer.renderer.setEffect("VolumeRendering",!0);let e=this.viewer.getEffect("VolumeRendering");this.volumeManager=new a(this.viewer),e.volumeManager=this.volumeManager,d._dbgNoAttenuation||(e.setAttenuation(.001),e.setAttenuationScale(.001))}if(this.tileSet!==e||this.contentMetaDataVersion!==e.contentMetaDataVersion){this.contentMetaDataVersion=e.contentMetaDataVersion;var t=e.contentMetaData&&e.contentMetaData.volume,n=this.volumeManager;this.tileSet=e;var i=e.getRootNode();if(r=i.metaData&&i.metaData.volume&&i.metaData.volume.range){var r=[parseFloat(r[0]),parseFloat(r[1])];n.setTileSetRange(r)}t&&t.displayRange&&(this.volumeManager.setMinValue(parseFloat(t.displayRange[0])),this.volumeManager.setMaxValue(parseFloat(t.displayRange[1]))),t&&t.transferFunction&&this.volumeManager.updateTransferFunctionRaw(t.transferFunction),t&&t.colorMap&&this.volumeManager.setColorMapRaw(t.colorMap)}},d.prototype.isReady=function(){return n.isReady()},d.prototype.isNodeVisible=function(e){var t=e.tileSet;this.updateEffect(t);var n=e.metaData&&e.metaData.volume&&e.metaData.volume.range;return!n||!!this.volumeManager.isRangeVisible({min:n[0],max:n[1]})},d.prototype.isThereEnoughMemoryToLoad=function(e,t){return t.isLoadingAllowed()},d.prototype.loadContentFromBuffer=function({data:e,node:t,content:i,onLoadedCB:r,onErrorCB:o,params:s}){var a=t.queue,d=new l(t,i,a),h=t.tileSet;this.updateEffect(h),"3dxc"!==i.getFormat()&&(this.fromCGR=!0),n.loadFromBuffer(e,d.targetSGNode,i.getFormat(),this.onModelLoaded.bind(this,d,r),this.onModelError.bind(this,d,o))},d.prototype.onModelLoaded=function(e,t){e.node,e.queue;(e.content.setContentToken(e),e.computeMemorySize(),this.volumeManager)&&this.volumeManager.getVolumeData(e,this.fromCGR);t()},d.prototype.onModelError=function(e,t){e.node,e.queue;t()},d.prototype.computeMemorySize=function(e){return new t(0,0)},d.prototype.showContent=function(e,t){let n=t.contentToken;if(n){if(this.volumeManager){n.node;var i=n.data.valueRange;if(i&&!this.volumeManager.isRangeVisible(i))return}if(this.volumeManager&&n.data)this.volumeManager.addChunk(n)&&0}},d.prototype.hideContent=function(e,t){let n=t.contentToken;n&&(this.volumeManager&&this.volumeManager.removeChunk(n)&&0)},d.prototype.deleteContent=function(e,t,n){},d.prototype.exportContent=function(e,t){return null},d._dbgNoAttenuation=!1;var l=function(e,t,n){this.node=e,this.content=t,this.queue=n,this.targetSGNode=new i,this.nodes=[],this.visible=!1,this.memorySize=null};return l.prototype.computeMemorySize=function(){this.memorySize=new t(0,0)},d}),define("DS/3DXMTiles/LDHZipHandler",["DS/Visualization/ThreeJS_DS","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/ModelLoader","DS/3DXMTiles/ModelBank"],function(e,t,n,i,r,o){"use strict";var s=function(e,n){t.call(this,t.Model3DHandler),this.manager=null,this.nbTickets=1,this.nbLoading=0,this.maxBatchSize=1,this.modelLoader=null,this.unzipLib=e.unzipLib||"zipjs2",this.loadModelCB=e.loadModelCB||this.CGRLoadCB.bind(this)};(s.prototype=Object.create(t.prototype)).isReady=function(){return this.nbLoading<this.nbTickets},s.prototype.handleReference=function(e,t){this.manager=t.manager._ldhNodeManager;var n=this.manager;e.requestBuildSceneGraphHierarchy(!0),n.tryBuildSceneGraphHierarchy();var i=e.getActiveRepresentation();i!==e.getPrimaryRepresentation()&&i.buildNode();var r=i.node;this.nbLoading++;var o=this.onModelLoaded.bind(this,e,t),s=this.onModelError.bind(this,e,t),a=i.src.zipArchive,d=i.src.path;"zipjs2"===this.unzipLib?a.find(d).getUint8Array().then(e=>{this.loadModelCB({targetNode:r,data:e,onLoadedCB:o,onErrorCB:s})}).catch(e=>{}):"zipjs1"===this.unzipLib&&a.find(d).getBlob("application/octet-stream",e=>{var t=new FileReader;t.onload=(e=>{this.loadModelCB({targetNode:r,data:e.target.result,onLoadedCB:o,onErrorCB:s})}),t.readAsArrayBuffer(e)})},s.prototype.onModelLoaded=function(e,t,i){this.nbLoading--;e.getActiveRepresentation();n.statsInit(),n.statsOnLoadedModel();e.referenceId;var r=t.manager;this.commitModelLoadedTransaction(e,r,i),t.doneCB([e],[])},s.prototype.onModelError=function(e,t){this.nbLoading--;e.referenceId,t=this.referenceToContext.get(e);this.referenceToContext.delete(e),t.doneCB([],[e])},s.prototype.acceptsRepresentation=function(e,t){return!0},s.prototype.CGRLoadCB=function(e){this.modelLoader||(this.modelLoader=new r,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0)),this.modelLoader.setOnLoadedProductStructureCallback(t=>{e.onLoadedCB(t)}),this.modelLoader.setOnErrorCallback(()=>{e.onErrorCB()});this.modelLoader.loadModelFromBuffer(e.data,e.targetNode,{})};var a=function(e){this.handler=e,this.reference=null};return a.prototype.containsReference=function(e){return this.reference&&this.reference.referenceId===e},a.prototype.addReferenceIfPossible=function(e,t){return!this.reference&&(this.reference=e,!0)},a.prototype.isEmpty=function(){return!this.reference},a.prototype.getSize=function(){return this.reference?1:0},a.prototype.setReferencesLoading=function(e){this.reference&&(this.reference.isLoading()||this.reference.setLoading(e))},s.prototype.handleBatch=function(e,t){this.handleReference(e.reference,t)},s.prototype.createBatch=function(){return new a(this)},s}),define("DS/3DXMTiles/DSTilesStdExpander",["DS/3DXMTiles/DSTilesExpander","DS/3DXMTiles/DSTilesNode","DS/Visualization/ThreeJS_DS","DS/3DXMTiles/DSTilesContentSet","DS/3DXMTiles/DSTilesMeshContentLoader","DS/3DXMTiles/DSTilesR2VPointCloudContentLoader","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/DSTilesVolumeContentLoader","DS/3DXMTiles/DSTilesTerrainContentLoader","DS/3DXMTiles/DSTilesTileSetContentLoader","DS/3DXMTiles/DSTilesInstancingContentLoader"],function(e,t,n,r,o,s,a,d,l,h,c){"use strict";var u=function(e){this.tilesManager=e.tilesManager,this.contentLoaderMap=new Map,this.createContentLoaders(),this.buildUrlCB=e.buildUrlCB||null,this.scoreComputer=e.scoreComputer,this._dbg_onLoadedNodeCB=e._dbg_onLoadedNodeCB,this.nbTickets=20,this.jsonPreprocessCB=e.jsonPreprocessCB||null,this.worldMatrixMap=new WeakMap};return(u.prototype=Object.create(e.prototype)).init=function(){this.contentLoaderMap.forEach(e=>{e.init()})},u.prototype.createContentLoaders=function(){this.contentLoaderMap.set("mesh",new o({tilesManager:this.tilesManager})),this.contentLoaderMap.set("pointCloud",new s({tilesManager:this.tilesManager})),this.contentLoaderMap.set("volume",new d({tilesManager:this.tilesManager})),this.contentLoaderMap.set("terrain",new l({tilesManager:this.tilesManager})),this.contentLoaderMap.set("tileSet",new h({tilesManager:this.tilesManager})),this.contentLoaderMap.set("instancedMesh",new c({tilesManager:this.tilesManager}))},u.prototype.isReady=function(){return this.nbTickets>0},u.prototype.isThereEnoughMemoryToExpand=function(e,t){return!0},u.prototype.getContentLoader=function(e){var t=this.contentLoaderMap.get(e)||null,n=null;return t||(n=this.tilesManager.getCustomContentManager(e))&&(t=n._getContentLoader(this.tilesManager)),t},u.prototype.expandNow=function(e){if(!e.isAlive())return!0;var t=e.queue,n=e.queue.queueSet,r=e.tileSet,o=e.childrenURIs,s=[],d=[];for(i=0;i<o.length;i++){let t=e.childrenEtags&&e.childrenEtags[i];var l=this.createNodeFromPreloaded(e,o[i],t,n,r,d);if(!l)return!1;s.push(l)}return function(){var n,i,r;for(e.tileSet.addNode(e),n=0;n<s.length;n++)(i=s[n]).tileSet.addNode(i),e.addChild(i),i.children&&i.children.length>0&&i.setExpandStatus(a.loaded,t),t.registerDSTilesNode(i);for(n=0;n<d.length;n++)(r=d[n]).tileSet.addNode(d[n]),r.children&&r.children.length>0?r.setExpandStatus(a.loaded,t):t.registerDSTilesNode(r)}(),!0},u.prototype.createNodeFromPreloaded=function(e,t,n,i,r,o){if(r.hasPreloadedNode(t,n)){var s=r.getPreloadedNodeJSON(t);if(s)return this.createNodeFromJSON(s,e,t,i,r,o)}return null},u.prototype.createNodeFromJSON=function(e,i,o,s,a,d){var l,h=null,c=null,u=1/0,p=null,f=[];if(e.children)for(l=0;l<e.children.length;l++)f.push(e.children[l]);var g=null;if(e.matrix)(p=new n.Matrix4).setFromJSON(e.matrix);else if(e.worldMatrix){var m=null;if((m=new n.Matrix4).setFromJSON(e.worldMatrix),g=m.clone(),i){var S=this.worldMatrixMap.get(i)||null;if(i.updateWorldMatrix(),S){var y=new n.Matrix4;y.getInverse(S),m.multiplyMatrices(y,m)}}p=m}var v=e.boundingVolume;v&&(v.sphere&&(h=new n.Sphere).setFromJSON(v.sphere),v.box&&(c=new n.Box3).setFromJSON(v.box));var M=e.triggerCondition,L=null;M&&(M.hasOwnProperty("geometricalError")?(u=parseFloat(M.geometricalError),L="pixelError"):M.hasOwnProperty("distanceToBox")&&(u=parseFloat(M.distanceToBox),L="distanceToBox"));var T=null;if(null===(T="add"===e.mode?t.Mode.addLOD:"ADD"==e.mode?t.Mode.addLOD:"replace"==e.mode?t.Mode.replaceLOD:i?i.mode:t.Mode.replaceLOD))throw new Error("mode is mandatory");e.content&&"POINTCLOUD"===e.content.type&&(e.content.type="pointCloud");var D=r.create(e.content,this),C=s.getQueueFromTileSet(a),R=new t({uri:o,tileSet:a,expander:this,childrenURIs:f,childrenEtags:e.childrenEtags,scoreComputer:this.scoreComputer,matrix:p&&!p.isIdentity()?p:null,geometricalError:u,boundingBox:c,boundingSphere:h,contentSet:D,mode:T,queue:C,userData:e.userData,metaData:e.contentMetaData,triggerMetric:L});return R.setMatrixUpdate(!0),g&&this.worldMatrixMap.set(R,g),d&&this.completeNodeChildrenIfPossible(R,s,a,C,d),R},u.prototype.completeNodeChildrenIfPossible=function(e,t,n,i,r){var o,s=!1;for(o=0;e.childrenURIs&&o<e.childrenURIs.length&&!s;o++){let t=e.childrenEtags&&e.childrenEtags[o];n.hasPreloadedNode(e.childrenURIs[o],t)||(s=!0)}if(!s){var a,d,l;for(o=0;e.childrenURIs&&o<e.childrenURIs.length&&!s;o++)l=e.childrenURIs[o],a=n.getPreloadedNodeJSON(l),d=this.createNodeFromJSON(a,e,l,t,n,r),r.push(d),e.addChild(d);e.children||(e.children=[])}},u.prototype.setSplattingParameters=function(e){this.getContentLoader("pointCloud").setSplattingParameters(e)},u}),define("DS/3DXMTiles/DSTilesStylingRenderRange",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingRender"],function(e,t){"use strict";class n extends t{constructor(){super(),this.attribute=null,this.values=[],this.colors=[]}setFromJSON(t){let n=[],i=t.attribute;e.isStylingAttributeName(i)?this.attribute=i:n.push(e.error("illegal attribute property","range"));let r,o=!1;for(r=0;r<t.values.length;r++){let n=t.values[r];e.isNumberOrString(n)?this.values.push(n):o=!0}for(o&&n.push(e.error("illegal value","range")),o=!1,r=0;r<t.colors.length;r++){let n=t.colors[r];e.isNumberOrString(n)?this.colors.push(n):o=!0}return o&&n.push(e.error("illegal color","range")),n.length?e.error("Error parsing range render","render",n):this.colors.length!==this.values.length+1?e.error("colors.length !== values.length+1","range"):e.ok}addNeededAttributesToSet(e){e.add(this.attribute)}buildShaderCode(e){const i=e.variableHandler,r=e=>i.float(e),o=e=>i.vec3(e);let s,a=`\n                ${o("color")}  = ${n.toShaderColor(this.colors[this.colors.length-1],o,r)};\n            `;for(s=0;s<this.values.length;s++){let e=this.values[s],n=t.toShaderColor(this.colors[s],o,r);a=0===s?`\n                        ${a}\n                        if (${r()}(${this.attribute}) <= ${r()}(${e})) {\n                            color = ${n};\n                        }\n                    `:`\n                        ${a}\n                        else if (${r()}(${this.attribute}) <= ${r()}(${e})) {\n                            color = ${n};\n                        }\n                    `}return a=`\n                ${a}\n                return color;\n            `}}return n.jsonType="range",n}),define("DS/3DXMTiles/LDHHandlerOOCAdapter",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/OOCPath"],function(e,t){"use strict";var n=function(t){e.call(this,t.type),this.oocHandler=t};return(n.prototype=Object.create(e.prototype)).handleReferences=function(e,n,i,r){var o,s,a=[];for(o=0;o<e.length;o++){var d=e[o];(s=t.buildFromReference(d,!0,r,this.oocHandler.manager))&&a.push(s)}var l={viewpointTag:n.viewpointTag,doneCB:this.adapterDoneCB.bind(this,n),screenRadius:n.screenRadius};this.oocHandler.handlePathes(a,l,i)},n.prototype.isReady=function(){return this.oocHandler.isReady()},n.prototype.getBatchSize=function(){return this.oocHandler.getBatchSize()},n.prototype.adapterDoneCB=function(e,t,n){var i,r,o=[],s=[];for(i=0;i<t.length;i++)(r="string"==typeof t[i]?this.oocHandler.manager._getLDHReference(t[i],!0):t[i]._ldhReference)&&o.push(r);for(i=0;i<n.length;i++)r="string"==typeof n[i]?this.oocHandler.manager._getLDHReference(n[i]):n[i]._ldhReference,s.push(r);e.doneCB(o,s)},n}),define("DS/3DXMTiles/OOCHandler",["DS/3DXMTiles/LDHHandlerOOCAdapter"],function(e){"use strict";var t=0,n=function(n,i){this.type=n,this.id=t++,this.ldhHandler=i||new e(this)};return n.prototype.handlePathes=function(e,t){},n.prototype.getBatchSize=function(){return 1},n.Model3DHandler=0,n.InstRefHander=1,n.TileSetHandler=2,n}),define("DS/3DXMTiles/OOCDefaultRefHandler",["DS/3DXMTiles/OOCHandler"],function(e){"use strict";var t=function(t,n){e.call(this,e.InstRefHander)};return(t.prototype=Object.create(e.prototype)).handlePathes=function(e,t){},t.prototype.getBatchSize=function(){return 1},t.prototype.isReady=function(){return!0},t}),define("DS/3DXMTiles/OOCModel3DZipHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHZipHandler"],function(e,t){var n=function(n){var i=new t(n=n||{});e.call(this,e.Model3DHandler,i)};return n.prototype=Object.create(e.prototype),n}),define("DS/3DXMTiles/OOCTileSetHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHTileSetHandler"],function(e,t){var n=function(n){var i=new t(n=n||{});e.call(this,e.TileSetHandler,i)};return n.prototype=Object.create(e.prototype),n}),define("DS/3DXMTiles/DSTilesStylingRule",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingFilter","DS/3DXMTiles/DSTilesStylingRender","DS/3DXMTiles/DSTilesStylingRenderRange","DS/3DXMTiles/DSTilesStylingRenderRamp"],function(e,t,n,i,r){"use strict";return class{constructor(e){this.name=e,this.showFilter=null,this.renderFilter=null,this.render=null,this.priority=0}setFromJSON(o){let s=[];if(o.showFilter){let n=new t,i=n.setFromJSON(o.showFilter);i.error?s.push(e.error("Error parsing showFilter","rule",[i])):this.showFilter=n}if(o.renderFilter){let n=new t,i=n.setFromJSON(o.renderFilter);i.error?s.push(e.error("Error parsing renderFilter","rule",[i])):this.renderFilter=n}if(o.render){let t=new e,a=n.createFromJSON(o.render,t,[i,r]);t.error?s.push(e.error("Error parsing render","rule",[t])):this.render=a}if(void 0!==o.priority){let t=parseFloat(o.priority);null!==o.priority&&isFinite(t)?this.priority=t:s.push(e.error("Invalid priority","rule"))}return s.length?e.error("Error parsing styling rule","rule",s):this.showFilter||this.render?e.ok:e.error("Invalid rule: no showFilter, no render","rule")}addNeededAttributesToSet(e){this.showFilter&&this.showFilter.addNeededAttributesToSet(e),this.renderFilter&&this.renderFilter.addNeededAttributesToSet(e),this.render&&this.render.addNeededAttributesToSet(e)}}}),define("DS/3DXMTiles/OOCTileSet",["DS/3DXMTiles/DSTilesForceLoadTransaction","DS/Visualization/PathElement"],function(e,t){"use strict";return class{constructor(e,t){this._tileSet=e,this.oocManager=t,this.override=null}forceLoadTraverse({onExploreCB:t,onLoadedCB:n,requestBoundingBox:i}){var r=new e({tileSet:this._tileSet,onExploreCB:t,onLoadedCB:n,requestBoundingBox:i});this._tileSet.addForceLoadTransaction(r),this.oocManager._ldhNodeManager.requestUpdate(!1,!1)}unlockNodeUnload(e){this._getDSTilesNode(e).unlockUnload()}getWorldBoundingSphere(){return this._getRoot().getOccurrencesWorldBoundingSphere()}updateContentMetaData(e){this._tileSet.updateContentMetaData(e)}setOpacity(e){var n=this._tileSet.getRootNode().getSgNode();if(!this.override){var i=n.createOverrideSetManager(),r=i.createSceneGraphOverrideSet();this.override=r.createOverride(new t([n])),i.pushSceneGraphOverrideSet(r)}this.override.setOpacity(e)}setVisibility(e){this._tileSet.setVisibility(e)}setVisibilityFree(e){this._tileSet.setVisibilityFree(e)}getUnitValue(){return this._tileSet.getUnitValue()}refreshWorldMatrix(){this._getDSTilesNode(this._tileSet.rootURI).setMatrixUpdate(!0),this.oocManager._updateBoundingSphere(),this.oocManager._ldhNodeManager.requestUpdate(!0,!0)}getUserData(){return this._tileSet.userData}getContentTypes(){return this._tileSet.contentTypes}hasType(e){return!!(this._tileSet.contentTypes&&this._tileSet.contentTypes.indexOf(e)>=0)}getCRS(){return this._tileSet.crs}getUnitScale(){return this._tileSet.unitScale}setPauseLoading(e,t){this._tileSet.setPauseLoading(e,t,this.oocManager._ldhNodeManager)}registerOnStartLoadingCB(e){return this._tileSet.registerOnStartLoadingCB(e)}unregisterOnStartLoadingCB(e){this._tileSet.unregisterOnStartLoadingCB(e)}registerOnEndLoadingCB(e){return this._tileSet.registerOnEndLoadingCB(e)}unregisterOnEndLoadingCB(e){this._tileSet.unregisterOnEndLoadingCB(e)}getTileUserData(e){var t=this._getDSTilesNode(e);if(!t)return null;var n=null;return t&&(n=t.userData),n}getTileWorldMatrices(e){let t=this._getDSTilesNode(e);if(!t)return null;t.updateWorldMatrix();let n,i=[];for(n=0;n<t.worldPosition.matrixArray.length;n++){let e=t.worldPosition.matrixArray[n];i.push(e?e.clone():null)}return i}getTileContentUrl(e,t){let n=this._getDSTilesNode(e);if(!n)return null;let i=n.getSourceWithContents(t),r=i&&(1===i.contents.length?i.contents[0]:null);if(r){let e=r.getUri(t),i=n&&n.tileSet.getContentSource(t);return i&&i.buildContentURL(e)}return null}getTileContentSpec(e){let t=this._getDSTilesNode(e);return t?t.getContentSpec():null}getTileContentMetaData(e){let t=this._getDSTilesNode(e);return t?t.getContentMetaData():null}getTileBoundingSphere(e){let t=this._getDSTilesNode(e),n=t&&t.getBoundingSphere();return n&&n.clone()}getTileBoundingBox(e){let t=this._getDSTilesNode(e),n=t&&t.getBoundingBox();return n&&n.clone()}setStyling({json:e}){let t=this._tileSet.setStyling(e,this.oocManager._ldhNodeManager.viewer);return this.oocManager._ldhNodeManager.requestUpdate(!0),t}getAvailableAttributes(){let e=[],t=this._tileSet;return t.availableAttributesMap&&t.availableAttributesMap.forEach((t,n)=>{e.push({name:n,type:t.type||null,userData:t.userData||null})}),e}setAvailableAttribute({name:e,type:t,userData:n}){this._tileSet.availableAttributesMap.set(e,{name:e,type:t,userData:n})}getRootURI(){return this._tileSet.rootURI}_setMaxPixelError(e){this._tileSet.setMaxPixelError(e),this.oocManager._ldhNodeManager.requestUpdate(!0,!0)}_getDSTilesNode(e){return this._tileSet.getTile(e)}_getRoot(){return this._getDSTilesNode(this._tileSet.rootURI)}}}),define("DS/3DXMTiles/DSTilesStyling",["DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesStylingRule"],function(e,t){"use strict";return class{constructor(){this.ruleSet=new Map,this.applyRules=[],this.neededAttributes=[]}setFromJSON(n){let i=[];if(n.rules){let r;for(r in n.rules){let o=new t(r),s=o.setFromJSON(n.rules[r]);s.isOk()?this.ruleSet.set(r,o):i.push(e.error("Error parsing rule '"+r+"'","styling",[s]))}}if(Array.isArray(n.applyRules)){let e;for(e=0;e<n.applyRules.length;e++)this.applyRules.push(n.applyRules[e])}return this.neededAttributes=this.computeNeededAttributes(),i.length?e.error("Error parsing rules","styling",i):e.ok}computeNeededAttributes(){let e,t=this.getRules(),n=new Set;for(e=0;e<t.length;e++)t[e].addNeededAttributesToSet(n);let i=[];return n.forEach(e=>{i.push(e)}),i}getRules(){let e,t=[];for(e=0;e<this.applyRules.length;e++){let n=this.ruleSet.get(this.applyRules[e]);n&&t.push(n)}return t}getNeededAttributes(){return this.neededAttributes}}}),define("DS/3DXMTiles/BSScreenSizeLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";new t.Vector3,new t.Matrix4;var n=e.extend({init:function(){this._parent(),this.type="BSScreenSize",this._debug_screenSize=-1},computeLOD:function(e,t){e.computeScreenRadius(t);var n=this._debug_screenSize>=0?this._debug_screenSize:t.pixelCulling;return e._screenRadius>=n?1:0},getLOD:function(e,t){return e>=(this._debug_screenSize>=0?this._debug_screenSize:t.pixelCulling)?1:0}});return n.createFromJSON=function(e){var t=e.screenSize;return new n(parseFloat(t))},n}),define("DS/3DXMTiles/LDHReference",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHOccurrence","DS/Visualization/ThreeJS_R57","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHHandler","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/Visualization/SceneGraphFactory","DS/3DXMTiles/AsyncCaller","DS/3DXMTiles/LDHSwitchRepresentationData","DS/Visualization/PLMMaterialConnectionFactory","DS/VisuTools/OOCReplay"],function(e,t,n,r,o,s,a,d,l,h,c,u,p,f,g,m,S,y,v){"use strict";var M=1,L=1,T=2,D=4,C=8,R=16,b=24,x=32,w=64,N=128,_=256,B=512,I=1024,O=2048,P="requested",U="none",A="slave",k=new e,E=function(e,t,n){this.reference=e,this.node=null,this.matrix=t,this.instanceId=n,this.userData=null},F=-1,H=localStorage.getItem("OOCBoxDebug"),V=new Map,z=function(e){-1===F&&(F=window.OOCForceBoundingSphere?1:0),this.id=M++,this._occurrences=[],this._rep=null,this._boundingSphere=e.boundingSphere,this._boundingBox=e.boundingBox,this.updateBoundingSphere(),this.handler=e.handler,this._screenRadiusCache=[],this._screenRadius=0,this._rep=null,this.children=[],this._status=d.waiting,this._optional=null,this.parents=[],this.referenceId=e.referenceId,this.userData=null,this.unloadLockCounter=0,this.inListStatus=0,this.occlusionId=-1,this.isRoot=!1,H&&(this.byteSize=0),this.memoryData=new q,this.sgFlag=e.leaf?A:U,y.hasLegacyUV(e.referenceId)&&this.setLegacyUV(),this.instancesToUpdate=null,this.updateMemorySizeNEW(e.manager)};z.prototype.isLoading=function(){return this._status===d.loading},z.prototype.isToUnload=function(){return this._status===d.toUnload},z.prototype.isToLoad=function(){return this._status===d.toLoad},z.prototype.shouldBeExpanded=function(){return this._status!==d.dead&&(!(!this._rep||this._rep.active)||this._status!==d.error&&(this._status!==d.error&&!this.isRepLoaded()))},z.prototype.hasGoodRep=function(){return this._rep&&this._rep.active},z.prototype.setIsRoot=function(e,t){e!==this.isRoot&&(this.isRoot=e,e?this._rep.node&&t.targetNode.addChild(this._rep.node):this._rep.node&&t.targetNode.removeChild(this._rep.node))},z.prototype.getNbOccurrences=function(){return this.getOccurrences().length},z.prototype.hasNode3D=function(){return!(!this._rep||!this._rep.node)},z.prototype.getOccurrences=function(){return this.hasNode3D()?this._rep.node?this._rep.node._occurrences:null:this._occurrences},z.prototype.getLDHOccurrences=function(){return this._occurrences},z.prototype.isComplete=function(){return this.isLoaded()},z.prototype.isLoaded=function(){return this._status===d.loaded},z.prototype.forceLoad=function(e,t,n){var i=this.isForced();this._optional||(this._optional=new Q),e?(this._optional._force||(this._optional._force=new j),!this.isLoading()&&this.isRepLoaded()&&(this.isLoaded()||this.isToUnload())&&this.hasGoodRep()?(m.call(t),this._optional._force=new j):this._optional._force.onForce(t)):this._optional._force=null;var r=this.isForced();i!==r&&(r?this.lockUnload(void 0,void 0,!0):this.unlockUnload(void 0,void 0,void 0,!0),n.registerTilesNode(this))},z.prototype.getMeshInRAM=function(){var e=this.getActiveRepresentation();return!!e&&!e.noMeshInRAM},z.prototype.setOverrideCB=function(e,t,n){t&&!this._optional&&(this._optional=new Q),this._optional&&(this._optional.setOverride(e,t),this.updateOverride(n))},z.prototype.hasOverrideCB=function(e){return!!this._optional&&this._optional.hasOverride(e)},z.prototype.removeParentFromParentsArray=function(e){var t,n=0;for(t=0;t<this.parents.length;t++)this.parents[t]!==e&&(this.parents[n]=this.parents[t],n++);this.parents.length=n},z.prototype.removeParent=function(e,t){var n;t||this.removeParentFromParentsArray(e);var i,r=0;for(i=0;i<this._occurrences.length;i++)(n=this._occurrences[i]).parent&&n.parent.reference!==e?(this._occurrences[r]=n,r++):n.parent=null;this._occurrences.length=r,this.unloadLockCounter>0&&this.unlockUnload(this.unloadLockCounter,e)},z.prototype.removeChild=function(e,t){var n,i,r,o=0;for(n=0;n<this.children.length;n++)(r=this.children[n]).reference===e?(i=r.instanceId,t._unregisterInstance(i)):(this.children[o]=r,o++);this.children.length=o,this.updateMemorySizeNEW(t._ldhNodeManager)},z.prototype.removeFromParents=function(e){var t;for(t=0;t<this.parents.length;t++)this.parents[t].removeChild(this,e),this.removeParent(this.parents[t],!0);this.parents=[]},z.prototype.unregister=function(e){this.isAlive()&&e._unregisterReference(this.referenceId)},z.prototype.addToOcclusionChecker=function(e){if(!e.hasReference(this)){var t,n=[];if(this.hasNode3D()){var i,r=this._rep.node._occurrences;for(t=0;t<r.length;t++)i=r[t],n.push(i.matrix)}else{var o,s=this._occurrences;for(t=0;t<s.length;t++)o=s[t],n.push(o.matrix)}var a=this.getBoundingBox();this.occlusionId=e.addBox(a,n),e.addReference(this)}},z.prototype.setStatus=function(e,t){if(this._status!==d.dead){var n=this._status!==e;this._status=e,n&&t.registerTilesNode(this)}},z.prototype.setLoading=function(e){this.setStatus(d.loading,e)},z.prototype.hasUnloadFrozenParent=function(){return 0!==this.parents.length&&this.parents[0].isUnloadFrozen()},z.prototype.isUnloadFrozen=function(){return this._status===d.freezeUnload},z.prototype.isLeaf=function(){return this.handler.type===l.Model3DHandler||this.handler.type===l.TileSetHandler},z.prototype.is3DShape=function(){return this.handler.type===l.Model3DHandler},z.prototype.freezeUnload=function(){this.traverse(function(e){return!(!e.isLeaf()&&!e.isUnloadFrozen())||(e._status=d.freezeUnload,!1)})},z.prototype.buildFlatList=function(){var e=[];this.traverse(function(t){return!(t.id>0)||(t.id*=-1,e.push(t),!1)});var t=0;for(t=0;t<e.length;t++)e[t].id*=-1;return e},z.prototype.addReferenceChild=function(e,t,n,i,o){var s,a,d=new E(e,t,n),l=this._occurrences.length;for(s=0;s<this._occurrences.length;s++)if(a=this._occurrences[s],new r({reference:e,matrix:t,manager:o,node:null,parent:a,instanceData:d},i),this._occurrences.length>l)return!1;return this.children.push(d),e.unloadLockCounter>0&&e.lockUnload(e.unloadLockCounter),-1===e.parents.indexOf(this)&&e.parents.push(this),null!==e._rep.node&&this.requestBuildSceneGraphHierarchy(!0),this.isLegacyUV()&&e.setLegacyUV(),this.updateMemorySizeNEW(o),!0},z.prototype.getOccurrencesFromInstanceId=function(e){var t,n=[];for(i=0;i<this._occurrences.length;i++)(t=this._occurrences[i]).instanceId===e&&n.push(t);return n},z.prototype.detachReference=function(e,t,n,i,r){var o,s,a,d,l,h=[],c=[],u=[];if(a=0,null===e){for(o=0;o<this._occurrences.length;o++)u=u.concat(this._occurrences[o].getChildren());if(0===this._occurrences.length&&r){var p=this;this.traverse(function(e){if(e!==p){if(e._occurrences.length>0)return!0;r.add(e)}})}if(h=this.children,n)for(o=0;o<h.length;o++)c.push(h[o].instanceId),h[o].reference.removeParentFromParentsArray(this);this.children=[]}else{for(d=!1,o=0;o<this.children.length;o++)(s=this.children[o]).reference!==e||null!==t&&s.instanceId!==t?(this.children[a]=this.children[o],s.reference===e&&(d=!0),a++):(h.push(s),c.push(s.instanceId));for(this.children.length=a,o=0;o<e._occurrences.length;o++)(l=e._occurrences[o]).parent.reference!==this||null!==t&&l.instanceData.instanceId!==t||-1!==u.indexOf(l)||u.push(l)}var f=new Set;for(o=0;o<u.length;o++)(l=u[o]).detach(f);f.forEach(function(e){e._removeNullsFromOccurrenceList(),r&&0===e._occurrences.length&&r.add(e)});var g=i._ldhNodeManager,m=this.getNode();for(o=0;o<h.length;o++){s=h[o],m&&m.removeChild(s.node);var S=s.reference.getNode();s.node&&(s.node.removeChild(S),s.node=null)}if(0===this.children.length&&this.removeFromSceneGraph(!1,g),!d&&e&&n){for(a=0,o=0;o<e.parents.length;o++)e.parents[o]!==this&&(e.parents[a]=e.parents[o],a++);e.parents.length=a}if(null!==t)i._unregisterInstance(t);else for(o=0;o<c.length;o++)i._unregisterInstance(c[o])},z.prototype.updateInstance=function(e,t,n){var i=this.getChild(e);t.instanceId&&(i.instanceId=t.instanceId,i.node&&i.node.setModelIdentification(t.instanceId)),t.matrix&&(i.node&&i.node.setMatrix(t.matrix),i.matrix?i.matrix.copy(t.matrix):i.matrix=t.matrix.clone(),this.updateOccurrencesPosition(n,i.instanceId))},z.prototype.addOnLoadedCB=function(e){this._optional||(this._optional=new Q),this._optional.addOnLoadedCB(e)},z.prototype._onLoaded=function(){this._optional&&this._optional._force&&this._optional._force.onLoaded(),this._optional&&this._optional.onLoaded()},z.prototype._onOccluded=function(){this._optional&&this._optional.onLoaded()},z.prototype.computeLODValue=function(e){var t=k.computeLOD(this,e);return v.recording&&(t=1),null===this._boundingSphere&&(t=1),t},z.prototype.getLODValue=function(e){return k.getLOD(this._screenRadius,e)};var X=[];function q(){this.memory=0,this.memoryGPU=0,this.memoryMeshInRAM=0}z.prototype.computeScreenRadius=function(e){var n=e.cst,i=e.viewpoint,r=this.hasNode3D();if(this._topLoadPriority)return this._screenRadius=1/0,this._screenRadius;if(this._boundingSphere){var o,s,a,d,l,h=-1/0,c=0,u=this._screenRadiusCache,p=!1;if(r)for(o=this._rep.node._occurrences,l=0;l<o.length&&!p;l++)o[l]._getNeedOverridesUpdate()&&(p=!0);if(!r||p)for(s=this._occurrences,X.length=s.length,l=0;l<s.length;l++)X[l]=s[l].matrix;else{for(o=this._rep.node._occurrences,X.length=o.length,l=0;l<o.length;l++)X[l]=o[l].matrix;if(u){var f=!1;for(u.length!==o.length&&(f=!0),l=0;!f&&l<o.length;l++)(d=u[l]).positionHasChanged(o[l].matrix)&&(f=!0)}f&&(u=[],this._screenRadiusCache=u)}for(l=0;l<X.length;l++){var g=X[l];c>=u.length?(d=t.computeScreenRadiusCache(g,null,this._boundingSphere,void 0,r),u.push(d)):d=u[c],c++,h<(a=t.computeScreenRadius(d,i.camera,i._frustum,n))&&(h=a)}return this._screenRadius=h,h}return this._screenRadius=1,1},z.prototype.getAllMatrices=function(){var e,t,n,i=[];if(this.hasNode3D())for(t=this._rep.node._occurrences,i.length=t.length,e=0;e<t.length;e++)i[e]=t[e].matrix;else for(n=this._occurrences,i.length=n.length,e=0;e<n.length;e++)i[e]=n[e].matrix;return i},z.prototype.getScreenRadiusCache=function(e){var n=null,i=this.hasNode3D(),r=this.getBoundingSphere();if(r){var o,s,a,d;if(n=this._screenRadiusCache,i){for(a=this._rep.node._occurrences,e.length=a.length,s=0;s<a.length;s++)e[s]=a[s].matrix;if(n){var l=!1;for(n.length!==a.length&&(l=!0),s=0;!l&&s<a.length;s++)(o=n[s]).positionHasChanged(a[s].matrix)&&(l=!0)}l&&(n=[],this._screenRadiusCache=n)}else for(d=this._occurrences,e.length=d.length,s=0;s<d.length;s++)e[s]=d[s].matrix;for(s=n.length;s<e.length;s++){var h=e[s];0>=n.length&&(o=t.computeScreenRadiusCache(h,null,r,void 0,i),n.push(o))}}return n},z.prototype.isCollidingWithBox=function(e,t,n,i){var r,o,s=this.getScreenRadiusCache(i),a=!1,d=null;if(s)for(r=0;r<s.length;r++)if(o=s[r],n.center.x=o.center.x,n.center.y=o.center.y,n.center.z=o.center.z,n.radius=o.radius,t.intersectsSphere(n)&&(a||(a=!0,d=this.getBoundingBox()),d&&e.isIntersectingWith(d,i[r])))return!0;return!1},z.prototype.updateNodeLOD=function(e){var t;return this.isForced()?(t=1,this._screenRadius=1/0):t=this.computeLODValue(e),t},q.prototype.set=function(e){if(e.isAlive()){var t=e.getMeshSize();if(e.handler.type===l.Model3DHandler)this.memory=0;else{var n=e._rep&&e._rep.node,i=0;n&&(i=824+280*(n._occurrences.length-1)),this.memory=232+336*e._occurrences.length+336*e.children.length+i}this.memoryMeshInRAM=e._rep&&!e._rep.noMeshInRAM?t:0,this.memoryGPU=t}},q.prototype.equals=function(e){return this.memory===e.memory&&this.memoryGPU===e.memoryGPU&&this.memoryMeshInRAM===e.memoryMeshInRAM},q.bank=new Map,q.getFromBank=function(e){var t=null;if(0!==e.memory)if(t=q.bank.get(e.memory)){if(e.equals(t))return t}else q.bank.set(e.memory,e);return e},z.prototype.computeMemoryData=function(e){var t=null;return(t=new q).set(this),t=q.getFromBank(t)},z.prototype.getMeshSize=function(){return this._rep?this._rep.getMeshSize():0},z.prototype.updateMemorySizeNEW=function(e){var t=this.memoryData,n=e.unloadManager,i=this.computeMemoryData(),r=!1;if(0===this.handler.type){r=this.getMeshInRAM();var o=this.getLDHNodeManagerQueue(e);this.getMeshSize()>0&&o.memorizeReferenceSize(this.referenceId,this.getMeshSize())}n.onReferenceMemoryDataChange(t,i,r),this.isAlive()||V.delete(this),this.memoryData=i},z.prototype.requestBuildSceneGraphHierarchy=function(e){if(this.sgFlag===U){var t,n=e||!1;for(t=0;t<this.children.length&&!n;t++)this.children[t].reference.sgFlag!==U&&(n=!0);if(n)for(this.setSGFlag(P),t=0;t<this.parents.length;t++)this.parents[t].requestBuildSceneGraphHierarchy(!0)}},z.prototype.setSGFlag=function(e){this.sgFlag=e},z.prototype.tryBuildSceneGraphHierarchy=function(e,t){var n,i,r;if(this.sgFlag===P){this.clearScreenRadiusCache();var o=!!this._rep.node;if(!this._rep.node){if(this._rep.node=new s,this.userData&&this._rep.node.setUserData(this.userData),this._rep.node.setModelIdentification(this.referenceId),this._rep.node.setNodeUsage(this.handler.getNodeUsage()),this._boundingSphere&&F&&this._rep.node.forceBoundingElements(!0,{sphere:this._boundingSphere},null),this.isRoot&&(t.targetNode.addChild(this._rep.node),1===this._occurrences.length)){var a=this._occurrences[0];a.instanceData.matrix&&this._rep.node.setMatrix(a.instanceData.matrix)}this._optional&&this._optional.hasOverride()&&e.push(this),t.oocManager._onNodeCreate(this._rep.node)}for(n=0;n<this.children.length;n++)(r=(i=this.children[n]).reference).tryBuildSceneGraphHierarchy(e,t),!i.node&&r._rep.node&&(i.node=new s,i.userData&&i.node.setUserData(i.userData),i.node.setModelIdentification(i.instanceId),i.node.setNodeUsage(s.INSTANCE_NODE),t.oocManager._onNodeCreate(i.node),i.node.setMatrix(i.matrix),i.node.addChild(r._rep.node),this._rep.node.addChild(i.node));this.setSGFlag(U),this._rep.node&&!o&&this._optional&&this._optional.onAddedToSceneGraphCB&&this._optional.onAddedToSceneGraphCB.call(void 0,this.referenceId),this.updateMemorySizeNEW(t)}},z.prototype.recursiveUpdateMemorySize=function(e){if(0===this.handler.type)this.updateMemorySizeNEW(e);else{var t,n=this.buildFlatList();for(t=0;t<n.length;t++)n[t].updateMemorySizeNEW(e)}},z.prototype.updateOverride=function(e){var t=this._optional;t&&t.overrideData&&(t.overrideData.updateOverride(e,this._rep.node,this.referenceId),t.overrideData.isEmpty()&&(t.overrideData=null))},z.prototype.removeRepresentationChildren=function(e){if(-1===z.useRepNodeName&&(z.useRepNodeName=window.OOCEnableRepNodeName?1:0),e){var t,n,i=e.children;for(t=i.length-1;t>=0;t--)n=i[t],1===z.useRepNodeName?n.name===z.RepNodeName&&e.removeChild(n):z.RepNodeSet.has(n.id)&&(e.removeChild(n),z.RepNodeSet.delete(n.id))}},z.prototype.removeFromSceneGraph=function(e,t){if(this.isSlave())t.unloadLeafReferenceCB(this.referenceId);else{if(this.clearScreenRadiusCache(),0===this.parents.length&&!this.isLeaf())return;if(null!==this._rep.node)if(this.isUnloadLocked())e&&this.removeRepresentationChildren(this._rep.node);else{var n,i,r=t.oocManager;if(this._rep.node.children.length>0)for(this._rep.node.removeChildren(),n=0;n<this.children.length;n++)(i=this.children[n]).node&&(i.node.removeChildren(),i.node=null);if(this.parents.length>0){var o,s,a=this._rep.node.parents.concat([]);for(n=0;n<a.length;n++)s=(o=a[n]).parents[0],o.removeChild(this._rep.node),s.removeChild(o),r._onNodeRemove(o);for(n=0;n<this.parents.length;n++)this.parents[n].removeChildNode(this,t),this.parents[n]._rep.node&&0===this.parents[n]._rep.node.children.length&&this.parents[n].removeFromSceneGraph(!1,t)}r._onNodeRemove(this._rep.node),this._rep.node=null,this._optional&&this._optional.onRemovedFromSceneGraphCB&&this._optional.onRemovedFromSceneGraphCB.call(void 0,this.referenceId)}}this.setRepLoaded(!1),this._rep.updateMeshSize(this),this.updateMemorySizeNEW(t),this.updateOverride(t)},z.prototype.removeChildNode=function(e,t){var n,i;for(n=0;n<this.children.length;n++)(i=this.children[n]).reference===e&&(i.node=null);this.updateMemorySizeNEW(t)},z.prototype.getChildInstanceNode=function(e){var t,n;for(t=0;t<this.children.length;t++)if((n=this.children[t]).instanceId===e)return n.node;return null},z.prototype.traverse=function(e){var t;if(!e(this))for(t=0;t<this.children.length;t++)this.children[t].reference.traverse(e)},z.prototype.traverseParents=function(e,t){if(!t||!t.has(this)){var n=new Set;n.add(this),this.traverseParents_internal(e,t,n)}},z.prototype.traverseParents_internal=function(e,t,n){var i,r;if(!e(this))for(i=0;i<this.parents.length;i++)r=this.parents[i],n.has(r)||t&&t.has(r)||(n.add(r),r.traverseParents_internal(e,t,n))},z.prototype.createJSON=function(){var e={references:[]};this.traverse(function(e){e.visited=!1});var t,n,i,r,o=0;for(this.traverse(function(t){if(!t.visited){t.visited=!0,t.jsonIndex=o++;var n=t.createJSON_internal();e.references.push(n)}}),t=0;t<e.references.length;t++)for(i=e.references[t],n=0;n<i.c.length;n++)(r=i.c[n]).r=r.r.jsonIndex;return e},z.prototype.createJSON_internal=function(){var e,t,n,i={url:this.url,bs:this._boundingSphere?this._boundingSphere.createJSON():null,i:!!this._rep.node,c:[]};for(e=0;e<this.children.length;e++)t=this.children[e],(n={}).m=t.matrix.createJSON(),n.r=t.reference,n.i=!!t.node,i.c.push(n);return i},z.prototype._removeOccurrenceFromList=function(e){var t=this._occurrences.indexOf(e);t<0?console.log("Internal inconsistency"):this._occurrences[t]=null},z.prototype._removeNullsFromOccurrenceList=function(){var e,t=0;for(e=0;e<this._occurrences.length;e++){var n=this._occurrences[e];n&&(this._occurrences[t]=n,t++)}this._occurrences.length=t},z.prototype._isDetachPossible=function(){return 0===this._occurrences.length},z.prototype.isWaiting=function(){return this._status===d.waiting},z.prototype.isUnknown=function(){return!this._boundingSphere&&!this.isLoaded()},z.prototype.isForced=function(){return!(!this._optional||!this._optional._force)},z.prototype.setOnRemovedFromSceneGraphCB=function(e){this._optional||(this._optional=new Q),this._optional.onRemovedFromSceneGraphCB=e,!this._rep.node&&e&&e.call(void 0,this.referenceId)},z.prototype.setOnAddedToSceneGraphCB=function(e){this._optional||(this._optional=new Q),this._optional.onAddedToSceneGraphCB=e,this._rep.node&&e&&e.call(void 0,this.referenceId)},z.prototype.isInList=function(){return!!(this.inListStatus&L)},z.prototype.setInList=function(e){this.inListStatus=e?this.inListStatus|L:this.inListStatus&65535-L},z.prototype.isInToBeLoaded=function(){return!!(this.inListStatus&T)},z.prototype.setInToBeLoaded=function(e){this.inListStatus=e?this.inListStatus|T:this.inListStatus&65535-T},z.prototype.isInLoaded=function(){return!!(this.inListStatus&D)},z.prototype.setInLoaded=function(e){this.inListStatus=e?this.inListStatus|D:this.inListStatus&65535-D},z.prototype.isInForced=function(){return!!(this.inListStatus&C)},z.prototype.setInForced=function(e){this.inListStatus=e?this.inListStatus|C:this.inListStatus&65535-C},z.prototype.isInUnknown=function(){return!!(this.inListStatus&R)},z.prototype.isInHighPriority=function(){return!!(this.inListStatus&b)},z.prototype.setInUnknown=function(e){this.inListStatus=e?this.inListStatus|R:this.inListStatus&65535-R},z.prototype.setOcclusionVisible=function(e){this.inListStatus=e?this.inListStatus|x:this.inListStatus&65535-x},z.prototype.isOcclusionVisible=function(){return!!(this.inListStatus&x)},z.prototype.setLoadingBoxVisible=function(e){this.inListStatus=e?this.inListStatus|w:this.inListStatus&65535-w},z.prototype.isLoadingBoxVisible=function(){return!!(this.inListStatus&w)},z.prototype.setRepLoaded=function(e){this.inListStatus=e?this.inListStatus|N:this.inListStatus&65535-N},z.prototype.isRepLoaded=function(){return!!(this.inListStatus&N)},z.prototype.setLegacyUV=function(){var e;if(!this.isLegacyUV())for(this.inListStatus=this.inListStatus|_,e=0;e<this.children.length;e++)this.children[e].reference.setLegacyUV()},z.prototype.isLegacyUV=function(){return!!(this.inListStatus&_)},z.prototype.getNeedUpdateOccurrences=function(){return!!(this.inListStatus&B)},z.prototype.setNeedUpdateOccurrences_internal=function(e){this.inListStatus=e?this.inListStatus|B:this.inListStatus&65535-B},z.prototype.getNeedUpdateOccurrencesUnder=function(){return!!(this.inListStatus&I)},z.prototype.setNeedUpdateOccurrencesUnder=function(e){this.inListStatus=e?this.inListStatus|I:this.inListStatus&65535-I},z.prototype.getNeedFullUpdateOccurrences=function(){return!!(this.inListStatus&O)},z.prototype.setNeedFullUpdateOccurrences=function(e){this.inListStatus=e?this.inListStatus|O:this.inListStatus&65535-O},z.prototype.setNeedUpdateOccurrences=function(e){e&&this.traverseParents(e=>!!e.getNeedUpdateOccurrencesUnder()||(e!==this&&e.setNeedUpdateOccurrencesUnder(!0),!1),null),this.setNeedUpdateOccurrences_internal(e)},z.prototype.requestUpdateOccurrencesPosition=function(e,t){t?(this.instancesToUpdate||(this.instancesToUpdate=[]),this.instancesToUpdate.push(t)):this.setNeedFullUpdateOccurrences(!0),this.setNeedUpdateOccurrences(!0),e.requestUpdate(!1)};function G(e,t){if(!e.isEmpty()){var n,i,r=e.get();for(n=0;n<r.length;n++){var o=r[n].pathElement,s=o&&o.externalPath;if(o)for(i=s.length-1;i>=0;i--)if(s[i]===t)return!0}}return!1}z.prototype.updateBoundingElementImpostor=function(){if(z.slaveBoxFix&&(this._boundingBox||this._boundingSphere)){var e,t,n=!1;for(e=0;!n&&e<this._rep.node.children.length;e++)"OOC##beImpostor"===(t=this._rep.node.children[e]).name&&(this._rep.node.removeChild(t),n=!0);var i=new s("OOC##beImpostor");this._rep.node.forceBoundingElements(!0,{sphere:this.getBoundingSphere(),box:this.getBoundingBox()}),this._rep.node.addChild(i)}},z.setScreenSize=function(e){k._debug_screenSize=e},z.getScreenSize=function(){return k._debug_screenSize},z.prototype.isAlive=function(){return this._status!==d.dead},z.prototype.isError=function(){return this._status===d.error},z.prototype.lockUnload=function(e,t,n){e=e||1,this.unloadLockCounter+=e},z.prototype.unlockUnload=function(e,t,n,i){e=e||1,this.unloadLockCounter-=e},z.prototype.isUnloadLocked=function(){return this.isForced()||this.unloadLockCounter>0},z.prototype.hasGrandChildren=function(){var e=0;for(e=0;e<this.children.length;e++)if(this.children[e].reference.children.length>0)return!0;return!1},z.prototype.getChild=function(e){var t;for(t=0;t<this.children.length;t++)if(this.children[t].instanceId===e)return this.children[t];return null},z.prototype.isSlave=function(){return this.sgFlag===A},z.prototype.isUnloadable=function(e){if(e){var t=this._rep.node;if(t&&(G(h,t)||G(c,t)||G(u,t)))return!1}return this._status!==d.freezeUnload},z.prototype.isLoading=function(){return this._status===d.loading},z.prototype.clearViewpointTags=function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].viewpointTag=-1},z.prototype.getLDHNodeManagerQueue=function(e){return e.queues[this.handler.type]},z.prototype.updateBoundingSphereFromNode=function(){if(this._rep.node){var e=this._rep.node.getBoundingSphere();e&&(this._boundingSphere=e.clone())}},z.prototype.hasDifferentViewpointTag=function(e){if(this._occurrences.length>0){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].viewpointTag!==e)return!0;return!1}return!0},z.prototype.buildDebugJSON=function(e,t){var n;var i,r={screenRadius:this._screenRadius,status:function(e){return t&&e._status===d.loaded?"complete":e._status}(this),unloadStatus:this._unloadStatus,handlerType:this.handler.type,parents:[]};for(e||(r.referenceId=this.referenceId),i=0;i<this.parents.length;i++)r.parents.push(this.parents[i].referenceId);if(this.children.length>0&&(r.nbChildren=this.children.length,this.children.length>0)){var o,s=[];for(n=0;n<this.children.length;n++)o=this.children[n],s.push({ref:o.reference.referenceId,inst:o.instanceId});r.children=s}return this.unloadLockCounter>0&&(r.unloadLockCounter=this.unloadLockCounter),this._rep.node&&(r.inSceneGraph=!0),r},z.prototype.setLoadModelOptions=function(e){this._optional||(this._optional=new Q),this._optional.setLoadModelOptions(e)},z.prototype.getLoadModelOptions=function(){return this._optional?this._optional.loadModelOptions:null},z.prototype.userLockUnload=function(){this._optional||(this._optional=new Q),this.lockUnload(),this._optional.addUserLockUnload()},z.prototype.userUnlockUnload=function(){this._optional&&this._optional.userLockUnload>0&&(this.unlockUnload(),this._optional.removeUserLockUnload())},z.prototype.needScreenRadiusSizeComputation=function(){return!(this._status!==d.waiting&&this._status!==d.loaded&&this._status!==d.toUnload&&this._status!==d.toLoad&&(this._status!==d.error||!this._rep||this._rep.active))},z.prototype.updateBoundingSphere=function(){!this._boundingSphere&&this._boundingBox&&(this._boundingSphere=this._boundingBox.getBoundingSphere())},z.prototype.getBoundingBox=function(){if(!this._boundingBox){var e=this._boundingSphere;if(!e)return null;var t=new o.Box3;t.min.x=e.center.x-e.radius,t.min.y=e.center.y-e.radius,t.min.z=e.center.z-e.radius,t.max.x=e.center.x+e.radius,t.max.y=e.center.y+e.radius,t.max.z=e.center.z+e.radius,this._boundingBox=t}return this._boundingBox},z.prototype.hasBoundingElement=function(){return this._boundingBox&&this._boundingSphere},z.prototype.setBoundingElements=function(e,t,n,i){e&&(this._boundingSphere=e.clone(),n&&this._boundingSphere.applyMatrix4(n)),t&&(this._boundingBox=t.clone(),n&&this._boundingBox.applyMatrix4(n))};var W=new o.Sphere;z.prototype.getBoundingSphere=function(e){return this._boundingSphere?this._boundingSphere:this._boundingBox?(this._boundingBox.getBoundingSphere(W),W):e?new o.Sphere:null},z.prototype.getScore=function(){return this._screenRadius};var $=new o.MeshBasicMaterial({color:"red"});z.prototype.displayBox=function(e){var t=e,n=t.newLoadingBoxes;if(n&&!this.isLoadingBoxVisible()&&this._rep&&this._rep.node||!n&&z.slaveBoxFix){var i,r,o,s,a=!1;if(t.queueRenderer){for(i=0;!a&&i<this._rep.node.children.length;i++)"OOC##Box"===this._rep.node.children[i].name&&(a=!0);a||(r=this.getBoundingBox(),s=n?t.queueRenderer.getMaterialApplication():t.queueRenderer.getRepMaterialApplication(),r&&((o=g.createCuboidNodeFromBox3(r,$)).setRenderPasses(["main"]),o.setModelIdentification(this.referenceId),o.setPickable(t.queueRenderer.pickable),o.setPickParent(!0),o.name="OOC##Box",o.setMaterialApplication(s),this._rep.node.addChild(o)))}this.setLoadingBoxVisible(!0)}},z.prototype.removeBox=function(e){var t=e.newLoadingBoxes;if(t&&this.isLoadingBoxVisible()&&this._rep&&this._rep.node||!t&&z.slaveBoxFix){var n,i,r=!1;for(n=0;!r&&n<this._rep.node.children.length;n++)"OOC##Box"===(i=this._rep.node.children[n]).name&&(this._rep.node.removeChild(i),r=!0)}this.setLoadingBoxVisible(!1)},z.lodSelector=k;var Q=function(){this._force=null,this.onAddedToSceneGraphCB=null,this.onRemovedFromSceneGraphCB=null,this.onLoadedCallbacks=null,this.loadModelOptions=null,this.userLockUnload=0,this.overrideData=null};Q.prototype.setOverride=function(e,t){this.overrideData||(this.overrideData=new K),this.overrideData.setOverride(e,t),this.overrideData.isEmpty()&&(this.overrideData=null)},Q.prototype.hasOverride=function(e){return void 0===e?null!==this.overrideData:this.overrideData&&this.overrideData.hasOverride(e)},Q.prototype.addUserLockUnload=function(){this.userLockUnload++},Q.prototype.removeUserLockUnload=function(){this.userLockUnload--},Q.prototype.addOnLoadedCB=function(e){this.onLoadedCallbacks||(this.onLoadedCallbacks=[]),this.onLoadedCallbacks.push(e)},Q.prototype.onLoaded=function(){if(this.onLoadedCallbacks){var e;for(e=0;e<this.onLoadedCallbacks.length;e++)this.onLoadedCallbacks[e]();this.onLoadedCallbacks=null}},Q.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e};var j=function(){this.callbacks=[]};j.prototype.onForce=function(e){e&&this.callbacks.push(e)},j.prototype.onLoaded=function(){var e;for(e=0;e<this.callbacks.length;e++)this.callbacks[e]();this.callbacks.length=0},j.prototype.clear=function(){this.callbacks.length=0};var J=function(){this.override=null,this.overrideCB=null},K=function(){this.count=0,this.overrideMap={}};K.prototype.setOverride=function(e,t){var n=this.overrideMap[e];n?n.overrideCB=t:t&&((n=new J).overrideCB=t,this.overrideMap[e]=n,this.count++)},K.prototype.hasOverride=function(e){var t=this.overrideMap[e];return!(!t||!t.overrideCB)},K.prototype.isEmpty=function(){return 0===this.count},K.prototype.updateOverride=function(e,t,n){var i,r,o,s,a,d,l=null;for(i in this.overrideMap)r=e.getOverrideSet(i),o=(a=this.overrideMap[i]).override,s=a.overrideCB,t&&s?(o?o._forceOverrideUpdate():(o=r._createNodeOverride(t),a.override=o),s(n,o)):o&&(r.deleteOverride(o),a.override=null,s||(l=l||[]).push(i));for(d=0;l&&d<l.length;d++)delete this.overrideMap[l[d]],this.count--},z.prototype.updateOccurrencesPosition=function(e,t){var n;for(this.clearScreenRadiusCache(),n=0;n<this._occurrences.length;n++)this._occurrences[n].updateMatrix(e);var i,r,o=new Set;for(n=0;n<this.children.length;n++)r=this.children[n],null!==t&&r.instanceId!==t||(i=r.reference,o.has(i)||(o.add(i),i.updateOccurrencesPosition(e,null)))},z.prototype.clearScreenRadiusCache=function(){this._screenRadiusCache=[]},z.createChildData=function(e,t,n){return new E(e,t,n)},z.prototype.removeRep=function(e){if(this._rep===e)this._rep=e.nextRep;else for(var t=this._rep;t;)if(t.nextRep===e){t.nextRep=e.nextRep;break}},z.prototype.switchMeshInRAM=function(e,t){if(this.isLeaf()){var n=this.getActiveRepresentation();if(n.hasMeshInRAM()!==e)if(this.isLoading()){var i=t.switchRepresentationBuffer.get(this.referenceId);i||(i=new S(n.clone()),t.switchRepresentationBuffer.set(this.referenceId,i))}else{if(n!==this.getPrimaryRepresentation())n.setMeshInRAM(e);else{var r=n.clone();this.switchRepresentation(r,e,t)}}}},z.prototype.switchRepresentation=function(e,t,n,i,r){if(!this.isLoading())if(null===this._rep)e.active=!0,e.copyMissingParams(null),e.setMeshInRAM(t),this._rep=e;else if(this.isLeaf()){var o=this._rep,s=null,a=null,l=!1;e.isPartiallyDefined()&&(a=this.getActiveRepresentation(),e.copyMissingParams(a),a=null),e.setMeshInRAM(t);for(var h,c=this.getPrimaryRepresentation();o;)!r&&o.equals(e)&&(s=o),o.active&&(a=o),o=o.nextRep;if(s!==a?!r&&a.isClearMeshInRAMOnly(e)?(a.clearMeshInRAM(e),this.updateMemorySizeNEW(n),a===c&&(l=!0)):(this.clearScreenRadiusCache(),s||(e.nextRep=this._rep.nextRep,this._rep.nextRep=e,s=e),a.active=!1,s.active=!0,a!==e&&(this.isError()&&this.setStatus(d.waiting,n),n.forceUpdateNode(this))):a===c&&(l=!0),l)n.onSwitchRepCB&&m.call(n.onSwitchRepCB.bind(null,this.referenceId)),i&&m.multiCall(i);else if(i)for(h=0;h<i.length;h++)this.addOnLoadedCB(i[h])}},z.prototype.getActiveRepresentation=function(){for(var e=this._rep;e;){if(e.active)return e;e=e.nextRep}return e},z.prototype.getPrimaryRepresentation=function(){return this._rep},z.prototype.showActiveRepresentation=function(e){if(this.isAlive()){var t=this.getActiveRepresentation(),n=this.getPrimaryRepresentation();if(t!==n){var i,r=null,o=n.node,s=t.node,a=this.isSlave();if(a?e.unloadLeafReferenceCB&&e.unloadLeafReferenceCB.call(null,this.referenceId):this.removeRepresentationChildren(o),s&&(r=s.children.concat([]),s.removeChildren()),n.noMeshInRAM!==t.noMeshInRAM&&(n.noMeshInRAM||e.unloadManager.setHasMeshInRam(!0)),this.removeRep(t),t.nextRep=null,t.node=o,n.node=s,t.updateMeshSize(this),this._rep=t,o&&r)for(i=0;i<r.length;i++)o.addChild(r[i]);this.updateMemorySizeNEW(e),a&&e.onLeafReferenceLoadedCB&&e.onLeafReferenceLoadedCB.call(null,this.referenceId)}var d=e.onSwitchRepCB;d&&m.call(d.bind(null,this.referenceId))}},z.prototype.hasRootBoundingElement=function(){return!(!this._boundingBox&&this._boundingSphere&&0===this._boundingSphere.radius)},z.prototype.getNode=function(){return this._rep.node},z.weakCGRNodeMap=new WeakMap;var Z=-1;return z.prototype.setCGRNodeNames=function(e,t){-1===z.useRepNodeName&&(z.useRepNodeName=window.OOCEnableRepNodeName?1:0);var n,i,r=!1;if(e)for(n=0;n<e.length&&!r;n++)i=e[n],1===z.useRepNodeName?i.name=z.RepNodeName:z.RepNodeSet.add(i.id),-1===Z&&(Z=!1!==window.OOCEnablePRPrimPicking),!Z&&t.isPR()&&i.traverse(function(e){"Mesh3D"===e.getNodeType()&&e._setDisablePrimPicking(!0)}),t.node&&y.idPathWatcher&&i.internalSceneGraph&&(z.weakCGRNodeMap.set(i,"##REP##"+this.referenceId),y.idPathWatcher.onAddChild(t.node,i),r=!0)},z.prototype.getCGRNode=function(){var e,t,n=this.getActiveRepresentation().node;if(n)for(t=0;t<n.children.length;t++)if((e=n.children[t]).internalSceneGraph)return e;return null},z.prototype.updateOccurrences_traverse=function(e){this.traverse(t=>{if(t.getNeedUpdateOccurrences())t.updateOccurrencesHierarchy(e);else if(!t.getNeedUpdateOccurrencesUnder())return!0;t.setNeedUpdateOccurrencesUnder(!1)})},z.prototype.updateOccurrencesHierarchy=function(e){if(this.getNeedFullUpdateOccurrences())this.updateOccurrencesPosition(e,null);else{let t=this.instancesToUpdate;if(t){let n,i=new Set;for(n=0;n<t.length;n++){let r=t[n];i.has(r)||(i.add(r),this.updateOccurrencesPosition(e,r))}}}this.traverse(e=>{e.instancesToUpdate=null,e.setNeedFullUpdateOccurrences(!1),e.setNeedUpdateOccurrences(!1),e.setNeedUpdateOccurrencesUnder(!1)})},z.slaveBoxFix=!1,Object.defineProperty(z.prototype,"manager",{get:function(){throw new Error("forbidden")},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(z.prototype,"node",{get:function(){return this._rep&&this._rep.node},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(z.prototype,"url",{get:function(){return this._rep&&this._rep.url},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(z.prototype,"memorySize",{get:function(){return this.memoryData.memory},set:function(e){throw new Error("forbidden")}}),Object.defineProperty(z.prototype,"memorySizeGPU",{get:function(){return this.memoryData.memoryGPU},set:function(e){throw new Error("forbidden")}}),z.useRepNodeName=-1,z.RepNodeSet=new Set,z.RepNodeName="OOC##RepNode",z}),define("DS/3DXMTiles/DSTilesTileSet",["DS/3DXMTiles/OOCTileSet","DS/WAFData/WAFData","DS/3DXMTiles/DSTilesNodeStatus","DS/3DXMTiles/DSTilesContentSource","DS/3DXMTiles/ModelBank","DS/QualityManager/QMController","DS/3DXMTiles/DSTilesStyling","DS/3DXMTiles/ParsingStatus","DS/3DXMTiles/DSTilesQueue"],function(e,t,n,i,r,o,s,a,d){"use strict";class l{constructor(t,n){if(this.rootURI=t.rootURI||null,this.rootEtag=t.rootEtag||null,this.baseTileURL=t.baseTileURL||null,this.tileExtension=t.tilesExtension||null,this.loginURL=t.loginURL||null,this.urlPostfix=t.urlPostFix||t.urlPostfix||null,this.tileURLPostfix=t.tileURLPostfix||null,this.infoURL=t.infoURL||null,this.tileBatchingURL=t.tileBatchingURL||null,this.unit=t.unit||null,this.jsonPreprocessCB=t.jsonPreprocessCB||null,this.preloadedTileMap=new Map,this.nodeMap=new Map,this.oocTileSet=new e(this,n),this.contentMetaData=t.contentMetaData||null,this.contentMetaDataVersion=0,this.forceLoadTransactions=[],this.contentTypes=t.contentTypes||null,this.userData=t.userData||null,this.crs=t.crs||null,this.availableAttributesMap=this.createAvailableAttributesMap(t.availableAttributes),this.styling=null,t.styling&&this.setStyling(t.styling),t.contentSources?this.contentSources=this.buildContentSources(t.contentSources):this.contentSources=this.buildContentSources({default:t}),this.maxPixelError=window.WUXDefaultTileSetMaxPixelError||5,this.progressiveMode=!0,t.unit){var i=n._computeUnitValue(t.unit);this.unitScale=i/n.getUnitValue(),this.unit=i}else this.unitScale=1,this.unit=-1;this.sortingMetric=t.sortingMetric||"screenRadius",this.contentTickets=6,this.currentExpandBatch=new c,this.expandTickets=6,this.info={maxTileBatchSize:1,maxContentBatchSize:1},this.nbLoading=0,this.nbExpanding=0,this.ghostMode=!1,this.loadingStatus=!1,this.onStartLoadingCallbacks=new Map,this.onEndLoadingCallbacks=new Map,this.nodeSourceLoadingStatus=new WeakMap,this.contentLoaders=new Map,this.visibility=!0,this.fileSizeBudget=1/0,this.pauseLoading=null,this.updateBankTimeout=!1,this.useBank=o.getLocalCache()}static setFileSizeBudget(e){this.fileSizeBudget=e||1/0}buildContentSources(e){var t,n={};for(t in e)n[t]=new i(t,e[t],this,l);return n}hasPreloadedNode(e,t){let n=this.preloadedTileMap.get(e);return!!n&&(!n.fromBank||!(!t||n.etag!==t))}getPreloadedNodeJSON(e){let t=this.preloadedTileMap.get(e);return t&&t.json}getContentSource(e){return e=e||"default",this.contentSources[e]||null}getTile(e){return this.nodeMap.get(e)||null}getUnitValue(){return this.unit>0?this.unit:this.oocTileSet.oocManager.getUnitValue()}getSortingMetric(){return this.sortingMetric}getTriggerMetric(){return this.triggerMetric}removeNode(e){var t=this.nodeMap.get(e);if(t){var n=t.contentLoaders;if(n){let e;for(e=0;e<n.length;e++){let t=n[e];var i=this.contentLoaders.get(t)||0;0===--i?this.contentLoaders.delete(t):this.contentLoaders.set(t,i)}}}this.nodeMap.delete(e)}getContentLoaders(){var e=[];return this.contentLoaders.forEach((t,n,i)=>{e.push(n)}),e}setMaxPixelError(e){this.maxPixelError=e}getMaxContentBatchSize(){return this.info.maxContentBatchSize}getMaxExpandBatchSize(){return this.info.maxTileBatchSize}dispose(){this.preloadedTileMap=new Map,this.nodeMap=new Map,this.oocTileSet=null}buildTileURL(e){var t=e;return this.baseTileURL&&(t=this.baseTileURL+t),this.tileExtension&&(t+=this.tileExtension),this.tileURLPostfix&&(t+=this.tileURLPostfix),this.urlPostfix&&(t+=this.urlPostfix),t}addNode(e){this.nodeMap.set(e.uri,e);var t=e.contentLoaders;if(t){let e;for(e=0;e<t.length;e++){let i=t[e];if(i){var n=this.contentLoaders.get(i)||0;n++,this.contentLoaders.set(i,n)}}}}getRootNode(){return this.nodeMap.get(this.rootURI)}canLoadContent(){return this.contentTickets>0}onSourceLoaded(e){var t=this.nodeSourceLoadingStatus.get(e);t.count--,0===t.count&&(this.nodeSourceLoadingStatus.delete(e),t.error?e.queue.onNodeLoadError(e):e.queue.onNodeLoaded(e))}onSourceError(e){var t=this.nodeSourceLoadingStatus.get(e);t.count--,t.error=!0,0===t.count&&(this.nodeSourceLoadingStatus.delete(e),e.queue.onNodeLoadError(e))}getNbContents(e){let t,n=0;for(t=0;t<e.length;t++)n+=e[t].contents.length;return n}loadTileContent(e){var t,i=e.getSourcesWithContents();if(i.length>0)for(this.nodeSourceLoadingStatus.set(e,new h(this.getNbContents(i))),t=0;t<i.length;t++){var r=this.contentSources[i[t].sourceId];let n,o=i[t].contents,s=i[t].sourceParams;for(n=0;n<o.length;n++)r.loadTileContent(e,o[n],s[n],this.onSourceLoaded.bind(this),this.onSourceError.bind(this),null)}else this.nodeSourceLoadingStatus.set(e,new h(1)),e.setContentStatus(n.loading,e.queue),setTimeout(()=>{let t=e.contentSet.contents[0];t.contentLoader.loadContentFromBuffer({data:null,node:e,content:t,onLoadedCB:this.onSourceLoaded.bind(this,e),onErrorCB:this.onSourceError.bind(this,e),updateContent:!1})},0)}updateNodeContent(e,t){let i=e.node,r=e.content,o=e.onUpdatedCB,s=i.getSourcesWithContents([r]),a=0,d=this.oocTileSet.oocManager._ldhNodeManager;function l(e){if(--a<=0){t.nbLoading--,e.setContentStatus(n.loaded,e.queue),o();var i=new Set;t.loadUpdatedContent(i),i.forEach(e=>{e.flushLoadTileContent()}),d.requestUpdate(!1)}}var h;for(t.nbLoading++,h=0;h<s.length;h++){var c=this.contentSources[s[h].sourceId];let t,n=s[h].contents,r=s[h].sourceParams;for(t=0;t<n.length;t++)a++,c.loadTileContent(i,n[t],r[t],l,l,e)}a<=0&&(o(),d.requestUpdate(!1))}flushLoadTileContent(){var e;for(e in this.contentSources)this.contentSources[e].flushLoadTileContent()}canExpand(){return this.expandTickets>0}expandTile(e){var t=e.expander,i=e.queue;if(e.setExpandStatus(n.loading,i),this.tileBatchingURL){if(!this.currentExpandBatch.tryToAdd(e,this.getMaxExpandBatchSize(),this,!1)){var r=this.currentExpandBatch;this.expandBatch(r),this.currentExpandBatch=new c,this.currentExpandBatch.tryToAdd(e,this.getMaxExpandBatchSize(),this,!0)}}else e.childrenURIs?(this.expandTickets--,this.downloadTilesJSON(e.childrenURIs,e.childrenEtags,()=>{this.expandTickets++,t.expandNow(e)?i.onNodeExpanded(e):i.onNodeExpandError(e)})):i.onNodeExpanded(e)}expandBatch(e){var t=e.childrenURIs;function n(){var t;for(t=0;t<e.nodes.length;t++){var n=e.nodes[t],i=n.expander,r=n.queue;i.expandNow(n)?r.onNodeExpanded(n):r.onNodeExpandError(n)}}this.expandTickets--,t.length>0?this.downloadPerBatch(e.childrenURIs,e.etags,()=>{this.expandTickets++,n()}):setTimeout(()=>{this.expandTickets++,n()},0)}downloadTilesJSON(e,t,n){if(this.tileBatchingURL){var i=e.length;function r(e){0===(i-=e)&&n()}var o,s=this.getMaxExpandBatchSize();for(o=0;o<i;o+=s){var a=e.slice(o,o+s);let n=t&&t.slice(o,o+s);this.downloadPerBatch(a,n,r.bind(null,a.length))}}else this.downloadTilesOneByOne(e,t,n)}downloadPerBatch(e,n,i){e.length;var r=this.tileBatchingURL,o=null;l.odt&&(o=t,t=l.odt.FakeWAFData),t.authenticatedRequest(r,{cors:!0,timeout:36e5,method:"POST",data:JSON.stringify(e),async:!0,headers:{"Content-Type":"application/json"},onComplete:(e,t)=>{var n=JSON.parse(e);this.registerTileJSON(n),i()},onFailure:()=>{i()}}),o&&(t=o)}downloadTilesOneByOne(e,t,n){var i,r,o,s,a=e.length;function d(){0===--a&&n()}for(i=0;i<e.length;i++)o=e[i],s=t&&t[i],this.hasPreloadedNode(o,s)?setTimeout(d,0):(r=this.buildTileURL(o),this.downloadTile(r,d,o))}downloadTile(e,n,i){t.authenticatedRequest(e,{timeout:36e5,onComplete:e=>{var t=JSON.parse(e);this.registerTileJSON(t),n()},onFailure:e=>{n()}})}registerTileJSON(e,t){void 0===e.length&&(e=[e]);let n=!1;for(let i=0;i<e.length;i++){let r=e[i].etag;r&&(n=!0),this.preloadedTileMap.set(e[i].uri,{json:e[i].json,etag:r||null,fromBank:t})}this.useBank&&n&&!t&&!this.updateBankTimeout&&(this.updateBankTimeout=!0,setTimeout(()=>{this.updateBankTimeout=!1;let e=this.buildTileURL(this.rootURI),t=[];this.preloadedTileMap.forEach((e,n)=>{e.etag&&t.push({uri:n,json:e.json,etag:e.etag})});let n=JSON.stringify(t);r.storeTileData([e],[n],[1])},2e3))}flushExpandTile(){this.currentExpandBatch.nodes.length>0&&(this.expandBatch(this.currentExpandBatch),this.currentExpandBatch=new c)}async init(){await this.getInfo(),await this.login(),await this.initPreloadedTilesFromBank()}getInfo(){return this.infoURL?new Promise((e,n)=>{t.authenticatedRequest(this.infoURL,{cors:!0,timeout:36e5,method:"GET",onComplete:(t,n)=>{var i,r=JSON.parse(t);r&&r.maxTileBatchSize&&(i=parseFloat(r.maxTileBatchSize),isFinite(i)&&(this.info.maxTileBatchSize=i)),r&&r.maxContentBatchSize&&(i=parseFloat(r.maxContentBatchSize),isFinite(i)&&(this.info.maxContentBatchSize=i)),e()},onFailure:()=>{console.log("Login error"),n()}})}):Promise.resolve(!0)}login(){return this.loginURL?new Promise((e,n)=>{t.authenticatedRequest(this.loginURL,{cors:!0,timeout:36e5,method:"GET",onComplete:(t,n)=>{e()},onFailure:()=>{console.log("Login error"),n()}})}):Promise.resolve(!0)}initPreloadedTilesFromBank(){let e=this.buildTileURL(this.rootURI);return this.useBank&&r.hasTileData(e,1)?new Promise((t,n)=>{r.retrieveTileData([e],(e,n)=>{try{let e,i=JSON.parse(n);for(e=0;e<i.length;e++)this.registerTileJSON(i[e],!0)}catch{t()}t()},n)}):Promise.resolve(!0)}addForceLoadTransaction(e){this.forceLoadTransactions.push(e)}removeForceLoadTransaction(e){var t=this.forceLoadTransaction.indexOf(e);this.forceLoadTransaction.splice(t,1)}updateForceLoad(){var e;let t=!1;for(e=0;e<this.forceLoadTransactions.length;e++)this.forceLoadTransactions[e].update()&&(this.forceLoadTransactions[e]=null,t=!0);var n=0;for(e=0;e<this.forceLoadTransactions.length;e++)this.forceLoadTransactions[e]&&(this.forceLoadTransactions[n]=this.forceLoadTransactions[e],n++);return this.forceLoadTransactions.length=n,t}setGhostMode(e){(e=!!e)!==this.ghostMode&&(this.ghostMode=e,this.ghostMode?this.sgNode.setVisibility(!1):this.sgNode.setVisibility(!0))}setNodeStartLoading(){this.nbLoading++}setNodeEndLoading(){this.nbLoading--}setNodeStartExpanding(){this.nbExpanding++}setNodeEndExpanding(){this.nbExpanding--}registerOnStartLoadingCB(e){var t={};return this.onStartLoadingCallbacks.set(t,e),t}unregisterOnStartLoadingCB(e){this.onStartLoadingCallbacks.delete(e)}registerOnEndLoadingCB(e){var t={};return this.onEndLoadingCallbacks.set(t,e),t}unregisterOnEndLoadingCB(e){this.onEndLoadingCallbacks.delete(e)}updateLoadingStatus(){var e=this.nbLoading>0||this.nbExpanding>0;e!==this.loadingStatus&&(this.loadingStatus=e,e?this.onStartLoadingCallbacks.forEach((e,t,n)=>{e.call(null)}):this.onEndLoadingCallbacks.forEach((e,t,n)=>{e.call(null)}))}updateContentMetaData(e){var t;for(t=0;t<e.length;t++){let o=e[t].path,s=e[t].value;var n,i=o.split("/"),r=this.contentMetaData;for(r||(r={},this.contentMetaData=r),n=0;n<i.length;n++)if(n<i.length-1){let e=r[i[n]];e||(e={},r[i[n]]=e),r=e}else r[i[n]]=s}this.contentMetaDataVersion++,this.getRootNode().onTileSetContentMetaDataUpdate()}setVisibility(e){var t;if(e!==this.visibility)for(this.visibility=!!e,this.getRootNode().getSgNode().setVisibility(this.visibility),this.getContentLoaders(),t=0;t<this.contentLoaders.length;t++)this.contentLoaders[t].setTileSetVisibility(this.visibility)}setVisibilityFree(e){this.getRootNode().getSgNode().setVisibilityFree(e)}getPauseLoading(){return!!(this.pauseLoading&&this.pauseLoading.size>0)}setPauseLoading(e,t,n){this.pauseLoading||(this.pauseLoading=new Set),e?this.pauseLoading.add(t):(this.pauseLoading.delete(t),0===this.pauseLoading.size&&(this.pauseLoading=null,n.requestUpdate(!0,!0)))}createAvailableAttributesMap(e){let t,n=new Map,i=["integer","float","string"];for(t=0;e&&t<e.length;t++){let r=e[t],o=r.name,s=i.indexOf(r.type)>=0?r.type:null,a=r.userData||null;o&&n.set(o,{type:s,userData:a})}return n}setStyling(e,t){let n=null,i=a.ok;if(e&&!(i=(n=new s).setFromJSON(e)).isOk())return n=null,i;this.styling=n;let r=this.getRootNode();if(r){let e=[];r.traverse(t=>{(t.hasContentToken()||t.isContentLoading())&&e.push(t)});let n,i=[],o=[];for(n=0;n<e.length;n++){let t,r=e[n],s=r.contentSet,a=s&&s.contents;for(t=0;t<a.length;t++)i.push(r),o.push(a[t])}let s=o.length;let a=d.updateNodesContents(i,o,function(e,n){if(--s<=0){let e;for(e=0;e<o.length;e++){let t=o[e],n=i[e];t.updatedContentVersion===a&&t.replaceContentWithUpdated(n)}t.render({budgeted:!0})}})}return i}}function h(e){this.count=e,this.error=!1}function c(){this.nodes=[],this.childrenURIs=[],this.etags=[]}return l.odt=!1,c.prototype.tryToAdd=function(e,t,n,i){if(!e.childrenURIs)return this.nodes.push(e),!0;var r,o,s,a=[],d=[];for(r=0;r<e.childrenURIs.length;r++)o=e.childrenURIs[r],s=e.childrenEtags&&e.childrenEtags[r],n.hasPreloadedNode(o,s)||(a.push(o),d.push(s));if(this.childrenURIs.length+a.length<t||i){for(r=0;r<a.length;r++)this.childrenURIs.push(a[r]),this.etags.push(d[r]);return this.nodes.push(e),!0}return!1},l}),define("DS/3DXMTiles/LDHBatchModel3DHandlerVISCA",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats"],function(e,t,n,i,r,o,s,a){"use strict";function d(e,t,n){var i,r,o=e.length;for(i=t;i<o&&(13!==(r=255&e.charCodeAt(i))&&10!==r);i++);return i+1<o?(13!==(r=255&e.charCodeAt(i+1))&&10!==r||i++,{str:e.slice(t,i),index:i+1}):null}var l=function(e,t){this.currentIndex=0,this.waitForSize=0,this.handler=e,this.onPartExtracted=t,this.nextReferenceIndex=0};l.prototype.onProgress=function(e){if(!(e.length<this.waitForSize))for(var t=!0;t;)t=this.tryToLoadPart(e)},l.prototype.tryToLoadPart=function(e){new TextDecoder;var t,n,i,r=this.nextReferenceIndex,o=this.currentIndex,s=-1;do{if(!(t=d(e,o)))return!1;o=t.index,(i=t.str).startsWith("Content-length:")&&(n=i.split(" "),s=parseInt(n[1])),i.startsWith("X-CorelationID:")&&(n=i.split("reference_"),r=parseInt(n[1]))}while(s<0&&o<e.length);if(!(t=d(e,o)))return!1;if(o=t.index,this.waitForSize=o+s,s>0&&o+s<e.length){for(var a=new Uint8Array(s),l=0;l<s;++l)a[l]=255&e.charCodeAt(o+l);return this.currentIndex=o+s,this.nextReferenceIndex++,this.onPartExtracted(r,a),!0}return!1};var h=0;function c(e,t){this.index=h++,this.context=e,this.references=[],this.size=t,this.startTime=performance.now()}var u={nbKO:0,nbOK:0,successRate:0,onKO:function(){this.nbKO++,this.successRate=this.nbOK/(this.nbKO+this.nbOK)},onOK:function(){this.nbOK++,this.successRate=this.nbOK/(this.nbKO+this.nbOK)}};window.OOCSuccessRate=u;var p=function(t,n,i){e.call(this,e.Model3DHandler),this.loadModelOptions=null,this.debug=!!t.debug,this.manager=null,this.loadingInProgress=!1,this.nbTickets=n,this.batchSize=i,this.modelLoader=new r,this.modelLoader.sharedBuffers=!1,this.modelLoader.setFileType("cgr"),this.modelLoader.setKeepLoaderMode(!0),this.referenceToBatch=new Map,this.urlServices=new o,this.getSecurityParamsCB=t.getSecurityParamsCB||null};(p.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},p.prototype.setRestricted=function(){},p.prototype.isReady=function(){return this.nbTickets>0},p.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},p.prototype.setRedirectUrlCB=function(){},p.prototype.setAutoRedirect=function(){};var f=document.createElement("a");p.prototype.getParams=function(e){var t={};f.href=e;for(var n,i=f.search.substring(1).split("&"),r=0;r<i.length;r++){var o=i[r].split("=");t[o[0]]=(n=o[1],decodeURIComponent((n+"").replace(/\+/g,"%20")))}return t};var g={getfcsurls:{url:"/resources/enopad/getfcsurls",verb:"POST"},fileurls:{url:"/resources/fcsservices/fcs/fileurls",verb:"POST"},reps:{url:"/api/V1/reps",verb:"POST"},rep:{url:"/api/V1/rep",urlLower:"/api/v1/rep",verb:"POST"},xmql:{url:"/i3dx/services/xmql",verb:"POST"}};p.prototype.buildMQLRequest=function(e){var t,n,i,r,o="[";for(t=0;t<e.length;t++)i=e[t].getActiveRepresentation(),t>0&&(o+=","),o+='{"correlationId":"'+(r=t+1)+'","filename":"'+(n=this.getParams(i.url)).filename+'","format":"'+n.format+'","path":"'+r+'","physicalid":"'+n.boid+'"}';return o+="]",['<?xml version="1.0" encoding="utf-8"?>','<executeSequence xmlns="http://www.3ds.com/xmql/query">',"  <execute>","    <function>get_checkout_ticket</function>","    <version>2.1.0</version>","    <params>",'      <param name="label">ticket</param>','      <param name="mcsurl">'+function(e){var t=e.getActiveRepresentation().url,n=t.toLowerCase().indexOf("/resources/fcsservices/");return n>=0?t.substring(0,n):"##error##"}(e[0])+"</param>",'      <param name="bops">[{"bops":'+o+',"store":"plmx"}]</param>',"    </params>","  </execute>","</executeSequence>"].join("\n")};return p.prototype.doCheckoutMQL=function(e,t,n){var r=this;n=n;function o(e,t,n){r.onModelLoaded(e,t,n)}function s(e){r.onModelError(e)}var a=new l(this,function(e,t){var i=n[e];r.loadPart(t,i,o,s)}),d=1===n.length?"arraybuffer":"text/plain",h=1===n.length?null:"text/plain; charset=x-user-defined",c=/\{\{([^\}]*)\}\{([^\}]*)\}\}/.exec(e),u=c[1],p=c[2],f=(r=this,{cors:!0,timeout:1e5,method:"POST",data:{__fcs__jobTicket:u},type:d,mimeType:h,async:!0,headers:{Accept:"text/plain"},onComplete:function(e){if(1===n.length){var t=n[0];r.loadPart(e,t,o,s)}},onProgress:function(e){n.length>1&&a.onProgress(e.target.responseText,t)},onFailure:function(){console.log("checkout ERROR")}});i.authenticatedRequest(p,f)},p.prototype.loadPart=function(e,n,i,r){var o=n.getActiveRepresentation().node,s=e.byteLength;this.modelLoader.setOnLoadedProductStructureCallback(function(e){i(n,e,s)}),this.modelLoader.setOnErrorCallback(function(){r(n)}),t.setupModelLoader(this.modelLoader,n),this.modelLoader.loadModelFromBuffer(e,o,{})},window.myLength=[],p.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},p.prototype.handleReferences=function(e,t){this.manager=t.manager._ldhNodeManager;var n,i,r,o=this.manager;for(i=0;i<e.length;i++)r=(n=e[i]).getActiveRepresentation(),n.requestBuildSceneGraphHierarchy(!0);o.tryBuildSceneGraphHierarchy();var s=[],d=[],l=new c(t,e.length);for(i=0;i<e.length;i++)(r=(n=e[i]).getActiveRepresentation())!==n.getPrimaryRepresentation()&&r.buildNode(),r.node,this.isViscaUrl(r.url)?d.push(n):s.push(n),l.references.push(n),this.referenceToBatch.has(n.referenceId)&&console.log("ben v'la aut' chose"),this.referenceToBatch.set(n.referenceId,l);this.nbTickets--,a.onStartBatch(l.references.length),s.length>0&&this.requestMQLCheckoutTicket(s,l),d.length>0&&this.requestVISCACheckoutTicket(d,l)},p.prototype.requestMQLCheckoutTicket=function(e,t){var n,r,o,s=this,a=this.buildMQLRequest(e),d=(n=e[0],r=n.getActiveRepresentation().url,(o=r.toLowerCase().indexOf("/resources/fcsservices/"))>=0?r.substring(0,o)+g.xmql.url:"##error##");i.authenticatedRequest(d,{data:a,authentication:"passport",method:"POST",headers:{"Content-type":"application/xml",Accept:"text/plain"},proxy:"passport",onComplete:function(n){s.doCheckoutMQL(n,t,e)},onFailure:function(n){s.errorCallbackTest(t,e)}})},p.prototype.requestVISCACheckoutTicket=function(e,t){var n,r,o=[],s=[];for(n=0;n<e.length;n++)r=e[n].getActiveRepresentation(),o.push(r.url),s.push("reference_"+n);var a=this.urlServices.CreateFetchURLAndBody(o,s,{allowPartial:!0}),d=this.getSecurityParamsCB(),l=d.securityCtx?d.securityCtx:"preferred",h=this,c=a.url.replace("//api","/api");i.authenticatedRequest(c,{method:"POST",data:a.body,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:l},onComplete:function(n){var i=JSON.parse(n);h.doCheckoutVISCA(i,t,e)},onFailure:function(n){h.errorCallbackTest(t,e)}})},p.prototype.doCheckoutVISCA=function(e,t,n){var i,r,o,s=e.ticketWrappers;for(i=0;i<s.length;i++)r=s[i].url,o=s[i].ticket,this.doCheckoutVISCASingle(r,o,t,n)},p.prototype.doCheckoutVISCASingle=function(e,t,n,r){var o=this;r=r;function s(e,t,n){o.onModelLoaded(e,t,n)}function a(e){o.onModelError(e)}var d=new l(this,function(e,t){var n=r[e];o.loadPart(t,n,s,a)}),h={cors:!0,timeout:1e5,method:"POST",data:{__fcs__jobTicket:t},type:1===r.length?"arraybuffer":"text/plain",mimeType:1===r.length?null:"text/plain; charset=x-user-defined",async:!0,headers:{Accept:"text/plain"},onComplete:function(e){if(1===r.length){var t=r[0];o.loadPart(e,t,s,a)}},onProgress:function(e){r.length>1&&d.onProgress(e.target.responseText,n)},onFailure:function(){console.log("checkout ERROR")}};i.authenticatedRequest(e,h)},p.prototype.errorCallbackTest=function(e,t){this.doneCB(e,t,!1)},p.prototype.onModelLoaded=function(e,t,n){var i=e.getActiveRepresentation();t&&t.nodes&&e.setCGRNodeNames(t.nodes,i),u.onOK(),a.onLoadedModel(n);var r=e.referenceId,o=this.referenceToBatch.get(r),s=o.context.manager,d=s._ldhNodeManager;e.showActiveRepresentation(d),e.setRepLoaded(!0),d.onLeafReferenceLoadedCB&&d.onLeafReferenceLoadedCB(e.referenceId,t),i.updateMeshSize(e),e.updateMemorySizeNEW(d),s._startModelLoaderTransaction(),s._onRepLoaded(e),s.endInstRefGraphTransaction(),this.doneCB(o,[e],!0)},p.prototype.onModelError=function(e){u.onKO();var t=this.referenceToBatch.get(e.referenceId);this.doneCB(t,[e],!1)},window.myBatches=[],p.prototype.doneCB=function(e,t,n){var i,r,o,s=e.context,d=s.manager;for(i=0;i<t.length;i++)o=t[i].referenceId,this.referenceToBatch.delete(o),r=d._getLDHReference(o),n?s.doneCB([r],[]):s.doneCB([],[r]),e.size--;if(0===e.size){performance.now();this.nbTickets++,a.onEndBatch(e.references.length),d._ldhNodeManager.requestUpdate(!1,!1)}},p.prototype.getBatchSize=function(){return this.batchSize},p}),define("DS/3DXMTiles/OOCManagerEntry",["DS/3DXMTiles/LDHReference"],function(e){"use strict";return function(t,n){this.id=t,this.reference=new e({handler:n.handler,manager:n.manager._ldhNodeManager,boundingSphere:n.boundingSphere&&n.boundingSphere.clone(),boundingBox:n.boundingBox&&n.boundingBox.clone(),urlOrId:n.url,referenceId:t,leaf:!!n.leaf,node:n.node||null}),n.loadModelOptions&&this.reference.setLoadModelOptions(n.loadModelOptions)}}),define("DS/3DXMTiles/DSTilesManager",["DS/3DXMTiles/DSTilesQueueSet","DS/3DXMTiles/MemoryBudgetManager","DS/3DXMTiles/DSTilesStdExpander","DS/3DXMTiles/DSTilesGenericScoreComputer","DS/3DXMTiles/DSTilesTileSet","DS/Visualization/Node3D","DS/3DXMTiles/DSTilesRootEntry","DS/Visualization/ThreeJS_DS"],function(e,t,n,i,r,o,s,a){"use strict";return class{constructor(e){this.expander=new n({tilesManager:this,scoreComputer:new i({})}),this.memoryManager=new t(e.unloadManager),this.ldhNodeManager=e,this.rootEntries=[],this.queueSets=[],this.customContentManagerMap=new Map}getQueueSet(t){return 0===this.queueSets.length&&this.queueSets.push(new e(this)),this.queueSets[0]}registerRootNode(e){this.expander.init();var t=e.node;t.sgNode||t.buildSgNode();var n=e.targetSGNode;n&&n!==t.sgNode&&n.addChild(t.sgNode);var i=new s({node:t});this.rootEntries.push(i)}removeTileSet(e){var t,n=e.getTile(e.rootURI);for(t=0;t<this.rootEntries.length;t++)if(this.rootEntries[t].node==n){this.rootEntries.splice(t,1);break}for(n.destroy(),t=0;t<this.queueSets.length;t++)this.queueSets[t].cleanLists();e.dispose()}registerDSTilesNode(e){e.queue.registerDSTilesNode(e)}updateNodes(e,t){var n,i,r,o=!1;for(n=0;n<this.rootEntries.length;n++)r=this.rootEntries[n].node,i=this.rootEntries[n].node.tileSet,r.updateDescendantLocked(),i.getPauseLoading()||i.updateForceLoad()&&(o=!0);let s=e||o;for(n=0;n<this.rootEntries.length;n++)(r=this.rootEntries[n].node).updateWorldMatrix(!0);for(n=0;n<this.queueSets.length;n++)this.queueSets[n].updateNodes(s,t);if(s)for(n=0;n<this.rootEntries.length;n++)(r=this.rootEntries[n].node).tileSet.getPauseLoading()||r.traverseUpdateNodes(this.ldhNodeManager.viewer);for(n=0;n<this.rootEntries.length;n++)(i=this.rootEntries[n].node.tileSet).flushLoadTileContent(),i.flushExpandTile()}loadNodes(e,t){var n,i=this.memoryManager;for(i.startUnload()&&(this.unloadNodes(),i.endUnload()),n=0;n<this.queueSets.length;n++)this.queueSets[n].loadNodes(e,t)}isLoading(){var e;for(e=0;e<this.queueSets.length;e++)if(this.queueSets[e].isLoading())return!0;return!1}unloadNodes(e){var t;for(e&&(window.forceUnload=!0),t=0;t<this.rootEntries.length;t++)this.rootEntries[t].node.tryUnload(this.memoryManager);e&&(window.forceUnload=!1)}registerCustomContentManager(e){var t=e.type;this.customContentManagerMap.set(t,e)}getCustomContentManager(e){return this.customContentManagerMap.get(e)||null}createFromJSON(e,t,n){var i=this.ldhNodeManager.oocManager,s=new r(e,i);return s.setPauseLoading(!0,"_init_",this.ldhNodeManager),s.init().then(()=>new Promise((e,i)=>{var r=this.getQueueSet();s.downloadTilesOneByOne([s.rootURI],[s.rootEtag],()=>{var i=s.rootURI,d=s.getPreloadedNodeJSON(i),l=this.expander.createNodeFromJSON(d,null,i,r,s,null);s.addNode(l);var h=t;if(n&&(h=new o,t.addChild(h)),1!==s.unitScale){var c=new o,u=new a.Matrix4;u.makeScale(s.unitScale,s.unitScale,s.unitScale),c.setMatrix(u),h.addChild(c);var p=new o;c.addChild(p),h=p}var f={targetSGNode:h,node:l};l.setSgNode(h),l.updateWorldMatrix(),this.registerDSTilesNode(l),this.registerRootNode(f),e(s)})}))}setSplattingParameters(e){this.expander.setSplattingParameters(e)}getOOCTargetNode(){return this.ldhNodeManager.targetNode}}}),define("DS/3DXMTiles/LDHNodeManagerQueue",["DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHStats","DS/Visualization/ThreeJS_R57"],function(e,t,n,i,r,o,s,a){"use strict";var d=function(t,n){this.type=t,this.handler=null,this.manager=n,this.newNodes=[],this.nodes=[],this.pendingNodes=[],this.nbNodesToRemoveFromList=0,this.viewpointData=null,this.enableOcclusionTest=!0,this.occlusionList=[],this.nodesToLoadQueue=new e,this.nodesToUpdateSet=new Set,this.loadedNodesQueue=new e,this.forcedReferences=[],this.unknownReferences=[],this.referenceSizeMap=new Map,this.nbLoading=0,this.nbLoaded=0,this.occlusionNbLoaded=0,this.renderingOccured=!1,this.nodesToLoadHasBeenReset=!1,this.unloadedReferenceIds=new Set,this.targetOcclusionNbLoaded=0};return d.prototype.registerNode=function(e){if(null==this.handler)this.handler=e.handler,this.manager.unloadManager.isRestricted&&this.handler.setRestricted();else if(this.handler!==e.handler)throw new Error("different handler found");this.addToLoadedNodesQueue(e);var t=!1;e.isForced()&&e.shouldBeExpanded()?e.isInForced()||(t=!0,e.setInForced(!0),this.forcedReferences.push(e)):e.isInForced()&&(this.removeForcedNode(e),e.setInForced(!1)),e.isUnknown()?e.isInUnknown()||t||(t=!0,e.setInUnknown(!0),this.unknownReferences.push(e)):e.isInUnknown()&&(this.removeUnknownNode(e),e.setInUnknown(!1),e.updateBoundingElementImpostor()),e.isInList()?this.forceUpdateNode(e):(e.setInList(!0),this.newNodes.push(e))},d.prototype.unregisterNode=function(e){e.isInUnknown()&&(this.removeUnknownNode(e),e.setInUnknown(!1)),e.isInForced()&&(this.removeForcedNode(e),e.setInForced(!1))},d.prototype.getEstimatedSize=function(){return this.nodes.length+this.newNodes.length},d.prototype.onReferenceUnloaded=function(){this.nodesToLoadQueue.cleanNulls()},d.prototype.removeUnknownNode=function(e){var t=this.unknownReferences.indexOf(e);t>=0&&this.unknownReferences.splice(t,1)},d.prototype.removeForcedNode=function(e){var t=this.forcedReferences.indexOf(e);t>=0&&this.forcedReferences.splice(t,1)},d.prototype.forceUpdateNode=function(e){e&&(this.nodesToUpdateSet.add(e),e.isForced()&&!e.isInForced()&&e.shouldBeExpanded()&&(this.forcedReferences.push(e),e.setInForced(!0)))},d.prototype.updateNodes=function(e,t){if(null!==this.handler){t?this.viewpointData=t:t=this.viewpointData,e&&(this.unloadedReferenceIds=new Set);var n=e;n||this.nodesToLoadHasBeenReset||(this.updateNodesToLoad(this.newNodes,t),this.updateNodesToLoad(Array.from(this.nodesToUpdateSet),t),this.newNodes.length>0||this.nodesToUpdateSet.size>0),function(e,t){var n;for(n=0;n<t.length;n++)e.push(t[n])}(this.nodes,this.newNodes),this.newNodes.length=0,this.nodesToUpdateSet.clear(),this.removeUselessNodesFromList(this.nodes,e),n&&(this.resetNodesToLoad(),!0),(n||this.nodesToLoadHasBeenReset)&&this.updateNodesToLoad(this.nodes,t)}},d.prototype.updateNodesToLoad=function(e,t){var i,r,s,a=this.manager.enableUnload,d=this.manager.newLoadingBoxes,l=this.manager.occlusionChecker;for(i=0;i<e.length;i++)(r=e[i]).needScreenRadiusSizeComputation()&&(1===(s=r.updateNodeLOD(t))?r.shouldBeExpanded()&&!this.unloadedReferenceIds.has(r.referenceId)?r.isInToBeLoaded()||r.isInHighPriority()||(r.setInToBeLoaded(!0),this.enableOcclusionTest?(l&&l.showReference(r),this.occlusionList.push(r)):this.nodesToLoadQueue.addNode(r),r.setStatus(n.toLoad,this.manager)):r.isRepLoaded()?r.setStatus(n.loaded,this.manager):r.setStatus(n.waiting,this.manager):a&&(!r.isSlave()&&!r.hasUnloadFrozenParent()||r.isLoaded())&&(r.setStatus(n.toUnload,this.manager),this.unloadedReferenceIds.add(r.referenceId)),!d&&o.slaveBoxFix&&r.isSlave()&&!r.isComplete()&&(1===s?r.displayBox(this.manager):r.removeBox(this.manager)));this.nodesToLoadHasBeenReset=!1},d.prototype.requiresOcclusion=function(){return!!(this.handler&&this.handler.isReady()&&this.occlusionList.length>0&&this.nodesToLoadQueue.isEmpty())||(this.isLoading()||!this.handler||this.handler.isReady()||this.manager.requestUpdate(!1,!1),!1)},d.prototype.hasOcclusionList=function(){return this.occlusionList.length>0},d.prototype.computeOcclusion=function(e,t){if(this.handler){if(r.startProbe("occlusion"+this.handler.type),this.renderingOccured=!1,!this.nodesToLoadQueue.isEmpty()){var n=this.nodesToLoadQueue.getAllNodes();this.occlusionList=n.concat(this.occlusionList)}var i,o;this.nodesToLoadQueue.clear();var s=!1;for(i=0;i<this.occlusionList.length;i++)(o=this.occlusionList[i])&&(o.addToOcclusionChecker(e),s=!0,0);if(s){e.computeVisibility();var a,d=0;for(i=0;i<this.occlusionList.length;i++)(o=this.occlusionList[i])&&(a=o.occlusionId)>=0&&o&&(e.getVisibility(a)||!o.hasGoodRep()?(o.setOcclusionVisible(!0),this.nodesToLoadQueue.addNode(o),this.occlusionList[i]=null,d++):(o.setOcclusionVisible(!1),o._onOccluded()));this.occlusionNbLoaded=this.nbLoaded+Math.floor(d/2)}r.endProbe("occlusion"+this.handler.type)}},d.prototype.resetNodesToLoad=function(){var e,t;for(this.nodesToLoadQueue.clear(function(e){e.setInToBeLoaded(!1),e.setOcclusionVisible(!1)}),e=0;e<this.occlusionList.length;e++)(t=this.occlusionList[e])&&(t.setInToBeLoaded(!1),t.setOcclusionVisible(!1));this.occlusionList=[],this.nodesToLoadHasBeenReset=!0},d.prototype.loadHighPriorityNodes=function(e,t){return this.loadNodeLists(e,[this.forcedReferences],t,!0)},d.prototype.loadUnknownNodes=function(e,t){return this.loadNodeLists(e,[this.unknownReferences],t,!1)},d.prototype.loadNodeLists=function(e,t,n,i){var r,o,s,a,d,l=this.handler,h=this.manager.unloadManager,c=this.manager,u=n||(l?l.createBatch():null);if(l&&l.isReady()){l.type;for(r=0;r<t.length;r++)for(s=t[r],o=0;o<s.length&&l.isReady();o++)(a=s[o]).isLoading()||u.containsReference(a)||a.isError()||(d=h.isLoadingAllowed(l.type),i&&!d&&(c.forceUnloadSmallNodes(1/0,e,l.type),d=h.isLoadingAllowed(l.type)),d&&(u.addReferenceIfPossible(a)||(this.loadBatch(u),u=l.createBatch())))}return u},d.prototype.loadNodes=function(e,t){var n=this.handler;if(n){var i=this.loadHighPriorityNodes(t,null),r=this.manager,o=!r.enableUnload||r.unloadManager.isLoadingAllowed(this.type),s=r.unloadManager,a=this;n.type;this.nodesToLoadQueue.traverseMaxPlus(function(e,d,l){if(e.isAlive()){if(!e.isToLoad())return e.setInToBeLoaded(!1),void e.setOcclusionVisible(!1);if(s.wouldDownloadCauseEmergencyUnload(e.referenceId,a))return r.emergencyUnloadAvoided=!0,l(),void d();if(n.isReady()&&(!o&&r.unloadSmallNodesEnabled&&(a.manager.forceUnloadSmallNodes(e.getScore(),t,n.type),o=s.isLoadingAllowed(n.type)),o))return e.hasDifferentViewpointTag(r.viewpointTag)&&(e._occurrences.length>0||e.isSlave())&&!e.isInHighPriority()&&!i.addReferenceIfPossible(e)?(l(),a.loadBatch(i),void(i=n.createBatch())):(e.setInToBeLoaded(!1),void e.setOcclusionVisible(!1));d(),l()}}),i=this.loadUnknownNodes(t,i),this.loadBatch(i)}},d.prototype.loadBatch=function(e){if(!e.isEmpty()){var t={viewpointTag:this.manager.viewpointTag,manager:this.manager.oocManager,doneCB:this.onHandlerDone.bind(this)};e.setReferencesLoading(this.manager),this.nbLoading+=e.getSize(),s.onStartCGRLoading(),this.handler.handleBatch(e,t)}},d.prototype.onHandlerDone=function(e,i){e=e||[];var r=(i=i||[]).length+e.length;this.nbLoaded+=r,0===this.handler.type?this.nbLoading-=r:this.nbLoading--;this.manager.enableUnload;var o,s,a,d,l=this.manager.occlusionChecker,h=e.concat(i);this.manager.unloadManager;if(this.manager.progressiveExpand)for(s=0;s<e.length;s++)(a=e[s]).setRepLoaded(!0);for(s=0;s<h.length;s++){if(a=h[s],l&&l.hideReference(a),a.isLoading()&&a.setStatus(n.loaded,this.manager),0===this.handler.type){var c=this.manager.switchRepresentationBuffer.get(a.referenceId);c&&(o=this.manager.oocManager,this.manager.switchRepresentationBuffer.delete(a.referenceId),a.switchRepresentation(c.rep,o.isMeshInRAMRequested(a.referenceId),this.manager,c.onSwitchRepCBArray,!0))}a._boundingSphere||a._boundingBox||this.handler.type!==t.Model3DHandler||(a.updateBoundingSphereFromNode(),d=!0),(a.isForced()||d)&&this.manager.registerTilesNode(a)}for(s=0;s<i.length;s++)this.handler.type===t.Model3DHandler||this.handler.type===t.TileSetHandler?(i[s].setStatus(n.error,this.manager),i[s].showActiveRepresentation(this.manager),i[s]._onLoaded(),this.onNodeToRemoveFromList()):this.forceUpdateNode(i[s]);this.handler.isReady()&&this.manager.requestUpdate(!1,!1),this.handler.type===t.Model3DHandler&&this.manager.viewer.render({budgeted:!0})},d.prototype.onNodeToRemoveFromList=function(){this.nbNodesToRemoveFromList++},d.prototype.removeUselessNodesFromList=function(e,t){if(this.nbNodesToRemoveFromList>200||t){var n,i;for(n=0;n<e.length;n++)(i=e[n]).isAlive()||(e[n]=null);var r=0;for(n=0;n<e.length;n++)null!==(i=e[n])&&(e[r]=i,r++);e.length=r,this.nbNodesToRemoveFromList=0}},d.prototype.isLoading=function(){return this.nbLoading>0},d.prototype.hasMoreToLoad=function(){return!this.nodesToLoadQueue.isEmpty()},d.prototype.fillDebugArray=function(e){var t,n,i,r;for(this.removeUselessNodesFromList(this.nodes,!0),t=0;t<this.nodes.length;t++){if(i={id:(n=this.nodes[t]).referenceId,screenRadius:n._screenRadius,status:n._status,unloadStatus:n._unloadStatus},n.children.length>0&&(i.nbChildren=n.children.length,n.children.length>0)){var o=[],s=[];for(r=0;r<n.children.length;r++)o.push(n.children[r].reference.referenceId),s.push(n.children[r].instanceId);i.children=o,i.instances=s}n.unloadLockCounter>0&&(i.unloadLockCounter=n.unloadLockCounter),e.push(i)}},d.prototype.memorizeReferenceSize=function(e,t){(!this.referenceSizeMap.has(e)||this.referenceSizeMap.get(e)<t)&&this.referenceSizeMap.set(e,t)},d.prototype.getMemorizedReferenceSize=function(e){return this.referenceSizeMap.has(e)?this.referenceSizeMap.get(e):-1},d.prototype.addToLoadedNodesQueue=function(e){e.isInLoaded()||(e.setInLoaded(!0),this.loadedNodesQueue.addNode(e))},d.prototype.unloadSmallNodes=function(e,t,n){var i=this.manager.unloadManager,r=this.loadedNodesQueue,o=this.manager,s=this.handler.type,a=this.unloadedReferenceIds;r.traverseMinPlus(function(n,r,d){var l=!1;!i.isLoadingAllowed(s)&&n.getScore()<e?n.isUnloadLocked()?l=!0:o.unloadNode(n,t,!0)?(a.add(n.referenceId),o.hasUnloadedSmallNodes=!0):l=!0:(r(),l=!0),l?d():n.setInLoaded(!1)})},d.prototype.standardUnloadNodes=function(e,t){var n=this.manager.unloadManager;if(this.handler&&n.isUnloadNeeded(this.handler.type)){e&&this.loadedNodesQueue.resetOrder(function(e){var t=e.isAlive();return t||e.setInLoaded(!1),t});var i=!1,r=this.manager;this.loadedNodesQueue.traverseMinPlus(function(o,s,a){var d=!1,l=o.handler;(e||o.isAlive()&&o.isUnloadable())&&o.isAlive()&&(n.isUnloadNeeded(l.type)&&o.isToUnload()?o.isUnloadLocked()?d=!0:(i=!0,r.unloadNode(o,t)||(d=!0)):(o.isLoaded()&&!o.isForced()&&s(),d=!0)),d?a():o.setInLoaded(!1)}),i&&this.onReferenceUnloaded()}e&&this.loadedNodesQueue.cleanNulls()},d.prototype.doEmergencyUnload=function(e){var t=this.manager,n=!1,i=this.type,r=this.unloadedReferenceIds;this.loadedNodesQueue.traverseMinPlus(function(o,s,a){if(t.unloadManager.isEmergencyUnloadRequired(void 0,i)){var d=!1;o.handler;o.isAlive()&&(o.isUnloadLocked()?d=!0:(n=!0,t.unloadNode(o,e,!0)?r.add(o.referenceId):d=!0)),d?a():o.setInLoaded(!1)}else a(),s()}),n&&this.onReferenceUnloaded()},d.prototype.computeNodesCollidingWithBox=function(e){var t,n,i=[];i=(i=i.concat(this.nodes)).concat(this.newNodes);var r=e.getBoundingSphere(),o=new a.Sphere,s=[],d=[];for(t=0;t<i.length;t++)(n=i[t]).isCollidingWithBox(e,r,o,s)&&d.push(n.referenceId);return d},d}),define("DS/3DXMTiles/OOCManagerRootEntry",["DS/3DXMTiles/LDHReference"],function(e){"use strict";var t=function(e,t,n,i){this.occurrence=e,this.boundingBox=t&&t.clone(),this.enableExpand=!0,this.treeModified=!1,this.elasticLoading=!1,this.rootId=n,this.onLoadedCB=i||null,this.visible=!0};return t.prototype.computeSceneMin=function(){var e=this.boundingBox.clone();return e.applyMatrix4(this.occurrence.matrix),e.min.z},t}),define("DS/3DXMTiles/LDHModel3DHandler2",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHRepresentationLoader","DS/3DXMTiles/LDHReferenceStatus","DS/WAFData/WAFData","DS/3DXMTiles/CopyViscaURLServices","DS/3DXMTiles/LDHReference","DS/3DXMTiles/LDHReferenceRep","DS/3DXMTiles/LDHStats"],function(e,t,n,i,r,o,s,a){"use strict";var d=function(e,t){this.references=e,this.nbRedirected=0,this.context=t,this.okReferences=[],this.koReferences=[]};d.prototype.addOkReference=function(e){var t=e.getReference();this.okReferences.push(t)},d.prototype.addKoReference=function(e){var t=e.getReference();this.koReferences.push(t)},d.prototype.isComplete=function(){return this.okReferences.length+this.koReferences.length>=this.references.length};var l=function(e,t,n){this.batch=e,this.index=t,this.newURL=n,this.newType=null};l.prototype.getUrl=function(){return this.batch.references[this.index].getActiveRepresentation().url},l.prototype.getReference=function(){return this.batch.references[this.index]};var h=function(t){e.call(this,e.Model3DHandler),this.fileType=null,this.redirectUrlCB=null,this.loadModelOptions=null,this.batches=[],this.toLoad=[],this.debug=!!t.debug,this.urlPostProcessCB=t.urlPostProcessCB||null,this.manager=null,this.minBatchSize=40,this.maxTickets=t.batchSize||100,this.maxRedirectTickets=t.redirectBatchSize||40,this.tickets=this.maxTickets,this.redirectTickets=this.maxRedirectTickets,this.nbLoadReferenceTickets=20,this.pauseInterval=null,this.getSecurityParamsCB=t.getSecurityParamsCB||null,this.autoRedirect=!1,this.urlServices=new r,this.debugLoadModelDelay=0,this.debugLockedReferences=null,this.debugModelLoaded=null};(h.prototype=Object.create(e.prototype)).setFileType=function(e){this.fileType=e},h.prototype.setRestricted=function(){this.minBatchSize=2,this.maxTickets=2,this.maxRedirectTickets=2,this.tickets=this.maxTickets,this.redirectTickets=this.maxRedirectTickets},h.prototype.isReady=function(){return this.tickets>=this.minBatchSize},h.prototype.setLoadModelOptions=function(e){this.loadModelOptions=e},h.prototype.redirectNeeded=function(){return!this.autoRedirect&&window.WUXForceAutoRedirect&&this.setAutoRedirect(!0),!(!this.redirectUrlCB&&!this.autoRedirect)},h.prototype.handleReferences=function(e,t){if(this.debugLoadModelDelay){var n=this;setTimeout(function(){n.handleReferences_internal(e,t)},this.debugLoadModelDelay)}else this.handleReferences_internal(e,t)},h.prototype.handleReferences_internal=function(e,t){if(this.debugLockedReferences){var n=[];for(r=0;r<e.length;r++)this.debugLockedReferences.indexOf(e[r].referenceId)>=0&&(n.push(e[r]),e[r]=null);var i=0;for(r=0;r<e.length;r++)null!==e[r]&&(e[i]=e[r],i++);e.length=i,n.length&&setTimeout(this.handleReferences.bind(this,n,t),100)}this.manager=t.manager._ldhNodeManager;var r,o,s,h=new d(e,t);if(this.batches.push(h),a.onStartBatch(e.length),this.incTickets(-e.length),!this.redirectNeeded()||this.urlPostProcessCB){for(r=0;r<h.references.length;r++){s=(o=h.references[r]).getActiveRepresentation();let e=this.urlPostProcessCB?this.urlPostProcessCB(o,s.url):s.url;this.toLoad.push(new l(h,r,e))}this.loadModels()}else this.redirectUrls()},h.prototype.redirectUrls=function(){if(this.redirectTickets>0){var e,t,n,i,r=[],o=[];for(e=0;e<this.batches.length;e++)for(i=(t=this.batches[e]).nbRedirected;this.redirectTickets>0&&i<t.references.length;i++)t.nbRedirected++,(n=new l(t,i,null)).getUrl()?(r.push(n),o.push(n.getUrl()),this.incRedirectTickets(-1)):this.toLoad.push(n);if(r.length>0){var s=this;this.incRedirectTickets(-this.redirectTickets),this.doRedirectUrls(o,function(e,t,n){var i;for(s.incRedirectTickets(-s.redirectTickets+s.maxRedirectTickets),i=0;i<e.length;i++){if(r[i].newURL=e[i],t&&(r[i].newType=t[i]),n&&n[i])r[i].batch.references[r[i].index].getActiveRepresentation().updateUrl(n[i]);s.toLoad.push(r[i])}s.redirectUrls(),s.loadModels()})}}},h.prototype.doRedirectUrls=function(e,t){this.redirectUrlCB&&!this.autoRedirect?this.redirectUrlCB(e,t):this.autoRedirectUrl(e,t)},h.prototype.loadModels=function(){if(!this.manager.getPauseLoading())return this.loadModels_internal();if(!this.pauseInterval){var e=this;this.pauseInterval=setInterval(function(){e.manager.getPauseLoading()||(clearInterval(e.pauseInterval),e.pauseInterval=null,e.loadModels_internal())},100)}},h.prototype.loadModels_internal=function(){var e;for(this.debug&&t.setDebug(!0);this.nbLoadReferenceTickets>0&&this.toLoad.length>0;)(e=this.toLoad.shift()).newURL?(this.nbLoadReferenceTickets--,t._loadModel(e.newURL,e.getReference(),this.onModelLoaded.bind(this,e),this.onModelError.bind(this,e),null,this.fileType,this.loadModelOptions,this.manager)):setTimeout(this.onModelError.bind(this,e),1)},h.prototype.onModelLoaded=function(e,t){this.incTickets(1),this.nbLoadReferenceTickets++;var n,i=e.batch,r=i.context;n=e.getReference(),this.debugModelLoaded&&this.debugModelLoaded(n);var o=n.getActiveRepresentation();e.newType&&"av1"===e.newType.toLowerCase()&&(o.type=s.RepType.av1),this.commitModelLoadedTransaction(n,r.manager,t),r.doneCB([n],[]),i.isComplete()&&this.onBatchComplete(i),this.loadModels()},h.prototype.onModelError=function(e){this.incTickets(1),this.nbLoadReferenceTickets++;var t,n=e.batch,i=n.context;t=e.getReference(),i.manager._startModelLoaderTransaction(),i.manager._onRepLoaded(t),i.manager.endInstRefGraphTransaction(),i.doneCB([],[t]),n.isComplete()&&this.onBatchComplete(n),this.loadModels()},h.prototype.onBatchComplete=function(e){a.onEndBatch(e.references.length);var t=this.batches.indexOf(e);this.batches.splice(t,1);e.context,e.okReferences;e.references=[],e.okReferences=[],e.koReferences=[]},h.prototype.getModelLoader=function(){return t.modelLoader},h.prototype.getBatchSize=function(){return this.tickets},h.prototype.setRedirectUrlCB=function(e){this.redirectUrlCB=e},h.prototype.setAutoRedirect=function(e){this.autoRedirect=!!e},h.prototype.incTickets=function(e){this.tickets+=e},h.prototype.incRedirectTickets=function(e){this.redirectTickets+=e},h.prototype.autoRedirectUrl=function(e,t){this._fcsFileurls({urls:e,callbacks:{onComplete:function(e,n){if(e){var i,r,o=[],s=[],a=[];for(i=0;i<e.length;i++)r=n[i],void 0!==e[i].checksum?(o[r]=e[i].url,s[r]=e[i].type,a[r]=e[i].updatedAccessUrl):0===e[i].status?(o[r]=e[i].fileurl,s[r]=null):o[r]=null;t(o,s,a)}},onFailure:function(n){for(var i=[],r=0;r<e.length;r++)i.push(null);t(i)}}})},h.prototype._fcsFileurls=function(e){var t;var n=function(e){var t={},n=document.createElement("a");n.href=e;for(var i,r=n.search.substring(1).split("&"),o=0;o<r.length;o++){var s=r[o].split("="),a=s[0];"boid"===a&&(a="id"),t[a]=(i=s[1],decodeURIComponent((i+"").replace(/\+/g,"%20")))}return t},i=[],r=0,o=[];function s(t,n){r--,i=i.concat(t),o=o.concat(n),0===r&&e.callbacks.onComplete(i,o)}var a,d,l=[],h=[],u={data:[],onComplete:function(e){try{s(UWA.is(e,"object")?e:JSON.parse(e),l)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}},p={data:[],onComplete:function(e){try{s((UWA.is(e,"object")?e:JSON.parse(e)).files,h)}catch(e){console.warn("Error while parsing results")}},onFailure:function(t){e.callbacks.onFailure(t)}},f=null,g=[];for(t=0;t<e.urls.length;t++)if(a=e.urls[t],this.isViscaUrl(a)){if(this.urlServices)g.push(a);else{if(d=n(a),!f){var m=a.toLowerCase().indexOf(c.rep.urlLower);f=m>=0?a.substring(0,m)+c.reps.url:"##error##"}p.data.push(d)}h.push(t)}else(d=n(a)).id&&d.format&&d.filename&&u.data.push(d),l.push(t);u.data.length&&(r++,this.fileurls(u)),p.data.length&&(r++,this.reps(p,f)),g.length>0&&(r++,this.viscaQuery(g,p))};var c={getfcsurls:{url:"/resources/enopad/getfcsurls",verb:"POST"},fileurls:{url:"/resources/fcsservices/fcs/fileurls",verb:"POST"},reps:{url:"/api/V1/reps",verb:"POST"},rep:{url:"/api/V1/rep",urlLower:"/api/v1/rep",verb:"POST"}};return h.prototype.isViscaUrl=function(e){var t=e.toLowerCase(),n=t.indexOf("-visca.");if(n>=0&&n<t.indexOf("?"))return!0;return!1},h.prototype.buildDataWithGoodNames=function(e,t){var n,i={};for(n in e)i[e[n]]=t[n];return i},h.prototype.reps=function(e,t){var n,i={s:"source",t:"tenant",id:"boid",f:"filename",v:"version",ts:"timeStamp",type:"repType",sgn:"signature"};for(n=0;n<e.data.length;n++)e.data[n]=this.buildDataWithGoodNames(i,e.data[n]);return e.data=JSON.stringify(e.data),e.method="POST",e.headers={Accept:"application/json","Content-Type":"application/json"},this.finalExecuteRequest(t,e)},h.prototype.fileurls=function(e){var t,n=this.getSecurityParamsCB(),i=e;return t="onPremise"===n.tenant?n.service3DSpaceUrl+c.fileurls.url:n.service3DSpaceUrl+c.fileurls.url+"?tenant="+n.tenant,i.method=c.fileurls.verb,i.headers={Accept:"application/json","Content-Type":"application/json"},i.data=JSON.stringify(i.data),this.executeRequest_fileurls(t,i,void 0,void 0,n)},h.prototype.executeRequest_fileurls=function(e,t,n,i,r){var o=r.securityCtx?r.securityCtx:"preferred";return UWA.is(o,"string")&&!0!==n&&(t.headers.SecurityContext=o),this.finalExecuteRequest(e,t)},h.prototype.viscaQuery=function(e,t){var n=this.getSecurityParamsCB(),i=n.securityCtx?n.securityCtx:"preferred",r=this.urlServices.CreateBatchURLAndBody(e,{allowPartial:!0,fallback:!0});t.data=r.body,t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:i};var o=r.url.replace("//api","/api");return this.finalExecuteRequest(o,t)},h.prototype.finalExecuteRequest=function(e,t){return i.authenticatedRequest(e,t)},h}),define("DS/3DXMTiles/OOCModel3DHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHModel3DHandler2","DS/3DXMTiles/LDHBatchModel3DHandlerVISCA","DS/3DXMTiles/LDHStats","DS/3DXMTiles/LDHBatchModel3DHandlerVISCANoStream","DS/QualityManager/QMController","DS/3DXMTiles/LDHHandlerMultiple","DS/3DXMTiles/LDHBatchModel3DHandlerBank","DS/3DXMTiles/LDHBatchModel3DHandlerDOS"],function(e,t,n,i,r,o,s,a,d){var l=function(l){l=l||{};var h=window.OOCBatchMode||window.localStorage.getItem("OOCBatchMode"),c=o.getBatching();h?c="ON"===h:void 0!==l.batching&&(c=!!l.batching),void 0!==l.useBank?bankMode=l.useBank:bankMode=!(navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&o.getLocalCache(),"ON"===window.localStorage.getItem("OOCBankMode")&&(bankMode=!0),bankMode&&(l.saveToBank=!0,l._dbg_no_batching||(c=!0)),window.OOCNoDashboard&&(c=!1);var u=null,p="ON"===(window.OOCLiveBatchUnstream||window.localStorage.getItem("OOCLiveBatchUnstream"));if(i.addFlag(c?p?"batching live":"batching":"no batching"),c){l.maxTicketSize=void 0!==l.maxTicketSize?l.maxTicketSize:20971520;var f=window.localStorage.getItem("OOCMaxTicketSize");f&&(f=parseInt(f));u=p?new n(l,12,40):new r(l,12,40)}var g=new d(l),m=new t(l);this.singleHandler=m;var S=u?[g,u,m]:[g,m];if(bankMode){S=[new a(l,40)].concat(S)}var y=new s({handlers:S,getSecurityParamsCB:l.getSecurityParamsCB});e.call(this,e.Model3DHandler,y)};return(l.prototype=Object.create(e.prototype)).setFileType=function(e){this.ldhHandler.setFileType(e)},l.prototype.setLoadModelOptions=function(e){this.ldhHandler.setLoadModelOptions(e)},l.prototype.getModelLoader=function(){return this.ldhHandler.getModelLoader()},l.prototype._dbg_getBatchHandler=function(){return this.ldhHandler.handlers[1]},l.prototype._dbg_getDOSHandler=function(){return this.ldhHandler.handlers[0]},l.prototype.setRedirectUrlCB=function(e){this.ldhHandler.setRedirectUrlCB(e)},l.prototype.setAutoRedirect=function(e){this.ldhHandler.setAutoRedirect(e)},l}),define("DS/3DXMTiles/LDHCandidateQueueRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/3DXMTiles/LDHCandidateListRenderer","DS/3DXMTiles/LDHOccurrence","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHReference","DS/Visualization/MaterialApplication"],function(e,t,n,i,r,o,s,a,d){"use strict";var l=function(t,i){this.manager=t,this.viewer=t.viewer,this.root=i||new n("CandidateQueueRenderer"),this.root.setRenderPasses(["main"]),this.viewer.addNode(this.root),this.displayIntermediateReferences=!1,this.preserveReferences=null,this.preserveSelection=!1,this.pickable=s.PICKABLE,this.attributes=[new h({dimension:2,color:new e.Color("red"),opacity:.1}),new h({dimension:1,color:new e.Color("black"),opacity:1})],this.repMaterial=null,this.repMaterialApplication=null,this.candidateListRenderers=[new r(this.root),new r(this.root)]};l.prototype.setPickable=function(e,t,n){this.pickable=e,this.root.setPickable(e),!t&&this.manager.isSlave()&&(this.removeSlaveBoxes(),this.displaySlaveBoxes(n))},l.prototype.setParams=function(e){e=e||{},this.repMaterial=null,this.repMaterialApplication=null,this.displayIntermediateReferences=!!e.displayIntermediateReferences,e.repRefAttributes&&this.attributes[0].setParams(e.repRefAttributes),e.refAttributes&&this.attributes[1].setParams(e.refAttributes)},l.prototype.dispose=function(){var e;for(e=0;e<this.candidateListRenderers.length;e++)this.candidateListRenderers[e].dispose();this.root=null},l.prototype.addNodeList=function(e,t,n){var i,r;for(i=0;i<e.length;i++)r=e[i],this.shouldDisplayReference(r,n)&&t.references.push(r)},l.prototype.shouldDisplayReference=function(e,t){var n=e.getNode();if(1===e.handler.type&&e.isRoot)return!0;if(a.slaveBoxFix){if(!n&&e.getLODValue(t)>0)return!0}else if((!n||e.isSlave()&&0===n.children.length)&&e.getLODValue(t)>0)return!0;return!!(this.preserveReferences&&this.preserveReferences.indexOf(e)>=0)},l.prototype.getNodesFromQueue=function(e,t){var n,i,r=[];for(n=0;n<e.nodes.length;n++)i=e.nodes[n],t?0===i.children.length&&r.push(i):i.isLoaded()||r.push(i);return r},l.prototype.getCandidateRoots=function(){return this.manager.getCandidateRoots()},l.prototype.updateRepresentation=function(e,t){var n=this.manager;if(!a.slaveBoxFix||n.isOOC()){var i,r,o,s=[];for(i=0;i<this.candidateListRenderers.length;i++)-1===(o=this.attributes[i]).clusters&&(r=this.candidateListRenderers[i],this.preserveSelection?s.push(r.createSelectionRestoringData()):s.push(null),r.references=[]);for(i=0;i<this.candidateListRenderers.length;i++){if(o=this.attributes[i],r=this.candidateListRenderers[i],this.displayIntermediateReferences||0===i){var d=n.queues[i],l=0===i?this.getNodesFromQueue(d,1===i):this.getCandidateRoots();this.addNodeList(l,r,t),r.updateRepresentation(o,e)}-1===o.clusters&&s[i]&&r.restoreSelection(s[i])}}},l.prototype.getPathFromPathElement=function(e){var t,n;for(t=0;t<this.candidateListRenderers.length;t++)if(n=this.candidateListRenderers[t],e.externalPath.indexOf(n.node)>=0){var i=n.getOccurrenceFromInstanceId(e.instanceId),r=null;if(i&&i instanceof o)for(r=[];i;)r.unshift(i.reference.referenceId),i.parent&&r.unshift(i.instanceData.instanceId),i=i.parent;return r}return null},l.prototype.getReferenceFromPathElement=function(e){var t,n;for(t=0;t<this.candidateListRenderers.length;t++)if(n=this.candidateListRenderers[t],e.externalPath.indexOf(n.node)>=0){var i=n.getOccurrenceFromInstanceId(e.instanceId);if(i)return i instanceof o?i.reference.referenceId:n.getReferenceFromOccurrence(i)}return null},l.prototype.clearClusters=function(){var e;for(e=0;e<this.candidateListRenderers.length;e++)this.candidateListRenderers[e].clearClusters()},l.prototype.displaySlaveBoxes=function(e){var t,n,i=this.manager,r=this.getNodesFromQueue(i.queues[0],!1);for(t=0;t<r.length;t++)(n=r[t]).getLODValue(e)>0&&n.displayBox(i)},l.prototype.removeSlaveBoxes=function(){var e,t=this.manager,n=t.queues[0].nodes;for(e=0;e<n.length;e++)n[e].removeBox(t)},l.prototype.getRepMaterial=function(){var t;return null===this.repMaterial&&(t=this.attributes[0],this.repMaterial=new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,transparent:t.opacity<1,force:!0})),this.repMaterial},l.prototype.getRepMaterialApplication=function(){return null===this.repMaterialApplication&&(this.repMaterialApplication=new d({faceMaterial:this.getRepMaterial(),layer:-1/0})),this.repMaterialApplication};var h=function(e){this.color=e.color.clone(),this.opacity=e.opacity,this.dimension=e.dimension,this.clusters=e.clusters||-1,this.count=e.count||0};return h.prototype.setParams=function(e){e.color&&(this.color=e.color.clone()),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.dimension&&(this.dimension=e.dimension),void 0!==e.clusters&&(this.clusters=e.clusters||-1),void 0!==e.count&&(this.count=e.count||0)},l}),define("DS/3DXMTiles/LDHUserQueue",["DS/3DXMTiles/PriorityQueue"],function(e){"use strict";var t=function(t,n){this.queue=new e,this.handler=t,this.manager=n};return t.prototype.addNode=function(e){this.queue.addNode(e)},t.prototype.computeOrder=function(e){var t,n;for(this.queue.resetOrder(),t=0;t<this.queue.nodeListLength;t++)!(n=this.queue.nodeList[t])||!n.isAlive()||n.isInList()&&n.needScreenRadiusSizeComputation()||n.updateNodeLOD(e)},t.prototype.handleViewpointChange=function(e){this.computeOrder(e)},t.prototype.traverseQueue=function(){var e=this.handler,t=[],n={doneCB:this.onHandlerDone.bind(this)};this.queue.traverseMax(function(i){return!i.isAlive()||!!(i._screenRadius>=0&&e.isReady())&&(t.push(i.referenceId),t.length>=e.getBatchSize()&&(e.handleReferences(t,n),t=[]),!0)}),t.length>0&&(e.handleReferences(t,n,this.queue.isEmpty()),t=[]),this.queue.isEmpty()&&this.manager.removeUserQueue(this.handler)},t.prototype.onHandlerDone=function(){this.manager.requestUpdate(!1,!1)},t}),define("DS/3DXMTiles/MassiveOcclusionChecker",["DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ComposerContext","DS/3DXMTiles/InstancingFactory","DS/Plugins/EffectComposer","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/ClippingContext"],function(e,t,n,i,r,o,s,a,d,l){"use strict";var h=function(e,t,n){this.id=n,this.occurrenceIndex=-1,this.box=e,this.matrices=t,this.clippingContext=null},c=-1;h.prototype.fillInstancingParams=function(t,n){var i,r=new e.Color(n?0:this.id+1),o=this.matrices;for(i=0;i<o.length;i++)t.matrices.push(o[i]),t.boxes.push(this.box),t.colors.push(r)};var u=new e.Box3;h.prototype.isContainingPoint=function(e){var t;for(t=0;t<this.matrices.length;t++)if(u.copy(this.box),u.applyMatrix4(this.matrices[t]),u.containsPoint(e))return!0;return!1},h.prototype.addDebugBoxes=function(t){var n,i,r=this.matrices;for(i=0;i<r.length;i++)(n=a.createCuboidNodeFromBox3(this.box,e.MaterialUtils.createShinyFaceMaterial({color:"red",force:!0}))).setMatrix(this.matrices[i]),t.addChild(n)};var p=-1,f=function(r){-1===c&&(c=!!window.OOCDebugOcclusionChecker),this.ldhNodeManager=r.ldhNodeManager||null,this.viewer=r.viewer,this.debugId=-1,this.renderer=this.viewer.renderer.renderer,this.renderTargetPool=this.viewer.renderer.renderTargetPool,this.ratio=r.ratio||1,this.only=-1,this.renderList=r.renderList||"main",this.discoveryTarget=0,this.scoreTarget=1;this.composer=new o(this.renderer,void 0,this.renderTargetPool,["--\x3e(main)","clearPass","occlusionPass"]),this.clearPass=new t("clearPass"),this.clearPass.clearColor=new e.Color("black"),this.clearPass.clearAlpha=1,this.occlusionPass=new n(null,null,null,null,null,null,"occlusionPass"),this.occlusionPass.disableToneMapping=!0,this.width=Math.ceil(this.ratio*this.viewer.renderer.viewportWidth),this.height=Math.ceil(this.ratio*this.viewer.renderer.viewportHeight),this.lastBufferSize=0,this.lastBuffer=null;var s=new e.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.occlusionComposerContext=new i(s,this.composer,"occlusionComposerContext"),this.occlusionComposerContext.keepResult=!0,this.composer.addPass(this.clearPass),this.composer.addPass(this.occlusionPass),this.boxes=[],this.occurrenceCount=0,this.visibilitySet=new Set,this.depthBuffer=null,this.debugInput=!1,this.scene=new e.Scene,this.material=new e.MeshBasicMaterial({color:"red",force:!0,side:e.DoubleSide}),this.alwaysVisibleIds=[],this.idsToHideSet=new Set,this.idsToHide=[],this.occurrencesToHide=[],this.idsToShowSet=new Set,this.idsToShow=[],this.occurrencesToShow=[],this.mesh=null,this.nextId=0,this.nbProcessedBoxes=0,this.idToReference=new Map,this.scores=[],this.needUpdateIdsTable=!1,this.dbgPng=[]};return f.prototype.dispose=function(){if(this.idToReference.forEach(function(e,t){e.occlusionId=-1}),this.idToReference=null,this.occlusionComposerContext.keepResult=!1,this.occlusionComposerContext.releaseRenderTargets(this.renderTargetPool,"main"),this.occlusionComposerContext.keepResult=!0,this.boxes=[],this.material.dispose(),this.material=null,this.mesh){var e=this.mesh._occurrences[0].renderable;this.viewer.renderer.renderer.__glResources__.removeGeometryList([e])}this.scene.dispose(),this.scene=null,this.mesh=null},f.prototype.hasReference=function(e){return e.occlusionId>=0&&this.idToReference.has(e.occlusionId)},f.prototype.addReference=function(e){this.idToReference.set(e.occlusionId,e)},f.prototype.hideReference=function(e){this.hasReference(e)&&this.hideId(e.occlusionId)},f.prototype.hideId=function(e){this.idsToHideSet.add(e),this.idsToShowSet.delete(e),this.needUpdateIdsTable=!0},f.prototype.updateIdsTables=function(){this.disabled=!1,this.idsToHide=[],this.idsToShow=[],this.occurrencesToHide=[],this.occurrencesToShow=[];var e=this;this.idsToHideSet.forEach(function(t){e.idsToHide.push(t);var n,i=e.boxes[t];if(i.occurrenceIndex>=0)for(n=0;n<i.matrices.length;n++)e.occurrencesToHide.push(i.occurrenceIndex+n),e.occurrencesToHide.push(i.id+1)}),this.idsToShowSet.forEach(function(t){e.idsToShow.push(t);var n,i=e.boxes[t];if(i.occurrenceIndex>=0)for(n=0;n<i.matrices.length;n++)e.occurrencesToShow.push(i.occurrenceIndex+n),e.occurrencesToShow.push(i.id+1)})},f.prototype.showReference=function(e){if(this.hasReference(e)){var t=e.occlusionId;this.idsToShowSet.add(t),this.idsToHideSet.delete(t),this.needUpdateIdsTable=!0}},f.prototype.clear=function(){this.boxes=[]},f.prototype.addBox=function(e,t){if(this.disabled=!1,!(t instanceof Array))throw new Error("invalid argument");var n=this.boxes.length,i=new h(e,t,n);return this.boxes.push(i),n},e.WebGLRenderTarget.prototype.readPixels=function(e){e.setRenderTarget(this),null!==this.lastBuffer&&this.lastBufferSize===this.width*this.height||(this.lastBuffer=new Uint8Array(4*this.width*this.height),this.lastBufferSize=this.width*this.height);var t=this.lastBuffer,n=e.getContext();return n.readPixels(0,0,this.width,this.height,n.RGBA,n.UNSIGNED_BYTE,t),t},f.prototype.getVisibility=function(e){return this.visibilitySet.has(e)},f.prototype.getVisibleReferences=function(){var e=[],t=this;return this.visibilitySet.forEach(function(n){var i=t.idToReference.get(n);i?e.push(i):console.log("problem")}),e},f.prototype.buildNode=function(e,t){return this.boxes[e].buildNode(t)},window.myOcclusion=[],window.myReferences=[],f.prototype.computeDepthBuffer=function(){var e,t=this.viewer.renderer,n=t.renderer.getContext(),i=this.viewer.internalSceneGraph.scene,r=this.viewer.internalSceneGraph,o=i.defaultRenderList;return i.defaultRenderList="ooc",e=t.renderOcclusionRealDepth("main",i,n,{main:this.viewer.currentViewpoint.camera},"main",!1,r),i.defaultRenderList=o,e},f.prototype.computeVisibility=function(){if(this.needUpdateIdsTable&&(this.updateIdsTables(),this.needUpdateIdsTable=!1),this.visibilitySet=new Set,!this.disabled){this.depthBuffer=this.computeDepthBuffer();var e,t,n,i,o=this.boxes,a=(window.performance.now(),null!==this.viewer.getSceneBoundingSphere(void 0,!0)),d={matrices:[],boxes:[],colors:[],material:this.material,useDBuffer:a,viewer:this.viewer,depthBuffer:this.depthBuffer},l=this.viewer.currentViewpoint.camera;for(e=this.nbProcessedBoxes;e<o.length;e++)n=(t=o[e]).id,l.isOrtho||!t.isContainingPoint(l.position)?(o[e].fillInstancingParams(d,this.idsToHide.indexOf(n)>=0||this.only>=0&&e!==this.only),t.occurrenceIndex=this.occurrenceCount,this.occurrenceCount+=t.matrices.length):this.alwaysVisibleIds.push(e);for(this.nbProcessedBoxes=o.length,e=0;e<this.alwaysVisibleIds.length;e++)i=this.alwaysVisibleIds[e],this.visibilitySet.add(i),this.scores[i]=1/0;if(this.debugInput){var h=new s;for(this.viewer.addNode(h),e=0;e<o.length;e++)t=o[e],(this.only<0||e===this.only)&&t.addDebugBoxes(h)}for(var u,p=!1,f=0,g=[],m=(this.idToReference,o=this.boxes,!0);!p;)this.compute(d,this.occurrencesToHide,g,this.occurrencesToShow,m),(u=this.visibilitySet.size-this.alwaysVisibleIds.length)===f||u>=this.discoveryTarget||u>=this.boxes.length?p=!0:(this.visibilitySet.forEach(function(e,t){var n,i=o[e];if(i.occurrenceIndex>=0)for(n=0;n<i.matrices.length;n++)g.push(i.occurrenceIndex+n),g.push(i.id+1)}),d={matrices:[],boxes:[],colors:[],material:this.material,useDBuffer:a,viewer:this.viewer,depthBuffer:this.depthBuffer}),f=u,m=!1,0;if(g.length>0){var S=this.mesh;r.updateInstancingBox({mesh:S,instancingParams:d,indexesToHide:[],indexesToHideTmp:[],indexesToShow:g})}0===u&&(this.disabled=!0),c&&window.myOcclusion.push(this.buildPNG())}},f.prototype.compute=function(t,n,i,o,s){this.scores=[];var a=this.scene,h=this.mesh;if(h)r.updateInstancingBox({mesh:h,instancingParams:t,indexesToHide:n,indexesToHideTmp:i,indexesToShow:o});else{(h=r.buildInstancingBox(t)).setVisibilityFree(!0);var u=h._occurrences[0].renderable;a.add(u),this.mesh=h}let f=this.ldhNodeManager&&this.ldhNodeManager.getClippingPlanes();if(f){var g=this.mesh._occurrences[0];g.occurrenceRenderingOverride||(g.occurrenceRenderingOverride=new d),this.clippingContext||(this.clippingContext=new l(f)),this.clippingContext.setPlanes(f),g.occurrenceRenderingOverride.clipPlanes=f,g.occurrenceRenderingOverride.clippingContext=this.clippingContext,g.renderable.occurrenceRenderingOverride=g.occurrenceRenderingOverride,this.renderer.clipPlanes=[];let e,t,n=this.renderer;for(t=0;t<f.length;t++)(e=f[t]).clippingContext||(e.clippingContext={}),e.clippingContext[n.id]||(e.clippingContext[n.id]={}),e.clippingContext[n.id].clippingPlaneAdded=!0,this.renderer.clipPlanes.push(e)}var m={main:this.viewer.currentViewpoint.camera};this.composer.updateScene(a),this.renderer.materialToUse=e.MaterialToUse.originalMaterial,this.composer.setComposerContext(this.occlusionComposerContext);window.performance.now();this.composer.render(void 0,void 0,m,"main");window.performance.now();for(var S,y,v=this.viewer,M=this.composer.getRenderResult("main").readPixels(v.renderer.renderer),L=(window.performance.now(),this.width),T=this.height,D=[],C=this.scoreTarget,R=0;R<T;R++)for(var b=0;b<L;b++){var x=4*(b+(T-R-1)*L);(S=(M[x]<<16)+(M[x+1]<<8)+M[x+2]-1)>=0&&(0,y=this.scores[S]?this.scores[S]+1:1,this.scores[S]=y,y===C&&(this.visibilitySet.add(S),c&&D.push(this.idToReference.get(S)),!0,0))}c&&window.myReferences.push(D),-1===p&&(p=Date.now())},f.prototype.buildPNG=function(){var e,t=this.viewer,n=this.composer.getRenderResult("main").readPixels(t.renderer.renderer),i=this.width,r=this.height,o=document.createElement("canvas");o.width=i,o.height=r;for(var s=o.getContext("2d"),a=s.createImageData(i,r),d=a.data,l=0;l<a.height;l++)for(var h=0;h<a.width;h++){var c=h+l*i,u=h+(r-l-1)*i;d[4*c]=n[4*u]?256-n[4*u]:0,d[4*c+1]=n[4*u+1]?256-n[4*u+1]:0,d[4*c+2]=n[4*u+2]?256-n[4*u+2]:0,d[4*c+3]=n[4*u+3]}return s.putImageData(a,0,0),e=o.toDataURL(),window.myDataURL=e,e},f}),define("DS/3DXMTiles/LDHNodeManager",["DS/3DXMTiles/LDHNodeManagerQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/3DXMTilesUtils","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/LDHUserQueue","DS/3DXMTiles/LDHCandidateQueueRenderer","DS/3DXMTiles/LDHLoadingBoxManager","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/3DXMTiles/MassiveOcclusionChecker","DS/3DXMTiles/LDHStats","DS/Visualization/BufferGPUManager","DS/VisuTools/FPSCounter","DS/3DXMTiles/DSTilesManager","DS/VisuTools/OOCReplay","DS/3DXMTiles/ModelBank"],function(e,t,n,i,r,o,s,a,d,l,h,c,u,p,f,g,m,S,y){"use strict";var v="ON"===window.localStorage.getItem("OOCPerfo"),M=function(n){p.init(),f.initAtLoading=!0,f.fillMapGeomBufferSize=!0,v&&(g.setAutoRefresh(!1),n.viewer.showPerfo(!0,!1)),this.getServiceUrlCB=n.getServiceUrlCB||null,this.tilesQueueSuperUpdate="OFF"!==localStorage.getItem("DSTilesSuperUpdate"),this.forceClientBox="ON"===localStorage.getItem("OOCClientBox"),this.enableUnload=void 0===window.OOCEnableUnload||window.OOCEnableUnload,this.viewer=n.viewer,this.bsNode=new c("ooc_bsNode"),this.bsNode.setVisibilityFree(!0),this.viewer.addNode(this.bsNode),this.fullVPToken=null,this.fullVPLoading=0,this.forceSceneMin=n.forceSceneMin,this.newLoadingBoxes=!!n.newLoadingBoxes,void 0!==n.maxNbBoxes&&(d.maxNbBoxes=n.maxNbBoxes);var i=this;this.alreadyCalledFullVP=!1,this.onViewpointMoveToken=this.viewer.currentViewpoint.onMove(function(){i.onViewpointMove()}),this.onSwapVisibleSpaceToken=this.viewer.onSwapVisibleSpace(function(){setTimeout(function(){i.onViewpointMove()},200)}),this.progressiveExpand=!!n.progressiveExpand,this.queues=[new e(t.Model3DHandler,this),null,new e(t.TileSetHandler,this)],this.progressiveExpand&&(this.queues[1]=new e(t.InstRefHandler,this),this.queues[1].enableOcclusionTest=!1),this.queues[2].enableOcclusionTest=!1,S.download&&S.recording&&this.disableOcclusionTest(),this.requestUpdateToken=null,this.fullVPPending=!1,this.updateOptions={viewpointChanged:!1},this.viewpointHasChanged=!0,this.targetNode=null,this.requestUpdate(!0,!0),this.unloadManager=new r(n.config,n.meshInRAM,n.oocManager),this.tilesManager=new m(this,n.config),this.previousIsLoading=!1,this.defaultLoadingCBToken={},this.onStartLoadingCBMap=new Map,this.onEndLoadingCBMap=new Map,this.suspendedReferenceActions=[],this.debugThrottle=0,this.pauseLoadingMap=new Map,this.oocManager=n.oocManager,this.viewpointTag=0,this.debugMissingExpectedNbChildren=!!window.debugMissingExpectedNbChildren,this.unloadSmallNodesEnabled=!0,this.unloadLeafReferenceCB=null,this.onLeafReferenceLoadedCB=null,this.pauseLoadingDuringViewpointMove=!0,this._dbg_freezeViewpointTag=!1,this.overrideSetManager=null,this.overrideSetMap={},this.lastQueueRendererUpdateTime=0,this.queueRenderer=null,this.userQueues=[],this.rootAdded=!1,this.lastDeltaTime=-1,this.startLoadTime=null,this.hasUnloadedSmallNodes=!1,this.emergencyUnloadOccured=!1,this.emergencyUnloadAvoided=!1,this.instRefTransactionCPUMemoryFullOccurred=!1,this.boundingSphere=new h.Sphere,this.viewer.onPreRender(this.onPreRender.bind(this)),this.occlusionTestEnabled=void 0===n.enableOcclusionTest||n.enableOcclusionTest,this.occlusionTestEnabled||(this.queues[0].enableOcclusionTest=!1),this.fullVPHandler=null,this.switchRepresentationBuffer=new Map,this.globalMeshInRAMCounter=0,this.needGlobalSwitchNoMeshInRAM=!1,this.switchNoMeshInRAMReferences=new Set,this.loadingReferencesToSwitchToNoMeshInRAM=new Set,this.occlusionChecker=null,window.oocLDHNodeManager=this,this.needsOcclusion=!1,this.updateLoadingBoxesRequested=!1,this.tileSetMap=new Map,this.disableFullVP=!1,this.fullVPScreenRadius=0,this.loadingReferencesFromBox=0,this.waitForBankVpMoveToken=null,this.waitForBankFullVpToken=null,this.waitForBankRequestUpdate=null};M.prototype.registerTileSets=function(e,t){this.tileSetMap.set(e,t)},M.prototype.removeTileSets=function(e){var t,n=this.tileSetMap.get(e);for(this.tileSetMap.delete(e),t=0;n&&t<n.length;t++)this.tilesManager.removeTileSet(n[t])},M.prototype.getTileSets=function(e){let t=this.tileSetMap.get(e);if(!t&&0===e.parents.length&&1===e.children.length){let n=e.children[0].reference;t=this.tileSetMap.get(n)}return t||null},M.prototype.onSceneChange=function(){this.needsOcclusion=!0},M.prototype.isSlave=function(){return this.oocManager.isSlave()},M.prototype.isOOC=function(){return this.oocManager.isOOC()};var L=function(e,t){this.references=e,this.callback=t};function T(e,t,n,i){this.viewpoint=e,this.cst=t,this.bsRadius=n?n.radius:0,this.pixelCulling=Math.min(i.getPixelCulling("static"),i.getPixelCulling("dynamic"))}M.prototype.setUnloadSmallNodesEnabled=function(e){this.unloadSmallNodesEnabled=e},M.prototype.onPreRender=function(e){if(this.queues[0].renderingOccured=!0,e.viewpoint==this.viewer.currentViewpoint&&this.updateLoadingBoxesRequested){var t=this.createViewpointData(this.viewer.currentViewpoint);this.updateCandidateQueueRenderer(!1,t),this.updateLoadingBoxesRequested=!1}},M.prototype.tryBuildSceneGraphHierarchy=function(){var e,t=this.oocManager.getRootOccurrences(),n=[],i=this;for(t.forEach(function(e,t,r){e.occurrence.reference.tryBuildSceneGraphHierarchy(n,i)}),e=0;e<n.length;e++)n[e].updateOverride(this)},M.prototype.setPauseLoadingDuringViewpointMove=function(e){this.pauseLoadingDuringViewpointMove=e},M.prototype.tryToPerformReferenceAction=function(e,t){var n,i=!0;for(n=0;n<e.length;n++)e[n].isLoading()&&(i=!1);if(i){var r=this;return t.call(void 0,e,function(){r.requestUpdate(!0,!0)}),!0}return!1},M.prototype.executeReferenceAction=function(e,t){this.tryToPerformReferenceAction(e,t)||this.suspendedReferenceActions.push(new L(e,t))},M.prototype.setTargetNode=function(e){this.targetNode=e},M.prototype.registerTilesNode=function(e){if(this.alreadyCalledFullVP||this.onViewpointMove(),this.progressiveExpand||1!==e.handler.type){if(e._status!==i.loaded&&e._status!==i.loading&&e._status!==i.waiting&&e._status!==i.toUnload&&e._status!==i.toLoad&&e._status!==i.error)return;var t=e.handler;this.queues[t.type].registerNode(e),this.requestUpdate(!1,!1)}else this.fullVPHandler||(this.fullVPHandler=e.handler,this.onViewpointMove())},M.prototype.unregisterNode=function(e){if(!e.isAlive()){var t=e.handler,n=this.queues[t.type];n&&n.unregisterNode(e)}},M.prototype.forceUpdateNode=function(e){var t=e.handler;0===t.type&&(this.queues[t.type].forceUpdateNode(e),this.requestUpdate(!1,!1))},M.prototype.requestUpdate=function(e){if(this.updateOptions.viewpointChanged=this.updateOptions.viewpointChanged||e,null===this.requestUpdateToken){if(!y.initComplete)return void(null===this.waitForBankRequestUpdate&&(this.waitForBankRequestUpdate=setTimeout(()=>{this.waitForBankRequestUpdate=null,this.requestUpdate(!1)},10)));this.requestUpdateToken=setTimeout(this._updateNodes.bind(this),0)}},M.prototype._updateNodes=function(){l.startProbe("updateNodes");var e,t,n,i=this.createViewpointData(this.viewer.currentViewpoint);if(this.suspendedReferenceActions.length>0){for(e=0;e<this.suspendedReferenceActions.length;e++)n=this.suspendedReferenceActions[e],this.tryToPerformReferenceAction(n.references,n.callback)&&(this.suspendedReferenceActions[e]=null);this.suspendedReferenceActions=this.suspendedReferenceActions.filter(function(e){return null!==e})}null!==this.requestUpdateToken&&(clearTimeout(this.requestUpdateToken),this.requestUpdateToken=null),this.updateOccurrences();var r=this.viewer.isManipulatedViewpointMoving();if(this.pauseLoadingDuringViewpointMove&&r)return this.emergencyUnloadNodes(i),this.requestUpdate(!1,!1),void l.endProbe("updateNodes");var o=this.updateOptions.viewpointChanged;if(this.updateOptions.viewpointChanged=!1,this.viewpointHasChanged=this.viewpointHasChanged||o,S.recording&&this.viewpointHasChanged&&S.addViewointMove(this.viewer.currentViewpoint),this.viewpointHasChanged&&(this.hasUnloadedSmallNodes=!1,this.emergencyUnloadOccured=!1,this.emergencyUnloadAvoided=!1),(this.viewpointHasChanged||this.needsOcclusion)&&(this.occlusionChecker&&this.occlusionChecker.dispose(),this.occlusionChecker=null),this.clearMeshInRAMForLoadingReferences(),this.getPauseLoading()||2===this.debugThrottle)return this.updateUserQueues(this.viewpointHasChanged,i),this.checkAutoMeshInRAM(),this.emergencyUnloadNodes(i),this.updateLoadingStatus(),void l.endProbe("updateNodes");for(this.viewpointHasChanged&&!this._dbg_freezeViewpointTag&&this.viewpointTag++,!this.newLoadingBoxes&&this.viewpointHasChanged&&this.queueRenderer&&this.queueRenderer.clearClusters(),e=0;e<this.queues.length;e++)(t=this.queues[e])&&t.updateNodes(this.viewpointHasChanged,i);this.tilesManager.updateNodes(this.viewpointHasChanged,i),this.updateUserQueues(this.viewpointHasChanged,i),this.computeOcclusion(this.viewpointHasChanged||this.needsOcclusion),this.needsOcclusion=!1,this.checkAutoMeshInRAM(),this.enableUnload&&(this.unloadManager.isUnloadNeeded()&&this.removeMeshInRAMForUnload(),this.standardUnloadNodes(this.viewpointHasChanged,i),this.emergencyUnloadNodes(i)),this.debugThrottle<1&&(this.loadNodes(this.viewpointHasChanged,i),this.tilesManager.loadNodes(this.viewpointHasChanged,i)),this.viewpointHasChanged=!1,this.updateLoadingStatus(),this.updateLoadingBoxesRequested=!0,l.endProbe("updateNodes")},M.prototype.removeMeshInRAMForUnload=function(){if(this.needGlobalSwitchNoMeshInRAM)this.globalMeshInRAMSwitch(!1),this.needGlobalSwitchNoMeshInRAM=!1;else{var e=this,t=this.oocManager;this.switchNoMeshInRAMReferences.forEach(function(n){if(!t.isMeshInRAMRequested(n)){var i=t._getLDHReference(n,!0);i&&i.switchMeshInRAM(!1,e)}}),0!==this.switchNoMeshInRAMReferences.size&&(this.switchNoMeshInRAMReferences=new Set)}},M.prototype.onViewpointMove=function(){if(y.initComplete){if(this.requestUpdate(!0),this.startLoadTime=(new Date).getTime(),this.getPauseLoading()||this.requestFullVP(1e3),!this.getPauseLoading()&&this.tilesQueueSuperUpdate){var e=this.createViewpointData(this.viewer.currentViewpoint);this.tilesManager.updateNodes(!0,e),this.tilesManager.loadNodes(!0,e),this.updateLoadingStatus()}}else null===this.waitForBankVpMoveToken&&(this.waitForBankVpMoveToken=setTimeout(()=>{this.waitForBankVpMoveToken=null,this.onViewpointMove(this)},10))},M.prototype.forceFullVP=function(){this.requestFullVP(0)},M.prototype.requestFullVP=function(e){if(y.initComplete){if(!this.progressiveExpand&&!this.getPauseLoading()&&this.oocManager.hasActiveRoot()){var t=this;null!==t.fullVPToken&&(t.decFullVPLoading(),clearTimeout(t.fullVPToken),t.fullVPToken=null),this.incFullVPLoading(),this.fullVPToken=setTimeout(function(){t.fullVPToken=null,t.decFullVPLoading(),t.goFullVP()},e)}}else null===this.waitForBankFullVpToken&&(this.waitForBankFullVpToken=setTimeout(()=>{this.waitForBankFullVpToken=null,this.requestFullVP(e)},10))},M.prototype.getRootsToExpand=function(){var e=[];return this.oocManager.getRootOccurrences().forEach(function(t,n,i){(t.enableExpand||t.treeModified)&&(t.occurrence.reference.isLeaf()||e.push(t))}),e},M.prototype.getClippingPlanes=function(){let e=[];var t=this.oocManager.getRootOccurrences();t.forEach(function(t,n,i){let r=t.occurrence.reference.getNode(),o=r&&r._occurrences[0].clippingContext;o&&e.push(o)});let n=null;if(e.length>0&&e.length===t.size){let t;for(n=e[0].planes,t=0;t<e.length;t++){e[t];let i,r=e[t].planes;for(i=0;i<r.length;i++)if(r[i]!==n[i])return null}}return n},M.prototype.goFullVP=function(){var e=this.fullVPHandler;if(!this.progressiveExpand&&null!==e&&!this.getPauseLoading()&&this.debugThrottle<1&&!this.disableFullVP)if(p.onNewViewpoint(),e.isReady()){this.fullVPPending=!1,this.alreadyCalledFullVP=!0;var t=this.getRootsToExpand();if(t.length>0){var n,i,r={viewpointTag:this.viewpointTag,manager:this.oocManager,doneCB:this.onFullVPDone.bind(this),screenRadius:this.fullVPScreenRadius};for(i=0;i<t.length;i++)(n=t[i]).treeModified=!1,this.incFullVPLoading(),e.handleReferences([n.occurrence.reference],r,[n.rootId],!0)}this.updateLoadingStatus()}else this.fullVPPending=!0;else this.updateLoadingStatus()},M.prototype.boxQuery=function(e,t,n){var i,r=this.fullVPHandler,o=this.oocManager.getRootOccurrences(),s=[],a=[],d=this.forceClientBox;if(o.forEach(function(e,t,n){var i=e.occurrence.reference;i.isLeaf()||(e.elasticLoading&&e.enableExpand&&!d?s.push(i):a.push(i))}),s.length>0||a.length>0){var l,h=s.length,c=[],u=[],p={doneCB:e=>{if(h--,c=c.concat(e.representationsList),0===h){this.loadingReferencesFromBox--;var n=function(e,t){if(0===t.length)return e;if(0===e.length)return t;var n,i=new Set;for(n=0;n<e.length;n++)i.add(e[n]);for(n=0;n<t.length;n++)i.add(t[n]);return Array.from(i)}(c,u);t(n),this.updateLoadingStatus()}},errorCB:e=>{p.doneCB({representationsList:[]}),n&&n(e)}};for(this.loadingReferencesFromBox++,l=0;l<s.length;l++){var f=s[l].referenceId;r.oocHandler.handleBox(f,(void 0,{corner_min:[""+(i=e).min.x,""+i.min.y,""+i.min.z],corner_max:[""+i.max.x,""+i.max.y,""+i.max.z],transformation_matrix:["1.000","0.000","0.000","0.000","1.000","0.000","0.000","0.000","1.000","0.000","0.000","0.000"],intersection_mode:"partly_in",filter_only_on_bounding_box:1}),p)}if(a.length>0){var g=this.queues[0];g&&(u=g.computeNodesCollidingWithBox(e)),0===h&&setTimeout(t.bind(null,u))}}else setTimeout(t.bind(null,[]));this.updateLoadingStatus()},M.prototype.onFullVPDone=function(){this.decFullVPLoading(),this._updateNodes(),this.fullVPPending&&this.forceFullVP(),this.updateLoadingStatus(),this.requestUpdate(!1)},M.prototype.computeOcclusion=function(e){var t=this.queues[0];t.enableOcclusionTest&&(e&&(this.occlusionChecker&&this.occlusionChecker.dispose(),this.occlusionChecker=null),(e||this.queues[0].requiresOcclusion())&&(this.occlusionChecker||(this.occlusionChecker=new u({ldhNodeManager:this,viewer:this.viewer,ratio:.25,renderList:"ooc"})),p.onOcclusion(),t.computeOcclusion(this.occlusionChecker,e)))},M.prototype.updateUserQueues=function(e,t){var n;for(n=0;n<this.userQueues.length;n++){var i=this.userQueues[n];this.getPauseLoading()&&i.pauseSensitive||(e&&i.handleViewpointChange(t),i.traverseQueue())}},M.prototype.loadNodes=function(e,t){var n,i;if(this.debugThrottle<.5)for(n=0;n<this.queues.length;n++)(i=this.queues[n])&&i.loadNodes(e,t)},M.prototype.createViewpointData=function(e){return new T(e,n.computeScreenRadiusCstComponent(e.camera,this.viewer),this.boundingSphere,this.viewer)},M.prototype.removeRemovedNodes=function(){var e;for(e=0;e<this.queues.length;e++)this.queues[e]&&this.queues[e].removeUselessNodesFromList(this.queues[e].nodes)},M.prototype.updateLoadingStatus=function(){var e,t,n,i=!1,r=this.hasUnloadedSmallNodes;for(i=this.fullVPLoading>0||i||this.rootAdded||this.loadingReferencesFromBox>0,this.tilesManager.isLoading()&&(i=!0),this.rootAdded=!1,t=0;t<this.queues.length;t++)(n=this.queues[t])&&(i=i||n.isLoading(),r=r||n.hasMoreToLoad());var o=!this.unloadManager.isLoadingAllowed(0)||!this.unloadManager.isLoadingAllowed(1);if(i!==this.previousIsLoading){var s={isLoading:i,memoryFull:o||this.emergencyUnloadOccured||this.emergencyUnloadAvoided||this.instRefTransactionCPUMemoryFullOccurred,emergencyUnload:this.emergencyUnloadOccured,emergencyUnloadAvoided:this.emergencyUnloadAvoided};if(i)l.startProbe("viewpoint"),this.startLoadTime=(new Date).getTime(),this.viewer.setRenderIteration(!1),this.onStartLoadingCBMap.forEach((e,t)=>{e&&e.call(void 0,s)});else{e=(new Date).getTime(),l.endProbe("viewpoint"),this.lastDeltaTime=e-this.startLoadTime;var a=this.createViewpointData(this.viewer.currentViewpoint);this.updateCandidateQueueRenderer(!0,a),this.viewer.setRenderIteration(!0),this.forceSceneMin?this.viewer.render():this.queues[0].nbLoaded>0&&(this.viewer._forceSceneMin(null),this.viewer.render({updateInfinitePlane:!0})),p.onEndLoading(),S.recording&&S.addEndLoading(),this.onEndLoadingCBMap.forEach((e,t)=>{e&&e.call(void 0,s)})}this.previousIsLoading=i}this.tileSetMap.forEach((e,t,n)=>{var i;for(i=0;i<e.length;i++)e[i].updateLoadingStatus()})},M.prototype.addLoadedNode=function(e){e.getLDHNodeManagerQueue(this).addToLoadedNodesQueue(e)},M.prototype.standardUnloadNodes=function(e,t){this.unloadManager.beforeLoadedNodesQueueTraversal(),this.queues[0].standardUnloadNodes(e,t),this.unloadManager.afterLoadedNodesQueueTraversal()},M.prototype.onReferenceUnloaded=function(){this.queues[0].onReferenceUnloaded()},M.prototype.unloadNode=function(e,t,n){if(e.isUnloadLocked()||!e.isUnloadable(!0))return!1;if(0===e.handler.type){if(!(e.isToUnload()||n&&e.isLoaded()))return!1}else if(e.isRoot||e.children.length>0)return!1;(this.newLoadingBoxes&&e.removeBox(this),e.removeFromSceneGraph(!1,this),e.recursiveUpdateMemorySize(this),e.isInList())&&e.getLDHNodeManagerQueue(this).onNodeToRemoveFromList();var r,o=e.parents;for(e.isSlave()||e.hasUnloadFrozenParent()?e.setStatus(i.waiting,this):(e.removeFromParents(this.oocManager),e.unregister(this.oocManager)),r=0;r<o.length;r++)this.unloadNode(o[r],t);return!0},M.prototype.setOnStartLoadingCB=function(e){this.onStartLoadingCBMap.set(this.defaultLoadingCBToken,e)},M.prototype.setOnEndLoadingCB=function(e){this.onEndLoadingCBMap.set(this.defaultLoadingCBToken,e)},M.prototype.addOnStartLoadingCB=function(e){var t={};return this.onStartLoadingCBMap.set(t,e),t},M.prototype.addOnEndLoadingCB=function(e){var t={};return this.onEndLoadingCBMap.set(t,e),t},M.prototype.removeLoadingCB=function(e){this.onStartLoadingCBMap.delete(e),this.onEndLoadingCBMap.delete(e)},M.prototype.onInstRefGraphTransactionEnd=function(e){var n,r;for(n=0;n<e.length;n++)(r=e[n]).isAlive()&&r.setStatus(i.loaded,this);for(n=0;n<e.length;n++)!(r=e[n]).isAlive()||r.handler.type!==t.Model3DHandler&&r.handler.type!==t.TileSetHandler||(r.updateMemorySizeNEW(this),r._onLoaded(),r.isUnloadable()&&this.addLoadedNode(r));if(this.instRefTransactionCPUMemoryFullOccurred&&e.length&&!e[0].isLeaf()){var o=new Set;this.oocManager.getRootOccurrences().forEach(function(e,t,n){e.occurrence.reference.traverse(function(e){e.isLeaf()||0!==e.children.length||o.add(e)})});var s=this;o.forEach(function(e){s.unloadNode(e)})}this.tryBuildSceneGraphHierarchy(!1,this)},M.prototype.fillDebugJSON=function(e){return e.references={Model3DHandler:[],InstRefHandler:[]},this.queues[0].fillDebugArray(e.references.Model3DHandler),e},M.prototype.setPauseLoading=function(e,t){t=t||"default",this.pauseLoadingMap.set(t,e)},M.prototype.getPauseLoading=function(){var e=!1;return this.pauseLoadingMap.forEach(function(t,n,i){t&&(e=!0)}),e},M.prototype.registerOverrideSet=function(e){this.overrideSetManager||(this.overrideSetManager=this.viewer.getSceneGraphOverrideSetManager()),this.overrideSetMap[e]||(this.overrideSetMap[e]=new o(this.targetNode,void 0,!0),this.overrideSetManager.pushSceneGraphOverrideSet(this.overrideSetMap[e]))},M.prototype.removeOverrideSet=function(e){var t=this.overrideSetMap[e];t&&(this.overrideSetManager.removeSceneGraphOverrideSet(t),delete this.overrideSetMap[e])},M.prototype.getOverrideSet=function(e){return this.overrideSetMap[e]},M.prototype.getOverrideSetManager=function(){return this.overrideSetManager},M.prototype.addUserQueue=function(e){var t;for(t=0;t<this.userQueues.length;t++)if(this.userQueues[t].handler===e)throw new Error("duplicate handler");var n,i=e.getParams?e.getParams():{},r=(void 0===i.addLeaves||i.addLeaves,void 0!==i.addIntermediateNodes&&i.addIntermediateNodes),o=new s(e,this),a=new Set,d=this.queues[0];for(t=0;t<d.nodes.length;t++)(n=d.nodes[t])&&(r?a.has(n)||n.traverseParents(function(e){a.add(e),o.addNode(e)},a):o.addNode(n));var l=this.createViewpointData(this.viewer.currentViewpoint);o.computeOrder(l),this.requestUpdate(!1,!1),this.userQueues.push(o)},M.prototype.removeUserQueue=function(e){var t;for(t=this.userQueues.length-1;t>=0;t--)this.userQueues[t].handler===e&&this.userQueues.splice(t,1)},M.prototype.setCandidateQueueRendererParams=function(e,t){if(!this.newLoadingBoxes&&this.queueRenderer&&this.oocManager.isSlave()&&this.queueRenderer.removeSlaveBoxes(),e){var n=this.createViewpointData(this.viewer.currentViewpoint),i=this.queueRenderer;i||(i=this.newLoadingBoxes?new d(this.oocManager,this.queues[0]):new a(this,t.rootNode),this.queueRenderer=i,void 0!==t.pickable&&this.queueRenderer.setPickable(t.pickable,!this.newLoadingBoxes,n)),this.newLoadingBoxes||void 0===t.preserveSelection||(this.queueRenderer.preserveSelection=t.preserveSelection),i.setParams(t),this.newLoadingBoxes&&i.removeBoxes(),this.newLoadingBoxes&&i.updateLoadingBoxes(),!this.newLoadingBoxes&&this.oocManager.isSlave()&&i.displaySlaveBoxes(n)}else this.queueRenderer&&(this.queueRenderer.dispose(),this.queueRenderer=null,this.viewer.render({budgeted:!0}));this.requestUpdate(!1,!1)},M.prototype.getCandidateRoots=function(){var e=this.oocManager.getRootOccurrences(),t=[];return e.forEach(function(e,n,i){var r=e.occurrence.reference;0===r.children.length&&t.push(r)}),t},M.prototype.updateCandidateQueueRenderer=function(e,t){var n=this.queueRenderer,i=this.viewer.currentViewpoint.camera.position;if(n){var r=Date.now();(r-this.lastQueueRendererUpdateTime>500||e)&&(this.lastQueueRendererUpdateTime=r,this.newLoadingBoxes?n.updateLoadingBoxes():n.updateRepresentation(i,t),this.viewer.render({budgeted:!0}))}},M.prototype.emergencyUnloadNodes=function(e){var t=this.unloadManager.isEmergencyUnloadRequiredCPU(),n=this.unloadManager.isEmergencyUnloadRequiredGPU();(t||n)&&(this.emergencyUnloadOccured=!0,n&&this.queues[0].doEmergencyUnload(e))},M.prototype.forceUnloadSmallNodes=function(e,t,n){this.queues[n].unloadSmallNodes(e,t,n)},M.prototype.setBoundingSphere=function(e){this.boundingSphere=e,e?this.bsNode.forceBoundingElements(!0,{sphere:e.clone()}):this.bsNode.forceBoundingElements(!1),this.viewer.render()},M.prototype.onAddRoot=function(){this.rootAdded=!0,this.requestUpdate(!1,!1),this.updateLoadingStatus(),this.forceFullVP()},M.prototype.incFullVPLoading=function(){this.fullVPLoading++},M.prototype.decFullVPLoading=function(){this.fullVPLoading--};var D=-1;return M.prototype.getGlobalMeshInRAM=function(e,t){if(this.globalMeshInRAMCounter>0)return!0;if((this.unloadManager.autoMeshInRAM&&this.queues[0].getEstimatedSize()>=1e3&&(this.unloadManager.autoMeshInRAM=!1,this.unloadManager.autoMeshInRAMChange=!0),e)&&(this.unloadManager.autoMeshInRAM&&(-1===D&&(D=window.OOCEnableAutoMeshInRAM?1:0),t=t||e.getActiveRepresentation())))return 1===D||t.isAV1();return this.unloadManager.meshInRAM||this.unloadManager.autoMeshInRAM},M.prototype.lockGlobalMeshInRAM=function(){this.globalMeshInRAMCounter++,this.needGlobalSwitchNoMeshInRAM=!1,1===this.globalMeshInRAMCounter&&this.globalMeshInRAMSwitch(!0)},M.prototype.unlockGlobalMeshInRAM=function(){this.globalMeshInRAMCounter>0&&this.globalMeshInRAMCounter--,0===this.globalMeshInRAMCounter&&(this.needGlobalSwitchNoMeshInRAM=!0)},M.prototype.clearMeshInRAMForLoadingReferences=function(){var e,t=this.oocManager,n=this,i=[];for(this.loadingReferencesToSwitchToNoMeshInRAM.forEach(function(e){var r=t._getLDHReference(e,!0);r&&!r.isLoading()&&(t.isMeshInRAMRequested(e)||r.switchMeshInRAM(!1,n),i.push(e)),r||i.push(e)}),e=0;e<i.length;e++)this.loadingReferencesToSwitchToNoMeshInRAM.delete(i[e])},M.prototype.globalMeshInRAMSwitch=function(e){var t=this,n=this.oocManager;n._referenceTos.forEach(function(i,r){var o=i.reference;o.isLeaf()&&(!e&&o.isLoading()?t.loadingReferencesToSwitchToNoMeshInRAM.add(o.referenceId):e?o.switchMeshInRAM(!0,t):n._lockMeshInRAMTos.has(r)||o.switchMeshInRAM(!1,t))}),e||(this.switchNoMeshInRAMReferences=new Set,this.unloadManager.restoreMemoryFromMeshInRAM())},M.prototype.checkAutoMeshInRAM=function(){this.unloadManager.autoMeshInRAMChange&&(this.unloadManager.autoMeshInRAMChange=!1,0===this.globalMeshInRAMCounter&&this.globalMeshInRAMSwitch(this.unloadManager.autoMeshInRAMChange))},M.prototype.updateOccurrences=function(){var e=this.oocManager.getRootOccurrences(),t=this;e.forEach(function(e,n,i){var r=e.occurrence.reference;(r.getNeedUpdateOccurrencesUnder()||r.getNeedUpdateOccurrences())&&r.updateOccurrences_traverse(t)})},M.prototype.dispose=function(){this.viewer.currentViewpoint.unsubscribe(this.onViewpointMoveToken),this.onViewpointMoveToken=null},M.prototype.getServiceUrl=function(e){return this.getServiceUrlCB(e)},M.prototype.disableOcclusionTest=function(){let e;for(e=0;e<this.queues.length;e++)this.queues[e]&&(this.queues[e].enableOcclusionTest=!1)},M.prototype.getOOCReplay=function(){return S},M.prototype.loadOOCDebugViews=function(){require(["DS/VisuTools/OOCDebugViews"],function(e){window.OOCDebugViews=e})},M}),define("DS/3DXMTiles/OOCManager",["DS/3DXMTiles/LDHNodeManager","DS/3DXMTiles/OOCManagerEntry","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/OOCReferenceIterator","DS/3DXMTiles/OOCManagerRootEntry","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/VisuTools/FPSCounter","DS/Visualization/IdPathMatcher","DS/3DXMTiles/LDHReference","DS/Visualization/Node3D","DS/Visualization/PLMMaterialConnectionFactory","DS/3DXMTiles/LDHReferenceRep","DS/Visualization/IdPath","DS/3DXMTiles/LDHSwitchRepresentationData","DS/3DXMTiles/AsyncCaller","DS/3DXMTiles/Debug3DXMTiles","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/3DXMTiles/Default360ContentManager","DS/3DXMTiles/ModelBank"],function(e,t,n,i,r,o,s,a,d,l,h,c,u,p,f,g,m,S,y,v,M,L,T){"use strict";var D=1,C=function(t,n){n=n||{},T.init(),function(){var e=window.localStorage.getItem("OOCDebug");if(e){var t,n=JSON.parse(e);for(t in n)window[t]=n[t]}}(),this._config=n.config||"v0";var i=n.meshInRAM?n.meshInRAM:"on";this._ldhNodeManager=new e({viewer:t,oocManager:this,config:this._config,enableOcclusionTest:n.enableOcclusionTest,fullVP:!!n.fullVP,meshInRAM:i,newLoadingBoxes:n.newLoadingBoxes,maxNbBoxes:n.maxNbBoxes,forceSceneMin:!!n.forceSceneMin,getServiceUrlCB:n.getServiceUrlCB||null,progressiveExpand:!!n.progressiveExpand}),t._setOOCManager(this);var r=void 0===n.fullOOC||!!n.fullOOC;this.disableSlaveBoxFix=!1===n.solution3BoxFix,this._ldhNodeManager.unloadManager.setFlashMode(!0),void 0!==n.unloadSmallNodes&&this._ldhNodeManager.setUnloadSmallNodesEnabled(!!n.unloadSmallNodes),this._referenceTos=new Map,this._instanceTos=new Map,this._rootOccurrenceTos=new Map,this._externalNodeIdToNode=new Map,this._externalNodeToNodeId=new Map,this._lockMeshInRAMTos=new Map,this._onCycleDetectedCB=null,this._cycleDetected=!1,this._instRefGraphTransaction=null,this._mode=r?C.Mode.ooc:C.Mode.slave,r&&this._initIdPathMatcher(),this._defaultLoadModelOptions=null,this._initialMeshInRAM=i,this._overrideSetMap=new Map,this._usePickingAccelerationStructure=!1,this._boxes=new Map,this._3DShapeCounter=0,this._overrideSetManagerMap=null,this._unitValue=this._computeUnitValue(n.unit),this._handlers={repRef:null,ref:null,tileSet:null},this._nextInstanceAutoId=0,this.registerCustomTilesManager(L),this._idToPositionOverrideSets=null};function R(e){var t,n,i=[];for(t=0;t<e.externalPath.length;t++)(n=e.externalPath[t].getModelIdentification())&&i.push(n);return i}function b(e){var t,n,i=e.getLastElement(!0),r=[];for(t=0;t<i.children.length;t++)"OOC##Box"===(n=i.children[t]).name&&r.push(n.getModelIdentification());return r}C.prototype.setTargetNode=function(e){e.setRenderPasses(["main","ooc"]),this._ldhNodeManager.setTargetNode(e)},C.prototype.setDefaultLoadModelOptions=function(e){this._defaultLoadModelOptions=e},C.prototype.getDefaultLoadModelOptions=function(){return this._defaultLoadModelOptions},C.prototype.registerReference=function(e,n){if(this._mode===C.Mode.slave)throw new Error("Cannot mix slave and OOC");n.handlerType||console.warn("OOCManager.registerReference: 'handler' parameter is deprecated - use registerHandlers() + 'handlerType' parameter");var i=this._getOOCEntry(e,!0);if(!i){var r=n.handler||this._handlers[n.handlerType]||null;i=new t(e,{manager:this,handler:r.ldhHandler,boundingSphere:n.boundingSphere||null,boundingBox:n.boundingBox||null,loadModelOptions:n.loadModelOptions}),this._referenceTos.set(e,i),this._handleNewReference(i.reference,n),this._ldhNodeManager.onSceneChange()}},C.prototype.registerTileSet=function({rootId:e,referenceId:t,tileSet:n,onTileSetReadyCB:i}){var r=this._rootOccurrenceTos.get(e),o=(r&&r.occurrence).reference,s=this._getAutoInstanceId();this.registerReference(t,{handlerType:"tileSet",tileSet:n}),this.addChild(o.referenceId,t,{instanceId:s,matrix:null}),this.setForceReferenceLoad(t,!0,()=>{var e=this.getTileSet(t);i.call(null,e)})},C.prototype.setOverrideCB=function(e,t,n){void 0===n&&(console.warn("Calling setOverrideCB(...) without 3rd argument is deprecated"),n="#undefined#",this.registerOverrideSet(n));var i=this._overrideSetMap.get(n);i&&(this._getLDHReference(e).setOverrideCB(n,t,this._ldhNodeManager),i.add(e))},C.prototype.hasOverrideCB=function(e,t){return!!this._overrideSetMap.get(t)&&!!this._getLDHReference(e).hasOverrideCB(t)},C.prototype.registerOverrideSet=function(e){"#undefined#"!==e&&(this._ldhNodeManager.registerOverrideSet(e),this._overrideSetMap.has(e)||this._overrideSetMap.set(e,new Set))},C.prototype.clearOverrideSet=function(e){if("#undefined#"!==e){var t=this._overrideSetMap.get(e),n=this;t&&t.forEach(function(t){var i=n._getLDHReference(t,!0);i&&i.setOverrideCB(e,null,n._ldhNodeManager)})}},C.prototype.removeOverrideSet=function(e){"#undefined#"!==e&&(this.clearOverrideSet(e),this._ldhNodeManager.removeOverrideSet(e),this._overrideSetMap.delete(e))},C.prototype.registerLeafReference=function(e,n){if(this._mode===C.Mode.ooc)throw new Error("Cannot mix slave and OOC");n.handlerType||console.warn("OOCManager.registerLeafReference: 'handler' parameter is deprecated - use registerHandlers() + 'handlerType' parameter"),u.slaveBoxFix=!this.disableSlaveBoxFix;var i=this._getOOCEntry(e,!0);if(!i){var r=n.node.getModelIdentification();if(r&&this.isRegistered(r))throw new Error("illegal node: used for another OOC reference");var o=this._handlers[n.handlerType]||n.handler||null;i=new t(e,{manager:this,handler:o.ldhHandler,boundingSphere:n.boundingSphere||null,boundingBox:n.boundingBox||null,leaf:!0,loadModelOptions:n.loadModelOptions}),this._referenceTos.set(e,i),n.node.setRenderPasses(["main","ooc"]),this._handleNewReference(i.reference,n),i.reference.updateBoundingElementImpostor(),this._ldhNodeManager.onSceneChange()}},C.prototype._handleNewReference=function(e,t){var n=new g({src:t.url||t.tileSet||t.src,noMeshInRAM:t.meshInRAM,active:!0,type:t.type||C.RepType.none,wms:t.wms});t.node&&(n.node=t.node);var i=e.referenceId,r=this._isMeshInRAMRequested(i,n);e.switchRepresentation(n,r,this._ldhNodeManager);var o=this._ldhNodeManager.switchRepresentationBuffer.get(i);o&&(o.rep.copyMissingParams(n),this._ldhNodeManager.switchRepresentationBuffer.delete(i),e.switchRepresentation(o.rep,r,this._ldhNodeManager,o.onSwitchRepCBArray)),e.is3DShape()&&this._on3DShapeAdd(),this._ldhNodeManager.registerTilesNode(e)},C.prototype.switchRepresentation=function(e,t,n){var i=new g({url:t.url,type:t.type||C.RepType.none,wms:t.wms});if(i.url){var r=this._getLDHReference(e,!0),o=null;if(r&&!r.isLoading())return!r.isForced()&&r.isToUnload()||(o=n?[n]:null),r.switchRepresentation(i,this._isMeshInRAMRequested(e,i),this._ldhNodeManager,o,!0),this._ldhNodeManager.onSceneChange(),!o&&n&&y.call(n),!0;var s=this._ldhNodeManager.switchRepresentationBuffer.get(e);return s?(i.copyMissingParams(s.rep),s.setRep(i)):(s=new S(i),this._ldhNodeManager.switchRepresentationBuffer.set(e,s)),n&&(r?s.addOnSwitchRepCB(n):y.call(n)),!1}setTimeout(n)},C.prototype.lockGlobalMeshInRAM=function(){this._ldhNodeManager.lockGlobalMeshInRAM()},C.prototype.unlockGlobalMeshInRAM=function(){this._ldhNodeManager.unlockGlobalMeshInRAM(),this._ldhNodeManager.requestUpdate(!1,!1)},C.prototype.lockReferenceMeshInRAM=function(e){if(this._lockMeshInRAMTos.has(e)){var t=this._lockMeshInRAMTos.get(e);t++,this._lockMeshInRAMTos.set(e,t)}else{this._lockMeshInRAMTos.set(e,1);var n=this._getLDHReference(e,!0);n&&n.switchMeshInRAM(!0,this._ldhNodeManager)}this._ldhNodeManager.switchNoMeshInRAMReferences.delete(e)},C.prototype.unlockReferenceMeshInRAM=function(e,t){if(this._lockMeshInRAMTos.has(e)){var n=this._lockMeshInRAMTos.get(e);if(0===--n||t){this._lockMeshInRAMTos.delete(e);var i=this._getLDHReference(e,!0);this._ldhNodeManager.getGlobalMeshInRAM(i)||this._ldhNodeManager.switchNoMeshInRAMReferences.add(e)}else this._lockMeshInRAMTos.set(e,n)}this._ldhNodeManager.requestUpdate(!1,!1)},C.prototype.isRepresentationUpToDate=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return!(!n||!n.active)},C.prototype.getRepresentation=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getActiveRepresentation();return n&&n.getJSON()},C.prototype.unregisterLeafReference=function(e){var t=this._getOOCEntry(e).reference;t.isSlave()&&(t.getLDHNodeManagerQueue(this._ldhNodeManager).onNodeToRemoveFromList(),this._ldhNodeManager.unloadLeafReferenceCB&&this._ldhNodeManager.unloadLeafReferenceCB(e),t._rep.node=null,this._unregisterReference(e))},C.prototype.setUnloadLeafReferenceCB=function(e){this._ldhNodeManager.unloadLeafReferenceCB=e},C.prototype.setOnLeafReferenceLoadedCB=function(e){this._ldhNodeManager.onLeafReferenceLoadedCB=e},C.prototype.setOnSwitchRepCB=function(e){this._ldhNodeManager.onSwitchRepCB=e},C.prototype.setOnCycleDetectedCB=function(e){this._onCycleDetectedCB=e},C.prototype.isRegistered=function(e,t){var n=null!==this._getOOCEntry(e,!0),i=!!this._instanceTos.get(e);return n||!t&&i},C.prototype.isPLMReference=function(e){return null!==this._getOOCEntry(e,!0)},C.prototype.isPLMInstance=function(e){return!!this._instanceTos.get(e)},C.prototype.addRoot=function(e,t){if(this._mode===C.Mode.slave)throw new Error("Cannot mix slave and OOC");this._rootOccurrenceTos.forEach(function(t,n,i){if(t.occurrence.reference.referenceId===e)throw new Error("Multiple occurrences for root are unsupported")});var i=this._getLDHReference(e),r=new Set,s=new n({reference:i,manager:this._ldhNodeManager,instanceData:u.createChildData(i,t.matrix||null,t.instanceId)},r),a=this._ldhNodeManager;s.updateMatrix(a),r.forEach(function(e){e.updateOverride(a)});var d=D,l=new o(s,t.boundingBox,d,t.onLoadedCB);return l.elasticLoading=!!t.elasticLoading,this._rootOccurrenceTos.set(d,l),D++,this._updateSceneMin(),i.setIsRoot(!0,this._ldhNodeManager),this._updateBoundingSphere(),this._ldhNodeManager.onAddRoot(),d},C.prototype.getReframeBoundingSphere=function(){var e=this.getRootOccurrences(),t=new l.Sphere;return e.forEach(function(e,n,i){var r=e.occurrence,o=r.reference.getBoundingSphere(!0).clone();o.applyMatrix4(r.matrix);var s=t.clone();o.mergeWithSphere(t,s),t=s}),t},C.prototype.removeRoot=function(e){var t=this._rootOccurrenceTos.get(e),n=t&&t.occurrence,i=n.reference;if(this._rootOccurrenceTos.delete(e),i.setIsRoot(!1,this._ldhNodeManager),i._occurrences.length>1){var r=new Set;n.detach(r),r.forEach(function(e){e._removeNullsFromOccurrenceList()})}else this.removeReferenceTree(i.referenceId);var o=this._ldhNodeManager.getTileSets(i);if(o){let e=this._ldhNodeManager.viewer;if(e&&e._viewer360Manager){let t,n=[];for(t=0;t<o.length;t++){let e=o[t].oocTileSet;e.hasType("360")&&n.push(e)}n.length>0&&e._viewer360Manager.onTileSetsRemoved(n)}this._ldhNodeManager.removeTileSets(i)}this._ldhNodeManager.removeRemovedNodes(),this._ldhNodeManager.requestUpdate(!0,!0),this._updateSceneMin();var s=this;this._overrideSetMap.forEach(function(e,t,n){var i,r=[];for(e.forEach(function(e){s._getLDHReference(e,!0)||r.push(e)}),i=0;i<r.length;i++)e.delete(r[i])}),this._updateBoundingSphere(),0===this._rootOccurrenceTos.size&&"auto"===this._initialMeshInRAM&&this._ldhNodeManager.unloadManager.restoreAutoMeshInRAM()},C.prototype.isRootAlive=function(e){return!!this._rootOccurrenceTos.get(e)},C.prototype.setRootEnabled=function(e,t){var n=this._rootOccurrenceTos.get(e);n?(t=!!t,n.enableExpand!==t&&(n.enableExpand=t,t&&this._ldhNodeManager.forceFullVP())):console.warn("Unknown rootId: '"+e+"'")},C.prototype.freezeRoot=function(e){this._rootOccurrenceTos.get(e).occurrence.reference.freezeUnload(),this.setRootEnabled(e,!1)},C.prototype.declareTreeModified=function(e){var t=this._rootOccurrenceTos.get(e);t&&(t.treeModified=!0,this._ldhNodeManager.forceFullVP())},C.prototype.isRepRef=function(e){var t=this._getLDHReference(e,!0);return!!t&&t.isLeaf()},C.prototype.createReferenceIterator=function(e){var t=this._getLDHReference(e,!0);return t&&new r(t)},C.prototype.notifyRootVisibilityChange=function(e,t){var n=this._rootOccurrenceTos.get(e);n&&(n.visible=!!t,this._updateBoundingSphere())},C.prototype.isCPUMemoryFull=function(){if(this._cycleDetected)return!0;var e=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1);if(e&&this._instRefGraphTransaction){if(!this._instRefGraphTransaction.unloadTried){this._instRefGraphTransaction.unloadTried=!0;var t=this._ldhNodeManager.createViewpointData(this._ldhNodeManager.viewer.currentViewpoint);this._ldhNodeManager.standardUnloadNodes(!0,t),e=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1)}e&&this._instRefGraphTransaction.onCPUMemoryFull(this)}return e},C.prototype._unregisterReference=function(e){var t=this._getLDHReference(e,!0);t&&(t.children.length>0&&console.log("_unregisterReference internal error"),t&&(t.is3DShape()&&this._on3DShapeRemove(),t.setStatus(i.dead,this._ldhNodeManager),this._ldhNodeManager.unregisterNode(t),t.updateMemorySizeNEW(this._ldhNodeManager)),this._referenceTos.delete(e))},C.prototype._unregisterInstance=function(e){this._instanceTos.delete(e)},C.prototype.addChild=function(e,t,n){var i=this._getLDHReference(e,!0);if(i){var r=this._getLDHReference(t),o=n.instanceId,s=new Set,a=!1;this._instanceTos.get(o)||(i.addReferenceChild(r,n.matrix||null,o,s,this._ldhNodeManager)||(a=!0),o&&this._instanceTos.set(o,i)),a&&(this._cycleDetected=!0,this._onCycleDetectedCB&&this._onCycleDetectedCB()),null!==this._instRefGraphTransaction&&this._instRefGraphTransaction.onAddChild(i),this._ldhNodeManager.tryBuildSceneGraphHierarchy();var d=this._ldhNodeManager;s.forEach(function(e){e.updateOverride(d)}),i.isUnloadFrozen()&&r.freezeUnload(),this._ldhNodeManager.onSceneChange()}},C.prototype.createNodeIdOverrideSetManager=function(e){this._overrideSetManagerMap||(this._overrideSetManagerMap=new Map);var t=this._overrideSetManagerMap.get(e);if(!t){var n=this._ldhNodeManager.viewer.getIdPathMatcher().idToNode(e);n?((t=n.createOverrideSetManager()).nodeId=e,t._idPathOverrideWatcher=this._ldhNodeManager.viewer._getIdPathOverrideWatcher()):t=new M({active:!1,nodeId:e,idPathOverrideWatcher:this._ldhNodeManager.viewer._getIdPathOverrideWatcher()}),t&&t._setOOCManager(this),this._overrideSetManagerMap.set(e,t)}return t},C.prototype.removeNodeIdOverrideSetManager=function(e){this._overrideSetManagerMap||(this._overrideSetManagerMap=new Map),this._overrideSetManagerMap.has(e.nodeId)&&(this._overrideSetManagerMap.delete(e.nodeId),e._removeNodeId())},C.prototype.getOccurrencesMatrices=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i,r=t.getAllMatrices(),o=[];for(i=0;i<r.length;i++)(n=r[i])&&o.push(n.clone());return o}return null},C.prototype._onRepLoaded=function(e){null!==this._instRefGraphTransaction&&this._instRefGraphTransaction.onAddChild(e)},C.prototype.getReferenceUrl=function(e){return this._getLDHReference(e)._rep.url},C.prototype.getReferenceBoundingSphere=function(e){var t=this._getLDHReference(e);return t.updateBoundingSphere(),t._boundingSphere&&t._boundingSphere.clone()},C.prototype.getReferenceBoundingBox=function(e){var t=this._getLDHReference(e).getBoundingBox();return t&&t.clone()},C.prototype._getOOCEntry=function(e,t){var n=this._referenceTos.get(e);if(!t&&!n)throw new Error("Unknown OOC referenceId: '"+e+"'");return n||null},C.prototype._getLDHReference=function(e,t){var n=this._getOOCEntry(e,t);return n?n.reference:null},C.prototype._getInstance=function(e){return this._instanceTos.get(e)},C.prototype.getSceneGraphNode=function(e){var t,n=this._getLDHReference(e,!0);if(n)return n._rep.node;if(n=this._instanceTos.get(e))for(t=0;t<n.children.length;t++){var i=n.children[t];if(i.instanceId===e)return i.node}return null},C.prototype.forceReferenceLoad=function(e,t){this.setForceReferenceLoad(e,!0,t)},C.prototype.setForceReferenceLoad=function(e,t,n){var i=this,r=i._getLDHReference(e,!0);r&&!r.isError()?this._ldhNodeManager.executeReferenceAction([r],function(e){var r,o;for(r=0;r<e.length;r++)(o=e[r]).forceLoad(!!t,n,i._ldhNodeManager),i._ldhNodeManager.forceUpdateNode(o);i._ldhNodeManager.requestUpdate(!0,!0)}):setTimeout(n,0)},C.prototype.setUserData=function(e,t){var n,i,r=!1,o=this._getLDHReference(e,!0);if(o)o.userData=t,r=!0,(n=o.getNode())&&n.setUserData(t);else if(o=this._instanceTos.get(e))for(i=0;i<o.children.length;i++){var s=o.children[i];s.instanceId===e&&(s.userData=t,r=!0,s.node&&s.node.setUserData(t))}if(!r)throw new Error("unknown id")},C.prototype.getUserData=function(e){var t,n=this._getLDHReference(e,!0);if(n)return n.userData;if(n=this._instanceTos.get(e))for(t=0;t<n.children.length;t++){var i=n.children[t];if(i.instanceId===e)return i.userData}throw new Error("unknown id")},C.prototype.setOnStartLoadingCB=function(e){this._ldhNodeManager.setOnStartLoadingCB(e)},C.prototype.setOnEndLoadingCB=function(e){this._ldhNodeManager.setOnEndLoadingCB(e)},C.prototype.addOnStartLoadingCB=function(e){return this._ldhNodeManager.addOnStartLoadingCB(e)},C.prototype.addOnEndLoadingCB=function(e){return this._ldhNodeManager.addOnEndLoadingCB(e)},C.prototype.removeLoadingCB=function(e){this._ldhNodeManager.removeLoadingCB(e)},C.prototype.setOnAddedToSceneGraphCB=function(e,t){this._getLDHReference(e).setOnAddedToSceneGraphCB(t)},C.prototype.setOnRemovedFromSceneGraphCB=function(e,t){this._getLDHReference(e).setOnRemovedFromSceneGraphCB(t)},C.prototype.getAllReferences=function(){var e=[];return this._referenceTos.forEach(function(t,n,i){e.push(n)}),e},C.prototype.switchLOD=function(e,t,n,r,o){var s=this._getLDHReference(e),a=this._ldhNodeManager;this._ldhNodeManager.executeReferenceAction([s],function(e,s){var d,l,h=0;function c(){for(d=0;d<e.length;d++){e[d].userUnlockUnload()}0===--h&&n&&(n(),n=null)}for(d=0;d<e.length;d++){var u;(u=e[d]).isToUnload()||u.isWaiting()||(u.userLockUnload(),h++,u.addOnLoadedCB(c)),(l=u.getActiveRepresentation())&&(l.setUrlAndType(t,r||C.RepType.none),l.setWMS(o)),u.removeFromSceneGraph(!0,a),u.setStatus(i.waiting,a),a.registerTilesNode(u)}0===h&&setTimeout(n,1),s()}),this._ldhNodeManager.onSceneChange()},C.prototype.getNbChildren=function(e){return this._getLDHReference(e).children.length},C.prototype.isReferenceComplete=function(e){return this.isReferenceLoaded(e)},C.prototype.isReferenceLoaded=function(e){var t=this._getLDHReference(e,!0);return null!==t&&(t.isLoaded()||t.isToUnload())},C.prototype.dumpAllMemorySize=function(e){this._referenceTos.forEach(function(t,n,i){var r=t.reference;e&&r.updateMemorySize(),console.log(n+" "+r.memorySize)}),console.log("TOTAL "+this._ldhNodeManager.unloadManager.memoryUsage)},C.prototype.startInstRefGraphTransaction=function(){this._instRefGraphTransaction&&console.log("ERROR - A transaction already exists"),this._instRefGraphTransaction=new x,this._ldhNodeManager.instRefTransactionCPUMemoryFullOccurred=!1},C.prototype.endInstRefGraphTransaction=function(){this._instRefGraphTransaction.endTransaction(this),this._instRefGraphTransaction=null},C.prototype.addSceneGraphLock=function(e){var t=this._getLDHReference(e,!0);return!!t&&(t.requestBuildSceneGraphHierarchy(!0),t.userLockUnload(),this._ldhNodeManager.tryBuildSceneGraphHierarchy(),!0)},C.prototype.removeSceneGraphLock=function(e){var t=this._getLDHReference(e,!0);return!!t&&(t.userUnlockUnload(),!0)},C.prototype.isSceneGraphLocked=function(e){return this.getSceneGraphLockCounter(e)>0},C.prototype.getSceneGraphLockCounter=function(e){var t=this._getLDHReference(e,!1);return t._optional?t._optional.userLockUnload:0},C.prototype.getRootOccurrences=function(){return this._rootOccurrenceTos},C.prototype.getRoots=function(){var e=[];return this._rootOccurrenceTos.forEach(t=>{var n=t.occurrence.reference.referenceId;e.indexOf(n)<0&&e.push(n)}),e},C.prototype.getIdPathesLeadingToReference=function(e){var t=null,n=this._getLDHReference(e,!0);if(n){t=[];var i,r,o=n.getLDHOccurrences();for(i=0;i<o.length;i++)r=o[i].getIdPath(),t.push(new m(r))}return t},C.prototype.setDisableFullVP=function(e){!e&&this._ldhNodeManager.disableFullVP&&this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.disableFullVP=e},C.prototype.setFullVPScreenRadius=function(e){this._ldhNodeManager.fullVPScreenRadius=e},C.prototype._getDebugJSON=function(){var e={references:{},roots:[]};return this._referenceTos.forEach(function(t,n,i){e.references[n]=t.reference.buildDebugJSON(!0,!0)}),this._rootOccurrenceTos.forEach(function(t,n,i){var r=t.occurrence;e.roots.push(r.reference.referenceId)}),e},C.prototype._getReferenceDebugJSON=function(e){var t=this._getLDHReference(e,!0);return t?t.buildDebugJSON():null},C.prototype._getAllInstancesDebugJSON=function(){var e={};return this._instanceTos.forEach(function(t,n,i){var r,o;for(r=0;r<t.children.length;r++)(o=t.children[r]).instanceId===n&&(e[n]={parent:t.referenceId,child:o.reference.referenceId})}),e},C.prototype._getSingleInstanceDebugJSON=function(e){var t,n,i=this._instanceTos.get(e);if(i)for(t=0;t<i.children.length;t++)if((n=i.children[t]).instanceId===e)return{instanceId:e,parent:i.referenceId,child:n.reference.referenceId};return null},C.prototype.setPauseLoading=function(e,t){var n=this._ldhNodeManager.getPauseLoading();this._ldhNodeManager.setPauseLoading(!!e,t),n&&!this._ldhNodeManager.getPauseLoading()&&(this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.requestUpdate(!0,!0))},C.prototype.forceRefresh=function(){this._ldhNodeManager.forceFullVP(),this._ldhNodeManager.requestUpdate(!0,!0)},C.prototype.setReferenceLoadModelOptions=function(e,t){this._getLDHReference(e).setLoadModelOptions(t)},C.prototype.getReferenceLoadModelOptions=function(e){this._getLDHReference(e).setLoadModelOptions(loadModelOptions)},C.prototype.getReferenceLoadModelOptions=function(e){var t=this._getLDHReference(e);return t._optional&&t._optional.loadModelOptions},C.prototype.setPerformancesOptions=function(e){e.fullAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!0,!0]),e.repAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!0,!1]),e.noAlwaysUnload&&this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([!1,!1]),void 0!==e.pauseLoadingDuringViewpointMove&&this._ldhNodeManager.setPauseLoadingDuringViewpointMove(!!e.pauseLoadingDuringViewpointMove)},C.prototype.getWorldMatrix=function(e,t){var n,i,r=this._rootOccurrenceTos.get(e).occurrence;r.reference;for(n=1;n<t.length;n+=2){i=r.getChildren();var o,s=!1;for(o=0;o<i.length;o++)i[o].instanceData.instanceId===t[n]&&(r=i[o],s=!0);if(!s)throw new Error("inconsistent path")}return r.matrix.clone()},C.prototype.addUserQueue=function(e){this._ldhNodeManager.addUserQueue(e)},C.prototype.removeUserQueue=function(e){this._ldhNodeManager.removeUserQueue(e)},C.prototype.setCandidateQueueRendererParams=function(e,t){this._ldhNodeManager.setCandidateQueueRendererParams(e,t)},C.prototype.setExpandAllowed=function(e,t){},C.prototype._updateSceneMin=function(){var e=0,t=!1;(this._rootOccurrenceTos.forEach(function(n,i,r){if(n.boundingBox){var o=n.computeSceneMin();(!t||o<e)&&(e=o,t=!0)}}),t)&&this._ldhNodeManager.viewer.forceSceneMin(e)},C.prototype.getSelectedPath=function(e){var t,n,i={hso:s,pso:a,cso:d}[e=e||"hso"].get(),r=[],o=[];for(t=0;t<i.length;t++)r=void 0!==(n=i[t].pathElement).instanceId&&this._ldhNodeManager.queueRenderer?this._ldhNodeManager.queueRenderer.getPathFromPathElement(n):R(n),o.push(r);return o&&1===o.length?o[0]:o},C.prototype.getSelectedReference=function(e){var t,n,i,r,o={hso:s,pso:a,cso:d}[e=e||"hso"].get(),l=[];for(t=0;t<o.length;t++)void 0!==(n=o[t].pathElement).instanceId&&this._ldhNodeManager.queueRenderer?r=this._ldhNodeManager.queueRenderer.getReferenceFromPathElement(n):(r=(i=this._mode===C.Mode.slave?b(n):R(n))[i.length-1],this.isRegistered(r,!0)||(r=null)),l.push(r);return l&&1===l.length?l[0]:l},C.prototype.registerExternalSceneGraphNode=function(e,t){if(null===t){var n=this._externalNodeIdToNode.get(e);this._externalNodeIdToNode.delete(e),this._externalNodeToNodeId.delete(n)}else this._externalNodeToNodeId.set(t,e),this._externalNodeIdToNode.set(e,t)},C.prototype.setLoadingBoxesPickable=function(e){if(this._ldhNodeManager.queueRenderer){var t=this._ldhNodeManager.createViewpointData(this._ldhNodeManager.viewer.currentViewpoint);this._ldhNodeManager.queueRenderer.setPickable(e,!1,t)}},C.prototype.showPerfos=function(){h.setAutoRefresh(!1),this._ldhNodeManager.viewer.showPerfo(!0,!1)},C.prototype._updateBoundingSphere=function(){var e=null;this._rootOccurrenceTos.forEach(function(t,n,i){var r=t.occurrence,o=null;t.visible&&r.reference.hasRootBoundingElement()&&(o=r.getBoundingSphere()),o&&(e?e.clone().mergeWithSphere(o,e):e=o.clone())});var t=this._ldhNodeManager.targetNode;if(e&&t&&1===t._occurrences.length){var n=t._occurrences[0].matrix;n&&!n.isIdentity()&&e.applyMatrix4(n)}this._ldhNodeManager.setBoundingSphere(e)},C.prototype.isSlave=function(){return this._mode===C.Mode.slave},C.prototype.isOOC=function(){return this._mode===C.Mode.ooc},C.prototype._debug_UnloadReference=function(e){var t=!1,n=this._ldhNodeManager.createViewpointData(this._ldhNodeManager.viewer.currentViewpoint),i=this._getLDHReference(e,!0);return i&&(t=this._ldhNodeManager.unloadNode(i,n),this.setPauseLoading(!0),this._ldhNodeManager.viewer.render()),t},C.prototype._startModelLoaderTransaction=function(){this._instRefGraphTransaction&&console.log("ERROR - A transaction already exists"),this._instRefGraphTransaction=new x},C.prototype._endModelLoaderTransaction=function(){this._instRefGraphTransaction.endTransaction(this),this._instRefGraphTransaction=null},C.prototype._updateOccurrences=function(e){if(!this.isSlave()){var t,n,i,r=this._ldhNodeManager;for(t=0;t<e.length;t++)n=e[t].getLastId(),(i=this._getLDHReference(n,!0))?i.requestUpdateOccurrencesPosition(r,null):(i=this._instanceTos.get(n))&&i.requestUpdateOccurrencesPosition(r,n)}},C.prototype.hasMeshInRAM=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return!!n&&(!(!n.node||!t.isLoaded()&&!t.isToUnload())&&n.hasMeshInRAM())},C.prototype.isMeshInRAMRequested=function(e){return this._isMeshInRAMRequested(e)},C.prototype.getRepType=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getPrimaryRepresentation();return n?n.type:null},C.prototype.getRequestedRepType=function(e){var t=this._getLDHReference(e,!0),n=t&&t.getActiveRepresentation();return n?n.type:null},C.prototype.hasRoot=function(){return this._rootOccurrenceTos.size>0},C.prototype.hasActiveRoot=function(){return this._ldhNodeManager.getRootsToExpand().length>0},C.prototype.getInstanceParentReferenceId=function(e){var t=this._instanceTos.get(e);return t?t.referenceId:null},C.prototype.getInstanceChildReferenceId=function(e){var t=this._instanceTos.get(e),n=t?t.getChild(e):null;return n?n.reference.referenceId:null},C.prototype.removeInstance=function(e){var t=this._instanceTos.get(e);if(!t)throw new Error("Unknown instanceId");var n=t.getChild(e);if(!n)throw new Error("Bad instanceId");t.detachReference(n.reference,e,!0,this)},C.prototype.removeInstanceTree=function(e){var t=this._instanceTos.get(e);if(!t)throw new Error("Unknown instanceId");var n=t.getChild(e);if(!n)throw new Error("Bad instanceId");t.detachReference(n.reference,e,!0,this),0!==n.reference.parents.length||n.reference.isRoot||this.removeReferenceTree(n.reference.referenceId)},C.prototype.removeReference=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i=t.parents;for(t.detachReference(null,null,!0,this),n=0;n<i.length;n++)i[n].detachReference(t,null,!1,this);t.parents.length=0,this._unregisterReference(e)}},C.prototype.removeReferenceTree=function(e){var t=this._getLDHReference(e,!0);if(t){var n,i=t.parents,r=new Set;for(t.detachReference(null,null,!0,this,r),n=0;n<i.length;n++)i[n].detachReference(t,null,!1,this);t.parents.length=0;var o=this;r.forEach(function(e){e.detachReference(null,null,!0,o),e.parents.length=0,o._unregisterReference(e.referenceId)}),this._unregisterReference(e)}},C.prototype.updateInstance=function(e,t){if(!t.instanceId||t.instanceId===e||!this._instanceTos.get(t.instanceId)){var n=this._instanceTos.get(e);if(!n)throw new Error("Unknown instanceId");n.updateInstance(e,t,this._ldhNodeManager),t.instanceId&&t.instanceId!==e&&(this._unregisterInstance(e),this._instanceTos.set(t.instanceId,n))}},C.prototype._initIdPathMatcher=function(){var e=this._ldhNodeManager.viewer,t=this;var n=new c({idToNodeCB:function(e){var n=t._externalNodeIdToNode.get(e);if(n)return n;if(e.startsWith("##REP##")){var i=e.substring(7),r=t._getLDHReference(i,!0);return r?r.getCGRNode():null}return t.getSceneGraphNode(e)},nodeToIdCB:function(e){if(!e)return null;var n=t._externalNodeToNodeId.get(e);return n||((n=e.getModelIdentification())||(n=u.weakCGRNodeMap.get(e)||null),n)},isNodeRepRefCB:function(e){var n,i=t._externalNodeToNodeId.get(e);return!i&&(i=e.getModelIdentification(),!!(n=t._getLDHReference(i,!0))&&n.isLeaf())}});e.setIdPathMatcher(n),f.setParams({useIdPathMatcher:!0,viewer:e,oocManager:this})},C.prototype.setUsePickingAccelerationStructure=function(e,t){var n=this._usePickingAccelerationStructure;this._usePickingAccelerationStructure=!!e,e&&n!==this._usePickingAccelerationStructure?this._doMassiveReload(t):t&&setTimeout(t,0)},C.prototype.registerCustomTilesManager=function(e){this._ldhNodeManager.tilesManager.registerCustomContentManager(e)},C.prototype.getUsePickingAccelerationStructure=function(){return this._usePickingAccelerationStructure},C.prototype.loadBox=function(e,t,n,i){if(this._boxes.has(t))throw new Error("box with name "+t+" already exists");this._boxes.set(t,null),v.startProbe("box_"+t);var r,o,s,a,d=localStorage.getItem("OOCBoxDebug");let l=0;d&&(r=performance.now()),this._ldhNodeManager.boxQuery(e,e=>{d&&(o=performance.now());let i=e.length,h=[];for(let t=0;t<i;t++){let n=this._getLDHReference(e[t]);h.push({obj:n,skip:!1})}var c,u,p=()=>{if(--c===l){var u;for(d&&(s=0,a=0),u=0;u<i;u++){let t=h[u];d&&(s+=t.obj.byteSize,t.skip&&(a+=t.obj.byteSize)),t.skip||(this.addSceneGraphLock(e[u]),this.setForceReferenceLoad(e[u],!1,null))}if(v.endProbe("box_"+t),d){var p=performance.now();console.log("skipped"+a+" of "+s+" bytes or "+a/s*100+"% of total size"),console.log("box query : "+(o-r)/1e3+" / "+i+" cgrs : "+(p-o)/1e3)}n(t)}};if(c=i,this._boxes.has(t))if(this._boxes.set(t,e),i>0){var f=localStorage.getItem("OOCBoxMinSize");for(u=0;u<i;u++){let t=h[u];if(null!=f){let e=t.obj.getBoundingSphere();if(e&&2*e.radius<f){l++,t.skip=!0;continue}}this.forceReferenceLoad(e[u],p)}l&&d&&console.log(l+" objects can be skipped")}else{if(v.endProbe("box_"+t),d){var g=performance.now();console.log("box query : "+(o-r)/1e3+" / "+i+" cgrs : "+(g-o)/1e3)}n(t)}},e=>{i(t,e)})},C.prototype.releaseBox=function(e){if(!this._boxes.has(e))throw new Error("box with name "+e+" does not exist");var t,n=this._boxes.get(e);if(this._boxes.delete(e),n)for(t=0;t<n.length;t++)this.removeSceneGraphLock(n[t])},C.prototype.getTileSet=function(e){var t=this._getLDHReference(e,!0),n=null;if(t){var i=this._ldhNodeManager.getTileSets(t);n=i?i[0].oocTileSet:null}return n},C.prototype.getTileSets=function(e){var t=this._getLDHReference(e,!0),n=null;if(t){var i,r=this._ldhNodeManager.getTileSets(t);if(r)for(n=[],i=0;i<r.length;i++)n.push(r[i].oocTileSet)}return n},C.prototype.getTileSetsWithContentType=function(e,t){var n=this._getLDHReference(e,!0),i=null;if(n){var r,o,s,a,d=this._ldhNodeManager.getTileSets(n);if(d)for(i=[],r=0;r<d.length;r++)s=(o=d[r]).getRootNode(),a=o.oocTileSet.hasType(t),s.traverse(e=>(e.hasContentType(t)&&(a=!0),a)),a&&i.push(d[r].oocTileSet)}return i},C.prototype.registerHandlers=function({repRef:e,ref:t,tileSet:n}){this._handlers.repRef?console.warn("registerHandlers repRef ignored since already valued"):this._handlers.repRef=e,this._handlers.ref?console.warn("registerHandlers ref ignored since already valued"):this._handlers.ref=t,this._handlers.tileSet?console.warn("registerHandlers tileSet ignored since already valued"):this._handlers.tileSet=n},C.prototype.setSplattingParameters=function(e){this._ldhNodeManager.tilesManager.setSplattingParameters(e)},C.prototype.getHandler=function(e){return this._handlers[e]},C.prototype._doMassiveReload=function(e){var t,n,i,r,o=this.getAllReferences(),s=o.length,a=function(){s--,e&&0===s&&e()};for(t=0;t<o.length;t++)n=o[t],(r=this._getLDHReference(n)).isLeaf()?(i=r.getActiveRepresentation(),n=o[t],this.switchLOD(n,i.url,a,i.type,i.wms)):s--},C.prototype._getActiveRootLDHReferences=function(){var e=[];return this._rootOccurrenceTos.forEach(function(t,n,i){(t.enableExpand||t.treeModified)&&e.push(t.occurrence.reference)}),e},C.prototype._dispose=function(){this._ldhNodeManager.dispose()},C.prototype.replace360Root=function({fromRootId:e,toRootId:t,removeFromRoot:n,onTransitionCompleteCB:i}){let r=!1;function o(e,t){let n=t._rootOccurrenceTos.get(e),i=(n&&n.occurrence).reference,r=i&&t.getTileSetsWithContentType(i.referenceId,"360");return r&&1===r.length?r[0]:null}let s=o(e,this),a=o(t,this);if(s&&a){let t=this._ldhNodeManager.viewer._viewer360Manager;t&&t.start360TileSetTransition&&(t.start360TileSetTransition(s,a,i),r=!0),n&&this.removeRoot(e)}return r},C.prototype.replaceTileSetRoot=function(e,t,n){n=n||{};let i={};for(let e in n)i[e]=n[e];let r=n.onRemovedCB||null,o=n.onLoadedCB||null,s=n.onTransitionCompleteCB||null;i.onLoadedCB=(()=>{let t=!1;n.userRequest360&&this.replace360Root({fromRootId:e,toRootId:a,removeFromRoot:!1,onTransitionCompleteCB:s})&&(t=!0),this.removeRoot(e),r&&r(),o&&o(),!t&&s&&s()});let a=this.addRoot(t,i);return a},C.prototype._isMeshInRAMRequested=function(e,t){var n=this._getLDHReference(e,!0),i=n&&n.getLoadModelOptions();return i&&void 0!==i.noMeshInRAM?!i.noMeshInRAM:this._defaultLoadModelOptions&&void 0!==this._defaultLoadModelOptions.noMeshInRAM?!this._defaultLoadModelOptions.noMeshInRAM:!(!this._ldhNodeManager.getGlobalMeshInRAM(n,t)&&!this._lockMeshInRAMTos.has(e))},C.prototype._onRootReferenceLoaded=function(e){let t=this._getLDHReference(e,!0);if(t){var n=this._ldhNodeManager.getTileSets(t);if(n){let e=this._ldhNodeManager.viewer,t=!1;if(e){let i;for(i=0;i<n.length;i++)n[i].oocTileSet.hasType("360")&&(t=!0);t&&e.on360TileSetAdded()}}}this._rootOccurrenceTos.forEach(function(t,n,i){t&&t.onLoadedCB&&t.occurrence.reference.referenceId===e&&t.onLoadedCB(e)}),this._updateBoundingSphere()},C.prototype._onNodeCreate=function(e){var t=e.getModelIdentification();this._activateOverrideSetManager(t,e)},C.prototype._onNodeRemove=function(e){var t=e.getModelIdentification(),n=this._overrideSetManagerMap&&this._overrideSetManagerMap.get(t);n&&n._deactivate()},C.prototype._activateOverrideSetManager=function(e,t){var n=this._overrideSetManagerMap&&this._overrideSetManagerMap.get(e);if(n){var i=t||this._ldhNodeManager.idPathMatcher.idToNode(e);i&&(n.node=i,i._setOverrideSetManager(n),n._activate())}},C.prototype._computeUnitValue=function(e){return e?C.unitsTable[e]:1},C.prototype.getUnitValue=function(){return this._unitValue},C.prototype._registerPositionOverrideSet=function(e,t){this._idToPositionOverrideSets||(this._idToPositionOverrideSets=new Map);var n=this._idToPositionOverrideSets.get(e);n||(n=[],this._idToPositionOverrideSets.set(e,n)),-1===n.indexOf(t)&&n.push(t);var i=this._getLDHReference(e,!0),r=null;i||(i=this._getInstance(e),r=e),i&&i.updateOccurrencesPosition(this._ldhNodeManager,r),this._ldhNodeManager.requestUpdate(!0,!0)},C.prototype._unregisterPositionOverrideSet=function(e,t){var n=this._idToPositionOverrideSets&&this._idToPositionOverrideSets.get(e);if(n){var i=n.indexOf(t);i>=0&&n.splice(i,1),0===n.length&&this._idToPositionOverrideSets.delete(e)}var r=this._getLDHReference(e,!0),o=null;r||(r=this._getInstance(e),o=e),r&&r.updateOccurrencesPosition(this._ldhNodeManager,o),this._ldhNodeManager.requestUpdate(!0,!0)},C.prototype._findPositionOverride=function(e,t){var n=e.getIdPath(t);if(this._idToPositionOverrideSets){var i,r,o,s,a=this._idToPositionOverrideSets.get(n[n.length-1]),d=[];if(a){for(r=0;r<a.length;r++){var l;if(o=a[r],i=this._overrideSetManagerMap.get(o.rootId))if(s=i.getSceneGraphOverrideSetIndex(o),(l=n.indexOf(o.rootId))>=0){let e=n.slice(l),t=o._getPositionOverrides(e);t&&t.length>0&&d.push({depth:e.length,override:t[t.length-1],index:s})}}let e=-1,t=null,h=-1;for(r=0;r<d.length;r++)(d[r].depth>e||d[r].depth===e&&h<d[r].index)&&(e=d[r].depth,t=d[r].override,h=d[r].index);return t}}return null},C.prototype._getAutoInstanceId=function(){return"##OOCManager##Instance"+this._nextInstanceAutoId++},C.prototype.hasVirtualProduct=function(){return this._3DShapeCounter>0},C.prototype._on3DShapeAdd=function(){if(this._3DShapeCounter++,1===this._3DShapeCounter){let e=this._ldhNodeManager.viewer;e._modelEvent.publish({event:"VirtualProductAdded",data:{viewer:e}})}},C.prototype._on3DShapeRemove=function(){if(this._3DShapeCounter>0&&(this._3DShapeCounter--,0===this._3DShapeCounter)){let e=this._ldhNodeManager.viewer;e._modelEvent.publish({event:"VirtualProductRemoved",data:{viewer:e}})}},C.prototype._debug_getLastLoadingTime=function(){return this._ldhNodeManager.lastDeltaTime},C.unitsTable={mm:1,cm:10,dm:100,m:1e3,dam:1e4,hm:1e5,km:1e6};var x=function(){this.updatedRefencesMap=new Map,this.unloadTried=!1};return x.prototype.onAddChild=function(e){this.updatedRefencesMap.set(e,!0)},x.prototype.endTransaction=function(e){var t=[];this.updatedRefencesMap.forEach(function(e,n,i){var r=n;r&&t.push(r)}),e._ldhNodeManager.onInstRefGraphTransactionEnd(t)},x.prototype.onCPUMemoryFull=function(e){e._ldhNodeManager.instRefTransactionCPUMemoryFullOccurred=!0},require(["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Selection/HSOManager","DS/Visualization/PathElement"],function(e,t,n,i,r){var o=null;window.OOCShowReferenceBoundingSphere=function(i,r,s,a){var d=r._getLDHReference(i),l=d.getBoundingBox(),h=d.getNode(),c={cornerPoint:l.min,firstAxis:new t.Vector3(l.max.x-l.min.x,0,0),secondAxis:new t.Vector3(0,l.max.y-l.min.y,0),thirdAxis:new t.Vector3(0,0,l.max.z-l.min.z),material:new t.MeshBasicMaterial({color:"red",force:!0,opacity:.2,transparent:!0})};null===o&&(o=new n("##OOCDebugBBRoot"),s.addNode(o));var u,p,f=d.isSlave()?h._occurrences:d._occurrences;for(u=0;u<f.length;u++)p=f[u].matrix,(h=e.createCuboidNode(c)).setMatrix(p),a&&h.setNoZ(!0),o.addChild(h);debugWebGLV6Viewer.render()},window.OOCBuildTileModelPreloadData=function(e,t){e=e||window.oocLDHNodeManager.oocManager,t=t||window.debugWebGLV6Viewer;var n=e.getRootOccurrences().values().next().value.occurrence,i=n&&n.reference.referenceId,r={viewpoint:{pos:t.currentViewpoint.getEyePosition().createJSON(),sight:t.currentViewpoint.getSightDirection().createJSON(),up:t.currentViewpoint.getUpDirection(),distanceToTarget:t.currentViewpoint.getTargetDistance()},rootId:i};return JSON.stringify(r)},window.OOCHighlightReference=function(e,t,n){var o=(t=t||window.oocLDHNodeManager.oocManager).getSceneGraphNode(e);if(o){var s=new r([o]);!n&&i.empty(),i.add({pathElement:s})}else console.log("no node");return t._getLDHReference(e,!0)}}),C.Mode={unknown:"unknown",ooc:"ooc",slave:"slave"},C.RepType={none:g.RepType.none,av1:g.RepType.av1,pr:g.RepType.pr,rr:g.RepType.rr},C});