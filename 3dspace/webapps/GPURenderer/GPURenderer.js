define("DS/GPURenderer/ComputeInterface",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";class t{constructor(e,t,r){var i={label:"compute pipeline Layout",bindGroupLayouts:t};this.pipelineLayout=e.createPipelineLayout(i),this.shaderModule=e.createShaderModule({label:"Compute Shader Module",code:r});var s={layout:this.pipelineLayout,compute:{module:this.shaderModule,entryPoint:"compute_main"}};this.wgpuPipeline=e.createComputePipeline(s)}}class r{constructor(e){if(this._setShaderContent(e.shaderContent),this._setWorkgroupSize(e.workgroupSize),this.bindingGroupsDesc=[],e.bindingDescriptions)for(let t=0;t<e.bindingDescriptions.length;t++)this._addBindingDescription(e.bindingDescriptions[t])}_setShaderContent(e){this.shaderContent=e,this._resetPipeline()}_setWorkgroupSize(t){this.workgroupSize=t||new e.Vector3(1,1,1),this._resetPipeline()}_addBindingDescription(e){let t=e.group||0,r=this.bindingGroupsDesc[t];r||(r=[],this.bindingGroupsDesc[t]=r),r[r.length]=e,this._resetPipeline()}_resetPipeline(){this.shader=null,this.bindgroupLayouts=null,this.pipeline=null}_getBindGroupLayout(e){if(!this.bindgroupLayouts){let t=[];for(let r=0;r<this.bindingGroupsDesc.length;r++){let i={label:"compute bindgroup "+r,entries:[]},s=this.bindingGroupsDesc[r];for(let e=0;e<s.length;e++)i.entries.push({binding:e,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}});let n=e.createBindGroupLayout(i);t.push(n)}this.bindgroupLayouts=t}return this.bindgroupLayouts}_getFullShader(){if(!this.shader){let e="";for(let t=0;t<this.bindingGroupsDesc.length;t++){let r=this.bindingGroupsDesc[t];for(let i=0;i<r.length;i++){e+=`@group(${t}) @binding(${i}) var<storage, read_write> ${r[i].name}: array<f32>;\n                        `}}this.shader=`\n                ${e}\n            \n                @compute @workgroup_size(${this.workgroupSize.x},${this.workgroupSize.y},${this.workgroupSize.z}) fn compute_main(\n                    @builtin(global_invocation_id) global_invocation_id: vec3u,\n                    @builtin(local_invocation_id) local_id: vec3u,\n                    @builtin(local_invocation_index) local_index: u32,\n                    @builtin(workgroup_id) workgroup_id: vec3u,\n                    @builtin(num_workgroups) num_workgroups: vec3u,\n                ) {\n                    ${this.shaderContent}\n                }\n                `}return this.shader}getPipeline(e){return this.pipeline||(this.pipeline=new t(e,this._getBindGroupLayout(e),this._getFullShader())),this.pipeline}}class i{constructor(t){this.shader=new r(t),this.bindings=new Map,this.bindgroups=null,this.workgroupCount=new e.Vector3(1,1,1)}setBinding(e,t){this.bindgroups=null,this.bindings.set(e,t)}setWorkgroupCount(t){this.workgroupCount=t||new e.Vector3(1,1,1)}getBindGroups(e){if(!this.bindgroups){this.bindgroups=[];let t=this.shader._getBindGroupLayout();for(let r=0;r<this.shader.bindingGroupsDesc.length;r++){let i=this.shader.bindingGroupsDesc[r],s=[];for(let e=0;e<i.length;e++)s.push({binding:e,resource:{buffer:this.bindings.get(i[e].name)}});let n=e.createBindGroup({layout:t[r],entries:s});this.bindgroups.push(n)}}return this.bindgroups}encodeCompute(e,t){t.setPipeline(this.shader.getPipeline(e).wgpuPipeline);let r=this.getBindGroups(e);for(let e=0;e<r.length;e++)t.setBindGroup(e,r[e]);t.dispatchWorkgroups(this.workgroupCount.x,this.workgroupCount.y,this.workgroupCount.z)}}return class{constructor(e){this.device=e,this.USAGES=GPUBufferUsage,this.passesEncoders=[]}_addPass(e,t){t&&this.passesEncoders.push({pass:e,commandEncoder:t})}_endCommandEncoder(e){for(let t=0;t<this.passesEncoders.length;t++){let r=this.passesEncoders[t];if(r.pass==e)return this.device.queue.submit([r.commandEncoder.finish()]),void this.passesEncoders.splice(t,1)}}getPassEncoder(e,t){let r=null;t||(t=r=this.device.createCommandEncoder({label:e}));let i=t.beginComputePass();return this._addPass(i,r),i}endPassEncoder(e){e.end(),this._endCommandEncoder(e)}getEmptyStorageBuffer(e,t){return this.device.createBuffer({label:"compute buffer",size:t,usage:GPUBufferUsage.STORAGE|(e||GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)})}getStorageBuffer(e,t){let r=this.getEmptyStorageBuffer(e,t.byteLength);return this.device.queue.writeBuffer(r,0,t),r}copyfromStorageBufferToMappableBuffer(e,t){let r=this.device.createBuffer({label:"result buffer",size:e.size,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});if(t)t.copyBufferToBuffer(e,0,r,0,r.size);else{let t=this.device.createCommandEncoder({label:"read from storage command encoder"});t.copyBufferToBuffer(e,0,r,0,r.size),this.device.queue.submit([t.finish()])}return r}getMappedCopyOfStorageBufferAsync(e){let t=this;return new Promise(function(r,i){let s=t.copyfromStorageBufferToMappableBuffer(e);s.mapAsync(GPUMapMode.READ).then(function(){r(new Float32Array(s.getMappedRange()))})})}createComputeDescriptor(e){return new i(e)}simpleCreateBindGroup(e){let t={label:"simple compute bindgroup",entries:[]},r=[];for(let i=0;i<e.length;i++){let s=i;t.entries.push({binding:s,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}),r.push({binding:s,resource:{buffer:e[i]}})}let i=this.device.createBindGroupLayout(t);return[i,this.device.createBindGroup({layout:i,entries:r})]}simpleCompute(e,r,i){let s=this;return new Promise(function(n,a){let o=s.getPassEncoder(),u=[];for(let t=0;t<e.length;t++)u.push(s.getStorageBuffer(null,e[t]));let[l,h]=s.simpleCreateBindGroup(u),p=new t(s.device,[l],r);o.setPipeline(p.wgpuPipeline),o.setBindGroup(0,h),o.dispatchWorkgroups(i.x,i.y,i.z),s.endPassEncoder(o);let c=[],d=[];for(let e=0;e<u.length;e++){let t=s.copyfromStorageBufferToMappableBuffer(u[e]);c.push(t.mapAsync(GPUMapMode.READ)),d.push(t)}Promise.all(c).then(function(){let e=[];for(let t=0;t<d.length;t++)e.push(new Float32Array(d[t].getMappedRange()));n(e)})})}executeCompute(e,t){let r=this.getPassEncoder(e.label,t);e.encodeCompute(this.device,r),this.endPassEncoder(r)}}}),define("DS/GPURenderer/WebGPURenderPipeline",[],function(){"use strict";var e=function(e){let t=e.attributes.length>1;return`\n        struct GlobalUniforms\n        {\n        \tviewMatrix : mat4x4f,\n        \tprojectionMatrix : mat4x4f,\n            position : vec3f,\n            lowPartCameraPosition: vec3f\n        };\n\n        struct MaterialUniforms\n        {\n        \tbaseColor : vec4f\n        };\n\n        struct ObjectUniforms\n        {\n        \tmodelMatrix : mat4x4f\n        };\n\n        @group(0) @binding(0) var<uniform> global_uniforms : GlobalUniforms;\n        @group(1) @binding(0) var<uniform> material_uniforms : MaterialUniforms;\n        @group(2) @binding(0) var<uniform> object_uniforms : ObjectUniforms;\n\n        struct VertexIn\n        {\n            @location(0) position : vec3f,\n            ${t?"@location(1) normal : vec3f":""}\n        }\n\n        struct VertexOut\n        {\n        \t@builtin(position) pos : vec4f,\n            ${t?"@location(0) normal : vec4f":""}\n        };\n\n        struct PixelOutput\n        {\n        \t@location(0) out0 : vec4f\n        };\n\n        @vertex\n        fn vertex_main(input: VertexIn) -> VertexOut\n        {\n        \tvar out : VertexOut;\n        \tout.pos = global_uniforms.projectionMatrix * global_uniforms.viewMatrix * object_uniforms.modelMatrix * vec4f(input.position, 1.0);\n            ${t?"out.normal = vec4f(input.normal, 0.0);":""}\n        \treturn out;\n        }\n        \n        // Some hardcoded lighting\n        const lightDir = vec3f(0.25, 0.5, 1);\n        const lightColor = vec3f(1);\n        const ambientColor = vec3f(0.1);\n\n        @fragment\n        fn fragment_main(vert : VertexOut) -> PixelOutput\n        {\n        \tvar out : PixelOutput;\n\n            // An extremely simple directional lighting model, just to give our model some shape\n            ${t?"let N = normalize(vert.normal.xyz);":"let N = vec3f(0.0,0.0,1.0);"}\n            let L = normalize(lightDir);\n            let NDotL = max(dot(N, L), 0.0);\n            let surfaceColor = (material_uniforms.baseColor.rgb * ambientColor) + (material_uniforms.baseColor.rgb * NDotL);\n            out.out0 = vec4f(surfaceColor, material_uniforms.baseColor.a);\n            return out;\n        }\n    `};return class{constructor(t,r,i,s,n,a,o){this.gpuDevice=t,this.key=s.program.id,this.renderState=o,this.bufferLayout=this.createBufferLayout(i.layout,s.program.shaderIO),this.bindGroupLayouts=n;let u="shader module : "+this.key;this.shaderModule=t.createShaderModule({label:u,code:s.program.shaderIO?s.wgslShaderCode:e(this.bufferLayout)}),this.layoutOrder=[];let l=[];for(let e=0;e<a.length;e++)n.has(a[e])&&(l.push(n.get(a[e])),this.layoutOrder.push(a[e]));var h={label:"Pipeline Layout",bindGroupLayouts:l};this.pipelineLayout=t.createPipelineLayout(h),this.wgpuPipeline=t.createRenderPipeline(this.getPipelineDescriptor())}getKey(){return this.key}getPipeline(){return this.wgpuPipeline}fillBuffer(e,t,r,i,s){for(var n=t.program.shaderIO.orderedUniforms[s],a=0;a<n.length;a++){var o=n[a],u=o.name;if("_colorOverride"!==u){var l=o.type,h=o.defaultValue,p=o.offset/4;if(o.functionLoad){var c="material"===o.functionContext?t:e,d=(0,o.functionLoad)(c);"v2"===l?(i[p]=d[0],i[p+1]=d[1]):i[p]=d}else{var f="color"===o.materialType,g="array"===o.materialType,m=o.size,w=o.materialName?o.materialName:u,b=w?w.split("."):null,P="object"===s?e:w.includes("directional")||w.includes("ambient")?r:t;P=P.uniformHandler?P.uniformHandler:P;var _=w?P[w]:P[u];if(b.length>1){var U=b[0];(U="anymap"===b[0]?t.map?"map":t.specularMap?"specularMap":t.normalMap?"normalMap":t.bumpMap?"bumpMap":null:b[0])?_=P[U][b[1]]:"offsetBumpMap"===u?_={x:0,y:0}:"repeatBumpMap"===u&&(_={x:1,y:1})}switch("ambient"===w&&(_=P[w]),void 0===_&&void 0!==h&&(_=h),l){case"i":new Uint32Array(i.buffer)[p]=_;break;case"f":i[p]=_;break;case"v2":i[p]=_.x,i[p+1]=_.y;break;case"fv3":case"fv4":case"v3":case"v4":if(m>0)if("v4"===l||"fv4"==l)for(var v=0;v<m;v++)i[p++]=_[4*v],i[p++]=_[4*v+1],i[p++]=_[4*v+2],i[p++]=_[4*v+3];else for(v=0;v<m;v++)i[p++]=_[3*v],i[p++]=_[3*v+1],i[p++]=_[3*v+2],p++;else f?(i[p]=_.r,i[p+1]=_.g,i[p+2]=_.b,"v4"===l&&(i[p+3]=_.a)):g?(i[p]=_[0],i[p+1]=_[1],i[p+2]=_[2],"v4"===l&&(i[p+3]=_[3])):(i[p]=_.x,i[p+1]=_.y,i[p+2]=_.z,"v4"===l&&(i[p+3]=_.w));break;case"m3":i[p++]=_.elements[0],i[p++]=_.elements[1],i[p++]=_.elements[2],p++,i[p++]=_.elements[3],i[p++]=_.elements[4],i[p++]=_.elements[5],p++,i[p++]=_.elements[6],i[p++]=_.elements[7],i[p++]=_.elements[8];break;case"m4":"_modelMatrixForDoubleGPU"===u?i.set(e._mElements,p):i.set(_.elements,p)}}}}}createBufferLayout(e,t){for(var r={arrayStride:0,stepMode:"vertex",attributes:[]},i=e.getBufferAttributes(),s=t?t.attribute:null,n=0,a={position:"aPosition",normal:"aNormal",uv:"aUv",uv2:"aUv2",tangent:"aTangent",binormal:"aBinormal"},o=0;o<i.length;o++){var u=i[o][0],l=a[u];if(s&&!s[l])break;var h=s?s[l].location:o;r.attributes.push({format:"float32x3",offset:12*h,shaderLocation:h}),n++}return r.arrayStride=12*n,r}getPipelineDescriptor(){let e=this.renderState.passInfo.renderTarget,t=e.depthStencilFormat,r=[];for(let t=0;t<e.colorCount;t++)r.push({format:e.format});return{layout:this.pipelineLayout,primitive:{topology:"triangle-list",frontFace:"ccw",cullMode:"back"},depthStencil:{format:t,depthWriteEnabled:!0,depthCompare:this.renderState.pipelineInfo.depthCompare},multisample:{count:e.multisample?4:1},vertex:{module:this.shaderModule,entryPoint:"vertex_main",buffers:[this.bufferLayout]},fragment:{module:this.shaderModule,entryPoint:"fragment_main",targets:r}}}}}),define("DS/GPURenderer/Commands",[],function(){"use strict";class e{constructor({pipeline:e,resources:t=null}){this.resources=t,this.pipeline=e,this._bindings=this.pipeline.getBindGroups(this.resources)}_encodeWebGPU(e){this.pipeline._encodeWebGPUBindGroups(e,this._bindings),e.setPipeline(this.pipeline.getGPUPipeline())}}class t extends e{constructor({geometry:e=null,indexBuffer:t=null,vertexBuffers:r=null,pipeline:i,resources:s=null}){super({pipeline:i,resources:s}),this.indexBuffer=e?e._webgpu.index:t,this.vertexBuffers=e?e._webgpu.vertex:r}isRenderCommand(){return!0}_encodeWebGPU(e){if(super._encodeWebGPU(e),this.indexBuffer){const t=this.indexBuffer.getGPUBufferView();e.setIndexBuffer(t.buffer,this.indexBuffer.index32bit?"uint32":"uint16",t.offset,t.size)}const t=this.vertexBuffers?this.vertexBuffers.length:0;for(let r=0;r<t;r++){const t=this.vertexBuffers[r].getGPUBufferView();e.setVertexBuffer(r,t.buffer,t.offset,t.size)}}}return{Draw:class extends t{constructor({vertexCount:e=null,vertexOffset:t=0,instanceCount:r=1,instanceOffset:i=0,geometry:s=null,vertexBuffers:n=null,pipeline:a,resources:o=null}){super({geometry:s,indexBuffer:null,vertexBuffers:n,pipeline:a,resources:o});const u=this.vertexBuffers&&this.vertexBuffers.length>0?this.vertexBuffers[0].numVertices:0;this.vertexCount=e||u,this.vertexOffset=t,this.instanceCount=r,this.instanceOffset=i}_encodeWebGPU(e){super._encodeWebGPU(e),e.draw(this.vertexCount,this.instanceCount,this.vertexOffset,this.instanceOffset)}},DrawIndexed:class extends t{constructor({indexCount:e=null,indexOffset:t=0,vertexOffset:r=0,instanceCount:i=1,instanceOffset:s=0,geometry:n=null,indexBuffer:a=null,vertexBuffers:o=null,pipeline:u,resources:l=null}){super({geometry:n,indexBuffer:a,vertexBuffers:o,pipeline:u,resources:l});const h=this.indexBuffer?this.indexBuffer.numIndices:0;this.indexCount=e||h,this.indexOffset=t,this.vertexOffset=r,this.instanceCount=i,this.instanceOffset=s}_encodeWebGPU(e){super._encodeWebGPU(e),e.drawIndexed(this.indexCount,this.instanceCount,this.indexOffset,this.vertexOffset,this.instanceOffset)}},DrawIndirect:null,DrawIndirectIndexed:null,Dispatch:null,DispatchIndirect:null}}),define("DS/GPURenderer/WebGPURenderTarget",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=0;return class{constructor(r,i,s,n,a){e.EventDispatcher.call(this),this.uniqueID=t++,this.width=r,this.height=i,this.colorCount=n,this.multisample=a,this.format=s.format,this.depthStencilFormat="depth24plus-stencil8",this.optionId=null,this.resolveTarget=null,this.canvasTarget=null,this.__colorTextures=[],this.__depthTexture=null,this.__init=!1,this.reset(s)}init(e){if(!this.canvasTarget&&this.__colorTextures.length!=this.colorCount){let t=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.TEXTURE_BINDING,r={size:{width:this.width,height:this.height},format:this.format,sampleCount:this.multisample?4:1,usage:t};for(let t=0;t<this.colorCount;t++)this.__colorTextures[t]=e.createTexture(r)}this.__depthTexture||(this.__depthTexture=e.createTexture({size:{width:this.width,height:this.height},sampleCount:this.multisample?4:1,format:this.depthStencilFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT}))}getRenderPassDescriptor(e){let t={colorAttachments:[],depthStencilAttachment:{view:this.__depthTexture.createView(),depthClearValue:e.clearDepth,depthLoadOp:e.depthLoadOp,depthStoreOp:e.depthStoreOp,stencilClearValue:e.clearStencil,stencilLoadOp:e.stencilLoadOp,stencilStoreOp:e.stencilStoreOp,depthReadOnlyValue:!1,stencilReadOnlyValue:!1}};for(let r=0;r<this.colorCount;r++)this.resolveTarget?t.colorAttachments.push({view:this.__colorTextures[r].createView(),resolveTarget:resolveTarget.createTextureView(),clearValue:e.clearColor,loadOp:e.colorLoadOp,storeOp:e.colorStoreOp}):t.colorAttachments.push({view:this.canvasTarget?this.canvasTarget.createTextureView():this.__colorTextures[r].createView(),clearValue:e.clearColor,loadOp:e.colorLoadOp,storeOp:e.colorStoreOp});return t}getTexture(t,r=0){if(!this.sampler){function i(t){switch(t){case e.ClampToEdgeWrapping:return"clamp-to-edge";case e.MirroredRepeatWrapping:return"mirror-repeat";default:return"repeat"}}const r={label:this.optionId+"Sampler",addressModeU:i(this.options.wrapS),addressModeV:i(this.options.wrapT)};switch(this.options.magFilter&&this.options.magFilter!=e.LinearFilter||(r.magFilter="linear"),this.options.minFilter){case e.NearestFilter:break;case e.LinearFilter:case e.LinearMipMapNearestFilter:r.minFilter="linear";break;case e.NearestMipMapLinearFilter:r.mipmapFilter="linear";break;case e.LinearMipMapLinearFilter:default:r.minFilter="linear",r.mipmapFilter="linear"}this.sampler=t.createSampler(r)}return{_wgpuSampler:this.sampler,_wgpuTexture:this.__colorTextures[r]}}setResolveTarget(e){this.resolveTarget=e}setCanvas(e){this.canvasTarget=e}reset(e){this.sampler=null,this.options=e}dispose(){for(let e=0;e<this.__colorTextures.length;e++)this.__colorTextures[e].destroy();this.__depthTexture&&this.__depthTexture.destroy(),this._disposed=!0}}}),define("DS/GPURenderer/Resource",[],function(){"use strict";let e=0;return class{constructor({container:t}){Object.defineProperty(this,"id",{value:e++,enumerable:!1,writable:!1}),this._container=t,this._webgpu=null}_destroy(){throw new Error("Not implemented")}isView(){return!1}getViewedResource(){return null}getResourcePool(){return this._container}getGPUAdapter(){return this._container.getGPUAdapter()}getGPUDevice(){return this._container.getGPUDevice()}getGPUBindingResource(){throw new Error("Not implemented")}getLabel(){return`${this.constructor.name}-${this.id}`}}}),define("DS/GPURenderer/Utils",[],function(){"use strict";function e(e){const t=e.byteLength;let r=e,i=0;return e instanceof ArrayBuffer||(r=e.buffer,i=e.byteOffset),{source:r,offset:i,size:t}}return{viewRawArrayBuffer:e,viewUint8Array:function(t){if(t instanceof Uint8Array)return t;const r=e(t);return new Uint8Array(r.source,r.offset,r.size)},murmurhash3:function(e,t){let r=3&(e=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)).length,i=e.length-r,s=t,n=0,a=0;for(;n<i;)s=5*(s=(s^=a=13715*(a=(a=11601*(a=e[n++]|e[n++]<<8|e[n++]<<16|e[n++]<<24)+-862060544*(65535&a)&4294967295)<<15|a>>>17)+461832192*(65535&a)&4294967295)<<13|s>>>19)+3864292196&4294967295;switch(a=0,r){case 3:a^=e[n+2]<<16;case 2:a^=e[n+1]<<8;case 1:s^=a=13715*(a=(a=11601*(a^=e[n])+-862060544*(65535&a)&4294967295)<<16|a>>>16)+461832192*(65535&a)&4294967295}return s^=e.length,s=51819*(s^=s>>>16)+2246770688*(65535&s)&4294967295,s=44597*(s^=s>>>13)+3266445312*(65535&s)&4294967295,(s^=s>>>16)>>>0},fnv32a:function(e,t){let r=t=>e[t];e.charCodeAt&&(r=(t=>e.charCodeAt(t)));let i=t||2166136261;for(let t=0;t<e.length;t++)i^=r(t),i+=(i<<1)+(i<<4)+(i<<7)+(i<<8)+(i<<24);return i>>>0}}}),define("DS/GPURenderer/Debug",[],function(){"use strict";class e{constructor(e){this.resource_id=e}}const t={generateID:function(e=15){let t="";const r=crypto.getRandomValues(new Uint8Array(e));for(let i=0;i<e;i++){let e=63&r[i];t+=e<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():"-_"[+(63==e)]}return t},id_res:new Map,res2ID:function(e){return this.id_res.has(e)||this.id_res.set(e.id,new WeakRef(e)),e.id},ID2res:function(e){let t=this.id_res.get(e);if(t)return(t=t.deref())||this.id_res.delete(e),t},getResourceData_impl(t,r,i=!0){const s=r.contains(t);if(i&&s)return new e(t.id);if(Array.isArray(t))return t.map(e=>this.getResourceData_impl(e,r));if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))return t.slice();if("object"==typeof t){const e=Object.getOwnPropertyNames(t),i=Object.getOwnPropertyDescriptors(t.constructor.prototype);for(let t in i)!i[t].get||i[t].set||i[t].writable||e.push(t);const n={};for(let i of e)(!s||"_webgpu"!==i&&"_container"!==i)&&(n[i]=this.getResourceData_impl(t[i],r));return n}return structuredClone(t)},getResourceData(e,t){return this.getResourceData_impl(e,t,!1)}};class r{constructor({name:e=null,procedures:r}){this.id=t.generateID(),this.name=e||document.title,this.procedures=r,this.requested={},this.num_requested=0,this.index=null,this.channel=new BroadcastChannel("web-visu/gpu-debug"),this.channel.onmessage=(e=>{if(!e.data.type)return;let t=this[`on_${e.data.type}`];t&&t.call(this,e.data)}),this.signal()}enableIndexing(){this.index=new Map,this.scan()}disableIndexing(){this.index=null}periodicIndexing({scanPeriod:e=1e3,maxAge:t=1100,callback:r}){if(this.isIndexingEnabled())return;return this.enableIndexing(),setInterval(r?()=>{this.scan(t),r()}:()=>{this.scan(t)},e)}isIndexingEnabled(){return!!this.index}pruneIndex(e=1100){if(!this.index)return;const t=Date.now();this.index.forEach((r,i)=>{t-r.date>e&&this.index.delete(i)})}scan(e){this.index&&(this.channel.postMessage({type:"scan"}),e&&e>0&&this.pruneIndex(e))}on_scan(e){this.signal()}signal(){this.channel.postMessage({type:"item",id:this.id,name:this.name})}on_item(e){this.index&&"string"==typeof e.id&&this.index.set(e.id,{name:e.name,date:Date.now()})}call(e,t,...r){return new Promise((i,s)=>{const n=this.num_requested++;this.requested[n]={id:e,resolve:i,reject:s},this.channel.postMessage({type:"call",id:e,seq:n,func:t,args:r})})}on_call(e){if(e.id===this.id)try{let t=this.procedures[e.func];if(!t)throw new Error(`Unknown function '${e.func}'`);this.channel.postMessage({type:"result",id:this.id,seq:e.seq,value:t(...e.args)})}catch(t){this.channel.postMessage({type:"result",id:this.id,seq:e.seq,error:t})}}on_result(e){let t=this.requested[e.seq];t&&e.id===t.id&&(delete this.requested[e.seq],e.hasOwnProperty("value")?t.resolve(e.value):t.reject(e.error))}}return{Channel:r,setupRenderGraphRemoteDebug:function(e){const i=e.resourcePool;return new r({procedures:{listResources(){let e=new Map;return i.forEach(r=>e.set(t.res2ID(r),r.constructor.name)),e},detailResource(e){let r=t.ID2res(e);return r?{id:e,typename:r.constructor.name,raw:t.getResourceData(r,i)}:null}}})}}}),define("DS/GPURenderer/Base",[],function(){"use strict";const e={Color:1,Depth:2,Stencil:4,Renderable:8};return{BufferCPUAccess:{None:0,Stage:1,MapRead:2,MapWrite:3},TextureType:e,TextureFormats:{rgba8unorm:{type:e.Renderable|e.Color},bgra8unorm:{type:e.Renderable|e.Color},stencil8:{type:e.Renderable|e.Stencil},depth16unorm:{type:e.Renderable|e.Depth},depth24plus:{type:e.Renderable|e.Depth},"depth24plus-stencil8":{type:e.Renderable|e.Depth|e.Stencil},depth32float:{type:e.Renderable|e.Depth}}}}),define("DS/GPURenderer/Resource.Pipelines",["DS/GPURenderer/Utils","DS/GPURenderer/Resource"],function(e,t){"use strict";class r extends t{constructor({resourceLocations:e={},container:t}){super({container:t}),this.resourceLocations=e}getBindGroups(e){if(!e)return null;let t=[];for(let r in this.resourceLocations){const[i,s]=this.resourceLocations[r];void 0===t[i]&&(t[i]=[]),t[i][s]=e[r]}return t.map(e=>this.getResourcePool().getBindGroup(e))}_encodeWebGPUBindGroups(e,t){if(t)for(let r=0;r<t.length;r++)e.setBindGroup(r,t[r].getGPUBindGroup(this.getGPUBindGroupLayout(r)))}}return{RenderPipeline:class extends r{constructor({resourceLocations:e={},_wgpu:t,container:r}){super({resourceLocations:e,container:r}),t.layout="auto",window._warned_deprecated_automatic_pipeline_layout||console.warn("Deprecated !\n\t\t\t\t\t\tAutomatic pipeline layouts are expected to be removed from the spec.\n\t\t\t\t\t\tWe should derive actual pipeline layouts from the given shaders\n\t\t\t\t\t\t(reminder: we do not have the actual resources when creating the pipeline)."),window._warned_deprecated_automatic_pipeline_layout=!0;const i=this.getGPUDevice().createRenderPipeline(t);this._webgpu={pipeline:i,layouts:Array.from({length:this.getGPUDevice().limits.maxBindGroups},(e,t)=>i.getBindGroupLayout(t))}}getGPUPipeline(){return this._webgpu.pipeline}getGPUBindGroupLayout(e){return this._webgpu.layouts[e]}},ComputePipeline:class extends r{}}}),define("DS/GPURenderer/Pass",["DS/GPURenderer/Base"],function(e){"use strict";return class{static Input(e){return{format:e}}static Output(t,r){if(!e.TextureFormats.hasOwnProperty(t))throw new Error(`Pass output: unknown texture format ${t}`);if(!(e.TextureFormats[t].type&e.TextureType.Renderable))throw new Error(`Pass output: format ${t} is not renderable`);return{format:t,init:r}}constructor({inputLayout:e,outputLayout:t}){this.name=null,this.graph=null,this.inputConnections=null,this.outputConnections=null,this.inputLayout=e||null,this.outputLayout=t||null,this.inputLayout&&(this.inputConnections=Array(this.inputLayout.length).fill(null)),this.outputLayout&&(this.outputConnections=Array(this.outputLayout.length).fill().map(e=>[]))}computeCommands(){throw new Error("Not implemented")}computeSizes(e){let t=void 0;const r=this.outputLayout?this.outputLayout.length:0,i=this.inputLayout?this.inputLayout.length:0;for(let i=0;!t&&i<r;i++)t=e.outputs[i];for(let r=0;!t&&r<i;r++)t=e.inputs[r];for(let i=0;i<r;i++)e.outputs[i]=t;for(let r=0;r<i;r++)e.inputs[r]=t}}}),define("DS/GPURenderer/Resource.Textures",["DS/GPURenderer/Resource"],function(e){"use strict";class t extends e{resize(e){throw new Error("Not implemented")}getGPUTexture(){throw new Error("Not implemented")}createTextureView(){throw new Error("Not implemented")}}return{CanvasResource:class extends t{constructor({canvas:e,container:t}){super({container:t}),this.canvas=e,this.size={width:-1,height:-1},this.format=navigator.gpu.getPreferredCanvasFormat(),this._webgpu=this.canvas.getContext("webgpu"),this.resize()}resize(e=null){e||(e=this.canvas.getBoundingClientRect()),e.width===this.size.width&&e.height===this.size.height||(this.size.width=e.width,this.size.height=e.height,this._configure())}_configure(){this.canvas.width=this.size.width,this.canvas.height=this.size.height,this._webgpu.configure({device:this.getGPUDevice(),format:this.format,alphaMode:"opaque",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.SHADER_READ})}getGPUTexture(){return this._webgpu.getCurrentTexture()}createTextureView(){return this._webgpu.getCurrentTexture().createView()}},TextureResource:class extends t{constructor({size:e,format:t,container:r}){super({container:r}),this._setup(e,t)}resize(e){e.width===this.size.width&&e.height===this.size.height&&e.depth===this.size.depth||this._setup(e,this.format)}getGPUTexture(){return this._webgpu}createTextureView(){return this._webgpu.createView()}_setup(e,t){this.format=t,this.size={width:e.width};let r="1d";e.height&&(this.size.height=e.height,r="2d"),e.depth&&(this.size.depth=e.depth,r="3d");let i={size:this.size,dimension:r,format:this.format,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.SHADER_READ};e.sampleCount&&(i.sampleCount=e.sampleCount),this._webgpu=this.getGPUDevice().createTexture(i)}}}}),define("DS/GPURenderer/Resource.Buffers",["DS/GPURenderer/Base","DS/GPURenderer/Utils","DS/GPURenderer/Resource"],function(e,t,r){"use strict";class i extends r{constructor({buffer:e=null,offset:t=0,size:r,container:i}){super({container:i}),this.buffer=e,this.offset=t,this.size=r}get alignment(){return 1}get stride(){return 1}get end(){return this.offset+this.size}isView(){return!0}getViewedResource(){return this.buffer}getGPUBuffer(){return this.buffer.getGPUBuffer()}getGPUBufferView(){return{buffer:this.getGPUBuffer(),offset:this.offset,size:this.size}}getGPUBindingResource(){return this.getGPUBufferView()}write({data:e,offset:r=0}){if(e=t.viewUint8Array(e),r<0||r+e.length>this.size)throw new Error("Out-of-range write");this.buffer.write({data:e,offset:r+this.offset})}upload(e){if(0===(e=t.viewRawArrayBuffer(e)).size)return;if(e.size>this.size)throw new Error(`Cannot upload data (size ${e.size} B) into buffer view (size ${this.size} B)`);const r=this.getGPUDevice().queue;return r.writeBuffer(this.getGPUBuffer(),this.offset,e.source,e.offset,e.size),r.onSubmittedWorkDone()}}return{BufferResource:class extends r{constructor({size:t,container:r,access:i=e.BufferCPUAccess.None,views:s=[]}){super({container:r});{s.sort((e,t)=>t.alignment-e.alignment);let e=0;for(let t=0;t<s.length;t++){const r=e%s[t].alignment;0!==r&&(e+=s[t].alignment-r),s[t].offset=e,e+=s[t].size}if(t||(t=e),t<e)throw new Error(`cannot create buffer of size ${t} B with ${s.length} views needing ${e} B`)}this.size=t,this.access=i,this._stage=null,i===e.BufferCPUAccess.Stage&&(this._stage={buffer:new Uint8Array(t),changed:!1}),this._views=s,this._views&&this._views.forEach(e=>e.buffer=this),this._webgpu=this.getGPUDevice().createBuffer({size:this.size,usage:GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST|GPUBufferUsage.INDEX|GPUBufferUsage.VERTEX|GPUBufferUsage.UNIFORM|GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.QUERY_RESOLVE,mappedAtCreation:i===e.BufferCPUAccess.MapRead||i===e.BufferCPUAccess.MapWrite})}_destroy(){this._webgpu.destroy()}getGPUBuffer(){return this._webgpu}getGPUBufferView(){return{buffer:this.getGPUBuffer(),offset:0,size:this.size}}getGPUBindingResource(){return this.getGPUBufferView()}write({data:r,offset:i}){switch(r=t.viewUint8Array(r),this.access){case e.BufferCPUAccess.Stage:this._stage.buffer.set(r,i),this._stage.changed=!0;break;case e.BufferCPUAccess.MapWrite:new Uint8Buffer(this._webgpu.getMappedRange(i,r.length)).set(r);break;default:throw new Error("Invalid operation: cannot write on a buffer that does not have CPU write access")}}flush(){this.access===e.BufferCPUAccess.Stage&&this._stage.changed&&(this.getGPUDevice().queue.writeBuffer(this.getGPUBuffer(),0,this._stage.buffer,0,this.size),this._stage.changed=!1)}},BufferView:i,IndexView:class extends i{constructor({numIndices:e,index32bit:t,buffer:r=null,offset:i=0,container:s}){super({buffer:r,offset:i,size:e*(t?4:2),container:s}),this.index32bit=t}get alignment(){return this.indexSize}get stride(){return this.indexSize}get indexSize(){return this.index32bit?4:2}get numIndices(){return this.size/this.indexSize}getGPUBufferUsage(){return GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST|GPUBufferUsage.INDEX}},VertexView:class extends i{constructor({numVertices:e,vertexSize:t,buffer:r=null,offset:i=0,container:s}){super({buffer:r,offset:i,size:e*t,container:s}),this.vertexSize=t}get alignment(){return this.vertexSize}get stride(){return this.vertexSize}get numVertices(){return this.size/this.vertexSize}getGPUBufferUsage(){return GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX}},UniformView:class extends i{get alignment(){return this.getGPUDevice().limits.minUniformBufferOffsetAlignment}getGPUBufferUsage(){return GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}writeMatrix({matrix:e,offset:t=0}){let r=e.elements instanceof Float32Array?e.elements:new Float32Array(e.elements);this.write({data:r,offset:t})}}}}),define("DS/GPURenderer/WebGPURenderPipelines",["DS/GPURenderer/WebGPURenderPipeline"],function(e){"use strict";return class{constructor(){this.pipelines=new Map,this.materialBindgroupLayouts=new Map}getPipeline(e,t,r,i,s,n,a){var o=this.getKey(i,a);if(this.pipelines.has(o))return this.pipelines.get(o);var u=this.createPipeline(e,t,r,i,s,n,a);return this.pipelines.set(u.getKey(),u),u}getKey(e,t){return e.program.id}createPipeline(t,r,i,s,n,a,o){return new e(t,r,i,s,n,a,o)}getMaterialLayoutKey(e){return e.id}getMaterialLayout(e,t){let r=this.getMaterialLayoutKey(t);if(this.materialBindgroupLayouts.has(r))return this.materialBindgroupLayouts.get(r);var i=t.shaderIO?t.uniforms:null,s=0,n={label:"Material BindGroupLayout #bindEntries=",entries:[{binding:s++,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}]};for(var a in i)"material"===i[a].ubo&&"t2"===i[a].type&&(n.entries.push({binding:s++,visibility:GPUShaderStage.FRAGMENT,sampler:{}}),n.entries.push({binding:s++,visibility:GPUShaderStage.FRAGMENT,texture:{}}));n.label+=s;let o=e.createBindGroupLayout(n);return this.materialBindgroupLayouts.set(r,o),o}}}),define("DS/GPURenderer/WebGPURenderer",["DS/Visualization/ThreeJS_DS","DS/ShaderBuilders/Commons/DefaultShaders","DS/Visualization/ShaderChunk","DS/Visualization/BufferGPUManager","DS/ShaderBuilders/WebGPUShaderBuilder","DS/GPURenderer/WebGPURenderPipelines","DS/GPURenderer/WebGPURenderTarget","DS/GPURenderer/ComputeInterface"],function(e,t,r,i,s,n,a,o){"use strict";var u=0;return class extends e.WebRenderer{constructor(e){super(e),this.buildDepthFunctionValues(),this.bindGroupOrder=["Frame","Light","Material","Object"],this.currentSetBindGroups=[],this.use_webgpu=!0,this.wgpuShaderBuilder=new s,this.wgpuRenderPipelines=new n,this.pipelineKeyInUse=-1,this.defaultObjectBindGroup=null,this.prevObjectBindGroupIsDefault=null,this.depthTexture=null,this.currentRenderState=null,this.frameBindGroupLayout=null,this.frameBindGroup=null,this.defaultMeshBindGroupLayout=null,this.defaultLightBindGroupLayout=null,this._screenRenderTarget=null,this._computeInterface=null,this.currentRenderState={passInfo:{},pipelineInfo:{},encoderGPU:null,currentPassGPU:null},this.resetPipelineInfo(),this.resetPassInfo(!0),this.setDefaultWebGPUState()}initWebGPUContext(t,r,s){this.webGPUDevice=t,this.webGPUCanvas=r,this.webGPUColorView=s,(this.bufferGPUManager._device&&this.bufferGPUManager._device!==this.webGPUDevice||this.bufferGPUManager._gl)&&(e.VisualizationTraces.info("WebGLRenderer: creating BufferGPUManager for TODO: find replacement for gl.contextId"),this.bufferGPUManager=new i.__builder__),this.bufferGPUManager.setWEBGPUContext(this.id,this.webGPUDevice,this.info)}getComputeInterface(){if(!this._computeInterface){if(!this.webGPUDevice)return null;this._computeInterface=new o(this.webGPUDevice)}return this._computeInterface}setDefaultWebGPUState(){this.setDepthTest(!0),this.setDepthFunc(this.depthFuncs.LEQUAL)}initFrameUBO(){this.frameUBOArray||this.webGPUDevice&&(this.frameUBOArray=new Float32Array(40),this.frameUniformBuffer=this.webGPUDevice.createBuffer({size:160,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}))}updateFrameUBO(e){super.updateFrameUBO(e),this.webGPUDevice&&(this.webGPUDevice.queue.writeBuffer(this.frameUniformBuffer,0,this.frameUBOArray),this.webgpuLightsNeedUpdate=!0,this.frameBindGroup&&this.setBindGroup(0,this.frameBindGroup),this.pipelineKeyInUse=-1,this.prevObjectBindGroupIsDefault=null)}resetPassInfo(e){(e||this.currentRenderState.passInfo.locked)&&(this.currentRenderState.passInfo={colorLoadOp:"load",depthLoadOp:"load",stencilLoadOp:"load",colorStoreOp:"store",depthStoreOp:"store",stencilStoreOp:"store",clearColor:{r:0,g:0,b:0,a:0},clearDepth:1,clearStencil:1,locked:!1,renderTarget:null,descriptorGPU:null},this.currentRenderState.passInfo.clearColor.r=this.gpuStates.clearColor.r,this.currentRenderState.passInfo.clearColor.g=this.gpuStates.clearColor.g,this.currentRenderState.passInfo.clearColor.b=this.gpuStates.clearColor.b,this.currentRenderState.passInfo.clearColor.a=this.gpuStates.clearAlpha)}resetPipelineInfo(){this.currentRenderState.pipelineInfo={depthWriteEnabled:!0,depthCompare:this._getGPUDepthCompareValue(),stencilReadMask:4294967295,stencilWriteMask:4294967295,locked:!1}}_getScreenRenderTarget(e,t){var r=e.size.width,i=e.size.height;return this._screenRenderTarget&&this._screenRenderTarget.width==r&&this._screenRenderTarget.height==i&&this._screenRenderTarget.multisample==t||(this._screenRenderTarget=new a(r,i,{format:e.format},1,t),t?this._screenRenderTarget.setResolveTarget(e):this._screenRenderTarget.setCanvas(e)),this._screenRenderTarget}createRenderPass(){if(!this.webGPUDevice)return;let t=this.gpuStates;var r=this.currentRenderState;let i=this.lastRenderTarget||this._getScreenRenderTarget(this.webGPUCanvas,this.antialias);i.init(this.webGPUDevice),this.currentRenderState.passInfo.renderTarget=i,this.currentRenderState.passInfo.descriptorGPU=i.getRenderPassDescriptor(this.currentRenderState.passInfo),this.currentRenderState.passInfo.locked=!0,r.encoderGPU=this.webGPUDevice.createCommandEncoder({}),r.currentPassGPU=r.encoderGPU.beginRenderPass(r.passInfo.descriptorGPU),r.currentPassGPU.setViewport(e.glStates.currentXOffset,e.glStates.currentYOffset,t.viewportWidth,t.viewportHeight,0,1),this.currentRenderState.locked=!0,this.currentSetBindGroups=[],this.frameBindGroupLayout||(this.frameBindGroupLayout=this.webGPUDevice.createBindGroupLayout({label:"Frame BindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}]}),this.frameBindGroup=this.webGPUDevice.createBindGroup({label:"Frame BindGroup",layout:this.frameBindGroupLayout,entries:[{binding:0,resource:{buffer:this.frameUniformBuffer}}]})),this.defaultMeshBindGroupLayout||(this.defaultMeshBindGroupLayout=this.webGPUDevice.createBindGroupLayout({label:"Default Mesh BindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]})),this.defaultLightBindGroupLayout||(this.defaultLightBindGroupLayout=this.webGPUDevice.createBindGroupLayout({label:"Default Light BindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{}}]}))}submitRenderPass(){this.currentRenderState.currentPassGPU.end(),this.webGPUDevice.queue.submit([this.currentRenderState.encoderGPU.finish()])}buildShader(i,s,n,a,o,l,h,p,c,d,f,g,m){let w=this.materialToUseList;if(a.program=u++,n.WebGPU){n.shaderContext=m,n.shaderIO={attribute:{},structSize:{}};for(var b=`\n            ${r.Default_uniforms_declaration(n)}\n            ${r.normalMatrix_uniforms_declaration(n)}\n            ${r.double_emulation_utilities(n)}\n            ${r.double_emulation(n)}\n\n            ${r.math_utils_pars(n)}\n\n            ${r.sRGB_conversion(n)}\n            ${r.gpu_scenegraph_nodes(n)}\n            \n            ${t.model_view_transformation_pars(n)}\n            ${t.model_view_unit_transformation_pars(n)}\n            \n            ${r.rgba_packing_pars(n)}\n            ${r.decompress_vertices_pars(n)}\n            ${r.decompress_normals_pars(n)}\n            ${r.decompress_uvs_pars(n)}\n            ${r.decompress_colors_pars(n)}\n        `,P=n.shaderIO.attribute,_={position:{name:"aPosition",type:"v3"},normal:{name:"aNormal",type:"v3"},uv:{name:"aUv",type:"v4"},uv2:{name:"aUv2",type:"v4"},tangent:{name:"aTangent",type:"v3"},binormal:{name:"aBinormal",type:"v3"},color:{name:"aColor",type:"v4"}},U=f.getBufferAttributes(),v=0;v<U.length;v++){var G=U[v];_[G]&&(P[_[G].name]=_[G])}(n.needTangentBinormalVertex||n.needTangentBinormal&&!n.gpuTangentBinormal)&&(P.aTangent&&P.aBinormal||(n.needTangentBinormalVertex=!1,n.gpuTangentBinormal||(n.needTangentBinormal=!1)));var B,y,S=`\n\n            ${b}\n\n            var<private> position_: vec3f;\n            var<private> normal: vec3f;\n\n            var<private> tangent: vec3f;\n            var<private> binormal: vec3f;\n\n            var<private> uv: vec4f;\n            var<private> uv2: vec4f;\n            var<private> uv3: vec4f;\n\n            var<private> color: vec4f;\n        `;"custom"===s?[B,y]=this.setMaterialShaders(i.postProBuilder,w.lightedMaterial,n):null!==s&&([B,y]=this.setMaterialShaders(e.ShaderLib[s],w.lightedMaterial,n)),this.wgpuShaderBuilder.computeLayoutInfos(n);var x=/(var out: VertexOutput;)/,C=B.replace(x,"$&"+r.attribute_vertex(n)+"\n"+r.large_scale_VS(n)),R=y.replace(x,"$&"+r.large_scale_FS(n)),D=this.wgpuShaderBuilder.getVertexInCode(n.shaderIO)+this.wgpuShaderBuilder.getVertexOutCode(n)+this.wgpuShaderBuilder.getFragmentInCode(n)+this.wgpuShaderBuilder.getUniformsCode(n,this.bindGroupOrder)+"\n"+S+"\n"+c+"\n"+C,T="\n\n            fn sampleCubeTextureBias(iTexture: texture_cube<f32>, iSampler: sampler, iCoord: vec3f, iBias: f32) -> vec4f {\n\n                return textureSampleBias(iTexture, iSampler, iCoord, iBias);\n            }\n        \n"+d+"\n"+R;T=e.SplitTrimStickString(T),D=e.SplitTrimStickString(D),i.wgslShaderCode=D+T,a.shaderIO=n.shaderIO,a.uniforms=m.__uniforms__}}prepareObjectBindGroup(e,t,r,i){if(e._webgpuBinding||(e._webgpuBinding={}),!e._webgpuBinding[t.id]){var s=64;i&&(s=t.program.shaderIO.structSize.object);var n=this.defaultObjectBindGroup,a=this.webGPUDevice.createBuffer({size:s,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:i});i?(e.bufferArray=new Float32Array(a.getMappedRange()),a._ab=e.bufferArray,r.fillBuffer(e,t,this.lights,e.bufferArray,"object"),a.unmap()):this.webGPUDevice.queue.writeBuffer(a,0,e._mElements),n={uniformBuffer:a,bindGroup:this.webGPUDevice.createBindGroup({label:i?"Object BindGroup":"Default Object BindGroup",layout:r.bindGroupLayouts.get("Object"),entries:[{binding:0,resource:{buffer:a}}]}),isDefault:!i},e._webgpuBinding[t.id]=n,i||(this.defaultObjectBindGroup=n)}}setBindGroup(e,t){this.currentSetBindGroups[e]!==t&&(this.currentSetBindGroups[e]=t,this.currentRenderState.currentPassGPU.setBindGroup(e,t))}setRenderPipeline(t,r,i,s){let n=t.program&&!!t.program.shaderIO,o=this.frameBindGroupLayout,u=this.defaultMeshBindGroupLayout,l=n&&t.useLighting?this.defaultLightBindGroupLayout:null,h=this.wgpuRenderPipelines.getMaterialLayout(this.webGPUDevice,t.program),p=new Map;p.set("Frame",o),p.set("Object",u),p.set("Material",h),l&&p.set("Light",l);var c=this.wgpuRenderPipelines.getPipeline(this.webGPUDevice,r,i,t,p,this.bindGroupOrder,this.currentRenderState);if(s){if(this.pipelineKeyInUse!==c.key&&(this.currentRenderState.currentPassGPU.setPipeline(c.getPipeline()),this.pipelineKeyInUse=c.key),this.prepareObjectBindGroup(r,t,c,n),n&&t.useLighting&&this.webgpuLightsNeedUpdate){var d=new Float32Array(t.program.shaderIO.structSize.light/4);c.fillBuffer(r,t,this.lights,d,"light"),this.webGPUDevice.queue.writeBuffer(this.webgpuLightBinding.uniformBuffer,0,d),this.webgpuLightsNeedUpdate=!1}return this.setBindGroup(c.layoutOrder.indexOf("Material"),t.bindGroup),c}let f=this;var g=function(){if(f._wgpuBlankTexture)return f._wgpuBlankTexture;const e=new Uint8Array([255,255,255,255,255,0,0,255,0,255,0,255,0,0,255,255]);var t=f.webGPUDevice.createTexture({label:"loading texture",size:{width:2,height:2},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});return f.webGPUDevice.queue.writeTexture({texture:t},e,{bytesPerRow:8},{width:2,height:2}),f._wgpuBlankTexture=t,f._wgpuBlankTexture},m=t.program.shaderIO&&function(r){for(var i in r)if("t2"===r[i].type){var s=t[i];if(!s){"precomputedTexture"===i&&(s=f.precomputedTexture),"envMap"===i&&(s=t.envMipMap[0]),"envMap2"===i&&(s=t.envMipMap[1]);let e=r[i].locationName;if(e&&e.includes("tInput")){let r=e.replace("tInput","");if(""===r&&(r=0),(s=t.uniformHandler.getInput(r))instanceof a)continue}}if(s.onRequest&&s.onRequest(),null!==s.loadEndStatus&&s.loadEndStatus!==e.AssetLoadingStatus.READY)return!1}return!0}(t.program.uniforms);if(n){if(t.useLighting)if(this.webgpuLightBinding)this.webgpuLightsNeedUpdate&&(d=new Float32Array(t.program.shaderIO.structSize.light/4),c.fillBuffer(r,t,this.lights,d,"light"),this.webGPUDevice.queue.writeBuffer(this.webgpuLightBinding.uniformBuffer,0,d),this.webgpuLightsNeedUpdate=!1);else{var w=this.webGPUDevice.createBuffer({size:t.program.shaderIO.structSize.light,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),d=new Float32Array(w.getMappedRange());w._ab=d,c.fillBuffer(r,t,this.lights,d,"light"),w.unmap();var b=this.webGPUDevice.createBindGroup({label:"Light BindGroup",layout:l,entries:[{binding:0,resource:{buffer:w}}]});this.webgpuLightBinding={uniformBuffer:w,bindGroup:b}}if(!t.uniformBuffer||t.program.id!==t.uniformBuffer.programId){w=this.webGPUDevice.createBuffer({size:t.program.shaderIO.structSize.material,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0}),t.bufferArray=new Float32Array(w.getMappedRange()),w._ab=t.bufferArray,c.fillBuffer(r,t,this.lights,t.bufferArray,"material"),w.unmap();var P=[{binding:0,resource:{buffer:w}}];m&&(w.programId=t.program.id,t.uniformBuffer=w);var _=t.program.uniforms,U=1;for(var v in _){if("t2"!==_[v].type)continue;var G="precomputedTexture"===v?f.precomputedTexture:t[v];"envMap"===v&&(G=t.envMipMap[0]),"envMap2"===v&&(G=t.envMipMap[1]);let r=_[v].locationName;if(r&&r.includes("tInput")){let e=r.replace("tInput","");""===e&&(e=0),(G=t.uniformHandler.getInput(e).value)instanceof a&&(G=G.getTexture(this.webGPUDevice))}if(!G._wgpuSampler){const t={label:v+"Sampler",addressModeU:"repeat",addressModeV:"repeat"};switch(G.magFilter&&G.magFilter!=e.LinearFilter||(t.magFilter="linear"),G.minFilter){case e.NearestFilter:break;case e.LinearFilter:case e.LinearMipMapNearestFilter:t.minFilter="linear";break;case e.NearestMipMapLinearFilter:t.mipmapFilter="linear";break;case e.LinearMipMapLinearFilter:default:t.minFilter="linear",t.mipmapFilter="linear"}G._wgpuSampler=this.webGPUDevice.createSampler(t)}var B=G._wgpuTexture?G._wgpuTexture:g();if(!G._wgpuTexture&&(null===G.loadEndStatus||G.loadEndStatus===e.AssetLoadingStatus.READY)){Math.floor(Math.log2(Math.max(G.image.width,G.image.height)));const e={label:v,size:{width:G.image.width,height:G.image.height},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,mipLevelCount:1};G._wgpuTexture=this.webGPUDevice.createTexture(e),G.imageBitmap?this.webGPUDevice.queue.copyExternalImageToTexture({source:G.imageBitmap,flipY:!0},{texture:G._wgpuTexture},e.size):G.image&&G.image.data&&this.webGPUDevice.queue.writeTexture({texture:G._wgpuTexture},G.image.data,{bytesPerRow:4*e.size.width},e.size),B=G._wgpuTexture}P.push({binding:U++,resource:G._wgpuSampler}),P.push({binding:U++,resource:B.createView()})}t.bindGroup=this.webGPUDevice.createBindGroup({label:"Material BindGroup #bindEntries="+U,layout:h,entries:P})}this.prepareObjectBindGroup(r,t,c,!0)}else t.uniformBuffer||(t.uniformBuffer=this.webGPUDevice.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0}),t.bufferArray=new Float32Array(t.uniformBuffer.getMappedRange()),t.uniformBuffer._ab=t.bufferArray,t.bufferArray.set(t.color?[t.color.r,t.color.g,t.color.b,1]:[1,1,1,1]),t.uniformBuffer.unmap(),t.bindGroup=this.webGPUDevice.createBindGroup({label:"Default Material BindGroup",layout:h,entries:[{binding:0,resource:{buffer:t.uniformBuffer}}]}),this.prepareObjectBindGroup(r,t,c,!1));return this.pipelineKeyInUse!==c.key&&(this.currentRenderState.currentPassGPU.setPipeline(c.getPipeline()),this.pipelineKeyInUse=c.key),this.setBindGroup(c.layoutOrder.indexOf("Material"),t.bindGroup),c}setRenderTarget(e){super.setRenderTarget(e)}_testPassInfoLock(){this.currentRenderState.passInfo.locked&&console.warn("trying to update passInfos after the renderPass is created, change won't be applied")}_testPipelineInfoLock(){this.currentRenderState.pipelineInfo.locked&&console.warn("trying to update pipelineInfos after the pipeline is created, change won't be applied")}buildDepthFunctionValues(){this.depthFuncs={NEVER:"never",LESS:"less",EQUAL:"equal",LEQUAL:"less-equal",GREATER:"greater",NOTEQUAL:"not-equal",GEQUAL:"greater-equal",ALWAYS:"always"}}_getGPUDepthCompareValue(){return this.gpuStates.depthTest?this.gpuStates.depthFunc:this.depthFuncs.ALWAYS}setDepthFunc(e){this._testPipelineInfoLock(),super.setDepthFunc(e),this.currentRenderState.pipelineInfo.depthCompare=this._getGPUDepthCompareValue()}setDepthTest(e){this._testPipelineInfoLock(),super.setDepthTest(e),this.currentRenderState.pipelineInfo.depthCompare=this._getGPUDepthCompareValue()}clear(e,t,r){this._testPassInfoLock(),this.currentRenderState.passInfo.colorLoadOp=e?"clear":"load",this.currentRenderState.passInfo.depthLoadOp=t?"clear":"load",this.currentRenderState.passInfo.stencilLoadOp=r?"clear":"load"}setClearColor(e,t){super.setClearColor(e,t),this._testPassInfoLock(),this.currentRenderState.passInfo.clearColor={r:e.r,g:e.g,b:e.b,a:t}}setColorWrite(e){let t=e?"store":"discard";t!=this.currentRenderState.passInfo.colorStoreOp&&(this._testPassInfoLock(),this.currentRenderState.passInfo.colorStoreOp=t)}setStencilWrite(e){this._testPipelineInfoLock(),this.currentRenderState.pipelineInfo.stencilWriteMask=e?4294967295:0}setDepthWrite(e){this._testPipelineInfoLock(),this.currentRenderState.passInfo.depthStoreOp=!!e}}}),define("DS/GPURenderer/RenderGraph",["DS/GPURenderer/Base","DS/GPURenderer/Pass","DS/GPURenderer/Debug"],function(e,t,r){"use strict";class i{constructor({pass:e,slot:t}){this.pass=e,this.slot=t}}class s{constructor({output:e,input:t}){this.output=e,this.input=t}}class n{constructor(e){this.encoder=e,this._bindGroups=[],this._pipeline=null,this._indexBuffer={buffer:null,indexFormat:null,offset:null,size:null},this._vertexBuffers=[]}setBindGroup(e,t){this._bindGroups[e]!==t&&(this._bindGroups.length=e+1,this._bindGroups[e]=t,this.encoder.setBindGroup(e,t))}setPipeline(e){this._pipeline!==e&&(this._pipeline=e,this.encoder.setPipeline(e))}setIndexBuffer(e,t,r,i){this._indexBuffer.buffer===e&&this._indexBuffer.indexFormat===t&&this._indexBuffer.offset===r&&this._indexBuffer.size===i||(this._indexBuffer.buffer=e,this._indexBuffer.indexFormat=t,this._indexBuffer.offset=r,this._indexBuffer.size=i,this.encoder.setIndexBuffer(e,t,r,i))}setVertexBuffer(e,t,r,i){void 0!==this._vertexBuffers[e]&&this._vertexBuffers[e].buffer===t&&this._vertexBuffers[e].offset===r&&this._vertexBuffers[e].size===i||(this._vertexBuffers[e]={buffer:t,offset:r,size:i},this.encoder.setVertexBuffer(e,t,r,i))}draw(e,t,r,i){this.encoder.draw(e,t,r,i)}drawIndexed(e,t,r,i,s){this.encoder.drawIndexed(e,t,r,i,s)}drawIndirect(e,t){this.encoder.drawIndirect(e,t)}drawIndexedIndirect(e,t){this.encoder.drawIndexedIndirect(e,t)}}class a{constructor(t,r,i){this.pass=t,this.attachments={colorAttachments:[]},this.layout={colorFormats:[]};for(let s=0;t.outputLayout&&s<t.outputLayout.length;s++){let n=e.TextureFormats[t.outputLayout[s].format],a=t.outputLayout[s].init;Number.isInteger(a.input)&&(a="load");const o=i[s]?"store":"discard";if(n.type&e.TextureType.Color){const e={view:r[s],loadOp:"load"===a?"load":"clear",storeOp:o};"clear"===e.loadOp&&(e.clearValue=a),this.attachments.colorAttachments.push(e),this.layout.colorFormats.push(t.outputLayout[s].format)}else{const i={view:r[s]};n.type&e.TextureType.Depth&&(i.depthClearValue="load"!==a?a.depth:1,i.depthLoadOp="load"===a?"load":"clear",i.depthStoreOp=o,i.depthReadOnly=!1),n.type&e.TextureType.Stencil&&(i.stencilClearValue="load"!==a?a.stencil:0,i.stencilLoadOp="load"===a?"load":"clear",i.stencilStoreOp=o,i.stencilReadOnly=!1),this.attachments.depthStencilAttachment=i,this.layout.depthStencilFormat=t.outputLayout[s].format}}}mapResources(e){const t=this.attachments.colorAttachments;for(let r=0;t&&r<t.length;r++)t[r].view=e(t[r].view);const r=this.attachments.depthStencilAttachment;r&&(r.view=e(r.view))}encodeWebGPU(e,t){let r=new Map;this.mapResources(function(e){let t=e.createTextureView();return r.set(t,e),t});let i=this.pass.computeCommands();{const e=t.beginRenderPass(this.attachments),r=new n(e);for(let e=0;e<i.length;e++)i[e]._encodeWebGPU(r);e.end()}this.mapResources(e=>r.get(e))}}class o{constructor(e,t){this.source=e,this.target=t}mapResources(e){this.source=e(this.source),this.target=e(this.target)}encodeWebGPU(e,t){const r={texture:this.source.getGPUTexture()},i={texture:this.target.getGPUTexture()},s=this.source.size;t.copyTextureToTexture(r,i,s)}}return class{static Slot(e){return new i(e)}static Connection(e){return new s(e)}constructor(e){this.passes=new Map,this.targets=new Map,this.resourcePool=e,this.transientTextures=[],this._renderSequence=null,this._debugChannel=r.setupRenderGraphRemoteDebug(this)}addPass(e,r){if(!(e instanceof t))throw new Error("mismatched pass type, expected a derivative of DS/GPURenderer/Pass");if(void 0===r&&(r=e.name),!r||"string"!=typeof r)throw new Error("invalid name");if(e.graph)throw new Error("pass was already added to a render graph");if(this.passes.has(r))throw new Error("a pass with this name already exist");return e.graph=this,e.name=r,this.passes.set(e.name,e),this._renderSequence=null,e}getPass(e){return this.passes.get(e)}connect(e,t,r,n){if(!this.passes.has(e))throw new Error("unknown output pass");if(!this.passes.has(r))throw new Error("unknown input pass");const a=this.passes.get(r),o=this.passes.get(e),u=(e,t)=>t&&Number.isInteger(e)&&e>=0&&e<t.length;if(!u(t,o.outputConnections))throw new Error("output slot is out of range");if(!u(n,a.inputConnections))throw new Error("input slot is out of range");if(a.inputConnections[n])throw new Error("input slot already connected");let l=new s({output:new i({pass:e,slot:t}),input:new i({pass:r,slot:n})});return o.outputConnections[t].push(l),a.inputConnections[n]=l,this._renderSequence=null,!0}target(e,t,r){if(!this.passes.has(t))throw new Error("unknown output pass");const n=this.passes.get(t);if(!((e,t)=>t&&Number.isInteger(e)&&e>=0&&e<t.length)(r,n.outputConnections))throw new Error("output slot is out of range");if(this.targets.has(e))throw new Error("resource is already a target");if(!this.resourcePool.contains(e))throw new Error("resource is not available in the resource pool that this render graph uses");let a=new s({output:new i({pass:t,slot:r}),input:new i({pass:null,slot:e})});return n.outputConnections[r].push(a),this.targets.set(e,a),this._renderSequence=null,!0}graphviz(e=null){let t=(e,t)=>`in ${t}`,r=(e,t)=>`out ${t}`;e&&e.input_name&&(t=e.input_name),e&&e.output_name&&(r=e.output_name);let i="digraph RenderGraph\n{\n";i+="\trankdir=LR;\n",i+='\tfontname="Helvetica";\n',i+='\tnode [style=filled, shape=box, fontname="Consolas"];\n';let s=new Map;this.passes.forEach(function(e){let n=s.size;s.set(e.name,n),i+=`\tsubgraph cluster_${n}\n\t{\n\t\tlabel="${e.name}";\n\t\tstyle=filled;\n\t\tcolor="#cccccc";\n`;const a=e.inputLayout?e.inputLayout.length:0,o=e.outputLayout?e.outputLayout.length:0,u=Math.max(a,o);for(let s=0;s<u;s++)i+=`\t\tp${n}in${s}`+(s<a?` [label="${t(e.name,s)}", color="#aaaaff"]`:" [style=invis]")+";\n",i+=`\t\tp${n}out${s}`+(s<o?` [label="${r(e.name,s)}", color="#aaffaa"]`:" [style=invis]")+";\n";for(let e=0;e<u;e++)i+=`\t\tp${n}in${e} -> p${n}out${e} [style=invis, weight=1000];\n`;i+="\t}\n"});let n=new Map;return this.targets.forEach(e=>n.set(e.input.slot,n.size)),this.targets.forEach(function(e){const t=n.get(e.input.slot),r=e.input.slot.constructor.name;i+=`\ttgt${t} [label="${r}\n${t}", shape=ellipse, color="#ffccaa"];\n`}),this.passes.forEach(function(e){for(let t=0;t<(e.outputConnections?e.outputConnections.length:0);t++){const r=e.outputConnections[t];for(let e=0;e<r.length;e++){let t=r[e];null!==t.input.pass?i+=`\tp${s.get(t.output.pass)}out${t.output.slot}:e -> p${s.get(t.input.pass)}in${t.input.slot}:w;\n`:i+=`\tp${s.get(t.output.pass)}out${t.output.slot}:e -> tgt${n.get(t.input.slot)}:w;\n`}}for(let t=0;t<(e.outputLayout?e.outputLayout.length:0);t++){const r=e.outputLayout[t].init.input;Number.isInteger(r)&&(i+=`\tp${s.get(e.name)}in${r}:e -> p${s.get(e.name)}out${t}:w [style=dashed];\n`)}}),i+="}\n"}_computePassOrder(){let e=[],t=Array.from(this.targets,([e,t])=>t.output.pass);for(let e=0;e<t.length;e++){const r=this.passes.get(t[e]).inputConnections;for(let e=0;r&&e<r.length;e++)r[e]&&t.push(r[e].output.pass)}let r=new Set;for(let i=t.length;i-- >0;)r.has(t[i])||(e.push(t[i]),r.add(t[i]));return e}_computeRenderSequence(){const e=this._computePassOrder();let t=new Map;for(let r=0;r<e.length;r++){const i=this.passes.get(e[r]),s=i.inputLayout?i.inputLayout.length:0,n=i.outputLayout?i.outputLayout.length:0;t.set(i.name,{inputs:Array(s).fill(),outputs:Array(n).fill()})}let r=[],i=[];function s(e){const t=i.length;return i.push({real_resource:void 0,format:e}),t}for(let n=0;n<e.length;n++){const u=this.passes.get(e[n]),l=t.get(u.name);for(let e=0;u.outputLayout&&e<u.outputLayout.length;e++){let t=u.outputLayout[e].init.input;t=Number.isInteger(t)?l.inputs[t]:s(u.outputLayout[e].format),l.outputs[e]=t}let h=Array(u.outputConnections?u.outputConnections.length:0).fill(!1);for(let e=0;u.outputConnections&&e<u.outputConnections.length;e++)for(let r=0;r<u.outputConnections[e].length;r++){const i=u.outputConnections[e][r],s=null===i.input.pass,n=t.get(i.input.pass);if(s||n){h[e]=!0;break}}r.push(new a(u,l.outputs,h));for(let e=0;u.outputConnections&&e<u.outputConnections.length;e++){let n=l.outputs[e],a=!1;for(let l=0;l<u.outputConnections[e].length;l++){const h=u.outputConnections[e][l],p=null===h.input.pass,c=t.get(h.input.pass);if(!p&&!c)continue;let d=n;p&&void 0!==i[d].real_resource&&(a=!0),a&&(d=s(i[n].format),r.push(new o(n,d))),p?i[d].real_resource=h.input.slot:c.inputs[h.input.slot]=d,a=!0}}}const n=i.map(e=>void 0===e.real_resource);let u=0;for(let e=0;e<i.length;e++)if(void 0===i[e].real_resource){if(u>=this.transientTextures.length){let t=this.resourcePool.createTexture({width:16,height:16},i[e].format);this.transientTextures.push(t)}i[e].real_resource=this.transientTextures[u],u++}let l=i.map(e=>e.real_resource);for(let e=0;e<r.length;e++)r[e].mapResources(e=>l[e]);return{used_resources:l,sequence:r,update_sizes:()=>{let r=l.map((e,t)=>n[t]?void 0:e.size),i=e=>({get:()=>r[e],set:t=>{if(!r[e]||r[e].width!==t.width||r[e].height!==t.height||r[e].depth!==t.depth){if(r[e])throw new Error("Cannot redefine pass slot size");r[e]=t}}});const s=e.length;for(let r=0;r<s;r++){const n=this.passes.get(e[s-r-1]),a=t.get(n.name);let o={inputs:{},outputs:{}};for(let e=0;e<a.inputs.length;e++)Object.defineProperty(o.inputs,e,i(a.inputs[e]));for(let e=0;e<a.outputs.length;e++)Object.defineProperty(o.outputs,e,i(a.outputs[e]));n.computeSizes(o)}for(let e=0;e<l.length;e++)n[e]&&l[e].resize(r[e])}}}submit(){this._renderSequence||(this._renderSequence=this._computeRenderSequence()),this._renderSequence.update_sizes();const e=this.resourcePool.getGPUDevice(),t=e.createCommandEncoder();for(let r=0;r<this._renderSequence.sequence.length;r++)this._renderSequence.sequence[r].encodeWebGPU(e,t);e.queue.submit([t.finish()])}}}),define("DS/GPURenderer/Resource.Bindings",["DS/GPURenderer/Resource"],function(e){"use strict";return{BindGroup:class extends e{constructor({resources:e,container:t}){super({container:t}),this.resources=e,this._webgpu=new WeakMap}getGPUBindGroup(e){let t=this._webgpu.get(e);return t||(t=this.getGPUDevice().createBindGroup({layout:e,entries:this.resources.map((e,t)=>({binding:t,resource:e.getGPUBindingResource()}))}),this._webgpu.set(e,t),t)}markStale(){this._webgpu=new WeakMap}}}}),define("DS/GPURenderer/ResourcePool",["DS/GPURenderer/Base","DS/GPURenderer/Resource.Buffers","DS/GPURenderer/Resource.Textures","DS/GPURenderer/Resource.Bindings","DS/GPURenderer/Resource.Pipelines"],function(e,t,r,i,s){"use strict";class n{constructor(){this._webgpu=null,this._initialization=async function(){const e=await navigator.gpu.requestAdapter(),t=await e.requestDevice();return{adapter:e,device:t}}().then(e=>{this._webgpu=e,this._initialization=null},e=>{throw console.warn("Failed to initialize WebGPU device: ",e),this._webgpu=null,this._initialization=null,e})}getGPUAdapter(){return this._webgpu&&this._webgpu.adapter}getGPUDevice(){return this._webgpu&&this._webgpu.device}}return class{constructor(){this._resources=new Set,this._device=new n,this._uniformsArena={regions:[],size:131072}}initialized(){return this._device._initialization||(this._device.getGPUDevice()?Promise.resolve():Promise.reject())}getDevice(){return this._device}getGPUAdapter(){return this._device.getGPUAdapter()}getGPUDevice(){return this._device.getGPUDevice()}contains(e){return this._resources.has(e)}remove(e){this._resources.delete(e),e._destroy()}forEach(e){this._resources.forEach(t=>e(t))}computeMemoryStatistics(){let e={};return this._resources.forEach(t=>{const r=t.constructor.name;e[r]=(e[r]||0)+1}),e}createTexture(e,t){return this._create(r.TextureResource,{size:e,format:t})}createCanvas(e){return this._create(r.CanvasResource,{canvas:e})}createIndexView({numIndices:e,index32bit:r}){return this._create(t.IndexView,{numIndices:e,index32bit:r})}createVertexView({numVertices:e,vertexSize:r}){return this._create(t.VertexView,{numVertices:e,vertexSize:r})}createUniformView(e){let r=this._create(t.UniformView,{size:e});return this._allocateArena(r,this._uniformsArena),r}getBindGroup(e){this.__cache||(this.__cache=new Map);const t=e.map(e=>e.id).join(";");let r=this.__cache.get(t);return r||(r=this._create(i.BindGroup,{resources:e}),this.__cache.set(t,r)),r}createRenderPipeline({resourceLocations:e,_wgpu:t}){return this._create(s.RenderPipeline,{resourceLocations:e,_wgpu:t})}createBuffer(e){return this._create(t.BufferResource,e)}flushUniforms(){this._flushArena(this._uniformsArena)}_create(e,t){t.container=this;const r=new e(t);return this._resources.add(r),r}_allocateArena(t,r){function i(e){const r=e%t.alignment;return 0===r?e:e+t.alignment-r}r.regions.sort(function(e,r){const s=i(e.end),n=i(r.end),a=e.memory.size-s,o=r.memory.size-n;if(o<t.size)return-1;if(a<t.size)return 1;const u=s-e.end,l=n-r.end;return u!==l?u-l:o-a});let s=null;r.regions.length>0&&(s=r.regions[0]),s&&s.memory.size-i(s.end)<t.size&&(s=null),s||(s={memory:this.createBuffer({size:r.size,access:e.BufferCPUAccess.Stage}),end:0},r.regions.push(s)),t.buffer=s.memory,t.offset=i(s.end),s.memory._views.push(t),s.end=t.end}_flushArena(e){for(let t=0;t<e.regions.length;t++)e.regions[t].memory.flush()}upload(e){if(!(e instanceof Map))throw new Error("upload() expects a map (Resource -> Array)");for(let[r,i]of e)if(!(r instanceof t.BufferView))throw new Error("upload(): only typed buffer views are supported");let r=[];for(let[t,i]of e)t.buffer||r.push(t);r.length>0&&this.createBuffer({views:r});for(let[t,r]of e)t.upload(r);return this.getGPUDevice().queue.onSubmittedWorkDone()}_mergeBuffers(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].size;let r=this.createBuffer({size:t});const i=this.getGPUDevice();let s=i.createCommandEncoder(),n=0;for(let t=0;t<e.length;t++){let i=e[t].getGPUBufferView();s.copyBufferToBuffer(i.buffer,i.offset,r.getGPUBuffer(),n,i.size),n+=i.size}i.queue.submit([s.finish()]),i.queue.onSubmittedWorkDone().then(()=>{(function(){let t=0,i=new Set;for(let s=0;s<e.length;s++){let n=e[s].size;if(e[s].isView()){let n=e[s].buffer;n._views.delete(e[s]),0===n._views.size&&i.add(n),e[s].buffer=r,e[s].offset=t}else e[s]._views&&(e[s]._views.forEach(e=>{e.buffer=r,e.offset+=t}),i.add(e[s]));t+=n}return i})().forEach(e=>this.remove(e))})}}}),define("DS/GPURenderer/BridgeV6Renderer",["DS/GPURenderer/ResourcePool","DS/GPURenderer/Resource.Pipelines","DS/GPURenderer/Pass","DS/GPURenderer/RenderGraph","DS/Visualization/ThreeJS_DS","DS/Visualization/WebGLV6Renderer","DS/Plugins/EffectComposer","DS/Plugins/ComposerContext","DS/Plugins/RenderPass","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/ImageOperationShaderBuilders"],function(e,t,r,i,s,n,a,o,u,l,h){"use strict";function p(e,t){let r=performance.now();t();let i=performance.now(),s=document.querySelector(e);s&&(s.textContent=`${(i-r).toFixed(3)} ms`)}return n.extend({init:function(t){this.isBridge=!0,this.webgpu=t.webgpu,this.webgpu&&(this.wgpu_resource_pool=new e,this.wgpu_resource_pool.initialized().then(()=>this._initWebGPU(this.canvas,t.antiAliasing),()=>console.error("Cannot setup WebGPU")),window.wgpu_stats=(()=>this.wgpu_resource_pool.computeMemoryStatistics())),this._parent(t)},_initComposer:function(){this.simpleComposer=new a(this.renderer,void 0,this.renderTargetPool,["--\x3emain","initClearPass","forwardPass","--\x3enoz","nozClearPass","nozPass","--\x3e(postEffects2)","compositePass","nothing"]);var e=new s.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear");this.simpleComposerContext=new o(e,this.simpleComposer,"simpleComposerContext"),this.simpleComposerContext.keepResult=!0,this.simpleComposer.addPass(this.initClearPass),this.simpleComposerContext.setPassClear(this.initClearPass,!0,new s.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.simplePass=new u(null,null,null,null,null,null,"forwardPass"),this.simplePass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.simpleComposer.addPass(this.simplePass),this.simpleComposer.addPass(this.nozClearPass),this.simpleComposerContext.enablePass(this.nozClearPass,!0),this.simpleComposerContext.setPassClear(this.nozClearPass,!1),this.simpleComposerContext.setPassClearDepth(this.nozClearPass,!0),this.simpleComposer.addPass(this.nozPass);let t=new l(h.Nothing,"nothing");this.simpleComposer.addPass(t),this.simpleComposerContext.setPassRenderToCanvas(t,!0)},_setupScene(e){this.renderer.renderIteration=0,this.renderer.increaseFrameCount(s._FrameTypes.MAIN),this.renderer.gammaInput=!0,this.renderer.materialToUse=s.MaterialToUse.originalMaterial,this.renderer.autoUpdateScene=!0,e.updateMatrixWorld(),this.renderer.initWebGLObjects(e),this.simplePass.scene=e,this.simpleComposer.updateScene(e),this.simpleComposer.setComposerContext(this.simpleComposerContext)},_initWebGPU:function(e,t){if(this.wgpu_canvas=this.wgpu_resource_pool.createCanvas(e),t){let t=this.wgpu_resource_pool.createTexture({width:e.width,height:e.height,sampleCount:4},navigator.gpu.getPreferredCanvasFormat());this.wgpu_colorView=t.createTextureView()}this.mainComposer.renderer.initWebGPUContext(this.wgpu_resource_pool.getGPUDevice(),this.wgpu_canvas,this.wgpu_colorView),console.log("WebGPU initialized")},render:function(e,t,r,i,s,n,a,o,u,l,h,c,d,f,g,m,w,b,P,_,U){if(this.webgpu){if(!this.wgpu_canvas)return;this.wgpu_canvas.resize(),p("#frame-time-webgpu",()=>this._parent(...arguments))}else p("#frame-time-webgl",()=>this._parent(...arguments))}})});