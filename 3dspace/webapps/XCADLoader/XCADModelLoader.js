define("DS/XCADLoader/XCADModelLoader",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/3DXMTiles/OOCModel3DZipHandler","DS/XCADLoader/XCADOOCHandler","DS/3DXMTiles/OOCManager","DS/ZipJS/zip-fs","DS/ZipJS2/ZipJS2","DS/ZipJS2/LoaderInflate","DS/ZipJS2/pako","DS/Visualization/Utils","DS/CoreEvents/Events"],function(e,o,t,r,n,i,a,l,s,d,u){"use strict";var f=!0,p="zipjs2",c=!1,g=!1,v=!1,m=function(o,l,h,L){this.viewer=o,this.viewer.endLoaded=void 0;var C=this;u.subscribe({event:"3DPLAY/EXPLODE/START"},function(e){C.hideAllAnnot(),c=!0}),u.subscribe({event:"3DPLAY/EXPLODE/END"},function(e){c=!1,C.showAllAnnot()}),u.subscribe({event:"/Default/3DPLAY/HIDE"},function(e){g=e.data.length>0}),u.subscribe({event:"/Default/3DPLAY/SHOW_ALL"},function(e){g=!1}),u.subscribe({event:"/VISU/"},function(e){!1===g&&("@onViewpointBeginMove"==e.eventType?C.hideAllAnnot():"@onViewpointEndMove"==e.eventType&&0==c&&1==v&&C.showAllAnnot())});var b=window.localStorage.getItem("XCADLoader_ODTMode"),D=void 0;f&&(null!=b?a.configure({maxWorkers:1,terminateWorkerTimeout:NaN}):a.configure({maxWorkers:4,terminateWorkerTimeout:NaN}));var A=void 0;if(A=f?new a.fs.FS:new i.fs.FS,null!=h)f?A.importBlob(h,{directAccess:!0}).then(w):A.importBlob(h,w);else{this.modelName="";var S=function(e,o){var t=function(e){if("string"==typeof e){var o="",t="";if("blob:"===e.substring(0,5))return{provider:"FILE",serverurl:"",filename:e,requiredAuth:null,proxyurl:"none"};if("http://"===e.substring(0,7))o=e;else if("https://"===e.substring(0,8))o=e;else if("/"===e.substring(0,1))o=e;else if("ms-appx://"===e.substring(0,10))o=e;else if("file://"===e.substring(0,7))o=e;else{var r=location.href,n=r.indexOf("?");-1!==n&&(r=r.substring(0,n));var i=r.lastIndexOf("/");-1!==i&&(r=r.substring(0,i+1)),o=r+e}t=(o=d.parseUrl(o)).protocol,""!==o.protocol&&(t+="://"),t+=o.authority+o.path.substring(0,o.path.lastIndexOf("/"))+"/";var a=o.path.substring(o.path.lastIndexOf("/")+1,o.path.length);return""!==o.query&&(a=a+"?"+o.query),e={provider:"FILE",serverurl:t,filename:a,requiredAuth:null,proxyurl:"none"}}return"EV6"===e.provider&&(o=d.parseUrl(e.serverurl),e.serverdefinition={},e.serverdefinition.protocol=o.protocol,e.serverdefinition.hostname=""!==o.user?o.user+"@"+o.domain:o.domain,e.serverdefinition.port=o.port,e.serverdefinition.rooturi=o.path,"/"===e.serverdefinition.rooturi.slice(0,1)&&(e.serverdefinition.rooturi=e.serverdefinition.rooturi.slice(1,e.serverdefinition.rooturi.length))),e}(o);return e.modelName=t.serverurl?t.serverurl:"",e.modelName+=t.filename?t.filename:"",t}(this,L);f?A.importHttpContent(L,{useXHR:!1,preventHeadRequest:!0}).then(w):A.importHttpContent({filename:S.filename,serverurl:S.serverurl},!1,w)}function w(){var i="root_url";if(o.endLoaded=!1,v=!1,D=new n(o),m.oocManager=D,D.modelLoader=l,D.setTargetNode(l.targetNode),null!=b){console.log("custom end loading for odt"),l.setOnLoadedCallback(void 0);var a=function(){null!=o.currentViewpoint&&o.currentViewpoint.reframe()};l.onLoadedCB(a),l.onLoadedCB=a}l.setKeepLoaderMode(!0),m.StartLoadingCB&&D.setOnStartLoadingCB(m.StartLoadingCB),m.EndLoadingCB&&D.setOnEndLoadingCB(m.EndLoadingCB),null==b&&D.addOnEndLoadingCB(e=>{null!=C.viewer.currentViewpoint&&1!=v&&C.viewer.currentViewpoint.reframe(),v=!0,C.viewer.endLoaded=!0,C.showAllAnnot()});var d=new t({loadModelCB:function(e){var o={};l.setOnLoadedProductStructureCallback(o=>{e.onLoadedCB()});let t=this.manager.fullVPHandler.oocHandler.assyProductsMap.get(e.targetNode.modelIdentification).geomRep.filename;var r=t.substring(t.lastIndexOf(".")+1,t.length);if("CGR"===r.toUpperCase())l.fileType="cgr",l.loadModelFromBuffer(e.data,e.targetNode,o);else if("STP"===r.toUpperCase())l.fileType="stp",l.loadModelFromBuffer(e.data,e.targetNode,o);else if("STPZ"===r.toUpperCase()){l.fileType="stp";var n=s.inflate(e.data);l.loadModelFromBuffer(n,e.targetNode,o)}else console.log("Not supported file type: "+r)},unzipLib:p});null===b&&(d.ldhHandler.nbTickets=8);var u=new r({manager:D,viewer:o,zipArchive:A,filename:void 0===S?h.name:S.filename,useZip2:f});D.registerHandlers({ref:u,repRef:d}),u.init(function(){D.registerReference(i,{boundingSphere:null,boundingBox:u.rootBbox,manager:D,handlerType:"ref",url:i});var t=D.addRoot(i,{matrix:new e.Matrix4,node:l.targetNode,manager:D,instanceId:u.rootName});d.rootId=t,o.currentViewpoint.reframe()})}};return m.prototype.getAnnotationRootNodes=function(e){return e.getRootNode().getChildrenByName("3DPlay_XCAD_Annotation")},m.prototype.showAllAnnot=function(){var e=this.getAnnotationRootNodes(this.viewer);if(null!=e){for(var o=0;o<e.length;o++)e[o].setVisibility(!0);this.viewer.render()}},m.prototype.hideAllAnnot=function(){var e=this.getAnnotationRootNodes(this.viewer);if(null!=e){for(var o=0;o<e.length;o++)e[o].setVisibility(!1);this.viewer.render()}},m.prototype.clear=function(){m.oocManager&&m.oocManager.getRootOccurrences().forEach(function(e,o,t){m.oocManager.removeRoot(e.rootId)})},m.prototype.pauseLoading=function(e){m.oocManager&&m.oocManager.setPauseLoading(e,"XCAD")},m.prototype.setOnStartLoadingCB=function(e){m.StartLoadingCB=e},m.prototype.setOnEndLoadingCB=function(e){m.EndLoadingCB=e},m.prototype.setObjectLoadedCB=function(e){m.ObjectLoadedCB=e},m});