define("DS/XCADLoader/XCADLoader",["UWA/Promise","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/XCADInputDocuments/XCADRepresentation","DS/XCADLoader/XCADGeomLoader","DS/Mesh/ThreeJS_Base","DS/ZipJS/zip-fs","DS/ZipJS2/LoaderInflate","DS/Visualization/Utils","DS/VisuDataAccess/ProxyAbstraction","DS/XCADLoader/XCADError","DS/XCADLoader/XCADSingleton","DS/XCADLoader/XCADZipUtils"],function(e,o,r,t,n,i,l,s,a,d,c,u,f){"use strict";var v=0,p=function(){var l,p=null,m=null,D=null,h=null,S=[],g=0,C=0;this.processModel=function(e){},this.load=async function(A,M,w,y,x,I,E,P,_,N,R){p=null,m=null,D=null,h=null,null,"",S=[],M,l=M.substr(M.lastIndexOf(".")+1).toUpperCase(),p=w,m=y,D=x,h=I;var T=A,L=new i.MeshBasicMaterial({side:i.DoubleSide,transparent:!1}),X=window.localStorage.getItem("XCAD_DebugMode");if(null!=R){if(1==A.zipped&&2==A.zipMethod&&(R=s.inflate(R)),null!=X)var b=performance.now();if(await U(R),null!=X){var O=performance.now();console.log("_processModel_"+v+" in "+(O-b)+" milliseconds."),window.localStorage.setItem("processModel_"+v,"_processModel in "+(O-b)+" milliseconds."),v++}}else if(1==A.zipped){var z=N.serverurl?N.serverurl:"";z+=N.filename?N.filename:"";var V=N.filename.substring(0,N.filename.lastIndexOf(".")),F=[];F.push(f.downloadFiles(z)),e.all(F).then(function(e){console.log("download Zip archive done");let o=void 0;e&&(e.forEach(function(e){u.addData(e),null!=e[V]&&(o=e[V])}),null!=o&&U(o))})}else{M.startsWith("blob")||(N.proxyurl=null);var G=new d;a.setProxyFromSpec(N,G);z=N.serverurl?N.serverurl:"";z+=N.filename?N.filename:"",G.executeGetHttpRequest(z,_,null,function(e){if(null!=X)var o=performance.now();if(U(e),null!=X){var r=performance.now();console.log("_processModel in "+(r-o)+" milliseconds."),window.localStorage.setItem("processModel_"+v,"_processModel in "+(r-o)+" milliseconds."),v++}})}async function U(e){Date.now();var s=new c,a=await T.initialize(e);if(a instanceof c)return h&&h(a),void(m&&m({loaded:0,total:0}));var d=!1,u=void 0,f=T.getRepresentation(t.XCAD_TESSELLATED_REPRESENTATION);if(void 0!==f)for(var S=(new n).load(f,m),C=0;C<S.length;C++){var A=(R=S[C]).primitive,w=R.transfo,y=R.descendants;if(0!=A.nbPrimitives||0==A.nbPrimitives&&S.length>1)if(void 0===u)(u=f.isIndexed&&!f.isIndexed()?r.createMeshNode(A,L):r.createMeshNode(A,L,0,"mono")).productType="Reference3D",null!=w&&u.setMatrix(w),g++;else{var x=void 0;x=f.isIndexed&&!f.isIndexed()?r.createMeshNode(A,L):r.createMeshNode(A,L,0,"mono"),null!=w&&x.setMatrix(w),u.addChild(x),Z(y,x,f)}}else if(void 0!==(f=T.getRepresentation(t.XCAD_PRODUCT_REPRESENTATION)))for(var I=f.getRootProducts(),P=0;P<I.length;P++)0===(u=B(I[P],m,{},null)).children.length&&null==u.mesh3js&&(d=!0,console.error(M+" : "+l+" Root with no supported Geometry"),s.setError("XCADLoader/XCADLoader","error.EMPTY_ROOT",null),h&&h(s)),E.add(u);else d=!0,console.error(M+" : "+l+" file with no supported representation"),s.setError("XCADLoader/XCADLoader","error.NO_REP",null),h&&h(s);var _=T.getRepresentation(t.XCAD_TESSELLATED_ANNOTATION_REPRESENTATION);if(void 0!==_&&0!=(S=(new n).load(_,m)).length){var N=new o("3DPlay_XCAD_Annotation");for(C=0;C<S.length;C++){var R;A=(R=S[C]).primitive,w=R.transfo;if(A.noz=!0,0!=A.nbPrimitives)for(var b=0;b<A.primitives.length;b++){1===A.primitives[b].attr.fill.color.r&&1===A.primitives[b].attr.fill.color.g&&1==A.primitives[b].attr.fill.color.b&&(A.primitives[b].attr.fill.color.r=0,A.primitives[b].attr.fill.color.g=0,A.primitives[b].attr.fill.color.b=0);var O=new i.LineBasicMaterial({color:A.primitives[b].attr.fill.color,dashType:A.primitives[b].attr.line.pattern,side:i.DoubleSide,force:!0});A.primitives[b].material=O}x=void 0;(x=_.isIndexed&&!_.isIndexed()?r.createMeshNode(A,L):r.createMeshNode(A,L,0,"mono")).productType="Annotation_Representation",x.setRenderLineMode(i.ShowAllRenderLineMode),null!=w&&x.setMatrix(w),N.add(x),null==X&&N.setVisibility(!1)}null!=u&&null!=N&&u.addChild(N)}if(0==f._associatedDocument.nbInstPart&&(s.setError("XCADLoader/XCADLoader","error.EMPTY_PROD",null),h&&h(s)),null!=X){var z="Number of detected instanciate Parts / Number of loaded instanciate Parts: "+f._associatedDocument.nbInstPart+" / "+g;console.log(z),window.localStorage.setItem("processModel_"+v,z),v++,z=g===f._associatedDocument.nbInstPart?"Number of part is OK":"Number of part is KO",console.log(z),window.localStorage.setItem("processModel_"+v,z),v++}_=null,f=null,T.close(),T=null,p&&u?(p(u),u=null):p(null),d||D&&D()}function Z(e,o,t){for(var n=0;n<e.length;n++){var i=e[n].primitive,l=e[n].transfo,s=e[n].descendants,a=void 0;a=t&&t.isIndexed&&!t.isIndexed()?r.createMeshNode(i,L):r.createMeshNode(i,L,0,"mono"),null!=l&&a.setMatrix(l),o.addChild(a),Z(s,a)}}function B(e,i,s,a){var d,u=new c,f=e.getProductAttributes(),v=f[0],p=e.getInstanceList(),m=e.getFilePath();if(void 0!==m){console.log(M+" has an external reference: "+m);var D=f[1];(d=new o(a)).productType="Instance3D",d.name=a,void 0!==D&&(D.name=v,d.add(D)),S[v]=d,g++}else{if(""!==v){var A=S[v];if(null!=A&&"Mesh3D"===A.getNodeType())return g++,A.clone();var w=e.getDocument();if(void 0!==w){w.initialize("");var y=w.getRepresentation(t.XCAD_TESSELLATED_REPRESENTATION);if(void 0!==y)for(var x=(new n).load(y,null),I=(D=void 0,0);I<x.length;I++){var E=x[I],P=E.primitive,_=E.transfo,N=E.descendants;if(0!=P.nbPrimitives||0==P.nbPrimitives&&x.length>1)if(void 0===D)(D=y.isIndexed&&!y.isIndexed()?r.createMeshNode(P,L):r.createMeshNode(P,L,0,"mono")).name=v,D.productType="Instance3D",S[v]=D,null!=_&&D.setMatrix(_),g++;else{var R=void 0;R=y.isIndexed&&!y.isIndexed()?r.createMeshNode(P,L):r.createMeshNode(P,L,0,"mono"),null!=_&&R.setMatrix(_),D.addChild(R),Z(N,R,y)}}else console.warn(M+" : "+l+" file with empty representation"),u.setError("XCADLoader/XCADLoader","error.NO_REP",null),h&&h(u);w.close()}}p.length>0?void 0===d&&((d=new o(v)).productType="Instance3D",void 0!==D&&d.add(D),S[v]=d):d=D,C++;var T=Object.keys(e._document.assyProducts).length;i&&i({loaded:C,total:T});for(I=0;I<p.length;I++){var X=J(p[I]);void 0!==X&&d.add(X)}d&&"Reference3D"===d.productType&&0===d.children.length&&(console.warn(M+" : "+l+" Product with empty Geometry"),u.setError("XCADLoader/XCADLoader","error.EMPTY_PROD",null),h&&h(u))}return d}function J(e){var o=e.getTransformation(),r=new i.Matrix4;if(void 0!==o&&o instanceof i.Matrix4)r=o;else{var t=o[1],n=o[0];r.set(n[0][0],n[0][1],n[0][2],t[0],n[1][0],n[1][1],n[1][2],t[1],n[2][0],n[2][1],n[2][2],t[2],0,0,0,1)}var l={CoordSys:""},s=B(e.getReferenceProduct(),null,0,e.getInstanceAttributes()[0]);if(null!=l.CoordSys&&1==l.CoordSys.Coord&&null!=l.CoordSys.Origin&&0!=l.CoordSys.Origin.length){var a=parseFloat(l.CoordSys.Origin[0]),d=parseFloat(l.CoordSys.Origin[1]),c=parseFloat(l.CoordSys.Origin[2]),u=new i.Matrix3,f=new i.Vector3(l.CoordSys.RefDir[0],l.CoordSys.RefDir[1],l.CoordSys.RefDir[2]),v=new i.Vector3(l.CoordSys.Axis[0],l.CoordSys.Axis[1],l.CoordSys.Axis[2]),p=new i.Vector3;p.crossVectors(v,f),u.set(f.x,p.x,v.x,f.y,p.y,v.y,f.z,p.z,v.z);var m=new i.Matrix4;m.set(u.elements[0],u.elements[3],u.elements[6],a,u.elements[1],u.elements[4],u.elements[7],d,u.elements[2],u.elements[5],u.elements[8],c,0,0,0,1),r.multiply(m)}return void 0!==s&&s.setMatrix(r),s}}};return p});