define("DS/XCADLoader/XCADReader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/XCADLoader/XCADGeomLoader","DS/XCADSTEPDocument/STEPTessellatedRepresentation","DS/XCADSTEPDocument/STEPTessellatedAnnotationRepresentation","DS/XCADSTEPDocument/STEPInputDocument","DS/XCADInputDocuments/XCADRepresentation","DS/XCADSTEPDocument/STEPProductRepresentation","DS/XCADSTEPDocument/STEPProduct"],function(e,r,t,o,a,n,s,d,i,l,u,c,p,m){"use strict";var h=t.matchUrl(r.getWebappsBaseUrl(),window.location)?null:"Passport",D={provider:"FILE",filename:"AmdLoader.js",serverurl:r.getWebappsBaseUrl()+"AmdLoader/",module:"AmdLoader",requiredAuth:h},f={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:h},v={provider:"FILE",filename:"Mesh.js",serverurl:r.getWebappsBaseUrl()+"Mesh/",module:"Mesh",requiredAuth:h},k={provider:"FILE",filename:"STEPFile.js",serverurl:r.getWebappsBaseUrl()+"XCADLoader/",module:"XCADLoader",requiredAuth:h},C={provider:"FILE",filename:"XCADRepresentation.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},A={provider:"FILE",filename:"STEPInputDocument.js",serverurl:r.getWebappsBaseUrl()+"XCADSTEPDocument/",module:"XCADSTEPDocument",requiredAuth:h},I={provider:"FILE",filename:"XCADGeomLoader.js",serverurl:r.getWebappsBaseUrl()+"XCADLoader/",module:"XCADLoader",requiredAuth:h},T={provider:"FILE",filename:"XCADInputDocument.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},b={provider:"FILE",filename:"XCADProductRepresentation.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},L={provider:"FILE",filename:"XCADProduct.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},x={provider:"FILE",filename:"XCADProductInstance.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},w={provider:"FILE",filename:"XCADTessellatedRepresentation.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},E={provider:"FILE",filename:"STEPTessellatedRepresentation.js",serverurl:r.getWebappsBaseUrl()+"XCADSTEPDocument/",module:"XCADSTEPDocument",requiredAuth:h},g={provider:"FILE",filename:"STEPTessellatedAnnotationRepresentation.js",serverurl:r.getWebappsBaseUrl()+"XCADSTEPDocument/",module:"XCADSTEPDocument",requiredAuth:h},S={provider:"FILE",filename:"XCADFaceData.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},P={provider:"FILE",filename:"XCADEdgeData.js",serverurl:r.getWebappsBaseUrl()+"XCADInputDocuments/",module:"XCADInputDocuments",requiredAuth:h},X={provider:"FILE",filename:"STEPProduct.js",serverurl:r.getWebappsBaseUrl()+"XCADSTEPDocument/",module:"XCADSTEPDocument",requiredAuth:h},W={provider:"FILE",filename:"STEPProductInstance.js",serverurl:r.getWebappsBaseUrl()+"XCADSTEPDocument/",module:"XCADSTEPDocument",requiredAuth:h},y={provider:"FILE",filename:"STEPProductRepresentation.js",serverurl:r.getWebappsBaseUrl()+"XCADSTEPDocument/",module:"XCADSTEPDocument",requiredAuth:h},R={provider:"FILE",filename:"XCADWorkerInfra.js",serverurl:r.getWebappsBaseUrl()+"XCADWorkers/",module:"XCADWorkers",requiredAuth:h},F={provider:"FILE",filename:"XCADError.js",serverurl:r.getWebappsBaseUrl()+"XCADLoader/",module:"XCADLoader",requiredAuth:h},M=function(r,t,h){h||(h={}),this.gl=r;e.supportedExtensions&&e.supportedExtensions.elementIndexUint,this.renderCallbackFunc=void 0!==t?t:null,this.isWorkerLoading=!1,this.workers=null,this.workerJobs=null,this.workerJobsId=[],this.urlToRevoke="",this.keepLoader=!!h.keepLoader&&h.keepLoader,this.type="",this.dataArray=[],this.modelsToLoad=new Map,this.modelsToLoadCount=0,this.loadIndex=0,this.actualLoadIndex=0,this.nbWorkers=4,this.workersLoaded=[],this.workerActivate=!1,this.currentDownload=0,this.maxParrallelDownload=40,this.currentWorkerTask=0,this.maxTaskPerWorker=1,this.maxWorkerTask=this.maxTaskPerWorker*this.nbWorkers,M.prototype.cleanLoader=function(){};var B=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!1}),U=function(e,r,t){for(var o=0;o<e.length;o++){var a=e[o].primitive,s=e[o].transfo,d=e[o].descendants,i=void 0;i=t&&t.isIndexed&&!t.isIndexed()?n.createMeshNode(a,B):n.createMeshNode(a,B,0,"mono"),null!=s&&i.setMatrix(s),r.addChild(i),U(d,i)}},N=function(r){var t=r.getTransformation(),o=new e.Matrix4;if(void 0!==t&&t instanceof e.Matrix4)o=t;else{var a=t[1],n=t[0];o.set(n[0][0],n[0][1],n[0][2],a[0],n[1][0],n[1][1],n[1][2],a[1],n[2][0],n[2][1],n[2][2],a[2],0,0,0,1)}var s={CoordSys:""},d=new m(r._document,r._document.assyProducts[r._stepProductInstance.productReferenceIdx]),i=_(d,null,s,r.getInstanceAttributes()[0]);if(null!=s.CoordSys&&1==s.CoordSys.Coord&&null!=s.CoordSys.Origin&&0!=s.CoordSys.Origin.length){var l=parseFloat(s.CoordSys.Origin[0]),u=parseFloat(s.CoordSys.Origin[1]),c=parseFloat(s.CoordSys.Origin[2]),p=new e.Matrix3,h=new e.Vector3(s.CoordSys.RefDir[0],s.CoordSys.RefDir[1],s.CoordSys.RefDir[2]),D=new e.Vector3(s.CoordSys.Axis[0],s.CoordSys.Axis[1],s.CoordSys.Axis[2]),f=new e.Vector3;f.crossVectors(D,h),p.set(h.x,f.x,D.x,h.y,f.y,D.y,h.z,f.z,D.z);var v=new e.Matrix4;v.set(p.elements[0],p.elements[3],p.elements[6],l,p.elements[1],p.elements[4],p.elements[7],u,p.elements[2],p.elements[5],p.elements[8],c,0,0,0,1),o.multiply(v)}return void 0!==i&&i.setMatrix(o),i},_=function(e,r,t){var o,a=e.getProductAttributes(),l=a[0],u=e.getInstanceList();if(void 0!==e.getFilePath()){var c=a[1];(o=new s(r)).productType="Instance3D",o.name=r,void 0!==c&&(c.name=l,o.add(c)),t[l]=o,nbInstPart++}else{if(""!==l){var p=t[l];if(null!=p&&"Mesh3D"===p.getNodeType())return nbInstPart++,p.clone();var m=e.getDocument();if(void 0!==m){var h=new i(m,m._internalRepresentationIndex);if(void 0!==h)for(var D=(new d).load(h,null),f=(c=void 0,0);f<D.length;f++){var v=D[f],k=v.primitive,C=v.transfo,A=v.descendants;if(0!=k.nbPrimitives||0==k.nbPrimitives&&D.length>1)if(void 0===c)(c=h.isIndexed&&!h.isIndexed()?n.createMeshNode(k,B):n.createMeshNode(k,B,0,"mono")).name=l,c.productType="Instance3D",t[l]=c,null!=C&&c.setMatrix(C);else{var I=void 0;I=h.isIndexed&&!h.isIndexed()?n.createMeshNode(k,B):n.createMeshNode(k,B,0,"mono"),null!=C&&I.setMatrix(C),c.addChild(I),U(A,I,h)}}}}u.length>0?void 0===o&&((o=new s(l)).productType="Instance3D",void 0!==c&&o.add(c),t[l]=o):o=c;for(f=0;f<u.length;f++){var T=N(u[f]);void 0!==T&&o.add(T)}}return o};this.jobsScheduler=function(e){for(var r=[this.nbWorkers],t=0;t<this.nbWorkers;++t)r[t]=-1;for(t=0;t<this.workersLoaded.length;++t){for(var o=0,a=0;a<this.workerJobs[this.workersLoaded[t]].length;++a)o+=this.workerJobs[this.workersLoaded[t]][a];r[this.workersLoaded[t]]=o}var n=0,s=-1;for(t=0;t<this.nbWorkers;++t)-1!=r[t]&&(-1==s||r[t]<s)&&(s=r[t],n=t);this.workerJobs[n].push(e.inputFile.byteLength),this.workerJobsId[n].push(e.loadIndex),this.currentWorkerTask++,this.workers[n].postMessage(e,[e.inputFile])},this.internalLoad=function(){var e,r=this,t=this.actualLoadIndex,n=null,s=this.modelsToLoad.get(this.actualLoadIndex++),d=s.url;s.launched=!0,s.isBuffer?((n=s.url)&&n.buffer&&(n=n.buffer),e="STEP"):d&&d.filename&&(e=d.filename,e="STEP");var i={loadIndex:t,inputFile:n,node:e};if(s.isBuffer)this.jobsScheduler(i);else{this.currentDownload++;var l=new a;o.setProxyFromSpec(d,l);var u=d.serverurl?d.serverurl:"";u+=d.filename?d.filename:"";l.executeGetHttpRequest(u,"text",null,function(e){r.currentDownload--;i.inputFile=(new TextEncoder).encode(e).buffer,r.jobsScheduler(i)},function(e){r.currentDownload--,s.errorCallback(e)})}},this.setKeepLoaderMode=function(e){this.keepLoader=e,this.keepLoader||0!=this.modelsToLoadCount||this.abort()},this.load=function(r,t,a){var h=this;this.cleanLoader();void 0!==a.isBuffer&&a.isBuffer;var M,N,j=(M=this.loadIndex,N=t.errorCallback,function(e){N&&N(e);var r=h.modelsToLoad.get(M);if(r.applicativeContainers)for(var t in r.applicativeContainers)r.applicativeContainers[t].errorCallback&&r.applicativeContainers[t].errorCallback(e);for(h.modelsToLoad.delete(M),h.modelsToLoadCount--,0==h.modelsToLoadCount?(null!==h.renderCallbackFunc&&h.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,reframe:!0}),r.doneCallback&&r.doneCallback()):null!==h.renderCallbackFunc&&h.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,budgeted:!0});h.currentDownload<h.maxParrallelDownload&&h.currentWorkerTask<h.maxWorkerTask;){var o=h.modelsToLoad.get(h.actualLoadIndex);if(!o||!1!==o.launched)break;h.internalLoad()}}),q={url:r,readyCallback:t.readyCallback,progressCallback:t.progressCallback,doneCallback:t.doneCallback,errorCallback:j,isBuffer:a.isBuffer,destinationNode:a.destination,launched:!1};if(this.modelsToLoad.set(this.loadIndex++,q),this.modelsToLoadCount++,this.workers)this.currentDownload<this.maxParrallelDownload&&this.currentWorkerTask<this.maxWorkerTask&&this.workerActivate&&this.internalLoad();else if(!this.isWorkerLoading){var O;this.type="xcad",this.isWorkerLoading=!0,O=[D,f,v,k,C,T,b,x,W,A,L,w,E,g,S,P,X,y,I,R,F],o.getWorkerBlobFromSpecs(O,function(r){h.workers=[],h.workerJobs=[],h.workerJobsId=[],h.urlToRevoke=r;for(var t=0;t<h.nbWorkers;++t){h.workers[t]=new Worker(r),h.workerJobs[t]=[],h.workerJobsId[t]=[];!function(r){h.workers[r].onerror=function(e){var t=h.workerJobsId[r].shift();h.workerJobs[r].shift(),h.modelsToLoad.get(t).errorCallback(e)},h.workers[r].onmessage=function(t){if(t.data.associatedDocument instanceof Uint8Array){let e=new u;e.unserialize(t.data.associatedDocument),t.data.associatedDocument=e,t.data.stepRepresentationIndex=(new TextDecoder).decode(t.data.stepRepresentationIndex),t.data.stepAnnotRepresentationIndex&&(t.data.stepAnnotRepresentationIndex=(new TextDecoder).decode(t.data.stepAnnotRepresentationIndex)),t.data.rootNodes=JSON.parse((new TextDecoder).decode(t.data.rootNodes)),t.data.info=parseInt((new TextDecoder).decode(t.data.info)),t.data.node=(new TextDecoder).decode(t.data.node),t.data.loadIndex=parseInt((new TextDecoder).decode(t.data.loadIndex))}if(t.data.error&&t.data.loadIndex)return h.currentWorkerTask--,void((a=h.modelsToLoad.get(t.data.loadIndex)).errorCallback&&a.errorCallback(t.data));if(t.data.loaded){if(h.workersLoaded.push(r),!h.workerActivate)for(h.workerActivate=!0;h.currentDownload<h.maxParrallelDownload&&h.currentWorkerTask<h.maxWorkerTask;){var o=h.modelsToLoad.get(h.actualLoadIndex);if(!o||!1!==o.launched)break;h.internalLoad()}}else{h.currentWorkerTask--,h.workerJobs[r].shift(),h.workerJobsId[r].shift();var a=h.modelsToLoad.get(t.data.loadIndex);t.data.associatedDocument.stepTokenizeArgs=function(e,r){if(void 0!==e){r.length=0;e.substr(e.indexOf("(")+1,e.lastIndexOf(")")).match(/(\'[a-zA-Z0-9\s.,+-_#()~:&\\\"]*\')*(\([()]*(\([^()]*\)[^()]*)*\))*(\([a-zA-Z0-9\s.,-_#]*\))*(\.[a-zA-Z0-9\s.,-_#]*\.)*(\#?\-?[0-9]+[.-E0-9]*)*(\$)*/g).filter(function(e){return""!=e}).forEach(e=>{if("string"==typeof e&&e.startsWith("'")&&e.endsWith("'")&&(e=e.slice(1,-1)),e.indexOf("\\X2\\")>=0){var t=e.substr(e.indexOf("\\X2\\")+4,e.indexOf("\\X0\\")).match(/.{1,4}/g);t.forEach((e,r,t)=>{t[r]="0x"+e});var o=String.fromCharCode.apply(String,t);e=e.substr(0,e.indexOf("\\X2\\"))+o+e.substr(e.indexOf("\\X0\\")+4,e.length-1)}r.push(e)})}},t.data.associatedDocument._stepGetEntityType=function(e){var r,t=this.stepEntities[e];void 0!==t&&(r="("===t[0]?-1!==t.indexOf("TESSELLATED_GEOMETRIC_SET")?"TESSELLATED_GEOMETRIC_SET":"[COMPLEX_STEP_ENTITY]":t.match(/^\w+/)[0]);return{first:r,second:t}};var D=void 0;if(null!=t.data.associatedDocument&&t.data.associatedDocument._stepRepresentationType==c.XCAD_TESSELLATED_REPRESENTATION){(b=new i(t.data.associatedDocument,t.data.stepRepresentationIndex))._stepRepresentationIndex=t.data.stepRepresentationIndex;for(var f=(new d).load(b,null),v=0;v<f.length;v++){var k=(X=f[v]).primitive,C=X.transfo,A=X.descendants;if(0!=k.nbPrimitives||0==k.nbPrimitives&&f.length>1)if(void 0===D)(D=b.isIndexed&&!b.isIndexed()?n.createMeshNode(k,B):n.createMeshNode(k,B,0,"mono")).productType="Reference3D",null!=C&&D.setMatrix(C),a.destinationNode.addChild(D);else{var I=void 0;I=b.isIndexed&&!b.isIndexed()?n.createMeshNode(k,B):n.createMeshNode(k,B,0,"mono"),null!=C&&I.setMatrix(C),D.addChild(I),U(A,I,b)}}}else{var T,b=new p(t.data.associatedDocument,c.XCAD_PRODUCT_REPRESENTATION,"root");if(t.data.associatedDocument.rootProducts.length>0)T=t.data.associatedDocument.rootProducts[0];else for(var L in t.data.associatedDocument.assyProducts)if(t.data.associatedDocument.assyProducts[L].isRoot){T=L;break}var x=new m(t.data.associatedDocument,t.data.associatedDocument.assyProducts[T]);b.addRootProduct(x);for(var w=b.getRootProducts(),E=[],g=0;g<w.length;g++)D=_(w[g],null,E),a.destinationNode.addChild(D)}if(null!=t.data.stepAnnotRepresentationIndex){var S=new l(t.data.associatedDocument,t.data.stepAnnotRepresentationIndex);if(0!=(f=(new d).load(S,null)).length){var P=new s("3DPlay_XCAD_Annotation");for(v=0;v<f.length;v++){var X;k=(X=f[v]).primitive,C=X.transfo;if(k.noz=!0,0!=k.nbPrimitives)for(var W=0;W<k.primitives.length;W++){1===k.primitives[W].attr.fill.color.r&&1===k.primitives[W].attr.fill.color.g&&1==k.primitives[W].attr.fill.color.b&&(k.primitives[W].attr.fill.color.r=0,k.primitives[W].attr.fill.color.g=0,k.primitives[W].attr.fill.color.b=0);var y=new e.LineBasicMaterial({color:k.primitives[W].attr.fill.color,dashType:k.primitives[W].attr.line.pattern,side:e.DoubleSide,force:!0});k.primitives[W].material=y}I=void 0;(I=S.isIndexed&&!S.isIndexed()?n.createMeshNode(k,B):n.createMeshNode(k,B,0,"mono")).productType="Annotation_Representation",I.setRenderLineMode(e.ShowAllRenderLineMode),null!=C&&I.setMatrix(C),P.add(I),P.setVisibility(!1)}null!=D&&null!=P&&D.addChild(P)}}!function(e){if(a.readyCallback&&a.readyCallback({nodes:e}),h.modelsToLoad.delete(t.data.loadIndex),h.modelsToLoadCount--,0==h.modelsToLoadCount?(null!==h.renderCallbackFunc&&h.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,"needReframe ":!0,budgeted:!0}),a.doneCallback&&a.doneCallback({isLast:!1})):null!==h.renderCallbackFunc&&h.renderCallbackFunc({hack:!0,updateInfinitePlane:!0,budgeted:!0,"needReframe ":!0}),h.keepLoader||0!=h.modelsToLoadCount)for(;h.currentDownload<h.maxParrallelDownload&&h.currentWorkerTask<h.maxWorkerTask;){var r=h.modelsToLoad.get(h.actualLoadIndex);if(!r||!1!==r.launched)break;h.internalLoad()}else h.abort();a=null}([])}}}(t)}})}},M.prototype.abort=function(){if(this.workers)for(var e=0;e<this.workers.length;++e)this.workers[e].terminate(),this.workers[e]=null;this.workers=null,this.urlToRevoke="",this.isWorkerLoading=!1,this.modelsToLoad=new Map,this.modelsToLoadCount=0,this.loadIndex=0,this.actualLoadIndex=0,this.workersLoaded=[],this.workerActivate=!1,this.cleanLoader()}};return M});