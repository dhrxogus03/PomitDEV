define("DS/MPFStripeComponent/StripeInput",["UWA/Class/View","DS/MPFServices/ObjectService"],function(e,t){"use strict";const r=Object.freeze({ON_VALIDATION_STATE_CHANGE:"onValidationStateChange"}),n=Object.freeze({CARD_NUMBER:"cardNumber",EXPIRY_DATE:"cardExpiry",CVC:"cardCvc"}),s=new Map;s.set(n.CARD_NUMBER,"number"),s.set(n.EXPIRY_DATE,"expiration"),s.set(n.CVC,"cvc");const i=e.extend({className:"mpf-stripe-input",setup({type:e,label:t,isValid:r=!1}={}){this.type=e,this.label=t,this._isValid=r,this.container.addClassName(`mpf-stripe-card-${s.get(this.type)}-element-container`)},render(){return this.container.setContent([{tag:"label",html:[{tag:"span",class:"mpf-label",text:this.label},{tag:"div",class:"mpf-text-input",id:this._getElementId()}]},{tag:"div",class:"mpf-error-container",id:this._getErrorContainerId()}]),this},destroy(){this.input&&this.input.destroy(),this.input=null,this._parent(),this.container=null},mount({stripeElements:e}){return this.input&&this.input.destroy(),new Promise(t=>{this.input=this._createInput({stripeElements:e}),this.input.on("ready",t),this.input.mount("#"+this._getElementId())})},isValid(){return this._isValid},getInput(){return this.input},_createInput({stripeElements:e}){const t=e.create(this.type,{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return t.on("change",e=>{const t=!e.error,n=e.error?e.error.message:"";this.container.getElement("#"+this._getErrorContainerId()).setText(n),t!==this._isValid&&(this._isValid=t,this.dispatchEvent(r.ON_VALIDATION_STATE_CHANGE,{isValid:t}))}),t},_getElementId(){return`mpf-stripe-card-${s.get(this.type)}-element`},_getErrorContainerId(){return`mpf-stripe-card-${s.get(this.type)}-errors`}});return i.Types=n,i.Events=r,i}),define("DS/MPFStripeComponent/CardInputs",["UWA/Core","UWA/Class/View","UWA/Promise","DS/MPFServices/ObjectService","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/UIKIT/Input/Text","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent"],function(e,t,r,n,s,i,a,o,c,p){"use strict";const d=Object.freeze({VALID_FIELD:"validField",INVALID_FIELD:"invalidField"}),l=t.extend({className:"mpf-stripe-payment-form",setup:function(e={}){n.requiredOfPrototype(e.cart,i,"options.cart must be a CartModel"),n.requiredOfPrototype(e.cartPsp,a,"options.cartPsp must be a PspModel"),n.requiredOfPrototype(e.me,s,"options.me must be a PersonModel"),this.cart=e.cart,this.cartPsp=e.cartPsp,this.me=e.me,this.creditCardTokenMultiUse=e.creditCardTokenMultiUse,this.waitForPaymentModel=e.waitForPaymentModel,this.stripe=Stripe(this.cartPsp.getPublicKey()),this.stripeElements=this.stripe.elements(),this.cardNameHolderInput=this._createCardNameHolderInput(),this.cardNumberInput=this._createCardNumberInput(),this.cardExpiryDateInput=this._createCardExpiryDateInput(),this.cardVerificationCodeInput=this._createCardVerificationCodeInput(),this.cardParams={}},render:function(){return this.container.setContent([this._createCardNameHolderContainer(),this._createCardInputsContainers()]),this},mount:function(){this.cardNumberInput.mount("#mpf-stripe-card-number-element"),this.cardExpiryDateInput.mount("#mpf-stripe-card-expiration-element"),this.cardVerificationCodeInput.mount("#mpf-stripe-card-cvc-element")},proceedToPayment:function(){return this.cartPsp.isScaEnabled()?this._handleCardPayment():this._createPaymentToken()},destroy(){this.cart=null,this.cartPsp=null,this.me=null,this._parent(),this.container=null},_handleCardPayment:function(){const e={};return e.billing_details={name:this.cardNameHolderInput.getValue()},this._validateCardNameHolderInput(),this.stripe.handleCardPayment(this.cart.getPaymentIntentSecret(),this.cardNumberInput,{payment_method_data:e}).then(function(e){return e.error?r.reject(e.error):r.resolve()}).then(this._waitForPaymentStateUpdate.bind(this))},_createPaymentToken:function(){const e={},t={};return e.name=this.cardNameHolderInput.getValue(),this._validateCardNameHolderInput(),this.stripe.createToken(this.cardNumberInput,e).then(e=>e.token?(t[i.Fields.STATE]=i.States.PENDING_PAYMENT,t.payment_token=e.token.id,"1"===this.creditCardTokenMultiUse&&(t.CreditCardTokenMultiUse="1"),this.cart.savePromise(t,{patch:!0})):r.reject(e.error)).then(this._waitForPaymentStateUpdate.bind(this))},_waitForPaymentStateUpdate:function(){return this.waitForPaymentModel?this.waitForPaymentModel.fetchPromise().catch(()=>Promise.resolve()).then(()=>{if(this.waitForPaymentModel.getState()===o.States.PAYMENT_REFUSED)return r.reject("payment refused")}):r.resolve()},_createCardNameHolderInput:function(){const e=this;return new c({placeholder:p.get("cardHolder"),value:this.me.getFirstName()+" "+this.me.getLastName(),events:{onKeyDown:function(){this.setClassName(""),e.container.getElement("#mpf-stripe-card-holder-errors").setText("")}}})},_createCardNameHolderContainer:function(){return e.createElement("div",{class:"mpf-stripe-payment-card-holder",html:e.createElement("label",{html:[e.createElement("span",{text:p.get("cardHolder")}),this.cardNameHolderInput,e.createElement("div",{id:"mpf-stripe-card-holder-errors"})]})})},_validateCardNameHolderInput:function(){0===this.cardNameHolderInput.getValue().length&&(this.cardNameHolderInput.setClassName("invalid"),this.container.getElement("#mpf-stripe-card-holder-errors").setText(p.get("cardHolderEmpty")))},_createCardNumberInput:function(){const e=this.stripeElements.create("cardNumber",{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return e.addEventListener("change",e=>{e.error?this.container.getElement("#mpf-stripe-card-number-errors").setContent(e.error.message):this.container.getElement("#mpf-stripe-card-number-errors").setContent("")}),e},_createCardExpiryDateInput:function(){const e=this.stripeElements.create("cardExpiry",{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return e.addEventListener("change",e=>{e.error?this.container.getElement("#mpf-stripe-card-expiration-errors").setContent(e.error.message):this.container.getElement("#mpf-stripe-card-expiration-errors").setContent("")}),e},_createCardVerificationCodeInput:function(){const e=this.stripeElements.create("cardCvc",{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return e.addEventListener("change",e=>{e.error?this.container.getElement("#mpf-stripe-card-cvc-errors").setContent(e.error.message):this.container.getElement("#mpf-stripe-card-cvc-errors").setContent("")}),e},_createCardInputsContainers:function(){return[e.createElement("div",{class:"mpf-stripe-card-number-element-container",html:e.createElement("label",{html:[e.createElement("span",{text:p.get("cardNumber")}),e.createElement("div",{id:"mpf-stripe-card-number-element"}),e.createElement("div",{id:"mpf-stripe-card-number-errors"})]})}),e.createElement("div",{class:"mpf-stripe-card-expiration-element-container",html:e.createElement("label",{html:[e.createElement("span",{text:p.get("expiryDate")}),e.createElement("div",{id:"mpf-stripe-card-expiration-element"}),e.createElement("div",{id:"mpf-stripe-card-expiration-errors"})]})}),e.createElement("div",{class:"mpf-stripe-card-cvc-element-container",html:e.createElement("label",{html:[e.createElement("span",{text:"CVC"}),e.createElement("div",{id:"mpf-stripe-card-cvc-element"}),e.createElement("div",{id:"mpf-stripe-card-cvc-errors"})]})})]}});return l.Events=Object.freeze(d),l}),define("DS/MPFStripeComponent/PhaseCreditCardInputs",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPersonModel/PersonModel","DS/MPFPspModel/PspModel","DS/UIKIT/Input/Text","DS/MPFError/ValidationError","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent"],function(e,t,r,n,s,i,a,o){"use strict";const c=Object.freeze({INVALID:"invalid",VALID:"valid"}),p=e.extend({className:"mpf-stripe-phase-payment-form",setup(e={}){t.requiredOfPrototype(e.cartPayment,r,"options.cartPayment must be a CartPaymentModel"),t.requiredOfPrototype(e.cartPsp,s,"options.cartPsp must be a PspModel"),t.requiredOfPrototype(e.me,n,"options.me must be a PersonModel"),this.me=e.me,this.cartPsp=e.cartPsp,this.cartPayment=e.cartPayment,this.creditCardTokenMultiUse=e.creditCardTokenMultiUse,this.waitForPaymentModel=e.waitForPaymentModel,this.stripe=Stripe(this.cartPsp.getPublicKey()),this.elements=this.stripe.elements(),this.cardNameHolderInput=this._createCardNameHolderInput(),this.cardNumberInput=this._createCardNumberInput(),this.cardExpiryDateInput=this._createCardExpiryDateInput(),this.cardVerificationCodeInput=this._createCardVerificationCodeInput(),this.cardParams={}},render(){return this.container.setContent([{tag:"div",class:"mpf-stripe-payment-card-holder",html:[{tag:"label",html:[{tag:"span",text:o.get("cardHolder")},this.cardNameHolderInput,{tag:"div",id:"mpf-stripe-card-holder-errors"}]}]},{tag:"div",class:"mpf-stripe-card-number-element-container",html:[{tag:"label",html:[{tag:"span",text:o.get("cardNumber")},{tag:"div",id:"mpf-stripe-card-number-element"},{tag:"div",id:"mpf-stripe-card-number-errors"}]}],events:{onPostInject:()=>console.log("INJECTED"),onInjected:()=>console.log("INJECTED"),postInject:()=>console.log("INJECTED"),injected:()=>console.log("INJECTED")}},{tag:"div",class:"mpf-stripe-card-expiration-element-container",html:[{tag:"label",html:[{tag:"span",text:o.get("expiryDate")},{tag:"div",id:"mpf-stripe-card-expiration-element"},{tag:"div",id:"mpf-stripe-card-expiration-errors"}]}]},{tag:"div",class:"mpf-stripe-card-cvc-element-container",html:[{tag:"label",html:[{tag:"span",text:"CVC"},{tag:"div",id:"mpf-stripe-card-cvc-element"},{tag:"div",id:"mpf-stripe-card-cvc-errors"}]}]}]),this},mount(){this.cardNumberInput.mount("#mpf-stripe-card-number-element"),this.cardExpiryDateInput.mount("#mpf-stripe-card-expiration-element"),this.cardVerificationCodeInput.mount("#mpf-stripe-card-cvc-element")},destroy(){this.me=null,this.cartPayment=null,this.container=null},async proceedToPayment(){if(this._validateCardNameHolderInput(),this.cartPsp.isScaEnabled()){const e={};return this.cartPayment.getState()!==r.States.PAYMENT_INITIATED&&(e[r.Fields.STATE]=r.States.PENDING_PAYMENT),this.creditCardTokenMultiUse&&(e.CreditCardTokenMultiUse="1"),Object.keys(e).length>0&&await this.cartPayment.savePromise(e,{patch:!0}),this._handleCardPayment()}return this._createPaymentToken()},async _handleCardPayment(){const e={billing_details:{name:this.cardNameHolderInput.getValue()}},t=await this.stripe.handleCardPayment(this.cartPayment.getPaymentIntentSecret(),this.cardNumberInput,{payment_method_data:e});if(t.error){throw t.error.type&&"validation_error"===t.error.type?new a(t.error.message):new Error(t.error.message)}await this._waitForPaymentStateUpdate()},_waitForPaymentStateUpdate(){return this.waitForPaymentModel?this.waitForPaymentModel.fetchPromise().catch(()=>Promise.resolve()).then(()=>{if(this.waitForPaymentModel.getState()===r.States.PAYMENT_REFUSED)return Promise.reject(new Error("payment refused"))}):Promise.resolve()},async _createPaymentToken(){const e=await this.stripe.createToken(this.cardNumberInput,{name:this.cardNameHolderInput.getValue()});if(!e.token)throw new Error(e.error);{const t={[r.Fields.STATE]:r.States.PENDING_PAYMENT,payment_token:e.token.id};"1"===this.creditCardTokenMultiUse&&(t.CreditCardTokenMultiUse="1"),await this.cartPayment.savePromise(t,{patch:!0}),await this._waitForPaymentStateUpdate()}},_createCardNameHolderInput(){const e=this;return new i({placeholder:o.get("cardHolder"),value:this.me.getFirstName()+" "+this.me.getLastName(),disabled:!1,events:{onKeyDown:function(){this.setClassName(""),e.container.getElement("#mpf-stripe-card-holder-errors").setText("")}}})},_validateCardNameHolderInput(){0===this.cardNameHolderInput.getValue().length&&(this.cardNameHolderInput.setClassName("invalid"),this.container.getElement("#mpf-stripe-card-holder-errors").setText(o.get("cardHolderEmpty")))},_createCardNumberInput(){const e=this.elements.create("cardNumber",{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return e.addEventListener("change",e=>{e.error?this.container.getElement("#mpf-stripe-card-number-errors").setContent(e.error.message):this.container.getElement("#mpf-stripe-card-number-errors").setContent("")}),e},_createCardExpiryDateInput(){const e=this.elements.create("cardExpiry",{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return e.addEventListener("change",e=>{e.error?this.container.getElement("#mpf-stripe-card-expiration-errors").setContent(e.error.message):this.container.getElement("#mpf-stripe-card-expiration-errors").setContent("")}),e},_createCardVerificationCodeInput(){const e=this.elements.create("cardCvc",{classes:{base:"StripeCardElement",focus:"StripeCardElement--focus",invalid:"StripeCardElement--invalid"}});return e.addEventListener("change",e=>{e.error?this.container.getElement("#mpf-stripe-card-cvc-errors").setContent(e.error.message):this.container.getElement("#mpf-stripe-card-cvc-errors").setContent("")}),e}});return p.Events=c,p}),define("DS/MPFStripeComponent/StripePaymentHelper",["UWA/Core"],function(e){"use strict";return class{static waitUntilElementInjected({container:e,elementId:t}){return new Promise(r=>{e.querySelectorAll("#"+t).length>0?r():new MutationObserver((e,n)=>{for(let s=0;s<e.length;s++){const i=e[s];"childList"===i.type&&i.addedNodes.forEach(e=>{e.id===t&&(n.disconnect(),r())})}}).observe(e,{childList:!0,attributes:!1,subtree:!1})})}static isStripeLoadedInDocument(){return document.querySelectorAll('script[src^="https://js.stripe.com/v3/"]').length>0}static createStripeScriptTag({onLoad:t,onError:r}){return e.createElement("script",{src:"https://js.stripe.com/v3/",attributes:{async:!0},events:{load:t,error:r}})}}}),define("DS/MPFStripeComponent/StripeBadge",["UWA/Class/View","DS/WebappsUtils/WebappsUtils","css!DS/MPFStripeComponent/MPFStripeComponent"],function(e,t){"use strict";const r=Object.freeze({}),n=e.extend({className:"mpf-stripe-badge",domEvents:{click:"_onClick"},setup(){},render(){return this.container.setContent([{tag:"div",class:"mpf-save-and-secure-info",text:"Save and secure checkout"},{tag:"img",id:"mpf-stripe-tag",class:"mpf-stripe-icon",src:t.getWebappsAssetUrl("MPFStripeComponent","graphics/pictures/PoweredByStripe.svg")}]),this},destroy(){this._parent(),this.container=null},_onClick(){window.open("https://stripe.com/privacy","_blank")}});return n.Events=r,n}),define("DS/MPFStripeComponent/CartInfoSection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent"],function(e,t,r,n,s){"use strict";return t.extend({className:"mpf-stripe-cart-section",setup:function(e){e||(e={}),r.requiredOfPrototype(e.cart,n,"options.cart must be a CartModel"),this.cart=e.cart,this.locale=e.locale||"fr-FR",this.merchantLine=this._createMerchantLine(),this.orderNumberLine=this._createOrderNumberLine(),this.amountLine=this._createOrderAmountLine()},render:function(){return this.container.setContent([this.merchantLine,this.orderNumberLine,this.amountLine]),this},_createMerchantLine:function(){return e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:s.get("merchant")}),e.createElement("span",{class:"mpf-stripe-value",text:"3DMarketplace"})]})},_createOrderNumberLine:function(){return e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:s.get("order")}),e.createElement("span",{class:"mpf-stripe-value",text:this.cart.getName()})]})},_createOrderAmountLine:function(){var t;return t=this.cart.has(n.Fields.COUPON)?parseFloat(this.cart.getCoupon().totalToPay):this.cart.get("GrossAmountTotal"),e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:s.get("amount")}),e.createElement("span",{class:"mpf-stripe-value",text:t.toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})})]})}})}),define("DS/MPFStripeComponent/CardHolderInput",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Text","DS/MPFServices/ObjectService","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent"],function(e,t,r,n,s){"use strict";const i=Object.freeze({ON_VALIDATION_STATE_CHANGE:"onValidationStateChange"}),a=t.extend({className:"mpf-card-holder-input mpf-stripe-input",setup({person:e}={}){const t=this._getDefaultValue({person:e});this.input=this._createInput({person:e,defaultValue:t}),this.errorContainer=this._createErrorContainer(),this._isValid=!!t},render(){return this.container.setContent([{tag:"label",html:[{tag:"span",class:"mpf-label",text:s.get("cardHolder")},this.input]},this.errorContainer]),this},destroy(){this.input=null,this.errorContainer=null,this._parent(),this.container=null},getValue(){return this.input.getValue()},isValid(){return!!this.getValue()},_onChange(){const e=this.isValid();e?this.errorContainer.setText(""):this.errorContainer.setText(s.get("cardHolderEmpty")),e!==this._isValid?(this._isValid=e,this.dispatchEvent(i.ON_VALIDATION_STATE_CHANGE,{isValid:e})):this._isValid=e},_createInput({person:e,defaultValue:t}){return new r({placeholder:s.get("cardHolder"),className:"mpf-text-input",value:t,events:{onKeyDown:this._onChange.bind(this)}})},_createErrorContainer:()=>e.createElement("div",{class:"mpf-error-container"}),_getDefaultValue({person:e}){const t=e.getFirstName(),r=e.getLastName();return t&&r&&t+" "+r}});return a.Events=i,a}),define("DS/MPFStripeComponent/PhaseInfoSection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent"],function(e,t,r,n,s,i){"use strict";return t.extend({className:"mpf-stripe-phase-section",setup:function(e={}){r.requiredOfPrototype(e.cart,n,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartPhase,s,"options.cartPhase must be a CartPhaseModel"),this.cart=e.cart,this.cartPhase=e.cartPhase,this.locale=e.locale},render:function(){return this.container.setContent([this._createMerchantLine(),this._createOrderNumberLine(),this._createPhaseNumberLine(),this._createOrderAmountLine()]),this},destroy:function(){this.cartPayment=null,this._parent(),this.container=null},_createMerchantLine:function(){return e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:i.get("merchant")}),e.createElement("span",{class:"mpf-stripe-value",text:"3DMarketplace"})]})},_createOrderNumberLine:function(){return e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:i.get("order")}),e.createElement("span",{class:"mpf-stripe-value",text:this.cart.getName()})]})},_createPhaseNumberLine:function(){return e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:i.get("phase")}),e.createElement("span",{class:"mpf-stripe-value",text:this.cartPhase.getPhaseNumber()})]})},_createOrderAmountLine:function(){const t=this.cart.getCurrency();return e.createElement("div",{html:[e.createElement("span",{class:"mpf-stripe-label",text:i.get("amount")}),e.createElement("span",{class:"mpf-stripe-value",text:parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"})})]})}})}),define("DS/MPFStripeComponent/StripePhasePaymentPage",["UWA/Core","UWA/Class/View","UWA/Promise","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Spinner","DS/MPFServices/MarketplaceServices","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFStripeComponent/PhaseCreditCardInputs","DS/MPFStripeComponent/PhaseInfoSection","DS/MPFStripeComponent/StripePaymentHelper","DS/MPFError/ValidationError","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent","css!DS/MPFStripeComponent/MPFStripeComponent"],function(e,t,r,n,s,i,a,o,c,p,d,l,h,m,u,C,P,S){"use strict";const E=Object.freeze({PAYMENT_SUCCESS:"onPaymentSuccess",PAYMENT_FAILURE:"onPaymentFailure"}),f=Object.freeze({LOADING:"loading",LOADED:"loaded",ERROR:"error"}),I=t.extend({className:"mpf-stripe-phase-payment-page",setup:function(e={}){h.requiredOfPrototype(e.me,c,"options.me must be a PersonModel"),h.requiredOfPrototype(e.cart,p,"options.cart must be a CartModel"),h.requiredOfPrototype(e.cartPhase,d,"options.cartPhase must be a CartPhaseModel"),h.requiredOfPrototype(e.cartPsp,l,"options.cartPsp must be a PspModel"),h.requiredOfPrototype(e.cartPayment,o,"options.cartPayment must be a CartPaymentModel"),this.me=e.me,this.cart=e.cart,this.cartPhase=e.cartPhase,this.cartPsp=e.cartPsp,this.cartPayment=e.cartPayment,this.creditCardTokenMultiUse=e.creditCardTokenMultiUse,this.waitForPaymentModel=e.waitForPaymentModel,this.locale=e.locale||"fr-FR",this.service=e.service||a.ENGINEERING,this.stripeLoadedElsewhere=C.isStripeLoadedInDocument(),this.spinner=new i,this.stripeScriptTag=this._createStripeScriptTag(),this.phaseInfoSection=this._createPhaseInfoSection(),this.paymentButton=this._createPaymentButton(),this.readyToMountDeferred=r.deferred(),this.stripeLoadedElsewhere?(this.creditCardInputs=this._createCreditCardInputs(),this.state=f.LOADED):this.state=f.LOADING},render:function(){return this.state===f.LOADING?(this.container.setContent([this.stripeScriptTag,this.spinner]),this.spinner.show()):this.state===f.ERROR?(this.container.setContent([{tag:"div",class:"fonticon fonticon-status-ko"},{tag:"div",class:"mpf-error-info",text:S.get("failedToLoadPaymentPage")}]),this.readyToMountDeferred.reject()):(this.container.setContent([!this.stripeLoadedElsewhere&&this.stripeScriptTag,e.createElement("div",{class:"mpf-stripe-phase-payment-body",html:[this._createLogoContainer(),this.phaseInfoSection.render(),this.creditCardInputs.render(),this.paymentButton]})]),this.readyToMountDeferred.resolve()),this},whenReadyToMount(){return this.readyToMountDeferred.promise},mountStripeInputs(){this.creditCardInputs.mount()},destroy:function(){this.stopListening(),this.phaseInfoSection&&this.phaseInfoSection.destroy(),this.creditCardInputs&&this.creditCardInputs.destroy(),this.phaseInfoSection=null,this.creditCardInputs=null,this.me=null,this.cart=null,this.cartPhase=null,this.cartPsp=null,this.cartPayment=null,this.creditCardTokenMultiUse=null,this._parent(),this.container=null},_createStripeScriptTag(){return C.createStripeScriptTag({onLoad:()=>{this.creditCardInputs=this._createCreditCardInputs(),this.state=f.LOADED,this.render()},onError:()=>{this.state=f.ERROR,this.render()}})},_createPhaseInfoSection:function(){return new u({cart:this.cart,cartPhase:this.cartPhase,locale:this.locale})},_createCreditCardInputs:function(){const e=new m({me:this.me,cartPsp:this.cartPsp,cartPayment:this.cartPayment,creditCardTokenMultiUse:this.creditCardTokenMultiUse,waitForPaymentModel:this.waitForPaymentModel});return this.listenTo(e,m.Events.INVALID,this._updatePaymentButton.bind(this,!1)),this.listenTo(e,m.Events.VALID,this._updatePaymentButton.bind(this,!0)),e},_createPaymentButton:function(e){return new n({className:"primary",value:S.get("pay"),disabled:!1,events:{onClick:this._proceedToPayment.bind(this)}})},_updatePaymentButton(e){this.paymentButton.setDisabled(!e)},_proceedToPayment:function(){s.mask(this.container,S.get("paymentInProgress")),this.creditCardInputs.proceedToPayment().then(()=>{s.unmask(this.container),this.dispatchEvent(E.PAYMENT_SUCCESS)}).catch(e=>{s.unmask(this.container),e instanceof P||this.dispatchEvent(E.PAYMENT_FAILURE)})},_createLogoContainer:function(){return e.createElement("div",{class:"mpf-stripe-form-ds-logo"})}});return I.Events=E,I.States=f,I}),define("DS/MPFStripeComponent/StripeCreditCardForm",["UWA/Core","UWA/Class/View","DS/UIKIT/Spinner","DS/UIKIT/Mask","DS/WebappsUtils/WebappsUtils","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFStripeComponent/StripePaymentHelper","DS/MPFStripeComponent/CardHolderInput","DS/MPFStripeComponent/StripeInput","DS/MPFStripeComponent/StripeBadge","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent","css!DS/MPFStripeComponent/MPFStripeComponent"],function(e,t,r,n,s,i,a,o,c,p,d,l){"use strict";const h=Object.freeze({ON_VALIDATION_STATE_CHANGE:"onValidationStateChange",ON_PAYMENT_SUCCESS:"onPaymentSuccess",ON_PAYMENT_FAILURE:"onPaymentFailure"}),m=Object.freeze({LOADING:"loading",LOADED:"loaded",ERROR:"error"}),u=t.extend({className:"mpf-stripe-credit-card-form",setup({person:e,cart:t,phase:n,psp:s,stripeContainerSelector:i}={}){this.person=e,this.cart=t,this.phase=n,this.psp=s,this.stripeContainerSelector=i,this.spinner=new r,this.badge=new d,this.cardHolderInput=this._createCardHolderInput(),this.numberInput=this._createStripeInput(p.Types.CARD_NUMBER,l.get("cardNumber")),this.expiryDateInput=this._createStripeInput(p.Types.EXPIRY_DATE,l.get("expiryDate")),this.cvcInput=this._createStripeInput(p.Types.CVC,"CVC"),this._isValid=!1,o.isStripeLoadedInDocument()?this.state=m.LOADED:this.state=m.LOADING},render(){if(this.state===m.LOADED)this._renderLoadedState(),n.mask(this.container),this._mountWhenInjected().then(()=>{n.unmask(this.container)});else if(this.state===m.LOADING){this._renderLoadingState(),this.spinner.show();const e=document.querySelector(this.stripeContainerSelector);this._createStripeScriptTag().inject(e)}else this._renderKoState();return this},async pay(){const e=this.cardHolderInput.getValue();if(this.psp.isScaEnabled()){const{error:t}=await this.stripe.handleCardPayment(this.cart.getPaymentIntentSecret(),this.numberInput.getInput(),{payment_method_data:{billing_details:{name:e}}});if(t)return Promise.reject(t)}else{const{token:t,error:r}=await this.stripe.createToken(this.numberInput.getInput(),{name:e});if(t)return{token:t};if(r)return Promise.reject(r)}},isValid(){return this._isValid},destroy(){this.stopListening(),this.cardHolderInput.destroy(),this.numberInput.destroy(),this.expiryDateInput.destroy(),this.cvcInput.destroy(),this.cardHolderInput=null,this.numberInput=null,this.expiryDateInput=null,this.cvcInput=null,this.stripe=null,this.stripeElements=null,this.person=null,this.psp=null,this._parent(),this.container=null},async _mountWhenInjected(){await o.waitUntilElementInjected({container:this.container,elementId:"mpf-stripe-tag"}),await this._mount()},_renderLoadedState(){this.container.setContent([this.cardHolderInput.render(),this.numberInput.render(),this.expiryDateInput.render(),this.cvcInput.render(),this.badge.render()])},_renderLoadingState(){this.container.setContent([this.spinner])},_renderKoState(){this.container.setContent([{tag:"div",class:"fonticon fonticon-status-ko"},{tag:"div",class:"mpf-error-info",text:l.get("failedToLoadPaymentSection")}])},_mount(){return this.stripe&&this.stripeElements||(this.stripe=Stripe(this.psp.getPublicKey())),this.stripeElements||(this.stripeElements=this.stripe.elements()),Promise.all([this.numberInput.mount({stripeElements:this.stripeElements}),this.expiryDateInput.mount({stripeElements:this.stripeElements}),this.cvcInput.mount({stripeElements:this.stripeElements})])},_onChange(){const e=this.cardHolderInput.isValid()&&this.numberInput.isValid()&&this.expiryDateInput.isValid()&&this.cvcInput.isValid();e!==this._isValid&&(this._isValid=e,this.dispatchEvent(h.ON_VALIDATION_STATE_CHANGE,{isValid:e}))},_createStripeScriptTag(){return o.createStripeScriptTag({onLoad:()=>{this.state=m.LOADED,this.render()},onError:()=>{this.state=m.ERROR,this.render()}})},_createCardHolderInput(){const e=new c({person:this.person});return this.listenTo(e,c.Events.ON_VALIDATION_STATE_CHANGE,this._onChange.bind(this)),e},_createStripeInput(e,t){const r=new p({type:e,label:t});return this.listenTo(r,p.Events.ON_VALIDATION_STATE_CHANGE,this._onChange.bind(this)),r}});return u.Events=h,u}),define("DS/MPFStripeComponent/StripePaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Spinner","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFPspModel/PspModel","DS/MPFPersonModel/PersonModel","DS/MPFServices/ObjectService","DS/MPFStripeComponent/CartInfoSection","DS/MPFStripeComponent/CardInputs","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFStripeComponent/StripePaymentHelper","i18n!DS/MPFStripeComponent/assets/nls/MPFStripeComponent","css!DS/MPFStripeComponent/MPFStripeComponent"],function(e,t,r,n,s,i,a,o,c,p,d,l,h,m,u,C,P){"use strict";const S=Object.freeze({PAY_WITH_CARD:"payWithCard",CARD_VALIDATION_ERROR:"CardValidationError"}),E=Object.freeze({LOADING:"loading",LOADED:"loaded",ERROR:"error"}),f=Object.freeze({PAYMENT_SUCCESS:"onPaymentSuccess",PAYMENT_FAILURE:"onPaymentFailure",LOADED:"loaded",PAYMENT_IN_PROGRESS:"paymentInProgress",VALIDATION_ERROR:"validationError"}),I=r.extend({className:"mpf-stripe-payment-page",setup:function(e={}){d.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),d.requiredOfPrototype(e.me,p,"options.me must be a PersonModel"),d.requiredOfPrototype(e.cartPsp,c,"options.cartPsp must be a PspModel"),this.service=e.service,this.cart=e.cart,this.cartPsp=e.cartPsp,this.me=e.me,this.waitForPaymentModel=e.waitForPaymentModel,this.locale=e.locale||"fr-FR",this.isStripeAlreadyLoaded=C.isStripeLoadedInDocument(),this.spinner=new i,this.stripeScriptTag=this._createStripeScriptTag(),this.cartInfoSection=this._createCartInfoSection(),this.paymentButton=this._createPaymentButton(),this.readyToMountDeferred=t.deferred(),this.isStripeAlreadyLoaded?(this.cardInputs=this._createCardInputs(),this.state=E.LOADED):this.state=E.LOADING},render:function(){return this.state===E.LOADED?(this.container.setContent([!this.isStripeAlreadyLoaded&&this.stripeScriptTag,{tag:"div",class:"mpf-stripe-payment-body",html:[this._createLogoContainer(),this.cartInfoSection.render(),this.cardInputs.render(),this.paymentButton]}]),this.readyToMountDeferred.resolve(),this.dispatchEvent(f.LOADED)):this.state===E.LOADING?(this.container.setContent([this.stripeScriptTag,this.spinner]),this.spinner.show()):(this.container.setContent([{tag:"div",class:"fonticon fonticon-status-ko"},{tag:"div",class:"mpf-error-info",text:P.get("failedToLoadPaymentPage")}]),this.readyToMountDeferred.reject(),this.dispatchEvent(f.LOADED)),this},destroy(){this.stopListening(),this.cartInfoSection.destroy(),this.cardInputs&&this.cardInputs.destroy(),this.cartInfoSection=null,this.cardInputs=null,this.stripeScriptTag=null,this.cart=null,this.cartPsp=null,this.me=null,this._parent(),this.container=null},whenReadyToMount(){return this.readyToMountDeferred.promise},mountCardInputs(){this.cardInputs.mount()},_createStripeScriptTag(){return C.createStripeScriptTag({onLoad:()=>{this.cardInputs=this._createCardInputs(),this.state=E.LOADED,this.render()},onError:()=>{this.state=E.ERROR,this.render()}})},_createCartInfoSection:function(){return new l({locale:this.locale,cart:this.cart})},_createCardInputs:function(){const e=new h({cart:this.cart,cartPsp:this.cartPsp,me:this.me,waitForPaymentModel:this.waitForPaymentModel,creditCardTokenMultiUse:this.cart.get("CreditCardTokenMultiUse")});return this.listenTo(e,h.Events.INVALID_FIELD,this.paymentButton.disable.bind(this.paymentButton)),this.listenTo(e,h.Events.VALID_FIELD,this.paymentButton.enable.bind(this.paymentButton)),e},_createPaymentButton:function(){return new n({className:"primary",value:P.get("pay"),events:{onClick:this._proceedToPayment.bind(this)}})},_proceedToPayment:function(){s.mask(this.container,P.get("paymentInProgress")),this.dispatchEvent(f.PAYMENT_IN_PROGRESS),this.cardInputs.proceedToPayment().then(()=>{s.unmask(this.container),this.dispatchEvent(f.PAYMENT_SUCCESS)}).catch(e=>{s.unmask(this.container),"validation_error"===e.type?this.dispatchEvent(f.VALIDATION_ERROR):(this._sendTrackingEvent(S.CARD_VALIDATION_ERROR),this.dispatchEvent(f.PAYMENT_FAILURE))})},_sendTrackingEvent(e){const t=m.createEventBuilder({category:"Checkout",action:e});o.addTrackerInformation(t,this.cart),t.addDimension(u.MARKETPLACE_SERVICE,this.service).send()},_createLogoContainer:function(){return e.createElement("div",{class:"mpf-stripe-form-ds-logo"})}});return I.Events=f,I.States=E,I});