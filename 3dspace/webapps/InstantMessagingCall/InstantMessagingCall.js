define("DS/InstantMessagingCall/store/modules/messages",["i18n!DS/InstantMessagingCall/assets/nls/feed"],function(e){"use strict";const t=e;return{state:(()=>({NLS:t,connexionLost:!1,bodyAlerts:{connexionLost:{text:t.startCallAbortedBecauseOffline,type:"warning",timeout:3e3,visible:!1},connexionRetrieved:{text:t.connexionRetrieved,type:"success",timeout:3e3,visible:!1},reconnectOngoing:{text:t.reconnectOngoing,type:"warning",timeout:3e3,visible:!1},connexionNetworkLost:{text:t.connexionNetworkLost,type:"error",timeout:0,visible:!1},callUnavailablePlurial:{text:t.callUnavailablePlurial,type:"warning",timeout:3e3,visible:!1},callUnavailableSingular:{text:t.callUnavailableSingular,type:"warning",timeout:3e3,visible:!1},publishDocument:{text:t.publishDocument,type:"success",timeout:3e3,visible:!1},publishDocumentError:{text:t.publishDocumentError,type:"error",timeout:3e3,visible:!1},audiomuted:{text:t.audiomuted,type:"warning",timeout:3e3,visible:!1},mediaDeviceNotFound:{text:t.localMediaError_NotFoundError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessDisabled:{text:t.localMediaError_SecurityError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessAborted:{text:t.localMediaError_AbortError,type:"warning",timeout:3e3,visible:!1},mediaAccessNotAllowed:{text:t.localMediaError_NotAllowedError,type:"warning",timeout:3e3,visible:!1},mediaDeviceAccessFailed:{text:t.localMediaError_OverConstrainedError,type:"warning",timeout:3e3,visible:!1},mediaDeviceNotSupported:{text:t.localMediaError_NotReadableError,type:"warning",timeout:3e3,visible:!1},browserNotCompatible:{text:t.localMediaError_TypeError,type:"warning",timeout:3e3,visible:!1},callOnHold:{text:t.alert_callOnHold,type:"primary",visible:!1,closable:!1},alreadyOnCall:{text:t.alreadyOnCall,type:"warning",timeout:3e3,visible:!1},ODEEditionNotSupported:{text:t.ODEEditionNotSupported,type:"warning",timeout:0,visible:!1}}}))(),getters:{nls:e=>t=>e.NLS[t],bodyAlerts:e=>e.bodyAlerts},mutations:{bodyAlertVisible:(e,{key:t,visible:i})=>{e.bodyAlerts[t]?e.bodyAlerts[t].visible=i:console.error("bodyAlert not found "+t)},connexionLost:(e,t)=>{e.connexionLost=t},bodyAlertText:(e,{key:t,text:i})=>{e.bodyAlerts[t]?e.bodyAlerts[t].text=i:console.error("bodyAlert not found "+t)}},actions:{hide_bodyAlert({commit:e},t){e("bodyAlertVisible",{key:t,visible:!1})},show_bodyAlert({commit:e},t){e("bodyAlertVisible",{key:t,visible:!0})},alert_connexionLost({dispatch:e,commit:t}){t("connexionLost",!0),e("hide_bodyAlert","connexionRetrieved"),e("show_bodyAlert","connexionLost")},alert_connexionRetrieved({state:e,dispatch:t,commit:i}){e.connexionLost&&(t("hide_bodyAlert","connexionLost"),t("hide_bodyAlert","connexionNetworkLost"),t("show_bodyAlert","connexionRetrieved"),i("connexionLost",!1))},alert_reconnectOngoing({dispatch:e}){e("hide_bodyAlert","connexionLost"),e("hide_bodyAlert","connexionRetrieved"),e("hide_bodyAlert","connexionNetworkLost"),e("show_bodyAlert","reconnectOngoing")},alert_connexionNetworkLost({dispatch:e}){e("hide_bodyAlert","connexionLost"),e("hide_bodyAlert","connexionRetrieved"),e("hide_bodyAlert","reconnectOngoing"),e("show_bodyAlert","connexionNetworkLost")},alert_uncallableUsers({getters:e,dispatch:t,commit:i},{uncallableUsers:r,calledUsers:s}){var o=r.length,a=o>1?"callUnavailablePlurial":"callUnavailableSingular";i("bodyAlertText",{text:e.nls(a).replace("{0}",o).replace("{1}",s.length+o),key:a}),t("show_bodyAlert",a)},alert_publishDocument({dispatch:e}){e("show_bodyAlert","publishDocument")},alert_publishDocumentError({dispatch:e}){e("show_bodyAlert","publishDocumentError")},alert_audiomuted({dispatch:e}){e("show_bodyAlert","audiomuted")},alert_browserNotCompatible({dispatch:e}){e("show_bodyAlert","browserNotCompatible")},alert_getLocalMediaError({dispatch:e},t){switch(t.name){case"NotFoundError":case"DevicesNotFoundError":e("show_bodyAlert","mediaDeviceNotFound");break;case"SecurityError":e("show_bodyAlert","mediaDeviceAccessDisabled");break;case"AbortError":e("show_bodyAlert","mediaDeviceAccessAborted");break;case"NotAllowedError":case"PermissionDeniedError":e("show_bodyAlert","mediaAccessNotAllowed");break;case"NotReadableError":case"TrackStartError":case"InvalidStateError":case"MediaDeviceFailedDueToShutdown":case"MediaDeviceKillSwitchOn":case"InternalError":e("show_bodyAlert","mediaDeviceAccessFailed");break;case"OverConstrainedError":case"ConstraintNotSatisfiedError":e("show_bodyAlert","mediaDeviceNotSupported");break;case"TypeError":case"NotSupportedError":e("show_bodyAlert","browserNotCompatible");break;default:console.error(t)}},alert_callOnHold({dispatch:e}){e("show_bodyAlert","callOnHold")},alert_callResumed({dispatch:e}){e("hide_bodyAlert","callOnHold")},alert_alreadyOnCall({dispatch:e}){e("show_bodyAlert","alreadyOnCall")},alert_ODEEditionNotSupported({dispatch:e}){e("show_bodyAlert","ODEEditionNotSupported")}}}}),define("DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem",["text!DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem.html"],function(e){"use strict";return{props:["label","rightTooltip"],template:e}}),define("DS/InstantMessagingCall/store/modules/notifSW",["DS/RTProxyDriver/RTLogger","i18n!DS/InstantMessagingCall/assets/nls/feed"],function(e,t){"use strict";window.Notification=window.Notification||window.webkitNotification||window.mozNotification;const i=()=>({serviceWorker:navigator.serviceWorker,swScriptUrl:void 0,registration:void 0,actionsAvailability:null});return{state:i(),getters:{serviceWorker:e=>e.serviceWorker,swScriptUrl:e=>e.swScriptUrl,registration:e=>e.registration,actionsAvailability:e=>e.actionsAvailability,notificationsSupported:()=>!!window.Notification,serviceWorkerSupported:()=>!!navigator.serviceWorker,badgeIcon_url:()=>window.dsDefaultWebappsBaseUrl+"/i3DXCompass/assets/small-compass.ico",loginIcon_url:(e,t)=>e=>t.swymUrl+"/api/user/getpicture/login/"+e,accept_button:()=>({action:"accept",title:t.acceptCall}),cancel_button:()=>({action:"refuse",title:t.cancel}),resume_button:()=>({action:"resume",title:t.resumeCall}),refuse_button:()=>({action:"refuse",title:t.refuseCall})},mutations:{resetNotificationsState(e){Object.assign(e,i())},serviceWorker:(e,t)=>{e.serviceWorker=t},swScriptUrl:(e,t)=>{e.swScriptUrl=t},registration:(e,t)=>{e.registration=t},actionsAvailability:(e,t)=>{e.actionsAvailability=t}},actions:{notifSW({dispatch:t,getters:i},{action:r,data:s}){if(i.isMobile||i.isIOS)return e.CallNotif("No Desktop notifications for mobile");switch(r){case"initSW":t("initNotifSW");break;case"inviteReceived":t("notifInviteReceived",s);break;case"acceptCall":case"callAccepted":t("notifCallAccepted",s);break;case"endCall":t("closeNotification",{tag:s.room_id}),t("stopFocusListener");break;case"closeNotifRoomId":t("closeNotification",{tag:s.room_id});default:e.CallNotif("unknown notifications action "+r)}},onMessageSW({dispatch:t,getters:i},r){e.CallNotif("Message from desktop notification: "+r);let s=r.data&&r.data.action,o=r.data&&r.data.room_id,a=i.room(o);switch(s){case"accept":if(e.CallNotif("Call accepted from desktop notification: "+o),!a)return e.CallNotif("SW accept - No room found for "+o);t("acceptCall",{room_id:a.room_id,type:a.type,noNotif:!0});break;case"resume":if(e.CallNotif("Call resumed from desktop notification: "+o),!a)return e.CallNotif("SW resume - No room found for "+o);t("resumeCall",a.room_id);break;case"refuse":if(e.CallNotif("Call refused from desktop notification: "+o),!a)return e.CallNotif("SW refuse - No room found for "+o);t("endCall",a);break;default:e.CallNotif("unknown SW message "+r.data)}},initNotifSW({getters:t,dispatch:i,commit:r}){e.CallNotif("Desktop notifications permission set to: "+window.Notification&&window.Notification.permission),r("swScriptUrl",t.assets_url+"notifSwScript.js"),i("registerServiceWorker")},requestNotificationPermission({getters:t}){if(t.isMobile||t.isIOS)return e.CallNotif("Desktop notifications permission set to false for mobile");window.Notification.requestPermission(t=>{e.CallNotif("Desktop notifications permission set to "+t)})},registerServiceWorker:({commit:t,getters:i,dispatch:r},s)=>i.serviceWorkerSupported?i.actionsAvailability&&i.registration?(s&&r("showNotification",s),e.CallNotif("Service Workers already registered")):(e.CallNotif("Service Workers registration ..."),i.serviceWorker.register(i.swScriptUrl,{}).then(i=>{e.CallNotif("Service Workers registration SUCCESS"),t("registration",i),t("actionsAvailability",!0)}).catch(i=>{e.CallNotif("Service worker registration FAILED: "+i),t("actionsAvailability",!1)}).then(()=>{s&&r("showNotification",s)}),i.serviceWorker.onmessage=(e=>{r("onMessageSW",e)}),void i.serviceWorker.startMessages()):(t("actionsAvailability",!1),e.CallNotif("Service Workers not supported")),showNotification:({dispatch:t,getters:i},{title:r,options:s})=>i.isHidden?r?(e.CallNotif("New browser notification: "+r+" : "+s.body),window.Notification&&"granted"===window.Notification.permission?!1===i.actionsAvailability?(s.actions=[],e.CallNotif("Cannot send notification without registered service worker"),e.CallNotif("Actions button not supported")):i.registration&&i.registration.active?(i.registration.showNotification(r,s),e.CallNotif("Notification via Service Worker: "+r)):void 0:e.CallNotif("Cannot send notification if permission not granted: "+window.Notification&&window.Notification.permission)):e.CallNotif("Cannot send notification without title"):e.CallNotif("No notification sent when tab is focused. isHidden: "+i.isHidden),closeNotification:({getters:t},{tag:i})=>i?(e.CallNotif("Close notification ("+i+")"),t.registration?void t.registration.getNotifications().then(t=>{if(!t||!t[0])return e.CallNotif("Close notification: No opened notifications found.");t.filter(e=>e.tag===i).map(e=>e.close())}):e.CallNotif("Cannot close notification without registered service worker.")):e.CallNotif("Cannot close notification without tag."),closeAllNotifications({getters:t}){if(!t.registration)return e.CallNotif("Cannot close notifications without registered service worker.");t.registration.getNotifications().then(t=>{if(!t||!t[0])return e.CallNotif("Close all notifications: No opened notifications found.");e.CallNotif("Close all notifications: "+t.length+" opened notifications found."),t.map(e=>e.close())})},notifInviteReceived({dispatch:i,getters:r},{room_id:s,username:o,login:a}){if(e.CallNotif("Invite received: "+s),!s)return e.CallNotif("Cannot send callAccepted notifications without room_id.");const n=r.room(s);let l=n&&(r.roomName(n)||n.user&&n.user.username)||o||a,d=t.incoming,c=[r.accept_button,r.refuse_button];n&&n.IamTheCaller&&(d=t.calling,c=[r.cancel_button]),r.isOpera&&(c=[]),i("showNotification",{title:l,options:{body:d,tag:s,data:{url:window.location.href},icon:r.loginIcon_url(a),badge:r.badgeIcon_url,requireInteraction:!0,actions:c}})},notifCallAccepted({dispatch:i,getters:r},{room_id:s}){if(e.CallNotif("Call accepted: "+s),!s)return e.CallNotif("Cannot send callAccepted notifications without room_id.");const o=r.room(s),a=o&&(r.roomName(o)||o.user&&o.user.username)||r.called_users_name(s),n=r.logins_except_myself[0];let l=t.ongoing,d=[r.refuse_button];r.is_onhold_room(s)&&(l=t.onHold,d=[r.resume_button,r.refuse_button]),r.isOpera&&(d=[]),i("showNotification",{title:a,options:{body:l,tag:s,data:{url:window.location.href},icon:r.loginIcon_url(n),badge:r.badgeIcon_url,requireInteraction:!0,actions:d}})}}}}),define("DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument",["text!DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument.html","DS/UIKIT/Input/Button","DS/UIKIT/Mask"],function(e,t,i){"use strict";var r=void 0;return{props:["featureData","featureId","active"],computed:{title(){var e=this.featureData;if(!e||!e.title||!this.featureId)return this.publishButton&&this.publishButton.destroy(),this.$refs.OdeContainer&&this.$refs.OdeContainer.children[0]&&"function"==typeof this.$refs.OdeContainer.children[0].destroy&&this.$refs.OdeContainer.children[0].destroy(),r&&(r=void 0),null;if(e&&e.title&&e.ext&&e.url&&this.featureId){var s=this.$store.getters.swymUrl,o=this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId,a=this;this.publishButton=((e,i)=>{var r=document.getElementById("im-call-lightbox");if(r)var s=r.getElementsByClassName("lightbox-bar__menu");var o=s[0].getElementsByClassName("bt_publish");o[0]&&"function"==typeof o[0].destroy&&o[0].destroy();var a=new t({value:e,className:"primary bt_publish",id:"bt_publish",events:{onClick:i}});return a.getContent().style.margin="5px",s[0].insertBefore(a.getContent(),s[0].firstChild),a})(this.$store.getters.nls("publish"),()=>{i.mask(a.publishButton.getContent(),""),((e,t,i,s)=>{var o={community_id:t,id_media:i};r.save({callbackUrl:e+"/api/media/editmedia",params:o,headers:{"X-DS-SWYM-CSRFTOKEN":"ode:{csrfToken}"},filenameForUpload:"userFile",firstCallUrl:e+"/api/session/info"}).then(function(e){s()},function(e){switch(e){case r.ERROR.NO_DOCUMENT_URL_PROVIDED:console.error("ODE Collab : NO_DOCUMENT_URL_PROVIDED");break;case r.ERROR.SERVICE_NOT_FOUND:console.error("ODE Collab : SERVICE_NOT_FOUND");break;default:console.error("ODE Collab : "+e)}s(e)})})(s,o,e.mediaId,function(e){i.unmask(a.publishButton.getContent()),e?a.$store.dispatch("alert_publishDocumentError"):a.$store.dispatch("alert_publishDocument")})}),(({title:e,ext:t,url:i},s,o,a,{isMobile:n,isODEEditionSupported:l})=>{if(!(e&&t&&i&&s))return console.error("loadODE missing params");o.children[0]&&"function"==typeof o.children[0].destroy&&o.children[0].destroy(),require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor","DS/OfficeDocumentEditorClient/Utils"]).then(function(d){r=d[0];var c=d[1];if(r){var u=UWA.extendElement(o);r.init({title:e,ext:t,url:i,readOnly:!1,docKeyToUse:"featureId"+s,useIframe:!0,rootElem:u,platformId:a}).then(function(e){const i=c.isDeviceSupportedForEditingDoc(n,(()=>{switch(t){case"docx":return c.DOCTYPE.WORD;case"pptx":return c.DOCTYPE.PRESENTATION;case"xlsx":return c.DOCTYPE.SPREADSHEET}})());l(i)},function(e){switch(e){case r.ERROR.NO_DOCUMENT_URL_PROVIDED:console.error("ODE Collab : NO_DOCUMENT_URL_PROVIDED");break;case r.ERROR.SERVICE_NOT_FOUND:console.error("ODE Collab : SERVICE_NOT_FOUND");break;default:console.error("ODE Collab : "+e)}})}})})(e,this.featureId,this.$refs.OdeContainer,this.$store.getters.tenant,{isMobile:this.$store.getters.isMobile,isODEEditionSupported:e=>this.$store.dispatch("send_isODEEditionNotSupported",e)})}return e.title}},template:e}}),define("DS/InstantMessagingCall/store/modules/noises",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingWebRTC/js/model/NoiseMaker"],function(e,t){"use strict";return{state:(()=>({noiseMaker:t,holdToneDisplayed:!1}))(),getters:{holdtoneURL:(e,t)=>t.assets_url+"holdtone.mp3"},mutations:{noiseURL(e,{noisename:t,url:i}){e.noiseMaker.set(t,i)},startRingtone(e){e.noiseMaker.start("ringtone",3e4)},startRingbacktone(e){e.noiseMaker.start("ringbacktone",3e4)},stopTones(e){e.noiseMaker.stop("ringtone"),e.noiseMaker.stop("ringbacktone"),e.noiseMaker.stop("holdtone")},userIn(e){e.noiseMaker.start("userin")},userOut(e){e.noiseMaker.start("userout")},startHoldtone(e){e.noiseMaker.start("holdtone",!0)},stopHoldtone(e){e.noiseMaker.stop("holdtone")}},actions:{noises({commit:t},{action:i}){switch(i){case"userIn":t("userIn");break;case"userOut":t("userOut");break;case"startRingtone":t("startRingtone");break;case"startRingbacktone":t("startRingbacktone");break;case"stopTones":t("stopTones");break;case"startHoldtone":t("startHoldtone");break;case"stopHoldtone":t("stopHoldtone");break;default:e.error("unknown noises action "+i)}},preloadNoises({state:e,commit:t,getters:i}){const r=i.assets_url;t("noiseURL",{noisename:"ringtone",url:r+"ringtone.mp3"}),t("noiseURL",{noisename:"ringbacktone",url:r+"ringbacktone.wav"}),t("noiseURL",{noisename:"userin",url:r+"userin.mp3"}),t("noiseURL",{noisename:"userout",url:r+"userout.mp3"}),t("noiseURL",{noisename:"holdtone",url:i.holdtoneURL}),e.noiseMaker.preload()}}}}),define("DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline",["text!DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline.html"],function(e){"use strict";var t,i;return{computed:{dmId(){if(this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options){this.$refs.TimelineContainer.children[0]&&this.$refs.TimelineContainer.children[0].destroy();var e=this.$store.getters.accepted_room.options.dmId;e&&((e,r,s)=>{if(t=t||require("DS/i3DXCompass/i3DXCompass"),i=i||require("UWA/Core"),!t||!i)return console.error("PanelTimeline prereqs not available");var o=UWA.extendElement(e);o.getParent().style.height="100%";r=r;var a=s.toUpperCase();t.getAppInfo({appId:"X3DMCTY_AP",onComplete:function(e){if(e){var t,s,n,l={communityType:"dm",community:r,x3dPlatformId:a,leftPanelState:"closed"},d=JSON.stringify(l),c={el:o,parent:!1,preview:!1,appId:"X3DMCTY_AP",data:d,header:!1};if(!e||!(e.checksum&&e.launchInfos||e.platforms))return console.error("Could not get valid Config from MyApps for the App "+c.appId);if(e.platformId&&e.platformId.toLowerCase()===a.toLowerCase())t=e.launchInfos,s=e.isolationLevel,n=e.checksum;else{var u=e.platforms.find(e=>e.id.toLowerCase()===a.toLowerCase());if(!u)return console.error("Could not get valid Config from MyApps for the App "+c.appId);t=u.launchInfos,s=u.isolationLevel,n=u.checksum}c=i.extend(c,{widgetId:t,isolationLevel:s,token:n}),require("DS/TopFrame/TopFrame")._loadModules(["DS/UWPClientCode/WidgetFactory","DS/TopFrame/Environment"]).then(function(e){var t=e[0],i=e[1];t.load(c,function(e){},i)})}}})})(this.$refs.TimelineContainer,e,this.$store.getters.tenant)}return this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId}},template:e}}),define("DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay",["DS/3DPlayHelper/3DPlayHelper","UWA/Data","text!DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay.html"],function(e,t,i){"use strict";var r;return{props:["featureData","featureId","masterUser","active","feature"],computed:{title(){if(!this.active)return null;var t=this.featureData;return t?(r&&r.isReady&&r.isReady()?console.log("Collab 3DPLay player already running"):((t,i,s,o)=>{if(!t||!i)return console.error("load3DPlay missing params");if(!t.mime)return console.error("load3DPlay missing mime");if(!t.fileName)return console.error("load3DPlay missing fileName");if(!t.path)return console.error("load3DPlay missing path");i.children[0]&&"function"==typeof i.children[0].destroy&&i.children[0].destroy();const a={collabmode:!0,container:i,input:{asset:{filename:t.path,provider:"FILE",format:t.mime,type:t.mime}},options:{loading:"autoplay",callbacks:{experience:{ExperienceReady:()=>{s&&(r.setCollabMode(!0),"function"==typeof o&&r.addCollabCB((e,t)=>{o({arg1:e,arg2:t})}))}},asset:{LoadingFinished:()=>{console.log("Collab 3DPlay LoadingFinished")}}}}};a.input.asset.originalAsset=JSON.parse(JSON.stringify(a.input.asset)),r&&"function"==typeof r.dispose&&r.dispose(),r=new e(a)})(t,this.$refs.TroisDPlayContainer,this.IAmMaster,this.collabCallback),t.title):null},IAmMaster(){return this.masterUser&&this.masterUser.login==this.$store.getters.myself.login},masterLogin(){if(!this.active||!this.masterUser)return null;var e=this.masterUser.login;return console.log("Collab 3DPLay master changed "+e),e},actions(){if(this.IAmMaster||!this.active||!this.feature||!this.feature.featureData)return null;var e=this.feature.featureData.actions;return e&&this.onCoreviewAction(e),e}},methods:{collabCallback({arg1:e,arg2:t}){this.$store.dispatch("send_3DPlay_data",{room_id:this.feature.room_id,featureId:this.featureId,featureData:this.featureData,actions:{arg1:e,arg2:t}})},onCoreviewAction({arg1:e,arg2:t}){if(r&&"function"==typeof r.isReady&&r.isReady()&&"function"==typeof r.performAction)try{r.performAction(e,t)}catch(e){console.error(e)}}},template:i}}),define("DS/InstantMessagingCall/api/senders",["DS/RTProxyDriver/RTProxyDriver","DS/PlatformAPI/PlatformAPI"],function(e,t){"use strict";const i=["startCall","endCall","acceptCall","webrtcIceCandidate","SDP","callEventFromView"],r={};for(let t of i)r[t]=function(i){return function(r){var s;return e.dispatch(i,[{...r,TxID:(s=`${t}`,Date.now()+"-r"+Math.floor(998*Math.random()+1)+"-"+s)}]),!0}}(t);return r.presence=(t=>{e.dispatch("SETSTATUS",[{myStatus:t,statusMsg:t}])}),r.ToSwym=(e=>{t.publish("toswym.im.ds.com",e)}),r}),define("DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard",["text!DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard.html"],function(e){"use strict";return{props:["featureData","featureId","masterUser","active"],data:()=>({sketchObj:null,isLoaded:!1}),computed:{title(){if(!this.active)return this.callInactive&&this.cleanWhiteboard(),null;var e=this.featureData;return e?(!this.isLoaded&&this.loadWhiteboard(),e.title):null},masterLogin(){if(!this.active||!this.masterUser)return null;var e=this.masterUser.login,t=e==this.$store.getters.myself.login;return this.sketchObj&&"function"==typeof this.sketchObj.onChangeCollabMaster&&this.sketchObj.onChangeCollabMaster({login:e,IAmMaster:t}),e},callInactive(){return this.$store.getters.isInitial||this.$store.getters.isEnded}},methods:{loadWhiteboard(){this.isLoaded=!0;var e=this.featureData,t=this.$refs.WhiteboardContainer;if(!e||!t)return console.error("loadWhiteboard missing params");t.children[0]&&"function"==typeof t.children[0].destroy&&t.children[0].destroy(),require("DS/TopFrame/TopFrame")._loadModules(["DS/CAT3DSKBootstrap/CAT3DSketchBootstrap"]).then((i=>(function(r){var s=r[0];s?(i.sketchObj=new s,i.sketchObj.create(t,e)):this.isLoaded=!1}))(this))},cleanWhiteboard(){this.sketchObj&&"function"==typeof this.sketchObj.destroy&&(this.sketchObj.destroy(),this.sketchObj=null,this.isLoaded=!1)}},template:e}}),define("DS/InstantMessagingCall/store/modules/focus",["DS/RTProxyDriver/RTLogger"],function(e){"use strict";return{state:{isHidden:null,hidden:null,visibilityChange:null},getters:{isHidden:e=>e.isHidden,hidden:e=>e.hidden,visibilityChange:e=>e.visibilityChange},mutations:{resetFocusState(e){Object.assign(e,{isHidden:null,hidden:null,visibilityChange:null})},isHidden:(e,t)=>{e.isHidden=!!t},hidden:(e,t)=>{e.hidden=t},visibilityChange:(e,t)=>{e.visibilityChange=t}},actions:{getFocusNavigatorValues({commit:e,getters:t}){void 0!==document.hidden?(e("hidden","hidden"),e("visibilityChange","visibilitychange")):void 0!==document.msHidden?(e("hidden","msHidden"),e("visibilityChange","msvisibilitychange")):void 0!==document.webkitHidden&&(e("hidden","webkitHidden"),e("visibilityChange","webkitvisibilitychange")),null!==t.hidden&&e("isHidden",document[t.hidden])},listenFocusEvent:({getters:t,commit:i,dispatch:r})=>void 0===document.addEventListener||null===t.hidden||null===t.visibilityChange?e.CallNotif("Browser does not support the Page Visibility API."):document[t.visibilityChange]?e.CallNotif("Focus Listener already started. isHidden: "+t.isHidden):void document.addEventListener(t.visibilityChange,function(s){i("isHidden",document[t.hidden]),e.CallNotif("Focus - Visibility change: isHidden: "+t.isHidden),t.isHidden?(t.accepted_room_id&&(e.CallNotif("Focus - Accepted room: "+t.accepted_room_id),r("notifSW",{action:"callAccepted",data:{room_id:t.accepted_room_id}})),t.invitations&&t.invitations.length>0&&(e.CallNotif("Focus - Invitations room: "+t.invitations.length),t.invitations.map(e=>{r("notifSW",{action:"inviteReceived",data:{room_id:e}})}))):r("closeAllNotifications")}),startFocusListener({dispatch:t,getters:i}){t("getFocusNavigatorValues"),t("listenFocusEvent"),e.CallNotif("Focus Listener started. isHidden: "+i.isHidden)},stopFocusListener({getters:t}){if(void 0!==t.room_id_accepted||t.room_id_invitations&&t.room_id_invitations.length>0)return e.CallNotif("Not stopping focus listeners because some calls are still running.");document.removeEventListener(t.visibilityChange,()=>{e.CallNotif("Focus Listener stopped")})}}}}),define("DS/InstantMessagingCall/store/modules/telephony",["DS/RTProxyDriver/RTLogger","DS/DSNodeSocketioClient_4.7.4/DSNodeSocketioClient_4.7.4"],function(e,t){"use strict";window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;return{state:{mediaSource:null,telwebsocket:null,mediaRecorder:null,holdRecorder:null,sourceBuffer:null,streamTel:null,streamHold:null,streaming:!1,callOnHold:!1,audioBitsPerSecond:null,holdFramesCount:0},mutations:{resetTelephonyState(e){Object.assign(e,{mediaSource:null,telwebsocket:null,mediaRecorder:null,holdRecorder:null,sourceBuffer:null,streamTel:null,streamHold:null,streaming:!1,callOnHold:!1,audioBitsPerSecond:null,holdFramesCount:0})},telwebsocket:(e,t)=>{e.telwebsocket=t},mediaRecorder:(e,t)=>{e.mediaRecorder=t},holdRecorder:(e,t)=>{e.holdRecorder=t},mediaSource:(e,t)=>{e.mediaSource=t},streamTel:(e,t)=>{e.streamTel=t},streamHold:(e,t)=>{e.streamHold=t},sourceBuffer:(e,t)=>{e.sourceBuffer=t},streaming:(e,t)=>{e.streaming=!!t},callOnHold:(e,t)=>{e.callOnHold=!!t},audioBitsPerSecond:(e,t)=>{e.audioBitsPerSecond=t},holdFramesCount:(e,t)=>{t?e.holdFramesCount=0:e.holdFramesCount++}},getters:{mediasource:e=>e.mediaSource,mediaSource:e=>e.mediaSource,mediaRecorder:e=>e.mediaRecorder,holdRecorder:e=>e.holdRecorder,sourceBuffer:e=>e.sourceBuffer,streamTel:e=>e.streamTel,streamHold:e=>e.streamHold,telwebsocket:e=>e.telwebsocket,streaming:e=>e.streaming,callOnHold:e=>e.callOnHold,audioBitsPerSecond:e=>e.audioBitsPerSecond,holdFramesCount:e=>e.holdFramesCount},actions:{recordHoldStream({getters:t,dispatch:i},{audioBitsPerSecond:r}){e.Call("Telephony recordHoldStream");const s=new Audio(t.holdtoneURL);s.loop=!0;const o=new window.AudioContext,a=o.createMediaElementSource(s),n=o.createMediaStreamDestination();a.connect(n),s.play(),i("onHoldMediaStream",{stream:n.stream,audioBitsPerSecond:r})},onHoldMediaStream:({commit:t,getters:i,dispatch:r},{stream:s,audioBitsPerSecond:o})=>(e.Call("Telephony onHoldMediaStream"),s?(t("streamHold",s),o&&t("audioBitsPerSecond",o),t("holdRecorder",new MediaRecorder(i.streamHold,{audioBitsPerSecond:i.audioBitsPerSecond||24e3})),i.holdRecorder?(i.holdRecorder.ondataavailable=(e=>{i.holdFramesCount>1?r("sendHoldStreamWebTel",e.data):t("holdFramesCount",!1)}),i.holdRecorder.onpause=(()=>e.Call("Telephony holdRecorder onpause.")),void r("resumeHoldTrack")):console.error("Telephony failed to create holdRecorder")):e.Call("Telephony onHoldMediaStream no stream")),sendHoldStreamWebTel({getters:e},t){e.telwebsocket&&e.telwebsocket.emit("web-hold-stream",t)||console.error("cant sendHoldStreamWebTel : missing telwebsocket")},muteHoldTrack({getters:t}){if(e.Call("Telephony muteHoldTrack"),t.callOnHold||!t.holdRecorder||"inactive"===t.holdRecorder.state)return Promise.reject("muteHoldTrack failed: no holdRecorder active or call on hold.");try{return t.holdRecorder.pause()}catch(e){return Promise.reject("muteHoldTrack failed "+e)}},resumeHoldTrack({getters:t,dispatch:i}){if(e.Call("Telephony resumeHoldTrack"),!t.callOnHold)return Promise.reject("resumeHoldTrack failed: call is not on hold.");if(t.holdRecorder||i("recordHoldStream",{}),"inactive"===t.holdRecorder.state)return t.holdRecorder.start(20);try{return t.holdRecorder.resume()}catch(e){return Promise.reject("resumeHoldTrack failed "+e)}},stopHoldTrack({getters:t,commit:i}){if(e.Call("Telephony stopHoldTrack"),i("holdFramesCount",!0),!t.holdRecorder)return!0;if(t.holdRecorder.ondataavailable=null,t.holdRecorder.onpause=null,"inactive"===t.holdRecorder.state)return!0;try{return t.holdRecorder.stop()}catch(t){e.Call("Telephony stopHoldTrack failed "+t)}},stopHoldStream({getters:t}){e.Call("Telephony stopHoldStream");try{return t.streamHold.getTracks().forEach(e=>e&&e.stop&&e.stop())}catch(t){e.Call("Telephony stopHoldStream failed "+t)}},recordStream:({dispatch:t},{audioBitsPerSecond:i})=>(e.Call("Telephony recordStream"),t("getUserMedia",{audio:!0}).then(e=>t("onMediaDeviceStream",{stream:e,audioBitsPerSecond:i})).catch(function(t){e.Call("Fail to record, error in getUserMedia "+t)})),onMediaDeviceStream:({commit:t,getters:i,dispatch:r},{stream:s,audioBitsPerSecond:o})=>(e.Call("Telephony onMediaDeviceStream"),s?(t("streamTel",s),o&&t("audioBitsPerSecond",o),t("mediaRecorder",new MediaRecorder(i.streamTel,{audioBitsPerSecond:i.audioBitsPerSecond||24e3})),i.mediaRecorder?(i.mediaRecorder.ondataavailable=(e=>r("sendStreamWebTel",e.data)),i.mediaRecorder.onpause=(()=>e.Call("Telephony mediaRecorder onpause.")),void r("resumeTelTrack")):console.error("Telephony failed to create MediaRecorder")):e.Call("Telephony onMediaDeviceStream no stream")),sendStreamWebTel({getters:e},t){e.telwebsocket&&e.telwebsocket.emit("web-stream",t)||console.error("cant sendStreamWebTel : missing telwebsocket")},resumeTelTrack({getters:t,dispatch:i}){if(e.Call("Telephony resumeTelTrack"),!t.streaming||t.callOnHold)return Promise.reject("resumeTelTrack failed: call on hold or not streaming.");if(t.mediaRecorder||i("recordStream",{}),"inactive"===t.mediaRecorder.state)return t.mediaRecorder.start(20);try{return t.mediaRecorder.resume()}catch(e){return Promise.reject("resumeTelTrack failed "+e)}},muteTelTrack({getters:t}){if(e.Call("Telephony muteTelTrack"),!t.mediaRecorder||"inactive"===t.mediaRecorder.state)return Promise.reject("muteTelTrack failed: No active mediaRecorder.");try{return t.mediaRecorder.pause()}catch(e){return Promise.reject("muteTelTrack failed "+e)}},stopTelTrack({getters:t}){if(e.Call("Telephony stopTelTrack"),!t.mediaRecorder)return!0;if(t.mediaRecorder.ondataavailable=null,t.mediaRecorder.onpause=null,"inactive"==t.mediaRecorder.state)return!0;try{return t.mediaRecorder.stop()}catch(t){e.Call("Telephony stopTelTrack failed "+t)}},stopTelStream({getters:t}){e.Call("Telephony stopTelStream");try{return t.streamTel.getTracks().forEach(e=>e&&e.stop&&e.stop())}catch(t){e.Call("Telephony stopTelStream failed "+t)}},activeStreamWebTel({dispatch:t,commit:i},{onHold:r}){e.Call("Telephony activeStreamWebTel- onHold: "+r),i("callOnHold",r),t("muteHoldTrack").catch(t=>e.Call("Telephony activeStreamWebTel "+t)).then(()=>t("resumeTelTrack")).catch(t=>e.Call("Telephony activeStreamWebTel "+t))},muteStreamWebTel({dispatch:t,commit:i},{onHold:r}){e.Call("Telephony muteStreamTelWeb - onHold: "+r),i("callOnHold",r),t("muteTelTrack").catch(t=>e.Call("Telephony muteStreamTelWeb "+t)).then(()=>t("resumeHoldTrack")).catch(t=>e.Call("Telephony muteStreamTelWeb "+t))},initMediaSource({commit:t,getters:i,dispatch:r}){if(e.Call("Telephony initMediaSource"),t("mediaSource",new MediaSource),!i.mediaSource)return console.error("Telephony failed to create MediaSource");i.mediaSource.addEventListener("sourceopen",t=>{e.Call("Telephony initMediaSource sourceopen"),r("onMediaSourceOpen",t)})},onMediaSourceOpen({getters:t,commit:i,dispatch:r}){if(e.Call("Telephony onMediaSourceOpen"),!t.mediaSource)return console.error("Telephony onMediaSourceOpen no mediaSource");i("sourceBuffer",t.mediaSource.addSourceBuffer("audio/mpeg")),r("received_track_audio",{user_id:t.accepters[0]},{root:!0})},stopSourceBuffer({getters:t}){e.Call("Telephony stopSourceBuffer");try{return t.sourceBuffer&&t.sourceBuffer.abort()}catch(t){e.Call("Telephony stopSourceBuffer failed "+t)}},stopMediaSource({getters:t}){if(e.Call("Telephony stopMediaSource"),!t.mediaSource)return!0;try{if(t.mediaSource.onsourceopen=null,"open"!=t.mediaSource.readyState)return!0;t.mediaSource.endOfStream(),t.mediaSource.removeSourceBuffer(t.sourceBuffer)}catch(t){e.Call("Telephony stopMediaSource failed "+t)}},disconnectTelWS({getters:t}){e.Call("Telephony disconnectTelWS");try{return!(t.telwebsocket&&!t.telwebsocket.disconnected)||t.telwebsocket.io.disconnect()}catch(t){e.Call("Telephony disconnectTelWS failed "+t)}},connectTelWS:({commit:i,dispatch:r,getters:s},{connectionParams:o,call_id:a,url:n,cookie:l})=>o?n?a?(l||e.Call("WARNING - TelWS will be randomly chosen without cookie"),s.telwebsocket?e.Call("TelWS already exists "+(s.telwebsocket.call_id&&s.telwebsocket.call_id==a)&&"for same call"):(e.Call("connectTelWS "+n+" for call "+a),cookieStore.set({name:"TELSERVERID",value:l,path:"/",domain:"3ds.com"}),i("telwebsocket",t.connect(n,Object.assign({},o,{reconnection:!1,path:o&&o.socketioPath||"/socketio.tel"}))),s.telwebsocket?(s.telwebsocket.call_id=a,s.telwebsocket.cookie=l,s.telwebsocket.on("connect",e=>{r("onConnect",e)}),s.telwebsocket.on("connection_ok",e=>{r("onConnectionOK",e)}),s.telwebsocket.on("start-streaming",e=>{r("onStartStream",e)}),s.telwebsocket.on("stop-streaming",e=>{r("onStopStream",e)}),s.telwebsocket.on("pstn-stream",e=>{r("onPstnStream",e)}),void s.telwebsocket.on("disconnect",e=>{r("onDisconnect",e)})):e.Call("connectTelWS failed"))):e.Call("cant connectTelWS without call_id"):e.Call("cant connectTelWS without url"):e.Call("cant connectTelWS without params"),onDisconnect({dispatch:t},i){e.Call("Telephony close-ws "+i&&i.call_id),t("cleanTelephony")},onPstnStream({getters:t},i){try{if(!t.sourceBuffer)throw"no sourceBuffer.";if(!t.mediaSource||"open"!=t.mediaSource.readyState)throw"mediaSource not ready";if(t.sourceBuffer.updating)return e.Call("Telephony onPstnStream sourceBuffer is already processing another chunk");t.sourceBuffer.appendBuffer(i)}catch(t){e.Call("Telephony onPstnStream Error : "+t)}},onStartStream({dispatch:t,getters:i,commit:r},s){e.Call("Telephony start-streaming."),r("streaming",!0),i.mediaRecorder&&"inactive"!==i.mediaRecorder.state||t("recordStream",s)},onStopStream({dispatch:t,commit:i},r){e.Call("Telephony stop-streaming"),i("streaming",!1),t("muteTelTrack"),t("muteHoldTrack")},onConnectionOK({getters:t,dispatch:i},r){e.Call("Telephony connection_ok"),i("initMediaSource"),t.telwebsocket.emit("init_call",{call_id:t.telwebsocket.call_id,cookie:t.telwebsocket.cookie,allCookie:document.cookie})},onConnect({},t){e.Call("Telephony connected")},cleanTelephony({getters:t,commit:i,dispatch:r},s){r("stopTelTrack").then(()=>r("stopTelStream")).then(()=>r("stopHoldTrack")).then(()=>r("stopHoldStream")).then(()=>r("disconnectTelWS")).then(()=>r("stopMediaSource")).then(()=>r("stopSourceBuffer")).then(()=>i("resetTelephonyState")).catch(t=>{e.Call("Telephony cleanTelephony failed "+t),i("resetTelephonyState")})}}}}),define("DS/InstantMessagingCall/store/modules/usergroup",["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WAFData/WAFData","DS/RTProxyDriver/RTLogger"],function(e,t,i,r){"use strict";return{state:Object.assign({odeFeature:!0,whiteboardFeature:!0,telephonyFeature:!1,troisdplayFeature:!1},{}),getters:{odeFeature:e=>e.odeFeature,whiteboardFeature:e=>e.whiteboardFeature,telephonyFeature:e=>e.telephonyFeature,troisdplayFeature:e=>e.troisdplayFeature},mutations:{changeOdeFeature(e,t){e.odeFeature=t},changeWhiteboardFeature(e,t){e.whiteboardFeature=t},changeTelephonyFeature(e,t){e.telephonyFeature=t},change3DPlayFeature(e,t){e.troisdplayFeature=t}},actions:{getCollaborationFeatures({dispatch:e,getters:t,commit:i}){e("getCollaborationFeature",{feature:"whiteboard",mutationMethod:"changeWhiteboardFeature",uwp:"app.swymfeature.activateWBCollab"}),e("getCollaborationFeature",{feature:"telephony",mutationMethod:"changeTelephonyFeature",uwp:"app.swymfeature.activatePhoneCall"}),e("getCollaborationFeature",{feature:"3dplay",mutationMethod:"change3DPlayFeature",uwp:"app.swymfeature.activate3DPlay"}),e("getCollaborationFeature",{feature:"ode",mutationMethod:"changeOdeFeature",uwp:"app.swymfeature.activateODECollab"}).then(()=>{t.odeFeature&&require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor"]).then(function(e){var s=e[0];s&&"function"==typeof s.isGranted&&s.isGranted({platformId:t.tenant}).then(()=>{r.Call("Editor activated and granted")}).catch(e=>{r.Call("Editor activated but not granted "+e),i("changeOdeFeature",!1)})})})},getCollaborationFeature({getters:e,dispatch:i,commit:s},{feature:o,mutationMethod:a,uwp:n}){if(UWA&&UWA.Utils&&UWA.Utils.getQueryString(document.URL,"activateCollab")||location&&location.href&&location.href.contains("activateCollab"))return s(a,!0);if("3dprint"==e.appName)return s(a,!1);const l=t.getApplicationConfiguration(n);return""===l||"true"===l||!0===l?s(a,!0):"false"===l?s(a,!1):void 0!==l?i("isUserInUserGroup",l).then(()=>{r.Call("Usergroup activation of feature "+o),s(a,!0)}).catch(e=>{r.Call("Usergroup deactivation of feature "+o+" : "+e),s(a,!1)}):void 0},isUserInUserGroup({getters:t},s){const o=t.tenant.toUpperCase(),a=t.myself.username;return new Promise((t,n)=>{e.getServiceUrl({serviceName:"3DSearch",platformId:o,onComplete:function(e){if(!e)return r.Call("Can't check usergroup without searchUrl"),n();i.authenticatedRequest(e+"/search",{method:"POST",type:"json",headers:{"Content-Type":"application/json"},data:JSON.stringify({with_synthesis_hierarchical:!1,with_synthesis:!1,with_synthesis_attribute:!1,source:["usersgroup"],query:'[ds6w:label]:"'+s+'"',select_predicate:["ds6w:hasMember","ds6w:responsible"],label:"bot",tenant:o}),onComplete:function(e){var i=[];return e&&e.results?(e.results.forEach(function(e){i=i.concat(e.attributes)}),i.filter(function(e){return"ds6w:hasMember"===e.name&&e.value===a||"ds6w:responsible"===e.name&&e.value===a}).length>0?t():n("not in usergroup")):n()},onFailure:function(t){return r.Call("AuthenticatedRequest on "+e+"/search failed : "+t),n("request to "+e+" failed")}})},onFailure:function(){return n("request to i3DXCompassPlatformServices failed")}})})}}}}),define("DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem",["text!DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem.html"],function(e){"use strict";return{props:[],data:()=>({srcObject:null}),methods:{onloadeddata(e){this.play()}},computed:{src(){var e=this.$store.getters.mediaSource;if(!e)return null;try{return window.URL.createObjectURL(e)}catch(e){return console.error("TelephonyItem unable to compute src from stream "+e),null}}},template:e}}),define("DS/InstantMessagingCall/components/VideoItem/VideoItem",["text!DS/InstantMessagingCall/components/VideoItem/VideoItem.html"],function(e){"use strict";return{props:["stream","user_id","isSpeakerView","isAudioMuted","isVideoMuted","track_id","muted","isSelfView"],data:()=>({srcObject:null}),computed:{video_track_id(){var e=this.stream&&this.stream.getVideoTracks();if(e&&e.length)return this.stream.getVideoTracks()[0].id},src(){try{try{return window.URL.createObjectURL(this.stream)}catch(e){return this.srcObject=this.stream,null}}catch(e){return console.error("VideoItem unable to compute src from stream "+e),null}}},methods:{toggleSpeaker(){if(!this.$store.getters.clickOnVideo)return!0;this.isSpeakerView?this.$store.dispatch("removeSpeaker",{user_id:this.user_id}):this.$store.dispatch("setAsSpeaker",{user_id:this.user_id,track_id:this.video_track_id})}},template:e}}),define("DS/InstantMessagingCall/components/CustomType/CustomType",["text!DS/InstantMessagingCall/components/CustomType/CustomType.html"],function(e){"use strict";return{props:["logins","isVideoMinimizeView"],computed:{users(){return this.logins&&0!=this.logins.length?this.logins.length>4?this.logins.slice(0,3):this.logins:[]},notDisplayed(){return this.logins&&0!=this.logins.length?this.logins.length<=4?0:this.logins.length-3:0}},template:e}}),define("DS/InstantMessagingCall/components/SpeakerName/SpeakerName",["text!DS/InstantMessagingCall/components/SpeakerName/SpeakerName.html"],function(e){"use strict";return{props:["user_id"],computed:{username(){return this.$store.getters.user(this.user_id).username}},template:e}}),define("DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti",["text!DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti.html"],function(e){"use strict";return{props:["featureData","masterUser","feature","active"],computed:{masterUsername(){return this.active?this.masterUser&&this.masterUser.username:null},IAmMaster(){return!!this.active&&(this.masterUser&&this.masterUser.login==this.$store.getters.myself.login)}},methods:{genId:function(e,t){return"confetti"+e+"-"+t},sendConfetti:function(e,t){this.IAmMaster&&!this.feature.featureData.confettis[this.genId(e,t)]&&this.$store.dispatch("send_confetti",{spanId:this.genId(e,t),feature:this.feature})}},template:e}}),define("DS/InstantMessagingCall/components/MemberItem/MemberItem",["text!DS/InstantMessagingCall/components/MemberItem/MemberItem.html"],function(e){"use strict";return{props:["user","hasJoined"],computed:{username(){return this.user.username},login(){return this.user.login},isAudioStreamer(){return this.user.stream_info.isAudioStreamer},isVideoStreamer(){return this.user.stream_info.isVideoStreamer},isAudioMuted(){return this.user.stream_info.isAudioStreamerMuted},isVideoMuted(){return this.user.stream_info.isVideoStreamerMuted},isScreenStreamer(){return this.user.stream_info.isScreenStreamer},isOnHold(){return this.user.stream_info.isOnHold},mustBeVisible(){return this.hasJoined?this.user.user_id==this.$store.getters.myself.user_id||this.$store.getters.accepters.indexOf(this.user.user_id)>-1:this.user.user_id!=this.$store.getters.myself.user_id&&!(this.$store.getters.accepters.indexOf(this.user.user_id)>-1)}},template:e}}),require.config({paths:{vuejs:window.dsDefaultWebappsBaseUrl+"/vuejs/2.6.10/vue.min",vuex:window.dsDefaultWebappsBaseUrl+"/vuex/3.1.1/vuex.min","vu-kit":window.dsDefaultWebappsBaseUrl+"/vuekit/vu-kit.umd.min"}}),define("DS/InstantMessagingCall/InstantMessagingCall",["vuejs","vu-kit","vuex","DS/RTVueUserPresenceAPI/RTVueUserPresenceAPI","DS/RTDialer/RTDialer","css!vuekit/vu-kit"],function(e,t,i,r,s){"use strict";return e.use(t),e.use(i),{init(e){require(["DS/InstantMessagingCall/main"],function(t){t.init(e)})}}}),define("DS/InstantMessagingCall/store/modules/tracker",["DS/RTProxyDriver/RTLogger","DS/Usage/TrackerAPI","DS/InstantMessagingWebRTC/js/model/RTCallingTracker"],function(e,t,i){"use strict";const r={NotFoundError:"localMediaError_NotFoundError",SecurityError:"localMediaError_SecurityError",AbortError:"localMediaError_AbortError",NotAllowedError:"localMediaError_NotAllowedError",NotReadableError:"localMediaError_NotReadableError",OverConstrainedError:"localMediaError_OverConstrainedError",TypeError:"localMediaError_TypeError",TrackStartError:"localMediaError_NotReadableError",PermissionDeniedError:"localMediaError_NotAllowedError",InvalidStateError:"localMediaError_NotReadableError",DevicesNotFoundError:"localMediaError_NotFoundError",ConstraintNotSatisfiedError:"localMediaError_OverConstrainedError",MediaDeviceFailedDueToShutdown:"localMediaError_NotReadableError",MediaDeviceKillSwitchOn:"localMediaError_NotReadableError",InternalError:"localMediaError_NotReadableError",NotSupportedError:"localMediaError_TypeError"};return{state:{callTracker:null,date_start:0},getters:{callTracker:e=>e.callTracker},mutations:{newTracker(e,{logins:t,caller:r,swymUrl:s,type:o,dmId:a}){e.callTracker&&e.callTracker.destroy(),e.callTracker=new i({caller:r,logins:t,swymBaseUrl:s,type:o,dmId:a})},destroyTracker(e){e.callTracker&&e.callTracker.destroy(),e.callTracker=null}},actions:{offlineStartCallTracking({dispatch:e,getters:t},{logins:i,login:r,dmId:s}){e("startTracking",{logins:i||r,dmId:s}),e("tracking",{action:"ended",login:t.myself.login,reason:"offline"}),e("stopTracking",{dontSendSwymReport:!0})},startTracking({commit:e,getters:t},{logins:i,type:r,dmId:s}){if(!i&&!t.accepted_room)return console.error("Can not start Call Analytics without callees");e("newTracker",{caller:t.myself.login,logins:i||t.accepted_room.calledUsers,swymUrl:t.swymUrl,type:r,dmId:s})},stopTracking({getters:e,commit:t},{dontSendSwymReport:i}){e.callTracker&&e.callTracker.endCall(i),t("destroyTracker")},tracking({getters:t},{action:i,login:s,user_id:o,reason:a,kind:n}){if(!t.callTracker)return!0;if(!s&&o)s=t.user(o).login;switch(i){case"ended":t.callTracker.logEnded(s,a);break;case"getLocalMediaFailed":t.callTracker.logEnded(s,r[a]||a);break;case"stream":t.callTracker.logStream(s);break;case"inviteSent":t.callTracker.logInviteSent();break;case"accepted":t.callTracker.logAccepted(s);break;default:e.error("unknown tracking action "+i)}},track_event({getters:i},{action:r,eventValue:s,dimensions:o,values:a}){if(!r)return e.Call("track_event called without action");if(i.isDevEnv)return e.Call("track_event "+r+" bypassed");const n=i.myself.user_id,l=i.accepted_room&&i.accepted_room.room_id||[],d=i.accepted_room&&i.accepted_room.calledUsers||[],c=i.accepters||[],u=i.refusers||[],m=i.sip?"telephony":"webRTC";var p={appID:"X3DIMSG_AP",eventCategory:"collabexperience",eventAction:r,eventLabel:"3DMessaging collab event "+r,eventValue:"number"==typeof s?s:null,persDim:{pd1:n,pd2:l},persVal:{pv1:d.length,pv2:c.length,pv3:u.length},callback:t=>{e.Call("Analytics event sent. "+(t||""))}};if(o){var h=Object.keys(p.persDim).length;const e="string"==typeof o?[o]:o;for(let t of e)"string"==typeof t&&(7===h&&++h,p.persDim["pd"+ ++h]=t.toLowerCase())}if(p.persDim.pd8=m,a){var f=Object.keys(p.persVal).length;const e="number"==typeof a?[a]:a;for(let t of e)"number"==typeof t&&(p.persVal["pv"+ ++f]=t)}try{e.Call("Analytics event : "+JSON.stringify(p)),t.trackPageEvent(p)}catch(t){e.error("Analytics event request failed : "+t)}}}}}),define("DS/InstantMessagingCall/components/UserItem/UserItem",["text!DS/InstantMessagingCall/components/UserItem/UserItem.html","DS/InstantMessagingCall/components/VideoItem/VideoItem","DS/InstantMessagingCall/components/TelephonyItem/TelephonyItem"],function(e,t,i){"use strict";return{components:{"im-call-video-item":t,"im-tel-video-item":i},props:["user_id","track_id","isSpeakerView","room","minimized"],data:()=>({streams:[],isScreen:!1,isAudio:!1}),computed:{isSip(){return this.$store.getters.sip},asMediasource(){return!!this.$store.getters.mediasource},user(){return this.$store.getters.user(this.user_id)},isSpeaker(){return this.$store.getters.speaker_id==this.user_id},isNotLarge(){return this.$store.getters.isAvatarNotLarge},isVideo(){var e=this.user.stream_info.isVideoStreamer,t=this.user.stream_info.isAudioStreamer,i=this.user.stream_info.isScreenStreamer,r=(e||t||i)&&this.$store.getters.streams(this.user_id,this.track_id);if(e&&i&&!this.track_id&&this.isSpeaker){var s=(o=r[0]).getVideoTracks();if(s&&s.length&&1!=s.length){var o=new MediaStream,a=r[0].getAudioTracks(),n=a&&a[0];n&&o.addTrack(n);for(let e of s)if("text"!==e.contentHint){o.addTrack(e);break}r=[o]}else r=[o]}else(e||i)&&this.track_id&&this.room&&(r[0].oninactive=(()=>{this.$store.dispatch("stopTrack",{kind:"screen",room_id:this.room.room_id})}));return this.streams=r,this.isScreen=i,this.isAudio=t,e},isVideoMuted(){return this.user.stream_info.isVideoStreamerMuted},isAudioMuted(){return this.user.stream_info.isAudioStreamerMuted},isOnHold(){return this.user.stream_info.isOnHold},hasCollabExperience(){return this.$store.getters.hasFeature},showVideo(){return(this.isVideo&&!this.isVideoMuted||this.isScreen)&&(!!this.track_id||!this.track_id&&(!this.isSpeaker||this.isSpeaker&&this.isScreen&&this.isVideo&&!this.isVideoMuted))}},methods:{unlargeAvatar(){var e=this.$refs.userItemContainer,t=e&&e.offsetHeight<240;this.$store.commit("avatarNotLarge",t)}},updated(){this.unlargeAvatar()},created(){window.addEventListener("resize",this.unlargeAvatar)},destroyed(){window.removeEventListener("resize",this.unlargeAvatar)},template:e}}),define("DS/InstantMessagingCall/components/SelfView/SelfView",["text!DS/InstantMessagingCall/components/SelfView/SelfView.html","DS/InstantMessagingCall/components/VideoItem/VideoItem"],function(e,t){"use strict";return{props:["showSelfView","isInUserList"],components:{"im-call-video-item":t},data:()=>({streams:null,isSpeaker:!1}),computed:{isVideo(){var e=this.$store.getters.local_stream_info("video"),t=e&&"muted"!=e;if(this.streams)return t;var i=this.$store.getters.isLocalSpeaker,r=(t||i!=this.isSpeaker)&&this.$store.getters.local_track_of_kind("video");if(r){var s=new MediaStream;s.addTrack(r),this.streams=[s]}return this.isSpeaker=i,t},isLocalVideoMuted(){return"muted"==this.$store.getters.local_stream_info("video")},isLocalAudioMuted(){return"muted"==this.$store.getters.local_stream_info("audio")},user_id(){return this.$store.getters.myself.user_id},username(){return this.$store.getters.myself.username}},methods:{minimize(){this.$store.commit("hideSelfView")}},destroyed(){this.streams=null},deactivated(){this.streams=null},mounted(){var e=this,t=document.getElementById("im-call-lightbox");new MutationObserver(function(){if("none"==t.style.display&&!e.$store.getters.isAccepted){if(!e.streams)return;for(let t=0;t<e.streams.length;t++)e.streams[t].getTracks().forEach(e=>e.stop());e.streams=null}}).observe(t,{attributes:!0,childList:!0})},template:e}}),define("DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize",["text!DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize.html","DS/InstantMessagingCall/components/CustomType/CustomType"],function(e,t){"use strict";return{props:["logins"],components:{"im-call-custom-type":t},template:e}}),define("DS/InstantMessagingCall/components/ActionBar/ActionBar",["text!DS/InstantMessagingCall/components/ActionBar/ActionBar.html","DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem","DS/WAFData/WAFData","DS/UIKIT/SuperModal","DS/InstantMessagingCall/assets/CollabOfficeTemplates"],function(e,t,i,r,s){"use strict";return{components:{"im-call-bar-item":t},props:["room","showSelfView","showUserList","hasFeature","hasSpeaker","isWhiteboard","isODE","isTelephonySupported","isConfetti","is3DPlay"],data(){return{document:document,durationInterval:null,duration:0,ODEitems:[{text:this.$store.getters.nls("createDocument"),fonticon:"doc-text",handler:e=>this.activeODE("docx")},{text:this.$store.getters.nls("createPresentation"),fonticon:"presentation-slide-layout",handler:e=>this.activeODE("pptx")},{text:this.$store.getters.nls("createSpreadsheet"),fonticon:"table",handler:e=>this.activeODE("xlsx")}],window:window}},computed:{isConfettiSupported(){return!this.$store.getters.hideConvFeatures&&this.$store.state.call.confettiAvailable},isODESupported(){return!this.$store.getters.hideConvFeatures&&this.$store.getters.isAccepted&&this.$store.getters.odeFeature},isWhiteboardSupported(){return!this.$store.getters.hideConvFeatures&&this.$store.getters.whiteboardFeature},is3DPlaySupported(){return!this.$store.getters.hideConvFeatures&&this.$store.getters.troisdplayFeature},isSpeaker(){return!!this.$store.getters.speaker_id},isLocalVideo(){return!!this.$store.getters.local_stream_info("video")},isLocalVideoMuted(){return"muted"==this.$store.getters.local_stream_info("video")},isLocalAudio(){return!!this.$store.getters.local_stream_info("audio")},isLocalAudioMuted(){return"muted"==this.$store.getters.local_stream_info("audio")},isLocalScreen(){return!!this.$store.getters.local_stream_info("screen")},isLocalScreenMuted(){return"muted"==this.$store.getters.local_stream_info("screen")},isSip(){return!!this.$store.getters.sip},date_start(){var e=this.$store.getters.date_start;return e?this.durationInterval=setInterval(()=>{this.duration=Date.now()-e},1e3):this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null,this.duration=0),e},durationString(){var e=Math.floor(this.duration/1e3),t=Math.floor(e/3600),i=(e-=3600*t)%60;i<10&&(i="0"+i);var r=Math.floor(e/60);return r<10&&(r="0"+r),(t?t+":":"")+r+":"+i},isLocalScreenDisplayed(){return this.isLocalScreen&&!this.isLocalScreenMuted},isScreenDisplayed(){return this.hasSpeaker&&this.runningScreenSharingFeature&&"screen"===this.$store.getters.speaker_kind},screenSharingDisabled(){return!this.$store.getters.screenSharingAvailable||this.hasFeature},collabDisabled(){return this.isSpeaker||this.hasFeature||this.isLocalScreenDisplayed},isDialerON(){return!!this.$store.getters.showDialer},runningConfettiFeature(){return this.$store.getters.getFeatureOfKind("confetti")},running3DPlayFeature(){return this.$store.getters.getFeatureOfKind("3dplay")},runningWhiteboardFeature(){return this.$store.getters.getFeatureOfKind("whiteboard")},runningODEFeature(){return this.$store.getters.getFeatureOfKind("ode")},runningScreenSharingFeature(){return"screen"===this.$store.getters.call_speaker_kind},isOnHold(){return this.room&&this.$store.getters.is_onhold_room(this.room.room_id)},ODESetMode(){return this.isODESupported&&(!this.collabDisabled||this.isODE&&!this.isOnHold||!this.isODE&&!!this.runningODEFeature&&!this.isOnHold)},ODEAvailableMode(){return!this.isODE&&!this.runningODEFeature&&!this.isOnHold},ODEStopMode(){return this.isODE&&!this.isOnHold},ODERunningMode(){return!this.isODE&&!!this.runningODEFeature&&!this.isOnHold},ODEDisableMode(){return!this.isODE&&!this.runningODEFeature&&this.collabDisabled}},methods:{endCall(){this.isLocalScreenDisplayed&&this.stopTrack("screen"),this.track_event(["handset",this.$store.getters.isAccepted],0),this.$store.dispatch("endCall",this.room)},acceptCall(){this.track_event(["handset"],1),this.$store.dispatch("acceptCall",this.room)},holdCall(){this.track_event(["track","holdCall"],1),this.$store.dispatch("holdCall",this.room.room_id)},resumeCall(){this.track_event(["track","resumeCall"],0),this.$store.dispatch("resumeCall",this.room.room_id)},activeTrack(e){this.$store.dispatch("activeTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],1)},muteTrack(e){this.$store.dispatch("muteTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0)},stopTrack(e){this.$store.dispatch("stopTrack",{kind:e,room_id:this.room.room_id}),this.track_event(["track",e],0)},volumeOFF(e){this.$store.dispatch("volumeOFF",e),this.track_event(["track","volume"],e?0:1)},displayDialer(){this.$store.commit("showDialer")},hideDialer(){this.$store.commit("hideDialer")},stopFeatures(e){this.$store.dispatch("stopFeatures",{room_id:this.room.room_id}),this.track_event(["feature",e],0)},activeODE(e){if(this.runningODEFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningODEFeature});if(e){var t=this;new r({closable:!0,renderTo:this.document.body}).prompt({title:this.$store.getters.nls("new"+s.extensionsFormat[e].name),message:this.$store.getters.nls("enterAFileName"),required:!0,placeholder:this.$store.getters.nls("fileName"),callback:function(i){i?t.onConfirm(i,e):console.log("Prompt dismissed")}})}},onConfirm(e,t){if(e&&t){var i=e,r=this.$store.getters.accepted_room&&this.$store.getters.accepted_room.options&&this.$store.getters.accepted_room.options.dmId,s=e+"."+t,o=this;this.addmedia(r,i,s,t,function(r,s){r&&s?(console.log("Add OK : mediaId: "+r+", title: "+e),o.$store.dispatch("newODE",{room_id:o.room.room_id,title:i,ext:t,media_id:r,url:s})):console.log("Error no mediaId or url define")}),this.track_event(["feature","ode",t],1)}},addmedia(e,t,r,o,a){if((n=this.$store.getters.swymUrl)&&e&&t&&r&&o&&a){var n=this.$store.getters.swymUrl,l=this.$store.getters.tenant,d=this;require("DS/TopFrame/TopFrame")._loadModules(["DS/OfficeDocumentEditorClient/Editor"]).then(function(c){var u=c[0];u&&u.getDocumentTemplatesURL({platformId:l}).then(l=>{if(l&&l[o]){var c=l[o];if(!c)return console.log("Failed to get ODE template"),a();i.request(c,{responseType:"blob",onComplete:function(l){if(!l)return console.log("Failed to get ODE template"),a();!function(e,t,i){if(s.extensionsFormat[e]){var r=new Blob([t],{type:s.extensionsFormat[e].format});r&&i(r)}else console.error("Error loading CollabOfficeTemplates of extension "+e)}(o,l,function(s){var o=new FormData;o.append("is_illustration",!1),o.append("community_id",e),o.append("title",t),o.append("media_type","document"),o.append("published",!0),o.append("fileName",r),o.append("userFile",s,r),d.getCSRFswym(function(e){e&&i.authenticatedRequest(n+"/api/media/addmedia",{method:"POST",headers:{"X-DS-SWYM-CSRFTOKEN":e},data:o,onComplete:function(e){if(e)try{var t=(e=JSON.parse(e)).result.id_media;a(t,c)}catch(e){console.log("Failed to add media"),a()}},onFailure:function(e){console.log("Failed to add media"),a()}})})})},onFailure:function(e){console.log("Failed to get template"),a()}})}else console.log("Failed to get template")})})}},getMedia(e,t,r){var s=this.$store.getters.swymUrl,o={params:{id_media:e,detailedInfos:!0}};i.authenticatedRequest(s+"/api/media/getmedia",{method:"POST",type:"json",headers:{"Content-Type":"application/json","X-DS-SWYM-CSRFTOKEN":t},data:JSON.stringify(o),onComplete:function(e){e&&e.result&&e.result.play&&e.result.play.download_original_url&&e.result.play.download_original_url.transient_url_as_attachment||r();var t=e.result.play.download_original_url.transient_url_as_attachment;r(t)},onFailure:function(e){console.log("Failed to get media"),r()}})},getCSRFswym(e){var t=this.$store.getters.swymUrl;i.authenticatedRequest(t+"/api/index/tk",{method:"GET",type:"json",onComplete:function(t){t||e();try{var i=t.result.ServerToken;e(i)}catch(t){console.log("Failed to resolve CSRF Token "+t),e()}},onFailure:function(t){console.log("Failed to get CSRF Token "+t),e()}})},joinODE(){if(this.runningODEFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningODEFeature});console.error("Can not join unexisting ODE")},activeWhiteboard(){if(this.runningWhiteboardFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningWhiteboardFeature});this.$store.dispatch("newWhiteboard",{room_id:this.room.room_id}),this.track_event(["feature","whiteboard"],1)},activeConfetti(){if(this.runningConfettiFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.runningConfettiFeature});this.$store.dispatch("newConfetti",{room_id:this.room.room_id})},active3DPlay(){if(this.running3DPlayFeature)return this.$store.dispatch("switchToFeature",{featureInfo:this.running3DPlayFeature});this.$store.dispatch("new3DPlay",{room_id:this.room.room_id})},track_event(e,t){this.$store.dispatch("track_event",{action:"actionBar",dimensions:e,eventValue:t})},removeSpeaker(){this.$store.dispatch("removeSpeaker",{user_id:this.$store.getters.speaker_id})},switchToCallSpeaker(){this.$store.dispatch("switchToCallSpeaker")}},template:e}}),define("DS/InstantMessagingCall/store/modules/feature",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/SwymUICore/script/feature/community/media/model/media-model","vuejs"],function(e,t,i,r){"use strict";return{state:Object.assign({},{currentFeatureId:null,features:{},isODEEditionSupported:!0}),mutations:{resetFeatureState(e){Object.assign(e,{currentFeatureId:null,features:{},isODEEditionSupported:!0})},setMaster(e,{featureId:t,user_id:i}){e.features[t]&&r.set(e.features[t],"master",i)},featureMembers(e,{featureId:t,featureMembers:i}){e.features[t]&&r.set(e.features[t],"members",i)},featureEnded(e,{featureId:t}){},feature(e,{featureKind:t,room_id:i,featureId:s,featureData:o,master:a}){e.features[s]||r.set(e.features,s,{featureKind:t,featureId:s,featureData:o,room_id:i,master:a})},currentFeatureId(e,t){e.currentFeatureId=t},confetti:(e,{spanId:t,user_id:i,featureId:s})=>{r.set(e.features[s].featureData.confettis,t,i)},coreview_3DPlay_data:(e,{actions:t,featureId:i})=>{if(!e.features[i])return console.error("Received 3DPlay coreview data but the feature is not loaded "+i);r.set(e.features[i].featureData,"actions",t)},isODEEditionSupported(e,t){e.isODEEditionSupported=t}},getters:{hasFeature:e=>!!e.currentFeatureId,feature:e=>t=>e.features[t],currentFeatureId:e=>e.currentFeatureId,currentFeature:(e,t)=>!!t.currentFeatureId&&t.feature(t.currentFeatureId),isODE:e=>e=>"ode"==e.featureKind,isWhiteboard:e=>e=>"whiteboard"==e.featureKind,isConfetti:e=>e=>"confetti"==e.featureKind,is3DPlay:e=>e=>"3dplay"==e.featureKind,isMaster:(e,t)=>e=>e.master==t.myself.user_id,getFeatureOfKind:(e,t)=>i=>{for(let r in e.features){let s=e.features[r];if(s.featureKind==i&&t.is_accepted_room(s.room_id))return s}return null},isODEEditionSupported:e=>e.isODEEditionSupported},actions:{activateFeature({commit:t,dispatch:i,getters:r},s){if(!s.featureKind||!s.featureId||!s.featureData)return e.error("Can not init feature "+JSON.stringify(s));s.master=r.myself.user_id,t("feature",s),i("switchToFeature",{room_id:s.room_id,featureInfo:s}),i("sendCurrentFeature")},stopFeatures({dispatch:e},{room_id:t}){e("switchToFeature",{room_id:t})},newODE({dispatch:e,getters:t},{room_id:i,title:r,ext:s,media_id:o,url:a}){e("activateFeature",{room_id:i,featureKind:"ode",featureId:Date.now(),featureData:{mediaId:o,title:r,ext:s,url:a}})},newConfetti({dispatch:e},{room_id:t}){e("activateFeature",{room_id:t,featureKind:"confetti",featureId:Date.now(),featureData:{confettis:{}}})},new3DPlay({dispatch:e,getters:t},{room_id:i}){e("activateFeature",{room_id:i,featureKind:"3dplay",featureId:Date.now(),featureData:{fileName:"RadialEngine.3dxml",mime:"3dxml",path:t.assets_url+"RadialEngine.3dxml",actions:{}}})},newWhiteboard({dispatch:t,getters:r},{room_id:s}){var o=r.accepted_room&&r.accepted_room.options&&r.accepted_room.options.dmId;if(o){var a=new i;a.set("play",{}),a.set("community",{community_type:"dm",id:o}),t("activateFeature",{room_id:s,featureKind:"whiteboard",featureId:Date.now(),featureData:{model:a,whiteboard:!0,title:"New whiteboard",coreview:{action:"initCoreview",room_id:s,noCall:!0,collabExperienceOrigin:!0,logins:r.called_users_logins,threadType:"dm",threadId:o,data:{communityId:o,logins:r.called_users_logins,mediaId:"0000",room_id:s}}}})}else e.error("New whiteboard dmId is undefined")},sendCurrentFeature({dispatch:e,getters:t}){var i=t.currentFeature;i&&e("sendFeature",i)},switchToFeature({getters:e,commit:i},{featureInfo:r,room_id:s}){i("currentFeatureId",r&&r.featureId);var o=s||r&&r.room_id;t.callEventFromView({action:"switchToFeature",room_id:o,user_id:e.myself.user_id,featureInfo:r,featureId:r&&r.featureId})},sendFeature({getters:i},r){r?t.callEventFromView({action:"feature",room_id:r.room_id,user_id:i.myself.user_id,featureInfo:r}):e.error("no featureInfo in sendFeature")},setMaster({getters:e,commit:i},r){i("setMaster",{user_id:user_id,featureId:r.featureId}),t.callEventFromView({action:"masterChanged",room_id:r.room_id,user_id:e.myself.user_id,featureInfo:r,featureId:r.featureId})},received_feature({commit:e,getters:t,dispatch:i},{user_id:r,featureInfo:s,room_id:o,type:a}){s.room_id=o,s.master=r,s.featureData.coreview&&(s.featureData.coreview.action="acceptCoreview",s.featureData.coreview.room_id=o),s.featureData.coreviewData,e("feature",s),!t.hasFeature&&t.is_accepted_room(o)&&i("switchToFeature",{featureInfo:s,room_id:o})},invited_feature({dispatch:e},{type:t,featureData:i,room_id:r}){"3dplay"==t&&(i.fileName="Collab3DPlay",i.mime=i.fileExt,i.path=i.fileUrl,i.actions={}),e("activateFeature",{featureData:i,featureId:Date.now(),featureKind:"ode"==t||"whiteboard"==t||"3dplay"==t?t:null,room_id:r})},masterChanged({commit:e},{user_id:t,featureId:i}){e("setMaster",{user_id:t,featureId:i})},featureMembers({commit:e},{user_id:t,featureId:i,featureMembers:r}){e("featureMembers",{user_id:t,featureId:i,featureMembers:r})},featureEnded({commit:e},{user_id:t,featureId:i}){e("featureMembers",{user_id:t,featureId:i,featureMembers:null}),e("featureEnded",{user_id:t,featureId:i})},received_confetti({commit:e},{featureData:t,featureId:i,user_id:r,room_id:s}){e("confetti",{spanId:t.spanId,user_id:r,featureId:i})},send_confetti({getters:e,commit:i},{spanId:r,feature:s}){i("confetti",{spanId:r,user_id:e.myself.user_id,featureId:s.featureId}),t.callEventFromView({action:"confetti",room_id:s.room_id,user_id:e.myself.user_id,featureId:s.featureId,featureData:{spanId:r}}),t.callEventFromView({action:"nextMaster",room_id:s.room_id,user_id:e.myself.user_id,featureId:s.featureId})},received_3DPlay_data({getters:e,commit:t},{room_id:i,actions:r,featureData:s,featureId:o}){t("coreview_3DPlay_data",{featureId:o,actions:r})},send_3DPlay_data({getters:e,commit:i},{room_id:r,actions:s,featureData:o,featureId:a}){t.callEventFromView({action:"3DPlayData",room_id:r,user_id:e.myself.user_id,featureId:a,featureData:o,actions:s})},send_isODEEditionNotSupported({commit:e,getters:t,dispatch:i},r){e("isODEEditionSupported",r),t.isMobile||r||i("alert_ODEEditionNotSupported")}}}}),define("DS/InstantMessagingCall/store/modules/users",["DS/RTProxyDriver/RTLogger","vuejs","DS/InstantMessagingCall/api/senders"],function(e,t,i){"use strict";return{state:{users:{},accepters:[],refusers:[],video_streamers:[],screen_streamers:[],audio_streamers:[],speaker:null,speaker_track_id:null,speaker_kind:null,call_speaker:null,call_speaker_kind:null,call_speaker_track_id:null,isLocalSpeaker:!1,media_id:null,local_audio:!1,local_video:!1,local_screen:!1,avatarNotLarge:!1,showUserList:!0},getters:{isAvatarNotLarge:e=>e.avatarNotLarge,isTheSpeaker:e=>t=>e.call_speaker==t,accepters:e=>e.accepters,refusers:e=>e.refusers,accepters_name:e=>{var t=[];for(let i of e.accepters)t.push(e.users[i].username);return t},accepters_except_myself:(e,t)=>e.accepters.filter(e=>e!==t.myself.user_id),user:e=>t=>e.users[t],speaker_id:e=>e.speaker,speaker_track_id:e=>e.speaker_track_id,speaker_kind:e=>e.speaker_kind,call_speaker_id:e=>e.call_speaker,call_speaker_kind:e=>e.call_speaker_kind,call_speaker_track_id:e=>e.call_speaker_track_id,local_stream_info:e=>t=>e["local_"+t],called_users:(e,t)=>{var i=[];if(!t.accepted_room||!t.accepted_room.calledUsers||!t.accepted_room.calledUsers.length)return i;for(let e of t.accepted_room.calledUsers)i.push(t.user(e.user_id));return i},called_users_logins:(e,t)=>{var i=[];return t.called_users.forEach(e=>e&&e.login&&i.push(e.login)),i},isLocalSpeaker:e=>e.isLocalSpeaker,login:e=>t=>e.users[t]&&e.users[t].login,logins_except_myself:(e,t)=>{var i=[];for(let e of t.called_users)e.user_id!=t.myself.user_id&&i.push(e.login);return i},showUserList:e=>e.showUserList,hasHoldCall:e=>t=>e.users[t]&&e.users[t].stream_info.isOnHold},mutations:{avatarNotLarge(e,t){e.avatarNotLarge=t},resetUsersState(e){Object.assign(e,{users:{},accepters:[],refusers:[],video_streamers:[],screen_streamers:[],audio_streamers:[],speaker:null,speaker_track_id:null,speaker_kind:null,call_speaker:null,call_speaker_kind:null,call_speaker_track_id:null,isLocalSpeaker:!1,media_id:null,local_audio:!1,local_video:!1,local_screen:!1,avatarNotLarge:!1,showUserList:!0})},isLocalSpeaker(e,t){e.isLocalSpeaker=t},user(e,i){e.users[i.user_id]||(e.users[i.user_id]=i,e.users[i.user_id].stream_info=t.observable({isAudioStreamer:!1,isAudioStreamerMuted:!1,isVideoStreamer:!1,isVideoStreamerMuted:!1,isScreenStreamer:!1,isOnHold:!1,track_id_screen:null,track_id_audio:null,track_id_video:null}))},accepter(e,t){var i=e.refusers.indexOf(t);-1!=i&&e.refusers.splice(i,1),-1==e.accepters.indexOf(t)&&e.accepters.push(t)},refuser(e,t){var i=e.accepters.indexOf(t);-1!=i&&e.accepters.splice(i,1),-1==e.refusers.indexOf(t)&&e.refusers.push(t)},received_track_video(e,{user_id:t,track_id:i}){e.users[t].stream_info.isVideoStreamer=!1,e.users[t].stream_info.isVideoStreamer=!0,e.users[t].stream_info.track_id_video=i,-1==e.video_streamers.indexOf(t)&&e.video_streamers.push(t)},received_track_screen(e,{user_id:t}){e.users[t].stream_info.isScreenStreamer=!0,-1==e.screen_streamers.indexOf(t)&&e.screen_streamers.push(t)},remove_track_screen(e,{user_id:t}){e.users[t].stream_info.isScreenStreamer=!1;var i=e.screen_streamers.indexOf(t);-1!=i&&e.screen_streamers.splice(i,1)},received_track_audio(e,{user_id:t,track_id:i}){e.users[t].stream_info.isAudioStreamer=!1,e.users[t].stream_info.isAudioStreamer=!0,e.users[t].stream_info.track_id_audio=i,-1==e.audio_streamers.indexOf(t)&&e.audio_streamers.push(t)},remove_track_audio(e,{user_id:t}){e.users[t].stream_info.isAudioStreamer=!1;var i=e.audio_streamers.indexOf(t);-1!=i&&e.audio_streamers.splice(i,1)},remove_track_video(e,{user_id:t}){e.users[t].stream_info.isVideoStreamer=!1;var i=e.video_streamers.indexOf(t);-1!=i&&e.video_streamers.splice(i,1)},local_stream_info(e,{kind:t,muted:i,loaded:r,user_id:s}){e["local_"+t]=i?"muted":r,"audio"==t?e.users[s].stream_info.isAudioStreamerMuted=!1!==i:"video"==t&&(e.users[s].stream_info.isVideoStreamerMuted=!1!==i)},stream_muted(e,{kind:t,user_id:i,muted:r}){"audio"==t?e.users[i].stream_info.isAudioStreamerMuted=r:"video"==t&&(e.users[i].stream_info.isVideoStreamerMuted=r)},call_hold(e,{user_id:t,onHold:i}){e.users[t].stream_info.isOnHold=!!i},call_speaker(e,{user_id:t,speaker_track_id:i,kind:r}){e.call_speaker=t,e.call_speaker_kind=r,e.call_speaker_track_id=i},speaker(e,{user_id:t,speaker_track_id:i,kind:r}){e.speaker_track_id=i,e.speaker=t,e.speaker_kind=r},track_stopped(t,{user_id:i,track_id:r,kind:s}){switch(s){case"screen":t.users[i].stream_info.isScreenStreamer=!1,t.showUserList=!0,t.speaker==i&&(t.speaker=null,t.speaker_track_id=null,t.speaker_kind=null),t.call_speaker==i&&(t.call_speaker=null,t.call_speaker_id=null,t.call_speaker_kind=null);break;default:e.Call("stop track "+s+" but feature not implemented")}},showUserList:(e,t)=>{e.showUserList=t}},actions:{setPresence({dispatch:e},t){i.presence(t)},setAsSpeaker({commit:e,getters:t},{user_id:i,track_id:r,firstSpeaker:s,kind:o}){e("speaker",{user_id:i,speaker_track_id:r,kind:o})},switchToCallSpeaker({dispatch:e,getters:t}){e("setAsSpeaker",{user_id:t.call_speaker_id,track_id:t.call_speaker_track_id,kind:t.call_speaker_kind})},removeSpeaker({commit:e,getters:t},{user_id:i}){e("speaker",{user_id:null,speaker_track_id:null}),i==t.myself.user_id&&e("isLocalSpeaker",!1)}}}}),define("DS/InstantMessagingCall/components/UserCircleList/UserCircleList",["text!DS/InstantMessagingCall/components/UserCircleList/UserCircleList.html","DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize"],function(e,t){"use strict";return{components:{"im-call-video-minimize":t},props:["users","myLogin","showSelfView"],computed:{},methods:{displaySelfView(){this.$store.commit("showSelfView")}},template:e}}),define("DS/InstantMessagingCall/components/UserVideoList/UserVideoList",["text!DS/InstantMessagingCall/components/UserVideoList/UserVideoList.html","DS/InstantMessagingCall/components/UserItem/UserItem"],function(e,t){"use strict";return{data:()=>({startIndex:0}),components:{"im-call-user-item":t},props:["users","videoDisplayNumber"],computed:{maxVideoNumber(){return this.videoDisplayNumber||6},endIndex(){return this.startIndex+this.maxVideoNumber},isScrollable(){return this.users.length>this.maxVideoNumber},isScrollableUp(){return this.isScrollable&&this.startIndex>0},isScrollableDown(){return this.isScrollable&&this.endIndex<this.users.length}},methods:{scrollUp(){this.startIndex=this.startIndex-1>0?this.startIndex-1:0},scrollDown(){this.startIndex=this.endIndex<this.users.length?this.startIndex+1:this.startIndex},isVisible(e){return this.startIndex<=e&&e<this.endIndex}},template:e}}),define("DS/InstantMessagingCall/components/UserList/UserList",["text!DS/InstantMessagingCall/components/UserList/UserList.html","DS/InstantMessagingCall/components/UserItem/UserItem","DS/InstantMessagingCall/components/SelfView/SelfView","DS/UIKIT/Scroller"],function(e,t,i,r){"use strict";return{data:()=>({startIndex:0}),components:{"im-call-user-item":t,"im-call-self":i},props:["hasSpeaker","showSelfView","minimized"],computed:{users(){return this.$store.getters.accepters},isScrollable(){return this.users&&this.users.length>6},isScrollableUp(){return this.isScrollable&&this.startIndex>0},isScrollableDown(){return this.isScrollable&&this.startIndex<this.users.length-6},isLightboxMinimized(){return this.sizeWH(),this.minimized}},methods:{scrollUp(){this.startIndex=0>this.startIndex-6?0:this.startIndex-6},scrollDown(){this.startIndex=this.users.length-6<this.startIndex+6?this.users.length-6:this.startIndex+6},canBeShown(e){return this.startIndex<=e&&e<this.startIndex+6},minimize(){this.$store.commit("showUserList",!1)},sizeWH(){var e,t,i,r,s,o,a=this.$refs["useritems-container"],n=a.offsetHeight,l=a.offsetWidth,d=a.childElementCount;if(this.hasSpeaker)t=1,r=l,o=i=(n-88)/(e=6),s=i*(16/9);else{switch(!0){case 1==d:t=1,e=1;break;case 2==d:t=2,e=1;break;case d<4||4==d:t=2,e=2;break;case d<6||6==d:t=3,e=2;break;case d<9||9==d:e=3,t=3;break;case d<12||12==d:t=4,e=3;break;case d<16||16==d:e=4,t=4}o=(s=(r=l/t)/(16/9)>(i=n/e)?i*(16/9):r)/(16/9)}for(var c=0;c<a.children.length;c++)a.children[c].style.height=o-5+"px",a.children[c].style.width=s-5+"px"}},updated(){this.sizeWH()},created(){window.addEventListener("resize",this.sizeWH)},destroyed(){window.removeEventListener("resize",this.sizeWH)},template:e}}),define("DS/InstantMessagingCall/components/MemberList/MemberList",["text!DS/InstantMessagingCall/components/MemberList/MemberList.html","DS/InstantMessagingCall/components/MemberItem/MemberItem"],function(e,t){"use strict";return{props:["members"],components:{"im-call-member-item":t},computed:{},methods:{},template:e}}),define("DS/InstantMessagingCall/components/PanelUsers/PanelUsers",["text!DS/InstantMessagingCall/components/PanelUsers/PanelUsers.html","DS/InstantMessagingCall/components/UserVideoList/UserVideoList","DS/InstantMessagingCall/components/UserCircleList/UserCircleList","DS/InstantMessagingCall/components/SelfView/SelfView"],function(e,t,i,r){"use strict";return{components:{"im-call-user-video-list":t,"im-call-user-circle-list":i,"im-call-self":r},props:["showSelfView","myLogin"],computed:{users(){return this.$store.getters.accepters.map(e=>this.$store.getters.user(e))},videoUserList(){return this.$store.getters.accepters.map(e=>this.$store.getters.user(e)).filter(e=>e.stream_info.isVideoStreamer&&!e.stream_info.isVideoStreamerMuted)},audioUserList(){return this.$store.getters.accepters.map(e=>this.$store.getters.user(e)).filter(e=>!e.stream_info.isVideoStreamer||e.stream_info.isVideoStreamerMuted)}},methods:{minimize(){this.$store.commit("showUserList",!1)}},template:e}}),define("DS/InstantMessagingCall/store/modules/p2p",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders"],function(e,t){"use strict";var i=window.navigator.userAgent,r=!!i.match(/iPad/i)||!!i.match(/iPhone/i)||!!i.match(/iPadPro/i),s=!!i.match(/WebKit/i),o=r&&s&&!i.match(/CriOS/i);window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;const a={googTypingNoiseDetection:!1,googEchoCancellation:!0,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},n={cursor:!0,logicalSurface:!0},l={mandatory:{OfferToReceiveAudio:!0,offerToReceiveAudio:!0,OfferToReceiveVideo:!0,offerToReceiveVideo:!0}},d=({room_id:t,user_id:i})=>t&&i&&"string"==typeof t&&"string"==typeof i?t+i:e.error("p2p protocol error p2pKey "+JSON.stringify(arguments[0])),c=t=>(t&&t.getVideoTracks().forEach(t=>{t.contentHint="text","contentHint"in t?"text"!==t.contentHint&&console.error("Invalid video track contentHint: text"):e.error("MediaStreamTrack contentHint attribute not supported")}),t),u=e=>"contentHint"in e&&"text"==e.contentHint,m=(e,t)=>!!e&&!!(e.kind==t&&("audio"==t||"video"==t&&!u(e))||"screen"==t&&u(e)),p=e=>{var t=e.getTracks(),i={isAudio:!1,isVideo:!1,isScreen:!1};for(let e of t)"audio"==e.kind?(i.isAudio=!0,i.isAudioMuted=!e.enabled,i.track_id_audio=e.id):"video"==e.kind&&(u(e)||i.isVideo?(i.isScreen=!0,i.isScreenMuted=!e.enabled,i.track_id_screen=e.id):(i.isVideo=!0,i.isVideoMuted=!e.enabled,i.track_id_video=e.id));return i},h=(e,t)=>{var i=e.getSenders();for(let e of i)if(e.track&&e.track.id==t)return!0;return!1},f=function(t,i){var r=t.getParameters();r.encodings||(r.encodings=[{}]),r.encodings[0]||(r.encodings[0]={}),r.encodings[0].maxBitrate=1e3*i,t.setParameters(r).then(()=>{e.Call("setBandwidth success to "+i+" kbps")},t=>{e.Call("setBandwidth failed "+t)})};var g=[];return{state:{peer_connections:{},local_stream:null,mutex_local_media:!1,remote_streams:{},video_activated:!1,audio_activated:!1,screen_activated:!1,bandwidth:500,constraintsVideo:{},constraintsAudio:{},forceTURN:!1},getters:{pc:e=>t=>e.peer_connections[d(t)],isTrackId:e=>(t,i)=>{var r=e.remote_streams[t];return!!r&&!!r.getTrackById(i)},streams:(e,t)=>(i,r,s)=>{if((s=s||e.remote_streams[i])||i!=t.myself.user_id||(s=e.local_stream),!s&&!t.sip)return console.error("can't find stream of user "+i);if(r){var o=new MediaStream,a=s.getTrackById(r);if(a)o.addTrack(a);else{var n=s.getVideoTracks(),l=void 0;n.forEach(e=>{e.contentHint&&"text"==e.contentHint&&(l=e)}),l?n&&n.length&&o.addTrack(l):n&&n.length&&o.addTrack(n[n.length-1])}return[o]}return[s]},self_stream:(e,t)=>e=>t.streams(t.myself.user_id),mutex_local_media:e=>e.mutex_local_media,local_track_of_kind:e=>t=>{if(!e.local_stream)return null;for(let i of e.local_stream.getTracks())if(m(i,t))return i;return null},bandwidth:e=>e.bandwidth,constraintsVideo:e=>e.constraintsVideo,constraintsAudio:e=>e.constraintsAudio},mutations:{resetP2PState(e){Object.assign(e,{peer_connections:{},local_stream:null,mutex_local_media:!1,remote_streams:{},video_activated:!1,audio_activated:!1,screen_activated:!1,bandwidth:500,constraintsVideo:{},constraintsAudio:{},forceTURN:!1})},pc(t,{user_id:i,room_id:r,webrtcConfig:s,p2pTentatives:o}){var a={user_id:i,room_id:r},n=d(a);if(t.peer_connections[n])return e.Call("p2p bypass PC creation : PC already exists "+i);var l=t.forceTURN?Object.assign({},s,{iceTransportPolicy:"relay"}):s;t.peer_connections[n]=Object.assign(new RTCPeerConnection(l),a),t.peer_connections[n].key=n,t.peer_connections[n].p2pTentatives=o||0},mutex_local_media(e,t){e.mutex_local_media=t},local_stream(e,t){if(e.local_stream)for(let i of t.getTracks())e.local_stream.addTrack(i);else e.local_stream=t},remote_stream(e,{stream:t,pc:i}){let r=i.user_id;e.remote_streams[r]=t},polite(t,{user_id:i,room_id:r}){var s=d({user_id:i,room_id:r});t.peer_connections[s]?t.peer_connections[s].polite=!0:e.error("polite: pc not found "+i)},stopLocalTrack(e,{kind:t}){if(!e.local_stream)return!0;for(let i of e.local_stream.getTracks())if(m(i,t)){i.stop(),e.local_stream.removeTrack(i);break}},deleteLocalStream(e){if(!e.local_stream)return!0;for(let t of e.local_stream.getTracks())t.stop();delete e.local_stream},deleteP2P(t,i){var r=t.peer_connections[i];if(!r)return e.error("failed to retrieve PC "+i);r.close(),delete t.peer_connections[i]},activated(e,{kind:t}){"video"==t?e.video_activated=!0:"screen"==t?e.screen_activated=!0:"audio"==t&&(e.audio_activated=!0)},deactivated(e,{kind:t}){"video"==t?e.video_activated=!1:"screen"==t?e.screen_activated=!1:"audio"==t&&(e.audio_activated=!1)},constraints(e,{bandwidth:t,constraintsVideo:i,constraintsAudio:r}){t&&(e.bandwidth=t),i&&i!={}&&(e.constraintsVideo=i),r&&r!={}&&(e.constraintsAudio=r)},forceTURN(e,t){e.forceTURN=t}},actions:{getUserMedia:({},t)=>navigator.mediaDevices?navigator.mediaDevices.getUserMedia(t):navigator.getUserMedia?new Promise((e,i)=>navigator.getUserMedia(t,e,i)):(e.Call("no navigator getLocalMedia method found"),Promise.reject("NotReadableError")),initP2P({commit:t,rootState:i,state:r,dispatch:s,getters:a},n){if(e.Call("iOSSafari : "+o),a.pc(n))return e.Call("p2p already exists");t("pc",Object.assign({},n,{webrtcConfig:i.webrtcConfig}));var l=a.pc(n);l.ontrack=(e=>{s("ontrack",{data:e,pc:l})}),l.onicecandidate=(e=>{s("onicecandidate",{data:e,pc:l})}),l.onnegotiationneeded=(t=>{if("stable"!=l.signalingState)return e.Call("onnegotiationneeded ignored "+l.user_id);e.Call("onnegotiationneeded "+l.user_id),s("createOffer",{data:t,pc:l})}),l.oniceconnectionstatechange=(e=>{s("oniceconnectionstatechange",{data:e,pc:l})}),l.onsignalingstatechange=(e=>{s("onsignalingstatechange",{data:e,pc:l})}),l.onicegatheringstatechange=(e=>{s("onicegatheringstatechange",{data:e,pc:l})})},sendStream({dispatch:i,getters:r},s){e.Call("sendStream to "+s.user_id),i("getLocalMedia",s).then(()=>{i("addLocalStream",r.pc(s))}).catch(e=>{console.error(e),i("alert_getLocalMediaError",e);var o=r.pc(s);t.callEventFromView({action:"reporting",reason:e,room_id:s.room_id,pcStates:o&&[o.polite,o.signalingState,o.iceConnectionState],step:"sendStream"})})},cleanAllP2P({state:e,commit:t,dispatch:i}){for(let t in e.peer_connections)i("cleanP2P",{key:t});t("deleteLocalStream")},cleanP2P({commit:t},{key:i,room_id:r,user_id:s}){e.Call("cleanP2P of "+(i||s)),t("deleteP2P",i||d({room_id:r,user_id:s}))},getLocalMedia:({state:i,commit:r,dispatch:s,getters:o},{user_id:l,type:d})=>new Promise((d,u)=>{var m,h,f,_,v,S=i.screen_activated,C=i.video_activated;if(i.local_stream){var b=p(i.local_stream);if(f=!b.isAudio,h=C&&!b.isVideo,m=S&&!b.isScreen,!f&&!h&&!m)return d()}else f=!0,h=C,m=S;if(i.mutex_local_media)return g.push(t=>{e.Call("Concurrent getLocalMedia finished, use same media for "+l),t&&u(t)||d()}),e.Call("Waiting for a concurrent getLocalMedia to finish before sending my stream to "+l);r("mutex_local_media",!0);var k=Object.assign({},o.constraintsVideo),y=Object.assign({},o.constraintsAudio);try{_=navigator.mediaDevices.getSupportedConstraints()}catch(e){_=null}if(_){for(v in k)_[v]||delete k[v];for(v in y)_[v]||delete y[v]}else k=null,y=null;k&&k!={}||y&&y!={}?(e.Call("getLocalMedia video constraints to apply : "+JSON.stringify(k)),e.Call("getLocalMedia audio constraints to apply : "+JSON.stringify(y))):e.Call("getLocalMedia no constraints to apply");var D=Object.assign({},a,{audio:f&&y,video:h&&k}),w=e=>{for(var t of(e&&r("local_stream",e),s("local_stream_info"),d(),g))t();g.length=0,r("mutex_local_media",!1)},I=e=>{for(var i of(u(e),g))i(e);g.length=0,r("mutex_local_media",!1),s("tracking",{action:"getLocalMediaFailed",reason:e,user_id:l}),s("track_event",{action:"getLocalMediaResult",dimensions:e.toString()}),t.callEventFromView({action:"reporting",reason:e,step:"getLocalMedia"})};const T=[...m?["screen"]:[],...f?["audio"]:[],...h?["video"]:[]];s("track_event",{action:"getLocalMedia",dimensions:T,eventValue:T.length}),new Promise((e,t)=>{if(!m)return e();navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(n).then(e).catch(t):navigator.getDisplayMedia(n).then(e).catch(t)}).then(e=>{D.audio||D.video?(e&&r("local_stream",c(e)),s("getUserMedia",D).then(w,I)):w(c(e))}).catch(e=>{I(e)})}),removeLocalTrackFromPC({},{pc:e,kind:t}){var i=e.getSenders();if(!i)return!0;i.forEach(i=>{m(i.track,t)&&e.removeTrack(i)})},addLocalStream({state:i,getters:r,dispatch:s},o){var a=i.local_stream;if(!a)return e.Call("no local stream");if(o.addTrack)try{var n,l=a.getTracks(),d=-1;for(n=0;n<l.length;n++)h(o,l[n].id)||(l[n].contentHint&&"text"==l[n].contentHint?d=n:o.addTrack(l[n],a));d>-1&&o.addTrack(l[d],a)}catch(i){e.error(i),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"addTrack"})}else{if(!o.addStream)return e.error("addLocalStream called but addTrack & addStream unexist");try{o.addStream(a)}catch(i){e.error("addLocalStream failed to addStream "+i),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"addStream"})}}s("sendStreamInfo",{kind:"screen",pc:o}),s("sendStreamInfo",{kind:"video",pc:o}),s("sendStreamInfo",{kind:"audio",pc:o}),s("sendStreamInfo",{kind:"hold",pc:o})},sendStreamInfo({getters:e},{kind:i,pc:r}){let s=e.local_track_of_kind(i);switch(i){case"screen":s&&t.callEventFromView({action:"speaker",type:i,room_id:r.room_id,user_id:e.myself.user_id,track_id:s.id});break;case"audio":case"video":s&&t.callEventFromView({action:"mute",type:i,muted:"muted"==e.local_stream_info(i),room_id:r.room_id,track_id:s.id});break;case"hold":t.callEventFromView({action:"hold",user_id:e.myself.user_id,onHold:e.hold&&-1!==e.hold.indexOf(r.room_id),room_id:r.room_id,sip:e.sip})}},local_stream_info({state:e,dispatch:t}){e.local_stream&&t("local_stream_changed",p(e.local_stream),{root:!0})},createOffer({dispatch:i},{pc:r}){r.makingOffer=!0,e.Call("CreateOffer"),r.createOffer(l).then(e=>r.setLocalDescription(e)).then(()=>{t.SDP({room_id:r.room_id,user_id:r.user_id,sdp:r.localDescription,isCaller:!0}),r.makingOffer=!1}).catch(s=>{e.error("failed to createOffer "+s),r.makingOffer=!1,i("track_event",{action:"webrtcIssue",dimensions:["createOffer",JSON.stringify(s),r.polite,r.signalingState,r.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:s,room_id:r.room_id,pcStates:[r.polite,r.signalingState,r.iceConnectionState],step:"createOffer"})})},onAnswer({dispatch:i},{data:r,pc:s}){s.isSettingRemoteAnswerPending=!0,s.setRemoteDescription(new RTCSessionDescription(r.sdp)).then(()=>{e.Call("onAnswer setRemoteDescription success"),s.isSettingRemoteAnswerPending=!1}).catch(r=>{e.error("onAnswer failed "+r),s.isSettingRemoteAnswerPending=!1,i("track_event",{action:"webrtcIssue",dimensions:["onAnswer",JSON.stringify(r),s.polite,s.signalingState,s.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:r,room_id:s.room_id,pcStates:[s.polite,s.signalingState,s.iceConnectionState],step:"onAnswer"})})},onOffer({dispatch:i,commit:r},{data:s,pc:a}){var n=!a.makingOffer&&("stable"==a.signalingState||a.isSettingRemoteAnswerPending);if(a.ignoreOffer=!a.polite&&!n,a.ignoreOffer)return e.Call("Ignoring SDP offer to avoid collision");a.setRemoteDescription(new RTCSessionDescription(s.sdp)).then(()=>(e.Call("onOffer setRemoteDescription success"),i("getLocalMedia",s))).then(()=>(e.Call("onOffer getLocalMedia resolved"),i("addLocalStream",a))).then(()=>(e.Call("onOffer localStream added"),a.createAnswer(l))).then(t=>(e.Call("onOffer answer created"),a.setLocalDescription(t))).then(()=>{e.Call("onOffer setLocalDescription success"),t.SDP({room_id:a.room_id,user_id:a.user_id,sdp:a.localDescription,isCaller:!1})}).catch(r=>{e.error("onOffer failed (polite  : "+a.polite+", iOSSafari: "+o+", signalingState : "+a.signalingState+"). Error: "+r),i("track_event",{action:"webrtcIssue",dimensions:["onOffer",JSON.stringify(r),a.polite,a.signalingState,a.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:r,room_id:a.room_id,pcStates:[a.polite,a.signalingState,a.iceConnectionState],step:"onOffer"}),i("initRetryProcess",{pc:a})})},ontrack({dispatch:t,commit:i,getters:r},{data:s,pc:o}){var a=s.stream||s.streams[0],n=a.getVideoTracks();n&&r.speaker_id&&o.user_id==r.speaker_id&&1==n.length&&(n[0].contentHint="text",i("speaker",{user_id:o.user_id,speaker_track_id:n[0].id,kind:"screen"}));var l=p(a);e.Call("Track of "+o.user_id+" received "+JSON.stringify(l)),i("remote_stream",{stream:a,pc:o,info:l}),t("update_received_stream",{user_id:o.user_id,pc:o})},update_received_stream({dispatch:e,state:t},{user_id:i,pc:r}){var s=t.remote_streams[i];if(!s)return!0;var o=p(s);o.isAudio?e("received_track_audio",{user_id:r.user_id},{root:!0}):e("remove_track_audio",{user_id:r.user_id},{root:!0}),o.isVideo?e("received_track_video",{user_id:r.user_id},{root:!0}):e("remove_track_video",{user_id:r.user_id},{root:!0}),o.isScreen?e("received_track_screen",{user_id:r.user_id},{root:!0}):e("remove_track_screen",{user_id:r.user_id},{root:!0})},onicecandidate({},{data:i,pc:r}){if(!i.candidate)return e.Call("ignoring candidate "+JSON.stringify(i));t.webrtcIceCandidate({room_id:r.room_id,user_id:r.user_id,candidate:i.candidate})},oniceconnectionstatechange({getters:t},{data:i,pc:r}){e.Call("oniceconnectionstatechange : "+r.iceConnectionState),"failed"===r.iceConnectionState&&"function"==typeof r.restartIce&&r.restartIce(),"failed"===r.iceConnectionState||"disconnected"===r.iceConnectionState||"closed"===r.iceConnectionState||"connected"==r.iceConnectionState&&function(t,i){if(!t||!i)return e.error("updateSenderBandwidth bad params");if(!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters)return e.Call("updateSenderBandwidth no compatiblity");try{var r=t.getSenders();for(let e of r)e.track&&"video"==e.track.kind&&f(e,i)}catch(e){console.error(e)}}(r,t.bandwidth)},onsignalingstatechange({dispatch:t},{data:i,pc:r}){e.Call("onsignalingstatechange : "+r.signalingState),"stable"==r.signalingState&&t("update_received_stream",{user_id:r.user_id,pc:r})},onicegatheringstatechange({},{data:t,pc:i}){let r="Unknown";switch(i.iceGatheringState){case"new":case"complete":r="Idle";break;case"gathering":r="Determining route"}e.Call("ICE status : "+i.iceGatheringState)},SDP({dispatch:t,getters:i,commit:r},s){if(!s.sdp)return e.error("failed to find sdp in "+JSON.stringify(s));if(i.refusers.indexOf(s.user_id)>-1)return e.Call("SDP sender already left the call");var o=i.pc(s);if(!o){if(!i.accepted_room||s.room_id!=i.accepted_room.room_id)return e.Call("SDP received for another device");if(e.Call("SDP initP2P for mobile retrocompatibility"),r("accepter",s.user_id),t("initP2P",s),t("autoEndTimeoutOFF",{room_id:s.room_id}),!(o=i.pc(s)))return e.error("SDP failed to create pc "+JSON.stringify(s))}s.isCaller?t("onOffer",{data:s,pc:o}):t("onAnswer",{data:s,pc:o})},webrtcIceCandidate({getters:i,dispatch:r},s){if(!s.candidate)return e.Call("error no candidate in "+JSON.stringify(s));var o=i.pc(s);if(!o)return e.error("webrtcIceCandidate failed to find pc "+JSON.stringify(s));o.addIceCandidate(new RTCIceCandidate(s.candidate)).then(()=>{e.Call("addIceCandidate success")}).catch(i=>{o.ignoreOffer||(e.error("addIceCandidate failed "+i),r("track_event",{action:"webrtcIssue",dimensions:["webrtcIceCandidate",JSON.stringify(i),o.polite,o.signalingState,o.iceConnectionState]}),t.callEventFromView({action:"reporting",reason:i,room_id:o.room_id,pcStates:[o.polite,o.signalingState,o.iceConnectionState],step:"webrtcIceCandidate"}))})},activeTrack({state:e,dispatch:i,getters:r,commit:s},{kind:o,room_id:a}){s("activated",{kind:o}),r.local_track_of_kind(o)?i("muteTrack",{kind:o,room_id:a,unmute:!0}):i("getLocalMedia",{type:o,room_id:a}).then(()=>{for(let t in e.peer_connections)i("addLocalStream",e.peer_connections[t]);t.callEventFromView({type:o,action:"mute",muted:!1,room_id:a})}).catch(e=>{s("deactivated",{kind:o}),t.callEventFromView({action:"reporting",reason:e,room_id:a,step:"activeTrack"})}),r.sip&&i("activeStreamWebTel",{onHold:r.is_onhold_room(a)})},muteTrack({getters:e,dispatch:i,commit:r},{kind:s,room_id:o,unmute:a}){e.local_track_of_kind(s).enabled=!!a,i("local_stream_info"),"video"==s&&r("showSelfView"),t.callEventFromView({type:s,action:"mute",muted:!a,room_id:o}),e.sip&&i("muteStreamWebTel",{onHold:e.is_onhold_room(o)})},stopTrack({state:i,dispatch:r,commit:s,getters:o},{kind:a,room_id:n}){var l=o.local_track_of_kind(a);if(!l)return console.error("Can not find track of kind "+a);var d=l.id;e.Call("stopTrack "+a+" "+d);for(let e in i.peer_connections)r("removeLocalTrackFromPC",{pc:i.peer_connections[e],kind:a});s("stopLocalTrack",{kind:a}),r("local_stream_info"),s("deactivated",{kind:a}),t.callEventFromView({type:a,action:"stopTrack",track_id:d,room_id:n||o.accepted_room&&o.accepted_room.room_id})},restartAllP2P({dispatch:e,state:t}){for(let i in t.peer_connections)e("initRetryProcess",{pc:t.peer_connections[i]})},initRetryProcess({dispatch:i,getters:r,rootState:s},{pc:o}){if(e.Call("initRetryProcess with "+o.user_id),"number"==typeof o.p2pTentatives?o.p2pTentatives++:o.p2pTentatives=1,i("track_event",{action:"retryP2P",dimensions:"init",eventValue:o.p2pTentatives}),o.p2pTentatives>s.max_p2pTentatives)return e.Call("initRetryProcess aborted : reached max_p2pTentatives");t.callEventFromView({action:"restartP2P",user_id:r.myself.user_id,user_id_to:o.user_id,room_id:o.room_id,p2pTentatives:o.p2pTentatives})},restartP2P({rootState:i,dispatch:r,getters:s,commit:o},{user_id:a,room_id:n,p2pTentatives:l}){var d={user_id:a,room_id:n,webrtcConfig:i.webrtcConfig,p2pTentatives:l};e.Call("restartP2P asked by "+d.user_id),r("resetPC",d).then(()=>(o("polite",d),t.callEventFromView({action:"p2pRestarted",user_id:s.myself.user_id,user_id_to:d.user_id,room_id:d.room_id,p2pTentatives:l}))).catch(i=>{e.error("restartP2P failed "+i),t.callEventFromView({action:"reporting",reason:i,room_id:n,p2pTentatives:l,step:"restartP2P"})})},p2pRestarted({dispatch:i,rootState:r},{user_id:s,room_id:o,p2pTentatives:a}){var n={user_id:s,room_id:o,webrtcConfig:r.webrtcConfig,p2pTentatives:a};e.Call("p2pRestarted "+n.user_id),i("resetPC",n).then(()=>i("sendStream",{user_id:n.user_id,room_id:n.room_id})).catch(i=>{e.error("p2pRestarted failed "+i),t.callEventFromView({action:"reporting",reason:i,room_id:o,p2pTentatives:a,step:"p2pRestarted"})})},resetPC:({commit:e,dispatch:t},i)=>(e("remove_track_audio",{user_id:i.user_id}),e("remove_track_video",{user_id:i.user_id}),e("remove_track_screen",{user_id:i.user_id}),t("cleanP2P",i).then(()=>t("initP2P",i))),getStats:({state:e},{selector:t,allStats:i})=>new Promise((r,s)=>{var o=[],a=[];for(let i in e.peer_connections)o.push(e.peer_connections[i].getStats(t)),a.push(i);Promise.all(o).then(e=>{var t={},s=0;return e.forEach(e=>{t[a[s]]=[],e.forEach(e=>{("outbound-rtp"==e.type||"inbound-rtp"==e.type||i)&&t[a[s]].push(e)}),s++}),r(t)}).catch(s)})}}}),define("DS/InstantMessagingCall/components/PanelMembers/PanelMembers",["text!DS/InstantMessagingCall/components/PanelMembers/PanelMembers.html","DS/InstantMessagingCall/components/MemberList/MemberList"],function(e,t){"use strict";return{components:{"im-call-member-list":t},computed:{called_users(){return this.$store.getters.called_users}},template:e}}),define("DS/InstantMessagingCall/store/modules/call",["DS/RTProxyDriver/RTLogger","DS/InstantMessagingCall/api/senders","DS/InstantMessagingCall/store/modules/users","DS/InstantMessagingCall/store/modules/p2p"],function(e,t,i,r){"use strict";const s={initial:"initial",invited:"invited",accepted:"accepted",ended:"ended"},o=()=>({callStatus:s.initial,rooms:{},room_id_accepted:null,room_id_invitations:[],room_id_hold:[],isVolumeOFF:!1,displayActionBar:!0,minimized:!1,date_start:0,showSelfView:!0,currentPanel:null,sip:!1,showInvite:!0,showDialer:!1,isHoldtoneON:!1,hideConvFeatures:!1});return{modules:{users:i,p2p:r},state:Object.assign({startMinimized:!1,timelineAvailable:!0,screenSharingAvailable:!0,confettiAvailable:!1},o()),getters:{screenSharingAvailable:e=>e.screenSharingAvailable,timelineAvailable:e=>e.timelineAvailable&&!e.hideConvFeatures,isInitial:e=>e.callStatus==s.initial,isAccepted:e=>e.callStatus==s.accepted,isInvited:e=>e.callStatus==s.invited,isEnded:e=>e.callStatus==s.ended,invitations:e=>e.room_id_invitations,room:e=>t=>e.rooms[t],accepted_room_id:e=>e.room_id_accepted,accepted_room:e=>e.rooms[e.room_id_accepted],is_accepted_room:e=>t=>!!e.room_id_accepted&&e.room_id_accepted==t,called_users_name:e=>t=>{var i=[];if(!e.rooms[t]||!e.rooms[t].calledUsers)return i;for(let r of e.rooms[t].calledUsers)i.push(r.username);return i},isVolumeOFF:e=>e.isVolumeOFF,displayActionBar:e=>e.displayActionBar,minimized:e=>e.minimized,date_start:e=>e.date_start,const_timeout_ms:e=>3e4,timeout_date_start:e=>t=>e.rooms[t].timeout_date_start,showSelfView:e=>e.showSelfView,currentPanel:e=>e.currentPanel,dmId:e=>e.accepted_room&&e.accepted_room.options&&e.accepted_room.options.dmId,sip:e=>e.sip,roomName:e=>e=>e.topic||e.options&&e.options.topic||e.orderId||e.options&&e.options.orderId,showInvite:e=>e.showInvite,showDialer:e=>e.showDialer,hideConvFeatures:e=>e.sip||e.hideConvFeatures,hold:e=>e.room_id_hold,is_onhold_room:e=>t=>e.room_id_hold&&e.room_id_hold.indexOf(t)>-1,isHoldtoneON:e=>e.isHoldtoneON,asDelegateOf:e=>t=>e.rooms[t].asDelegateOf,simringWith:e=>t=>e.rooms[t].simringWith},mutations:{resetCallState(e){Object.assign(e,o())},status(t,i){let r;if(i){if(!s[i])return e.Call("error callStatus unknown : "+i);r=s[i]}else switch(t.callStatus){case s.initial:r=s.invited;break;case s.invited:r=s.accepted;break;case s.accepted:r=s.ended;break;case s.ended:r=s.initial;break;default:r=s.initial}return r==t.callStatus||(r==s.invited&&t.callStatus!=s.initial&&t.callStatus!=s.ended||r==s.accepted&&t.callStatus!=s.invited||r==s.ended&&t.callStatus!=s.invited&&t.callStatus!=s.accepted?e.Call("Can not set "+r+" after "+t.callStatus):(r==s.accepted&&t.startMinimized&&(t.minimized=!0),r==s.accepted&&(t.date_start=Date.now()),e.Call("nextStatus: "+r),void(t.callStatus=r)))},room_accepted(e,t){e.room_id_accepted=t},room(e,t){e.rooms[t.room_id]?(e.rooms[t.room_id].asDelegateOf=t.asDelegateOf,e.rooms[t.room_id].simringWith=t.simringWith):e.rooms[t.room_id]=t},invitation_del(e,t){let i=e.room_id_invitations.indexOf(t);-1!=i&&e.room_id_invitations.splice(i,1)},invitation_del_all(e){e.room_id_invitations.length=0},invitation(e,t){-1==e.room_id_invitations.indexOf(t)&&e.room_id_invitations.push(t)},volume:(e,t)=>{e.isVolumeOFF=!t},closeActionBar:e=>{e.displayActionBar=!1},openActionBar:e=>{e.displayActionBar=!0},minimize:(e,t)=>{e.minimized=t},timeout_started:(e,{room_id:t})=>{e.rooms[t].timeout_date_start=Date.now()},timeout_stopped:(e,{room_id:t})=>{e.rooms[t].timeout_date_start=0},showSelfView:e=>{e.showSelfView=!0},hideSelfView:e=>{e.showSelfView=!1},currentPanel:(e,t)=>{e.currentPanel=t},screenSharingAvailable:(e,t)=>{e.screenSharingAvailable=t},sipState:(e,t)=>{e.sip=!!(t&&t.options&&t.options.sip)&&!!t.options.sip},showInvite:e=>{e.showInvite=!0},hideInvite:e=>{e.showInvite=!1},showDialer:e=>{e.showDialer=!0},hideDialer:e=>{e.showDialer=!1},hideConvFeatures:(e,t)=>{e.hideConvFeatures=!t||!t.convId&&!t.dmId},hold:(e,t)=>{-1===e.room_id_hold.indexOf(t)&&e.room_id_hold.push(t)},resume:(e,t)=>{const i=e.room_id_hold.indexOf(t);i>-1&&e.room_id_hold.splice(i,1)},holdtoneON:(e,t)=>{e.isHoldtoneON=t}},actions:{nextStatus({commit:e}){e("status")},endCurrentCall({dispatch:e,getters:t}){t.accepted_room&&e("endCall",t.accepted_room)},endCall({dispatch:i,getters:r},s){r.isAccepted&&(e.Call("Call Started Resumed before end"),i("resumeCall",s.room_id)),t.endCall({reason:"user_hangup",IamTheCaller:s.IamTheCaller,dontEndCallOnRoom:!1,room_id:s.room_id}),i("stopFeatures",{room_id:s.room_id}),i("autoEndTimeoutOFF",{room_id:s.room_id}),i("notifSW",{action:"endCall",data:{room_id:s.room_id}})},endAllInvitations({getters:e,dispatch:i}){for(let r of e.invitations)t.endCall({reason:"user_hangup",IamTheCaller:!1,dontEndCallOnRoom:!1,room_id:r}),i("autoEndTimeoutOFF",{room_id:r}),i("notifSW",{action:"endCall",data:{room_id:r}})},endCallMissed({dispatch:e},{room_id:i,IamTheCaller:r}){t.endCall({reason:r?"callTimeout":"callMissed",IamTheCaller:r,dontEndCallOnRoom:r,room_id:i}),e("notifSW",{action:"endCall",data:{room_id:i}})},endCallFailure({dispatch:e},{room_id:i,reason:r,IamTheCaller:s}){t.endCall({reason:r,IamTheCaller:s,dontEndCallOnRoom:!1,room_id:i}),e("autoEndTimeoutOFF",{room_id:i}),e("notifSW",{action:"endCall",data:{room_id:i}})},acceptCall({commit:e,getters:i,dispatch:r},{room_id:s,type:o,noNotif:a}){e("room_accepted",s),r("autoEndTimeoutOFF",{room_id:s}),e("status","accepted"),e("invitation_del",s),r("endAllInvitations");o=o||i.room(s).type;t.acceptCall({room_id:s,type:o,asDelegateOf:i.asDelegateOf(s),simringWith:i.simringWith(s)}),r("getLocalMedia",{type:null,user_id:i.myself.user_id}).catch(e=>{r("alert_getLocalMediaError",e),r("endCallFailure",{room_id:s,IamTheCaller:!1,reason:e})}),a||r("notifSW",{action:"acceptCall",data:{room_id:s}})},inviteSent({commit:e,dispatch:t,getters:i},r){if(t("startFocusListener"),e("status","invited"),r.IamTheCaller=!0,e("sipState",r),e("hideConvFeatures",r&&r.call),e("room",r),e("user",i.myself),t("tracking",{action:"inviteSent"}),r.calledUsers)for(let t of r.calledUsers)e("user",t);i.accepted_room||(e("activated",{kind:r.type}),t("autoEndTimeoutON",{room_id:r.room_id,IamTheCaller:!0}),t("noises",{action:"startRingbacktone"})),r.options&&r.options.featureData&&t("invited_feature",{type:r.type,room_id:r.room_id,featureData:r.options.featureData}),e("room_accepted",r.room_id),e("invitation",r.room_id),e("constraints",r),t("getLocalMedia",r).catch(e=>{t("alert_getLocalMediaError",e),t("endCallFailure",{room_id:r.room_id,IamTheCaller:!0,reason:e})})},inviteReceived({commit:i,state:r,getters:s,dispatch:o},a){if(a.youHaveToAccept){if(a.room_id!=r.room_id_accepted)return e.Call("Invitation protocol error : while on "+r.room_id_accepted+", received invitation from "+a.login+" on "+a.room_id);i("user",a.user),i("accepter",a.user_id),o("initP2P",a),i("polite",a),o("sendStream",a),t.acceptCall({user_id:a.user_id,room_id:a.room_id,type:"audio",autoAccept:!0})}else if(s.isAccepted)e.Call("Invitation protocol error "+JSON.stringify(a));else{i("sipState",a),i("hideConvFeatures",a&&a.call),!0!==localStorage.getItem(a.room_id)&&(o("noises",{action:"startRingtone"}),localStorage.setItem(a.room_id,!0)),i("user",s.myself);for(let e of a.calledUsers)i("user",e),e.id===s.myself.user_id&&e.asDelegateOf&&(i("user",e.asDelegateOf),a.asDelegateOf=e);a.simringWith=a.calledUsers.filter(e=>e.asDelegateOf&&(e.asDelegateOf.id===s.myself.user_id||e.asDelegateOf===a.asDelegateOf)),"screen"==a.type&&(a.type="audio"),i("room",a),i("invitation",a.room_id),i("constraints",a),i("status","invited"),o("autoEndTimeoutON",{room_id:a.room_id,IamTheCaller:!1}),o("startFocusListener"),o("notifSW",{action:"inviteReceived",data:a})}},accepted({commit:i,state:r,dispatch:s,getters:o},a){if(!r.rooms[a.room_id])return e.Call("error room unknown "+a.room_id);if(r.room_id_accepted!=a.room_id&&a.user_id!=o.myself.user_id)return e.Call("someone else accepted the call and I still don't");if(s("noises",{action:"stopTones"}),e.Call("Someone joined the call "+a.user.login),i("invitation_del",a.room_id),i("user",a.user),s("autoEndTimeoutOFF",{room_id:a.room_id}),a.user_id!=o.myself.user_id)i("sipState",o.room(a.room_id)),s("noises",{action:"userIn"}),s("initP2P",a),i("status","accepted"),i("accepter",a.user_id),s("sendCurrentFeature"),a.autoAccepted?(e.Call("Another accepter's p2p is ready, send my stream"),s("sendStream",a)):(e.Call("Another user joined, tell him to start p2p with me"),(!a.clientDevice||!a.clientDevice.callVersion||a.clientDevice.platform&&"ios"==a.clientDevice.platform.toLowerCase())&&i("polite",a),t.startCall({login:a.user.login,alreadyStarted:!0,room_id:a.room_id}),s("tracking",{login:a.user.login,action:"accepted"}));else if(a.room_id==r.room_id_accepted){e.Call("I accepted the call on current device, initP2P with the caller (mobile retrocompat), waiting for other users to start P2P");var n=o.accepted_room.user.user_id;i("accepter",n),s("initP2P",Object.assign({},a,{user_id:n}))}else e.Call("I accepted the call on another device whereas I am in the room on current device"),o.invitations.length||i("status","initial"),s("notifSW",{action:"closeNotifRoomId",data:a})},cleanEverything({commit:e,dispatch:t},i){t("cleanAllP2P"),t("cleanTelephony"),e("status","ended"),e("resetUsersState"),e("resetP2PState"),e("resetFeatureState"),e("resetCallState"),i&&t("notifSW",{action:"endCall",data:{room_id:i}})},callEnded({commit:i,state:r,dispatch:s,getters:o},{room_id:a,user_id:n,login:l,reason:d}){var c=n==o.myself.user_id,u=o.room(a)&&o.room(a).user.user_id==n,m=o.room(a)&&o.room(a).IamTheCaller;return s("alert_callResumed"),s("tracking",{reason:d,login:l,action:"ended"}),s("noises",{action:"stopTones"}),localStorage.removeItem(a),a==r.room_id_accepted?(i("refuser",n),c?(e.Call("I left the call "+a),s("stopTracking",{dontSendSwymReport:!1}),s("cleanEverything",a)):(s("noises",{action:"userOut"}),o.called_users.length-1==o.refusers.length||u&&!o.accepters.length&&!m?(e.Call("I am the last one of the call "+a+(u?" and the caller left ":"")),t.endCall({reason:"user_hangup",IamTheCaller:m,dontEndCallOnRoom:!1,room_id:a}),s("stopTracking",{dontSendSwymReport:!1}),s("cleanEverything",a)):(s("cleanP2P",{room_id:a,user_id:n}),e.Call("Someone left the call "+a)))):(-1!=o.invitations.indexOf(a)&&(c||u?(e.Call((c?"I refused the invitation":"The caller stopped the invitation")+" on "+a),i("invitation_del",a),o.invitations.length||r.room_id_accepted||s("cleanEverything",a)):e.Call("Someone refused/left the call I am invited on "+a)),e.error("Received an unwanted endCall "+a))},volumeOFF({commit:e,getters:t,dispatch:i},r){e("volume",!r),t.isHoldtoneON&&i("noises",r?{action:"stopHoldtone"}:{action:"startHoldtone"})},holdCall({commit:i,getters:r,dispatch:s},o){e.Call("Call hold on "+o),s("alert_callOnHold"),i("hold",o),i("call_hold",{user_id:r.myself.user_id,onHold:!0}),t.callEventFromView({action:"hold",user_id:r.myself.user_id,onHold:!0,room_id:o,sip:r.sip}),s("volumeOFF",!0),s("muteTrack",{kind:"audio",room_id:o}),r.local_stream_info("video")&&s("muteTrack",{kind:"video",room_id:o}),r.local_stream_info("screen")&&"muted"!==r.local_stream_info("screen")&&s("stopTrack",{kind:"screen",room_id:o})},resumeCall({commit:i,getters:r,dispatch:s},o){e.Call("Call resumed on "+o),s("alert_callResumed"),i("resume",o),i("call_hold",{user_id:r.myself.user_id,onHold:!1}),t.callEventFromView({action:"hold",user_id:r.myself.user_id,onHold:!1,room_id:o,sip:r.sip}),s("volumeOFF",!1),s("activeTrack",{kind:"audio",room_id:o})},call_hold({commit:t,getters:i,dispatch:r},{room_id:s,user_id:o,onHold:a}){if(!i.user(o))return e.Call("User on hold doesn't exist.");if(t("call_hold",{user_id:o,onHold:a}),a){let e=i.accepters_except_myself.filter(e=>i.hasHoldCall(e));i.accepters_except_myself.length===e.length&&(t("holdtoneON",!0),i.isVolumeOFF||i.sip||r("noises",{action:"startHoldtone"}))}else t("holdtoneON",!1),r("noises",{action:"stopHoldtone"})},callEvent({commit:t,getters:i,dispatch:r},{room_id:s,action:o,type:a,user_id:n,track_id:l,muted:d,onHold:c,data:u,featureData:m,featureMembers:p,featureInfo:h,featureId:f,user_id_to:g,p2pTentatives:_,actions:v}){if(!i.isAccepted&&"notCallable"!=o&&"alreadyOnCall"!=o)return e.Call("ignoring callEvent "+o);switch(o){case"mute":t("stream_muted",{kind:a,user_id:n,muted:d});break;case"hold":r("call_hold",{room_id:s,user_id:n,onHold:c});break;case"speaker":t("call_speaker",{user_id:n,speaker_track_id:l,kind:a}),!i.currentFeature&&t("speaker",{user_id:n,speaker_track_id:l,kind:a});break;case"feature":r("received_feature",{user_id:n,room_id:s,featureInfo:h});break;case"confetti":r("received_confetti",{user_id:n,room_id:s,featureData:m,featureId:f});break;case"3DPlayData":r("received_3DPlay_data",{user_id:n,room_id:s,featureData:m,featureId:f,actions:v});break;case"masterChanged":r("masterChanged",{user_id:n,featureId:f});break;case"featureEnded":r("featureEnded",{user_id:n,featureId:f});break;case"featureMembers":r("featureMembers",{user_id:n,featureId:f,featureMembers:p});break;case"stopTrack":t("track_stopped",{user_id:n,track_id:l,kind:a});break;case"notCallable":for(let e in u.uncallableUsers)r("callEnded",{login:u.uncallableUsers[e].login,user_id:u.uncallableUsers[e].user_id,room_id:s,reason:"Busy"});r("alert_uncallableUsers",{calledUsers:u.callableLogins,uncallableUsers:u.uncallableUsers});break;case"alreadyOnCall":r("alert_alreadyOnCall");break;case"restartP2P":i.is_accepted_room(s)&&g==i.myself.user_id?r("restartP2P",{room_id:s,user_id:n,p2pTentatives:_}):e.Call("ignore callEvent restartP2P from "+n+" to "+g);break;case"p2pRestarted":i.is_accepted_room(s)&&g==i.myself.user_id?r("p2pRestarted",{room_id:s,user_id:n,p2pTentatives:_}):e.Call("ignore callEvent p2pRestarted from "+n+" to "+g);break;default:e.Call("unknown callEvent "+o)}},received_track_video({commit:e,dispatch:t},{user_id:i,track_id:r}){e("received_track_video",{user_id:i,track_id:r}),t("tracking",{user_id:i,kind:"video",action:"stream"})},received_track_screen({commit:e,dispatch:t},{user_id:i}){e("received_track_screen",{user_id:i}),t("tracking",{user_id:i,kind:"screen",action:"stream"})},received_track_audio({commit:e,dispatch:t},{user_id:i,track_id:r}){e("received_track_audio",{user_id:i,track_id:r}),t("tracking",{user_id:i,kind:"audio",action:"stream"})},remove_track_screen({commit:e},{user_id:t}){e("remove_track_screen",{user_id:t})},remove_track_video({commit:e},{user_id:t}){e("remove_track_video",{user_id:t})},remove_track_audio({commit:e},{user_id:t}){e("remove_track_audio",{user_id:t})},local_stream_changed({commit:e,getters:t},i){i.isAudio&&e("received_track_audio",{user_id:t.myself.user_id,track_id:i.track_id_audio}),i.isVideo&&e("received_track_video",{user_id:t.myself.user_id,track_id:i.track_id_video}),i.isScreen?e("received_track_screen",{user_id:t.myself.user_id,track_id:i.track_id_screen}):(e("remove_track_screen",{user_id:t.myself.user_id}),e("track_stopped",{user_id:t.myself.user_id,track_id:i.track_id_screen,kind:"screen"})),e("local_stream_info",{kind:"audio",muted:i.isAudioMuted,loaded:i.isAudio,user_id:t.myself.user_id}),e("local_stream_info",{kind:"video",muted:i.isVideoMuted,loaded:i.isVideo,user_id:t.myself.user_id}),e("local_stream_info",{kind:"screen",muted:i.isScreenMuted,loaded:i.isScreen,user_id:t.myself.user_id})},autoEndTimeoutON({commit:e,getters:t,dispatch:i},{room_id:r,IamTheCaller:s}){t.room(r)&&!t.room(r).callMissed&&(e("timeout_started",{room_id:r}),t.room(r).callMissed=setTimeout(()=>{i("endCallMissed",{room_id:r,IamTheCaller:s})},3e4))},autoEndTimeoutOFF({commit:e,getters:t},{room_id:i}){e("timeout_stopped",{room_id:i}),clearTimeout(t.room(i).callMissed)},offlineStartCall({dispatch:e},t){e("offlineStartCallTracking",t),e("alert_connexionLost")}}}}),define("DS/InstantMessagingCall/store/index",["vuejs","vuex","DS/InstantMessagingCall/store/modules/call","DS/InstantMessagingCall/store/modules/tracker","DS/InstantMessagingCall/store/modules/messages","DS/InstantMessagingCall/store/modules/noises","DS/InstantMessagingCall/store/modules/notifSW","DS/InstantMessagingCall/store/modules/feature","DS/InstantMessagingCall/store/modules/focus","DS/InstantMessagingCall/store/modules/usergroup","DS/InstantMessagingCall/store/modules/telephony","DS/RTProxyDriver/RTLogger"],function(e,t,i,r,s,o,a,n,l,d,c,u){"use strict";return u.addLevel("CallNotif","darkblue"),new t.Store({state:{tenant:"GLOBAL",webrtcConfig:null,user_id_myself:null,login_myself:null,username_myself:null,appName:null,rtcUrl:null,swymUrl:null,isConnected:!1,clientDevice:null,isIOS:!1,isMac:!1,isDesktopApp:!1,isOpera:!1,backgroundImage:!0,clickOnVideo:!1,selfViewInUserList:!0,assets_url:void 0,max_p2pTentatives:15},modules:{call:i,tracker:r,messages:s,noises:o,notifSW:a,Feature:n,focus:l,usergroup:d,Telephony:c},getters:{rtcUrl:e=>e.rtcUrl,swymUrl:e=>e.swymUrl,tenant:e=>e.tenant,myself:e=>({user_id:e.user_id_myself,login:e.login_myself,username:e.username_myself}),isConnected:e=>e.isConnected,isIOS:e=>e.isIOS,isMac:e=>e.isMac,isDesktopApp:e=>e.isDesktopApp,isOpera:e=>e.isOpera,isDevEnv:e=>"devenv"==e.appName,selfViewInUserList:e=>e.selfViewInUserList,assets_url:e=>e.assets_url,backgroundImage:e=>e.backgroundImage,clickOnVideo:e=>e.clickOnVideo,isMobile:e=>e.isMobile},mutations:{tenant(e,t){e.tenant=t},user_id_myself(e,t){e.user_id_myself=t},login_myself(e,t){e.login_myself=t},username_myself(e,t){e.username_myself=t},webrtcConfig(e,t){e.webrtcConfig=t},appName(e,t){e.appName=t,"devenv"!=e.appName&&"3dprint"!=e.appName&&"ElectronCallWebview"!=e.appName||(e.call.timelineAvailable=!1),"devenv"==e.appName&&(e.call.confettiAvailable=!0),e.assets_url="devenv"==e.appName?"../../../InstantMessaging/InstantMessagingCall.mweb/src/assets/":window.dsDefaultWebappsBaseUrl+"InstantMessagingCall/assets/"},swymUrl(e,t){e.swymUrl=t},rtcUrl(e,t){e.rtcUrl=t},isConnected(e,t){e.isConnected=t},clientDevice(e,t){e.clientDevice=t},isIOS(e,t){e.isIOS=t},isMac(e,t){e.isMac=t},isDesktopApp:(e,t)=>{e.isDesktopApp=t},isOpera(e,t){e.isOpera=t},selfViewInUserList(e,t){e.selfViewInUserList=t},isMobile(e,t){e.isMobile=t}},actions:{connected({getters:e,commit:t,dispatch:i},{clientDevice:r,tenant:s,user_id_myself:o,login_myself:a,username_myself:n,appName:l}){i("alert_connexionRetrieved"),t("isConnected",!0),r&&i("clientDevice",r),s&&t("tenant",s),o&&t("user_id_myself",o),a&&t("login_myself",a),n&&t("username_myself",n),l&&t("appName",l),-1!==window.navigator.userAgent.indexOf("OPR")&&t("isOpera",!0),window&&window.ds&&"MOBILE"==window.ds.env&&t("isMobile",!0),i("notifSW",{action:"initSW"})},disconnected({commit:e}){e("isConnected",!1)},clientDevice({commit:e},t){e("clientDevice",t),void 0===t.ScreenSharingCompatible||t.ScreenSharingCompatible||e("screenSharingAvailable",!1),void 0!==t.isIOS&&e("isIOS",t.isIOS),void 0!==t.isMac&&e("isMac",t.isMac)}}})}),define("DS/InstantMessagingCall/components/Collab/Collab",["text!DS/InstantMessagingCall/components/Collab/Collab.html","DS/InstantMessagingCall/components/CollabOfficeDocument/CollabOfficeDocument","DS/InstantMessagingCall/components/CollabWhiteBoard/CollabWhiteBoard","DS/InstantMessagingCall/components/CollabConfetti/CollabConfetti","DS/InstantMessagingCall/components/Collab3DPlay/Collab3DPlay"],function(e,t,i,r,s,o){"use strict";return{components:{"im-call-ode":t,"im-call-whiteboard":i,"im-call-confetti":r,"im-call-3dplay":s},props:["feature","feature_id","isODE","isWhiteboard","isConfetti","is3DPlay","isScreenShare"],computed:{featureData(){return this.feature&&this.feature.featureData},masterUser(){return this.feature&&this.feature.master&&this.$store.getters.user(this.feature.master)}},template:e}}),define("DS/InstantMessagingCall/api/desktop/watchers",["DS/InstantMessagingCall/store/index","DS/PlatformAPI/PlatformAPI"],function(e,t){"use strict";const i=["invitation","invitation_del","room_accepted","status","minimize"],r=["inviteReceived","inviteSent","accepted","callEnded","cleanEverything"];var s;return{init:function(t){this.unsubscribe=e.subscribe(this.mutationsOccured,{prepend:!0}),this.unsubscribeAction=e.subscribeAction(this.actionsOccured,{prepend:!0}),s=t},destroy:function(){this.unsubscribe(),this.unsubscribeAction()},actionsOccured:function(e,i){-1!=r.indexOf(e.type)&&(console.log("To Electron : "+JSON.stringify(e)),t.publish(s,{data:e,state:{}}))},mutationsOccured:function(e,r){-1!=i.indexOf(e.type)&&(console.log("To Electron : "+JSON.stringify(e)),t.publish(s,e))}}}),define("DS/InstantMessagingCall/api/desktop/listeners_papi",["DS/InstantMessagingCall/store/index"],function(e){"use strict";const t={},i=["setPresence","endCurrentCall","endCall","acceptCall"],r=["showInvite","hideInvite","minimize"];for(let i of r)t[i]=(t=>{e.commit(i,t)});for(let r of i)t[r]=(t=>{e.dispatch(r,t)});return e=>{if(e.evenement&&t[e.evenement]||e.action&&t[e.action])return console.log("From Electron : "+JSON.stringify(e)),t[e.evenement||e.action](e&&e.data)}}),define("DS/InstantMessagingCall/api/listeners_papi",["DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/senders"],function(e,t){"use strict";const i={CONNECTED(t){e.dispatch("connected",{clientDevice:t.data.clientDevice,tenant:t.data.data.tenant,user_id_myself:t.data.user_id,login_myself:t.data.userId,username_myself:t.data.username,appName:t.data.appName})},startCall:i=>e.getters.isConnected?"screen"!=i.type||e.getters.screenSharingAvailable?(i.isJoinable||e.dispatch("startTracking",{logins:i.logins||i.login||i.phone,type:i.sip?"telephony":i.type,dmId:i.dmId}),e.dispatch("track_event",{action:i.isJoinable?"joinCall":"startCall",dimensions:[i.sip?"telephony":i.type,i.dmId||i.orderId],eventValue:(i.logins||[i.login]).length}),void t.startCall({login:i.login,logins:i.logins,username:i.username,type:i.type,rtconvEnable:i.rtconvEnable||!(!i.options||!i.options.rtconvEnable),options:{sip:i.sip||i.options&&i.options.sip,uri:i.uri||i.phone,orderId:i.orderId,topic:i.topic,callId:i.callId,dmId:i.subjectUri||i.dmId,dbConvId:i.subjectUri?i.dmId:i.dbConvId,swymUrl:i.swymUrl||i.options&&i.options.swymUrl,featureData:i.data}})):e.dispatch("alert_browserNotCompatible"):e.dispatch("offlineStartCall",i)};return e=>{if(e.evenement&&i[e.evenement]||e.action&&i[e.action])return i[e.evenement||e.action](e)}}),define("DS/InstantMessagingCall/components/LightboxContent/LightboxContent",["text!DS/InstantMessagingCall/components/LightboxContent/LightboxContent.html","DS/InstantMessagingCall/components/ActionBar/ActionBar","DS/InstantMessagingCall/components/UserList/UserList","DS/InstantMessagingCall/components/SelfView/SelfView","DS/InstantMessagingCall/components/UserItem/UserItem","DS/InstantMessagingCall/components/SpeakerName/SpeakerName","DS/InstantMessagingCall/components/Collab/Collab","DS/InstantMessagingCall/components/ActionBarItem/ActionBarItem","DS/InstantMessagingCall/components/VideoMinimize/VideoMinimize","DS/InstantMessagingCall/components/PanelUsers/PanelUsers"],function(e,t,i,r,s,o,a,n,l,d){"use strict";return{components:{"im-call-bar":t,"im-call-user-list":i,"im-call-self":r,"im-call-user-item":s,"im-call-speaker-name":o,"im-call-collaboration":a,"im-call-bar-item":n,"im-call-video-minimize":l,"im-call-panel-users":d},props:["room","isRightPanel","showUserList","userlist_at_top","showSelfView","backgroundImage","minimized"],data:function(){return{timeoutInterval:null,secondsLeftBeforeTimeout:0,timeoutMessageVisible:!1}},computed:{login_myself(){return this.$store.getters.myself.login},logins(){return this.$store.getters.logins_except_myself},speaker_id(){return this.$store.getters.speaker_id},feature_id(){return this.$store.getters.currentFeatureId},feature(){return!!this.feature_id&&this.$store.getters.feature(this.feature_id)},isODE(){return!!this.feature&&this.$store.getters.isODE(this.feature)},is3DPlay(){return!!this.feature&&this.$store.getters.is3DPlay(this.feature)},isWhiteboard(){return!!this.feature&&this.$store.getters.isWhiteboard(this.feature)},isConfetti(){return!!this.feature&&this.$store.getters.isConfetti(this.feature)},hasFeature(){return!!this.feature_id},hasSpeaker(){return!!this.speaker_id||!!this.feature_id},speaker_track_id(){return this.$store.getters.speaker_track_id},displayActionBar(){return this.$store.getters.displayActionBar},isDialerON(){return!!this.$store.getters.showDialer},isTelephonySupported(){return this.$store.getters.telephonyFeature}},methods:{toggleActionBar(){this.displayActionBar?this.$store.commit("closeActionBar"):this.$store.commit("openActionBar")},displaySelfView(){this.$store.commit("showSelfView"),this.$store.getters.selfViewInUserList&&this.displayUserList()},displayUserList(){this.$store.commit("showUserList",!0)},sendNbr(e){console.log("DIALER ",e)}},template:e}}),define("DS/InstantMessagingCall/api/desktop/interface",["DS/InstantMessagingCall/api/desktop/listeners_papi","DS/InstantMessagingCall/api/desktop/watchers","DS/InstantMessagingCall/store/index","DS/PlatformAPI/PlatformAPI"],function(e,t,i,r){"use strict";return{init:function(s){return i.commit("hideInvite"),r.subscribe("fromDesktopApp.ds.com",e),t.init("toDesktopApp.ds.com"),this}}}),define("DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox",["text!DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox.html","DS/InstantMessagingCall/components/LightboxContent/LightboxContent","DS/InstantMessagingCall/components/PanelMembers/PanelMembers","DS/InstantMessagingCall/components/PanelTimeline/PanelTimeline","DS/InstantMessagingCall/components/CustomType/CustomType"],function(e,t,i,r,s){"use strict";return{components:{"im-call-content":t,"im-call-members":i,"im-call-timeline":r,"im-call-type":s},data(){return{currentListPosition:"right",previousPanel:null,currentPanelComponent:null,sideActions:[{name:"minimize",fonticon:"resize-small",label:this.$store.getters.nls("minimize"),hidden:!1}],panel:{name:"right",show:!!this.currentPanel,fonticon:"users",showClose:!0,title:null}}},computed:{actions(){return{display_action_bar:{name:"display_action_bar",fonticon:"bottom-panel",label:this.$store.getters.nls("displayActionBar"),hidden:!0},members:{name:"members",fonticon:"users",label:this.$store.getters.nls("members")},timeline:{name:"timeline",fonticon:"chat-alt",label:this.$store.getters.nls("timeline"),hidden:!this.$store.getters.timelineAvailable},list_at_top:{name:"list_at_top",fonticon:"table-row-column",label:this.$store.getters.nls("displayListTop"),hidden:!0,isUserListAction:!0},list_at_right:{name:"list_at_right",fonticon:"table-row-column",label:this.$store.getters.nls("displayListRight"),hidden:!0,isUserListAction:!0},add_list:{name:"add_list",fonticon:"table-column-add ",label:this.$store.getters.nls("addList"),hidden:!0,isUserListAction:!0},remove_list:{name:"remove_list",fonticon:"table-column-delete",label:this.$store.getters.nls("removeList"),hidden:!0,isUserListAction:!0},remove_list_from_top:{name:"remove_list",fonticon:"table-row-delete",label:this.$store.getters.nls("removeListTop"),hidden:!0,isUserListAction:!0},add_list_at_top:{name:"add_list_at_top",fonticon:"table-row-add",label:this.$store.getters.nls("addListTop"),hidden:!0,isUserListAction:!0}}},hasSpeaker(){var e=!!this.$store.getters.speaker_id;return e||this.displayUserList(),e},backgroundImage(){return this.$store.getters.backgroundImage},actions_array(){var e=[];for(let t in this.actions)e.push(this.actions[t]);return e},room(){return this.$store.getters.accepted_room},showUserList(){return this.$store.getters.showUserList},showSelfView(){return this.$store.getters.showSelfView},labelArray(){return this.room&&this.$store.getters.roomName(this.room)?[this.$store.getters.roomName(this.room)]:this.room&&this.$store.getters.called_users_name(this.room.room_id)||this.$store.getters.accepters_name},displayActionBar(){return this.$store.getters.displayActionBar},minimized(){return this.$store.getters.minimized},logins(){return this.$store.getters.logins_except_myself},currentPanel(){var e=this.$store.getters.currentPanel;return e?(this.previousPanel&&e!=this.previousPanel&&(this.actions[this.previousPanel].selected=!1),this.actions[e].selected=!0,this.previousPanel=e,this.panel.show=!0,this.panel.title=this.$store.getters.nls(e),this.currentPanelComponent="im-call-"+e):(this.panel.show=!1,this.currentPanelComponent=null,this.previousPanel&&(this.actions[this.previousPanel].selected=!1),this.previousPanel=null),e}},methods:{endCall(){this.room&&this.$store.dispatch("endCall",this.room),this.track_event("close")},confirmEndCall(){return this.$confirm(this.$store.getters.nls("confirmEndCall"),this.$store.getters.nls("refuseCall"),{okLabel:this.$store.getters.nls("confirm"),cancelLabel:this.$store.getters.nls("cancel")})},beforeWindowUnload(){this.endCall()},closePanel(){this.$store.commit("currentPanel",null)},togglePanel(e){var t=e==this.previousPanel?null:e;this.$store.commit("currentPanel",t),t&&this.track_event(["togglePanel",e],1)},removeUserListAction(){for(let e in this.actions)this.actions[e].isUserListAction&&(this.actions[e].hidden=!0);return!0},addUserListAction(e){return this.removeUserListAction(),this.actions[e].hidden=!1,!0},userListAction(e){switch(e){case"add_list_at_top":this.displayUserList(),this.currentListPosition="top";break;case"remove_list":case"remove_list_from_top":this.hideUserList(),this.currentListPosition="hidden";break;case"add_list":this.displayUserList(),this.currentListPosition="right";break;case"list_at_top":this.currentListPosition="top";break;default:this.removeUserListAction(),this.displayUserList()}},hideUserList(){this.$store.commit("showUserList",!1)},displayUserList(){this.$store.commit("showUserList",!0)},chooseUserAction(e){e?this.showUserList?this.currentPanel?"right"==this.currentListPosition&&this.addUserListAction("remove_list")||this.addUserListAction("remove_list_from_top"):"right"==this.currentListPosition||"hidden"==this.currentListPosition?this.addUserListAction("list_at_top"):this.addUserListAction("remove_list_from_top"):!this.currentPanel&&this.addUserListAction("add_list")||this.addUserListAction("add_list_at_top"):this.removeUserListAction()},openActionBar(){this.$store.commit("openActionBar")},minimize(e,t){this.$store.commit("minimize",e),this.track_event("minimize",1)},track_event(e,t){this.$store.dispatch("track_event",{action:"topBar",dimensions:e,eventValue:t})}},created(){window.addEventListener("beforeunload",this.beforeWindowUnload)},beforeDestroy(){window.removeEventListener("beforeunload",this.beforeWindowUnload)},template:e}}),define("DS/InstantMessagingCall/components/InvitationItem/InvitationItem",["text!DS/InstantMessagingCall/components/InvitationItem/InvitationItem.html","DS/InstantMessagingCall/components/ActionBar/ActionBar"],function(e,t){"use strict";return{components:{"im-call-bar":t},props:["room_id"],computed:{room(){return this.$store.getters.room(this.room_id)},isCaller(){return this.room.IamTheCaller},isMinimizedCall(){return this.$store.getters.isAccepted},labelArray(){if(this.room){if(this.$store.getters.roomName(this.room))return[this.$store.getters.roomName(this.room)];if(!this.room.IamTheCaller&&this.room.user&&this.room.user.username)return[this.room.user.username]}return this.$store.getters.called_users_name(this.room_id)},label(){return this.labelArray&&this.labelArray.toString().replaceAll(",",", ")},callerLogin(){return this.room&&this.room.user.login},subtitle(){return this.isMinimizedCall&&this.$store.getters.nls("ongoing")||this.isCaller&&this.$store.getters.nls("calling")||this.$store.getters.nls("incoming")},asDelegateOf(){return this.room&&this.room.room_id&&this.$store.getters.asDelegateOf(this.room.room_id)},simringWith(){return this.room&&this.room.room_id&&this.$store.getters.simringWith(this.room.room_id)},delegationMessage(){return!!this.asDelegateOf&&this.$store.getters.nls("invitedAsDelegate").replace("{username}",this.asDelegateOf.username)||!!this.simringWith&&1===this.simringWith.length&&this.$store.getters.nls("simringWith").replace("{username}",this.simringWith[0])||!!this.simringWith&&this.simringWith.length>1&&this.$store.getters.nls("simringWithDelegates")}},methods:{maximize(){this.$store.commit("minimize",!1),this.track_event("minimize",0)},track_event(e,t){this.$store.dispatch("track_event",{action:"topBar",dimensions:e,eventValue:t})}},template:e}}),define("DS/InstantMessagingCall/api/listeners_server",["DS/InstantMessagingCall/store/index"],function(e){"use strict";const t=function(e){return Object.assign({},e,{room_id:e.room_id||e.room&&e.room.room_id||e.data&&e.data.room_id,user_id:e.user_id||e.user&&e.user.user_id,login:e.login||e.user&&e.user.login})},i=["inviteSent","inviteReceived","callEnded","webrtcIceCandidate","SDP","callEvent","disconnected","connectTelWS"],r={base_url:null,connected(t={}){this.base_url=t.options.url,e.dispatch("connected",{clientDevice:t.clientDevice,devEnv:t.options.devEnv,tenant:t.options.platformId,user_id_myself:t.user_id,login_myself:t.userId,username_myself:t.username,appName:t.appName})},callAccepted(i){e.commit("webrtcConfig",function(e,t){if(e.webrtcConfig&&e.webrtcConfig.iceServers)for(var i=0;i<e.webrtcConfig.iceServers.length;i++)e.webrtcConfig.iceServers[i].urls=e.webrtcConfig.iceServers[i].url.replace("REPLACEMEWITHRTCDNS:3478",t+"/coturn"),e.webrtcConfig.iceServers[i].url=e.webrtcConfig.iceServers[i].url.replace("REPLACEMEWITHRTCDNS:3478",t+"/coturn");return e.webrtcConfig}(i,this.base_url)),e.commit("forceTURN",i.forceTURN),e.dispatch("accepted",t(i))}};for(let s of i)r[s]=function(i){return function(r){e.dispatch(i,t(r))}}(s);return r}),define("DS/InstantMessagingCall/components/InvitationList/InvitationList",["text!DS/InstantMessagingCall/components/InvitationList/InvitationList.html","DS/InstantMessagingCall/components/InvitationItem/InvitationItem"],function(e,t){"use strict";return{components:{"im-call-invitation-item":t},props:["rooms_id"],template:e}}),define("DS/InstantMessagingCall/api/interface",["DS/RTProxyDriver/RTProxyDriver","DS/InstantMessagingCall/api/listeners_server","DS/InstantMessagingCall/api/listeners_papi","DS/InstantMessagingCall/api/senders","DS/PlatformAPI/PlatformAPI","DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/desktop/interface"],function(e,t,i,r,s,o,a){"use strict";return{audiovideoV2:!1,init:function(r){return this.audiovideoV2=r.audiovideoV2,this.PlatformAPI=s,t.base_url=r.base_url,e.addEvent("CONNECTED",t.connected),e.addEvent("DISCONNECTED",t.disconnected),e.addEvent("inviteSent",t.inviteSent),e.addEvent("inviteToCall",t.inviteReceived),e.addEvent("callAccepted",t.callAccepted),e.addEvent("callEnded",t.callEnded),e.addEvent("webrtcIceCandidateReceived",t.webrtcIceCandidate),e.addEvent("SDPreceived",t.SDP),e.addEvent("callEvent",t.callEvent),e.addEvent("connectTelWS",t.connectTelWS),s.subscribe("towidgetim.ds.com",i),s.subscribe("im.ds.com",i),(o.getters.isDesktopApp||o.getters.isDevEnv)&&a.init(),s.publish("fromwidgetim.ds.com",{evenement:"GETLOGINOKDATA"}),this}}}),define("DS/InstantMessagingCall/components/Base/Base",["text!DS/InstantMessagingCall/components/Base/Base.html","DS/InstantMessagingCall/components/BaseLightbox/BaseLightbox","DS/InstantMessagingCall/components/InvitationList/InvitationList"],function(e,t,i){"use strict";return{components:{"im-call-base-lightbox":t,"im-call-base-invite":i},computed:{bodyAlerts(){return this.$store.getters.bodyAlerts},isEnded(){return this.$store.getters.isEnded},isInvited(){return this.$store.getters.isInvited},isAccepted(){return this.$store.getters.isAccepted},showInvite(){return this.$store.getters.showInvite},currentBaseComponent(){return this.isAccepted&&(this.$store.getters.minimized?"im-call-base-minimized":"im-call-base-lightbox")||this.isInvited&&"im-call-base-invite"}},template:e}}),define("DS/InstantMessagingCall/main",["DS/RTProxyDriver/RTLogger","vuejs","DS/InstantMessagingCall/components/Base/Base","DS/InstantMessagingCall/store/index","DS/InstantMessagingCall/api/interface","css!DS/InstantMessagingCall/InstantMessagingCall.css"],function(e,t,i,r,s){"use strict";e.addLevel("Call","purple"),e.Call("InstantMessagingCall load 10/2023 24xFD01 service 3.4.1");const o={divID:"vue-im-call",addDiv:function(t){return document.getElementById(this.divID)?e.Call("InstantMessagingCall div already injected"):t?(this.divCall=document.createElement("div"),this.divCall.id=this.divID,void t.appendChild(this.divCall)):e.Call("InstantMessagingCall needs a div container")},initVm:function(s={}){if(this.vmCall)return e.Call("InstantMessagingCall initVm already done");this.vmCall=new t({el:"#"+this.divID,data:()=>s,components:{"im-call-base":i},store:r,template:"<im-call-base id="+this.divID+" />"})},initTransport:function(e){this.interface=s.init(e)},initStore:function(e){r.commit("tenant",e.platformId),r.commit("appName",e.appName),r.commit("swymUrl",e.swymUrl),r.dispatch("preloadNoises"),r.dispatch("getCollaborationFeatures")}};return{init:function(e){return o.initStore(e),o.addDiv(e.callContainer||document.body),o.initVm(e),o.initTransport(e),document.IMCall=document.IMCall||o,document.IMCall}}});