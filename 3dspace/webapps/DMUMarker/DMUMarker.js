define("DS/DMUMarker/DMUMarkerTextCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DText","DS/DMUPlayMarker/DMUMarker3DStamp","DS/DMUPlayMarker/DMUMarker2DText","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUI/DMUToolsUsers","DS/Utilities/TouchUtils","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/DMUBaseUIServices/DMUObjectsServices","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,i,r,a,o,s,l,c,d,u,m,h,g,D,p){"use strict";return t.extend({init:function(t){let M,f,v="markerTextCmdHdr"===t.ID||"DMUCreateRejectedMkrHdr"===t.ID||"DMUCreateValidatedMkrHdr"===t.ID?"3D":"2D",S="DMUCreateRejectedMkrHdr"===t.ID||"DMUCreateValidatedMkrHdr"===t.ID,C=this,y=null,U=!1,P=!0,w="Validated",x="Rejected";function b(){y.fireEvent("onDMUObjectInitialized",{dmuObject:y}),C.addInCSO(y),P&&!m.getTouchMode()&&y.startEdition(),C._endExecute()}function k(){var e=null;if(C._clickEventData&&C._clickEventData.from&&C._clickEventData.from.length){var t=M.getMousePosition(C._clickEventData.from[0].getCurrentPosition(M.canvas)),n=M.pick(t,"primHybrid",!0);n&&n.path.length&&(e=n.path[0])}return e}function E(d,E){var A=d[0].position,F="3D"===v?r.getWindowPositionFromPoint(M,A,C._frmWindow):r.getViewerPositionFromPoint(M,A),I=r.getDistanceFromPixel(M,A,100,C._frmWindow);F.top<100&&(I=-I);var T,_=r.getViewpointInfo(M.currentViewpoint).up.clone().multiplyScalar(I),L=A.clone().add(_);if(E&&(L=E),f||(f=new c(M)),f.createHVAxis(A,{key:"Shift",keyCode:16},t.dragEventCallback),f.activate(),"3D"===v)T=A.clone();else{var V=r.getViewerPositionFromPoint(M,A);T=[new i.Vector2(V.left,V.top)]}var H=a.getReviewContext({viewer:C.getFrameWindow().getViewer()}),B=H.getCurrentSessionMarkup();let O;y=!1===S?"3D"===v?new o(M,B):new l(M,B):new s(M,B),S&&((O="DMUCreateRejectedMkrHdr"===t.ID?x:w)||(O="DMUCreateRejectedMkrHdr"===t.ID?D.defaultRejectedStampLabel:D.defaultValidatedStampLabel)),y.setAttributes([{name:"sID",value:B.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:B.computeNewName({object:y,prefix:"3D"===v?p.text3DPrefix:p.text2DPrefix})},{name:"sTextContents",value:S?[O]:[p.markertext.standard]},{name:"lLeaderPointingPoints",value:"3D"===v?[C.getRelativePosition(T)]:T},{name:"bHasALeader",value:"3D"===v},{name:"sLeaderEndType",value:"Arrow"},{name:"cLineStyleColor",value:new i.Color("#afafaf")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!0},{name:"fFontSize",value:4.23},{name:"fBorderRadius",value:!0===S?0:4},{name:"fPointedPageNumber",value:C.getPageNumber()},{name:"sPointedElementID",value:C.getElementId(T)}]),"3D"===v?y.setAttribute("vLeaderBreakPoint3D",C.getRelativePosition(L)):y.setAttribute("vLeaderBreakPoint2D",T[0]),!0===S&&y.setAttributes([{name:"sOwner",value:u.getUserLogin()},{name:"sStampType",value:"DMUCreateRejectedMkrHdr"===t.ID?"Rejected":"Validated"},{name:"lTextComment",value:[""]},{name:"fCreationDate",value:Date.now()}]);var R=B.getCurrentSlide();if(R.addDMUObject(y),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command",(S?"CreateStamp":"CreateText")+v+R.getType())}),P=!0,"3D"===v){var W=!0,N=k();if(N&&(W=!1),!N&&d[0].pathElement?N=d[0].pathElement:!N&&C._selectedPathElement&&void 0!==E&&(N=C._selectedPathElement),N){if(n.isAPOIPath(N)){const{position:e,label:t}=g.getPOIInformationFromPathElement(N);e&&y.setAttributes([{name:"lLeaderPointingPoints",value:[e]},{name:S?"lTextComment":"sTextContents",value:[t||(S?O:p.markertext.standard)]}])}var j=function(e){return!(!(e&&e.getLastElement(!0)&&e.getLastElement(!0).getDMUType)||"DMUSection"!==e.getLastElement(!0).getDMUType()&&"DMUClipping"!==e.getLastElement(!0).getDMUType())||!!e.getParentPath()&&j(e.getParentPath())};if(W&&j(N)&&(N=k()),N){let e="";if(N.internalPath.length){let t=[],n=h.giveDMUApplicativeContextManager({context:a.getContextViewer({viewer:C.getFrameWindow().getViewer()})});if(n){var z=n.getApplicativeControllers();if(z&&z.length)for(let e=0;e<=z.length;e++)if(z[e]&&z[e].getFeatureInformation){let n=z[e].getFeatureInformation(N);n&&n.name&&t.push(n.name)}1===t.length&&t[0]&&(e=t[0],y.setAttribute(!0===S?"lTextComment":"sTextContents",[e]),y.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:y}))}}if(!e){var X=n.getLastReference(N);if(X){var q=X.getLastElement(!0);q&&(q.associatedMarkers||(q.associatedMarkers=[]),q.associatedMarkers.push(y),P=!1,n.getName([q],function(e){if(e&&1===e.length&&e[0]){var t=e[0].slice();let i;if(t&&q.associatedMarkers&&q.associatedMarkers.length&&q.userData&&"Requirement Specification"!==q.userData.type){for(var n=0;n<q.associatedMarkers.length;n++)q.associatedMarkers[n]&&(q.associatedMarkers[n].setAttribute(-1!==q.associatedMarkers[n].getType().indexOf("Stamp")?"lTextComment":"sTextContents",[t]),q.associatedMarkers[n].fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:q.associatedMarkers[n]}),i=q.associatedMarkers[n]);q.associatedMarkers=void 0,i&&i.startEdition&&!m.getTouchMode()&&i.startEdition(),M.render()}}},a.getContextViewer({reviewContext:H}),""))}}}}}U||b()}a.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(y){var t=r.getViewerPositionFromPoint(M,e.vCurrentPosition);if(t=r.get2DSnappedPosition(new i.Vector2(t.left,t.top)),e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey){var n=r.getViewerPositionFromPoint(M,e.vStartPosition);Math.abs(t.y-n.top)>=Math.abs(t.x-n.left)?t.setX(n.left):t.setY(n.top)}if("3D"===v){let n=C.getElementId(e.vCurrentPosition);y.setAttribute("vLeaderBreakPoint3D",C.getRelativePosition(r.getPositionFromIntersection(M,t,e.vCurrentPosition),n))}else y.setAttribute("vLeaderBreakPoint2D",t);y.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:y})}else U=!0,E([{position:e.vStartPosition}],e.vCurrentPosition);f.updateManipulationData(e),e.bLastUpdate&&b()},this.clean=function(){f&&f.remove(),U=!1,y=null};let A=this.beginExecute;this.beginExecute=function(){var e=a.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(S&&d.readPreferences([{Repository:"DMURepository",PreferenceNames:["MarkerValidatedStampLabel","MarkerRejectedStampLabel"]}]).then(e=>{let t=e.repositories[0].preferences;for(let e=0;e<t.length;e++)"MarkerValidatedStampLabel"===t[e].name?w=t[e].value:"MarkerRejectedStampLabel"===t[e].name&&(x=t[e].value)}).catch(e=>{window.console.warn("Could not get server value, default value set instead.",e)}),A.call(this),this.done()):this._endExecute()},this._parent(t,function(e){U||y||E(e)},p.textPositionLabel,{},!0),M=this.getFrameWindow().getViewer()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})}),define("DS/DMUMarker/DMUMarkerCloudShapePreview",["require","exports","UWA/Core","DS/Visualization/ThreeJS_DS","DS/DMUBaseUIServices/DMUObjectsServices"],function(e,t,n,i,r){"use strict";return class{constructor(e){let t,a,o,s={lineCap:"round",lineJoin:"round",lineStyleOpacity:1,lineStyleColor:new i.Color(13371695),lineStyleThicknessIndex:4},l=[];function c(){let n=e.viewerFrame.getDimensions();t.width=n.width,t.height=n.height}function d(){a&&(a.lineCap=s.lineCap,a.lineJoin=s.lineJoin,a.globalAlpha=s.lineStyleOpacity,a.strokeStyle=s.lineStyleColor.getStyle(),a.fillStyle=s.lineStyleColor.getStyle(),a.lineWidth=r.getLineThickness(s.lineStyleThicknessIndex))}function u(e,t){return{x:t.x-e.x,y:t.y-e.y}}this.startPreview=function(){if(!t||!a){let i=e.uiFrame;t=new n.Element("canvas",{id:"CloudPreviewCanvas",styles:{zIndex:"2000",pointerEvents:"none",position:"absolute",top:0,left:0}}).inject(i);let r=e.viewerFrame,o=r.getDimensions();r.addEvent("resize",c),t.width=o.width,t.height=o.height,a=t.getContext("2d"),d()}},this.refreshPreview=function(){t&&a&&(a.clearRect(0,0,t.width,t.height),l.length=0,o=0)},this.destroy=function(){l.length=0,o=0,a&&t&&(e.viewerFrame.removeEvent("resize",c),a.clearRect(0,0,t.width,t.height),a=null,t.remove(),t=null)},this.updatePreview=function(e,n){if(t&&a){if(!l.length)return d(),void l.push(e);if(n?(o||(o=l.length),l[o]=e):(l[l.length-1].x!==e.x&&l[l.length-1].y!==e.y&&l.push(e),o=l.length),l.length>1){a.clearRect(0,0,t.width,t.height);const e=15;let n,i,r=function(e){const t=e.length;let n=0,i=0;for(const t of e)n+=t.x,i+=t.y;return{x:n/t,y:i/t}}(l),o=function(e,t,n){const i=u(e,t),r=u(e,n),a=(s=r,(o=i).x*s.y-o.y*s.x);var o,s;return a>0?1:a<0?-1:0}(l[0],l[1],r);for(let t=0,r=1;t<l.length-1;t++,r++){let s,c,d,u=l[t].x,m=l[r].x,h=l[t].y,g=u,D=h,p=m-u,M=l[r].y-h,f=Math.sqrt(p*p+M*M)/(1.6*e),v=f-Math.floor(f),S=Math.atan2(M,p);2===l.length||o>0?(c=1.2,d=1.9,s=!1):(c=.9,d=.2,s=!0);for(let r=0;r<f;r++){g=u+e*r*Math.cos(S)*1.6,D=h+e*r*Math.sin(S)*1.6;let o=0===r&&t>0,m=r===Math.ceil(f-1)&&t!==l.length-2,p=c*Math.PI+S,M=d*Math.PI+S;if(o&&i&&n){let e;e=i<=.3?.42:i>.3&&i<.6?.28:.14,p=s?p-e*Math.PI-S+n:p+e*Math.PI-S+n}else if(m){let e;e=v<=.3?.3:v>.3&&v<.6?.2:.1,M=s?M+e*Math.PI:M-e*Math.PI}a.beginPath(),a.arc(g,D,e,p,M,s),a.stroke(),n=S,i=v}}}}},this.getPreviewPoints=function(){return l}}}}),define("DS/DMUMarker/DMUMarkerExport",["require","exports","DS/DMUPlayMarker/DMUMarker3DText","DS/DMUPlayMarker/DMUMarker3DPicture","DS/DMUPlayMarker/DMUMarker3DRectangle","DS/DMUPlayMarker/DMUMarker3DEllipse","DS/DMUPlayMarker/DMUMarker3DSpline","DS/DMUPlayMarker/DMUMarker3DFreehand","DS/DMUPlayMarker/DMUMarker3DCloud","DS/DMUPlayMarker/DMUMarker3DCircle","DS/DMUPlayMarker/DMUMarker3DArrow","DS/DMUPlayMarker/DMUMarker3DLine","DS/DMUPlayMarker/DMUMarker3DPoint","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers"],function(e,t,n,i,r,a,o,s,l,c,d,u,m,h,g,D){"use strict";const p={1:[],2:[2,2],3:[3,1],4:[3,2,1,2],5:[6,2,2,2,2,2],6:[1,1],7:[2,1,12,1]};class M{static getCommentExportDefinition(e,t){return new Promise(n=>{(async()=>{const i=e.getAttribute("sOwner")||"";let r=t?await D.getUserName(i):i,a={id:e.getAttribute("sUuid")||"",content:(e.getAttribute("sTextContents")||[""]).join("\n"),owner:r,creationDate:new Date(e.getAttribute("fCreationDate")||Date.now()),lastModificationDate:new Date(e.getAttribute("fLastModificationDate")||Date.now())};n(a)})()})}static getExportDefinition(e,t){return new Promise((D,f)=>{(async()=>{let v,S=e.getPointedPosition(),C=e.getAttribute("sUuid")||"",y=e.getAttribute("bVisible")||!1;if(e instanceof r){let t=e.getAttribute("fWidth")||0,n=e.getAttribute("fHeight")||0;v={id:C,visible:y,type:e.getType(),position:{x:S.x,y:S.y},width:t,height:n,rotationAngle:e.getAttribute("fRotationAngle")}}else if(e instanceof n&&"Marker3DText"===e.getAttribute("sType")){let t,n=e.getAttribute("sTextContents"),i=e.getAttribute("bHasALeader"),r=e.getAttribute("bHasBorder"),a=e.getAttribute("sLeaderEndType"),o=e.getAttribute("vLeaderBreakPoint3D"),s=e.getAttribute("lLeaderPointingPoints"),l=e.getNode().getLabelDimensions(),c=e.getNode().getRepNode().leader.getChildren()[0].getChildren(),d=h.getRelativePosition(e,c[0]._initialPoint);t=1===c.length?d:h.getRelativePosition(e,c[1]._finalPoint);let u=e.getAttribute("sFontName"),m=e.getAttribute("fFontSize"),g=e.getAttribute("sFontStyle"),D=e.getAttribute("sLineStylePattern"),p=e.getAttribute("fLineStyleThicknessIndex"),M=p?h.getLineThickness(p):e.getAttribute("fLineStyleThickness"),f=[];"Arrow"===a&&(a="OpenArrow"),s&&s.length&&(f.push(s[0].x),f.push(s[0].y)),o&&(f.push(o.x),f.push(o.y),f.push(d.x),f.push(d.y),f.push(t.x),f.push(t.y)),v={id:C,visible:y,type:"DMUMarker3DText",position:{x:S.x,y:S.y},textContent:n||[""],hasLeader:i||!1,hasBorder:r||!1,offheight:l.offsetHeight,offwidth:l.offsetWidth,height:l.height,width:l.width,leaderEndType:a||"OpenArrow",leaderPosition:f,fontName:u||"",fontSize:m||1,fontColor:e.getAttribute("cFontColor"),fontStyle:g||"",borderColor:e.getAttribute("cLeaderStyleColor"),lineType:D||"",lineThickness:M||1,rotationAngle:e.getAttribute("fBoxRotationAngle")}}else if(e instanceof i&&"Marker3DPicture"===e.getAttribute("sType")){let t=e.getAttribute("bHasALeader"),n=e.getAttribute("sLeaderEndType"),i=e.getAttribute("vLeaderBreakPoint3D"),r=e.getAttribute("lLeaderPointingPoints"),a=e.getAttribute("fImageWidth"),o=e.getAttribute("fImageHeight"),s=e.getAttribute("sImageData"),l=e.getAttribute("fLineStyleThicknessIndex"),c=e.getAttribute("sLineStylePattern"),d=h.getLineThickness(l||1)||e.getAttribute("fLineStyleThickness"),u=[];"Arrow"===n&&(n="OpenArrow"),r&&r.length&&(u.push(r[0].x),u.push(r[0].y)),i&&r&&a&&(r[0].x<i.x?(u.push(i.x-a/3),u.push(i.y),u.push(i.x-a/4),u.push(i.y)):(u.push(i.x+a/3),u.push(i.y),u.push(i.x+a/4),u.push(i.y)),u.push(i.x),u.push(i.y)),v={id:C,visible:y,type:"DMUMarker3DPicture",position:{x:S.x,y:S.y},hasLeader:t||!1,offheight:o||1,offwidth:a||1,height:o||1,width:a||1,imagedata:s||"",leaderEndType:n||"OpenArrow",leaderPosition:u,borderColor:e.getAttribute("cLeaderStyleColor"),linetype:c||"",linethickness:d||1}}else if(e instanceof c){let t=e.getAttribute("fRadius")||0;v={id:C,visible:y,type:e.getType(),position:{x:S.x,y:S.y},radius:t}}else if(e instanceof a){let t=e.getAttribute("fxAxisLength")||0,n=e.getAttribute("fyAxisLength")||0;v={id:C,visible:y,type:e.getType(),position:{x:S.x,y:S.y},rotationAngle:e.getAttribute("fRotationAngle"),xLength:t,yLength:n}}else if(e instanceof u){let t=e.getPoints()[1].getAttribute("vPosition");v={id:C,visible:y,type:e.getType(),points:{start:{x:S.x,y:S.y},end:{x:t.x,y:t.y}}}}else if(e instanceof o){let t=[],n=e.getPoints(),i=e.getManipulationData(),r=e.getAttribute("fRotationAngle"),a=h.getRelativePosition(e,i.position);n&&n.forEach(e=>{if(e instanceof m){let n=e.getAttribute("vPosition");if(r){let e=n.sub(a);t.push({x:e.x*Math.cos(r)-e.y*Math.sin(r)+a.x,y:e.x*Math.sin(r)+e.y*Math.cos(r)+a.y})}else t.push({x:n.x,y:n.y})}}),v={id:C,visible:y,type:e.getType(),rect:{width:i.width,height:i.height},position:{x:a.x,y:a.y},rotationAngle:i.rotation,points:t}}else if(e instanceof s){let t=[],n=e.getPoints(),i=e.getManipulationData(),r=e.getAttribute("fRotationAngle"),a=h.getRelativePosition(e,i.position);n&&n.forEach(e=>{if(e instanceof m){let n=e.getAttribute("vPosition");if(r){let e=n.sub(a);t.push({x:e.x*Math.cos(r)-e.y*Math.sin(r)+a.x,y:e.x*Math.sin(r)+e.y*Math.cos(r)+a.y})}else t.push({x:n.x,y:n.y})}}),v={id:C,visible:y,type:"DMUMarker3DFreehand",rect:{width:i.width?i.width:1,height:i.height?i.height:1},position:{x:a.x,y:a.y},rotationAngle:i.rotation,points:t}}else if(e instanceof l){let t=[],n=e.getPoints(),i=e.getManipulationData().boundingBoxDimensions,r=e.getAttribute("fRotationAngle"),a=h.getRelativePosition(e,i.position);n&&(n.forEach(e=>{if(e instanceof m){let n=e.getAttribute("vPosition");if(r){let e=n.sub(a);t.push({x:e.x*Math.cos(r)-e.y*Math.sin(r)+a.x,y:e.x*Math.sin(r)+e.y*Math.cos(r)+a.y})}else t.push({x:n.x,y:n.y})}}),t.push({x:t[0].x,y:t[0].y})),v={id:C,visible:y,type:"DMUMarker3DCloud",rect:{width:i.width,height:i.height},position:{x:a.x,y:a.y},rotationAngle:i.rotation,points:t}}else if(e instanceof d){let t=e.getNode().getArrowSpecs(),n=e.getAttribute("vSecondPoint"),i=n.clone().sub(S),r=Math.acos(i.x/Math.sqrt(i.x*i.x+i.y*i.y))*Math.sign(i.y),a=Math.cos(r),o=Math.sin(r);v={id:C,visible:y,type:e.getType(),pointing:{x:S.x,y:S.y},ending:{x:n.x,y:n.y},points:t.coordinates.map(e=>({x:S.x+(e.x*a-e.y*o),y:S.y+(e.x*o+e.y*a)}))}}if(v){let i=g.getMMPerPixelRatio(e.getViewer(),S),r=p[e.getAttribute("sLineStylePattern")||1],a=r?r.map(e=>6*e*i):[],c={definition:v,pageNumber:e.getAttribute("fPointedPageNumber")||1,material:{fill:e.getAttribute("bIsFilled")?{color:e.getAttribute("cFillStyleColor"),opacity:e.getAttribute("fOpacity")||1}:void 0,border:e.getAttribute("bHasBorder")||e instanceof u||e instanceof o||e instanceof s||e instanceof l||e instanceof n?{color:e.getAttribute("cLineStyleColor"),thickness:h.getLineThickness(e.getAttribute("fLineStyleThicknessIndex"),"mm")||h.convertLineThickness(e.getAttribute("fLineStyleThickness"),"mm")||0,pattern:a,opacity:e.getAttribute("fLineStyleOpacity")||1}:void 0}},d=e.getDMUComments();if(d.length){c.comments=[];for(let e=0;e<d.length;e++){let n=await M.getCommentExportDefinition(d[e],t);c.comments.push(n)}}return D(c)}f(new Error("This type cannot be exported"))})()})}}return M}),define("DS/DMUMarker/DMUMarkerPictureCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUControls/EXPSnapshotControl","DS/DMUControls/EXPFileBrowser","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPUtils","DS/StateCommandEngine/PathElementAgent","DS/CoreEvents/Events","DS/ApplicationFrame/ContextualBar","DS/DMUPlayMarker/DMUMarker3DPicture","DS/DMUPlayMarker/DMUMarker2DPicture","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,i,r,a,o,s,l,c,d,u,m,h,g,D){"use strict";var p,M,f,v=t.extend({init:function(e){this.markerType="markerPictureCmdHdr"===e.ID?"3D":"2D",m.setAuthoringFeatureTypes("Marker"),e.dragEventCallback=function(e){},this._parent(e,"exclusive",D.picturePositionLabel,{},!0)},initiateCmd:function(){var e=m.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?this._parent():this.cancel()},cancelExecute:function(){this._cleanData&&this._cleanData(),this.cancel()},buildGraph:function(){let t,v;function S(e){M.sendNotify("error",e,3e3)}function C(t){if(t.img){let y=o.convertImageDataUrl(t.img.src);if(y&&y.type&&y.data){var i=m.getReviewContext({viewer:M.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),r=t.img.width,s=t.img.height;r>300&&(s=300*s/r,r=300),s>300&&(r=300*r/s,s=300),r=Math.round(r),s=Math.round(s);var l=v,c="3D"===M.markerType?n.getWindowPositionFromPoint(M._viewer,l,M._frmWindow):n.getViewerPositionFromPoint(M._viewer,l),h=n.getDistanceFromPixel(M._viewer,l,r,M._frmWindow);c.top<r&&(h=-h);var g,p=n.getViewpointInfo(M._viewer.currentViewpoint).up.clone().multiplyScalar(h);if(l=l.clone().add(p),"3D"===M.markerType)g=v.clone();else{var f=n.getViewerPositionFromPoint(M._viewer,v);g=[new a.Vector2(f.left,f.top)]}var S="3D"===M.markerType?new d(M._viewer,i):new u(M._viewer,i);S.setAttributes([{name:"sID",value:i.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:i.computeNewName({object:S,prefix:"3D"===M.markerType?D.picture3DPrefix:D.picture2DPrefix})},{name:"lLeaderPointingPoints",value:"3D"===M.markerType?[M.getRelativePosition(g)]:g},{name:"sTextContents",value:[t.name?t.name:""]},{name:"sImageType",value:y.type},{name:"sImageData",value:y.data},{name:"bHasALeader",value:"3D"===M.markerType},{name:"sLeaderEndType",value:"Arrow"},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"fFontSize",value:3.5},{name:"fBorderRadius",value:4},{name:"bShortDisplay",value:!0},{name:"fCreationDate",value:Date.now()},{name:"fImageWidth",value:"3D"===M.markerType?n.convertPixelToModel({sizeInPixels:r,viewer:M._viewer}):r},{name:"fImageHeight",value:"3D"===M.markerType?n.convertPixelToModel({sizeInPixels:s,viewer:M._viewer}):s},{name:"fPointedPageNumber",value:M.getPageNumber()},{name:"sPointedElementID",value:M.getElementId(g)}]),"3D"===M.markerType?S.setAttribute("vLeaderBreakPoint3D",M.getRelativePosition(l)):S.setAttribute("vLeaderBreakPoint2D",g[0]);var C=i.getCurrentSlide();C.addDMUObject(S),S.fireEvent("onDMUObjectInitialized",{dmuObject:S}),M.addInCSO(S),o._sendUsageProbe("command","CreatePicture"+M.markerType+C.getType())}}}f="browser",(M=this).changeDefaultController(),M.initiateCmd();var y=new r({onFileLoadedCB:function(e){C(e),M._cleanData()},onErrorCB:function(){M._cleanData(),S(D.markerpicture.FileBrowserInvalidFile)}}),U=new s({agentId:"_pathElementAgent",frameWindow:M._frmWindow});function P(){M.options.executionContext&&(M._frmWindow=M.options.executionContext.getComponent("Viewer").getFrameWindow());var e,t=m.getContextViewer({reviewContext:m.getReviewContext({viewer:M.getFrameWindow().getViewer()})});v&&(e=M._frmWindow.getViewer().currentViewpoint.project(v));let n=[{name:"DMUImportPictureFromFileStr",line:1,hdr_list:["DMUImportPictureFromFileHdr"],type:"handler",identifier:"DMUImportPictureFromFileHdr"},{name:"DMUCreateSnapshotStr",line:1,hdr_list:["DMUCreateSnapshotHdr"],type:"handler",identifier:"DMUCreateSnapshotHdr"},{name:"DMUCancelPictureCmdStr",line:1,hdr_list:["DMUCancelPictureCmdHdr"],type:"handler",identifier:"DMUCancelPictureCmdHdr"}],i=M._frmWindow.getExecutionContext?{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:n}}},subscriberId:"DMUCreatePictureCtxCmds",merge:!0,workbenchName:"DMUCreatePictureCtxCmds",module:"DMUMarker",context:t.getCommandContext(),cmdPrefix:"",fileName:"DMUCreatePictureCtxCmds.xml"}:[{onContextualBarReady:function(){return{cmdList:n}},workbenchName:"DMUCreatePictureCtxCmds",module:"DMUMarker",context:t.getCommandContext(),cmdPrefix:"",fileName:"DMUCreatePictureCtxCmds.xml"}];var r={subscribersOptions:i,viewerFrame:M._frmWindow.getViewer(),uiFrame:M._frmWindow.getUIFrame(),Xposition:e.x,Yposition:e.y,hideWithDistance:!1};M._frmWindow.getExecutionContext?(M._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().register(i),M._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager()._showContextualBar(r)):c.show(r),M.sendNotify("info",D.markerpicture.notifypicturesource)}this._cleanData=function(){y&&y.cleanFileBrowser(),M.cleanNotify(),c.hide(),p&&clearInterval(p),c.hide(),y=U=t=v=null,M.__endExecute()};var w=function(e){C(e),M._cleanData()},x=function(){M._cleanData()},b=function(){S(D.markerpicture.onSnaphotErrorMsg)},k=function(e){"webcam"===f?t=new i({immersiveFrame:M._frmWindow.getImmersiveFrame(),onValidateSnapshotCB:w,onCloseSnapshotCB:x,onErrorCB:b}):"browser"===f&&(y.openFileBrowser(),setTimeout(function(){if(M.isRunning())var e=l.subscribe({event:"/VISU/"},function(){l.unsubscribe(e),M._cleanData()})},100)),M._frmWindow.getExecutionContext&&M._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().unregister("DMUCreatePictureCtxCmds"),M.end(),e()},E=this.createInitialState("selectGeometryState");this.setEnterStateAction(E,function(){M._frmWindow.getViewerFrame().setStyle("cursor","crosshair"),M.sendNotify("info",D.markerpicture.notifypictureposition)}),this.setExitStateAction(E,function(){M._frmWindow.getViewerFrame().setStyle("cursor","auto"),M.cleanNotify()});var A=this.createState("selectOriginState"),F=this.createState("captureSnapshotState"),I=this.getFinalState();navigator.userAgent&&(-1!==navigator.userAgent.search("Chrome")||-1!==navigator.userAgent.search("Firefox"))&&(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)?(this.setPictureCreationChoice=function(e){f=e,c.hide(),p&&clearInterval(p),p=setInterval(function(){M.isRunning()&&(clearInterval(p),M.publish({event:f?"contextBarOK":"contextBarCancel",data:null}))},10)},this.setEnterStateAction(A,P),this.setExitStateAction(A,function(){M.cleanNotify()}),this.addTransition({iEvent:U,iInitialState:E,iFinalState:A,iAction:function(e,t){v=null;const n=t[0].pathElement||M._selectedPathElement;if(g.isAPOIPath(n)){const{position:e}=h.getPOIInformationFromPathElement(n);e&&(v=e)}v||(v=t[0].position.clone()),e()}}),this.addEmptySelectionTransition(E,A,function(e,t){var n=M.computeEmptySelectionInformation(t);v=n[0].position.clone(),e()}),this.addTransition({iEvent:U,iInitialState:A,iFinalState:A,iAction:function(e,t){v=t[0].position.clone(),P(),e()}}),this.addEmptySelectionTransition(A,A,function(e,t){var n=M.computeEmptySelectionInformation(t);v=n[0].position.clone(),P(),e()})):(f="browser",this.addTransition({iEvent:U,iInitialState:E,iFinalState:I,iAction:function(e,t){v=null;const n=t[0].pathElement||M._selectedPathElement;if(g.isAPOIPath(n)){const{position:e}=h.getPOIInformationFromPathElement(n);e&&(v=e)}v||(v=t[0].position.clone()),k(e)}}),this.addEmptySelectionTransition(E,I,function(e,t){var n=M.computeEmptySelectionInformation(t);v=n[0].position.clone(),k(e)})),this.addTransition({iSender:this,iEvent:"contextBarOK",iInitialState:A,iFinalState:I,iAction:function(e){k(e)}}),this.addTransition({iSender:this,iEvent:"contextBarCancel",iInitialState:A,iFinalState:I,iAction:function(e){M._frmWindow.getExecutionContext&&(M._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().getContextualBar().hide(),M._frmWindow.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().unregister("DMUCreatePictureCtxCmds")),this._cleanData(),e()}}),this.addTransition({iSender:this,iEvent:"ActionOK",iInitialState:F,iFinalState:I,iAction:function(e){this._cleanData(),e()}})}});return v.setNewPictureCreationChoice=function(e,t){f=t&&t.args?t.args.Choice:null,t.executionContext&&t.executionContext.getComponent(WAfrStandardComponentKey.UIComponent).getContextualUIComponentManager().getContextualBar().hide(),p&&clearInterval(p),p=setInterval(function(){clearInterval(p),M.publish({event:f?"contextBarOK":"contextBarCancel",data:null})},10),e()},v}),define("DS/DMUMarker/DMUMarkerCircleCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DCircle","DS/DMUPlayMarker/DMUMarker2DCircle","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,i,r,a,o,s,l,c){"use strict";return t.extend({init:function(t){var d,u="markerCircleCmdHdr"===t.ID?"3D":"2D",m=this,h=null,g=!1;function D(){h.fireEvent("onDMUObjectInitialized",{dmuObject:h}),m.addInCSO(h),m._endExecute()}function p(t,p){var M,f=r.getReviewContext({viewer:m.getFrameWindow().getViewer()}),v=f?f.getCurrentSessionMarkup():null,S=t[0].position,C=p?S.clone().sub(p).length():100;if("3D"===u){const e=t[0].pathElement||m._selectedPathElement;if(l.isAPOIPath(e)){const{position:t}=s.getPOIInformationFromPathElement(e);t&&(M=t)}M||(M=S.clone())}else{var y=n.getViewerPositionFromPoint(d,S);M=new i.Vector2(y.left,y.top)}(h="3D"===u?new a(d,v):new o(d,v)).setAttributes([{name:"sID",value:v.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:v.computeNewName({object:h,prefix:"3D"===u?c.circle3DPrefix:c.circle2DPrefix})},{name:"vCenter",value:m.getRelativePosition(M)},{name:"fRadius",value:"3D"===u?n.getDistanceFromPixel(d,S,C,m._frmWindow):C},{name:"cLineStyleColor",value:new i.Color("#cc092f")},{name:"cFillStyleColor",value:new i.Color("#cc092f")},{name:"fLineStyleThicknessIndex",value:4},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0},{name:"fPointedPageNumber",value:m.getPageNumber()},{name:"sPointedElementID",value:m.getElementId(M)}]);var U=v.getCurrentSlide();U.addDMUObject(h),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateCircle"+u+U.getType())}),g||D()}r.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(h){var t=e.vStartPosition.clone(),r=m.getElementId(t),a=m.getAbsolutePosition(n.getPositionFromIntersection(d,m.getRelativePosition(e.vCurrentPosition,r),m.getRelativePosition(e.vCurrentPosition,r),!0),r);if("2D"===u){var o=n.getViewerPositionFromPoint(d,t);t=new i.Vector2(o.left,o.top),o=n.getViewerPositionFromPoint(d,a),a=new i.Vector2(o.left,o.top)}var s=t.sub(a);h.setAttributes([{name:"fRadius",value:Math.max(0,s.length())}]),h.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:h})}else g=!0,p([{position:e.vStartPosition}],e.vCurrentPosition);e.bLastUpdate&&D()},this.clean=function(){g=!1,h=null},this._parent(t,function(e){g||h||p(e)},c.circlePositionLabel,{},!0),d=this.getFrameWindow().getViewer()},beginExecute:function(){var e=r.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)||this._endExecute(),this._parent(),this.done()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})}),define("DS/DMUMarker/DMUMarkerRectangleCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarker3DRectangle","DS/DMUPlayMarker/DMUMarker2DRectangle","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,i,r,a,o,s,l,c,d){"use strict";return t.extend({init:function(t){var u,m,h="DMU3DRectangleCmdHdr"===t.ID?"3D":"2D",g=this,D=null,p=!1;function M(){let e=D.getAttribute("vPosition");D.setAttributes([{name:"vPosition",value:g.getRelativePosition(e)},{name:"sPointedElementID",value:g.getElementId(e)},{name:"fPointedPageNumber",value:g.getPageNumber()}]),D.fireEvent("onDMUObjectInitialized",{dmuObject:D}),g.addInCSO(D),g._endExecute()}function f(f,v){var S=o.getReviewContext({viewer:g.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),C=f[0].position;m||(m=new s(u)),m.addToListener("Control",t.dragEventCallback),m.addToListener("Shift",t.dragEventCallback),m.activate();var y,U=200,P=160,w=C.clone(),x=v;if("3D"===h){if(x){y=(new i.Plane).setFromNormalAndCoplanarPoint(u.currentViewpoint.getSightDirection(),C).projectPoint(x);var b=u.currentViewpoint.getUpDirection(),k=(new i.Vector3).crossVectors(b,u.currentViewpoint.getSightDirection());P=y.dot(b)-C.dot(b),U=y.dot(k)-C.dot(k),w=(new i.Vector3).addVectors(y,C).multiplyScalar(.5)}const e=f[0].pathElement||g._selectedPathElement;if(c.isAPOIPath(e)){const{position:t}=l.getPOIInformationFromPathElement(e);t&&(w=t)}}else{var E=n.getViewerPositionFromPoint(u,C);if(w=new i.Vector2(E.left,E.top),x)E=n.getViewerPositionFromPoint(u,x),U=2*(y=new i.Vector2(E.left,E.top).clone().sub(w)).x,P=2*y.y;else P=160,U=200}U="3D"===h?n.getDistanceFromPixel(u,C,200,g._frmWindow):U,P="3D"===h?n.getDistanceFromPixel(u,C,160,g._frmWindow):P,U=Math.abs(U),P=Math.abs(P),(D="3D"===h?new r(u,S):new a(u,S)).setAttributes([{name:"sID",value:S.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:S.computeNewName({object:D,prefix:"3D"===h?d.rectangle3DPrefix:d.rectangle2DPrefix})},{name:"vPosition",value:w},{name:"fWidth",value:U},{name:"fHeight",value:P},{name:"cLineStyleColor",value:new i.Color(13371695)},{name:"fLineStyleThicknessIndex",value:3},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0}]);var A=S.getCurrentSlide();A.addDMUObject(D),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateRectangle"+h+A.getType())}),p||M()}t.dragEventCallback=function(e){if(D){var t,r,a,o,s=g.getElementId(e.vStartPosition.clone()),d=g.getAbsolutePosition(n.getPositionFromIntersection(u,g.getRelativePosition(e.vCurrentPosition,s),g.getRelativePosition(e.vCurrentPosition,s),!0),s);if("2D"===h){var v=n.getViewerPositionFromPoint(u,e.vStartPosition);o=new i.Vector2(v.left,v.top),v=n.getViewerPositionFromPoint(u,e.vCurrentPosition),t=2*(a=new i.Vector2(v.left,v.top).sub(o)).x,r=2*a.y}else{var S=e.ctrlKey||void 0===e.ctrlKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.ctrlKey,C=e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey;a=(new i.Plane).setFromNormalAndCoplanarPoint(u.currentViewpoint.getSightDirection(),e.vStartPosition).projectPoint(d);var y=u.currentViewpoint.getUpDirection(),U=(new i.Vector3).crossVectors(y,u.currentViewpoint.getSightDirection());if(C){var P=a.dot(y)-e.vStartPosition.dot(y),w=a.dot(U)-e.vStartPosition.dot(U),x=Math.max(Math.abs(P),Math.abs(w));r=x*Math.sign(P),t=x*Math.sign(w),(a=y.clone().multiplyScalar(r).add(U.clone().multiplyScalar(t))).add(e.vStartPosition)}else r=a.dot(y)-e.vStartPosition.dot(y),t=a.dot(U)-e.vStartPosition.dot(U);if(S){const n=g._selectedPathElement;if(n&&c.isAPOIPath(n)){const{position:e}=l.getPOIInformationFromPathElement(n);e&&(o=e)}else o=e.vStartPosition.clone();r*=2,t*=2}else o=(new i.Vector3).addVectors(a,e.vStartPosition).multiplyScalar(.5)}D.setAttributes([{name:"fWidth",value:Math.abs(t)},{name:"fHeight",value:Math.abs(r)},{name:"vPosition",value:o}]),D.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:D})}else p=!0,f([{position:e.vStartPosition}],e.vCurrentPosition);m.updateManipulationData(e),e.bLastUpdate&&M()},this.clean=function(){m&&m.remove(),p=!1,D=null},this._parent(t,function(e){p||D||f(e)},d.rectangleCreationLabel,{},!0),u=this.getFrameWindow().getViewer()},beginExecute:function(){var e=o.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(this._parent(),this.done()):this._endExecute()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})}),define("DS/DMUMarker/DMUMarkerBoxContextCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager"],function(e,t,n){"use strict";return e.extend({init:function(e){var t=e||{};t.mode="shared",this._parent(t)},beginExecute:function(e){this._parent(e);for(var i=t.get(),r=[],a=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),o=0;o<i.length;o++){var s=a.getDMUObjectFromPathElement(i[o].pathElement);s&&r.push(s)}if("DMUMarkerShortDisplayHdr"===this._id){for(var l,c,d=0;d<r.length;d++)if("boolean"==typeof(c=r[d].getAttribute("bShortDisplay")))if(void 0===l)l=c;else if(l!==c){l=null;break}r.forEach(function(e){e.setAttribute("bShortDisplay",null===l||!l),e.refreshNode()})}this.getFrameWindow().getViewer().render(),a&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getCurrentSlide()&&a.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:a.getCurrentSessionMarkup().getCurrentSlide()}),this.done()}})}),define("DS/DMUMarker/DMUMarkerFreehandShapePreview",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/3DPlayAnnotationUtils/CanvasShapes","DS/DMUBaseUIServices/DMUObjectsServices"],function(e,t,n,i,r){"use strict";return t.extend({init:function(t){if(t&&t.graphicProperties&&t.frameWindow){this._parent();var a,o,s,l={};l.lineCap=t.graphicProperties.lineCap?t.graphicProperties.lineCap:"round",l.lineJoin=t.graphicProperties.lineJoin?t.graphicProperties.lineJoin:"round",l.lineStyleOpacity=t.graphicProperties.lineStyleOpacity?t.graphicProperties.lineStyleOpacity:1,l.lineStyleColor=t.graphicProperties.lineStyleColor?t.graphicProperties.lineStyleColor:new n.Color(13371695),l.lineStyleThicknessIndex=t.graphicProperties.lineStyleThicknessIndex?t.graphicProperties.lineStyleThicknessIndex:4,this.setGraphicProperties=function(e){e&&(l.lineCap=e.lineCap?e.lineCap:l.lineCap,l.lineJoin=e.lineJoin?e.lineJoin:l.lineJoin,l.lineStyleOpacity=e.lineStyleOpacity?e.lineStyleOpacity:l.lineStyleOpacity,l.lineStyleColor=e.lineStyleColor?e.lineStyleColor:l.lineStyleColor,l.lineStyleThicknessIndex=e.lineStyleThicknessIndex?e.lineStyleThicknessIndex:l.lineStyleThicknessIndex,d())},this.startPreview=function(){if(!a||!o){var n=t.frameWindow.getUIFrame();a=new e.Element("canvas",{id:"freehandPreviewCanvas",styles:{zIndex:"2000",pointerEvents:"none",position:"absolute",top:0,left:0}}).inject(n);var i=t.frameWindow.getViewerFrame(),r=i.getDimensions();i.addEvent("resize",c),a.width=r.width,a.height=r.height,o=a.getContext("2d"),d()}},this.drawHalfPreview=function(e,t,n){o.clearRect(0,0,a.width,a.height);let s={color:l.lineStyleColor,thickness:r.getLineThickness(l.lineStyleThicknessIndex),transparency:1};if(e){let t=i.createShape({shapeData:e,settings:s});o.globalAlpha=1,i.drawShape({shape:JSON.parse(JSON.stringify(t)),canvas:a,scale:1,angle:0})}else{o.globalAlpha=1,o.beginPath();let e=n.length;o.moveTo(n[0].x,n[0].y);for(let t=1;t<e;++t)o.lineTo(n[t].x,n[t].y);o.stroke()}o.globalAlpha=.3,o.beginPath();let c=t.length;o.moveTo(t[0].x,t[0].y);for(let e=1;e<c;++e)o.lineTo(t[e].x,t[e].y);o.stroke()},this.destroyHalfPreview=function(e){o.clearRect(0,0,a.width,a.height),o.globalAlpha=1;let t=e.length;o.moveTo(e[0].x,e[0].y);for(let n=1;n<t;++n)o.lineTo(e[n].x,e[n].y);o.stroke()},this.refreshPreview=function(){a&&o&&(o.clearRect(0,0,a.width,a.height),s=null)},this.destroy=function(){s=null,o&&a&&(t.frameWindow.getViewerFrame().removeEvent("resize",c),o.clearRect(0,0,a.width,a.height),o=null,a.remove(),a=null)},this.updatePreview=function(e,t){if(a&&o){if(!s)return d(),void(s=[]).push(e);t?s[1]=e:s.push(e),o.clearRect(0,0,a.width,a.height),o.beginPath(),o.moveTo(s[0].x,s[0].y);for(var n=1;n<s.length;n++)o.lineTo(s[n].x,s[n].y);o.stroke()}},this.getPreviewPoints=function(){return s}}function c(){var e=t.frameWindow.getViewerFrame().getDimensions();a.width=e.width,a.height=e.height}function d(){o&&(o.lineCap=l.lineCap,o.lineJoin=l.lineJoin,o.globalAlpha=l.lineStyleOpacity,o.strokeStyle=l.lineStyleColor.getStyle(),o.fillStyle=l.lineStyleColor.getStyle(),o.lineWidth=r.getLineThickness(l.lineStyleThicknessIndex))}}})}),define("DS/DMUMarker/DMUMarkerContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXComponents/DMUCommandsManager"],function(e,t,n){"use strict";return e.extend({getSharedContextualMenuCommandList:function(e){var t=[];return e&&e.length&&e.forEach(function(e){e.isReadOnly()||-1!==t.indexOf(e.getType())||t.push(e.getType())}),t.length&&-1===t.indexOf("DMUSlide")&&-1===t.indexOf("DMUFormat")?this.getContextualMenuCommandList(e):[]},getContextualMenuCommandList:function(e){var t,n=[],i=[],r=[],a="true"===localStorage.getItem("WebAfr_v2_activated");if(!this.isReadOnly())if(this.isEditable()){a?i.push("DMUCutHdr","DMUCopyHdr","DMUHideShowHdr","DMUDeleteHdr"):n=[{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUHideShowStr",hdr_list:["DMUHideShowHdr"]},{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}];var o,s,l,c=!1,d=!0,u=!1,m=!1,h=!1;for(this.cmdHdrState_list=[],t=0;t<e.length;t++)e[t].getSharedHeaderTypes&&(o=e[t].getSharedHeaderTypes())&&(o.leaderProperties?(c=!0,o.hideShowLeaderProperties&&(u=!0)):d=!1,o.pointTypeProperties&&(s=e[t],m=!0),o.extremityTypeProperties&&(l=e[t],h=!0)),!d||e[0].getAttribute("sLeaderEndType")===e[t].getAttribute("sLeaderEndType")&&e[0].getAttribute("bHasALeader")===e[t].getAttribute("bHasALeader")||(d=!1);if(c){var g={line:1,name:"DMULeaderStr",hdr_list:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"};if(u&&g.hdr_list.push("DMUNoLeaderHdr"),a?r.push({category:"Leader end type",hdrs:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"]}):n.push(g),e.length>0){var D=!1,p=!1,M=!1,f=!1,v=!1,S=!1;if(d){var C=e[0].getAttribute("sLeaderEndType");switch(e[0].getAttribute("bHasALeader")||(C="None"),C){case"Arrow":D=!0;break;case"Bubble":p=!0;break;case"Cross":M=!0;break;case"Square":f=!0;break;case"No end":v=!0;break;case"None":S=!0}}var y=[{name:"DMUArrowLeaderHdr",state:D},{name:"DMUBubbleLeaderHdr",state:p},{name:"DMUCrossLeaderHdr",state:M},{name:"DMUSquareLeaderHdr",state:f},{name:"DMUNoEndLeaderHdr",state:v},{name:"DMUNoLeaderHdr",state:S}];for(t=0;t<y.length;t++)this.cmdHdrState_list.push(y[t])}}if(m&&s&&s.getPointTypeHdr){var U=s.getPointTypeHdr();if(U&&U.hdr_list.length>0){a?i.push(...U.hdr_list):n.push(U);var P,w=[];for(P=0;P<U.hdr_list.length;P++)w.push({name:U.hdr_list[P],state:!1});for(P=0;P<w.length;P++)this.cmdHdrState_list.push(w[P])}}if(h&&l&&l.getExtremityTypeHdr){var x=l.getExtremityTypeHdr();if(x&&x.hdr_list.length>0){a?i.push(...x.hdr_list):n.push(x);var b,k=[];for(b=0;b<x.hdr_list.length;b++)k.push({name:x.hdr_list[b],state:!1});for(b=0;b<k.length;b++)this.cmdHdrState_list.push(k[b])}}}else a?i.push("DMUDeleteHdr"):n=[{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}];if(a){for(let e=0;e<i.length;e++)n.push({type:"WAfrDefaultHandlerItem",handlerId:i[e]});return r.forEach(e=>{let t={type:"PushItem",title:e.category,submenu:[]};for(let n=0;n<e.hdrs.length;n++)"ENO3DToggleStatusBarCmd"===e.hdrs[n]?t.submenu.push({type:"WAfrCheckHandlerItem",handlerId:e.hdrs[n]}):t.submenu.push({type:"WAfrDefaultHandlerItem",handlerId:e.hdrs[n]});n.push(t)}),n}return n},getSharedContextualCommandList:function(e){var n=[],i="true"===localStorage.getItem("WebAfr_v2_activated");let r=e&&e.length&&e.every(function(e){const t=e.getParent(),i=t&&t.getParent(),r=i&&i.getRestrictions(t);return!(r&&!r.markup.canEdit&&!r.reply.canEdit)&&(!e.isReadOnly()&&e.isInEdition()?(-1===n.indexOf(e.getType())&&n.push(e.getType()),e.isEditable()):void 0)});if(!n.length||-1!==n.indexOf("DMUSection")||-1!==n.indexOf("DMUClipping")||!r)return i?void 0:[];if(1===n.length||2===n.length&&-1!==n.indexOf("DMUMarker2DPicture")&&-1!==n.indexOf("DMUMarker3DPicture")||2===n.length&&-1!==n.indexOf("DMUMarker2DText")&&-1!==n.indexOf("DMUMarker3DText"))return this.getContextualCommandList(e[0]);var a,o=[];for(a=0;a<e.length;a++){for(var s=!1,l=0;l<o.length;l++)if(o[l].type===e[a].getType()){s=!0;break}if(!s){if(!e[a].getSharedHeaderTypes)return i?void 0:[];o.push({sharedTypes:e[a].getSharedHeaderTypes()})}}var c=!1;for(a=0;a<o.length;a++)o[a].sharedTypes.fontProperties&&(c=!0);var d=[],u=t.getManager({name:"DMU2DSheetManager",context:this._frmWindow});return u&&u.isADocumentDisplayed()&&("Document"===u.getDocumentType()||"Requirement"===u.getDocumentType())&&(d=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]),c&&(d.push({name:"Marker_DMUStylesStr",line:1,hdr_list:["Marker_DMUDefaultStyleHdr","Marker_DMULightStyleHdr","Marker_DMUMeasureStyleHdr","Marker_DMUPostitStyleHdr","Marker_DMUValidateStyleHdr","Marker_DMUWarningStyleHdr","Marker_DMUCautionStyleHdr"],selectedHdr:"Marker_DMUDefaultStyleHdr",type:"handler",identifier:"Marker_DMUStylesStr"}),d.push({name:"Marker_DMUIncreaseFontSizeStr",line:1,hdr_list:["Marker_DMUIncreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUIncreaseFontSizeHdr"}),d.push({name:"Marker_DMUDecreaseFontSizeStr",line:1,hdr_list:["Marker_DMUDecreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUDecreaseFontSizeHdr"})),d=d.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"],type:"handler",identifier:"DMUGraphicPropertiesPanelHdr"}])},getContextualCommandList:function(){var e=[];if(this.isReadOnly()||!this.isInEdition()||!this.isEditable())return e;var n=t.getManager({name:"DMU2DSheetManager",context:this._frmWindow});return n&&n.isADocumentDisplayed()&&("Document"===n.getDocumentType()||"Requirement"===n.getDocumentType())&&(e=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]),e=e.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"],type:"handler",identifier:"DMUGraphicPropertiesPanelHdr"}])},getSharedHeaderTypes:function(){return{}},register:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"},contextualMenu:{type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"},contextualMenu:{type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}})},applyStateToContextHdr:function(e){if(e.length>0)for(var t=0;t<e.length;t++){var i=n.getCommand(e[t].name,"Default");void 0!==i&&i.setState&&i.setState(e[t].state)}},setCheckCmdHdrState:function(e){this.applyStateToContextHdr&&e.length>0&&this.applyStateToContextHdr(e)}})}),define("DS/DMUMarker/DMUMarkerCreatePictureCtxInternalCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATWebUXComponents/DMUCommandsManager"],function(e,t){"use strict";return e.extend({init:function(e){e.mode="shared",this._parent(e),this.setRepeatMode(!1)},beginExecute:function(){var e=this.options.executionContext?this.options.ID:t._getCurrent(this.options.context),n=t.getCommand("markerPictureCmdHdr",this.options.executionContext?this.options.executionContext:this._ctx);(!n||n&&!n.isPaused()||n&&!n.setPictureCreationChoice)&&(n=t.getCommand("marker2DPictureCmdHdr",this.options.executionContext?this.options.executionContext:this._ctx)),n&&(!n||n.setPictureCreationChoice||this.options.executionContext)&&("DMUImportPictureFromFileHdr"===e?n.setPictureCreationChoice("browser"):"DMUCreateSnapshotHdr"===e?n.setPictureCreationChoice("webcam"):n.setPictureCreationChoice(null),this.cancel())}})}),define("DS/DMUMarker/DMUMarkerArrowCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPGenericCmdOneSelThenOperation","DS/DMUBaseExperience/EXPToolsVisualization","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlayMarker/DMUMarker3DArrow","DS/DMUPlayMarker/DMUMarker2DArrow","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,i,r,a,o,s,l,c,d){"use strict";return t.extend({init:function(t){var u,m,h,g,D="markerArrowCmdHdr"===t.ID||"marker3DDoubleArrowCmdHdr"===t.ID?"3D":"2D",p=this,M=null,f=!1;function v(){let e=M.getAttribute("vFirstPoint"),t=M.getAttribute("vSecondPoint"),n=p.getElementId(e);M.setAttributes([{name:"vFirstPoint",value:p.getRelativePosition(e)},{name:"vSecondPoint",value:p.getRelativePosition(t,n)},{name:"fPointedPageNumber",value:p.getPageNumber()},{name:"sPointedElementID",value:n}]),M.fireEvent("onDMUObjectInitialized",{dmuObject:M}),p.addInCSO(M),p._endExecute()}function S(S,C){var y=r.getReviewContext({viewer:p.getFrameWindow().getViewer()}),U=y?y.getCurrentSessionMarkup():null,P=S[0].position;h=n.getSnapRotationInfos().snapRotationToggle;var w=parseFloat(n.getSnapRotationInfos().snapRotationAngle);g=(isNaN(w)?90:w)*Math.PI/180,m||(m=new s(u)),m.addToListener("Shift",t.dragEventCallback),m.activate();var x,b=P.clone(),k=C;if("3D"===D){var E=n.getDistanceFromPixel(u,P,100,p.getFrameWindow()),A=n.getViewpointInfo(u.currentViewpoint),F=A.right.clone().add(A.up).normalize().multiplyScalar(E);const e=S[0].pathElement||p._selectedPathElement;if(c.isAPOIPath(e)){const{position:t}=l.getPOIInformationFromPathElement(e);t&&(b=t)}k?x=k.clone().sub(P.clone()).length():(k=P.clone().add(F),x=E/10)}else{var I=n.getViewerPositionFromPoint(u,b);b=new i.Vector2(I.left,I.top),k?(I=n.getViewerPositionFromPoint(u,k),k=new i.Vector2(I.left,I.top)):(k=(new i.Vector2).copy(b)).add(new i.Vector2(150,0)),x=k.clone().sub(b).length()/10}(M="3D"===D?new a(u,U):new o(u,U)).setAttributes([{name:"sID",value:U.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:U.computeNewName({object:M,prefix:"3D"===D?d.arrow3DPrefix:d.arrow2DPrefix})},{name:"vFirstPoint",value:b},{name:"vSecondPoint",value:k},{name:"fWidth",value:x},{name:"cLineStyleColor",value:new i.Color("#cc092f")},{name:"cFillStyleColor",value:new i.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sStyle",value:-1===t.ID.indexOf("DoubleArrow")?"beginSide":"bothSide"}]);var T=U.getCurrentSlide();T.addDMUObject(M),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateArrow"+D+T.getType())}),f||v()}r.setAuthoringFeatureTypes("Marker"),t.dragEventCallback=function(e){if(e.isCanvasToDraw){if(M){var t,r;let f=p.getElementId(e.vStartPosition.clone());var a=p.getAbsolutePosition(n.getPositionFromIntersection(u,p.getRelativePosition(e.vCurrentPosition,f),p.getRelativePosition(e.vCurrentPosition,f),!0),f),o=e.iEventData.from[0].getCurrentPosition(u.canvas),s="2D"===D?e.vStartPosition:M.getAttribute("vFirstPoint"),l=n.getViewerPositionFromPoint(u,s);l=new i.Vector2(l.left,l.top);var c=(new i.Vector2).subVectors(o,l),d=new i.Vector2(1,0).dot(c.clone().normalize());r=o.y<=l.y?Math.acos(d):2*Math.PI-Math.acos(d);var C=e.shiftKey||void 0===e.shiftKey&&e.iEventData.from&&e.iEventData.from.length&&e.iEventData.from[0].event&&e.iEventData.from[0].event.shiftKey;if(h!==C){var y=Math.round(r/g)*g,U=new i.Vector2(Math.cos(y),-Math.sin(y));if(U.setLength(c.dot(U)),U.distanceTo(c)<m.ROTATION_SNAP_THRESHOLD){U.normalize();var P=(new i.Vector2).subVectors(n.get2DSnappedPosition(o,y),l);U.setLength(P.dot(U)),a=n.getPositionFromIntersection(u,l.add(U),s),m.displayAxis(s,y,P.length()+20)}else m.removeAxis()}else m.removeAxis();if("2D"===D){var w=n.getViewerPositionFromPoint(u,a);a=new i.Vector2(w.left,w.top)}t=a.clone().sub(M.getAttribute("vFirstPoint")).length()/10,M.setAttributes([{name:"fWidth",value:t},{name:"vSecondPoint",value:a}]),M.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:M})}else f=!0,S([{position:e.vStartPosition}],e.vCurrentPosition);m.updateManipulationData(e)}e.bLastUpdate&&M&&v()},this.clean=function(){m&&m.remove(),f=!1,m=M=null},this._parent(t,function(e){f||M||S(e)},d.arrowPositionLabel,{},!0),u=this.getFrameWindow().getViewer()},beginExecute:function(){var e=r.getReviewContext({viewer:this.getFrameWindow().getViewer()});(e?e.getCurrentSessionMarkup():null)?(this._parent(),this.done()):this._endExecute()},_endExecute:function(){this._parent(),this.clean&&this.clean(),this.cancel()},destroy:function(){this._endExecute()}})}),define("DS/DMUMarker/DMUMarkerCloudCreateCmd",["require","exports","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseExperience/DMUContextManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/EXPManagerSet","DS/Selection/CSOManager","DS/Selection/HSOManager","UWA/Utils","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseCommands/EXPStateCommand","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUMarker/assets/nls/DMUMarker","DS/DMUMarker/DMUMarkerCloudShapePreview","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUPlayMarker/DMUMarker3DCloud"],function(e,t,n,i,r,a,o,s,l,c,d,u,m,h,g,D,p,M){"use strict";return class extends u{constructor(e){super(e,"exclusive",!0);const t=this.getFrameWindow().getUIFrame(),u=this.getFrameWindow().getViewer();this.executionContext=e.executionContext;const f=this;let v,S,C,y,U,P,w,x=!1,b=[];const k=h.getWebappsAssetUrl("DMUBaseCommands","icons/32/");function E(e){return C&&"Requirement"===C.getDocumentType()?C.getPointedElemIDAtPosition(e):null}function A(){const e=i.getReviewContext({viewer:f.getFrameWindow().getViewer()});let t=e?e.getCurrentSessionMarkup():null;if(!t)return;let n,r=C?C.getPageNumber(U):null,o=Boolean(r);o&&(n=new a.Vector3(0,0,0));let s,l=-1/0,d=1/0,m=-1/0,h=1/0,g=[];(s=b).forEach(function(e){l=Math.max(l,e.x),d=Math.min(d,e.x),m=Math.max(m,e.y),h=Math.min(h,e.y)});let D=new a.Vector2(d,m),v=new a.Vector2(l,h),y=(new a.Vector2).addVectors(D,v).multiplyScalar(.5),P=p.getNearPositionFrom2DCoordinates(y,u,n,o),w=E(P);P&&s.forEach(function(e){w=E(P);let t,n=p.get3DPositionFromScreenCoordinates({coords:e,viewer:u});P&&(t=function(e,t,n){if(U===u.canvas||!C)return e;let i=C.getElementMatrix(n||t);return e.clone().applyMatrix4((new a.Matrix4).getInverse(i))}(p.getPositionFromIntersection(u,n,P),w,r),g.push({Point3D:t.toArray()}))}),(S=new M(u,t)).setAttributes([{name:"sID",value:t.computeNewID()},{name:"sUuid",value:c.getUUID()},{name:"sName",value:t.computeNewName({object:S,prefix:"CloudMarker3D"})},{name:"oPoints",value:g},{name:"fRotationAngle",value:0},{name:"cLineStyleColor",value:new a.Color("#cc092f")},{name:"cFillStyleColor",value:new a.Color("#cc092f")},{name:"fLineStyleThicknessIndex",value:3},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!0},{name:"fLineStyleOpacity",value:1},{name:"fPointedPageNumber",value:r},{name:"sPointedElementID",value:E(P)}]);let x=p.getViewpointInfo(u.currentViewpoint);x&&S.updateProjectionPlaneDefinition({up:x.up,right:x.right}),t.getCurrentSlide().addDMUObject(S)}function F(e){if(e&&e===U)return!0;let t=e.parentNode;for(;t&&"___view___1"!==t.id;){if(t===U)return!0;t=t.parentElement}return!1}function I(){u.currentViewpoint.isMoving()||(f.publish({event:"endCommand",data:null}),x=!1),v=null}function T(e){!u.currentViewpoint.isMoving()&&F(e.from[0].getView())&&(x=!0,v||(v=e.from[0].getStartPosition(u.canvas)),y&&y.updatePreview(e.from[0].getCurrentPosition(u.canvas),!0))}function _(e){if(!(U=C?C.getElementToDraw(e.from[0].getView()):u.canvas))return;let t=e.from[0].getStartPosition(u.canvas);v||(v=t),y&&(y.updatePreview(e.from[0].getCurrentPosition(u.canvas),!1),y.getPreviewPoints&&3===y.getPreviewPoints().length&&function(){let e={nls:g.ok,url:k+"I_Validate.png",id:"okButtonForCloud",callback:I};if(v){let t=p.getNearPositionFrom2DCoordinates(new a.Vector2(v.x,v.y),u);(w=new m({body:f.getFrameWindow().getUIFrame(),viewer:u,frmWindow:f.getFrameWindow(),position:t,mode:"curve",dir:"bottom",lJsonElement:[e]})).build()}}())}function L(e){F(e.from[0].getView())&&v&&!u.currentViewpoint.isMoving()&&f.publish({event:"click",data:e.from[0].getCurrentPosition(u.canvas)})}function V(){var e;f.restoreDefaultController(),u.manipulatorManager.setActivate(!0),u.setDefaultPicking(!0),f.cleanNotify();let t=n.giveDMUCursorsController({context:f.getFrameWindow()});t&&t.restoreCursors(),w&&(w.clear(),w=null);const i=document.getElementById("okButtonForCloud");if(i&&(null===(e=i.parentNode)||void 0===e||e.removeChild(i)),v&&(v=null),r.removeEvent(P,"onMouseMove",T),r.removeEvent(P,"onPrimaryPointerUpUnique",L),r.removeEvent(P,"onPrimaryPointerDownUnique",_),r.removeEvent(P,"onPrimaryPointerDoubleClick",I),C&&C.setTextSelectionFlag(!0),y&&y.destroy(),u.currentViewpoint.setDefaultController(!0,"FLY_WALK"),x=!1,b.length=0,S){let e=S.getNode&&S.getNode()?d.buildPathElement(S.getNode()):null;e&&s.add({pathElement:e}),S=null}f.cancel(),f.done()}this.resumeExecute=function(){let e=n.giveDMUCursorsController({context:f.getFrameWindow()});e&&e.resetCursors(),f.done&&f.done()},this.cancelExecute=function(){V()},this.destroy=function(){V()},this.buildGraph=function(){!function(){let e=i.getReviewContext({viewer:u});if(!e||!e.getCurrentSessionMarkup())return;u.currentViewpoint.setDefaultController(!1,"FLY_WALK"),C||(C=o.getManager({name:"DMU2DSheetManager",context:f.getFrameWindow()})),P=C?C.getPointedElem():u.canvas,C&&C.setTextSelectionFlag(!1),l.empty(),s.empty();let a=n.giveDMUCursorsController({context:f.getFrameWindow()});a&&a.setCursors({pages:P!==u.canvas?"crosshair":null,canvas:P===u.canvas?"crosshair":null,preHLMarkers:"crosshair"}),f.sendNotify("info",g.cloudCreationLabel),u.manipulatorManager.setActivate(!1),u.setDefaultPicking(!1),r.addEvent(P,"onPrimaryPointerDownUnique",_),r.addEvent(P,"onPrimaryPointerUpUnique",L),r.addEvent(P,"onPrimaryPointerDoubleClick",I),y||(y=new D({viewerFrame:f.getFrameWindow().getViewerFrame(),uiFrame:t})),y&&y.startPreview(),f.changeDefaultController()}();let e=this.createInitialState("initialState"),a=this.createState("clickState"),c=this.getFinalState(),d={iSender:this,iEvent:"click",iInitialState:e,iFinalState:a,iCondition:function(){return!x},iAction:function(e){U&&r.addEvent(P,"onMouseMove",T),e()}};this.addTransition(d);let m={iSender:this,iEvent:"click",iInitialState:a,iFinalState:a,iCondition:()=>x};f.addTransition(m);let h={iSender:this,iEvent:"endCommand",iInitialState:a,iFinalState:c,iCondition:null,iAction:function(e){y&&(b=y.getPreviewPoints(),x&&b.pop(),b&&b.length>=3?(A(),y.refreshPreview(),S&&S.fireEvent("onDMUObjectInitialized",{dmuObject:S})):y.refreshPreview(),f.done()),V(),e()}};this.addTransition(h)}}}}),define("DS/DMUMarker/DMUMarkerPictureContextualBar",["DS/DMUMarker/DMUMarkerContextualBar"],function(e){"use strict";return e.extend({getContextualCommandList:function(e){var t=this._parent(e);return e&&!e.isReadOnly()&&e.isInEdition()&&e.isEditable()&&(t||(t=[]),t.unshift({name:"DMUMarkerShortDisplayStr",line:1,hdr_list:["DMUMarkerShortDisplayHdr"],type:"handler",identifier:"DMUMarkerShortDisplayHdr"})),t},getSharedHeaderTypes:function(){return{leaderProperties:!0,hideShowLeaderProperties:!0}}})}),define("DS/DMUMarker/DMUMarkerLineContextualBar",["DS/DMUMarker/DMUMarkerContextualBar","DS/DMUBaseExperience/EXPManagerSet"],function(e,t){"use strict";return e.extend({getContextualCommandList:function(){var e=[];if(!this.isReadOnly()&&this.isInEdition()&&this.isEditable()){var n=t.getManager({name:"DMU2DSheetManager",context:this._frmWindow});n&&n.isADocumentDisplayed()&&("Document"===n.getDocumentType()||"Requirement"===n.getDocumentType())&&(e=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]),e=e.concat([{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"]}])}return e}})}),define("DS/DMUMarker/DMUMarkerTextContextualBar",["DS/DMUMarker/DMUMarkerContextualBar","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({getContextualCommandList:function(e){var n=this._parent(e);if(e&&!e.isReadOnly()&&e.isInEdition()&&e.isEditable()&&(n||(n=[]),n.unshift({name:"Marker_DMUIncreaseFontSizeStr",line:1,hdr_list:["Marker_DMUIncreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUIncreaseFontSizeHdr"},{name:"Marker_DMUDecreaseFontSizeStr",line:1,hdr_list:["Marker_DMUDecreaseFontSizeHdr"],type:"handler",identifier:"Marker_DMUDecreaseFontSizeHdr"}),"Marker3DStamp"!==e.getAttribute("sType"))){var i="Marker_DMUDefaultStyleHdr";e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#000000")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#ffffff")},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="Marker_DMULightStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#368ec4")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="Marker_DMUMeasureStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#000000")},{name:"sFontStyle",value:"italic"},{name:"cFillStyleColor",value:new t.Color("#fee000")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#ff8a2e")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#ff8a2e")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="Marker_DMUPostitStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#57b847")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#477738")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#477738")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="Marker_DMUValidateStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new t.Color("#ff8a2e")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#8f4c00")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#8f4c00")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?i="Marker_DMUWarningStyleHdr":e.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new t.Color("#ffffff")},{name:"sFontStyle",value:"bold"},{name:"cFillStyleColor",value:new t.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new t.Color("#6d2828")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new t.Color("#6d2828")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))&&(i="Marker_DMUCautionStyleHdr"),n.unshift({name:"Marker_DMUStylesStr",line:1,hdr_list:["Marker_DMUDefaultStyleHdr","Marker_DMULightStyleHdr","Marker_DMUMeasureStyleHdr","Marker_DMUPostitStyleHdr","Marker_DMUValidateStyleHdr","Marker_DMUWarningStyleHdr","Marker_DMUCautionStyleHdr"],selectedHdr:i,type:"handler",identifier:"Marker_DMUStylesStr"})}return n},getSharedHeaderTypes:function(){return{leaderProperties:!0,fontProperties:!0,hideShowLeaderProperties:!0}}})}),define("DS/DMUMarker/DMUMarkerFreehandCreateCmd",["DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMarker/DMUMarkerFreehandShapePreview","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/DMUPlayMarker/DMUMarkerFactory","DS/DMUPlayMarker/DMUMarkerTools","DS/3DPlayAnnotationUtils/ShapeUtils","DS/DMUControls/DMUContextToolsMenu","DS/WebappsUtils/WebappsUtils","DS/Utilities/TouchUtils","DS/DMUBaseExperience/EXPManagerSet","DS/WebRunloop/Runloop","i18n!DS/DMUMarker/assets/nls/DMUMarker"],function(e,t,n,i,r,a,o,s,l,c,d,u,m,h,g,D,p){"use strict";return e.extend({init:function(e){this._parent(e,"exclusive",!0);var M,f,v,S,C,y,U,P,w,x=this.getFrameWindow().getViewer(),b=this,k=!1,E=localStorage.getItem("currentFreehandMode")?localStorage.getItem("currentFreehandMode"):"DMUFreehandAnnotate",A=localStorage.getItem("currentFreehandAnnotateColor")?localStorage.getItem("currentFreehandAnnotateColor"):"DMUFreehandColorRed",F=localStorage.getItem("currentFreehandHighlightColor")?localStorage.getItem("currentFreehandHighlightColor"):"DMUFreehandColorYellow",I=[],T={},_=m.getWebappsAssetUrl("DMUMarker","icons/");let L,V,H,B,O=!1,R=void 0,W=void 0,N=[],j=new s.Vector3(0,0,0),z=!0;function X(){z&&(j=function(){let e=-1/0,t=1/0,n=-1/0,r=1/0;I.forEach(function(i){e=Math.max(e,i.x),t=Math.min(t,i.x),n=Math.max(n,i.y),r=Math.min(r,i.y)});let a=new s.Vector2(t,n),o=new s.Vector2(e,r),l=(new s.Vector2).addVectors(a,o).multiplyScalar(.5),c=i.get3DPositionFromScreenCoordinates({coords:l,viewer:x}),d=i.getNearPositionFrom2DCoordinates(l,x,void 0,!1);return i.getPositionFromIntersection(x,c,d)}()),z=!1;var e=n.getReviewContext({viewer:b.getFrameWindow().getViewer()}).getCurrentSessionMarkup(),t=f?f.getPageNumber(P):null;let r=d.shapeEval(N).shape;if(!B&&r&&(r.type="freehand"),C=l.create3DMarker({viewer:x,points:I,shape:r,parent:e,graphicProperties:T,pageNb:t,projectionPoint:j,getRelativePositionCB:function(e,n){if(P===x.canvas||!f)return e;var i=f.getElementMatrix(t||n);return e.clone().applyMatrix4((new s.Matrix4).getInverse(i))},getRelativeRotationCB:function(e){return P!==x.canvas&&f&&t?e-f.getPageRotation(t):e},getElementIDAtPosition:function(e){return f&&"Requirement"===f.getDocumentType()?f.getPointedElemIDAtPosition(e):null}})){var a=e.getCurrentSlide();a.addDMUObject(C),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateFreehand"+("DMUFreehandAnnotate"===E?"Annotate":"Highlight")+a.getType())})}}function q(){(I=v.getPreviewPoints())&&I.length?(X(),v.refreshPreview(),C&&(C.fireEvent("onDMUObjectInitialized",{dmuObject:C}),U||(U=[]),U.push(C))):v.refreshPreview(),V&&(V.stop(),V.dispose(),V=null),N=[],W=void 0,H=void 0,L=0,O=!1}function G(e){var t;if(O&&k)if(!H&&W)H=W,L=e.time,B=void 0;else if(W&&(t=W.distanceTo(H)),N&&N.length&&(R=d.shapeEval(N).shape),t<5){if(e.time-L>300&&N.length>=2)if(R&&"unknownOpen"!==R.type&&"unknownClosed"!==R.type&&"triangle"!==R.type)v.drawHalfPreview(R,N,!1),B=!0;else if(R&&"unknownOpen"===R.type){let e=[],t=function(e){if(!e)return;let t=[];return e.forEach(function(e){t.push(new s.Vector2(e.x,e.y))}),new s.SplineCurve(t).getPoints(200)}(e=c.getControlPoints(N,15));v.drawHalfPreview(!1,N,t),B=!0}}else B&&(B=void 0,v.destroyHalfPreview(N)),H=W,L=e.time}function K(e){if(e&&e===P)return!0;for(var t=e.parentNode;t&&"___view___1"!==t.id;){if(t===P)return!0;t=t.parentElement}return!1}function J(e){if(!(b.isPaused()||b.getFrameWindow().getViewpoint().isMoving()||y&&y.isCornerButtonActive())){if(k=!0,K(e.from[0].getView())){"touchmove"!==e.from[0].event.type||e.from[0].event.pageX||e.from[0].event.pageY||(e.from[0].event.pageX=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageX:0,e.from[0].event.pageY=e.from[0].event.touches&&e.from[0].event.touches.length?e.from[0].event.touches[0].pageY:0),M||"begin"!==e.state||(M=e.from[0].getStartPosition(x.canvas));const t=e.from[0].getCurrentPosition(x.canvas);if(W){let e=Math.abs(t.x-W.x),n=Math.abs(t.y-W.y),r=i.convertModelToPixels({sizeInMM:e}),a=i.convertModelToPixels({sizeInMM:n});(r>2||a>2)&&(v.updatePreview(t,!1),N.push(t))}W=t}"end"===e.state&&(k=!1,b.publish({event:"dragEnd"}),q())}}function Y(e){var n,i;"DMUFreehandAnnotate"===E?(A=e.id,localStorage.setItem("currentFreehandAnnotateColor",A),n="22/I_MarkerFreehandCursor",i=") 11 11, auto"):(F=e.id,localStorage.setItem("currentFreehandHighlightColor",F),n="32/I_MarkerFreehandHighlightCursor",i=") 16 16, auto");var r=t.giveDMUCursorsController({context:b.getFrameWindow()});switch(e.id){case"DMUFreehandColorGreen":T.lineStyleColor=new s.Color(5748807),r&&r.setCursors({pages:w!==x.canvas?"url("+_+n+"Green.png"+i:null,canvas:w===x.canvas?"url("+_+n+"Green.png"+i:null});break;case"DMUFreehandColorOrange":T.lineStyleColor=new s.Color(16747054),r&&r.setCursors({pages:w!==x.canvas?"url("+_+n+"Orange.png"+i:null,canvas:w===x.canvas?"url("+_+n+"Orange.png"+i:null});break;case"DMUFreehandColorYellow":T.lineStyleColor=new s.Color(16703488),r&&r.setCursors({pages:w!==x.canvas?"url("+_+n+"Yellow.png"+i:null,canvas:w===x.canvas?"url("+_+n+"Yellow.png"+i:null});break;case"DMUFreehandColorRed":T.lineStyleColor=new s.Color(13371695),r&&r.setCursors({pages:w!==x.canvas?"url("+_+n+"Red.png"+i:null,canvas:w===x.canvas?"url("+_+n+"Red.png"+i:null})}v.setGraphicProperties(T)}function Z(e){"DMUFreehandHighlight"===e.id?(localStorage.setItem("currentFreehandMode","DMUFreehandHighlight"),E=e.id,T.lineCap="square",T.lineStyleThicknessIndex=9,T.lineStyleOpacity=.4,T.isFilled=!0,T.hasBorder=!1,v.setGraphicProperties(T),y.setColor(F),Y({id:F})):"DMUFreehandAnnotate"===e.id?(localStorage.setItem("currentFreehandMode","DMUFreehandAnnotate"),E=e.id,T.lineCap="round",T.lineStyleThicknessIndex=3,T.lineStyleOpacity=1,T.isFilled=!1,T.hasBorder=!0,v.setGraphicProperties(T),y.setColor(A),Y({id:A})):b.publish({event:"lastClick"})}function Q(e){b.isPaused()||y&&y.isCornerButtonActive()||(P=f?f.getElementToDraw(e.from[0].getView()):x.canvas)&&(O=!0,B=void 0,M=e.from[0].getStartPosition(x.canvas),v.updatePreview(M.clone(),!1),N.push(M.clone()),W=M.clone(),(V=new D({data:b,func:G})).start())}function $(e){b.isPaused()||y&&y.isCornerButtonActive()||!K(e.from[0].getView())||(!M||k||b.getFrameWindow().getViewpoint().isMoving()||(b.publish({event:"click",data:e.from[0].getCurrentPosition(x.canvas)}),q()),M=null,k=!1)}function ee(e){e()}function te(e){"@onViewpointBeginMove"!==e.eventType&&"@onViewpointEndMove"!==e.eventType||v.refreshPreview()}function ne(e){var t=x.get2DMode()?p.freehandManipulationModeLabel2D:p.freehandManipulationModeLabel;b.sendNotify("info",e.checked?t:p.freehandCreationLabel);var n=x.currentViewpoint.getControl();x.get2DMode()||(n.setRotationActive(e.checked),n.setTouchRotationActive(e.checked)),n.setPanActive(e.checked),n.setZoomActive(e.checked),f&&f.setTouchPanActive(e.checked),v.refreshPreview()}this.pauseExecute=function(){y&&y.setVisibleFlag(!1)},this.resumeExecute=function(){y&&y.setVisibleFlag(!0);let e=t.giveDMUCursorsController({context:b.getFrameWindow()});e&&e.resetCursors()},this.cancelExecute=function(){this._endExecute()},this.destroy=function(){this._endExecute()},this._endExecute=function(){S&&a.unsubscribe(S),x.get2DMode()?f&&f.setTouchPanActive(!0):x.currentViewpoint.getControl().setTouchRotationActive(!0),h.getTouchMode()&&(x.get2DMode()||x.currentViewpoint.getControl().setRotationActive(!0),x.currentViewpoint.getControl().setPanActive(!0),x.currentViewpoint.getControl().setZoomActive(!0)),b.cleanNotify(),x.manipulatorManager.setActivate(!0),x.setDefaultPicking(!0);var e=t.giveDMUCursorsController({context:b.getFrameWindow()});e&&e.restoreCursors(),o.removeEvent(w,"onPrimaryPointerUpUnique",$),o.removeEvent(w,"onDrag",J),o.removeEvent(w,"onPrimaryPointerDownUnique",Q),f&&f.setTextSelectionFlag(!0),y&&(y.destroy(),y=null),v&&(v.destroy(),v=null),x.currentViewpoint.setDefaultController(!0,"FLY_WALK"),k=!1,C=I=null,U&&(U.forEach(function(e){b.addInCSO(e,!0)}),U=null),b.restoreDefaultController(),b.cancel(),V&&(V.stop(),V.dispose(),V=null),N=[],W=void 0,H=void 0,L=0,O=!1,z=!0},this.buildGraph=function(){var e;this.changeDefaultController(),(e=n.getReviewContext({viewer:b.getFrameWindow().getViewer()}))&&e.getCurrentSessionMarkup()?(x.currentViewpoint.setDefaultController(!1,"FLY_WALK"),f||(f=g.getManager({name:"DMU2DSheetManager",context:b.getFrameWindow()})),w=f?f.getPointedElem():x.canvas,f&&f.setTextSelectionFlag(!1),b.emptyHSO(),b.emptyCSO(),b.sendNotify("info",p.freehandCreationLabel),x.manipulatorManager.setActivate(!1),x.setDefaultPicking(!1),o.addEvent(w,"onPrimaryPointerDownUnique",Q),o.addEvent(w,"onPrimaryPointerUpUnique",$),o.addEvent(w,"onDrag",J),(y=new u({frameWindow:b.getFrameWindow()})).addButton({label:p.exitFreehandAnnotationsLabel,id:"DMUFreehandExit",icon:_+"32/I_MarkerFreehandExit.png",isOneShot:!0,isSelected:!1,onClickCB:Z}),y.addSeparator(),y.addButton({label:p.annotateModeLabel,id:"DMUFreehandAnnotate",icon:_+"32/I_MarkerFreehand.png",isSelected:"DMUFreehandAnnotate"===E,onClickCB:Z}),y.addButton({label:p.highlightModeLabel,id:"DMUFreehandHighlight",icon:_+"32/I_MarkerFreehandHighlight.png",isSelected:"DMUFreehandHighlight"===E,onClickCB:Z}),y.createColorPalette([{id:"DMUFreehandColorGreen",color:new s.Color(5748807),isSelected:"DMUFreehandAnnotate"===E?"DMUFreehandColorGreen"===A:"DMUFreehandColorGreen"===F,onClickCB:Y},{id:"DMUFreehandColorYellow",color:new s.Color(16703488),isSelected:"DMUFreehandAnnotate"===E?"DMUFreehandColorYellow"===A:"DMUFreehandColorYellow"===F,onClickCB:Y},{id:"DMUFreehandColorOrange",color:new s.Color(16747054),isSelected:"DMUFreehandAnnotate"===E?"DMUFreehandColorOrange"===A:"DMUFreehandColorOrange"===F,onClickCB:Y},{id:"DMUFreehandColorRed",color:new s.Color(13371695),isSelected:"DMUFreehandAnnotate"===E?"DMUFreehandColorRed"===A:"DMUFreehandColorRed"===F,onClickCB:Y}]),v||(v=new r({frameWindow:b.getFrameWindow(),graphicProperties:T})),v.startPreview(),Z({id:E}),S=a.subscribe({event:"/VISU/"},te),x.get2DMode()?f&&f.setTouchPanActive(!1):x.currentViewpoint.getControl().setTouchRotationActive(!1),h.getTouchMode()&&(x.currentViewpoint.getControl().setPanActive(!1),x.currentViewpoint.getControl().setZoomActive(!1),x.get2DMode()||x.currentViewpoint.getControl().setRotationActive(!1),y.createCornerButton({id:"DMUFreehandTouchButton",enabledIcon:_+"../textures/DMUFreehandRotationOn.png",disabledIcon:_+"../textures/DMUFreehandRotationOff.png",onClickCB:ne}))):b.cancel();var t=b.createInitialState("initialState"),i=b.createState("clickState"),l=b.getFinalState(),c={iSender:b,iEvent:"click",iInitialState:t,iFinalState:i,iCondition:function(){return!k},iAction:ee};b.addTransition(c);var d={iSender:b,iEvent:"click",iInitialState:i,iFinalState:i,iCondition:null,iAction:ee};b.addTransition(d);var m={iSender:b,iEvent:"dragEnd",iInitialState:t,iFinalState:i,iCondition:null};b.addTransition(m);var D={iSender:b,iEvent:"dragEnd",iInitialState:i,iFinalState:i,iCondition:null};b.addTransition(D);var M={iSender:b,iEvent:"lastClick",iInitialState:t,iFinalState:l,iCondition:null,iAction:function(e){this._endExecute(),e()}};b.addTransition(M);var C={iSender:b,iEvent:"lastClick",iInitialState:i,iFinalState:l,iCondition:null,iAction:function(e){this._endExecute(),e()}};b.addTransition(C)}}})});