define("DS/DMUComment/DMUCommentExport",["require","exports","DS/DMUPlayMarker/DMUCommentPositioned","DS/DMUPlayMarker/DMUCommentHighlight","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseUIServices/DMUObjectsServices"],function(e,t,n,i,r,o){"use strict";class a{static getCommentExportDefinition(e,t){return new Promise(n=>{(async()=>{const i=e.getAttribute("sOwner")||"";let o=t?await r.getUserName(i):i,a={id:e.getAttribute("sUuid")||"",content:(e.getAttribute("sTextContents")||[""]).join("\n"),owner:o,creationDate:new Date(e.getAttribute("fCreationDate")||Date.now()),lastModificationDate:new Date(e.getAttribute("fLastModificationDate")||Date.now()),parentCommentId:e.getAttribute("sParentCommentId")};n(a)})()})}static getExportDefinition(e,t){return new Promise((s,m)=>{(async()=>{let l,g=e.getPointedPosition(),u=e.getAttribute("sUuid")||"";if(e instanceof n)l={id:u,visible:!0,type:e.getType(),position:{x:g.x,y:g.y},width:8,height:8,radius:1};else if(e instanceof i){let t=e.getSelection();l={id:u,visible:!0,type:e.getType(),position:{x:g.x,y:g.y},selection:t.map(t=>{let n=o.getRelativePosition(e,t.position);return{position:{x:n.x,y:n.y},width:t.width,height:t.height,rotationAngle:t.rotationAngle}})}}if(l){let o,m=r.getUserColor(e.getOwner()||"");if(m&&e instanceof n){let e=m.getHSL();e.s=1,e.l*=.5,o=m.clone().setHSL(e.h,e.s,e.l)}let g={definition:l,pageNumber:e.getAttribute("fPointedPageNumber")||1,material:{fill:m&&{color:m,opacity:e instanceof i?.3:1},border:o&&{color:o,thickness:.34,opacity:1}}},u=e.getDMUComments();if(u.length){g.comments=[];for(let e=0;e<u.length;e++){let n=await a.getCommentExportDefinition(u[e],t);g.comments.push(n)}}return s(g)}m(new Error("This type cannot be exported"))})()})}}return a}),define("DS/DMUComment/DMUCommentCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight","DS/DMUPlayMarker/DMUCommentPositioned","DS/DMUBaseExperience/EXPToolsVisualization","DS/VisuEvents/EventsManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseUI/DMUToolsUsers","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","i18n!DS/DMUComment/assets/nls/DMUComment"],function(e,t,n,i,r,o,a,s,m,l,g,u,d,c){"use strict";return t.extend({init:function(t){this._parent(t,"exclusive",!0);var p,D,h=this.getFrameWindow().getViewer(),M=this;function f(e){if(e.pointedElementId){var t=p.getElementMatrix(e.pointedElementId);if(t){let n=new u.Vector3(e.absRect.position.x,e.absRect.position.y,0);n.applyMatrix4((new u.Matrix4).getInverse(t));let i=new u.Vector3(e.absRect.width,e.absRect.height,0);return i.applyMatrix4((new u.Matrix4).extractRotation(t)),{position:new u.Vector2(n.x,n.y),width:i.x,height:i.y}}}return e.absRect}function U(t){var i=n.getReviewContext({viewer:M.getFrameWindow().getViewer()});let s=i.getValidation(),m=s?s.getCurrentMarkup():null;for(;m&&"Markup"!==m.getValType();)m=m.getParentRepRef().getParent();m&&m.getValType&&"Markup"===m.getValType()&&(m=m.getRepRef());let l=m?m.getMarkupContent():i.getCurrentSessionMarkup(),d=l;"marker"===t.type&&t.marker&&(d=t.marker.getParent());var D,f=new r(h,d);if(f.setAttributes([{name:"sID",value:l.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:l.computeNewName({object:f,prefix:c.commentPrefix})},{name:"sOwner",value:g.getUserLogin()},{name:"sTextContents",value:[""]},{name:"fCreationDate",value:Date.now()},{name:"fLastModificationDate",value:Date.now()}]),"highlight"!==t.type&&"positioned"!==t.type||!t.position)"marker"===t.type&&t.marker&&(D=t.marker).addDMUComment(f);else{D="highlight"===t.type?new o(h,l):new a(h,l);let n=p&&"Requirement"===p.getDocumentType()?p.getPointedElemIDAtPosition(t.position):null;var U=function(e){if(e.pointedElementId){var t=p.getElementMatrix(e.pointedElementId);if(t){let n=new u.Vector3(e.absPosition.x,e.absPosition.y,0);return n.applyMatrix4((new u.Matrix4).getInverse(t)),new u.Vector2(n.x,n.y)}}return e.absPosition}({absPosition:t.position,pointedElementId:t.pageNumber||n});D.setAttributes([{name:"sID",value:l.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:l.computeNewName({object:D,prefix:c[t.type+"CommentPrefix"]})},{name:"vPosition",value:new u.Vector3(U.x,U.y,0)},{name:"fPointedPageNumber",value:t.pageNumber},{name:"sPointedElementID",value:n},{name:"oSelection",value:t.selectionRects}]),l.getCurrentSlide().addDMUObject(D),D.addDMUComment(f),D.fireEvent("onDMUObjectInitialized",{dmuObject:D})}D&&f&&(M.addInCSO(f),f.fireEvent("onDMUObjectInitialized",{dmuObject:f}),f.fireEvent("onDMUCommentEditionRequired",{dmuObject:f}),i.getUIManager().isAPreviewRegistered()||i.getUIManager().registerElementIdAsPreview(f.getAttribute("sUuid"),l),M.publish({event:"EndCommand"}))}function C(){var e=window.getSelection();if(e&&""!==e.toString())for(var t=e.getRangeAt(0),n=0,i=t.commonAncestorContainer;i&&n<15;){if(i===h.currentViewpoint.divCameraCSSElement)return t;i=i.parentNode,n++}return null}function w(){var e=d.get(),t=n.getReviewContext({viewer:M.getFrameWindow().getViewer()});if(t)for(var i=0;i<e.length;i++){var r=t.getDMUObjectFromPathElement(e[i].pathElement);if(r&&r.addDMUComment)return r}return null}function v(e,t){for(let n=0;n<t.length;n++){const i=t[n];if(i!==e&&e.top<i.y&&e.bottom>i.y+i.height&&e.left<i.x&&e.right>i.x+i.width)return!1}return!0}function y(e){var t=[],n=s.getMMPerPixelRatio(h),i=Array.from(e.getClientRects()).filter(e=>e.height&&e.width),r=h.canvas.getOffsets(),o=s.getPickingInfo(h,new u.Vector2(i[0].x-r.x,i[0].y-r.y)).point;o=new u.Vector2(o.x,o.y);for(var a="Document"===p.getDocumentType()&&i.length>2,m=0;m<i.length;m++)if((!a||(m+1)%2!=0||m+1===i.length)&&v(i[m],i)){for(var l=s.getPickingInfo(h,new u.Vector2(i[m].x-r.x,i[m].y-r.y)).point,g=p.getPointedElemIDAtPosition(l),d="number"==typeof g?g:null,c="string"==typeof g?g:null,D=f({absRect:{position:l,width:i[m].width*n,height:i[m].height*n},pointedElementId:g}),M=!1,C=0;C<t.length;C++)(d&&t[C].page===d||c&&t[C].element===c)&&(t[C].rects.push(D),M=!0);M||t.push({page:d,element:c,rects:[D]})}U({type:"highlight",pageNumber:t[0].page,pointedElement:t[0].element,position:o,selectionRects:t})}function x(e){var t=p.getElementToDraw(e.from[0].getView());if(t){var i=C();if(i)y(i);else{var r=w();let i=n.getReviewContext({viewer:M.getFrameWindow().getViewer()});const a=r&&i&&i.getRestrictions(r.getParent());if(a&&(a.markup.canEdit||a.reply.canEdit))U({type:"marker",marker:r});else{var o=e.from[0].getCurrentPosition(h.canvas);U({type:"positioned",pageNumber:p.getPageNumber(t),position:s.getPickingInfo(h,o).point})}}}}function S(){p||(p=l.getManager({name:"DMU2DSheetManager",context:M.getFrameWindow()})),p.setLinkActivationFlag(!1);var e=C();if(e)M.emptyHSO(),M.emptyCSO(),y(e);else{var t=w();let e=n.getReviewContext({viewer:M.getFrameWindow().getViewer()});const r=t&&e&&e.getRestrictions(t.getParent());r&&(r.markup.canEdit||r.reply.canEdit)?(M.emptyHSO(),M.emptyCSO(),U({type:"marker",marker:t})):(M.emptyHSO(),M.emptyCSO(),function(){D=p.getPointedElem();var e=i.giveDMUCursorsController({context:M.getFrameWindow()});e&&e.setCursors({pages:"crosshair",preHLMarkers:"pointer"}),m.addEvent(D,"onPrimaryPointerUpUnique",x),M.sendNotify("info",c.commentCreationLabel)}())}}function P(){M.cleanNotify(),p&&(p.setLinkActivationFlag(!0),p=null);var e=i.giveDMUCursorsController({context:M.getFrameWindow()});e&&e.restoreCursors(),m.removeEvent(D,"onPrimaryPointerUpUnique",x),M.restoreDefaultController(),M.end?M.end():M.done()}this.cancelExecute=function(){P()},this.buildGraph=function(){M.changeDefaultController(),setTimeout(S);var e=M.createInitialState("initialState"),t=M.getFinalState(),n={iSender:M,iEvent:"EndCommand",iInitialState:e,iFinalState:t,iCondition:null,iAction:function(e){P(),e()}};M.addTransition(n)}}})}),define("DS/DMUComment/DMUCommentContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseUI/DMUToolsContextualBar"],function(e,t){"use strict";return e.extend({getSharedContextualMenuCommandList:function(e){return e.every(e=>!e.isReadOnly()&&"DMUComment"===e.getType())?this.getContextualMenuCommandList(e):[]},getContextualMenuCommandList:function(){var e=[],n=[],i="true"===localStorage.getItem("WebAfr_v2_activated");if(!this.isReadOnly()){if(this.getParent()&&this.getParent().getParent()&&this.getParent().getParent().getValidation()){i?n.push("DMUReplyCmdHdr"):e.push({line:1,name:"DMUReplyCmdStr",hdr_list:["DMUReplyCmdHdr"]});const t=this.getParent().getParent().getRestrictions().highlight.canCreate;if(!this.isReply()&&t&&window.widget&&"ENOR3V_AP"===window.widget.getValue("appId")){const t=this.getAssociatedHighlightData();t&&t.length||(i?n.push("DMUAddHighlightHdr"):e.push({line:1,name:"DMUAddHighlightStr",hdr_list:["DMUAddHighlightHdr"]})),t&&!(t.length<2)||t[0]&&t[0].hasIssue||(i?n.push("issueTemplate"===localStorage.getItem("issueCreationType")?"DMUGenerateIssueFromTemplateFromSelectionHdr":"DMUGenerateIssueFromSelectionHdr"):e.push({line:1,name:"DMUGenerateIssueFromSelectionStr",hdr_list:["issueTemplate"===localStorage.getItem("issueCreationType")?"DMUGenerateIssueFromTemplateFromSelectionHdr":"DMUGenerateIssueFromSelectionHdr"]}))}}i?n.push("DMUDeleteHdr"):e.push({line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}),!t.isCloud()||this.isPreview()||this.isReply()||(i?n.push("DMUSetAsPreviewHdr"):e.push({line:1,name:"DMUSetAsPreviewStr",hdr_list:["DMUSetAsPreviewHdr"]}))}if(i){for(let t=0;t<n.length;t++)e.push({type:"WAfrDefaultHandlerItem",handlerId:n[t],hdr_list:[n[t]]});return e}return e},getContextualCommandList:function(){var e=[],t="true"===localStorage.getItem("WebAfr_v2_activated");return!this.isReadOnly()&&this.isInEdition()&&(e=t?[{type:"WAfrDefaultHandlerItem",handlerId:"DMUCommentCmdHdr"}]:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]),e},register:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:"markup"===e.experience?{type:"DMUComment",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}:{type:"DMUComment",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:"markup"===e.experience?{type:"DMUComment",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}:{type:"DMUComment",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})}})});