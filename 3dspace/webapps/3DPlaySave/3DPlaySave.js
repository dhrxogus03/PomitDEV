define("DS/3DPlaySave/Load3DComment",["UWA/Core","UWA/Controls/Abstract","DS/ApplicationFrame/Command","DS/WebSystem/SessionManager","UWA/Utils"],function(e,t,n,o,i){"use strict";var r,a=t.extend({init:function(t){this._parent(t);var n=null,o=new FileReader,r=!1;function a(){!r&&t.onErrorCB&&t.onErrorCB()}(n=new e.createElement("input",{id:"TestFileSelector"}).inject(widget.body)).setAttribute("type","file"),n.setAttribute("accept",".json,.zip"),n.setStyles({opacity:0}),n.onchange=function(){if(n){var e=n.files;if(!e||e&&!e.length)return void a();setTimeout(a,5e3),e[0].name.indexOf(".zip")>-1?(o.onload=function(){r=!0;var e=o.result;try{e=i.base64Decode(e)}catch(e){}for(var n=new ArrayBuffer(e.length),a=new Uint8Array(n),l=0;l<e.length;l++)a[l]=e.charCodeAt(l);var s=new window.zip.Inflater,c=s.append(a);s.flush();var u=String.fromCharCode.apply(null,c);t.onFileLoadedCB(JSON.parse(u))},o.readAsBinaryString(e[0])):(o.onload=function(){r=!0;var e=o.result;e=(e=e.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f")).replace(/[\u0000-\u0019]+/g,""),t.onFileLoadedCB(JSON.parse(e))},o.readAsText(e[0]))}},this.openFileBrowser=function(){n.click()},this.cleanFileBrowser=function(){n&&n.parentNode===widget.body&&widget.body.removeChild(n),n=null}}});return n.extend({init:function(e){this._parent(e,{mode:"shared"}),this.setRepeatMode(!1);var t=this;this.initFileBrowser=function(){r=new a({onErrorCB:function(){},onFileLoadedCB:function(e){o.restoreSession(e),r.cleanFileBrowser(),r=null,t.end()}})},this.initFileBrowser()},beginExecute:function(){r||this.initFileBrowser(),r.openFileBrowser()}})}),define("DS/3DPlaySave/SaveServices",["DS/WebUtils/Tracker","DS/WebUtils/Network","DS/WebUtils/WebServices","DS/WebInfraUI/CmdScenarioUI","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WebUtils/StringUtils","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/WebUtils/Logger","DS/WebInfraUI/ConfirmBox","DS/WebInfraUI/LoadingPanel"],function(e,t,n,o,i,r,a,l,s,c,u,d,m,f){"use strict";var p,D,S,v,g,h,y,b,C,F,P={"3DSpace":{name:"3DSpace",app:"X3DCSMA_AP",module:"DS/3DPlaySave/SaveTo3DSpace"},"3DSwym":{name:"3DSwym",app:"X3DMCTY_AP",module:"DS/3DPlaySave/SaveTo3DSwym"},"3DDrive":{name:"3DDrive",app:"X3DDRIV_AP",module:"DS/3DPlaySave/SaveTo3DDrive"}},T=d("3DPlay.SaveServices","3DPlay.Log.Save");function w(){require(["DS/3DPlaySave/CmdUpload3DExp","DS/ApplicationFrame/CommandFactory"],function(e,t){t._createCommandCheckHeader(e,{ID:"Upload3Dexp",context:y.ctx}),y.lightbox&&y.lightbox.update()})}function _(){return new UWA.Promise(function(e,t){n.getPlatformServices({onComplete:function(t){if(v=[],t&&t.length>0){var n=[],o=Object.keys(P);g&&"STPA"===g.format.toUpperCase()&&["3DSwym","3DSpace"].forEach(e=>{o.indexOf(e)>-1&&o.splice(o.indexOf(e),1)});for(var i=t.length;i--;)for(var r=Object.keys(t[i]),a=o.length;a--;){var l=o[a];-1===n.indexOf(l)&&r.indexOf(l)>-1&&(n.push(l),v.push(P[l]))}}T.log("availableProviders",v),e(v)},onFailure:t})})}var I=function(){h&&a.removeNotification(h),h=null},U=function(){I();var t,n={level:"info",message:i.FileDnDFromDesktopNotif,category:"3DPlayPublishServices",sticky:!0},o=v&&v.length>0;if(o&&(n.action={label:v.length>1?i.FileDnDFromDesktopNotif_ActionTitle:i.FileDnDFromDesktopNotif_ActionTitle_1+v[0].name,callback:function(){t=!0,e.command("NotifUpload3DExp"),k()}},w()),h=r.addNotif(n),o){var l=function(){var e;return a._notifications.forEach(function(t){t._data.count===h&&(e=t)}),e}();l&&(l._action.addClassName("wux-ui-state-primary"),setTimeout(function(){var e=function(){if(!t){var n={level:"warning",message:i.FileDnDFromDesktopNotif+i["FileDnDFromDesktopNotif_2Message".concat("_CMD")],category:"3DPlayPublishServices",sticky:!0};l.getDiv().removeEventListener(c.POINTERUP,e),h=r.addNotif(n)}};l.getDiv().addEventListener(c.POINTERUP,e)},50))}return h},k=function(){var t=function(t,n){require([t.module],function(o){function a(){F.pause(),m({warning:!1,container:y.frmWindow.getViewerFrame(),caption:i.FileDnDFromDesktopConfirmBox_Title,info:i.FileDnDFromDesktopConfirmBox_Text,confirm:{callback:function(){F.abort(),A(),I(),r.addNotif({level:"success",message:i.FileDnDFromDesktopConfirmBox_Aborted,category:"3DPlayPublishServices"}),T.log("canceled"),c("canceled"),e.command("NotifUpload3DExp"),N(!1)},text:i.FileDnDFromDesktopConfirmBox_Confirm},cancel:{callback:function(){F.isFinished()||(F.resume(),l())},text:i.FileDnDFromDesktopConfirmBox_Cancel}}),e.command("NotifUpload3DExp")}function l(){(S=new f({container:document.getElementById("canvas-div"),showButtonsFlag:"closeButtonOnly",title:n.name,info:D})).setCloseButtonCB(a),S.setTitleString(n.name),S.setInfoString(D),S.on(),S.value=0}function c(o){var i=s.getExtension(n.name);e.trackPageEvent("save",i,t.name,{success:200,failed:1,canceled:2,timeout:3}[o],{fileSize:Math.floor(n.size/1e3)}),y.getPhaseProgress().hideProgressBar()}o(n,{frame:y.frmWindow.getImmersiveFrame(),frmWindowContent:y.frmWindow.getContent(),timeout:54e5,onStartUpload:function(e,t){F=e,D=t,l()},onComplete:function(e){T.log("onComplete"),c("success"),I(),r.addNotif({level:"success",message:i.FileDnDFromDesktopNotif_PublishOK+t.name,category:"3DPlayPublishServices"}),C(e),x()},onCancel:function(){T.log("canceled"),c("canceled"),A(),N(!1)},onTimeout:function(){c("timeout"),r.addNotif({level:"error",message:i.FileDnDFromDesktopNotif_ErrorTimeout,category:"3DPlayPublishServices"}),T.error("Upload",t.name,"timeout"),A(),N(!1)},onFailed:function(e){c("failed"),r.addNotif({level:"error",title:e.displayMessage?i.FileDnDFromDesktopNotif_ErrorInPublish:void 0,message:e.displayMessage?e.displayMessage:i.FileDnDFromDesktopNotif_ErrorInPublish,category:"3DPlayPublishServices"}),T.error("Upload",t.name,e),A(),N(!1)},onProgress:function(e){S&&(S.value=Math.round(100*e.loaded/e.total)),T.log("progress",e)},logger:T})},console.error)};if(v.length<2)t(v[0],g.localFile);else{for(var n=[],a=0;a<v.length;a++){!function(e){e.onSelectCB=function(n){o.dispose(),t(e,g.localFile)},n.push(new Promise(function(t){l.getAppInfo({appId:e.app,onComplete:function(n){e.thumbnail=n.icon,t()}})}))}(v[a])}Promise.all(n).then(function(){n=null,I(),h=void 0,o.create({frmWnd:y.frmWindow,listchooser:v,title:i.FileDnDFromDesktopNotif_ChooserTitle,endcb:function(){N(!1)}})})}N(!0)};function N(e){y&&y.lightbox&&y.lightbox.manageUploadCommand(e)}function A(){S&&(S.off(),setTimeout(function(){S&&(S.dispose(),S.destroy(),S=null)},2e3))}function x(){y&&y.lightbox&&y.lightbox.onUploadCompleted(),void 0,void 0,void 0,A(),o.dispose()}return function(e,t,n){if(p)return p=!1,void w();e?(g=e.loadAssetInfo,y=n,C=t,b||(b=!0,y.subscribe("SCENARIO/CHANGE",function(e){p="FTA"===e.scenario.name},!0),y.subscribe("ASSET/LOADINGSTARTED",x,!0),y.disposeFunctions.add(function(){x(),b=void 0})),_().then(U)):_().then(k)}}),define("DS/3DPlaySave/Save3DComment",["DS/ApplicationFrame/Command","DS/WebSystem/SessionManager","DS/WebSystem/Downloader"],function(e,t,n){"use strict";return e.extend({beginExecute:function(){!async function(){const e=await t.getSession(),o=JSON.stringify(e);n("3DPlaySession.json",new Blob([o],{type:"json"}))}(),this.end()}})}),define("DS/3DPlaySave/SaveControler",[],function(e){"use strict";return function(){return{setRequest:function(e){this.req=e},onResume:function(e){this.resumeCB=e},isFinished:function(){return!0===this._finished},isAborted:function(){return!0===this._aborted},isPaused:function(){return!0===this._pause},finish:function(){this._finished=!0},abort:function(){this._aborted=!0,this.req&&this.req.cancel(),this.finish()},pause:function(){this._pause=!0},resume:function(){this.resumeCB&&this.resumeCB(),this._pause=!1}}}}),define("DS/3DPlaySave/SaveTo3DDrive",["DS/WebUtils/Tracker","DS/WAFData/WAFData","DS/UIKIT/Spinner","DS/UIKIT/SuperModal","DS/UIKIT/Input/Text","DS/W3DDriveComponent/DriveContentSelector","css!DS/UIKIT/UIKIT.css","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/3DPlaySave/SaveControler","DS/WebUtils/StringUtils"],function(e,t,n,o,i,r,a,l,s,c,u){"use strict";return function(e,i){var a,d=c();function m(){a&&function(n,o){var r=n.url+"/resources/3ddrive/v1/bos/"+n.objectId+"/contents?update=true&withactions=true";n.tenant&&(r+="&tenant="+n.tenant);var a={"Content-Type":"application/json;charset=UTF-8"};a["X-DS-CSRFTOKEN"]=n.token;var l={};l.receipt=n.receipt,l.file=n.displayName,l.title=n.displayName,l.type="DriveFile",i.logger.log("contents",r,a),t.authenticatedRequest(r,{parse:!0,validate:!0,wait:!0,method:"POST",type:"json",headers:a,file:e,data:JSON.stringify(l),onComplete:o.onComplete,onFailure:o.onFailure})}(a,{onFailure:i.onFailed,onComplete:function(e){d.finish(),i.onComplete({objectType:"DriveFile",objectId:e.id,serviceId:"3DDrive",envId:a.envId,displayName:a.displayName}),a=null}})}function f(e){var t=document.querySelector(".drive-validation-button");t&&(t.disabled=e)}function p(){f(!0)}var D,S=new n({className:"spinner-center",visible:!0}),v=new o({className:"driveBrowserTest",closable:!1,renderTo:document.body});v.dialog({title:l.DriveBrowser_Title,body:[S],buttons:[{className:"primary drive-validation-button",value:l.DriveBrowser_Button_OK,action:function(n){var o,r;i.onStartUpload(d,u.sprintf(l.Drive_Progress_Info,D.displayName)),o=D.envId,r={onFailure:i.onFailed,onComplete:function(n){var o,r,l;o={url:n.url,envId:D.envId},r={onFailure:i.onFailed,onComplete:function(o){var r,l,s;r={ticket:o.ticket,file:e},l={timeout:i.timeout,onTimeout:i.onTimeout,onFailure:i.onFailed,onProgress:i.onProgress,onComplete:function(t){d.isAborted()?i.onCancel():(d.setRequest(null),a={url:n.url,objectId:D.objectId,envId:D.envId,token:o.token,displayName:e.name,receipt:UWA.createElement("div").setHTML(t).getElement('[name="__fcs__jobReceipt"]').value},d.isPaused()||m())}},(s=new FormData).append(r.ticket.jobticket,r.ticket.ticket),s.append("file-name",r.file.name),s.append("file_0",r.file),s.append("file-title",r.file.name),s.append("file-description",r.file.name),i.logger.log("uploadFCS",r.ticket.actionurl,r.ticket.jobticket,r.ticket.ticket),d.isAborted()||d.setRequest(t.authenticatedRequest(r.ticket.actionurl,{timeout:l.timeout,method:"POST",data:s,onTimeout:l.onTimeout,onComplete:l.onComplete,onUploadProgress:l.onProgress,onFailure:l.onFailure}))}},l=o.url+"/resources/3ddrive/v1/bos/ticket",o.tenant&&(l+="?tenant="+o.tenant),i.logger.log("_getTicket",l),t.authenticatedRequest(l,{method:"GET",type:"json",onComplete:function(e,t,n){e&&e.actionurl&&e.ticket&&e.jobticket?r.onComplete({ticket:e,token:t["x-ds-csrftoken"]}):(i.logger.error("_getTicket no response Ticket"),r.cbs&&r.onFailure())},onFailure:o.onFailure})}},s.getServiceUrl({serviceName:"3DDrive",platformId:o,onError:r.onFailure,onSuccess:r.onComplete}),n.hide()}},{value:l.DriveBrowser_Button_Cancel,action:function(e){e.hide(),i.onCancel()}}]}),p();var g={createFolder:!0,accessright:"edit",select:{type:"DriveFolder"},filter:{type:"DriveFolder"},multiEnv:!0,onSelect:function(e){e&&e.length>0&&e[0]&&"sharedwithme"!==(D=e[0]).objectId&&D.envId?f(!1):p()}};try{var h=r.create3DDriveChooser(g);S.hide(),v.modals.current.getBody().appendChild(h.container)}catch(e){v.modals.current.hide()}d.onResume(m)}}),define("DS/3DPlaySave/SaveTo3DSwym",["DS/WebUtils/Tracker","DS/UIKIT/Modal","DS/WAFData/WAFData","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/WebUtils/StringUtils","DS/3DPlaySave/SaveControler"],function(e,t,n,o,i,r,a){"use strict";return function(e,l){var s,c,u,d,m,f=a();function p(){m.id&&(d.addEvent("ContentCreated",function(e){c();try{e=JSON.parse(e)}catch(t){e=""}if(!0===e.success){var t={objectType:"media",objectId:e.contentSubjectURI,serviceId:"3DSwym",envId:m.tenant,displayName:m.displayName};l.onComplete(t)}else l.onFailure();e.finish(),l.logger.log("publishFormView.createContent",m.id)}),d.createContent(m.id))}return require(["DS/SwymPublishForm/script/publish-form-view"],function(a){d=new a({mode:"jsevent",contentTitle:e.name}),u=function(){s&&(s.destroy(),s=null)},c=function(){d&&(d.destroy(),d=null),u()},d.addEvent("CancelShare",function(){c(),l.onCancel()}),d.addEvent("StartUpload",function(t){u();var a,s=JSON.parse(t);s._currentThreadType&&s._currentThreadType,l.logger.log("StartUpload",t),l.onStartUpload(f,r.sprintf(o["Swym_Progress_Info_"+s.threadType],s.threadTitle)),a={url:s.platform_instance,onComplete:function(t){var a,u;m={tenant:i.getTenant(s.platform_instance),displayName:e.name},a={timeout:l.timeout,url:s.platform_instance,communityId:s.community_id,serverToken:t,file:e,filename:e.name,name:e.name,onTimeout:l.onTimeout,onFailure:l.onFailed,onProgress:l.onProgress,onComplete:function(e){if(f.isAborted())return l.onCancel(),void c();m.id=e.result.id,f.isPaused()||p()}},(u=new FormData).append("userFile",a.file,a.localFilename),u.append("published",1),u.append("title",a.name),u.append("community_id",a.communityId),"media"!==a._currentType&&u.append("is_illustration","true"),l.logger.log("_publish",a.url+"/api/media/add",a.communityId),f.isAborted()||f.setRequest(n.authenticatedRequest(a.url+"/api/media/add",{timeout:a.timeout,method:"POST",type:"json",headers:{"X-DS-SWYM-CSRFTOKEN":a.serverToken},data:u,onTimeout:a.onTimeout,onComplete:function(e){f.setRequest(null),e.errorcode?(l.logger.error("_publish",e),a.onFailure&&a.onFailure(e)):a.onComplete(e)},onUploadProgress:a.onProgress,onFailure:function(e,t,n){a.onFailure({error:e,response:t,headers:n,displayMessage:t&&t.errorcode&&r.sprintf(o["Swym_"+t.errorcode],"3DSwym")||"File exceeds 3DSwym's size limit"})}}))},onFailure:l.onFailed},l.logger.log("_getServerToken",a.url+"/api/index/tk"),n.authenticatedRequest(a.url+"/api/index/tk",{method:"GET",type:"json",onComplete:function(e){e&&e.result&&e.result.ServerToken?a.onComplete(e.result.ServerToken):(l.logger.error("_getServerToken No response"),a.onFailure&&a.onFailure())},onFailure:a.onFailure})}),(s=new t({closable:!1,header:o.SwymPublish_Title,body:d.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),s.show()}),f.onResume(p),f}}),define("DS/3DPlaySave/SaveTo3DSpace",["DS/WebUtils/WebServices","DS/WebSystem/App","DS/3DPlaySave/SaveControler"],function(e,t,n){"use strict";return function(e,o){var i,r=n(),a=function(t,n){o.logger.log("PlateformInfo :",t["3DSpace"],t.platformId,n);var r=new i({tenantUrl:t["3DSpace"],tenant:t.platformId,securityContext:n,immersiveFrame:o.frame,getWorkUnderHeaders:function(){return{}},onUploadStart:function(){o.logger.log("onUploadStart");try{widget.body.querySelector(".doco-progress-progresspane").inject(o.frmWindowContent)}catch(e){console.error(e)}},onCancel:o.onCancel,onError:o.onFailed,onDocumentUpload:function(n){o.logger.log("onDocumentUpload");var i=n.documents[0];o.onComplete({objectId:i.id,objectType:i.type,envId:t.platformId,serviceId:"3DSpace",displayName:e.name}),r.destroy(),r=null}});r.create([e])};return require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PADServices/utils/GlobalUtils","DS/DocumentCreateNew/CreateNew"],function(e,n,r){i=r;var l=[];n.getSecurityContext()||l.push(new Promise(function(e){require(["DS/PADServices/utils/PlatformURL"],function(t){t.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}).then(()=>{n.retrieveAndSetSC().then(e)})})})),e.getPlatformServices({serviceName:"3DSpace",onError:o.onFailed,onComplete:function(e){t.isOnCloud()&&e.length>1?parent.require(["DS/Dashboard/Modals/PlatformSelect","i18n!DS/Dashboard/assets/nls/modal"],function(t,i){var r=[];e.forEach(e=>{e["3DSpace"]&&r.push(e)}),o.logger.log(e,r),e=null,t.show({message:i.noPlatformSelectContent,closable:!0,platforms:r,onCancel:o.onCancel,onConfirm:function(e){Promise.all(l).then(()=>{a(e,n.getSecurityContext())})}})}):Promise.all(l).then(()=>{a(e[0],n.getSecurityContext())})}})}),r}}),define("DS/3DPlaySave/CmdUpload3DExp",["DS/ApplicationFrame/Command","DS/WebUtils/Tracker","DS/3DPlaySave/SaveServices"],function(e,t,n){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!1}),this.enable()},execute:function(){t.command(this.getId()),n()}})});