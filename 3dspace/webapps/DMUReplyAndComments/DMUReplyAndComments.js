define("DS/DMUReplyAndComments/DMUCreateSlideReplyCmd",["UWA/Utils","DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/Selection/CSOManager","i18n!DS/DMUReplyAndComments/assets/nls/DMUReplyAndComments"],function(e,t,n,i,r,a,o,s,l){"use strict";return t.extend({init:function(t){t.mode="shared",t.repeatMode=!1,t.isAsynchronous=!0,this._parent(t);let u=this;this.beginExecute=function(){require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateSlideReply")});let t=u.getFrameWindow(),m=n.getReviewContext({viewer:t.getViewer()}),d=m?m.getValidation():null,g=d?d.getCurrentMarkup():null;if(d&&g){let n=r.giveDMUSlidesController({context:t}),D=n.getRepliedSlide();if(!D){const e=s.get();if(e&&1===e.length){const t=m.getDMUObjectFromPathElement(e[0].pathElement);"DMUSlide"===t.getType()&&(D=t)}}let U=m.getCurrentSessionMarkup();if(U&&D){let r=a.getUserLogin(),s=D.getAttribute("sParentSlideID");s||(s=D.getAttribute("sUuid"));let c=D.getAttribute("sName");c&&(c=c.replace(l.replyTo,""));var p=[{name:"sID",value:U.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sOwner",value:a.getUserLogin()},{name:"fCreationDate",value:Date.now()},{name:"sName",value:U.computeNewName({object:D,prefix:c,noSuffixIfPossible:!0,separator:"parenthesis"})},{name:"sParentSlideID",value:s}];let M=g;for(;M&&"Markup"!==M.getValType();)M=M.getParentRepRef().getParent();let f=function(){let e=i.getManager({name:"DMUUserExperienceManager",context:t});e?e.duplicateDMUElements({elements:[D],parent:m.getCurrentSessionMarkup(),attributes:[p],cb:function(e){if(e&&e.duplicatedElements&&1===e.duplicatedElements.length){let t=D.getEnvironmentOverload(),i=m.getEnvironment().getEnvironmentInfo();i.sFocusProperty=t.state.sFocusProperty,e.duplicatedElements[0].updateEnvironmentOverload({target:m.getEnvironment(),state:i}),n.setActiveSlide(e.duplicatedElements[0],{duration:0})}u.end()}}):u.end()};if(M){let e=function(e){n.setSlideLoading(D.getAttribute("sUuid"),!0),o.addReply({markupRef:M,existingRepRef:e,viewer:t.getViewer(),validation:d,onReplyCreationCompleted:function(e){d.setCurrentMarkup(e.replyRepRef),f(),n.setSlideLoading(D.getAttribute("sUuid"),!1)},onReplyCreationFailed:function(){n.setSlideLoading(D.getAttribute("sUuid"),!1),u.end()}})},i=M.getReplies(),a=!1;i.some(t=>{if(t.isWebMarkup&&t.isWebMarkup()&&(t.getOwner&&t.getOwner()===r||t.getRepRef()&&t.getRepRef().getOwner&&t.getRepRef().getOwner()===r)){let n=t.getRepRef();n.hasStream()?(d.setCurrentMarkup(t),f()):e(n),a=!0}return a}),a||e()}else u.end()}}}}})}),define("DS/DMUReplyAndComments/DMUCommentReplyCreateCmd",["UWA/Utils","DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUPlayComment/DMUComment","DS/DMUBaseUI/DMUToolsUsers","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/Selection/CSOManager","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUReplyAndComments/assets/nls/DMUReplyAndComments"],function(e,t,n,i,r,a,o,s,l,u){"use strict";return t.extend({init:function(t){t.mode="shared",this._parent(t);var m=this;function d(t,n){let i=new r(m.getFrameWindow().getViewer(),t),o=[{name:"sID",value:t.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:t.computeNewName({object:i,prefix:u.commentPrefix})},{name:"sOwner",value:a.getUserLogin()},{name:"sTextContents",value:[""]},{name:"fCreationDate",value:Date.now()},{name:"fLastModificationDate",value:Date.now()}];return n&&o.push({name:"sParentCommentId",value:n.getAttribute("sUuid")}),i.setAttributes(o),i}this._parentBeginExecute=this.beginExecute,this.beginExecute=function(){this._parentBeginExecute();var e=n.getReviewContext({viewer:this.getFrameWindow().getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(!t)return void m.end();var r=s.get();if(!r||1!==r.length)return void m.end();var u=i.giveDMUCommentsController({context:m.getFrameWindow()}),g=u.getDMUObjectFromPathElement(r[0].pathElement);if(!g)return void m.end();let p=e?e.getValidation():null,D=g.getParent().getMarkupOwner();if(p&&D){s.empty();let e=D;for(;e&&"Markup"!==e.getValType();)e=e.getParent();if(e){let t=function(e){let t=e.getMarkupContent();if(t){let e=d(t,g);if(t.addComment(e),e){let t=l.buildPathElement(e.getNode());t&&s.add({pathElement:t})}e.fireEvent("onDMUObjectInitialized",{dmuObject:e,parentObject:g}),e.fireEvent("onDMUCommentEditionRequired",{dmuObject:e,parentObject:g})}else n(e)},n=function(n){u.setCommentLoading(g.getAttribute("sUuid"),!0),o.addReply({markupRef:e,existingRepRef:n,viewer:m.getFrameWindow().getViewer(),validation:p,onReplyCreationCompleted:function(e){t(e.replyRepRef),u.setCommentLoading(g.getAttribute("sUuid"),!1)},onReplyCreationFailed:function(){u.setCommentLoading(g.getAttribute("sUuid"),!1),m.end()}})},i=e.getReplies(),r=a.getUserLogin();i.some(e=>{if(e.isWebMarkup&&e.isWebMarkup()&&(e.getOwner&&e.getOwner()===r||e.getRepRef()&&e.getRepRef().getOwner&&e.getRepRef().getOwner()===r))return t(e.getRepRef()),!0})||n()}else m.end()}else{var U=r[0].pathElement.getSubPath(function(e){return e.getDMUType&&"DMUComment"!==e.getDMUType()}),c=t.getDMUObjectFromPathElement(U);let e=c.getDMUComments().indexOf(g);if(e>=0){let n=d(t);c.addDMUComment(n,e+1),n.fireEvent("onDMUObjectInitialized",{dmuObject:n}),n.fireEvent("onDMUCommentEditionRequired",{dmuObject:n})}}m.end()}}})}),define("DS/DMUReplyAndComments/DMUReplyAndComments",[],function(){});