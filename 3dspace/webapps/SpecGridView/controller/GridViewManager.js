define("DS/SpecGridView/controller/GridViewManager",["UWA/Core","UWA/Class","DS/DataGridView/DataGridView","DS/XSRCommonComponents/utils/Utils","DS/SpecGridView/controller/GridColumn","DS/XSRCommonComponents/utils/Notification","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/createform/view/NewDialog","DS/XSRCommonComponents/components/XSpecDnD/DragDropUtil","i18n!DS/SpecGridView/assets/nls/SpecGridView","css!DS/SpecGridView/GridViewManger.css"],function(e,t,n,o,i,a,l,r,s,d,u){"use strict";return t.extend({init:function(t){var n=t;this._parent(n),this.appCore=n.appCore,this.itemId=n.itemId;var o=n.container,a=n.columns;this.modelEvents=n.appCore.specViewerModelEvents,this.model=n.model,this.currentTabKey=n.currentTabKey,this.rowDragEnabledFlag=!t.dvgOpts||!1!==t.dvgOpts.rowDragEnabledFlag,this.basicModelEvents=n.appCore.basicModelEvents,this.container=e.createElement("div",{id:"grid-row-view"}).inject(o),this.parentModel=t.parentModel,this.gridColumns=new i,a&&this.initializeColumns(a),this._subscribe()},_subscribe:function(){this.eventList=[]},initializeColumns:function(e){this.columnCharValidationList={},this.exportableColums=[],this.columns=this.gridColumns.process.call(this,e)},addColumn:function(e,t,n){if(!n){let n=[e];this.processedColumns=this.gridColumns.process.call(this,n),this.grid.addColumnOrGroup(this.processedColumns[0],t)}},removeColumn:function(e,t){t&&this.grid.removeColumnOrGroup(e)},setColumns:function(e){this.initializeColumns(e)},drawGrid:function(t,i){var a=this;!async function(){a.grid=new n({columns:a.columns,showModelChangesFlag:!0,showTreeIconsFlag:!0,showRowBorderFlag:!0,rowGroupingOptions:a.model.rowGroupingOptions,treeDocument:a.model,showNodeKPIColorFlag:a.model.isColorized,cellSelection:"multiple",rowSelection:"multiple",rowDragEnabledFlag:a.rowDragEnabledFlag,onContextualEvent:function(e,t){if(e&&e.collectionView&&e.cellInfos){e.collectionView.columns.length;var n=e.cellInfos.columnID,o=e.cellInfos.rowID;if(!(n>=0&&o>=0))return e.collectionView.buildDefaultContextualMenu(e,t);e.cellInfos.nodeModel.isSelected()||(e.collectionView.unselectAll(),e.cellInfos.nodeModel.select());var i=a.currentTabKey?l.GRID_CONTEXT_MENU+"-"+a.currentTabKey:l.GRID_CONTEXT_MENU;a.modelEvents&&a.modelEvents.publish({event:i,data:e})}}.bind(this)}),a.grid.inject(a.container),a.grid.layout.cellHeight=24,a.model.setLayoutInstance(a.grid.layout),a.grid.onCustomViewsSave=function(t,n){var i=t,l=r.getSecurityContext();if("bom"===a.currentTabKey||"formulatedbom"===a.currentTabKey){if("VPLMAdmin"===l.split("::")[1].split(".")[0]&&"DefaultConfiguration"===t[n].identifier){var d={},c=new e.Element("div",{class:"Update-Dialog-Option-Container"}),m=new e.Element("div",{class:"xsr-update-message-icon"}).inject(c);new e.Element("span",{class:"xsr-update_warning_icon fonticon fonticon-attention fonticon-2x"}).inject(m),new e.Element("p",{class:"message-container",html:u.Update_Attribute}).inject(m),d.position={at:"center",my:"center"},d.Title=u.Update_Att_Title,d.Content=c,d.width=450,d.height=150,d.renderTo=document.getElementById("xspecsContainer"),d.RemoveApplyButton=!0,d.OKLabel="OK";var g=new s(d);g.render(),g._dialog.buttons.Ok.disabled=!1,g.listenTo(g,"EVENT_CLICK_SPEC_CANCEL",async function(){var e=await o.loadBOMCustomViewConfiguration(a.currentTabKey);delete e.tab;let t={identifier:"DefaultConfiguration",label:"Default Configuration",columnsVisibleFlag:JSON.parse(e)};a.grid.loadCustomViews([t],0)}),g.listenTo(g,"EVENT_CLICK_SPEC_OK",function(){g.closeDialog(),o.saveBOMCustomConfiguration(i,a.currentTabKey)})}"VPLMAdmin"!==l.split("::")[1].split(".")[0]&&(widget.setValue("CustomGridViews"+a.currentTabKey,i),widget.setValue("CurrentCustomViewIndex"+a.currentTabKey,n))}"bom"!==a.currentTabKey&&"formulatedbom"!==a.currentTabKey&&(widget.setValue("CustomGridViews"+a.currentTabKey,i),widget.setValue("CurrentCustomViewIndex"+a.currentTabKey,n))};var t,i=widget.getValue("CustomGridViews"+a.currentTabKey),c=widget.getValue("CurrentCustomViewIndex"+a.currentTabKey);if(t="number"==typeof c?c>=0:c,"bom"===a.currentTabKey||"formulatedbom"===a.currentTabKey){var m=await o.loadBOMCustomViewConfiguration(a.currentTabKey);if(delete m.tab,i&&t)a.grid.loadCustomViews(i,c);else if(m){let e={identifier:"DefaultConfiguration",label:"Default Configuration",columnsVisibleFlag:JSON.parse(m)};a.grid.loadCustomViews([e],0)}}"bom"!==a.currentTabKey&&"formulatedbom"!==a.currentTabKey&&i&&t&&a.grid.loadCustomViews(i,c),a.rowDragEnabledFlag&&(a.grid.onDragStartRowHeaderDefault=function(e,t){a.model.unselectAll(),t.nodeModel.select();var n=(new d).prepareDragData(a.model.getSelectedNodes());e.dataTransfer.effectAllowed="all",e.dataTransfer.setData("text",n)},a.grid.onDragOverRowHeader=function(){console.log("Drag over ignored to avoid css change in UI")},a.grid.onDragOverCell=function(){console.log("Drag over cell ignored to avoid css change in UI")},a.grid.onDropRowHeader=function(e,t){console.log("Drop ignored")});a.grid.getTypeRepresentationFactory().registerTypeTemplates(JSON.stringify({UWAObjectTemplate:{path:"DS/SpecGridView/utils/UWAObjectTemplate",options:{}}})),a.addEvents();var g={};g[u.label_Yes]=!0,g[u.label_No]=!1;var p={contextMenu:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"chevron-down",fontIconFamily:1}}},quickViewMenu:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"eye",fontIconFamily:1}}},positiveInteger:{stdTemplate:"spinEdit",semantics:{stepValue:1,minValue:1}},UWAObject:{stdTemplate:"UWAObjectTemplate"},DisplayBooleanCombobox:{stdTemplate:"enumCombo",semantics:{possibleValues:g,valueType:"enumCusto"}}};a.grid.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(p))}(),this.model.unselectAll(),i?a.hide():a.show()},addEvents:function(){var t=this;this.grid.getCellsXSO().onPostAdd(function(n){if(n&&e.is(n,"array")&&1==n.length){t.grid.unselectAll(),!n[0].nodeModel._canBeGrouped()?setTimeout(function(){n[0].nodeModel.select()},50):n[0].nodeModel.select()}}),this.grid.addEventListener("click",function(e,n){if(void 0!==n&&-1!==n.rowID){if(!e.target.hasClassName("wux-tweakers-string-icon"))return;var o=e.dsModel.layout.getDataIndexFromColumnIndex(n.columnID);if("Alternate"===o){let e={cellInfo:n,column:o};t.modelEvents&&t.modelEvents.publish({event:l.EVENT_BOM_GRID_ICON_CLICK,data:e})}}}),this.grid.addEventListener("dragstart",function(e,t){o.dragStartedInXSR=!0}),this.grid.addEventListener("dragend",function(e,t){o.dragStartedInXSR=!1}),this.grid.addEventListener("preEdit",function(e,n){t.grid.getTreeDocument().cancelChanges()});var n=function(e){if(e.columnIndex)var n=e.columnIndex;else n=t.grid.layout.getDataIndexFromColumnIndex(e.columnID);var i=e.cellModel,r=e.nodeModel?e.nodeModel.getReferenceValue(n):void 0;r=r&&Array.isArray(r)?r[0]:r;var s="string"==typeof i?i.trim():i;"date"===t.grid.layout.getColumnTypeRepresentation(e.columnID)&&("Invalid Date"===(s=new Date(i).toUTCString())&&(s=""));if(n.startsWith("bom")||n.startsWith("formulatedbom")){var d=t.grid.getColumnOrGroup(e.columnID);!d||"bom"!==e.nodeModel.currentTabKey&&"formulatedbom"!==e.nodeModel.currentTabKey||(e.nodeModel.setCustomDimensionType(d.dimensionType),e.nodeModel.setCustomUnit(d.unit))}if(s!==r)if(t.columnCharValidationList&&t.columnCharValidationList[n]&&o.hasBadChar(s)){var c=u.replace(u.get("FailedToUpdateCell"),{forbiddenChar:l.FORBIDDEN_CHARS});a.displayNotification({eventID:"error",msg:c}),t.modelEvents&&t.modelEvents.publish({event:"xsr-show-toolbar-reset-command-"+t.currentTabKey})}else t.modelEvents&&(t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey}),t.modelEvents.publish({event:"grid-cell-value-update-"+t.currentTabKey,data:{nodeModel:e.nodeModel,newValue:s,oldValue:r,dataIndex:n}}));else t.modelEvents&&t.modelEvents.publish({event:"xsr-hide-toolbar-reset-command-"+t.currentTabKey})};this.grid.getTreeDocument().onNodeModelUpdate(function(e){if(e.data.attributes){var t=e.data.attributes;if(t.quantity)(o={}).columnIndex=l.COLUMN_QUANTITY,o.nodeModel=e.target,o.cellModel=t.quantity,n(o);else if(t.hasOwnProperty("asRequired")){(o={columnIndex:"asRequired"}).nodeModel=e.target,o.cellModel=t.asRequired,n(o)}else if(t.hasOwnProperty("unitNLS")){(o={columnIndex:"unitNLS"}).nodeModel=e.target,o.cellModel=t.unitNLS,n(o)}else if(t.hasOwnProperty("minQuantity")){(o={columnIndex:"minQuantity"}).nodeModel=e.target,o.cellModel=t.minQuantity,n(o)}else if(t.hasOwnProperty("maxQuantity")){(o={columnIndex:"maxQuantity"}).nodeModel=e.target,o.cellModel=t.maxQuantity,n(o)}else if(t.hasOwnProperty("targetQuantity")){var o;(o={columnIndex:"targetQuantity"}).nodeModel=e.target,o.cellModel=t.targetQuantity,n(o)}}}),this.grid.addEventListener("change",function(e,o){void 0===o||"double"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"boolean"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"independantBoolean"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"string"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"integer"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"date"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)&&"real"!==t.grid.layout.getColumnTypeRepresentation(o.columnID)||n(o)})},highlightCell:function(e,t){if(e&&t){var n=this.grid.layout.getColumnIndex(t),o=this.grid.layout.getCellIDFromCoordinates({rowID:e,columnID:n});o&&this.grid.selectCell(o)}},setColumnVisibilityFlag:function(e,t){this.grid.layout.setColumnVisibleFlag(e,t)},exportCSV:function(e){var t=this.grid.layout.getVisibleOrderedColumnsIndexes();let n=this.grid.columns.reduce((e,t)=>(e[t.dataIndex]=t.text,e),{});var i=[];let a="",r="",s=!1;if(t&&t.length>0){for(var d=0;d<t.length;d++){var u=t[d],c=this.grid.layout.getDataIndexFromColumnIndex(u);if(this.exportableColums.indexOf(c)>=0)switch(i.push(c),a+=n[c]+",",c){case"tree":r+=this.parentModel.getAttributeValue("ds6w:label")+",";break;case"partNumber":r+=this.parentModel.getAttributeValue("ds6wg:EnterpriseExtension.V_PartNumber")+",";break;case"ds6w:type":r+=this.parentModel.getAttributeValue("ds6w:type")+",";break;case"ds6wg:revision":r+=this.parentModel.getAttributeValue("ds6wg:revision")+",";break;case"ds6w:status":r+=this.parentModel.options.maturity+",";break;case"name":r+=this.parentModel.options.name+",";break;case"ds6w:description":r+=this.parentModel.options.description+",";break;case"ds6w:responsible":r+=this.parentModel.getAttributeValue("ds6w:responsible")+",";break;case"ds6w:modified":r+=o.getExportCellDateFormat(this.parentModel.options.lastmodified)+",";break;case"ds6w:created":r+=o.getExportCellDateFormat(this.parentModel.options.originated)+",";break;case"level":r+="0,",s=!0;break;default:r+=","}}let g=this.currentTabKey===l.FORMULABOM_TAB;this.currentTabKey===l.BOM_TAB&&(g=!s);var m=this.grid.getAsCSV({forceQuotes:!1,allColumns:!1,onlySelectedRows:!(!e||!e.onlySelectedRows)&&e.onlySelectedRows,columnKeys:i,columnSeparator:e&&e.columnSeparator?e.columnSeparator:void 0,addLevelInformation:g});this.currentTabKey===l.BOM_TAB&&(g&&(a=","+a,r=","+r),m=a+"\n"+r+"\n\n"+m.trim()),o.downloadCSV(m,e.fileName)}},personalizeColumns:function(){this.grid.showCustomViewsDialog()},hide:function(){this.container.setStyle("display","none")},show:function(){this.container.setStyle("display","block")},destroy:function(){this.eventList&&this.eventList.length>0&&this.modelEvents.unsubscribeList(this.eventList)}})});