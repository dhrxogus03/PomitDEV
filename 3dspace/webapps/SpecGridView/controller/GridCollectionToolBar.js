define("DS/SpecGridView/controller/GridCollectionToolBar",["UWA/Core","UWA/Class","DS/Menu/Menu","DS/XSRCommonComponents/utils/XSRMask","DS/XSRCommonComponents/utils/XspecEvents","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/Constants","DS/ENOXCollectionToolBar/js/ENOXCollectionToolBar","DS/XSRCommonComponents/utils/Notification","i18n!DS/SpecGridView/assets/nls/SpecGridView"],function(e,t,i,n,o,a,r,s,d,l){"use strict";return t.extend({init:function(e){this.indexSwitcherTimeout=null,this.appCore=e.appCore,this.modelEvents=e.appCore.specViewerModelEvents,this.currentTabKey=e.currentTabKey,this.target=e.target,this.preferredView=e.preferredView,this.container=e.container,this.toolBarEvents=new o,this.hiddenCmds=[],this.currentViewType,this._subscribeEvents(),this.parentModel=e.parentModel},draw:function(e){e&&(this.target=e);var t={modelEvents:this.toolBarEvents,withmultisel:!0,showItemCount:!0,actions:this.actionCommands,multiselActions:null,multiselActionCallback:this.getMultipleActions.bind(this),filter:{multiselect:!1,enableCache:!1},sort:[],currentView:this.preferredView?this.preferredView:r.GRID_VIEW,views:this.currentTabKey===r.FACET_MBMF||this.currentTabKey===r.FORMULABOM_TAB||"bom"===this.currentTabKey?[]:[{id:r.BIG_TILE,text:l.bigTile,fonticon:"view-big-tile"},{id:r.GRID_VIEW,text:l.DataGridView,fonticon:"tree-table"}],currentNbitems:0,currentNbSelections:0};if(this.collectionToolbar=new s(t),this.collectionToolbar.inject(e),this.hideCommand("ResetChanges"),this.hideCommand("Unwraptext"),"bom"===this.currentTabKey||this.currentTabKey===r.FORMULABOM_TAB)if("index"===widget.getValue("fetchmode"))parseInt(widget.getValue("intervalswitchpreference"))>0?this.hideCommand("authormode"):this.hideCommand("indexmode");else if(parseInt(widget.getValue("intervalswitchpreference"))>0){parseInt(widget.getValue("previousindexed"))+parseInt(widget.getValue("intervalswitchpreference"))<Math.floor(Date.now()/1e3)?(this.hideCommand("authormode"),widget.setValue("fetchmode","index")):(this.hideCommand("indexmode"),this.initiateTimer())}else this.hideCommand("indexmode")},initiateTimer(){let e=this;e.indexSwitcherTimeout&&clearTimeout(e.indexSwitcherTimeout);var t=parseInt(widget.getValue("intervalswitchpreference"))||.02;e.indexSwitcherTimeout=setTimeout(function(){e.indexSwitcherTimeout=null,e.hideCommand("authormode"),e.showCommand("indexmode"),parseInt(widget.getValue("intervalswitchpreference"))>0&&d.displayNotification({eventID:"info",msg:l.INDEX_MODE_ACTIVE}),widget.setValue("fetchmode","index"),e.launchCommand("authormode")},1e3*t)},_subscribeEvents:function(e){var t=this;this.subscriptionList=[],this.modelEvents&&(this.subscriptionList.push(this.modelEvents.subscribe({event:r.UPDATE_ITEMVIEW_TOOLBOOR_COUNT},function(e){var i=t.currentModel?t.currentModel.getSelectedNodes().length:0;i>0?t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_CHECKBOX_CHECK_FLAG,data:{}}):t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_CHECKBOX_UNCHECK_FLAG,data:{}}),t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_SELECTIONS_COUNT_UPDATE,data:i}),t.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_EVENT_UPDATE_COUNT,data:i})})),this.subscriptionList.push(t.modelEvents.subscribe({event:"xsr-toolbar-switch-fetch-mode-to-author"},function(){t.switchToAuthorMode()})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-show-toolbar-reset-command-"+t.currentTabKey:"xsr-show-toolbar-reset-command"},function(){t.showCommand("ResetChanges")})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-hide-toolbar-reset-command-"+t.currentTabKey:"xsr-show-toolbar-reset-command"},function(){t.hideCommand("ResetChanges")})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-hide-toolbar-makeFrom-command-"+t.currentTabKey:null},function(e){e&&(t.hideMBMFCommand=e.disableMBMFCmd,t.hideMBMFFPCommand=e.disableMBMFCmd)})),this.subscriptionList.push(t.modelEvents.subscribe({event:t.currentTabKey?"xsr-hide-toolbar-add-corematerial-command-"+t.currentTabKey:null},function(e){e&&(t.disableAddCoreMatCmd=e.disableAddCoreMatCmd)}))),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_EVENT_ALL_SELECTED},function(e){t.currentModel.gridLayout.collectionView.selectAllVisibleNodes()}),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_EVENT_ALL_UNSELECTED},function(e){t.currentModel.unselectAll()}),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_EVENT_VIEW_ACTIVATED},function(e){e!==t.currentViewType&&(t.currentViewType=e,t.launchResetModelChanges(),t.switchView(e))}),t.toolBarEvents.subscribe({event:r.COLLECTION_TOOLBAR_SEARCH},function(e){var i=t.currentModel;i.prepareUpdate();var n=i.getChildren();if(t.showAllNodes(n),t.parentModel.getAllDescendants().forEach(e=>{e._isHidden=!1}),!e.searchValue[0]||0===e.searchValue.length)return t.baseModel?void t.baseModel.pushUpdate():void i.pushUpdate();var o=[];i.search({match:function(i){var n,a=i.nodeModel;if(!a._canBeGrouped())return!1;if(!a.getTitle)return!0;if(a.currentTabKey===r.MEI_TAB||void 0!==a.getMEIInterface&&a.getMEIInterface()===r.MEI_INTERFACE)n=a.getTitle()+" "+a.getMaturity()+" "+a.getType()+" "+a.getName()+" "+a.getRevision()+" "+a.getOriginatedDate()+" "+a.getModifedDate()+" "+a.getDescription()+" "+a.getMftPartNo()+" "+a.getManufacturer()+" "+a.getPartSource()+" "+a.getPartSourceURL()+" "+a.getOwner()+" "+a.getEqQualIsPreferred();else{let e=widget.getValue(r.PERSISTENCY_BOM_VIEW);var s=a.getPartNumber?a.getPartNumber():"",d=a.getAsRequired?a.getAsRequired():"",l=a.getInstanceCount?a.getInstanceCount():"",c=a.getUnit?a.getUnit():"",u=a.getMBMFReferenceName?a.getMBMFReferenceName():"",h=a.getCoreMat?a.getCoreMat():"",m=a.getAllAttributeValue?a.getAllAttributeValue():"";n=s+" "+d+" "+l+" "+c+" "+(a.getTitle?a.getTitle():"")+" "+(a.getMaturity?a.getMaturity():"")+" "+(a.getType?a.getType():"")+" "+(a.getName?a.getName():"")+" "+(a.getRevision?a.getRevision():"")+" "+(a.getModifedDate?a.getModifedDate():"")+" "+(a.getOriginatedDate?a.getOriginatedDate():"")+" "+(a.getDescription?a.getDescription():"")+" "+(a.getOwner?a.getOwner():"")+" "+u+" "+h+" "+m,!e&&a.getInstanceTitle&&(n+=a.getInstanceTitle())}if(e.searchValue[0]&&-1!==n.toUpperCase().indexOf(e.searchValue[0].toUpperCase())){if(a.setSearchFilterState&&a.setSearchFilterState(!0),"bom"===t.currentTabKey){let e=a.getParent();for(o.push(a.getID());null!=e&&(e.getID&&o.push(e.getID()),null!==(e=e.getParent())););a.getRoot()&&a.getRoot().getID()&&o.push(a.getRoot().getID())}return!1}return a.setSearchFilterState&&a.setSearchFilterState(!1),!0}}).forEach(function(e,t){!e._canBeGrouped()||!e.getTitle||e.getID&&o.includes(e.getID())||(e.unmatchSearch(),e.setSearchFilterState&&e.setSearchFilterState(!1),e.applyFilters&&e.applyFilters())}),i.pushUpdate()})},showAllNodes:function(e){var t=this;e&&Array.isArray(e)&&e.forEach(function(e,i){if(e._canBeGrouped()){if(e.setSearchFilterState&&e.setSearchFilterState(!0),e._options.children&&e._options.children.length>0){e._options.children.forEach(e=>{e.setSearchFilterState&&e.setSearchFilterState(!0),e._isHidden=!1})}e.applyFilters&&e.applyFilters()}else t.showAllNodes(e.getChildren())})},switchView:function(e){var t=this.currentTabKey?"grid-toolbar-switch-view-"+this.currentTabKey:"grid-toolbar-switch-view";this.modelEvents&&this.modelEvents.publish({event:t,data:e})},getMultipleActions:function(e){var t=this.currentTabKey?r.UPDATE_MULTI_TOOLBAR_MENU+"-"+this.currentTabKey:r.UPDATE_MULTI_TOOLBAR_MENU;this.modelEvents&&this.modelEvents.publish({event:t,data:{target:e}})},setActions:function(e){this.actionCommands=this.drawMenus(e)},setCurrentModel:function(e){this.currentModel=e,this.baseModel=e},setTooltip:function(e,t,i,n){if("bomViews"===e.id&&i&&e.tooltip){let i=widget.getValue(t);var o;o=void 0!==i?i?l.label_QuantityMode:l.label_InstanceMode:n?l.label_QuantityMode:l.label_InstanceMode,e.tooltip.getBody().setText(o)}},setDefaultTooltip:function(e,t,i,n){if("bomViews"===e&&n){let e=widget.getValue(i);return void 0!==e?e?l.label_QuantityMode:l.label_InstanceMode:t}},setCommandFontIcon:function(e,t,i,n){if("bomViews"===e.id&&i&&e.fonticon){let i,o,a=widget.getValue(t),r="fonticon fonticon-";void 0!==a?(i=a?"object-reference":"object-instance",o=a?r+"object-reference":r+"object-instance"):(i=n?"object-reference":"object-instance",o=n?r+"object-reference":r+"object-instance"),e.fonticon=i,e.elements.icon.className=o}},getCommandIcon:function(e,t,i){if("bomViews"===e){let e=widget.getValue(t);return void 0!==e?e?"object-reference":"object-instance":i}},drawMenus:function(e){var t=[],i=this;if(e.forEach(function(e){var n={};n.id=e.key;var o=e.persistencyKey,a=e.isSelectable;if(n.text=e.text,n.title=e.text,n.fonticon=e.fonticon,n.disabled=e.disabled,o&&a){let t=i.setDefaultTooltip(e.key,e.text,o,a);n.title=n.text=t;let r=i.getCommandIcon(e.key,o,n.fonticon);n.fonticon=r}var r=e.subMenu;n.handler=r?function(e){var t=e.target.getBoundingClientRect();i.drawSubMenu(t,r,this,o,a)}:i.launchCommand.bind(i,e.key),t.push(n)}),this.currentTabKey!==r.FACET_MBMF&&"test-method-facet"!==this.currentTabKey){var n={id:"Export"};n.text=l.ExportCSV,n.title=l.ExportCSV,n.fonticon="export",n.handler=i.launchCommand.bind(i,"Export"),t.push(n)}if("bom"===this.currentTabKey||this.currentTabKey===r.FORMULABOM_TAB){var o={id:"authormode"};o.text=l.AuthorMode,o.title=l.AuthorMode,o.fonticon="database-hourglass infoIconActive",o.handler=function(){i.hideCommand("authormode"),i.showCommand("indexmode"),parseInt(widget.getValue("intervalswitchpreference"))>0&&d.displayNotification({eventID:"info",msg:l.INDEX_MODE_ACTIVE}),i.indexSwitcherTimeout&&clearTimeout(i.indexSwitcherTimeout),widget.setValue("fetchmode","index"),i.launchCommand(o.id)},t.push(o);var a={id:"indexmode"};a.text=l.IndexMode,a.title=l.IndexMode,a.fonticon="database-refresh",a.handler=function(){i.switchToAuthorMode()},t.push(a)}if("test-method-facet"!==this.currentTabKey){var s={id:"personalize"};s.text=l.PersonalizeView,s.title=l.PersonalizeView,s.fonticon="cog",s.handler=i.launchCommand.bind(i,"personalize"),t.push(s)}var c={id:"Wraptext"};c.text=l.Wrap,c.title=l.Wrap,c.fonticon="text-wrapping-ok",c.handler=i.launchWrapText.bind(i),t.push(c);var u={id:"Unwraptext"};u.text=l.Unwrap,u.title=l.Unwrap,u.fonticon="text-wrapping-off",u.handler=i.launchUnWrapText.bind(i),t.push(u);var h={id:"ResetChanges"};return h.text=l.ResetChanges,h.title=l.ResetChanges,h.fonticon="reset",h.handler=i.launchResetModelChanges.bind(i),t.push(h),t},switchToAuthorMode:function(){this.hideCommand("indexmode"),this.showCommand("authormode"),this.launchCommand("indexmode"),parseInt(widget.getValue("intervalswitchpreference"))>0>0?"index"===widget.getValue("fetchmode")&&(d.displayNotification({eventID:"info",msg:l.AUTHOR_MODE_ACTIVE}),widget.setValue("fetchmode","author"),widget.setValue("previousindexed",Math.floor(Date.now()/1e3)),this.initiateTimer()):(widget.setValue("fetchmode","author"),widget.setValue("previousindexed",Math.floor(Date.now()/1e3)))},launchResetModelChanges:function(){this.currentModel&&(this.currentModel.cancelChanges(),this.hideCommand("ResetChanges"))},launchWrapText:function(){n.maskLoader(this.container,l.WrapLoader);try{this.currentModel.gridLayout.collectionView.prepareUpdateView();for(var e=this.currentModel.gridLayout.columns,t=0;t<e.length;t++){var i=e[t];if("FormulaQunatityPercent"===i.dataIndex||"FormulaQuantityRange"===i.dataIndex)for(let e=0;e<i.children.length;e++)this.coreWrapOperation(i.children[e]);else this.coreWrapOperation(i)}this.currentModel.gridLayout.collectionView.pushUpdateView({updateCellContent:!0,updateCellLayout:!0,updateCellAttributes:!0},!0),this.hideCommand("Wraptext"),this.showCommand("Unwraptext"),n.unmaskLoader(this.container)}catch(e){console.error("Wraping failed!! "+e),n.unmaskLoader(this.container)}},coreWrapOperation:function(e){var t=e.dataIndex;"tree"!==e.typeRepresentation&&"string"!==e.typeRepresentation||(e._defaulttypeRepresentation=e.typeRepresentation,this.currentModel.gridLayout.setColumnTypeRepresentation(t,"textBlock")),this.currentModel.gridLayout.setColumnAutoRowHeightFlag(t,!0)},launchUnWrapText:function(){n.maskLoader(this.container,l.UnwrapLoader);try{this.currentModel.gridLayout.collectionView.prepareUpdateView();for(var e=this.currentModel.gridLayout.columns,t=0;t<e.length;t++){var i=e[t];if("FormulaQunatityPercent"===i.dataIndex||"FormulaQuantityRange"===i.dataIndex)for(let e=0;e<i.children.length;e++)this.coreUnwrapOperation(i.children[e]);else this.coreUnwrapOperation(i)}this.currentModel.gridLayout.collectionView.pushUpdateView({updateCellContent:!0,updateCellLayout:!0,updateCellAttributes:!0},!0),this.hideCommand("Unwraptext"),this.showCommand("Wraptext"),n.unmaskLoader(this.container)}catch(e){console.error("Unwraping failed!! "+e),n.unmaskLoader(this.container)}},coreUnwrapOperation:function(e){var t=e.dataIndex;"textBlock"===e.typeRepresentation&&(e.typeRepresentation=e._defaulttypeRepresentation),this.currentModel.gridLayout.setColumnAutoRowHeightFlag(t,!1)},hideCommand:function(e){var t=this.target?this.target.getElementsByTagName("li")[e]:void 0;t&&(t.setStyle("display","none"),-1===this.hiddenCmds.indexOf(e)&&this.hiddenCmds.push(e))},showCommand:function(e){var t=this.target?this.target.getElementsByTagName("li")[e]:void 0;t&&(t.setStyle("display","inline-block"),this.hiddenCmds.splice(this.hiddenCmds.indexOf(e),1))},drawSubMenu:function(e,t,n,o,s){var d=this;if(d.currentTabKey===r.BOM_TAB&&d.currentModel&&1===d.currentModel.getSelectedNodes().length){let e=d.currentModel.getSelectedNodes()[0].getTypeActualName();e&&a.isRawMaterial(e)&&(d.hideMBMFCommand=!0,d.hideMBMFFPCommand=!0),e&&a.isFormulatedProduct(e)&&(d.hideMBMFFPCommand=!0)}if(t){var l=function(e){var t=[];return e.forEach(function(e){var i={};if(i.title=e.text,"CheckItem"==e.type?i.type=e.type:i.type=e.type&&"separator"===e.type?"TitleItem":"PushItem",!d.hideMBMFCommand||"addMBMFItem"!==e.key&&"addMBMFRawMat"!==e.key||(i.state="disabled"),d.hideMBMFFPCommand&&"addMBMFFP"===e.key&&(i.state="disabled"),d.disableAddCoreMatCmd&&"addMaterial"===e.key&&(i.state="disabled"),o){let t=widget.getValue(o);null!=t?e.isDefault?i.state=t?"selected":"unselected":i.state=t?"unselected":"selected":(e.isDefault,i.state=e.isDefault?"selected":"unselected")}if(e.subMenu){e.fonticon&&(i.fonticon={family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-"+e.fonticon}),i.action={this:this,callback:function(t){d.launchCommand(e.key)}};var a=l(e.subMenu);i.submenu=a}else"PushItem"!==i.type&&"CheckItem"!==i.type||(e.fonticon&&(i.fonticon={family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-"+e.fonticon}),i.action={this:this,callback:function(t){!e.isDefault&&s?widget.setValue(o,!1):e.isDefault&&s&&widget.setValue(o,!0),d.setTooltip(n,o,s,e.isDefault),d.setCommandFontIcon(n,o,s,e.isDefault),d.launchCommand(e.key),["expandall","expandNLevel","collapseall"].includes(e.key)&&d.changeTooltipFontIcon(n,e)}});t.push(i)}),t};d.subMenus=l(t),i.show(d.subMenus,{position:{x:e.left,y:e.bottom}})}},disableCommands:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_COMMAND_DISABLE,data:i}),this.hiddenCmds.indexOf(i)>=0&&this.hideCommand(i)}},enableCommands:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.toolBarEvents.publish({event:r.COLLECTION_TOOLBAR_COMMAND_ENABLE,data:i}),this.hiddenCmds.indexOf(i)>=0&&this.hideCommand(i)}},launchCommand:function(e){var t=this.currentTabKey?"grid-toolbar-action-click-"+this.currentTabKey:"grid-toolbar-action-click";this.modelEvents&&this.modelEvents.publish({event:t,data:e})},changeTooltipFontIcon:function(e,t){console.log(e,t),e.tooltip.getBody().setText(t.text),e.fonticon="fonticon fonticon-"+t.fonticon,e.elements.icon.className="fonticon fonticon-"+t.fonticon},destroy:function(){this.subscriptionList&&this.modelEvents&&this.modelEvents.unsubscribeList(this.subscriptionList),this.indexSwitcherTimeout&&clearTimeout(this.indexSwitcherTimeout),this.toolBarEvents.unsubscribeAll()}})});