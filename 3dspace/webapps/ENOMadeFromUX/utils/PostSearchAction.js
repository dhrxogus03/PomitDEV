define("DS/ENOMadeFromUX/utils/PostSearchAction",["UWA/Controls/Abstract","DS/XSRCommonComponents/utils/XSRSearch","DS/XSRCommonComponents/utils/RMCommonServiceProvider","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/XSRCommonComponents/createform/view/TableForm","DS/XSRCommonComponents/createform/control/BOMCreateModel","DS/XSRCommonComponents/utils/TypeUtils","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Notification","DS/ENOMadeFromUX/service/MBMFServiceProvider","DS/XSRCommonComponents/utils/XSRMask","i18n!DS/XSRCommonComponents/assets/nls/XSRCommonComponents","i18n!DS/ENOMadeFromUX/assets/nls/MadeFromUX"],function(e,t,o,n,s,i,r,a,c,l,d,M,m){"use strict";return e.extend({init:function(e){this.appCore=e.appCore,this.currentTabKey=e.currentTabKey,this.container=e.container,this.bomGrid=e.bomGrid,this.isReferenceView=e.isReferenceView,this.isTileView=e.isTileView,this.specModel=e.specModel,this.modelEvents=e.modelEvents,this.isMBMF=e.isMBMF,this.isMBMFFP=e.isMBMFFP,this.bomGridCombos=[],this.appId=e.appId,this.dataModelMap=null,this.parentHasCoreMat=!1,this.subsList=[],this.subscribeEvents(),this.RMService=new o},subscribeEvents(){let e=this;e.subsList.push(e.modelEvents.subscribe({event:"postDeleteDuplicate"},t=>{if(t&&t.target){let o=t.target._treeDocument.getChildren();o.forEach(t=>{let n=t.options.grid;e.connectMaterialCheck(n,o.length)})}}))},triggerSearch(e){let o=this,i=[a.TYPE_VPMREFERENCE];e&&e.searchOnlyRawM&&(i=[a.RAW_MATERIAL_TYPE]),o.isMBMFFP&&(i=[a.FORMULATED_PRODUCT]);let c={allowedTypes:i,role:"",subType:"",criteria:e.query,precondition:'NOT [current]:"OBSOLETE"',in_apps_callback:function(e){let t,i={appCore:o.appCore},a=o.bomGrid.getTreeDocument().getSelectedNodes();if(a&&0===a.length?(i.parentId=o.specModel.getID(),i.parentTitle=o.specModel.getLabel(),t=o.bomGrid.getTreeDocument(),o.parentHasCoreMat=o.specModel.hasMadeOf?o.specModel.hasMadeOf():o.parentHasCoreMat):a&&1===a.length&&(i.parentId=a[0].getID(),i.parentTitle=a[0].getLabel(),t=a[0],o.parentHasCoreMat=!!a[0].getCoreMatId()),i.createCloseAction=function(e){o.createMBMF(e,i.parentId)},o.preapreComboFromGrid(t),i.bomGridCombos=o.bomGridCombos,i.container=o.container,e&&e.length>0){d.maskLoader(o.container,"Loading...");let t=[],a=[];e.forEach(function(e){a.push(e.id),r.isRawMaterial(e["ds6w:type"])?e["ds6wg:raw_material.v_dimensiontype_value"]||t.push(e.id):(r.isFormulatedProduct(e["ds6w:type"])||r.isFormulatedProduct(e["ds6w:type_value"]))&&t.push(e.id)});let c=[];t.forEach(e=>{let t=new Promise((t,n)=>{o.RMService.getUOMTypes(e).then(function(o){let n={};n[e]=o.result.applicableUOMTypes[0].dimension,t(n)})});c.push(t)}),Promise.all(c).then(async function(t){let r=new Map,c=new Map;if(t.forEach(function(e){r.set(Object.keys(e)[0],Object.values(e)[0])}),0!=a.length){let e={references:a,with_partials:!0};(c=await(new n).fetchCoreMatDetails(e))||(c=new Map)}let l=o.createProdGridFields(e,r,c);o.tblFrom=new s(i).loadData(l),d.unmaskLoader(o.container)})}},excludeList:e.excludeList||[]};new t(c).launchSearch(c)},async preapreComboFromGrid(e){let t=this,o=e.getVisibleChildren?e.getVisibleChildren():e.getChildren();if(o.forEach(e=>{let o=e.getMBMFReferenceName()||"";t.bomGridCombos.push(`${e.getID()}_${o}`)}),0==o.length){let o=await(new l).getReferenceMap(e.options.grid.physicalId);o.success&&Object.keys(o.result.MadeFromConnections).forEach(e=>{o.result.MadeFromConnections[e]&&o.result.MadeFromConnections[e].forEach(o=>{t.bomGridCombos.push(`${e}_${o}`)})})}if(e.getVisibleChildren&&0==o.length){let e=await(new l).getReferenceMap(parentId);e.success&&Object.keys(e.result.MadeFromConnections).forEach(o=>{e.result.MadeFromConnections[o]&&e.result.MadeFromConnections[o].forEach(e=>{t.bomGridCombos.push(`${o}_${e}`)})})}},createProdGridFields(e,t,o){let n=this,s=[];return Array.isArray(e)?(e.forEach(r=>{let a=(new i).setModel(r);a.dimensionDB&&""!=a.dimensionDB||!t.has(a.id)||(a.dimension=t.get(a.id).nlsLabel,a.dimensionDB=t.get(a.id).dbName),o.has(a.id)&&(a.coreMaterial=[o.get(a.id)]),a.isMBMF=n.isMBMF,n.connectMaterialCheck(a,e.length),s.push(a)}),s):s},connectMaterialCheck(e,t){(t+=this.bomGridCombos.length)>1&&(e.connectCM=!1),this.parentHasCoreMat||1!=t||1!=e.coreMaterial.length?0==e.coreMaterial.length?(e.canConnectCM=!1,e.connectCM_Msg=M.childCMMsg):(e.canConnectCM=!1,e.connectCM_Msg=M.connectMultiCMMsg):e.canConnectCM=!0},createMBMF(e,t){let o=this;if(Array.isArray(e)&&0==e.length)return;let n=[];o.dataModelMap=new Map,e.forEach(e=>{let t=e.options.grid;o.dataModelMap.set(t.id,t);let s=t.dataToSubmit();"EA"===t.unit&&t.quantity>0?n.push(...Array(t.quantity).fill(s)):n.push(s)}),(new l).connectMBMFItem(n,t).then(e=>{if(e&&200===e.statusCode){if(e.success&&e.result.MadeFromConnections.length>0){let n=e.result.MadeFromConnections,s=[],i=!0;n.forEach(e=>{if(e.success&&e.connectionPID){let n=o.dataModelMap.get(e.makeFromPID);n.relationID=e.connectionPID,n.parentID=t,s.push(n.getMbmfJsonForEIM(e)),i&&(c.displayNotification({eventID:"success",msg:m.Success_ConnectMBMF}),i=!1)}else!1===e.success&&c.displayNotification({eventID:"error",msg:e.message||m.Error_ConnectMBMF})}),o.modelEvents.publish({event:"add_MBMF_nodes",data:{resp:s,success:!0}})}}else c.displayNotification({eventID:"error",msg:m.Error_ConnectMBMF})}).catch(function(e){c.displayNotification({eventID:"error",msg:e?e.result.message:m.Error_ConnectMBMF}),d.unmaskLoader(o.container)})}})});