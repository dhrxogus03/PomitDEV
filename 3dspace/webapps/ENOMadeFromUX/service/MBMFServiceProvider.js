define("DS/ENOMadeFromUX/service/MBMFServiceProvider",["UWA/Core","UWA/Class","UWA/Promise","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/ItemServiceProvider","DS/XSRCommonComponents/utils/ResponseParser","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/Utils","DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(e,t,n,r,s,o,i,a,c){"use strict";return t.extend({init:function(e){this.platFormId=r.getPlatformId(),this.CSRFToken=r.get3DSpaceCSRFToken(),this.SC=r.getSecurityContext(),e&&(this.SC=e)},getHeaders:function(e){var t={"Content-type":"application/json"};this.isChangeControlled&&Object.assign(t,r.getWorkUnderHeaders());const n=c.get();return n&&n.AuthoringContextHeader&&Object.assign(t,n.AuthoringContextHeader),e&&Object.keys(e).forEach(function(n){t[n]=e[n]}),t},connectMBMFItem:function(t,s,o){var i=this,a=i.SC?i.SC:o;return new n(function(n,o){r.send3DSpaceRequest("resources/v1/modeler/dsspec/dsspec:PhysicalProduct/"+s+"?$mask:dsspec:idMask","GET",{headers:i.getHeaders({ENO_CSRF_TOKEN:i.CSRFToken,SecurityContext:a})},function(c){var u=JSON.parse(c).member[0].cestamp;r.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+s+"/MMade_From?cestamp="+u,"POST",{type:"json",headers:i.getHeaders({ENO_CSRF_TOKEN:i.CSRFToken,SecurityContext:a}),data:e.Json.encode(t)},n,o)},o)})},disconnectMBMFItem:function(e,t){var s=this;return new n(function(n,o){r.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+e+"/Made_From/"+t,"DELETE",{type:"json",headers:s.getHeaders({ENO_CSRF_TOKEN:s.CSRFToken,SecurityContext:s.SC})},n,o)})},getMBMFInfo:function(e){var t=this;return new n(function(n,s){r.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+e,"GET",{type:"json",headers:t.getHeaders({ENO_CSRF_TOKEN:t.CSRFToken,SecurityContext:t.SC})},n,s)})},updateMBMFInfo:function(t,s,o){var i=this;return new n(function(n,a){r.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+s+"/Made_From/"+o,"PUT",{type:"json",headers:i.getHeaders({ENO_CSRF_TOKEN:i.CSRFToken,SecurityContext:i.SC}),data:e.Json.encode(t)},n,a)})},updateAndSyncAttributes:function(e,t,r,o){var c={itemid:e,request:t,isRelorBus:o,relId:null};return new n(function(e,t){new s({isChangeControlled:!0}).updateAttributes(c).then(function(n){if(n.results&&n.results.length>0)for(var s=n.results,o=0;o<s.length;o++){if(200===s[o].status){var c=s[o].body;if(c.errors&&c.errors.length>0)t(c.errors);else{for(var u in c){var d=Array.isArray(c[u].value)?c[u].value[0]:c[u].value;i.ITEM_DESCRIPTION_SELECTABLE===u&&(r.options.grid["ds6w:description"]=d),"modified"===u&&(r.options.grid["ds6w:modified"]=a.getformatedDate(d)),i.ITEM_V_NAME_SELECTABLE===u&&r.setTitle(d)}r.updateOtherDetails(),e(r)}}else t()}}).catch(function(e){console.log(e)})})},fetchItemInfo:function(e){var t=this;return new n(function(n,r){(new s).fetchItemData(e,null).then(function(e){var s={serverResponse:e,withconfig:!0,createNode:!1};if(e.infos&&0===e.infos.nhits)return n([]);t._indexFormatFetchManager(s,n,r)}).catch(function(e){return r(e)})})},_indexFormatFetchManager:function(e,t,n){if(!e||!e.serverResponse||!Array.isArray(e.serverResponse.results))return n?n("invalid input : missing serverResponse"):null;var r=void 0!==e.createNode&&e.createNode;this.getEngItemsListFromServerFetch(e.serverResponse,e.uwaModel,e.withconfig,r).then(function(e){return t(e)}).catch(function(e){n(e)})},getEngItemsListFromServerFetch:function(e,t,r,s){var i=this;return new n(function(t,n){if(!Array.isArray(e.results))return n(e);var r=o.parseFetchResult(e,["ds6w:type","ds6w:status"]);i.resolveMissingNls(r.nlsTracker).then(function(e){return t(s?i.createListNodes(r.results,i.genericEngItemOptionsMapper.bind(i,e[0])):i._optionsRetrievor(r.results,i.genericEngItemOptionsMapper.bind(i,e[0])))}).catch(function(e){console.log(e)})})},resolveMissingNls:function(e){if(!Array.isArray(e.classes)||!e.properties)throw new Error("Ouups ! invalid input");var t=[];return t.push(a.getNlsOfPropertiesValues(e.properties)),n.all(t)},genericEngItemOptionsMapper:function(e,t){var n=[];return t.forEach(function(t){t["ds6w:created"]=a.getformatedDate(t["ds6w:created"]),t["ds6w:modified"]=a.getformatedDate(t["ds6w:modified"]),e&&(t["ds6w:type"]=e["ds6w:type"][t["ds6w:type_value"]],t["ds6w:status"]=e["ds6w:status"][t["ds6w:status_value"]]),n.push(t)}),n},createListNodes:function(t,n){var r=[],s=this;return t.forEach(function(t){var o=s.createListNode(t,n);e.is(o)&&r.push(o)}),r},createListNode:function(e,t){var n=this._optionsRetrievor(e,t);return this.createGridModel(n)},_optionsRetrievor:function(t,n){return n&&"function"===e.typeOf(n)?n(t):t},getReferenceMap(e){let t=this;return new n(function(n,s){r.send3DSpaceRequest("resources/MadeFrom/v1/Physical_Prod/"+e+"/getReferenceMap","GET",{type:"json",headers:t.getHeaders({ENO_CSRF_TOKEN:t.CSRFToken,SecurityContext:t.SC})},n,s)})},checkMaterialMismatch:function(t){var s=this,o={itemPID:t};return new n(function(t,n){r.send3DSpaceRequest(i.MATERIAL_BASE_URL+"dsspec:checkMaterialMismatch","POST",{type:"json",headers:s.getHeaders({ENO_CSRF_TOKEN:s.CSRFToken,SecurityContext:s.SC,"Accept-Language":s.lang}),data:e.Json.encode(o)},t,n)})},getAdditionalInfo:function(t){var s=this,o={ids:t};return new n(function(t,n){r.send3DSpaceRequest(i.MATERIAL_BASE_URL+"dsspec:fetch","POST",{type:"json",headers:s.getHeaders({ENO_CSRF_TOKEN:s.CSRFToken,SecurityContext:s.SC,"Accept-Language":s.lang}),data:e.Json.encode(o)},t,n)})}})});