define("DS/MPFModalConfiguratorComponent/ConfirmMakeBankTransferPage",["UWA/Core","UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadForm","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u){"use strict";const m=Object.freeze({CONFIRM_BANK_TRANSFER:"confirmBankTransfer",UPLOAD_PURCHASE_ORDER:"uploadPurchaseOrder"}),C=Object.freeze({UPLOAD_LATER:"onUploadLater",SHOW_SAVE_BUTTON:"showSaveButton"}),y=t.extend({className:"mpf-confirm-bank-transfer-make",setup:function(e={}){o.requiredOfPrototype(e.cart,p,"options.cart must be a CartModel"),o.requiredOfPrototype(e.purchaseOrderDocument,h,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel"),o.requiredOfPrototype(this.model,l,"this.model must be a PurchaseOrderModel"),this.service=e.service||a.MAKE,this.purchaseOrderDocument=e.purchaseOrderDocument,this.cart=e.cart,this.stateMachine=this._createStateMachine(),this.confirmDeferredPaymentMessage=this._createConfirmDeferredPaymentMessage(),this.learnMoreLink=this._createLearnMoreLink(e.linkToBankTransferFAQ),this.uploadPurchaseOrderButton=this._createUploadPurchaseOrderButton(),this.uploadLaterButton=this._createUploadLaterButton(),this.purchaseOrderUploadForm=new d({service:this.service,model:this.model,purchaseOrderDocument:this.purchaseOrderDocument,cart:this.cart}),this.listenTo(this.purchaseOrderUploadForm,"purchaseOrderUploaded",this._onPurchaseOrderUploaded.bind(this))},render:function(){let e;return this.stateMachine.getState()===m.UPLOAD_PURCHASE_ORDER?this.container.setContent([this.purchaseOrderUploadForm.render()]):(e=[this.confirmDeferredPaymentMessage,this.learnMoreLink,this.uploadPurchaseOrderButton,this.uploadLaterButton],this.container.setContent(e)),this},save:function(){return this.stateMachine.getState()===m.UPLOAD_PURCHASE_ORDER?this.purchaseOrderUploadForm.save():Promise.resolve()},destroy(){this.stopListening(),this.purchaseOrderUploadForm.destroy(),this.purchaseOrderUploadForm=null,this.purchaseOrderDocument=null,this.cart=null,this.stateMachine=null,this._parent(),this.container=null},_createConfirmDeferredPaymentMessage:function(){return e.createElement("p",{text:u.get("confirmDeferredPaymentMessage")})},_createLearnMoreLink:function(t){let s;const r=e.is(t)?t:"/faq/proceed-to-deferred-payment";return r.length>0&&(s=e.createElement("a",{href:r,text:u.get("learnMoreAboutDeferredPayment"),target:"_blank"})),s},_createUploadPurchaseOrderButton:function(){return new r({className:"primary mpf-uploadPurchaseOrderButton",value:u.get("uploadPurchaseOrder"),events:{onClick:this._onUploadPurchaseOrder.bind(this)}})},_onUploadPurchaseOrder:function(){this.stateMachine.changeState(m.UPLOAD_PURCHASE_ORDER),this.dispatchEvent(C.SHOW_SAVE_BUTTON),this.render()},_createUploadLaterButton:function(){return new r({className:"primary mpf-uploadLaterButton",value:u.get("uploadPurchaseOrderLater"),events:{onClick:this._onUploadPurchaseOrderLater.bind(this)}})},_onUploadPurchaseOrderLater:function(){n.mask(this.container),this._updateCart().then(()=>{n.unmask(this.container),s.publish("MPCartTimeline",{event:"refresh",cartId:this.cart.get("id")}),this.dispatchEvent(C.UPLOAD_LATER)}).catch(e=>{n.unmask(this.container),console.error(e),new i({messageClassName:"error",closable:!0,visible:!0,messages:u.get("error")}).inject(this.container,"top")})},_updateCart:function(){const e={};return e[p.Fields.BLOCKED]="TRUE",this.cart.savePromise(e,{patch:!0,partialRefresh:!0})},_onPurchaseOrderUploaded:function(){this.dispatchEvent("endPurchaseOrderStep")},_createStateMachine:function(){return new c({state:m.CONFIRM_BANK_TRANSFER,states:[m.CONFIRM_BANK_TRANSFER,m.UPLOAD_PURCHASE_ORDER],transitions:[{from:m.CONFIRM_BANK_TRANSFER,to:m.UPLOAD_PURCHASE_ORDER}]})}});return y.Events=C,y}),define("DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSection",["UWA/Core","UWA/Class/View","UWA/Class/Promise","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFTCContractModel/TCContractModel","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcContractComponent/SalesConditionsBuyerPayment","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C){"use strict";const y=Object.freeze({VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"}),g=t.extend({setup:function(e){e||(e={}),this._checkPrototypes(e),this._parent(e),this.service=e.serviceRequest,this.buyer=e.buyer,this.shopModel=e.shopModel,this.tcDocumentFactory=e.tcDocumentFactory,this.tcContractFactory=e.tcContractFactory,this.cart=e.cart,this.whenReady=this._findContract()},render:function(){const t=this;return this.dispatchEvent(y.INVALID_SECTION),this.whenReady.then(function(){e.is(t.tcContract)&&t.tcContract.getCurrentState()===c.STATUS.draft?(t.checkbox=new h({shopModel:t.shopModel,tcDocumentFactory:t.tcDocumentFactory,tcContract:t.tcContract}),t._initListeners(),t.container.setContent(t.checkbox.render()),t.dispatchEvent(t.isChecked()?y.VALID_SECTION:y.INVALID_SECTION)):t.dispatchEvent(y.VALID_SECTION)}).catch(function(){new r({className:"error",messageClassName:"error",messages:C.get("errorTC"),visible:!0,attributes:{style:"height: 60px"}}).inject(t.container)}),this},isChecked:function(){return!e.is(this.checkbox)||this.checkbox.isChecked()},save:function(){return e.is(this.checkbox)?this.checkbox.signContract():s.resolve()},_initListeners:function(){this.listenTo(this.checkbox,h.Events.CHECKED,function(){this._sendTrackingEvent("SalesConditionsClicked",{label:"on",service:this.service}),this.dispatchEvent(y.VALID_SECTION)}),this.listenTo(this.checkbox,h.Events.UNCHECKED,function(){this._sendTrackingEvent("SalesConditionsClicked",{label:"off",service:this.service}),this.dispatchEvent(y.INVALID_SECTION)})},_sendTrackingEvent:function(e,t){const s=p.createEventBuilder({category:m.CHECKOUT,action:e}).setLabel(t.label);a.addTrackerInformation(s,this.cart),s.addDimension(u.MARKETPLACE_SERVICE,t.service).send()},_findContract:function(){return this._findSpecificTcContract()},_findSpecificTcContract:function(){const e=this,t=e.tcContractFactory.createModel(l.Types.CUSTOM_TC_SELLER);return t.setParentResourceId(this.cart.get("id")),t.fetchPromise().then(function(){return t.isNew()?e._findInConsumedContracts():(e.tcContract=t,s.resolve())})},_findInConsumedContracts:function(){const t=this,r=this.tcContractFactory.createCollection(l.Types.CONSUMED_CONTRACTS);return r.fetchPromise().then(function(){const i=t.shopModel.get("owner").match(/[A-Z0-9]{32}$/)[0];return e.is(r)&&(t.tcContract=r.filter(function(e){return e.getConsumerID()===t.buyer.get("id")&&e.getDocumentType()===c.DOCUMENT_TYPES.DEFAULT_SALES_CONDITIONS&&e.getSupplierID()===i&&e.getCurrentState()!==c.STATUS.archived&&e.getSigningRevision()===e.getActiveRevision()}).shift()),e.is(t.tcContract)?(t.tcContract.dataProxy=t.tcContractFactory.getDataProxy(l.Types.CONTRACTS),s.resolve()):t._createContract(i)})},_createContract:function(t){const r=this.shopModel.getService(this.service)["contract-documents"];return e.is(r)?0===r.length?s.resolve():r.length>0?(this.tcContract=this.tcContractFactory.createModel(l.Types.EXISTING_DOCUMENT,{documentID:r[0].id,supplierID:t,consumerID:this.buyer.get("id"),currentState:c.STATUS.draft}),this.tcContract.savePromise()):void 0:s.reject()},_checkPrototypes:function(e){i.requiredOfPrototype(e.shopModel,n,"options.shopModel must be a ShopModel"),i.requiredOfPrototype(e.tcDocumentFactory,d,"options.tcDocumentFactory must be a TCDocumentFactory"),i.requiredOfPrototype(e.tcContractFactory,l,"options.tcContractFactory must be a TCContractFactory"),i.requiredOfPrototype(e.cart,o,"options.cart must be a CartModel")}});return g.Events=Object.freeze(y),g}),define("DS/MPFModalConfiguratorComponent/CompanyInformationSection",["UWA/Promise","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyComponent/CompanyNameInput","DS/MPFCompanyComponent/CompanyTaxRegistrationIdInput","DS/MPFCompanyComponent/CompanyRegistrationIdInput","DS/MPFView/FieldSelectInputV2","DS/MPFCountryModel/CountryCollection","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressCollection","i18n!DS/MPFCompanyComponent/assets/nls/CompanyComponent"],function(e,t,s,r,i,n,o,a,c,d,l){"use strict";return t.extend({className:"mpf-form mpf-company-information mpf-horizontal",setup:function(e={}){s.requiredOfPrototype(e.countryCollection,a,"options.countryCollection must be a CountryCollection"),s.requiredOfPrototype(this.model,c,"this.model must be a CompanyModel"),s.requiredOfPrototype(e.addresses,d,"options.addresses must be a AddressCollection"),this._parent(e),this.countryCollection=e.countryCollection,this.addresses=e.addresses,this.companyNameInput=this._createCompanyName(),this.countrySelect=this._createCountrySelect(),this.taxRegistrationInput=this._createTaxRegistrationID(),this.companyRegistrationInput=this._createCompanyRegistrationID()},render:function(){return this.container.setContent([this.companyNameInput.render(),this.countrySelect.render(),this.taxRegistrationInput.render(),this.companyRegistrationInput.render()]),this},save:function(){var t={},s=null;return this.validate()?(this.model.isNew()||(s=this.model.getPendingChanges(),t.patch=!0),this.model.isNew()||0!==Object.keys(s).length?this.model.savePromise(s,t):e.resolve()):e.reject()},validate:function(){var e=this.companyNameInput.validate().isValid,t=this.countrySelect.validate().isValid,s=this.taxRegistrationInput.validate().isValid,r=this.companyRegistrationInput.validate().isValid;return e&&t&&s&&r},clearForm:function(){this.companyNameInput.resetValue(),this.countrySelect.resetValue(),this.taxRegistrationInput.resetValue(),this.companyRegistrationInput.resetValue()},_createCompanyName:function(){return new r({model:this.model,dynamicValidation:!0,readOnly:!this.model.isNew()&&this.model.getName(),required:!0})},_createCountrySelect:function(){var e=this.model.has(c.Fields.COUNTRY)&&""!==this.model.getCountry();if(!e&&this.addresses.hasBillingAddresses()){var t=this.addresses.find(function(e){return e.isBillTo()}).getCountry();t&&this.model.setCountry(t)}return new o({model:this.model,required:!0,dynamicValidation:!0,silent:!1,fieldName:c.Fields.COUNTRY,fieldLabel:l.get("country"),readOnly:e,placeholder:l.get("selectCountry"),selectableOptions:this._getCountriesOptions()})},_createTaxRegistrationID:function(){let e=!1;return this.model.has(c.Fields.TAX_REGISTRATION_ID)&&""!==this.model.getTaxRegistrationId()&&(e=!!this.model.getTaxRegistrationId()&&!this.model.validate(c.Fields.TAX_REGISTRATION_ID)),new i({model:this.model,required:!0,readOnly:e})},_createCompanyRegistrationID:function(){const e=this.model.has(c.Fields.REGISTRATION_ID)&&""!==this.model.getRegistrationId();return new n({model:this.model,required:!1,readOnly:e})},_getCountriesOptions:function(){const e=this.model.getCountry();return this.countryCollection.map(t=>({value:t.getIso3(),label:t.getName(),selected:t.getIso3()===e}))},destroy:function(){this.companyNameInput.destroy(),this.countrySelect.destroy(),this.taxRegistrationInput.destroy(),this.companyRegistrationInput.destroy(),this.companyNameInput=null,this.countrySelect=null,this.taxRegistrationInput=null,this.companyRegistrationInput=null,this.model=null,this._parent(),this.container=null}})}),define("DS/MPFModalConfiguratorComponent/CouponSection",["UWA/Core","UWA/Promise","DS/UIKIT/Input/Text","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Value","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,i,n,o,a,c,d,l,h,p,u)=>{"use strict";const m=Object.freeze({NO_COUPON:"noCoupon",COUPON_ADDED:"couponAdded"}),C=Object.freeze({HIDE_PAYMENT_METHOD_SECTION:"hidePaymentMethodSection",SHOW_PAYMENT_METHOD_SECTION:"showPaymentMethodSection",VALID:"valid",INVALID:"invalid",COUPON_ADDED:"couponAdded",COUPON_REMOVED:"couponRemoved"}),y=n.extend({className:"mpf-section mpf-coupon-section",setup(e={}){o.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),this.service=e.service,this.cart=e.cart,this.locale=e.locale||"fr-FR",this._parent(e),this.stateMachine=this._createStateMachine(),this.couponInput=this._createInput()},render({errorMsg:e}={}){return this.stateMachine.getState()===m.COUPON_ADDED?this.body=this._renderCouponAddedState({errorMsg:e}):this.body=this._renderNoCouponState({errorMsg:e}),this._parent(),this._updatePaymentMethods(),this.dispatchEvent(this.isValid()?C.VALID:C.INVALID),this},_renderCouponAddedState({errorMsg:e}){const t=[{tag:"div",class:"mpf-line",html:[this._renderInputAndLabel(m.COUPON_ADDED),{tag:"div",class:"mpf-no-wrap",html:[this._createButton(),this._createDiscountContainer()]}]},{tag:"div",class:"mpf-line mpf-info-container",html:[this._createCouponInfoContainer(),this._createTotalPriceContainer()]}];return e&&t.push(this._renderError(e)),t},_renderNoCouponState({errorMsg:e}){this.couponInput.enable(),this.couponInput.setValue("");const t=[{tag:"div",class:"mpf-line",html:[this._renderInputAndLabel(m.NO_COUPON),this._createButton()]}];return e&&t.push(this._renderError(e)),t},_renderInputAndLabel(e){const t=[this.couponInput];return e===m.COUPON_ADDED&&(this.couponInput.disable(),t.push({tag:"span",class:"fonticon fonticon-status-ok"})),[{tag:"label",html:[{tag:"span",class:"mpf-label",text:u.get("couponCode")},{tag:"div",class:"mpf-input-container",html:t}]}]},_renderError:e=>({tag:"div",class:"mpf-line",html:[{tag:"div",class:"mpf-no-wrap mpf-error",html:[{tag:"span",class:"fonticon fonticon-attention"},{tag:"span",class:"error-coupon",text:e}]}]}),isValid(){return this.stateMachine.getState()===m.NO_COUPON||this._isCouponValid()&&!this._hasCouponExpired()},_isCouponValid(){return!0===this.cart.getCoupon().validity.isValid},_hasCouponExpired(){const e=new Date;return new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())>new Date(this.cart.getCoupon().endDate)},_updatePaymentMethods(){const e=this.stateMachine.getState()===m.COUPON_ADDED?C.COUPON_ADDED:C.COUPON_REMOVED;this.dispatchEvent(e);const t=this.cart.has(a.Fields.COUPON)&&0===parseFloat(this.cart.getCoupon().totalToPay)&&this.couponInput.getValue()===this.cart.getCoupon().tokenUsed?C.HIDE_PAYMENT_METHOD_SECTION:C.SHOW_PAYMENT_METHOD_SECTION;this.dispatchEvent(t)},_onAdd(){const e=this.couponInput.getValue();e&&e.trim().length>0?(this._setLoading(!0),this._saveCoupon({value:e}).then(()=>{this._setLoading(!1),this.stateMachine.changeState(m.COUPON_ADDED),this._sendTrackerEvent(C.COUPON_ADDED),this.render()}).catch(e=>{this._setLoading(!1);const t=e&&e.response;let s;s="Error.CouponCampaignClosed"===(t&&t.errorCode)?u.get("expiredCoupon"):t&&t.errorMsg?t.errorMsg:u.get("invalidCoupon"),this.render({errorMsg:s})})):this.render({errorMsg:u.get("enterCoupon")})},_onRemove(){this._setLoading(!0),this._saveCoupon({value:""}).then(()=>{this._setLoading(!1),this.stateMachine.changeState(m.NO_COUPON),this._sendTrackerEvent(C.COUPON_REMOVED),this.render()}).catch(e=>{this._setLoading(!1);const t=e&&e.response&&e.response.errorMsg?e.response.errorMsg:u.get("error");this.render({errorMsg:t})})},_setLoading(e=!0){const t=this.container.getElement(".mpf-body");e?i.mask(t):i.unmask(t)},_saveCoupon({value:e}){const s=this.cart.getCoupon();return this.cart.unset(a.Fields.COUPON,{silent:!0}),this.cart.savePromise({[a.Fields.COUPON]:e},{patch:!0}).catch(e=>(this.cart.set(a.Fields.COUPON,s,{silent:!0}),t.reject(e)))},_createStateMachine(){return new d({state:this.cart.has(a.Fields.COUPON)?m.COUPON_ADDED:m.NO_COUPON,states:[m.COUPON_ADDED,m.NO_COUPON],transitions:[{from:m.COUPON_ADDED,to:m.NO_COUPON},{from:m.NO_COUPON,to:m.COUPON_ADDED}]})},_createCouponInfoContainer(){const t=[];if(this.stateMachine.getState()===m.COUPON_ADDED){const s=parseFloat(this.cart.getCoupon().campaignAmount),r=parseFloat(this.cart.getCoupon().amount),i=new Date(this.cart.getCoupon().endDate);t.push(e.createElement("div",{class:"mpf-coupon-info-campaign",text:u.get("commercialCampaign")+": "+this.cart.getCoupon().commercialName+", "+u.get("expiryDate")+": "+i.toLocaleDateString()})),this._hasCouponExpired()?t.push(e.createElement("div",{class:"mpf-coupon-info-value mpf-warning",text:u.get("expiredCoupon")})):this._isCouponValid()?s>r&&t.push(e.createElement("div",{class:"mpf-coupon-info-value",text:u.get("couponValueExceedsOrderValue")})):t.push(e.createElement("div",{class:"mpf-coupon-info-value mpf-warning",text:e.is(this.cart.getCoupon().validity.validation)?this.cart.getCoupon().validity.validation:u.get("invalidCoupon")}))}return e.createElement("div",{class:"mpf-coupon-info",html:t})},_createTotalPriceContainer(){let t;if(this.stateMachine.getState()===m.COUPON_ADDED&&this.isValid()){const s=this.cart.getCurrency(),r=parseFloat(this.cart.getCoupon().totalToPay).toLocaleString(this.locale,{style:"currency",currency:s,currencyDisplay:"code"}).replace(s,"").trim();t=[e.createElement("span",{class:"mpf-coupon-payment-label",text:u.get("totalToPay")}),e.createElement("span",{class:"mpf-coupon-payment-value",text:r+" "+s})]}return e.createElement("div",{class:"mpf-coupon-payment",html:t})},_createDiscountContainer(){const t=[];if(this.stateMachine.getState()===m.COUPON_ADDED){const s=this.cart.getCurrency(),r=this.cart.getCoupon().percentage;if(e.is(r)){const s=e.createElement("div",{text:u.get("percentageTotalOrder",{value:parseInt(r)})});t.push(s)}const i=parseFloat(this.cart.getCoupon().amount).toLocaleString(this.locale,{style:"currency",currency:s,currencyDisplay:"code"}).replace(s,"").trim(),n=e.createElement("div",{text:"- "+i+" "+s});t.push(n)}return e.createElement("div",{class:"mpf-coupon-discount",html:t})},_createIconContainer:()=>e.createElement("span",{class:"fonticon"}),_createButton(){const e=!!this.cart.getCoupon(),t=e?u.get("remove"):u.get("add");return new r({value:t,icon:e?"trash":"plus",events:{onClick:()=>{e?this._onRemove():this._onAdd()}}})},_createInput(){const e=this.stateMachine.getState()===m.COUPON_ADDED;return new s({placeholder:u.get("couponCode"),disabled:e,value:e?this.cart.getCoupon().tokenUsed:""})},destroy(){this.cart=null,this._parent(),this.container=null},_sendTrackerEvent(e){const t=l.createEventBuilder({category:"Checkout",action:e}).addDimension(h.MARKETPLACE_SERVICE,this.service);c.addTrackerInformation(t,this.cart),t.send()}});return y.Events=C,y}),define("DS/MPFModalConfiguratorComponent/BuyerCard",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i,n,o){"use strict";var a={ON_SELECTED:"onSelected"};return t.extend({className:"mpf-buyer-card",domEvents:{click:"cardClicked"},setup:function(e){e||(e={}),this._checkPrototypes(e),this._parent(e),this.buyerType=e.buyerType,this.country=e.country},render:function(){return e.equals(this.buyerType,r.INDIVIDUAL)?this.container.setContent(this._renderPerson()):this.container.setContent(this._renderCompany()),this},_renderCompany:function(){var t,s,r,i;return t=this.model.getName(),i=e.is(this.country)?this.country:this.model.getCountry(),s=e.is(this.model.getTaxRegistrationId())?this.model.getTaxRegistrationId():"",r=e.is(this.model.getRegistrationId())?this.model.getRegistrationId():"",[this._getCompanyLine(o.get("company"),t),this._getCompanyLine(o.get("country"),i),this._getCompanyLine(o.get("taxRegistrationId"),s),this._getCompanyLine(o.get("companyRegistration"),r)]},_getCompanyLine:function(t,s){return e.createElement("div",{class:"mpf-buyer-line",html:[e.createElement("span",{text:t}),e.createElement("span",{text:s})]})},_renderPerson:function(){var t,s;return t=this.model.get("firstName"),s=this.model.get("lastName"),e.createElement("div",{class:"mpf-buyer-line",text:t+" "+s})},_checkPrototypes:function(t){if(!e.is(t.buyerType))throw new Error("options.buyerType is required");if(s.requiredOfPrototype(t.buyerType,r,"options.buyerType must be a BuyerType"),!Object.prototype.isPrototypeOf.call(n.prototype,this.model)&&!Object.prototype.isPrototypeOf.call(i.prototype,this.model))throw new Error("BuyerCard model must be a CompanyModel or a PersonModel")},destroy:function(){this.model=null,this._parent(),this.container=null},cardClicked:function(){this.dispatchEvent(a.ON_SELECTED,this.model)}})}),define("DS/MPFModalConfiguratorComponent/CreditCardPaymentPage",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFStripeComponent/StripePaymentPage","DS/MPFView/EmptyView"],function(e,t,s,r,i,n,o){"use strict";const a=Object.freeze({PAYMENT_SUCCESS:"onPaymentSuccess",PAYMENT_FAILURE:"onPaymentFailure",PAYMENT_IN_PROGRESS:"paymentInProgress",VALIDATION_ERROR:"validationError"}),c=e.extend({className:"mpf-credit-card-payment-page",setup(e={}){t.requiredOfPrototype(e.me,s,"options.me must be a PersonModel"),t.requiredOfPrototype(e.cart,r,"options.cart must be a CartModel"),t.requiredOfPrototype(e.cartPsp,i,"options.cartPsp must be a PspModel"),this.me=e.me,this.cart=e.cart,this.cartPsp=e.cartPsp,this.waitForPaymentModel=e.waitForPaymentModel,this.service=e.service,this.locale=e.locale||"fr-FR",this.paymentPage=this._createPaymentPage()},render(){return this.container.setContent(this.paymentPage.render()),this.cartPsp.getPsp()===i.Psp.STRIPE&&this.paymentPage.whenReadyToMount().then(()=>{this.paymentPage.mountCardInputs()}),this},destroy(){this.stopListening(),this.paymentPage.destroy(),this.me=null,this.cart=null,this.cartPsp=null,this.waitForPaymentModel=null,this._parent(),this.container=null},_createPaymentPage(){let e;switch(this.cartPsp.getPsp()){case i.Psp.PAYU:e=this._redirectToPayU();break;default:e=this._createStripePaymentPage()}return e},_redirectToPayU(){return window.location.assign(this.cart.getPaymentUrl()),o.getInstance()},_createStripePaymentPage(){const e=new n({me:this.me,cart:this.cart,cartPsp:this.cartPsp,waitForPaymentModel:this.waitForPaymentModel,service:this.service,locale:this.locale});return this.listenTo(e,n.Events.PAYMENT_SUCCESS,this.dispatchEvent.bind(this,a.PAYMENT_SUCCESS)),this.listenTo(e,n.Events.PAYMENT_FAILURE,this.dispatchEvent.bind(this,a.PAYMENT_FAILURE)),this.listenTo(e,n.Events.PAYMENT_IN_PROGRESS,this.dispatchEvent.bind(this,a.PAYMENT_IN_PROGRESS)),this.listenTo(e,n.Events.VALIDATION_ERROR,this.dispatchEvent.bind(this,a.VALIDATION_ERROR)),e}});return c.Events=a,c}),define("DS/MPFModalConfiguratorComponent/IfweloopBankTransferPage",["UWA/Class/View","UWA/Core","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFPurchaseOrderComponent/PurchaseOrderUploadForm","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d){"use strict";const l=Object.freeze({END_PURCHARSE_ORDER_STEP:"endPurchaseOrderStep",VALID:"valid"}),h=e.extend({className:"mpf-bank-transfer-ifweloop",setup(e={}){s.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),s.requiredOfPrototype(e.purchaseOrderDocument,o,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel"),s.requiredOfPrototype(this.model,n,"this.model must be a PurchaseOrderModel"),this.service=e.service||r.IFWELOOP,this.purchaseOrderDocument=e.purchaseOrderDocument,this.cart=e.cart,this.cartPsp=e.cartPsp,this.virtualIbans=e.virtualIbans,this.displayAccountOwner=!0,this.paymentInfoMessage=this._createPaymentInfoMessage(),this.accountInfo=this._createAccountInfoContainer(),this.purchaseOrderUploadForm=this._createPurchaseOrderUploadForm()},render(){const e=[this.paymentInfoMessage,this.accountInfo,this.purchaseOrderUploadForm.render()];return this.container.setContent(e),this.dispatchEvent(l.VALID),this},save(){return this.purchaseOrderUploadForm.save()},_onPurchaseOrderUploaded(){this.dispatchEvent(l.END_PURCHARSE_ORDER_STEP)},_createAccountInfoContainer(){const e=this.virtualIbans.first(),s=e.getExternalReference(),r=this.cartPsp&&this.cartPsp.getCountryPlatform(),i="3DS-EUR"===s||"3DS-GBP"===s||r===c.Platform.STRIPE_EU,n="3DS-AUD"===s||"3DS-JPY"===s||r===c.Platform.STRIPE_AUSTRALIA||r===c.Platform.STRIPE_JAPAN,o="3DS-INR"===s;let a;return a=i?this._getEuropeanIbanInfo(e):n?this._getAustralianJapanIbanInfo(e):o?this._getIndianIbanInfo(e):this._getAmericanIbanInfo(e),t.createElement("div",{class:"mpf-ifweloop-seller",html:a})},_getAustralianJapanIbanInfo(e){const s=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:"3DS-AUD"===e.getExternalReference()?d.get("accountOwner")+": DS Australia Pty Ltd":d.get("accountOwner")+": DS K.K."}),r=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("accountNumber")+": "+e.getAccountNumber()}),i=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("swiftbic")+": "+e.getBic()});return this.displayAccountOwner?[s,r,i]:[r,i]},_getAmericanIbanInfo(e){const s=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("accountOwner")+": Dassault Systemes USA"}),r=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("accountNumber")+": "+e.getAccountNumber()}),i=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("routingNumber")+": "+e.getRoutingNumber()}),n=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("swiftbic")+": "+e.getBic()});return this.displayAccountOwner?[s,r,i,n]:[r,i,n]},_getEuropeanIbanInfo(e){const s=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("accountOwner")+": 3DS Store Ltd"}),r=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("iban")+": "+e.getIban()}),i=t.createElement("div",{class:"mpf-ifweloop-seller-info",text:d.get("swiftbic")+": "+e.getBic()});return this.displayAccountOwner?[s,r,i]:[r,i]},_getIndianIbanInfo(e){const t=[];return this.displayAccountOwner&&t.push(this._createSellerInfoDiv(`${d.get("accountOwner")}: ${e.getAccountName()}`)),t.push(this._createSellerInfoDiv(`${d.get("accountNumber")}: ${e.getAccountNumber()}`)),t.push(this._createSellerInfoDiv(`${d.get("bic")}: ${e.getBic()}`)),t.push(this._createSellerInfoDiv(`${d.get("ifsc")}: ${e.getIfsc()}`)),t.push(this._createSellerInfoDiv(`${d.get("micr")}: ${e.getMicr()}`)),t},_createSellerInfoDiv:e=>t.createElement("div",{class:"mpf-ifweloop-seller-info",text:e}),_createPurchaseOrderUploadForm(){return new i({service:this.service,model:this.model,purchaseOrderDocument:this.purchaseOrderDocument,cart:this.cart})},_createPaymentInfoMessage:()=>t.createElement("p",{text:d.get("infoPaymentBankTransferIfweloop")})});return h.Events=l,h}),define("DS/MPFModalConfiguratorComponent/OrderAgreementsSection",["UWA/Core","UWA/Class/View","UWA/String","UWA/Promise","UWA/Utils/Client","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/UIKIT/Input/Toggle","DS/UIKIT/Alert","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFTCContractModel/TCContractModel","DS/MPFTCContractModel/TCContractFactory","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y){"use strict";const g=Object.freeze({ON_RENDER:"onRender",VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"}),P=t.extend({className:"mpf-agreements-order",setup:function(e){e||(e={}),this._parent(e),this._checkPrototypes(e),this.service=e.service||n.IFWELOOP,this.cart=e.cart,this.cartItems=e.cartItems,this.buyer=e.buyer,this.tcContractFactory=e.tcContractFactory,this.softwareAgreement=e.softwareAgreement,this.checkbox=this._createToggle()},render:function(){return this._getDocuments().then(()=>{this.container.setContent([this.checkbox,this._getLabel()]),this.dispatchEvent(g.ON_RENDER)}).catch(this._displayAlert.bind(this)),this},save:function(){return this._saveClosaContract()},isChecked:function(){return this.checkbox.isChecked()},_saveClosaContract:function(){return this.tcContractFactory.createModel(p.Types.EXISTING_DOCUMENT,{documentID:this.softwareAgreement.get("id"),currentState:h.STATUS.inEffect,consumerID:this.buyer.get("id"),cartItemID:this.cartItems.first().get("id")}).savePromise()},_getDocuments:function(){return this._fetchClosa()},_getLabel:function(){const t=this.service===n.CLICK_AND_BUY?this._getClickAndBuyLabel():this._getIfweloopLabel();return e.createElement("div",{class:"mpf-switch-label",html:t})},_getClickAndBuyLabel:function(){return y.get("agreementsClickAndBuy",{closa:this._getClosaLink().outerHTML})},_getIfweloopLabel:function(){return y.get("agreementsIfweloop",{closa:this._getClosaLink().outerHTML})},_getClosaLink:function(){return e.createElement("a",{target:"_blank",href:this.softwareAgreement.getUrl(),text:y.get("onlineAgreements")})},_fetchClosa:function(){return this.softwareAgreement.fetchPromise({cartId:this.cart.get("id")})},_displayAlert:function(){new c({className:"error",messages:{className:"error",message:y.get("errorLoadingTC")},icon:!0,closable:!0,visible:!0}).inject(this.container.getElement(".mpf-body"),"top")},_createToggle:function(){const e=this;return new a({type:"switch",className:"primary",value:"",events:{onChange:function(){this.isChecked()?e.dispatchEvent(g.VALID_SECTION):e.dispatchEvent(g.INVALID_SECTION)}}})},_checkPrototypes:function(e){if(o.requiredOfPrototype(e.cart,d,"options.cart must be a CartModel"),o.requiredOfPrototype(e.cartItems,l,"options.cartItems must be a CartItemCollection"),o.requiredOfPrototype(e.tcContractFactory,p,"options.tcContractFactory must be a TCContractFactory"),o.requiredOfPrototype(e.softwareAgreement,u,"options.softwareAgreement must be a SoftwareAgreementModel"),!C.prototype.isPrototypeOf(e.buyer)&&!m.prototype.isPrototypeOf(e.buyer))throw new Error("OrderAgreementsSection options.buyer must be a CompanyModel or a PersonModel")}});return P.Events=g,P}),define("DS/MPFModalConfiguratorComponent/BankAccountInformationSection",["UWA/Core","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFVirtualIbanModel/VirtualIbanModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i){"use strict";return s.extend({setup:function(e){e||(e={}),this._parent(e),t.requiredOfPrototype(e.virtualIban,r,"options.virtualIban must be a VirtualIbanModel"),this.virtualIban=e.virtualIban},render:function(){return this.body.push(e.createElement("div",{class:"mpf-iban",text:i.get("iban")+" "+this.virtualIban.get("Iban")}),e.createElement("div",{class:"mpf-bic",text:i.get("bic")+" "+this.virtualIban.get("Bic")})),this._parent(),this}})}),define("DS/MPFModalConfiguratorComponent/OrderSummarySection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i){"use strict";return t.extend({className:"mpf-summary-order",setup:function(e){e||(e={}),s.requiredOfPrototype(e.cart,r,"options.cart must be a CartModel"),this._parent(e),this.cart=e.cart,this.locale=e.locale||"fr-FR"},render:function(){return this.container.setContent([this._getDetailAmount(),this._getTotal()]),this},_getTotal:function(){return e.createElement("div",{class:"mpf-order-total",html:[e.createElement("div",{text:i.get("orderTotal")}),e.createElement("div",{text:this._getGrossAmountTotal()})]})},_getDetailAmount:function(){return e.createElement("div",{class:"mpf-order-detail",html:[e.createElement("div",{class:"mpf-order-subtotal",html:[e.createElement("div",{text:i.get("subtotal")}),e.createElement("div",{text:this._getNetAmountTotal()})]}),e.createElement("div",{class:"mpf-order-taxes",html:[e.createElement("div",{text:i.get("taxes")}),e.createElement("div",{text:this._getTaxesAmountTotal()})]})]})},_getGrossAmountTotal:function(){return this.cart.getGrossAmountTotal().toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})},_getNetAmountTotal:function(){return this.cart.getNetAmountTotal().toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})},_getTaxesAmountTotal:function(){return this.cart.getTaxesAmountTotal().toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"})}})}),define("DS/MPFModalConfiguratorComponent/CheckoutHandlerFunctions",["UWA/Core","DS/UIKIT/Modal","DS/UIKIT/Mask","DS/UIKIT/Input/Button","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,i){"use strict";return{renderError:function(e,{page:s}={}){const r=new t({className:"mpf-configurator-offer mpf-loading-error",visible:!0,closable:!0,header:{tag:"h4",text:i.get("errorLoading")},body:s||{tag:"div",class:"mpf-error-message-container",html:[{tag:"div",class:"mpf-info-message-title",text:i.get("somethingWentWrong")},{tag:"div",class:"fonticon fonticon-alert mpf-icon"},{tag:"div",class:"mpf-info-message",text:i.get("couldNotLoadData")}]}});return r.inject(e),r},onLoad:function(r,n){const o=e.is(n)?n:i.get("loading"),a=new t({className:"mpf-configurator-offer mpf-configurator-loading",visible:!0,closable:!1,header:{tag:"h4",text:o}});return a.inject(r),s.mask(a.getBody()),a}}}),define("DS/MPFModalConfiguratorComponent/BillingAddressHelper",["DS/MPFServices/MarketplaceServices","DS/MPFUtils/StorageUtils","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCartModel/CartModel","DS/MPFPspModel/PspModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCountryModel/CountryCollection","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory"],(e,t,s,r,i,n,o,a,c,d,l,h,p,u)=>{return class{constructor({service:t,me:r,cart:n,cartPsp:c,buyerType:m,isBuyerTypeEditable:C,company:y,cardTokens:g,personAddresses:P,companyAddresses:S,countries:E,addressFactory:M,paymentCardTokenFactory:A}){s.requiredOfPrototype(r,i,"options.me must be a PersonModel"),s.requiredOfPrototype(n,o,"options.cart must be a CartModel"),s.requiredOfPrototype(c,a,"options.cartPsp must be a PspModel"),s.requiredOfPrototype(P,d,"options.personAddresses must be an AddressCollection"),s.requiredOfPrototype(M,l,"options.addressFactory must be an AddressFactory"),s.requiredOfPrototype(g,p,"options.cardTokens must be a PaymentCardTokenCollection"),s.requiredOfPrototype(A,u,"options.paymentCardTokenFactory must be a PaymentCardTokenFactory"),s.requiredOfType(t,"string","options.service must be a MarketplaceServices instance"),s.requiredOfType(C,"boolean","options.isBuyerTypeEditable must be a boolean"),this.service=t,this.me=r,this.company=y,this.cart=n,this.cartPsp=c,this.cardTokens=g,this.personAddresses=P,this.companyAddresses=S,this.addressFactory=M,this.paymentCardTokenFactory=A,this._isBuyerTypeEditable=C,this.buyerType=m||this.deduceBuyerType(),this.service===e.CLICK_AND_BUY&&(s.requiredOfPrototype(E,h,"options.countries must be a CountryCollection"),this.countries=E)}isBillingInfoComplete(){const e=this.getBuyerType(),t=this.isBuyerTypeEditable(),s=this.hasValidBillingAddress();if(e===r.COMPANY||t){if(this.company){const e=!!this.company.getName(),t=!!this.company.getCountry(),r=this._validateTaxRegistrationId(),i=e&&t&&r;return s&&i}return!1}return s}_validateTaxRegistrationId(){let t;const s=this.company.getTaxRegistrationId(),r=this.company.getCountry(),i=["USA","CAN","JPN"].indexOf(r)>-1,o=this.service===e.CLICK_AND_BUY,a=this.service===e.SUBSCRIPTIONS,c=this.service===e.INNOVATE;return t=!(!(o||a||c)||!i&&!this.company.hasNoVatId())||!!s&&!this.company.validate(n.Fields.TAX_REGISTRATION_ID)}getBuyerType(){return this.buyerType||this.deduceBuyerType()}deduceBuyerType(){const e=this.cart.get(o.Fields.BILL_TO);return e&&this.companyAddresses&&this.companyAddresses.get(e)?r.COMPANY:r.INDIVIDUAL}setBuyerType(e){this.buyerType=e}isCompanyBuyer(){return this.buyerType===r.COMPANY}isBuyerTypeEditable(){return this._isBuyerTypeEditable}getBuyer(){const e=this.getSelectedAddress();return e&&e.isCompanyAddress?this.company:this.me}getSelectedAddress(){const e=this.cart.get(o.Fields.BILL_TO),t=this.companyAddresses&&this.companyAddresses.get(e);return t?(t.isCompanyAddress=!0,t):this.personAddresses.get(e)}createBillingAddress(e={}){return e[c.Fields.IS_BILL_TO]="TRUE",e[c.Fields.IS_SHIP_TO]="TRUE",this.isCompanyBuyer()?this._createCompanyAddress(e):this._createMeAddress(e)}_createCompanyAddress(e){return this.addressFactory.createModel(l.Types.COMPANY,{[c.Fields.COUNTRY]:this.company.getCountry(),...e},{isCompanyAddress:!0,parentResourceId:this.company.get("id")})}_createMeAddress(e){return this.addressFactory.createModel(l.Types.ME,e)}getValidBillingAdresses({forceBuyerTypeFiltering:e=!1}={}){const t=[];if((this.buyerType===r.INDIVIDUAL||this.isBuyerTypeEditable()&&!e)&&this.personAddresses.forEach(e=>{e.isBillTo()&&t.push(e)}),(this.buyerType===r.COMPANY||this.isBuyerTypeEditable()&&!e)&&this.company&&this.companyAddresses){const e=this.company.getCountry();this.companyAddresses.forEach(s=>{!s.isBillTo()||e&&s.getCountry()!==e||(s.isCompanyAddress=!0,t.push(s))})}return t}_fetchCardTokens(){let e,t;return this.isCompanyBuyer()?(e=u.Types.COMPANY,t=this.company.get("id")):(e=u.Types.ME,t=this.me.get("id")),t?(this.cardTokens.dataProxy=this.paymentCardTokenFactory.getDataProxy(e),this.cardTokens.setParentResourceId(t),this.cardTokens.fetchPromise()):Promise.resolve()}async patchBillingAddress(s,r={}){await this.cart.savePromise({[o.Fields.BILL_TO]:s.get("id"),...r},{patch:!0}),this.buyerType=this.deduceBuyerType(),await Promise.all([this.cartPsp.fetchPromise(),this._fetchCardTokens()]);let i=!1;if(this.service===e.CLICK_AND_BUY){const e=s.getCountry(),r=this.countries.find(t=>t.getIso3()===e),n=r&&r.getIso2();i=this.hasCountryChanged(n),t.storeCountry(this.service,n)}return{hasCountryChanged:i}}hasCountryChanged(e){return e!==t.getStoredCountry(this.service)}hasValidBillingAddress(){const e=this.cart.get(o.Fields.BILL_TO);return!!e&&!!this.getValidBillingAdresses().find(t=>t.get("id")===e)}async patchDefaultCartBillingAddress(){let t;if(this.hasValidBillingAddress())if(this.service===e.CLICK_AND_BUY){const e=this.cart.get(o.Fields.BILL_TO),s=this.getValidBillingAdresses().find(t=>t.get("id")===e).getCountry(),r=this.countries.find(e=>e.getIso3()===s),i=r&&r.getIso2();t=this.hasCountryChanged(i)}else t=!1;else{let e;const s=this.getValidBillingAdresses(),r=this.cart.get(o.Fields.SHIP_TO),i=r&&s.find(e=>e.get("id")===r);if(e=i||s.length>0&&s[s.length-1])return this.patchBillingAddress(e);t=!1}return await this._fetchCardTokens(),{hasCountryChanged:t}}}}),define("DS/MPFModalConfiguratorComponent/CBTokenPaymentConfirmationPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPspModel/PspModel","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,i,n,o,a,c,d,l,h,p,u)=>{"use strict";const m={},C={};m.PAYMENT_TOKEN="PaymentTokenOperation",m.VALID="valid",C.COMPLETE="Complete",C.FAILURE="Failure";const y=s.extend({className:"mpf-cbtoken-page",setup(e){e||(e={}),r.requiredOfPrototype(e.me,a,"options.me must be a PersonModel"),r.requiredOfPrototype(e.token,n,"options.token must be a PaymentCardTokenModel"),r.requiredOfPrototype(e.cart,c,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartPsp,p,"options.cartPsp must be a PspModel"),this.me=e.me,this.cart=e.cart,this.cartPsp=e.cartPsp,this.token=e.token,this.product=e.product,this.waitForPaymentModel=e.waitForPaymentModel,this.locale=e.locale||"fr-FR",this.service=e.service||i.MAKE,this.orderInfoSection=this._createOrderInformationSection(),this.tokenSection=this._createRecapCBTokenSection()},render(){return this.container.setContent([this.orderInfoSection.render(),this.tokenSection.render()]),this.dispatchEvent(m.VALID),this},save(){return this._payWithToken().then(()=>(this.dispatchEvent(m.PAYMENT_TOKEN,C.COMPLETE),{paymentOK:!0})).catch(e=>(console.error(e),this.dispatchEvent(m.PAYMENT_TOKEN,C.FAILURE),{paymentOK:!1}))},destroy(){this.orderInfoSection.destroy(),this.tokenSection.destroy(),this.cart=null,this.cartPsp=null,this.token=null,this.product=null,this.container=null},_payWithToken(){return this.cartPsp.getPsp()===p.Psp.STRIPE&&this.cartPsp.isScaEnabled()?this._getStripe().then(this._patchCart.bind(this)).then(this._submitPaymentToStripe.bind(this)).then(function(e){return e.error?Promise.reject(e.error):Promise.resolve()}).then(this._waitForPaymentStateUpdate.bind(this)):this._patchCart().then(this._waitForPaymentStateUpdate.bind(this))},_waitForPaymentStateUpdate(){var e=this;return this.waitForPaymentModel?this.waitForPaymentModel.fetchPromise().catch(()=>Promise.resolve()).then(()=>{if(e.waitForPaymentModel.getState()===h.States.PAYMENT_REFUSED)return Promise.reject(new Error("payment refused"))}):Promise.resolve()},_submitPaymentToStripe(){const e={};return e.payment_method=this.token.getPaymentMethodId(),this.stripe.handleCardPayment(this.cart.getPaymentIntentSecret(),e)},_patchCart(){const e={currentState:c.States.PENDING_PAYMENT,CreditCardTokenId:this.token.getCardId()},s=this.cart.getState()!==c.States.PAYMENT_INITIATED&&this.cart.getState()!==c.States.PAYMENT_REFUSED,r=new d,i=new l(l.Operations.modify,"/",e);return r.add(i),s?this.cart.megaPatch(r):t.resolve(this.cart)},_getStripe(){var s,r=this,i=t.deferred();return s=e.createElement("script",{src:"https://js.stripe.com/v3/",events:{load:function(){return r.stripe=Stripe(r.cartPsp.getPublicKey()),r.elements=r.stripe.elements(),i.resolve()}}}),"function"==typeof Stripe?(r.stripe=Stripe(r.cartPsp.getPublicKey()),r.elements=r.stripe.elements(),i.resolve()):document.body.appendChild(s),i.promise},_createRecapCBTokenSection(){const e=[{tag:"table",html:[this._createRow("mpf-cc-owner",u.get("ccOwner"),this.token.getCardName()),this._createRow("mpf-cc-number",u.get("ccNumber"),"xxxx-xxxx-xxxx-"+this.token.getCardNumber()),this._createRow("mpf-cc-expDate",u.get("ccExpDate"),this.token.getCardExpMonth()+"/"+this.token.getCardExpYear()),this._createRow("mpf-cc-type",u.get("ccType"),this.token.getCardType())]}];return new o({title:u.get("titleCBToken"),body:e})},_createOrderInformationSection(){let t;t=(t=this.cart.has(c.Fields.COUPON)?parseFloat(this.cart.getCoupon().totalToPay):this.cart.get("GrossAmountTotal")).toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"});const s=e.createElement("table",{html:[this._createRow("mpf-order-number",u.get("order"),"#"+this.cart.getName()),this._createRow("mpf-order-total",u.get("amount"),t)]});return new o({title:u.get("orderInformation"),body:[s]})},_createRow:(e,t,s)=>({tag:"tr",class:e,html:[{tag:"td",class:"mpf-label",text:t},{tag:"td",class:"mpf-value",text:s}]})});return y.Events=Object.freeze(m),y.PaymentStates=Object.freeze(C),y}),define("DS/MPFModalConfiguratorComponent/ThanksPurchasingPage",["UWA/Class/View","UWA/Core","DS/MPFUrl/UrlUtils","DS/MPFServices/MarketplaceServices","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],(e,t,s,r,i,n,o,a)=>{"use strict";const c={},d={};c.ON_RENDER="onRender",d.SUCCESS_PAGE="/checkout/OrderSuccess",d.FAILURE_PAGE="/checkout/OrderFailure";const l=e.extend({className:"mpf-end-purchasing",setup(e){e||(e={}),this.service=t.is(e.service)?e.service:r.MAKE,this.me=e.me,this.paymentOK=!0===e.paymentOK,this.product=e.product,this.isClicknbuyEduOrMakers=!0===e.isClicknbuyEduOrMakers,this.firstNameUser=e.firstNameUser,this.billingAddressHelper=e.billingAddressHelper,this.isClickAndBuy=this.service===r.CLICK_AND_BUY,this.isCompany=this.billingAddressHelper&&this.billingAddressHelper.isCompanyBuyer()||this.isClickAndBuy&&!this.isClicknbuyEduOrMakers},render(){let e;return this.service!==r.MAKE&&(this.paymentOK?(this.renderSuccess(),e=a.get("purchaseComplete")):(this.renderFailure(),e=a.get("purchaseFailure"))),window.parent.postMessage({isPaymentDone:!0,isPaymentOk:this.paymentOK,headerModalMsg:e},"*"),this.dispatchEvent(c.ON_RENDER),this},setPayment(e){this.paymentOK=e},_createIframe(){if(this.service===r.CLICK_AND_BUY&&s.isProduction())return t.createElement("iframe",{src:"https://assets.3ds.com/store/confirmation.html",class:"iframe-thanks-purchasing"})},renderSuccess(){this.container.setContent([this._displayCheckFonticon(),this._displaySuccessInfo(),this.isCompany?this._createIframe():""]),this._sendTrackingPage(d.SUCCESS_PAGE)},renderFailure(){this.container.setContent([this._displayWrongFonticon(),this._displayFailureInfo(),this.isCompany?this._createIframe():""]),this._sendTrackingPage(d.FAILURE_PAGE)},_displayCheckFonticon:()=>t.createElement("div",{class:"fonticon fonticon-5x fonticon-check"}),_displayWrongFonticon:()=>t.createElement("div",{class:"fonticon fonticon-5x fonticon-wrong"}),_displaySuccessInfo(){const e=this.service===r.SUBSCRIPTIONS,s=this.service===r.INNOVATE;let i="";return i=(this.isClickAndBuy||e||s)&&this.isCompany?this._getCompanyMessage():this.isClicknbuyEduOrMakers?this._getPersonnalizedMessage():this._getStandardMessage(),t.createElement("div",{class:"mpf-end-purchase-info",html:i})},_getPersonnalizedMessage(){return[t.createElement("p",{text:t.is(this.me)?a.get("cnbThanksWelcomeFull",{firstName:this.me.getFirstName(),lastName:this.me.getLastName()}):t.is(this.firstNameUser)?a.get("cnbThanksWelcomeShort",{firstName:this.firstNameUser}):a.get("cnbThanksWelcome")}),t.createElement("p",{html:a.get("cnbThanks1")}),t.createElement("ul",{class:"mpf-list",html:[{class:"mpf-list-item",tag:"li",text:a.get("cnbThanksEmail1")},{class:"mpf-list-item",tag:"li",text:a.get("cnbThanksEmail2")}]}),t.createElement("p",{class:"mpf-note",text:a.get("cnbThanksNote")}),t.createElement("p",{text:a.get("cnbThanksEnd")})]},_getStandardMessage(){let e;const s=[];e=t.is(this.product)&&"PGB"===this.product?a.get("PGBPurchase"):t.is(this.product)?a.get("LicensesPurchase"):a.get("Purchase");const i=t.createElement("p",{text:a.get("thanksPurchase")}),n=t.createElement("p",{text:e}),o=t.createElement("p",{text:this.service===r.IFWELOOP?a.get("emailSolutionReady"):a.get("emailPurchase")});return s.push(i),this.service!==r.IFWELOOP&&s.push(n),s.push(o),s},_getCompanyMessage(){const e=[],s=t.createElement("p",{class:"mpf-thanks-purchase",text:a.get("thanksPurchase2")}),r=t.createElement("div",{class:"mpf-more-details-container",html:[a.get("experienceSoonAvailable"),{tag:"ol",html:[{tag:"li",text:a.get("confirmationEmail")},{tag:"li",html:[a.get("getStartedEmail"),{tag:"span",class:"mpf-check-spam",text:a.get("checkSpam")}]}]}]});return e.push(s,r),e},_displayFailureInfo(){const e=t.createElement("p",{text:a.get("errorPayment")}),s=t.createElement("p",{text:a.get("supportDS")});return t.createElement("div",{class:"mpf-end-purchase-info",html:[e,s]})},_sendTrackingPage(e){i.createPageBuilder({url:e}).addDimension(n.MARKETPLACE_SERVICE,this.service).send()}});return l.Events=Object.freeze(c),l}),define("DS/MPFModalConfiguratorComponent/BillingAddressList",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFPersonModel/PersonModel","DS/MPFAddressFormComponent/AddressCard"],function(e,t,s,r,i){"use strict";const n=Object.freeze({ADD_ADDRESS:"addAddress"}),o=t.extend({className:"mpf-billing-address-list",setup:function(e){s.requiredOfPrototype(e.me,r,"options.me must be a PersonModel"),this.billingAddressHelper=e.billingAddressHelper,this.company=e.company,this.me=e.me,this.countries=e.countries,this.addressCards=[],this.addAddressButton=this._createAddAddressButton()},render:function(){return this._destroyAddressCards(),this.addressCards=this._createAddressCards(),this.container.setContent([this.addressCards,this.addAddressButton]),this},getSelectedAddress:function(){return this.selectedAddressCard.getAddress()},destroy:function(){this.stopListening(),this._destroyAddressCards(),this.billingAddressHelper=null,this.me=null,this.company=null,this.countries=null,this._parent(),this.container=null},_createAddressCards:function(){const e=[],t=this.billingAddressHelper.getValidBillingAdresses({forceBuyerTypeFiltering:!0});return t.forEach((s,r)=>{const n=this.countries.getCountryWithIso3(s.getCountry()),o=n&&n.getName(),a=new i({address:s,legalEntity:s.isCompanyAddress?this.company:this.me,country:o,noToggle:t.length<=1});0===r&&(this.selectedAddressCard=a)&&this.selectedAddressCard.select(),this.listenTo(a,i.Events.ON_SELECTED,this._onSelection.bind(this)),e.push(a.render())}),e},_createAddAddressButton:function(){return e.createElement("div",{class:"mpf-add-address-button",text:"+",html:{tag:"span",class:"fonticon fonticon-plus"},events:{click:this.dispatchEvent.bind(this,n.ADD_ADDRESS)}})},_onSelection:function({addressCard:e}){this.selectedAddressCard!==e&&(this.selectedAddressCard.unselect(),e.select(),this.selectedAddressCard=e)},_destroyAddressCards:function(){this.addressCards.forEach(e=>{this.stopListening(e),e.destroy()}),this.addressCards=null}});return o.Events=n,o}),define("DS/MPFModalConfiguratorComponent/OrderPaymentMethodSection",["UWA/Core","DS/MPFOrderComponent/OrderConfirmationSection","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/MPFView/FieldTextInputV2","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFUrl/UrlUtils","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y)=>{"use strict";const g=Object.freeze({VALID:"validSection",INVALID:"invalidSection",NEW_HEIGHT:"new-height",ON_CHANGE_METHOD_ERROR:"onChangeMethodError"}),P=Object.freeze({CB:"CB",BANK_TRANSFER:"bankTransfer",COUPON:"coupon",UNIFIED_PAYMENTS_INTERFACE:"upi"}),S=t.extend({setup(e={}){l.requiredOfPrototype(e.billingAddressHelper,c,"options.billingAddressHelper must be a BillingAddressHelper"),l.requiredOfPrototype(e.cart,o,"options.cart must be a CartModel"),l.requiredOfPrototype(e.cartPsp,d,"options.cartPsp must be a PspModel"),l.requiredOfPrototype(e.cardTokens,n,"options.cardTokens must be a PaymentCardTokenCollection"),this.billingAddressHelper=e.billingAddressHelper,this.cart=e.cart,this.cartPsp=e.cartPsp,this.cardTokens=e.cardTokens,this.service=e.service,this.bankTransferActive=e.bankTransferActive,this._parent(e),this._initCBOption(),this._initBankTransfertOption(),this._initUpiOption(),this.listenTo(this.cardTokens,"onSync",this._updateAvailableTokens.bind(this))},render(){return this._fillBody(),this._parent(),this._displayBTOption(),this.updatePaymentCoupon(),0===this.cart.getGrossAmountTotal()&&this.container.hide(),this},updatePaymentCoupon(){if(this.service===h.CLICK_AND_BUY){const e=this.cart.has(o.Fields.COUPON),t=this.bankTransfToggle&&this.bankTransfToggle.isChecked();if(e){if(t)return this.cbToggle.setCheck(!0),this._cbOptionSelected().then(()=>{this.bankTransfToggle&&this.bankTransfToggle.hide()});this.bankTransfToggle&&this.bankTransfToggle.hide()}else this.bankTransfToggle&&this.bankTransfToggle.show()}},destroy(){this.stopListening(this.purchaseOrderField),this.stopListening(this.expenseFinancialLineField),this.purchaseOrderField&&this.purchaseOrderField.destroy(),this.expenseFinancialLineField&&this.expenseFinancialLineField.destroy(),this.billingAddressHelper=null,this.cart=null,this.cartPsp=null,this.service=null,this.cardTokens=null,this._parent()},_fillBody(){const t=e.createElement("div",{class:"mpf-payment-cb",html:this.billingAddressHelper.isCompanyBuyer()?[this.cbToggle,this.selectCB,this.saveCB,this.purchaseOrderField.render(),this.expenseFinancialLineField.render()]:[this.cbToggle,this.selectCB,this.saveCB]}),s=e.createElement("div",{class:"mpf-payment-bank-transfer",html:this.bankTransfToggle}),r=e.createElement("div",{class:"mpf-payement-upi",html:this.UpiToggle});this.body=e.createElement("div",{class:"mpf-payment-method mpf-horizontal",html:[t,s,r]})},getPaymentMethod(){const e={};if(this.container.isHidden())e.method=P.COUPON;else if(this.cbToggle.isChecked())if(e.method=P.CB,e.value=this.selectCB.getValue()[0],"addCB"===e.value)e.CreditCardTokenMultiUse=this.saveCB.isChecked()?"1":"0";else{const t=this.cardTokens.filter(e=>this.selectCB.getValue()[0]===e.getCardId()).shift();e.CreditCardToken=t}else this.UpiToggle&&this.UpiToggle.isChecked()?e.method=P.UNIFIED_PAYMENTS_INTERFACE:e.method=P.BANK_TRANSFER;return e},_initCBOption(){const e=this;let t="addCB";const n=this._getCBTokens(),a=this.cart.getPaymentMethod();n.length>0&&(t=n[n.length-1].value),this.cbToggle=new s({value:y.get("cbChoiceLabel"),name:"mpf-payment-method",className:"primary cb",checked:!a||a===o.PaymentMethods.BANK_CARD,events:{onChange:function(){this.isChecked()&&e._cbOptionSelected()}}}),this.saveCB=this._createSaveCbToggle(),this.selectCB=new r({placeholder:y.get("selectCB"),value:t,options:n,disabled:!this.cbToggle.isChecked(),events:{onChange:function(){const t="addCB"===this.getValue()[0];e.dispatchEvent(g.NEW_HEIGHT),e._displayCheckboxSaveCB(t),e._sendTrackerEvent(t?"AddNewCreditCardChosen":"CreditCardSelected"),""!==this.getValue()[0]?e.dispatchEvent(g.VALID):e.dispatchEvent(g.INVALID)},onClick:function(){e.dispatchEvent(g.NEW_HEIGHT,parseInt(this.elements.dropdown.getStyle("height")))}}}),this.purchaseOrderField=this._createBankCardPurchaseOrderField(),this.listenTo(this.purchaseOrderField,i.Events.UPDATE,this._sendTrackerEvent.bind(this,"YourReferenceToMentionOnInvoiceFilled")),this.expenseFinancialLineField=this._createBankCardExpenseFinancialLineField(),this.listenTo(this.expenseFinancialLineField,i.Events.UPDATE,this._sendTrackerEvent.bind(this,"ExpenseFinancialLineFilled")),this._updateBankCardAdditionnalFieldsVisibility(),this._displayCheckboxSaveCB(this.cbToggle.isChecked()&&"addCB"===this.selectCB.getValue()[0])},_createSaveCbToggle(){const e=this;return new s({type:"checkbox",name:"save-CB",value:y.get("saveCB"),className:"primary cb-save",checked:!0,events:{onClick:function(){e._sendTrackerEvent("SaveCardInformationClicked",this.isChecked()?"on":"off")}}})},_createBankCardPurchaseOrderField(){return new i({model:this.cart,fieldName:o.Fields.PURCHASE_ORDER_NUMBER,fieldLabel:y.get("referenceMention"),dynamicValidation:!0,maxlength:30})},_createBankCardExpenseFinancialLineField(){return new i({model:this.cart,fieldName:o.Fields.EXPENSE_FINANCIAL_LINE,fieldLabel:y.get("expenseFinancialLine"),dynamicValidation:!0})},_updateBankCardAdditionnalFieldsVisibility(){this.cbToggle.isChecked()?(this.purchaseOrderField.show(),this.expenseFinancialLineField.show()):(this.purchaseOrderField.hide(),this.expenseFinancialLineField.hide())},_cbOptionSelected(){return this.selectCB.enable(),this._updateBankCardAdditionnalFieldsVisibility(),this._displayCheckboxSaveCB("addCB"===this.selectCB.getValue()[0]),this.dispatchEvent(g.INVALID),this._setPaymentMethodOnCart(o.PaymentMethods.BANK_CARD).then(()=>{const e=""!==this.selectCB.getValue()[0]?g.VALID:g.INVALID;this.dispatchEvent(e)}).catch(this.dispatchEvent.bind(this,g.ON_CHANGE_METHOD_ERROR))},_updateAvailableTokens(){const e=this._getCBTokens();this.selectCB.remove(),this.selectCB.add(e),this.selectCB.setValue(e[e.length-1].value)},_getCBTokens(){const e=this.cartPsp.getPsp(),t=this.cartPsp.getCountryPlatform(),s=e===d.Psp.HIPAY,r=e===d.Psp.STRIPE,i=this.cardTokens.filter(i=>{const n=i.getPsp()===e,o=i.getPlatform()===t;return n&&(s||r&&o)}).map(e=>({value:e.getCardId(),label:"xxxx-xxxx-xxxx-"+e.getCardNumber()+", "+e.getCardExpMonth()+"/"+e.getCardExpYear()}));return i.unshift({value:"addCB",label:y.get("createCB")}),i},_initBankTransfertOption(){const e=this,t=!this.billingAddressHelper.isCompanyBuyer()&&!this.billingAddressHelper.isBuyerTypeEditable(),r=p.from(window.location.href).isEmp(),i=t&&!r,n=this.service===h.IFWELOOP,a=-1!==window.location.href.indexOf("BankTransfer");if(this.bankTransferActive&&!this.cart.isDirectPurchase()&&!i||n||a){const t=this._getBankTransferLabel();this.bankTransfToggle=new s({value:t,name:"mpf-payment-method",className:"primary bank",checked:this.cart.getPaymentMethod()===o.PaymentMethods.DEFERRED_BANK_TRANSFER,events:{onChange:function(){this.isChecked()&&e._bankTransferOptionSelected()}}})}},_disableBankcardFields(){this.selectCB.disable(),this._updateBankCardAdditionnalFieldsVisibility(),this._displayCheckboxSaveCB(!1)},_bankTransferOptionSelected(){return this._disableBankcardFields(),this.dispatchEvent(g.INVALID),this._setPaymentMethodOnCart(o.PaymentMethods.DEFERRED_BANK_TRANSFER).then(this.dispatchEvent.bind(this,g.VALID)).catch(t=>{const s=e.is(t.response)?t.response:{};this.dispatchEvent(g.ON_CHANGE_METHOD_ERROR,s),e.is(s.errorCode)&&"Error.BankTransferNotAllowed"===s.errorCode&&(this.cbToggle.setCheck(!0),this.bankTransfToggle.setCheck(!1),this.bankTransfToggle.setDisabled(),this._cbOptionSelected())})},_displayBTOption(){let t=!1;if(this.billingAddressHelper.isBuyerTypeEditable()){t=!this.billingAddressHelper.getSelectedAddress().isCompanyAddress}const s=-1!==this.cartPsp.getPaymentMethod().indexOf(d.PaymentMethod.BANK_TRANSFER);if(e.is(this.bankTransfToggle))if(t||!s&&this.service!==h.IFWELOOP)this.bankTransfToggle.hide();else{const e=this._getBankTransferLabel();this.bankTransfToggle.setValue(e),this.bankTransfToggle.show()}},_getBankTransferLabel(){const e=this.cartPsp.getPsp()===d.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===d.Platform.STRIPE_US,t=this.billingAddressHelper.getSelectedAddress(),s=t&&t.getCountry(),r=(e={default:null})=>{let t;return t="GBP"===this.cart.getCurrency()&&"GBR"===s?y.get("bankTransferUK"):"EUR"===this.cart.getCurrency()?y.get("bankTransferEU"):e.default};let i;return i=this.service===h.IFWELOOP||this.service===h.CLICK_AND_BUY||this.service===h.INNOVATE?y.get("deferredPaymentInvoice"):e?y.get("btChoiceACHLabel"):r({default:y.get("btChoiceLabel")})},_displayCheckboxSaveCB(e){e?this.saveCB.show():this.saveCB.hide()},_initUpiOption(){this.cartPsp.getPaymentMethod().includes(d.PaymentMethod.UNIFIED_PAYMENTS_INTERFACE)&&(this.UpiToggle=new s({value:y.get("UPI"),name:"mpf-payment-method",className:"primary bank",checked:this.cart.getPaymentMethod()===o.PaymentMethods.UNIFIED_PAYMENTS_INTERFACE,events:{onChange:()=>{this.UpiToggle.isChecked()&&this._upiOptionSelected()}}}))},_upiOptionSelected(){return this._disableBankcardFields(),this.dispatchEvent(g.INVALID),this._setPaymentMethodOnCart(o.PaymentMethods.UNIFIED_PAYMENTS_INTERFACE).then(this.dispatchEvent.bind(this,g.VALID)).catch(t=>{const s=e.is(t.response)?t.response:{};this.dispatchEvent(g.ON_CHANGE_METHOD_ERROR,s)})},hide(){this.container.hide(),this.dispatchEvent(g.VALID)},show(){this.container.show(),this.dispatchEvent(this.isValid()?g.VALID:g.INVALID)},isValid(){let e=!1;return this.container.isHidden()?e=!0:this.bankTransfToggle&&this.bankTransfToggle.isChecked()?e=this.cart.getPaymentMethod()===o.PaymentMethods.DEFERRED_BANK_TRANSFER:this.UpiToggle&&this.UpiToggle.isChecked()?e=this.cart.getPaymentMethod()===o.PaymentMethods.UNIFIED_PAYMENTS_INTERFACE:this.cbToggle.isChecked()&&(e=""!==this.selectCB.getValue()[0]&&this.cart.getPaymentMethod()===o.PaymentMethods.BANK_CARD),e},_setPaymentMethodOnCart(e){return this.cart.savePromise({[o.Fields.PAYMENT_METHOD]:e},{patch:!0})},_sendTrackerEvent(e,t){const s=u.createEventBuilder({category:C.CHECKOUT,action:e});a.addTrackerInformation(s,this.cart),t&&s.setLabel(t),s.addDimension(m.MARKETPLACE_SERVICE,this.service).send()}});return S.Events=Object.freeze(g),S.PaymentMethod=Object.freeze(P),S}),define("DS/MPFModalConfiguratorComponent/PaymentRedirectResultComponent",["UWA/Class/View","UWA/Core","DS/MPFServices/MarketplaceServices","DS/MPFView/ManuallyClosedModal","DS/MPFCartModel/CartModel","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/UIKIT/Spinner","DS/UIKIT/Input/Button","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],(e,t,s,r,i,n,o,a,c,d)=>{"use strict";const l=Object.freeze({WAIT_PAYMENT_INFO:"waitPaymentInfo",DISPLAY_PAYMENT_RESULT:"displayPaymentResult"}),h=Object.freeze({PAYMENT_COMPLETED:"paymentCompleted"}),p=e.extend({className:"mpf-payment-redirect-result",setup:function(e){this.service=e.service,this.cart=e.cart,this.stateMachine=this._createStateMachine(),this.spinner=this._createSpinner(),this.modal=null,this.thanksComponent=null,setTimeout(this._waitForPaymentInformation.bind(this),0)},render:function(){return this.stateMachine.isState(l.DISPLAY_PAYMENT_RESULT)?(this.container.setContent(),this.modal.inject(this.container)):(this.container.setContent(this.spinner),this.spinner.show()),this},destroy:function(){this.thanksComponent&&this.thanksComponent.destroy(),this._parent()},_createSpinner:()=>new o,_createModal(e){const t=this.service===s.CLICK_AND_BUY&&(this.cart.hasEduItems()||this.cart.hasMakerItems()),i=e.isPaymentOk?d.get("purchaseComplete"):d.get("purchaseFailure"),n=this.service!==s.CLICK_AND_BUY||t?new a({value:d.get("close"),className:"default",events:{onClick:this._onClickModalOk.bind(this)}}):this._createFooterForCompany();return new r({className:"mpf-payment-redirect-result-modal",closable:!0,visible:!0,header:i,body:this.thanksComponent.render(),footer:n,events:{[r.Events.ON_CLOSE]:this._onClickModalOk.bind(this)}})},_createFooterForCompany(){const e=t.createElement("a",{text:"www.3ds.com/store/get-started",href:"https://www.3ds.com/store/get-started?utm_content=3ds&utm_term=companygspage&utm_source=ordconfpage",target:"_blank"}).outerHTML;return t.createElement("div",{class:"mpf-visit-get-started",html:d.get("visitGetStarted",{getStarted:e})})},_onClickModalOk(){this.modal.hide(),this.dispatchEvent(h.PAYMENT_COMPLETED)},_createThanksComponent(e){const t=this.service===s.CLICK_AND_BUY&&(this.cart.hasEduItems()||this.cart.hasMakerItems());return new c({service:this.service,paymentOK:e.isPaymentOk,isClicknbuyEduOrMakers:t})},_createStateMachine:()=>new n({state:l.WAIT_PAYMENT_INFO,states:[l.WAIT_PAYMENT_INFO,l.DISPLAY_PAYMENT_RESULT],transitions:[{from:l.WAIT_PAYMENT_INFO,to:l.DISPLAY_PAYMENT_RESULT}]}),async _waitForPaymentInformation(){let e=!0;switch(this.cart.get(i.Fields.PAYMENT_STATUS)){case i.States.PAYMENT_PAYMENT_REFUSED:e=!1;case i.States.PAYMENT_ACCEPTED:this.thanksComponent=this._createThanksComponent({isPaymentOk:e}),this.modal=this._createModal({isPaymentOk:e}),this.stateMachine.changeState(l.DISPLAY_PAYMENT_RESULT),this.render();break;default:await this.cart.fetchPromise({expand:[i.Expands.CART_ITEMS]}),setTimeout(this._waitForPaymentInformation.bind(this),300)}}});return p.States=l,p.Events=h,p}),define("DS/MPFModalConfiguratorComponent/BillingInformationSection",["UWA/Core","UWA/String","DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFOrderComponent/NoOrderConfirmationSectionCommand","DS/UIKIT/Alert","DS/MPFView/IconSelectInput","DS/MPFAddressFormComponent/AddressCard","DS/MPFModalConfiguratorComponent/BuyerCard","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFPspModel/PspModel","DS/MPFCountryModel/CountryCollection","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFUrl/UrlUtils","DS/MPFServices/MarketplaceServices","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","DS/MPFModalConfiguratorComponent/BillingAddressHelper","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","i18n!DS/MPFAddressFormComponent/assets/nls/AddressFormComponent"],(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y,g,P,S,E,M,A,_,f)=>{"use strict";const D=Object.freeze({ADDRESS_SELECTION:"addressSelection",ADDRESS_DETAILS:"addressDetails"}),T=Object.freeze({NEW_ADDRESS_FORM:"newAddressForm",ADDRESS_SELECTION:"onAddressSelection",PATCHING_CART:"updatingCart",ERROR_PATCH_CART:"errorPatchCart",VALID:"validSection",INVALID:"invalidSection"}),O=Object.freeze({ADD:0,DETAILS:1}),F=r.extend({className:"mpf-billing-information-section mpf-section",setup(e={}){s.requiredOfPrototype(e.cart,p,"options.cart must be a CartModel"),s.requiredOfPrototype(e.cartPsp,m,"options.cartPsp must be a PspModel"),s.requiredOfPrototype(e.countries,C,"options.countries must be a CountryCollection"),s.requiredOfPrototype(e.billingAddressHelper,A,"options.billingAddressHelper must be a BillingAddressHelper"),s.requiredOfPrototype(e.addressFactory,h,"options.addressFactory must be an AddressFactory"),this._parent(e),this.cart=e.cart,this.cartPsp=e.cartPsp,this.billingAddressHelper=e.billingAddressHelper,this.addressFactory=e.addressFactory,this.countries=e.countries,this.service=e.service,this.selectedAddress=null,this.isReadOnly=!0===e.isReadOnly,this.commands=this._getCommands(),this.alert=this._createAlert(),this.stateMachine=this._createStateMachine()},render(){let t;return this.commands.forEach(e=>e.render()),this.stateMachine.getState()===D.ADDRESS_DETAILS?(t=[this.alert,...this._renderDetails()],this.commands[O.DETAILS].setOn()):(t=[this.alert,this._getAddressSelect()],this.commands[O.DETAILS].setOff()),this.body=[e.createElement("div",{class:"mpf-billing-infos",html:t})],this._parent(),this},isValid(){return e.is(this.billingAddressHelper.getSelectedAddress())},_getAddressSelect(){const e=this.cart.get(p.Fields.BILL_TO),t=this.billingAddressHelper.getValidBillingAdresses(),s=e&&t.find(t=>t.get("id")===e);if(!s)throw new Error("No billing address found in cart!");const r=t.map(e=>{const t=e.get("id");return{value:t,label:this._getAddressTitle(e),icon:e.isCompanyAddress?"building-office":"user",selected:t===s.get("id")}});return new a({options:r,placeholder:!1,disabled:this.isReadOnly,events:{onChange:this._onAddressChange.bind(this)}})},_onAddressChange(e){const t=e.target.value;if(t)if(t!==this.cart.get(p.Fields.BILL_TO)){const e=this.billingAddressHelper.getValidBillingAdresses().find(e=>e.get("id")===t);this.dispatchEvent(T.ADDRESS_SELECTION,e)}else this.dispatchEvent(T.VALID);else this.dispatchEvent(T.INVALID)},_getAddressTitle(s){let r="";return[l.Fields.LINE1,l.Fields.LINE2,l.Fields.LINE3,l.Fields.LINE4,l.Fields.CITY,l.Fields.COUNTY,l.Fields.STATE,l.Fields.POSTAL_CODE,l.Fields.COUNTRY].map(t=>{if(t===l.Fields.STATE){const r=f[s.getCountry()+s.getState()];return e.is(r)?r:s.get(t)}return s.get(t)}).filter(e=>e&&e.length>0).map(e=>r=r+" "+e+","),t.truncate(r,r.length-1,"")},_getCommands(){const e=g.from(window.location.href).isEmp()||this.service===P.IFWELOOP&&!0!==this.cart.get("isSelfOrder")||this.service===P.SUBSCRIPTIONS||this.service===P.INNOVATE||this.isReadOnly?n.getInstance():new i({icon:"plus",iconOff:"plus",label:_.get("addAddress"),labelOff:_.get("addAddress")});this.listenTo(e,"commandOn",this.dispatchEvent.bind(this,T.NEW_ADDRESS_FORM)),this.listenTo(e,"commandOff",this.dispatchEvent.bind(this,T.NEW_ADDRESS_FORM));const t=new i({icon:"eye",iconOff:"eye-off",label:_.get("details"),labelOff:_.get("hideDetails")});return this.listenTo(t,"commandOn",this._displayDetails.bind(this)),this.listenTo(t,"commandOff",this._displayAddressSelect.bind(this)),[e,t]},_displayDetails(){this.stateMachine.changeState(D.ADDRESS_DETAILS),this._sendTrackerEvent("Billing.DetailsAddressClicked"),this.render()},_displayAddressSelect(){this.stateMachine.changeState(D.ADDRESS_SELECTION),this.render()},_renderDetails(){const e=this.billingAddressHelper.getSelectedAddress(),t=e.getCountry(),s=this.billingAddressHelper.getBuyer(),r=this.billingAddressHelper.getBuyerType();let i,n;return i=t&&t.test(/^[A-Z]{3}$/)?this.countries.find(e=>e.getIso3()===t).getName():t,n=e?[new d({model:s,buyerType:r,country:i}).render(),new c({address:e,legalEntity:s,country:i,readOnly:!0}).render()]:[new d({model:s,buyerType:r}).render(),this._getAddressSelect()]},_createAlert:()=>new o({messsageClassName:"error",icon:!0,closable:!0,visible:!0,maximumVisibleMessage:1}),_createStateMachine:()=>new y({state:D.ADDRESS_SELECTION,states:[D.ADDRESS_SELECTION,D.ADDRESS_DETAILS],transitions:[{from:D.ADDRESS_SELECTION,to:D.ADDRESS_DETAILS},{from:D.ADDRESS_DETAILS,to:D.ADDRESS_SELECTION}]}),_sendTrackerEvent(e){const t=S.createEventBuilder({category:M.CHECKOUT,action:e});u.addTrackerInformation(t,this.cart),t.addDimension(E.MARKETPLACE_SERVICE,this.service).send()}});return F.Events=T,F.States=D,F}),define("DS/MPFModalConfiguratorComponent/OrderSummaryDetailsSection",["DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartModel/CartItemFactory","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFModalConfiguratorComponent/OrderSummarySection","DS/MPFOrderComponent/OrderDetailsComponent","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u){"use strict";const m=Object.freeze({ORDER_DETAILS_DISPLAYED:"orderDetailsDisplayed",ORDER_DETAILS_NOT_DISPLAYED:"orderDetailsNotDisplayed",LOADING:"loading"}),C=Object.freeze({ON_RENDER:"onRender",ON_RENDER_ERROR:"onRenderError"}),y=n.extend({setup:function(e){e||(e={}),t.requiredOfPrototype(e.cart,s,"options.cart must be a CartModel"),t.requiredOfPrototype(e.cartItemFactory,i,"options.cartItemFactory must be a CartItemFactory"),this._parent(e),this.service=e.service,this.cart=e.cart,this.cartItemFactory=e.cartItemFactory,this.locale=e.locale||"fr-FR",this.orderSummarySection=null,this.orderDetailsSection=null,this.commands=this._createCommands(),this.stateMachine=this._createStateMachine()},render:function(){return this.orderSummarySection=this._createOrderSummarySection(),this.orderDetailsSection=this._createOrderDetailsSection(),this._parent(),this._updateBody(),this},_updateBody:function(){const e=this.stateMachine.getState(),t=this.container.getElement(".mpf-body"),s=e===m.ORDER_DETAILS_DISPLAYED?this.orderDetailsSection.render():this.orderSummarySection.render();t.setContent(s)},_displayAlert:function(){new e({className:"error",messages:{className:"error",message:u.get("errorCartItems")},icon:!0,closable:!0,visible:!0}).inject(this.container.getElement(".mpf-body"),"top")},_createOrderSummarySection:function(){return new a({cart:this.cart,locale:this.locale})},_createOrderDetailsSection:function(){return new c({service:this.service,cart:this.cart,cartItems:this.cartItemFactory.createCollection("",this.cart.getItems()),locale:this.locale})},_createCommands:function(){const e=this,t="TRUE"===this.cart.get("IsPriceDetailsDisplay"),s=new o({icon:"eye",iconOff:"eye-off",label:u.get("details"),labelOff:u.get("hideDetails")});return this.listenTo(s,o.Events.COMMAND_ON,function(){e.stateMachine.changeState(m.ORDER_DETAILS_DISPLAYED),this._sendTrackerEvent("Billing.DetailsPriceClicked"),e._updateBody()}),this.listenTo(s,o.Events.COMMAND_OFF,function(){e.stateMachine.changeState(m.ORDER_DETAILS_NOT_DISPLAYED),this._sendTrackerEvent("Billing.HideDetailsPriceClicked"),e._updateBody()}),t?[s.render()]:[]},_sendTrackerEvent:function(e){const t=l.createEventBuilder({category:p.CHECKOUT,action:e});r.addTrackerInformation(t,this.cart),t.addDimension(h.MARKETPLACE_SERVICE,this.service).send()},_createStateMachine:function(){return new d({state:m.ORDER_DETAILS_NOT_DISPLAYED,states:[m.ORDER_DETAILS_DISPLAYED,m.ORDER_DETAILS_NOT_DISPLAYED,m.LOADING],transitions:[{from:m.ORDER_DETAILS_DISPLAYED,to:m.ORDER_DETAILS_NOT_DISPLAYED},{from:m.ORDER_DETAILS_NOT_DISPLAYED,to:m.ORDER_DETAILS_DISPLAYED},{from:m.ORDER_DETAILS_DISPLAYED,to:m.LOADING},{from:m.ORDER_DETAILS_NOT_DISPLAYED,to:m.LOADING},{from:m.LOADING,to:m.ORDER_DETAILS_DISPLAYED},{from:m.LOADING,to:m.ORDER_DETAILS_NOT_DISPLAYED}]})}});return y.Events=Object.freeze(C),y}),define("DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSectionV2",["UWA/Core","UWA/Class/View","UWA/Class/Promise","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFShopModel/ShopModel","DS/MPFShopModel/ShopServiceModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFTCContractModel/TCContractModel","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcContractComponent/SalesConditionsBuyerPayment","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y,g,P){"use strict";const S=Object.freeze({VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"}),E=t.extend({className:"mpf-sales-conditions-buyer-payment-section-v2",setup(e={}){n.requiredOfPrototype(e.shop,a,"options.shop must be a ShopModel"),n.requiredOfPrototype(e.cart,d,"options.cart must be a CartModel"),n.requiredOfPrototype(e.billingAddressHelper,o,"options.billingAddressHelper must be a BillingAddressHelper"),n.requiredOfPrototype(e.tcContractFactory,u,"options.tcContractFactory must be a TCContractFactory"),n.requiredOfPrototype(e.tcDocumentFactory,p,"options.tcDocumentFactory must be a TCDocumentFactory"),this.shop=e.shop,this.cart=e.cart,this.billingAddressHelper=e.billingAddressHelper,this.service=e.service,this.tcContractFactory=e.tcContractFactory,this.tcDocumentFactory=e.tcDocumentFactory,this.alert=this._createAlert()},render(){return this.container.setContent([this.alert]),i.mask(this.container),this.dispatchEvent(S.INVALID_SECTION),this._fetchContract().then(t=>{i.unmask(this.container),e.is(t)&&t.getCurrentState()===h.STATUS.draft?(this.checkbox=this._createCheckbox({tcContract:t}),this.container.addContent(this.checkbox.render()),this.dispatchEvent(this.isChecked()?S.VALID_SECTION:S.INVALID_SECTION)):(this.checkbox&&(this.checkbox=null),this.dispatchEvent(S.VALID_SECTION))}),this},isChecked(){return!e.is(this.checkbox)||this.checkbox.isChecked()},save(){return e.is(this.checkbox)?this.checkbox.signContract():s.resolve()},async _fetchContract(){try{const e=await this.tcContractFactory.createModel(u.Types.CUSTOM_TC_SELLER,null,{parentResourceId:this.cart.get("id")}).fetchPromise();let t;if(e.isNew()){const e=await this.tcContractFactory.createCollection(u.Types.CONSUMED_CONTRACTS).fetchPromise(),s=this.billingAddressHelper.getBuyer().get("id"),r=this.shop.get("owner").match(/[A-Z0-9]{32}$/)[0];(t=this._findContractIn(e,s,r))?t.dataProxy=this.tcContractFactory.getDataProxy(u.Types.CONTRACTS):t=await this._createContract(s,r)}else t=e;return t}catch(e){console.error(e),this.alert.add({className:"error",message:P.get("errorTC")}).show()}},_createAlert:()=>new r({visible:!1,closable:!0}),_createCheckbox({tcContract:e}){const t=new m({shopModel:this.shop,tcDocumentFactory:this.tcDocumentFactory,tcContract:e});return this.listenTo(t,m.Events.CHECKED,()=>{this._sendTrackingEvent("SalesConditionsClicked",{label:"on",service:this.service}),this.dispatchEvent(S.VALID_SECTION)}),this.listenTo(t,m.Events.UNCHECKED,()=>{this._sendTrackingEvent("SalesConditionsClicked",{label:"off",service:this.service}),this.dispatchEvent(S.INVALID_SECTION)}),t},_findContractIn(e,t,s){if(e)for(let r=e.length-1;r>=0;r--){const i=e.at(r);if(i.getConsumerID()===t&&i.getDocumentType()===h.DOCUMENT_TYPES.DEFAULT_SALES_CONDITIONS&&i.getSupplierID()===s&&i.getCurrentState()!==h.STATUS.archived&&i.getSigningRevision()===i.getActiveRevision())return i}},_createContract(e,t){const s=this.shop.getService(this.service)[c.Fields.CONTRACT_DOCUMENTS];if(!s)return Promise.reject(new Error("No shop TC documents found"));if(0===s.length)return Promise.resolve();if(s.length>0){return this.tcContractFactory.createModel(u.Types.EXISTING_DOCUMENT,{documentID:s[0].id,supplierID:t,consumerID:e,currentState:h.STATUS.draft}).savePromise()}},_sendTrackingEvent(e,t){const s=C.createEventBuilder({category:g.CHECKOUT,action:e}).setLabel(t.label);l.addTrackerInformation(s,this.cart),s.addDimension(y.MARKETPLACE_SERVICE,t.service).send()}});return E.Events=Object.freeze(S),E}),define("DS/MPFModalConfiguratorComponent/BillingAddressFormSectionV2",["DS/MPFServices/ObjectService","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFModalConfiguratorComponent/BillingAddressList","DS/MPFOrderComponent/OrderConfirmationSection"],function(e,t,s,r,i,n,o,a,c,d){"use strict";const l=Object.freeze({SELECTION:"addressSelection",CREATION:"addressCreation"}),h=d.extend({className:"mpf-billing-address-form-section-v2",setup:function(a={}){e.requiredOfPrototype(a.billingAddressHelper,t,"options.billingAddressHelper must be a BillingAddressHelper"),e.requiredOfPrototype(a.me,o,"options.me must be a PersonModel"),e.requiredOfPrototype(a.countries,s,"options.countries must be a CountryCollection"),e.requiredOfPrototype(a.personAddresses,r,"options.personAddresses must be an AddressCollection"),e.requiredOfPrototype(a.addressFactory,i,"options.addressFactory must be an AddressFactory"),this.billingAddressHelper=a.billingAddressHelper,this.me=a.me,this.company=a.company,this.countries=a.countries,this.personAddresses=a.personAddresses,this.companyAddresses=a.companyAddresses,this.addressFactory=a.addressFactory,this._parent(a),this.address=this.billingAddressHelper.createBillingAddress(),this.addressForm=this._createAddressForm(),this.addressList=this._createAddressList(),this.state=this._getStateFromAddresses(),this.company&&this.listenTo(this.company,"onChange:"+n.Fields.COUNTRY,this._onBuyerCountryChange.bind(this))},render:function(){return this.body=[],this.state===l.CREATION?this.body.push(this.addressForm.render()):this.body.push(this.addressList.render()),this._parent(),this},getBillingAddressModel(){return this.address},validate:function(){return this.state===l.CREATION?this.addressForm.validate():!!this.addressList.getSelectedAddress()},save:function(){if(this.state===l.CREATION){const e=this.billingAddressHelper.isCompanyBuyer();return this.address.setParentResourceId(e?this.company.get("id"):this.me.get("id")),this.addressForm.savePromise().then(t=>(e?this.companyAddresses.add(t):this.personAddresses.add(t),t))}return Promise.resolve(this.addressList.getSelectedAddress())},destroy:function(){this.stopListening(),this.addressForm.destroy(),this.addressList.destroy(),this.countries=null,this.billingAddressHelper=null,this.personAddresses=null,this.companyAddresses=null,this.addressFactory=null,this._parent(),this.container=null},_onBuyerCountryChange:function(){const e=this.billingAddressHelper.isCompanyBuyer()?this.company.getCountry():this.me.getCountry();this.addressForm.countrySelectComponent.setReadOnly(!1),this.addressForm.countrySelectComponent.setValue(e),this.addressForm.countrySelectComponent.setReadOnly(!0),this.state=this._getStateFromAddresses(),this.render()},_switchToAddressForm:function(){this.state=l.CREATION,this.render()},_getStateFromAddresses:function(){return this.billingAddressHelper.getValidBillingAdresses({forceBuyerTypeFiltering:!0}).length>0?l.SELECTION:l.CREATION},_createAddressForm:function(){return new a({addressModel:this.address,addressConstraints:this.addressFactory.addressesConstraints,countryReadOnly:this.billingAddressHelper.isCompanyBuyer(),countries:this.countries,horizontalLayout:!0})},_createAddressList:function(){const e=new c({billingAddressHelper:this.billingAddressHelper,me:this.me,company:this.company,countries:this.countries});return this.listenTo(e,c.Events.ADD_ADDRESS,this._switchToAddressForm.bind(this)),e}});return h.States=l,h}),define("DS/MPFModalConfiguratorComponent/BillingInformationFormSectionV2",["DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFModalConfiguratorComponent/CompanyInformationSection","DS/MPFPersonComponent/PersonNameForm","DS/MPFBuyer/BuyerType","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFBuyerAddressComponent/BuyerTypeSelectorInput","DS/MPFCartModel/CartModel","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFCountryModel/CountryCollection","DS/MPFAddressModel/AddressCollection"],function(e,t,s,r,i,n,o,a,c,d,l,h,p){"use strict";const u=Object.freeze({ON_TYPE_CHANGE:"onTypeChange"}),m=s.extend({setup(s={}){e.requiredOfPrototype(s.cart,c,"options.cart must be a CartModel"),e.requiredOfPrototype(s.person,l,"options.person must be a PersonModel"),e.requiredOfPrototype(s.billingAddressHelper,o,"options.billingAddressHelper must be a BillingAddressHelper"),e.requiredOfPrototype(s.countries,h,"options.countries must be a CountryCollection"),this.cart=s.cart,this.person=s.person,this.countries=s.countries,this.billingAddressHelper=s.billingAddressHelper,this.service=s.service||t.MAKE;const r=this.billingAddressHelper.isBuyerTypeEditable();(this.billingAddressHelper.isCompanyBuyer()||r)&&(e.requiredOfPrototype(s.company,d,"options.company must be a CompanyModel"),e.requiredOfPrototype(s.companyAddresses,p,"options.companyAddresses must be an AddressCollection"),this.company=s.company,this.companyAddresses=s.companyAddresses),this._parent(s);const i=this.service===t.CLICK_AND_BUY&&this.cart.hasEduItems(),n=this.service===t.CLICK_AND_BUY&&this.cart.hasMakerItems();(r||i||n)&&(this.buyerTypeInput=this._createBuyerTypeSelector({isBuyerTypeEditable:r})),this.buyerForm=this._createBuyerForm()},render(){return this.body=[],this.buyerTypeInput&&this.body.push(this.buyerTypeInput.render()),this.body.push(this.buyerForm.render()),this._parent(),this},validate(){return this.buyerForm.validate()},save(){if(this.billingAddressHelper.isCompanyBuyer())return this.buyerForm.save()},_onBuyerTypeChange(e){let t;"company"===e?(this.company.isNew()&&(this.company.unset(d.Fields.COUNTRY),this.company.unset(d.Fields.TAX_REGISTRATION_ID)),t=n.COMPANY):t=n.INDIVIDUAL,this.billingAddressHelper.setBuyerType(t),this.buyerForm.destroy(),this.buyerForm=this._createBuyerForm(),this.dispatchEvent(u.ON_TYPE_CHANGE,{buyerType:t,company:this.company})},_createBuyerTypeSelector({isBuyerTypeEditable:e}){const t=new a({model:this.billingAddressHelper.isCompanyBuyer()?this.company:this.person,readOnly:!e});return this.listenTo(t,a.Events.ON_CHANGE,this._onBuyerTypeChange.bind(this)),t},_createBuyerForm(){return this.billingAddressHelper.isCompanyBuyer()?this._createCompanyForm():this._createPersonForm()},_createCompanyForm(){return new r({model:this.company,countryCollection:this.countries,addresses:this.companyAddresses})},_createPersonForm(){return new i({model:this.person,readOnly:!0,required:!0,horizontalLayout:!0})}});return m.Events=u,m}),define("DS/MPFModalConfiguratorComponent/BillingInformationPage",["UWA/Core","UWA/Class/View","UWA/Promise","UWA/Utils","DS/MPFBuyer/BuyerType","DS/MPFModalConfiguratorComponent/BillingInformationFormSectionV2","DS/MPFModalConfiguratorComponent/BillingAddressFormSectionV2","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFPersonModel/PersonModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/ValidationError","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFTracker/Category","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y,g,P,S,E,M,A,_,f){"use strict";const D=Object.freeze({INDIVIDUAL_VIEW:"individualView",COMPANY_VIEW:"companyView"}),T=Object.freeze({VALID:"valid",INVALID_PAGE:"invalidPage",PAGE_SAVED:"pageSaved"}),O=t.extend({className:"mpf-billing-info-page",setup(e={}){this._checkPrototypes(e),this.billingAddressHelper=e.billingAddressHelper,this.me=e.me,this.cart=e.cart,this.company=e.company,this.personAddresses=e.personAddresses,this.companyAddresses=e.companyAddresses,this.addressFactory=e.addressFactory,this.countries=e.countries,this.service=e.service,this.cartPsp=e.cartPsp,this.companyFactory=e.companyFactory,this.billingInfoSection=this._createBillingInfoSection(),this.billingAddressSection=this._createBillingAddressSection(),this._sendTrackingPage()},render(){return this.container.setContent([this._displayInfoMsgForJapaneseUsers(),this.billingInfoSection.render(),this.billingAddressSection.render(),this._requiredFieldsLabel()]),this.dispatchEvent(T.VALID),this},save(){const e=this.billingInfoSection.validate(),t=this.billingAddressSection.validate();return this._sendTrackerEvent("Billing.SaveClicked"),e&&t?s.resolve().then(async()=>{this.billingAddressHelper.getBuyerType()===i.COMPANY&&(await this.billingInfoSection.save(),await this._deleteWrongBillingAddresses());const e=await this.billingAddressSection.save();this.dispatchEvent(T.PATCHING_CART);const{hasCountryChanged:t}=await this.billingAddressHelper.patchBillingAddress(e);return this.service===E.ENGINEERING&&await this.cartPhase.fetchPromise({forceDelegate:!0}),this._sendTrackerEvent("Billing.SaveSuccess"),this.dispatchEvent(T.PAGE_SAVED),{address:e,hasCountryChanged:t}}):(this.dispatchEvent(T.INVALID_PAGE),s.reject(new P(f.get("errorFieldsInfo"))))},destroy(){this.stopListening(),this.billingInfoSection.destroy(),this.billingAddressSection.destroy(),this.billingAddressHelper=null,this.me=null,this.cart=null,this.company=null,this.personAddresses=null,this.companyAddresses=null,this.addressFactory=null,this.countries=null,this.service=null,this.cartPsp=null,this.companyFactory=null,this._parent(),this.container=null},_sendTrackerEvent(e){const t=M.createEventBuilder({category:_.CHECKOUT,action:e});C.addTrackerInformation(t,this.cart),t.addDimension(A.MARKETPLACE_SERVICE,this.service).send()},_deleteWrongBillingAddresses(){return Promise.all(this.companyAddresses.filter(e=>e.isBillTo()&&e.getCountry()!==this.company.getCountry()).map(e=>{const t={[l.Fields.COUNTRY]:e.getCountry(),[l.Fields.IS_BILL_TO]:"FALSE"};return e.savePromise(t,{method:"PUT"})}))},_createBillingInfoSection(){const e=new n({title:f.get("billInfo"),cart:this.cart,person:this.me,company:this.company,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,countries:this.countries,billingAddressHelper:this.billingAddressHelper,service:this.service,companyFactory:this.companyFactory});return this.listenTo(e,n.Events.ON_TYPE_CHANGE,this._adaptAddressFormToBuyerType.bind(this)),e},_createBillingAddressSection(){return new o({title:f.get("billAddress"),me:this.me,company:this.company,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,addressFactory:this.addressFactory,billingAddressHelper:this.billingAddressHelper,countries:this.countries})},_adaptAddressFormToBuyerType(e){this.billingAddressHelper.getBuyerType()===i.COMPANY&&(this.company=e.company),this.billingAddressSection=this._createBillingAddressSection(),this.render()},_requiredFieldsLabel:()=>e.createElement("div",{class:"mpf-required-fields",html:[e.createElement("em",{class:"mpf-required",html:"*"}),e.createElement("span",{text:f.get("requiredFields")})]}),_createStateMachine:e=>new g({state:e,states:[D.INDIVIDUAL_VIEW,D.COMPANY_VIEW],transitions:[{from:D.INDIVIDUAL_VIEW,to:D.COMPANY_VIEW},{from:D.COMPANY_VIEW,to:D.INDIVIDUAL_VIEW}]}),_displayInfoMsgForJapaneseUsers:function(){const t=r.Client.Locale.lang,s=this._getCurrentLanguageFromCookie(),i="ja"===t||e.is(s)&&"ja"===s.value,n="individual"===this.billingAddressHelper.getBuyerType().name;if(i&&n)return e.createElement("div",{class:"alert-message alert-warning alert-has-icon",html:[e.createElement("span",{class:"icon fonticon"}),e.createElement("span",{text:""})]})},_getCurrentLanguageFromCookie:function(){return document.cookie.split(/\s*;\s*/).map(function(e){const t=e.split("=");return{key:t.length>=1?t[0]:null,value:t.length>=2?t[1]:null}}).find(function(e){return e.key===encodeURIComponent("swymlang")})},_sendTrackingPage(){const e=M.createPageBuilder({url:"/checkout/AddressCreation"});C.addTrackerInformation(e,this.cart),e.addDimension(A.MARKETPLACE_SERVICE,this.service).send()},_checkPrototypes(t){S.requiredOfPrototype(t.countries,c,"options.countries must be a CountryCollection"),S.requiredOfPrototype(t.me,d,"options.me must be a PersonModel"),S.requiredOfPrototype(t.personAddresses,h,"options.personAddresses must be an AddressCollection"),S.requiredOfPrototype(t.addressFactory,p,"options.addressFactory must be an AddressFactory"),S.requiredOfPrototype(t.cart,m,"options.cart must be a CartModel"),S.requiredOfPrototype(t.companyFactory,u,"options.companyFactory must be a CompanyFactory"),e.equals(i.COMPANY,t.billingAddressHelper.getBuyerType())&&(S.requiredOfPrototype(t.company,a,"options.company must be a CompanyModel"),S.requiredOfPrototype(t.companyAddresses,h,"options.companyAddresses must be a AddressCollection")),t.service===E.ENGINEERING&&(S.requiredOfPrototype(t.cartPhase,y,"options.cartPhase must be a CartPhaseModel"),this.cartPhase=t.cartPhase)}});return O.Events=T,O}),define("DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/UIKIT/Scroller","DS/MPFServices/MarketplaceServices","DS/MPFView/ManuallyClosedModal","DS/MPFOrderComponent/OrderConfirmationPage","DS/MPFOrderComponent/OrderConfirmationHelper","DS/MPFModalConfiguratorComponent/ConfirmMakeBankTransferPage","DS/MPFModalConfiguratorComponent/IfweloopBankTransferPage","DS/MPFModalConfiguratorComponent/BillingInformationPage","DS/MPFModalConfiguratorComponent/CBTokenPaymentConfirmationPage","DS/MPFModalConfiguratorComponent/ThanksPurchasingPage","DS/MPFClickAndBuyComponent/checkout/BillingInfoPage","DS/MPFClickAndBuyComponent/checkout/CompanyListPage","DS/MPFModalConfiguratorComponent/CreditCardPaymentPage","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartModelHelper","DS/MPFCartModel/CartItemFactory","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFTCContractModel/SoftwareAgreementModel","DS/MPFTCContractModel/TCContractFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenCollection","DS/MPFVirtualIbanModel/VirtualIbanFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFCountryModel/CountryCollection","DS/MPFShopModel/ShopModel","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPurchaseOrderModel/PurchaseOrderModel","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentModel","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFError/ValidationError","DS/WebappsUtils/WebappsUtils","DS/MPFTracker/Tracker","DS/MPFTracker/Dimension","DS/MPFModalConfiguratorComponent/CheckoutHandlerFunctions","i18n!DS/MPFModalConfiguratorComponent/assets/nls/ModalConfiguratorComponent","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y,g,P,S,E,M,A,_,f,D,T,O,F,I,v,b,N,k,R,L,B,U,w,x,V,H,Y,K,q,W,G,j){"use strict";const z={},Q={},X={};Q.PAYMENT_COMPLETED="paymentCompleted",Q.PAYMENT_DECLINED="paymentDeclined",Q.PURCHASE_ORDER_UPLOADED="purchaseOrderUploaded",Q.UPLOAD_PO_LATER="uploadPoLater",Q.MODAL_CLOSED="modalClosed",Q.NEXT_PAGE_OPERATIONS_DONE="nextPageOperationDone",X.USE_PAYMENT_CARD_TOKEN="UsePaymentCardToken",X.USE_BANK_TRANSFER="UseBankTransfer",X.USE_PAYMENT_CARD="UsePaymentCard",X.PAYMENT_COMPLETED="PaymentCompleted",X.PAYMENT_DECLINED="PaymentDeclined",X.CLOSE_CHECKOUT="CloseCheckout",X.QUOTE_DOWNLOADED="QuoteDownloaded",X.PAYMENT_INITIATED="PaymentInitiated",z.PAGE_DISPLAYED="pageDisplayed",z.IFRAME_DISPLAYED="iframeDisplayed",z.SAVING_PAGE="savingPage";const $=s.extend({setup:function(t={}){this._checkPrototypes(t),this._parent(t),this.service=e.is(t.service)?t.service:a.MAKE,this.me=t.me,this.billingAddressHelper=t.billingAddressHelper,this.cart=t.cart,this.cartQuote=t.cartQuote,this.cartItemFactory=t.cartItemFactory,this.company=t.company,this.companySearch=t.companySearch,this.companyFactory=t.companyFactory,this.addresses=t.addresses,this.personAddresses=t.personAddresses,this.companyAddresses=t.companyAddresses,this.addressFactory=t.addressFactory,this.countries=t.countries,this.tcContractFactory=t.tcContractFactory,this.cardTokens=t.cardTokens,this.virtualIbanFactory=t.virtualIbanFactory,this.paymentCardTokenFactory=t.paymentCardTokenFactory,this.purchaseOrder=t.purchaseOrder,this.purchaseOrderDocument=t.purchaseOrderDocument,this.periodicitiesAlreadyPurchased=t.periodicitiesAlreadyPurchased,this.cartPsp=t.cartPsp,this.waitForPaymentModel=t.waitForPaymentModel,this.locale=t.locale||"fr-FR",this.linkToBankTransferFAQ=t.linkToBankTransferFAQ,this.bankTransferActive=!e.is(t.bankTransferActive)||t.bankTransferActive,this.hasDedicatedPoUploadEvent=!0===t.hasDedicatedPoUploadEvent,this.hasCountryChanged=t.hasCountryChanged,this.alert=this._createAlert(),this.isPaymentInProgress=!1,this.stateMachine=this._createStateMachine(),this._sendTrackingPage()},render:function(e){return this._initPages(),this._createModal(),this.modal.inject(e),this.displayNextPage(),this},_initPages:function(){return this.pages=[],this.titlePages=[],this.labelNextButton=[],this.idxPages={},this.currentPage=-1,this.closingEvent=null,this.service===a.IFWELOOP||this.cart.isIfweloopOrder()||this.cart.isRenewal()||this.service===a.INNOVATE&&this.cart.isInnovateBusinessExperienceOrder(this.service)||this.billingAddressHelper.isBillingInfoComplete()?this._initCheckoutPage():this._initBillingInfoPage()},_paymentByToken(e){const t=new m({service:this.service,me:this.me,cart:this.cart,locale:this.locale,cartPsp:this.cartPsp,waitForPaymentModel:this.waitForPaymentModel,token:e});this._unmask(),this.pages.push(t),this.titlePages.push(j.get("checkoutTitle2")),this.labelNextButton.push(j.get("paymentButton")),this.idxPages.checkoutPage2=this.pages.length-1,this._sendTrackingEvent(X.PAYMENT_INITIATED,{token:e,paymentType:X.USE_PAYMENT_CARD_TOKEN})},_initCreditCardPaymentPage(){const e=new P({me:this.me,cart:this.cart,cartPsp:this.cartPsp,waitForPaymentModel:this.waitForPaymentModel,service:this.service,locale:this.locale});return this.listenTo(e,P.Events.PAYMENT_SUCCESS,()=>{this.closingEvent=Q.PAYMENT_COMPLETED,this.isPaymentInProgress=!1,this.cancelButton.enable(),this._sendTrackingEvent(X.PAYMENT_COMPLETED),this.service===a.MAKE?this._closeModal():(this._getNextPage({paymentOK:!0}),this.displayNextPage(),this.dispatchEvent(Q.NEXT_PAGE_OPERATIONS_DONE))}),this.listenTo(e,P.Events.PAYMENT_FAILURE,()=>{this.closingEvent=Q.PAYMENT_DECLINED,this.isPaymentInProgress=!1,this.cancelButton.enable(),this._sendTrackingEvent(X.PAYMENT_DECLINED),this.service===a.MAKE?this._closeModal():(this._getNextPage({paymentOK:!1}),this.displayNextPage(),this.dispatchEvent(Q.NEXT_PAGE_OPERATIONS_DONE))}),this.listenTo(e,P.Events.PAYMENT_IN_PROGRESS,()=>{this.isPaymentInProgress=!0,this.cancelButton.disable()}),this.listenTo(e,P.Events.VALIDATION_ERROR,()=>{this.isPaymentInProgress=!1,this.cancelButton.enable()}),this.pages.push(e),this.idxPages.checkoutPage2=this.pages.length-1,this.titlePages.push(j.get("checkoutTitle2")),this.nextButton.hide(),this._sendTrackingEvent(X.PAYMENT_INITIATED,{paymentType:X.USE_PAYMENT_CARD}),e},_goToUpiPage(){window.location.assign(this.cart.getPaymentUrl())},_createFooterForCompany(){const t=e.createElement("a",{text:"www.3ds.com/store/get-started",href:"https://www.3ds.com/store/get-started?utm_content=3ds&utm_term=companygspage&utm_source=ordconfpage",target:"_blank"}).outerHTML;return e.createElement("div",{class:"mpf-visit-get-started",html:j.get("visitGetStarted",{getStarted:t})})},_resizeModalAfterPayment(e="490px"){this.modal.elements.content.setStyle("height",e);const t=this.service===a.CLICK_AND_BUY,s=this.service===a.SUBSCRIPTIONS,r=this.service===a.INNOVATE,i=this.billingAddressHelper.isCompanyBuyer();(t||s||r)&&i?this.modal.setFooter(this._createFooterForCompany()):(this.cancelButton.setValue(j.get("close")),this.cancelButton.show())},displayNextPage:function(){const t=this.stateMachine.getState();this.currentPage+1<this.pages.length&&(this.currentPage+=1,this.nextButton.load(!1),this._initButtonListeners(this.pages[this.currentPage]),this.modal.setHeader({tag:"h4",text:this.titlePages[this.currentPage]}),this.nextButton.setValue(this.labelNextButton[this.currentPage]),e.is(this.pages[this.currentPage].isValid)&&this.pages[this.currentPage].isValid()?this.nextButton.enable():this.nextButton.disable(),t===z.IFRAME_DISPLAYED?(this._unmask(),this.modal.setBody([this.alert,this.pages[this.currentPage]]),this.nextButton.hide(),this.cancelButton.hide(),this.modal.elements.wrapper.setStyle("height","unset"),this.modal.elements.content.setStyle("max-height","unset")):t===z.PAGE_DISPLAYED&&(this._unmask(),this.modal.setBody([this.alert,e.createElement("div",{class:"mpf-scroll",html:[this.pages[this.currentPage].render()]})]),this.scroller=new o({element:this.modal.getBody().getElement(".mpf-scroll")}),this.scroller.inject(this.modal.getBody()),this.pages[this.currentPage].scroller=this.scroller))},doBankTransfer(e){let t;this.service===a.IFWELOOP||this.service===a.CLICK_AND_BUY||this.service===a.SUBSCRIPTIONS||this.service===a.INNOVATE?(t=new p({service:this.service,model:this.purchaseOrder,cart:this.cart,cartPsp:this.cartPsp,purchaseOrderDocument:this.purchaseOrderDocument,virtualIbans:e}),this.labelNextButton.push(j.get("save"))):(t=new h({service:this.service,model:this.purchaseOrder,cart:this.cart,purchaseOrderDocument:this.purchaseOrderDocument,linkToBankTransferFAQ:this.linkToBankTransferFAQ}),this.nextButton.hide(),this.listenTo(t,h.Events.UPLOAD_LATER,()=>{this.closingEvent=Q.UPLOAD_PO_LATER,this._sendTrackingEvent(X.PAYMENT_COMPLETED),this._closeModal()}),this.listenTo(t,h.Events.SHOW_SAVE_BUTTON,()=>{this.nextButton.setValue(j.get("save")),this.nextButton.enable(),this.nextButton.show()})),this._sendTrackingEvent(X.PAYMENT_INITIATED,{paymentType:X.USE_BANK_TRANSFER}),this.pages.push(t),this.titlePages.push(j.get("checkoutTitle2")),this.idxPages.checkoutPage2=this.pages.length-1},_initThanksPurchasingPage(e){const t=this.service===a.CLICK_AND_BUY&&(this.cart.hasEduItems()||this.cart.hasMakerItems()),s=new C({service:this.service,paymentOK:!0===e.paymentOK,firstNameUser:this.me.getFirstName(),isClicknbuyEduOrMakers:t,billingAddressHelper:this.billingAddressHelper});this.pages.push(s),this.titlePages.push(j.get("purchaseComplete")),this.idxPages.thanksPage=this.pages.length-1,this.nextButton.hide();const r=t?"580px":void 0;this._resizeModalAfterPayment(r)},_initButtonListeners:function(e){this.listenTo(e,"valid",this.nextButton.enable.bind(this.nextButton)),this.listenTo(e,"invalid",this.nextButton.disable.bind(this.nextButton))},_initBillingInfoPage:function(){const e=this;let t;const s=this.service===a.CLICK_AND_BUY;!s&&this.service!==a.SUBSCRIPTIONS||this.cart.hasEduItems()||this.cart.hasMakerItems()?(t=new u({me:this.me,company:this.company,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,cart:this.cart,billingAddressHelper:this.billingAddressHelper,addressFactory:this.addressFactory,countries:this.countries,service:this.service,companyFactory:this.companyFactory,cartPsp:this.cartPsp}),this.labelNextButton.push(j.get("saveBillInfo"))):(t=new y({billingAddressHelper:this.billingAddressHelper,service:this.service,me:this.me,company:s&&this.companySearch?this.companySearch:this.company,cart:this.cart,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,countries:this.countries,companyFactory:this.companyFactory,addressFactory:this.addressFactory}),this.labelNextButton.push(j.get("next"))),this.pages.push(t),this.titlePages.push(j.get("billingInformationTitle")),this.idxPages.billingInformationPage=this.pages.length-1,this.listenTo(this.pages[this.idxPages.billingInformationPage],u.Events.INVALID_PAGE,function(){e._unmask()})},_initMatchingCompaniesPage:function(){const e=this.companyFactory.createCollection(R.Types.MATCHING_COMPANIES,this.companySearch.getMatchingCompanies(),{parse:!0,addressFactory:this.addressFactory}),t=new g({cart:this.cart,cartPsp:this.cartPsp,company:this.company,companySearch:this.companySearch,address:this.pages[this.idxPages.billingInformationPage].getBillingAddressModel(),companyAddresses:this.companyAddresses,matchingCompanies:e,companyFactory:this.companyFactory,addressFactory:this.addressFactory,countries:this.countries,cardTokens:this.cardTokens,billingAddressHelper:this.billingAddressHelper});this.pages.push(t),this.titlePages.push(j.get("billingInformationTitle")),this.labelNextButton.push(j.get("next")),this.idxPages.matchingCompaniesPage=this.pages.length-1},_initCheckoutPage:function({hasCountryChanged:e}={}){"boolean"==typeof e&&(this.hasCountryChanged=e);const t=new d({service:this.service,me:this.me,company:this.company,billingAddressHelper:this.billingAddressHelper,cart:this.cart,cartQuote:this.cartQuote,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,addressFactory:this.addressFactory,cartItemFactory:this.cartItemFactory,softwareAgreement:this.softwareAgreement,onlineServiceAgreement:this.onlineServiceAgreement,tcContractFactory:this.tcContractFactory,cardTokens:this.cardTokens,virtualIbanFactory:this.virtualIbanFactory,shop:this.shop,tcDocumentFactory:this.tcDocumentFactory,bankTransferActive:this.bankTransferActive,countries:this.countries,periodicitiesAlreadyPurchased:this.periodicitiesAlreadyPurchased,cartPsp:this.cartPsp,locale:this.locale,hasCountryChanged:this.hasCountryChanged});this.pages.push(t),this.titlePages.push(j.get("checkoutTitle1")),this.labelNextButton.push(j.get("paymentButton")),this.idxPages.checkoutPage1=this.pages.length-1,this._initCheckoutPageListeners()},_initCheckoutPageListeners(){const e=this.pages[this.idxPages.checkoutPage1];this.listenTo(e,d.Events.QUOTE_DOWNLOADED,this._sendTrackingEvent.bind(this,X.QUOTE_DOWNLOADED)),this.listenTo(e,d.Events.STATE_CHANGE,t=>{t===d.States.NEW_ADDRESS_FORM?this.nextButton.hide():t===d.States.LOADING?this.nextButton.disable():(this.nextButton.show(),e.isValid()?this.nextButton.enable():this.nextButton.disable())})},_createModal:function(){this.modal=new c({className:"mpf-configurator-offer",visible:!0,closable:!0,footer:this._initFooterModal(),events:{[c.Events.ON_CLOSE]:this._closeModal.bind(this)}})},_closeModal(){return this.isPaymentInProgress?(setTimeout(this._closeModal.bind(this),200),Promise.resolve()):(this._mask(),([Q.PAYMENT_COMPLETED,Q.PURCHASE_ORDER_UPLOADED,Q.UPLOAD_PO_LATER].includes(this.closingEvent)?t.resolve():this._resetCartState()).then(()=>{this._unmask(),this._destroyModal(),this._sendTrackingEvent("close"),this._dispatchClosingEvent()}).catch(e=>{console.error(e),this._unmask(),this._displayAlertMessage("error",j.get("errorTryLater"))}))},_resetCartState(){const e={};let s,r=!1;const i=this.service===a.CLICK_AND_BUY,n=this.service===a.SUBSCRIPTIONS&&this.cart.isSelfOrder(),o=this.service===a.INNOVATE;return n||i&&!this.cart.isRenewal()||this.cart.isDirectPurchase()||o?s=M.States.DRAFT:(s=M.States.SUBMITTED,r=!0),this.cart.get(M.Fields.PURCHASE_ORDER_NUMBER)&&(e[M.Fields.PURCHASE_ORDER_NUMBER]=""),this.cart.get(M.Fields.EXPENSE_FINANCIAL_LINE)&&(e[M.Fields.EXPENSE_FINANCIAL_LINE]=""),s&&this.cart.getState()!==s&&(e[M.Fields.STATE]=s),(r?this.cart.fetchPromise({expand:[M.Expands.CART_ITEMS]}):t.resolve()).then(()=>Object.keys(e).length>0?this.cart.savePromise(e,{patch:!0}):t.resolve())},_destroyModal:function(){window.removeEventListener("message",this._onIframeMessageBinded),this.stopListening(),this.modal.hide().destroy(),this.modal=null},_dispatchClosingEvent(){this.closingEvent?this.dispatchEvent(this.closingEvent,{cart:this.cart}):this.dispatchEvent(Q.MODAL_CLOSED),this._sendTrackingEvent(X.CLOSE_CHECKOUT)},_initFooterModal:function(){return this.nextButton=new r({value:this.labelNextButton[this.currentPage],className:"primary",disabled:!0,events:{onClick:this._nextButtonHandler.bind(this)}}),this.cancelButton=new r({value:j.get("cancel"),events:{onClick:this._cancelButtonHandler.bind(this)}}),[this.nextButton,this.cancelButton]},_cancelButtonHandler:function(){const e=this.pages[this.idxPages.checkoutPage1];this.currentPage===this.idxPages.checkoutPage1&&e.state===d.States.NEW_ADDRESS_FORM?e.changeState(d.States.PAGE_DISPLAYED):this._closeModal()},_nextButtonHandler:function(){const t=this.currentPage===this.idxPages.checkoutPage2?j.get("paymentInProgress"):null;return this.nextButton.load(),this._mask(t),this.stateMachine.changeState(z.SAVING_PAGE),this.pages[this.currentPage].save().then(this._getNextPage.bind(this)).then(this.displayNextPage.bind(this)).catch(t=>{if(console.error(t),this.nextButton.load(!1),this._unmask(),!(t instanceof Y)){let s;const r="string"==typeof t?t:"";s=t&&e.is(t.errorCode)&&"Error.JapanesNotSupported"===t.errorCode?"":t&&Object.prototype.isPrototypeOf.call(Error.prototype,t)&&t.message?t.message:e.is(j["error"+r])?j.get("error"+r):j.get("error"),this._displayAlertMessage("error",s)}}).finally(()=>{this.dispatchEvent(Q.NEXT_PAGE_OPERATIONS_DONE)})},_getNextPage:function(e={}){const t=this.idxPages.matchingCompaniesPage,s=this.idxPages.billingInformationPage,r=this.idxPages.checkoutPage1,i=this.idxPages.checkoutPage2;if(this.currentPage!==s||this.service!==a.CLICK_AND_BUY||this.cart.hasEduItems()||this.cart.hasMakerItems())if(this.currentPage===s||this.currentPage===t){const{hasCountryChanged:t}=e;this._initCheckoutPage({hasCountryChanged:t})}else if(this.currentPage===r){const{paymentPage:t,ibans:s,ccToken:r,wasPaymentSuccessful:i}=e;t===l.PaymentPages.NONE?(this.closingEvent=i?Q.PAYMENT_COMPLETED:Q.PAYMENT_DECLINED,this.service===a.MAKE?this._closeModal():this._initThanksPurchasingPage({paymentOK:i})):t===l.PaymentPages.BANK_TRANSFER?this.doBankTransfer(s):t===l.PaymentPages.CC_TOKEN?this._paymentByToken(r):t===l.PaymentPages.CC_PAYMENT?this._initCreditCardPaymentPage():t===l.PaymentPages.UNIFIED_PAYMENTS_INTERFACE&&this._goToUpiPage()}else this.currentPage===i&&(this._sendTrackingEvent(e.paymentOK?X.PAYMENT_COMPLETED:X.PAYMENT_DECLINED),this.closingEvent=e.paymentOK?e.isBankTransferPayment?this._getPoClosingEvent():Q.PAYMENT_COMPLETED:Q.PAYMENT_DECLINED,this.service===a.MAKE?this._closeModal():this._initThanksPurchasingPage({paymentOK:e.paymentOK}));else this._initMatchingCompaniesPage();this.stateMachine.changeState(z.PAGE_DISPLAYED)},_getPoClosingEvent(){return this.hasDedicatedPoUploadEvent?Q.PURCHASE_ORDER_UPLOADED:Q.PAYMENT_COMPLETED},_createAlert:function(){return new n({messsageClassName:"error",icon:!0,closable:!0,visible:!0,hideDelay:5e3,maximumVisibleMessages:1,autoHide:!0})},_displayAlertMessage:function(e,t){const s=this,r=this.alert.getMessages();r.length>0&&r.forEach(function(e){s.alert.remove(e)}),this.alert.add({className:e,message:t})},_mask(e){i.mask(this.modal.getBody(),e)},_unmask(){i.unmask(this.modal.getBody())},_isCartPaymentUrlAvailable:function(){return!!this.cart.getPaymentUrl()&&(this.cart.getState()===M.STATUS.paymentInitiated||this.cart.getState()===M.STATUS.paymentRefused)},_createStateMachine:function(){const e=this._isCartPaymentUrlAvailable()?z.IFRAME_DISPLAYED:z.PAGE_DISPLAYED;return new H({state:e,states:[z.PAGE_DISPLAYED,z.IFRAME_DISPLAYED,z.SAVING_PAGE],transitions:[{from:z.PAGE_DISPLAYED,to:z.SAVING_PAGE},{from:z.SAVING_PAGE,to:z.PAGE_DISPLAYED},{from:z.SAVING_PAGE,to:z.IFRAME_DISPLAYED},{from:z.IFRAME_DISPLAYED,to:z.SAVING_PAGE}]})},_sendTrackingPage:function(){const e=q.createPageBuilder({url:"/checkout"}).setTitle("Checkout V1");this._setupTrackerParameters(e),e.send()},_sendTrackingEvent:function(e,t){const s=q.createEventBuilder({category:"Checkout",action:e});this._setupTrackerParameters(s,t),s.send()},_setupTrackerParameters:function(e,t={}){A.addTrackerInformation(e,this.cart),e.addDimension(W.MARKETPLACE_SERVICE,this.service).addDimension(W.BUYER_ID,this.me.id).addDimension(W.BUYER_TYPE,this.billingAddressHelper.getBuyerType().name).addDimension(W.PSP,this.cartPsp.getPsp()).addDimension(W.PAYMENT_CARD_TOKEN,t.token).addDimension(W.PAYMENT_METHOD,t.paymentType)},_checkPrototypes:function(e){V.requiredOfPrototype(e.billingAddressHelper,S,"options.billingAddressHelper must be a BilllingAddressHelper"),V.requiredOfPrototype(e.me,E,"options.me must be a PersonModel"),V.requiredOfPrototype(e.cart,M,"options.cart must be a CartModel"),V.requiredOfPrototype(e.cartQuote,B,"options.cartQuote must be a CartQuoteModel"),V.requiredOfPrototype(e.cartItemFactory,_,"options.cartItemFactory must be a CartItemFactory"),V.requiredOfPrototype(e.personAddresses,f,"options.personAddresses must be a AddressCollection"),V.requiredOfPrototype(e.addressFactory,D,"options.addressFactory must be an AddressFactory"),V.requiredOfPrototype(e.tcContractFactory,O,"options.tcContractFactory must be a TCContractFactory"),V.requiredOfPrototype(e.cardTokens,F,"options.cardTokens must be a PaymentCardTokenCollection"),V.requiredOfPrototype(e.paymentCardTokenFactory,L,"options.paymentCardTokenFactory must be a PaymentCardTokenFactory"),V.requiredOfPrototype(e.virtualIbanFactory,I,"options.virtualIbanFactory must be a VirtualIbanFactory"),V.requiredOfPrototype(e.countries,b,"options.countries must be a CountryCollection"),V.requiredOfPrototype(e.purchaseOrder,U,"options.purchaseOrder must be a PurchaseOrderModel"),V.requiredOfPrototype(e.purchaseOrderDocument,w,"options.purchaseOrderDocument must be a PurchaseOrderDocumentModel"),V.requiredOfPrototype(e.cartPsp,x,"options.cartPsp must be a PspModel"),V.requiredOfPrototype(e.companyFactory,R,"options.companyFactory must be a CompanyFactory"),e.service===a.IFWELOOP||e.service===a.SUBSCRIPTIONS?(V.requiredOfPrototype(e.softwareAgreement,T,"options.softwareAgreement must be a SoftwareAgreementModel"),this.softwareAgreement=e.softwareAgreement):e.service===a.CLICK_AND_BUY?(V.requiredOfPrototype(e.softwareAgreement,T,"options.softwareAgreement must be a SoftwareAgreementModel"),V.requiredOfPrototype(e.tcDocumentFactory,k,"options.tcDocumentFactory must be a TCDocumentFactory"),this.softwareAgreement=e.softwareAgreement,this.tcDocumentFactory=e.tcDocumentFactory):e.service===a.INNOVATE?(V.requiredOfPrototype(e.shop,N,"options.shop must be a ShopModel"),V.requiredOfPrototype(e.tcDocumentFactory,k,"options.tcDocumentFactory must be a TCDocumentFactory"),V.requiredOfPrototype(e.softwareAgreement,T,"options.softwareAgreement must be a SoftwareAgreementModel"),this.shop=e.shop,this.tcDocumentFactory=e.tcDocumentFactory,this.softwareAgreement=e.softwareAgreement):(V.requiredOfPrototype(e.shop,N,"options.shop must be a ShopModel"),V.requiredOfPrototype(e.tcDocumentFactory,k,"options.tcDocumentFactory must be a TCDocumentFactory"),this.shop=e.shop,this.tcDocumentFactory=e.tcDocumentFactory),(e.billingAddressHelper.isCompanyBuyer()||e.billingAddressHelper.isBuyerTypeEditable())&&(V.requiredOfPrototype(e.company,v,"options.company must be a CompanyModel"),V.requiredOfPrototype(e.companyAddresses,f,"options.companyAddresses must be a AddressCollection"),e.service===a.CLICK_AND_BUY&&e.company.isNew()&&V.requiredOfPrototype(e.companySearch,v,"options.companySearch must be a CompanyModel"))}});return $.renderError=G.renderError,$.onLoad=G.onLoad,$.displayIbanPaymentRecap=G.displayIbanPaymentRecap,$.Events=Object.freeze(Q),$}),define("DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory",["UWA/Class","UWA/Utils","UWA/Class/Listener","UWA/Class/Events","DS/MPFDataProxy/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFError/ValidationError","DS/MPFModalConfiguratorComponent/ModalConfiguratorComponent","DS/MPFPersonModel/PersonFactory","DS/MPFCartModel/CartFactory","DS/MPFCartQuoteModel/CartQuoteFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFCountryModel/CountryFactory","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/MPFPspModel/PspFactory","DS/MPFShopModel/ShopFactory","DS/MPFAddressModel/AddressFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFShopModel/ShopModel","DS/MPFCountryModel/CountryModel","DS/MPFBuyer/BuyerType","DS/MPFTCContractModel/SoftwareAgreementFactory","DS/MPFCartPaymentModel/WaitForPaymentFactory","DS/MPFModalConfiguratorComponent/BillingAddressHelper"],function(e,t,s,r,i,n,o,a,c,d,l,h,p,u,m,C,y,g,P,S,E,M,A,_,f,D,T,O){"use strict";const F=Object.freeze({PAYMENT_COMPLETED:"paymentCompleted",PAYMENT_DECLINED:"paymentDeclined",PURCHASE_ORDER_UPLOADED:"purchaseOrderUploaded",UPLOAD_PO_LATER:"uploadPoLater",MODAL_CLOSED:"modalClosed"}),I=e.extend(s,r,{init(e={}){this.service=e.serviceRequest||n.MAKE,this.locale=e.locale||window.dsLang||t.Client.Locale.lang,this.container=e.container||document.body,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.cartId=e.idCart,this.hasDedicatedPoUploadEvent=e.hasDedicatedPoUploadEvent,this.isCloudLicensePurchase=this.service===n.IFWELOOP||this.service===n.CLICK_AND_BUY||this.service===n.SUBSCRIPTIONS},async whenReady(){this.modal&&(this.stopListening(),this.modal.destroy()),this.onLoadModal=c.onLoad(this.container);try{this.modal=await this._fetchDataInitModal()}catch(e){throw this.onLoadModal.destroy(),e&&"ValidationError"===e.name?new a(e.message,{errorCode:e.errorCode}):e&&e.response&&"error.renewallinkexpired"===e.response.errorCode?new a(e.response.errorMsg,{errorCode:e.response.errorCode}):(c.renderError(this.container),new Error(e))}this.onLoadModal.destroy(),this.listenTo(this.modal,c.Events.PAYMENT_COMPLETED,this.dispatchEvent.bind(this,F.PAYMENT_COMPLETED)),this.listenTo(this.modal,c.Events.PAYMENT_DECLINED,this.dispatchEvent.bind(this,F.PAYMENT_DECLINED)),this.listenTo(this.modal,c.Events.PURCHASE_ORDER_UPLOADED,this.dispatchEvent.bind(this,F.PURCHASE_ORDER_UPLOADED)),this.listenTo(this.modal,c.Events.UPLOAD_PO_LATER,this.dispatchEvent.bind(this,F.UPLOAD_PO_LATER)),this.listenTo(this.modal,c.Events.MODAL_CLOSED,this.dispatchEvent.bind(this,F.MODAL_CLOSED))},show(){this.modal.render(this.container)},async _initModelOrCollection(e,t,s,r,i,n,o){const a=await this.factoryDispenser.getFactory(t),c=e?a.createModel(s,i,n):a.createCollection(s,i,n);return r?c.fetchPromise(o):c},async _initModel(e,t,s,r,i,n){return this._initModelOrCollection(!0,e,t,s,r,i,n)},async _initCollection(e,t,s,r,i,n){return this._initModelOrCollection(!1,e,t,s,r,i,n)},async _fetchDataInitModal(){const e=await i.fetchPromise({service:this.service});this.factoryDispenser=o.getInstance(e);const[{me:t,cart:s,shop:r,company:n,companySearch:a,companyAddresses:d,isBuyerTypeEditable:l},p,u,g,E,M,A,_,D,F,I,v,b,N,k,R]=await Promise.all([this._fetchMeCartShopCompanyWithAddresses(),this._initModel(o.Types.PSP,y.Types.CART_PSP,!0,null,{parentResourceId:this.cartId}),this._initModel(o.Types.CART_QUOTE,h.Types.CART_QUOTE,!1,null,{parentResourceId:this.cartId}),this._initModel(o.Types.PURCHASE_ORDER,m.Types.CART_PURCHASE_ORDER,!1,null,{parentResourceId:this.cartId}),this._initModel(o.Types.PURCHASE_ORDER_DOCUMENT,C.Types.CART_PURCHASE_ORDER_DOCUMENT,!1,null,{parentResourceId:this.cartId}),this._initModel(o.Types.WAIT_FOR_PAYMENT,T.Types.CART,!1,null,{parentResourceId:this.cartId}),this._initSoftwareAgreement(),this._initCollection(o.Types.ADDRESS,P.Types.ME,!0),this._fetchCountries(),this.factoryDispenser.getFactory(o.Types.ADDRESS),this.factoryDispenser.getFactory(o.Types.COMPANY),this.factoryDispenser.getFactory(o.Types.CART_ITEM),this.factoryDispenser.getFactory(o.Types.TC_CONTRACT),this.factoryDispenser.getFactory(o.Types.TC_DOCUMENT),this.factoryDispenser.getFactory(o.Types.VIRTUAL_IBAN),this.factoryDispenser.getFactory(o.Types.PAYMENT_CARD_TOKEN)]),L=this._getBuyerType({me:t,cart:s,company:n,companyAddresses:d}),B=R.createCollection(L===f.COMPANY?S.Types.COMPANY:S.Types.ME),U=new O({buyerType:L,isBuyerTypeEditable:l,me:t,cart:s,cartPsp:p,company:n,companyAddresses:d,personAddresses:_,cardTokens:B,countries:D,addressFactory:F,paymentCardTokenFactory:R,service:this.service}),{hasCountryChanged:w}=await U.patchDefaultCartBillingAddress();return new c({billingAddressHelper:U,me:t,cart:s,shop:r,company:n,companySearch:a,companyAddresses:d,cartPsp:p,cartQuote:u,purchaseOrder:g,purchaseOrderDocument:E,waitForPaymentModel:M,softwareAgreement:A,personAddresses:_,cardTokens:B,countries:D,hasCountryChanged:w,addressFactory:F,companyFactory:I,cartItemFactory:v,tcContractFactory:b,tcDocumentFactory:N,virtualIbanFactory:k,paymentCardTokenFactory:R,service:this.service,locale:this.locale,linkToBankTransferFAQ:this.linkToBankTransferFAQ,hasDedicatedPoUploadEvent:this.hasDedicatedPoUploadEvent})},async _fetchMeCartShopCompanyWithAddresses(){const[e,t]=await Promise.all([this._initModel(o.Types.PERSON,d.Types.ME,!0),this._initModel(o.Types.CART,l.Types.CART,!0,{id:this.cartId},{},{expand:[M.Expands.CART_ITEMS]})]),s=this.service===n.CLICK_AND_BUY&&!t.hasEduItems()&&!t.hasMakerItems(),[r,{company:i,companySearch:a,companyAddresses:c,isBuyerTypeEditable:h}]=await Promise.all([this._fetchShop({cart:t}),this._fetchCompanyWithAddresses({me:e,cart:t,isClickAndBuyForCompanies:s})]);return{me:e,cart:t,company:i,companySearch:a,companyAddresses:c,shop:r,isBuyerTypeEditable:h}},async _fetchCompanyWithAddresses({me:e,cart:t,isClickAndBuyForCompanies:s}){const r=this.isCloudLicensePurchase||this.service===n.INNOVATE?t.getCompanyID():e.getCompanyId();let i,a,c;const d=this._isBuyerTypeEditable({cart:t});if(r||s||d){const[e,t]=await Promise.all([this.factoryDispenser.getFactory(o.Types.COMPANY),this.factoryDispenser.getFactory(o.Types.ADDRESS)]);e.addressFactory=t,r?(i=e.createModel(p.Types.COMPANY,{id:r}),await i.fetchPromise(),c=i.addresses):s?(a=e.createModel(p.Types.MATCHING_COMPANIES),i=e.createModel(p.Types.ME),c=t.createCollection(P.Types.COMPANY)):d&&(i=e.createModel(p.Types.COMPANY),c=t.createCollection(P.Types.COMPANY))}return{company:i,companySearch:a,companyAddresses:c,isBuyerTypeEditable:d}},_fetchShop({cart:e}){if(!this.isCloudLicensePurchase)return this._initModel(o.Types.SHOP,g.Types.SHOP,!0,{id:e.getShopId()},{expand:[A.Expands.SHOP_SERVICES]})},async _fetchCountries(){const e=await this.factoryDispenser.getFactory(o.Types.COUNTRY);if(this.service===n.CLICK_AND_BUY){const[t,s]=await Promise.all([e.createCollection(u.Types.BUYER).fetchPromise(),e.createCollection(u.Types.GENERIC_BUSINESS).fetchPromise()]),r=s.pluck(_.Fields.ISO2);return e.createCollection(u.Types.BUYER,t.filter(e=>r.includes(e.getIso2())))}return e.createCollection(u.Types.BUYER).fetchPromise()},_initSoftwareAgreement(){if(this.isCloudLicensePurchase||this.service===n.INNOVATE)return this._initModel(o.Types.SOFTWARE_AGREEMENT,D.Types.AGREEMENTS,!1)},_isBuyerTypeEditable({cart:e}){return!e.get(M.Fields.SHIP_TO)&&this.service===n.MAKE},_getBuyerType({cart:e,me:t,company:s,companyAddresses:r}){let i;const o=e.get(M.Fields.BILL_TO);if(o)i=r&&r.find(e=>e.get("id")===o)?f.COMPANY:f.INDIVIDUAL;else{const t=e.get(M.Fields.SHIP_TO);i=t?r&&r.find(e=>e.get("id")===t)?f.COMPANY:f.INDIVIDUAL:!s||!s.get("id")&&this.service!==n.CLICK_AND_BUY||e.hasEduItems()||e.hasMakerItems()?f.INDIVIDUAL:f.COMPANY}return this.service===n.CLICK_AND_BUY&&t.set(E.Fields.BUYER_TYPE,i),i}});return I.Events=F,I});