/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/LineTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Web3DUXUtils/Web3DUXArrow","DS/Ruler/Ruler","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/AxisSystemNode","DS/Manipulators/PointHandle"],function(e,t,i,n,r,a,o,d,l,s,c){"use strict";return e.extend({init:function(e){var u,g,x,h,f,p,m=e||{},D=this,b=[],v=!0,y=9689341,C=6543615,A=m.window.getViewer(),w=m.stepRequired,M=new Array(6),P=new Array(6),V=!0,T=new i("BoxEditor_HandleBag");T.setVisibility(!1),T.exludeFromBounding(!0);var S=new i,O=new Array(6),R=null,G=new r,E=!1,z=!1,B=0,U=e.lengthUnit.unit,L=e.lengthUnit.decimalPlaceRO,I=new i("BoxEditor_Axis");I.exludeFromBounding(!0),I.setPickable(a.PICKTHROUGH),I.setVisibility(!1);var N=new s({headLength:10,arrowLength:50,arrowWidth:2,head:s.types.ARROW,colors:{colorX:new a.Color(1,.5,0,0),colorY:new a.Color(1,.5,0,0),colorZ:new a.Color(1,.5,0,0)}});I.addChild(N);var k=new i,F=new i;F.setVisibilityFree(!0),F.setVisibilityInTree(!1);var j=new o({sceneGraph:F,width:60,viewer:A});j.setVisibility(!1),j.setPickable(a.PICKTHROUGH),F.addChild(k),F.addChild(j),F.addChild(T),F.addChild(S),F.addChild(I),A.addNode(F);var H=new d(m.window,{displayOrigin:!0,startValue:0,offset:5,unit:U,nbDecimals:L}),W=0,X=0;this.display=function(e){p=e.matrix,F.setMatrix(p),F.name="BoxGridEditor "+e.rootID;var t=K(e);u=t.selectedCorner,g=t.fstAxis,x=t.sndAxis,h=t.thdAxis,f=t.cornerPoint,V=e.displayHandlePoints,q(),J(e.gridDataPreference);for(var i=0;i<6;i++)te(i,y,C);T.setVisibility(!0),W||(W=H.subscribe("RulerManipulate",_),X=H.subscribe("RulerManipulateEnd",Y)),A.render()},this.refresh=function(){fe(),H.clear(),A.render()},this.updateUnit=function(e){H.unit=e.unit,H.nbDecimals=e.decimalPlaceRO,H.display()},this.setHandlePointsVisibility=function(e){V=e,fe(),A.render()},this.setDataPreference=function(e){var t=K({gridDataPreference:e});f=t.cornerPoint,u=t.selectedCorner,b=[],g=t.fstAxis,x=t.sndAxis,h=t.thdAxis,J(D.getDataPreference())},this.getDataPreference=function(){var e=(new t.Vector3).subVectors(f,u),i=0===Math.round(e.x)?g.x:e.x,n=0===Math.round(e.y)?x.y:e.y,r=0===Math.round(e.z)?h.z:e.z;return{origin:u,xAxis:i,yAxis:n,zAxis:r}},this.updateAutomaticCorner=function(){var e=(new t.Vector3).crossVectors(x,g),i=(new t.Vector3).crossVectors(g,h),n=(new t.Vector3).crossVectors(h,x),r=f.clone(),a=A.currentViewpoint.getSightDirection();a.dot(e)<0&&a.dot(i)>0&&a.dot(n)>0?r.add(h):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)>0?r.add(x):a.dot(e)>0&&a.dot(i)>0&&a.dot(n)<0?r.add(g):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)>0?(r.add(x),r.add(h)):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)<0?(r.add(x),r.add(g)):a.dot(e)<0&&a.dot(i)>0&&a.dot(n)<0?(r.add(h),r.add(g)):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)<0&&(r.add(g),r.add(x),r.add(h)),!r||u.x===r.x&&u.y===r.y&&u.z===r.z||$({selectedCorner:r})},this.clean=function(){for(var e=0;e<6;e++)O[e]&&O[e].unlink(P[e]),M[e]&&M[e].removeChildren();M.splice(0,M.length),P.splice(0,P.length),O.splice(0,O.length),S&&S.removeChildren(),I&&I.removeChildren(),k&&k.removeChildren(),T&&T.removeChildren(),F.removeChildren(),A.removeNode(F),j=null,k=null,S=null,I=null,W&&(H.unsubscribe(W),W=0),X&&(H.unsubscribe(X),X=0),H.clear(),H=null,G=null,T=null,A.render()},this.getBag=function(){return S},this.isSizeOK=function(){return v},this.subscribe=function(e,t){return G.subscribe({event:e},t)},this.unsubscribe=function(e){G.unsubscribe(e)};var _=function(e){E=!0,de(e.translationVector)},Y=function(){se()},Z=function(e){var i=new c({viewer:A,sceneGraph:e.parent});i.name=e.name,i.setMatrix((new t.Matrix4).setPosition(e.position));var n=a.PICKABLE;return i.setPickable(n),i.setVisibility(!0),i.setSize(20),i.subscribe("EndManipulate",function(e){var i=e.paths[0].externalPath[2],n=(new t.Vector3).getPositionFromMatrix(i.getMatrix());u!==n?($({selectedCorner:n}),he("BoxCornerChanged",{cornerChanged:!0})):he("BoxCornerChanged",{cornerChanged:!1})}),i},q=function(){for(var e,i=function(e){var i=new t.Vector3;return i.x=e.x.toFixed(4),i.y=e.y.toFixed(4),i.z=e.z.toFixed(4),i},n=new t.Matrix4,r=new t.Color("#FFFFFF"),a=new t.Color("#FF8000"),o=["mO","mOX","mOY","mOZ","mOXY","mOYZ","mOXZ","mOXYZ"],d=[f.clone(),f.clone().add(g),f.clone().add(x),f.clone().add(h),f.clone().add(g).add(x),f.clone().add(x).add(h),f.clone().add(g).add(h),f.clone().add(g).add(x).add(h)],l=0;l<o.length;l++){(e=T.getChildByName(o[l]))?e.setMatrix(n.setPosition(d[l])):(n=n.setPosition(d[l]),e=Z({name:o[l],position:d[l],parent:T}));var s=i(d[l]).equals(i(u));e.setFillColor(s?a:r),e.setVisibility(V||s)}},K=function(e){var i=(new t.Vector3).copy(e.gridDataPreference.origin),n=(new t.Vector3).copy(e.gridDataPreference.origin),r=new t.Vector3(e.gridDataPreference.xAxis,0,0),a=new t.Vector3(0,e.gridDataPreference.yAxis,0),o=new t.Vector3(0,0,e.gridDataPreference.zAxis);return i.x+e.gridDataPreference.xAxis<i.x&&(n.x=i.x+r.x,r.x*=-1),i.y+e.gridDataPreference.yAxis<i.y&&(n.y=i.y+a.y,a.y*=-1),i.z+e.gridDataPreference.zAxis<i.z&&(n.z=i.z+o.z,o.z*=-1),{selectedCorner:i,cornerPoint:n,fstAxis:r,sndAxis:a,thdAxis:o}},J=function(e){var i=function(e){return 0===(e=Number(e))||isNaN(e)?e:e>0?1:-1};I.setMatrix((new t.Matrix4).setPosition(e.origin)),I.setVisibility(!0);var n=(new t.Matrix4).rotateX(3*i(e.yAxis)*Math.PI/2);I.children[0].children[0].setMatrix(n);var r=(new t.Matrix4).rotateY(i(e.xAxis)*Math.PI/2);I.children[0].children[1].setMatrix(r);var a=new t.Matrix4;e.zAxis<0&&a.rotateX(Math.PI),I.children[0].children[2].setMatrix(a)},Q=function(e,i){var n=(new t.Vector3).copy(e),r=(new t.Vector3).copy(i),a=n.cross(r).length();return 0===Math.round(100*a)},$=function(e){b=[],u=e.selectedCorner,fe(),J(D.getDataPreference())},ee=function(){var e=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e};v=!0,y=9689341,C=6543615;var i=(new t.Vector3).copy(f);if(i.x%w!=0&&i.x%w!=0&&i.x%w!=0){var n=(new t.Vector3).copy(i).add(g).add(x).add(h),r=e(n.x,w),a=e(n.y,w),o=e(n.z,w);r<i.x&&a<i.y&&o<i.z&&(v=!1,y=16711765,C=14876748)}},te=function(e,n,r){M[e]&&M[e].removeChildren();var a=null,o=null,d=null,s=null;switch(e){case 0:a=f,o=x,d=g,3!==b.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&b.push(e));break;case 1:a=f,o=h,d=x,3!==b.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&b.push(e));break;case 2:a=f,o=g,d=h,3!==b.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&b.push(e));break;case 3:a=(new t.Vector3).copy(f).add(g),o=x,d=h,3!==b.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&b.push(e));break;case 4:a=(new t.Vector3).copy(f).add(x),o=h,d=g,3!==b.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&b.push(e));break;case 5:a=(new t.Vector3).copy(f).add(h),o=g,d=x,3!==b.length&&(s=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(s))&&b.push(e))}var c=ie(a,o,d,n,r,e),p=l.createMeshNode(c);p.excludeFromCSO(!0),p.excludeFromHighlight(!0),p.setSSAO(!1),p.setShadow(!1,!1),M[e]||(M[e]=new i("Face"+e),S.add(M[e])),M[e].add(p),O[e]&&O[e].unlink(P[e]),O[e]=ne(e,(new t.Vector3).copy(o).cross(d).normalize()),P[e]=O[e].linkToNode(M[e]),ne(-1,new t.Vector3)},ie=function(e,i,n,r,o){var d,l,s,c,u,g,x,h,f,p,m;(d=new a.PrimitiveGroup).fillAttr=new a.FillAttributes,d.lineAttr=new a.LineAttributes,d.pointAttr=new a.PointAttributes,(l=new a.Buffer).size=12,l.component=a.VertexComponentEnum.POSITION,l.format=a.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(12),(c=new a.Buffer).indexBuffer=!0,c.size=9,c.format=a.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(9),(s=new a.Buffer).size=3,s.component=a.VertexComponentEnum.NORMAL,s.format=a.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(3),(u=new a.Buffer).indexBuffer=!0,u.size=4,u.format=a.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(4),d.addBuffer(0,l),d.addBuffer(1,c),d.addBuffer(2,s),d.addBuffer(3,u),x=0,(g=l.data)[x++]=e.x,g[x++]=e.y,g[x++]=e.z,m=(new t.Vector3).copy(e).add(i),g[x++]=m.x,g[x++]=m.y,g[x++]=m.z,m=(new t.Vector3).copy(e).add(i).add(n),g[x++]=m.x,g[x++]=m.y,g[x++]=m.z,m=(new t.Vector3).copy(e).add(n),g[x++]=m.x,g[x++]=m.y,g[x++]=m.z,(g=c.data)[0]=0,g[1]=1,g[2]=3,g[3]=2,(g=s.data)[0]=0,g[1]=0,g[2]=1,(g=u.data)[0]=0,g[1]=0,g[2]=0,g[3]=0,(h=new a.Primitive).nbIndices=4,h.connectivity=a.ConnectivityTypeEnum.TRIANGLE_STRIP,h.material=new t.MeshBasicMaterial({side:t.DoubleSide,color:r,opacity:.5,transparent:!0}),(f=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,f.nbVertices=4,f.nbValuesPerVertex=3,f.format=a.DataTypeEnum.FLOAT,f.cardinality=0,f.bufferId=0,f.indices=new a.IndexArray,f.indices.format=a.DataTypeEnum.UINT,f.indices.bufferId=1,f.indices.offset=0,h.addVertexComponent(f),(p=new a.VertexComponent).component=a.VertexComponentEnum.NORMAL,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=a.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=2,p.indices=new a.IndexArray,p.indices.format=a.DataTypeEnum.UINT,p.indices.bufferId=3,p.indices.offset=0,h.addVertexComponent(p),d.addPrimitive(h),x=4,(g=c.data)[x++]=0,g[x++]=1,g[x++]=2,g[x++]=3,g[x++]=0;var D=new a.Primitive;return D.nbIndices=4,D.connectivity=a.ConnectivityTypeEnum.LINE_STRIP,D.attr={fill:new a.FillAttributes,line:new a.LineAttributes(new a.Color(o)),point:new a.PointAttributes},(f=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,f.nbVertices=5,f.nbValuesPerVertex=3,f.format=a.DataTypeEnum.FLOAT,f.cardinality=0,f.bufferId=0,f.indices=new a.IndexArray,f.indices.format=a.DataTypeEnum.UINT,f.indices.bufferId=1,f.indices.offset=4,D.addVertexComponent(f),d.addPrimitive(D),d.noz=!1,d},ne=function(e,i){var r=new n({axis:(new t.Vector3).copy(i)});return r.setExclusive(!0),e>=0&&(r.subscribe("BeginManipulate",function(){oe(e)}),r.subscribe("Manipulate",function(e){le(e)}),r.subscribe("EndManipulate",function(e){ce(e)}),r.subscribe("BeginPreactivate",function(t){ue(e,t)}),r.subscribe("EndPreactivate",function(){ge()})),r},re=function(e){var i=null,n=null;switch(e){case 0:i=(new t.Vector3).copy(x),n=(new t.Vector3).copy(g);break;case 1:i=(new t.Vector3).copy(h),n=(new t.Vector3).copy(x);break;case 2:i=(new t.Vector3).copy(g),n=(new t.Vector3).copy(h);break;case 3:i=(new t.Vector3).copy(x),n=(new t.Vector3).copy(h);break;case 4:i=(new t.Vector3).copy(h),n=(new t.Vector3).copy(g);break;case 5:i=(new t.Vector3).copy(g),n=(new t.Vector3).copy(x)}return(new t.Vector3).copy(n).cross(i).normalize()},ae=function(e,i){var n=null,r=null,a=null;switch(e){case 0:n=(new t.Vector3).copy(f),r=(new t.Vector3).copy(x),a=(new t.Vector3).copy(g);break;case 1:n=(new t.Vector3).copy(f),r=(new t.Vector3).copy(h),a=(new t.Vector3).copy(x);break;case 2:n=(new t.Vector3).copy(f),r=(new t.Vector3).copy(g),a=(new t.Vector3).copy(h);break;case 3:n=(new t.Vector3).copy(f).add(g),r=(new t.Vector3).copy(x),a=(new t.Vector3).copy(h);break;case 4:n=(new t.Vector3).copy(f).add(x),r=(new t.Vector3).copy(h),a=(new t.Vector3).copy(g);break;case 5:n=(new t.Vector3).copy(f).add(h),r=(new t.Vector3).copy(g),a=(new t.Vector3).copy(x)}var o=r.length();a.length()>o&&(o=a.length());var d=(new t.Vector3).copy(r).setLength(r.length()/2),l=(new t.Vector3).copy(a).setLength(a.length()/2);n.add(d).add(l);var s=(new t.Vector3).copy(a).cross(r).normalize(),c=new t.Matrix4;r.normalize(),a.normalize();var u=c.elements;i&&s.applyAxisAngle(r,Math.PI),u[0]=r.x,u[1]=r.y,u[2]=r.z,u[4]=a.x,u[5]=a.y,u[6]=a.z,u[8]=s.x,u[9]=s.y,u[10]=s.z,c.setPosition(n),j.setMatrix(c),z=i},oe=function(e){B=e,R=new t.Vector3(0,0,0),ae(B),j.setVisibility(!0),k.removeChildren(),E=!0,H.clear();var i=re(B),n=null;Q(i,g)?n=g:Q(i,x)?n=x:Q(i,h)&&(n=h);var r=null,a=null;switch(B){case 0:r=(new t.Vector3).copy(f),a=g;break;case 1:r=(new t.Vector3).copy(f),a=x;break;case 2:r=(new t.Vector3).copy(f).sub(h),a=h;break;case 3:r=(new t.Vector3).copy(f).add(g).sub(h),a=h;break;case 4:r=(new t.Vector3).copy(f).add(x),a=g;break;case 5:r=(new t.Vector3).copy(f).add(h),a=x}var o=(new t.Vector3).copy(i).setLength(n.length()).add((new t.Vector3).copy(a).setLength(a.length()));H.origin=(new t.Vector3).copy(r).add(o).add((new t.Vector3).getPositionFromMatrix(p)),H.initValue=n.length(),H.value=H.initValue,H.direction=i.multiplyScalar(-1),H.setVisibleFlag(!0),H.display(),H.beginManipulation(),A.render()},de=function(e){var i;R.add(e),0===B?(i=(new t.Vector3).copy(h).sub(e),h.copy(i)):1===B?(i=(new t.Vector3).copy(g).sub(e),g.copy(i)):2===B?(i=(new t.Vector3).copy(x).sub(e),x.copy(i)):3===B?(i=(new t.Vector3).copy(g).add(e),g.copy(i)):4===B?(i=(new t.Vector3).copy(x).add(e),x.copy(i)):5===B&&(i=(new t.Vector3).copy(h).add(e),h.copy(i)),0!==B&&1!==B&&2!==B||f.add(e),b.indexOf(B)>-1&&u.add(e);var n=M[B].children[0],r=n.getMatrix();r.setPosition((new t.Vector3).getPositionFromMatrix(r).add(e)),n.setMatrix(r),xe(B);var a=e.dot(re(B));a>0&&!z?ae(B,!0):a<0&&z&&ae(B,!1);var o=(new t.Vector3).getPositionFromMatrix(j.getMatrix()).add(e);j.setMatrix((new t.Matrix4).copy(j.getMatrix()).setPosition(o)),T.setVisibility(!1),I.setVisibility(!1)},le=function(e){var i=H.getSnappedTranslationVector(e);if(0!==i.returnCode)return null;var n=(new t.Vector3).copy(i.snappedTranslationVector).sub(R),r=H.value+n.length()*(n.dot(re(B))<0?1:-1);r<=0&&(r=0,n.setLength(H.value)),H.setValue(r),de(n)},se=function(){j&&j.setVisibility(!1),E=!1,q(),T.setVisibility(!0),J(D.getDataPreference()),he("EndBoxChanged")},ce=function(){se(),H.endManipulation(),H.display()},ue=function(e){if(E)return!0;var i=null,n=null,r=null;switch(e){case 0:i=f,n=x,r=g;break;case 1:i=f,n=h,r=x;break;case 2:i=f,n=g,r=h;break;case 3:i=(new t.Vector3).copy(f).add(g),n=x,r=h;break;case 4:i=(new t.Vector3).copy(f).add(x),n=h,r=g;break;case 5:i=(new t.Vector3).copy(f).add(h),n=g,r=x}var a=(new t.Vector3).copy(n);a.cross(r),a.normalize(),a.setLength(.05);var o=(new t.Vector3).copy(i).sub(a),d=ie(o,n,r,9689341,6543615,e),s=l.createMeshNode(d);s.excludeFromCSO(!0),s.excludeFromHighlight(!0),s.setSSAO(!1),s.setShadow(!1,!1),k.removeChildren(),k.add(s),ae(e),j.setVisibility(!0),A.render()},ge=function(){E||(j.setVisibility(!1),k.removeChildren(),A.render())},xe=function(e){ee();for(var t=0;t<6;t++)t!==e&&te(t,y,C)},he=function(e){return G.publish({event:e,context:this,data:D.getDataPreference()})},fe=function(){var e;for(k.removeChildren(),E=!1,e=0;e<6;e++)O[e]&&O[e].unlink(P[e]),O[e]=null,M[e]&&M[e].removeChildren(),M[e]=null;for(S&&(S.removeChildren(),F.remove(S)),M=new Array(6),S=new i,F.addChild(S),O=new Array(6),q(),ee(),e=0;e<6;e++)te(e,y,C);A.render()}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CoreEvents/Events"],function(e,t){"use strict";let i;var n=e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}});return n.Check=function(e,n){(i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext())&&t.publish({event:"CATRelatedData3DGridAutoOriginHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true"),e()},n.Uncheck=function(e,n){i||(i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext()),i&&t.publish({event:"CATRelatedData3DGridAutoOriginHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false"),e()},n}),define("DS/CATRelatedData3DGrid/CATRelatedData3DGrid",[],function(){}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridRemoveOverloadCmd",["DS/CATWebUXComponents/DMUCommand","DS/CoreEvents/Events"],function(e,t){"use strict";let i,n;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),n=this},beginExecute:function(){(i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0)&&t.publish({event:n.getId()+"/BEGIN",data:n})},cancelExecute:function(){i||(i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0),i&&t.publish({event:n.getId()+"/END",data:n}),i=void 0,this.done()}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCancelCmd",["DS/CATWebUXComponents/DMUCommand"],function(e){"use strict";return e.extend({init:function(){},beginExecute:function(){window.console.log("Cancel edit"),this.done()}})}),define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCommandsComponent",[],function(){"use strict";let e=null,t=null,i=null,n=[{id:"CATRelatedData3DGridHdr",type:"check",localStorageID:"CATRelatedData3DGridCmd"}],r=function(e){for(let t=0;t<n.length;t++)if(n[t].id===e)return n[t];return!1};return class{constructor(n){this.initialize=function(){return t=(e=this).getExecutionContext(),i=t.getComponent(WAfrStandardComponentKey.HandlerComponent),new Promise(e=>{n.forEach(e=>{let t=r(e.id);t&&("check"===t.type?i.setCheckState({id:t.id,state:"true"===localStorage.getItem(t.localStorageID)}):"default"===t.type&&(t.enable&&("true"===t.enable?i.enableHandler(t.id):i.disableHandler(t.id)),"true"===t.init&&i.executeHandler({id:t.id})))}),e()})},this.clean=function(){return new Promise(e=>{e()})},this.destroy=function(){return new Promise(e=>{e()})},this.canBeParallelized=function(){return!1}}}}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CoreEvents/Events"],function(e,t){"use strict";let i;var n=e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}});return n.Check=function(e,n){(i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext())&&t.publish({event:"CATRelatedData3DGridAutoFitHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true"),e&&e()},n.Uncheck=function(e,n){i||(i=n.executionContext?n.executionContext:this.getFrameWindow().getExecutionContext()),i&&t.publish({event:"CATRelatedData3DGridAutoFitHdr/TOGGLECHECK"}),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false"),e&&e()},n}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CoreEvents/Events"],function(e,t,i){"use strict";let n,r;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),r=this},beginExecute:function(){n=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0,t.get().setRobotVisibility(!1),n&&i.publish({event:r.getId()+"/BEGIN",data:r})},cancelExecute:function(){n||(n=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0),t.get().setRobotVisibility(!0),n&&i.publish({event:r.getId()+"/END",data:r}),n=void 0,this.done()}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridPropertiesCmd",["DS/CATWebUXComponents/DMUCommand","DS/CoreEvents/Events"],function(e,t){"use strict";let i,n;return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),n=this},beginExecute:function(){(i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0)&&t.publish({event:n.getId()+"/BEGIN",data:n})},cancelExecute:function(){i||(i=this.getFrameWindow().getExecutionContext?this.getFrameWindow().getExecutionContext():void 0),i&&t.publish({event:n.getId()+"/END",data:n}),i=void 0,this.done()}})}),
/*!  Copyright 2024 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridDMUObject",["DS/DMUBaseExperience/DMUObject","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";let i=[{name:"sType",type:"string",JSONname:"type"},{name:"sPitch",type:"float",JSONname:"pitch",isOverloadable:!0},{name:"sLabelPrefixX",type:"string",JSONname:"LabelPrefixX",defaultValue:"L",isOverloadable:!0},{name:"sLabelPrefixY",type:"string",JSONname:"LabelPrefixY",defaultValue:"W",isOverloadable:!0},{name:"sLabelPrefixZ",type:"string",JSONname:"LabelPrefixZ",defaultValue:"H",isOverloadable:!0},{name:"bIsBBOverloaded",type:"bool",JSONname:"IsBBOverloaded",defaultValue:!1,isOverloadable:!0},{name:"vBBMin",type:"Vector3",JSONname:"BoundingBoxMin",defaultValue:null,isOverloadable:!0},{name:"vBBMax",type:"Vector3",JSONname:"BoundingBoxMax",defaultValue:null,isOverloadable:!0},{name:"idxLockedOrigin",type:"int",JSONname:"LockedOriginIndex",defaultValue:0,isOverloadable:!0}];return class extends e{constructor(e,n){super(e,n),this.addParameters(i),this._type="3DGrid",this.setAttribute("sType","3DGrid"),this.getType=function(){return this._type},this.setGridOverload=function(e,t){var i=[];i.push({attribute:"bIsBBOverloaded",value:e}),e?(i.push({attribute:"vBBMin",value:t.min?t.min:null}),i.push({attribute:"vBBMax",value:t.max?t.max:null})):(i.push({attribute:"vBBMin",value:null}),i.push({attribute:"vBBMax",value:null})),this.set(i)},this.importData=function(e,i,n){if(e){var r=[];r.push({attribute:"sPitch",value:e.pitch}),r.push({attribute:"sLabelPrefixX",value:e.LabelPrefixX}),r.push({attribute:"sLabelPrefixY",value:e.LabelPrefixY}),r.push({attribute:"sLabelPrefixZ",value:e.LabelPrefixZ}),r.push({attribute:"bIsBBOverloaded",value:e.IsBBOverloaded}),r.push({attribute:"vBBMin",value:e.BoundingBoxMin?(new t.Vector3).setFromArray(e.BoundingBoxMin):null}),r.push({attribute:"vBBMax",value:e.BoundingBoxMax?(new t.Vector3).setFromArray(e.BoundingBoxMax):null}),r.push({attribute:"idxLockedOrigin",value:e.LockedOriginIndex}),this.set(r)}},this.afterImport=function(){this.fireEvent("onDMUObjectInitialized",{dmuObject:this})}}}}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridView",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNodeTexture","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/CATWebUXComponents/DMUCommandsManager","DS/Manipulators/HandlePointManipulator","DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridPropertiesCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridRemoveOverloadCmd","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Windows/Dialog","DS/Controls/Button","DS/Controls/SpinBox","DS/Controls/LineEditor","DS/CATRelatedData3DGrid/CATRelatedData3DGridDMUObject","i18n!DS/CATRelatedData3DGrid/assets/nls/CATRelatedData3DGrid","css!DS/CATRelatedData3DGrid/assets/css/CATRelatedData3DGrid"],function(e,t,i,n,r,a,o,d,l,s,c,u,g,x,h,f,p,m,D,b,v,y,C,A,w,M,P){"use strict";return t.extend({init:function(t){if(!t)return;var V,T=t.viewer,S=t.window,O=t.context,R=[{},{x:"min",y:"min",z:"min"},{x:"max",y:"min",z:"min"},{x:"min",y:"max",z:"min"},{x:"max",y:"max",z:"min"},{x:"min",y:"min",z:"max"},{x:"max",y:"min",z:"max"},{x:"min",y:"max",z:"max"},{x:"max",y:"max",z:"max"}],G=!1,E=!1,z=null,B=null,U=this,L=[],I=JSON.parse(localStorage.getItem("CATRelatedData3DGridDftOrigin"));I||(I={x:"min",y:"min",z:"min"});var N={xStep:t.stepRequiredX,yStep:t.stepRequiredY,zStep:t.stepRequiredZ},k=new i.Matrix4;t.gridMatrix&&(k=t.gridMatrix.clone());var F=t.id,j=void 0===t.isEditable||t.isEditable,H=void 0===t.isLabelManipulable||t.isLabelManipulable,W=t.owner,X=void 0!==t.isAbsoluteMode&&t.isAbsoluteMode,_=t.nbMaxLabel,Y=t.labels?t.labels:{x:"L",y:"W",z:"H"},Z=2*Math.round(10*window.devicePixelRatio/2),q=window.widget,K=null;q&&(K=q.getValue("3DGridData")),K?K=JSON.parse(K):(q&&q.addPreference({name:"3DGridData",type:"hidden"}),K={gridList:[]});var J,Q,$,ee,te=null,ie=!1,ne=null,re=new i.Vector3,ae=null,oe=null,de=null,le=null,se=null,ce=!1,ue=null,ge=null,xe=S.getContextualUIManager(),he=null,fe={},pe={},me=null,De=null,be=null,ve=null,ye=null,Ce=null,Ae=null,we=null,Me=null,Pe=null,Ve=null,Te=null,Se=null,Oe=null,Re=null,Ge=null,Ee=[],ze=[],Be=!1,Ue=[],Le=[],Ie=null,Ne=0,ke=!1;var Fe=null,je=null,He=null,We=null,Xe=null,_e=["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP","ENOR3D_APWebApp"],Ye={width:t.freeZoneDim?t.freeZoneDim.width:0,height:t.freeZoneDim?t.freeZoneDim.height:0,left:t.freeZoneDim?t.freeZoneDim.left:0,right:t.freeZoneDim?t.freeZoneDim.width-t.freeZoneDim.right:0,top:t.freeZoneDim?t.freeZoneDim.top:0,bottom:t.freeZoneDim?t.freeZoneDim.height-t.freeZoneDim.bottom:0},Ze={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3,nls:"mm"},qe=!1;function Ke(e,t){var i=!0;if(Object.keys(e).length===Object.keys(t).length){for(let n in e)if(e[n]!==t[n]){i=!1;break}}else i=!1;return i}function Je(e){for(let t=0;t<R.length;t++)if(Ke(e,R[t]))return t}function Qe(e){var t=e.getHotspot();return t.width=e.hotspotWidth||0,t.height=e.hotspotHeight||0,t}function $e(e){var t;if(e){var n=e.getOrientedBoundingBox?e.getOrientedBoundingBox(new i.Matrix4,T):e.getBoundingBox(null,T,T.getVisibleSpace()?"visibleSpace":"invisibleSpace");t=n&&!n.isNaN()?n:void 0}return t}var et=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e},tt=function(e,t){var i=e%t;return i>0?e+(t-i):i<0?e-i:e},it=function(e){return 0===(e=parseFloat(e))||isNaN(e)?e:e>0?1:-1},nt=function(e){return e.x<0||e.y<0||e.z<0?-1:1},rt=function(){Ie&&(T.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(Ie),Ie=null)},at=function(e){e&&(Ie&&rt(),Ie=new D(e.externalPath[0]),T.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(Ie))},ot=function(e,t){Ie&&e&&t&&("color"===t.type?Ie.createOverride(e).setColor(t.value):"pickability"===t.type&&Ie.createOverride(e).setPickability(t.value))},dt=function(e,t,i){var n=e.getContext("2d"),r=e.height-2;n.font=Z+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,r);for(var a=z.childNodes.length-1;a>=0;a--)z.childNodes[a].label.name===t&&((n=z.childNodes[a].getContext("2d")).font=Z+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,r))},lt=function(e){for(var t=new b,i=[],n=e;n&&!n.notAllowedInPathElement;)i.splice(0,0,n),n=n.parents[0];return t.setFromArray(i),t},st=function(e){var t,i;if(e.preactivated&&(i=e.preactivated.path.externalPath.length),le=e.preactivated?e.preactivated.path.externalPath[i-2]:e.currentTarget.label,se=e.currentTarget,le){var n=le.canvasNodeTexture;n.isHighlighted=!0,n.requestRedraw(),se&&dt(se,le.name,"#FF8000");var r=e.preactivated?e.preactivated.path:null;if(r)for(;r&&-1===r.getLastElement(!0).name.indexOf("3D Grid");)r=r.getParentPath();else if(W)for(t=0;t<L.length;t++)L[t].grid.name===e.currentTarget.label.gridID&&(r=lt(W)).addElement(L[t].grid);else for(t=0;t<L.length;t++)L[t].grid.name===e.currentTarget.label.gridID&&(r=new b).addElement(L[t].grid);at(r);var a=r.getChildrenPathes();for(t=0;t<a.length;t++)for(var o=a[t].getChildrenPathes()[0].getChildrenPathes(),d=0;d<o.length;d++)o[d].getLastElement(!0).relatedLabel&&n.labelValue&&o[d].getLastElement(!0).relatedLabel.prefix===n.labelValue.prefix&&o[d].getLastElement(!0).relatedLabel.value===n.labelValue.value&&(ot(o[d],{type:"color",value:"#FF8000"}),ie||o[d].getLastElement(!0).setNoZ(!0),Ue.push(o[d].getLastElement(!0)));T.render()}},ct=function(){if(le){var e=le.canvasNodeTexture;if(e.isHighlighted=!1,e.requestRedraw(),se&&dt(se,le.name,ge),le=null,rt(),!ie)for(var t=0;t<Ue.length;t++)Ue[t].setNoZ(!1);Ue.splice(0,Ue.length),T.render()}},ut=function(e){if(Ne<2&&Ne++,2===Ne&&!Q&&(Ne=4,T.currentViewpoint.getControl()._changeState(3),(Q={}).eyePosition=T.currentViewpoint.getEyePosition(),Q.upDirection=T.currentViewpoint.getUpDirection(),Q.sightDirection=T.currentViewpoint.getSightDirection(),Q.distanceToTarget=T.currentViewpoint.getTargetDistance(),st(ee?{currentTarget:ee}:{preactivated:{path:e.paths[0]}}),2===Ue.length)){var t=(new i.Vector3).copy(Ue[0].explicitBBox.min),n=(new i.Vector3).copy(Ue[0].explicitBBox.max);t.applyMatrix4(Ue[0].getMatrix()),n.applyMatrix4(Ue[0].getMatrix());var a,d=(new i.Vector3).copy(Ue[1].explicitBBox.min),l=(new i.Vector3).copy(Ue[1].explicitBBox.max);if(d.applyMatrix4(Ue[1].getMatrix()),l.applyMatrix4(Ue[1].getMatrix()),ee){for(var s=0;s<L.length;s++)if(L[s].grid.name===ee.label.gridID){a=L[s].grid.getMatrix();break}}else a=e.paths[0].externalPath[0].getMatrix();t.applyMatrix4(a),n.applyMatrix4(a),d.applyMatrix4(a),l.applyMatrix4(a);var c=t,u=new i.Vector3,g=new i.Vector3;c.x===d.x&&c.y===d.y&&c.z===d.z||c.x===l.x&&c.y===l.y&&c.z===l.z?u=(new i.Vector3).subVectors(n,t):(c=n,u=(new i.Vector3).subVectors(t,c)),c.x===d.x&&c.y===d.y&&c.z===d.z?g.subVectors(l,c):g.subVectors(d,c),$&&(T.removeNode($),$=null),($=function(e,t,n,a,d){var l=new o.PrimitiveGroup;l.noz=!1,l.fillAttr=new o.FillAttributes,l.lineAttr=new o.LineAttributes,l.pointAttr=new o.PointAttributes;var s=new o.Buffer;s.size=12,s.component=o.VertexComponentEnum.POSITION,s.format=o.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(12);var c=new o.Buffer;c.indexBuffer=!0,c.size=4,c.format=o.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(4),c.data[0]=0,c.data[1]=1,c.data[2]=3,c.data[3]=2;var u=new o.Buffer;u.size=3,u.component=o.VertexComponentEnum.NORMAL,u.format=o.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(3),u.data[0]=0,u.data[1]=0,u.data[2]=1;var g=new o.Buffer;g.indexBuffer=!0,g.size=4,g.format=o.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(4),g.data[0]=0,g.data[1]=0,g.data[2]=0,g.data[3]=0,l.addBuffer(0,s),l.addBuffer(1,c),l.addBuffer(2,u),l.addBuffer(3,g);var x=s.data,h=0;x[h++]=e.x,x[h++]=e.y,x[h++]=e.z;var f=(new i.Vector3).copy(e).add(t);x[h++]=f.x,x[h++]=f.y,x[h++]=f.z,f=(new i.Vector3).copy(e).add(t).add(n),x[h++]=f.x,x[h++]=f.y,x[h++]=f.z,f=(new i.Vector3).copy(e).add(n),x[h++]=f.x,x[h++]=f.y,x[h++]=f.z;var p=new o.Primitive;p.nbIndices=4,p.connectivity=o.ConnectivityTypeEnum.TRIANGLE_STRIP;var m=new i.MeshBasicMaterial({side:i.DoubleSide,color:a,opacity:d,transparent:!0});p.material=m;var D=new o.VertexComponent;D.component=o.VertexComponentEnum.POSITION,D.nbVertices=4,D.nbValuesPerVertex=3,D.format=o.DataTypeEnum.FLOAT,D.cardinality=0,D.bufferId=0,D.indices=new o.IndexArray,D.indices.format=o.DataTypeEnum.UINT,D.indices.bufferId=1,D.indices.offset=0;var b=new o.VertexComponent;b.component=o.VertexComponentEnum.NORMAL,b.nbVertices=4,b.nbValuesPerVertex=3,b.format=o.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=2,b.indices=new o.IndexArray,b.indices.format=o.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,p.addVertexComponent(D),p.addVertexComponent(b),l.addPrimitive(p);var v=r.createMeshNode(l);return v.setSSAO(!1),v.setShadow(!1,!1),v.excludeFromCSO(!0),v.excludeFromHighlight(!0,!0),v.setMatrix(k),v}(c,u,g,16744448,.5)).name="Box_PreviewPlane",T.addNode($)}},gt=function(e){ke=!0,setTimeout(function(){ke&&(Ne=2,ut(e))},100)},xt=function(){ke=!1,ee&&(ee=null),Q&&(T.currentViewpoint.getControl()._changeState(-1),T.currentViewpoint.moveTo({eyePosition:Q.eyePosition,upDirection:Q.upDirection,sightDirection:Q.sightDirection,distanceToTarget:Q.distanceToTarget,duration:100}),Q=null),$&&(T.removeNode($),$=null,ct()),Ne=0},ht=function(e){Ne=0,ke=!1,"touch"===(e.type?e.type:e.event.from[0].type).indexOf!==-1&&(Pe&&(clearTimeout(Pe),ct(),Pe=null),Pe=setTimeout(function(){ct(),Pe=null},1e3),st(ee?{currentTarget:ee}:{preactivated:{path:e.intersection.path[0]}}));for(var t=ee?ee.label.gridID:e.intersection?e.intersection.path[0].externalPath[0].name:e.gesture.currentEvent[0].view.label.gridID,i=0;i<L.length;i++)if(L[i].grid.name===t){ae=L[i];break}Ve&&Ve.setState("userDefined"!==ae.type),me&&(me=s.getCommand("CATRelatedData3DGridEditHdr",O.getCommandContext()));var n=[];let r=ae.gridDMUObject.getParent();n=r&&r.getCurrentSlide?[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"},{name:"CATRelatedData3DGridRemoveOverload",line:1,hdr_list:["CATRelatedData3DGridRemoveOverloadHdr"],type:"handler",identifier:"CATRelatedData3DGridRemoveOverloadHdr"}]:[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"}],O.getExecutionContext?xe._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:n}}},context:O.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}):xe.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:n}},context:O.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}),ee&&(ee=null)},ft=function(e){var t;e.stopPropagation(),e.preventDefault(),-1!==e.type.indexOf("touch")?("function"==typeof window.UIEvent?t=new window.UIEvent(e.type):(t=document.createEvent("UIEvent")).initUIEvent(e.type,!0,!0,window,1),t.touches=e.touches,t.changedTouches=e.changedTouches):"function"==typeof window.MouseEvent?t=new MouseEvent(e.type,{bubbles:!0,cancelable:!0,view:window,clientX:e.clientX,clientY:e.clientY,screenX:e.clientX,screenY:e.clientY,button:0}):(t=document.createEvent("MouseEvent")).initMouseEvent(e.type,!0,!0,window,1,0,0,e.clientX,e.clientY,!1,!1,!1,!1,0,null),t._simul=!0===l._ODTMode||void 0,T.canvas.dispatchEvent(t)},pt=function(e){ke=!0,ee=e.currentTarget,Ne=0,setTimeout(function(){ke&&ee&&(Ne=2,"Touch"===e.type&&ft(e),ut())},100)},mt=function(e){e.stopPropagation(),e.preventDefault(),ee&&ft(e)},Dt=function(e){ee&&!Ne?ht(e):xt()},bt=function(e,t){var n;e.setVisibility(!0);var r,a,o,d=(new i.Matrix4).multiplyMatrices(t,e.getMatrix()),l=(new i.Vector3).getPositionFromMatrix(d),s=T.currentViewpoint.project(l),c=s.clone(),u=Ye.width-Ye.right,g=Ye.height-Ye.bottom,x=Ye.left,h=Ye.top,f=Qe(e);function p(e){e.x-=f.x,e.y+=f.y;var t=Ye.left+(u-Ye.left)/2,i=Ye.top+(g-Ye.top)/2;e.x<=t/2&&e.y<=i/2?e.y-=f.height:e.x>t/2&&e.y>i/2?e.x+=f.width:e.x>t/2&&e.y<=i/2&&(e.x+=f.width,e.y-=f.height)}if(p(c),c.x<x||c.y<h||c.x>u||c.y>g||Math.abs(c.z)>1){e.setVisibility(!1);var m,D,b=new i.Vector2(-1,-1),v=(new i.Vector3).copy(e.boundaries[0]).applyMatrix4(t),y=(new i.Vector3).copy(e.boundaries[1]).applyMatrix4(t);if(m=v.x===l.x&&v.y===l.y&&v.z===l.z?s:T.currentViewpoint.project(v),D=y.x===l.x&&y.y===l.y&&y.z===l.z?s:T.currentViewpoint.project(y),Math.abs(m.z)>1&&Math.abs(D.z)>1)return n;if(Math.abs(m.z)>1||Math.abs(D.z)>1){var C=new i.Line3(v,y),A=T.currentViewpoint.getSightDirection().setLength(T.currentViewpoint.camera.near),w=T.currentViewpoint.getEyePosition().add(A),M=(new i.Plane).setFromNormalAndCoplanarPoint(T.currentViewpoint.getSightDirection(),w).intersectLine(C);if(!M)return n;Math.abs(m.z)>1?(m=T.currentViewpoint.project(M),v.x===l.x&&v.y===l.y&&v.z===l.z&&p(c=m.clone())):(D=T.currentViewpoint.project(M),y.x===l.x&&y.y===l.y&&y.z===l.z&&p(c=D.clone()))}if(m.x<x&&D.x<x||m.x>u&&D.x>u||m.y<h&&D.y<h||m.y>g&&D.y>g)return n;var P=D.x-m.x!=0?(D.y-m.y)/(D.x-m.x):"infinity";P="infinity"!==P?Math.round(100*P)/100:"infinity",Math.abs(P)>1e7&&(P="infinity");var V=Math.round("infinity"!==P?m.y-m.x*P:m.y);if(c.y<=h){if(0===P)return n;if(c.x>x&&c.x<u)b.x="infinity"!==P?-1*V/P:m.x,b.y=h;else if(c.x<=x){if("infinity"===P)return n;P*x+V>h&&P*x+V<g?(b.x=x,b.y=P*x+V):(b.x=-1*V/P,b.y=h)}else{if("infinity"===P)return n;P*u+V>h&&P*u+V<g?(b.x=u,b.y=P*u+V):(b.x=-1*V/P,b.y=h)}}else if(c.y>=g){if(0===P)return n;if(c.x>x&&c.x<u)b.x="infinity"!==P?(g-V)/P:m.x,b.y=g;else if(c.x<=x){if("infinity"===P)return n;P*x+V>h&&P*x+V<g?(b.x=x,b.y=P*x+V):(b.x=(g-V)/P,b.y=g)}else{if("infinity"===P)return n;P*u+V>h&&P*u+V<g?(b.x=u,b.y=P*u+V):(b.x=(g-V)/P,b.y=g)}}else if(c.x<=x){if("infinity"===P)return n;c.y>h&&c.y<g&&(b.x=x,b.y=0!==P?P*x+V:m.y)}else if(c.x>=u){if("infinity"===P)return n;c.y>h&&c.y<g&&(b.x=u,b.y=0!==P?P*u+V:m.y)}if(b.x>=x&&b.y>=h&&b.x<=u&&b.y<=g&&b.x>=Math.min(m.x,D.x)-f.width&&b.y>=Math.min(m.y,D.y)-f.height&&b.x<=Math.max(m.x,D.x)+f.width&&b.y<=Math.max(m.y,D.y)+f.height){b.x=Math.floor(b.x),b.y=Math.floor(b.y);for(var S=0;S<ze.length;S++)if(ze[S].label.name===e.name&&null===ze[S].isUsed&&ze[S].label.gridID===e.gridID){n=ze[S];break}n||(r=e.canvasNodeTexture._canvas2DCanvas,a=document.createElement("canvas"),o=a.getContext("2d"),a.width=r.width,a.height=r.height,o.drawImage(r,0,0),(n=a).style.transform="scale("+1/window.devicePixelRatio+")",n.className="Grid3D_AnchoredLabel",n.style.position="absolute",n.ondrag=function(){},n.label=e,H&&(n.addEventListener("mouseenter",st),n.addEventListener("mouseleave",ct),n.addEventListener("mousedown",pt),n.addEventListener("mousemove",mt),n.addEventListener("mouseup",Dt),n.addEventListener("touchstart",pt),n.addEventListener("touchmove",mt),n.addEventListener("touchend",Dt)),ze.push(n)),n.isUsed=!0,n.style.visibility="";var O=0,R=0;b.x===x&&(O=-5,R=n.height/2),b.y===h&&(O=n.width/2,R=-5),b.x===u&&(O=n.width+5,R=n.height/2),b.y===g&&(O=n.width/2,R=n.height+5),O=Math.floor(O),R=Math.floor(R),n.position2D={x:b.x,y:b.y},n.offset2D={x:O,y:R},n.style.top=b.y-R+"px",n.style.left=b.x-O+"px",n.parentNode||z.appendChild(n)}}return n},vt=function(e){var t,n,r,a,o,d,l,s,c;if(z){if(e)for(ze.splice(0,ze.length);z.firstChild;)z.removeChild(z.firstChild);else{for(t=z.childNodes.length-1;t>=0;t--)z.childNodes[t].style.visibility="hidden";for(t=0;t<ze.length;t++)ze[t].isUsed=null}var u=[],g=[];for(t=0;t<L.length;t++)if(L[t].grid&&L[t].grid.isVisible())for(var x=(new i.Matrix4).multiplyMatrices(L[t].grid.getMatrix(),k),h=0;h<L[t].grid.children.length;h++)if(L[t].grid.children[h].isVisible()){var f=L[t].grid.children[h].children[1];if(f&&f.isVisible())for(var p=0;p<f.children.length;p++){var m=f.children[p];if(m.isVisible())for(var D=0;D<m.children.length;D++){var b=bt(m.children[D],x);if(b){var v="x:"+b.position2D.x+", y:"+b.position2D.y,y=u.indexOf(v);-1!==y&&(n=b,r=g[y],a=void 0,o=void 0,d=void 0,l=void 0,s=void 0,c=void 0,a=0,o=0,d=Ye.width-Ye.right,l=Ye.height-Ye.bottom,s=Ye.left,c=Ye.top,n.position2D.x===s&&(a=-5-r.width),n.position2D.y===c&&(o=-5-r.height),n.position2D.x===d&&(a=r.width+5),n.position2D.y===l&&(o=r.height+5),n.style.top=n.position2D.y-n.offset2D.y-o+"px",n.style.left=n.position2D.x-n.offset2D.x-a+"px"),u.push(v),g.push(b)}}}}}},yt=function(e){var t={};return e.origin.x+e.xAxis<e.origin.x?t.x="max":t.x="min",e.origin.y+e.yAxis<e.origin.y?t.y="max":t.y="min",e.origin.z+e.zAxis<e.origin.z?t.z="max":t.z="min",t},Ct=function(e){if(e.grid){var t={origin:(new i.Vector3).copy(e.gridDataPreference.origin),xAxis:Math.abs(e.gridDataPreference.xAxis),yAxis:Math.abs(e.gridDataPreference.yAxis),zAxis:Math.abs(e.gridDataPreference.zAxis)};e.gridDataPreference.xAxis<0&&(t.origin.x+=e.gridDataPreference.xAxis),e.gridDataPreference.yAxis<0&&(t.origin.y+=e.gridDataPreference.yAxis),e.gridDataPreference.zAxis<0&&(t.origin.z+=e.gridDataPreference.zAxis),t.origin.applyMatrix4(e.grid.getMatrix());var n=new i.Vector3(0,t.yAxis,0),r=new i.Vector3(t.xAxis,0,0);n.applyMatrix4(k),r.applyMatrix4(k);var a=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(t.xAxis,0,0),r=new i.Vector3(0,0,t.zAxis),n.applyMatrix4(k),r.applyMatrix4(k);var o=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(0,0,t.zAxis),r=new i.Vector3(0,t.yAxis,0),n.applyMatrix4(k),r.applyMatrix4(k);var d=(new i.Vector3).crossVectors(n,r),l=T.currentViewpoint.getSightDirection();return l.dot(a)<0&&l.dot(o)>0&&l.dot(d)>0?t.zAxis=-t.zAxis:l.dot(a)>0&&l.dot(o)<0&&l.dot(d)>0?t.yAxis=-t.yAxis:l.dot(a)>0&&l.dot(o)>0&&l.dot(d)<0?t.xAxis=-t.xAxis:l.dot(a)<0&&l.dot(o)<0&&l.dot(d)>0?(t.yAxis=-t.yAxis,t.zAxis=-t.zAxis):l.dot(a)>0&&l.dot(o)<0&&l.dot(d)<0?(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis):l.dot(a)<0&&l.dot(o)>0&&l.dot(d)<0?(t.xAxis=-t.xAxis,t.zAxis=-t.zAxis):l.dot(a)<0&&l.dot(o)<0&&l.dot(d)<0&&(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis,t.zAxis=-t.zAxis),yt(t)}},At=function(e){if(e.grid&&"userDefined"!==e.originType)if(ce&&te&&e===ae)te.updateAutomaticCorner();else{var t=Ct(e),i=yt(e.gridDataPreference);t.x===i.x&&t.y===i.y&&t.z===i.z||(e.bBox?U.drawGrids({specifications:[e.bBox]}):e.root&&U.drawGrids({rootPaths:[e.root]}))}},wt=function(e){var t=new i.Vector2(0,0),n=e.positionOnAxis;return"left"===e.anchor?"first"===n?t.x=e.width:"last"===n?(t.x=e.width,t.y=e.height):(t.x=e.width,t.y=e.height/2):"right"===e.anchor?"last"===n?t.y=e.height:"first"!==n&&(t.y=e.height/2):"top"===e.anchor?"first"===n?t.y=-e.height/3:"last"===n?(t.x=e.width,t.y=-e.height/3):(t.x=e.width/2,t.y=-e.height/3):"bottom"===e.anchor&&("first"===n?t.y=4*e.height/3:"last"===n?(t.x=e.width,t.y=4*e.height/3):(t.x=e.width/2,t.y=4*e.height/3)),t.x=Math.round(10*t.x)/10,t.y=Math.round(10*t.y)/10,e.node&&(e.node.hotspotWidth=e.width,e.node.hotspotHeight=e.height),t},Mt=function(e){var t=e.isFirst?"first":!1===e.hasNext?"last":"else",i="xAxis"===e.axis&&e.axisOrientation>0||"xAxis"!==e.axis&&e.axisOrientation<0;return e.planeSightOrientation.side&&(i=!i),-1!==e.planeID.indexOf("yx")?e.planeSightOrientation.top||"left"!==e.labelPositionOnGrid&&"right"!==e.labelPositionOnGrid||(i=!i):-1===e.planeID.indexOf("yz")&&-1===e.planeID.indexOf("xz")||e.planeSightOrientation.top||"top"!==e.labelPositionOnGrid&&"bottom"!==e.labelPositionOnGrid||(i=!i),i&&"else"!==t&&(t="first"===t?"last":"first"),t},Pt=function(e){var t=(new i.Vector3).copy(e.plane.localYAxis).clone().normalize(),n=T.currentViewpoint.getSightDirection(),r=T.currentViewpoint.getUpDirection(),a=(new i.Vector3).crossVectors(n,r),o=t.projectOnPlane(a),d=0!==o.x||0!==o.y||0!==o.z?o.angleTo(r):0,l={},s={},c=it(e.plane.normal.dot(n));s.top=c>0,s.side=!1,c>0?(l.localYAxis="left",l.oppositeLocalYAxis="right",l.localXAxis="bottom",l.oppositeLocalXAxis="top"):-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?(l.localYAxis="right",l.oppositeLocalYAxis="left",l.localXAxis="bottom",l.oppositeLocalXAxis="top"):(l.localYAxis="left",l.oppositeLocalYAxis="right",l.localXAxis="top",l.oppositeLocalXAxis="bottom");var u=!1,g=null,x=null;return-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?nt(e.plane.localYAxis)>0?(g=Math.PI/2,x=Math.PI):(g=0,x=Math.PI/2):nt(e.plane.localYAxis)===c?(g=0,x=Math.PI/2):(g=Math.PI/2,x=Math.PI),d&&d>=g&&d<=x&&(u=!0,s.side=!0),u&&(l.localXAxis="bottom"===l.localXAxis?"top":"bottom",l.oppositeLocalXAxis="top"===l.oppositeLocalXAxis?"bottom":"top",l.localYAxis="right"===l.localYAxis?"left":"right",l.oppositeLocalYAxis="left"===l.oppositeLocalYAxis?"right":"left"),l.planeSightOrientation=s,l},Vt=function(e){for(var t=Pt({plane:e}),i=e.getChildByName("Labels").children,n=0;n<i.length;n++)if(i[n].isVisible())for(var r=i[n].children,a=0;a<r.length;a++){var o=Qe(r[a]),d=Mt({axis:r[a].axis,axisOrientation:r[a].axisOrientation,isFirst:r[a].labelIsFirst,hasNext:r[a].labelHasNext,labelPositionOnGrid:t[i[n].getName()],planeSightOrientation:t.planeSightOrientation,planeID:e.getName()});r[a].labelIsFirst&&r[a].labelHasNext&&Le.push({node:r[a]});var l=wt({node:r[a],anchor:t[i[n].getName()],width:o.width,height:o.height,positionOnAxis:d});l.x===o.x&&l.y===o.y&&l.width===o.width&&l.height===o.height||r[a].setHotspot(l)}},Tt=function(e){var t=e.plane.getChildByName("Labels"),i="",n="";-1!==e.plane.getName().indexOf("yx")?(i=nt(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis",t.getChildByName(i).setVisibility(e.flag),n=nt(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("yz")?(i=nt(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=nt(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("xz")&&(i=nt(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=nt(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis",t.getChildByName(n).setVisibility(e.flag))},St=function(e){if(e.grid){var t;if(0===e.gridDataPreference.xAxis||0===e.gridDataPreference.yAxis||0===e.gridDataPreference.zAxis)for(t=0;t<e.grid.children.length;t++)Tt({plane:e.grid.children[t],flag:!0});else{var i=null;for(t=0;t<e.grid.children.length;t++){var n;if((n=T.currentViewpoint.getSightDirection().clone().projectOnPlane(e.grid.children[t].normal.applyMatrix4(k))).x=parseFloat(n.x.toFixed(4)),n.y=parseFloat(n.y.toFixed(4)),n.z=parseFloat(n.z.toFixed(4)),0===n.x&&0===n.y&&0===n.z){i=e.grid.children[t].name;break}}if(i){for(e.grid.setNoZ(!0),t=0;t<e.grid.children.length;t++)e.grid.children[t].setVisibility(i===e.grid.children[t].name),i===e.grid.children[t].name&&(Tt({plane:e.grid.children[t],flag:!0}),Vt(e.grid.children[t]));ie=!0,ne=i}}T.render()}},Ot=function(){for(var e,t,n=0;n<Le.length;n++)if(!Le[n].updated){var r=Qe(t=Le[n].node),a=(new i.Vector3).getPositionFromMatrix(t.getMatrix()),o=[];for(e=0;e<Le.length;e++)if(n!==e){var d=(new i.Vector3).getPositionFromMatrix(Le[e].node.getMatrix());if(d.x===a.x&&d.y===a.y&&d.z===a.z){var l=Qe(Le[e].node);l.y<r.y-r.height||r.y-r.height>l.y||l.x<r.x-r.width||r.x-r.width>l.x||o.push(e)}}if(1===o.length){o.push(n);var s=0;for(e=0;e<o.length;e++){var c=Qe(t=Le[o[e]].node),u=new i.Vector2;u.x=c.width/2,u.y=s,t.hotspotWidth=c.width,t.hotspotHeight=c.height,u.x===c.x&&u.y===c.y||t.setHotspot(u),s+=c.height,s+=3,Le[o[e]].updated=!0}}Le[n].updated=!0}},Rt=function(e){var t,i;if(-1!==e.eventType.indexOf("@onViewpoint")){var n=T.currentViewpoint.getSightDirection();if("@onViewpointBeginMove"===e.eventType)ue=!0,ct(),Be=!0;else if("@onViewpointChange"===e.eventType){if(null===ue&&(ue=!0),!n.equals(re)){if(ie){for(t=0;t<L.length;t++)for(L[t].grid.setNoZ(!1),i=0;i<L[t].grid.children.length;i++)Vt(L[t].grid.children[i]),Tt({plane:L[t].grid.children[i],flag:!1}),L[t].grid.children[i].setVisibility(!0);ie=!1,ne=null}for(t=0;t<L.length;t++)St(L[t]);re.copy(n)}if(!Q)for(t=0;t<L.length;t++)At(L[t]);vt(ue),ue=!1}else if("@onViewpointEndMove"===e.eventType)if(ke)xt();else if(ue=null,Be=!1,vt(!0),!ie){for(Le.splice(0,Le.length),t=0;t<L.length;t++)if(L[t].grid)for(i=0;i<L[t].grid.children.length;i++)Vt(L[t].grid.children[i]);Ot()}T.render()}},Gt=function(){if(j){(te=new B({window:S,stepRequired:N.xStep,lengthUnit:Ze})).display({rootID:v.getNodeID(ae.root.getLastElement(!0)),gridDataPreference:ae.gridDataPreference,matrix:ae.grid.getMatrix(),displayHandlePoints:"userDefined"===ae.originType}),oe=te.subscribe("EndBoxChanged",function(){ae.type="userDefined",Ve.setState(!1),xe._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:[{type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"}]}}},context:O.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}),de=te.subscribe("BoxCornerChanged",function(e){!0===e.cornerChanged?(ae.originType="userDefined",Se.setState(!1),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")):Se.setState("userDefined"!==ae.originType),O.getExecutionContext?xe._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{WAfrCtxBarRow1:{model:[{type:"handler",identifier:"CATRelatedData3DGridAutoOriginHdr"}]}}},context:O.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}):xe.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoOrigin",line:1,hdr_list:["CATRelatedData3DGridAutoOriginHdr"]}]}},context:O.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})});var e=function(t){0!==T.pick(T.getMousePosition(t.from[0].currentPosition),"mesh",!1).path.length||T.currentViewpoint.isMoving()||(l.removeEvent(T.canvas,"onPrimaryPointerClick",e),me&&(O.getExecutionContext&&"CATRelatedData3DGridEditHdr"===O.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getRunningCommand()?O.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent).executeHandler({id:"CATRelatedData3DGridCancelHdr"}):me.cancel()))};me=s.getCommand("CATRelatedData3DGridEditHdr",O.getCommandContext()),l.addEvent(T.canvas,"onPrimaryPointerClick",e),he.disable()}},Et=function(e){var t;if(e){if(Be&&"Labels"===e.name)return;if(e.material&&(e.material.dispose(),e.material=null,e.canvasNodeTexture&&(e.canvasNodeTexture._canvas2DTexture&&(e.canvasNodeTexture._canvas2DTexture.dispose(),e.canvasNodeTexture._canvas2DTexture=null),e.canvasNodeTexture.materials&&e.canvasNodeTexture.materials.length)))for(t=0;t<e.materials.canvasNodeTexture.length;t++)e.canvasNodeTexture.materials[t].dispose(),e.canvasNodeTexture.materials[t]=null;for(t=e.children.length-1;t>=0;t--)Et(e.children[t]);e.removeChildren()}},zt=function(e){var t=!0;"userDefined"===e.fitToStep&&(t=!1);var n=new i.Vector3(e.min.x,e.min.y,e.min.z),r=it(e.max.x-e.min.x),a=it(e.max.y-e.min.y),o=it(e.max.z-e.min.z);j&&e.gridDMUObject&&(N.xStep=e.gridDMUObject.getAttribute("sPitch"),N.yStep=e.gridDMUObject.getAttribute("sPitch"),N.zStep=e.gridDMUObject.getAttribute("sPitch"));var d=new i.Vector3(e.min.x,e.min.y,e.min.z),l=e.max.x,s=e.max.y,c=e.max.z;t&&(d.x=r?r>0?et(n.x,N.xStep):tt(n.x,N.xStep):0,d.y=a?a>0?et(n.y,N.yStep):tt(n.y,N.yStep):0,d.z=o?o>0?et(n.z,N.zStep):tt(n.z,N.zStep):0,l=r?r>0?tt(e.max.x,N.xStep):et(e.max.x,N.xStep):0,s=a?a>0?tt(e.max.y,N.yStep):et(e.max.y,N.yStep):0,c=o?o>0?tt(e.max.z,N.zStep):et(e.max.z,N.zStep):0);var u=l-d.x,g=s-d.y,x=c-d.z,h=e.defaultOrigin;return h&&("max"===h.x&&(d.x=d.x+u,u*=-1),"max"===h.y&&(d.y=d.y+g,g*=-1),"max"===h.z&&(d.z=d.z+x,x*=-1)),{origin:d,xAxis:u,yAxis:g,zAxis:x}},Bt=function(){for(var e={gridList:[]},t=0;t<L.length;t++)e.gridList.push({rootID:L[t].gridName.split("3D Grid ")[1],gridDataPreference:L[t].gridDataPreference,type:L[t].type,originType:L[t].originType});q&&q.setValue("3DGridData",JSON.stringify(e)),localStorage.setItem("CATRelatedData3DGridDftOrigin",JSON.stringify(I))},Ut=function(e){if(ae)if("userDefined"===ae.type||e){if("userDefined"===ae.type&&e){ae.type="auto";var t=$e(ae.root),i=null;if(t)if(ce)i=zt({gridDMUObject:ae.gridDMUObject,min:t.min,max:t.max,defaultOrigin:yt(te.getDataPreference())}),te.setDataPreference(i),te.refresh();else{i=zt({gridDMUObject:ae.gridDMUObject,min:t.min,max:t.max,defaultOrigin:yt(ae.gridDataPreference)}),ae.gridDataPreference=i,U.drawGrids({rootPaths:[ae.root]});var n=[];let e=ae.gridDMUObject.getParent();n=e&&e.getCurrentSlide?[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"},{name:"CATRelatedData3DGridRemoveOverload",line:1,hdr_list:["CATRelatedData3DGridRemoveOverloadHdr"],type:"handler",identifier:"CATRelatedData3DGridRemoveOverloadHdr"}]:[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"],type:"handler",identifier:"CATRelatedData3DGridEditHdr"},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"],type:"handler",identifier:"CATRelatedData3DGridAutoFitHdr"},{name:"CATRelatedData3DGridProperties",line:1,hdr_list:["CATRelatedData3DGridPropertiesHdr"],type:"handler",identifier:"CATRelatedData3DGridPropertiesHdr"}],xe._showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return O.getExecutionContext?{WAfrCtxBarRow1:{model:n}}:{cmdList:n}},context:O.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true")}}else ae.type="userDefined",Bt(),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false")},Lt=function(e){ae&&("userDefined"===ae.originType||e?"userDefined"===ae.originType&&e&&(ae.originType="auto",ce&&(te.setHandlePointsVisibility(!1),te.updateAutomaticCorner()),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true")):(ae.originType="userDefined",Bt(),ce&&te.setHandlePointsVisibility(!0),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")))},It=function(e,t){var i=e.height-2;t.font=Z+"pt sans-serif",t.fillStyle=this.isHighlighted?"#FF8000":ge,t.fillText(this.txtValue,0,i)},Nt=function(e){var t,n=Ge.getContext("2d");n.font=Z+"pt sans-serif";var d,l=e.prefix+p.convertUnitValueToString(e.value,"Length",Ze.unit,Ze.decimalPlaceRO,qe,{displaySymbol:!1,displaySpace:!1}),s=Math.round(10*n.measureText(l).width)/10,c=Z+2;Ge.width=s,Ge.height=c;var u=e.plane.getName();for(t=0;t<Ee.length;t++)if(Ee[t].txtValue===l&&Ee[t].gridID===e.gridID){d=Ee[t].canvasNodeTexture;break}d||((d=new a({width:s,height:c,drawCB:It})).txtValue=l,d.labelValue={prefix:e.prefix,value:e.value},Ee.push({txtValue:l,canvasNodeTexture:d,gridID:e.gridID}));var g=Pt({plane:e.plane});for(t=0;t<e.position.length;t++){var x="";-1!==u.indexOf("yx")?x="yAxis"===e.axis?nt(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis":nt(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("yz")?x="yAxis"===e.axis?nt(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":nt(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("xz")&&(x="xAxis"===e.axis?nt(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":nt(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis"),t>0&&("localXAxis"===x?x="oppositeLocalXAxis":"oppositeLocalXAxis"===x?x="localXAxis":"localYAxis"===x?x="oppositeLocalYAxis":"oppositeLocalYAxis"===x&&(x="localYAxis"));var h=Mt({axis:e.axis,axisOrientation:e.gridData[e.axis],planeID:u,isFirst:e.isFirst,hasNext:e.hasNext,planeSightOrientation:g.planeSightOrientation,labelPositionOnGrid:g[x]}),f=wt({anchor:g[x],positionOnAxis:h,width:s,height:c}),m=r.createCanvas2DNode({name:l,hotspot:f,canvasNodeTexture:d});m.hotspotWidth=s,m.hotspotHeight=c,m.setMatrix((new i.Matrix4).makeTranslation(e.position[t].x,e.position[t].y,e.position[t].z)),m.setPickable(o.PICKABLE),m.labelIsFirst=e.isFirst,m.gridID=e.gridID,m.labelHasNext=e.hasNext,m.axis=e.axis,m.axisOrientation=e.gridData[e.axis],m.boundaries=[e.position[0].clone(),e.position[1].clone()],e.labels.getChildByName(x).addChild(m),he&&(fe[e.gridID]||(fe[e.gridID]=[]),fe[e.gridID].push(he.linkToNode(m))),e.isFirst&&e.hasNext&&Le.push({node:m})}},kt=function(){var e=new i.Vector3,t=new i.Vector3,n=new i.Vector3,r=new i.Vector3;k.extractBasis(t,n,r);var a=new i.Vector3(k.elements[12],k.elements[13],k.elements[14]);return e.x=t.dot(a),e.y=n.dot(a),e.z=r.dot(a),e},Ft=function(e){let t={x:e.gridData.gridDMUObject.getAttribute("sLabelPrefixX"),y:e.gridData.gridDMUObject.getAttribute("sLabelPrefixY"),z:e.gridData.gridDMUObject.getAttribute("sLabelPrefixZ")};var r;j&&e.gridDMUObject&&(N.xStep=e.gridDMUObject.getAttribute("sPitch"),N.yStep=e.gridDMUObject.getAttribute("sPitch"),N.zStep=e.gridDMUObject.getAttribute("sPitch")),Le.splice(0,Le.length),X&&(r=kt());for(var a,o=["yx","yz","xz"],d=0;d<o.length;d++){var l=e.gridData.gridDataPreference,s=o[d].charAt(0),c=o[d].charAt(1),u=s+"Axis",g=c+"Axis",x=e.gridData.grid.getChildByName(o[d]+" Plane");if(0!==l[u]&&0!==l[g]&&x){var h=x.getChildByName("Labels");if(h)for(a=0;a<h.children.length;a++)h.children[a].removeChildren();else(h=new n("Labels")).addChild(new n("localXAxis")),h.addChild(new n("localYAxis")),h.addChild(new n("oppositeLocalXAxis")),h.addChild(new n("oppositeLocalYAxis")),x.addChild(h);var f=s+"Step",p=c+"Step",m=it(l[u])<0?et(l.origin[s],N[f]):tt(l.origin[s],N[f]),D=m,b=0;if(X)for("x"===s&&(D=D=it(m)<0?m+r.x:m-r.x),"y"===s&&(D=D=it(m)<0?m+r.y:m-r.y),"z"===s&&(D=D=it(m)<0?m+r.z:m-r.z);Math.abs(D)>Math.abs(l.origin[s]);)b+=N[f],D=it(D)<0?D+=N[f]:D-=N[f];var v,y,C=0;for(a=0;Math.abs(D+a*it(l[u])-l.origin[s])<=Math.abs(l[u]);a+=N[f])0!==C&&C%e.gridData.labelRatio!=0&&C!==e.labelsInfos[o[d]].fstAxis||(v=(new i.Vector3).copy(l.origin),y=(new i.Vector3).copy(l.origin),v[s]=D+a*it(l[u]),v[c]=l.origin[c],y[s]=D+a*it(l[u]),y[c]=l.origin[c]+l[g],Nt({prefix:t[s],value:Math.pow(10,-3)*(m+b+a*it(l[u])),isFirst:0===a,hasNext:Math.abs(D+(a+N[f])*it(l[u])-l.origin[s])<=Math.abs(l[u]),position:[v,y],axis:u,labels:h,plane:x,gridData:l,gridID:e.gridData.grid.getName()})),C++;var A=it(l[g])<0?et(l.origin[c],N[p]):tt(l.origin[c],N[p]),w=0,M=A;if(X)for("x"===c&&(M=M=it(A)<0?A+r.x:A-r.x),"y"===c&&(M=M=it(A)<0?A+r.y:A-r.y),"z"===c&&(M=M=it(A)<0?A+r.z:A-r.z);Math.abs(M)>Math.abs(l.origin[c]);)w+=N[p],M=it(M)<0?M+=N[p]:M-=N[p];for(C=0,a=0;Math.abs(M+a*it(l[g])-l.origin[c])<=Math.abs(l[g]);a+=N[p])0!==C&&C%e.gridData.labelRatio!=0&&C!==e.labelsInfos[o[d]].scdAxis||(v=(new i.Vector3).copy(l.origin),y=(new i.Vector3).copy(l.origin),v[s]=l.origin[s],v[c]=M+a*it(l[g]),y[s]=l.origin[s]+l[u],y[c]=M+a*it(l[g]),Nt({prefix:t[c],value:Math.pow(10,-3)*(A+w+a*it(l[g])),isFirst:0===a,hasNext:Math.abs(M+(a+N[p])*it(l[g])-l.origin[c])<=Math.abs(l[g]),position:[v,y],axis:g,labels:h,plane:x,gridData:l,gridID:e.gridData.grid.getName()})),C++;ie&&ne===x.name?Tt({plane:x,flag:!0}):Tt({plane:x,flag:!1})}}Ot()},jt=function(e,t){if(t){j&&(N.xStep=e,N.yStep=e,N.zStep=e);for(var i,n={max:0},r=["yx","yz","xz"],a=0;a<r.length;a++){var o=r[a].charAt(0),d=r[a].charAt(1),l=o+"Axis",s=d+"Axis";if(0!==t[l]&&0!==t[s]){var c=o+"Step",u=d+"Step";n[r[a]]={};var g=0,x=it(t[l])<0?et(t.origin[o],N[c]):tt(t.origin[o],N[c]);for(i=0;Math.abs(x+i*it(t[l])-t.origin[o])<=Math.abs(t[l]);i+=N[c])g++,n.max++;n[r[a]].fstAxis=g,g=0;var h=it(t[s])<0?et(t.origin[d],N[u]):tt(t.origin[d],N[u]);for(i=0;Math.abs(h+i*it(t[s])-t.origin[d])<=Math.abs(t[s]);i+=N[u])g++,n.max++;n[r[a]].scdAxis=g}}return n}},Ht=function(e){var t,i=0,n=[];for(t=0;t<L.length;t++)if(L[t].grid&&L[t].gridDMUObject&&L[t].gridDataPreference){let e=L[t].gridDMUObject.getAttribute("sPitch");var r=jt(e,L[t].gridDataPreference);r&&(n.push(r),i+=r.max)}var a=i,o=1;if(_)for(;i>_;)i=a/++o;for(t=0;t<L.length;t++)L[t].grid&&(L[t].labelRatio!==o||e)&&(L[t].labelRatio=o,Ft({gridData:L[t],labelsInfos:n[t]}));vt(!0)};function Wt(e){e.forEach(function(e){if("cke"===e.name){let t=!1;e.preferences.forEach(function(e){"Length"===e.name&&Ze.unit!==e.value?(Ze.unit=e.value,t=!0):"LengthCalcDisplay"===e.name&&Ze.decimalPlaceRO!==parseInt(e.value)?(Ze.decimalPlaceRO=parseInt(e.value),t=!0):"TrailingZeros"===e.name&&(qe=e.value,t=!0)}),t&&(Ht(!0),T.render(),te&&te.updateUnit(Ze))}})}function Xt(){return new Promise(function(e){if(E)return e();p.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay"]}]).then(function(t){Wt(t.repositories),E=!0,e()}).catch(function(t){window.console.warn("Error Preferences ",t),e()})})}var _t=function(){V||(V=Xt()),V.then(function(){ce=!0,at(t.rootBagPath);for(var e=0;e<L.length;e++)ot(L[e].root,{type:"pickability",value:"NOT_PICKABLE"}),L[e].grid.name===ae.grid.name&&Et(L[e].grid);for(;z.firstChild;)z.removeChild(z.firstChild);B?Gt():require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle"],function(e){B=e,Gt()})}).catch(function(e){window.console.warn("Error Preferences ",e)})},Yt=function(){V||(V=Xt()),V.then(function(){Xe=new y({title:"Properties",content:function(){if(!ae||!ae.gridDMUObject)return;let t=ae.gridDMUObject.getAttribute("sPitch"),i=ae.gridDMUObject.getAttribute("sLabelPrefixX"),n=ae.gridDMUObject.getAttribute("sLabelPrefixY"),r=ae.gridDMUObject.getAttribute("sLabelPrefixZ"),a=new e.Element("div");var o=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(a);o.setStyles({paddingTop:"5px"});var d=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(o);d.innerHTML=P.lblPitch,d.setStyles({width:"50%",fontWeight:"normal",marginRight:"5px"});var l=Ze.unit;(Fe=new A({value:t,units:p.Length.Millimeter.symbol,minValue:1,maxValue:1e5,stepValue:1})).value=p.convert(t,"Length","Millimeter",Ze.unit),Fe.units=p.Length[l].symbol,Fe.inject(o),Fe.elements.container.setStyles({width:"50%",marginRight:"10px"});var s=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(a);s.setStyles({paddingTop:"5px"});var c=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(s);c.innerHTML=P.lblDirection1,c.setStyles({width:"50%",fontWeight:"normal",marginRight:"5px"}),(je=new w({value:i,selectAllOnFocus:!0,autoCommitFlag:!0,maxLength:3}).inject(s)).elements.container.setStyles({width:"50%",marginRight:"10px"});var u=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(a);u.setStyles({paddingTop:"5px"});var g=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(u);g.innerHTML=P.lblDirection2,g.setStyles({width:"50%",fontWeight:"normal",marginRight:"5px"}),(He=new w({value:n,selectAllOnFocus:!0,autoCommitFlag:!0,maxLength:3}).inject(u)).elements.container.setStyles({width:"50%",marginRight:"10px"});var x=e.createElement("div",{class:"CATRelatedData3DGridPanelFlex",marginBottom:"5px"}).inject(a);x.setStyles({paddingTop:"5px"});var h=e.createElement("div",{class:"CATRelatedData3DGridPanelLabel"}).inject(x);return h.innerHTML=P.lblDirection3,h.setStyles({width:"50%",fontWeight:"normal",marginRight:"5px"}),(We=new w({value:r,selectAllOnFocus:!0,autoCommitFlag:!0,maxLength:3}).inject(x)).elements.container.setStyles({width:"50%",marginRight:"10px"}),a}(),buttons:{Ok:new C({label:P.lblOk,onClick:function(){var e={};e.PitchValue=p.convert(Fe.value,"Length",Ze.unit,"Millimeter"),e.Direction1=je.value,e.Direction2=He.value,e.Direction3=We.value,U.setGridProperties(e),U.drawGrids({rootPaths:O.getRootBagPath().getChildrenPathes()}),O.getExecutionContext?ve.cancelExecute():ve.cancel()}}),Apply:new C({label:P.lblApply,onClick:function(){var e={};e.PitchValue=p.convert(Fe.value,"Length",Ze.unit,"Millimeter"),e.Direction1=je.value,e.Direction2=He.value,e.Direction3=We.value,U.setGridProperties(e),U.drawGrids({rootPaths:O.getRootBagPath().getChildrenPathes()})}}),Cancel:new C({label:P.lblClose,onClick:function(){O.getExecutionContext?ve.cancelExecute():ve.cancel()}})}})})},Zt=function(){for(var e=0;e<L.length;e++)if(L[e].grid.name===ae.grid.name){let t=L[e].gridDMUObject.getParent();t&&(t&&t.removeDMUObjects?t.removeDMUObjects([L[e].gridDMUObject]):t&&t.getCurrentSlide()&&(t.getCurrentSlide().removeDMUObject(L[e].gridDMUObject),t.getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:t.getCurrentSlide()})));let i=ae.grid.name;Et(L[e].grid),T.removeNode(L[e].grid),ai(i),oi(i),di(i),Ae&&Ae.cancel();break}Ae&&Ae.cancel()};let qt=function(e){if(!e.gridDMUObject)return;let t="userDefined"===e.type;t!==e.gridDMUObject.getAttribute("bIsBBOverloaded")&&e.gridDMUObject.setAttribute("bIsBBOverloaded",t);let n=e.gridDataPreference.origin,r=(new i.Vector3).setFromArray([n.x+e.gridDataPreference.xAxis,n.y+e.gridDataPreference.yAxis,n.z+e.gridDataPreference.zAxis]);e.gridDMUObject.setAttribute("vBBMin",(new i.Vector3).setFromArray([Math.min(n.x,r.x),Math.min(n.y,r.y),Math.min(n.z,r.z)])),e.gridDMUObject.setAttribute("vBBMax",(new i.Vector3).setFromArray([Math.max(n.x,r.x),Math.max(n.y,r.y),Math.max(n.z,r.z)]));let a=0;"userDefined"===e.originType&&(a=Je(yt(e.gridDataPreference))),a!==e.gridDMUObject.getAttribute("idxLockedOrigin")&&e.gridDMUObject.setAttribute("idxLockedOrigin",a)},Kt=function(e){if(!e.gridDMUObject||!e.gridDataPreference)return;e.type=e.gridDMUObject.getAttribute("bIsBBOverloaded")?"userDefined":"auto";let t=e.gridDMUObject.getAttribute("vBBMin"),n=e.gridDMUObject.getAttribute("vBBMax");if(t&&n){let r=[n.x-t.x,n.y-t.y,n.z-t.z],a=[0,0,0],o=[0,0,0];switch(e.gridDMUObject.getAttribute("idxLockedOrigin")){case 0:case 1:a[0]=t.x,a[1]=t.y,a[2]=t.z,o[0]=r[0],o[1]=r[1],o[2]=r[2];break;case 2:a[0]=n.x,a[1]=t.y,a[2]=t.z,o[0]=-r[0],o[1]=r[1],o[2]=r[2];break;case 3:a[0]=t.x,a[1]=n.y,a[2]=t.z,o[0]=r[0],o[1]=-r[1],o[2]=r[2];break;case 4:a[0]=n.x,a[1]=n.y,a[2]=t.z,o[0]=-r[0],o[1]=-r[1],o[2]=r[2];break;case 5:a[0]=t.x,a[1]=t.y,a[2]=n.z,o[0]=r[0],o[1]=r[1],o[2]=-r[2];break;case 6:a[0]=n.x,a[1]=t.y,a[2]=n.z,o[0]=-r[0],o[1]=r[1],o[2]=-r[2];break;case 7:a[0]=t.x,a[1]=n.y,a[2]=n.z,o[0]=r[0],o[1]=-r[1],o[2]=-r[2];break;case 8:a[0]=n.x,a[1]=n.y,a[2]=n.z,o[0]=-r[0],o[1]=-r[1],o[2]=-r[2]}e.gridDataPreference.origin=(new i.Vector3).setFromArray(a),e.gridDataPreference.xAxis=o[0],e.gridDataPreference.yAxis=o[1],e.gridDataPreference.zAxis=o[2]}e.originType=0===e.gridDMUObject.getAttribute("idxLockedOrigin")?"auto":"userDefined"},Jt=function(){if(ce){te.unsubscribe(null),te.unsubscribe(oe),te.unsubscribe(de);for(var e=0;e<L.length;e++)if(L[e].grid.name===ae.grid.name){te.isSizeOK()&&(L[e].gridDataPreference=te.getDataPreference(),L[e].type=ae.type,L[e].originType=ae.originType,I=yt(L[e].gridDataPreference),qt(L[e]));break}te.clean(),te=null,ce=!1,rt(),U.drawGrids({rootPaths:[ae.root]}),he.enable()}};let Qt=function(){Xe&&(Xe.destroy(),Xe=null),xe&&xe.activateContextualBar(),he&&he.enable()},$t=function(){xe&&xe.activateContextualBar(),he&&he.enable()};let ei=async function(){let e,t=S.getExecutionContext?S.getExecutionContext():void 0;t&&(e=t.getComponent(WAfrStandardComponentKey.HandlerComponent),await e.setCheckState({id:"CATRevealRelatedDataHdr",state:"false"!==localStorage.getItem("CATRevealRelatedDataCmd")}),await e.setCheckState({id:"CATRelatedData3DGridAutoFitHdr",state:"false"!==localStorage.getItem("CATRelatedData3DGridAutoFitCmd")}))};this.setActiveState=function(t){var i;if(t!==G)if(G=t)Ge||(Ge=document.createElement("canvas")),z||(z=e.createElement("div").inject(S.getUIFrame())),Re=d.subscribe({event:"/VISU/"},Rt),re.copy(T.currentViewpoint.getSightDirection()),H&&((he=new c).setExclusive(!0),pe.beginPreactivate=he.onBeginPreactivate(st),pe.endPreactivate=he.onEndPreactivate(ct),pe.primaryPointerClick=he.onPrimaryPointerClick(ht),pe.beginManipulate=he.onBeginManipulate(gt),pe.manipulate=he.onManipulate(ut),pe.endanipulate=he.onEndManipulate(xt)),S.getExecutionContext&&setTimeout(ei,500),j&&(O&&(me=O.getExecutionContext?s.getCommand("CATRelatedData3DGridEditHdr",O.getExecutionContext()):new u({ID:"CATRelatedData3DGridEditHdr",isEnabled:!0,context:O.getCommandContext()}),De=O.getExecutionContext?me.onBeginExecute(function(){_t()}):me.onBegin(function(){_t()}),be=O.getExecutionContext?me.onEndExecute(function(){Jt()}):me.onEnd(function(){Jt()})),function(){if(O.getExecutionContext){let e=O.getExecutionContext();e&&((Ve=s.getCommandCheckHeader("CATRelatedData3DGridAutoFitHdr",e)).setState(!0),Te=Ve.onStateChange(function(){Ut(Ve.getState())}))}else Ve=new g({ID:"CATRelatedData3DGridAutoFitHdr",isEnabled:!0,context:O.getCommandContext()}),Te=Ve.onStateChange(function(){Ut(this.getState())})}(),function(){if(O.getExecutionContext){let e=O.getExecutionContext?O.getExecutionContext():void 0;e&&((Se=s.getCommandCheckHeader("CATRelatedData3DGridAutoOriginHdr",e)).setState(!0),Se.onStateChange(function(){Lt(Se.getState())}))}else Se=new x({ID:"CATRelatedData3DGridAutoOriginHdr",isEnabled:!0,context:O.getCommandContext()}),Oe=Se.onStateChange(function(){Lt(this.getState())})}(),O&&(ve=O.getExecutionContext?s.getCommand("CATRelatedData3DGridPropertiesHdr",O.getExecutionContext()):new h({ID:"CATRelatedData3DGridPropertiesHdr",isEnabled:!0,context:O.getCommandContext()}),ye=O.getExecutionContext?ve.onBeginExecute(function(e){ve=e,O&&O.getFrameWindow()&&O.getFrameWindow().getContextualUIManager()&&O.getFrameWindow().getContextualUIManager().deactivateContextualBar(),Yt()}):ve.onBegin(function(e){ve=e,he.disable(),Yt()}),Ce=O.getExecutionContext?ve.onEndExecute(function(e){ve=e,Qt()}):ve.onEnd(function(e){ve=e,Qt()})),O&&(Ae=O.getExecutionContext?s.getCommand("CATRelatedData3DGridRemoveOverloadHdr",O.getExecutionContext()):new f({ID:"CATRelatedData3DGridRemoveOverloadHdr",isEnabled:!0,context:O.getCommandContext()}),we=O.getExecutionContext?Ae.onBeginExecute(function(e){Ae=e,O&&O.getFrameWindow()&&O.getFrameWindow().getContextualUIManager()&&O.getFrameWindow().getContextualUIManager().deactivateContextualBar(),Zt()}):Ae.onBegin(function(e){Ae=e,he.disable(),Zt()}),Me=O.getExecutionContext?Ae.onEndExecute(function(e){Ae=e,$t()}):Ae.onEnd(function(e){Ae=e,$t()}))),V||(V=Xt()),(i=m.getPreferenceManager({context:S}))&&(J=i.subscribe("com.ds.mep:onPrefUpdate",function(e){Wt(JSON.parse(e[1].preferences).repositories)}));else{var n;z&&S.getUIFrame().removeChild(z),z=null,Ge=null,d.unsubscribe(Re),Re=0,H&&((n=Object.keys(pe)).forEach(function(e){he.unsubscribe(pe[e])}),pe={}),(i=m.givePreferenceManager({context:S}))&&(i.unsubscribe(J),J=null),m.unreferencePreferenceManager({context:S}),V=null,E=!1,j&&(ve&&ve.cancel(),O.getExecutionContext?(d.unsubscribe(be),d.unsubscribe(De),d.unsubscribe(Ce),d.unsubscribe(ye),d.unsubscribe(Me),d.unsubscribe(we),d.unsubscribe(Te),d.unsubscribe(Oe)):(d.unsubscribe(be),d.unsubscribe(De),d.unsubscribe(Ce),d.unsubscribe(ye),d.unsubscribe(Me),d.unsubscribe(we),Ve._modelEvents.unsubscribe(Te),Se._modelEvents.unsubscribe(Oe)),be=null,De=null,me=null,Te=null,Ve=null,Oe=null,Se=null,ye=null,Ce=null,ve=null,we=null,Me=null,Ae=null),n=Object.keys(fe);for(var r=0;r<n.length;r++)for(var a=0;a<fe[n[r]].length;a++)he.unlink(fe[n[r]][a]);fe={}}},this.endEditMode=function(){me&&(O.getExecutionContext&&"CATRelatedData3DGridEditHdr"===O.getExecutionContext().getComponent(WAfrStandardComponentKey.CommandsManagerComponent).getRunningCommand()?(Jt(),O.getExecutionContext().getComponent(WAfrStandardComponentKey.HandlerComponent).executeHandler({id:"CATRelatedData3DGridCancelHdr"})):me.cancel())};var ti=function(e,t){var n,r;if("userDefined"!==e.type){let i=e.gridDMUObject?e.gridDMUObject.getAttribute("idxLockedOrigin"):0;r=zt({gridDMUObject:e.gridDMUObject,min:t.min,max:t.max,defaultOrigin:i>0?R[i]:{x:"min",y:"min",z:"min"}})}else r=e.gridDataPreference;if((n="userDefined"===e.originType?yt(e.gridDataPreference):Ct(e))&&(r=function(e,t,n){for(var r,a,o=t.origin,d=[new i.Vector3(o.x,o.y,o.z),new i.Vector3(o.x+t.xAxis,o.y,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z+t.zAxis)],l=0;l<d.length;l++)void 0===r&&void 0===a?(r=(new i.Vector3).copy(d[l]),a=(new i.Vector3).copy(d[l])):(r.x=Math.min(d[l].x,r.x),r.y=Math.min(d[l].y,r.y),r.z=Math.min(d[l].z,r.z),a.x=Math.max(d[l].x,a.x),a.y=Math.max(d[l].y,a.y),a.z=Math.max(d[l].z,a.z));return zt({gridDMUObject:e.gridDMUObject,min:r,max:a,defaultOrigin:n,fitToStep:e.type})}(e,r,n)),r!==e.gridDataPreference)return r},ii=function(e){var t;if(K.gridList&&K.gridList.length>0)for(var i=0;i<K.gridList.length;i++){if((t=K.gridList[i]).rootID===e.split("3D Grid ")[1]){K.gridList.splice(i,1);break}t=null}return t},ni=function(e,t,i){for(var n,r=0;r<L.length;r++)if(L[r].gridName===e){if(t&&(L[r].root=t.clone()),i&&(L[r].bBox=i.clone()),n=L[r],fe&&fe[e]){for(var a=0;a<fe[e].length;a++)he.unlink(fe[e][a]);fe[e].splice(0,fe[e].length)}break}return n},ri=function(e,a,d,l,s,c){var u,g,x,h,f,p,m,D=!0,b=[];let v=!1;var y=null;return c&&(y=c.getGridRvwContext()),e&&(h=e.gridDataPreference,e.type&&(f=e.type),e.originType&&(p=e.originType)),a?(a.grid||(a.grid=new n(a.gridName),a.grid.setVisibilityFree(!0)),u=a.grid,h=a.gridDataPreference,f=a.type,p=a.originType,D=a.visibility,a.gridDMUObject||(u||(u=new n(s)),a.gridDMUObject=new M(T,y),a.savedDMUObject=a.gridDMUObject,b.push({attribute:"sType",value:"3DGrid"}),b.push({attribute:"sPitch",value:N.xStep}),b.push({attribute:"sLabelPrefixX",value:Y.x}),b.push({attribute:"sLabelPrefixY",value:Y.y}),b.push({attribute:"sLabelPrefixZ",value:Y.z}),b.push({attribute:"bIsBBOverloaded",value:!1}),b.push({attribute:"vBBMin",value:null}),b.push({attribute:"vBBMax",value:null}),b.push({attribute:"idxLockedOrigin",value:"userDefined"===p?Je(I):0}),a.gridDMUObject.set(b),a.root=l?l.clone():void 0,v=!0),m=a.gridDMUObject):(N={xStep:t.stepRequiredX,yStep:t.stepRequiredY,zStep:t.stepRequiredZ},Y=t.labels?t.labels:{x:"L",y:"W",z:"H"},u=new n(s),m=new M(T,y),v=!0,b.push({attribute:"sType",value:"3DGrid"}),b.push({attribute:"sPitch",value:N.xStep}),b.push({attribute:"sLabelPrefixX",value:Y.x}),b.push({attribute:"sLabelPrefixY",value:Y.y}),b.push({attribute:"sLabelPrefixZ",value:Y.z}),b.push({attribute:"bIsBBOverloaded",value:!1}),b.push({attribute:"vBBMin",value:null}),b.push({attribute:"vBBMax",value:null}),s==="3D Grid "+F?void 0===p&&(p="auto"):void 0===p&&(p="false"===localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")?"userDefined":"auto"),b.push({attribute:"idxLockedOrigin",value:"userDefined"===p?Je(I):0}),m.set(b),u.setVisibilityFree(!0),s==="3D Grid "+F?(void 0===f&&(f="userDefined"),void 0===h&&(h=zt({gridDMUObject:m,savedDMUObject:m,min:d.min,max:d.max,defaultOrigin:I,fitToStep:f})),a={bBox:d?d.clone():void 0,gridName:s,grid:u,gridDataPreference:h,type:f,originType:p,gridDMUObject:m}):(void 0===f&&(f="false"===localStorage.getItem("CATRelatedData3DGridAutoFitCmd")?"userDefined":"auto"),void 0===h&&(h=zt({gridDMUObject:m,savedDMUObject:m,min:d.min,max:d.max,defaultOrigin:I})),a={root:l?l.clone():void 0,gridName:s,grid:u,gridDataPreference:h,type:f,originType:p,gridDMUObject:m}),L.push(a),c&&c.onGridAddedToGridList({addedGrid:a})),Et(u),a.labelRatio=null,u.setVisibility(D),a.visibility=D,a.previousVisibility=D,v&&(a.previousMode="Default",a.mode="Default"),(g=ti(a,d))&&(a.gridDataPreference=g),(x=a.gridDMUObject)&&(a.gridDMUObject=x),(v||"Default"===a.mode)&&c&&c.addGridDMUObject(a),function(e){var t,a=["yx","yz","xz"];j&&e.gridDMUObject&&(N.xStep=e.gridDMUObject.getAttribute("sPitch"),N.yStep=e.gridDMUObject.getAttribute("sPitch"),N.zStep=e.gridDMUObject.getAttribute("sPitch"));let d={x:e.gridData.gridDMUObject.getAttribute("sLabelPrefixX"),y:e.gridData.gridDMUObject.getAttribute("sLabelPrefixY"),z:e.gridData.gridDMUObject.getAttribute("sLabelPrefixZ")};var l;X&&(l=kt());for(var s=0;s<a.length;s++){var c=e.gridData.gridDataPreference,u=a[s].charAt(0),g=a[s].charAt(1),x=u+"Axis",h=g+"Axis";if(0!==c[x]&&0!==c[h]){var f=new n(u+g+" Plane");e.gridData.grid.addChild(f);var p=new n("Lines");p.setPickable(o.PICKTHROUGH),f.addChild(p);var m=new i.Vector3,D=new i.Vector3;m[u]=c[x],D[g]=c[h],f.localXAxis=m,f.localYAxis=D,f.normal=(new i.Vector3).crossVectors(m,D).normalize(),nt(f.normal)>0&&(f.normal=f.normal.negate());var b=u+"Step",v=g+"Step",y=it(c[x])<0?et(c.origin[u],N[b]):tt(c.origin[u],N[b]);if(X)for("x"===u&&(y=it(y)<0?y+=l.x:y-=l.x),"y"===u&&(y=it(y)<0?y+=l.y:y-=l.y),"z"===u&&(y=it(y)<0?y+=l.z:y-=l.z);Math.abs(y)>Math.abs(c.origin[u]);)y=it(y)<0?y+=N[b]:y-=N[b];var C=(new i.Vector3).copy(c.origin),A=(new i.Vector3).copy(c.origin);C[u]=y,C[g]=c.origin[g],A[u]=y,A[g]=c.origin[g]+c[h];var w=r.createLineNode({points:[C,A]});for(t=0;Math.abs(y+t*it(c[x])-c.origin[u])<=Math.abs(c[x]);t+=N[b]){var M=w;0!==t&&(M=M.clone()),M.setMatrix((new i.Matrix4).makeTranslation("x"===u?t*it(c[x]):0,"y"===u?t*it(c[x]):0,"z"===u?t*it(c[x]):0)),M.relatedLabel={prefix:d[u],value:Math.pow(10,-3)*Math.round(y+t*it(c[x]))},p.addChild(M)}var P=it(c[h])<0?et(c.origin[g],N[v]):tt(c.origin[g],N[v]);if(X)for("x"===g&&(P=it(P)<0?P+=l.x:P-=l.x),"y"===g&&(P=it(P)<0?P+=l.y:P-=l.y),"z"===g&&(P=it(P)<0?P+=l.z:P-=l.z);Math.abs(P)>Math.abs(c.origin[g]);)P=it(P)<0?P+=N[v]:P-=N[v];for(C=(new i.Vector3).copy(c.origin),A=(new i.Vector3).copy(c.origin),C[u]=c.origin[u],C[g]=P,A[u]=c.origin[u]+c[x],A[g]=P,w=r.createLineNode({points:[C,A]}),t=0;Math.abs(P+t*it(c[h])-c.origin[g])<=Math.abs(c[h]);t+=N[v]){var V=w;0!==t&&(V=V.clone()),V.setMatrix((new i.Matrix4).makeTranslation("x"===g?t*it(c[h]):0,"y"===g?t*it(c[h]):0,"z"===g?t*it(c[h]):0)),V.relatedLabel={prefix:d[g],value:Math.pow(10,-3)*Math.round(P+t*it(c[h]))},p.addChild(V)}}}}({gridData:a}),u.exludeFromBounding(!1),u.setVisibilityInTree(!1),Ht(),u};this.drawGrids=function(e){var t,n,r,a;n=T.backgroundColor,r=new i.Color(n),a=Math.round((255*r.r*299+255*r.g*587+255*r.b*114)/1e3),ge=a>125?"black":"white";var o,d,l,s,c,u=null;if(e.rootPaths){var g;for(g=0;g<e.rootPaths.length;g++)if(s=e.rootPaths[g],l="3D Grid "+v.getNodeID(s.getLastElement(!0)),(c=ii(l))||(u=ni(l,s,d)),!(u&&ce&&te&&u===ae))if(d=$e(s)){u&&e.mode&&"Default"===e.mode&&(u.gridDMUObject=u.savedDMUObject,u.grid&&u.grid.setVisibility(!0),u.visibility=!0,u.mode="Default");var x=e.gridCmd;x||(window.widget.data.appId&&-1!==_e.indexOf(window.widget.data.appId)||window.widget.data.afrAppId&&-1!==_e.indexOf(window.widget.data.afrAppId))&&(x=require("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd")),o=ri(c,u,d,s,l,x),T.getRootNode().getChildByName("3D Grid "+v.getNodeID(s.getLastElement(!0)))||T.addNode(o)}else u&&u.grid&&(u.grid.setVisibility(!1),vt(!0));for(g=0;g<e.rootPaths.length;g++)for(t=0;t<L.length;t++)if(L[t].root&&L[t].root.isEqual(e.rootPaths[g])){St(L[t]);break}e.rootPaths.length>0&&(Bt(),T.render({updateInfinitePlane:!0}))}else if(e.specifications){if(d=e.specifications[0].BBox,(c=ii(l="3D Grid "+F))||(u=ni(l,s,d)),u&&ce&&te&&u===ae)return;!d&&u&&u.grid&&u.grid.setVisibility(!1),o=ri(c,u,d,s,l),St(L[0]),Bt(),W&&W.addChild(o)}};var ai=function(e){var t=fe[e];if(t&&t.length){for(var i=0;i<t.length;i++)he.unlink(t[i]);t.splice(0,t.length)}},oi=function(e){if(z&&z.childNodes&&z.childNodes.length)for(var t=z.childNodes.length-1;t>=0;t--)z.childNodes[t].label.gridID===e&&z.removeChild(z.childNodes[t])},di=function(e){if(Ee)for(var t=Ee.length-1;t>=0;t--)Ee[t].gridID===e&&Ee.splice(t,1)},li=function(e,t){for(var i=L.length-1;i>=0;i--)if(L[i].gridName===t){Et(L[i].grid),e.rootPaths?T.removeNode(L[i].grid):e.owner&&e.owner.removeChild(L[i].grid),e.fromStorage?L.splice(i,1):(L[i]&&L[i].grid&&delete L[i].grid,L[i]&&L[i].root&&delete L[i].root,L[i]&&L[i].bBox&&delete L[i].bBox,L[i]&&L[i].labelRatio&&delete L[i].labelRatio),ai(t);break}oi(t),di(t)};this.deleteGrids=function(e){var t=void 0;if(e.rootPaths)for(var i=0;i<e.rootPaths.length;i++)t="3D Grid "+v.getNodeID(e.rootPaths[i].getLastElement(!0)),li(e,t);else li(e,t="3D Grid "+F);e.fromStorage&&e.rootPaths&&e.rootPaths.length>0&&(Bt(),T.render()),0===L.length?Ee.splice(0,Ee.length):Ht()},this.getGridRootNames=function(){for(var e=[],t=0;t<L.length;t++)e.push(L[t].gridName);return e},this.setGridsVisibility=function(e){var t,i=[];for(t=0;t<e.roots.length;t++)for(var n=0;n<L.length;n++)if(v.getNodeID(L[n].root.getLastElement(!0))===v.getNodeID(e.roots[t].getLastElement(!0))&&L[n].grid&&L[n].grid.isVisible()!==e.flag){if(L[n].grid.setVisibility(e.flag),L[n].visibility=e.flag,e.flag){var r=$e(L[n].root);if(r){var a=ti(L[n],r);a&&(L[n].gridDataPreference=a,i.push(e.roots[t]))}else L[n].grid.setVisibility(!1)}break}for(t=z.childNodes.length-1;t>=0;t--)z.childNodes[t].style.visibility=e.flag?"":"hidden";i.length&&U.drawGrids({rootPaths:i}),T.render()},this.setSlide3DGrid=function(e){let t=!1;var i,n,r=[];for(i=0;i<e.roots.length;i++)for(var a=0;a<L.length;a++)if(!(n=L[a].root?v.getNodeID(L[a].root.getLastElement(!0)):null)&&L[a].gridName&&(n=L[a].gridName.replace("3D Grid ","")),n===v.getNodeID(e.roots[i].getLastElement(!0))){L[a].root||(L[a].root=e.roots[i]);let n,s=!1;"StartPreviewSlide"!==L[a].mode&&"EndPreviewSlide"!==L[a].mode&&(L[a].previousMode=L[a].mode?L[a].mode:"Default",L[a].previousVisibility=L[a].visibility);let c=!1;if(L[a].mode=e.mode,"StartPreviewSlide"===L[a].mode?(n=e.gridDMUObject,e.gridDMUObject&&(c=!0)):"EndPreviewSlide"===L[a].mode?(n=L[a].savedDMUObject,L[a].previousVisibility&&(c=!0)):"ViewSlide"===L[a].mode?(n=e.gridDMUObject,L[a].savedDMUObject=e.gridDMUObject,e.gridDMUObject&&(c=!0)):"Default"===L[a].mode&&(n=L[a].savedDMUObject,c=!0),L[a].gridDMUObject!==n&&(L[a].gridDMUObject=n,Kt(L[a]),s=!0),L[a].grid?L[a].grid.isVisible()!==c&&(L[a].grid.setVisibility(c),L[a].visibility=c,s=!0):(L[a].visibility=c,s=!0),s&&c){var o=$e(L[a].root);if(o){var d=ti(L[a],o);d&&(L[a].gridDataPreference=d),r.push(e.roots[i])}else L[a].grid&&L[a].grid.setVisibility(!1)}else t=!0;if(z)for(var l=z.childNodes.length-1;l>=0;l--)z.childNodes[l].style.visibility=c;break}r.length?U.drawGrids({rootPaths:r}):t&&vt(!0),T.render()},this.updateFreeZone=function(e){Ye=e,vt(!0)},this.setGridProperties=function(e){ae&&ae.gridDMUObject&&(ae.gridDMUObject.setAttribute("sPitch",e.PitchValue),ae.gridDMUObject.setAttribute("sLabelPrefixX",e.Direction1.replace(/\s+/g,"").slice(0,3)),ae.gridDMUObject.setAttribute("sLabelPrefixY",e.Direction2.replace(/\s+/g,"").slice(0,3)),ae.gridDMUObject.setAttribute("sLabelPrefixZ",e.Direction3.replace(/\s+/g,"").slice(0,3)))}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridController",["UWA/Core","UWA/Utils","UWA/Class","DS/CATWebUXComponents/DMUCommandsManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/CoreEvents/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,n,r,a,o){"use strict";var d=i.extend({init:function(i){var d=i||{};this._parent(d);var l,s=!1,c=!1,u=null,g=["CAT3DComposeExamineSelectionHdr","Explode","CAT3DComposeFakeMoveHdr","CATW3DSetIdentityPositionHdr"],x=d.ctxViewer,h={},f=x.getViewer(),p=null,m=this,D={},b=function(){if(s&&!u&&p){var e=x.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();p.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}},v=function(e){if(x&&s&&!u){for(var t=!1,i=0;i<g.length;i++)if(g[i]===e._id){t=!0;break}if(t){var r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",x.getCommandContext?x.getCommandContext():null);r.disable(),p.deleteGrids({rootPaths:x.getRootBagPath().getChildrenPathes(),fromStorage:!1}),u=e.onEnd(function(){(r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",x.getCommandContext?x.getCommandContext():null)).enable(),p.drawGrids({rootPaths:x.getRootBagPath().getChildrenPathes(),mode:"Default"}),a.unsubscribe(u),u=null})}}},y=function(e,t){let i=e.map(function(e){return e.modelIdentification}),n=i.indexOf(t[0]);if(n<0)return!1;let r=0;for(;r<i.length-n&&i[r+n]===t[r];)r++;return r===i.length-n},C=v;n.onCommandStart(C,x.getCommandContext&&x.getCommandContext()?x.getCommandContext():void 0);this.setActiveState=function(i,a){var d,m;if(i!==s){s=i;var A=x.getRootBagPath().getChildrenPathes();s?new Promise(function(e){let t=[{Repository:"GridRepository",PreferenceNames:["GridPitchValue","Direction1","Direction2","Direction3"]}];require(["DS/CATWebUXPreferences/CATWebUXPreferencesUtils"].concat([]),function(i){try{i.readPreferences(t).then(function(t){e(t)})}catch(t){window.console.warn("Error Preferences ",t),e()}})}).then(function(i){if(i.repositories.forEach(function(e){"GridRepository"===e.name&&e.preferences.forEach(function(e){"GridPitchValue"===e.name?D.PitchValue=1e3*parseFloat(e.value):"Direction1"===e.name?D.Direction1=e.value.replace(/\s+/g,"").slice(0,3):"Direction2"===e.name?D.Direction2=e.value.replace(/\s+/g,"").slice(0,3):"Direction3"===e.name&&(D.Direction3=e.value.replace(/\s+/g,"").slice(0,3))})}),!p){var w={};""!==window.location.search&&(e.extend(w,t.parseQuery(window.location.search)),w.widgetDomain&&e.extend(w,t.parseQuery(w.widgetDomain))),p=new r({window:x.getFrameWindow(),rootBagPath:x.getRootBagPath(),viewer:f,context:x,nbMaxLabel:"CAT3DGRID_MAXLABEL"in w?w.CAT3DGRID_MAXLABEL:300,stepRequiredX:D.PitchValue,stepRequiredY:D.PitchValue,stepRequiredZ:D.PitchValue,labels:{x:D.Direction1,y:D.Direction2,z:D.Direction3}}),b()}p.setActiveState(!0);var M=p.getGridRootNames(),P=!1,V=[];for(d=0;d<M.length;d++){for(m=0;m<A.length;m++)if("3D Grid "+o.getNodeID(A[m].getLastElement(!0))===M[d]){P=!0;break}if(!P)for(m=0;m<A.length;m++)if("3D Grid "+o.getNodeID(A[m].getLastElement(!0))===M[d]){V.push(A[m]);break}}for(p.deleteGrids({rootPaths:V,fromStorage:!0}),p.drawGrids({rootPaths:A,mode:"Default",gridCmd:a}),x.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",b),h.onViewerResizedToken=f.onViewerResize(b),h.onRootAddedToken=x.subscribe({event:"onRootAdded"},function(e){if(s&&!u){p.endEditMode();var t=e.path;if(e.inContext)for(var i=x.getRootBagPath().getChildrenPathes(),n=0;n<i.length;n++)if(i[n].isAParentOf(e.path)){t=i[n];break}p.drawGrids({rootPaths:[t]})}}),h.onLoadingCompleteToken=x.subscribe({event:"onLoadingComplete"},function(){if(s&&!u){p.drawGrids({rootPaths:x.getRootBagPath().getChildrenPathes()});var e=x.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();p.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}}),h.onRenderComplete=x.subscribe({event:"onEndProgressiveLoad"},function(){s&&!u&&p.drawGrids({rootPaths:x.getRootBagPath().getChildrenPathes()})}),l=x.subscribe({event:"onRootRemoved"},function(e){s&&!u&&p.endEditMode();var t=!c;p.deleteGrids({rootPaths:[e.path],fromStorage:t}),!s&&l&&0===p.getGridRootNames().length&&(x.unsubscribe(l),l=null)}),h.onHide=x.subscribe({event:"onHide"},function(e){if(s&&e&&Array.isArray(e.paths)&&p&&!u){p.endEditMode();for(var t=[],i=x.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++){if(e.paths[n].externalPath&&i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}if(y(i[r].externalPath,e.paths[n])){t.push(i[r]);break}}t.length&&p.drawGrids({rootPaths:t})}}),h.onShow=x.subscribe({event:"onShow"},function(e){if(s&&e&&Array.isArray(e.paths)&&p&&!u){p.endEditMode();for(var t=[],i=x.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++){if(e.paths[n].externalPath&&i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}if(y(i[r].externalPath,e.paths[n])){t.push(i[r]);break}}t.length&&p.drawGrids({rootPaths:t})}}),h.onRefreshBeginToken=x.subscribe({event:"onRefreshBegin"},function(){c=!0,p.endEditMode()}),h.onRefreshCompletedToken=x.subscribe({event:"onRefreshCompleted"},function(){c=!1}),h.onRootAttachedToken=x.subscribe({event:"onRootAttached"},function(e){s&&!u&&p.drawGrids({rootPaths:[e.path]})}),h.onRootDetachedToken=x.subscribe({event:"onRootDetached"},function(e){s&&!u&&(p.endEditMode(),p.deleteGrids({rootPaths:[e.path],fromStorage:!1}))}),h.onLayoutComputedToken=x.subscribe({event:"onLayoutComputationBegin"},function(){s&&!u&&(p.endEditMode(),p.deleteGrids({rootPaths:x.getRootBagPath().getChildrenPathes(),fromStorage:!1}))}),h.onLayoutResetToken=x.subscribe({event:"onLayoutComputationEnd"},function(){s&&!u&&p.drawGrids({rootPaths:x.getRootBagPath().getChildrenPathes()})}),h.onModelUpdatedToken=x.subscribe({event:"onModelUpdated"},function(e){if(s&&!u){p.endEditMode();var t=[],i=x.getRootBagPath().getChildrenPathes();if(e.rootNodes){for(var n=0;n<e.rootNodes.length;n++)for(var r=0;r<i.length;r++)if(i[r].getLastElement(!0)===e.rootNodes[n]){t.push(i[r]);break}p.drawGrids({rootPaths:t})}else p.drawGrids({rootPaths:i})}}),C=v,h.onBackgroundModifyToken=f.onBackgroundModify(function(){s&&!u&&(p.endEditMode(),p.drawGrids({rootPaths:x.getRootBagPath().getChildrenPathes()}))}),d=0;d<g.length;d++){var T=n.getCommand(g[d],x.getCommandContext?x.getCommandContext():null);if(T&&T.isRunning()){v(T);break}}}):(p&&(p.endEditMode(),p.deleteGrids({rootPaths:A,fromStorage:!1}),p.setActiveState(!1)),x.unsubscribe(h.onRefreshBeginToken),x.unsubscribe(h.onRefreshCompletedToken),x.unsubscribe(h.onRenderComplete),x.unsubscribe(h.onRootAddedToken),x.unsubscribe(h.onRootAttachedToken),x.unsubscribe(h.onRootDetachedToken),x.unsubscribe(h.onLayoutComputedToken),x.unsubscribe(h.onLayoutResetToken),x.unsubscribe(h.onModelUpdatedToken),f.unsubscribe(h.onBackgroundModifyToken),f.unsubscribe(h.onViewerResizedToken),x.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",b),h={},C=null)}},this.getActiveState=function(){return s},this.clearController=function(){m.setActiveState(!1),x=f=g=p=m=null},this.hide3DGrids=function(){s&&!u&&p.setGridsVisibility({roots:x.getRootBagPath().getChildrenPathes(),flag:!1})},this.display3DGrids=function(){s&&!u&&p.setGridsVisibility({roots:x.getRootBagPath().getChildrenPathes(),flag:!0})},this.displaySlide3DGrid=function(e,t){s=Boolean(t),p.setActiveState(s),p.setSlide3DGrid({roots:x.getRootBagPath().getChildrenPathes(),mode:e,gridDMUObject:t})}}}),l=[];return i.singleton({init:function(){},give3DGridController:function(e){if(e&&e.context)for(var t=0;t<l.length;t++)if(l[t].context===e.context)return l[t].gridController},get3DGridController:function(e){var t=this.give3DGridController(e);if(e&&e.context&&!t){var i=new d({ctxViewer:e.context});t={setActiveState:function(e,t){i&&i.setActiveState(e,t)},getActiveState:function(){if(i)return i.getActiveState()},clearController:function(){i&&(i.clearController(),i=null)},hide3DGrids:function(){i&&i.hide3DGrids()},display3DGrids:function(){i&&i.display3DGrids()},displaySlide3DGrid:function(e,t){i&&i.displaySlide3DGrid(e,t)}},l.push({context:e.context,gridController:Object.freeze(t)})}return t},unreference3DGridController:function(e){if(e&&e.context)for(var t=l.length-1;t>=0;t--)l[t].context===e.context&&(l[t].gridController.clearController(),l.splice(t,1))}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/PADUtils/PADContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/DMUCommandsManager","DS/CoreEvents/Events"],function(e,t,i,n,r,a){"use strict";var o=null,d=null,l=null;let s,c;var u,g=!1,x=["ENOR3D_AP","ENOR3R_AP","ENOR3V_AP","ENOR3D_APWebApp"],h=null,f=e.extend({init:function(e){this._parent(e,{}),u=this,this._skipNextChg=g,s=!(!e.arguments.length||!e.arguments[0].context)&&"Review"===e.arguments[0].context,h=this.onStateChange(function(){if(u._skipNextChg)return u._skipNextChg=!1,g=!1,void(u.getState()||f.Hide3DGrid());u.getState()?f.Display3DGrid():f.Hide3DGrid()});var t=this._destroy;this._destroy=function(){o&&i.unreference3DGridController({context:o}),u._modelEvents.unsubscribe(h),a.unsubscribe(p),t.call(u)};var n="true"===localStorage.getItem("CATRelatedData3DGridCmd");this.setState(n,!0),n&&require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("commandCheck","3DGridOn")})},_destroy:function(){this._parent()},isReviewContext:function(){return s}});f._onDMUSlideDisplayedCB=function(e){if(e.dmuObject){var t=u.getState();t!==e.dmuObject.getDMUObjects("3DGrid").length>0&&(u._modelEvents.unsubscribe(h),u.setState(!t),u._modelEvents.subscribe(h))}};var p=a.subscribe({event:"onSlideDisplayedToManageGrid"},f._onDMUSlideDisplayedCB);return f.onGridAddedToGridList=function(e){e.addedGrid&&(c=e.addedGrid)},f.getGridRvwContext=function(){if(!s)return null;if((l=n.getReviewContext({viewer:d}))||require(["DS/DMUBaseUIControllers/DMUReviewContextInitializer"].concat([]),function(e){o||(o=n.getContextViewer({viewer:d})),e.createReviewContext({context:o}).then(function(){l=n.getReviewContext({viewer:d}),c&&l&&c.gridDMUObject&&l.getTransientReviewBag().addDMUObject(c.gridDMUObject)})}),!l)return;var e=l.getCurrentSessionMarkup();let t=!0;if(e){let i=l.getRestrictions(e);i.markup&&void 0!==i.markup.canEdit&&(t=i.markup.canEdit)}return e&&e.getActiveFlag()&&e.isVisible()&&!e.isReadOnly()&&t&&e.getCurrentSlide()?e:l.getTransientReviewBag()},f.addGridDMUObject=function(e){if(!s)return null;var t,i=this.getGridRvwContext();if(i){var n=i.getCurrentSlide?i.getCurrentSlide():null;if(i.addDMUObject){if(i.getDMUObjects){let e=i.getDMUObjects("3DGrid");for(t=0;t<=e.length&&i.removeDMUObject;t++)i.removeDMUObject&&i.removeDMUObject(e[t])}i.addDMUObject(e.gridDMUObject)}else if(n&&n.addDMUObject){if(n.getDMUObjects){let e=n.getDMUObjects("3DGrid");for(t=0;t<=e.length&&n.removeDMUObject;t++)n.removeDMUObject&&n.removeDMUObject(e[t])}n.addDMUObject(e.gridDMUObject),n.fireEvent("onSlidePreviewRefreshRequired",{dmuObject:n})}}},f.ManageGridOnDMUSlideDisplay=function(e){if(e&&e.dmuObject){let n=e.dmuObject.getDMUObjects("3DGrid"),a=i.give3DGridController({context:o});if(!a)return;a.displaySlide3DGrid("ViewSlide",n.length?n[0]:void 0);let d=n.length>=1;var t=r.getCommandCheckHeader("CATRelatedData3DGridHdr",o.getCommandContext?o.getCommandContext():null);t.getState()!==d&&(g=!0,t.setState(d))}},f.Display3DGrid=async function(e,n){var r="";n&&n.executionContext&&(r=n.executionContext.getSourceApp()&&n.executionContext.getSourceApp().options&&n.executionContext.getSourceApp().options.id?n.executionContext.getSourceApp().options.id:window.widget.data.afrAppId?window.widget.data.afrAppId:window.widget.data.appId?window.widget.data.appId:"",s=x.indexOf(r)>=0),!o&&n?o=n.executionContext.getComponent("Viewer"):o||n||(o=t.get()),o&&(d=o.getViewer()),await i.get3DGridController({context:o}).setActiveState(!0,f),localStorage.setItem("CATRelatedData3DGridCmd","true"),e&&e()},f.Hide3DGrid=async function(e,n){var r="";n&&n.executionContext&&(r=n.executionContext.getSourceApp()&&n.executionContext.getSourceApp().options&&n.executionContext.getSourceApp().options.id?n.executionContext.getSourceApp().options.id:window.widget.data.afrAppId?window.widget.data.afrAppId:window.widget.data.appId?window.widget.data.appId:"",s=x.indexOf(r)>=0),!o&&n?o=n.executionContext.getComponent("Viewer"):o||n||(o=t.get()),o&&(d=o.getViewer());let a=i.give3DGridController({context:o});a&&await a.setActiveState(!1),localStorage.setItem("CATRelatedData3DGridCmd","false"),e&&e()},f.updateGridCommandState=function(){if(!s)return null;var e=r.getCommandCheckHeader("CATRelatedData3DGridHdr",o.getCommandContext?o.getCommandContext():null);if(!e)return;let t=null,i=null;var n=this.getGridRvwContext();if(n){var a=n.getCurrentSlide?n.getCurrentSlide():null;n.getDMUObjects?t=n.getDMUObjects("3DGrid"):a&&a.getDMUObjects&&(i=a.getDMUObjects("3DGrid"))}var d;d=t&&t.length>0||i&&i.length>0,e.setState(d)},f});