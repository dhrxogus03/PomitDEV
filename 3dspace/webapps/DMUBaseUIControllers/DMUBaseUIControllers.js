define("DS/DMUBaseUIControllers/DMUWebPreferencesController",["require","exports","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CoreEvents/ModelEvents"],function(e,t,n,i,r){"use strict";let o;const a=new r,l=function(e){let t;if(e)switch(e){case"Length":t=Math.pow(10,-3);break;case"Angle":t=Math.PI/180;break;case"Volume":t=Math.pow(10,-9);break;case"Area":t=Math.pow(10,-6)}return t},s=function(e){let t;if(e)switch(e.toLowerCase()){case"length":t="Length";break;case"area":t="Area";break;case"angle":t="Angle";break;case"volume":t="Volume";break;case"mass":t="Mass"}return t},d=async e=>{let t;try{return t=await n.readPreferences(e),o=t,t}catch(e){return o=t={repositories:[{name:"cke",preferences:[{name:"TrailingZeros",datatype:"boolean",value:!1},{name:"Length",datatype:"enum",value:"Millimeter"},{name:"LengthDisplay",datatype:"uint",value:"3"},{name:"LengthCalcDisplay",datatype:"uint",value:"3"},{name:"Angle",datatype:"enum",value:"Degree"},{name:"AngleDisplay",datatype:"uint",value:"3"},{name:"AngleCalcDisplay",datatype:"uint",value:"3"},{name:"Volume",datatype:"enum",value:"CubMm"},{name:"VolumeDisplay",datatype:"uint",value:"3"},{name:"VolumeCalcDisplay",datatype:"uint",value:"3"},{name:"Area",datatype:"enum",value:"SqMm"},{name:"AreaDisplay",datatype:"uint",value:"3"},{name:"AreaCalcDisplay",datatype:"uint",value:"3"},{name:"Mass",datatype:"enum",value:"Kilogram"},{name:"MassDisplay",datatype:"uint",value:"3"},{name:"MassCalcDisplay",datatype:"uint",value:"3"}]},{name:"MeasureRepository",preferences:[{name:"DMUMeasureRemovePreviousNonPersistent",datatype:"boolean",value:"false"}]},{name:"DMURepository",preferences:[{name:"ValidationRestrictedAccess",datatype:"enum",value:"Activated"},{name:"ReviewRestrictedAccess",datatype:"enum",value:"Deactivated"}]}]},t}},u=e=>{const t=JSON.parse(e[1].preferences).repositories;let n=!1;for(let e=0;e<t.length;e++)if(t[e].preferences&&t[e].preferences.length>0)for(let i=0;i<o.repositories.length;i++)if(o.repositories[i].name===t[e].name)for(let r=0;r<o.repositories[i].preferences.length;r++)for(let a=0;a<t[e].preferences.length;a++)o.repositories[i].preferences[r].name===t[e].preferences[a].name&&(o.repositories[i].preferences[r].value=t[e].preferences[a].value,n=!0);n&&((e,t)=>{a&&a.publish({event:e,data:t})})("onDMUWebpreferencesUpdate",o)};class g{static async init(e){let t=i.givePreferenceManager({context:e.context.getFrameWindow()});return t||(t=i.getPreferenceManager({context:e.context.getFrameWindow()})),t.subscribe("com.ds.mep:onPrefUpdate",u),o=await d([{Repository:"cke",PreferenceNames:["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"]},{Repository:"MeasureRepository",PreferenceNames:["DMUMeasureRemovePreviousNonPersistent"]},{Repository:"DMURepository",PreferenceNames:["ValidationRestrictedAccess","ReviewRestrictedAccess"]}])}static readPreferences(e){let t=[];for(let n=0;n<o.repositories.length;n++)if(o.repositories[n].name===e.name)for(let i=0;i<e.PreferenceNames.length;i++)for(let r=0;r<o.repositories[n].preferences.length;r++)o.repositories[n].preferences[r].name===e.PreferenceNames[i]&&t.push(o.repositories[n].preferences[r]);return{name:e.name,preferences:t}}static convertUnitValueToString(e,t,i,r,o,a){let d=s(e),u=i&&i.getDMUPreferenceRepository?i.getDMUPreferenceRepository().getPreference(e):null;null===u&&(u=g.readPreferences({name:"cke",PreferenceNames:[e]}).preferences[0].value);const c=g.readPreferences({name:"cke",PreferenceNames:[d+"CalcDisplay"]}).preferences[0].value,p={displaySpace:!0!==r&&void 0,displaySymbol:!0!==o&&void 0};let m=e;switch(m.toLowerCase()){case"length":d="Length";break;case"area":d="Area";break;case"angle":d="Angle";break;case"volume":d="Volume"}return t*=l(m),n.convertUnitValueToString(t,d,u,c,a,p)}static getCurrentUnit(e){const t=s(e);if(!t)return window.console.warn("Magnitude not supported"),{unit:"",nls:""};let i=this.readPreferences({name:"cke",PreferenceNames:[t]}).preferences[0].value;const r=this.readPreferences({name:"cke",PreferenceNames:[t+"Display"]}).preferences[0].value,o=this.readPreferences({name:"cke",PreferenceNames:[t+"CalcDisplay"]}).preferences[0].value,a=n.Types[t];return i||(i=a.defaultValue),{unit:i,nls:n[t][i].symbol,decimalPlaceRW:r,decimalPlaceRO:o}}static subscribe(e,t){if(e&&t&&a)return a.subscribe({event:e},t)}static unsubscribe(e){a&&e&&a.unsubscribe(e)}}return g}),define("DS/DMUBaseUIControllers/DMUReqCompareController",["require","exports","DS/CATWebUXComponents/DMUCommandsManager","DS/HTMLCompareLib/HTMLDiff","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/DMUControls/EXPNotify","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/DMUBaseExperience/DMUContextManager"],function(e,t,n,i,r,o,a,l,s,d,u,g,c){"use strict";let p=[];class m{constructor(e){let t,p,m,f,h,v,C,D,b,M,y=this,S=e.context,w=c.giveEventsController({viewer:S.getViewer()}),E={},U=!1,x=[],O=!1,P=0,R=!0;function A(e,t){M&&(M.destroy(),M=null),M=new l({body:S.getFrameWindow().getUIFrame(),type:e,message:t})}function I(){if(h=null,v=void 0,d.getNodeID(S.getRoots()[0])===t){P++;let e=s.getManager({name:"DMU2DSheetManager",context:S.getFrameWindow()});e&&e.setRequirementCompareData({firstReqData:[],secondReqData:[]}),w&&w.fireEvent("on2DDocumentLoadRequired",{documentType:b&&b[t]?b[t]["ds6w:type"]:void 0,rootID:t,objectName:b&&b[t]?b[t]["ds6w:label"]:void 0})}else d.getNodeID(S.getRoots()[0])===p&&S.removeRoots({pids:[p]});k()}function k(){h=null,S&&S.getRoots()&&S.getRoots().length&&!O&&(D&&D.clear(),b=[]),o.empty(),a.empty()}function V(e,i,o){let a=g.giveWebDocumentVisualizationController({context:S}),l=c.getReviewContext({viewer:S.getViewer()});a&&l&&(a.removeDocument(),a.loadDocumentStream({phyId:i?t+"_"+p:t,type:"Requirement",elementsToLoad:e,fatherNode:S.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),onComplete:()=>{let e=S.getFrameWindow().getViewer(),t=e?e.currentViewpoint:void 0;t&&(t.setTargetDistance(m),t.setEyePosition(new r.Vector3(f.x,f.y,f.z)),e.render());let a=c.getReviewContext({viewer:S.getViewer()}),l=null==a?void 0:a.getVisibleMarkups();if(R&&l&&l.length)if(i&&h)a&&a.setVisibleMarkups(l),h.fireEvent("onRequirementComparisonDisplayed",{dmuObject:h});else if(P){let e=n.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",S.getCommandContext());e&&U&&(e.setState(!0),localStorage.setItem("DMUBookmarksPanelDisplayed","true"),U=!1),a&&a.setVisibleMarkups(l),w&&w.fireEvent("onRequirementComparisonEnded",void 0)}P--,o&&o()},onFailure:()=>{A("info",u.comparisonFailed),window.console.warn("Issue in loading the document"),y.toggleRequirementCompareCmd(!1)}}))}this.getActiveCompareFeature=function(){return h},this.isRequirementCompareActive=function(){return Boolean(h)},this.loadCompareRequirement=function(e,n,r){n?((C=e).forEach(e=>{let t;t=e.pathId.split("/").pop(),x.push(t),D.set(e.pathId,e)}),S.getController().getAttributes({ids:x,attributes:["ds6wg:revision","logicalid","versionid","ds6w:type","ds6w:label"],callbacks:{onComplete:function(e){b=e;let t=function(){let e=[],t=[],n=[],i=[];v&&v.forEach(t=>{let i=t.pathId.split("/"),r=i.pop();e.push(t.pathId),b&&b[r]&&b[r].logicalid&&n.push(b[r].logicalid)});C.forEach(e=>{let n=e.pathId.split("/"),r=n.pop();t.push(e.pathId),b&&b[r]&&b[r].logicalid&&i.push(b[r].logicalid)});let r=new Map;function o(n,i,o,a,l=!1){for(let t=n;t<o-1;t++)r.set(e[t],null);for(let e=i;e<a-1;e++)r.set(t[e],null);l||r.set(e[o-1],t[a-1])}let a=new Map,l=new Map;for(let e=0;e<i.length;e++){let t=JSON.stringify({logID:i[e],occ:0});if(a.has(t)){let n=l.get(i[e])+1;t=JSON.stringify({logID:i[e],occ:n}),a.set(t,e+1),l.set(i[e],n)}else a.set(t,e+1),l.set(i[e],0)}let s=[];for(let e=0;e<n.length;e++){let t=JSON.stringify({logID:n[e],occ:0});a.has(t)&&s.push(a.get(t))}let d=[],u=[];if(s.length){d.push(s[0]),u.push(n.indexOf(i[s[0]-1])+1);for(let e=1;e<s.length;e++)s[e]>d[d.length-1]&&(d.push(s[e]),n.indexOf(n[s[e]-1])>=0&&u.push(n.indexOf(i[s[e]-1])+1))}"Requirement"===(b&&b[p]?b[p]["ds6w:type"]:"")&&0===d.length&&(d=[],(u=[]).push(1),d.push(1));let g=0,c=0;for(let e=0;e<u.length;e++){let t=u[e],r=d[e];o(g,c,t,r),g=u[e],c=d[e],u.length-1===e&&o(g,c,n.length+1,i.length+1,!0)}return r}();if(t&&t.size){let e=function(e){let t=[];return e.forEach((e,n)=>{let r;if(D.has(n)&&(r=D.get(n)),r)if(e){let o=e.split("/").pop(),a=n.split("/").pop(),l=a&&b[a]?b[a]["ds6wg:revision"]:"",s=o&&b[o]?b[o]["ds6wg:revision"]:"",d=r.content;d&&(d=(d=d.replaceAll("&lt;","<")).replaceAll("&gt;",">"));let u,g=D.get(e);if(g&&g.content){u=(u=(u=g.content).replaceAll("&lt;","<")).replaceAll("&gt;",">");const e={ignoreWhiteSpaceDifferences:!0,matchGranularity:100,combineWords:!1};let n=i.default(d,u,e),o={...r,content:n,pathId:r.pathId+"_"+g.pathId,title:r.title+" "+l+" | "+g.title+" "+s};t.push(o)}}else t.push(r)}),t}(t);e&&e.length&&(!function(e){if(e){let t=[],n=[],i=[];for(let e=0;e<C.length;e++)t.push(C[e].pathId);if(e.forEach((e,r)=>{e||(-1!==t.indexOf(r)?i.push(r):n.push(r))}),n.length||i.length){let e=s.getManager({name:"DMU2DSheetManager",context:S.getFrameWindow()});e&&e.setRequirementCompareData({firstReqData:n,secondReqData:i})}}}(t),V(e,n,r))}else A("info",u.compareNoObjectToCompare),y.toggleRequirementCompareCmd(!1)},onFailure:function(){A("info",u.compareServerFailed),y.toggleRequirementCompareCmd(!1)}}})):(V(e,n,r),t="",p="")},this.getCompareIDsFromFeature=function(e){let t=[],n=e.getAttribute("oSelections"),i=e.getParent()?e.getParent():void 0,r=i?i.getAttribute("oLinksManager"):null;if(r){let e=r.getChildWithID(n[0].id);e&&t.push(r.getOccurrenceIdPath(e.path).join()),(e=r.getChildWithID(n[1].id))&&t.push(r.getOccurrenceIdPath(e.path).join())}return t},this.isLoading=function(){return P>0},this.displayRequirementComparison=function(e){if(!e)return;let i=y.getCompareIDsFromFeature(e);if(i&&i.length>1&&(t=i[0],p=i[1]),S){let i=S.getViewer(),r=i?i.currentViewpoint:i;if(r&&(m=r.getTargetDistance(),f=r.getEyePosition()),k(),O=!1,h=e,!v){let e=g.getWebDocumentVisualizationController({context:S});v=e?e.getLoadedReqElement():void 0}v&&v.length&&(D=new Map,x=[t,p],v.forEach(e=>{let t=e.pathId.split("/").pop();x.push(t),D.set(e.pathId,e)}),S.getController().getAttributes({ids:[p],attributes:["ds6w:type","ds6w:label"],callbacks:{onComplete:function(e){let t=n.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",S.getCommandContext());t&&"true"===localStorage.getItem("DMUBookmarksPanelDisplayed")&&(t.setState(!1),localStorage.setItem("DMUBookmarksPanelDisplayed","false"),U=!0),w&&(P++,w.fireEvent("on2DDocumentLoadRequired",{documentType:e&&e[p]?e[p]["ds6w:type"]:void 0,rootID:p,objectName:e&&e[p]?e[p]["ds6w:label"]:void 0}),y.toggleRequirementCompareCmd(!0),o.empty(),a.empty())},onFailure:function(){A("info",u.compareServerFailed),y.toggleRequirementCompareCmd(!1)}}}))}},this.clean=function(){if(I(),w){let e=Object.keys(E);for(let t=0;t<e.length;t++)w.removeEvent(E[e[t]]||"")}E={}},this.toggleRequirementCompareCmd=function(e){let t=n.getCommandCheckHeader("DMUReqCompareCmdHdr",S.getCommandContext());t&&t.getState()!==e&&t&&t.setState(e)},this.getCurrentComparedObjectIDPaths=function(){return h?{feature:h,firstObject:t?t.slice():null,secondObject:p?p.slice():null}:null},w&&(E.onDMUReqCompareCancelled=w.addEvent("onDMUReqCompareCancelled",function(e){if(e&&e.dmuObject&&"DMUCompareRequirement"===e.dmuObject.getType()&&v&&v.length){let t=e.dmuObject.getParent();if(t)if("DMUMarkup"===t.getType()){let e=t.getSlides();if(e&&e.length&&e.length>1){let n=t.getCurrentSlide();if(n&&0===n.getDMUObjects("DMUComment").length){let e=n.getDMUObjects();for(let t=0;t<e.length;t++)n.removeDMUObject(e[t]);t.removeSlide(n)}t.setCurrentSlide(e[0])}}else"DMUTemporaryBag"===t.getType()&&t.removeDMUObjects("DMUCompareRequirement");let i=n.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",S.getCommandContext());i&&"true"===localStorage.getItem("DMUBookmarksPanelDisplayed")&&(i.setState(!1),localStorage.setItem("DMUBookmarksPanelDisplayed","false"),U=!0),I()}}),E.onDMUSlideCompareDisplayRequired=w.addEvent("onDMUSlideCompareDisplayRequired",function(e){var t;if(e&&e.dmuObject){let n=e.dmuObject.getDMUObjects("DMUCompareRequirement");n.length&&n[0]&&h&&h.getParent()&&"DMUTemporaryBag"===(null===(t=h.getParent())||void 0===t?void 0:t.getType())&&(O=!0,y.displayRequirementComparison(n[0]))}}),E.onDMUObjectDeleted=w.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject&&"DMUComment"===e.dmuObject.getType()){let t=e.dmuObject.getParent(),n=t.getSlides();for(let e=0;e<n.length;e++)if(t.getCurrentSlide()!==n[e]){let i=n[e].getDMUObjects("DMUCompareRequirement");if(i&&i.length&&!n[e].getDMUObjects("DMUComment").length){let i=n[e].getDMUObjects();for(let t=0;t<i.length;t++)n[e].removeDMUObject(i[t]);t.removeSlide(n[e])}}}}),E.onDMUReviewVisbilityChanged=w.addEvent("onDMUReviewVisbilityChanged",function(e){e&&(e.status?R=!0:(R=!1,y.toggleRequirementCompareCmd(!1)))}),E.onDMUMarkupLoaded=w.addEvent("onDMUMarkupLoaded",function(e){if(e&&e.dmuObject){let t=e.dmuObject;if(t){let e=t.getSlides();if(e.length>1){let n=t.getAttribute("sCurrentSlideId");if("string"==typeof n)for(let t=0;t<e.length;t++)if(e[t].getAttribute("sID")===n){let n=e[t].getDMUObjects("DMUCompareRequirement");n&&n.length&&y.displayRequirementComparison(n[0]);break}}}}}))}static getReqCompareController(e){let t=this.giveReqCompareController(e);if(t)for(let t=0;t<p.length;t++)p[t].context===e.context&&p[t].count++;else t=new m(e),p.push({context:e.context,controller:t,count:1});return t}static giveReqCompareController(e){if(e&&e.context)for(let t=0;t<p.length;t++)if(p[t].context===e.context)return p[t].controller}static unreferenceReqCompareController(e){if(e&&e.context)for(let t=0;t<p.length;t++){p[t].context===e.context&&(p[t].count--,0===p[t].count&&(p[t].controller.clean(),p.length=0));break}}}return m}),define("DS/DMUBaseUIControllers/DMUApplicativeContextManager",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/DMUBaseUIControllers/assets/config/DMUApplicativeContextManager.json"],function(e,t,n,i,r){"use strict";var o=[{wkbID:"3D",module:"DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview"},{wkbID:"3D",module:"DS/DMUBaseUIControllers/DMUEnrichApplicativeController"},{wkbID:"ITF",module:"DS/PIMwebViewController/PIMwebItfCtrl"},{wkbID:"MSR",module:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRAppCtrl"}],a=["ITF","MSR"],l=["FTA"],s=e.extend({init:function(e){var s;this._parent(e);var d,u=[],g=e.context,c={},p=t.getEventsController({viewer:g.getViewer()}),m=i.getPreferenceManager({context:g.getFrameWindow()}),f=[],h=this,v=JSON.parse(r),C={};let D=[];function b(e){if(!e)return[];let t=e.getValidation?e.getValidation():null,n=[];if(t){let e=t.getMarkups();for(let t=0;t<e.length;t++){let i=e[t].getMarkupContent();!i&&e[t].getRepRef()&&(i=e[t].getRepRef().getMarkupContent()),i&&(n=n.concat(i.getSlides()))}}else n=e.getCurrentSessionMarkup&&e.getCurrentSessionMarkup()?e.getCurrentSessionMarkup().getSlides():[];return n}function M(e,n){var i=t.getReviewContext({context:g}),r=[],o=n||b(i);if(o.length&&i&&i.getUIManager()&&!i.getUIManager().getFormatEditionModeFlag()){let t;for(var a=0;a<o.length;a++)(t=o[a].getSlideApplicativeContext(e))&&r.push({state:t})}return r}function y(){C={},d&&(clearTimeout(d),d=0),d=setTimeout(function(){if(d=null,!u)return;let e=t.getReviewContext({context:g}),n=e?e.getCurrentSessionMarkup():null;for(var i=0;i<u.length;i++)if(u[i].controller){let e=M(u[i].controller.getApplicativeContainerID());u[i].controller.updateAppContainer({slidesEditableFlag:Boolean(n&&!n.isReadOnly()),slidesAppData:e})}},100)}function S(e,t,n){return e===t||!n||!(!e&&t||e&&!t)&&(e.version===t.version&&function e(t,n,i){if(t===n)return null!=t||!i.mandatory;var r=typeof t;if(r!==typeof n)return!1;if(!("array"!==i.type||Array.isArray(t)&&Array.isArray(n)))return!1;if("array"!==i.type&&r!==i.type)return!1;var o,a=!0;switch(i.type){case"object":var l=Object.keys(i.attributes);for(o=0;o<l.length;o++)if(!(a=e(t[l[o]],n[l[o]],i.attributes[l[o]])))return a;break;case"array":if(i.partialContentAllowed){if(t.length>n.length)return!1;for(o=0;o<t.length;o++){a=!1;for(var s=0;s<n.length;s++)if(e(t[o],n[s],i.childStructure)){a=!0;break}if(!a)return a}a=!0}else{if(t.length!==n.length)return!1;for(o=0;o<t.length;o++)if(!(a=e(t[o],n[o],i.childStructure)))return a}break;case"string":case"boolean":case"number":a=t===n}return a}(e.context,t.context,n.attributes.context))}var w=function(){setTimeout(function(){if(g){var e=[],n=!1;if(1===h.getApplicativeControllers().length&&h.getApplicativeControllers()[0].getActiveState()){var i=h.getApplicativeControllers()[0].getApplicativeContainerID();if(-1!==a.indexOf(i)){n=!0;var r=t.getReviewContext({context:g}),o=h.getApplicativeControllers()[0].getCurrentAppContainerState();if(r&&r.getUIManager()){let t=b(r);if(t.length)for(var l,d=0;d<t.length;d++)(l=t[d].getSlideApplicativeContext(i))&&S(o,l,v[i])&&e.push(t[d])}}}if(s){var u=s.giveDMUSlidesController({context:g.getFrameWindow()});u&&n&&(u.setSlideFilteringAvailability(!0),u.setListOfFilteredSlides(e))}}},10)};c.onLeavingR3DApp=p.addEvent("onLeavingR3DApp",function(e){u.forEach(function(t){t&&t.controller&&t.controller.onLeavingApp&&t.controller.onLeavingApp(e)})}),c.onComparisonStarted=p.addEvent("onComparisonStarted",function(){u.forEach(function(e){e&&-1===l.indexOf(e.id)&&e.controller&&e.controller.getActiveState()&&(e.controller.setActiveState(!1),D.push(e))})}),c.onComparisonEnded=p.addEvent("onComparisonEnded",function(){D.forEach(function(e){e&&e.controller&&!e.controller.getActiveState()&&e.controller.setActiveState(!0)}),D.length=0}),c.onDMUObjectInitialized=p.addEvent("onDMUObjectInitialized",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUMarkup"===e.dmuObject.getType())&&(y(),w())}),c.onDMUObjectDeleted=p.addEvent("onDMUObjectDeleted",function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&(y(),w())}),c.onDMUSlideDisplayed=p.addEvent("onDMUSlideDisplayed",function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&w()}),c.onDMUObjectActiveFlagChanged=p.addEvent("onDMUObjectVisibleFlagChanged",function(e){e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&y()});var E=function(e){if(null===e&&n.empty(),s){var t=s.giveDMUSlidesController({context:g.getFrameWindow()});t&&t.setActiveSlide(e)}};let U=function(){let e;return function(t,n){return e=t&&t.version?t.version:0,function t(n,i){if(!i)return!0;Array.isArray(i)&&[].concat(i).some(t=>"fromVersion"in t?e>=t.fromVersion&&(i=t):"toVersion"in t?e<=t.toVersion&&(i=t):i=t);var r=typeof n;if("fromVersion"in i&&e<i.fromVersion)return void 0===n;if("toVersion"in i&&e>i.toVersion)return void 0===n;if(void 0===n)return!i.mandatory;if("array"===i.type&&!Array.isArray(n))return!1;if("array"!==i.type&&r!==i.type)return!1;var o,a=!0;switch(i.type){case"object":var l,s,d=Object.keys(i.attributes);for(o=0;o<d.length;o++){if((s=d[o].split("|")).length>1){let e=0;l=null;for(let t=0;t<s.length;++t)n[s[t]]&&(e++,l||(l=s[t]));if(1!==e)return!1}else l=d[o];if(!(a=t(n[l],i.attributes[d[o]])))return a}break;case"array":if(void 0!==i.minimal&&n.length<i.minimal)return!1;if(void 0!==i.maximal&&n.length>i.maximal)return!1;for(o=0;o<n.length;o++)if(!(a=t(n[o],i.childStructure)))return a}return a}(t,n)}}();this.initApplicativeContainer=function(e,n){var i=[];o.forEach(function(t){t.wkbID===e&&i.push(t.module)}),i.length&&require(["DS/DMUBaseUIControllers/DMUSlidesController"].concat(i),function(e,...i){s=e,i.forEach(e=>{if(g&&e.getApplicativeController){var i=e.getApplicativeController({context:g});i&&(u.push({id:i.getApplicativeContainerID(),controller:i,lib:e}),i.initializeAppContainer({onApplicativeControllerInitialized:function(){let e=t.getReviewContext({context:g}),r=e?e.getCurrentSessionMarkup():null;if(i.updateAppContainer({slidesEditableFlag:Boolean(r&&!r.isReadOnly()),slidesAppData:M(i.getApplicativeContainerID())}),n&&n.onReady){var o=[];u.forEach(function(e){o.push(e.controller)}),n.onReady(o)}w()},onDataWorkbenchReadyCB:function(e){p&&e&&p.fireEvent("onApplicativeContextCommandsRequired",e)},onPreferencesReadyCB:function(e){m&&e&&e.length&&(e.forEach(function(e){f.push(e.id)}),m.addPreferences(e))},options:n}),i.subscribe("onApplicativeContextActiveStateModified",function(e){if(C={},g&&e&&e.id&&(w(),e.state)){var n=t.getReviewContext({context:g});n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getCurrentSlide()&&E(n.getCurrentSessionMarkup().getCurrentSlide())}}),i.subscribe("onApplicativeContentChanged",function(e){if(g&&e&&e.id){var n,i=t.getReviewContext({context:g});if(u.some(function(t){if(t.id===e.id)return n=t.controller,!0}),n&&i&&i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isReadOnly()&&i.getCurrentSessionMarkup().isVisible()&&i.getCurrentSessionMarkup().getCurrentSlide()&&i.getCurrentSessionMarkup().getCurrentSlide().isVisible()){var r=h.getVerifiedApplicativeContainerState(e.id);if(r){var o=i.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id);o&&("FTA"===e.id&&o&&"number"!=typeof o.version?i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,r):(o.content=r.content,i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,o)),i.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlideApplicativeContextModified",{dmuObject:i.getCurrentSessionMarkup().getCurrentSlide()}))}}}}),i.subscribe("onApplicativeContextRequested",function(e){if(!g||!e||!e.id)return;w();let n=t.getReviewContext({context:g});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&(n.getCurrentSessionMarkup().isVisible()||e.forceDisplay)){var r=null;if(n.getUIManager().getFormatEditionModeFlag())return;let t=b(n);if(t.length){let n,a=[],l=[];for(let i=0;i<t.length;i++)(n=t[i].getSlideApplicativeContext(e.id))&&(l.push(n),a.push(t[i]));if(l.length){var o=i.getOrderedAppContainerStates(l,e.data);o&&o.length&&(C.id===e.id&&e.data&&JSON.stringify(e.data)===C.data?C.counter=C.counter+1:e.data&&(C={id:e.id,data:JSON.stringify(e.data),counter:0}),C.counter=C.counter%o.length,o&&o.length&&-1!==l.indexOf(o[0])&&(r=a[l.indexOf(o[C.counter])]))}}r?E(r):e.data&&e.data.selectedFeature&&p?p.fireEvent("onNewSlideCreationRequest"):E(null)}}),i.subscribe("onApplicativeContextChanged",function(e){if(C={},g&&e&&e.id){w();var n=t.getReviewContext({context:g});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().getCurrentSlide()&&n.getCurrentSessionMarkup().getCurrentSlide().isVisible()){if(n.getUIManager().getFormatEditionModeFlag())return;if(v[e.id]&&S(i.getCurrentAppContainerState(),n.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id),v[e.id]))return;E(null)}}}))}})})},this.removeApplicativeContainer=function(e){C.id===e&&(C={});for(var t=u.length-1;t>=0;t--)u[t]&&u[t].id===e&&(u[t].lib.unreferenceApplicativeController({context:g}),u.splice(t,1))},this.clear=function(){C={},D.length=0;for(var e=Object.keys(c),n=0;n<e.length;n++)p.removeEvent(c[e[n]]);t.unreferenceEventsController({viewer:g.getViewer()}),m&&(m.removePreferences(f),i.unreferencePreferenceManager({context:g.getFrameWindow()})),u.forEach(function(e){e.lib.unreferenceApplicativeController({context:g})}),g=m=null,f=[],u=[]},this.getVerifiedApplicativeContainerState=function(e){for(var t=0;t<u.length;t++)if(u[t].controller.getActiveState()&&u[t].controller.getApplicativeContainerID()===e){var n=u[t].controller.getCurrentAppContainerState();return v[e]&&!U(n,v[e])?void window.console.error("ERROR: the provided applicative container state does not match its structure."):n}},this.getApplicativeControllers=function(){var e=[];return u.forEach(function(t){t.controller.getActiveState()&&e.push(t.controller)}),e},this.getApplicativeContainersTICInfo=function(e,t){if(!e||"Issue"!==e&&"CA"!==e&&"IssueTemplate"!==e)return;var i,r=[],o=0,a=0,l=function(e){o++,e&&r.push(e),o===a&&t(r)};let s=[];n.get().map(e=>e.pathElement).forEach(e=>{if(e.getLastElement()&&e.getLastElement().getDMUType&&"DMUValidationExposedPresentation"===e.getLastElement().getDMUType()){let n=e.getLastElement().getOwner(),i=n.getParent();if(n&&i){let e=n.getPresentationSlideID(),r=i.getRepRef(n.getAttribute("sRepRefMarkupID"));var t=r?r.getMarkupContent():null;if(t&&e){let n=t.getSlides();for(let t=0;t<n.length;t++)if(n[t].getAttribute("sUuid")===e){s.push(n[t]);break}}}}});for(var d=0;d<u.length;d++)u[d].controller.getAppContainerTICInfo&&(i=M(u[d].controller.getApplicativeContainerID(),s.length?s:null))&&(a++,u[d].controller.getAppContainerTICInfo(e,i,l));a||t(r)}}}),d=[];return e.singleton({init:function(){},getDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t=!1,n=0;n<d.length;n++)if(d[n].context===e.context){t=!0;break}if(!t){var i=new s(e);d.push({context:e.context,appController:i})}return this.giveDMUApplicativeContextManager(e)}},giveDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t,n=0;n<d.length;n++)if(d[n].context===e.context){t=d[n].appController;break}if(t)return Object.freeze({initApplicativeContainer:function(e,n){t&&t.initApplicativeContainer(e,n)},getVerifiedApplicativeContainerState:function(e){return t?t.getVerifiedApplicativeContainerState(e):void 0},getApplicativeContainersTICInfo:function(e,n){return t?t.getApplicativeContainersTICInfo(e,n):void 0},removeApplicativeContainer:function(e){t&&t.removeApplicativeContainer(e)},getApplicativeControllers:function(){return t?t.getApplicativeControllers():void 0}})}},unreferenceDMUApplicativeContextManager:function(e){if(e&&e.context)for(var t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].appController&&d[t].appController.clear(),void d.splice(t,1)}})}),define("DS/DMUBaseUIControllers/DMUEnrichApplicativeController",["require","exports","DS/DMUControls/EXPNotify","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CoreEvents/ModelEvents","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,n,i,r,o,a){"use strict";class l{constructor(e){const t=this,l="POI",s=["ENO3DViewer_POI","ENO3DViewer_ZOI","ENO3DViewer_GP"];let d,u,g,c,p,m=!1,f=new r,h={},v=[],C=!1,D=[],b=!1,M=!1;function y(e,t){f.publish({event:e,data:t})}function S(i,r){t&&(u&&(u.destroy(),u=null),u=new n({body:e.context.getFrameWindow().getUIFrame(),type:i,message:r}))}function w({id:e}){m||t.setActiveState(!0),v.includes(e)||(v.push(e),D.includes(e)?(D.splice(D.indexOf(e),1),0===D.length&&g&&g()):M&&y("onApplicativeContextChanged",{id:l}))}function E({id:e}){const t=v.indexOf(e);-1!==t&&(v.splice(t,1),!C&&M&&y("onApplicativeContextChanged",{id:l}))}function U({id:e}){!C&&v.includes(e)&&y("onApplicativeContentChanged",{id:l})}this.setActiveState=(t=>{if(t!==m){if(m=t)h.layerModified=e.context.getController().get3DLayerController().subscribe({event:"layerModified"},U),h.layerDeleted=e.context.getController().get3DLayerController().subscribe({event:"layerDeleted"},E),p=i.getPreferenceManager({context:e.context.getFrameWindow()}),c=p.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences).repositories;for(let e=0;e<t.length;e++)if("DMURepository"===t[e].name)for(let n=0;n<t[e].preferences.length;n++)"CaptureSpecLayers"===t[e].preferences[n].name&&(M="true"===t[e].preferences[n].value)});else{const t=Object.keys(h);for(let n=0;n<t.length;n++)e.context.getController().get3DLayerController().unsubscribe(h[t[n]]);h={},c&&(p.unsubscribe(c),i.unreferencePreferenceManager({context:e.context.getFrameWindow()}),p=null)}y("onApplicativeContextActiveStateModified",{id:l,state:m})}}),this.getActiveState=(()=>m),this.subscribe=((e,t)=>f.subscribe({event:e},t)),this.unsubscribe=(e=>{f.unsubscribe(e)}),this.initializeAppContainer=(async({onApplicativeControllerInitialized:n})=>{d=e.context.getController().get3DLayerController().subscribe({event:"layerCreated"},w);const i=e.context.getController().streamLayers();i&&i.length&&(v=i.map(e=>e.id),t.setActiveState(!0));try{M="true"===(await a.readPreferences([{Repository:"DMURepository",PreferenceNames:["CaptureSpecLayers"]}])).repositories[0].preferences[0].value}catch(e){M=!1,window.console.warn("Could not get server value, default value set instead.",e)}n()}),this.updateAppContainer=(e=>{e.slidesAppData.length&&e.slidesAppData.some(e=>e.state&&e.state.context&&e.state.context.layerIds&&e.state.context.layerIds.length)&&t.setActiveState(!0)}),this.onLeavingApp=(e=>{"X3DPLAW_AP"===e.targetApp&&t.setActiveState(!1)}),this.displayAppContainerState=(t=>{if(t.state&&t.state.context&&t.state.context.layerIds&&t.state.context.layerIds.length)if(D=t.state.context.layerIds.filter(e=>!v.includes(e)),v.length!==t.state.context.layerIds.length||D.length){v.length=0;const n=()=>{g=void 0,S("info",o.noWidgetLinkedToEnrichView),C=!1,t.callback()};try{const i="DS/WidgetLink/WidgetLink";parent.require([i],i=>{try{let r=i.get(window.widget);if(!r||!r.getLinked().length)return void n();const a="DS/ENOXInterWdgCom/LinkManager";window.require([a],n=>{C=!0,n.publish("DS/ExternalWdgtCom/RestoreLayers",{layerIds:t.state.context.layerIds});let i=setTimeout(()=>{t.callback(),setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),C=!1}),S("warning",o.layersMayBeMissing)},5e3);g=(()=>{g=void 0,clearTimeout(i),t.callback(),setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),C=!1})})})}catch(e){n()}})}catch(e){n()}}else setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),t.callback()});else v.length&&M?(v.length=0,e.context.getController().enrich3D({}).then(t.callback)):t.callback()}),this.getCurrentAppContainerState=(()=>{if(M){const t=[],n=[];return(e.context.getController().streamLayers()||[]).forEach(e=>{s.includes(e.kind)&&(t.push(e.id),n.push({id:e.id,visible:e.visible,clustered:e.clustered,color:e.color}))}),{version:1,context:{layerIds:t},content:{layerOverloads:n}}}return{version:1,context:{},content:{}}}),this.getApplicativeContainerID=(()=>l),this.getOrderedAppContainerStates=(()=>{}),this.getCurrentAppContainerStateTitle=(()=>void 0),this.setMinimalUIFlag=(e=>{b=e}),this.getMinimalUIFlag=(()=>b),this.clean=function(){t.setActiveState(!1),d&&(e.context.getController().get3DLayerController().unsubscribe(d),d=null)}}}let s=[];return class{static getApplicativeController(e){let t;for(let n=0;n<s.length;n++)if(s[n].context===e.context)return t=s[n].controller,s[n].count++,t;let n=new l(e);return t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return!!n&&n.getActiveState()},subscribe:function(e,t){return n?n.subscribe(e,t):""},unsubscribe:function(e){n&&n.unsubscribe(e)},initializeAppContainer:function(e){n&&n.initializeAppContainer(e)},updateAppContainer:function(e){n&&n.updateAppContainer(e)},onLeavingApp:function(e){n&&n.onLeavingApp(e)},displayAppContainerState:function(e){n&&n.displayAppContainerState(e)},getCurrentAppContainerState:function(){return n?n.getCurrentAppContainerState():null},getApplicativeContainerID:function(){return n?n.getApplicativeContainerID():null},getOrderedAppContainerStates:function(e,t){return n?n.getOrderedAppContainerStates(e,t):null},getCurrentAppContainerStateTitle:function(){return n?n.getCurrentAppContainerStateTitle():void 0},setMinimalUIFlag:function(e){n&&n.setMinimalUIFlag(e)},getMinimalUIFlag:function(){return!!n&&n.getMinimalUIFlag()},clean:function(){n&&n.clean()}}),s.push({context:e.context,controller:t,count:1}),t}static giveApplicativeController(e){if(e&&e.context)for(let t=0;t<s.length;t++)if(s[t].context===e.context)return s[t].controller}static unreferenceApplicativeController(e){if(e&&e.context)for(let t=0;t<s.length;t++)if(s[t].context===e.context){s[t].count--,0===s[t].count&&(s[t].controller.clean(),s.splice(t,1));break}}}}),define("DS/DMUBaseUIControllers/DMUGraphicPropertiesCtr",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUControls/panels/DMUGraphicPropertiesPanel","DS/DMUControls/panels/DMUCustomColorPanel","DS/DMUBaseExperience/DMUContextManager","DS/Utilities/TouchUtils","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIControllers/DMUWebPreferencesController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u){"use strict";var g=e.extend({init:function(e){this._parent(e);var g,c,p,m,f,h,v=!1,C=(e||{}).ctxViewer,D=this,b=[];function M(){c&&c.clean(),c=null,p&&p.clean(),p=null,m&&m.clean(),m=null,f&&f.clean(),f=null}function y(e,t,n){var i,r;for(let o=0;o<t.length;o++)if(t[o].hasAttribute(e)&&!t[o].isAttributeReadOnly(e)&&(void 0===r&&(r=t[o].getAttribute(e)),void 0===r&&void 0!==n&&(r=n),i=t[o].getAttribute(e),JSON.stringify(i)!==JSON.stringify(r)))return null;return i}function S(){C.render();var e=a.getReviewContext({viewer:C.getViewer()});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().isVisible()&&e.getCurrentSessionMarkup().getCurrentSlide()&&e.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:e.getCurrentSessionMarkup().getCurrentSlide()})}function w(){m&&(m.clean(),f.clean(),f=m=null)}function E(e){localStorage.setItem("DMUGraphicPropertiesCustomColors",JSON.stringify(e.customColors)),c.setCustomColors(e.customColors),e.selectedColor&&c.setCurrentColor(e.selectedColor),w()}function U(e){if(m)w();else{m=new o({touchMode:l.getTouchMode()});var t=localStorage.getItem("DMUGraphicPropertiesCustomColors"),n=[];t&&(n=JSON.parse(t));let a=l.getTouchMode()?405:365;var r={id:"DMUCustomColorPanel",className:"DMUCustomColorPanel",title:u.grpCustomColorPanel,showTitleFlag:!0,frameWindow:C.getFrameWindow(),immersiveFrame:C.getFrameWindow().getImmersiveFrame(),content:m.build(n),minWidth:a,width:a,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:w};(f=new i(r)).setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-100}),m.setCurrentCustomColor(e),m.subscribe("onCustomColorPanelOk",E),m.subscribe("onCustomColorPanelCancel",w)}}function x(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("bIsFilled")||(b[t].setAttribute("bIsFilled",e),b[t].refreshNode());c.update({hasBorder:y("bHasBorder",b)}),S()}function O(e,n){for(var i=0;i<b.length;i++)b[i].isAttributeReadOnly(e)||(b[i].setAttribute(e,new t.Color(n)),b[i].refreshNode());S()}function P(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fOpacity")||(b[t].setAttribute("fOpacity",e),b[t].refreshNode());S()}function R(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("bHasBorder")||(b[t].setAttribute("bHasBorder",e),b[t].refreshNode());c.update({isFilled:y("bIsFilled",b)}),S()}function A(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("sLineStylePattern")||(b[t].setAttribute("sLineStylePattern",e),b[t].setAttribute("sLeaderStylePattern",e),b[t].refreshNode());S()}function I(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fLineStyleThicknessIndex")||(b[t].setAttribute("fLineStyleThicknessIndex",e),b[t].setAttribute("fLeaderStyleThicknessIndex",e),b[t].refreshNode());S()}function k(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fLineStyleOpacity")||(b[t].setAttribute("fLineStyleOpacity",e),b[t].refreshNode());S()}function V(e){for(var t=0;t<b.length;t++)b[t].setAttribute("fFontSize",e),b[t].refreshNode();S()}function T(e){for(var t=0;t<b.length;t++)b[t].setAttribute("sFontStyle",e),b[t].refreshNode();S()}function j(e){if(M(),!v)return;let t=y("sLineStylePattern",b);t&&(t=parseFloat(t));let n=y("fLineStyleThicknessIndex",b);var o={unitDetails:d.getCurrentUnit("Length"),isFilled:y("bIsFilled",b),hasBorder:y("bHasBorder",b),fillColor:y("cFillStyleColor",b),lineColor:y("cLineStyleColor",b),fillOpacity:y("fOpacity",b,0),thickness:void 0!==n?n:s.getLineThicknessIndex(y("fLineStyleThickness",b)),lineOpacity:y("fLineStyleOpacity",b,0),pattern:t,fontColor:y("cFontColor",b),fontStyle:y("sFontStyle",b),fontSize:y("fFontSize",b)};let a=localStorage.getItem("DMUGraphicPropertiesCustomColors");c||(c=new r({touchMode:l.getTouchMode()})),c.subscribe("onFilledPropertyChanged",x),c.subscribe("onFillColorChanged",function(e){O("cFillStyleColor",e)}),c.subscribe("onLineColorChanged",function(e){O("cLineStyleColor",e),O("cLeaderStyleColor",e)}),c.subscribe("onTextColorChanged",function(e){O("cFontColor",e)}),c.subscribe("onFillOpacityChanged",P),c.subscribe("onHasBorderPropertyChanged",R),c.subscribe("onLineTypeChanged",A),c.subscribe("onLineThicknessChanged",I),c.subscribe("onLineOpacityChanged",k),c.subscribe("onFontSizeChanged",V),c.subscribe("onFontStyleChanged",T),c.subscribe("onCustomColorPanelRequired",U),c.subscribe("onActiveTabChanged",function(e){localStorage.setItem("DMUGraphicPropsPanelActiveTab",e.activeTab)});var g=c.build({values:o,activeTab:localStorage.getItem("DMUGraphicPropsPanelActiveTab"),customColors:a?JSON.parse(a):[]});if(!p&&g){var m={id:"DMUGraphicPropsPanel",className:"DMUGraphicPropsPanel",title:u.grpPanel,showTitleFlag:!0,frameWindow:C.getFrameWindow(),immersiveFrame:C.getFrameWindow().getImmersiveFrame(),content:g,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:function(){D&&D.setActiveState(!1)}};if(p=new i(m),e)p.setPanelPosition({offsetX:e.x,offsetY:e.y});else{var f=C.getFrameWindow().getContextualUIManager().getContextualBar(),h=f?f.getPosition():null,S=l.getTouchMode()?300:200;h?p.setPanelPosition({offsetX:h.x+f.elements.container.getDimensions().width/2-S/2,offsetY:h.y-S/2}):p.setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-S/2}),f&&f.hide()}}}function F(){v&&(h&&(clearTimeout(h),h=null),h=setTimeout(()=>{b.length=0;let e=n.get();if(e&&e.length){var t=a.getReviewContext({viewer:C.getViewer()}),i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),e.forEach(function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&b.push(t)}),b.length)return void j(p?p.getAbsolutePosition():void 0)}D.setActiveState(!1)}))}this.setActiveState=function(e){if(v!==e)if(v=e,b.length=0,v){g||((g={}).onAdd=n.onAdd(F),g.onRemove=n.onRemove(F),g.onEmpty=n.onEmpty(F));var t=a.getReviewContext({context:C});if(t){var i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),!i)return void(v=!1);if(n.get().forEach(function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&b.push(t)}),!b.length)return void D.setActiveState(!1);j()}}else g&&(n.unsubscribe(g.onAdd),n.unsubscribe(g.onRemove),n.unsubscribe(g.onEmpty),g=null),M();else if(v){let e=C.getFrameWindow().getContextualUIManager().getContextualBar();e&&e.hide()}},this.getActiveState=function(){return v},this.clearController=function(){D.setActiveState(!1),h&&(clearTimeout(h),h=null),p=c=C=D=null}}}),c=[];return e.singleton({init:function(){},getDMUGraphicPropsController:function(e){var t=this.giveDMUGraphicPropsController(e);if(!t&&e&&e.context){var n=new g({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},clearController:function(){n&&(n.clearController(),n=null)}}),c.push({context:e.context,graphicPropsController:t})}return t},giveDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<c.length;t++)if(c[t].context===e.context)return c[t].graphicPropsController},unreferenceDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<c.length;t++)if(c[t].context===e.context){c[t].graphicPropsController.clearController(),c.splice(t,1);break}}})}),define("DS/DMUBaseUIControllers/DMUSlidesController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUControls/panels/DMUSlidesPanel","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/DMUBaseExperience/DMUContextManager","DS/UIKIT/Spinner","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/CATWebUXThumbnail","DS/CATWebUXComponents/DMUCommandsManager","DS/ApplicationFrame/ContextualMenu","DS/ApplicationFrame/ContextualBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUToolsClipping","DS/DMUBaseExperience/EXPManagerSet","DS/DMUControls/EXPNotify","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g,c,p,m,f,h,v,C,D,b,M,y,S,w,E,U,x,O,P){"use strict";let R=e=>{if(!e||!e.context)return;let n=e.opts&&"number"==typeof e.opts.duration?e.opts.duration:400,i=o.getReviewContext({context:e.context}),r=i?i.getCurrentSessionMarkup():null;if(r){let a=r.getCurrentSlide();if(C.cleanClippingFromSlide(a),e.onBeforeApplySlide&&e.onBeforeApplySlide({previousSlide:a,nextSlide:e.slide}),r.setCurrentSlide(e.slide),a&&a.refreshNode(),e.slide){e.context.getViewer().getVisibleSpace()||(e.context.getViewer().swapVisibleSpace(),e.context.getViewer().render());let r,a=e.slide,l=e.viewpoint,s=a.getAttribute("mRelativePosMatrix");if(s){let e=a.getAttribute("sPointedReference"),n=i.getEnvironment(),o=g.getAbsolutePositionMatrix(a,s,e);if(o){let e=new t.Vector3,i=new t.Vector3;o.extractBasis(new t.Vector3,i,e);let a=(new t.Vector3).getPositionFromMatrix(o);r={vViewpointPosition:a,vViewpointSight:e,vViewpointUp:i,iViewpointType:n.getAttribute("iViewpointType"),fViewpointFieldOfView:n.getAttribute("fViewpointFieldOfView"),fViewpointTargetDistance:n.getAttribute("fViewpointTargetDistance")}}}let d,u=function(){a.refreshNode(),setTimeout(()=>{e.onSlideActivated&&e.onSlideActivated({slide:a})},n)},c=()=>{i.getEnvironment().refresh({duration:n,viewpoint:l,envInfos:r}),e.context.getController&&e.context.getController().forceRefresh();let t=S.giveDMUApplicativeContextManager({context:e.context}),o=t?t.getApplicativeControllers():[];if(o&&o.length){let e=0,t=function(){++e===o.length&&u()};for(let e=0;e<o.length;e++)o[e].displayAppContainerState({state:a.getSlideApplicativeContext(o[e].getApplicativeContainerID()),callback:t,noCtxChangedEvt:!0})}else u()},p=!1,m=a.getDMUObjects();for(let e=0;e<m.length;e++)if(-1!==m[e].getType().indexOf("DMUCompare")&&(d=m[e],"DMUCompareRequirement"===m[e].getType())){p=!0;break}if(!d&&a.getPointedFormats&&a.getPointedFormats().length){m=a.getPointedFormats()[0].getDMUObjects();for(let e=0;e<m.length;e++)if(-1!==m[e].getType().indexOf("DMUCompare")&&(d=m[e],"DMUCompareRequirement"===m[e].getType())){p=!0;break}}if(d){if(!p){let t,n,i=o.giveEventsController({viewer:e.context.getViewer()});if(!i)return;n=i.addEvent("onComparisonDisplayed",()=>{i.removeEvent(n),i.removeEvent(t),c()}),t=i.addEvent("onComparisonEnded",()=>{i.removeEvent(n),i.removeEvent(t),c()})}a.fireEvent("onDMUSlideCompareDisplayRequired",{dmuObject:a})}else c();let f=C.getClippingCmdService();f&&f.updateClippingCommandState({contextViewer:o.getContextViewer({viewer:e.context.getViewer()}),reviewContext:o.getReviewContext({viewer:e.context.getViewer()}),slideActivateEvent:!0})}else e.onSlideActivated&&e.onSlideActivated({slide:e.slide});e.context.getViewer().render()}};var A=e.extend({init:function(e){this._parent(e);var g,A,I,k,V,T,j,F,N,L,B,H,W,q,_,z,X,G,K,J,Z=e||{},Q=this,Y=!1,$=[],ee=[],te=[],ne=[],ie=Z.context,re=!0,oe=!0,ae=new r,le=!1,se=[],de=null,ue=!1,ge=!0,ce=new t.Vector2,pe=!1,me=[],fe=!0,he={},ve={},Ce=o.getContextViewer({viewer:ie.getViewer()}),De=!1,be=o.giveEventsController({viewer:ie.getViewer()});let Me,ye,Se,we=1,Ee=null;var Ue,xe;window.require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],e=>{e&&(Ee=e)});var Oe=new Map;Oe.set("PRIVATE","IN_WORK"),Oe.set("IN_WORK","FROZEN"),Oe.set("FROZEN","RELEASED"),Oe.set("RELEASED","OBSOLETE"),Oe.set("OBSOLETE",void 0);var Pe=new Map;Pe.set("PRIVATE",void 0),Pe.set("IN_WORK","PRIVATE"),Pe.set("FROZEN","IN_WORK"),Pe.set("RELEASED",void 0),Pe.set("OBSOLETE",void 0);var Re=new Map;Re.set("PRIVATE","#9b2c98"),Re.set("IN_WORK","#007da3"),Re.set("FROZEN","#018308"),Re.set("RELEASED","#757575"),Re.set("OBSOLETE","#80808080");var Ae,Ie=new Map;function ke(){return o&&"R2V"===o.getCurrentReviewContext()}function Ve(){de&&void 0!==de.getEnvironmentOverload().state.b360Mode&&(Ce.getViewer().get360Mode()||de.getEnvironmentOverload().state.b360Mode||Be(de))}function Te(){var e=o.getReviewContext({viewer:ie.getViewer()}),t=e&&!e.getValidation()?e.getCurrentSessionMarkup():null;if(t){var n=t.getSlides(),i=t.getAttribute("sCurrentSlideId");if("string"==typeof i){for(var r=0;r<n.length;r++)if(n[r].getAttribute("sID")===i){Q.setActiveSlide(n[r]);break}}else n.length&&Q.setActiveSlide(n[0])}}function je(e,t){return!(e&&!t)&&(!(!e&&t)&&(Math.round(1e3*e.x)/1e3==Math.round(1e3*t.x)/1e3&&(Math.round(1e3*e.y)/1e3==Math.round(1e3*t.y)/1e3&&Math.round(1e3*e.z)/1e3==Math.round(1e3*t.z)/1e3)))}function Fe(e,t){return!(je(e.vViewpointSight,t.vViewpointSight)&&je(e.vViewpointUp,t.vViewpointUp)&&je(e.vViewpointPosition,t.vViewpointPosition))||!t.b360Mode&&Math.round(1e3*e.fViewpointTargetDistance)/1e3!=Math.round(1e3*t.fViewpointTargetDistance)/1e3||e.iViewpointType!==t.iViewpointType||e.b360Mode!==t.b360Mode}function Ne(e){if(!e)return"";let t=e.getAttribute("sUuid");return t||(t="MarkupID_"+e.parentID+"_SlideID_"+e.getAttribute("sID")),t}function Le(e,t,n){return new Promise(t=>{Ee&&(Ee.give3DGridController({context:e})&&t());t()})}async function Be(e){let t=e||de;if(!(Y&&oe&&ie.getViewer().getVisibleSpace()&&t&&t.isDisplayed()))return;var n=o.getReviewContext({viewer:ie.getViewer()}),i=n?n.getCurrentSessionMarkup():null;if(!i||i&&!i.getActiveFlag()||i&&i.getActiveFlag()&&!i.isVisible()||i&&i.getActiveFlag()&&i.isVisible()&&i.isImporting())return;var r=n.getEnvironment().getEnvironmentInfo(),a=Fe(r,n.getEnvironment().getCurrentSlideEnvironmentInfo());a&&(n.getEnvironment().refresh({duration:0}),ie.getViewer().render());let l=t?(t.getDMUObjects("DMUClipping")||[]).filter(e=>!e.getAttribute("bClippingActiveState")):[],s=t?(t.getDMUObjects("DMUSection")||[]).filter(e=>!e.getAttribute("bClippingActiveState")):[],d=t?t.getDMUObjects("3DGrid"):[];await Le(Ce,0,d.length&&d[d.length-1]);let u=l.concat(s);u.length&&await ze(Ce,!1);let c=C.getClippingCmdService();c&&c.setClippingVisualizationState(Ce,u,!0);var p,m,f=await y.computeImage({viewer:ie.getViewer(),width:200,height:113});if(c&&c.setClippingVisualizationState(Ce,u,!1),u.length&&await ze(Ce,!0),await Le(Ce),g){let e=Ne(t);g.updateSlide(e,{img:f.src}),J&&J.has(e)&&J.get(e).forEach(e=>e.setPreview(f.src)),p="onSlidePreviewUpdated",m={slide:t,img:f.src},ae.publish({event:p,data:m,context:Q})}if(!t.isReadOnly()){let e=x.convertImageDataUrl(f.src);e&&(t.setAttribute("sImageType",e.type),t.setAttribute("sImageData",e.data))}a&&(n.getEnvironment().refresh({envInfos:r,duration:0}),ie.getViewer().render())}async function He(e){let t;if(e){const n=144,i=108,r=(t=document.createElement("canvas")).getContext("2d");if(r){const t=await new Promise(t=>{let n=new Image;n.onload=function(){t(n)},n.src=e.getPreview()}),o=Math.floor(t.height*n/i);r.drawImage(t,(t.width-o)/2,0,o,t.height,0,0,n,i)}}return e&&t?t.toDataURL("image/png"):null}async function We(e){const t=await He(e);be&&be.fireEvent("onPreviewThumbnailUpdateRequested",{elementId:e?e.getAttribute("sUuid"):void 0,thumbnailData:t})}function qe(){oe&&(z&&(clearInterval(z),z=null),Ae&&clearTimeout(Ae),Ae=setTimeout(function(){Ae=null,Y&&"false"!==localStorage.getItem("DMUAutomaticThumbnailRefresh")&&(z=setInterval(function(){if(!De&&!h._isShown&&!f._isShown){var e=o.getReviewContext({viewer:ie.getViewer()}),t=e?e.getUIManager():null,n=t?t.getSelectedObjects():void 0;if(t&&n){for(var i=0;i<n.length;i++)if("DMUSlide"!==n[i].getType()&&"DMUFormat"!==n[i].getType())return;clearInterval(z),z=null,Ae=setTimeout(()=>{if(De)return qe();Be().then(()=>{if(de){const e=de.getAttribute("sUuid");e&&e===Se&&We(de),de&&de.getAssociatedHighlightData&&de.getAssociatedHighlightData().length&&He(de).then(t=>{be&&be.fireEvent("onPreviewUpdateOnHighlightRequested",{elementId:e,imageData:t})})}})},ke()?1e3:500)}}},100))},100))}let _e;function ze(e,t){if(!_e)return new Promise(n=>{window.require(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"],i=>{i&&(_e=i,Ce&&i.setSectionVisibilityFlag(e,t)),n()},n)});_e.setSectionVisibilityFlag(e,t)}var Xe;function Ge(e){ie&&(Xe&&clearTimeout(Xe),Xe=setTimeout(async function(){Xe=null;var t=o.getReviewContext({viewer:ie.getViewer()});if(t){var n=function(e){if(!e)return;function t(e){let t;return!!(e&&((!(t=e.getDMUObjects("DMUClipping"))||t&&0===t.length)&&(t=e.getDMUObjects("DMUSection")),t&&t.length>0))}let n,i=!1,r=!1,o=e.getCurrentSessionMarkup();o&&o.getActiveFlag()&&o.isVisible()&&o.getCurrentSlide&&(i=t(n=o.getCurrentSlide()));var a=e.getTransientReviewBag();return r=t(a),i||n&&!r?n:a}(t);if(n){var i=n.areSectionPlanesDisplayed?!n.areSectionPlanesDisplayed():!function(e){if(!e||!e.getDMUObjects)return!1;let t;if(0!==e.getDMUObjects("DMUSection").length||0!==e.getDMUObjects("DMUClipping").length){let n=e.getDMUObjects("DMUSection");for(t=0;t<n.length;t++)if(n[t].isSectionDisplayed())return!0;let i=e.getDMUObjects("DMUClipping");for(t=0;t<i.length;t++)if(i[t].isSectionDisplayed())return!0}return!1}(n);await ze(Ce,i);var r,a=S.giveDMUApplicativeContextManager({context:Ce}),l=a?a.getApplicativeControllers():[];if(l&&l.length)for(r=0;r<l.length;r++)l[r].setAppSectionPlanesVisibleFlag&&l[r].setAppSectionPlanesVisibleFlag(i)}}e&&qe()},10))}function Ke(){if(g&&(g.setSlideTitleVisibleFlag(!!le||(void 0!==L?L:N)),J)){let e=J.keys();for(let t=0;t<J.size;t++){let t=e.next().value,n=J.get(t);for(let e=0;e<n.length;e++)n[e].setTitleAndIconSectionVisibleFlag(void 0!==L?L:N)}}}function Je(e){let t=D.getManager({name:"DMU2DSheetManager",context:ie});if(t&&t.isADocumentDisplayed())return;let n=e.slide.getEnvironmentOverload();if(n){let t=n.state;if(!(t&&t.vViewpointPosition&&t.vViewpointRight&&t.vViewpointSight&&t.vViewpointUp))return void window.console.error("State overload is not defined");let o={protocol:"3DXContent",version:"2.0",data:{items:[{serviceId:"3DSpace",envId:w.getPlatformId(),contextId:E.getSetting("pad_security_ctx")?E.getSetting("pad_security_ctx"):void 0,objectId:"",objectType:"DMUSlideView",objectOverloads:[],dmuObjects:[],environmentOverload:{targetDistance:t.fViewpointTargetDistance,viewpointAngle:t.fViewpointFieldOfView||Ce.getViewpoint().getAngle(),viewpointPosition:{x:t.vViewpointPosition.x,y:t.vViewpointPosition.y,z:t.vViewpointPosition.z},viewpointRight:{x:t.vViewpointRight.x,y:t.vViewpointRight.y,z:t.vViewpointRight.z},viewpointSight:{x:t.vViewpointSight.x,y:t.vViewpointSight.y,z:t.vViewpointSight.z},viewpointUp:{x:t.vViewpointUp.x,y:t.vViewpointUp.y,z:t.vViewpointUp.z}}}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},a=[],l=e.slide.getObjectOverloads();if(l)for(let e=0;e<l.length;e++)if(l[e].state.hasOwnProperty("bVisible")){let t=l[e].target.getOccurrenceIDPath();o.data.items[0].objectOverloads.push({data:{type:"Visible",value:l[e].state.bVisible},targetPath:t}),a.push(JSON.stringify(t))}let s=e.slide.getPointedFormats();if(s&&s.length){let e=s[0].getObjectOverloads();if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t].state.hasOwnProperty("bVisible")){let n=e[t].target.getOccurrenceIDPath();a.includes(JSON.stringify(n))||o.data.items[0].objectOverloads.push({data:{type:"Visible",value:e[t].state.bVisible},targetPath:n})}}var i=function(e){return e&&e.getAttribute("bVisible")&&e.getAttribute("bClippingActiveState")},r=function(e,t){if(!e)return{};var n=function(e){let t=[];return e&&(t=[255*e.r,255*e.g,255*e.b]),t};let i=[],r=e.getAttribute("mPlaneReferential");r&&(i=r.elements);var o=e.getAttribute("fOpacity");return o&&(o*=255),{type:t||"Clipping",data:{offset:e.getAttribute("fSliceOffset"),xDirSize:e.getAttribute("fXDirSize"),yDirSize:e.getAttribute("fYDirSize"),planeBoxMode:e.getClippingModeForDragDrop(),planeReferential:i,sectionCurvesVisible:Boolean(e.getAttribute("bSectionCurvesVisible")),customCappingColor:e.isCustomColorSorce("Capping"),cappingColor:n(e.getAttribute("cCappingColor")),customContourColor:e.isCustomColorSorce("Contour"),lineStyleColor:n(e.getAttribute("cLineStyleColor")),lineStyleThickness:e.getAttribute("fLineStyleThickness")||e.getAttribute("fLineStyleThicknessIndex"),lineStylePattern:e.getAttribute("sLineStylePattern")||1,fillStyleColor:n(e.getAttribute("cFillStyleColor")),fOpacity:o,clippingPlaneVisible:e.getAttribute("bClippingPlaneVisible")||!1,hatchingDisplay:e.getAttribute("bHatchingDisplay"),hatchingColor:n(e.getAttribute("cHatchingColor")),hatchingLineStyleThickness:e.getAttribute("fHatchingLineStyleThickness"),hatchingAnglesMode:e.getAttribute("sHatchingAnglesMode"),hatchingSingleAngleValue:e.getAttribute("fHatchingSingleAngleValue"),hatchingPitchValue:e.getAttribute("fHatchingPitchValue")}}};let d=e.slide.getDMUObjects("DMUSection");if(d&&d.length?i(d[0])&&o.data.items[0].dmuObjects.push(r(d[0],"Section")):(d=e.slide.getDMUObjects("DMUClipping"))&&d.length&&i(d[0])&&o.data.items[0].dmuObjects.push(r(d[0])),s&&s.length&&0===o.data.items[0].dmuObjects.length){let e=s[0].getDMUObjects("DMUSection");e&&e[0]?i(e[0])&&o.data.items[0].dmuObjects.push(r(e[0],"Section")):(e=s[0].getDMUObjects("DMUClipping"))&&e[0]&&i(e[0])&&o.data.items[0].dmuObjects.push(r(e[0]))}let u={id:e.id,parentSlideId:e.parentSlideID,data:JSON.stringify(o)};g&&g.setSlideDragContent(u)}}function Ze(e){if(e)for(let t=0;t<$.length;t++)if($[t].id===e){Je($[t]);break}}function Qe(){if(!g)return;let e=!g.getPanelActiveFlag();g&&g.setPanelActiveFlag(e);var t,n=l.get();for(t=n.length-1;t>=0;t--)n[t].pathElement&&n[t].pathElement.getLastElement(!0).getDMUType&&l.remove(n[t]);for(t=(n=s.get()).length-1;t>=0;t--)n[t].pathElement&&n[t].pathElement.getLastElement(!0).getDMUType&&s.remove(n[t]);var i=o.getReviewContext({viewer:ie.getViewer()});i&&(i.getTransientReviewBag().removeDMUObjects(),i.getUIManager().setMarkupVisualizationActiveState(Boolean(e&&i.getCurrentSessionMarkup())))}function Ye(){g&&Y&&!g.getPanelActiveFlag()&&Qe()}function $e(){return g?g.getColumnMinimumWidth():250}function et(){return g?g.getColumnWidthStep():233}function tt(){if(A){if(sessionStorage)if("true"===sessionStorage.getItem("DMUSlidesExpFlag_"+widget.id))sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"false"),A.setWidth($e());else{var e=parseFloat(sessionStorage.getItem("DMUSlidesWidth_"+widget.id));e&&e!==$e()&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),A.setWidth(e))}g&&g.resizePanel({width:A.getWidth(),height:A.getHeight()})}}function nt(){g&&(g.resetSlideDisplayHistory(),de&&g.setActiveSlide(Ne(de))),W&&W.destroy(),W=new b({body:ie.getUIFrame(),type:"info",message:P.displayHistoryRemoved})}function it(e,t){if(Ye(),e&&e.id){g&&g.setActiveSlide(e.id,t);for(var n=0;n<$.length;n++)if($[n].isActiveSlide=$[n].id===e.id,$[n].id===e.id){l.empty(),Q.setActiveSlide($[n].slide,{updatePreviousPreview:!0});break}}A&&A.isSmallWidth()&&A.collapsePanel()}function rt(e){if(!k)for(var t=0;t<$.length;t++)if($[t].id===e.id){var n=v.buildPathElement($[t].slide.getNode());e.prehighlightedFlag?d.add({pathElement:n}):d.remove({pathElement:n})}}function ot(e){if(!k)for(var t=0;t<$.length;t++)if($[t].id===e.id){var n=v.buildPathElement($[t].slide.getNode());e.checkFlag?l.add({pathElement:n}):l.remove({pathElement:n})}}async function at(e){if(de){l.empty();var t=m.getCommand("sectionCmdHdr",Ce.getCommandContext());t&&t.isRunning()&&t.cancel&&t.cancel(),await Be(de)}for(let t=0;t<$.length;t++)$[t].id===e.id&&(K=$[t].slide);m.getCommand("DMUCreateSlideReplyHdr",Z.commandContext).begin(),A&&A.isSmallWidth()&&A.collapsePanel()}function lt(e){var t,n=o.getReviewContext({viewer:ie.getViewer()}),i=n?n.getValidation():null;if(i){let n=i.getRepRef(e.markupID);t=n?n.getMarkupContent():null}else t=n?n.getCurrentSessionMarkup():null;if(t&&e.orderedSlideIDs&&e.orderedSlideIDs.length){let n=le?t.getFormats():t.getSlides();e.orderedSlideIDs.forEach(function(e){let t=n.findIndex(t=>t.getAttribute("sUuid")===e);if(t>=0){let e=n.splice(t,1)[0];n.push(e)}}),t.setAttribute(le?"lFormats":"lSlides",n),be&&be.fireEvent("onSaveRequested")}}function st(e){var t=o.getReviewContext({viewer:ie.getViewer()}),n=t?t.getValidation():null;n&&e.orderedMarkupIDs&&n.reorderMarkups(e.orderedMarkupIDs)}function dt(){fe&&(X||(X=setInterval(function(){if(!G&&!De){if(clearInterval(X),X=null,g&&g.removeSlideUpdateRequiredFlags(),!Y||k||!g||se.length||ue||!g.getPanelActiveFlag()||!fe||!ie)return;let t=o.getReviewContext({viewer:ie.getViewer()});const n=de&&de.getParent(),i=Boolean(de&&de.getAttribute("sParentSlideID"));if(de&&!de.isReadOnly()&&de.getActiveFlag()&&n&&t&&t.getRestrictions(n)[i?"reply":"markup"].canEdit){var e=de.getEnvironmentOverload();if(e)Fe(e=e.state,o.getReviewContext({viewer:ie.getViewer()}).getEnvironment().getEnvironmentInfo())?g.setSlideUpdateRequiredFlag(Ne(de),!0):ke()&&Be()}}},100)))}function ut(e){for(var t=0;t<$.length;t++)if($[t].id===e.id){var n=m.getCommand("DMUUpdateFormatSessionOverloadHdr",Z.commandContext);return n&&n.begin(),void dt()}}function gt(){Ye();var e=m.getCommand(le?"DMUExitFormatsHdr":"DMUEditFormatsHdr",Z.commandContext);e&&e.begin()}function ct(){Ye(),l.empty();var e=m.getCommand("DMUEditPropertiesHdr",Z.commandContext);e&&e.begin()}function pt(e){Ye();for(var t=0;t<$.length;t++)if($[t].id===e.id)return $[t].slide.setAttribute("sName",e.title),J&&J.has(e.id)&&J.get(e.id).forEach(t=>t.setThumbnailTexts({title:e.title})),be&&be.fireEvent("onDMUSlideNameChanged",{dmuObject:$[t].slide,value:e.title}),void($[t].title=e.title)}function mt(e){for(var t=0;t<te.length;t++)if(te[t].id===e.id&&te[t].content){let i=te[t].content.getMarkupContent();if(i){var n=v.buildPathElement(i.getNode());l.empty(),s.empty(),l.add({pathElement:n}),d.add({pathElement:n}),ce=e.position.clone(),ie.getExecutionContext?ie.getContextualUIManager()._showContextMenu(ce):ie.getContextualUIManager()._showContextualMenu(ce)}}}function ft(e){if(be){let i=!1;for(var t=0;t<te.length;t++)if(te[t].id===e.id){i=!0;break}if(i){var n=o.getReviewContext({viewer:ie.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return be.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}}}function ht(e){for(var t=0;t<$.length;t++)if($[t].id===e.id){K=$[t].slide;var n=v.buildPathElement($[t].slide.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||e.openFromButton||(l.empty(),s.empty()),l.add({pathElement:n}),ce=e.position.clone();var i=D.getManager({name:"DMUUserExperienceManager",context:ie});i&&i.setCCPTarget($[t].slide),ie.getExecutionContext?ie.getContextualUIManager()._showContextMenu(ce):ie.getContextualUIManager()._showContextualMenu(ce)}}function vt(e){e?we++:we--,A&&A.setEnableFlag(we>0)}function Ct(){if(ie&&Q){var e=D.getManager({name:"DMU2DSheetManager",context:ie});!e||!e.isADocumentDisplayed()&&!e.isRunning()||"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType()?Q.setVisibleFlag(!0):Q.setVisibleFlag(!1)}}function Dt(){A&&A.setPanelVisibilityFlag((te&&te.length||$&&$.length>0)&&oe)}if(Ie.set("PRIVATE",P.maturityValue.PRIVATE),Ie.set("IN_WORK",P.maturityValue.IN_WORK),Ie.set("FROZEN",P.maturityValue.FROZEN),Ie.set("RELEASED",P.maturityValue.RELEASED),Ie.set("OBSOLETE",P.maturityValue.OBSOLETE),this.subscribe=function(e,t){if(e&&t)return ae.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&ae.unsubscribe(e)},be){var bt=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(q=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:w.getPlatformId(),serviceId:"3DSpace",contextId:E.getSetting("pad_security_ctx")?E.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),g&&g.setDragContent(q))},Mt=o.getReviewContext({viewer:ie.getViewer()});Mt&&bt(Mt.getReviewCtxInformation()),he.onReviewCtxInformationChanged=be.addEvent("onReviewCtxInformationChanged",bt),he.onDMUSlidePreferencesChanged=be.addEvent("onDMUSlidePreferencesChanged",function(){var e=u.getSlidePreferences({context:ie});if(e&&(e.panelTitle&&"string"==typeof e.panelTitle&&T!==e.panelTitle&&(T=e.panelTitle,!V&&g&&g.setPanelTitle(T)),"boolean"==typeof e.displaySlideTitle&&N!==e.displaySlideTitle&&(L=e.displaySlideTitle,Ke()),e.slideDragAndDropOperation)){Me="TransferView"===e.slideDragAndDropOperation;let t=D.getManager({name:"DMU2DSheetManager",context:ie});g&&(t&&t.isADocumentDisplayed()?g.enableDragContent(!1):g.enableDragContent(Me))}}),he.onDMUSlideAssociatedToHighlight=be.addEvent("onDMUSlideAssociatedToHighlight",function(e){e&&e.dmuObject&&e.dmuObject.getAssociatedHighlightData&&Q.updateSlide(e.dmuObject,{highlights:e.dmuObject.getAssociatedHighlightData()})}),he.onApplyingSlideView=be.addEvent("onApplyingSlideView",function(){let e=o.getReviewContext({viewer:ie.getViewer()});if(e){e.getUIManager().setMarkupVisualizationActiveState(!1);let t=e.getTransientReviewBag();t&&(t.removeDMUObjects("DMUSection"),t.removeDMUObjects("DMUClipping"))}}),he.onDMUObjectActiveFlagChanged=be.addEvent("onDMUObjectActiveFlagChanged",function(e){var t=o.getReviewContext({viewer:ie.getViewer()});!(t&&g&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||(!t.getValidation()&&"DMUMarkup"===e.dmuObject.getType()||t.getValidation()&&"DMUValidationValidation"===e.dmuObject.getType())&&Ye()}),he.onDMUMarkupLoaded=be.addEvent("onDMUMarkupLoaded",function(){let e=o.getReviewContext({viewer:ie.getViewer()}).getReviewCtxInformation();e&&!e.modifiable&&g.setAllowSlideReorderFlag(!1),_||(vt(!1),_=setInterval(function(){if(!Y||!ie)return clearInterval(_),void(_=null);if(A&&Ce&&Ce.getRootBagPath().getChildrenPathes().length){var e=D.getManager({name:"DMU2DSheetManager",context:ie});(e&&e.isADocumentDisplayed()&&!e.isRunning()||!e||e&&!e.isADocumentDisplayed()&&"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType())&&(clearInterval(_),_=null,vt(!0),he.onDMUMarkupApplicativeContextLoaded||Te())}},100))}),he.onDMUMarkupApplicativeContextLoadBegin=be.addEvent("onDMUMarkupApplicativeContextLoadBegin",function(){he.onDMUMarkupApplicativeContextLoaded=be.addEvent("onDMUMarkupApplicativeContextLoaded",function(){Te(),be.removeEvent(he.onDMUMarkupApplicativeContextLoaded),he.onDMUMarkupApplicativeContextLoaded=null})}),he.onDMUObjectInitialized=be.addEvent("onDMUObjectInitialized",function(e){if(e&&e.dmuObject&&(!de||e.dmuObject!==de&&-1===de.getDMUObjects().indexOf(e.dmuObject)||qe(),de&&"DMUFormat"!==de.getType()&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType()))){Ze(Ne(de))}}),he.onFormatsEditionModeEnded=be.addEvent("onFormatsEditionModeEnded",function(){for(let e=0;e<$.length;e++){Ze($[e].id)}}),he.onSaveRequested=be.addEvent("onSaveRequested",qe),he.onEndSectionManipulation=be.addEvent("onEndSectionManipulation",function(e){if(e&&e.dmuObject&&de&&"DMUFormat"!==de.getType()&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())){Ze(Ne(de))}}),he.onDMUObjectDeleted=be.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject.getType){if("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType()){var t=o.getReviewContext({viewer:ie.getViewer()});t&&t.getValidation()&&e.dmuObject===de&&Q.setActiveSlide(null),Q.removeSlide(e.dmuObject)}else if("DMUMarkup"===e.dmuObject.getType()){for(let t=te.length-1;t>=0;t--)if(te[t].content&&te[t].content.getMarkupContent()===e.dmuObject){for(let e=ne.length-1;e>=0;e--)ne[e].parentID===te[t].id&&(g&&g.removeReply(ne[e].id),ne.splice(e,1));g&&g.removeMarkup(te[t].id),te.splice(t,1);break}}else if(!de||"DMUFormat"===de.getType()||"DMUSection"!==e.dmuObject.getType()&&"DMUClipping"!==e.dmuObject.getType())"DMUMarker3DPoint"!==e.dmuObject.getType()&&"DMUMarker2DPoint"!==e.dmuObject.getType()&&qe();else{Ze(Ne(de))}Dt()}}),he.onDMUSlideSessionInfoChanged=be.addEvent("onDMUSlideSessionInfoChanged",function(e){if(e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()){Ze(Ne(e.dmuObject))}qe()}),he.onSlidePreviewRefreshRequired=be.addEvent("onSlidePreviewRefreshRequired",function(e){if(e&&e.dmuObject===de){if("DMUSlide"===e.dmuObject.getType()){Ze(Ne(e.dmuObject))}qe()}}),he.onDMUSlideOrFormatRefreshRequired=be.addEvent("onDMUSlideOrFormatRefreshRequired",function(e){e&&e.dmuObject===de&&qe()}),he.onDMUOverloadPropertiesChanged=be.addEvent("onDMUOverloadPropertiesChanged",qe),he.onOccurenceVisibleFlagChanged=be.addEvent("onOccurenceVisibleFlagChanged",function(){if(de&&"DMUFormat"!==de.getType()){Ze(Ne(de))}}),he.onDMUOccOverloadRemoved=be.addEvent("onDMUOccOverloadRemoved",function(){if(qe(),de&&"DMUFormat"!==de.getType()){Ze(Ne(de))}}),he.onDMUObjectAddedInObject=be.addEvent("onDMUObjectAddedInObject",function(e){e&&e.dmuObject&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())&&Ge()}),he.onDMUObjectRemovedFromObject=be.addEvent("onDMUObjectRemovedFromObject",function(e){if(e&&e.dmuObject&&("DMUSection"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType())){if(de&&"DMUFormat"!==de.getType()){Ze(Ne(de))}Ge()}}),he.onDMUFormatAssociatedListeModified=be.addEvent("onDMUSlideFormatListModified",function(e){if(e&&e.dmuObject&&e.dmuObject.isDisplayed()&&(Ge(),"DMUFormat"!==e.dmuObject.getType())){Ze(Ne(e.dmuObject))}}),he.onDMUObjectVisibleFlagChanged=be.addEvent("onDMUObjectVisibleFlagChanged",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType()||"DMUClipping"===e.dmuObject.getType()||"DMUSection"===e.dmuObject.getType())&&Ge()}),he.onContextVisuChangeEnd=be.addEvent("onContextVisuChangeEnd",qe),he.onNewSlideCreationRequest=be.addEvent("onNewSlideCreationRequest",wt);let e=!1;he.onDMUSlideCompareDisplayRequired=be.addEvent("onDMUSlideCompareDisplayRequired",()=>{vt(!1),e=!0}),he.onComparisonDisplayed=be.addEvent("onComparisonDisplayed",()=>{e&&vt(!0),e=!1}),he.onComparisonEnded=be.addEvent("onComparisonEnded",()=>{e&&vt(!0),e=!1}),he.on2DDocumentLoadStarted=be.addEvent("on2DDocumentLoadStarted",()=>{let e=O.giveReqCompareController({context:Ce});if(!e||!e.isLoading()){let e=D.getManager({name:"DMU2DSheetManager",context:ie});Q.setVisibleFlag(!(e&&!e.getLoadedDocuments().length))}}),he.on2DDocumentLoadError=be.addEvent("on2DDocumentLoadError",()=>{Q.setVisibleFlag(!0)}),he.onEmptyDocument=be.addEvent("onEmptyDocument",()=>{Q.setVisibleFlag(!0)}),he.on2DDocumentLoadSuccess=be.addEvent("on2DDocumentLoadSuccess",Ct),he.onMarkupObjectAttributesModified=be.addEvent("onMarkupObjectAttributesModified",function(e){e&&e.object&&e.attr&&"DMUMarkup"===e.object.getType()&&e.attr.forEach(function(e){e.currentState&&g&&(Ue=e.currentState,xe&&(xe.destroy(),xe=null),g.setPanelQuickAccessCommands(Et()),g.setPanelSubMenuCommands(St()))})}),he.onCurrentSessionMarkupChanged=be.addEvent("onCurrentSessionMarkupChanged",function(){g&&g.setPanelQuickAccessCommands(Et())}),he.onReviewObjectAttributesModified=be.addEvent("onReviewObjectAttributesModified",function(){if(g){let e=o.getReviewContext({viewer:ie.getViewer()});g.allowReplies(e&&e.getValidation()&&!le&&e.getRestrictions().reply.canCreate),g.setAllowSlideReorderFlag(e&&(!e.getValidation()||e.getRestrictions(e.getCurrentSessionMarkup()).markup.canEdit))}})}var yt=i.subscribe({event:"/VISU/"},function(e){var t=e.eventType||e.event;"@onViewpointBeginMove"===t?De=!0:"@onViewpointEndMove"===t&&(De=!1,dt())});function St(){var e=[];if(!k){var t=o.getReviewContext({viewer:ie.getViewer()});let n=t.getCurrentSessionMarkup(),i="Reply"===(n&&n.getMarkupOwner()&&n.getMarkupOwner().getParent()&&n.getMarkupOwner().getParent().getType());(t?t.getValidation():null)||le||(Oe.get(Ue)&&e.push({id:"Next State",type:"button",nls:P.maturityValue.SetTo+' "'+Ie.get(Oe.get(Ue))+'"',fontIcon:"fonticon fonticon-double-chevron-right wux-ui-3ds",fontIconColor:Re.get(Oe.get(Ue)),separator:!1,cb:function(){let e=ie.getUIFrame();var t=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],n=e.getElementsByClassName("rp-maturity-"+Ue)[0];(xe=new a({visible:!0})).inject(t);var i=xe.getContent().getSize().width,r=(n.getSize().width-i)/2;xe.getContent().setStyles({position:"absolute",height:"20px",right:(33+r).toString()+"px"}),be.fireEvent("onMarkupMaturityModificationRequested",{fromState:Ue,toState:Oe.get(Ue)})}}),Pe.get(Ue)&&e.push({id:"Previous State",type:"button",nls:P.maturityValue.SetTo+' "'+Ie.get(Pe.get(Ue))+'"',fontIcon:"fonticon fonticon-double-chevron-left wux-ui-3ds",fontIconColor:Re.get(Pe.get(Ue)),separator:!1,cb:function(){let e=ie.getUIFrame();var t=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],n=e.getElementsByClassName("rp-maturity-"+Ue)[0];(xe=new a({visible:!0})).inject(t);var i=xe.getContent().getSize().width,r=(n.getSize().width-i)/2;xe.getContent().setStyles({position:"absolute",height:"20px",right:(53-r).toString()+"px"}),be.fireEvent("onMarkupMaturityModificationRequested",{fromState:Ue,toState:Pe.get(Ue)})}}),e.push({id:"DMUMarkupMaturityChange",type:"button",nls:P.changeMaturity,fontIcon:"fonticon fonticon-collaborative-lifecycle-management wux-ui-3ds",separator:!0,cb:function(){var e=m.getCommand("DMUMarkupMaturityChangeHdr",Z.commandContext);e&&e.begin()}})),re&&t&&t.getRestrictions(t.getCurrentSessionMarkup())[i?"reply":"markup"].canEdit&&e.push({id:"DMUFormats",type:"button",nls:le?P.exitFormatsUI:P.launchFormatsUI,fontIcon:le?"fonticon fonticon-upload wux-ui-3ds":"fonticon fonticon-template wux-ui-3ds",separator:!0,cb:gt})}let n=m.getCommand("DMUCopyLinkHdr",Z.commandContext);return n&&e.push({id:"DMUCopyLink",type:"button",nls:P.launchCopyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",cb:()=>{(n=m.getCommand("DMUCopyLinkHdr",Z.commandContext))&&n.begin()}}),null!=(n=m.getCommand("DMUEditPropertiesHdr",Z.commandContext))&&e.push({id:"DMUEditProperties",type:"button",nls:P.launchEditProperties,fontIcon:"fonticon fonticon-info wux-ui-3ds",cb:ct}),k&&e.push({id:"DMUResetDisplayHistory",type:"button",nls:P.resetDisplayHistoryLabel,icon:M.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:nt}),e}async function wt(e){if(de){l.empty();var t=m.getCommand("sectionCmdHdr",Ce.getCommandContext());t&&t.isRunning()&&t.cancel&&t.cancel(),await Be(de)}if(e&&e.id){var n=o.getReviewContext({viewer:ie.getViewer()}),i=n?n.getValidation():null;i&&i.setCurrentMarkup(i.getRepRef(e.id)),Ut()}m.getCommand(le?"DMUFormatCmdHdr":"slideCmdHdr",Z.commandContext).begin(),A&&A.isSmallWidth()&&A.collapsePanel()}function Et(){var e=[];k||e.push({id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:P.switchMarkupVisibility,cb:function(e){var t=e.dsModel.checkFlag;if(Qe(),t){var n=D.getManager({name:"DMU2DSheetManager",context:ie});if(n&&n.isADocumentDisplayed()){var i=o.getReviewContext({viewer:ie.getViewer()});i&&i.getEnvironment().refresh()}}A&&A.isSmallWidth()&&A.collapsePanel()}}),pe&&e.push({id:"filterButton",type:"checkbox",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter",title:P.filterSlides,checkFlag:!!g&&g.getFilterActivationFlag(),cb:function(){g&&g.switchFilterActivation()}}),!k&&re&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:le?P.newFormat:P.newSlide,cb:wt});var t=o.getReviewContext({viewer:ie.getViewer()}),n=t?t.getCurrentSessionMarkup():null;const i=n?n.getMaturityState():null;return!le&&i&&e.push({id:"maturityStateButton",type:"label",title:P.maturityState,label:P.maturityValue[i],className:"rp-ms-box rp-maturity-"+i}),e}function Ut(){re=!0;let e=o.getReviewContext({viewer:ie.getViewer()}),t=e?e.getValidation():null;if(t){let e=t.getCurrentMarkup();if(e){for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();e&&(re=(e.isWebMarkup&&e.isWebMarkup()||e.getRepRef&&e.getRepRef()&&e.getRepRef().isWebMarkup&&e.getRepRef().isWebMarkup())&&!e.isReadOnly())}}if(g){g.setPanelSubMenuCommands(St()),g.setPanelQuickAccessCommands(Et());let e=m.getCommand(le?"DMUFormatCmdHdr":"slideCmdHdr",Z.commandContext);g.setQuickAccessCommandActiveFlag("newButton",e&&e.isEnabled())}}function xt(){var e=u.getSlidePreferences({context:ie});if(e&&("boolean"==typeof e.displaySlidePanel&&(ge=e.displaySlidePanel),"string"==typeof e.panelTitle&&(T=e.panelTitle),"boolean"==typeof e.displaySlideTitle&&(L=e.displaySlideTitle),Me="TransferView"===e.slideDragAndDropOperation,void 0===k&&"boolean"==typeof e.playMode&&(k=e.playMode),!B&&e.beforeApplySlideCB&&(B=e.beforeApplySlideCB),!H&&e.afterApplySlideCB&&(H=e.afterApplySlideCB)),ge){var t,i=o.getReviewContext({viewer:ie.getViewer()});if(i&&(t=i.getValidation()),g||(g=new n({allowMarkupReorder:Boolean(window.__karma__&&window.allowMarkupReorder),allowSlideReorder:!0,allowReplies:t&&!le&&i.getRestrictions().reply.canCreate}),(I={}).onTopBarDoubleClick=g.subscribe("onTopBarDoubleClick",tt),I.onSlideDisplayed=g.subscribe("onSlideDisplayed",it),I.onSlidePreselected=g.subscribe("onSlidePreselected",rt),I.onSlideSelected=g.subscribe("onSlideSelected",ot),I.onSlideUpdateRequired=g.subscribe("onSlideUpdateRequired",ut),I.onSlideNameChanged=g.subscribe("onSlideNameChanged",pt),I.onSlideCtxMenuRequired=g.subscribe("onSlideCtxMenuRequired",ht),I.onMarkupCtxMenuRequired=g.subscribe("onMarkupCtxMenuRequired",mt),I.onMarkupRenamed=g.subscribe("onMarkupRenamed",ft),I.onNewSlideCreated=g.subscribe("onNewSlideCreated",wt),I.onSlideReplyCreated=g.subscribe("onSlideReplyCreated",at),I.onSlideReordered=g.subscribe("onSlideReordered",lt),I.onSlideDragStart=g.subscribe("onSlideDragStart",e=>{e.isTouch&&setTimeout(ie.getContextualUIManager().hideContextualMenu,1e3)}),I.onMarkupReordered=g.subscribe("onMarkupReordered",st),I.onSlideHighlightSelected=g.subscribe("onSlideHighlightSelected",({slideId:e,highlightId:t})=>{const n=$.find(t=>t.id===e);n&&be&&be.fireEvent("onCommentOrSlideInformationIconClicked",{dmuObject:n.slide,highlightId:t})})),!A){var r=g.buildPanel({panelTitle:V||T,noSlideLabel:j,createSlideLabel:F,contextualCmdList:St(),quickAccessBtnList:Et()});q&&g.setDragContent(q),g.setReadOnlyFlag(k);var a={id:"DesignReview",className:"DMUSlidesPanel",title:P.slidePanelTitle,closeButtonFlag:!1,showTitleFlag:!1,icon:"fonticon fonticon-DMUSlidePanelIcon DMUSlidePanelIcon",immersiveFrame:ie.getImmersiveFrame(),viewerFrame:ie.getViewerFrame(),content:r,minWidth:$e(),widthStep:et(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizeCB:function(e){g&&g.resizePanel(e)},onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||e.widthModifiedInteractively&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),sessionStorage.setItem("DMUSlidesWidth_"+widget.id,e.width)),g&&g.resizePanel(e)}};A=new c(a)}if(g){g.setPanelActiveFlag(fe),g.resizePanel({width:A.getWidth(),height:A.getHeight()});let e=D.getManager({name:"DMU2DSheetManager",context:ie});e&&e.isADocumentDisplayed()?g.enableDragContent(!1):g.enableDragContent(Me)}Ke(),Q.setPlayMode(k),Dt()}}function Ot(e){if(g||xt(),e.titleEditionAllowed=e.isEditable()&&!k,null!==e.index&&void 0!==e.index?$.splice(e.index,0,e):$.push(e),e.markedAsDeleted){if(!$.some(t=>t.parentSlideID===e.id))return}g&&(g.addSlide(e),1===$.length&&A.setMinWidth($e()),"DMUFormat"!==e.slide.getType()&&Ze(e.id)),A&&A.setWidthStep(g.getColumnWidthStep()),Dt()}ve.onEndProgressiveLoad=Ce.subscribe({event:"onEndProgressiveLoad"},()=>{var e=o.getReviewContext({viewer:ie.getViewer()});let t,n;if(e){Fe(t=e.getEnvironment().getEnvironmentInfo(),n=e.getEnvironment().getCurrentSlideEnvironmentInfo())||qe()}}),he.onDMUObjectAttributeModified=be.addEvent("onDMUObjectAttributeModified",function(e){e&&"bMarkedAsDeleted"===e.attrName&&"DMUSlide"===e.dmuObject.getType()&&e.value&&g&&g.removeSlide(e.dmuObject.getAttribute("sUuid"))}),he.onHighlightAttributeChanged=be.addEvent("onHighlightAttributeChanged",function(e){if(e&&e.objectIds&&e.objectIds.length){const t=e.objectIds.slice();for(let n=0;n<$.length;n++){const i=$[n].slide,r=i.getAssociatedHighlightData();if(r&&r.length){if(t.filter(e=>r.some(t=>t.id===e)).forEach(n=>{i.updateAssociatedHighlightData({id:n,rating:e.rating}),t.splice(t.indexOf(n),1)}),!t.length)break}}}}),he.onHighlightIssueCreated=be.addEvent("onHighlightIssueCreated",function({highlightId:e}){if(e)for(let t=0;t<$.length;t++){const n=$[t].slide,i=n.getAssociatedHighlightData();if(i&&i.length&&i.some(t=>t.id===e)){n.updateAssociatedHighlightData({id:e,hasIssue:!0});break}}}),this.editMarkupName=function(e){if(oe&&g&&e&&e.getPlmID){let t;for(let n=0;n<te.length;n++)if(te[n].id===e.getPlmID()){t=e.getPlmID();break}t&&g.editMarkupName(t)}},this.getRepliedSlide=function(){return K},this.getActiveThumbnailCtxMenuPosition=function(){return ce.clone()},this.setSlideFilteringAvailability=function(e){pe!==e&&(pe=e,g&&g.setPanelQuickAccessCommands(Et()))},this.setListOfFilteredSlides=function(e){me=e&&e.length?e.slice():[];var t=[];$.forEach(function(e){-1!==me.indexOf(e.slide)&&t.push(e.id)}),g&&g.setListOfVisibleSlides(t)},this.setActiveFlag=function(e){var t;if(e!==Y)if(Y=e){for(ke()&&Ce.getFrameWindow().getImmersiveFrame().addEventListener("endEdit",Ve),Ct(),t=0;t<ee.length;t++)Q.addSlide(ee[t]);de&&Q.setActiveSlide(de)}else{if(ke()&&Ce.getFrameWindow().getImmersiveFrame().removeEventListener("endEdit",Ve),me.length=0,g){g.cleanPanel();var n=Object.keys(I);for(t=0;t<n.length;t++)g.unsubscribe(I[n[t]]);$.length=0,I={}}A&&(A.setPanelVisibilityFlag(!1),A.clean()),_&&clearInterval(_),X&&clearInterval(X),z&&clearInterval(z),A=g=X=_=z=null}},this.getActiveFlag=function(){return Y},this.setPanelActiveFlag=function(e){fe=e,g&&g.setPanelActiveFlag(fe),dt()},this.getPanelActiveFlag=function(){return fe},this.addSlide=function(e,t,n){if(!Y||!e)return;var i;Ye();var r=o.getReviewContext({viewer:ie.getViewer()});if(n)i=n;else{if(!r||r&&!r.getCurrentSessionMarkup())return;i=r.getCurrentSessionMarkup()}$.length||e.parentID||(e.parentID="default");let a=Ne(e);for(var l=0;l<$.length;l++)if(Ne($[l].slide)===a)return;-1===ee.indexOf(e)&&("number"==typeof t?ee.splice(t,0,e):ee.push(e));var s=e.getAttribute("sOwner"),d={slide:e,id:Ne(e),parentID:e.parentID,parentSlideID:e.getAttribute("sParentSlideID"),index:t,isPreview:Se===a,markedAsDeleted:e.getAttribute("bMarkedAsDeleted"),isEditable:function(){return!e.isReadOnly()}};d.isPreview&&e.setPreviewFlag(!0),"DMUSlide"===e.getType()||"DMUFormat"===e.getType()?(d.title=e.getAttribute("sName"),d.icon="DMUFormat"===e.getType()?M.getWebappsAssetUrl("DMUPlaySlide","icons/22/I_DMUFormat.png"):void 0,d.img=e.getPreview(),d.isActiveSlide=!i.isImporting()):d.text=e.getAttribute("sTextContents"),s&&s.length?U.getUserName(s,function(t){d.userName=t,d.userColor=U.getUserColor(s),d.userPic=U.getUserImageURL(s),d.defaultUserPic=M.getWebappsAssetUrl("DMUBaseUI","icons/I_DefaultUserPic.png"),d.date=e.getAttribute("fCreationDate"),Ot(d)}):Ot(d)},this.removeSlide=function(e){if(Y&&e){Ye();for(let t=$.length-1;t>=0;t--)($[t].slide===e||$[t].parentSlideID&&e.getAttribute("sUuid")===$[t].parentSlideID)&&(ee.splice(ee.indexOf(e),1),g&&g.removeSlide($[t].id),$.splice(t,1));Dt()}},this.addReply=function(e){ne.push(e),e.webMarkup=e.content.isWebMarkup(),g&&g.addReply(e)},this.forcePanelVisibility=function(){A&&A.ensureVisible()},this.addMarkup=function(e){var t=o.getReviewContext({viewer:ie.getViewer()}),n=t?t.getValidation():null,i=t?t.getCurrentSessionMarkup():null;t&&e&&(n||i)&&(te.push(e),g||xt(),e.allowSlideReorder=!0,e.webMarkup=e.content.isWebMarkup(),e.owner=e.content.getOwner(),g&&g.addMarkup(e))},this.updateSlide=function(e,t){if(Y&&e&&t){if(t.uuid)for(var n=0;n<$.length;n++)if($[n].slide===e){let t=$[n].id;return $[n].id=Ne(e),void(g&&g.updateSlide(t,{id:$[n].id}))}if(g){let n=Ne(e);g.updateSlide(n,t),J&&J.has(n)&&J.get(n).forEach(e=>{t.name&&e.setThumbnailTexts({title:t.name}),t.img&&e.setPreview(t.img)})}}},this.updateSlideEditableFlag=function(e){if(Y&&e)for(var t=0;t<$.length;t++)if($[t].slide===e)return $[t].titleEditionAllowed=$[t].isEditable()&&!k,void(g&&g.updateSlide($[t].id,{titleEditionAllowed:$[t].titleEditionAllowed}))},this.update=function(){if(Y&&$)for(var e=0;e<$.length;e++)$[e].titleEditionAllowed=$[e].isEditable()&&!k,g&&g.updateSlide($[e].id,{titleEditionAllowed:$[e].titleEditionAllowed})},this.setPlayMode=function(e){if(Y&&k!==e){if(k=e,Ye(),dt(),g){if(g.setReadOnlyFlag(k),g.setPanelSubMenuCommands(St()),g.setPanelQuickAccessCommands(Et()),$)for(var t=0;t<$.length;t++)$[t].titleEditionAllowed=$[t].isEditable()&&!k,g.updateSlide($[t].id,{titleEditionAllowed:$[t].titleEditionAllowed,checkFlag:!k&&void 0});g.resetSlideDisplayHistory(),de&&g.setActiveSlide(Ne(de))}Ut()}},this.getPlayMode=function(){return k},this.setVisibleFlag=function(e){Y&&(oe=e,Dt())},this.getVisibleFlag=function(){return oe},this.getActiveSlide=function(){return de},this.getSlideRepresentation=function(e,t){let n=$.findIndex(t=>t.id===e);if(n>=0){J||(J=new Map);let i=new p({id:e,data:$[n].slide,displayMode:t,displayPrefix:!1,width:202,height:127,displayTitleAndIcon:N,title:$[n].title,allowCtxMenu:!1,isCheckable:!1,clickCB:e=>{it(e,{recenter:!0})},preview:$[n].slide.getPreview(),allowTitleEdition:!1});return J.has(e)?J.get(e).push(i):J.set(e,[i]),{getDiv:i.getContent,updateDisplayMode:i.updateDisplayMode,getImage:()=>He($[n].slide),remove:()=>{if(J){let t=J.get(e);t&&(t.splice(t.indexOf(i),1),0===t.length&&J.delete(e)),i.clear()}}}}},this.setPanelOptions=function(e){if(Y&&e){Ye();var t,n=Object.keys(e);for(t=0;t<n.length;t++){if("panelTitle"===n[t]&&(V=e.panelTitle,g&&g.setPanelTitle(V||T)),"noSlideLabel"===n[t]&&(j=e.noSlideLabel,g&&g.setNoSlideLabel(j)),"createSlideLabel"===n[t]&&(F=e.createSlideLabel,g&&g.setCreateSlideLabel(F)),"editingFormats"===n[t]){le=e.editingFormats,g&&g.setPanelSubMenuCommands(St()),g.setPanelQuickAccessCommands(Et());var i=o.getReviewContext({viewer:ie.getViewer()});g.allowReplies(i&&i.getValidation()&&!le&&i.getRestrictions().reply.canCreate),g.setAllowMarkupReorderFlag(!1),g.setAllowSlideReorderFlag(i&&(!i.getValidation()||i.getRestrictions(i.getCurrentSessionMarkup()).markup.canEdit)),A&&(A.setMinWidth($e()),A.setWidthStep(et())),Ke()}"playMode"===n[t]&&Q.setPlayMode(e.playMode),"beforeApplySlideCB"===n[t]&&(B=e.beforeApplySlideCB),"afterApplySlideCB"===n[t]&&(H=e.afterApplySlideCB)}}},this.setActiveSlide=function(e,t){if(Y){Ye();var n=!0;if(n){for(var i=0;i<se.length;i++)if((se[i].slide?se[i].slide.getAttribute("sID"):null)===(e?e.getAttribute("sID"):null)){n=!1;break}n&&se.push({slide:e,options:t||{}})}1===se.length&&async function e(t,n){se.splice(0,1),ue=!0;var i=de;if(de=t,n&&n.updatePreviousPreview&&i){var r=m.getCommand("sectionCmdHdr",Ce.getCommandContext());r&&r.isRunning()&&r.cancel&&r.cancel(),de!==i&&(ke()&&(de.getEnvironmentOverload().state.b360Mode||i.getEnvironmentOverload().state.b360Mode)||await Be(i))}var a=o.getReviewContext({viewer:ie.getViewer()});a.getTransientReviewBag().removeDMUObjects();var d=a?a.getValidation():null;t&&d&&(d.setCurrentMarkup(d.getRepRef(t.parentID)),Ut());var u=a?a.getCurrentSessionMarkup():null;if(u){if(dt(),de){var c,p=l.get();for(c=p.length-1;c>=0;c--)p[c].pathElement&&p[c].pathElement.getLastElement(!0).getDMUType&&"DMUValidationExposedPresentation"!==p[c].pathElement.getLastElement(!0).getDMUType()&&l.remove(p[c]);for(c=(p=s.get()).length-1;c>=0;c--)p[c].pathElement&&p[c].pathElement.getLastElement(!0).getDMUType&&"DMUValidationExposedPresentation"!==p[c].pathElement.getLastElement(!0).getDMUType()&&s.remove(p[c]);if(!a.isReadOnly()&&!u.isReadOnly()){var f=v.buildPathElement(de.getNode());l.add({pathElement:f}),Q.updateSelectedSlides([de])}}g&&g.setActiveSlide(Ne(de));var h=S.giveDMUApplicativeContextManager({context:Ce});(h?h.getApplicativeControllers():[]).forEach(function(e){e.setAppViewpointManipFlag&&e.setAppViewpointManipFlag(!de)}),R({context:Ce,slide:t,opts:n,onBeforeApplySlide:function(){ye&&g.setInProgress(ye,!1),g&&(ye=Ne(de),g.setInProgress(ye,!0)),de&&ke()&&Ce.set360Mode({checkFlag:de.getEnvironmentOverload().state.b360Mode}),B&&B(i,de),be&&be.fireEvent("onDMUSlideStartDisplay",{dmuObject:de})},onSlideActivated:function(t){n.afterSlideActivationCB&&n.afterSlideActivationCB(i,t.slide),H&&H(i,t.slide),be&&be.fireEvent("onDMUSlideDisplayed",{dmuObject:t.slide}),de&&ke()?de.getEnvironmentOverload().state.b360Mode===Ce.getViewer().get360Mode()&&qe():Be(),se.length?e(se[0].slide,se[0].options):(ue=!1,Ge(!0)),g&&(g.setInProgress(ye,!1),ye=null)}})}}(se[0].slide,se[0].options)}},this.updateSelectedSlides=function(e){if(Y)for(var t,n=0;n<$.length;n++){t=!1;for(var i=0;i<e.length;i++)if($[n].slide===e[i]){t=!0;break}g&&g.updateSlide($[n].id,{checkFlag:t})}},this.hasReplies=function(e){return $.some(t=>t.parentSlideID===e)},this.setSlideAsPreview=((e,t)=>{if(Se===e)return;let n;if($&&(n=$.find(t=>t.id===e))&&g){if(Se){const e=$.find(e=>e.id===Se);e&&(e.slide.setPreviewFlag(!1),g.updateSlide(e.id,{isPreview:!1}))}n.slide.setPreviewFlag(!0),g.updateSlide(n.id,{isPreview:!0})}Se=e,t&&We(n?n.slide:void 0)}),this.setSlideLoading=((e,t)=>{if($){let n=$.find(t=>t.id===e);n&&g&&g.setInProgress(n.id,t)}}),this.updateHeaderCommandsAvailability=(()=>{if(g){var e=o.getReviewContext({viewer:ie.getViewer()}),t=e?e.getCurrentSessionMarkup():null;Ue=t?t.getMaturityState():null,g.setPanelSubMenuCommands(St());let n=m.getCommand(le?"DMUFormatCmdHdr":"slideCmdHdr",Z.commandContext);g.setQuickAccessCommandActiveFlag("newButton",n&&n.isEnabled())}}),this.clear=function(){var e,t;if(Ye(),we=1,Q.setActiveFlag(!1),de=null,ee.length=0,$.length=0,se.length=0,be)for(t=Object.keys(he),e=0;e<t.length;e++)be.removeEvent(he[t[e]]);for(he={},t=Object.keys(ve),e=0;e<t.length;e++)Ce.unsubscribe(ve[t[e]]);ve={},J&&J.clear(),yt&&i.unsubscribe(yt),yt=null,W&&W.destroy(),W=null,J=B=H=be=ae=null}}}),I=[];return e.singleton({init:function(){},setActiveSlide:e=>R(e),getDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<I.length;n++)if(I[n].context===e.context){I[n].counter++,t=I[n].slidesController;break}if(e&&e.context&&!t){var i=new A(e);t={setActiveFlag:function(e){i&&i.setActiveFlag(e)},getActiveFlag:function(){if(i)return i.getActiveFlag()},setPanelActiveFlag:function(e){i&&i.setPanelActiveFlag(e)},getPanelActiveFlag:function(){if(i)return i.getPanelActiveFlag()},forcePanelVisibility:function(){if(i)return i.forcePanelVisibility()},addSlide:function(e,t,n){if(i)return i.addSlide(e,t,n)},addReply:function(e){if(i)return i.addReply(e)},addMarkup:function(e){if(i)return i.addMarkup(e)},editMarkupName:function(e,t){i&&i.editMarkupName(e,t)},removeSlide:function(e){if(i)return i.removeSlide(e)},updateSlide:function(e,t){i&&i.updateSlide(e,t)},updateSlideEditableFlag:function(e){i&&i.updateSlideEditableFlag(e)},update:function(){i&&i.update()},clear:function(){i&&i.clear()},setPlayMode:function(e){i&&i.setPlayMode(e)},getPlayMode:function(){return!!i&&i.getPlayMode()},setVisibleFlag:function(e){i&&i.setVisibleFlag(e)},getVisibleFlag:function(){if(i)return i.getVisibleFlag()},setActiveSlide:function(e,t){i&&i.setActiveSlide(e,t)},getActiveSlide:function(){if(i)return i.getActiveSlide()},getSlideRepresentation:function(e,t){if(i)return i.getSlideRepresentation(e,t)},setPanelOptions:function(e){i&&i.setPanelOptions(e)},setSlideFilteringAvailability:function(e){i&&i.setSlideFilteringAvailability(e)},setListOfFilteredSlides:function(e){i&&i.setListOfFilteredSlides(e)},updateSelectedSlides:function(e){i&&i.updateSelectedSlides(e)},getActiveThumbnailCtxMenuPosition:function(){return i?i.getActiveThumbnailCtxMenuPosition():{}},getRepliedSlide:function(){return i?i.getRepliedSlide():null},hasReplies:function(e){return i?i.hasReplies(e):null},setSlideAsPreview:function(e,t){return i?i.setSlideAsPreview(e,t):null},setSlideLoading:function(e,t){return i?i.setSlideLoading(e,t):null},updateHeaderCommandsAvailability:function(){return i?i.updateHeaderCommandsAvailability():null}},I.push({context:e.context,slidesController:t,counter:1})}return t?Object.freeze(t):t},giveDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<I.length;n++)if(I[n].context===e.context){t=I[n].slidesController;break}return t?Object.freeze(t):t},unreferenceDMUSlidesController:function(e){if(e&&e.context)for(var t=0;t<I.length;t++)if(I[t].context===e.context){I[t].counter--,I[t].counter<=0&&(I[t].slidesController.clear(),I.splice(t,1));break}}})}),define("DS/DMUBaseUIControllers/DMUCommentsController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/DMUControls/EXPNotify","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/DMUBaseUIControllers/DMUReqCompareController","DS/UIKIT/Spinner","UWA/Core","UWA/Utils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers","DS/WebappsUtils/WebappsUtils","DS/DMUControls/panels/DMUCommentsPanel","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIComponents/DMUComment","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g,c,p,m,f,h,v,C,D,b,M,y,S,w){"use strict";class E{constructor(e){let t,E,U=this,x=new Map;x.set("PRIVATE","IN_WORK"),x.set("IN_WORK","FROZEN"),x.set("FROZEN","RELEASED"),x.set("RELEASED","OBSOLETE"),x.set("OBSOLETE",void 0);let O=new Map;O.set("PRIVATE",void 0),O.set("IN_WORK","PRIVATE"),O.set("FROZEN","IN_WORK"),O.set("RELEASED",void 0),O.set("OBSOLETE",void 0);let P=new Map;P.set("PRIVATE","#9b2c98"),P.set("IN_WORK","#007da3"),P.set("FROZEN","#018308"),P.set("RELEASED","#757575"),P.set("OBSOLETE","#80808080");let R=new Map;R.set("PRIVATE",w.maturityValue.PRIVATE),R.set("IN_WORK",w.maturityValue.IN_WORK),R.set("FROZEN",w.maturityValue.FROZEN),R.set("RELEASED",w.maturityValue.RELEASED),R.set("OBSOLETE",w.maturityValue.OBSOLETE);let A,I,k,V,T,j,F,N,L,B,H,W,q,_,z,X,G,K=new Map,J=e.context,Z=!1,Q=!0,Y=!1,$=!0,ee=!0,te=!0,ne={},ie=!1,re=y.getContextViewer({viewer:J.getViewer()}),oe=y.giveEventsController({viewer:J.getViewer()}),ae=o.getManager({name:"DMU2DSheetManager",context:J}),le=!0,se=[];function de(e){if(e.flag===te)return;let t,n=l.get();for(t=n.length-1;t>=0;t--)n[t].pathElement.getLastElement(!0).getDMUType&&l.remove(n[t]);for(t=(n=s.get()).length-1;t>=0;t--)n[t].pathElement.getLastElement(!0).getDMUType&&s.remove(n[t]);let i=y.getReviewContext({viewer:J.getViewer()});i&&(i.getTransientReviewBag().removeDMUObjects(),te=e.flag,i.getUIManager().setMarkupVisualizationActiveState(te),oe&&oe.fireEvent("onDMUReviewVisbilityChanged",{status:e.flag}),U.setGuidelineVisibility(e.flag),A&&A.setCurrentMarkup(e.flag?z:null))}function ue(){te||(A&&A.restoreCommentSelection(),de({flag:!te}),A&&A.setReviewVisuCheckFlag(!0))}function ge(){A&&A.resetCommentDisplayHistory(),T&&T.destroy(),T=new a({body:J.getUIFrame(),type:"info",message:w.resetDisplayHistoryLabel}),l.empty(),s.empty()}function ce(){let n=[],r=y.getReviewContext({viewer:J.getViewer()});const o=r?r.getCurrentSessionMarkup():null;if(!o)return n;if(!Z){z&&r&&!r.getValidation()&&r.getRestrictions(o).markup.canEdit&&(x.get(t)&&n.push({id:"Next State",type:"button",nls:w.maturityValue.SetTo+' "'+R.get(x.get(t))+'"',fontIcon:"fonticon fonticon-double-chevron-right wux-ui-3ds",fontIconColor:P.get(x.get(t)),cb:function(){let e=J.getUIFrame(),n=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[1],i=e.getElementsByClassName("rp-maturity-"+t)[1];(E=new f({visible:!0})).inject(n);let r=E.getContent().getSize().width,o=(i.getSize().width-r)/2;E.getContent().setStyles({position:"absolute",height:"20px",right:(33+o).toString()+"px"}),oe&&oe.fireEvent("onMarkupMaturityModificationRequested",{fromState:t,toState:x.get(t)})}}),O.get(t)&&n.push({id:"Previous State",type:"button",nls:w.maturityValue.SetTo+' "'+R.get(O.get(t))+'"',fontIcon:"fonticon fonticon-double-chevron-left wux-ui-3ds",fontIconColor:P.get(O.get(t)),cb:function(){let e=J.getUIFrame(),n=e.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[1],i=e.getElementsByClassName("rp-maturity-"+t)[1];(E=new f({visible:!0})).inject(n);let r=E.getContent().getSize().width,o=(i.getSize().width-r)/2;E.getContent().setStyles({position:"absolute",height:"20px",right:(33+o).toString()+"px"}),oe&&oe.fireEvent("onMarkupMaturityModificationRequested",{fromState:t,toState:O.get(t)})}}),n.push({id:"DMUMarkupMaturityChange",type:"button",nls:w.changeMaturity,fontIcon:"fonticon fonticon-collaborative-lifecycle-management wux-ui-3ds",separator:!0,cb:function(){let t=i.getCommand("DMUMarkupMaturityChangeHdr",e.commandContext);t&&t.begin()}}));let a=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext);a&&n.push({id:"DMUExportReviewAsPdf",type:"button",nls:w.launchExportAsPDF,fontIcon:"fonticon fonticon-export-to-pdf wux-ui-3ds",cb:function(){(a=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext))&&a.begin()}})}let a=i.getCommand("DMUCopyLinkHdr",e.commandContext);return a&&n.push({id:"DMUCopyLink",type:"button",nls:w.launchCopyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",cb:()=>{(a=i.getCommand("DMUCopyLinkHdr",e.commandContext))&&a.begin()}}),a=i.getCommand("DMUEditPropertiesHdr",e.commandContext),n.push({id:"DMUEditProperties",type:"button",nls:w.launchEditProperties,fontIcon:"fonticon fonticon-info wux-ui-3ds",cb:function(){ue(),(a=i.getCommand("DMUEditPropertiesHdr",e.commandContext))&&a.begin()}}),Z&&n.push({id:"DMUResetDisplayHistory",type:"button",nls:w.resetDisplayHistoryLabel,icon:b.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:ge}),n}function pe(){let t=y.getReviewContext({viewer:J.getViewer()}),n=t?t.getCurrentSessionMarkup():null,r=[];n&&!Z&&(z&&r.push({id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:w.switchMarkupVisibility,cb:function(e){de({flag:e.dsModel.checkFlag}),I&&I.isSmallWidth()&&I.collapsePanel()}}),r.push({id:"newCommentButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:w.newComment,cb:function(){let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t.isRunning()?t.end():t.begin(),I&&I.isSmallWidth()&&I.collapsePanel()}})),!Z&&(null==t?void 0:t.getValidation())&&A?r.push({id:"filterCommentsButton",type:"button",fontIcon:A&&A.hasFiltersApplied()?"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter-select-on CATWebUXSectionHeaderSectionBulletsSelected":"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter",title:w.filterComments,cb:function(){A&&(l.empty(),A.setFilterViewFlag(!A.getFilterViewFlag()))}}):(r.push({id:"previousButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-left",title:w.previousComment,cb:function(){i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext).begin()}}),r.push({id:"nextButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-right",title:w.nextComment,cb:function(){i.getCommand("DMUNextCommentCmdHdr",e.commandContext).begin()}}));const o=n?n.getMaturityState():null;return o&&r.push({id:"maturityStateButton",type:"label",title:w.maturityState,label:w.maturityValue[o],className:"rp-ms-box rp-maturity-"+o}),r}function me(){!B&&A&&(B=setInterval(function(){if(A){if(!J)return B&&clearInterval(B),void(B=null);if(I&&re&&re.getRootBagPath().getChildrenPathes().length){let t=i.getCommand("DMUNextCommentCmdHdr",e.commandContext);if(t&&ae&&ae.isADocumentDisplayed()&&!ae.isRunning()){B&&clearInterval(B),B=null;let n=y.getReviewContext({viewer:J.getViewer()}),r=w.commentsPanelTitle,o=n?n.getValidation():null,a=n?n.getCurrentSessionMarkup():null;o?r=o.getName():a&&(r=a.getAttribute("sName")),A.updatePanelHeader({panelTitle:r,contextualCmdList:ce(),quickAccessBtnList:pe(),headerDrag:Boolean(L)}),t=i.getCommand("DMUCommentCmdHdr",e.commandContext),A.updatePanelHeader({quickAccessBtnAvailability:{flag:t&&t.isEnabled(),id:"newCommentButton"}}),t=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),A.updatePanelHeader({quickAccessBtnAvailability:{flag:t&&t.isEnabled(),id:"nextButton"}}),t=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext),A.updatePanelHeader({quickAccessBtnAvailability:{flag:t&&t.isEnabled(),id:"previousButton"}})}}}},500))}function fe(e){var t;if(e){let n=y.getReviewContext({viewer:J.getViewer()}),i=n?n.getValidation():null;if(i){let n=null===(t=e.getMarkupOwner())||void 0===t?void 0:t.getParent();if(!n){let t=i.getMarkups();t&&t.some(t=>{let i=t.getRepRef();if(i){if(i.getMarkupContent()===e)return n=t,!0;let r=t.getReplies();r&&r.some(t=>{let i=t.getRepRef();if(i&&i.getMarkupContent()===e)return n=t,!0})}})}if(n)return{id:n.getRepRef().getPlmID(),name:n.getName()}}}return{id:"default"}}function he(e){if(!A)return;if(A.restoreCommentPreSelection(),!e||!e.length)return;e.forEach(e=>{if(!A)return;let t=K.get(e);if(t){if(X&&X.has(t.uuid)){let e=X.get(t.uuid);e&&e.forEach(e=>{t&&e.updateDate(D.formatDate(t.dateInMs))})}A.preSelectComment(t.uuid),function(e){if(e){let t=r.buildPathElement(e.getNode());d.add({pathElement:t})}}(t.parentObject)}}),$=!0}function ve(e){if(ue(),e&&e!==z){z=e;let t=y.getReviewContext({viewer:J.getViewer()});if(t){t.getTransientReviewBag().removeDMUObjects();let e=t?t.getValidation():null;e&&e.setCurrentMarkup(e.getRepRef(z))}}}function Ce(e){if(!e)return;if(e.isReply()&&_){let t=e.getAttribute("sParentCommentId");const n=K.get(t);return n?n.dmuObject:void 0}let t=e.getNode().getParents();if(!t||!t.length)return;let n=y.getReviewContext({viewer:J.getViewer()}),i=r.buildPathElement(t[0]);return null==n?void 0:n.getDMUObjectFromPathElement(i)}function De(e,t){if(!W||!q||ie||!I.getContentVisibleState()||!te||!re.getViewer().getVisibleSpace())return;if(!(e&&e.length||t&&t.length))return void W.setStyle("display","none");"none"===W.getStyle("display")&&W.setStyle("display","block");let n=function(e){var t;if(!A)return;const n="string"==typeof e?K.get(e):e.isReply()?K.get(e.getAttribute("sParentCommentId")):K.get(e.getAttribute("sUuid"));if(n&&!n.hasAlertFlag()&&!A.isCommentFiltered(n.uuid)&&(!n.parentObject.hasAttribute("bVisible")||n.parentObject.getAttribute("bVisible"))){let e=ae.getElementMatrix("Document"===ae.getDocumentType()?n.pointedPage:null===(t=n.pointedElement)||void 0===t?void 0:t.id),i=C.getViewerPositionFromPoint(re.getViewer(),n.pointedPosition.clone().applyMatrix4(e));if(i){let e=I.getAbsolutePosition().x<i.left,t=A.getDivPositionFrom(n.uuid,re.getViewer().canvas,e);q&&t&&(q.moveTo(i.left,i.top),q.lineTo(t.x+(e?45:-45),i.top),q.lineTo(t.x+(e?-10:-20),t.y),q.lineTo(t.x+(e?-25:-7),t.y))}}};q.clearRect(0,0,W.width,W.height),e&&e.length&&(q.setLineDash([]),q.strokeStyle="#368EC4",q.beginPath(),e.forEach(n),q.stroke()),t&&t.length&&(q.setLineDash([5,5]),q.strokeStyle="#78BEFA",q.beginPath(),t.forEach(n),q.stroke())}function be(){let e=d.get(),t=[],n=y.getReviewContext({viewer:J.getViewer()});for(let i=0;i<e.length;i++){if(!e[i].pathElement)continue;let r;if(n&&(r=n.getDMUObjectFromPathElement(e[i].pathElement)),r||(r=U.getDMUObjectFromPathElement(e[i].pathElement)),r){let e=!1,i=r.getType(),o=n?n.getCurrentSessionMarkup():void 0,a=o?o.getCurrentSlide():void 0,l=a?a.getDMUObjects("DMUComment"):void 0;if(l&&l.length)for(let t=0;t<l.length;t++)if(r===l[t]){e=!0;break}if(!e||"DMUComment"!==i||r.isReply()&&_){if(r.getDMUComments&&$){let e=r.getDMUComments();t=t.concat(e.map(e=>e.getAttribute("sUuid")))}}else t.push(r.getAttribute("sUuid"))}}De(H,t),he(t)}function Me(){let e=l.get();H||(H=[]),H.length=0;let t=y.getReviewContext({viewer:J.getViewer()});for(let n=0;n<e.length;n++){let i;if(t&&(i=t.getDMUObjectFromPathElement(e[n].pathElement)),i||(i=U.getDMUObjectFromPathElement(e[n].pathElement)),i){if("DMUComment"===i.getType())H.push(i);else if(i.getDMUComments){let e=i.getDMUComments();H=H.concat(e),ae.fireCrossWidgetSelection(i.getAttribute("sPointedElementID"))}}}De(H),function(e){if(!A)return;if(A.restoreCommentSelection(),!e||!e.length)return;j=null;let t=function(e){if(e){let t=r.buildPathElement(e.getNode());l.isIn({pathElement:t})||s.add({pathElement:t})}};e.forEach(e=>{var n;if(e.isReply()&&_){let n=e.getAttribute("sParentCommentId");const i=K.get(n);if(i&&i.replies&&A){const n=i.replies.find(t=>t.dmuObject===e);n&&(A.selectReply(n.uuid,i.uuid),j=i.uuid,t(i.parentObject))}}else{const i=K.get(e.getAttribute("sUuid"));if(i){let e;if(Q&&I){let t=ae.getElementMatrix("Document"===ae.getDocumentType()?i.pointedPage:null===(n=i.pointedElement)||void 0===n?void 0:n.id),r=C.getViewerPositionFromPoint(re.getViewer(),i.pointedPosition.clone().applyMatrix4(t));r&&(e=r.top-I.getAbsolutePosition().y)}A&&A.selectComment(i.uuid,e,Y),Y=!1,j=i.uuid,t(i.parentObject)}}})}(H)}function ye(e,t){let n,i=e.isReply()&&_;if(t=t||(e.isExternal()?void 0:Ce(e)),!i){let t=function(e){let t=y.getReviewContext({viewer:J.getViewer()}),n=t?t.getValidation():null;if(!n)return;let i=[];return n.getAllRepRefs().forEach(t=>{let n=t.getMarkupContent();if(n){let t=n.getComments();t&&t.forEach(t=>{t.getAttribute("sParentCommentId")===e&&i.push(t)})}}),i}(e.getAttribute("sUuid")||"");t&&t.length&&(n=[],t.forEach(function(t){let i=ye(t,e);i.uuid&&n.push(i)}))}let r=t?ae.getElementInfo(t.getAttribute("sPointedElementID")):null,o=y.getReviewContext({viewer:J.getViewer()});const a=e.getParent(),l=a&&a.getMarkupOwner(),s=fe(a);return{parentObject:t,markupId:e.isExternal()?"externalCommentsBag":s.id,markupName:e.isExternal()?void 0:s.name,dmuObject:e,uuid:e.getAttribute("sUuid")||"",isReply:i,owner:{login:e.getAttribute("sOwner")||""},dateInMs:e.getAttribute("fLastModificationDate")||0,replies:n,content:(d=e.getAttribute("sTextContents"),Array.isArray(d)&&d.length?d[0].endsWith(">")?d.join("\n"):d.map(e=>`<p>${e}</p>`).join(""):""),isReadOnly:e.isReadOnly,isExternal:e.isExternal(),markedAsDeleted:Boolean(e.getAttribute("bMarkedAsDeleted")),isPreview:G&&G.id===e.getAttribute("sUuid"),disableEdition:!o||!o.getRestrictions(l)[i?"reply":"markup"].canEdit,allowReply:!e.isReadOnly()&&_&&o&&o.getValidation()&&o.getRestrictions().reply.canCreate&&!t.getAttribute("bMarkedAsDeleted"),hasAlertFlag:e.hasAlertFlag,pointedPage:t?t.getAttribute("fPointedPageNumber"):void 0,pointedElement:t&&t.getAttribute("sPointedElementID")?{id:t.getAttribute("sPointedElementID"),title:r?r.title:null,index:r?r.index:null}:void 0,pointedPosition:t&&t.getPointedPosition?t.getPointedPosition():void 0};var d}function Se(){se.length&&se.sort(function(e,t){const n=K.get(e),i=K.get(t);return n?i?n.pointedElement&&i.pointedElement?n.pointedElement.index<i.pointedElement.index?-1:n.pointedElement.index>i.pointedElement.index?1:n.pointedPosition?i.pointedPosition?n.pointedPosition.y>i.pointedPosition.y?-1:n.pointedPosition.y<i.pointedPosition.y?1:Math.sign(n.dateInMs-i.dateInMs):1:-1:void 0===n.pointedPage?-1:void 0===i.pointedPage?1:n.pointedPage<i.pointedPage?-1:n.pointedPage>i.pointedPage?1:n.pointedPosition?i.pointedPosition?n.pointedPosition.y>i.pointedPosition.y?-1:n.pointedPosition.y<i.pointedPosition.y?1:0:1:-1:1:-1})}function we(){if(!A)return;let n=y.getReviewContext({viewer:J.getViewer()}),r=n?n.getCurrentSessionMarkup():null;t=r?r.getMaturityState():null;let o=i.getCommand("DMUCommentCmdHdr",e.commandContext);A.updatePanelHeader({quickAccessBtnAvailability:{flag:o&&o.isEnabled(),id:"newCommentButton"}});let a=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),l=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext);K&&0!==K.size?(a&&!a.isEnabled()&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"nextButton"}}),a.enable()),l&&!l.isEnabled()&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"previousButton"}}),l.enable())):(a&&a.isEnabled()&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"nextButton"}}),a.disable()),l&&l.isEnabled()&&(A.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"previousButton"}}),l.disable()))}async function Ee(e,t){const n=K.get(t||e);if(n){const{min:e,max:t}=n.parentObject.getNode().getBoundingBox();if(e.x===1/0)return;const i=(new p.Vector3).getPositionFromMatrix(n.parentObject.getNode().getMatrixWorld()),r=C.getMMPerPixelRatio(re.getViewer(),i),o=re.getViewer().currentViewpoint.getEyePosition(),a=i.sub(o),l=re.getViewer().canvas.getSize(),u=5,g={x:(a.x+e.x)/r+l.width/2-u,y:-(a.y+t.y)/r+l.height/2-u},c=s.get(),m=d.get();s.empty(),d.empty();const f=new ImageData(l.width,l.height);re.getViewer().renderToTarget(f,re.getViewer().currentViewpoint),s.add(c),d.add(m);const h=144,v=108,D=document.createElement("canvas"),b=D.getContext("2d");if(b){let e=await createImageBitmap(f,0,0,f.width,f.height);b.scale(1,-1),b.drawImage(e,g.x,f.height-g.y,h,-v,0,0,h,-v),e.close()}return D.toDataURL("image/png")}}async function Ue(e,t){const n=await Ee(e,t);n&&oe&&oe.fireEvent("onPreviewThumbnailUpdateRequested",{elementId:e,thumbnailData:n})}function xe(e,t){var n;if(e.isTemporary()||!A)return;I.ensureVisible(),ue();let i=y.getReviewContext({viewer:J.getViewer()});if(e&&(e.isExternal()||i&&i.getCurrentSessionMarkup())&&!K.has(e.getAttribute("sUuid"))){let i=ye(e,t);if(e.getAttribute("bMarkedAsDeleted")&&!(null===(n=i.replies)||void 0===n?void 0:n.length))return void(null==t||t.getParent().getSlides()[0].getNode().removeChild(t.getNode()));i.uuid&&(se.push(i.uuid),A.addComment(i),K.set(e.getAttribute("sUuid"),i),Se(),we(),e.setPreviewFlag(i.isPreview),i.isPreview&&ae&&!ae.isRunning()&&ae.isADocumentDisplayed()&&Ue(i.uuid))}}function Oe(e,t,n){var i,r,o,a;if(K&&A){let l=n||ye(e,t);const s=K.get(e.getAttribute("sUuid"));if(s){let e=Object.keys(l),t=!1;for(let n=0;n<e.length;n++){const o=e[n],a=l[o];a?("pointedPage"===o&&a!==s[o]?t=!0:"pointedElement"!==o||a.id===(null===(i=s[o])||void 0===i?void 0:i.id)&&a.index===(null===(r=s[o])||void 0===r?void 0:r.index)?"pointedPosition"===o&&a&&s[o]&&!a.equals(s[o])&&(t=!0):t=!0,"owner"===o?s[o].login=a.login:s[o]=a):"highlights"===o&&(s[o]=void 0)}X&&(X.has(s.uuid)&&(null===(o=X.get(s.uuid))||void 0===o||o.forEach(e=>e.update({...s,disableEdition:!0}))),X.has(s.uuid+"-tooltip")&&(null===(a=X.get(s.uuid+"-tooltip"))||void 0===a||a.forEach(e=>e.update({...s,disableEdition:!0})))),A.updateComment(s,t),t&&Se()}}}function Pe(e,t){ue();let n=y.getReviewContext({viewer:J.getViewer()});if(!(n&&n&&n.getCurrentSessionMarkup()&&e))return;const i=K.get(t.getAttribute("sUuid"));if(i&&A){let n=ye(e,t);if(n.uuid){if(-1===(i.replies?i.replies.findIndex(function(e){return e.uuid===n.uuid}):-1)){A.addReply(n,i.uuid);let e=i.replies||[];e.push(n),i.replies=e}e.setPreviewFlag(n.isPreview),n.isPreview&&Ue(n.uuid,i.uuid)}}}function Re(e,t){ue(),l.empty();let n=y.getReviewContext({viewer:J.getViewer()}),i=n?n.getCurrentSessionMarkup():null;if(!n||!e||!i)return;let o=t||Ce(e);if(o){const t=K.get(o.getAttribute("sUuid"));if(t&&t&&t.replies&&t.replies.length){let n=t.replies.findIndex(function(t){return t.dmuObject===e});if(n>=0){A&&A.removeReply(t.replies[n].uuid,t.uuid),t.replies.splice(n,1),e.getParent().removeComment(e);let i=r.buildPathElement(t.dmuObject.getNode());l.add({pathElement:i})}}}}function Ae(e){if(!e||!e.target||!e.target.dmuObject)return;ue(),Q=!1,Y=!0;let t=r.buildPathElement(e.target.dmuObject.getNode());l.empty(),l.add({pathElement:t}),ae.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:0})}function Ie(e){if(!e||!e.target||!e.target.dmuObject)return;let t=e.target.isReply?null:r.buildPathElement(e.target.dmuObject.getNode());d.empty(),t&&e.prehighlightedFlag&&($=!1,d.add({pathElement:t}))}function ke(e){if(!e||!e.target||!e.target.dmuObject)return;ue(),Q=!1;let t=!0;if(e.selected){let n=r.buildPathElement(e.target.dmuObject.getNode());if(e.event.from[0].event.ctrlKey)if(l.isIn({pathElement:n})){if(e.target.parentObject){let t=r.buildPathElement(e.target.parentObject.getNode());s.remove({pathElement:t})}l.remove({pathElement:n}),t=!1}else l.add({pathElement:n});else l.empty(),s.empty(),l.add({pathElement:n})}let n=re.getViewer();if(n.getVisibleSpace()||(n.swapVisibleSpace(),n.render()),t&&e.target.pointedPosition){let t=e.div.getPosition(n.canvas);ae.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:n.SCREEN_HEIGHT/2-t.y-30})}e.selected&&!e.isEnableEdition&&I.isSmallWidth()&&I.collapsePanel()}function Ve(e){if(e&&e.parentObject&&e.uuid&&e.parentObject.getParent){let t=e.parentObject.getParent();if(t){let n=m.giveReqCompareController({context:re}),i=t&&t.getSlides?t.getSlides():void 0;if(n&&i&&i.length>1)for(let r=0;r<i.length;r++)if(i[r]!==t.getCurrentSlide()){let o=i[r].getDMUObjects("DMUComment");for(let a=0;a<o.length;a++)if(o[a].getAttribute("sUuid")===e.uuid){t.getCurrentSlide().getDMUObjects("DMUCompareRequirement").length?i[r].getDMUObjects("DMUCompareRequirement").length?n.displayRequirementComparison(i[r].getDMUObjects("DMUCompareRequirement")[0]):n.toggleRequirementCompareCmd(!1):i[r].getDMUObjects("DMUCompareRequirement").length&&n.displayRequirementComparison(i[r].getDMUObjects("DMUCompareRequirement")[0]),t.setCurrentSlide(i[r]);break}}}}}function Te(e,t,n){if(!e||!t||t&&(!t.commentId||!t.commentData))return;let i=!1,r=!0,o=t.commentData.dmuObject.getParent(),a=o?o.getSlides():void 0,l=o?o.getCurrentSlide():void 0;if(l&&a&&a.length>1)for(let e=0;e<a.length;e++)if(a[e]!==l){let n=a[e].getDMUObjects("DMUComment");for(let o=0;o<n.length;o++)if(n[o].getAttribute("sUuid")===t.commentId&&(r=!1,a[e].getDMUObjects("DMUCompareRequirement").length)){i=!0;break}}if(r||!i&&l&&0===l.getDMUObjects("DMUCompareRequirement").length)e(n);else if(oe){if(i){let t=oe.addEvent("onRequirementComparisonDisplayed",()=>{oe&&(oe.removeEvent(t),e(n),i=!1)})}else{let t=oe.addEvent("onRequirementComparisonEnded",()=>{oe&&(oe.removeEvent(t),e(n))})}n&&n.target?Ve(n.target):Ve(K.get(t.commentId))}}function je(e){Te(ke,{commentId:e.target.uuid,commentData:e.target},e)}function Fe(e){if(e&&e.target&&e.target.dmuObject){let t=e.value.split(/(?:\r\n|\r|\n)/g);const n=e.target.dmuObject.getAttribute("sTextContents");Array.isArray(n)&&n.length===t.length&&!n.some((e,n)=>e!==t[n])||(t.find(e=>e)&&e.target.dmuObject.setAttributes([{name:"sTextContents",value:t},{name:"fLastModificationDate",value:Date.now()}]),e.target.dmuObject.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e.target.dmuObject}),I&&I.isSmallWidth()&&I.collapsePanel())}}function Ne(t){if(t&&t.target&&t.target.dmuObject){let n=r.buildPathElement(t.target.isReply?t.target.parentObject.getNode():t.target.dmuObject.getNode());l.empty(),Q=!1,l.add({pathElement:n});let o=i.getCommand("DMUReplyCmdHdr",e.commandContext);o&&o.begin()}}function Le(e){if(!e||!e.target.dmuObject)return;let t=r.buildPathElement(e.target.dmuObject.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||(l.empty(),s.empty()),Q=!1,l.add({pathElement:t}),J.getExecutionContext?J.getContextualUIManager()._showContextMenu(e.position.clone()):J.getContextualUIManager()._showContextualMenu(e.position.clone())}function Be(e){if(!W||!q)return;let t=e.eventType||e.event||e.type;"scroll"!==t&&"@onViewpointBeginMove"!==t||q.clearRect(0,0,W.width,W.height),"scroll"!==t&&"@onViewpointEndMove"!==t||De(H)}function He(e){if("freeZoneResize"!==e.type&&"move"!==e.type&&W){let e=J.getViewerFrame().getDimensions();W.width=e.width,W.height=e.height}De(H)}function We(t){let n;y.getReviewContext({viewer:J.getViewer()})&&(t.target&&("textarea"===t.target.type||"input"===t.target.type||"P"===t.target.tagName||t.target.isContentEditable)||(!t.ctrlKey||"ArrowRight"!==t.key&&39!==t.keyCode?!t.ctrlKey||"ArrowLeft"!==t.key&&37!==t.keyCode||(n=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext))&&n.isEnabled()&&n.begin():(n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext))&&n.isEnabled()&&n.begin()))}function qe(e){let t=y.getReviewContext({viewer:J.getViewer()});if(!t)return;let n=t.getValidation();n&&n.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return oe&&oe.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}function _e(e){var t;let n=y.getReviewContext({viewer:J.getViewer()}),i=n?n.getValidation():null;if(i){let n=i.getMarkups().find(t=>{let n=t.getRepRef();return n.getPlmID&&n.getPlmID()===e.id}),o=null===(t=null==n?void 0:n.getRepRef())||void 0===t?void 0:t.getMarkupContent();if(o){let t=r.buildPathElement(o.getNode());l.empty(),s.empty(),l.add({pathElement:t}),d.add({pathElement:t}),J.getExecutionContext?J.getContextualUIManager()._showContextMenu(e.position.clone()):J.getContextualUIManager()._showContextualMenu(e.position.clone())}}}function ze(e){U.setGuidelineVisibility(e.dsModel.contentVisibleState)}function Xe(){if(!ee)return;if(A||(A=new M,k={onCommentSelected:A.subscribe("onCommentSelected",je),onCommentEditionEnd:A.subscribe("onCommentEditionEnd",Fe),onCommentReply:A.subscribe("onCommentReply",Ne),onCommentCtxMenuRequired:A.subscribe("onCommentCtxMenuRequired",Le),onCommentPreselected:A.subscribe("onCommentPreselected",Ie),onPanelScroll:A.subscribe("onPanelScroll",Be),onMarkupRenamed:A.subscribe("onMarkupRenamed",qe),onSetCurrentMarkup:A.subscribe("onSetCurrentMarkup",ve),onMarkupCtxMenuRequired:A.subscribe("onMarkupCtxMenuRequired",_e),onNewCommentCreated:A.subscribe("onNewCommentCreated",()=>{let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t&&(t.isRunning()?t.end():t.begin(),I&&I.isSmallWidth()&&I.collapsePanel())}),onNewMentions:A.subscribe("onNewMentions",e=>{oe&&oe.fireEvent("onNewCommentMentionsCreated",{commentId:e.commentId,mentions:e.mentions})}),onCommentCheckSelected:A.subscribe("onCommentCheckSelected",e=>{oe&&oe.fireEvent("onCommentOrSlideInformationIconClicked",e)}),onCommentHighlightSelected:A.subscribe("onCommentHighlightSelected",e=>{oe&&oe.fireEvent("onCommentOrSlideInformationIconClicked",e)}),onCommentFiltersApplied:A.subscribe("onCommentFiltersApplied",()=>{A&&A.updatePanelHeader({quickAccessBtnList:pe()})})},(V={}).onPSOEmpty=d.onEmpty(be),V.onPSORemove=d.onRemove(be),V.onPSOAdd=d.onAdd(be),V.onCSOEmpty=l.onEmpty(Me),V.onCSORemove=l.onRemove(Me),V.onCSOAdd=l.onAdd(Me),A.setReadOnlyFlag(Z)),!I){let e=y.getReviewContext({viewer:J.getViewer()}),t=w.commentsPanelTitle,i=e?e.getValidation():null,r=e&&e.getCurrentSessionMarkup()||void 0;i?t=i.getName():r&&(t=r.getAttribute("sName"));let o=A.buildPanel({allowReplies:Boolean(e&&e.getValidation()),panelTitle:t,contextualCmdList:ce(),quickAccessBtnList:pe()});A.setRestrictedModeFlag(Boolean(e&&!e.getRestrictions(r).markup.canEdit)),L&&A.setDragContent(L),me();let a=300,l=160,s=250;I=new n({id:"DMUCommentsPanel",className:"DMUCommentsPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-comment",immersiveFrame:J.getImmersiveFrame(),viewerFrame:J.getViewerFrame(),content:o,minWidth:s,width:a,minHeight:l,height:l,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea}),U.setVisibleFlag(le),!ae||!ae.isRunning()&&ae.isADocumentDisplayed()||I.setEnableFlag(!1)}let t=J.getUIFrame();if(t){W=new h.Element("canvas",{id:"DMUCommentGidelineCanvas",styles:{height:"100%",width:"100%",pointerEvents:"none",float:"left"}}).inject(t);let e=J.getViewerFrame(),n=e.getDimensions();W&&(W.width=n.width,W.height=n.height,q=W.getContext("2d")),e.addEvent("resize",He),J.getImmersiveFrame().addEventListener("freeZoneResize",He)}N=c.subscribe({event:"/VISU/"},Be),I.addEventListener("move",He),I.addEventListener("contentVisibleStateChange",ze),document.addEventListener("keyup",We)}function Ge(){let e=y.getReviewContext({viewer:J.getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(t&&!t.isReadOnly()){let e=o.getManager({name:"DMUUserExperienceManager",context:J});e&&(e.registerContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),e.registerContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}))}}function Ke(){if(Ge(),ae.isADocumentDisplayed()&&"Document"===ae.getDocumentType()){let e=ae?ae.getExternalComments():null;if(e&&e.length){let t=["DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight"];window.require(t,function(t,n){let i;F||(F=[]),A||Xe();let r=J.getViewer().getNodes();for(let e=0;e<r.length;e++)if("DecorationBag"===r[e].name){i=r[e];break}e.forEach(function(e){let r=new t(re.getViewer(),null,!0);r.setAttributes([{name:"sUuid",value:v.getUUID()},{name:"sOwner",value:e.owner.name},{name:"sTextContents",value:e.content}]);let o=new n(re.getViewer(),null,!0);o.setAttributes([{name:"sUuid",value:v.getUUID()},{name:"vPosition",value:e.pointedPosition},{name:"fPointedPageNumber",value:e.pointedPage},{name:"oSelection",value:[{page:e.pointedPage,rects:[e.rect]}]}]),o.addDMUComment(r),xe(r,o),i&&i.addChild(o.getNode()),F&&F.push(o),o.refreshNode()}),J.getViewer().render()})}}}if(oe){let e=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(L=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:u.getPlatformId(),serviceId:"3DSpace",contextId:g.getSetting("pad_security_ctx")?g.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),A&&A.setDragContent(L))},n=y.getReviewContext({viewer:J.getViewer()});n&&e(n.getReviewCtxInformation()||void 0),ne.onReviewCtxInformationChanged=oe.addEvent("onReviewCtxInformationChanged",e),ne.onDMUObjectActiveFlagChanged=oe.addEvent("onDMUObjectActiveFlagChanged",function(e){!((n=y.getReviewContext({viewer:J.getViewer()}))&&A&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||n.getValidation()||"DMUMarkup"!==e.dmuObject.getType()||ue()}),ne.onDMUCommentEditionRequired=oe.addEvent("onDMUCommentEditionRequired",function(e){e&&e.dmuObject&&"DMUComment"===e.dmuObject.getType()&&function(e,t){if(!A)return;let n=0;K.size||(n=500),setTimeout(()=>{A&&A.enableContentEdition(e.getAttribute("sUuid"),t?t.getAttribute("sUuid"):void 0)},n)}(e.dmuObject,e.parentObject)}),ne.onDMUObjectInitialized=oe.addEvent("onDMUObjectInitialized",function(e){let t=y.getReviewContext({viewer:J.getViewer()}),n=t?t.getCurrentSessionMarkup():null;if(e&&e.dmuObject){let t=e.dmuObject.getType();"DMUComment"===t?e.dmuObject.isReply()&&_?Pe(e.dmuObject,e.parentObject):(A||Xe(),xe(e.dmuObject,null),De(H)):"DMUMarkup"!==t&&"ReviewMarkup"!==t||(Ge(),A&&me()),n||"DMUValidationValidation"!==t||me()}}),ne.onCurrentSessionMarkupChanged=oe.addEvent("onCurrentSessionMarkupChanged",function(e){let t=y.getReviewContext({viewer:J.getViewer()});if(_=Boolean(t&&t.getValidation()),e&&e.currentMarkup){let n=fe(e.currentMarkup).id;if(z=n,t&&!t.getValidation()){let t=e.currentMarkup.getSlides();t&&(t.forEach(e=>{e.getDMUObjects().filter(function(e){return e.getDMUComments&&e.getDMUComments().length}).forEach(function(e){e.getDMUComments().forEach(function(t){A||Xe(),xe(t,e)})})}),De(H),A&&me())}}else z=null;A&&(A.setCurrentMarkup(z),A.setAllowReplies(Boolean(t&&t.getValidation())),A.updatePanelHeader({quickAccessBtnList:pe(),contextualCmdList:ce()}))}),ne.onDMUObjectVisuRefreshRequired=oe.addEvent("onDMUObjectVisuRefreshRequired",function(e){if(e&&e.dmuObject){let t=e.dmuObject.getType();if("DMUSlide"===t)F&&F.forEach(function(e){e.refreshNode()}),J.getViewer().render();else if("DMUComment"===t)e.dmuObject.isReply()&&_?function(e,t,n){var i;if(!K||!e)return;let r=t||Ce(e),o=n||ye(e,r);if(r&&o){const t=K.get(r.getAttribute("sUuid"));if(t&&t.replies&&A&&t.replies){let n=t.replies.find(t=>t.dmuObject===e);if(!n)return;let r=Object.keys(o);for(let e=0;e<r.length;e++)o[r[e]]&&(n[r[e]]=o[r[e]]);X&&X.has(n.uuid+"-tooltip")&&(null===(i=X.get(n.uuid+"-tooltip"))||void 0===i||i.forEach(e=>{n&&e.update({...n,disableEdition:!0})})),A.updateComment(t)}}}(e.dmuObject):Oe(e.dmuObject);else if(e.dmuObject.getDMUComments){e.dmuObject.getDMUComments().forEach(function(t){const n=t.getAttribute("sUuid");Oe(t,e.dmuObject),G&&n===(G.parentId||G.id)&&Ue(G.id,G.parentId),t.getAssociatedHighlightData().length&&Ee(n).then(e=>{oe&&oe.fireEvent("onPreviewUpdateOnHighlightRequested",{elementId:n,imageData:e})})})}}}),ne.onDMUObjectsVisuRefreshRequired=oe.addEvent("onDMUObjectsVisuRefreshRequired",function(){let e=y.getReviewContext({viewer:J.getViewer()}),t=e?e.getVisibleMarkups():null;if(t){t.map(e=>e.getCurrentSlide()).forEach(e=>{e&&e.refreshNode()})}F&&F.forEach(function(e){e.refreshNode()}),J.getViewer().render()}),ne.onDMUObjectDeleted=oe.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject){let t=e.dmuObject.getType();if("DMUComment"===t)U.removeComment(e.dmuObject);else if("DMUMarkup"===t&&A){let t=fe(e.dmuObject).id;A.removeMarkup(t),we()}}}),ne.onDMUObjectAttributeModified=oe.addEvent("onDMUObjectAttributeModified",function(e){e&&"bMarkedAsDeleted"===e.attrName&&"DMUComment"===e.dmuObject.getType()&&e.value&&A&&A.removeComment(e.dmuObject.getAttribute("sUuid"))}),ne.onUpdateImpactedChecksList=oe.addEvent("onUpdateImpactedChecksList",function(e){if(!e||!e.highlight)return;const t=e.highlight.getPlmID(),n=K.values();for(let i=0;i<K.size;i++){const i=n.next().value;if(i.highlights&&i.highlights.some(e=>e.id===t)){i.dmuObject.updateAssociatedHighlightData({id:t,hasImpactedChecks:Boolean((e.highlight.getAssociatedCheck()||[]).length)});break}}}),ne.onCurrentElementChanged=oe.addEvent("onCurrentElementChanged",function(e){e&&e.currentElement&&A&&(Q&&A.scrollPanelToContainer(e.currentElement),e.endMove&&(Q=!0))}),ne.onDMUObjectReadOnlyFlagChanged=oe.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){var t;e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&((t=e.dmuObject.isReadOnly())!==Z&&(Z=t,ue(),me(),A&&(A.resetCommentDisplayHistory(),A.setReadOnlyFlag(t))))}),ne.on2DDocumentLoadSuccess=oe.addEvent("on2DDocumentLoadSuccess",()=>{F&&F.length||Ke(),I&&I.setEnableFlag(!0)}),ne.OnReviewMarkupLoaded=oe.addEvent("OnReviewMarkupLoaded",function(e){let t=y.getReviewContext({viewer:J.getViewer()}),n=t?t.getValidation():null;if(n){let t=n.getAllRepRefs(),i=[],r=[];for(let e=0;e<t.length;e++){let n=t[e],o=n.getParent().getValType();"Markup"===o?i.push({title:n.getParent().getName(),content:n,id:n.getPlmID()}):"Reply"===o&&r.push({title:n.getParent().getName(),content:n,id:n.getPlmID(),parentID:n.getParentRepRef().getPlmID()})}let o={};i.forEach(e=>{U.addMarkup(e);let t=e.content.getMarkupContent(),n=null==t?void 0:t.getSlides()[0];if(n){t.setCurrentSlide(n);let e=n.getDMUObjects();e&&e.forEach(e=>{if(e.getDMUComments){let t=e.getDMUComments();t&&t.forEach(t=>{xe(t,e),o[t.getAttribute("sUuid")]=t})}})}}),r.forEach(e=>{var t;let n=null===(t=e.content.getMarkupContent())||void 0===t?void 0:t.getComments();n&&n.forEach(e=>{let t=e.getAttribute("sParentCommentId");o[t]&&Pe(e,o[t])})});let a=n.getCurrentMarkup();if(a&&A&&(z=a.getRepRef().getPlmID(),A.setCurrentMarkup(z)),n.updateVisibleMarkups(),null==e?void 0:e.commentId)if(K.has(e.commentId)){const t=K.get(e.commentId);if(t)if(ae&&ae.isADocumentDisplayed()&&!ae.isRunning())Ae({target:t});else if(oe){let e=oe.addEvent("on2DDocumentLoadSuccess",()=>{oe&&oe.removeEvent(e),Ae({target:t})})}}else K.forEach(t=>{t.replies&&t.replies.some(t=>{if(t.uuid===e.commentId){if(ae&&ae.isADocumentDisplayed()&&!ae.isRunning())Ae({target:t});else if(oe){let e=oe.addEvent("on2DDocumentLoadSuccess",()=>{oe&&oe.removeEvent(e),Ae({target:t})})}return!0}})})}}),ne.onDMURemoveSessionReview=oe.addEvent("onDMURemoveSessionReview",function(){A&&K&&(F&&F.length?(K.forEach((e,t)=>{e.isExternal||K.delete(t)}),we(),me()):U.cleanCommentsPanel())}),ne.onDMUCommentAssociatedToHighlight=oe.addEvent("onDMUCommentAssociatedToHighlight",function(e){e&&e.dmuObject&&Oe(e.dmuObject,null,{highlights:e.highlights})}),ne.onMarkupObjectAttributesModified=oe.addEvent("onMarkupObjectAttributesModified",function(e){e&&e.object&&e.attr&&"DMUMarkup"===e.object.getType()&&e.attr.forEach(function(e){e.currentState&&A&&(t=e.currentState,E&&(E.destroy(),E=null),A.updatePanelHeader({quickAccessBtnList:pe(),contextualCmdList:ce()}))})}),ne.onValidationObjectAttributesModificationRequest=oe.addEvent("onValidationObjectAttributesModificationRequest",function(e){var t,n;e&&e.dmuObject&&"name"===(null===(t=e.attr)||void 0===t?void 0:t.key)&&"Markup"===(null===(n=e.dmuObject.getParent())||void 0===n?void 0:n.getType())&&K.forEach(t=>{t.markupId===e.dmuObject.getPlmID()&&Oe(t.dmuObject,t.parentObject,{markupName:e.attr.value})})}),ne.onHighlightAttributeChanged=oe.addEvent("onHighlightAttributeChanged",function(e){if(e&&e.objectIds&&e.objectIds.length){const t=e.objectIds.slice(),n=K.values();for(let i=0;i<K.size;i++){const i=n.next().value;if(i.highlights&&i.highlights.length){if(t.filter(e=>{var t;return null===(t=i.highlights)||void 0===t?void 0:t.some(t=>t.id===e)}).forEach(n=>{i.dmuObject.updateAssociatedHighlightData({id:n,rating:e.rating}),t.splice(t.indexOf(n),1)}),!t.length)break}}}}),ne.onHighlightIssueCreated=oe.addEvent("onHighlightIssueCreated",function(e){if(e&&e.highlightId){const t=K.values();for(let n=0;n<K.size;n++){const n=t.next().value;if(n.highlights&&n.highlights.some(t=>t.id===e.highlightId)){n.dmuObject.updateAssociatedHighlightData({id:e.highlightId,hasIssue:!0});break}}}}),ne.onReviewObjectAttributesModified=oe.addEvent("onReviewObjectAttributesModified",function(e){var t;if(e&&e.attr&&e.attr.length&&A){let e=y.getReviewContext({viewer:J.getViewer()});if(e&&e.getValidation()){e.getValidation().getMarkups().forEach(t=>{if(A&&e&&t){let n=t.getRepRef();n.getMarkupContent()&&(e.getRestrictions(t).markup.canEdit?A.addMarkup({id:n.getPlmID(),owner:n.getOwner(),title:n.getParent().getName()}):A.removeMarkup(n.getPlmID()))}});const n=e.getCurrentSessionMarkup();n&&(A.setCurrentMarkup(null===(t=n.getMarkupOwner())||void 0===t?void 0:t.getPlmID()),A.setRestrictedModeFlag(!e.getRestrictions(n).markup.canEdit))}K.forEach(t=>{const n=t.dmuObject.getParent(),i=n&&n.getMarkupOwner();t.allowReply=_&&(null==e?void 0:e.getRestrictions().reply.canCreate),t.disableEdition=!(null==e?void 0:e.getRestrictions(i).markup.canEdit),t.replies&&t.replies.forEach(t=>{const n=t.dmuObject.getParent(),i=n&&n.getMarkupOwner();t.allowReply=_&&(null==e?void 0:e.getRestrictions().reply.canCreate),t.disableEdition=!(null==e?void 0:e.getRestrictions(i).reply.canEdit)}),null==A||A.updateComment(t)}),me()}})}function Je(e){if(e){const t=K.get(e);if(l.empty(),s.empty(),t){let e=r.buildPathElement(t.dmuObject.getNode());Q=!1,Y=!0,l.add({pathElement:e}),ae.centerViewpointAtElementPosition({elementID:(t.pointedElement?t.pointedElement.id:null)||t.pointedPage,position:t.pointedPosition}),I&&I.isSmallWidth()&&I.collapsePanel()}}}this.addMarkup=function(e){let t=y.getReviewContext({viewer:J.getViewer()}),n=t?t.getValidation():null;e&&n&&ae&&(A||Xe(),A&&(null==t?void 0:t.getRestrictions(e.content).markup.canEdit)&&(A.addMarkup({id:e.id,owner:e.content.getOwner(),title:e.title,parentID:e.parentID}),A.setCurrentMarkup(e.id)))},this.editMarkupName=function(e){A&&e&&e.getPlmID&&A.editMarkupName(e.getPlmID())},this.getSelectedComments=function(){return H&&H.filter(e=>!e.isExternal())},this.getCommentTooltip=function(e){if(!ie)return null;const t=[];if(K.forEach(n=>{n.parentObject.getNode()===e&&t.push(n)}),t.length){X||(X=new Map);let e=h.createElement("div",{class:"DMUCommentTooltipMainDiv"});return t.forEach(t=>{if(!X)return;const n=X.get(t.uuid+"-tooltip");let i=n&&n[0]?n[0].getCommentDiv():null;if(!i){let e=new S({commentData:{...t,disableEdition:!0}});X.set(t.uuid+"-tooltip",[e]),i=e.getCommentDiv()}e.appendChild(i),t.replies&&t.replies.forEach(function(e){if(!X)return;const t=X.get(e.uuid+"-tooltip");let n=t&&t[0]?t[0].getCommentDiv():null;if(!n){let t=new S({commentData:{...e,disableEdition:!0},allowReplies:_});X.set(e.uuid+"-tooltip",[t]),n=t.getCommentDiv()}null==i||i.appendChild(n)})}),e}},this.getCommentRepresentation=function(e,t){var n;const i=K.get(e);if(i){X||(X=new Map);let r={displayMode:t,commentData:{...i,disableEdition:!0},onClickCB:Ae,onEnterCB:Ie,onLeaveCB:Ie},o=new S(r);return X.has(e)?null===(n=X.get(e))||void 0===n||n.push(o):X.set(e,[o]),{getDiv:o.getCommentDiv,updateDisplayMode:o.updateDisplayMode,getImage:()=>Ee(e),remove:()=>{if(X){let t=X.get(e);t&&(t.splice(t.indexOf(o),1),0===t.length&&X.delete(e)),o.remove()}}}}},this.hasComments=function(){return Boolean(K&&K.size)},this.applyComment=function(e){if(!e.commentId)return;const t=K.get(e.commentId);t&&Ae({target:t})},this.setVisibleFlag=function(e){le=e,I&&I.setPanelVisibilityFlag(e),W&&W.setStyle("display",e?"block":"none")},this.setPresentationModeFlag=function(e){ie=e},this.removeComment=function(e,t){if(!e)return;if(e.isReply()&&_)return void Re(e);ue();const n=K.get(e.getAttribute("sUuid"));if(n){n.replies&&n.replies.slice().forEach(function(t){Re(t.dmuObject,e)}),se.splice(se.indexOf(n.uuid),1),A&&A.removeComment(n.uuid),K.delete(n.uuid);let i=n.parentObject;we();let r=y.getReviewContext({viewer:J.getViewer()}),o=r?r.getCurrentSessionMarkup():null;if(i&&o){let n;s.empty();const a=r&&r.getValidation()&&"Activated"===r.getValidation().getRestrictedEditionFlag();if(t)(n=o.getSlides()[0])&&(a&&!e.isReply()?(e.setAttribute("bMarkedAsDeleted",!0),i.setAttribute("bMarkedAsDeleted",!0),n.getNode().removeChild(i.getNode())):n.removeDMUObject(i)),J.getViewer().render();else{a&&!e.isReply()?e.setAttribute("bMarkedAsDeleted",!0):i.removeDMUComment(e);let t=i.getType();if("DMUCommentHighlight"===t||"DMUCommentPositioned"===t){let t=i.getAttribute("lComments");t&&t.length&&(1!==t.length||-1===t.indexOf(e))||((n=o.getSlides()[0])&&(a&&!e.isReply()?(i.setAttribute("bMarkedAsDeleted",!0),n.getNode().removeChild(i.getNode())):n.removeDMUObject(i)),J.getViewer().render())}}}}},this.selectNextOrPreviousComment=function(e){ue();let t,n=e?1:-1,i=j?se.indexOf(j):-1;do{let r=(i+n)%se.length;r<0&&(r=se.length-1),t=se[r],n+=e?1:-1}while((null==A?void 0:A.isCommentFiltered(t))&&n<=se.length);Te(Je,{commentId:t,commentData:K.get(t)},t)},this.hasReplies=(e=>{const t=K.get(e);return Boolean(t&&t.replies&&t.replies.length)}),this.getDMUObjectFromPathElement=function(e){if(!e)return;let t=e.getLastElement(!0),n=t.getDMUType?t.getDMUType():null;if(n){let e;if("DMUComment"===n){let n=K.values();for(let i=0;i<K.size;i++){let i=n.next().value;if(i.dmuObject.getNode()===t)return i.dmuObject;if(i.replies&&i.replies.length&&(e=i.replies.findIndex(e=>e.dmuObject.getNode()===t))>=0)return i.dmuObject}}else if(F&&(e=F.findIndex(function(e){return e.getNode()===t}))>=0)return F[e]}},this.setGuidelineVisibility=function(e){q&&W&&(e?(W.setStyle("display","block"),De(H)):W.setStyle("display","none"))},this.setCommentAsPreview=((e,t,n)=>{if(G&&G.id===e)return;const i=K.get(_&&t||e);if(i&&A){if(G&&G.id){const e=K.get(_&&G.parentId||G.id);e&&(G.parentId&&e.replies?e.replies.some(e=>{if(G&&e.uuid===G.id)return e.dmuObject.setPreviewFlag(!1),e.isPreview=!1,!0}):(e.dmuObject.setPreviewFlag(!1),e.isPreview=!1),A.updateComment(e))}t&&i.replies?i.replies.some(t=>{if(G&&t.uuid===e)return t.dmuObject.setPreviewFlag(!0),t.isPreview=!0,!0}):(i.dmuObject.setPreviewFlag(!0),i.isPreview=!0),A.updateComment(i)}G={id:e,parentId:_?t:void 0},n&&Ue(e,t)}),this.updateHeaderCommandsAvailability=(()=>{we()}),this.setCommentLoading=((e,t)=>{A&&A.setCommentLoading(e,t)}),this.cleanCommentsPanel=function(){let e;ue(),document.removeEventListener("keyup",We),we();let t=J.getViewer().getNodes();if(F&&F.length){for(let n=0;n<t.length;n++)if("DecorationBag"===t[n].name){e=t[n];break}F.forEach(function(t){e&&e.removeChild(t.getNode())})}if(A){let e=Object.keys(k);for(let t=0;t<e.length;t++)A.unsubscribe(k[e[t]]||"");k={},A.clear()}V&&(d.unsubscribe(V.onPSOEmpty),d.unsubscribe(V.onPSORemove),d.unsubscribe(V.onPSOAdd),l.unsubscribe(V.onCSOEmpty),l.unsubscribe(V.onCSORemove),l.unsubscribe(V.onCSOAdd)),W&&q&&(J.getViewerFrame().removeEvent("resize",He),J.getImmersiveFrame().removeEventListener("freeZoneResize",He),q.clearRect(0,0,W.width,W.height),q=null,W.remove()),N&&c.unsubscribe(N),T&&T.destroy(),B&&clearInterval(B),I&&(I.removeEventListener("move",He),I.removeEventListener("contentVisibleStateChange",ze),I.setPanelVisibilityFlag(!1),I.clean()),K.clear(),Z=!1,L=W=T=A=I=F=B=V=null},this.clear=function(){U.cleanCommentsPanel();let e,t,n=o.getManager({name:"DMUUserExperienceManager",context:J});if(n&&(n.unregisterContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),n.unregisterContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"})),oe)for(t=Object.keys(ne),e=0;e<t.length;e++)oe.removeEvent(ne[t[e]]||"");X&&X.clear(),ne={},T&&T.destroy(),T=null,B&&clearInterval(B),K.clear(),se.length=0,X=oe=A=B=j=null},ae&&ae.isADocumentDisplayed()&&!ae.isRunning()&&Ke()}}let U=[];return class{static getDMUCommentsController(e){let t;for(let n=0;n<U.length;n++)if(U[n].context===e.context)return t=U[n].controller,U[n].count++,t;let n=new E(e);return t=Object.freeze({addMarkup:function(e){n&&n.addMarkup(e)},editMarkupName:function(e){n&&n.editMarkupName(e)},setVisibleFlag:function(e){n&&n.setVisibleFlag(e)},setPresentationModeFlag:function(e){n&&n.setPresentationModeFlag(e)},getCommentTooltip:function(e){if(n)return n.getCommentTooltip(e)},getCommentRepresentation:function(e,t){if(n)return n.getCommentRepresentation(e,t)},getSelectedComments:function(){if(n)return n.getSelectedComments()},hasComments:function(){return!!n&&n.hasComments()},applyComment:function(e){if(n)return n.applyComment(e)},removeComment:function(e,t){n&&n.removeComment(e,t)},setGuidelineVisibility:function(e){n&&n.setGuidelineVisibility(e)},setCommentAsPreview:function(e,t,i){n&&n.setCommentAsPreview(e,t,i)},selectNextOrPreviousComment:function(e){n&&n.selectNextOrPreviousComment(e)},getDMUObjectFromPathElement:function(e){if(n)return n.getDMUObjectFromPathElement(e)},hasReplies:function(e){return!!n&&n.hasReplies(e)},updateHeaderCommandsAvailability:function(){if(n)return n.updateHeaderCommandsAvailability()},setCommentLoading:function(e,t){if(n)return n.setCommentLoading(e,t)},cleanCommentsPanel:function(){if(n)return n.cleanCommentsPanel()},clear:function(){if(n)return n.clear()}}),U.push({context:e.context,controller:t,count:1}),t}static giveDMUCommentsController(e){if(e&&e.context)for(let t=0;t<U.length;t++)if(U[t].context===e.context)return U[t].controller}static unreferenceDMUCommentsController(e){if(e&&e.context)for(let t=0;t<U.length;t++)if(U[t].context===e.context){U[t].count--,0===U[t].count&&(U[t].controller.clear(),U.splice(t,1));break}}}}),define("DS/DMUBaseUIControllers/DMUMarkupsController",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/CoreEvents/Events","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseUIControllers/DMUWebPreferencesController"],function(e,t,n,i,r,o,a,l,s){"use strict";var d=t.extend({init:function(t){this._parent(t);var d,u,g=null,c=[],p=t.context.getExecutionContext?t.context.getViewer():t.context,m=null,f=null,h=null,v=null,C=null,D=!1,b="true"===localStorage.getItem("DMU3DMarkersResponsiveDisplay");function M(t){if(!g||D)return;if(!d){var n=p.getSceneGraphOverrideSetManager();n&&p.getRootNode().getChildByName("DMUReviewBag")&&(d=new i(p.getRootNode().getChildByName("DMUReviewBag")),n.pushSceneGraphOverrideSet(d))}let r=o.getReviewContext({viewer:p}),s=r?r.getCurrentSessionMarkup():null,u=s?s.getCurrentSlide():null;if(!u||!d)return;d&&d.deleteOverrides(d.getOverrides());let c=u.get3DMarkers(),m=u.get2DMarkers();if(u.getPointedFormats&&u.getPointedFormats().forEach(e=>{c=c.concat(e.get3DMarkers()),m=m.concat(e.get2DMarkers())}),c.length){let n=function(){let t=a.getViewpointInfo(p.currentViewpoint);var n=1;if(1===p.getVisibleSpace()&&C&&C.vViewpointPosition&&C.vViewpointSight&&C.fViewpointTargetDistance){let i=(new e.Vector3).addVectors(C.vViewpointPosition,C.vViewpointSight.clone().multiplyScalar(C.fViewpointTargetDistance)),r=t.position.distanceTo(i),o=C.fViewpointTargetDistance;n=o&&r>o?1-3*Math.abs(r-o)/r:1,(n=Math.max(n,0))>.5?n=1:n*=2,n=Math.round(10*n)/10}return n}(),i={};c.forEach(e=>{let r=!b||e.isInEdition()?1:n;if(e.getNode()._updateVisibility(r,t),r){i[r]||(i[r]={opacity:r,paths:[]});let t=e.getNode().getRepNode(),n=[],o=Object.keys(t);if(-1!==o.indexOf("box"))for(let i=0;i<o.length;i++)"box"===o[i]&&e.getNode().hasTessellatedRepresentation&&!e.getNode().hasTessellatedRepresentation()||n.push(t[o[i]]);else n.push(e.getNode());n.forEach(e=>{i[r].paths.push(l.buildPathElement(e))})}});let r=Object.keys(i);if(r.length){let e;for(let t=0;t<r.length;t++)1!==i[r[t]].opacity&&i[r[t]]&&i[r[t]].paths&&i[r[t]].paths.length&&(e=d.createOverride({pathes:i[r[t]].paths}))&&e.setOpacity(i[r[t]].opacity)}}m&&m.length&&m.forEach(function(e){e.getNode().updateScreenPosition()}),p.render()}var y=function(e){if(c&&(!c||c.length)){var t,n=e.eventType||e.event,i=!1,r=!1,a=e;if("@onWindowResized"===n||"@onViewpointEndMove"===n||"@onViewpointBeginMove"===n||"@onPinchPanRotate"===n||"beginExplodeCmd"===n||"endExplodeCmd"===n||"onSwapVisibleSpace"===n||"onPreferenceModified"===n||"onDMUSlideStartDisplay"===n||"onDMUSlideDisplayed"===n)i=!0;else if("@onViewpointChange"===n&&e.viewpoint.isMoving()||"EXPEndProgressiveLoad"===n||"onRepresentationLoaded"===n)r=!0;else if("EXPHideShowEvent"===n&&(e&&e.occurrence||e.paths))if(i=!0,a={eventType:"onHideShow",flag:e.flag,paths:[]},e.occurrence){var l=o.getReviewContext({viewer:p});if(l){var s=l.getCurrentSessionMarkup(),d=s?s.getAttribute("oLinksManager"):null;if(d){var u=d.getOccurrencePathElement(e.occurrence.id);u&&a.paths.push(u.clone())}}}else if(e.areIdPaths)a.idPaths=a.paths.slice();else for(t=0;t<e.paths.length;t++)a.paths.push(e.paths[t].clone());if(("@onViewpointChange"===n&&e.viewpoint.isMoving()||"@onViewpointEndMove"===n||"onDMUSlideEnvironmentOverloadChanged"===n||"onSwapVisibleSpace"===n||"@onWindowResized"===n)&&M("@onViewpointChange"===n),i||r)for(t=0;t<c.length;t++)c[t]&&c[t].onViewerEventCB&&(i||r&&c[t].isDisplayed())&&c[t].onViewerEventCB(a)}};this.setResponsiveDisplayFlag=function(e){b=e,M()},this.getResponsiveDisplayFlag=function(){return b},this.setActiveState=function(e){if(e!==g){g=e;var t=o.giveEventsController({viewer:p}),i=o.getContextViewer({viewer:p});if(g){var a;if(v||(v=s.subscribe("onDMUWebpreferencesUpdate",function(){y({eventType:"onPreferenceModified"})})),t)(h={}).OnHideShow=t.addEvent(r.Events.EXPHideShowEvent,function(e){e.eventType="EXPHideShowEvent",y(e)}),h.EndProgressiveLoad=t.addEvent(r.Events.EXPEndProgressiveLoad,function(e){e.eventType="EXPEndProgressiveLoad",y(e)}),h.onDMUSlideEnvironmentOverloadChanged=t.addEvent("onDMUSlideEnvironmentOverloadChanged",function(){let e=o.getReviewContext({viewer:p});e&&e.getEnvironment()&&(C=e.getEnvironment().getCurrentSlideEnvironmentInfo(),M())}),h.onDMUSlideStartDisplay=t.addEvent("onDMUSlideStartDisplay",function(e){if(D=!0,e&&e.dmuObject){let t=e.dmuObject.get2DMarkers(),n=1;if(e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().forEach(e=>{t=t.concat(e.get2DMarkers())}),t&&t.length){let e;for(let i=0;i<t.length;i++)(e=t[i].getMaximumProportionalWidth?t[i].getMaximumProportionalWidth():-1)>n&&(n=e)}n>1&&t.forEach(function(e){e.setMaximalProportionalZoneWidth(n)})}y({eventType:"onDMUSlideStartDisplay"})}),h.onDMUSlideDisplayed=t.addEvent("onDMUSlideDisplayed",function(e){if(D=!1,C=null,y({eventType:"onDMUSlideDisplayed"}),e&&e.dmuObject){let e=o.getReviewContext({viewer:p});C=e.getEnvironment().getCurrentSlideEnvironmentInfo()}M()}),h.onDMUObjectEdited=t.addEvent("onDMUObjectEdited",function(){a&&clearInterval(a),a=setTimeout(()=>{M(),a=null})});u=i.subscribe({event:"onRepresentationLoaded"},function(){y({eventType:"onRepresentationLoaded"})}),m||((m={}).onVISUEvents=n.subscribe({event:"/VISU/"},y),m.onResize=n.subscribe({event:"/VISU/onWindowResized"},function(){y({eventType:"@onWindowResized"})}),m.onExplodeStart=n.subscribe({event:"3DPLAY/EXPLODE/START"},function(){y({eventType:"beginExplodeCmd"})}),m.onExplodeEnd=n.subscribe({event:"3DPLAY/EXPLODE/END"},function(){y({eventType:"endExplodeCmd"})})),f||(f=p.onSwapVisibleSpace(function(){y({eventType:"onSwapVisibleSpace"})}));let e=o.getReviewContext({viewer:p});e&&(C=e.getEnvironment().getCurrentSlideEnvironmentInfo())}else{let e,r;if(C=null,d&&(p.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(d),d=null),c.length=0,t&&h){for(e=Object.keys(h),r=0;r<e.length;r++)t.removeEvent(h[e[r]]);h=null}if(i.unsubscribe(u),v&&(s.unsubscribe(v),v=null),m){for(e=Object.keys(m),r=0;r<e.length;r++)n.unsubscribe(m[e[r]]);m=null}f&&(p.unsubscribe(f),f=null)}}},this.clear=function(){this.setActiveState(!1),c=p=null},this.registerMarker=function(e){c.push(e)},this.unregisterMarker=function(e){for(var t=c.length-1;t>=0;t--)if(c[t]===e){c.splice(t,1);break}}}}),u=[];return t.singleton({init:function(){},getDMUMarkupsController:function(e){if(e&&e.context){for(var t=!1,n=0;n<u.length;n++)if(u[n].context===e.context){u[n].counter++,t=!0;break}if(!t){var i=new d(e);i.setActiveState(!0),u.push({counter:1,context:e.context,markersController:i})}return this.giveDMUMarkupsController(e)}},giveDMUMarkupsController:function(e){if(e&&e.context){for(var t,n=0;n<u.length;n++)if(u[n].context===e.context){t=u[n].markersController;break}if(t)return Object.freeze({setResponsiveDisplayFlag:function(e){t&&t.setResponsiveDisplayFlag(e)},getResponsiveDisplayFlag:function(){return t?t.getResponsiveDisplayFlag():void 0},registerMarker:function(e){if(t)return t.registerMarker(e)},unregisterMarker:function(e){t&&t.unregisterMarker(e)}})}},unreferenceDMUMarkupsController:function(e){if(e&&e.context)for(var t=0;t<u.length;t++)if(u[t].context===e.context)return u[t].counter--,void(u[t].counter<=0&&(u[t].markersController&&u[t].markersController.clear(),u.splice(t,1)))}})}),define("DS/DMUBaseUIControllers/DMUSceneDisplayController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUCompareVisu/DMUBaseCompareServices","DS/DMUControls/DMUBaseSlider","DS/DMUControls/EXPNotify","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/DMUBaseUIControllers/DMUApplicativeContextManager","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g){"use strict";var c=e.extend({init:function(e){this._parent(e);let c=null,p=e.context,m=r.createSceneGraphOverrideSet(p.getViewer()),f=r.createSceneGraphOverrideSet(p.getViewer()),h=new o(p.getFrameWindow(),{ctxViewer:p});h.setLegendVisibleFlag(!1);let v,C,D,b,M,y,S,w,E,U,x,O,P,R,A,I,k,V,T=null,j=null,F=this,N=0,L=0,B=50,H="unset",W=!0,q=[],_=!1,z=null,X=null,G=null,K=!1,J=!1,Z=!1,Q=null,Y=d.givePreferenceManager({context:p.getFrameWindow()});function $(e,t){var i,o,a=[];if(e&&e.length)for(i=0;i<e.length;i++)if(e[i]&&e[i].getLastElement){var l=e[i].clone();if(r.isAModelPath(l)){for(;l&&!r.isPLMNode(l.getLastElement(!0));)l=l.getParentPath();l&&l.externalPath.length>1&&(o=r.getIdPath(l),a.push(o))}}else o=e[i].ids?e[i].ids.slice():e[i],a.push(o);if(c&&p&&a.length){var s=n.getReviewContext({viewer:p.getViewer()});if(s&&s.getActiveFlag()){var d=!1,u=s.getCurrentSessionMarkup();if(s&&u&&u.getActiveFlag()&&u.isVisible()&&!s.isReadOnly()&&!u.isReadOnly()){for(i=0;i<a.length;i++)if(a[i][0]===C){var g=u.getOrCreateOccurrenceOverloader({idPath:a[i]},!0);if(!g)continue;var f=r.getOverrides(m,{idPaths:[g.getOccurrenceIDPath()]});f&&1===f.length&&f[0].setVisibility(void 0===t?null:t),t!==g.getAttribute("bVisible")&&(d=!0,g.setAttribute("bVisible",t))}d&&u.fireEvent("onSaveRequested",{}),u.fireEvent("onOccurenceVisibleFlagChanged"),p.getViewer().render()}}}}function ee(e,t){D&&(D.destroy(),D=null),D=new l({body:p.getFrameWindow().getUIFrame(),type:e,message:t})}function te(e,n){if(m&&e&&e.length){var i=[],o=[];r.ensurePriorityOfSceneGraphOverrideSet(p.getViewer(),m),e.forEach(function(e){var a=e.target;if(a){var l=a.getOccurrenceIDPath();if(l){var s=r.getOverrides(m,{idPaths:[l]},!0);if(e.state&&a.getActiveFlag()&&a.isVisible()){if(s.length||(s=r.getOverrides(m,{idPaths:[l]})),s&&1===s.length){s=s[0];var d=e.state.bVisible;if(n||void 0!==d){s.setVisibility(void 0===d?null:d);var u=l.slice();!1===d?i.push(u):o.push(u)}if(d=e.state.fOpacity,(n||void 0!==d)&&s.setOpacity(void 0===d?null:d,!0),d=e.state.cColor,(n||void 0!==d)&&s.setColor(d&&d.getHexString?"#"+d.getHexString():null,!0),void 0!==(d=e.state.mTransfoMatrix))s.setPosition(d);else if(void 0!==(d=e.state.mPosition)){if(d){var g=e.target.getOccurrencePathElement(),c=g&&g.getParentPath()?g.getParentPath().getWorldMatrix():null;if(c){var p=(new t.Matrix4).getInverse(c);d=(new t.Matrix4).multiplyMatrices(p,d)}}s.setPosition(d)}}}else s&&1===s.length&&!1===s[0].getVisibility()&&o.push(l),r.removeOverride(m,{idPath:l})}}}),o.length&&(N++,p.getHideShowController().show({idPaths:o,dispatch:!0})),i.length&&(L++,p.getHideShowController().hide({idPaths:i,dispatch:!0})),p.getViewer().render()}}function ne(){if(C){var e=p.getHideShowController().getSGOverrideSet();if(e){var t,i=[],r=[],o=[],a=e.getOverrides();for(t=0;t<a.length;t++){let e=a[t].getIdPathes();if(e&&e.length)for(var l=0;l<e.length;l++)e[l].getElement(1)===C&&o.push(e[l])}if(p.getHideShowController().clearOverrides(C),n.getReviewContext({viewer:p.getViewer()}).isReadOnly()){require(["DS/3DPlay/3DPlay"],function(e){if(p){const t=e.getExperience(p.getCommandContext());t&&t.executeScriptingFunction("showAll")}},()=>null)}for(t=0;t<o.length;t++){var s=o[t].buildPathElement(p.getViewer().getIdPathMatcher());s&&(p.getHideShowController().isVisible(s)?r.push(o[t].ids.slice(1,o[t].ids.length)):i.push(o[t].ids.slice(1,o[t].ids.length)))}i.length&&(L++,p.getHideShowController().publish({event:"onHide",data:{paths:i,dispatch:!0}}),p.getHideShowController()._commandProxy&&p.getHideShowController()._commandProxy.hide({paths:i})),r.length&&(N++,p.getHideShowController().publish({event:"onShow",data:{paths:r,dispatch:!0}}),p.getHideShowController()._commandProxy&&p.getHideShowController()._commandProxy.show({paths:r}))}}}function ie(e){let t=[],n=[];if(e&&e.getObjectOverloads){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let r=i[e].target.getOccurrenceIDPath();n.push(JSON.stringify(r)),t.push(i[e])}}e.getPointedFormats&&e.getPointedFormats().length&&e.getPointedFormats().forEach(function(e){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let r=i[e].target.getOccurrenceIDPath();n.includes(JSON.stringify(r))||t.push(i[e])}}})}return t}function re(){if(q.length&&(p.getController().unlockNodes({ids:q}),q.length=0),R=!1,y&&y.fireEvent("onComparisonEnded",{dmuObject:y}),h&&h.clean(),b&&b.clean(),f&&f.deleteOverrides(f.getOverrides()),_&&O&&O.setNavBarVisibleFlag(!0),!_&&p&&p.getHideShowController()&&U&&p.getHideShowController().hide({paths:[U],dispatch:!0}),p&&y&&!K&&!J&&_&&w&&w.length){P=null;let e=p.getRoots();for(let t=0;t<e.length;t++)r.getNodeID(e[t])===w[0]&&(e[t].isBeingRemoved=!0);let t=[w[0]];p.getStatusBar()&&p.getStatusBar().clearFilter({ids:t}),p.getController().removeRoots({pids:t},!0,!1)}S=null,w=null,_=!1,y=null,E=null,U=null,b=null}function oe(e){var t=[];return void 0===e&&(t=[1,1]),e>=50?(t.push(1),t.push(1-.02*(e-50))):(t.push(1-.02*(50-e)),t.push(1)),t}function ae(){if(p){let e=n.getReviewContext({viewer:p.getViewer()});if(e&&e.getTransientReviewBag()&&e.getTransientReviewBag().getDMUObjects(_?"DMUCompare2D":"DMUCompare3D").length){K=!1;let t=_;re(),e.getTransientReviewBag().removeDMUObjects(t?"DMUCompare2D":"DMUCompare3D")}}}function le(e){if(f&&f.deleteOverrides(f.getOverrides()),y&&E&&(void 0===(W=e)&&(W=!0),W)){let e=y.getAttribute("oSelections");if(e&&2===e.length&&e[1].id){let i=y.getParent().getAttribute("oLinksManager");var n=i.getChildWithID(e[1].id);if(n){let e=n.path?i.getOccurrenceIdPath(n.path):n.identifier?[n.identifier]:null;if(e&&1===e.length){let n=E&&E.getParentPath()?E.getParentPath().getWorldMatrix():null;if(n){let i=p.getController().createReferenceIterator(e[0]),o=[];i&&i.isRepRef()?o.push({idPath:e,matrix:new t.Matrix4}):i.getChildren().forEach(function(n){n.getInstanceId&&n.getInstanceId()&&o.push({idPath:[].concat(e).concat(n.getInstanceId()),matrix:n.getMatrix&&n.getMatrix()?n.getMatrix():new t.Matrix4})}),o&&o.length&&o.forEach(e=>{let i=r.getOverrides(f,{idPaths:[e.idPath]});i&&i.length&&i.forEach(i=>{i.setPosition((new t.Matrix4).multiplyMatrices(n,e.matrix))})})}}}}}p.getViewer().render()}function se(){let e=[];if(!_&&S&&S[0]&&w&&w[0]){let t=F.getDisplayedAndHiddenOccurrences(S[0]);t&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths)),(t=F.getDisplayedAndHiddenOccurrences(w[0]))&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths))}return e}function de(e,t){if(b&&"number"==typeof e){B=e;let n,i=oe(e),o=A,a=I;n=_?V:k,h.updateCompareModel({Old:{color:a,pathElements:[U],opacity:i[0]},New:{color:o,pathElements:[E],opacity:i[1]},Common:{color:n},compareMode:_?"2D":"3D",noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:se()}),t&&b.update({leftButton:{color:o},rightButton:{color:a},value:B});let l=r.getOverrides(f,{idPaths:[S,w]});l&&l.length&&l.forEach(e=>{e.setPickability("PICKABLE")}),0!==e&&100!==e||(l=r.getOverrides(f,{idPaths:[100===e?S:w]}))&&l.length&&l.forEach(e=>{e.setPickability("IGNORED")})}}async function ue(){try{let e=(await s.readPreferences([{Repository:"DMURepository",PreferenceNames:["CompareFirstColor","CompareSecondColor","Compare3DCommonColor","Compare2DCommonColor"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CompareFirstColor"===e[t].name?A=e[t].value:"CompareSecondColor"===e[t].name?I=e[t].value:"Compare3DCommonColor"===e[t].name?k=e[t].value:"Compare2DCommonColor"===e[t].name&&(V=e[t].value)}catch(e){A="#FF0000",I="#00FF00",k="#D3D3D3",V="#000000",window.console.warn("Could not get server value, default value set instead.",e)}if(x=null,!(y&&y.getParent()&&p&&c&&S&&S.length&&w&&w.length))return re();let e=y.getAttribute("oSelections");if(e&&2===e.length){let n=y.getParent().getAttribute("oLinksManager");if(n){if(!(E=n.getOccurrencePathElement(e[0].id)))return D=ee("info",g.comparisonFailed),void re();if(!(U=n.getOccurrencePathElement(e[1].id)))return D=ee("info",g.comparisonFailed),void re();if(_){let e=y.getAttribute("oSheetIDs");if(e&&e.length&&(G=e[1].id,O)){let e=O.getDocumentData(w[0]);e&&(z=e.sheetNames,X=e.sheetIDList.indexOf(G),O.setCurrentSheet({parentID:w[0],sheet:G}))}}let i=E.getLastElement(!0),o=U.getLastElement(!0),l=[];r.isRepReference(i)&&l.push(i),r.isRepReference(o)&&l.push(o);try{await(t=l,t&&t.length?new Promise((e,n)=>{var i=[],o=[],a=p.getController();t.forEach(function(e){if("cgr"!==a.getLoadedStream(e)){o.push({node:e,stream:"cgr"});let t=r.getNodeID(e);q.includes(t)||i.push(t)}}),i.length?(q=q.concat(i),a.lockNodes({ids:i}),a.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!0}}),callback:()=>{o.length?a.switchNodeVisuStreamOnDemand({data:o,callbacks:{onComplete:e,onFailure:n}}):e()}})):e()}):Promise.resolve())}catch(e){window.console.error("Error Locking Nodes",e)}finally{let e=[],t=p.getHideShowController();t&&(t.isVisible(E)||e.push(E),t.isVisible(U)||e.push(U),e.length&&t.show({paths:e,dispatch:!0})),_||le(y.getAttribute("bLocalAxis")),void 0===(B=y.getAttribute("fBalance"))&&(B=50);let n,i=oe(B),r=A,o=I;n=_?V:k,h.compare({Old:{color:o,pathElements:[U],opacity:i[0]},New:{color:r,pathElements:[E],opacity:i[1]},Common:{color:n},noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:se(),compareMode:_?"2D":"3D"}),R=!0,y.fireEvent("onComparisonDisplayed",{is2DCompare:_});let l,s,d=[S[S.length-1],w[w.length-1]];"DMUTemporaryBag"===y.getParent().getType()&&(l={icon:g.compareLastButtonTitle,iconClassName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-close",title:g.compareLastButtonTitle,callBack:ae},E.externalPath.length>2&&(s=[{type:"checkbox",label:g.localAxisTitle,checkFlag:y.getAttribute("bLocalAxis"),callBack:le}]),_&&z&&z.length>1&&-1!==X&&(s=[{type:"combo",elementList:z,enableSearchFlag:!0,value:z[X],callBack:e=>{if(-1!==(X=z.indexOf(e))){let e=O.getDocumentData(w[0]);if(e&&e.sheetIDList&&e.sheetIDList.length){let t=e.sheetIDList[X];if(O){O.setCurrentSheet({parentID:w[0],sheet:t});let e=y.getAttribute("oSheetIDs");e&&e.length>1&&(e[1].id=t,y.setAttribute("oSheetIDs",e))}}}}}])),b&&b.clean(),(b=new a(p.getFrameWindow())).build({viewerCanvas:p.getViewer().canvas,value:B,minValue:0,maxValue:100,stepValue:5,onChangeCB:de,leftButton:{color:r},rightButton:{color:o},lastButton:l,subMenuItems:s}),p.getController().getAttributes({ids:d,attributes:["ds6w:label","ds6wg:revision"],callbacks:{onComplete:function(e){let t=e[d[0]]?e[d[0]]["ds6w:label"]:"",n=e[d[0]]?e[d[0]]["ds6wg:revision"]:"";n&&(t=t+" "+n);let i=e[d[0]]?e[d[1]]["ds6w:label"]:"",r=e[d[0]]?e[d[1]]["ds6wg:revision"]:"";r&&(i=i+" "+r),b&&b.update({leftButton:{title:t||""},rightButton:{title:i||""}})},onFailure:function(){}}})}}}var t}function ge(){let e=p.getRoots(),t=[];for(let n=0;n<e.length;n++)t.push(r.getNodeID(e[n]));w&&w.length&&-1!==t.indexOf(w[0])&&(x&&clearTimeout(x),x=setTimeout(ue))}function ce(e){let t,n=!0;if(e.slide){var i=e.slide.getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e]);if(!t&&e.slide.getPointedFormats&&e.slide.getPointedFormats().length){i=e.slide.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e])}}else t=e.compare;if(t){if(t===y)return!1;let e,i,o,a=t.getParent()?t.getParent().getAttribute("oLinksManager"):null;if(a&&(e=t.getAttribute("oSelections")),e&&2===e.length&&(i=a.getChildWithID(e[1].id)),i&&(o=i.idPath&&i.idPath.length?i.idPath:a.getOccurrenceIdPath(i.path)),o=o&&o.length?o[0]:null){let e=p.getRoots();for(let t=0;t<e.length;t++)r.getNodeID(e[t])===o&&(n=!1)}}return n}function pe(){"DIFSheet"===P||"DIFLayout"===P?v&&v.fireEvent("on2DDocumentLoadRequired",{documentType:P,rootID:w[0],isATemporaryRoot:!0}):(T.onLoadingFailure=p.subscribe({event:"onLoadingFailure"},function(){re(),T.onLoadingFailure&&p.unsubscribe(T.onLoadingFailure),T.onLoadingFailure=null}),p.addRoots({objects:[{path:[w[0]]}]}))}function me(e){if(D&&D.destroy(),_&&e===y)return;let t=function(e){let t={};if(!e)return t;var n=e.getAttribute("oSelections");if(!n||2!==n.length)return t;let i=e.getParent()?e.getParent().getAttribute("oLinksManager"):null;if(i){let e=i.getChildWithID(n[0].id);e&&(t.firstCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path)),(e=i.getChildWithID(n[1].id))&&(t.secondCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path))}return t}(e);if(e&&"DMUCompare2D"===e.getType()&&!K&&(K=t&&w&&t.secondCompareRootID&&t.secondCompareRootID[0]&&t.secondCompareRootID[0]===w[0]),re(),!p||!e||!e.getParent()||!e.getType||"DMUCompare3D"!==e.getType()&&"DMUCompare2D"!==e.getType())return;if(_="DMUCompare2D"===(y=e).getType(),y.fireEvent("onComparisonStarted",{is2DCompare:_}),_&&(O||(O=i.getManager({name:"DMU2DSheetManager",context:p.getFrameWindow()})),O.setNavBarVisibleFlag(!1)),!(t&&t.firstCompareRootID&&t.firstCompareRootID.length&&t.secondCompareRootID&&t.secondCompareRootID.length))return D=ee("info",g.comparisonFailed),void re();S=t.firstCompareRootID.slice(),w=t.secondCompareRootID.slice();let n=p.getRoots().map(e=>e.isBeingRemoved?"":r.getNodeID(e));n&&-1===n.indexOf(w[0])?(M=p.getAutomaticReframePolicy(),H=window.ENOPADNoReframe,window.ENOPADNoReframe=!0,p.setAutomaticReframePolicy(!1),_&&!P?p.getController().getAttributes({ids:[w[0]],attributes:["ds6w:type"],callbacks:{onComplete:function(e){w&&w.length&&e[w[0]]&&(P=e[w[0]]["ds6w:type"],pe())},onFailure:re}}):pe()):ge()}this.getCurrentComparedObjectIDPaths=function(){return y?{feature:y,firstObject:S?S.slice():null,secondObject:w?w.slice():null}:null},this.getCurrentCompareBalance=function(){return B},this.getCurrentLocalAxisValue=function(){return W},this.setActiveState=function(e){if(e!==c){var t,i;if(c=e){v=n.giveEventsController({viewer:p.getViewer()}),(j={}).onDMUOverloadPropertiesChanged=v.addEvent("onDMUOverloadPropertiesChanged",function(e){e&&e.overloads&&e.overloads.length&&te(e.overloads)}),j.onDMUObjectDeleted=v.addEvent("onDMUObjectDeleted",function(e){m&&e&&e.dmuObject&&e.dmuObject.getOccurrenceIDPath&&e.dmuObject.getOccurrenceIDPath()?te([{target:e.dmuObject}]):e&&e.dmuObject&&e.dmuObject===y&&re()}),j.onDMUOccOverloadRemoved=v.addEvent("onDMUOccOverloadRemoved",function(e){m&&e&&e.length&&te(e)});var r=function(e){if(e&&e.getOccurrenceOverloaders&&p){var t;if(e.getOccurrenceOverloaders().length&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath().length)t=e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()[0];else{var i=n.getReviewContext({viewer:p.getViewer()});if(i){var r=i.getReviewCtxInformation();r&&r.contextId&&(t=r.contextId);let e=u.giveDMUApplicativeContextManager({context:p});if(e){(e.getApplicativeControllers()||[]).forEach(e=>{e.getContextRootID&&(t=e.getContextRootID())})}}}C&&t!==C&&ne(),p.getController().isFilterOpen(e=>{e&&e.filterAvailable?p.getController().getPrdIdFromFilterId([t]).then(e=>{C&&e!==C&&ne(),C=e},()=>{C&&t!==C&&ne(),C=t}):(C&&t!==C&&ne(),C=t)})}};j.onDMUMarkupLoaded=v.addEvent("onDMUMarkupLoaded",function(e){r(e.dmuObject)}),j.onDMUMarkupCreationSucceeded=v.addEvent("onDMUMarkupCreationSucceeded",function(e){r(e.dmuObject)}),j.onReviewCtxInformationChanged=v.addEvent("onReviewCtxInformationChanged",function(e){if(!e)return;let t=u.giveDMUApplicativeContextManager({context:p}),n=e.contextId;if(t){(t.getApplicativeControllers()||[]).forEach(e=>{e.getContextRootID&&(n=e.getContextRootID())})}n&&n!==C&&(ne(),p.getController().isFilterOpen(e=>{e&&e.filterAvailable?p.getController().getPrdIdFromFilterId([n]).then(e=>{C=e},()=>{C&&n!==C&&ne(),C=n}):C=n}))});var o=function(e){e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.dmuObject.getActiveFlag()&&e.dmuObject.isVisible()?e.dmuObject.getCurrentSlide()&&(m&&m.deleteOverrides(m.getOverrides()),ne(),te(ie(e.dmuObject.getCurrentSlide()),!0)):(m&&m.deleteOverrides(m.getOverrides()),ne()))};j.onDMUObjectVisibleFlagChanged=v.addEvent("onDMUObjectVisibleFlagChanged",o),j.onDMUObjectActiveFlagChanged=v.addEvent("onDMUObjectActiveFlagChanged",o),j.onDMUSlideOrFormatRefreshRequired=v.addEvent("onDMUSlideOrFormatOverloadsRefreshRequired",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(m.deleteOverrides(m.getOverrides()),te(ie(e.dmuObject),!0))}),j.onDMUSlideFormatListModified=v.addEvent("onDMUSlideFormatListModified",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(m.deleteOverrides(m.getOverrides()),ne(),te(ie(e.dmuObject),!0))}),j.onDMUSlideStartDisplay=v.addEvent("onDMUSlideStartDisplay",function(e){Z=!0,"Requirement"!==P&&"Requirement Specification"!==P&&(K=!ce({slide:e.dmuObject}),re()),m&&c&&(m.deleteOverrides(m.getOverrides()),ne())}),j.onDMUSlideCompareDisplayRequired=v.addEvent("onDMUSlideCompareDisplayRequired",function(e){if(e.dmuObject){let n;var t=e.dmuObject.getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&"DMUCompareRequirement"!==t[e].getType()&&(n=t[e]);if(!n&&e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().length){t=e.dmuObject.getPointedFormats()[0].getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&"DMUCompareRequirement"!==t[e].getType()&&(n=t[e])}n&&me(n)}}),j.onDMUSlideDisplayed=v.addEvent("onDMUSlideDisplayed",function(){Z=!1}),j.onDMUObjectInitialized=v.addEvent("onDMUObjectInitialized",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"===e.dmuObject.getParent().getType()&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()&&-1!==e.dmuObject.getType().indexOf("Compare")&&(K=!ce({compare:e.dmuObject}),me(e.dmuObject))}),Y&&(Q=Y.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences),n=!1;for(let e=0;e<t.repositories.length;e++)if("DMURepository"===t.repositories[e])for(let i=0;i<t.repositories[e].preferences.length;i++){const r=t.repositories[e].preferences;"CompareFirstColor"===r[i].name?(A=r[i].value,n=!0):"CompareSecondColor"===r[i].name?(I=r[i].value,n=!0):"Compare3DCommonColor"===r[i].name?(k=r[i].value,n=!0):"Compare2DCommonColor"===r[i].name&&(V=r[i].value,n=!0)}n&&de(B,!0)})),j.onDMUAdd2DCompareRoot=v.addEvent("onDMUAdd2DCompareRoot",function(e){e&&e.documentType&&e.compare2DSecondRoot&&p&&("Drawing"===(P=e.documentType)?p.addRoots({objects:[{path:[e.compare2DSecondRoot]}]}):v&&v.fireEvent("on2DDocumentLoadRequired",{documentType:e.documentType,rootID:e.compare2DSecondRoot,isATemporaryRoot:!0}))}),j.on2DDocumentLoadSuccess=v.addEvent("on2DDocumentLoadSuccess",function(){_&&w&&w[0]&&ge()}),j.onDMUCompareRefreshRequired=v.addEvent("onDMUCompareRefreshRequired",function(e){Z||e&&e.dmuObject&&(e.dmuObject.getParent()&&(e.dmuObject.getParent().getType&&"DMUTemporaryBag"===e.dmuObject.getParent().getType()||!e.dmuObject.getParent().isImporting())&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()?_||"DMUCompareRequirement"===e.dmuObject.getType()||me(e.dmuObject):y&&y===e.dmuObject&&"DMUCompareRequirement"!==e.dmuObject.getType()&&(K=!1,re()))}),j.onTransientCompareRemoved=v.addEvent("onTransientCompareRemoved",ae),j.onBeginDMUObjectDuplication=v.addEvent("onBeginDMUObjectDuplication",function(){let e=n.getReviewContext({viewer:p.getViewer()});if(e){let t=e.getTransientReviewBag().getDMUObjects("DMUCompare2D");J=!!t.length}else J=!1}),j.onDMUObjectDuplicated=v.addEvent("onDMUObjectDuplicated",function(){J=!1}),(T={}).onHide=p.subscribe({event:"onHide"},function(e){c&&e&&Array.isArray(e.paths)&&!L&&$(e.paths,!1),L>0&&L--}),T.onShow=p.subscribe({event:"onShow"},function(e){c&&e&&Array.isArray(e.paths)&&!N&&$(e.paths,!0),N>0&&N--}),T.onExclusiveShow=p.subscribe({event:"onExclusiveShow"},function(){var e=F.getDisplayedAndHiddenOccurrences();e&&($(e.shown.paths,!0),$(e.shown.idPaths,!0),$(e.hidden.paths,!1),$(e.hidden.idPaths,!1))}),T.onRefreshBegin=p.subscribe({event:"onRefreshBegin"},function(){_&&"Drawing"===P&&sessionStorage.setItem("DMU2DCompareTempRoot",w[0])}),T.onRootAdded=p.subscribe({event:"onRootAdded"},function(e){"unset"!==H&&(window.ENOPADNoReframe=H),H="unset",void 0!==M&&M!==p.getAutomaticReframePolicy()&&p.setAutomaticReframePolicy(M),M=void 0,!_&&e&&w&&e.id===w[0]&&(T.onLoadingComplete=p.subscribe({event:"onLoadingComplete"},function(){if(T.onLoadingFailure&&(p.unsubscribe(T.onLoadingFailure),T.onLoadingFailure=null),!w||!w.length)return p.unsubscribe(T.onLoadingComplete),T.onLoadingComplete=null,void re();let e=p.getController().createReferenceIterator(w[0]);e&&(e.isRepRef()||e.getChildren().length)&&(p.unsubscribe(T.onLoadingComplete),T.onLoadingComplete=null,ge())}));let t,i,r,o=[],a=p.getRoots(),l=[];(t=n.getReviewContext({viewer:p.getViewer()}))&&(o=t.getValidation()?t.getValidation().getMarkups().map(e=>e&&e.getRepRef()?e.getRepRef().getMarkupContent():void 0):[t.getCurrentSessionMarkup()]),o.length&&o.forEach(e=>{e&&(r=e.getAttribute("oLinksManager"),(i=e.getSlides()).forEach(e=>{e.getDMUObjects("DMUCompare3D").forEach(e=>{let t,n,i=e.getAttribute("oSelections");i&&i.length&&(t=r.getChildWithID(i[1].id))&&t.path&&t.path[0]&&(n=r.getChildWithID(t.path[0]))&&l.push(n.identifier)})}),a.forEach(e=>{l.length&&l.includes(e.modelIdentification)&&e.isVisible()&&e.setVisibility(!1)}))})}),T.onRootRemoved=p.subscribe({event:"onRootRemoved"},function(e){var t=n.getReviewContext({viewer:p.getViewer()});w&&w[0]===e.id&&y&&"DMUTemporaryBag"===y.getParent().getType()&&t.getTransientReviewBag()&&(t.getTransientReviewBag().removeDMUObjects(_?"DMUCompare2D":"DMUCompare3D"),re(),p.getHideShowController().clearOverrides(e.id))})}else{if(void 0!==M&&M!==p.getAutomaticReframePolicy()&&p.setAutomaticReframePolicy(M),"unset"!==H&&(window.ENOPADNoReframe=H),H="unset",M=void 0,T){for(t=Object.keys(T),i=0;i<t.length;i++)p.unsubscribe(T[t[i]]);T=null}if(v&&j){for(t=Object.keys(j),i=0;i<t.length;i++)v.removeEvent(j[t[i]]);j=null}Q&&(Y.unsubscribe(Q),Q=null),m.deleteOverrides(m.getOverrides()),ne(),re(),v=null,D&&(D.destroy(),D=null)}N=0,L=0}},this.getDisplayedAndHiddenOccurrences=function(e){let t=e||C;var n,i={shown:{idPaths:[],paths:[]},hidden:{idPaths:[],paths:[]}};if(p&&c){var o=p.getHideShowController().getSGOverrideSet();if(o)for(var a=o.getOverrides(),l=0;l<a.length;l++)if(null!==a[l].getVisibility())if(n=a[l].getVisibility()?i.shown:i.hidden,a[l].isIdPathOverride()){let e=a[l].getIdPathes()||[];e=e.map(e=>e.ids.slice(1,e.ids.length)),n.idPaths=n.idPaths.concat(e.filter(e=>e[0]===t))}else n.paths=n.paths.concat(a[l].getPathes().filter(e=>r.getNodeID(e.externalPath[1])===t))}return i},this.isAComparisonDisplayed=(()=>R),this.toggleVisibility=function(e){if(e&&e.length&&c&&p&&p.getHideShowController()){var t=p.getHideShowController(),n=[],i=[];if(e.forEach(function(e){t.isVisible(e)?n.push(e):i.push(e)}),n.length)return void t.hide({paths:n,dispatch:!0});i.length&&t.show({paths:i,dispatch:!0})}},this.clear=function(){this.setActiveState(!1),p&&m&&r.removeSceneGraphOverrideSet(p.getViewer(),m),p&&f&&r.removeSceneGraphOverrideSet(p.getViewer(),f),p=m=f=h=null}}}),p=[];return e.singleton({init:function(){},getDMUSceneDisplayController:function(e){if(e&&e.context){for(var t=!1,n=0;n<p.length;n++)if(p[n].context===e.context){p[n].counter++,t=!0;break}if(!t){var i=new c(e);i.setActiveState(!0),p.push({counter:1,context:e.context,ctrl:i})}return this.giveDMUSceneDisplayController(e)}},giveDMUSceneDisplayController:function(e){if(e&&e.context){for(var t,n=0;n<p.length;n++)if(p[n].context===e.context){t=p[n].ctrl;break}if(t)return Object.freeze({isAComparisonDisplayed:function(){return t?t.isAComparisonDisplayed():null},getCurrentComparedObjectIDPaths:function(){return t?t.getCurrentComparedObjectIDPaths():null},getCurrentCompareBalance:function(){return t?t.getCurrentCompareBalance():[]},getCurrentLocalAxisValue:function(){return!t||t.getCurrentLocalAxisValue()},getDisplayedAndHiddenOccurrences:function(e){return t?t.getDisplayedAndHiddenOccurrences(e):{}},toggleVisibility:function(e){return t?t.toggleVisibility(e):{}}})}},unreferenceDMUSceneDisplayController:function(e){if(e&&e.context)for(var t=0;t<p.length;t++)if(p[t].context===e.context)return p[t].counter--,void(p[t].counter<=0&&(p[t].ctrl&&p[t].ctrl.clear(),p.splice(t,1)))}})}),define("DS/DMUBaseUIControllers/DMUReviewController",["UWA/Core","UWA/Class","DS/DMUControls/panels/DMUReviewPanel","DS/DMUControls/panels/DMUHighlightsPanel","DS/DMUControls/panels/DMUChecksPanel","DS/UIKIT/Spinner","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/CoreEvents/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/PADUtils/PADUtilsServices","DS/WebappsUtils/WebappsUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g,c,p,m,f,h,v,C,D,b,M,y,S,w){"use strict";var E=t.extend({init:function(t){this._parent(t);var E,U,x,O,P=t||{},R=P.context,A=new d,I=a.giveEventsController({viewer:R.getViewer()}),k=v.giveDMUSlidesController({context:R}),V=!1,T=!0,j=!1,F=!1,N="issue";localStorage.setItem("issueCreationType","issue");var L,B,H,W,q,_,z,X,G,K,J,Z,Q,Y,$,ee,te={},ne=new Map;ne.set("PRIVATE","IN_WORK"),ne.set("IN_WORK","FROZEN"),ne.set("FROZEN","RELEASED"),ne.set("RELEASED","OBSOLETE"),ne.set("OBSOLETE",void 0);var ie=new Map;ie.set("PRIVATE",void 0),ie.set("IN_WORK","PRIVATE"),ie.set("FROZEN","IN_WORK"),ie.set("RELEASED",void 0),ie.set("OBSOLETE",void 0);var re=new Map;re.set("PRIVATE","#9b2c98"),re.set("IN_WORK","#007da3"),re.set("FROZEN","#018308"),re.set("RELEASED","#757575"),re.set("OBSOLETE","#80808080");var oe,ae,le,se=new Map;se.set("PRIVATE",w.maturityValue.PRIVATE),se.set("IN_WORK",w.maturityValue.IN_WORK),se.set("FROZEN",w.maturityValue.FROZEN),se.set("RELEASED",w.maturityValue.RELEASED),se.set("OBSOLETE",w.maturityValue.OBSOLETE);var de,ue,ge,ce,pe,me=-1,fe=-1,he={},ve={},Ce={},De={},be="noType",Me=[],ye=[],Se=[],we=[],Ee=0,Ue=!1,xe=!1,Oe=!1,Pe=!1,Re=new e.createElement("div",{class:"thumbnailsDiv"}),Ae=new Map,Ie=[];let ke=[],Ve="noWarning";Ie.statusOK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check",fonticonColor:"rgb(71,119,56)"},Ie.statusKO={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-wrong",fonticonColor:"rgb(234,79,55)"},Ie.statusUNK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question",fonticonColor:"#007DA3"},Ie.statusTBA={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention",fonticonColor:"#007DA3"},Ie.requirement={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-requirement",fonticonColor:"black"},Ie.highlight_urgent={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-alert",fonticonColor:"rgb(153, 7, 7)"},Ie.highlight_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-high",fonticonColor:"rgb(234,79,55)"},Ie.highlight_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-medium",fonticonColor:"rgb(232,123,0)"},Ie.highlight_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-low",fonticonColor:"rgb(71,119,56)"},Ie.ca_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(234,79,55)"},Ie.ca_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(232,123,0)"},Ie.ca_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(71,119,56)"};var Te=[Ie.statusUNK,Ie.statusOK,Ie.statusKO,Ie.requirement],je=[Ie.statusTBA,Ie.highlight_low,Ie.highlight_medium,Ie.highlight_high,Ie.statusOK,Ie.highlight_urgent],Fe=[];function Ne(e){var t=!0;if(e&&"3DPart"===e.usage)return t;var n=a.getReviewContext({viewer:R.getViewer()}),i=a.getContextViewer({viewer:R.getViewer()}).getController(),r=n&&n.getValidation()&&n.getValidation().getContext()&&n.getValidation().getContext().getMainContextID()?n.getValidation().getContext().getMainContextID():null,o=[],l=i.getNode({id:r});if(l){o.push(l);var s=new g(o);if(s.externalPath.length){var d=s.externalPath[0].getChildren();for(let e=0;e<d.length;e++)if(!u.isRepInstance(d[e])){t=!1;break}}}else t=!1;return t}function Le(e){if(I){let i=!1;for(var t=0;t<ke.length;t++)if(ke[t].id===e.id){i=!0;break}if(i){var n=a.getReviewContext({viewer:R.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return I.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}}}function Be(e){for(var t=0;t<ke.length;t++)if(ke[t].id===e.id&&ke[t].content){let i=ke[t].content.getMarkupContent();if(i){var n=u.buildPathElement(i.getNode());c.empty(),p.empty(),c.add({pathElement:n}),m.add({pathElement:n});let t=e.position.clone();R.getExecutionContext?R.getContextualUIManager()._showContextMenu(t):R.getContextualUIManager()._showContextualMenu(t)}}}function He(e){let t=JSON.parse(e.dataTransfer.getData("Text"));if(t.data&&t.data.items&&t.data.items.length>0){let e=[];for(let n=0;n<t.data.items.length;n++)-1!==["Requirement","Requirement Specification","Chapter"].indexOf(t.data.items[n].objectType)&&e.push(t.data.items[n]);I.fireEvent("onRequirementDropped",e)}}function We(){var e=l.getCommand("DMUAddHighlightHdr",P.commandContext);e&&e.begin()}function qe(e){O=e.iEvt?e.iEvt:e;var t=l.getCommand("DMUAddCheckHdr",P.commandContext);t&&t.begin()}Fe.Low=Ie.ca_low,Fe.Medium=Ie.ca_medium,Fe.High=Ie.ca_high;var _e=function(e){var t,n=e.object.getElementsByClassName("highlightsPanel-editableHighlightThumbDiv")[0];if(!n.getElementsByClassName("DMUCommentMainDiv").length&&!n.getElementsByClassName("highlightsPanel-thumbnail").length){var i=e.object.getElementsByClassName("highlightsPanel-slide")[0],r=e.object.getElementsByClassName("highlightsPanel-slideIcon")[0],o=ye[e.id]._repRefMarkupId;if(o){var l=a.getReviewContext({viewer:R.getViewer()}).getValidation().getRepRef(o);if(oe=ye[e.id]._slideID,ge=n,ce=i,pe=r,l){var s=l.getMarkupContent(),d=s?s.getSlides():[];for(let e=0;e<d.length;e++)if(d[e].getAttribute("sUuid")===oe)t=d[e];else if(d[e].getDMUObjects().length){var u=d[e].getDMUObjects();for(let e=0;e<u.length;e++){var g=u[e].getDMUComments?u[e].getDMUComments():[];if(g.length)for(let e=0;e<g.length;e++)if(g[e].getAttribute("sUuid")===oe){t=g[e];break}}}}t&&function(e,t){var n=C.giveDMUCommentsController({context:R});if("DMUComment"===e.getType()){var i=n.getCommentRepresentation(oe,"normal").getDiv(),r=n.getCommentRepresentation(oe,"light").getDiv();r.addClassName("lightCommentRepresentation"),i.addClassName("normalCommentRepresentation"),i.inject(ge),r.inject(ge),r.hide()}else{var o=e.getAttribute("sName"),a=k.getSlideRepresentation(e.getAttribute("sUuid"),"normal");a.getDiv().dsModel=a,a.getDiv().addClassName("highlightsPanel-thumbnail"),a.getDiv().inject(ge),Ae.has(t)||Ae.set(t,a),ce.setText(o),ce.title=o,pe.addClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-presentation-slide"),a.getDiv().setStyles({padding:"0px"}),f.getTouchMode()&&a.getDiv().setStyles({width:"193px"})}}(t,e.id)}}},ze=function(e){var t=l.getCommand("DMUEditPropertiesHdr",P.commandContext);t.setObject(e),t.begin()};function Xe(e){var t=e.path;Se[Se.length]={name:e.name,id:Ee,path:t},we[Ee]={name:e.name,index:Se.length-1,path:t},Ue=!1,Ee+=7}var Ge=function(){I.fireEvent("onUpdateValidatedRequested",!1),L.deactiveValidatedButton(),j=!1,ue&&I.removeEvent(ue)},Ke=function(e){if("Escape"===e.key||27===e.keyCode){if(j&&Ge(),F)l.getCommand("DMUSetImpactedCheckHdr",P.commandContext).end(),F=!1;var t=l.getCommand("DMUAddHighlightHdr");t&&t.isRunning()&&t.end(),W&&W.deactiveButtons()}if("Delete"===e.key||46===e.keyCode){var n=c.get();if(n.length&&(!e.target||"text"!==e.target.type&&"textarea"!==e.target.type)){var i=n[0].pathElement.getLastElement();if(i.getOwner&&("DMUValidationCheck"===i.getOwner().getType()||"DMUValidationExposedPresentation"===i.getOwner().getType()))if(e.shiftKey){let e=l.getCommand("DMUQuickDeleteHdr",P.commandContext);if(e)e.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpQuickDelete",context:P.commandContext});t.begin(),t.destroy(),t=null})}}else{l.getCommand("DMUDeleteHdr",P.commandContext).begin()}}}},Je=function(){var e=l.getCommand("DMUUpdateValidatedListHdr",P.commandContext);e&&!e.isRunning()&&(j=!0,e.options.arguments[0].Value="add",e.begin(),window.addEventListener("keydown",Ke,!0),ue=I.addEvent("onDMUValidatedCreated",function(e){if(j=!1,I.fireEvent("onUpdateValidatedRequested",!1),e){Ne()&&L.setAddValidatedButtonVisibilityFlag(!0);for(let n=0;n<e.validatedNames.length;n++){var t=L.addValidatedObject(e.validatedNames[n],e.validatedIcons[n]);t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0),Xe({name:e.validatedNames[n],id:e.validatedId,path:e.validatedPaths[n]})}}else L.deactiveValidatedButton(),j=!1;I.removeEvent(ue)}))};function Ze(){return L?L.getColumnMinimumWidth():273}function Qe(){return L?L.getColumnWidthStep():240}function Ye(e){Ee=0,Se=[],we=[];var t=Z.getPathElements();for(let e=0;e<t.length;e++)Se[e]={name:t[e].instanceName,id:Ee,path:t[e].pathElement},we[Ee]={name:t[e].instanceName,index:e,path:t[e].pathElement},Ee+=7;e&&e()}function $e(e){const t=a.getReviewContext({viewer:R.getViewer()}),n=t&&t.getValidation();if(!n||e&&"DMUTemporaryBag"===e.getType())return null;var i={};const r=y.getUserLogin();let o;const l=n.getOwner(),s=n.getStatus(),d=n.getCurrentState();o="Activated"===n.getRestrictedEditionFlag()?"Activated":"Deactivated";const u=e=>{let t,n=M.getSetting("pad_security_ctx");const i=/::([^.]+)/;switch(n=n.match(i)?n.match(i)[1]:"",e){case"PRIVATE":t=["VPLMAdmin"];break;case"IN_WORK":t=["VPLMProjectLeader","VPLMAdmin"]}return r===l||t.includes(n)},g={Deactivated:"edit",PRIVATE:"readOnly",IN_WORK:"inProgress"===s&&u("IN_WORK")?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let c=g[o]||g[d]||"readOnly";const p={Deactivated:"edit",PRIVATE:"inProgress"===s&&u("PRIVATE")?"edit":"readOnly",IN_WORK:"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let m=p[o]||p[d]||"readOnly";const f={Deactivated:"edit",PRIVATE:"readOnly",IN_WORK:u("IN_WORK")?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let h=f[o]||f[d]||"readOnly";i.review={canEditValObj:"edit"===m,canEditState:"edit"===h},i.check={canCreate:"edit"===m,canEditDef:"edit"===m,canEditState:"edit"===c,canDelete:"edit"===m},i.highlight={canCreate:"edit"===c,canEditDef:"edit"===c,canEditPriority:"edit"===c,canDelete:"edit"===c};const v={Deactivated:"create",PRIVATE:"readOnly",IN_WORK:"inProgress"===s?"create":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let C=v[o]||v[d]||"readOnly";if(i.markup={canCreate:"create"===C},i.reply={canCreate:"create"===C},e){"DMUMarkup"===e.getType()&&(e=e.getMarkupOwner()),"ReviewMarkup"===e.getType()&&(e=e.getParent());const t=e.getOwner(),n={Deactivated:"edit",PRIVATE:"readOnly",IN_WORK:"inProgress"===s&&t===r?"edit":"readOnly",FROZEN:"readOnly",RELEASED:"readOnly",OBSOLETE:"readOnly"};let a=n[o]||n[d]||"readOnly";if("Markup"===e.getType()){i.markup.canEdit="edit"===a;var D=e.getReplies();i.markup.canDelete="Activated"!==o||"edit"===a&&0===D.length}else"Reply"===e.getType()&&(i.reply.canEdit="edit"===a,i.reply.canDelete="edit"===a)}return i}function et(){Me=[];let e=K.getContext()?K.getContext().getMainContextType():null,t=S.getParentType(e)?S.getParentType(e):e;for(let e=0;e<Se.length;e++){let r=[],o=Se[e].id,a=we[o].path;if("Requirement Specification"===t||"Requirement"===t||"Document"===t||"Specification Report"===t||"DesignSight"===t){let t=K.getNode().getChildren(),n=Se[e].path[0];t.forEach(e=>{"Validated"===e.name&&e.getDocInfo().validatedPaths[0]===n&&r.push(e)});let i=new g(r);Me[o]=i}else if(""===we[o].instanceName&&(Me[o]=void 0),we[o].path.externalPath)Me[o]=we[o].path;else{for(var n=0;n<a.length;n++){var i=E.getNode({id:a[n]});i&&r.push(i)}if(r.length){let e=new g(r);Me[o]=e}}}Ue=!0}function tt(){if(z){let e=z.getSectionHeader(),t=dt();e.setSubMenuCommands(t)}if(W){let e=W.getSectionHeader(),t=st();e.setSubMenuCommands(t)}}function nt(e){if("Check"===e.type){var t=K.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){let i=u.buildPathElement(t[n].getNode());"add"===e.updateType?c.add({pathElement:i}):(xe=!0,c.remove({pathElement:i})),tt()}}else if("Highlight"===e.type){var n=K.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){let i=u.buildPathElement(n[t].getNode());"add"===e.updateType?c.add({pathElement:i}):(xe=!0,c.remove({pathElement:i})),I.fireEvent("onHighlightSelectionCompleted"),tt()}}}function it(e){var t=c.get(),n=t[t.length-1].pathElement;if(n&&n.getLastElement&&n.getLastElement().getOwner&&n.getLastElement().getOwner().getPlmID){var i=t[t.length-1].pathElement.getLastElement().getOwner().getPlmID();for(let t=0;t<e.expanders.length;t++)e.expanders[t].id===i&&(fe=t)}else fe=-1}function rt(e){var t,n;e.expanders&&(t=e.expanders),n=e.index;var i=c.get();if(e.event&&e.event&&(e.event.shiftKey||e.event.options&&e.event.options.shiftKey)&&fe>-1){var r=n>fe?fe:n,o=n>fe?n:fe;if(t[r].type===t[o].type)for(let e=0;e<t.length;e++)e>=r&&e<=o?t[e].expander.getMainDiv().setSelectedFlag(!0):nt({id:t[e].id,type:t[e].type,index:e,updateType:"remove"})}else{var a;if(i.length)if("DMUValidationExposedPresentation"===(a=i[0].pathElement.getLastElement().getDMUType&&"DMUComment"===i[0].pathElement.getLastElement().getDMUType()?"Highlight":i[0].pathElement.getLastElement().getOwner?i[0].pathElement.getLastElement().getOwner().getType():i[0].pathElement.getLastElement().modelIdentification?"Validated":void 0)?a="Highlight":"DMUValidationCheck"===a&&(a="Check"),t[n].type!==a){for(let e=i.length-1;e>=0;e--){var l=i[e].pathElement;xe=!0,"Highlight"===a?W.unSelectExpander(l.getLastElement().getOwner?l.getLastElement().getOwner().getPlmID():void 0):"Check"===a?z.unSelectExpander(l.getLastElement().getOwner?l.getLastElement().getOwner().getPlmID():void 0):"Validated"!==a&&"Context"!==a&&L.unSelectExpander(l.getLastElement().getOwner?l.getLastElement().getOwner().getPlmID():void 0)}Oe?xe=!1:(c.empty(),p.empty()),"Validated"===a&&L.unSelectAllValidated()}else t[n].expander.getMainDiv().isCheckBoxClicked()||!e.event||e.event.options&&e.event.options.shiftKey||e.event.shiftKey||e.event.options&&e.event.options.ctrlKey||e.ctrlKey||i[0].pathElement.getLastElement().getDMUType()&&"DMUComment"===i[0].pathElement.getLastElement().getDMUType()||(xe=!0,p.empty());fe=n}nt({id:t[n].id,type:t[n].type,index:n,updateType:"add"})}function ot(e){if("Check"===e.type){var t=K.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){xe=!0;let i=u.buildPathElement(t[n].getNode());c.remove({pathElement:i}),c.get().length?it(e):fe=-1}}else if("Highlight"===e.type){var n=K.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){xe=!0;let i=u.buildPathElement(n[t].getNode());c.remove({pathElement:i}),c.get().length?it(e):fe=-1}}else if("Validated"===e.type){var i=e.id;xe=!0,Me[i]&&(c.remove({pathElement:u.buildPathElement(Me[i].getLastElement(!0))}),p.remove({pathElement:Me[i]})),me=-1}else if("Context"===e.type){var r=E.getNode({id:J.getSubContextID()?J.getSubContextID():J.getMainContextID()}),o=u.buildPathElement(r);xe=!0,c.remove({pathElement:o}),p.remove({pathElement:o})}tt()}function at(){c.empty();var e=l.getCommand("DMUEditPropertiesHdr",P.commandContext);e&&e.begin()}function lt(){c.empty();var e=l.getCommand("DMUCopyLinkHdr",P.commandContext);e&&e.begin()}function st(){var e=[],t=function(e){var t=c.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&(K.isReadOnly()||"Checks"!==n&&"Highlights"!==n||(xe=!0,m.remove({pathElement:t[e].pathElement}),c.remove({pathElement:t[e].pathElement})))}let i=u.buildPathElement(K.getNode().getChildByName("Highlights"));const r=$e(),o=i.getLastElement().getOwner();let a=!x||!r.highlight.canEditDef;if(o.setReadOnly(a),c.add({pathElement:i}),m.add({pathElement:i}),"expand"===e){var s=l.getCommand("DMUExpandAllHdr",P.commandContext);s&&s.begin()}else{var d=l.getCommand("DMUCollapseAllHdr",P.commandContext);d&&d.begin()}};e.push({id:"ExpandAll",type:"button",nls:w.expandAll,fontIcon:"fonticon fonticon-expand-all wux-ui-3ds",separator:!1,cb:function(){t("expand")}}),e.push({id:"CollapseAll",type:"button",nls:w.collapseAll,fontIcon:"fonticon fonticon-collapse-all wux-ui-3ds",separator:!1,cb:function(){t("collapse")}}),e.push({id:"HideShowThumbnail",type:"button",nls:w.hideShowPreview,fontIcon:"fonticon fonticon-eye-off wux-ui-3ds",separator:!0,cb:function(){var e=l.getCommand("DMUHideShowThumbnailHdr",P.commandContext);e&&e.begin()}});var n=[],i=$e();!x||!i.highlight.canEditDef||(n.push({id:"NewIssue",type:"subCommand",nls:w.newIssue,defaultCheckValue:!0,fontIcon:"fonticon fonticon-issue-type wux-ui-3ds",separator:!1,cb:function(){N="issue",localStorage.setItem("issueCreationType","issue")}}),n.push({id:"NewIssueFromTemplate",type:"subCommand",nls:w.newIssueFromTemplate,defaultCheckValue:!1,fontIcon:"fonticon fonticon-template wux-ui-3ds",separator:!1,cb:function(){N="issueTemplate",localStorage.setItem("issueCreationType","issueTemplate")}}),e.push({id:"GenerateIssue",type:"subMenuDisplayButton",nls:w.generateIssue,icon:b.getWebappsAssetUrl("DMUBaseCtxCommands","icons/32/")+"I_DMU_LeaderXCross.png",separator:!0,subCommands:n,subCommandsCheckable:!0}));var r=c.get(),o=0;for(let e=0;e<r.length;e++)r[e].pathElement.getLastElement().getDMUType&&"DMUValidationExposedPresentation"!==r[e].pathElement.getLastElement().getDMUType()||o++;return 1===r.length&&1===o&&e.push({id:"CopyLink",type:"button",nls:w.copyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",cb:function(){var e=l.getCommand("DMUCopyLinkHdr",P.commandContext);e&&e.begin()}}),(i=$e())&&x&&i.highlight.canDelete&&K.getModifyAccessFlag()&&r.length>0&&o===r.length&&e.push({id:"Delete",type:"button",nls:w.delete,fontIcon:"fonticon fonticon-trash wux-ui-3ds",separator:!1,cb:function(){var e=l.getCommand("DMUDeleteHdr",P.commandContext);e&&e.begin()}}),e}function dt(){var e=[],t=function(e){var t=c.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&(K.isReadOnly()||"Checks"!==n&&"Highlights"!==n||(xe=!0,m.remove({pathElement:t[e].pathElement}),c.remove({pathElement:t[e].pathElement})))}let i=u.buildPathElement(K.getNode().getChildByName("Checks"));const r=$e(),o=i.getLastElement().getOwner();let a=!x||!r.check.canEditDef;if(o.setReadOnly(a),c.add({pathElement:i}),m.add({pathElement:i}),"expand"===e){var s=l.getCommand("DMUExpandAllHdr",P.commandContext);s&&s.begin()}else{var d=l.getCommand("DMUCollapseAllHdr",P.commandContext);d&&d.begin()}},n=$e(),i=c.get();e.push({id:"ExpandAll",type:"button",nls:w.expandAll,fontIcon:"fonticon fonticon-expand-all wux-ui-3ds",cb:function(){t("expand")}}),e.push({id:"CollapseAll",type:"button",nls:w.collapseAll,fontIcon:"fonticon fonticon-collapse-all wux-ui-3ds",separator:n&&x&&n.check.canDelete&&K.getModifyAccessFlag()&&i.length>0,cb:function(){t("collapse")}});var r=0;for(let e=0;e<i.length;e++)i[e].pathElement.getLastElement().getDMUType&&"DMUValidationCheck"!==i[e].pathElement.getLastElement().getDMUType()||r++;return n&&x&&n.check.canDelete&&K.getModifyAccessFlag()&&i.length>0&&i.length===r&&e.push({id:"Delete",type:"button",nls:w.delete,fontIcon:"fonticon fonticon-trash wux-ui-3ds",cb:function(){var e=l.getCommand("DMUDeleteHdr",P.commandContext);e&&e.begin()}}),e}function ut(){var e=[];ne.get($)&&e.push({id:"Next State",type:"button",nls:w.maturityValue.SetTo+' "'+se.get(ne.get($))+'"',fontIcon:"fonticon fonticon-double-chevron-right wux-ui-3ds",fontIconColor:re.get(ne.get($)),separator:!1,cb:function(){var e=H.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],t=H.getElementsByClassName("rp-maturity-"+$)[0];(ee=new o({visible:!0})).inject(e);var n=ee.getContent().getSize().width,i=(t.getSize().width-n)/2;ee.getContent().setStyles({position:"absolute",height:"20px","margin-left":i.toString()+"px"}),I.fireEvent("onMaturityModificationRequested",{fromState:$,toState:ne.get($)})}}),ie.get($)&&e.push({id:"Previous State",type:"button",nls:w.maturityValue.SetTo+' "'+se.get(ie.get($))+'"',fontIcon:"fonticon fonticon-double-chevron-left wux-ui-3ds",fontIconColor:re.get(ie.get($)),separator:!1,cb:function(){var e=H.getElementsByClassName("CATWebUXSectionHeaderQuickAccessDiv")[0],t=H.getElementsByClassName("rp-maturity-"+$)[0];(ee=new o({visible:!0})).inject(e);var n=ee.getContent().getSize().width,i=(t.getSize().width-n)/2;ee.getContent().setStyles({position:"absolute",height:"20px","margin-left":i.toString()+"px"}),I.fireEvent("onMaturityModificationRequested",{fromState:$,toState:ie.get($)})}}),e.push({id:"DMUReviewMaturityChange",type:"button",nls:w.changeMaturity,fontIcon:"fonticon fonticon-collaborative-lifecycle-management wux-ui-3ds",separator:!0,cb:function(){var e=l.getCommand("DMUReviewMaturityChangeHdr",P.commandContext);e&&e.begin()}});var t=$e();return t&&t.review&&t.review.canEditState&&K&&K.getModifyAccessFlag()&&e.push({id:"DMUReviewStatusChange",type:"button",nls:w.validationStatus,fontIcon:"fonticon fonticon-check wux-ui-3ds",separator:!0,cb:function(){var e=l.getCommand("DMUReviewStatusChangeHdr",P.commandContext);e&&e.begin()}}),e.push({id:"DMUCopyLink",type:"button",nls:w.launchCopyLink,fontIcon:"fonticon fonticon-link wux-ui-3ds",separator:!1,cb:lt}),e.push({id:"DMUEditProperties",type:"button",nls:w.launchEditProperties,fontIcon:"fonticon fonticon-info wux-ui-3ds",separator:!1,cb:at}),e}function gt(){var e=[];e.push({id:"newDropZone",type:"dropZone",zoneText:w.reqDropZoneInfo,title:"new ReqCheck",cb:He});var t=$e();return t&&t.check.canCreate&&K.getModifyAccessFlag()&&x&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:"new Check",cb:qe}),e}function ct(){var e=[],t=$e();return t&&t.highlight.canCreate&&K.getModifyAccessFlag()&&x&&K.getContext()&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:"new Highlight",cb:We}),e}function pt(){var e=[];if(K){const t=K.getCurrentState();t&&e.push({id:"maturityStateButton",type:"label",title:w.maturityState,label:w.maturityValue[t],className:"rp-ms-box rp-maturity-"+t.toString()});const n=K.getStatus();n&&(e.push({id:"assessValidationButton",type:"label",title:w.validationState,label:w.statusValue[n],className:"rp-ms-box rp-status-"+n.toString()}),Ve&&e.push({id:"assessValidationWarningButton",type:"label",title:w.valStatusWarning[Ve],fontIcon:"wux-ui-3ds-attention wux-ui-3ds",className:"rp-status-warning-"+Ve}))}return e}function mt(){let e=null;if(K.getContext()){let t=K.getContext().getMainContextType();e=S.getParentType(t)?S.getParentType(t):t}if(Y.length||x){W=new i;var t=$e();_=W.buildPanel({contextualCmdList:st(),quickAccessBtnList:ct(),highlights:Y,checks:Q,icons:Te,highlightIcons:je,readOnlyFlag:K.isReadOnly(),thumbnail:Re,onHighlightExpand:_e,allowEditProperties:!0,getHighlightDragContent:function(e,t){return JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:D.getPlatformId(),serviceId:"3DSpace",contextId:M.getSetting("pad_security_ctx")?M.getSetting("pad_security_ctx"):void 0,objectId:e,objectType:"DMUValidationExposedPresentation",displayName:t}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})},onAttachedObjClicked:ze,panelTitle:K.getName()?K.getName():U,editionMode:x,frmWindow:R,ctxViewer:a.getContextViewer({viewer:R.getViewer()}),contextType:e,restrictions:t,appId:window.widget.getValue("appId")});var n={id:"DMUHighlightsPanel",className:"DMUHighlightsPanel",title:"Highlights",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-highlight-review DMUHighlightPanelIcon",immersiveFrame:R.getImmersiveFrame(),viewerFrame:R.getViewerFrame(),closeButtonFlag:!1,content:_,minWidth:Ze(),widthStep:Qe(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};q=new h(n)}}function ft(){let e=null;if(K.getContext()){let t=K.getContext().getMainContextType();e=S.getParentType(t)?S.getParentType(t):t}if(Q.length||x){z=new r,ae={envId:D.getPlatformId(),contextId:M.getSetting("pad_security_ctx")?M.getSetting("pad_security_ctx"):void 0,source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},le=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:D.getPlatformId(),serviceId:"3DSpace",contextId:M.getSetting("pad_security_ctx")?M.getSetting("pad_security_ctx"):void 0,objectId:K.getPlmID(),objectType:"DMUValidationValidation",displayName:K.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0});var t=$e();G=z.buildPanel({contextualCmdList:dt(),quickAccessBtnList:gt(),checks:Q,highlights:Y,icons:Te,highlightIcons:je,readOnlyFlag:K.isReadOnly(),thumbnail:Re,onHighlightExpand:_e,allowEditProperties:!0,highlightDragContent:ae,reviewDragContent:le,onAttachedObjClicked:ze,panelTitle:K.getName()?K.getName():U,editionMode:x,frmWindow:R,ctxViewer:a.getContextViewer({viewer:R.getViewer()}),contextType:e,restrictions:t,appId:window.widget.getValue("appId")});var n={id:"DMUChecksPanel",className:"DMUChecksPanel",title:"Checks",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-check-review DMUChecksPanelIcon",immersiveFrame:R.getImmersiveFrame(),viewerFrame:R.getViewerFrame(),closeButtonFlag:!1,content:G,minWidth:Ze(),widthStep:Qe(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};X=new h(n)}}function ht(e,t){if(e&&t){let i="noWarning";var n=e.getChecks();n&&n.length>0&&("inProgress"===e.getStatus()?n.some(e=>"1"===e.getStatus())||(i="warningProgress"):"failed"===e.getStatus()?n.some(e=>"3"===e.getStatus())||(i="warningFailed"):"passed"===e.getStatus()&&(n.every(e=>"2"===e.getStatus())||(i="warningPassed"))),Ve!==i&&(Ve=i,t.setPanelQuickAccessCommands(pt()))}}function vt(){var e=a.getReviewContext({viewer:R.getViewer()});V=!0,E=a.getContextViewer({viewer:R.getViewer()}).getController(),K=e.getValidation(),J=K.getContext(),Z=K.getValidated(),Ye(),Q=K.getChecksData(),Y=K.getHighlightsData(),function(){for(let t=0;t<Y.length;t++){var e={_repRefMarkupId:Y[t].repRefMarkupId,_slideID:Y[t].slideId};ye[Y[t].id]=e}}(),L=new n,$=K.getCurrentState();let t=null;if(K.getContext()){let e=K.getContext().getMainContextType();t=S.getParentType(e)?S.getParentType(e):e}var i,r=$e();mt(),ft(),le=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:D.getPlatformId(),serviceId:"3DSpace",contextId:M.getSetting("pad_security_ctx")?M.getSetting("pad_security_ctx"):void 0,objectId:K.getPlmID(),objectType:"DMUValidationValidation",displayName:K.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),1===Z.getPathElements().length&&(Ne(J.getMainContext())||(i=J.getMainContext())&&["Drawing","Document","Specification Report","Requirement","DIFSheet","R2V_FeatureState"].includes(i.type))&&(J.getMainContextID()!==Z.getPathElements()[0].pathElement[0]&&J.getSubContextID()!==Z.getPathElements()[0].pathElement[0]||L.setAddValidatedButtonVisibilityFlag(!0));let o=null;var d;J&&(o=[],J.getSubContextName()?o.push(J.getSubContextName()):J.getMainContextName()&&o.push(J.getMainContextName())),H=L.buildPanel({contextualCmdList:K.isReadOnly()?(d=[],d.push({id:"DMUCopyLink",type:"button",nls:w.launchCopyLink,icon:b.getWebappsAssetUrl("DMUBaseCommands","icons/22/")+"I_DMUCopyLink.png",cb:lt}),d.push({id:"DMUEditProperties",type:"button",nls:w.launchEditProperties,icon:b.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:at}),d):ut(),quickAccessBtnList:pt(),contextNames:o,validatedNames:K.getValidated().getValidatedInstanceNames(),checks:Q,highlights:Y,icons:Te,highlightIcons:je,readOnlyFlag:K.isReadOnly(),thumbnail:Re,onHighlightExpand:_e,allowEditProperties:!0,reviewDragContent:le,onAttachedObjClicked:ze,onAddValidatedClicked:Je,panelTitle:K.getName()?K.getName():U,editionMode:x,frmWindow:R,ctxViewer:a.getContextViewer({viewer:R.getViewer()}),contextType:t,restrictions:r,appId:window.widget.getValue("appId")});var f={id:"DMUReviewPanel",className:"DMUReviewPanel",title:"Review",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-review DMUReviewPanelIcon",immersiveFrame:R.getImmersiveFrame(),viewerFrame:R.getViewerFrame(),closeButtonFlag:!1,content:H,minWidth:Ze(),widthStep:Qe(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};function v(){let t=[];J&&te.id&&t.push(te.id);for(let e=0;e<Z.getPathElements().length;e++){let n=Z.getPathElements()[e];t.push(n.pathElement[n.pathElement.length-1])}if(J&&"R2V_FeatureState"===te.type){let t;(t=e.getReviewCtxInformation()&&e.getReviewCtxInformation().loadedR2VInfo?e.getReviewCtxInformation().loadedR2VInfo:e.getValidation().getContext().getJsonContexts()[0].loadedR2VInfo).forEach(e=>{if(e.id===J.getJsonContextIDs()[0]){let n=e.info[0].icon,i=e.info[0]["ds6w:label"],r=H.getElementsByClassName("validatedObjectExpander");for(let t=0;t<r.length;t++)if(""!==Z.getPathElements()[t].instanceName){let n=e.info[0].icon;L.updateHeaderIcon(r[t].id,n)}else L.updateHeaderIcon(r[t].id,n);var t=H.getElementsByClassName("contextObjectExpander");for(let e=0;e<t.length;e++)L.updateHeaderIcon(t[e].id,n),L.updateHeaderLabel(t[e].id,i)}})}else te.id&&t.length>0&&E.getAttributes({ids:t,attributes:["type_icon_url"],callbacks:{onComplete:function(e){let t=e[te.id].type_icon_url,n=e[te.id]["ds6w:label"],i=H.getElementsByClassName("validatedObjectExpander");for(let n=0;n<i.length;n++){var r=Z.getPathElements()[n].pathElement[Z.getPathElements()[n].pathElement.length-1];if(""!==Z.getPathElements()[n].instanceName){let t=e[r];L.updateHeaderIcon(i[n].id,t.type_icon_url)}else L.updateHeaderIcon(i[n].id,t)}var o=H.getElementsByClassName("contextObjectExpander");for(let e=0;e<o.length;e++)L.updateHeaderIcon(o[e].id,t),L.updateHeaderLabel(o[e].id,n)},onFailure:function(){let t=e.getReviewCtxInformation().tempObjectInfo.icon,n=H.getElementsByClassName("reviewPanel-validIcon");for(let e=0;e<n.length;e++)n[e].src=t;var i=H.getElementsByClassName("reviewPanel-ctxIcon");for(let e=0;e<i.length;e++)i[e].src=t;return null}}})}B=new h(f),J&&(te.id=J.getSubContextID()?J.getSubContextID():J.getMainContextID(),te.type=J.getSubContextType()?J.getSubContextType():J.getMainContextType()),v();var C,y=[];for(C=0;C<Q.length;C++)if(0!==Q[C].requirements.length){let e;for(e=0;e<Q[C].requirements.length;e++)y.push(Q[C].requirements[e].getPlmID())}y.length>0&&E.getAttributes({ids:y,attributes:["label","type_icon_url","ds6w:status"],callbacks:{onComplete:function(t){if(t){let l=e.getValidation();if(l){let e=l.getChecks();for(var n=0;n<e.length;n++){let o=e[n].getJsonRequirements();for(var i=0;i<o.length;i++)for(var r=0;r<y.length;r++)y[r]===o[i].getPlmID()&&o[i].setName(t[y[r]].label)}}var o=G.getElementsByClassName("checksPanel-requirement");for(let e=0;e<o.length;e++){var a=o[e].getText();o[e].setText(t[a].label),o[e].title=t[a].label}}},onFailure:function(){return null}}}),window.addEventListener("keydown",Ke,!0),ht(K,L),L&&(he.updateIconValidated=L.subscribe("updateIconValidated",v),he.onValidatedSelected=L.subscribe("onValidatedSelected",function(e){var t=c.get();for(let e=t.length-1;e>=0;e--)if(t[e].pathElement.getLastElement().getOwner){var n=t[e].pathElement.getLastElement().getOwner().getType();if("DMUValidationCheck"===n||"DMUValidationExposedPresentation"===n){xe=!0;var i=t[e].pathElement;p.remove({pathElement:t[e].pathElement}),c.remove({pathElement:t[e].pathElement}),L.unSelectExpander(i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0),z.unSelectExpander(i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0),W.unSelectExpander(i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0),tt()}}!function(e){Ue||et();var t,n=e.element.header,i=e.element.getContent().id;let r;if((J=K.getContext()).getSubContextName()?r=J.getSubContextName():J.getMainContextType()&&(r=J.getMainContextType()),n===r&&"Requirement"!==r){var o=[];t=E.getNode({id:J.getSubContextID()?J.getSubContextID():J.getMainContextID()}),o.push(t);var a=new g(o);Me[i]=a}if(!0===e.element.isSelected())if(e.event&&e.event.shiftKey&&me>-1)if(-1!==me){c.add({pathElement:Me[i]}),p.add({pathElement:Me[i]});var l=we[i].index>we[me].index+1?we[me].index+1:we[i].index,d=we[i].index>we[me].index-1?we[i].index:we[me].index-1;for(let t=l;t<=d;t++)t>=l&&t<=d&&(e.validatedRects[t].getMainDiv().isSelected()||e.validatedRects[t].getMainDiv().setSelectedFlag(!0))}else c.add({pathElement:Me[i]}),p.add({pathElement:Me[i]}),me=i;else{if(["Requirement Specification","Requirement"].includes(J.getMainContextType())){let e=s.getManager({name:"DMU2DSheetManager",context:R});Me.length&&(c.unsubscribe(de),e.setCurrentElement({elementID:Me[i].getLastElement(!0).modelIdentification?Me[i].getLastElement(!0).modelIdentification:Me[i].getLastElement(!0).getDocInfo().validatedPaths[0]}),de=c.onPostRemove(function(e){var t;e&&e.length&&e[0].pathElement&&e[0].pathElement.getLastElement(!0).getDMUType&&(t=e[0].pathElement.getLastElement(!0).getDMUType()),xe||"DMUSlide"===t||(L.unSelectAllExpanders(be),z.unSelectAllExpanders(be),W.unSelectAllExpanders(be)),xe=!1,c.get().length||(fe=-1)}))}e.element.isCheckBoxClicked()||!event||event.shiftKey||event.ctrlKey||e.event&&(c.empty(),p.empty()),Me[i]&&("Document"===J.getMainContextType()||"Specification Report"===J.getMainContextType()?(t=E.getNode({id:J.getSubContextID()?J.getSubContextID():J.getMainContextID()}))&&(c.add({pathElement:u.buildPathElement(E.getNode({id:J.getSubContextID()?J.getSubContextID():J.getMainContextID()}))}),p.add({pathElement:u.buildPathElement(E.getNode({id:J.getSubContextID()?J.getSubContextID():J.getMainContextID()}))})):(c.add({pathElement:u.buildPathElement(Me[i].getLastElement(!0))}),p.add({pathElement:u.buildPathElement(Me[i].getLastElement(!0))})),me=i)}}(e)}),he.onContextSelected=L.subscribe("onContextSelected",function(e){!function(e){var t=E.getNode({id:J.getSubContextID()?J.getSubContextID():J.getMainContextID()}),n=u.buildPathElement(t);!0===e.element.isSelected()&&n.externalPath.length?(e.event.ctrlKey||(xe=!0,c.empty(),p.empty()),c.add({pathElement:n}),p.add({pathElement:n})):(xe=!0,c.remove({pathElement:n}),p.remove({pathElement:n}))}(e)}),he.onExpanderSelectionRequested=L.subscribe("onExpanderSelectionRequested",function(e){rt(e)}),he.onExpanderUnselectRequested=L.subscribe("onExpanderUnselectRequested",function(e){ot(e)}),he.onValidatedRemove=L.subscribe("onValidatedRemove",function(e){!function(){var e=l.getCommand("DMUUpdateValidatedListHdr",P.commandContext);e&&(e.options.arguments[0].Value="remove",e.begin());var t=I.addEvent("onValidatedSaved",function(e){["Requirement","R2V_FeatureState","Requirement Specification"].includes(J.getMainContextType())&&L.setDropZoneVisibilityFlag(!0),L._processValidatedObjDeletion(e),c.empty(),p.empty(),Ye(function(){et()}),I.removeEvent(t)})}()}),he.onUpdateValidatedListCancel=L.subscribe("onUpdateValidatedListCmdCancel",function(){var e=l.getCommand("DMUUpdateValidatedListHdr",P.commandContext);e&&e.isRunning()&&(e.end(),L.deactiveValidatedButton(),j=!1,ue&&I.removeEvent(ue))}),he.onMarkupCreationRequested=L.subscribe("onMarkupCreationRequested",function(){var e=l.getCommand("DMUReviewMarkupHdr",P.commandContext);e&&e.begin()}),he.onMarkupCtxMenuRequired=L.subscribe("onMarkupCtxMenuRequired",Be),he.onMarkupRenamed=L.subscribe("onMarkupRenamed",Le)),z&&(ve.onExpanderSelectionRequested=z.subscribe("onExpanderSelectionRequested",function(e){rt(e)}),ve.onExpanderUnselectRequested=z.subscribe("onExpanderUnselectRequested",function(e){ot(e)}),ve.onCheckAttributeChanged=z.subscribe("onCheckAttributeChanged",function(e){!function(e){var t=c.get();if(e.status){var n=[];for(let r=0;r<t.length;r++){var i=t[r].pathElement.getLastElement().getOwner().getPlmID();n.push(i),z.updateCheckStatus(i,e.status)}var r={objectIds:n,status:e.status};I.fireEvent("onCheckAttributeChanged",r)}else I.fireEvent("onCheckAttributeChanged",e)}(e)}),ve.onRequirementAddRequested=z.subscribe("onRequirementAddRequested",function(e){!function(e){I.fireEvent("requirementAddRequested",e)}(e)}),ve.onObjectRemoveRequested=z.subscribe("onRequirementRemoveRequested",function(e){!function(e){I.fireEvent("onRequirementRemoveRequested",e)}(e)}),he.onCheckCreationRequested=z.subscribe("onCheckCreationRequested",qe)),W&&(Ce.onExpanderSelectionRequested=W.subscribe("onExpanderSelectionRequested",function(e){rt(e)}),Ce.onExpanderUnselectRequested=W.subscribe("onExpanderUnselectRequested",function(e){ot(e)}),Ce.onHighlightAttributeChanged=W.subscribe("onHighlightAttributeChanged",function(e){!function(e){var t=c.get();if(e.rating){var n=[];for(let r=0;r<t.length;r++)if(t[r].pathElement.getLastElement().getOwner&&"DMUValidationExposedPresentation"===t[r].pathElement.getLastElement().getOwner().getType()){var i=t[r].pathElement.getLastElement().getOwner().getPlmID();i&&(n.push(i),W.updateHighlightSeverity(i,e.rating))}var r={objectIds:n,rating:e.rating};I.fireEvent("onHighlightAttributeChanged",r)}else I.fireEvent("onHighlightAttributeChanged",e)}(e)}),Ce.onImpCheckCancelCmd=W.subscribe("onImpCheckCancelCmd",function(){var e=l.getCommand("DMUSetImpactedCheckHdr",P.commandContext);e&&e.isRunning()&&e.end()}),Ce.onImpCheckRemoveRequested=W.subscribe("onImpCheckRemoveRequested",function(e){!function(e){var t,n;if(K){var i=K.getHighlights();if(i)for(let n=0;n<i.length;n++)if(i[n].getPlmID()===e.highlightId){t=i[n];break}var r=K.getChecks();if(r)for(let t=0;t<r.length;t++)if(r[t].getPlmID()===e.checkId){n=r[t];break}}t&&n&&I.fireEvent("onRemoveImpactedCheckRequested",{highlight:t,check:n})}(e)}),Ce.onIssueAddRequested=W.subscribe("onIssueAddRequested",function(e){var t,n,i=c.get();for(let t=0;t<i.length;t++)if(i[t].pathElement.getLastElement().getOwner&&i[t].pathElement.getLastElement().getOwner().getPlmID()!==e.id){xe=!0;let n=i[t].pathElement.getLastElement().getOwner().getPlmID(),r=0;for(;r<e.expanders.length;){if(e.expanders[r].id===n){e.expanders[r].expander.getMainDiv().setSelectedFlag(!1);break}r++}t++}if("issueTemplate"===N){var r=l.getCommand("CATWebUXGenerateIssueTemplateHdr",P.commandContext);r&&r.begin()}else{var o=l.getCommand("CATWebUXGenerateIssueHdr",P.commandContext);o&&o.begin()}t=I.addEvent("onTICCreationComplete",function(e){W.deactiveButtons(),I.fireEvent("onIssueDataRequested",{physicalId:e.ticID,onComplete:function(t){W.addIssue({highlightId:e.attachmentIDs[0],name:t.issueTitle,id:e.ticID})}}),I.fireEvent("onHighlightIssueCreated",{highlightId:e.attachmentIDs[0]}),I.removeEvent(t),I.removeEvent(n)}),n=I.addEvent("onTICCreationCancel",function(){(event&&event.target&&"create-view-footer-cancel-btn"===event.target.id||event&&event.target&&event.target.title&&"Close"===event.target.title)&&(W.deactiveButtons(),I.removeEvent(t),I.removeEvent(n))}),window.addEventListener("keydown",Ke,!0)}),Ce.onCaAddRequested=W.subscribe("onCaAddRequested",function(e){var t=c.get();for(let n=0;n<t.length;n++)if(t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id){xe=!0;let i=t[n].pathElement.getLastElement().getOwner().getPlmID(),r=0;for(;r<e.expanders.length;){if(e.expanders[r].id===i){e.expanders[r].expander.getMainDiv().setSelectedFlag(!1);break}r++}n++}var n,i,r=l.getCommand("CATWebUXGenerateCAHdr",P.commandContext);r&&r.begin(),n=I.addEvent("onTICCreationComplete",function(e){W.deactiveButtons(),W.addCa({highlightId:e.attachmentIDs[0],name:e.title,id:e.ticID}),I.removeEvent(n),I.removeEvent(i)}),i=I.addEvent("onTICCreationCancel",function(){W.deactiveButtons(),I.removeEvent(n),I.removeEvent(i)}),window.addEventListener("keydown",Ke,!0)}),he.onImpCheckRequested=W.subscribe("onImpCheckRequested",function(e){var t;if(K){var n=K.getHighlights();if(n)for(let i=0;i<n.length;i++)if(n[i].getPlmID()===e.objectId){t=n[i];break}}var i=l.getCommand("DMUSetImpactedCheckHdr",P.commandContext);i&&(i.setHighlightObject(t),i.begin()),F=!0,window.addEventListener("keydown",Ke,!0)}),he.onHighlightCreationRequested=W.subscribe("onHighlightCreationRequested",We)),ve.onRequirementRemoved=I.addEvent("onRequirementRemoved",function(t){z.removeRequirement(t),(e=e||a.getReviewContext({viewer:R.getViewer()}))&&e.getValidation().getChecks().forEach(e=>{e._sPlmID&&e.removeJsonRequirement(t.requirementId)})}),De.onExpanderSelectRequested=I.addEvent("onExpanderSelectRequested",function(e){var t;if(e.type&&e.id){t="Highlight"===e.type?W.getExpanders():"Check"===e.type?z.getExpanders():L.getExpanders();for(let n=0;n<t.length;n++)t[n].id===e.id&&t[n].expander.getMainDiv().setSelectedFlag(!0,!0)}}),De.issueCreationTokenEvent=I.addEvent("onTICFromSelectionCreationComplete",function(e){W.deactiveButtons(),I.fireEvent("onIssueDataRequested",{physicalId:e.ticID,onComplete:function(t){W.addIssue({highlightId:e.attachmentIDs[0],name:t.issueTitle,id:e.ticID})}}),I.fireEvent("onHighlightIssueCreated",{highlightId:e.attachmentIDs[0]})}),De.onCommentOrSlideInformationIconClicked=I.addEvent("onCommentOrSlideInformationIconClicked",function(e){Oe=!0,e.highlightId?W.scrollToHighlight(e,function(){Oe=Pe=!1}):e.checkId&&z.scrollToCheck(e,function(){Oe=Pe=!1})}),De.onExpandRequested=I.addEvent("onExpandRequested",function(e){"DMUValidationCheck"===e?z.expandAll():W.expandAll();var t=c.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&("Checks"!==n&&"Highlights"!==n||(xe=!0,m.remove({pathElement:t[e].pathElement}),c.remove({pathElement:t[e].pathElement}),tt()))}}),De.onExpanderSelectionRequested=I.addEvent("onExpanderSelectionRequested",function(e){rt(e)}),De.onExpanderSelectionRequested=I.addEvent("onSetImpactedCheckRequested",function(e){var t,n=[];if(K){var i=K.getHighlights();if(i)for(let n=0;n<i.length;n++)if(i[n].getPlmID()===e.highlightId){t=i[n];break}var r=K.getChecks();if(r)for(let t=0;t<r.length;t++)if(r[t].getPlmID()===e.checkId){n.push(r[t].getPlmID());break}}var o=l.getCommand("DMUSetImpactedCheckHdr",P.commandContext);o&&(o.setHighlightObject(t),o.setCheckObject(n),o.begin()),F=!0,window.addEventListener("keydown",Ke,!0)}),De.onCollapseRequested=I.addEvent("onCollapseRequested",function(e){"DMUValidationCheck"===e?z.collapseAll():W.collapseAll();var t=c.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&("Checks"!==n&&"Highlights"!==n||(xe=!0,m.remove({pathElement:t[e].pathElement}),c.remove({pathElement:t[e].pathElement})))}}),De.onValidatedCmdCancel=I.addEvent("onValidatedObjCancelRequested",function(){Ge()}),De.updateHighlightAttributes=I.addEvent("updateHighlightAttributes",function(e){W.updateHighlightAttributes(e)}),De.onDMUCheckRemoveRequested=I.addEvent("onDMUCheckRemoveRequested",function(e){z.updateCheckDisplay(e),ht(K,L)}),De.onRequirementAdded=I.addEvent("onRequirementAdded",function(t){z.addRequirement(t),(e=e||a.getReviewContext({viewer:R.getViewer()}))&&e.getValidation().getChecks().forEach(e=>{e.getPlmID()===t.checkId&&e.addJsonRequirement({type:"Requirement",id:t.requirementId,name:t.requirementTitle})})}),De.onDMUHighlightRemoveRequested=I.addEvent("onDMUHighlightRemoveRequested",function(e){W.updateHighlightDisplay(e),e.forEach(function(e){K.getMarkups().forEach(function(t){t.getChildren().forEach(function(t){if("ReviewMarkup"===t.getType())(t.getMarkupContent()?t.getMarkupContent().getSlides():[]).forEach(function(t){"Document"===J.getMainContextType()||"Specification Report"===J.getMainContextType()?t.getDMUObjects().forEach(function(t){t.getDMUComments().forEach(function(t){t.getAssociatedHighlightData().forEach(function(n){n.id===e&&t.removeAssociatedHighlightData({id:e})})})}):t.getAssociatedHighlightData().forEach(function(n){n.id===e&&t.removeAssociatedHighlightData({id:e})})});else if("Reply"===t.getType()){t.getChildren().forEach(function(t){(t.getMarkupContent()?t.getMarkupContent().getSlides():[]).forEach(function(t){t.getAssociatedHighlightData().forEach(function(n){n.id===e&&t.removeAssociatedHighlightData({id:e})})})})}})});let t=Ae.get(e);t&&t.remove(),Ae.delete(e)})}),De.onAttributeSaved=I.addEvent("onAttributeSaved",function(e){z.updateImpactedCheckDisplay(e),W.updateImpactedCheckDisplay(e),void 0!==e.status&&e.object&&ht(e.object.getParent(),L)}),De.onImpCheckFailed=I.addEvent("onImpCheckFailed",function(){W.deactiveButtons()}),De.onReviewCtxLoaded=I.addEvent("onReviewCtxLoaded",function(e){L.updateContextInformations(e),(J=K.getContext())&&(te.id=J.getSubContextID()?J.getSubContextID():J.getMainContextID(),te.type=J.getSubContextType()?J.getSubContextType():J.getMainContextType()),W&&W.setPanelQuickAccessCommands(ct())}),De.onHighlightPreviewUpdateRequested=I.addEvent("onHighlightPreviewUpdateRequested",function(e){W.updateSlidePreview({id:e.highlightId})}),De.onIssueTemplateOnlySet=I.addEvent("onIssueTemplateOnlySet",function(e){!0===e&&(N="issueTemplate",localStorage.setItem("issueCreationType","issueTemplate"))}),De.onHideShowThumbnailRequested=I.addEvent("onHideShowThumbnailRequested",function(){W.highlightUpdatePreview()}),De.onDMUSlideDelete=I.addEvent("onDMUSlideDelete",function(e){if("DMUSlide"===e.dmuObject.getType()){let t=e.dmuObject.getAssociatedHighlightData();for(let e=0;e<t.length;e++)W.updateSlidePreview(t[e]),I&&I.fireEvent("onPreviewDeleteOnHighlightRequested",{elementId:t[e].id})}}),De.onDMUObjectAttributeModified=I.addEvent("onDMUObjectAttributeModified",function(e){if(e&&"bMarkedAsDeleted"===e.attrName&&"DMUSlide"===e.dmuObject.getType()&&e.value){let t=e.dmuObject.getAssociatedHighlightData();for(let e=0;e<t.length;e++)W.updateSlidePreview(t[e]),I&&I.fireEvent("onPreviewDeleteOnHighlightRequested",{elementId:t[e].id})}}),De.onUpdateImpactedChecksList=I.addEvent("onUpdateImpactedChecksList",function(e){if("add"===e.mode)for(let t=0;t<e.checks.length;t++)z.addImpactedCheck({highlightRating:parseInt(e.highlight.getRating()),highlightTitle:e.highlight.getName(),highlightId:e.highlight.getPlmID(),checkId:e.checks[t].getPlmID(),checkStatus:parseInt(e.checks[t].getStatus()),checkTitle:e.checks[t].getName()}),W.addImpactedCheck({highlightRating:parseInt(e.highlight.getRating()),highlightTitle:e.highlight.getName(),highlightId:e.highlight.getPlmID(),checkId:e.checks[t].getPlmID(),checkStatus:parseInt(e.checks[t].getStatus()),checkTitle:e.checks[t].getName()});else for(let t=0;t<e.checks.length;t++)z.removeImpactedCheck({highlightId:e.checks[t].highlightId,checkId:e.checks[t].checkId}),W.removeImpactedCheck({highlightId:e.checks[t].highlightId,checkId:e.checks[t].checkId});W.deactiveButtons()}),De.onReviewObjectAttributesModified=I.addEvent("onReviewObjectAttributesModified",function(e){if(e&&e.object&&e.attr){const t=u.getRoots(a.getContextViewer({viewer:R.getViewer()})).length;if(e.attr[0]&&(e.attr[0].currentState||e.attr[0].sValidationState)&&e.object.getRestrictedEditionFlag&&"Activated"===e.object.getRestrictedEditionFlag()){if(L.setRestrictions($e()),z&&z.setRestrictions($e()),W&&W.setRestrictions($e()),Y.forEach(function(e){let t=Ae.get(e.id);t&&t.remove(),Ae.delete(e.id)}),t){L.updateValidatedList(K.getValidated().getValidatedInstanceNames()),L.updatePanel();let e=L.getSectionHeader(),t=ut();e.setSubMenuCommands(t)}else L.updateReviewPanelContent({reviewNoContextMode:!0});if(z){z.updatePanel();let e=z.getSectionHeader(),t=dt();e.setSubMenuCommands(t)}if(W)if(t){W.updatePanel();let e=W.getSectionHeader(),t=st();e.setSubMenuCommands(t)}else W&&W.updateReviewPanelContent({reviewNoContextMode:!0})}e.object.getValType&&"DMUValidationValidation"===e.object.getValType()&&e.attr.forEach(function(t){if(t.sValidationState&&ht(e.object,L),t.sValidationState||t.currentState){t.currentState&&($=t.currentState),ee&&(ee.destroy(),ee=null),L.setPanelQuickAccessCommands(pt()),z&&z.setPanelQuickAccessCommands(gt()),W&&W.setPanelQuickAccessCommands(ct());let e=ut();L.getSectionHeader().setSubMenuCommands(e)}})}}),De.onTransitionRequested=I.addEvent("setEditionMode",function(e){x=e.editionMode,L.setPanelReadOnlyFlag(e);var t=K.getContext();z?z.setPanelReadOnlyFlag(e):e.editionMode&&t&&t.getJsonContexts().length&&(z=ft()),W?W.setPanelReadOnlyFlag(e):e.editionMode&&t&&t.getJsonContexts().length&&(W=mt())}),De.onSetIssueCreationTypeRequested=I.addEvent("onSetIssueCreationTypeRequested",function(e){N=e.type,localStorage.setItem("issueCreationType",e.type)}),De.onValidationObjectDeleted=I.addEvent("onValidationObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject[0].getType&&"Markup"===e.dmuObject[0].getType())L&&L.removeMarkup(e);else if(e&&e.dmuObject[0]&&"DMUValidationExposedPresentation"===e.dmuObject[0].getType()){var t=e.dmuObject[0].getParent();if(t){var n,i=t.getRepRef(e.dmuObject[0].getAttribute("sRepRefMarkupID")),r=e.dmuObject[0].getPresentationSlideID(),o=t.getHighlights();for(let t=0;t<o.length;t++)if(o[t]!==e.dmuObject[0]&&o[t].getPresentationSlideID()===r){n=o[t];break}if(i){var a=i.getMarkupContent();if(a){var l,s=a.getSlides();for(let e=0;e<s.length;e++){if(s[e].getAttribute("sUuid")===r){l=s[e];break}if(s[e].getDMUObjects().length){var d=s[e].getDMUObjects();for(let e=0;e<d.length;e++){var u=d[e].getDMUComments?d[e].getDMUComments():[];if(u.length)for(let e=0;e<u.length;e++)if(u[e].getAttribute("sUuid")===r){l=u[e];break}}}}l&&n&&l.addAssociatedHighlightData({id:n.getPlmID(),rating:n.getRating(),hasIssue:Boolean(n._lIssuesIDs.length),hasImpactedChecks:Boolean((n.getAssociatedCheck()||[]).length)})}}}}}),De.tokenDMUValidatedCreated=I.addEvent("onReviewCtxUpdateOrDropValidated",function(e){if((J=K.getContext())&&J.getMainContextType()&&-1!==["Document","Specification Report","Requirement","Requirement Specification","Drawing","SIMItfSimulation","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_FeatureState"].indexOf(J.getMainContextType())){L.setContextType(J.getMainContextType());for(let i=0;i<e.validatedNames.length;i++){let r=J.getMainContextType();"R2V_FeatureState"!==r&&"Document"!==r&&"Specification Report"!==r&&"Drawing"!==r&&"DIFSheet"!==r&&"Requirement"!==r||L.setAddValidatedButtonVisibilityFlag(!0),"Requirement"!==t&&"R2V_FeatureState"!==r||L.setDropZoneVisibilityFlag(!1);var n=L.addValidatedObject(e.validatedNames[i],e.validatedIcons[i]);n.getMainDiv().setAdditionalDivVisibleFlag(!0),n.getMainDiv().setSelectedFlag(!0),Xe({name:e.validatedNames[i],id:e.validatedId,path:e.validatedPaths[i]})}"Requirement"!==J.getMainContextType()&&"DesignSight"!==J.getMainContextType()&&"Requirement Specification"!==J.getMainContextType()&&"DIFLayout"!==J.getMainContextType()&&I.removeEvent(De.tokenDMUValidatedCreated)}}),de=c.onPostRemove(function(){Oe&&!Pe?(L.unSelectAllExpanders(be),z&&z.unSelectAllExpanders(be)):Oe||Pe||xe||(L.unSelectAllExpanders(be),z&&z.unSelectAllExpanders(be),W&&W.unSelectAllExpanders(be)),xe=!1,c.get().length||(fe=-1),tt()})}this.addReview=function(){L||vt()},this.addCheck=function(e){p.empty(),O&&(e.evt=O,O=null),z&&z.addNewCheck(e),ht(K,L)},this.addHighlight=function(e){c.empty(),p.empty();var t=e.slideObject,n=[];if(W){var i={_repRefMarkupId:e.repRefMarkupId,_slideID:t.getAttribute("sUuid")};if(ye[e.id]=i,"DMUComment"===t.getType()){var r=C.giveDMUCommentsController({context:R});e.normalComment=r.getCommentRepresentation(t.getAttribute("sUuid"),"normal").getDiv(),e.lightComment=r.getCommentRepresentation(t.getAttribute("sUuid"),"light").getDiv();let i=t.getAttribute("sUuid");n=t.getReferencedCheckIds(),K.getAllRepRefs().forEach(e=>{let t=e.getMarkupContent();if(t){let e=t.getComments();e&&e.forEach(e=>{if(i===e.getParentCommentId()){var t=e.getReferencedCheckIds();if(t.length)for(let e=0;e<t.length;e++)-1===n.indexOf(t[e])&&n.push(t[e])}})}})}var o=[],a=K.getChecks();for(let e=0;e<n.length;e++)for(let t=0;t<a.length;t++)n[e]===a[t].getPlmID()&&o.push(n[e]);if(W.addNewHighlight(e),o.length){var s=l.getCommand("DMUSetImpactedCheckHdr",P.commandContext);s&&(s.setHighlightObject(e.highlightObject),s.setCheckObject(o),s.begin(),I.addEvent("onImpactedChecksCmdEnd",function(){I.fireEvent("onHighlightCreationCompleted",e)}))}else I.fireEvent("onHighlightCreationCompleted",e)}},this.addMarkup=function(e){L&&L.addNewMarkup(e),ke.push(e)},this.editMarkupName=function(e){if(T&&L&&e&&e.getPlmID){let t;for(let n=0;n<ke.length;n++)if(ke[n].id===e.getPlmID()){t=e.getPlmID();break}t&&L.editMarkupName(t)}},this.subscribe=function(e,t){if(e&&t)return A.subscribe({event:e},t)},this.setVisibleFlag=function(e){V&&(T=e,B&&B.setPanelVisibilityFlag(T),X&&X.setPanelVisibilityFlag(T),q&&q.setPanelVisibilityFlag(T))},this.setEditionMode=function(e){x=e},this.clear=function(){if(I){var e=Object.keys(De);for(let t=0;t<e.length;t++)I.removeEvent(De[e[t]])}De={},this.setActiveFlag(!1)},this.setActiveFlag=function(e){if(e!==V&&!(V=e)){if(L){var t=Object.keys(he);for(let e=0;e<t.length;e++)L.unsubscribe(he[t[e]]);he={},L.cleanPanel()}if(z){var n=Object.keys(ve);for(let e=0;e<n.length;e++)z.unsubscribe(ve[n[e]]);ve={},z.cleanPanel()}if(W){var i=Object.keys(Ce);for(let e=0;e<i.length;e++)W.unsubscribe(Ce[i[e]]);Ce={},W.cleanPanel()}B&&(B.setPanelVisibilityFlag(!1),B.clean()),X&&(X.setPanelVisibilityFlag(!1),X.clean()),q&&(q.setPanelVisibilityFlag(!1),q.clean()),c.unsubscribe(de),B=X=q=z=W=L=null}},this.updateReviewPanelContent=function(e){L&&L.updateReviewPanelContent(e)},this.getRestrictions=function(e){return $e(e)}}}),U=[];return t.singleton({init:function(){},getDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<U.length;n++)if(U[n].context===e.context){U[n].counter++,t=U[n].reviewController;break}if(e&&e.context&&!t){var n=new E(e);t={addReview:function(){if(n)return n.addReview()},addCheck:function(e){if(n)return n.addCheck(e)},addMarkup:function(e){if(n)return n.addMarkup(e)},addHighlight:function(e){if(n)return n.addHighlight(e)},setVisibleFlag:function(e){if(n)return n.setVisibleFlag(e)},setEditionMode:function(e){if(n)return n.setEditionMode(e)},clear:function(){n&&n.clear()},editMarkupName:function(e){n&&n.editMarkupName(e)},updateReviewPanelContent:function(e){if(n)return n.updateReviewPanelContent(e)},getRestrictions:function(e){if(n)return n.getRestrictions(e)}},U.push({context:e.context,reviewController:t,counter:1})}return t?Object.freeze(t):t},giveDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<U.length;n++)if(U[n].context===e.context){t=U[n].reviewController;break}return t?Object.freeze(t):t},unreferenceDMUReviewController:function(e){if(e&&e.context)for(let t=0;t<U.length;t++)if(U[t].context===e.context){U[t].counter--,U[t].counter<=0&&(U[t].reviewController.clear(),U.splice(t,1));break}}})}),define("DS/DMUBaseUIControllers/DMUUserExperienceManager",["UWA/Core","UWA/Class","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/DMUBaseExperience/DMUContextManager","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseExperience/DMUFactory","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUModelServices","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g,c,p,m,f,h,v){"use strict";return t.extend({init:function(t){var C,D=[],b=[],M=t.frmWindow,y=this,S=null,w={};function E(e){let t=s.getReviewContext({viewer:M.getViewer()});if(!t)return!1;let n=t.getValidation()&&"Activated"===t.getValidation().getRestrictedEditionFlag(),i=h.giveDMUCommentsController({context:M});const r=e=>e&&e.getMarkupOwner()&&e.getMarkupOwner().getParent()&&e.getMarkupOwner().getParent().getType();return e.every(e=>{if(!e||!e.getType)return!0;let o=e.getType();if("DMUMarkup"===o)return t.getRestrictions(e)["Reply"===r(e)?"reply":"markup"].canDelete;if(["DMUSlide","DMUComment","DMUFormat"].includes(o)||o.includes("DMUMarker")){const a=t.getRestrictions(e.getParent())["Reply"===r(e.getParent())?"reply":"markup"].canEdit;if("DMUComment"===o&&!e.isReply())return a&&!e.isReadOnly()&&(!n||i&&!i.hasReplies(e.getAttribute("sUuid")));if("DMUSlide"===o&&!e.getAttribute("sParentSlideID")){let t=f.giveDMUSlidesController({context:M});return a&&!e.isReadOnly()&&(!n||t&&!t.hasReplies(e.getAttribute("sUuid")))}return a}return!0})}function U(e){var t=s.getReviewContext({viewer:M.getViewer()});if(t){var n=s.getContextViewer({reviewContext:t});if(n){var i,o=r.get();if(!e.target||"textarea"!==e.target.type&&"input"!==e.target.type&&"P"!==e.target.tagName&&!e.target.isContentEditable)if("Delete"===e.key||46===e.keyCode){if(!o.length)return;for(var a=[],l=0;l<o.length;l++){var u=t.getDMUObjectFromPathElement(o[l].pathElement);u&&a.push(u)}if(1===a.length&&a[0].isTextEdited&&a[0].isTextEdited())return;let r=h.giveDMUCommentsController({context:M});if(r&&(a=a.concat(r.getSelectedComments()||[])),!E(a))return;if(e.shiftKey||!t.getCurrentSessionMarkup()||t.getCurrentSessionMarkup()&&!t.getCurrentSessionMarkup().getActiveFlag()||t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().getActiveFlag()&&t.getCurrentSessionMarkup().isReadOnly())if(i=d.getCommand("DMUQuickDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpQuickDelete",context:n.getExecutionContext?n.getExecutionContext():n.getCommandContext()});t.begin(),t.destroy(),t=null})}else if(i=d.getCommand("DMUDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpDelete",context:n.getCommandContext()});t.begin(),t.destroy(),t=null})}}else if(!e.ctrlKey||"c"!==e.key&&67!==e.keyCode)if(!e.ctrlKey||"x"!==e.key&&88!==e.keyCode)!e.ctrlKey||"v"!==e.key&&86!==e.keyCode||(i=d.getCommand("DMUPasteHdr",n.getCommandContext()))&&i.begin();else{if(!o.length)return;(i=d.getCommand("DMUCutHdr",n.getCommandContext()))&&i.begin()}else{if(!o.length)return;(i=d.getCommand("DMUCopyHdr",n.getCommandContext()))&&i.begin()}}}}this.clean=function(){if(M){var e;for(e=D.length-1;e>=0;e--)M.getContextualUIManager().unregister(D[e].type);for(e=b.length-1;e>=0;e--)M.getContextualUIManager().unregister(b[e].type);S&&document.removeEventListener("keyup",U),S=null,D.length=0,b.length=0,M=null}},this.pick=function(e,t){if(M)return e.x===w.x&&e.y===w.y&&t===w.type||(w={x:e.x,y:e.y,type:t||"mesh",path:M.getViewer().pick({xPix:e.x,yPix:e.y},t||"mesh",!0).path}),w.path};var x,O=[],P=[],R=!1,A=!1,I=!1;async function k(e,t,i,r,o){var a,l;if(e&&(t&&"DMUMarkup"===t.getType()?a=t:e.getParent?a=e.getParent():t.getParent&&(a=t.getParent()),a&&a.getType&&"DMUMarkup"===a.getType())){var s,d=e.getAttribute?e.getAttribute("sType"):e.type,g=t;if(g&&("Clipping"===d||"Section"===d)){var p=g.getDMUObjects("DMUSection"),f=g.getDMUObjects("DMUClipping");if(p&&p.length&&"Clipping"===d||f&&f.length&&"Section"===d)return void(p&&p.length?p[0]:f[0]).notifyWrongPaste("Clipping"===d);if(f&&f.length&&((s=f[0]).cleanNode&&s.cleanNode(),!1===o&&"Clipping"===d))return void f[0].displayWarning(e,g)}if(s||(s=u.buildComponent(i||d,t,a)),s){var h=e.getAttribute?{}:e;if(C||(C=new c({viewer:M.getViewer(),experience:a})),e.getAttribute&&(h=await m.getObjectDefinition(e)),s.importData(h,C,a),i&&s.setAttribute("sType",i),"Clipping"===d&&s.manageConstrutionItemModeafterClone&&s.manageConstrutionItemModeafterClone(),("Slide"===d||"Format"===d)&&s.getParent()!==e.getParent()){let t=e.getObjectOverloads(),n=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if("Slide"===d&&e.getPointedFormats&&e.getPointedFormats().length&&s.getPointedFormats&&!s.getPointedFormats().length){let i=e.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)("DMUCompare3D"!==i[e].getType()&&"DMUCompare2D"!==i[e].getType()||!n.length)&&s.addDMUObject(await k(i[e]));t=t.concat(e.getPointedFormats()[0].getObjectOverloads()),n.length||(n=e.getPointedFormats()[0].getDMUObjects("DMUCompare3D")?e.getPointedFormats()[0].getDMUObjects("DMUCompare3D"):e.getPointedFormats()[0].getDMUObjects("DMUCompare2D")),s.setAttribute("sPointedFormats",[])}if(t.length){let e=s.getObjectOverloads();for(l=e.length-1;l>=0;l--)s.removeObjectOverload(e[l]);for(l=0;l<t.length;l++)if(t[l].target){let e=s.getParent().getOrCreateOccurrenceOverloader({idPath:t[l].target.getOccurrenceIDPath()},!0),n={};t[l].state.cColor&&t[l].state.cColor.clone&&(n.cColor=t[l].state.cColor.clone()),null!==t[l].state.fOpacity&&void 0!==t[l].state.fOpacity&&(n.fOpacity=t[l].state.fOpacity),"boolean"==typeof t[l].state.bVisible&&(n.bVisible=t[l].state.bVisible),t[l].state.mTransfoMatrix&&t[l].state.mTransfoMatrix.clone&&(n.mTransfoMatrix=t[l].state.mTransfoMatrix.clone()),s.addObjectOverload({state:n,target:e})}}let i=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if(1===n.length&&1===i.length){let t=e.getParent().getAttribute("oLinksManager"),r=n[0].getAttribute("oSelections"),o="Compare2D"===n[0].getAttribute("sType")?n[0].getAttribute("oSheetIDs"):null;if(r&&r.length){let e=[];r.forEach(n=>{let i=t.getChildWithID(n.id);if(i){let n=i.idPath&&i.idPath.length?i.idPath:t.getOccurrenceIdPath(i.path),r=s.getParent().getOccurence({idPath:n},!0);r&&e.push({id:r.id})}}),2===e.length&&i[0].setAttribute("oSelections",e)}o&&o.length&&i[0].setAttribute("oSheetIDs",o)}}if(s.setAttribute("sID","-1"),s.setAttributes([{name:"sID",value:a.computeNewID()},{name:"sUuid",value:n.getUUID()}]),"Slide"===d||"Format"===d){var D,b=s.getDMUObjects();for(l=0;l<b.length;l++)b[l].setAttribute("sID","-1"),b[l].setAttributes([{name:"sID",value:a.computeNewID()},{name:"sUuid",value:n.getUUID()}]),b[l].afterImport(r);i?D=a.computeNewName({object:s,prefix:("DMUSlide"===s.getType()?v.slideDefaultName:v.formatDefaultName)+s.getAttribute("sName"),noSuffixIfPossible:!0,separator:"parenthesis"}):R||(D=a.computeNewName({object:s,prefix:s.getAttribute("sName")+v.copySuffix,noSuffixIfPossible:!0,separator:"parenthesis"})),D&&s.setAttribute("sName",D)}return s}}}function V(e,t){if(t&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())){var n,i,r,o=s.getReviewContext({viewer:M.getViewer()}),a=Object.keys(t);for(n=0;n<a.length;n++)if("camera"!==a[n]||t[a[n]])if("formatting"!==a[n]||t[a[n]])if("markers3D"!==a[n]||t[a[n]])if("markers2D"!==a[n]||t[a[n]])"format"!==a[n]||t[a[n]]||e.setAttribute("sPointedFormats",null);else for(i=(r=e.get2DMarkers()).length-1;i>=0;i--)e.removeDMUObject(r[i]);else for(i=(r=e.get3DMarkers()).length-1;i>=0;i--)e.removeDMUObject(r[i]);else{for(i=(r=e.getDMUObjects("DMUSection")).length-1;i>=0;i--)e.removeDMUObject(r[i]);for(i=(r=e.getDMUObjects("DMUClipping")).length-1;i>=0;i--)e.removeDMUObject(r[i]);for(i=(r=e.getObjectOverloads()).length-1;i>=0;i--)e.removeObjectOverload(r[i])}else e.updateEnvironmentOverload({target:o.getEnvironment(),state:o.getEnvironment().getEnvironmentInfo()})}}this.duplicateDMUElements=async function(e){if(e&&(e.elements||e.elementDefinitions)){var t=async function(t,n){var i=await k(t,e.parent,e.newType,e.markupRepRef);if(i){n&&n.length&&i.setAttributes(n);let t=i.getType();"DMUSlide"!==t&&"DMUFormat"!==t||e.parent["DMUSlide"===t?"addSlide":"addFormat"](i),e.parent?i.afterImport(e.markupRepRef):(i.refreshNode(),i.setTemporary(!0),"DMUMarker3DSpline"!==t&&"DMUMarker3DCloud"!==t&&"DMUMarker3DFreehand"!==t||i.updateProjectionPlaneDefinition({up:M.getViewer().currentViewpoint.getUpDirection(),right:M.getViewer().currentViewpoint.getSightDirection().cross(M.getViewer().currentViewpoint.getUpDirection())})),V(i,e.duplicationOptions)}return i},n=[];if(e.elements&&e.elements.length)for(var i=0;i<e.elements.length;i++)n.push(e.elements[i].getAttribute("sType"));else if(e.elementDefinitions&&e.elementDefinitions.length)for(var r=0;r<e.elementDefinitions.length;r++)n.push(e.elementDefinitions[r].type);u.initFactoryOf(M.getViewer(),n);var o,a,l=[],s=e.elements&&e.elements.length?e.elements:e.elementDefinitions;if(s&&s.length)for(o=0;o<s.length;o++)(a=await t(s[o],e.attributes&&e.attributes.length&&e.attributes[o]?e.attributes[o]:null))&&l.push(a);e.cb&&(l.length?e.cb({duplicatedElements:l}):e.cb({error:"Element not duplicated"}))}else e&&e.cb&&e.cb({error:"Element not duplicated"})},this.setCCPTarget=function(e){x=null,e&&e.getType&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())&&(x=e)},this.getCCPTarget=function(){return x},this.areOccurenceOverloadsCopied=function(){return 0!==P.length},this.copySelectedDMUElements=function(e){x=null,O.length=0,P.length=0,A=!1,I=!1;var t,n=r.get(),o=s.getReviewContext({viewer:M.getViewer()});if(o){var a=o.getCurrentSessionMarkup();if(a)for(var l=a.getCurrentSlide(),d=function(e,t){if(e){var n,r,o;if(e.state){var a=e.target.getOccurrencePathElement();e.state.mTransfoMatrix?(o=e.state.mTransfoMatrix.clone(),r=(new i.Matrix4).getInverse(a.getLastElement(!0).getMatrix()),n=(new i.Matrix4).multiplyMatrices(o,r)):e.state.mPosition&&(o=(d=a)&&d.getParentPath()?(new i.Matrix4).multiplyMatrices(d.getParentPath().getWorldMatrix(),d.getLastElement(!0).getMatrix()):null,r=(new i.Matrix4).getInverse(o),n=(new i.Matrix4).multiplyMatrices(r,a.getWorldMatrix()))}var s=!1;for(let i=0;i<P.length;i++)P[i].originalPath.isEqual(t)&&(P[i].overloads.push({slideOverload:e,parent:l,transfo:void 0,transfoMatrix:n}),s=!0);s||P.push({originalPath:t.clone(),overloads:[{slideOverload:e,parent:l,transfo:void 0,transfoMatrix:n}]})}var d},u=0;u<n.length;u++)if((t=o.getDMUObjectFromPathElement(n[u].pathElement))&&"DMUOccurrenceOverloader"!==t.getType()){var c=a;if(t.isReadOnly()||!t.isEditable())continue;"DMUSlide"===t.getType()?(A||(O.length=0),A=!0,I=!1):"DMUFormat"===t.getType()?(I||(O.length=0),A=!1,I=!0):((A||I)&&(O.length=0),A=!1,I=!1,c=l),O.push({object:t,parent:c})}else{var p=a.getOrCreateOccurrenceOverloader(n[u]);p&&d(l.getOverloadForTarget(p),n[u].pathElement),n[u].pathElement.getParentPath()&&g.isInstance(n[u].pathElement.getParentPath().getLastElement(!0))&&(p=a.getOrCreateOccurrenceOverloader({pathElement:n[u].pathElement.getParentPath()}))&&d(l.getOverloadForTarget(p),n[u].pathElement)}}y.refreshCCPCommandsAvailability(),R=e};let T=function(e){let t,n=e.getType(),r=M.getViewer().currentViewpoint.getUpDirection();if("DMUMarker3DArrow"===n){t=r.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vFirstPoint"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vFirstPoint").add(t),i=e.getAttribute("vSecondPoint").add(t);e.setAttribute("vFirstPoint",n),e.setAttribute("vSecondPoint",i)}else if("DMUMarker3DCircle"===n||"DMUMarker3DEllipse"===n){t=r.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vCenter"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vCenter").add(t);e.setAttribute("vCenter",n)}else if("DMUMarker3DRectangle"===n){t=r.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vPosition"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vPosition").add(t);e.setAttribute("vPosition",n)}else if("DMUMarker3DSpline"===n||"DMUMarker3DLine"===n||"DMUMarker3DFreehand"===n||"DMUMarker3DCloud"===n){let n=e.getAttribute("oPoints");n&&n.length&&(t=r.multiplyScalar(p.convertPixelToModel({coords:n[0].getAttribute("vPosition"),sizeInPixels:50,viewer:M.getViewer()})),n.forEach(e=>{let n=e.getAttribute("vPosition").add(t);e.setAttribute("vPosition",n)}))}else if("DMUMarker3DText"===n||"DMUMarker3DStamp"===n||"DMUMarker3DPicture"===n){t=r.multiplyScalar(p.convertPixelToModel({coords:e.getAttribute("vLeaderBreakPoint3D"),sizeInPixels:50,viewer:M.getViewer()}));let n=e.getAttribute("vLeaderBreakPoint3D").add(t);e.setAttribute("vLeaderBreakPoint3D",n)}else if("DMUMarker2DText"===n||"DMUMarker2DPicture"===n){t=new i.Vector2(0,-50);let n=e.getAttribute("vLeaderBreakPoint2D").add(t);e.setAttribute("vLeaderBreakPoint2D",n)}};this.pasteDMUElements=async function(t){var n,a,l,d;if(O&&O.length||P&&(!P||P.length)){var c=s.getReviewContext({viewer:M.getViewer()});if(c){var p=c.getCurrentSessionMarkup();if(p){var m=p.getCurrentSlide(),h=x||m;if(h&&h.isReadOnly())return;var v=h===m,C=[],D=function(e){for(var t=0;t<t.length;t++)if(C[t].isEqual(e))return;C.push(e.clone())},b=function(){if(r.empty(),C.length){var e=[],t=[];C.forEach(function(n){e.push({pathElement:n});var i=n.getLastElement(!0);i&&(!i.getDMUType||i.getDMUType&&"DMUSlide"!==i.getDMUType()&&"DMUFormat"!==i.getDMUType())&&t.push({pathElement:n})}),r.add(e),o.add(t)}M.getViewer().render()};if(O&&O.length){var y=O.slice(),S=A||I;if(S&&t&&!1===t.createNewSlide&&h&&("Slide"===h.getAttribute("sType")||"Format"===h.getAttribute("sType"))){y=[];var w,E,U=[],j=function(e,t){e&&e.length&&(y=y.concat(e.map(function(e){return{object:e,parent:t}})))};for(n=0;n<O.length;n++)if(O[n].object&&O[n].object.getDMUObjects){if(t.formatting){j(O[n].object.getDMUObjects("DMUSection"),O[n].object),j(O[n].object.getDMUObjects("DMUClipping"),O[n].object),h.getDMUObjects("DMUCompare3D").length||j(O[n].object.getDMUObjects("DMUCompare3D"),O[n].object);let e=O[n].object.getDMUObjects("DMUCompare2D");if(e&&e.length){!h.getDMUObjects("DMUCompare2D").length&&e[0].getAttribute("oSheetIDs")&&h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty[0]&&"string"==typeof h.getEnvironmentOverload().state.sFocusProperty[0]&&e[0].getAttribute("oSheetIDs")[0]&&-1!==h.getEnvironmentOverload().state.sFocusProperty[0].indexOf(e[0].getAttribute("oSheetIDs")[0].id)&&j(e,O[n].object)}for(a=(w=O[n].object.getObjectOverloads()).length-1;a>=0;a--){for(E=!0,l=0;l<U.length;l++)U[l].target===w[a].target&&(U[l].state=w[a].state,E=!1);E&&U.push(w[a])}}t.markers3D&&j(O[n].object.get3DMarkers(),O[n].object),t.markers2D&&j(O[n].object.get2DMarkers(),O[n].object)}if(S=!1,t.camera){let t=O[O.length-1].object.getEnvironmentOverload(),n={};Object.keys(t.state).forEach(i=>{t.state[i]&&t.state[i].clone?n[i]=t.state[i].clone():n[i]=e.clone(t.state[i])}),h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty.length&&(n.sFocusProperty=h.getEnvironmentOverload().state.sFocusProperty.slice()),h.updateEnvironmentOverload({state:n,target:h.getEnvironmentOverload().target})}if(t.formatting){for(n=0;n<U.length;n++)h.addObjectOverload(U[n]);h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:U})}t.format&&h.setAttribute("sPointedFormats",O[O.length-1].object.getAttribute("sPointedFormats"))}var F=[];for(l=0;l<y.length;l++)F.push(y[l].object.getAttribute("sType"));u.initFactoryOf(M.getViewer(),F),h||(h=p);var N,L=[];if(h){if(h.isReadOnly())return;if(S){for(n=y.length-1;n>=0;n--){var B;if("Slide"===y[n].object.getAttribute("sType")&&c.getUIManager().getFormatEditionModeFlag()&&(B="Format"),"Format"!==y[n].object.getAttribute("sType")||c.getUIManager().getFormatEditionModeFlag()||(B="Slide"),N=await k(y[n].object,p,B)){let e;if(L.push(N),"DMUSlide"===h.getType()){let t=p,n=function(){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(e=n.getRepRef(),t=e.getMarkupContent())};if(N.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")!==N.getAttribute("sParentSlideID")||!h.getAttribute("sParentSlideID")?(N.setAttribute("sParentSlideID",void 0),t&&t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType()&&n()):!N.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&n(),t){var H,W=t.getSlides();for(d=0;d<W.length;d++)if(W[d]===h){H=d+1;break}t.addSlide(N,H)}}else if("DMUFormat"===h.getType()){var q;N.setAttribute("sParentSlideID",void 0);var _=p.getFormats();for(d=0;d<_.length;d++)if(_[d]===h){q=d+1;break}p.addFormat(N,q)}else if(c.getUIManager().getFormatEditionModeFlag())N.setAttribute("sParentSlideID",void 0),p.addFormat(N);else{let t=p;if(N.getAttribute("sParentSlideID")&&(N.setAttribute("sParentSlideID",void 0),t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType())){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(t=(e=n.getRepRef()).getMarkupContent())}t&&t.addSlide(N)}N.afterImport(e),V(N,t)}}if(L&&L.length){var z=f.giveDMUSlidesController({context:M});z&&z.setActiveSlide(L[0])}}else{if("DMUSlide"!==h.getType()&&"DMUFormat"!==h.getType())return;for(n=y.length-1;n>=0;n--)y[n].object&&(N=await k(y[n].object,h,void 0,void 0,Boolean(t)))&&(O.forEach(e=>{e.parent.getAttribute("sUuid")===h.getAttribute("sUuid")&&T(N)}),N.afterImport(),L.push(N))}h.refreshNode(),R&&O.forEach(function(e){"DMUSlide"===e.object.getType()||"DMUFormat"===e.object.getType()?h!==e.object&&"DMUSlide"===e.object.getType()?p.removeSlide(e.object):h!==e.object&&"DMUFormat"===e.object.getType()&&p.removeFormat(e.object):e.parent.removeDMUObject(e.object)})}if(v)for(n=0;n<L.length;n++)D(g.buildPathElement(L[n].getNode()));R&&(O.length=0,A=!1,I=!1,R=!1),x=null,b()}if(h&&P&&P.length){if(t&&!t.graphicProps&&!t.positions)return;var X=[],G=r.get();for(n=0;n<G.length;n++)G[n].pathElement.getLastElement(!0).getDMUType||X.push(G[n].pathElement.clone());var K=function(e){var n,r,o,a=h.getOverloadForTarget(e.slideOverload.target),l={},s=e.slideOverload.target.getOccurrencePathElement();if(a)for(n=Object.keys(a.state),o=0;o<n.length;o++)r=a.state[n[o]],l[n[o]]=r.clone?r.clone():r;for(n=Object.keys(e.slideOverload.state),o=0;o<n.length;o++)(!t||t&&t.graphicProps&&"cColor"===n[o]||t&&t.graphicProps&&"bVisible"===n[o]||t&&t.graphicProps&&"fOpacity"===n[o]||t&&t.positions&&("mPosition"===n[o]||"mTransfoMatrix"===n[o]))&&("mPosition"===n[o]||"mTransfoMatrix"===n[o]?l.mTransfoMatrix=(new i.Matrix4).multiplyMatrices(s.getLastElement(!0).getMatrix(),e.transfoMatrix):(r=e.slideOverload.state[n[o]],l[n[o]]=r.clone?r.clone():r));h.addObjectOverload({target:e.slideOverload.target,state:l}),h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:[{target:e.slideOverload.target,state:l}]})},J=!1;if(!X.length&&h&&h.addObjectOverload)for(n=P.length-1;n>=0;n--)for(a=P[n].overloads.length-1;a>=0;a--)h!==P[n].overloads[a].parent&&(K(P[n].overloads[a]),D(P[n].overloads[a].slideOverload.target.getOccurrencePathElement()),J=!0);else if(h&&h.addObjectOverload&&X.length){var Z,Q=0,Y=[],$=function(e,n){for(var r=Object.keys(e.slideOverload.state),o=0;o<r.length;o++)if(!t||t&&t.graphicProps&&"cColor"===r[o]||t&&t.graphicProps&&"bVisible"===r[o]||t&&t.graphicProps&&"fOpacity"===r[o]||t&&t.positions&&("mPosition"===r[o]||"mTransfoMatrix"===r[o]))if(J=!0,"mPosition"===r[o]||"mTransfoMatrix"===r[o]){for(var a=n.clone();a&&!g.isInstance(a.getLastElement(!0));)a=a.getParentPath();if(!a)for(a=n.clone();a&&!g.isReference(a.getLastElement(!0))&&!g.isRepReference(a.getLastElement(!0));)a=a.getParentPath();if(a&&(Z=p.getOrCreateOccurrenceOverloader({pathElement:a},!0))){var l=(new i.Matrix4).multiplyMatrices(Z.getOccurrencePathElement().getLastElement(!0).getMatrix(),e.transfoMatrix);Z.setAttribute("mTransfoMatrix",l),Y.push({target:Z,state:{mTransfoMatrix:l}}),D(n)}}else if(Z=p.getOrCreateOccurrenceOverloader({pathElement:n},!0)){Z.setAttribute(r[o],e.slideOverload.state[r[o]]);var s={};s[r[o]]=e.slideOverload.state[r[o]],Y.push({target:Z,state:s}),D(n)}};for(a=0;a<X.length;a++){for(l=0;l<P[Q].overloads.length;l++)$(P[Q].overloads[l],X[a]);++Q>=P.length&&(Q=0)}Y.length&&s.giveEventsController({viewer:M.getViewer()}).fireEvent("onDMUOverloadPropertiesChanged",{overloads:Y})}if(J){if(R)for(n=P.length-1;n>=0;n--)for(a=P[n].overloads.length-1;a>=0;a--)P[n].overloads[a].parent.removeObjectOverload(P[n].overloads[a].slideOverload);v&&h.refreshNode()}R&&(P.length=0,R=!1),x=null,b()}s.giveEventsController({viewer:M.getViewer()}).fireEvent("onSaveRequested",{})}}}},this.refreshCCPCommandsAvailability=function(){var e=s.getReviewContext({viewer:M.getViewer()}),t=s.getContextViewer({viewer:M.getViewer()});if(t&&e){var n=e.getCurrentSessionMarkup(),i=n&&n.isVisible()&&!n.isReadOnly(),o=i?e.getUIManager().getSelectedObjects():[],a=function(e,a){var l=!1;if(i&&!o.length)for(var s=r.get(),u=0;u<s.length;u++){var c=n.getOrCreateOccurrenceOverloader(s[u]);if(c&&c.isOverloadedInCurrentSlide()){l=!0;break}if(s[u].pathElement.getParentPath()&&g.isInstance(s[u].pathElement.getParentPath().getLastElement(!0))&&(c=n.getOrCreateOccurrenceOverloader({pathElement:s[u].pathElement.getParentPath()}))&&c.isOverloadedInCurrentSlide()){l=!0;break}}var p=d.getCommand(e+"DMUCopyHdr",t.getCommandContext());p&&(o.length||l?p.enable():p&&p.disable(),!(p=d.getCommand(e+"DMUCutHdr",t.getCommandContext()))||!o.length&&!l||a&&!a.canEdit?p&&p.disable():p.enable(),p=d.getCommand(e+"DMUPasteHdr",t.getCommandContext()),i&&p&&(O.length||P.length)&&(!a||a.canEdit)?p.enable():p&&p.disable(),(p=d.getCommand(e+"DMUPasteSpecialHdr",t.getCommandContext()))&&(!i||a&&!a.canEdit||(1!==O.length||"DMUSlide"!==O[0].object.getType()&&"DMUFormat"!==O[0].object.getType())&&!P.length?p.disable():p.enable()))};const l=n&&n.getMarkupOwner(),s=l&&l.getParent()&&"Reply"===l.getParent().getType(),u=e&&e.getRestrictions(s?l.getParentRepRef():l).markup;a("",u),a("Format_",u)}},this.refreshCommandsAvailability=(()=>{y.refreshCCPCommandsAvailability();let e=f.giveDMUSlidesController({context:M});e&&e.updateHeaderCommandsAvailability();let t=h.giveDMUCommentsController({context:M});t&&t.updateHeaderCommandsAvailability()}),this.refreshCtxCommandsAvailability=function(){var e=s.getReviewContext({viewer:M.getViewer()}),t=s.getContextViewer({viewer:M.getViewer()});if(t&&e){var n=e.getCurrentSessionMarkup();let r=e.getUIManager().getSelectedObjects()||[];var i=h.giveDMUCommentsController({context:M});i&&(r=r.concat(i.getSelectedComments()||[]));const o=E(r);let a=d.getCommand("DMUDeleteHdr",t.getCommandContext());a&&(o?a.enable():a.disable()),(a=d.getCommand("Format_DMUDeleteHdr",t.getCommandContext()))&&(o?a.enable():a.disable());const l=e&&e.getRestrictions(n);let s=r.map(e=>e.getType());s.includes("DMUMarkup")&&(a=d.getCommand("DMURenameMarkupHdr",t.getCommandContext()))&&(!l||l.markup.canEdit?a.enable():a.disable()),s.includes("DMUSlide")&&(a=d.getCommand("DMUFormatChooserHdr",t.getCommandContext()))&&(!l||l.markup.canEdit?a.enable():a.disable())}},this.registerContextualMenu=function(e){if(M&&!function(e){for(var t=0;t<b.length;t++)if(b[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:M.getViewer()});if(!t)return;S||(S=!0,document.addEventListener("keyup",U)),M.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualMenuReady:function(t,n){y.refreshCtxCommandsAvailability(e.type);var i,o=M.getExecutionContext||M.getContextualUIManager()._executionContext,l=o?[]:{cmdList:[]};if(t&&t.event&&t.event.getCurrentPosition?((i=t.event.getCurrentPosition(M.getViewer().canvas)).x*=window.devicePixelRatio,i.y*=window.devicePixelRatio):i=o?{x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio}:{x:n.XmousePositionWithDevPxRatio,y:n.YmousePositionWithDevPxRatio},0===y.pick(i,"mesh").length&&0===a.get().length)return l;var d=s.getReviewContext({viewer:M.getViewer()});if(d){var u=d.getUIManager().getSelectedObjects(),g=r.get();if(g.length&&u.length===g.length){for(var c=0;c<u.length;c++)if(-1!==u[c].getType().indexOf(e.type))return u[c].getSharedContextualMenuCommandList?o?u[c].getSharedContextualMenuCommandList(u):{cmdList:u[c].getSharedContextualMenuCommandList(u)}:l}else if(g.length&&"DMUComment"===e.type){var p=h.giveDMUCommentsController({context:M});if(p){var m=p.getSelectedComments();if(m&&m.length===g.length)for(var f=0;f<m.length;f++)if("DMUComment"===m[f].getType())return o?m[f].getSharedContextualMenuCommandList(m):{cmdList:m[f].getSharedContextualMenuCommandList(m)}}}else if(g.length)for(let t=0;t<g.length;t++){if("Checks"===e.type&&g[t].pathElement.getLastElement().getDMUType&&"Checks"===g[t].pathElement.getLastElement().getDMUType()){let e=[g[t].pathElement.getLastElement().getOwner()];return o?e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):[]:{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):void 0}}if(g.length&&"Highlights"===e.type&&g[t].pathElement.getLastElement().getDMUType&&"Highlights"===g[t].pathElement.getLastElement().getDMUType()){let e=[g[t].pathElement.getLastElement().getOwner()];return o?e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):[]:{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,M.getViewer()):void 0}}}}return l},onCtxMenuPostXmlLoadingCB:function(){var t=s.getReviewContext({viewer:M.getViewer()});if(t){var n=t.getUIManager().getSelectedObjects(),i=r.get();if(i.length&&n.length===i.length)for(var o=0;o<n.length;o++)if((-1!==n[o].getType().indexOf(e.type)||n[o].getType().includes("DMUComment")&&"DMUMarker"===e.type)&&n[o].setCheckCmdHdrState&&n[o].cmdHdrState_list)return n[o].setCheckCmdHdrState(n[o].cmdHdrState_list),Promise.resolve()}return Promise.resolve()}})}var n,i;n=e.type,(i=b.findIndex(function(e){return e.type===n}))>=0?b[i].count++:b.push({type:n,count:1})},this.unregisterContextualMenu=function(e){var t=b.findIndex(function(t){return t.type===e.type});t>=0&&(b[t].count--,0===b[t].count&&(b.splice(t,1),M.getContextualUIManager().unregister(e.type)))},this.registerContextualBar=function(e){if(M&&!function(e){for(var t=0;t<D.length;t++)if(D[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:M.getViewer()});if(!t)return;M.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:function(){var t=s.getReviewContext({viewer:M.getViewer()}),n=M.getExecutionContext||M.getContextualUIManager()._executionContext,i=n?void 0:{cmdList:[]};if(t){var o=t.getUIManager().getSelectedObjects(),a=r.get();if(a.length&&o.length===a.length){for(var d=0;d<o.length;d++)if(-1!==o[d].getType().indexOf(e.type)||o[d].getType().includes("DMUComment")&&"DMUMarker"===e.type)return o[d].getSharedContextualCommandList?n?{WAfrCtxBarRow1:{model:o[d].getSharedContextualCommandList(o)}}:{cmdList:o[d].getSharedContextualCommandList(o)}:i}else if("DMUMarker"===e.type&&!t.isReadOnly()&&!l.getTouchMode()){var u=window.getSelection();if(u&&""!==u.toString())for(var g=0,c=u.getRangeAt(0).commonAncestorContainer;c&&g<15;){if(c===M.getViewer().currentViewpoint.divCameraCSSElement)return n?{WAfrCtxBarRow1:{model:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]}}:{cmdList:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"],type:"handler",identifier:"DMUCommentCmdHdr"}]};c=c.parentNode,g++}}}return i}})}var n,i;n=e.type,(i=D.findIndex(function(e){return e.type===n}))>=0?D[i].count++:D.push({type:n,count:1})},this.unregisterContextualBar=function(e){var t=D.findIndex(function(t){return t.type===e.type});t>=0&&(D[t].count--,0===D[t].count&&(D.splice(t,1),M.getContextualUIManager().unregister(e.type)))}}})}),define("DS/DMUBaseUIControllers/DMUReviewContextInitializer",["UWA/Class","UWA/Utils","DS/CATWebUXComponents/DMUCommandsManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/DMUBaseExperience/DMUExperience","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUUserExperienceManager","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewController","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIManipulators/DMUBaseRepManipulator","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseUIControllers/DMUReqCompareController","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUToolsClipping","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g,c,p,m,f,h,v,C,D,b,M,y,S,w,E,U,x,O,P,R){"use strict";let A=e.extend({init:function(e){var s,U,A,I,k,V=e.context.getFrameWindow(),T=this,j=!1,F=[],N=!1,L=!0,B={},H={};let W;var q,_,z,X,G=d.getContextViewer({viewer:V.getViewer()}),K=d.giveEventsController({viewer:V.getViewer()}),J=null;let Z=null;var Q,Y,$,ee,te,ne,ie,re,oe,ae=null;let le,se,de,ue,ge=P.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/");g.addManager({name:"DMUUserExperienceManager",context:V,manager:new u({frmWindow:V})});let ce,pe=g.getManager({name:"DMU2DSheetManager",context:V}),me=pe&&pe.isADocumentDisplayed()&&pe.getDocumentType()||"3D";function fe(e){if(e&&e.completed)if(e.arrayPath){var t=X?X.getCommentTooltip(e.arrayPath[0].getLastElement(!0)):null;if(!(t||e.arrayPath&&1===e.arrayPath.length&&e.token&&e.arrayPath[0].getLastElement(!0).getTooltip))return void e.completed();e.completed({token:e.token,div:t||e.arrayPath[0].getLastElement(!0).getTooltip(),interactiveContent:!0})}else if(e.element&&_&&_.length){var n=_.findIndex(function(t){return t.div===e.element});n>=0?e.completed({token:e.token,div:_[n].content,interactiveContent:!0}):e.completed()}else e.completed()}function he(e){for(var t=e;t&&t.getLastElement(!0).getPickParent();)t=t.getParentPath();return t}function ve(e){if(J&&e&&e.length){let n=0;for(var t=0;t<e.length;t++)"DMUSlide"!==e[t].getType()&&"DMUFormat"!==e[t].getType()||(e[t].getActiveFlag()&&!N&&"DMUSlide"===e[t].getType()||N&&"DMUFormat"===e[t].getType()?(J.addSlide(e[t],e[t].getAttribute("sParentSlideID")?n:null),e[t].getAttribute("sParentSlideID")||n++):J.removeSlide(e[t]))}}function Ce(t){if(J&&t&&t.dmuObject&&e.reviewContext&&e.reviewContext.getActiveFlag()){var n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup();if(n&&("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType())){let i=e.reviewContext.getValidation();i&&(t.mkpRepRef?t.dmuObject.parentID=t.mkpRepRef.getPlmID():t.dmuObject.parentID=i.getCurrentMarkup()?i.getCurrentMarkup().getRepRef().getPlmID():null),t.dmuObject.getActiveFlag()&&(!N&&"DMUSlide"===t.dmuObject.getType()||N&&"DMUFormat"===t.dmuObject.getType())?J.addSlide(t.dmuObject,function(e,t){if(e&&t)for(var n="DMUSlide"===e.getType()?t.getSlides():t.getFormats(),i=0;i<n.length;i++)if(n[i]===e)return i}(t.dmuObject,n),n):J.removeSlide(t.dmuObject)}}}function De(){le&&clearTimeout(le),le=setTimeout(()=>{if(le=null,V){let e=V.getContextualUIManager();V.getExecutionContext||e._executionContext?e._showContextualBar({hideWithDistance:!0,backMAB:function(){i.empty()}}):e.showContextualBar({hideWithDistance:!0,backMAB:function(){i.empty()}})}},100)}function be(e){if(V){var t=V.getActionBar();t&&t.MAB&&!0===t.MAB.state.visible?a.publish({event:"/"+V.options.context+"/WUX/ContextualBar/Hide/"}):e||V.getContextualUIManager().getContextualBar().hide()}}var Me,ye,Se,we;function Ee(e){if(!V)return;let t=V.getViewer();t&&t.getCursor().contains("WebViewerRotate")&&(e&&void 0===e.handleType?t.canvas.setStyle("cursor","url("+ge+"DMUPositionCursorHL.png) 10 10, auto"):e&&"Center"===e.handleType?t.canvas.setStyle("cursor","move"):e&&"Rot"===e.handleType?t.canvas.setStyle("cursor","url("+ge+"DMURotationCursorSel.png) 16 16, auto"):t.canvas.setStyle("cursor","crosshair"))}function Ue(e){if(setTimeout(function(){Ee(e)},100),Q&&Q.length){re||(re=new M(V.getViewer())),e&&e.event&&e.event.from&&(de&&l.removeEventFromToken(de),de=l.addEvent(e.event.from[0].view,"onPrimaryPointerUpUnique",()=>{null!=de&&(l.removeEventFromToken(de),de=null),re.setTextSelectionFlag(!0),re.setTouchPanActive(!0)})),re.setTextSelectionFlag(!1),re.setTouchPanActive(!1);for(var t=0;t<Q.length;t++)"DMUMarker3DFreehand"!==Q[t].dmuObj.getType()&&(Q[t].manipulator?Q[t].manipulator.onBeginManipulateCB(e):Q[t].repManip&&Q[t].repManip.onBeginManipulateCB(e));ce&&ce.onBeginManipulateCB(e)}}function xe(e){if(Ee(e),Q&&Q.length&&re){var t,n=e&&e.translationVector2D&&(!te||!te.length),i=e&&e.translationVector2D&&(e.ctrlKey||void 0===e.ctrlKey&&e.event&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.ctrlKey);re.updateManipulationData(e);for(var a=0;a<Q.length;a++){var l=Q[a].dmuObj.getType();n&&"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&(te||(te=[]),t||(t=[]),"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&t.push(Q[a].dmuObj)),Q[a].manipulator?(Q[a].dmuObj.setGhostMode(i),"DMUMarker3DFreehand"!==Q[a].dmuObj.getType()&&(Q[a].manipulator.onManipulateCB(e),Y||Q[a].manipulator.setHandlesVisibility(!1))):Q[a].repManip&&Q[a].repManip.onManipulateCB(e)}if(ce&&(ce.onManipulateCB(e),Y||ce.setHandlesVisibility(!1)),n&&t&&t.length)re.addToListener("Control",xe),re.activate(),g.getManager({name:"DMUUserExperienceManager",context:V}).duplicateDMUElements({elements:t,cb:function(e){e&&e.duplicatedElements&&(te=e.duplicatedElements.slice())}});if(i){if(!ee&&te&&te.length&&oe){ee=!0,z&&z.setCursors({canvas:"copy",pages:"copy"});for(var s=0;s<te.length;s++)oe.addChild(te[s].getNode())}}else if(ee&&te&&te.length&&oe){z&&z.setCursors({canvas:"move",pages:"move"});for(var d=0;d<te.length;d++)oe.removeChild(te[d].getNode());ee=!1}Y||(o.empty(),Y=r.get().slice(),r.empty(),X&&X.setGuidelineVisibility(!1)),be(),V.getViewer().render()}}async function Oe(n){if(Q&&Q.length&&re){if(null!=de&&(l.removeEventFromToken(de),de=null),re.setTextSelectionFlag(!0),re.setTouchPanActive(!0),re.remove(),te&&te.length&&oe){for(var i=0;i<te.length;i++)oe.removeChild(te[i].getNode()),te[i].remove();te=null}if(ee){for(var o=e.reviewContext.getCurrentSessionMarkup(),a=g.getManager({name:"DMUUserExperienceManager",context:V}),s=[],d=0;d<Q.length;d++)"DMUMeasure"!==Q[d].dmuObj.getType()&&"DMUCommentPositioned"!==Q[d].dmuObj.getType()&&s.push(Q[d].dmuObj);s.length&&await a.duplicateDMUElements({elements:s,parent:o.getCurrentSlide(),cb:function(e){if(e&&e.duplicatedElements)for(var n=0;n<e.duplicatedElements.length;n++)e.duplicatedElements[n].setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:t.getUUID()}])}}),ee=!1}for(var u=0;u<Q.length;u++)Q[u].dmuObj.setGhostMode(!1),"DMUMarker3DFreehand"!==Q[u].dmuObj.getType()&&(Q[u].manipulator?(Q[u].manipulator.onEndManipulateCB(n),Q[u].manipulator.setHandlesVisibility(!0)):Q[u].repManip&&Q[u].repManip.onEndManipulateCB(n));ce&&(ce.setHandlesVisibility(!0),ce.onEndManipulateCB(n)),Y&&Y.length&&r.add(Y),Y=null,X&&X.setGuidelineVisibility(!0),De(),z&&z.restoreCursors()}}function Pe(){var e=C.checkIfCommandIsRunning(V.getViewer());if(e){var t=C.getCurrentCommand(V.getViewer());"measureCmdHdr"!==t&&"measure2DCmdHdr"!==t&&"measure3CmdHdr"!==t&&"measure2CmdHdr"!==t&&"thicknessCmdHdr"!==t&&"sectionCmdHdr"!==t&&"section2CmdHdr"!==t||(e=!1)}return e}function Re(t){if(t){if(!oe)for(var n=V.getViewer().getNodes(),i=0;i<n.length;i++)if("DecorationBag"===n[i].name){oe=n[i];break}require(["DS/DMUMarkerManipulators/DMUMarkerRecManipulator","DS/DMUMarkerManipulators/DMUMarkerLineManipulator","DS/DMUMarkerManipulators/DMUMarkerFreehandManipulator","DS/DMUMarkerManipulators/DMUMarkerCircleManipulator","DS/DMUMarkerManipulators/DMUMarkerArrowManipulator","DS/DMUMarkerManipulators/DMUMarkerLabelManipulator","DS/DMUMarkerManipulators/DMUMarkerCloudManipulator"],function(t,n,i,r,o,a,l){Se=function(s){if(s){we&&(clearTimeout(we),we=null);var d=[];if(0===(d=s.filter(function(e){return e.getType().includes("Marker")||"DMUMeasure"===e.getType()||"DMUCommentPositioned"===e.getType()})).length){if(Q&&Q.length){for(var u=0;u<Q.length;u++){if(Q[u].manipulator&&"DMUMarker3DFreehand"!==Q[u].dmuObj.getType()&&Q[u].manipulator.remove(),Q[u].repManipTokens&&Q[u].repManipTokens.length)for(var g=0;g<Q[u].repManipTokens.length;g++)Q[u].repManip.unsubscribe(Q[u].repManipTokens[g]);Q[u]=null}ce&&(ce.remove(),ce=null),Q=null,$&&K&&(ne&&ne.destroy(),K.fireEvent("onSaveRequested"),$=!1)}}else{var c=function(){var s=[];if(Q||(Q=[]),d.forEach(function(d){var u=Q.findIndex(function(e){return e.dmuObj.getNode().id===d.getNode().id});-1===u?(!function(s){var d=s.getType();const u=s.getParent(),g=e.reviewContext.getRestrictions(u);if(!Pe()&&!s.isReadOnly()&&s.isEditable()&&s.getAttribute("bVisible")&&(g.markup.canEdit||g.reply.canEdit)){var c,p=s.getNode().getRepManipulator();p&&("DMUMarker3DRectangle"===d||"DMUMarker3DEllipse"===d||"DMUMarker3DSpline"===d?(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:new t({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe})},Q.push(c)):"DMUMarker3DCircle"===d?(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:new r({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe})},Q.push(c)):"DMUMarker3DLine"===d?(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:new n({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe})},Q.push(c)):"DMUMarker3DFreehand"===d?(ce?ce.registerMarker(s):ce=new i({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe}),c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:ce},Q.push(c)):"DMUMarker3DCloud"===d?(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:new l({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe})},Q.push(c)):"DMUMarker3DArrow"===d?(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:new o({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe})},Q.push(c)):"DMUMarker2DText"===d||"DMUMarker3DStamp"===d||"DMUMarker3DText"===d||"DMUMarker2DPicture"===d||"DMUMarker3DPicture"===d||"DMUMeasure"===d?(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)],manipulator:new a({viewer:V.getViewer(),dmuObj:s,onBeginManipulateCB:Ue,onManipulateCB:xe,onEndManipulateCB:Oe})},Q.push(c)):"DMUCommentPositioned"===d&&(c={dmuObj:s,repManip:p,repManipTokens:[p.subscribe("onMarkerRepBegingManipulate",Ue),p.subscribe("onMarkerRepManipulate",xe),p.subscribe("onMarkerRepEndManipulate",Oe)]},Q.push(c)))}}(d),s.push(Q.length-1)):s.push(u)}),s.length!==Q.length){for(var u=0;u<Q.length;u++)if(!s.includes(u)){if(Q[u].manipulator&&("DMUMarker3DFreehand"===Q[u].dmuObj.getType()?Q[u].manipulator.unregisterMarker(Q[u].dmuObj):Q[u].manipulator.remove()),Q[u].repManipTokens&&Q[u].repManipTokens.length)for(var g=0;g<Q[u].repManipTokens.length;g++)Q[u].repManip.unsubscribe(Q[u].repManipTokens[g]);Q[u]=void 0}ce&&!ce.registeredMarkersLength()&&(ce.remove(),ce=null),Q.sort(),Q=Q.slice(0,s.length)}};Pe()?we=setTimeout(c):c()}}}})}else Se=function(e){if(e){we&&(clearTimeout(we),we=null);var t=[];if(0===(t=e.filter(function(e){return"DMUMeasure"===e.getType()})).length){if(Q&&Q.length){for(var n=0;n<Q.length;n++){if(Q[n].repManipTokens&&Q[n].repManipTokens.length)for(var i=0;i<Q[n].repManipTokens.length;i++)Q[n].repManip.unsubscribe(Q[n].repManipTokens[i]);Q[n]=null}Q=null}}else{var r=function(){Q||(Q=[]);var e=[];if(t.forEach(function(t){var n=Q.findIndex(function(e){return e.dmuObj.getNode().id===t.getNode().id});-1===n?(!function(e){if(!Pe()&&!e.isReadOnly()&&e.isEditable()&&e.getAttribute("bVisible")){var t,n=e.getNode().getRepManipulator();n&&(t={dmuObj:e,repManip:n,repManipTokens:[n.subscribe("onMarkerRepBegingManipulate",Ue),n.subscribe("onMarkerRepManipulate",xe),n.subscribe("onMarkerRepEndManipulate",Oe)]},Q.push(t))}}(t),e.push(Q.length-1)):e.push(n)}),e.length!==Q.length){for(var n=0;n<Q.length;n++)if(!e.includes(n)){if(Q[n].repManipTokens&&Q[n].repManipTokens.length)for(var i=0;i<Q[n].repManipTokens.length;i++)Q[n].repManip.unsubscribe(Q[n].repManipTokens[i]);Q[n]=void 0}Q.sort(),Q=Q.slice(0,e.length)}};Pe()?we=setTimeout(r):r()}}}}function Ae(){var t,n,o,a=F.slice(),l=[];if(F.forEach(function(e){e.setInEdition(!1),"DMUSection"!==e.getType()&&"DMUClipping"!==e.getType()||ie&&e.isManipulationOnGo&&!e.isManipulationOnGo()&&ie.destroy()}),F.length=0,e.reviewContext){var s,d,u=function(e,t,n){for(var i,r=0;r<l.length;r++)if(l[r].path.isEqual(e)){i=l[r];break}i||(i={path:e.clone(),counter:1,dmuObj:t},l.push(i)),i.counter=i.counter+(n?1:-1)},c=i.get(),p=[],m=[],f=[],h=[],v=e.reviewContext.getCurrentSessionMarkup();for(n=0;n<c.length;n++){if(d=e.reviewContext.getDMUObjectFromPathElement(c[n].pathElement))"DMUSlide"===d.getType()||"DMUFormat"===d.getType()?(p.push(d),h.push(c[n])):m.push(c[n]),-1===F.indexOf(d)&&F.push(d),d.setInEdition(!0);else{if(!(v?v.getOrCreateOccurrenceOverloader(c[n]):null))continue;f.push(c[n])}p.length&&c.length>1&&n===c.length-1&&(s=p[p.length-1]===d?m.concat(f):h)}var C=F.length!==a.length;if(!C)for(n=0;n<F.length;n++)if(-1===a.indexOf(F[n])){C=!0;break}if(s&&s.length)i.remove(s);else{F.forEach(function(n){for("DMUSection"!==n.getType()&&"DMUClipping"!==n.getType()||n.refreshNode(),t=function(t){var n=[];if(!t)return n;t.getPathElement&&n.push(t.getPathElement());var i=t.getPointedReferences?t.getPointedReferences():[];if(i&&i.length&&e.reviewContext){var r=e.reviewContext.getCurrentSessionMarkup();if(!r&&t.getType&&"DMUMeasure"===t.getType()&&(r=e.reviewContext.getTransientReviewBag()),r){var o=r.getAttribute("oLinksManager");if(o)for(var a=0;a<i.length;a++)if("null"!==i[a]){var l=o.getOccurrencePathElement(i[a]);l&&n.push(l)}}}return n}(n),o=0;o<t.length;o++)u(t[o],n,!0)});var D=g.getManager({name:"DMUUserExperienceManager",context:V});if(D&&D.refreshCCPCommandsAvailability(),J&&J.updateSelectedSlides(p.concat([])),Se&&Se(F),C){be(!0),De();var b=[],M=[];l.forEach(function(e){e.counter>0&&b.push({pathElement:e.path})}),c.length?(r.get().forEach(function(e){if(!i.isIn(e)){for(var t=0;t<b.length;t++)if(b[t].pathElement.isEqual(e.pathElement))return;M.push(e)}}),r.remove(M)):r.empty(),r.add(b),V.getViewer().render()}}}}function Ie(e){if(e&&e.pathElement){var t=e.pathElement.getLastElement(!0);t&&t.processPathForTrimedText&&(e=t.processPathForTrimedText(e))}return e}function ke(t){const n="DMUSlide"===t.getType(),i=e.reviewContext.getValidation();if(i){let e,t;i.getMarkups().some(i=>{let r=i.getRepRef();if(r){const i=r.getMarkupContent();if(i){const r=i.getSlides();if(r&&r.length)return n?(e=i,t=r.find(e=>!e.getAttribute("bMarkedAsDeleted")),!0):r.some(n=>{return n.getDMUObjects().some(n=>{const r=n.getDMUComments();if(r&&r.length)return e=i,t=r.find(e=>!e.getAttribute("bMarkedAsDeleted")),!0})})}}}),e&&t?T.registerElementIdAsPreview(t.getAttribute("sUuid"),e):T.registerElementIdAsPreview(null)}else{const t=e.reviewContext.getCurrentSessionMarkup();if(t&&t.getActiveFlag()){const e=t.getSlides();let i;e&&e.length?n?T.registerElementIdAsPreview(e[0].getAttribute("sUuid"),t):e.some(e=>{return e.getDMUObjects().some(e=>{const t=e.getDMUComments();if(t&&t.length)return i=t[0],!0})})?T.registerElementIdAsPreview(i.getAttribute("sUuid"),t):T.registerElementIdAsPreview(null):T.registerElementIdAsPreview(null)}}}Re(-1!==d.getAuthoringFeatureTypes().indexOf("Marker")),this.setMarkupVisualizationActiveState=function(t){let n;const r=e.reviewContext.getCurrentSessionMarkup();function o(){if(L!==t&&(L=t,e.reviewContext.getVisibleMarkups().forEach(function(e){if(e){e.setVisibleFlag(L),e.refreshNode(),V.getViewer().render(),require([].concat(["DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd"]),e=>{e&&e.updateGridCommandState()});let t=O.getClippingCmdService();t&&t.updateClippingCommandState({contextViewer:d.getContextViewer({viewer:V.getViewer()}),reviewContext:d.getReviewContext({viewer:V.getViewer()})}),J.setPanelActiveFlag(L)}}),!L&&F&&F.length)){let t=[];i.get().forEach(function(n){e.reviewContext.getDMUObjectFromPathElement(n.pathElement)&&t.push(n)}),t.length&&i.remove(t)}}r&&(n=r.getApplicativeContext());const a=d.getEventsController({viewer:G.getViewer()});if(n&&n.PIM){require([{isr:"DS/PIMwebViewController/PIMwebItfCtrl"}.isr],function(e){t?(a.fireEvent("onDMUMarkupApplicativeContextLoadBegin"),e.loadApplicativeContext(n.PIM,G).then(()=>{a.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!0}),o()})):e.cleanApplicativeContext(n.PIM,G).then(()=>{a.fireEvent("onDMUMarkupApplicativeContextCleaned"),o()})})}else a.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!1}),o()},this.setFormatEditionModeFlag=function(t){if(J&&e.reviewContext){i.empty();var n=e.reviewContext.getCurrentSessionMarkup(),r=n&&n.getCurrentSlide?n.getCurrentSlide():null;N=t;let a=e.reviewContext.getValidation(),l=a?a.getAllRepRefs():[],s=[];l.length?l.forEach(e=>{e.getMarkupContent()&&s.push(e.getMarkupContent())}):s.push(n);let d=[],u=[];if(s.forEach(e=>{u=u.concat(e.getFormats()),d=d.concat(e.getSlides())}),a&&a.getCurrentMarkup()&&"Reply"===a.getCurrentMarkup().getAttribute("sValType")){let e=a.getCurrentMarkup();for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();e&&"Markup"===e.getAttribute("sValType")&&(e=e.getRepRef()),a.setCurrentMarkup(e)}if(N)for(let e=0;e<u.length;e++)u[e].setReadOnly(!1,!0);J.setPanelOptions({panelTitle:N?R.formatPanelTitle:void 0,noSlideLabel:N?R.noFormatLabel:void 0,createSlideLabel:N?R.createFormatLabel:void 0,editingFormats:N});var o=q||n.getCurrentSlide();o||(o=N?u[0]:d[0]),q=r,ve(N?u:d),ve(N?d:u),J.setActiveSlide(o,{duration:0}),q&&(q.refreshNode(),"DMUSlide"===q.getType()&&q.getPointedFormats().length&&-1!==q.getPointedFormats().indexOf(o)&&(o.setDisplayedFlag(!0),o.setReadOnly(!1),o.refreshNode()),V.getViewer().render())}},this.getFormatEditionModeFlag=function(){return N},this.setReadOnly=function(e){e&&A&&(A.clean(),A=null),v.setSlidePreferences({context:V,preferences:{playMode:e}}),J&&J.setPanelOptions({playMode:e}),Re(!e)},this.registerElementIdAsPreview=((e,t,n)=>{if(!require("DS/PADUtils/PADUtilsServices").isCloud())return;const i=!t||!t.isImporting();if("Document"===me||"PDF"===me||"Requirement Specification"===me||"Requirement"===me){let t=m.giveDMUCommentsController({context:V});t&&t.setCommentAsPreview(e,n,i)}else{let t=p.giveDMUSlidesController({context:V});t&&t.setSlideAsPreview(e,i)}ue&&ue.getAttribute("sPreviewElementUuid")!==e&&ue.setAttribute("sPreviewElementUuid",void 0),t&&!t.isImporting()&&t.setAttribute("sPreviewElementUuid",e),ue=t,K.fireEvent("onSaveRequested")}),this.isAPreviewRegistered=(()=>Boolean(ue)),this.getSelectedObjects=function(){return F},this.remove=function(){if(T.setActiveFlag(!1),A&&A.clean(),g.removeManager({name:"DMUUserExperienceManager",context:V}),c.unreferenceTooltipManager(e),ne&&(ne.destroy(),ne=null),ie&&(ie.destroy(),ie=null),te&&te.length)for(var t=0;t<te.length;t++)V.getViewer().removeNode(te[t].getNode());re&&re.remove(),te=Q=Y=$=ee=null,F=null,K=null,q=null,re=V=null,U=null,A=null},this.setActiveFlag=function(t){let r=!1,l="SlideReorder",u=!0,C=!0,M="0.001",P=!0,F="1.5708";if(v.setSlidePreferences({context:V,preferences:{displaySlideTitle:r,slideDragAndDropOperation:l,slideNameFromfeature:u}}),E.readPreferences([{Repository:"DMURepository",PreferenceNames:["DisplaySlideTitle","SlideDragAndDropOperation","SlideNameFromFeature","SnapHandlesToGrid","SnapHandlesGridValue","SnapRotationToggle","SnapRotationAngle"]}]).then(function(e){let t=e.repositories[0].preferences;for(let e=0;e<t.length;e++)"DisplaySlideTitle"===t[e].name?r="true"===t[e].value:"SlideDragAndDropOperation"===t[e].name?l=t[e].value:"SlideNameFromFeature"===t[e].name?u="true"===t[e].value:"SnapHandlesToGrid"===t[e].name?C="true"===t[e].value:"SnapHandlesGridValue"===t[e].name?M=t[e].value:"SnapRotationToggle"===t[e].name?P="true"===t[e].value:"SnapRotationAngle"===t[e].name&&(F=t[e].value);v.setSlidePreferences({context:V,preferences:{displaySlideTitle:r,slideDragAndDropOperation:l,slideNameFromfeature:u}}),x.setManipulationPrefs({snapHandlesToGrid:C,snapHandlesGridValue:M,snapRotationToggle:P,snapRotationAngle:F})}).catch(function(e){window.console.warn("Could not get server value, default value set instead.",e)}),j!==t){if(j=t)J=p.getDMUSlidesController({context:V,commandContext:G.getCommandContext()}),ae=f.getDMUReviewController({context:V,commandContext:G.getCommandContext()}),e.reviewContext.setRestrictions(ae.getRestrictions),z=h.getDMUCursorsController({context:V,commandContext:G.getCommandContext()}),Z=w.getPreferenceManager({context:G.getFrameWindow()}),J.setActiveFlag(!0),y.getDMUSceneDisplayController({context:G}),S.getReqCompareController({context:G}),H.onDMUObjectCreated=K.addEvent("onDMUObjectCreated",function(e){e.dmuObject&&"DMUFormat"===e.dmuObject.getType()&&e.dmuObject.setReadOnly(!N)}),H.onDMUObjectInitialized=K.addEvent("onDMUObjectInitialized",function(t){if(t&&t.dmuObject){var n,i,r;if("DMUMarkup"===t.dmuObject.getType()&&t.dmuObject.getAttribute("sPreviewElementUuid"))T.registerElementIdAsPreview(t.dmuObject.getAttribute("sPreviewElementUuid"),t.dmuObject);else if("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType()){t.dmuObject.setDisplayedFlag(!1),A&&A.hide();let e=g.getManager({name:"DMU2DSheetManager",context:V});"DMUSlide"!==t.dmuObject.getType()||ue||e&&e.isADocumentDisplayed()||T.registerElementIdAsPreview(t.dmuObject.getAttribute("sUuid"),t.dmuObject.getParent())}else if("DMUSection"===t.dmuObject.getType()||"DMUClipping"===t.dmuObject.getType()){if(e.reviewContext&&(n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&n.isVisible()){var o=n.getCurrentSlide();o&&"DMUSlide"===o.getType()&&(o.refreshNode(),V.getViewer().render())}}else if("DMUValidationValidation"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),J&&i){var a=i.getAllRepRefs();let e=[],n=[];for(var l=0;l<a.length;l++){var s=(r=a[l]).getParent().getValType();"Markup"===s?e.push({title:r.getParent().getName(),content:r,id:r.getPlmID()}):"Reply"===s&&n.push({title:r.getParent().getName(),content:r,id:r.getPlmID(),parentID:r.getParentRepRef().getPlmID()})}e.forEach(e=>{t.dmuObject.getModifyAccessFlag()||e.content.setReadOnly(!0),J.addMarkup(e),X&&X.addMarkup(e)}),n.forEach(e=>{J.addReply(e)})}if(ae&&i){ae.setEditionMode(t.editionMode&&t.dmuObject.getModifyAccessFlag());var d=Boolean(X);i.enableMultipleMarkupVisibility(d),ae.addReview(d),se&&ae.updateReviewPanelContent({reviewNoContextMode:!0}),J&&!d&&J.forcePanelVisibility()}}else if("ReviewMarkup"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),r=t.dmuObject,ae.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),J&&i){var u=r.getParent();"Markup"===u.getType()?(J.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),X&&(X.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),se&&X.setVisibleFlag(!1))):"Reply"===u.getType()&&J.addReply({title:r.getParent().getName(),content:r,id:r.getPlmID(),parentID:r.getParentRepRef().getPlmID()})}}else if("DMUValidationCheck"===t.dmuObject.getType()){var c=t.dmuObject;ae&&ae.addCheck({id:c.getPlmID(),name:c.getName(),status:c.getStatus(),description:c.getDescription(),requirements:c.getJsonRequirements()?c.getJsonRequirements():[]})}else if("DMUValidationExposedPresentation"===t.dmuObject.getType()){var p=t.dmuObject;ae&&ae.addHighlight({repRefMarkupId:t.dmuObject.getAttribute("sRepRefMarkupID"),slideObject:t.slideObject,id:p.getPlmID(),name:p.getName(),rating:p.getRating(),description:p.getDescription(),issues:[],changeAction:[],highlightObject:p,index:e.reviewContext.getValidation().getHighlights().length-1})}else if("DMUComment"!==t.dmuObject.getType()||ue){var m=t.dmuObject.getType();!m.includes("DMUMarker")&&"DMUMeasure"!==m&&"DMUCommentPositioned"!==m||"DMUMarker3DPoint"===m||"DMUMarker2DPoint"===m||"DMUCommentHighlight"===m||t.dmuObject.getNode().setRepManipulator(new b(t.dmuObject)),e.reviewContext&&(n=e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&!n.isImporting()&&(t.dmuObject.refreshNode(),V.getViewer().render())}else T.registerElementIdAsPreview(t.dmuObject.getAttribute("sUuid"),t.dmuObject.getParent());Ce(t)}}),H.onDMUObjectVisuRefreshRequired=K.addEvent("onDMUObjectVisuRefreshRequired",function(e){e&&e.dmuObject&&(e.dmuObject.refreshNode(),V.getViewer().render())}),H.onDMUObjectDeleted=K.addEvent("onDMUObjectDeleted",function(t){if(t&&t.dmuObject)if("DMUSection"===t.dmuObject.getType()||"DMUClipping"===t.dmuObject.getType()){if(e.reviewContext){var n=e.reviewContext.getCurrentSessionMarkup();if(n){var i=n.getCurrentSlide();i&&"DMUSlide"===i.getType()&&(i.refreshNode(),V.getViewer().render())}}}else ue&&("DMUSlide"===t.dmuObject.getType()||"DMUComment"===t.dmuObject.getType())&&t.dmuObject.getParent()===ue&&e.reviewContext&&t.dmuObject.isPreview()&&ke(t.dmuObject)}),H.onDMUObjectActiveFlagChanged=K.addEvent("onDMUObjectActiveFlagChanged",function(e){Ce(e),e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.flag?J&&e.dmuObject.getCurrentSlide()&&J.setActiveSlide(e.dmuObject.getCurrentSlide()):A&&(A.clean(),A=null),e.dmuObject.refreshNode(),V.getViewer().render())}),H.onDMUObjectVisibleFlagChanged=K.addEvent("onDMUObjectVisibleFlagChanged",function(t){t&&t.dmuObject===e.reviewContext.getCurrentSessionMarkup()&&T.setMarkupVisualizationActiveState(t.flag)}),H.onDMUObjectAttributeModified=K.addEvent("onDMUObjectAttributeModified",function(t){if(t&&"bShortDisplay"===t.attrName&&Q&&Q.length){var i=Q.findIndex(function(e){return e.dmuObj.getNode().id===t.dmuObject.getNode().id});i>=0&&setTimeout(function(){Q[i].manipulator&&(Q[i].manipulator.updateHandlePosition(),V.getViewer().render())})}(!N&&"DMUSlide"===t.dmuObject.getType()||N&&"DMUFormat"===t.dmuObject.getType())&&J&&t.dmuObject.getActiveFlag()&&t.dmuObject.isVisible()&&J.updateSlide(t.dmuObject),t&&t.dmuObject&&"DMUComment"===t.dmuObject.getType()&&"sTextContents"===t.attrName&&t.value&&K.fireEvent("onSaveRequested"),t&&t.dmuObject&&"3DGrid"===t.dmuObject.getType()&&"vBBMin"!==t.attrName&&"vBBMax"!==t.attrName&&K.fireEvent("onSaveRequested"),t&&t.dmuObject&&("DMUClipping"===t.dmuObject.getType()||"DMUSection"===t.dmuObject.getType())?function(t){if(t&&t.dmuObject&&(!t.dmuObject.isManipulationOnGo||!t.dmuObject.isManipulationOnGo())){var n=t.dmuObject.getType(),i=t.dmuObject,r=e.reviewContext.getCurrentSessionMarkup(),o=O.getEditCmd(G),a=function(){o&&o.isRunning()&&r&&r.getActiveFlag()&&r.isVisible()&&!r.isReadOnly()&&i&&i.isManipulationOnGo&&!i.isManipulationOnGo()&&("DMUClipping"!==n&&"DMUSeciton"!==n||(ie||(ie=new D),ie.display({frmWindow:G.getFrameWindow(),label:R.saveMarkup,type:"button",onClick:function(){ie.destroy(),$=!1,K.fireEvent("onSaveRequested")}}),$=!0))};o&&(ye&&(clearTimeout(ye),ye=null),o.isRunning()?a():ye=setTimeout(a))}}(t):function(t){if(t&&t.dmuObject&&Q&&Q.length){var i,r=t.dmuObject.getParent();i=r&&r.getType().includes("DMUMarker")?r.getNode():t.dmuObject.getNode();var o=e.reviewContext.getCurrentSessionMarkup(),a=n.getCommand("DMU3ReviewWidgetDefaultHdr",G.getCommandContext())||n.getCommand("DMUReviewWebAppDefaultHdr",G.getCommandContext())||n.getCommand("DMUValidationWebAppDefaultHdr",G.getCommandContext()),l=function(){a&&a.isRunning()&&o&&o.getActiveFlag()&&o.isVisible()&&i&&Q&&Q.length&&-1!==Q.findIndex(function(e){var t=e.dmuObj.getNode();return t&&t.id===i.id})&&(ne||(ne=new D),ne.display({frmWindow:G.getFrameWindow(),label:R.saveMarkup,type:"button",onClick:function(){ne.destroy(),$=!1,K.fireEvent("onSaveRequested")}}),$=!0)};a&&(Me&&(clearTimeout(Me),Me=null),a.isRunning()?l():Me=setTimeout(l))}}(t),t&&"bMarkedAsDeleted"===t.attrName&&t.dmuObject&&("DMUSlide"===t.dmuObject.getType()||"DMUComment"===t.dmuObject.getType())&&(t.dmuObject.getParent()===ue&&ke(t.dmuObject),K.fireEvent("onSaveRequested"))}),H.onDMUObjectReadOnlyFlagChanged=K.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){e&&e.dmuObject&&(!N&&"DMUSlide"===e.dmuObject.getType()||N&&"DMUFormat"===e.dmuObject.getType())&&J&&J.updateSlideEditableFlag(e.dmuObject)}),H.onDMUSlideDisplayed=K.addEvent("onDMUSlideDisplayed",function(){A&&A.hide()}),H.onLoadingReviewContext=K.addEvent("onLoadedReviewContext",function(t){if(me=t.rootType,"Document"===t.rootType||"Specification Report"===t.rootType||"PDF"===t.rootType||"Requirement Specification"===t.rootType||"Requirement"===t.rootType){J&&J.setVisibleFlag(!1),X||(X=m.getDMUCommentsController({context:V,commandContext:G.getCommandContext()}));const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!0)}if("DXF"===t.rootType||"DWG"===t.rootType){J&&J.setVisibleFlag(!0),X&&X.setVisibleFlag(!1);const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!1)}}),H.on2DDocumentLoadSuccess=K.addEvent("on2DDocumentLoadSuccess",e=>{if(e&&"Document"===e.type){me=e.type;var t=d.getReviewContext({viewer:V.getViewer()}),n=t?t.getValidation():null;n&&n.getMarkups().forEach(e=>{let t=e.getRepRef();t&&t.getMarkupContent()&&t.getMarkupContent().refreshNode()})}}),H.onReviewNoContextModeOn=K.addEvent("reviewNoContextModeOn",function(e){se=!0,X||(X=m.getDMUCommentsController({context:V,commandContext:G.getCommandContext()})),X.setVisibleFlag(!1),J&&J.setVisibleFlag(!1),ae.updateReviewPanelContent({reviewNoContextMode:!0}),e&&e.markups&&e.markups.forEach(e=>{ae.addMarkup({title:e.getName(),content:e,id:e.getPlmID()})})}),H.onReviewNoContextModeOff=K.addEvent("reviewNoContextModeOff",function(e){se=!1;let t=e.rootType;!X||"PDF"!==t&&"Requirement"!==t&&"Requirement Specification"!==t?"DXF"===t||"DWG"===t?X.setVisibleFlag(!1):"Document"!==t&&J&&(J.setVisibleFlag(!0),X&&(m.unreferenceDMUCommentsController({context:V}),X=null)):X.setVisibleFlag(!0),ae&&ae.updateReviewPanelContent({reviewNoContextMode:!1,rootType:t})}),Z&&(W=Z.subscribe("com.ds.mep:onPrefUpdate",function(e){let t={},n={},i=JSON.parse(e[1].preferences);for(let e=0;e<i.repositories.length;e++)if("DMURepository"===i.repositories[e].name)for(let r=0;r<i.repositories[e].preferences.length;r++)"DisplaySlideTitle"===i.repositories[e].preferences[r].name?t.displaySlideTitle="true"===i.repositories[e].preferences[r].value:"SlideDragAndDropOperation"===i.repositories[e].preferences[r].name?t.slideDragAndDropOperation=i.repositories[e].preferences[r].value:"SlideNameFromFeature"===i.repositories[e].preferences[r].name?t.slideNameFromfeature="true"===i.repositories[e].preferences[r].value:"SnapHandlesToGrid"===i.repositories[e].preferences[r].name?n.snapHandlesToGrid="true"===i.repositories[e].preferences[r].value:"SnapHandlesGridValue"===i.repositories[e].preferences[r].name?n.snapHandlesGridValue=i.repositories[e].preferences[r].value:"SnapRotationToggle"===i.repositories[e].preferences[r].name?n.snapRotationToggle="true"===i.repositories[e].preferences[r].value:"SnapRotationAngle"===i.repositories[e].preferences[r].name&&(n.snapRotationAngle=i.repositories[e].preferences[r].value);v.setSlidePreferences({context:V,preferences:t}),x.setManipulationPrefs(n)})),U=c.getTooltipManager(e),s=U.register({onTooltipReady:fe,filterPath:he}),(pe=g.getManager({name:"DMU2DSheetManager",context:V}))&&(X||!pe.isADocumentDisplayed()&&!pe.isRunning()||"Document"!==pe.getDocumentType()&&"Requirement"!==pe.getDocumentType()||(X=m.getDMUCommentsController({context:V,commandContext:G.getCommandContext()})),(_=pe.getPDFHyperlinks())&&_.length&&U.registerElements(_.reduce(function(e,t){return e.concat(t.div)},[]))),B.onPostAdd=i.onPostAdd(Ae),B.onPostRemove=i.onPostRemove(Ae),B.onEmpty=i.onEmpty(Ae),k=o.onPreAdd(Ie),I=a.subscribe({event:"/VISU/onWindowResized"},function(){var t=e.reviewContext.getCurrentSessionMarkup();if(t){var n=t.getCurrentSlide();if(n){var i=n.getDMUObjects();if(i&&i.length)for(let e=0;e<i.length;e++)i[e].refreshNode&&-1===i[e].getType().indexOf("Compare")&&i[e].refreshNode()}}});else{if(J&&(p.unreferenceDMUSlidesController({context:V}),J=null),e.reviewContext.setRestrictions(void 0),ae&&(f.unreferenceDMUReviewController({context:V}),ae=null),z&&(h.unreferenceDMUCursorsController({context:V}),z=null),X&&(m.unreferenceDMUCommentsController({context:V}),X=null),y.unreferenceDMUSceneDisplayController({context:G}),S.unreferenceReqCompareController({context:G}),A&&(A.clean(),A=null),K)for(var L=Object.keys(H),q=0;q<L.length;q++)K.removeEvent(H[L[q]]);H={},B.onPostAdd&&i.unsubscribe(B.onPostAdd),B.onPostRemove&&i.unsubscribe(B.onPostRemove),B.onEmpty&&i.unsubscribe(B.onEmpty),B={},k&&o.unsubscribe(k),k=null,W&&(Z.unsubscribe(W),W=null),Z&&(w.unreferencePreferenceManager({context:G.getFrameWindow()}),Z=null),_&&_.length&&(U.unregisterElements(_.reduce(function(e,t){return e.concat(t.div)},[])),_=null),U.unregister(s),s=null,a.unsubscribe(I),I=null}ue=null,Se&&Se([])}}}});return Object.freeze({createReviewContext:async e=>{if(e&&e.context){var t=d.getReviewContext(e);if(!t){await U.init({context:e.context}),(t=new s(e.context.getFrameWindow())).setUIManager(new A({context:e.context,reviewContext:t}));var n=e.context.getFrameWindow();n.removeReviewModel||(n.removeReviewModel=function(t){if(t){var i=d.getReviewContext(e);if(i){var r=i.getTransientReviewBag();r.removeDMUObjects(t),r.getDMUObjects().length||i.getCurrentSessionMarkup()||(d.removeReviewContext(e),n.removeReviewModel=void 0)}}else d.removeReviewContext(e),n.removeReviewModel=void 0}),n.setReviewModelVisibleFlag||(n.getReviewModelVisibleFlag=function(){var t=d.getReviewContext(e);return!!t&&t.isVisible()},n.setReviewModelVisibleFlag=function(t){var n=d.getReviewContext(e);n&&n.setVisibleFlag(t)}),t&&d.setReviewContext({context:e.context,controller:t})}return t}}})}),define("DS/DMUBaseUIControllers/DMU2DSheetManager",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUControls/EXPNavBar","DS/DMUControls/DMUCurrentPageWidget","DS/SVGLoader/SVGNode","DS/Mesh/MeshUtils","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseExperience/DMUContextManager","DS/DibUDLWebLoader/CATDibUDLWebLoader","DS/WAFData/WAFData","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIControllers/DMUMarkupsController","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/DMUCommandsManager","DS/DMUBaseUIControllers/DMUReqCompareController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,g,c,p,m,f,h,v){"use strict";return e.extend({init:function(e){let C,D,b,M,y,S,w,E,U,x,O,P,R,A,I,k,V=this,T=e.ctxViewer,j=!1,F=null,N=[],L=[],B=1,H=[],W=0,q=new Map;function _(e,t){let n;if(e&&t)for(let i=0;i<L.length;i++)if(L[i]&&L[i].sheetNodes&&L[i].sheetNodes.length){for(let r=0;r<L[i].sheetNodes.length;r++)"modelID"===e&&L[i].sheetNodes[r].sheetID===t&&(n=L[i].sheetNodes[r].modelID),"sheetID"===e&&L[i].sheetNodes[r].modelID===t&&(n=L[i].sheetNodes[r].sheetID),"parentID"===e&&L[i].sheetNodes[r].sheetID===t&&(n=L[i].parentID);if(n)break}return n}function z(){C=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:v.objectWithoutUDL})}function X(e){var t,n;let i=e&&e.parentID?e.parentID:L[0].parentID;for(let e=0;e<L.length;e++)if(L[e].parentID===i){n=e;break}if(void 0===n&&L&&L.length&&(i=L[n=0].parentID),i)if(L[n].svg){for(t=0;t<L[n].sheetNodes.length;t++)L[n].sheetNodes[t].setVisibility(L[n].sheetNodes[t].sheetID===e.sheetID),L[n].sheetNodes[t].setVisibilityFree(L[n].sheetNodes[t].sheetID!==e.sheetID);e.callback&&e.callback(),T.getViewer().render()}else{W++;var r=l.giveEventsController({context:T}),o=function(){W--,e.callback&&e.callback(),r&&r.fireEvent("onContextVisuChangeEnd")};r&&r.fireEvent("onContextVisuChangeBegin");let t=_("modelID",e.sheetID);if(L[n].fatherNode&&L[n].fatherNode.removeChildren(),"DXF/DWG"===L[n].dataType||"DIFSheet"===L[n].dataType||"DIFLayout"===L[n].dataType)L[n].getSheet3DNode({modelID:t,noUdlMessage:N,noUdlWarningMessage:function(){z()},end:o,cb:function(e){!function(){q?q.clear():q=new Map;let e=function(t){if(t.getLastElement(!0).getDibInfo&&t.getLastElement(!0).getDibInfo()&&t.getLastElement(!0).getDibInfo().id){let e=t.getLastElement(!0).getDibInfo().id;if(e){q.has(e)||q.set(e,[]);let n=q.get(e);n&&n.push(t)}}let n=t.getChildrenPathes();n&&n.length&&n.forEach(e)};e(T.getRootBagPath())}(),T.getViewer().setBackgroundColor(e&&e.getHex?e.getHex():16777215)}});else{let i=L[n].UDLLoader;if(i){let r=i.getSheetBackgroundColor(t);T.getViewer().setBackgroundColor(r&&r.getHex?r.getHex():16777215),i.getSheet3DNode({sheetID:t,onSheetNodeCreated:function(e){L[n].fatherNode&&L[n].fatherNode.addChild(e),T&&T.getViewer().render()},onSheetLoaded:function(){N.includes(e.sheetID)&&z(),T&&T.getViewer().render(),o()},onFailure:function(){N.push(e.sheetID),z(),o()}})}}}}function G(e){var t=l.getReviewContext({context:T}),n=t?t.getCurrentSessionMarkup():null,i=a.giveDMUSlidesController({context:T.getFrameWindow()});if(n&&n.getActiveFlag()&&n.isVisible()&&i){var r=null;if(e)for(var o=t.getUIManager().getFormatEditionModeFlag()?n.getFormats():n.getSlides(),s=0;s<o.length;s++)if(o[s].getEnvironmentOverload().state.sFocusProperty&&o[s].getEnvironmentOverload().state.sFocusProperty.length&&o[s].getEnvironmentOverload().state.sFocusProperty[0]===e){r=o[s];break}i.setActiveSlide(r)}else t&&t.getTransientReviewBag&&t.getTransientReviewBag().removeDMUObjects(),T.getViewpoint().reframe()}function K(e){if(!T)return void(e&&e.callback&&e.callback({error:!0}));var n=null;let i,r=e&&e.parentID?e.parentID:L.length?L[0].parentID:null;if(!r)return;for(let e=0;e<L.length;e++)if(L[e].parentID===r){i=e;break}let o=r===L[0].parentID;if(void 0===i&&(i=0),e&&e.sheetID?n=e.sheetID:L[i].sheetNodes&&L[i].sheetNodes.length&&(n=L[i].sheetNodes[0].sheetID),n){let a=!1,l=_("sheetID",L[i].activatedSheet);if(n!==l){a=!0;let e=parseInt(n);e&&L[i].sheetNodes&&L[i].sheetNodes.length&&(L[i].sheetNodes[e-1].sheetID===l?a=!1:n=L[i].sheetNodes[e-1].sheetID)}if(a)C&&C.destroy(),function(e){for(let t=0;t<L.length;t++)if(L[t].sheetNodes)for(let n=0;n<L[t].sheetNodes.length;n++)if(L[t].sheetNodes[n].sheetID===e)return L[t].sheetNodes[n]}(n)?(e.changeActiveSlide&&G(""),L[i].activatedSheet=_("modelID",n),X({sheetID:n,parentID:r,callback:function(t){o&&e.changeActiveSlide&&G(n),e.callback&&e.callback(t)}}),o&&n&&y&&r===L[0].parentID&&y.setActiveNarBarItem(n)):(C=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:v.sheetNotExistWarning}),e.callback&&e.callback({error:!0}));else e&&e.callback&&e.callback()}else e&&e.callback&&e.callback()}function J(e){w&&w.updateCurrentPage(e.value);var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onCurrentElementChanged",{currentElement:e.value,endMove:e.endMove})}function Z(e){if(O&&e&&e.paths&&e.paths.length&&e.paths[0].length){let t=e.paths[0]?e.paths[0].join("/"):void 0;t&&(k=t,O.setCurrentElement({elementID:t,duration:200}))}}function Q(e){if(e&&e.paths&&e.paths.length){let t=[];if(e.paths.forEach(e=>{if(O&&O.isADocumentDisplayed()&&"Requirement"===O.getDocumentType()){O.forceElementsLoad([e[e.length-1]]);let n=O.getElementInfo(e[e.length-1]);n&&n.pathElement&&t.push(n.pathElement)}else{let n=e&&e.length>2?[e[e.length-2],e[e.length-1]]:e.length?e:[],i=[];for(let e=n.length-1;e>=0;e--)if(q.has(n[e])&&q.get(n[e]).length){let t=q.get(n[e]);if(i.length)for(let e=i.length-1;e>=0;e--){let n=i[e];t.some(e=>e.isAParentOf(n))||i.splice(e,1)}else i=t.slice()}t=t.concat(i)}}),t.length){let e=f.getCommand("DMUFocusOnRepresentationHdr",T.getCommandContext());e&&e.beginExecute(t)}}}function Y(){if(L&&1===L.length){T.getViewer().set2DMode(!0,"CATIA"),D=T.getViewer().antiAliasing,T.getViewer().setAntiAliasing("MSAA"),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}]).then(e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)});var e=p.giveSelectionManager({context:T});e&&e.setPicking(1),-1!==(M=T.getViewer().getVisuEnv()).indexOf("OCA")&&(M=M.split("OCA")[0]),T.getViewer().setVisuEnvOCA("Basic")}}function $(){if(!T.getFrameWindow())return;let e=0,t=T.getFrameWindow().getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea);(t.getContainedVisibleWindows().length>0||t.interactiveDockAreaVisibleFlag)&&(e=t._collapserSize,t.collapseDockingZoneFlag||(e+=t.dockingZoneSize)),w&&w.setOffset(e)}this.isRunning=function(){return W>0},this.load2DDocument=function(e){if(!e||!T)return;if(!e.onFailure)return;if(!e.phyID)return void e.onFailure();if(!e.dataType)return void e.onFailure();if(!e.parentNode&&"DIFLayout"!==e.dataType&&"DIFSheet"!==e.dataType)return void e.onFailure();if(!e.onComplete)return void e.onFailure();for(let t=0;t<L.length;t++)if(e.phyID===L[t].parentID)return;if(-1!==H.indexOf(e.phyID))return;let i=l.giveEventsController({viewer:T.getViewer()});i&&i.fireEvent("on2DDocumentLoadStarted",{id:e.phyID,type:"2DData"}),e.onLoadingStarted&&e.onLoadingStarted(),W++,H.push(e.phyID);var a=function(n,r){C&&C.destroy(),C=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:n}),W--,i&&i.fireEvent(r,{id:e.phyID,type:"2DData"}),-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1),e.onComplete("fail")},u=function(t){K({sheetID:t,parentID:e.phyID,callback:function(){if(T){1===L.length&&function(){if(y&&y.clean(),L[0]&&L[0].sheetNodes&&L[0].sheetNodes.length){for(var e=[],t=0;t<L[0].sheetNodes.length;t++)e.push({id:L[0].sheetNodes[t].sheetID,label:L[0].sheetNodes[t].label});if(e.length){let t=_("sheetID",L[0].activatedSheet);(y=new n({frameWindow:T.getFrameWindow(),tabs:e,onClickCB:e=>{e&&L&&L.length&&K({sheetID:e,parentID:L[0].parentID,changeActiveSlide:!0})},activeTabIndex:t||e[0].id})).setVisibleFlag(B>0)}}}();var t=l.getReviewContext({context:T}),r=t?t.getCurrentSessionMarkup():null;(!r||r&&!r.getSlides().length)&&T.getViewpoint().reframe(),W--,-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1),V.initializeDMUEvents(),i&&i.fireEvent("on2DDocumentLoadSuccess",{id:e.phyID,type:"2DData"})}e.onComplete()}})},g=function(){W--,-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1),i&&i.fireEvent("on2DDocumentLoadError",{id:e.phyID,type:"2DData"}),e.onFailure()},c=function(){T.getController().getAttributes({ids:[e.phyID],attributes:["svg"],callbacks:{onComplete:function(t){if(-1!==H.indexOf(e.phyID))if(t[e.phyID]&&t[e.phyID].svg&&""!==t[e.phyID].svg){var n={method:"GET",authentication:"passport",proxy:"none",type:"text",timeout:6e4,cache:3600,onComplete:function(t){if(-1===H.indexOf(e.phyID))return;F||(F=new DOMParser);let n=F.parseFromString(t,"image/svg+xml");if(!n)return void a(v.sheetNotSupported,"on2DDocumentLoadError");let i=[],l=[];if(n.documentElement&&n.documentElement.id?l=[n.documentElement]:n.documentElement&&n.documentElement.childNodes&&n.documentElement.childNodes.length&&n.documentElement.childNodes[0].id&&(l=n.documentElement.childNodes),!l.length)return void a(v.sheetNotSupported,"on2DDocumentLoadError");let s,d,g=l.length-1;for(d=l.length-1;d>=0;d--){if(!l[d].id)return void a(v.sheetNotSupported,"on2DDocumentLoadError");if(-1!==i.indexOf(l[d].id))return void a(v.sheetNotSupported,"on2DDocumentLoadError");i.push(l[d].id)}for(L.push({parentID:e.phyID,dataType:e.dataType,svg:!0,sheetNodes:[],activatedSheet:null,fatherNode:e.parentNode}),d=l.length-1;d>=0;d--)(s=new r(l[d],"Drw."+e.phyID+"_"+l[d].id,T.getViewer())).modelID=l[d].id,s.sheetID="Drw."+e.phyID+"_"+l[d].id,s.label=l[d].textContent,s.setPickable(o.PICKTHROUGH),L[L.length-1].sheetNodes.unshift(s),g>0&&"svg"===l[d].localName&&s.setVisibility(!1),g--;for(d=0;d<L[L.length-1].sheetNodes.length;d++)L[L.length-1].fatherNode.addChild(L[L.length-1].sheetNodes[d]);Y(),u(L[L.length-1].sheetNodes[0].sheetID)},onCancel:g,onFailure:g};d.handleRequest(t[e.phyID].svg,n)}else g()},onFailure:g}})};let p=new s;if(p.setMaxSheetInCache(4),p.set3DAccuracy(.001),p.set2DAccuracy(.001),"Drawing"===e.dataType)e.serverUrl?p.loadModel({data:{physicalid:e.phyID,dataType:e.dataType},serverUrl:e.serverUrl,securityContext:e.securityContext?e.securityContext:"prefered",onComplete:function(t){if(-1!==H.indexOf(e.phyID))if(t.sheetIDList&&t.sheetIDList.length){N=[],L.push({parentID:e.phyID,dataType:e.dataType,sheetNodes:[],sheetIDList:t.sheetIDList,activatedSheet:null,fatherNode:e.parentNode,UDLLoader:p});for(var n=0;n<t.sheetIDList.length;n++)L[L.length-1].sheetNodes.push({parentID:e.phyID,modelID:t.sheetIDList[n],sheetID:"Drw."+e.phyID+"_"+t.sheetIDList[n],label:p.getSheetName(t.sheetIDList[n])});Y(),u(L[L.length-1].sheetNodes[0].sheetID)}else a(v.objectWithoutSheet,"on2DDocumentLoadError")},onFailure:c}):c();else if("DXF/DWG"===e.dataType||"DIFSheet"===e.dataType||"DIFLayout"===e.dataType){N=[];var m=e.loadedSheetInformations;if(!m||!m.sheetIDList||!m.sheetIDList.length)return void a(v.objectWithoutSheet,"onEmptyDocument");L.push({parentID:"DXF/DWG"===e.dataType?e.parentNode.modelIdentification:e.phyID,dataType:e.dataType,sheetNodes:e.sheetNodes,sheetIDList:m.sheetIDList,activatedSheet:null,fatherNode:e.parentNode,UDLLoader:p,getSheet3DNode:e.getSheet3DNode}),Y(),u(L[L.length-1].sheetNodes[0].sheetID)}else g()},this.loadDocumentStream=function(e){if(!e||!T)return;if(!e.onFailure)return;if(!e.documentID)return void e.onFailure();if(!e.type)return void e.onFailure();if(!e.fatherNode)return void e.onFailure();if(!e.onComplete)return void e.onFailure();let t=h.giveReqCompareController({context:T});t&&t.isLoading()||V.clean2DDocument();let n=l.giveEventsController({viewer:T.getViewer()});n&&n.fireEvent("on2DDocumentLoadStarted",{type:"Document"}),W++,L.push({parentID:e.documentID,dataType:e.type,fatherNode:null}),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}]).then(e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)});var r=p.giveSelectionManager({context:T});r&&r.setPicking(1),t&&(t.isLoading()||t.isRequirementCompareActive())?t.loadCompareRequirement(e.elementsToLoad,t.isRequirementCompareActive(),()=>{W--,V.initializeDMUEvents(),e.onComplete()}):"Document"===e.type||"Requirement"===e.type?require(["DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],function(t,r){A=t,I=r,O||(O=t.getWebDocumentVisualizationController({context:T})),O.loadDocumentStream({phyId:e.documentID,type:e.type,dataBuffer:e.dataBuffer,elementsToLoad:e.elementsToLoad,fatherNode:e.fatherNode,password:e.password,onPasswordOk:e.onPasswordOk,onIncorrectPassword:()=>{W--,e.onIncorrectPassword()},onComplete:async()=>{if("Document"===e.type){w||(T.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",$),w=new i({frameWindow:T.getFrameWindow(),onValueChanged:function(e){O.setCurrentElement({elementID:e})},maxValue:O.getDocumentLength()}));let e=O.getExternalComments(),t=O.getPDFHyperlinks();if(e&&e.length||t&&t.length)l.getReviewContext({viewer:T.getViewer()})||(await require("DS/DMUBaseUIControllers/DMUWebPreferencesController").init({context:T}),await u.createReviewContext({context:T}))}if(V.documentHasBookmarks()){E||(E=r.getWebDocumentBookmarksController({context:T}));let t=f.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",T.getCommandContext());if(t){let n=localStorage.getItem("DMUBookmarksPanelDisplayed");("true"===n||"false"!==n&&"Requirement"===e.type)&&setTimeout(function(){t.setState(!0)},100)}}W--,V.initializeDMUEvents(),n&&n.fireEvent("on2DDocumentLoadSuccess",{id:e.documentID,type:"Document"}),e.onComplete()},onFailure:t=>{n&&n.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),W--,t&&window.console.error("Error Loading Document Stream",t.message),e.onFailure(t)}})}):(W--,n&&n.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),e.onFailure(new Error("Data type not supported")))},this.clean2DDocument=function(e){if(T){if(e&&e.id){-1!==H.indexOf(e.phyID)&&H.splice(H.indexOf(e.phyID),1);for(let t=0;t<L.length;t++)if(L[t].parentID===e.id){L[t].fatherNode&&(L[t].fatherNode.removeChildren(),L[t].fatherNode=null),L.splice(t,1);break}}else if(L&&L.length){H.length=0;for(let e=0;e<L.length;e++)L[e].fatherNode&&(L[e].fatherNode.removeChildren(),L[e].fatherNode=null),L.splice(e,1)}if(y&&!L.length&&(y.clean(),y=null),!L||!L.length){if(w&&(w.clean(),T.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",$)),b&&T.getViewer().setPicking(b),M&&T.getViewer().setVisuEnvOCA(M),T.getViewer().get2DMode()){D&&T.getViewer().antiAliasing!==D&&"MSAA"===T.getViewer().antiAliasing&&T.getViewer().setAntiAliasing(D),T.getViewer().set2DMode(!1),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry"]}]).then(e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)});var t=p.giveSelectionManager({context:T});t&&t.setPicking(1)}T.getViewer().render(),void 0!==x&&U&&(U.setResponsiveDisplayFlag(x),x=void 0),V.removeDMUEvents(),O&&A&&(O.removeDocument(),A.unreferenceWebDocumentVisualizationController({context:T})),E&&I&&I.unreferenceWebDocumentBookmarksController({context:T}),U&&c.unreferenceDMUMarkupsController({context:T.getViewer()}),U=null,y=D=O=E=k=null,w=b=M=null}}},this.updateDocumentControllers=function(){O=A?A.giveWebDocumentVisualizationController({context:T}):null,E=I?I.giveWebDocumentBookmarksController({context:T}):null,O&&(L.length||L.push({}),L[0].dataType=O.getDocumentType(),L[0].parentID=O.getDocumentLoadedID())},this.initializeDMUEvents=function(){if(O&&(S||(S=new g),P||(P={onCurrentElementChange:O.subscribe("onCurrentElementChange",J),onZoomChange:O.subscribe("onZoomChange",function(e){if("start"===e.type)S.display({modal:!0,frmWindow:T.getFrameWindow(),type:"message",message:v.zoomLabel+" : "+e.value+" %"});else if("change"===e.type)S.updateMessage(v.zoomLabel+" : "+e.value+" %");else if(S.destroy(),O.getMultiPageVisibility()){var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")}}),onElementSelection:O.subscribe("onElementSelection",V.fireCrossWidgetSelection),onDocumentRotationAngleChange:O.subscribe("onDocumentRotationAngleChange",function(){var e=l.getReviewContext({context:T}),t=e?e.getVisibleMarkups():null;t&&t.map(e=>e.getCurrentSlide()).forEach(t=>{t&&t.updateEnvironmentOverload({target:e.getEnvironment(),state:e.getEnvironment().getEnvironmentInfo()})});var n=l.giveEventsController({viewer:T.getViewer()});n&&n.fireEvent("onDMUObjectsVisuRefreshRequired")})}),(U=c.getDMUMarkupsController({context:T.getViewer()}))&&(x=U.getResponsiveDisplayFlag())&&U.setResponsiveDisplayFlag(!1)),!R){R={};var e=l.giveEventsController({viewer:T.getViewer()});"Requirement"===L[0].dataType&&e&&(R.onCrossWidgetSelection=e.addEvent("onCrossWidgetSelection",Z)),e&&(R.onCrossWidgetFind=e.addEvent("onCrossWidgetFind",Q))}},this.removeDMUEvents=function(){if(O){if(P){Object.keys(P).forEach(e=>O.unsubscribe(P[e]))}S&&S.destroy(),void 0!==x&&U&&(U.setResponsiveDisplayFlag(x),x=void 0),c.unreferenceDMUMarkupsController({context:T.getViewer()})}if(R){var e=l.giveEventsController({viewer:T.getViewer()});e&&(R.onCrossWidgetSelection&&e.removeEvent(R.onCrossWidgetSelection),R.onCrossWidgetFind&&e.removeEvent(R.onCrossWidgetFind))}U=S=P=R=null},this.setCurrentElement=function(e){if(O)return O.setCurrentElement(e)},this.isADocumentDisplayed=function(){return L&&L[0]&&L[0].sheetNodes&&L[0].sheetNodes.length>0||O&&O.isADocumentDisplayed()},this.getDocumentRotationAngle=function(){if(O)return O.getDocumentRotationAngle()},this.getDocumentType=function(){return L&&L.length?L[0].dataType:null},this.getDocumentLoadedID=function(){if(L&&L.length&&L[0].parentID)return L[0].parentID},this.getExternalComments=function(){if(O)return O.getExternalComments()},this.getPDFHyperlinks=function(){if(O)return O.getPDFHyperlinks()},this.enableCurrentPageEdition=function(){if(w)return w.enableCurrentPageEdition()},this.setCurrentPageWidgetVisibleFlag=function(e){w&&w.setVisibility(e)},this.setTouchPanActive=function(e){if(O)return O.setTouchPanActive(e)},this.getElementsVisualizationData=function(){if(O)return O.getElementsVisualizationData()},this.getSelectedElementIDs=function(){if(O)return O.getSelectedElementIDs()},this.getElementInfo=function(e){if(O)return O.getElementInfo(e)},this.getElementMatrix=function(e){if(O)return O.getElementMatrix(e)},this.getPageRotation=function(e){if(O)return O.getPageRotation(e)},this.getPointedElemIDAtPosition=function(e){if(O)return O.getPointedElemIDAtPosition(e)},this.enableTextSelection=function(e){if(O)return O.enableTextSelection(e)},this.setTextSelectionFlag=function(e){if(O)return O.setTextSelectionFlag(e)},this.setLinkActivationFlag=function(e){if(O)return O.setLinkActivationFlag(e)},this.setRequirementCompareData=function(e){if(O)return O.setRequirementCompareData(e)},this.centerViewpointAtElementPosition=function(e){O&&(O.centerViewpointAtElementPosition(e),V.fireCrossWidgetSelection(e.elementID))},this.centerViewpointAtNextOrPreviousElement=function(e){if(O)return O.centerViewpointAtNextOrPreviousElement(e)},this.documentHasMultipleElements=function(){if(O)return O.getDocumentLength()>1},this.documentHasBookmarks=function(){if(!O)return!1;let e=O.getDocumentBookmarks();return Boolean(e&&e.length)},this.setDocumentRotation=function(e){O&&O.setDocumentRotationAngle(e)},this.setMultiPageVisibility=function(e){O&&O.setMultiPageVisibility(e);var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")},this.setBookmarksVisibility=function(e){E&&E.setPanelVisibilityFlag(e)},this.getElementToDraw=function(e){let t=L&&L.length?L[0].dataType:null;if(!t||"Document"!==t&&"Requirement"!==t)return T.getViewer().canvas;var n,i="Document"===t?"WebDocPageLayerPage":"WebDocReqElem";if(e){if(e.id.includes(i))return"Requirement"===t?e.parentElement.parentElement:e;for(n=e.parentNode;n;){if(n.id&&n.id.includes(i))return"Requirement"===t?n.parentElement.parentElement:n;n=n.parentElement}}return null},this.getPointedElem=function(){let e=L&&L.length?L[0].dataType:null;return"Document"===e||"Requirement"===e?T.getViewer().divCssElement:T.getViewer().canvas},this.getPageNumber=function(e){const t="WebDocPageLayerPage";return e&&e!==T.getViewer().canvas&&e.id.includes(t)?parseInt(e.id.slice(t.length)):null},this.getElementId=function(e){return e&&e!==T.getViewer().canvas&&e.id.includes("WebDocReqElem")?e.id.slice("WebDocReqElem".length+1):null},this.fireCrossWidgetSelection=function(e){let{dataType:t,parentID:n}=L&&L.length?L[0]:{};if(e&&e!==n&&k!==e&&"Requirement"===t){k=void 0;var i=l.giveEventsController({viewer:T.getViewer()});i&&i.fireEvent("onFireCrossWidgetSelection",{paths:[e.split("/")]})}},this.setNavBarVisibleFlag=function(e){e?B++:B--,y&&y.setVisibleFlag(B>0)},this.getNavBarVisibleFlag=function(){return y?y.getVisibleFlag():void 0},this.clean=function(){V.clean2DDocument(),C&&C.destroy(),C=F=T=null},this.setCurrentSheet=function(e){var t=e;t&&t.sheet&&(t.sheetID=_("sheetID",t.sheet)),K({sheetID:t.sheetID,parentID:t.parentID?t.parentID:_("parentID",t.sheetID),changeActiveSlide:!1,callback:t.callback})},this.getCurrentSheet=function(){return L&&L.length&&L[0].activatedSheet?_("sheetID",L[0].activatedSheet):null},this.setReviewPlayMode=function(e){j=e},this.getReviewPlayMode=function(){return j},this.getLoadedDocuments=(()=>L?L.slice():[]),this.getDocumentData=function(e){let t,n,i,r=[];for(let t=0;t<L.length;t++)if(L[t].parentID===e){i=t;break}if(void 0!==i&&L[i]&&L[i].sheetIDList){t=L[i].activatedSheet,n=L[i].sheetIDList;for(let e=0;e<L[i].sheetNodes.length;e++)r.push(L[i].sheetNodes[e].label);return{activatedSheetID:t,sheetIDList:n,sheetNames:r}}}}})});