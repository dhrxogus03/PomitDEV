/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENORIPE_Columns/utils/NavWSProxy",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/PADServices/utils/GlobalUtils","UWA/Promise","DS/ENOXWidgetPreferences/js/ENOXWidgetPreferences","DS/SNNavigationMap/utils/MapSecurityCtxConverter","DS/ENORIPE_Relations/RelationsTabSettings"],function(e,t,n,o,i,s,r,a){var l=function(e,n,o){return new i(function(i,s){n.onComplete=function(e){var t=function(e){return"string"==typeof e?JSON.parse(e):e}(e),n=t;o&&(n=o(t)),i(n)},n.onFailure=function(e){s(e)},n.data&&(n.data=JSON.stringify(n.data)),function(e,n,o){t.authenticatedRequest(e,n)}(e,n)})};return{getrelationprofiles:function(e,t){var o=n.get3DSpaceUrl(),i={};return o=o+"/resources/enorelnav/v2/navigate/getProfiles?tenant="+n.getPlatformId(),i.method="POST",i.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:this.getXPrefCredential()},i.data={widgetId:n.getWidgetId(),label:"DGV-RelationColumns-"+Date.now(),roles:e,lang:widget&&widget.lang?widget.lang:"en"},l(o,i,!1)},getRelationSettings:function(e,t){var o=n.get3DSpaceUrl(),i={label:"DGV-RelationColumns-"+Date.now()};return o=o+"/resources/enorelcc/cc_services/getrelsettings?tenant="+n.getPlatformId(),i.method="GET",i.headers={Accept:"application/json","Content-Type":"application/json"},l(o,i,!1)},getMergedProfiles:function(e,t,n){var o=this,s=!1;return new i(function(i,r){t.relation_sets&&t.relation_sets.length||i(e);e.profiles.map(function(e){return e.name});for(var a=0;a<t.relation_sets.length;a++){for(var l=t.relation_sets[a].roles,d=t.relation_sets[a].userGroups,u=!1,c=0;c<l.length;c++)if(n.indexOf(l[c])>-1){u=!0;break}if(d.length>0&&!u){s=!0;break}}s?o._getGrantedUsrGrp().then(function(s){s=o._parseUserGroups(s),e=o._filterRelSets(e,t,s,n),i(e)}):(e=o._filterRelSets(e,t,[],n),i(e))})},getAllProfilesAndSettings:function(e){var t=this,n=this.getrelationprofiles(e),o=this.getRelationSettings();return new i(function(s,r){i.all([n,o]).then(function(n){var o=n[0],i=n[1];t._parseSettings(i).then(function(n){t.getMergedProfiles(o,n,e).then(function(e){s([e,n])})}).catch(()=>{s()})}).catch(()=>{s()})})},getAppId:function(){return n.getAppId()},getUserID:function(){return n.getUserLogin()},addCredentialPreferenceToWidget:function(){var e=this,t="";return new i(function(n,o){e.isWebInWin()?e._getListOfSecurityContext().then(function(t){e.setXPrefCredential(t[0].value),n()}):(t=widget.getValue("xPref_CREDENTIAL"))&&""!==t?(e.setXPrefCredential(t),n()):s.addCredentialPreferenceToWidget({usePreferredCredentials:!0}).then(function(){(t=widget.getValue("xPref_CREDENTIAL"))||(t=widget.getPreference("xPref_CREDENTIAL").options[0].value,widget.setValue("xPref_CREDENTIAL",t)),e.setXPrefCredential(t),n()})})},_getListOfSecurityContext:function(){var e=this;return new i(function(t,n){e.getAllSecurityContexts().then(function(e){var o=[];if(e&&e.cspaces){var i=e.cspaces;if(Array.isArray(i))for(var s=0;s<i.length;s++)o[s]={label:i[s].label,value:i[s].value};JSON.stringify(o),t(o)}else n("collabspaces not found")})})},getAllSecurityContextsUrl:function(){return n.get3DSpaceUrl()+"/resources/modeler/pno/person?current=true&select=preferredcredentials&select=collabspaces&tenant="+n.getPlatformId()},getAllSecurityContexts:function(){var e=this;return new i(function(n,o){e.map_AllSecurityContexts&&""!=e.map_AllSecurityContexts?n(e.map_AllSecurityContexts):t.authenticatedRequest(e.getAllSecurityContextsUrl(),{headers:{Accept:"application/json","Content-Type":"application/json"},method:"GET",type:"json",proxy:"passport",onComplete:function(t){if(null!==t){var o=r.getSecurityContext(t);e.map_AllSecurityContexts=o,n(o)}},onFailure:function(e){o(e)}})})},getXPrefCredential:function(){return 0!==this._xPrefCredential.indexOf("ctx::")&&(this._xPrefCredential="ctx::"+this._xPrefCredential),this._xPrefCredential},setXPrefCredential:function(e){this._xPrefCredential=e},isWebInWin:function(){return"undefined"!=typeof dscef||"undefined"!=typeof CATCefSendString},_parseSettings:function(e){var t=this;return new i(function(n,o){e.notexist||void 0===e.relation_apps?t._getResetRelApps().then(function(t){n(e=t)}):n(e)})},_getResetRelApps:function(){var e=n.get3DSpaceUrl(),t={};return e=e+"/resources/enorelcc/cc_services/getrelappsinit?tenant="+n.getPlatformId(),t.method="GET",t.headers={Accept:"application/json","Content-Type":"application/json"},l(e,t,!1)},_getGrantedUsrGrp:function(){var e=n.get3DSearchUrl()+"/search",t={},o=n.getUserLogin()||"";return t.method="POST",t.headers={Accept:"application/json","Content-Type":"application/json"},t.data={label:"ENORIPE_"+o+"_"+Date.now(),select_predicate:["ds6w:label"],query:"[ds6w:type]:GROUP AND "+o,tenant:n.getPlatformId(),nresults:100,with_synthesis_attribute:!1,with_synthesis:!1},l(e,t,!1)},_parseUserGroups:function(e){var t=[];if(e&&e.results)for(var n=0;n<e.results.length;n++){var o=e.results[n];if(o.attributes){for(var i={},s=0;s<o.attributes.length;s++)"resourceid"===o.attributes[s].name&&(i.resourceid=o.attributes[s].value),"ds6w:label"===o.attributes[s].name&&(i.label=o.attributes[s].value);void 0!==i.resourceid&&t.push(i)}}return t},_filterRelSets:function(e,t,n,o){for(var i=e.profiles.map(function(e){return e.name}),s=(n=n.map(function(e){return e.resourceid}),0);s<t.relation_sets.length;s++){var r=t.relation_sets[s].roles,a=t.relation_sets[s].userGroups,l=!1;r&&r.length>0&&(r=r.map(function(e){return e.name})),a&&a.length>0&&(a=a.map(function(e){return e.name}));for(var d=0;d<r.length;d++)if(o.indexOf(r[d])>-1){l=!0;break}if(!l)for(d=0;d<a.length;d++)if(n.indexOf(a[d])>-1){l=!0;break}var u=i.indexOf(t.relation_sets[s].name);l?-1===u?e.profiles.push(t.relation_sets[s]):e.profiles.splice(u,1,t.relation_sets[s]):-1!==u&&e.profiles.splice(u,1)}return e}}}),define("DS/ENORIPE_Columns/WSRelations",["DS/WAFData/WAFData","DS/PADServices/utils/GlobalUtils","DS/PADServices/utils/PlatformURL","DS/PADServices/utils/PCSTracker","DS/ENORIPE_Columns/utils/NavWSProxy"],function(e,t,n,o,i){"use strict";function s(){return"object"==typeof s.instance?s.instance:(s.instance=this,this)}return s.prototype.executeRequest=function(t,n,i,s){var r=o.networkprobe({url:t,request_options:n});return e.authenticatedRequest(t,r)},s.prototype.getCount=function(e){return n.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}),new Promise(function(o,s){var r=n.get3DSpaceURL(),a={onComplete:o,onFailure:s};r=r+"/resources/enorelnav/v2/navigate/getRelationCount?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:i.getXPrefCredential()},console.log(i.getXPrefCredential()),a.data=JSON.stringify({widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),label:"DGV-RelationColumns-"+Date.now(),ids:e.ids,relations:e.relations,computeWithInstances:!1}),this.executeRequest(r,a)}.bind(this))},s.prototype.getDetail=function(e){return new Promise(function(o,s){var r=n.get3DSpaceURL(),a={onComplete:o,onFailure:s};r=r+"/resources/enorelnav/v2/navigate/getEcosystem?tenant="+n.getPlatformId(),a.method="POST",a.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:i.getXPrefCredential()},a.data={widgetId:"DGV-RelationColumns-"+t.getWidgetId()+"-"+Date.now(),label:"DGV-RelationColumns-"+Date.now(),responseMode:"objectsByPatterns",computeWithInstances:!1},a.data=Object.assign(a.data,e),a.data=JSON.stringify(a.data),this.executeRequest(r,a)}.bind(this))},new s}),define("DS/ENORIPE_Columns/RelationsColumns",["text!DS/ENORIPE_Columns/assets/ColumnsDefinition.json","i18n!DS/ENORIPE_Columns/assets/nls/ENORIPE_Columns","DS/ENORIPE_Columns/WSRelations","DS/PADServices/utils/AttributesMgtV2","DS/PADServices/utils/DictionaryAccess","DS/CoreEvents/ModelEvents","DS/PADServices/utils/GlobalUtils","DS/ENORIPE_Columns/utils/NavWSProxy"],function(e,t,n,o,i,s,r,a){"use strict";var l=new s,d={BME:["v6_cad_document_drawing_to","v6_cad_document_analysis_to","v6_cad_document_process_to"]};function u(){if("object"==typeof u.instance)return u.instance;u.instance=this,this.relationColumnsDef=JSON.parse(e),this.alwaysUpdate=!1,this.dataIndexes=[],l.subscribe({event:"ENXRelationsCol/AddGroupingNodes"},this._addGroupingNodes.bind(this)),l.subscribe({event:"ENXRelationsCol/ShowGroupingNodes"},this._showGroupingNodes.bind(this)),l.subscribe({event:"ENXRelationsCol/HideGroupingNodes"},this._hideGroupingNodes.bind(this))}function c(e,t,n,o){var i=new e.options.nodeModelClass(n);i.isRelationsObjectNode=!0;var s,r=t.getRoot().getID(),a=t.getState(),d=t.getChildren();return d&&d.length?!0===d[0].isRelationsObjectGroupingNode?(d[0].addChild(i),s=d[0]):((s=p({treeDoc:e,parentId:t.getID()})).addChild(i),t.insertBefore(s,d[0])):((s=p({treeDoc:e,parentId:t.getID()})).addChild(i),t.addChild(s)),!0===u.groupingNodeHidden&&s.hide(),l.publish({event:"ENXRelationsCol/AddGroupingNodes",data:{groupingNode:s,rootId:r}}),!0===o&&s.setState({state:"expanded"}),"noChildren"===a?t.setState({state:"expanded"}):"collapsed"===a&&t.childComputed&&t.getReferenceValue("ds6w:kind")&&-1!==t.getReferenceValue("ds6w:kind").indexOf("3DPart")?t.setState({state:"expanded"}):"collapsed"===a&&!1===t.childComputed?t.setState({state:"expanded"}):t.setState({state:a}),i}function p(e){var n={resourceid:"fakeNode-"+e.parentId,label:t.fakeGroupingNode.label,childComputed:!0,icons:[{iconName:"object-related",fontIconFamily:1}],thumbnail:{iconName:"object-related",fontIconFamily:1},grid:{},children:[]},o=new e.treeDoc.options.nodeModelClass(n);return o.isRelationsObjectNode=!0,o.isRelationsObjectGroupingNode=!0,o.childComputed=!0,o}return u.prototype.setupCallback=function(e){e.treeDocModelEvents&&e.treeDocModelEvents.subscribe({event:"preRemoveChild"},this._cleanupGroupingNodes.bind(this)),e.globalModelEvents&&e.globalModelEvents.subscribe({event:"ENXModel/UpdateAdditionalColumns"},this._forceUpdateAttributes.bind(this))},u.groupingNodeHidden=!localStorage.getItem("enx-relation-groupingNode-hide_"+r.getAppId())||"true"===localStorage.getItem("enx-relation-groupingNode-hide_"+r.getAppId()),u.prototype.isAdditionalColumnsAvailable=function(e){for(var t=Object.keys(this.relationColumnsDef.patterns),n=[],o=0;o<t.length;o++)this.relationColumnsDef.patterns[t[o]].nlsPatternAMD&&-1===n.indexOf(this.relationColumnsDef.patterns[t[o]].nlsPatternAMD)&&n.push(this.relationColumnsDef.patterns[t[o]].nlsPatternAMD);a.addCredentialPreferenceToWidget().then(function(){n.length?require(n,function(){e(!0)}):e(!0)})},u.prototype.getName=function(){return"RelationsColumns"},u.prototype.getManagedColumnNames=function(){return this.dataIndexes=this.columnsPreference.availableDataIndexes,this.dataIndexes},u.prototype.getAutoReloadNames=function(){return this.columnsPreference.addAutoPatterns},u.prototype.setPreferenceProxy=function(e){u.prototype.setPreference=e.setPreference,u.prototype.getPreference=e.getPreference,u.prototype.relationsColumnsList=e.relationsColumnsList,this.columnsPreference=this.getPreference();var t={};this.columnsPreference&&(t=JSON.parse(this.columnsPreference)),this._buildDefaultConfiguration(this.relationsColumnsList),this.columnsPreference=UWA.extend(this.columnsPreference,t,!0),this.setPreference(JSON.stringify(this.columnsPreference)),this.columnsPreference.addAutoPatterns&&this.columnsPreference.addAutoPatterns.length>0&&(this.alwaysUpdate=!0)},u.prototype.hasStructureModelUpdate=function(){return!(!that.columnsPreference.addAutoPatterns||!that.columnsPreference.addAutoPatterns.length)},u.prototype.setupDGVManipulation=function(e){u.prototype.addColumns=e.onAddColumn,u.prototype.removeColumns=e.onRemoveColumn},u.prototype.toBeUpdated=function(e,t){if("SyncModelRefresh"===t||"SyncModelNodes"===t||"OnSyncModel"===t)return!0;for(var n=!1,o=Object.keys(e),i=0;i<o.length&&!1===n;i++)""!==e[o[i]]&&void 0!==e[o[i]]||(n=!0);return n},u.prototype._forceUpdateAttributes=function(e){this.updateAttributes(e.nodesToUpdate,e.callback,e.treedocument)},u.prototype.updateAttributes=function(e,t,o){var i={pids:{},relids:{}},s=this,r=[],l=Promise.resolve();a._xPrefCredential||(l=a.addCredentialPreferenceToWidget(),r.push(l)),e.pids.forEach(function(e){i.pids[e]||(i.pids[e]={});for(var t=0;t<s.dataIndexes.length;t++)i.pids[e][s.dataIndexes[t]]=void 0});var d=new Promise(function(t){l.then(function(){n.getCount({ids:e.pids,relations:s.dataIndexes}).then(function(t){e.pids.forEach(function(e){for(var t=0;t<s.dataIndexes.length;t++)i.pids[e][s.dataIndexes[t]]=0});for(var n=(t="string"==typeof t?JSON.parse(t):t).counts,o=0;o<n.length;o++)i.pids[n[o].source][n[o].name]=parseInt(n[o].count)}).finally(t)})});r.push(d),r.push(new Promise(function(t){d.then(function(){s._autoAddInView({pids:e.pids,updatedAttributes:i,treedocument:o}).then(t)})})),Promise.all(r).then(function(){"function"==typeof t&&t(i)})},u.prototype.getAdditionalColumnsUXDGV=function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].dataIndex);0===this.dataIndexes.length&&this.getManagedColumnNames();for(var o=0;o<this.dataIndexes.length;o++){var i=this.dataIndexes[o],s=this.columnsPreference.patterns[i]&&this.columnsPreference.patterns[i].nlsPatternAMD,r=require(s),a=this._buildDGVColumn(this.dataIndexes[o]),l=t.indexOf(i),d=i;-1===l?(a.text=r[d]?r[d]:"",e.push(a)):(e[l]=UWA.extend(e[l],a,!0),e[l].text=r[d]?r[d]:"")}},u.prototype.provideDisplayTooltip=function(e){var n=null;return e.nodeModel&&-1!==this.dataIndexes.indexOf(e.dataIndex)&&(n=t[e.dataIndex]&&t[e.dataIndex].columnTooltip?t[e.dataIndex].columnTooltip:""),n},u.prototype.getTypeRepresentations=function(){for(var e={relColNone:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"",fontIconFamily:WUXManagedFontIcons.Font3DS}}},relColLoading:{stdTemplate:"functionIcon",semantics:{className:"relationRefresh",icon:{iconName:"reload wux-ui-3ds-spin",fontIconFamily:WUXManagedFontIcons.Font3DS}}}},t=Object.keys(this.columnsPreference.patterns),n=0;n<t.length;n++)this.columnsPreference.patterns[t[n]].typeRepresentations&&(e=Object.assign(e,this.columnsPreference.patterns[t[n]].typeRepresentations)),e[t[n]+"Check"]||(e[t[n]+"Check"]={stdTemplate:"functionIcon",semantics:{icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS}}});return e},u.prototype.getOnCellClickCB=function(e){if(-1!==this.dataIndexes.indexOf(e)){var t=this;return function(s){if(s.nodeModel){var r=s.nodeModel,a=r.getTreeDocument();if(a.unselectAll(),s.nodeModel.options.grid[e]>0){var l=r.getID(),d=o.createOutputsRequest("fetch"),u=r.options.icons;u[0].badges||(u[0].badges={}),u[0].badges.topRight={iconName:"reload wux-ui-3ds-spin",fontIconSize:"1x",className:"dgv-badge-top"},r.updateOptions({icons:u}),n.getDetail({id:l,relations:[e],attributesForView:d.select_predicate?d.select_predicate:d.select_object}).then(function(n){n="string"==typeof n?JSON.parse(n):n,a.withTransactionUpdate(function(){for(var o=n.objectsByPatterns[e],s=(r.getState(),0);s<o.length;s++){var l=o[s],d=r.getNodesByRelId(l.relation);if(0===d.length){var u=t._buildNode(l),p=c(a,r,u,!0);i.updateNLS(p),p.select()}else{d[0].select();var f=d[0]._parentNode;f&&f.setState({state:"expanded"})}}t._showGroupingNodes({treeDoc:a});var g=UWA.clone(r.options.icons);g[0].badges&&(g[0].badges.topRight=null),r.updateOptions({icons:g})})})}}}}},u.prototype.getAdditionalCtxMenu=function(e){var n,o=!1;"datagridview"===e.view&&(o=-1===e.ctxParams.cellInfos.rowID,n=e.ctxParams.collectionView.getColumnOrGroup(e.ctxParams.cellInfos.columnID).dataIndex);var i=[];"tree"===n&&!0===o?(u.groupingNodeHidden?i.push({type:"PushItem",fonticon:{family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-eye"},title:t.ctxCommands.showRelated,action:{callback:function(){l.publish({event:"ENXRelationsCol/ShowGroupingNodes",data:{treeDoc:e.treeDocument}}),u.groupingNodeHidden=!1,localStorage.setItem("enx-relation-groupingNode-hide_"+r.getAppId(),"false")}}}):i.push({type:"PushItem",fonticon:{family:"DSFontIcon",content:"wux-ui-3ds wux-ui-3ds-eye-off"},title:t.ctxCommands.hideRelated,action:{callback:function(t){l.publish({event:"ENXRelationsCol/HideGroupingNodes",data:{treeDoc:e.treeDocument}}),u.groupingNodeHidden=!0,localStorage.setItem("enx-relation-groupingNode-hide_"+r.getAppId(),"true")}}}),e.callback(this.getName(),i)):e.callback(null)},u.prototype.resetConfiguration=function(){var t=[],n=[];this.relationColumnsDef=JSON.parse(e);for(var o=Object.keys(this.relationColumnsDef.patterns),i=0;i<o.length;i++){var s=this.relationColumnsDef.patterns[o[i]];if("boolean"==typeof s.dgvColumnAvailable)if(this.columnsPreference.patterns[o[i]]){if(this.columnsPreference.patterns[o[i]].dgvColumnAvailable!==s.dgvColumnAvailable)if(!0===s.dgvColumnAvailable){r=this._buildDGVColumn(o[i]),a=this.columnsPreference.patterns[o[i]]&&this.columnsPreference.patterns[o[i]].nlsPatternAMD,l=require(a);r.text=l[o[i]]?l[o[i]]:"",t.push(r)}else n.push({dataIndex:o[i]})}else if(this.columnsPreference.patterns[o[i]]=s,!0===s.dgvColumnAvailable){var r=this._buildDGVColumn(o[i]),a=this.columnsPreference.patterns[o[i]]&&this.columnsPreference.patterns[o[i]].nlsPatternAMD,l=require(a);r.text=l[o[i]]?l[o[i]]:"",t.push(r)}}t.length>0&&this.addColumns&&this.addColumns({addedColumns:t}),n.length>0&&this.removeColumns&&this.removeColumns({removedColumns:n}),this._buildDefaultConfiguration(this.relationsColumnsList),this.columnsPreference.addAutoPatterns&&this.columnsPreference.addAutoPatterns.length>0&&(this.alwaysUpdate=!0),this.setPreference(JSON.stringify(this.columnsPreference))},u.prototype.updateConfiguration=function(e){for(var t=Object.keys(e),n=[],o=[],i=0;i<t.length;i++){if("boolean"==typeof e[t[i]].dgvColumnAvailable)if(this.columnsPreference.patterns[t[i]].dgvColumnAvailable=e[t[i]].dgvColumnAvailable,!0===this.columnsPreference.patterns[t[i]].dgvColumnAvailable){var s=this._buildDGVColumn(t[i]),r=this.columnsPreference.patterns[t[i]]&&this.columnsPreference.patterns[t[i]].nlsPatternAMD,a=require(r);s.text=a[t[i]]?a[t[i]]:"",n.push(s)}else o.push({dataIndex:t[i]});"boolean"==typeof e[t[i]].autoAdd&&(this.columnsPreference.patterns[t[i]].autoAdd=e[t[i]].autoAdd)}n.length>0&&this.addColumns&&this.addColumns({addedColumns:n}),o.length>0&&this.removeColumns&&this.removeColumns({removedColumns:o}),this._rebuildConfiguration(),this.columnsPreference.addAutoPatterns&&this.columnsPreference.addAutoPatterns.length>0&&(this.alwaysUpdate=!0),this.setPreference(JSON.stringify(this.columnsPreference))},u.prototype._buildDGVColumn=function(e){var t={dataIndex:e,alignment:"center",editableFlag:!1,sortableFlag:!1,width:50,minWidth:50,visibleFlag:!1,isAdditionalColumn:!0,getCellTypeRepresentation:function(t){if(t.nodeModel){var n=t.nodeModel.options.grid[e];return!0===t.nodeModel.isRelationsObjectNode?"relColNone":void 0!==n&&""!==n?n>0?e+"Check":"relColNone":"relColLoading"}},getCellSemantics:function(t){if(t.nodeModel){var n=t.nodeModel.options.grid[e];if(void 0===n||""===n||0===n)return{disabled:!0}}},customisation:{dataIndex:e,exportable:{lock:!1,value:!1},layout:{removable:!1}}},n=this.columnsPreference.patterns[e]&&this.columnsPreference.patterns[e].dgvOpts?this.columnsPreference.patterns[e].dgvOpts:{};return t=UWA.extend(t,n),UWA.clone(t)},u.prototype._autoAddInView=function(e){var t=this;return new Promise(function(s){if(e.treedocument&&t.columnsPreference.addAutoPatterns&&t.columnsPreference.addAutoPatterns.length){var r,a=e.pids,l=[],d=t.columnsPreference.addAutoPatterns,u=e.treedocument,p=o.createOutputsRequest("fetch");for(r=0;r<a.length;r++){u.getNodesById(a[r]).forEach(function(e){if(!0!==e.isRelationsObjectNode){var t=e.options.icons;t[0].badges||(t[0].badges={}),t[0].badges.topRight={iconName:"reload wux-ui-3ds-spin",fontIconSize:"1x",className:"dgv-badge-top"},e.updateOptions({icons:t})}})}n.getDetail({ids:a,relations:d,attributesForView:p.select_predicate?p.select_predicate:p.select_object}).then(function(e){e="string"==typeof e?JSON.parse(e):e,u.withTransactionUpdate(function(){for(r=0;r<d.length;r++){var n=d[r],o=e.objectsByPatterns[n];if(o)for(var p=0;p<o.length;p++){var f=o[p],g=f.relations[0].source;-1===l.indexOf(g)&&l.push(g);for(var h=u.getNodesById(g),m=0;m<h.length;m++){var v=h[m];if(!0!==v.isRelationsObjectNode){if(0===v.getNodesById(f.id).length){var C=t._buildNode(f),P=c(u,v,C);i.updateNLS(P)}var b=UWA.clone(v.options.icons);b[0].badges&&(b[0].badges.topRight=null),v.updateOptions({icons:b})}}}}for(r=0;r<a.length;r++){if(-1===l.indexOf(a[r]))(h=u.getNodesById(a[r])).forEach(function(e){var t=UWA.clone(e.options.icons);t[0].badges&&(t[0].badges.topRight=null),e.updateOptions({icons:t})})}s()})}).catch(function(e){console.warn("Retrieve the pattern fails:"+JSON.stringify(e)),s()})}else s()})},u.prototype._buildDefaultConfiguration=function(e){var t=[];if(Array.isArray(e))for(var n=Object.keys(this.relationColumnsDef.patterns),o=0;o<e.length;o++)-1!==n.indexOf(e[o])&&t.push(e[o]);this.columnsPreference=this.relationColumnsDef,this.columnsPreference.availableDataIndexes=t,this.dataIndexes=t,this.columnsPreference.addAutoPatterns=[]},u.prototype.setHardcodedConfiguration=function(e){var t=[],n=[],o=Object.keys(this.relationColumnsDef.patterns);if(u.groupingNodeHidden=!1,d.hasOwnProperty(e)){console.log("set harcoded configuration for "+e+" : "+d.key);for(var i=0;i<d[e].length;i++)-1!==o.indexOf(d[e][i])&&n.push(d[e][i])}this.columnsPreference=this.relationColumnsDef,this.columnsPreference.availableDataIndexes=t,this.dataIndexes=t,this.columnsPreference.addAutoPatterns=n,this.columnsPreference.addAutoPatterns&&this.columnsPreference.addAutoPatterns.length>0&&(this.alwaysUpdate=!0)},u.prototype._rebuildConfiguration=function(){for(var e=[],t=[],n=Object.keys(this.columnsPreference.patterns),o=0;o<n.length;o++)!0===this.columnsPreference.patterns[n[o]].dgvColumnAvailable&&e.push(n[o]),!0===this.columnsPreference.patterns[n[o]].autoAdd&&t.push(n[o]);this.columnsPreference.availableDataIndexes=e,this.dataIndexes=e,this.columnsPreference.addAutoPatterns=t},u.prototype._buildNode=function(e){for(var t=o.createOutputsRequest("fetch"),n={resourceid:e.id,relationid:e.relation,label:e["ds6w:label"],icons:[{iconPath:"url("+e.type_icon_url+")",className:"dgv-icons"}],type:e["ds6w:type"],thumbnail:e.thumbnail,relationOrder:-2,grid:{thumbnail:e.thumbnail},children:null},i=t.select_predicate?t.select_predicate:t.select_object,s=0;s<i.length;s++)"ds6w:label"!==i[s]&&(n.grid[i[s]]=e[i[s]]);return n},u.prototype.hasHiddenGroupingNodes=function(){return this._hiddenGroupingNodes&&this._hiddenGroupingNodes.length},u.prototype._addGroupingNodes=function(e){var t=e.groupingNode,n=e.rootId;t&&n&&(this._groupingNodes||(this._groupingNodes={}),this._groupingNodes[n]||(this._groupingNodes[n]=[]),this._groupingNodes[n].push(t))},u.prototype._showGroupingNodes=function(e){if(this._groupingNodes){var t=this;e.treeDoc.withTransactionUpdate(function(){for(var e=Object.keys(t._groupingNodes),n=0;n<e.length;n++)for(var o=t._groupingNodes[e[n]],i=0;i<o.length;i++){o[i].show();var s=o[i]._parentNode;s&&"expanded"!==s.getState()&&s.setState({state:"partiallyExpanded"})}})}u.groupingNodeHidden=!1},u.prototype._hideGroupingNodes=function(e){if(this._groupingNodes){var t=this;e.treeDoc.withTransactionUpdate(function(){for(var e=Object.keys(t._groupingNodes),n=0;n<e.length;n++)for(var o=t._groupingNodes[e[n]],i=0;i<o.length;i++)o[i].hide()})}u.groupingNodeHidden=!0},u.prototype._cleanupGroupingNodes=function(e){if(this._groupingNodes){var t=e.data.nodeModel;if(t&&t.isRoot())this._groupingNodes[t.getID()]&&delete this._groupingNodes[t.getID()];else{var n=t.getRoot();n&&this._groupingNodes[n.getID()]&&(this._groupingNodes[n.getID()]=this._groupingNodes[n.getID()].filter(function(e){return-1!==e.getOccurencePath().indexOf(t.getID())}))}}},new u}),define("DS/ENORIPE_Columns/RelationsColumnsCmd",["DS/ENORIPE_Columns/RelationsColumns","DS/ApplicationFrame/Command","css!DS/ENORIPE_Columns/ENORIPE_Columns","i18n!DS/ENORIPE_Columns/assets/nls/ENORIPE_Columns","DS/Controls/Button","DS/Controls/Accordeon","DS/Controls/Toggle","DS/PADUtils/PADContext"],function(e,t,n,o,i,s,r,a){"use strict";return t.extend({init:function(e){this._parent(e);var t=a.get();this._checkIfTreeview(),UWA.is(t.addEvent,"function")&&t.addEvent("onToggleView",this._checkIfTreeview.bind(this))},execute:function(){var t=this;this.columnsPreference=JSON.parse(e.getPreference()),this.changes={},require(["DS/ENOFloatingPanel/ENOFloatingPanel"],function(e){t.elements={},t._buildContent().then(function(){t.elements.floatingpanel=new e({className:"enx-relationcolmgt",body:t.elements.container,footer:t._buildFooter(),title:o.relationsColumnsMgt.title,overlay:!0,closable:!0,animate:!0,resizable:!0,visible:!0,events:{onClose:function(){t.elements.floatingpanel.destroy()}}}),t.elements.floatingpanel.inject(document.body)})})},_buildContent:function(){return new Promise(function(t){this.elements.container=document.createElement("div"),this.elements.container.classList.add("enx-relmgt-container");var n=e.relationColumnsDef;this.columnsPreference.addAutoPatterns||(this.columnsPreference.addAutoPatterns=[]);var i=e.relationsColumnsList,a=this,l=function(t){var n=document.createElement("div");n.classList.add("enx-relmgt-expander"),n.classList.add(t);var i=-1!==e.dataIndexes.indexOf(t),s=new r({type:"switch",label:o.relationsColumnsMgt.columnAvailable,value:t,checkFlag:i,touchMode:!0});n.appendChild(s.getContent()),s.addEventListener("change",a._colAvailablityMgt.bind(a));var l=-1!==a.columnsPreference.addAutoPatterns.indexOf(t),d=new r({type:"switch",label:o.relationsColumnsMgt.autoAdd,value:t,checkFlag:l,touchMode:!0});n.appendChild(d.getContent());var u=document.createElement("div");return u.classList.add("enx-relmgt-autoAddInfo"),u.classList.add(t),u.innerText=o.relationsColumnsMgt.autoAddInfo,!0===l?u.removeAttribute("hidden"):u.setAttribute("hidden",""),n.appendChild(u),d.addEventListener("change",a._autoAddMgt.bind(a)),n};if(1===i.length){this.elements.container.classList.add("enx-relmgt-single-pattern");var d=n.patterns[i[0]],u=require(d.nlsPatternAMD),c=document.createElement("div");c.classList.add("enx-relmgt-title-pattern"),c.innerText=u[i[0]],this.elements.container.appendChild(c);var p=l(i[0]);this.elements.container.appendChild(p)}else if(i.length>1){var f=this.elements.accordion=new s({style:"filled-separate",exclusive:!1});this.elements.container.appendChild(f.getContent());for(var g=0;g<i.length;g++){p=l(i[g]),d=n.patterns[i[g]],u=require(d.nlsPatternAMD);f.addItem({header:u[i[g]],body:p,expandedFlag:!0})}}t()}.bind(this))},_buildFooter:function(){var t=this,n=UWA.createElement("div",{class:"footerModal"}),s=new i({label:o.relationsColumnsMgt.save,emphasize:"primary",touchMode:!0});s.addEventListener("click",function(){e.updateConfiguration(t.changes),t.elements.floatingpanel.destroy()}),s.inject(n);var r=new i({label:o.relationsColumnsMgt.reset,emphasize:"secondary",touchMode:!0});r.addEventListener("click",function(){e.resetConfiguration(),t.elements.floatingpanel.destroy()}),r.inject(n);var a=new i({label:o.relationsColumnsMgt.cancel,emphasize:"secondary",touchMode:!0});return a.addEventListener("click",function(){t.elements.floatingpanel.destroy()}),a.inject(n),n},_colAvailablityMgt:function(e){this.changes[e.dsModel.value]||(this.changes[e.dsModel.value]={}),this.changes[e.dsModel.value].dgvColumnAvailable=e.dsModel.checkFlag},_autoAddMgt:function(e){this.changes[e.dsModel.value]||(this.changes[e.dsModel.value]={}),this.changes[e.dsModel.value].autoAdd=e.dsModel.checkFlag;var t=this.elements.container.getElementsByClassName("enx-relmgt-autoAddInfo "+e.dsModel.value);1===t.length&&(!0===e.dsModel.checkFlag?(this.elements.container.classList.add("withAutoAddInfo"),t[0].removeAttribute("hidden")):(this.elements.container.classList.remove("withAutoAddInfo"),t[0].setAttribute("hidden","")),this.elements.floatingpanel.onResize())},_checkIfTreeview:function(){switch(a.get().getCurrentView()){case"datagridview":this.enable();break;default:this.disable()}}})});