/*!  Copyright 2020 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXRobotWithRuler/CATWebUXRobotWithRuler",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(n,e,i,t,o,r,a){"use strict";var l=150,s=150,u=1;return n.extend({init:function(n){var c,g,p,d,b,f,v,M,y,V,h,x=n.frameWindow,w=x.getViewer(),m=n.lightDisplay,R=!1,P=!1,O=n.getRulerUnitCB,C=n.getAngularRulerUnitCB,T=n.checkDirforRuler;Object.defineProperty(this,"robotMatrixCompute",{set:function(n){"function"==typeof n&&(c=n)},get:void 0}),Object.defineProperty(this,"robotOrigin3DCompute",{set:function(n){"function"==typeof n&&(g=n)},get:void 0}),Object.defineProperty(this,"moveBegin",{set:function(n){"function"==typeof n&&(p=n)},get:void 0}),Object.defineProperty(this,"move",{set:function(n){"function"==typeof n&&(d=n)},get:void 0}),Object.defineProperty(this,"moveEnd",{set:function(n){"function"==typeof n&&(b=n)},get:void 0}),Object.defineProperty(this,"moveRobotBegin",{set:function(n){"function"==typeof n&&(f=n)},get:void 0}),Object.defineProperty(this,"moveRobot",{set:function(n){"function"==typeof n&&(v=n)},get:void 0}),Object.defineProperty(this,"moveRobotEnd",{set:function(n){"function"==typeof n&&(M=n)},get:void 0}),Object.defineProperty(this,"moveRulerOriginBegin",{set:function(n){"function"==typeof n&&(y=n)},get:void 0}),Object.defineProperty(this,"moveRulerOrigin",{set:function(n){"function"==typeof n&&(V=n)},get:void 0}),Object.defineProperty(this,"moveRulerOriginEnd",{set:function(n){"function"==typeof n&&(h=n)},get:void 0});var A=new i("",w,!1,!1);A.name="RobotWithRuler_"+u++,A.target={getWorldMatrix:function(){return A.getMatrix()}},A.setMoveMode("CALLBACK_ONLY"),A.scalingNodeX.setVisibility(!1),A.scalingNodeX.setVisibilityFree(!0),A.scalingNodeY.setVisibility(!1),A.scalingNodeY.setVisibilityFree(!0),A.scalingNodeZ.setVisibility(!1),A.scalingNodeZ.setVisibilityFree(!0),A.setVisibility(!1),w.addNode(A);var D,E,S,B,N,U,X,L,k,F,Y,Z,W,j,z=[],G=[],I=[],H={origin:new e.Vector3,initOrigin:new e.Vector3,direction:null,initValue:null,value:null,origin3D:null},K={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},_=!1,q=function(){var n={x:new e.Vector3,y:new e.Vector3,z:new e.Vector3};function i(n,e){var i;return n.normalize(),n.x>.9995?i="x":n.y>.9995?i="y":n.z>.9995&&(i="z"),i?e+"|"+i:e}return function(e){e?(A.getMatrix().extractBasis(n.x,n.y,n.z),A.setLabels({labelX:i(n.x,"u"),labelY:i(n.y,"v"),labelZ:i(n.z,"w")})):A.setLabels()}}();function J(n){A.setPickable(n?o.PICKABLE:o.PICKTHROUGH)}function Q(){S&&S.clear(),B&&B.clear()}function $(){S&&(S.direction=null,S.origin=null,S.origin3DPos=null,S.setValue(0)),B&&(B.direction=null,B.origin=null,B.originVector=null,B.setValue(0)),Q()}function nn(){A.setToNonGhostState()}function en(){J(!1),L=S.displayOrigin,X=(S.origin3DPos||S.origin).clone(),y&&y()}function tn(n){if(k=null,g){var e=g({event:n.event,viewer:w});k=e&&e.origin3D}return S.displayOrigin=L,k?(S.displayOrigin=!0,V&&V(),k.clone()):X}function on(){J(!0),k&&(H.origin3D=k.clone()),h&&h()}function rn(n){if("RulerManipulateBegin"===n.eventName||"AngularRulerManipulateBegin"===n.eventName)P=!0,F=new e.Vector3,Y=0,E=A.getMatrix(),p&&p({robotMatrix:A.getMatrix(),from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"RulerManipulateBegin"===n.eventName?"translation":"rotation",event:n.event});else if("RulerManipulate"===n.eventName)q(),F.add(n.translationVector),A.setMatrix((new e.Matrix4).copy(E).setPosition((new e.Vector3).getPositionFromMatrix(E).add(F))),d&&d({robotMatrix:A.getMatrix(),translationVector:n.translationVector,from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"translation",event:n.event}),w.render();else if("AngularRulerManipulate"===n.eventName){q();var i=n.diffAngle*Math.PI/180;Y+=i;var t=(new e.Matrix4).makeRotationAxis(n.direction,Y).multiply((new e.Matrix4).extractRotation(E));A.setMatrix(t.setPosition((new e.Vector3).getPositionFromMatrix(E))),K.value=B.value,d&&d({robotMatrix:A.getMatrix(),rotationAngle:i,from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"rotation",event:n.event})}else"RulerManipulateEnd"!==n.eventName&&"AngularRulerManipulateEnd"!==n.eventName||(A.setRobotMatrix(A.getMatrix()),P=!1,b&&b({robotMatrix:A.getMatrix(),from:"ruler",axis:(new e.Vector3).copy(n.direction),kind:"RulerManipulateEnd"===n.eventName?"translation":"rotation",event:n.event}),q(!0),w.render())}function an(n){var i,t;if(J(!1),P=!0,w.setCursor("pointer"),Q(),i=n.manipulator,[A.arrowX,A.arrowY,A.arrowZ,A.translationPlaneYZ,A.translationPlaneXY,A.translationPlaneXZ,A.rotationArcYZ,A.rotationArcXZ,A.rotationArcXY].forEach(function(n){n&&n.manipulator&&n.manipulator!==i&&n.setToGhostState()}),A.robotHandle.setToGhostState(),"LineTranslationBegin"===n.eventChannel){t=(new e.Vector3).copy(n.manipulator.axis),T&&(t=T(t));var o=(new e.Vector3).getPositionFromMatrix(A.getMatrix()),a=(new e.Vector3).copy(t).multiplyScalar((new e.Vector3).copy(H.baseOrigin).sub(o).dot(t));H.initOrigin=(new e.Vector3).copy(o).add(a);var l=(new e.Vector3).copy(H.initOrigin);if(H.origin3D)l=new e.Line3(H.initOrigin,(new e.Vector3).copy(H.initOrigin).add(t)).closestPointToPoint(H.origin3D,!1);H.origin=l;var s=(new e.Vector3).copy(H.origin).sub(o).dot(t);if(H.direction=t,H.value=l.distanceTo(o)*(s>0?-1:1),H.initValue=H.value,S){let n;S.origin=H.origin,S.origin3DPos=H.origin3D,S.initOrigin=H.initOrigin,S.setValue(H.value),S.direction=H.direction,S.initValue=H.initValue,S.displayOrigin=Boolean(H.origin3D),O&&(n=O()),S.unit=n||r.getCurrentUnit("length").unit,S.display(),S.beginManipulation()}}else if("RotationBegin"===n.eventChannel){if(t=(new e.Vector3).copy(n.manipulator.axis),!K.direction||0===Math.round(100*t.dot(K.direction))){var u=new e.Vector3,c=new e.Vector3,g=new e.Vector3;A.getMatrix().extractBasis(u,c,g),u.normalize(),c.normalize();var d=Math.round(100*u.dot(t)),b=Math.round(100*c.dot(t));0===d?K.originVector=(new e.Vector3).copy(u):0===b&&(K.originVector=(new e.Vector3).copy(c)),K.value=0,K.direction=t}if(K.origin=(new e.Vector3).getPositionFromMatrix(A.getMatrix()),K.initValue=K.value,B){let n;B.originVector=K.originVector,B.setValue(K.value),B.origin=K.origin,B.direction=K.direction,B.initValue=K.initValue,C&&(n=C()),B.unit=n||r.getCurrentUnit("angle").unit,B.display(),B.beginManipulation()}}p&&p({robotMatrix:A.getMatrix(),from:"robot",axis:(new e.Vector3).copy(n.manipulator.axis),kind:"LineTranslationBegin"===n.eventChannel?"translation":"rotation",event:n.event})}function ln(n){if(w.setCursor("pointer"),q(),"LineTranslationManipulation"===n.eventChannel)H.value=H.initValue+n.translationVector.length()*(H.direction.dot(n.translationVector)>0?1:-1),S&&S.setValue(H.value);else if("RotationManipulation"===n.eventChannel){var i=(new e.Vector3).copy(n.axis),t=K.direction.dot(i)<0?2*Math.PI-n.angle:n.angle;K.value=K.initValue+180*t/Math.PI,B&&B.setValue(K.value)}n.translationVector&&d?d({robotMatrix:A.getMatrix(),axis:(new e.Vector3).copy(n.manipulator.axis),translationVector:n.translationVector,from:"robot",kind:"translation",event:n.event}):n.angle&&d&&d({robotMatrix:A.getMatrix(),axis:(new e.Vector3).copy(n.axis),rotationAngle:n.angle,from:"robot",kind:"rotation",event:n.event}),w.render()}function sn(n){J(!0),nn(),"LineTranslationEnd"===n.eventChannel?S&&(S.endManipulation(),S.display()):"RotationEnd"===n.eventChannel&&B&&(B.endManipulation(),B.display()),P=!1,b&&b({robotMatrix:A.getMatrix(),from:"robot",axis:(new e.Vector3).copy(n.manipulator.axis),kind:"LineTranslationEnd"===n.eventChannel?"translation":"rotation",event:n.event}),q(!0),w.render()}function un(){_||(_=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(n,e){A&&((S=new n(x,{displayOrigin:!1,offset:l,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1,lightDisplay:m})).setVisibilityFree(!0),G.push(S.subscribe("OriginManipulateBegin",en)),S.onOriginManipulator=tn,G.push(S.subscribe("OriginManipulateEnd",on)),G.push(S.subscribe("RulerManipulateBegin",function(n){rn(n)})),G.push(S.subscribe("RulerManipulate",function(n){rn(n)})),G.push(S.subscribe("RulerManipulateEnd",function(n){rn(n)})),(B=new e(x,{radius:s,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0,lightDisplay:m})).setVisibilityFree(!0),I.push(B.subscribe("AngularRulerManipulateBegin",function(n){rn(n)})),I.push(B.subscribe("AngularRulerManipulate",function(n){rn(n)})),I.push(B.subscribe("AngularRulerManipulateEnd",function(n){rn(n)})))})),N||(N=a.givePreferenceManager({context:x}))&&(U=N.subscribe("onPreferencesChanged",function(){S&&S.getVisibleFlag()&&(S.unit=r.getCurrentUnit("length").unit,S.display()),B&&B.getVisibleFlag()&&(B.unit=r.getCurrentUnit("angle").unit,B.display())}))}function cn(n){f&&f({event:n.event}),w.setCursor("pointer"),P=!0,J(!1),A.arrowX.mat.opacity=.2,A.arrowY.mat.opacity=.2,A.arrowZ.mat.opacity=.2,A.translationPlaneYZ.planeMat.opacity=.2,A.translationPlaneXY.planeMat.opacity=.2,A.translationPlaneXZ.planeMat.opacity=.2,A.rotationArcYZ.planeMat.opacity=.2,A.rotationArcXZ.planeMat.opacity=.2,A.rotationArcXY.privilegedPlaneMat.opacity=.2,Z=A.getMatrix(),j=new e.Plane(w.currentViewpoint.getSightDirection()),un()}A.snapTranslationCallback=function(n){var e=n.translationVector;if(S){var i=S.getSnappedTranslationVector(n);0===i.returnCode&&(e=i.snappedTranslationVector)}return e},A.snapRotationCallback=function(n){var e={value:180*n.angle/Math.PI,axis:n.axis};if(K.direction.dot(n.axis)<0&&(e.value=360-e.value),B){var i=B.getSnappedRotationValue(n);0===i.returnCode&&(e={value:i.snappedRotationAngle,axis:i.axis})}return e};var gn=!1;z.push(A.subscribe("LineTranslationBegin",function(n){an(n)})),z.push(A.subscribe("RotationBegin",function(n){an(n)})),z.push(A.subscribe("ScalingBegin",function(n){an(n)})),z.push(A.subscribe("PlaneTranslationBegin",function(n){an(n)})),z.push(A.subscribe("LineTranslationManipulation",function(n){ln(n)})),z.push(A.subscribe("RotationManipulation",function(n){ln(n)})),z.push(A.subscribe("ScalingManipulation",function(n){ln(n)})),z.push(A.subscribe("PlaneTranslationManipulation",function(n){ln(n)})),z.push(A.subscribe("LineTranslationEnd",function(n){sn(n)})),z.push(A.subscribe("RotationEnd",function(n){sn(n)})),z.push(A.subscribe("ScalingEnd",function(n){sn(n)})),z.push(A.subscribe("PlaneTranslationEnd",function(n){sn(n)})),z.push(A.subscribe("ScreenPlaneTranslationBegin",function(n){cn(n)})),z.push(A.subscribe("ScreenPlaneTranslationManipulation",function(n){!function(n){q(),Q(),w.setCursor("pointer"),v&&v({event:n.event});var e=A.getMatrix().setPosition(n.intersection.ray.intersectPlane(j));if(c){var i=c({event:n.event,viewer:w});W=i&&i.robotMatrix.clone()}A.setRobotMatrix(W||e),w.render()}(n)})),z.push(A.subscribe("ScreenPlaneTranslationEnd",function(n){!function(n){P=!1,J(!0),nn(),Q(),$(),A.setRobotMatrix(W||Z);var i=A.getMatrix(),t=(new e.Vector3).getPositionFromMatrix(i);H.origin=t,H.initOrigin=t.clone(),H.baseOrigin=t.clone(),M&&M({event:n.event}),q(!0),w.render()}(n)})),D=t.subscribe({event:"/VISU/"},function(n){R&&("@onViewpointBeginMove"===n.eventType?gn=!0:"@onViewpointChange"===n.eventType?gn&&(A.setVisibility(!1),w.render()):"@onViewpointEndMove"===n.eventType&&(A.setVisibility(!0),gn=!1,w.render()))}),this.setPosition=function(n){if(!P){if(!n||!n.robotMatrix&&!n.translationRulerOrigin)throw new Error("No valid positions defined!");var i,t;n.robotMatrix&&(i=n.robotMatrix.clone(),t=(new e.Vector3).getPositionFromMatrix(i),A.setRobotMatrix(i),H.origin=t,H.initOrigin=t.clone(),H.baseOrigin=t.clone(),S&&(S.initOrigin=H.initOrigin,S.origin=H.origin)),n.translationRulerOrigin?H.origin3D=n.translationRulerOrigin.clone():null===n.translationRulerOrigin&&(H.origin3D=null),un(),n.doNotResetRuler||$(),q(),w.render()}},this.setVisibility=function(n){if("boolean"!=typeof n)throw new Error("Argument must be a boolean");R=n,A.setVisibility(n),q(!0)},this.destroy=function(){z.forEach(A.unsubscribe,A),z=null,t.unsubscribe(D),D=null,N&&(U=N.unsubscribe(U)),N=U=null,w.removeNode(A),Q(),S&&G.forEach(S.unsubscribe,S),B&&I.forEach(B.unsubscribe,B),A=x=w=null,S=B=null}}})});