/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/PIMwebViewModel/PIMwebUtils",["DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI"].concat([]),function(e,t){"use strict";let i={get3DSpaceUrl:()=>require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl(),getPlatformId:()=>require("DS/PADUtils/PADUtilsServices").getPlatformId(),getSecurityContext:()=>require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx"),getLang:()=>require("DS/PADServices/utils/GlobalUtils").getLang()};function n(e){var i=t.getUser();return e+"-"+(i?i.login:"")+"-"+Date.now()}function r(e){var t=UWA.Promise.deferred();return function(e,t){var i=UWA.Promise.deferred();return require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"].concat([]),function(n){n.getServiceUrl({serviceName:e,platformId:t,onComplete:function(e){i.resolve(e)},onFailure:function(e){i.reject(new Error(e))}})}),i.promise}("djc",e).then(function(e){var i=e+"/api";t.resolve(i)}),t.promise}function o(e,t,n,r){let o=Object.assign({},e);return o.method=t,o.url=i.get3DSpaceUrl()+n+"?tenant="+i.getPlatformId(),o.securityContext=i.getSecurityContext(),r&&(o.data=r),o}function s(e,t,n,o){var s=UWA.Promise.deferred();let a=i.getPlatformId(),c=Object.assign({},e);return c.method=t,r(a).then(function(e){c.url=e+n,o&&(c.data=o),s.resolve(c)}),s.promise}function a(t){return e.authenticatedRequest(t.url+"&SecurityContext="+t.securityContext,{method:t.method,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t.securityContext},data:JSON.stringify(t.data),timeout:t.timeout,onComplete:t.onComplete,onFailure:t.onFailure,onTimeout:t.onTimeout||t.onFailure})}function c(t){return e.authenticatedRequest(t.url,{method:t.method,headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:t.securityContext},data:JSON.stringify(t.data),timeout:t.timeout,onComplete:t.onComplete,onFailure:t.onFailure,onTimeout:t.onTimeout||t.onFailure})}var l=Object.create({}),u=Object.getPrototypeOf(l);function f(e){let t=new Blob([e.stream],{type:"application/json"}),i=new FormData;i.append("__fcs__jobTicket",e.preCheckIn.checkinTicket),i.append("file_0",t,"WebIsrScenarioContent.json");var n=new XMLHttpRequest;n.open("POST",e.preCheckIn.actionURL,!0),n.onload=function(){if(200===n.status){a(o({onComplete:e.onComplete,onFailure:e.onFailure},"POST","/resources/pimauthoring/service/checkinStreamInfo",{repRefId:e.repRefID,receipt:n.responseText,simuContent:e.stream}))}else e.onFailure()},n.send(i)}u._DEFAULT_PAGGING=500,u._navigateFromIsr=function(e){let t,i=[],r=t=>{i.forEach(e=>e.cancel()),e.onFailure(t)},s=i=>(i=JSON.parse("string"==typeof i?i:null))?t?(t.result&&t.result.length?i.result&&i.result.length&&(Object.assign(t.result[0].input_object,i.result[0].input_object),Object.assign(t.result[0].outputs,i.result[0].outputs)):t=i,delete t.version,void e.onComplete(JSON.stringify(t))):t=i:r(),c={onComplete:s,onFailure:r},u={onComplete:s,onFailure:r,isrID:e.isrID};return i.push(a(o(c,"POST","/cvservlet/navigate",{input_physical_ids:[e.isrID],label:n("PIMwebIsr"),primitives:[{navigate_to_rel:{id:1,filter:{bo_type:["dsc_Result_Category_Ref"]}}},{navigate_to_rel:{id:2}}],patterns:{itfCtxt:[{id:1},{id:2}]},fileAttributes:[],attributes:["ds6w:label","ds6wg:EnterpriseExtension.V_PartNumber","ds6w:responsible","owner","ds6w:type","ds6w:description"],version:3}))),i.push(l._navigateFromIsrToContext(u)),{cancel:()=>i.forEach(e=>e.cancel())}},u._navigateFromIsrToContext=function(e){return a(o({onComplete:t=>{if(!(t=JSON.parse("string"==typeof t?t:null))||!t.infos||"OK"!==t.infos.status||!t.result)return e.onFailure();e.onComplete(JSON.stringify({infos:t.infos,result:t.result.map(e=>({input_object:e.input,outputs:e.output}))}))},onFailure:e.onFailure},"POST","/resources/pimauthoring/service/readItfSimulationContent",Array.isArray(e.isrID)?e.isrID:[e.isrID]))},u._navigateFromContextualInterferences=function(e){return a(o(e,"POST","/cvservlet/navigate",{input_physical_ids:e.ctxIDs,label:n("PIMwebItfCtxt"),primitives:[{navigate_to_sr:{id:1,filter:{semantics:["6"],role:["198"]},mode:"last"}},{navigate_to_rel:{id:2}},{navigate_to_sr:{id:3,filter:{semantics:["5"],role:["201"]},mode:"path"}},{navigate_to_sr:{id:4,filter:{semantics:["5"],role:["197"]},mode:"path"}},{navigate_to_sr:{id:5,filter:{semantics:["6"],role:["200"]},mode:"path"}},{navigate_to_rel:{id:6,filter:{bo_type:["PLMPIMGeometricResultRepReference"]}}}],patterns:{ms:[{id:1}],r2sca:[{id:4}],sca2occ:[{id:1},{id:2},{id:3}],sca:[{id:1},{id:2},{id:5}],repRef:[{id:1},{id:6}]},attributes:["ds6w:label","ds6wg:EnterpriseExtension.V_PartNumber","ds6w:responsible","owner","ds6w:type","ds6w:status","ds6w:description","ds6w:project","ds6wg:revision","organization","current","bo.PLMPIMMetricReference.V_Itf_Analysis","bo.PLMPIMMetricReference.V_Itf_Previous_Analysis","bo.PLMPIMMetricReference.V_Itf_Type","bo.PLMPIMMetricReference.V_Itf_User_Type","bo.PLMPIMMetricReference.V_Itf_Real_Tolerance_Used_For_Computation","bo.PLMPIMMetricReference.V_Itf_Spec_Clearance_value","bo.PLMPIMMetricReferenceClashContact.V_Itf_Penetration_Value","bo.PLMPIMMetricReferenceClashContact.V_Itf_Clash_Volume","bo.PLMPIMMetricReferenceClashContact.V_Itf_FirstPointFoundClash","bo.PLMPIMMetricReferenceClashContact.V_Itf_SecondPointFoundClash","bo.PLMPIMMetricReferenceClearance.V_Itf_Distance_Min","bo.PLMPIMMetricReferenceClearance.V_Itf_FirstPointFoundClearance","bo.PLMPIMMetricReferenceClearance.V_Itf_SecondPointFoundClearance","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_UUID_1","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_UUID_2","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_Name_1","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_Name_2","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_UUIDs_1","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_UUIDs_2","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_Names_1","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_Names_2"],fileAttributes:[],version:3}))},u._setAttrValue=function(e){return e.data.attrValue=String(e.data.attrValue),a(o(e,"POST","/resources/PIMwebModel/services/setAttributeValue",e.data))},u._navigateFromMetricToIsr=function(e){return a(o(e,"POST","/cvservlet/navigate",{input_physical_ids:e.metricIDs,label:n("PIMwebItfMetric"),primitives:[{navigate_from_sr:{id:1,filter:{semantics:["6"],role:["198"]}}},{navigate_from_rel:{id:2}}],patterns:{itfCtxt:[{id:1}],isr:[{id:1},{id:2,iter:2}]},attributes:["ds6w:label","ds6w:responsible","owner","ds6w:type","ds6w:description"],fileAttributes:[],version:3}))},u._navigateOneLevel=function(e){return a(o(e,"POST","/cvservlet/navigate",{input_physical_ids:e.ids,label:n("PIMwebNavigateOneLevel"),primitives:[{navigate_to_rel:{id:1}}],patterns:{ref:[{id:1}]},attributes:["ds6w:label","ds6wg:EnterpriseExtension.V_PartNumber","ds6w:responsible","owner","ds6w:type","ds6w:project","ds6wg:revision","organization","current"],fileAttributes:[],version:3}))},u._getLabelAndIconAttr=function(e){return a(o(e,"POST","/cvservlet/fetch/v2",{physicalid:e.ids,label:n("PIMwebFetchForLabelandIcon"),select_predicate:["ds6w:label"],select_file:["icon"]}))},u._fetchForWelcomePanel=function(e){return a(o(e,"POST","/cvservlet/fetch/v2",{physicalid:e.ids,label:n("PIMwebFetchForWelcomePanel"),select_predicate:["ds6w:label","ds6w:type","ds6wg:revision","ds6w:status","owner","ds6w:responsible","ds6w:modified","ds6w:project","ds6w:identifier","ds6w:status"],select_file:["icon","thumbnail_2d"]}))},u._fetchValidationState=function(e){return a(o(e,"POST","/cvservlet/fetch/v2",{physicalid:e.ids,label:n("PIMwebFetchValidationState"),select_predicate:["bo.SIMItfSimulation.V_ValidationState"],select_file:[]}))},u._getInterferenceAnalysisProgress=function(e){return a(o(e,"POST","/resources/PIMwebModel/services/getInterferenceAnalysisProgress",e.ids))},u._updateIsrContextAndSpec=function(e){let t={onFailure:e.onFailure,onComplete:function(t){if(!(t=JSON.parse("string"==typeof t?t:null))||!t.infos||"OK"!==t.infos.status)return e.onFailure();f({stream:t.output.simuContent,repRefID:e.repRefID,preCheckIn:{checkinTicket:t.output.checkinTicket,actionURL:t.output.actionURL},onFailure:e.onFailure,onComplete:()=>e.onComplete({filter:t.output.filter})})}};return e.data.isrPid=e.isrID,a(o(t,"POST","/resources/pimauthoring/service/updateItfSimulationContent",e.data))},u._readIsrSpecStream=(()=>{let e,t=function(t,n){e||(e=n);try{e.Load({IRPC:!0,serverUrl:i.get3DSpaceUrl(),physicalid:t.repRefID,boType:"dsc_Scenario_CLASH_Rep",format:"1",persistancyType:"json",streamType:"text",onStreamLoaded:e=>t.onComplete({infos:{status:"OK"},stream:JSON.parse(e)}),onError:e=>t.onComplete({infos:{status:e}})})}catch(e){t.onComplete({infos:{status:"KO"}})}};return function(i){e?t(i,e):require(["DS/VisuDataAccess/Ox4StreamLoader"].concat([]),t.bind(null,i))}})(),u._createIsr=function(e){return a(o({onFailure:e.onFailure,onComplete:function(t){if(!(t=JSON.parse("string"==typeof t?t:null))||!t.infos||"OK"!==t.infos.status)return e.onFailure();f({stream:t.output.simuContent,repRefID:t.output.specID,preCheckIn:{checkinTicket:t.output.checkinTicket,actionURL:t.output.actionURL},onFailure:e.onFailure,onComplete:()=>e.onComplete({isrID:t.output.pId})})}},"POST","/resources/pimauthoring/service/createInterferenceSimulation",e.data))},u._computeIsr=function(e){s({onFailure:e.onFailure,onComplete:function(t){if(console.log("computeIsr Response message:"+t),!(t=JSON.parse("string"==typeof t?t:null))||!t.jobID||0!==t.status||"OK"!==t.message)return e.onFailure();e.onComplete(t)}},"POST","/v1/job/submit/interference",e.data).then(function(e){return c(e)})},u._getComputeIsrJobStatus=function(e){s({onFailure:e.onFailure,onComplete:function(t){if(console.log("computeIsr Status Response message:"+t),!(t=JSON.parse("string"==typeof t?t:null))||!t.jobID||0!==t.status||"OK"!==t.message)return e.onFailure();e.onComplete(t)}},"GET","/v1/job/status/"+e.data.jobID,null).then(function(e){return c(e)})},u._getIsrJobsList=function(e){s({onFailure:e.onFailure,onComplete:function(t){if(console.log("List jobs Response message:"+t),!(t=JSON.parse("string"==typeof t?t:null))||0!==t.status||"OK"!==t.message)return e.onFailure();e.onComplete(t)}},"GET","/v1/job/list",null).then(function(e){return c(e)})},u._readMetricGeomStream=(()=>{let e,t=function(t,n){e||(e=n);try{e.Load({IRPC:!0,serverUrl:i.get3DSpaceUrl(),physicalid:t.repRefID,boType:"PLMPIMGeometricResultRepReference",persistancyType:"json",streamType:"text",onStreamLoaded:e=>t.onComplete({infos:{status:"OK"},buffer:e.replace(/\0+$/,"")}),onError:e=>t.onComplete({infos:{status:e}})})}catch(e){t.onComplete({infos:{status:"KO"}})}};return function(i){e?t(i,e):require(["DS/VisuDataAccess/Ox4StreamLoader"].concat([]),t.bind(null,i))}})();var p,d,I=["SIMItfSimulationDS","ENOSTItfSimulationDS"];function m(e,t){return e?Promise.resolve(e):new Promise(function(i){a(o({onComplete:function(n){e?i(e):(-1===(e="string"==typeof n?Object.keys(JSON.parse(n)):[]).indexOf(t)&&e.push(t),Object.freeze(e=e.filter(e=>-1===I.indexOf(e))),i(e))},onFailure:function(){i([t])}},"POST","/resources/dictionary/getTypeInfo",[t]))})}u._getIsrTypes=function(){return m(p,"SIMItfSimulation").then(e=>p=e)},u._checkParentType=function(e){return e.typeToCheck===e.parentType?Promise.resolve(!0):new Promise(function(t){return a(o({onFailure:function(){t(!1)},onComplete:function(i){let n=JSON.parse(i).parentTypes.indexOf(e.parentType);t(n>=0)}},"POST","/resources/markup/service/getParentTypes",{sType:e.typeToCheck}))})},u._getBundleFasternerTypes=function(){return m(d,"BundleFastener").then(e=>d=e)};var h,_={};return u._getTypeNLS=function(e){var t={},n=e.filter(function(e){var i=_[e];return t[e]=i||e,!i});return n.length?new Promise(function(e){require(["DS/FedDictionaryAccess/FedDictionaryAccessAPI"],function(r){r.getNlsOfPropertiesValues(JSON.stringify({"ds6w:type":n}),{tenantId:i.getPlatformId(),lang:i.getLang(),apiVersion:"R2019x",onComplete:function(i){Object.keys((i||{})["ds6w:type"]||{}).forEach(function(e){t[e]=_[e]=i["ds6w:type"][e]}),e(t)},onFailure:function(){e(t)}})})}):Promise.resolve(t)},u._getCustomAttributesFromType=function(e){return new Promise(function(t){require(["DS/FedDictionaryAccess/FedDictionaryAccessAPI"],function(n){n.getPropertiesForClass(e.data,{tenantId:i.getPlatformId(),lang:i.getLang(),apiVersion:"R2019x",onComplete:function(e){if(e&&e.length){var i={};e.forEach(function(e){var t=[];e.properties.forEach(function(e){void 0!==e.userAccess&&t.push(e)}),i[e.classInfo.curi.substring(e.classInfo.curi.lastIndexOf(":")+1)]=t}),t(i)}else t()},onFailure:function(){t()}})})})},u._getCreationParams=function(e){return a(o({onFailure:e.onFailure,onComplete:function(t){return(t=JSON.parse("string"==typeof t?t:null))&&t&&t.infos&&"OK"===t.infos.status&&t.result?void u._getTypeNLS(p).then(function(i){t.result.types=i,e.onComplete(t.result)}):e.onFailure()}},"POST","/resources/pimauthoring/service/generateName",{type:e.type,lang:i.getLang()}))},u._sendUsageProbe=function(e,t,i){if(h){var n=h.getPADTracker({eventCategory:"usage",eventAction:e}),r={eventLabel:t};void 0!==i&&(r.eventValue=i),n.setEventData(r),n.trackPageEvent()}else require(["DS/PADServices/utils/PADTrackerManager"],function(e,t,i,n){h=n,this._sendUsageProbe(e,t,i)}.bind(this,e,t,i))},u._setRequestUtils=function(e){e.get3DSpaceUrl&&(i.get3DSpaceUrl=e.get3DSpaceUrl),e.getPlatformId&&(i.getPlatformId=e.getPlatformId),e.getSecurityContext&&(i.getSecurityContext=e.getSecurityContext),e.getLang&&(i.getLang=e.getLang)},u.getPlatformId=(()=>i.getPlatformId()),u.getLang=(()=>i.getLang()),u.get3DSpaceUrl=function(e){var t=UWA.Promise.deferred();return t.resolve(i.get3DSpaceUrl(e)),t.promise},l}),define("DS/PIMwebViewModel/PIMwebIsr",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/PIMwebViewModel/PIMwebUtils"],function(e,t,i,n){"use strict";let r,o,s,a=1,c="ds6w:label",l="ds6w:type",u="ds6wg:EnterpriseExtension.V_PartNumber",f="ds6w:responsible",p="owner",d="ds6w:description",I="ds6wg:revision",m="ds6w:project",h="ds6w:status",_={1:"Clash",2:"Contact",3:"Clearance",4:"Contact",5:"NoInterference",6:"Undefined"},P={Clash:1,Contact:2,Clearance:3,NoInterference:5,Undefined:6},g={1:"OK",2:"KO",3:"NotAnalyzed",4:"NotAnalyzed",5:"NotAnalyzed"},y={1:"OK",2:"KO",3:"NotAnalyzed",4:"",5:"NotAnalyzed"},C={OK:1,KO:2,NotAnalyzed:3},b={"ds6w:description":"itfDescription","bo.PLMPIMMetricReference.V_Itf_Analysis":"itfAnalysis","bo.PLMPIMMetricReference.V_Itf_Previous_Analysis":"itfPrevAnalysis","bo.PLMPIMMetricReference.V_Itf_Type":"itfSystemType","bo.PLMPIMMetricReference.V_Itf_User_Type":"itfUserType","bo.PLMPIMMetricReference.V_Itf_Real_Tolerance_Used_For_Computation":"itfTolerance","bo.PLMPIMMetricReference.V_Itf_Spec_Clearance_value":"itfClearVal","bo.PLMPIMMetricReferenceClashContact.V_Itf_Penetration_Value":"itfPenVec","bo.PLMPIMMetricReferenceClashContact.V_Itf_Clash_Volume":"itfPenVol","bo.PLMPIMMetricReferenceClearance.V_Itf_Distance_Min":"itfMinDist","bo.PLMPIMMetricReferenceClashContact.V_Itf_FirstPointFoundClash":"itfQtfPt1","bo.PLMPIMMetricReferenceClashContact.V_Itf_SecondPointFoundClash":"itfQtfPt2","bo.PLMPIMMetricReferenceClearance.V_Itf_FirstPointFoundClearance":"itfQtfPt1","bo.PLMPIMMetricReferenceClearance.V_Itf_SecondPointFoundClearance":"itfQtfPt2","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_UUID_1":"itfFeat1","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_UUID_2":"itfFeat2","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_Name_1":"itfFeatName1","bo.PLMPIMMetricReferenceFeature.V_Itf_Feature_Name_2":"itfFeatName2","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_UUIDs_1":"itfIFC1","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_UUIDs_2":"itfIFC2","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_Names_1":"itfIFCName1","bo.PLMPIMMetricReferenceIFC.V_Itf_IFC_Names_2":"itfIFCName2","ds6w:responsible":"itfOwner",owner:"itfOwnerID","ds6w:status":"itfCurrent"},M=["physicalid","type","itfMetricName","itfOwner","itfOwnerID","itfCurrent","itfDescription","itfAnalysis","itfPrevAnalysis","itfSystemType","itfUserType","itfTolerance","itfClearVal","itfPenVec","itfPenVol","itfMinDist","itfQtfPt1","itfQtfPt2","itfFeat1","itfFeat2","itfFeatName1","itfFeatName2","itfIFC1","itfIFC2","itfIFCName1","itfIFCName2"],F=["physicalid","itfCtxName"];var v,D={};function w(){return Object.keys(D).length?Promise.resolve():(v||(v=new Promise(e=>{require(["DS/FedDictionaryAccess/FedDictionaryAccessAPI"],function(t){t.getNlsOfPropertiesValues(JSON.stringify({"ds6w:status":["VPLM_SMB_Evaluation.PRIVATE","VPLM_SMB_Evaluation.IN_WORK","VPLM_SMB_Evaluation.FROZEN","VPLM_SMB_Evaluation.RELEASED","VPLM_SMB_Evaluation.OBSOLETE"]}),{tenantId:n.getPlatformId(),lang:n.getLang(),apiVersion:"R2019x",onComplete:function(t){D=t["ds6w:status"],v=null,e()},onFailure:function(){v=null,e()}})})})),v)}function S(e){var t=Number(e);return isNaN(t)||t<0?null:t}function L(e){var t=Number(e);return isNaN(t)?null:t}function O(e){return Object.keys(e).forEach(function(t){var i=b[t];i&&(e[i]=e[t],delete e[t])}),e.itfCurrent&&(e.itfCurrent=D[e.itfCurrent]||e.itfCurrent),e}function V(e){return e.itfCtxName=e[c],O(e),Object.keys(e).forEach(function(t){-1===F.indexOf(t)&&delete e[t]}),e}function x(e){return e.itfMetricName=e[c],e.type=e[l],O(e),Object.keys(e).forEach(function(t){-1===M.indexOf(t)&&delete e[t]}),e}function N(e){if(!e)return null;var t={physicalid:e.physicalid,label:e[c],owner:e[f],ownerID:e[p],type:e[l],revision:e[I],project:e[m],current:e.current?e.current:e[h],organization:e.organization};return e[u]&&(t.pn=e[u]),s&&s.indexOf(t.type)>-1&&(t.isBundleFst=!0),Object.freeze(t)}function A(t,i,n){let r="itfIFC"+n.toString(),s="itfIFCName"+n.toString();if(!i[r]||!i[s])return;var a=i[r].length;if(i[s].length!==a)return;if(!o[t])return;let c,l=[];for(c=0;c<a;c++){let n=e.clone(o[t],!0),u=i[r][c];n.isIfcElt=!0,n.physicalid=u,n.label=i[s][c],n.type=c%2?"VPMReference":"VPMInstance",c===a-2?n.type="VPMRepInstance":c===a-1&&(n.type="VPMRepReference"),o[u]||(o[u]=n),l.push(i[r][c])}return l}function R(e){var t=String(window.widget?window.widget.id+"_":"")+e;window.top.performance.measure(t,t)}function T(e){window.top.performance.mark(String(window.widget?window.widget.id+"_":"")+e)}var U,E,j,k,J=(U=[],E=0,j=0,k=function(e,t,i){R("PIM_QueryCtx_"+e),E--,J(),setTimeout(function(){w().then(()=>{i(t)})},0)},function(t){t&&U.push(t),U.length&&E<5&&(E++,j++,function(t,i){T("PIM_QueryCtx_"+i);var r=e.clone(t,!1);r.onComplete=function(e){k(i,e,t.onComplete)},r.onFailure=function(e){k(i,e,t.onFailure)},r.onTimeout=function(e){k(i,e,t.onTimeout||t.onFailure)},n._navigateFromContextualInterferences(r)}(U.shift(),j))});return t.extend({init:function(e){let t=this,u={physicalid:e.id,isrContext:[],isrSpec:null,nbItfs:-2,itfs:{}},I=new i,m=function(e,i){return I.publish({event:e,data:i,context:t})};function h(){s=null,n._getBundleFasternerTypes().then(function(e){s=e.slice()})}function b(e){if(e&&e.contextualIDs&&e.onProgress&&e.onComplete&&e.onFailure)if(0!==e.contextualIDs.length){var t,i=Math.floor((e.contextualIDs.length-1)/n._DEFAULT_PAGGING)+1,s=0,a=[],c=!1;for(t=function(t){e.onProgress({itfIDs:t.itfIDs,isrID:u.physicalid,metrics:t.metricIDs});var i=t.itfIDs,s=[],a=u.isrContext&&u.isrContext.length?u.isrContext[0].prd.physicalid:null;a&&i.forEach(function(e){var t=u.itfs[e];if(t.r2sca&&t.r2sca.forEach(function(e){-1===s.indexOf(e.physicalid)&&s.push(e.physicalid)}),t.metricID&&r[t.metricID]&&r[t.metricID].sca2occ){var i=[Boolean(r[t.metricID].itfIFC1),Boolean(r[t.metricID].itfIFC2)];r[t.metricID].sca2occ.forEach(function(e,t){let n=-1;i[t]?i[t]&&(n=e?e.length:-1):n=e?e.length-2:-1;for(var r=0;r<n;++r)-1===s.indexOf(e[r].physicalid)&&s.push(e[r].physicalid)})}}),s.length?n._navigateOneLevel({ids:s,onComplete:function(n){var s,c,f=JSON.parse(n),p={};f&&f.infos&&"OK"===f.infos.status&&f.result&&(f.result.forEach(function(e){s=e.input_object,(c=e.outputs&&e.outputs.ref&&e.outputs.ref.length?e.outputs.ref[0]:null)&&(o[c.physicalid]||(o[c.physicalid]=N(c)),p[s.physicalid]=c.physicalid)}),t.metricIDs.forEach(function(e){var t=r[e];if(t){if(!t.path&&t.sca&&t.sca2occ&&t.sca2occ.length){var i=[Boolean(t.itfIFC1),Boolean(t.itfIFC2)];t.path=[null,null],t.sca2occ.forEach(function(e,t){if(e){var n,r;for(this[t]=[],i[t]?i[t]&&(r=e?e.length:-1):r=e?e.length-2:-1,n=0;n<r;++n){var o=e[n].physicalid;if(this[t].push(o),!(o=p[o])){this[t]=null;break}this[t].push(o)}this[t]&&r===e.length-2&&(this[t].push(e[n].physicalid),this[t].push(e[n+1].physicalid))}},t.path),t.path[0]||t.path[1]||(t.path=null),delete t.sca2occ}}else window.console.log("No metric! At this point this is not possible")}),i.forEach(function(e){var t,i,n=u.itfs[e],o=r[n.metricID],s=[];if(a&&(s.push(a),t=(n.r2sca||[]).some(function(e){var t=e.physicalid;if(s.push(t),!(t=p[t]))return!0;s.push(t)}),i=s[s.length-1],o&&o.path&&!t&&i&&i===o.sca&&(n.path=[null,null],o.path[0]&&(n.path[0]=s.concat(o.path[0])),o.path[1]&&(n.path[1]=s.concat(o.path[1]))),delete n.r2sca,o&&(o.itfIFC1&&o.itfIFCName1||o.itfIFC2&&o.itfIFCName2))){if(!t&&i&&i===o.sca){n.path||(n.path=[null,null]),n.ifcLen=[null,null];for(let e=0;e<2;++e){let t=A(n.path[e]?n.path[e][n.path[e].length-1]:i,o,e+1);t&&(n.ifcLen[e]=t.length,n.path[e]=n.path[e]?n.path[e].concat(t):s.concat(t))}}o.itfIFC1&&delete o.itfIFC1,o.itfIFC2&&delete o.itfIFC2,o.itfIFCName1&&delete o.itfIFCName1,o.itfIFCName2&&delete o.itfIFCName2}}),e.onProgress({interferingPathsReady:!0,itfIDs:i,isrID:u.physicalid,metrics:t.metricIDs}),l({itfIDs:i}))},onFailure:function(){l({itfIDs:i})}}):l({itfIDs:i})};s<i&&!c;)performance.mark("iteration"+s),J({ctxIDs:e.contextualIDs.slice(s*n._DEFAULT_PAGGING,(s+1)*n._DEFAULT_PAGGING),onComplete:function(e){if(!c){var i=JSON.parse(e);if(i&&i.infos&&"OK"===i.infos.status&&i.result){var n,s,a,l,f,p,d,I,m,h,_,P,g=(i=i.result).length,y=[],C=[];for(l=0;l<g;++l){if(s=V((n=i[l]).input_object),a=n.outputs.ms?n.outputs.ms[0]:null,y.push(s.physicalid),a&&-1===C.indexOf(a.physicalid)&&C.push(a.physicalid),a&&!r[a.physicalid]?r[a.physicalid]=x(a):a&&r[a.physicalid]&&(a=r[a.physicalid]),a&&!a.ctxt&&(a.ctxt=[]),a&&a.ctxt&&-1===a.ctxt.indexOf(s.physicalid)&&a.ctxt.push(s.physicalid),s.metricID=a?a.physicalid:null,u.itfs[s.physicalid]=s,n.outputs.r2sca&&n.outputs.r2sca.length)for(s.r2sca=[],f=0,h=n.outputs.r2sca[0].elements.length;f<h;++f)P=N(I=n.outputs.r2sca[0].elements[f]),o[I.physicalid]||(o[I.physicalid]=P),s.r2sca.push(P);if(n.outputs.sca&&n.outputs.sca.length>0&&a&&!a.sca&&(I=n.outputs.sca[0].elements[0],a.sca=I.physicalid,o[a.sca]||(o[a.sca]=N(I))),n.outputs.sca2occ&&a&&!a.sca2occ)for(a.sca2occ=[],f=0,h=n.outputs.sca2occ.length;f<h;++f){if(m=[],(d=n.outputs.sca2occ[f]).elements.length>1)for(p=0;p<d.elements.length;++p)P=N(I=d.elements[p]),o[I.physicalid]||(o[I.physicalid]=P),m.push(P);_="number"==typeof d.app_index&&d.app_index?d.app_index-1:"number"==typeof d.sr_id?d.sr_id-1:f,a.sca2occ[_]=m}n.outputs.repRef&&n.outputs.repRef.length&&a&&!a.repRef&&(a.repRef=n.outputs.repRef[0].physicalid)}t({itfIDs:y,metricIDs:C})}}},onFailure:function(t){c=!0,t||(t={}),t.step="Metrics",e.onFailure(t)}}),s++}else e.onComplete({itfIDs:[],metricIDs:[]});function l(t){c||(a.push.apply(a,t.itfIDs),t.error?(c=!0,t.error.step="Metrics",t.error.isrID=u.physicalid,e.onFailure(t.error)):a.length===e.contextualIDs.length&&e.onComplete({isrID:u.physicalid,itfIDs:a}))}}r={},o={},w(),this._fetch=function(e){u.physicalid&&e&&e.onProgress&&e.onComplete&&e.onFailure?e.contextualIDs?e.contextualIDs.length>0&&function(e){var t=a++;h(),T("PIM_QueryIsrToContext_"+t+"_"+u.physicalid),n._navigateFromIsrToContext({isrID:u.physicalid,onComplete:function(i){R("PIM_QueryIsrToContext_"+t+"_"+u.physicalid);var n,r,s,a=JSON.parse(i);a&&a.result&&1===a.result.length?(u.label=a.result[0].input_object[c],u.type=a.result[0].input_object[l],u.description=a.result[0].input_object[d],u.owner=a.result[0].input_object[f],u.ownerID=a.result[0].input_object[p],n=a.result[0].outputs&&a.result[0].outputs.prd,r=a.result[0].outputs&&a.result[0].outputs.filter,s=a.result[0].outputs&&a.result[0].outputs.spec,n=N(n),r=N(r),u.isrSpec=s,u.isrContext=n?[{prd:n,filter:r}]:[],u.nbItfs=-1,n&&!o[n.physicalid]&&(o[n.physicalid]=n),b({contextualIDs:e.contextualIDs,onProgress:e.onProgress,onComplete:e.onComplete,onFailure:e.onFailure})):e.onFailure()},onFailure:function(){R("PIM_QueryIsrToContext_"+t+"_"+u.physicalid),e.onFailure()}})}(e):function(e){if(!u.physicalid)return e.onFailure({error:"No valid Simulation ID parameter (iSimulationID)"}),void e.onFailure({step:"Simulation"});h();var i=a++;T("PIM_QueryIsr_"+i+"_"+u.physicalid),n._navigateFromIsr({isrID:u.physicalid,onComplete:function(r){R("PIM_QueryIsr_"+i+"_"+u.physicalid),n._sendUsageProbe("load","Isr");var s,a=JSON.parse(r);if(!a||!a.result||1!==a.result.length)return void e.onFailure({step:"Simulation"});if(!(s=a.result[0])||0===Object.keys(s.outputs).length)return void e.onFailure({step:"Simulation"});u.label=s.input_object[c],u.type=s.input_object[l],u.description=s.input_object[d],u.owner=s.input_object[f],u.ownerID=s.input_object[p],u.nbItfs=s.outputs.itfCtxt?s.outputs.itfCtxt.length:0,n._sendUsageProbe("load","IsrNbItfs",u.nbItfs);let I=N(s.outputs.prd),m=N(s.outputs.filter),h=(s.outputs.itfCtxt||[]).map(function(e){return e.physicalid});u.isrSpec=s.outputs.spec,u.isrContext=I?[{prd:I,filter:m}]:[],I&&!o[I.physicalid]&&(o[I.physicalid]=I),e.onProgress({context:t.getIsrContexts()}),n._sendUsageProbe("load","IsrWithFilter",m?"Yes":"No"),b({contextualIDs:h,onProgress:e.onProgress,onComplete:e.onComplete,onFailure:e.onFailure})},onFailure:function(t){R("PIM_QueryIsr_"+i+"_"+u.physicalid),n._sendUsageProbe("load","IsrFailed"),t||(t={}),t.step="Simulation",e.onFailure(t)}})}(e):e.onFailure()},this.getAttributes=function(){return{physicalid:u.physicalid,label:u.label,type:u.type,description:u.description,owner:u.owner,ownerID:u.ownerID}},this.getIsrContexts=function(){return JSON.parse(JSON.stringify(u.isrContext))},this.getItfIDs=function(){return Object.keys(u.itfs)},this.getInterferences=function(e){var t=[];return(e?Array.isArray(e)?e:[e]:Object.keys(u.itfs)).forEach(function(e){var i=u.itfs[e],n=r[i.metricID],s={itfuid:e,itfModelId:u.physicalid,itfCtxName:i.itfCtxName,itfPath1:i.path&&i.path.length&&i.path[0]?i.path[0].map(function(e){return o[e]}):null,itfPath2:i.path&&i.path.length>1&&i.path[1]?i.path[1].map(function(e){return o[e]}):null,ifcLen1:i.ifcLen&&i.ifcLen.length>1&&i.ifcLen[0]&&i.ifcLen[0]>0?i.ifcLen[0]:0,ifcLen2:i.ifcLen&&i.ifcLen.length>1&&i.ifcLen[1]&&i.ifcLen[1]>0?i.ifcLen[1]:0};n?(s.itfMetricName=n.itfMetricName,s.itfSystemType=_[n.itfSystemType],s.itfUserType=_[n.itfUserType],s.itfAnalysis=g[n.itfAnalysis],s.itfPrevAnalysis=y[n.itfPrevAnalysis],s.itfPenVec=S(n.itfPenVec),s.itfPenVol=S(n.itfPenVol),s.itfMinDist=S(n.itfMinDist),s.itfDescription=n.itfDescription,s.itfTolerance=S(n.itfTolerance),s.itfClearVal=S(n.itfClearVal),s.itfOwner=n.itfOwner,s.itfOwnerID=n.itfOwnerID,s.itfCurrent=n.itfCurrent,s.itfQtfPt1=(s.itfPenVec||s.itfPenVol||s.itfMinDist)&&n.itfQtfPt1&&3===n.itfQtfPt1.length?n.itfQtfPt1.map(L):null,s.itfQtfPt2=(s.itfPenVec||s.itfPenVol||s.itfMinDist)&&n.itfQtfPt2&&3===n.itfQtfPt2.length?n.itfQtfPt2.map(L):null,s.itfQtfPt1&&s.itfQtfPt2||(s.itfQtfPt1=s.itfQtfPt2=null),s.itfFeat1=n.itfFeat1,s.itfFeat2=n.itfFeat2,s.itfFeatName1=n.itfFeatName1,s.itfFeatName2=n.itfFeatName2,s.mID=n.physicalid,s.mType=n.type,s.mRepRef=n.repRef,s.msca=n.sca):(s.itfMetricName=s.itfSystemType=s.itfUserType=s.itfAnalysis=s.itfPrevAnalysis=s.itfPenVec=s.itfPenVol=s.itfMinDist=s.itfClearVal=void 0,s.itfDescription=s.itfTolerance=s.itfOwner=s.itfOwnerID=s.itfCurrent=s.itfQtfPt1=s.itfQtfPt2=void 0,s.itfFeat1=s.itfFeat2=s.itfFeatName1=s.itfFeatName2=s.mID=s.mType=s.mRepRef=s.msca=void 0),t.push(s)}),t},this.updateInterference=function(e){if(e.id&&u.itfs[e.id]&&"string"==typeof e.param){var t,i,o,s=u.itfs[e.id],a=r[s.metricID];switch(e.param){case"itfCtxName":t=s.physicalid,i="PLMEntity.V_Name",o=e.newValue;break;case"itfMetricName":t=a?a.physicalid:null,i="PLMEntity.V_Name",o=e.newValue;break;case"itfUserType":t=a?a.physicalid:null,i="PLMPIMMetricReference.V_Itf_User_Type",o=P[e.newValue];break;case"itfAnalysis":t=a?a.physicalid:null,i="PLMPIMMetricReference.V_Itf_Analysis",o=C[e.newValue];break;case"itfDescription":t=a?a.physicalid:null,i="PLMEntity.V_description",o=e.newValue;break;default:t=a?a.physicalid:null,i=e.param.replace("M:",""),o=e.newValue}if(t){var c={data:{id:t,attrName:i,attrValue:o},onComplete:function(t){var i="string"==typeof t?JSON.parse(t):{},n=[];i&&"success"===i.status?"itfCtxName"===e.param?(s.itfCtxName=o,n.push(e.id)):(a[e.param]=o,Array.prototype.push.apply(n,a.ctxt)):n.push(e.id),m("itfUpdateSuccess",n.map(function(e){return{id:e}}))},onFailure:function(){m("itfUpdateFailed",[{id:e.id}])}};n._setAttrValue(c)}else setTimeout(function(){m("itfUpdateFailed",[{id:e.id}])},0)}else m("itfUpdateFailed",[{id:e.id}])},this.getLoadStatus=(()=>-2===u.nbItfs?"notLoaded":-1===u.nbItfs?"partiallyLoaded":"fullyLoaded"),this.getSpecAndContextInfo=function(e){if(!u.isrSpec||!u.isrSpec.physicalid)return window.console.error("isr without context and spec"),e.onFailure({error:"No specification available"});n._readIsrSpecStream({repRefID:u.isrSpec.physicalid,onComplete:function(i){if(!i||!i.infos||"OK"!==i.infos.status||!i.stream)return e.onFailure(i.infos.status);var n=i.stream;n.context=t.getIsrContexts()[0],n.isEditable=u.isrSpec.isEditable,e.onComplete(n)},onFailure:e.onFailure})},this.setSpecAndContextInfo=function(e){let t=u.isrSpec;if(!t||!t.physicalid||!t.isEditable)return window.console.error("isr without context and spec"),e.onFailure({error:"No specification available"});n._updateIsrContextAndSpec({isrID:u.physicalid,repRefID:t.physicalid,data:e.data,onFailure:e.onFailure,onComplete:t=>{u.isrContext[0].filter=N(t.filter),e.onComplete()}})},this.subscribe=function(e,t){return e&&t?I.subscribe({event:e},t):null},this.unsubscribe=function(e){null!=e&&I.unsubscribe(e)}}})}),define("DS/PIMwebViewModel/PIMwebIsrMgr",["DS/PIMwebViewModel/PIMwebIsr","DS/PIMwebViewModel/PIMwebUtils","DS/WAFData/WAFData","DS/CoreEvents/ModelEvents"],function(e,t,i,n){"use strict";var r={},o={},s=new n;function a(e,t){return s.publish({event:e,data:t})}function c(t){var i=r[t];if(!i){var n=new e({id:t});r[t]=i={isr:n,lock:0},o[t]=[],o[t].push(n.subscribe("itfUpdateSuccess",function(e){e.isrID=t,a("itfUpdateSuccess",e)})),o[t].push(n.subscribe("itfUpdateFailed",function(e){e.isrID=t,a("itfUpdateFailed",e)}))}return i.isr}function l(e){var n=UWA.Promise.deferred(),r=e&&e.platformId?e.platformId:t.getPlatformId();return function(e){var i=UWA.Promise.deferred();return t.get3DSpaceUrl(e).then(function(e){i.resolve(e)}),i.promise}(r).then(function(e){(function(e,t){var n=UWA.Promise.deferred(),r=e+"/resources/modeler/pno/person?current=true&select=preferredcredentials";return t&&(r+="&tenant="+t),i.authenticatedRequest(r,{method:"GET",type:"json",onComplete:function(e){var t=e.preferredcredentials.role.name,i=e.preferredcredentials.organization.name,r=e.preferredcredentials.collabspace.name;n.resolve(t+"."+i+"."+r)},onFailure:function(e){n.reject(new Error(e))}}),n.promise})(e,r).then(function(t){(function(e,t,n){var r=UWA.Promise.deferred(),o=e+"/ticket/get?runasctx="+encodeURIComponent(t).trim();return n&&(o+="&tenant="+n),i.authenticatedRequest(o,{headers:{Accept:"application/json"},method:"GET",type:"json",onComplete:function(e){r.resolve(e.ticket)},onFailure:function(e){r.reject(new Error(e))}}),r.promise})(e,t,r).then(function(i){n.resolve({url:e,loginTicket:i,securityContext:t})})})}),n.promise}return Object.freeze({subscribe:function(e,t){return!e||!t||"itfUpdateSuccess"!==e&&"itfUpdateFailed"!==e?(window.console.error("Invalid event name"),null):s.subscribe({event:e},t)},unsubscribe:function(e){if(null!=e)return s.unsubscribe(e)},getLoadedIsr:function(){var e={};return Object.keys(r).forEach(function(t){e[t]=r[t].isr}),e},getCreationParams:e=>t._getCreationParams(e),createIsr:e=>t._createIsr(e),computeIsr:e=>t._computeIsr(e),getComputeIsrJobStatus:e=>t._getComputeIsrJobStatus(e),getIsrJobsList:e=>t._getIsrJobsList(e),getIsr:function(e){var t=r[e];return t?t.isr:null},isUpdateSimulationAllowed:function(){var e,t="";if(window&&window.widget){var i="OnPremise"!==(e=window.widget).getValue("x3dPlatformId");if(e&&e.data&&e.data.appId&&(t=e.data.appId),1===window.top.__PIM_CSIExecute&&i&&("ENOR3M_AP"===t||"ENOI3S_AP"===t))return!0}return!1},readComputeIsrPrefs:function(){new Promise(function(e){let t=[{Repository:"PIMwebPref",PreferenceNames:["IDLinksAutomaticReroot","IDTrackPreviousAnalysisStatus"]}];require(["DS/CATWebUXPreferences/CATWebUXPreferencesUtils"].concat([]),function(i){try{i.readPreferences(t).then(function(t){e(t)})}catch(t){window.console.warn("Error Preferences ",t),e()}})})},get3DSpaceUrlAndLoginTicket:function(){var e=UWA.Promise.deferred();return l().then(function(t){e.resolve(t)}),e.promise},loadIsr:function(e){if(e&&e.isrID&&e.onProgress&&e.onComplete&&e.onFailure){var t=e.isrID,i=c(t);"fullyLoaded"!==i.getLoadStatus()?i._fetch({onProgress:function(n){e.onProgress({itfIDs:n.itfIDs,context:n.context,interferingPathsReady:n.interferingPathsReady,isrID:t,isr:i})},onComplete:function(){e.onComplete({isrID:t,isr:i,wasFullyLoaded:!1}),0===r[t].lock&&window.console.log("isr has not been locked!!!")},onFailure:function(n){delete r[t],i=null,e.onFailure(n)}}):(e.onProgress({itfIDs:i.getItfIDs(),context:i.getIsrContexts(),isrID:t,isr:i}),e.onComplete({isrID:t,isr:i,wasFullyLoaded:!0}))}else window.console.error("Invalid arguments")},loadIsrFromMetrics:function(e){e&&e.metrics&&e.onProgress&&e.onComplete&&e.onFailure?t._navigateFromMetricToIsr({metricIDs:e.metrics,onComplete:function(t){var i,n=JSON.parse(t),o={},s=[];n&&n.infos&&"OK"===n.infos.status&&n.result&&(n=n.result)&&Array.isArray(n)?(n.forEach(function(e){(i=e.outputs.isr?e.outputs.isr[0].physicalid:null)?(o[i]||(o[i]={itfC:[],itfM:[],label:e.outputs.isr[0]["ds6w:label"]}),o[i].itfC=o[i].itfC.concat(e.outputs.itfCtxt.map(function(e){return e.physicalid})),-1===o[i].itfM.indexOf(e.input_object.physicalid)&&o[i].itfM.push(e.input_object.physicalid)):s.push(e.input_object.physicalid)}),Object.freeze(o),e.onFilterIsr({isrIDs:o,metricsWithoutIsr:s,onComplete:function(t){var i=t.length,n=function(){0==--i&&e.onComplete()};if(0===t.length)return i=1,void n();t.forEach(function(t){if(o[t]){var i=c(t);i._fetch({contextualIDs:o[t].itfC,onProgress:e.onProgress,onComplete:function(){e.onComplete({isrID:t,isr:i,wasFullyLoaded:!1}),0===r[t].lock&&window.console.log("isr has not been locked!!!"),n()},onFailure:function(){e.onFailure({isrID:t,isr:i,wasFullyLoaded:!1})}})}})}})):e.onFailure()},onFailure:function(){e.onFailure()}}):e.onFailure()},lockIsr:function(e){var t=r[e];return t?(t.lock++,0):(window.console.log(e+" has not been loaded"),-1)},unlockIsr:function(e){var t=r[e];return t?(t.lock--,0===t.lock&&(t=r[e]=null,delete r[e]),0):(window.console.log(e+" has not been loaded"),-1)}})});