define("DS/KnowledgeWebCoreComm/comm",["DS/ExperienceKernel/ExperienceKernel","DS/KnowledgeWebUtils/Listenable","DS/KnowledgeWebCore/context","DS/KnowledgeWebUtils/Utils","DS/KnowledgeWebUtils/KnowledgeWebTrace","DS/UIKIT/Mask","css!DS/KnowledgeWebCoreComm/assets/Style/comm.css"],function(e,t,n,i,o,a){"use strict";const r=new t;function s(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):e}function u(e){let t=null;if(window.ActiveXObject)(t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e);else{t=(new DOMParser).parseFromString(e,"text/xml")}return t}function l(...e){const t=n.getValue("Kconsole");t&&t.log&&t.log(...e)}var c={ids:[],cbs:[],add:function(e,t){0===this.ids.length&&r.notify("isWaitingForAnswer",!0),this.ids.push(e),this.cbs.push(t)},remove:function(e){var t=this.ids.indexOf(e);t>-1&&(this.cbs.splice(t,1),this.ids.splice(t,1)),0===this.ids.length&&r.notify("isWaitingForAnswer",!1)},get:function(e){var t,n=this.ids.indexOf(e);return n>-1&&(t=this.cbs[n]),t},getIndex:function(e){return this.cbs[e]},isWaitingForAnswer:function(){return this.ids.length>0}};Object.defineProperty(c,"length",{get:function(){return this.ids.length},set:function(){}});var d,h,f={},g={},m=new Map,p=new Map,v="",y="",b={status:!1,cb:[],check:function(){var e,t=!1;for(e=0;e<c.length&&!t;e++)c.cbs[e].displayWP&&(t=!0);if(b.status!==t)for(b.status=t,e=0;e<b.cb.length;e++)b.cb[e](b.status)}},C=/END:(\d*)/,x=null,w=[];function A(e){if(void 0!==e.notification){var t=e.notification.getAttr("name"),n="";if(""!==e.notification.getAttr("modeler")&&(n=e.notification.getAttr("modeler")),p.has(n))p.get(n).forEach(function(t){var n=t(e);void 0!==n&&(e=n)});if(p.has("ALL"))p.get("ALL").forEach(function(t){var n=t(e);void 0!==n&&(e=n)});if(void 0!==f[t]){for(var o=0;o<f[t].length;o++)y=t,i.isFunction(f[t][o])&&f[t][o](e);y="",f[a=t]&&f[a].length&&-1!==f[a].indexOf(null)&&(f[a]=f[a].filter(i.exists))}}var a;return e}function L(e,t){var n=C.exec(e);if(null!==n&&2===n.length)c.remove(parseInt(n[1])),x=null,null;else{var o=S(u(e));if(void 0!==o.notification){var a=o.notification.getAttr("name");l(e," > Notification : "+a,t),r.notify("io",{label:" > Notification : "+a,text:e}),o=A(o)}else{var s,d,h,f="",p="ALL";if(void 0!==o&&void 0!==o.response&&void 0!==o.response.cmdReturn){x=parseInt(o.response.getAttr("id")),(h=c.get(x))&&(d=h.obj);var y=[];o.response.cmdReturn.forEach(function(e,t){y.push(e.getAttr("name"))});var w=[];o.response.cmdReturn.forEach(function(e,t){w.push(e.getAttr("modeler"))}),l(e," > Response id : "+x+" - modeler : "+w.join(", ")+" -> "+y.join(", "),t),r.notify("io",{label:" > Response id : "+x+" - modeler : "+w.join(", ")+" -> "+y.join(", "),text:e}),o.response.cmdReturn.forEach(function(e,n){f=e.getAttr("name"),""!==e.getAttr("modeler")&&(p=e.getAttr("modeler"));var a,r={};(r.response={},r.response["@attr"]=o["@attr"],r.response.getAttr=N.prototype.getAttr,r.response.cmdReturn=e,m.has(p))&&m.get(p).forEach(function(e){var t=e(r,d,x);void 0!==t&&(r=t)});m.has("ALL")&&m.get("ALL").forEach(function(e){var t=e(r,d,x);void 0!==t&&(r=t)});if(0===n?s=r:1===n?s=[s,r]:s.push(r),""!==f&&void 0!==g[f]){for(var u=0;u<g[f].length;u++)v=f,i.isFunction(g[f][u])&&g[f][u](r,d,x,t);v="",g[a=f]&&g[a].length&&-1!==g[a].indexOf(null)&&(g[a]=g[a].filter(i.exists))}})}else l(e," > Empty or invalid message !",t),r.notify("io",{label:" > Empty or invalid message !",text:e});h&&h.onText&&h.onText(s,d,x)}}return b.check(),!0}function T(t){if(x){var n=c.get(x);if(l("cannot display binary"," > binary received for "+x),r.notify("io",{label:" > binary received for "+x,text:"cannot display binary"}),void 0!==n&&void 0!==n.onBinary){var i=new e.BinaryReader(t).dataView.buffer;n.onBinary(i)}}return!0}function j(e){o.log("KillGraphViewer"),o.log("onClose"),e||a.mask(document.body,"Websocket connection failed")}function N(e){this.tagName=e,this.children=[],this.objectType="MessageNode"}function S(e){var t,n,i,o,a,r,s,u=new N;if(1===e.nodeType){if(u.tagName=e.tagName,u["@attr"]={},e.attributes.length>0)for(n=0;n<e.attributes.length;n++)i=e.attributes.item(n),u["@attr"][i.nodeName]=i.value}else if(3===e.nodeType)u=e.nodeValue;else if(9===e.nodeType&&(u["@attr"]={},e.documentElement.attributes.length>0))for(n=0;n<e.documentElement.attributes.length;n++)i=e.documentElement.attributes[n],u["@attr"][i.name]=i.value;if(e.hasChildNodes())for(t=0;t<e.childNodes.length;t++)void 0===u[a=(o=e.childNodes.item(t)).nodeName]?(r=S(o),u[a]=r,u.children.push(r)):(void 0===u[a].push&&(s=u[a],u[a]=[],u[a].push(s)),r=S(o),u[a].push(r),u.children.push(r));return u}function q(e){return this.bName=e,this.content=[],this.modeler="",this}function V(){q.call(this,"request");var e=this;return this.id=Date.now(),this.toXml=function(){for(var t="<request id='"+e.id+"' modeler='"+e.modeler+"'>",n=0;n<e.content.length;n++)t+=e.content[n].toXml();return t+="</request>"},this}function O(e){q.call(this,"command");var t=this;return this.name=e,this.id=null,this.toXml=function(){for(var e="<command name='"+t.name+"'"+(t.id?" id='"+t.id+"'":"")+(t.requestsManager?" modeler='"+t.requestsManager.getModeler()+"'":"")+" >",n=0;n<t.content.length;n++)e+=t.content[n].toXml()+"";return e+="</command>"},this}function W(e){q.call(this,"value");var t=this;return this.name=e.name,this.type=e.type,this.value=e.value,this.unit=e.unit,this.channels=e.channels,this.toXml=function(){var e="<value";if(void 0!==t.name&&(e+=" name='"+t.name+"'"),void 0!==t.type&&(e+=" type='"+t.type+"'",this.unit&&(e+=" unit='"+t.unit+"'")),e+=">",void 0!==t.value&&0===t.content.length)e+=s(t.value)+"";else if(t.content.length>0)for(var n=0;n<t.content.length;n++)e+=t.content[n].toXml()+"";return e+="</value>"},this.toJSON=function(){if("List"===this.type){for(var e="[",t=0;t<this.content.length;t++)t>0&&(e+=", "),e+=this.content[t].toJSON();return e+="]"}return this.value},this}n.addListener(function(){n.getValue("CustomCommunicationChannel")&&(w&&w.length&&w.forEach(function(e){B.send(e.request,e.onText?e.onText:function(){},e.onBinary?e.onBinary:function(){},e.displayWP,e.obj)}),w=[])},"CustomCommunicationChannelChanged"),N.prototype.get=function(e,t){var n;if(void 0!==this[e])if(this[e]instanceof Array){for(var i=0;i<this[e].length;i++)if(this[e][i].getAttr("name")===t){n=this[e][i];break}}else this[e].getAttr("name")===t&&(n=this[e]);return n},N.prototype.getAttr=function(e){return this["@attr"][e]},N.prototype.forEach=function(e){if(void 0!==this)if(this instanceof Array)for(var t=0;t<this.length;t++)e(this[t],t);else e(this,0)},q.prototype.add=function(e){this.content.push(e),e.requestsManager&&e.requestsManager.getModeler&&(this.modeler=e.requestsManager.getModeler())},q.prototype._streamSelectionReducer=function(e,t){return i.exists(t.channels[channelId])?e+JSON.stringify(t.channels[channelId]):i.isFunction(t.streamChannel)?e+t.streamChannel(channelId):e},q.prototype.streamChannel=function(e){let t=null;for(let n=0;n<this.content.length&&null===t;n++){let o=this.content[n];i.exists(o)&&(i.exists(o.channels)&&i.exists(o.channels[e])?t=o.channels[e]:i.isFunction(o.streamChannel)&&(t=o.streamChannel(e)))}return t},V.prototype=Object.create(q.prototype,{constructor:{value:V,enumerable:!1}}),V.prototype.getCommandsName=function(){for(var e=[],t=0;t<this.content.length;t++)e.push(this.content[t].name);return e},V.prototype.getCommands=function(){for(var e=[],t=0;t<this.content.length;t++){for(var n=this.content[t].name+"(",i=0;i<this.content[t].content.length;i++)i>0&&(n+=", "),n+=this.content[t].content[i].toJSON();n+=")",e.push(n)}return e},V.prototype.isReadOnly=function(){for(var e=!0,t=0;t<this.content.length&&e;t++)!0!==this.content[t].readonly&&(e=!1);return e},Object.defineProperty(V.prototype,"requireUpdate",{get:function(){for(var e=!1,t=0;t<this.content.length&&!e;t++)!0===this.content[t].requireUpdate&&(e=!0);return e},set:function(){}}),O.prototype=Object.create(q.prototype,{constructor:{value:O,enumerable:!1}}),W.prototype=Object.create(q.prototype,{constructor:{value:W,enumerable:!1}});var B={popUpErrors:function(e){var t=e.response.cmdReturn.param;if(void 0!==t){var n=[];t instanceof Array||"Errors"===t.getAttr("name")&&(n=t.value.value);for(var i=0;i<n.length;i++){var o=/Line \d* : Evaluation error in relation [^\s]* (.*)/.exec(n[i]["#text"].replace("\n"," "));2===o.length?n[i]=o[1]:n[i]=n[i]["#text"]}}},addWaitingStatusCB:function(e){b.cb.push(e)},removeWaitingStatusCB:function(e){var t=b.cb.indexOf(e);t>-1&&b.cb.splice(t,1)},sendText:function(e,t,i,o,a,s,u){var f,g;void 0===a&&(a=!1),"EKCommunication"===n.getValue("CommunicationContext")?(t&&c.add(t,{onText:i,onBinary:o,displayWP:a,obj:s}),f=" < Request id : "+t,u&&(f+=" -> "+u.join(", ")),l(e,f),r.notify("io",{label:f,text:e}),d.sendText(h,e),b.check()):n.getValue("CustomCommunicationChannel")?(g=n.getValue("CustomCommunicationChannel"),t&&c.add(t,{onText:i,onBinary:o,displayWP:a,obj:s}),f=" < Request id : "+t,u&&(f+=" -> "+u.join(", ")),l(e,f),r.notify("io",{label:f,text:e}),g.sendText({text:e,readOnly:!1,requireUpdate:!0}),b.check()):(f=" < Request id : "+t,u&&(f+=" -> "+u.join(", ")),w.push({cbid:t,display:f,message:e,onText:i,onBinary:o,displayWP:a,obj:s}))},send:function(e,t,i,o,a){function s(e,t,n,i,o){var a="";if("object"==typeof e){var s=e.id;a=e.toXml();var u=e.getCommands(),d=" < Request id : "+s+" - modeler : "+e.modeler;s&&c.add(s,{onText:t,onBinary:n,displayWP:i,obj:o}),u&&(d+=" -> "+u.join(", ")),l(a,d),r.notify("io",{label:d,text:a})}else"string"==typeof e&&(a=e);return a}if(void 0===o&&(o=!1),"EKCommunication"===n.getValue("CommunicationContext")){var u=s(e,t,i,o,a);d.sendText(h,u),b.check()}else if("GenUXCommunication"===n.getValue("CommunicationContext")){u=s(e,t,i,o,a);let r=n.getValue("GraphAsGenUXContext");r&&r.sendMessage(e),b.check()}else if(n.getValue("CustomCommunicationChannel")){var f=n.getValue("CustomCommunicationChannel");u=s(e,t,i,o,a);void 0!==f.send&&"object"==typeof e?f.send(e):f.sendText(u),b.check()}else w.push({request:e,onText:t,onBinary:i,displayWP:o,obj:a})},startLongTransaction:function(e){const t=n.getValue("CustomCommunicationChannel");return t&&"function"==typeof t.startLongTransaction?t.startLongTransaction(e):Promise.reject()},endLongTransaction:function(e){const t=n.getValue("CustomCommunicationChannel");return t&&"function"==typeof t.endLongTransaction?t.endLongTransaction(e):Promise.reject()},addNotificationCallback:function(e,t){void 0===f[e]&&(f[e]=[]),f[e].push(t)},addAllNotificationCallback:function(e,t="ALL"){var n;p.has(t)?(n=p.get(t)).has(e)||n.add(e):(n=new Set([e]),p.set(t,n))},removeAllNotificationCallback:function(e,t="ALL"){if(p.has(t)){var n=p.get(t);n.has(e)&&n.delete(e),p.set(t,n)}},removeNotificationCallback:function(e,t){if(f&&e&&void 0!==f[e]){var n=f[e].indexOf(t);n>-1&&(y===e?f[e][n]=null:f[e].splice(n,1))}},addCommandCallback:function(e,t){void 0===g[e]&&(g[e]=[]),g[e].push(t)},removeCommandCallback:function(e,t){if(g&&e&&void 0!==g[e]){var n=g[e].indexOf(t);n>-1&&(v===e?g[e][n]=null:g[e].splice(n,1))}},addAllCommandCallback:function(e,t="ALL"){var n;m.has(t)?(n=m.get(t)).has(e)||n.add(e):(n=new Set([e]),m.set(t,n))},removeAllCommandCallback:function(e,t="ALL"){if(m.has(t)){var n=m.get(t);n.has(e)&&n.delete(e),m.set(t,n)}},getWaitingStatus:function(){return b.status}};return B.xmlEscape=s,B.MessageNode=N,B.Request=V,B.Command=O,B.Value=W,B.stringtoXML=u,B.xml2json=S,B.createNode=function(t,n){var i;i=void 0!==n?n:2097;var o=(d=new e.Node({onText:L,onBinary:T,onHypervisorDisconnect:j,hypervisorIp:t,webSocketPort:i,pool:"KnowledgeGraphClientPool"})).connect("KnowledgeGraphServerPool");return h=o.select(),d.sendTextOnDisconnection(h,"DISCONNECT"),d.subscribe(h,"Notification"),{id:h,createdNode:d}},B.onText=L,B.onBinary=T,B.listenable=r,B.onCommunicationConnect=function(){a.unmask(document.body)},B.onCommunicationDisconnect=j,n.setValue("GraphCommunicationNode",B),n.setValue("KnowledgewareCommunicationNode",B),B}),define("DS/KnowledgeWebCoreComm/ToValueInterface",[],function(){function e(){}return e.prototype.toValue=function(){return{name:"undefined",type:"undefined",value:"undefined"}},e}),define("DS/KnowledgeWebCoreComm/AppRequests",["DS/KnowledgeWebCoreComm/comm","DS/KnowledgeWebCoreComm/ToValueInterface","DS/KnowledgeWebUtils/Utils","DS/KnowledgeWebCore/KnowledgeMagnitudeServices"],function(e,t,n,i){"use strict";class o{constructor(e){this._modeler=e.modeler,this._grouping={activated:!1,commands:[],textCBs:[],binCBs:[],textCB:function(){var e=this.textCBs;return this.textCBs=[],function(t,n,i){for(var o=0;o<e.length;o++)e[o]&&e[o](t,n,i)}},binCB:function(){}}}static buildRequest(t,n){var i;t instanceof Array||(t=[t]);var o=new e.Request;for(n&&(o.modeler=n),o.waiting=!1,i=0;i<t.length;i++)o.add(t[i]),o.waiting=o.waiting||t[i].waiting;return o}send(t,n,i,a){var r;t instanceof Array||(t=[t]);const s=t.filter(e=>e.isValid());if(t.length!==s.length&&console.warn(t.length-s.length+" invalid resquests have been filtered."),!this._grouping.activated){const t=o.buildRequest(s,this._modeler);return e.send(t,n,i,t.waiting||a),t.id}for(r=0;r<s.length;r++)this._grouping.commands.push(s[r]),this._grouping.textCBs.push(n),this._grouping.binCBs.push(i)}sendAndWait(e,t,n,i,o){return new Promise(a=>{this._grouping.activated&&console.warn("requests grouping activated but ignored because sendAndWait can not be grouped");var r=new this[e](t,o);i?this.send(r,null,a,n):this.send(r,a,null,n)})}startGroup(){this._grouping.activated||(this._grouping.activated=!0,this._grouping.commands=[])}endGroup(e,t){this._grouping.textCBs.push(e),this._grouping.binCBs.push(t),this._grouping.activated&&(this._grouping.activated=!1,this._grouping.commands.length>0?this.send(this._grouping.commands,this._grouping.textCB(),t):n.isFunction(e)&&this._grouping.textCB()())}endGroupAndDump(){let e=null;return this._grouping.activated&&(this._grouping.activated=!1,this._grouping.commands.length>0&&(e=o.buildRequest(this._grouping.commands))),e}static startLongTransaction(t){return e.startLongTransaction(t)}static endLongTransaction(t){return e.endLongTransaction(t)}getModeler(){return this._modeler}createCommand(e,i,o){const a=this;var s,u,l;o&&(s=o.waiting,u=o.readonly,l=o.requireUpdate),a[e]=function(o,s){r.call(this,e,a),n.isObject(s)&&n.isBoolean(s.requireUpdate)&&(this.requireUpdate=s.requireUpdate),o instanceof Array||(o=[o]);for(var u=0,l=0;l<i.length&&u<o.length;l++){var c=i[l].name,d=i[l].type,h=i[l].value,f=null;if(!(o[u]instanceof Object)||o[u]instanceof Array||n.implement(o[u],t)||(void 0!==o[u].name&&(c=o[u].name),void 0!==o[u].type&&(d=o[u].type),void 0!==o[u].value&&(h=o[u].value),void 0!==o[u].unit&&(f=o[u].unit),u++),void 0===c&&(c=o[u++]),void 0===d&&u<o.length&&(d=o[u++]),void 0===h&&u<o.length&&(void 0===(h=o[u++])?(h=null,d="NULL"):n.isObject(h)&&n.exists(h.value)&&n.exists(h.unit)&&(f=h.unit,h=h.value)),void 0!==c&&void 0!==d&&void 0!==h)if(i[l].repeatable&&h instanceof Array)for(var g=0;g<h.length;g++)this.addValue(c,d,h[g],f);else this.addValue(c,d,h,f)}return this},n.inherits(a[e],r),a[e].prototype.addParam=function(e,t){for(var n,o=0;o<i.length&&void 0===n;o++)i[o].name===e&&(n=i[o]);this.addValue(n.name,n.type,t)},a[e].prototype.waiting=s,u&&(a[e].prototype.readonly=u),a[e].prototype.requireUpdate=l,a["send"+e]=function(t,n,i,o,r){var s=new a[e](t,r);return void 0!==o&&(s.waiting=o),a.send(s,n,i)}}}function a(o){var r,s,u,l,c={};o instanceof Object&&(o instanceof Array?(r="listError",s="String",u="cannot be treated without a type",l=void 0):(r=o.name,o.value instanceof Object?o.value instanceof Array?(s="List",l=o.value,u=void 0):n.implement(o.value,t)?(s=(o=o.value.toValue()).type,u=o.value):"Selection"===o.type&&(c.selection=o.value,s="Feature",u="Selection"):(s=o.type,u=o.value)));var d={name:r,type:s,value:u,channels:c};if(s&&i.isAMagnitude(s)&&(o.unit?d.unit=i.getUnitFromLabel(s,o.unit).Name:d.unit=i.getUnitToDisplay(s).Name),e.Value.call(this,d),void 0===u&&void 0!==l&&l instanceof Array)for(var h=0;h<l.length;h++)this.add(new a({name:r+"."+h,type:o.type,value:l[h]}));return this}function r(t,n){return this.requestsManager=n,e.Command.call(this,t),this}return n.inherits(a,e.Value),Object.defineProperty(a.prototype,"valid",{get:function(){return this.content.reduce((e,t)=>e&&!1!==t.valid,!0)&&n.exists(this.type)&&n.isString(this.type)&&""!==this.type}}),n.inherits(r,e.Command),r.prototype.addValue=function(e,t,n,i){this.add(new a({name:e,type:t,value:n,unit:i}))},r.prototype.addValues=function(e){for(var t=0;t<e.length;t++)e[t].name&&e[t].type&&e[t].value&&this.addValue(e[t].name,e[t].type,e[t].value)},r.prototype.send=function(e,t){this.requestsManager.send(this,e,t)},r.prototype.isValid=function(){return this.content.reduce((e,t)=>e&&!1!==t.valid,!0)},o});