define("DS/MPFBiddingNewMessage/CancelConfirmationModal",["UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Mask","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a){"use strict";const n=Object.freeze({CONFIRMED:"confirmed"}),r=e.extend({className:"mpf-cancel-modal",setup:function(){this.confirmButton=this._createConfirmButton(),this.cancelButton=this._createCancelButton(),this.modal=this._createModal()},render:function({isPhaseCancel:e,phase:t}={}){return this.modal.setHeader(this._getModalHeader({isPhaseCancel:e,phase:t})),this.modal.setBody(this._getModalBody({isPhaseCancel:e})),this.container.setContent(this.modal),this},show:function(){this.setLoading(!1),this.modal.show()},hide:function(){this.modal.hide()},setLoading:function(e){(e=!1!==e)?(i.mask(this.modal.getBody()),this.confirmButton.load()):(i.unmask(this.modal.getBody()),this.confirmButton.load(!1))},_cancelCart:function(){this.setLoading(),this.dispatchEvent(n.CONFIRMED)},_createModal:function(){return new t({footer:[this.confirmButton,this.cancelButton]})},_getModalBody:function({isPhaseCancel:e}){return[{tag:"div",class:"fonticon fonticon-3x fonticon-trash"},{tag:"div",class:"mpf-first-line",text:e?a.get("cancelThisPhase"):a.get("cancelThisRequest")},{tag:"div",class:"mpf-second-line",text:a.get("actionIrreversible")}]},_getModalHeader:function({isPhaseCancel:e,phase:t}){return{tag:"h4",text:e?a.get("cancelPhase",{number:t.getNumber()}):a.get("cancelRequest")}},_createConfirmButton:function(){return new s({className:"primary",value:a.get("confirm"),events:{onClick:this._cancelCart.bind(this)}})},_createCancelButton:function(){return new s({value:a.get("close"),events:{onClick:this.hide.bind(this)}})},destroy:function(){this.modal=null,this._parent(),this.container=null}});return r.Events=n,r}),define("DS/MPFBiddingNewMessage/BiddingActions",[],function(){"use strict";return Object.freeze({SEND_REQUEST:"sendRequest",SEND_MESSAGE:"message",ACCEPT:"accept",CANCEL:"cancel",PAY:"pay",NOTIFY_WORK_STARTED:"workStarted",NOTIFY_READY:"ready",NOTIFY_SHIPPING:"shipping",CONFIRM_DELIVERY:"confirmDelivery",ACCEPT_PHASE:"acceptPhase",NOTIFY_PHASE_WORK_STARTED:"phaseWorkStarted",ACCEPT_PHASE_DELIVERY:"acceptPhaseDelivery",REJECT_PHASE_DELIVERY:"rejectPhaseDelivery",NOTIFY_PHASE_DELIVERY:"notifyPhaseDelivery",CANCEL_PHASE:"cancelPhase",UPDATE:"update",BUYER_UPDATE:"buyerUpdate",UPDATE_AND_ACCEPT:"updateAndAccept",SEND_QUOTE:"sendQuote",SEND_TENDER_QUOTE:"sendTenderQuote",CONFIRM_PAID_CART_MODIF:"confirmPaidCartModif",CONFIRM_PAID_CART_AND_PAY:"confirmPaidCartAndPay",CONFIRM_EMP_ORDER:"confirmEmpOrder"})}),define("DS/MPFBiddingNewMessage/BiddingDeliveryMethod",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n){"use strict";var r={DELIVERY_METHOD_CHANGED:"deliveryMethodChanged"},o=t.extend({className:"mpf-bidding-delivery-method",setup:function(e){e||(e={}),i.requiredOfPrototype(e.cart,a,"options.cart must be a CartModel"),this.cart=e.cart,this.shippingRadio=this._createShippingRadio(),this.pickUpRadio=this._createPickUpRadio()},render:function(){return this.cart.getState()===a.States.DRAFT?this.container.setContent([n.get("delivery"),this.pickUpRadio,this.shippingRadio]):this.container.setContent(""),this},isShippingSelected:function(){return this.shippingRadio.isChecked()},_createShippingRadio:function(){var e=this;return new s({checked:!0,type:"radio",value:n.get("shipping"),className:"primary",events:{onChange:function(){this.isChecked()&&(e.pickUpRadio.setCheck(!1),e.dispatchEvent(r.DELIVERY_METHOD_CHANGED,e.shippingRadio.isChecked()))}}})},_createPickUpRadio:function(){var e=this;return new s({type:"radio",value:n.get("pickUp"),className:"primary",events:{onChange:function(){this.isChecked()&&(e.shippingRadio.setCheck(!1),e.dispatchEvent(r.DELIVERY_METHOD_CHANGED,e.shippingRadio.isChecked()))}}})}});return o.Events=Object.freeze(r),o}),define("DS/MPFBiddingNewMessage/BiddingUploadFileComponent",["UWA/Core","UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/File","DS/MPFUtils/FormatUtils","DS/MPFServices/ObjectService","DS/MPFView/GuidanceHelper","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractModel","DS/MPFTcDocumentModel/TcDocumentModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u){"use strict";const p={DOCUMENT_SAVED:"docSaved",DOCUMENT_NOT_SAVED:"docNotSaved"},m={NDA:"NDA",SALES_CONDITIONS:"salesConditions",OTHER:"other"},g={[m.NDA]:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/pdf"],[m.SALES_CONDITIONS]:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/pdf"]};function P(t,s,i){const a=t.getState()===d.States.DRAFT||t.getState()===d.States.SUBMITTED,n=s.getState()===l.STATUS.draft||s.getState()===l.STATUS.submitted;return e.is(i)?a&&n&&i.getCurrentState()!==c.STATUS.inEffect:a&&n}const S=t.extend({tagName:"div",className:"mpf-bidding-upload-files",setup(e){e||(e={}),this._checkPrototypes(e),this.buyerView=!0===e.buyerView,this.tcDocumentFactory=e.tcDocumentFactory,this.cart=e.cart,this.cartItem=e.cartItem,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize||31457280,this.nda=e.nda,this.alwaysAllowDocUpload=!0===e.alwaysAllowDocUpload,this.addNdaButton=this._createAddNdaButton(),this.addNdaTooltip=this._createNdaTooltip(),this.addSalesDocumentButton=this._createAddSalesDocumentButton(),this.addSalesDocumentTooltip=this._createSalesDocumentTooltip(),this.addDocumentButton=this._createAddDocumentButton(),this.addDocumentTooltip=this._createDocumentTooltip()},render(){const e=[];return this.buyerView&&this._isBuyerAllowedToUploadNDA()&&!this.alwaysAllowDocUpload||e.push(this._getAddDocumentButtonContainer()),this.buyerView&&this._isBuyerAllowedToUploadNDA()&&e.push(this._getAddNdaContainer()),!this.buyerView&&this._isSellerAllowedToUploadSalesConditions()&&e.push(this._getAddSalesDocumentContainer()),this.container.setContent(e),this},_getAddSalesDocumentContainer(){return e.createElement("div",{class:"mpf-sales-doc",html:[this.addSalesDocumentButton,this.addSalesDocumentTooltip]})},_getAddNdaContainer(){return e.createElement("div",{class:"mpf-nda-doc",html:[this.addNdaButton,this.addNdaTooltip]})},_getAddDocumentButtonContainer(){return e.createElement("div",{class:"mpf-add-doc",html:[this.addDocumentButton,this.addDocumentTooltip]})},_clearDoc(e){switch(e){case m.NDA:this.addNdaButton.clear();break;case m.SALES_CONDITIONS:this.addSalesDocumentButton.clear();break;case m.OTHER:this.addDocumentButton.clear()}},_createSalesDocumentTooltip(){const t=[e.createElement("p",{text:u.get("addSalesCond")})];return this.maxSpecificFileSize&&t.push(e.createElement("p",{text:u.get("maximumFileSize",{size:a.getReadableFileSize(this.maxSpecificFileSize)})})),t.push(e.createElement("p",{text:u.get("supportedFileFormatsSalesConditions")})),new r({position:"left",content:t})},_createNdaTooltip(){const t=[e.createElement("p",{text:u.get("addNdaDoc")})];return this.maxSpecificFileSize&&t.push(e.createElement("p",{text:u.get("maximumFileSize",{size:a.getReadableFileSize(this.maxSpecificFileSize)})})),t.push(e.createElement("p",{text:u.get("supportedFileFormatsNda")})),new r({position:"left",content:t,useTooltip:!0})},_createDocumentTooltip(){const t=[e.createElement("p",{text:u.get("addDocSeller")})];return this.maxFileSize&&t.push(e.createElement("p",{text:u.get("maximumFileSize",{size:a.getReadableFileSize(this.maxFileSize)})})),t.push(e.createElement("p",{text:u.get("supportedFileFormats")})),new r({position:"left",content:t,useTooltip:!0})},_createAddDocumentButton(){const e=new i({icon:"attach",buttonText:u.get("addDocument"),input:!1,name:m.OTHER,events:{onChange:this._uploadFile.bind(this,m.OTHER)},attributes:{title:u.get("addDocument")}});return this._addIcon("attach",e),e},_createAddSalesDocumentButton(){const e=new i({buttonText:u.get("addSalesConditions"),input:!1,name:m.SALES_CONDITIONS,events:{onChange:this._uploadFile.bind(this,m.SALES_CONDITIONS)},attributes:{title:u.get("addSalesConditions")}});return this._addIcon("doc-log",e),e},_createAddNdaButton(){const e=new i({buttonText:u.get("addNda"),className:"mpf-nda-btn",input:!1,name:m.NDA,events:{onChange:this._uploadFile.bind(this,m.NDA)},attributes:{title:u.get("addNda")}});return this._addIcon("doc-log",e),e},_addIcon(t,s){e.createElement("span",{class:"fonticon fonticon-"+t}).inject(s.elements.button,"top")},_uploadFile(t,i){const a=this,n={};let r;const c=i.target.files[0];if(e.is(c)){const e=this._validateFile(t,c);e.ok?(t===m.NDA?(r=this.tcDocumentFactory.createModel(o.Types.NEW_NDA),n.type=h.DocumentTypes.NDA):t===m.SALES_CONDITIONS?(r=this.tcDocumentFactory.createModel(o.Types.NEW_CUSTOM_TC_SELLERS),n.type=h.DocumentTypes.SPECIFIC_SALES_CONDITIONS):t===m.OTHER&&(r=this.tcDocumentFactory.createModel(o.Types.CART_BIDDING)),s.mask(this.container),r.saveDocument({file:c},n).then(function(e){s.unmask(a.container),a.dispatchEvent(p.DOCUMENT_SAVED,{docName:c.name,docID:r.getDocID()||Object.keys(r.get("documentIDs"))[0],docType:t})}).catch(function(){const e=c.type.indexOf("image")>-1;let i;i=e&&t===m.NDA?u.get("imageCantBeUploadedNDA"):e&&t===m.SALES_CONDITIONS?u.get("imageCantBeUploadedSalesConditions"):u.get("uploadError"),s.unmask(a.container),a.dispatchEvent(p.DOCUMENT_NOT_SAVED,i)}).finally(this._clearDoc.bind(this,t))):this.dispatchEvent(p.DOCUMENT_NOT_SAVED,e.message)}},_validateFile(e,t){const s=this._validateFileSize(e,t.size),i=this._validateFileType(e,t.type);return{ok:s.ok&&i.ok,message:s.message||i.message}},_validateFileSize(e,t){const s={ok:!0};return e===m.NDA||e===m.SALES_CONDITIONS?(s.ok=!this.maxSpecificFileSize||t<=this.maxSpecificFileSize,s.ok||(s.message=u.get("fileExceedsMaxSize",{size:a.getReadableFileSize(this.maxSpecificFileSize)}))):e===m.OTHER&&(s.ok=!this.maxFileSize||t<=this.maxFileSize,s.ok||(s.message=u.get("fileExceedsMaxSize",{size:a.getReadableFileSize(this.maxFileSize)}))),s},_validateFileType(e,t){const s={},i=g[e];return s.ok=!i||i.includes(t),s.ok||(s.message=u.get("fileFormatNotSupported")),s},_isSellerAllowedToUploadSalesConditions(){const e=this.cart.getState()===d.States.SUBMITTED,t=this.cartItem.getState()===l.STATUS.submitted||this.cartItem.getState()===l.STATUS.accepted;return e&&t},_isBuyerAllowedToUploadNDA(){return P(this.cart,this.cartItem,this.nda)},_checkPrototypes(e){n.requiredOfPrototype(e.tcDocumentFactory,o,"options.tcDocumentFactory must be a TCDocumentFactory"),n.requiredOfPrototype(e.cart,d,"options.cart must be a CartModel"),n.requiredOfPrototype(e.cartItem,l,"options.cartItem must be a CartItemModel"),this.buyerView&&this.cart.getState()===d.States.SUBMITTED&&n.requiredOfPrototype(e.nda,c,"options.nda must be a TcContractModel")}});return S.Events=Object.freeze(p),S.DocTypes=Object.freeze(m),S.isBuyerAllowedToUploadNDA=P,S}),define("DS/MPFBiddingNewMessage/CancelReasonInput",["UWA/Class/View","DS/UIKIT/Input/Select","DS/MPFCartModel/CartCancelReasonCompiler","i18n!DS/MPFBiddingNewMessage/assets/nls/CancelConfirmationModalV2"],function(e,t,s,i){"use strict";const a=Object.freeze({}),n=e.extend({className:"mpf-cancel-reason-input",setup({isBuyerView:e}){this.input=this._createInput({isBuyerView:e})},render(){return this.container.setContent([{tag:"div",class:"mpf-label",html:[i.get("pleaseTellReason"),{tag:"span",class:"mpf-required-icon",text:"*"}]},this.input]),this},validate(){return this.getValue()?(this.container.removeClassName("mpf-invalid"),!0):(this.container.addClassName("mpf-invalid"),!1)},getValue(){return this.input.getValue()[0]},clear(){return this.input.clear()},destroy(){this.input=null,this._parent(),this.container=null},_createInput({isBuyerView:e}){const a=(e?s.getBuyerReasons():s.getSellerReasons()).map(e=>({value:e,label:s.translate(e)}));return new t({placeholder:i.get("selectAReason"),required:!0,options:a,events:{onChange:this.validate.bind(this)}})}});return n.Events=a,n}),define("DS/MPFBiddingNewMessage/CartChangeTracker",["UWA/Class","UWA/Class/Events","UWA/Class/Listener","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartPhaseModel/CartPhaseModel"],function(e,t,s,i,a,n,r){"use strict";const o=Object.freeze({ON_CHANGE:"onChange"}),c=[a.Fields.GROSS_AMOUNT_TOTAL,a.Fields.TAXES_AMOUNT_TOTAL,a.Fields.NET_AMOUNT_TOTAL,a.Fields.CART_ITEMS,"didOrderChanged","originalCart"],h=e.extend(t,s,{init({cart:e,cartItems:t,cartPhases:s}){this.cart=e,this.items=t,this.phases=s,this.originalItems=t.clone(),this.originalPhases=s&&s.clone(),this.listenTo(this.cart,"onChange",this._dispatchChange.bind(this)),this.listenTo(this.items,"onAdd",this._dispatchChange.bind(this)),this.listenTo(this.items,"onRemove",this._dispatchChange.bind(this)),this.listenTo(this.items,"onChange",this._dispatchChange.bind(this)),this.phases&&(this.listenTo(this.phases,"onAdd",this._dispatchChange.bind(this)),this.listenTo(this.phases,"onRemove",this._dispatchChange.bind(this)),this.listenTo(this.phases,"onChange",this._dispatchChange.bind(this)))},hasPendingChanges(){return this.hasCartChanges()||this.hasItemChanges()||!!this.phases&&this.hasPhaseChanges()},hasCartChanges(){const e=this.getFilteredCartChanges();return e&&Object.keys(e).length>0},hasItemChanges(){return this.getAddedItems().length>0||this.getRemovedItems().length>0||this.getChangedItems().length>0},hasPhaseChanges(){return this.getAddedPhases().length>0||this.getRemovedPhases().length>0||this.getChangedPhases().length>0},getFilteredCartChanges(){const e=this.cart.getPendingChanges();return e?(Object.keys(e).forEach(t=>{c.indexOf(t)>-1&&delete e[t]}),e):{}},getAddedItems(){return this._getAdded(this.items,this.originalItems)},getRemovedItems(){return this._getRemoved(this.items,this.originalItems,n.States.DELETED)},getChangedItems(){return this._getChanged(this.items,this.originalItems)},getAddedPhases(){return this._getAdded(this.phases,this.originalPhases)},getRemovedPhases(){return this._getRemoved(this.phases,this.originalPhases,r.States.DELETED)},getChangedPhases(){return this._getChanged(this.phases,this.originalPhases)},getItemOperation(e,t){let s,a,r;if(this.originalItems.get(e)?this.items.get(e)||e.isNew()?e.getState()===n.States.DELETED||!e.hasPendingChanges()&&t===e.getState()||(s=i.Operations.modify,a=`/cart-items/${e.get("id")}`,r=e.getPendingChanges(),t&&t!==e.getState()&&(r[n.Fields.STATE]=t)):(s=i.Operations.remove,a=`/cart-items/${e.get("id")}`,r={}):(s=i.Operations.add,a="/cart-items",r=e.omit(),t&&t!==e.getState()&&(r[n.Fields.STATE]=t)),s&&(Object.keys(r).length>0||s===i.Operations.remove))return new i(s,a,r)},getPhaseOperation(e,t){let s,a,o;if(this.originalPhases.get(e))e.getState()===r.States.DELETED||!e.hasPendingChanges()&&t===e.getState()||(s=i.Operations.modify,a=`/phases/${e.get("id")}`,o=e.getPendingChanges(),t&&t!==e.getState()&&(o[n.Fields.STATE]=t));else{s=i.Operations.add,a="/phases",o=e.omit(["name",r.Fields.STATE]);const c=1===e.getPhaseNumber();t&&t!==e.getState()&&!c&&(o[n.Fields.STATE]=t)}if(s&&(Object.keys(o).length>0||s===i.Operations.remove))return new i(s,a,o)},reset(){this.cart.clearPendingChanges(),this.originalItems=this.items.clone(),this.originalPhases=this.phases&&this.phases.clone(),this.items.forEach(e=>e.clearPendingChanges()),this.phases&&this.phases.forEach(e=>e.clearPendingChanges())},destroy(){this.stopListening(),this.cart=null,this.items=null,this.originalItems=null,this.phases=null,this.originalPhases=null},_getAdded(e,t){const s=[];return e.forEach(e=>{t.get(e)||s.push(e)}),s},_getRemoved(e,t,s){const i=[];return t.forEach(t=>{t.getState()!==s&&(e.get(t)||t.isNew())||i.push(t)}),i},_getChanged(e,t){const s=[];return e.forEach(e=>{t.get(e)&&e.hasPendingChanges()&&s.push(e)}),s},_dispatchChange(){this.dispatchEvent(o.ON_CHANGE)}});return h.Events=o,h}),define("DS/MPFBiddingNewMessage/BiddingMessageContentV2",["UWA/Class/View","DS/UIKIT/Input/Text","DS/MPFString/MPFString","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i){"use strict";const a=Object.freeze({ON_CHANGE:"onChange"}),n=e.extend({className:"mpf-bidding-message-content-v2",setup({message:e,isBuyerView:t=!1}={}){this.isBuyerView=t,this.textInput=this._createTextInput(e)},render(){return this.container.setContent([this.textInput]),this.showValidity(!0),this},setMessage(e){this.textInput.setValue(e)},getMessage(){return this.textInput.getValue().trim()},clear(){this.setMessage("")},showValidity(e){this.container.toggleClassName("mpf-invalid",!e)},_deleteUnauthorizedCharacters(e){const t=new s(e).hideEmailAddresses().escapeHTML();return t.wasEmailReplaced()?t.toString()+"\n\n"+i.get("inappropriateContent"):t.toString()},_createTextInput(e){return new t({placeholder:i.get("typeMessage"),rows:4,multiline:!0,value:e||"",events:{onChange:this.dispatchEvent.bind(this,a.ON_CHANGE)}})}});return n.Events=a,n}),define("DS/MPFBiddingNewMessage/BiddingAddress",["UWA/Core","UWA/String","UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFPersonModel/PersonModel","DS/MPFAddressModel/AddressCollection","DS/MPFBuyerAddressComponent/BuyerAddressBook","DS/MPFFiniteStateMachine/FiniteStateMachine","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P){"use strict";const S=Object.freeze({PICK_UP:"pickUp",SHIPPING_NO_ADDRESS:"shippingNoAddress",SHIPPING_ADDRESS_SELECTED:"shippingAddressSelected"});return s.extend({className:"mpf-bidding-address",setup:function(e){e||(e={}),this._checkPrototypes(e),this.buyerType=e.buyerType,this.addresses=e.addresses,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.me=e.me,this.company=e.company,this.cart=e.cart,this.countries=e.countries,this.buyerAddressBook=this._initBuyerAddressBook(),this.addAddressButton=this._createButton(P.get("addAddress")),this.changeAddressButton=this._createButton(P.get("changeAddress")),this.stateMachine=this._createStateMachine(),this.listenTo(this.buyerAddressBook,"onSelected",this._addressSelected.bind(this))},render:function(){const e=this.stateMachine.getState();return e===S.SHIPPING_NO_ADDRESS?this.container.setContent([this.addAddressButton,this.buyerAddressBook.render()]):e===S.SHIPPING_ADDRESS_SELECTED?this._displayAddressLabel():this.container.setContent(""),this},manageAddressChoices:function(t){t?e.is(this.getSelectedAddress())?this.stateMachine.changeState(S.SHIPPING_ADDRESS_SELECTED):this.stateMachine.changeState(S.SHIPPING_NO_ADDRESS):this.stateMachine.changeState(S.PICK_UP),this.render()},getSelectedAddress:function(){return this.buyerAddressBook.getSelectedAddress()||this.cart.getShippingAddress()},_initBuyerAddressBook:function(){return new m({model:this.addresses,me:this.me,buyer:this.buyerType===n.COMPANY?this.company:this.me,addressFactory:this.addressFactory,companyFactory:this.companyFactory,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,countries:this.countries})},_createButton:function(e){const t=this;return new i({className:"link",value:e,events:{onClick:function(){t.buyerAddressBook.show()}}})},_addressSelected:function(e){e.ok&&(this.stateMachine.changeState(S.SHIPPING_ADDRESS_SELECTED),this.render())},_displayAddressLabel:function(){const t=e.createElement("div",{class:"mpf-bidding-address-selected",html:[e.createElement("span",{text:P.get("shipTo")}),this._getAddressTitle(this.getSelectedAddress()),this.cart.getState()===r.States.DRAFT&&this.changeAddressButton]});this.container.setContent([t,this.buyerAddressBook.render()])},_getAddressTitle:function(e){let s="";return["addressLine1","addressLine2","addressLine3","addressLine4","city","county","state","postalCode","country"].map(function(t){return e.get(t)}).filter(function(e){return e&&e.length>0}).map(function(e){return s=s+" "+e+","}),t.truncate(s,s.length-1,"")},_createStateMachine:function(){return new g({state:this.getSelectedAddress()?S.SHIPPING_ADDRESS_SELECTED:S.SHIPPING_NO_ADDRESS,states:[S.PICK_UP,S.SHIPPING_NO_ADDRESS,S.SHIPPING_ADDRESS_SELECTED],transitions:[{from:S.PICK_UP,to:S.SHIPPING_NO_ADDRESS},{from:S.PICK_UP,to:S.SHIPPING_ADDRESS_SELECTED},{from:S.SHIPPING_NO_ADDRESS,to:S.PICK_UP},{from:S.SHIPPING_NO_ADDRESS,to:S.SHIPPING_ADDRESS_SELECTED},{from:S.SHIPPING_ADDRESS_SELECTED,to:S.PICK_UP}]})},_checkPrototypes:function(e){a.requiredOfPrototype(e.me,u,"options.me must be a PersonModel"),a.requiredOfPrototype(e.cart,r,"options.cart must be a CartModel"),a.requiredOfPrototype(e.companyFactory,h,"options.companyFactory must be a CompanyFactory"),a.requiredOfPrototype(e.addressFactory,d,"options.addressFactory must be an AddressFactory"),a.requiredOfPrototype(e.cartItemFactory,c,"options.cartItemFactory must be a CartItemFactory"),a.requiredOfPrototype(e.cartFactory,o,"options.cartFactory must be a CartFactory"),a.requiredOfPrototype(e.addresses,p,"options.addresses must be an AddressCollection"),this.buyerType===n.COMPANY&&a.requiredOfPrototype(e.company,l,"options.company must be a CompanyModel")}})}),define("DS/MPFBiddingNewMessage/BiddingCartHelper",["DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel"],function(e,t,s){"use strict";return{getSubmittedStateCartOperation:function(s,i,a){const n={currentState:t.States.SUBMITTED,ShopID:s};return i&&(n.ShipTo=a),new e(e.Operations.modify,"/",n)},getDeliveryRequestItemOperation:function(t,i,a){return new e(e.Operations.add,"/cart-items/",{"@type":"MP_DeliveryServiceRequest",CartID:t,currentState:s.STATUS.submitted,Quantity:1,ShopID:a,DeliveryServiceName:i?"Shipping":"Pickup"})},getModifyCartItemAttributesOperation:function(t){return new e(e.Operations.modify,"/cart-items/"+t.get("id"),t.getPendingChanges())},getSubmittedStateCartItemOperation:function(t){if(t.hasPendingChanges()){const i=t.getPendingChanges();return i.currentState=s.STATUS.submitted,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)}return new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.submitted})},getDeliveredStateCartItemOperation:function(t){if(t.hasPendingChanges()){const i=t.getPendingChanges();return i.currentState=s.STATUS.delivered,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)}return new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.delivered})},getReadyStateCartItemOperation:function(t){if(t.hasPendingChanges()){const i=t.getPendingChanges();return i.currentState=s.STATUS.ready,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)}return new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.ready})},getShippedStateCartItemOperation:function(t){if(t.hasPendingChanges()){const i=t.getPendingChanges();return i.currentState=s.STATUS.shipped,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)}return new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.shipped})},getProcessingStateCartItemOperation:function(t){if(t.hasPendingChanges()){const i=t.getPendingChanges();return i.currentState=s.STATUS.processing,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)}return new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.processing})},getAcceptedStateCartItemOperation:function(t){if(t.hasPendingChanges()){const i=t.getPendingChanges();return i.currentState=s.STATUS.accepted,new e(e.Operations.modify,"/cart-items/"+t.get("id"),i)}return new e(e.Operations.modify,"/cart-items/"+t.get("id"),{currentState:s.STATUS.accepted})},getAddContractOperation:function(t,s,i){return new e(e.Operations.add,"/contracts",{ContractID:t,CartItemID:s,documentType:i})},getCancelRequestOperation:function(){return new e(e.Operations.modify,"/",{currentState:t.States.CANCELLED})},getAddBiddingDocOperation:function(t,s){return new e(e.Operations.add,"/bidding-documents",{CartItemID:t,DocumentID:s})},getAddMessageOperation:function(t,s,i,a){return new e(e.Operations.add,"/message",{author:t?"mdpeoplecompany/people/"+a.getOwnerId():"/mdshop/shops/"+a.getShopID(),documentIDs:s,message:i})}}}),define("DS/MPFBiddingNewMessage/SendMessageHandler",["UWA/Class/Listener","UWA/Class/Events","DS/PlatformAPI/PlatformAPI","DS/MPFAmdLazyLoader/AmdLazyLoader","DS/MPFString/MPFString","DS/MPFServices/ObjectService","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartCancelReasonCompiler","DS/MPFTCContractModel/TCContractFactory","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C){"use strict";const y=new Map;y.set(P.SEND_REQUEST,c.States.SUBMITTED),y.set(P.CANCEL,c.States.CANCELLED),y.set(P.SEND_TENDER_QUOTE,c.States.SUBMITTED),y.set(P.CONFIRM_PAID_CART_MODIF,c.States.BUYER_ACCEPT),y.set(P.CONFIRM_PAID_CART_AND_PAY,c.States.BUYER_ACCEPT),y.set(P.NOTIFY_WORK_STARTED,c.States.PROCESSING),y.set(P.NOTIFY_READY,c.States.PROCESSED),y.set(P.CONFIRM_DELIVERY,c.States.DELIVERED);const D=new Map;D.set(P.SEND_REQUEST,h.States.SUBMITTED),D.set(P.SEND_QUOTE,h.States.ACCEPTED),D.set(P.ACCEPT,h.States.ACCEPTED),D.set(P.SEND_TENDER_QUOTE,h.States.ACCEPTED),D.set(P.UPDATE_AND_ACCEPT,h.States.ACCEPTED),D.set(P.BUYER_UPDATE,h.States.SUBMITTED),D.set(P.CONFIRM_EMP_ORDER,h.States.PENDING_PROCESSING),D.set(P.NOTIFY_WORK_STARTED,h.States.PROCESSING),D.set(P.NOTIFY_READY,h.States.READY),D.set(P.NOTIFY_SHIPPING,h.States.SHIPPED),D.set(P.CONFIRM_DELIVERY,h.States.DELIVERED);const E=new Map;E.set(P.ACCEPT_PHASE,l.States.ACCEPTED),E.set(P.NOTIFY_PHASE_WORK_STARTED,l.States.PROCESSING),E.set(P.NOTIFY_PHASE_DELIVERY,l.States.READY),E.set(P.ACCEPT_PHASE_DELIVERY,l.States.DELIVERED),E.set(P.CANCEL_PHASE,l.States.DELETED);const M=Object.freeze({ON_PAYMENT_DONE:"onPaymentDone",UPLOAD_PO_LATER:"uploadPoLater"});class T extends t{constructor(t){super(),n.requiredOfPrototype(t.me,o,"options.me must be a PersonModel"),n.requiredOfPrototype(t.cart,c,"options.cart must be a CartModel"),n.requiredOfPrototype(t.cartItems,d,"options.cartItems must be a CartItemCollection"),n.requiredOfPrototype(t.tcContractFactory,g,"options.tcContractFactory must be a TCContractFactory"),this.me=t.me,this.cart=t.cart,this.cartItems=t.cartItems,this.cartPhases=t.cartPhases,this.shop=t.shop,this.company=t.company,this.tcContractFactory=t.tcContractFactory,this.activePhasePayment=t.activePhasePayment,this.isBuyerView=t.isBuyerView,this.validateSend=t.validateSend,this.cartPatchOpFactory=t.cartPatchOpFactory,this.service=t.service,this.locale=t.locale,this.cartChangeTracker=t.cartChangeTracker,this.listener=new e}async validateAction({action:e}){return("function"==typeof this.validateSend?await this.validateSend({action:e,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases}):null)||{isValid:!0}}async validateMessage({text:e,files:t}){const s="function"==typeof this.validateSend?await this.validateSend({action:P.SEND_MESSAGE,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases}):null,i=t&&t.length>0;return s||{isValid:!!e||i}}async sendRequest({text:e,files:t}){const{nda:s,otherFiles:i}=this._sortFiles(t);let a;s&&this.isBuyerView&&(a=await this._saveNda(s));const n=P.SEND_REQUEST,r=this.getDocsAndMessageOperations({text:e,ndaContract:a,otherFiles:i,action:n});this._hasCartPhases()?r.addAll(this._getCartPhaseOperations({action:n})):(r.add(this._getCartOperation({action:n})),r.addAll(this._getCartItemOperations({action:n}))),await this.cart.megaPatch(r),this._publishUpdateEvents()}async sendMessage({text:e,files:t}){const{nda:s,salesConditions:i,otherFiles:a}=this._sortFiles(t);let n,r;s&&this.isBuyerView?n=await this._saveNda(s):i&&!this.isBuyerView&&(r=await this._saveSalesConditions(i));const o=this.getDocsAndMessageOperations({text:e,ndaContract:n,salesConditionsContract:r,otherFiles:a,action:P.SEND_MESSAGE});await this.cart.megaPatch(o),this._publishUpdateEvents()}async doAction({action:e}){const t=new u;if(this._hasCartPhases()?t.addAll(this._getCartPhaseOperations({action:e})):(t.add(this._getCartOperation({action:e})),t.addAll(this._getCartItemOperations({action:e}))),e!==P.PAY){let e;e=this.me.isDSOperator()?"/mdpeople/people/"+this.me.get("id"):this.isBuyerView?"/mdpeoplecompany/people/"+this.cart.getOwnerId():"/mdshop/shops/"+this.cart.getShopID(),t.add(new p(p.Operations.add,"/message",{author:e,documentIDs:[],message:""}))}"function"==typeof this.cartPatchOpFactory&&t.addAll(this.cartPatchOpFactory({action:e,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases})),t.length()>0&&await this.cart.megaPatch(t),this._hasCartPhases()&&await this._refreshPhasesAndPayment(),e!==P.PAY&&e!==P.CONFIRM_PAID_CART_AND_PAY||await this._launchCheckout(),this._publishUpdateEvents()}async cancel({action:e=P.CANCEL,reason:t,message:s}){s=m.addReasonToText(t,s);const i=this.getDocsAndMessageOperations({text:s,action:e});if(e===P.CANCEL_PHASE){const e=this.cartPhases.getActivePhase();await e.updateState(l.States.DELETED)}else i.add(this._getCartOperation({action:e}));await this.cart.megaPatch(i),this._publishUpdateEvents()}getDocsAndMessageOperations({text:e,ndaContract:t,salesConditionsContract:s,otherFiles:i=[],action:a}){const n=new u,r=this._getRequestFromCartItems().get("id");if(e=this._deleteUnauthorizedCharacters(e),t||s){let i,a;t?(e+="\n\n"+C.get("ndaAdded"),i="nda",a=t.get("id")):s&&(e+="\n\n"+C.get("specificSalesConditionAdded"),i="custom-tc-seller",a=s.get("id")),n.add(new p(p.Operations.add,"/contracts",{ContractID:a,CartItemID:r,documentType:i}))}const o=[];if(i.forEach(e=>{o.push(e.docID),n.add(new p(p.Operations.add,"/bidding-documents",{CartItemID:r,DocumentID:e.docID}))}),"function"==typeof this.cartPatchOpFactory){const e=this.cartPatchOpFactory({action:a,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases});Array.isArray(e)&&(e.filter(e=>"/bidding-documents"===e.path).map(e=>e.value.DocumentID).forEach(e=>{o.push(e)}),n.addAll(e))}if(e||i){let t;t=this.me.isDSOperator()?"/mdpeople/people/"+this.me.get("id"):this.isBuyerView?"/mdpeoplecompany/people/"+this.cart.getOwnerId():"/mdshop/shops/"+this.cart.getShopID(),n.add(new p(p.Operations.add,"/message",{author:t,documentIDs:o,message:e}))}return n}destroy(){this.listener.stopListening(),this.me=null,this.cart=null,this.cartItems=null,this.cartPhases=null,this.shop=null,this.company=null,this.tcContractFactory=null,this.activePhasePayment=null,this.validateSend=null,this.cartPatchOpFactory=null,this.cartChangeTracker=null}async _saveNda(e){return this.tcContractFactory.createModel(g.Types.EXISTING_DOCUMENT,{consumerID:this.shop.getOwner(),documentID:e.docID,supplierID:this.buyerType===r.COMPANY?this.company.get("id"):this.me.get("id")}).savePromise()}async _saveSalesConditions(e){return this.tcContractFactory.createModel(g.Types.EXISTING_DOCUMENT,{consumerID:this.cart.getOwnerId(),documentID:e.docID,supplierID:this.me.getCompanyId()}).savePromise()}async _launchCheckout(){return this.cartPhases&&this.cartPhases.size()>=0?this._launchCheckoutV2():this._launchCheckoutV1()}async _launchCheckoutV1(){const[e]=await i.getInstance().get(["DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory"]),t=new e({serviceRequest:this.service,idCart:this.cart.get("id"),linkToBankTransferFAQ:this.linkToBankTransferFAQ,locale:this.locale});await t.whenReady(),this.listener.listenTo(t,{[e.Events.PAYMENT_COMPLETED]:this._onPaymentDone.bind(this,{wasPaymentSuccessful:!0}),[e.Events.PURCHASE_ORDER_UPLOADED]:this._onPaymentDone.bind(this),[e.Events.UPLOAD_PO_LATER]:this._onPaymentDone.bind(this,{eventName:M.UPLOAD_PO_LATER}),[e.Events.PAYMENT_DECLINED]:this._onPaymentDone.bind(this,{wasPaymentSuccessful:!1})}),t.show()}async _launchCheckoutV2(){const[e,t]=await i.getInstance().get(["DS/MPFCheckout/CheckoutV2Factory","DS/MPFCheckout/CheckoutV2"]),s=await e.from({service:this.service,cartId:this.cart.get("id"),locale:this.locale});this.listener.listenTo(s,t.Events.PAYMENT_DONE,this._onPaymentDone.bind(this)),s.inject(document.body).render().show()}
//! Only for test purposes, the real checkout page has to be integrated by the service on a dedicated page
async _launchCheckoutPage(){const[e,t]=await i.getInstance().get(["DS/MPFCheckoutPage/CheckoutPageFactory","DS/MPFCheckoutPage/CheckoutPage"]),s=await e.createComponent({cartId:this.cart.get("id"),service:this.service});this.listener.listenTo(s,t.Events.PAYMENT_DONE,this._onPaymentDone.bind(this)),s.inject(document.querySelector(".order-bidding.mp-container")).render()}_onPaymentDone({wasPaymentSuccessful:e,eventName:t}={}){this._publishUpdateEvents(),this.dispatchEvent(t||M.ON_PAYMENT_DONE,{wasPaymentSuccessful:e})}_getCartPhaseOperations({action:e}){const t=[],s=E.get(e);return this.cartPhases.forEach(e=>{const i=this.cartChangeTracker.getPhaseOperation(e,s);i&&t.push(i)}),this.cartChangeTracker.getRemovedPhases().forEach(e=>{t.push(new p(p.Operations.remove,`/phases/${e.get("id")}`))}),t}_getCartOperation({action:e}){const t=y.get(e),s=this.cartChangeTracker.getFilteredCartChanges();if(t||Object.keys(s).length>0)return new p(p.Operations.modify,"/",{...s,[c.Fields.STATE]:t})}_getCartItemOperations({action:e}){const t=[],s=D.get(e);return this.cartItems.forEach(e=>{const i=this.cartChangeTracker.getItemOperation(e,s);i&&t.push(i)}),this.cartChangeTracker.getRemovedItems().forEach(e=>{t.push(new p(p.Operations.remove,`/cart-items/${e.get("id")}`))}),t}async _refreshPhasesAndPayment(){await this.cartPhases.fetchPromise(),this.activePhasePayment.clear({silent:!0});const e=this.cartPhases.getActivePhase();if(e)return this.activePhasePayment.setParentResourceId(e.get("id")),this.activePhasePayment.fetchPromise()}_publishUpdateEvents(){s.publish("MPCartTimeline",{event:"refresh",cartId:this.cart.id}),s.publish("MPFDeferredPaymentNotices",{event:"update"})}_sortFiles(e){let t,s;const i=[];for(let a=0;a<e.length;a++){const n=e[a];n.docType===S.DocTypes.NDA?t=n:n.docType===S.DocTypes.SALES_CONDITIONS?s=n:i.push(n)}return{nda:t,salesConditions:s,otherFiles:i}}_deleteUnauthorizedCharacters(e){const t=new a(e).hideEmailAddresses().escapeHTML();return t.wasEmailReplaced()?t.toString()+"\n\n"+C.get("inappropriateContent"):t.toString()}_hasCartPhases(){return this.cartPhases&&this.cartPhases.size()>0}_getRequestFromCartItems(){return this.cartItems.getRequestItemForService(this.service)}}return T.Events=M,T}),define("DS/MPFBiddingNewMessage/BiddingMessageFileList",["UWA/Class/View","DS/UIKIT/Badge","DS/MPFServices/ObjectService","DS/MPFBiddingNewMessage/BiddingUploadFileComponent"],function(e,t,s,i){"use strict";const a=Object.freeze({}),n=e.extend({className:"mpf-bidding-message-file-list",setup({isBuyerView:e,files:t=[]}={}){this.isBuyerView=e,this.files=t},render(){return this.container.setContent([this.files.map(e=>this._createBadge(e))]),this},addDocument(e){e.docType!==i.DocTypes.NDA&&e.docType!==i.DocTypes.SALES_CONDITIONS||this._deleteDocOfSameType(e),this.files.push(e),this.render()},getUploadedFiles(){return this.files},getSpecificDocuments(){return this.isBuyerView?this.files.filter(function(e){return e.docType===i.DocTypes.NDA}):this.files.filter(function(e){return e.docType===i.DocTypes.SALES_CONDITIONS})},clear(){this.files=[]},destroy(){this.files=null,this._parent(),this.container=null},_deleteFileWithName(e){this.files=this.files.filter(function(t){return t.docName!==e})},_deleteDocOfSameType(e){for(let t=this.files.length-1;t>=0;t--)this.files[t].docType===e.docType&&this.files.splice(t,1)},_createBadge(e){const s=this;return new t({closable:!0,content:e.docName,icon:"doc",events:{onClose:function(){s._deleteFileWithName(e.docName),this.destroy()}}})}});return n.Events=a,n}),define("DS/MPFBiddingNewMessage/biddingOptions/InnovateBiddingOptions",["DS/MPFBiddingNewMessage/BiddingActions","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i){"use strict";const a=Object.freeze({EDIT:"edit",SELECT_TENANT:"selectTenant"});class n{constructor({cart:e,cartPhases:t,isBuyerView:s}){this.cart=e,this.cartPhases=t,this.isBuyerView=s,this._isEditing=!1}getOptions(){const e=this.cart.getState(),s=this.cartPhases.getActivePhase(),i=s&&s.getState();return e===t.States.CANCELLED||e===t.States.DELIVERED?[]:this.isBuyerView?this.getBuyerOptions({cartState:e,activePhase:s,activePhaseState:i}):this.getSellerOptions({cartState:e,activePhase:s,activePhaseState:i})}getBuyerOptions({activePhase:t,activePhaseState:a}){if(0===this.cartPhases.size())return[{action:e.CANCEL,label:i.get("cancelRequest"),className:"default",icon:"wrong"}];const n=1===this.cartPhases.size(),r=t&&t.getNumber();switch(a){case s.States.SUBMITTED:return[this._getCancelPhaseOption({hasOnePhase:n,number:r})];case s.States.ACCEPTED:return this.cart.getOnlineInstance()||"BE"!==t.get(s.Fields.ITEM_TYPE)?[{action:e.PAY,className:"primary",label:n?i.get("confirmAndPay"):i.get("confirmAndPayPhase",{number:r}),icon:"credit-card"},this._getCancelPhaseOption({hasOnePhase:n,number:r})]:[{action:this.toTenantSelection.bind(this),className:"primary",label:i.get("selectPlatform"),icon:"check"},this._getCancelPhaseOption({hasOnePhase:n,number:r})];case s.States.READY:return t.get(s.Fields.OFFER_ID)?[{action:e.ACCEPT_PHASE_DELIVERY,className:"primary",label:i.get("deploy"),icon:"check"}]:[];default:return[]}}getSellerOptions({activePhase:t,activePhaseState:a}){if(0===this.cartPhases.size())return this._isEditing?[{action:e.SEND_QUOTE,label:i.get("sendQuote"),className:"primary",icon:"send",isDisabled:!this._canSendQuote()},{action:e.CANCEL,label:i.get("rejectRequest"),className:"default",icon:"wrong"}]:[{action:this.toEditMode.bind(this),label:i.get("createQuote"),className:"primary",icon:"check",isDisabled:this._isEditing},{action:e.CANCEL,label:i.get("rejectRequest"),className:"default",icon:"wrong"}];const n=1===this.cartPhases.size(),r=t&&t.getNumber();switch(a){case s.States.SUBMITTED:return t.isNew()?[{action:e.SEND_QUOTE,label:i.get("sendQuote"),className:"primary",icon:"send",isDisabled:!this._canSendQuote()},{action:e.CANCEL,label:i.get("rejectRequest"),className:"default",icon:"wrong"}]:[{action:e.ACCEPT_PHASE,label:n?i.get("accept"):i.get("sendPhaseQuote",{number:r}),className:"primary",icon:"check",isDisabled:this._isEditing},this._getCancelPhaseOption({hasOnePhase:n,number:r})];case s.States.ACCEPTED:return[this._getCancelPhaseOption({hasOnePhase:n,number:r})];case s.States.PENDING_PROCESSING:return[{action:e.NOTIFY_PHASE_WORK_STARTED,label:n?i.get("notifyWorkStarted"):i.get("notifyPhaseWorkStarted",{number:r}),className:"primary",icon:"play"}];case s.States.PROCESSING:return[{action:e.NOTIFY_PHASE_DELIVERY,label:n?i.get("notifyReadiness"):i.get("notifyPhaseDelivery",{number:r}),className:"primary",icon:"truck-delivery"}];default:return[]}}toTenantSelection(){return a.SELECT_TENANT}toEditMode(){return this._isEditing=!0,a.EDIT}_getCancelPhaseOption({hasOnePhase:t,number:s}){return{action:e.CANCEL_PHASE,label:t?i.get("cancelRequest"):i.get("cancelPhase",{number:s}),className:"default",icon:"wrong"}}_canSendQuote(){let e=!0;if(0===this.cartPhases.size())e=!1;else{const t=this.cartPhases.size();for(let s=0;s<t;s++){const t=this.cartPhases.at(s);if(!t.getDescription()||!t.getStartDate()||!t.getEndDate()){e=!1;break}}}return e}}return n.ExternalActions=a,n}),define("DS/MPFBiddingNewMessage/biddingOptions/MakeBiddingOptionsHandler",["DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFServices/MarketplaceServices","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a){"use strict";return class{constructor({cart:e,cartItems:t,cartChangeTracker:s,isBuyerView:i,isEmp:a=!1}){this.cart=e,this.cartItems=t,this.cartChangeTracker=s,this.isBuyerView=i,this.isEmp=a}getOptions(){const e=this.getRedButtonOption(),t=this.getGreenButtonOption(),s=[];return e&&s.push({className:"error",...e}),t&&s.push({className:"success",...t}),s}getRedButtonOption(){const i=this.cart.getState(),n=this._findFirstRequestCartItem(this.cartItems).getState(),r=i===e.States.SUBMITTED,o=n===t.States.SUBMITTED,c=this.isEmp&&i===e.States.SUBMITTED&&n===t.States.PENDING_PROCESSING,h=i===e.States.PAYMENT_COMPLETE&&this.cart.isDirectPurchase();if(r&&!c||o||h)return{action:s.CANCEL,label:this.isBuyerView?a.get("cancelRequest"):a.get("rejectRequest")}}getGreenButtonOption(){const i=this._findFirstRequestCartItem(this.cartItems),n=this.cart.getState(),r=i.getState(),o=this.cartChangeTracker.hasPendingChanges(),c=this.cart.get("DirectPurchaseAuthorizationPrice"),h=c&&parseFloat(c)>0;if(this.isBuyerView){if(!this.cart.isBlocked())switch(n){case e.States.SUBMITTED:if(o)return{action:s.BUYER_UPDATE,label:a.get("updateRequest")};if(r===t.States.ACCEPTED)return this.isEmp?{action:s.CONFIRM_EMP_ORDER,label:a.get("accept")}:{action:s.PAY,label:a.get("confirmAndPay")};break;case e.States.PAYMENT_COMPLETE:if(this.cart.isDirectPurchase()){if(o)return{action:s.BUYER_UPDATE,label:a.get("updateRequest")};if(this.cart.getGlobalState()===e.GlobalStates.WAITING_PAYMENT&&h)return this._doesCartNeedNewPayment()?{action:s.CONFIRM_PAID_CART_AND_PAY,label:a.get("confirmAndPay")}:{action:s.CONFIRM_PAID_CART_MODIF,label:a.get("confirm")}}break;case e.States.PROCESSING:if(r===t.States.SHIPPED)return{action:s.CONFIRM_DELIVERY,label:a.get("confirmDelivery")}}}else switch(n){case e.States.SELLER_DRAFT:if(r===t.States.SUBMITTED&&this._canBeAccepted())return{action:s.SEND_TENDER_QUOTE,label:a.get("sendQuote")};break;case e.States.SUBMITTED:switch(r){case t.States.SUBMITTED:if(this._canBeAccepted())return{action:s.SEND_QUOTE,label:a.get("sendQuote")};break;case t.States.ACCEPTED:if(this._canBeAccepted()&&o)return{action:s.UPDATE,label:a.get("updateRequest")};break;case t.States.PENDING_PROCESSING:if(this.isEmp)return{action:s.NOTIFY_WORK_STARTED,label:a.get("startProcessing")}}break;case e.States.PAYMENT_COMPLETE:if(this.cart.isDirectPurchase()&&r===t.States.SUBMITTED){if(this._canBeAccepted())return o?{action:s.UPDATE_AND_ACCEPT,label:a.get("updateAndAccept")}:{action:s.ACCEPT,label:a.get("acceptRequest")}}else if(r===t.States.ACCEPTED&&o&&this._canBeAccepted())return{action:s.UPDATE,label:a.get("updateRequest")};break;case e.States.PAYMENT_ACCEPTED:if(t.States.PENDING_PROCESSING)return{action:s.NOTIFY_WORK_STARTED,label:a.get("startProcessing")};break;case e.States.PROCESSING:if(r===t.States.PROCESSING)return{action:s.NOTIFY_SHIPPING,label:a.get("notifyShipping")}}}_findFirstRequestCartItem(e){return e.getRequestItemForService(i.MAKE)}_doesCartNeedNewPayment(){const e=this.cart.get("DirectPurchaseAuthorizationPrice"),t=e&&parseFloat(e);return t&&t<parseFloat(this.cart.getGrossAmountTotal())}static getOptions({isBuyerView:t,cart:s,cartItem:i}){const a=i.getState(),n=s.isDirectPurchase(),r=s.hasPendingChanges()||i.hasPendingChanges(),o=!s.get(e.Fields.SHIP_TO),c={cart:s,isDirectPurchase:n,hasCartOrItemChanged:r,cartItemState:a,isOrderPickedUp:o};return(t?this._getBuyerOptions(c):this._getSellerOptions(c))||[]}static _getBuyerOptions({cart:i,hasCartOrItemChanged:n,cartItemState:r}){switch(i.getState()){case e.States.SUBMITTED:switch(r){case t.States.SUBMITTED:return[{value:n?s.UPDATE:s.SEND_MESSAGE,text:n?a.get("update"):a.get("askForInformation"),icon:n?"doc-update":"question-circle"},{value:s.CANCEL,text:a.get("cancelRequest"),icon:"close"}];case t.States.ACCEPTED:return[{value:s.PAY,text:a.get("confirmAndPay"),icon:"credit-card"},{value:s.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:a.get("cancelRequest"),icon:"close"}]}break;case e.States.PAYMENT_COMPLETE:switch(r){case t.States.SUBMITTED:return[{value:s.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:a.get("cancelRequest"),icon:"close"}]}break;case e.States.PROCESSING:switch(r){case t.States.SHIPPED:return[{value:s.CONFIRM_DELIVERY,text:a.get("confirmDelivery"),icon:"check"},{value:s.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"}]}}}static _getSellerOptions({cart:i,isDirectPurchase:n,hasCartOrItemChanged:r,cartItemState:o,isOrderPickedUp:c}){switch(i.getState()){case e.States.SUBMITTED:switch(o){case t.States.SUBMITTED:{const e=[{value:r?s.UPDATE:s.SEND_MESSAGE,text:r?a.get("update"):a.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:a.get("rejectRequest"),icon:"close"}];return this._canAcceptRequest(i)&&e.unshift({value:r?s.UPDATE_AND_ACCEPT:s.ACCEPT,text:r?a.get("updateAndAccept"):a.get("acceptRequest"),icon:"check"}),e}case t.States.ACCEPTED:return[{value:r?s.UPDATE:s.SEND_MESSAGE,text:r?a.get("update"):a.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:a.get("rejectRequest"),icon:"close"}]}break;case e.States.PAYMENT_ACCEPTED:switch(o){case t.States.PENDING_PROCESSING:return[{value:s.NOTIFY_WORK_STARTED,text:a.get("workStarted"),icon:"play"},{value:s.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"}]}break;case e.States.PAYMENT_COMPLETE:switch(o){case t.States.SUBMITTED:{const e=[{value:s.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:s.CANCEL,text:a.get("rejectRequest"),icon:"close"}];return this._canAcceptRequest(i)&&e.unshift({value:s.ACCEPT,text:a.get("acceptRequest"),icon:"check"}),e}}break;case e.States.PROCESSING:switch(o){case t.States.PROCESSING:return[{value:c?s.NOTIFY_READY:s.NOTIFY_SHIPPING,text:c?a.get("notifyReadiness"):a.get("notifyShipping"),icon:c?"parcel-ok":"trolley"},{value:s.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"}]}}}_canBeAccepted(){const e=this.cartItems.toArray();let s;for(s=0;s<e.length;s++)if(e[s].getState()!==t.States.DELETED){const i=parseFloat(e[s].getUnitNetAmount());if("MP_QuoteRequest"!==e[s].getType()&&(isNaN(i)||i<0))return!1;if(e[s].getType()===t.Types.MAKE_REQUEST&&!(e[s].get("ProcessFamily")&&e[s].get("Process")&&e[s].get("MaterialCategory")&&e[s].get("MaterialSubCategory")&&e[s].get("MaterialType")&&e[s].get("MaterialID")))return!1}return!0}static _canAcceptRequest(e){const t=e.getGrossAmountTotal();return t&&t>=0}}}),define("DS/MPFBiddingNewMessage/BiddingMessageComponent",["UWA/Class/View","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBiddingNewMessage/SendMessageHandler","DS/MPFBiddingNewMessage/BiddingMessageContentV2","DS/MPFBiddingNewMessage/BiddingMessageFileList","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h){"use strict";const d=Object.freeze({START_SENDING:"startSending",MESSAGE_SENDED:"messageSended",ON_ERROR:"onError"}),l=e.extend({className:"mpf-bidding-message-component",setup({service:e,isBuyerView:t,sendMessageHandler:s,slot1:i,slot2:r,slot3:o,message:c,files:h,maskOnLoad:d=!0,...l}={}){a.requiredOfType(e,"string","options.service must be a string (see DS/MPFServices/MarketplaceServices)"),a.requiredOfType(t,"boolean","options.isBuyerView must be a boolean"),a.requiredOfPrototype(s,n,"options.sendMessageHandler must be a SendMessageHandler"),this.sendMessageHandler=s,this.slot1=i,this.slot2=r,this.slot3=o,this.maskOnLoad=d,this.alert=this._createAlert(),this.messageInput=this._createMessageInput({service:e,message:c}),this.fileList=this._createFileList({files:h,isBuyerView:t}),this.uploadFileComponent=this._createUploadFileComponent({service:e,isBuyerView:t,...l})},render(){return this.container.setContent([this.alert,{tag:"div",class:"mpf-message-and-files",html:[this.messageInput.render(),this.slot3,this.fileList.render()]},{tag:"div",class:"mpf-bidding-buttons",html:[{tag:"div",class:"mpf-left-column",html:[this.slot1,this.uploadFileComponent.render()]},{tag:"div",class:"mpf-right-column",html:[this.slot2,new i({className:"primary mpf-send-button",value:h.get("sendMessage"),events:{onClick:()=>this._sendMessage()}})]}]}]),this},destroy(){this.stopListening(),this.alert.destroy(),this.messageInput.destroy(),this.fileList.destroy(),this.uploadFileComponent.destroy(),this.alert=null,this.messageInput=null,this.fileList=null,this.uploadFileComponent=null,this._parent(),this.container=null},async _sendMessage(){const e=this.messageInput.getMessage(),t=this.fileList.getUploadedFiles(),i=this.container.getElement(".mpf-message-and-files");if((await this.sendMessageHandler.validateMessage({text:e,files:t})).isValid){i.toggleClassName("mpf-invalid",!1),this.maskOnLoad&&s.mask(this.container),this.dispatchEvent(d.START_SENDING);try{await this.sendMessageHandler.sendMessage({text:e,files:t}),this.maskOnLoad&&s.unmask(this.container),this.messageInput.clear(),this.fileList.clear(),this.render(),this.dispatchEvent(d.MESSAGE_SENDED)}catch(e){this.maskOnLoad&&s.unmask(this.container),console.error(e),this.alert.add({className:"error",message:h.get("unableToSendMessage")}).show(),this.dispatchEvent(d.ON_ERROR)}}else i.toggleClassName("mpf-invalid",!0)},_createAlert:()=>new t({visible:!1,autoHide:!0,hideDelay:5e3}),_createMessageInput:({service:e,message:t})=>new r({service:e,message:t}),_createFileList:({files:e,isBuyerView:t})=>new o({files:e,isBuyerView:t}),_createUploadFileComponent({cart:e,cartItems:t,nda:s,tcDocumentFactory:i,isBuyerView:a,maxFileSize:n,maxSpecificFileSize:r,service:o}){const h=new c({buyerView:a,tcDocumentFactory:i,cart:e,cartItem:t.getRequestItemForService(o),maxFileSize:n,maxSpecificFileSize:r,nda:s,alwaysAllowDocUpload:!0});return this.listenTo(h,c.Events.DOCUMENT_SAVED,e=>{this.fileList.addDocument(e)}),this.listenTo(h,c.Events.DOCUMENT_NOT_SAVED,e=>{this.alert.add({className:"error",message:e}).show()}),h}});return l.Events=d,l}),define("DS/MPFBiddingNewMessage/biddingOptions/BuyerPhaseBiddingOptions",["UWA/Class","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n){"use strict";return e.extend({init:function(e){this.cart=e.cart,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment},getBiddingOptions:function(){let e;return(e=this.cart.getState()===t.States.CANCELLED?[]:this.cartPhases.isEmpty()?this.cart.getState()===t.States.DRAFT?[{value:a.SEND_REQUEST,text:n.get("sendForQuote")}]:[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"},{value:a.CANCEL,text:n.get("cancelRequest"),icon:"close"}]:this._getBuyerBiddingOptionsForPhases())||[]},_getBuyerBiddingOptionsForPhases:function(){let e,t;const i=this.cartPhases.getActivePhase();if(i)switch(t=i.getState()){case s.States.SUBMITTED:e=this._getBuyerBiddingOptionsForPhaseSubmitted(i);break;case s.States.ACCEPTED:e=this._getBuyerBiddingOptionsForPhaseAccepted(i);break;case s.States.READY:e=this._getBuyerBiddingOptionsForPhaseReady(i)}return e},_getBuyerBiddingOptionsForPhaseSubmitted:function(e){return[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"},{value:a.CANCEL_PHASE,text:n.get("cancelPhase",{number:e.getNumber()}),icon:"close"}]},_getBuyerBiddingOptionsForPhaseAccepted:function(e){let t,s,r;const o=[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"},{value:a.CANCEL_PHASE,text:n.get("cancelPhase",{number:e.getNumber()}),icon:"close"}];return this.activePhasePayment.isNew()||(t=this.activePhasePayment.getState(),s=this.activePhasePayment.getPaymentMethod()===i.PaymentMethods.BANK_CARD&&(t===i.States.PENDING_PAYMENT||t===i.States.PAYMENT_INITIATED),r=this.activePhasePayment.getPaymentMethod()===i.PaymentMethods.BANK_CARD&&t===i.States.PAYMENT_REFUSED,this.cart.isBlocked()||t!==i.States.DRAFT&&!s&&!r||o.unshift({value:a.PAY,text:n.get("confirmAndPayPhase",{number:e.getNumber()}),icon:"credit-card"})),o},_getBuyerBiddingOptionsForPhaseReady:function(e){const t=[{value:a.SEND_MESSAGE,text:n.get("askForInformation"),icon:"question-circle"}];return(this.activePhasePayment.getPaymentMethod()===i.PaymentMethods.BANK_CARD||this.activePhasePayment.getBuyerInvoiceNumber())&&(t.unshift({value:a.ACCEPT_PHASE_DELIVERY,text:n.get("acceptPhaseDelivery",{number:e.getNumber()}),icon:"check"}),t.push({value:a.REJECT_PHASE_DELIVERY,text:n.get("rejectPhaseDelivery",{number:e.getNumber()}),icon:"close"})),t}})}),define("DS/MPFBiddingNewMessage/biddingOptions/SellerPhaseBiddingOptions",["UWA/Class","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a){"use strict";return e.extend({init:function(e){this.cart=e.cart,this.cartPhases=e.cartPhases},getBiddingOptions:function(){let e;return(e=this.cart.getState()===t.States.CANCEL?[]:this.cartPhases.isEmpty()?this._getPhaseCreationBiddingOptions():this._getPhaseBiddingOptions())||[]},_getPhaseBiddingOptions:function(){let e,t;const i=this.cartPhases.getActivePhase();if(i)switch(t=i.getState()){case s.States.SUBMITTED:e=i.isNew()?this._getPhaseCreationBiddingOptions():this._getPhaseSubmittedBiddingOptions(i);break;case s.States.ACCEPTED:e=this._getPhaseAcceptedBiddingOptions(i);break;case s.States.PENDING_PROCESSING:e=this._getPhasePendingProcessingBiddingOptions(i);break;case s.States.PROCESSING:e=this._getPhaseProcessingBiddingOptions(i)}return e},_getPhaseCreationBiddingOptions:function(){return[{value:i.ACCEPT,text:a.get("proposeSchedule"),icon:"check"},{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.CANCEL,text:a.get("rejectRequest"),icon:"close"}]},_getPhaseSubmittedBiddingOptions:function(e){return[{value:i.ACCEPT_PHASE,text:a.get("acceptPhase",{number:e.getNumber()}),icon:"check"},{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.CANCEL_PHASE,text:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}]},_getPhaseAcceptedBiddingOptions:function(e){return[{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.CANCEL_PHASE,text:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}]},_getPhasePendingProcessingBiddingOptions:function(e){return[{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.NOTIFY_PHASE_WORK_STARTED,text:a.get("notifyPhaseWorkStarted",{number:e.getNumber()}),icon:"play"}]},_getPhaseProcessingBiddingOptions:function(e){return[{value:i.SEND_MESSAGE,text:a.get("askForInformation"),icon:"question-circle"},{value:i.NOTIFY_PHASE_DELIVERY,text:a.get("notifyPhaseDelivery",{number:e.getNumber()}),icon:"truck-delivery",disabled:!e.hasDocuments()}]}})}),define("DS/MPFBiddingNewMessage/biddingOptions/EngineeringBiddingOptions",["DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFBiddingNewMessage/BiddingActions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a){"use strict";return class{constructor({cart:e,cartPhases:t,isBuyerView:s,cartChangeTracker:i}){this.cart=e,this.cartPhases=t,this.isBuyerView=s,this.cartChangeTracker=i}getOptions(){const t=this.cart.getState(),s=this.cartPhases.getActivePhase(),i=s&&s.getState();return t===e.States.CANCELLED?[]:(this.isBuyerView?this.getBuyerOptions({activePhase:s,activePhaseState:i}):this.getSellerOptions({activePhase:s,activePhaseState:i}))||[]}getBuyerOptions({activePhase:e,activePhaseState:t}){if(!t)return[];switch(t){case s.States.SUBMITTED:return[{action:i.CANCEL_PHASE,label:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}];case s.States.ACCEPTED:return[{action:i.PAY,label:a.get("confirmAndPayPhase",{number:e.getNumber()}),icon:"credit-card"},{action:i.CANCEL_PHASE,label:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}];case s.States.READY:return[{action:i.ACCEPT_PHASE_DELIVERY,label:a.get("acceptPhaseDelivery",{number:e.getNumber()}),icon:"check"},{action:i.REJECT_PHASE_DELIVERY,label:a.get("rejectPhaseDelivery",{number:e.getNumber()}),icon:"close"}]}}getSellerOptions({activePhase:e,activePhaseState:t}){if(0===this.cartPhases.size())return[{action:i.ACCEPT,label:a.get("proposeSchedule"),icon:"check"},{action:i.CANCEL,label:a.get("rejectRequest"),icon:"close"}];if(t)switch(t){case s.States.SUBMITTED:return[{action:i.ACCEPT_PHASE,label:a.get("acceptPhase",{number:e.getNumber()}),icon:"check"},{action:i.CANCEL_PHASE,label:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}];case s.States.ACCEPTED:return[{action:i.CANCEL_PHASE,label:a.get("cancelPhase",{number:e.getNumber()}),icon:"close"}];case s.States.PROCESSING:return[{action:i.NOTIFY_PHASE_DELIVERY,label:a.get("notifyPhaseDelivery",{number:e.getNumber()}),icon:"truck-delivery",isDisabled:!e.hasDocuments()}]}}}}),define("DS/MPFBiddingNewMessage/SendQuoteRequestComponent",["UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFBiddingNewMessage/CartChangeTracker","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/BiddingMessageContentV2","DS/MPFBiddingNewMessage/BiddingMessageFileList","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFBiddingNewMessage/SendMessageHandler","DS/MPFTcContractComponent/TermsOfUseOrder","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C){"use strict";const y=Object.freeze({ON_REQUEST_SENT:"onRequestSent",SAVING_ERROR:"savingError",ON_CHANGE:"onChange"}),D=e.extend({className:"mpf-send-quote-request",setup({me:e,cart:t,cartItems:s,shop:i,service:l,doesNeedSignature:u,tcContract:p,privacyPolicyContract:m,tcDocument:g,privacyPolicyDocument:P,tcDocumentFactory:S,tcContractFactory:C,slotElementFactory:y,platformPurchaseUrl:D,maxFileSize:E,maxSpecificFileSize:M,files:T,message:f,alwaysAllowDocUpload:F,displaySendButton:A=!0}={}){a.requiredOfPrototype(e,n,"options.me must be a PersonModel"),a.requiredOfPrototype(t,o,"options.cart must be a CartModel"),a.requiredOfPrototype(s,c,"options.cartItems must be a CartItemCollection"),a.requiredOfPrototype(i,r,"options.shop must be a ShopModel"),a.requiredOfType(l,"string",'options.service must be one of the MarketplaceServices "enums"'),a.requiredOfPrototype(S,h,"options.tcDocumentFactory must be a TcDocumentFactory"),a.requiredOfPrototype(C,d,"options.tcContractFactory must be a TcContractFactory"),this.me=e,this.cart=t,this.cartItems=s,this.shop=i,this.service=l,this.tcContract=p,this.privacyPolicyContract=m,this.tcDocument=g,this.privacyPolicyDocument=P,this.tcDocumentFactory=S,this.tcContractFactory=C,this.slotElementFactory=y,this.platformPurchaseUrl=D,this.maxFileSize=E,this.maxSpecificFileSize=M,this.alwaysAllowDocUpload=F,this.displaySendButton=A,this.cartChangeTracker=this._createCartChangeTracker(),this.messageInput=this._createTextInput({message:f}),this.fileList=this._createFileList({files:T}),this.ndaInput=this._createNdaInput(),this.sendMessageHandler=this._createSendMessageHandler(),this.alert=this._createAlert(),u&&(this.termsOfUseOrderComponent=this._createTermsOfUseOrderComponent()),A&&(this.sendButton=this._createSendButton(u,f))},render(){return this.container.setContent([this.alert,this.messageInput.render(),{tag:"div",class:"mpf-slot-1",html:["function"==typeof this.slotElementFactory&&this.slotElementFactory({cart:this.cart})]},this.fileList.render(),{tag:"div",class:"mpf-button-row",html:[this.ndaInput.render(),this.sendButton]},this.termsOfUseOrderComponent&&this.termsOfUseOrderComponent.render()]),this},validate(){const e=!!this.messageInput.getMessage().trim(),t=!this.termsOfUseOrderComponent||this.termsOfUseOrderComponent.isChecked();return{isValid:e&&t,isMessageValid:e}},async sendRequest(){if(this.validate().isValid)try{s.mask(this.container),this.cart.isNew()&&await this.cart.savePromise(),this.termsOfUseOrderComponent&&await this.termsOfUseOrderComponent.createContract(),await this.sendMessageHandler.sendRequest({text:this.messageInput.getMessage(),files:this.fileList.getUploadedFiles()}),this.messageInput.clear(),this.fileList.clear(),this.render(),s.unmask(this.container),this.dispatchEvent(y.ON_REQUEST_SENT)}catch(e){s.unmask(this.container),console.error(e),this._showError(C.get("requestCannotBeSend")),this.dispatchEvent(y.SAVING_ERROR)}else this.dispatchEvent(y.INVALID_CONTENT)},getMessage(){return this.messageInput.getMessage()},destroy(){this.stopListening(),this.messageInput.destroy(),this.fileList.destroy(),this.ndaInput.destroy(),this.termsOfUseOrderComponent&&this.termsOfUseOrderComponent.destroy(),this.messageInput=null,this.fileList=null,this.ndaInput=null,this.sendButton=null,this.termsOfUseOrderComponent=null,this.me=null,this.cart=null,this.cartItems=null,this.shop=null,this.tcContract=null,this.privacyPolicyContract=null,this.tcDocument=null,this.privacyPolicyDocument=null,this.tcDocumentFactory=null,this.tcContractFactory=null,this._parent(),this.container=null},_onChange(){const{isValid:e,isMessageValid:t}=this.validate();this.sendButton&&this.sendButton.setDisabled(!e),this.messageInput.showValidity(t),this.dispatchEvent(y.ON_CHANGE,{isValid:e})},_showError(e){this.alert.add({className:"error",message:e}).show()},_createCartChangeTracker(){return new l({cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases})},_createTextInput({message:e}){const t=new p({service:this.service,message:e});return this.listenTo(t,p.Events.ON_CHANGE,this._onChange.bind(this)),t},_createFileList({files:e}){return new m({isBuyerView:this.isBuyerView,files:e})},_createNdaInput(){const e=new g({buyerView:!0,tcDocumentFactory:this.tcDocumentFactory,cart:this.cart,cartItem:this.cartItems.getRequestItemForService(this.service),maxFileSize:this.maxFileSize,maxSpecificFileSize:this.maxSpecificFileSize,alwaysAllowDocUpload:this.alwaysAllowDocUpload});return this.listenTo(e,g.Events.DOCUMENT_SAVED,e=>{this.fileList.addDocument(e)}),this.listenTo(e,g.Events.DOCUMENT_NOT_SAVED,e=>{this.alert.add({className:"error",message:e}).show()}),e},_createSendButton(e,s){return new t({className:"primary mpf-send-button",disabled:e||!s,value:C.get("sendForQuote"),events:{onClick:()=>{this.sendRequest()}}})},_createSendMessageHandler(){return new P({cartChangeTracker:this.cartChangeTracker,me:this.me,cart:this.cart,cartItems:this.cartItems,shop:this.shop,tcContractFactory:this.tcContractFactory,service:this.service,isBuyerView:!0})},_createTermsOfUseOrderComponent(){return new S({buyer:this.me,tcDocument:this.tcDocument,privacyPolicyDocument:this.privacyPolicyDocument,tcContract:this.tcContract,privacyPolicyContract:this.privacyPolicyContract,isInitializedChecked:!1,callback:this._onChange.bind(this)})},_createAlert:()=>new i({visible:!1})});return D.Events=y,D}),define("DS/MPFBiddingNewMessage/SendQuoteRequestComponentFactory",["DS/MPFServices/ObjectService","DS/MPFConnector/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFPersonModel/PersonFactory","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFShopModel/ShopFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFTCContractModel/TCContractModel","DS/MPFBiddingNewMessage/SendQuoteRequestComponent"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p){"use strict";return class{static async createComponent({cartId:h,shopId:m,message:g,multibiddingShopIds:P,maxFileSize:S,maxSpecificFileSize:C,service:y=s.INNOVATE,slotElementFactory:D,platformPurchaseUrl:E,alwaysAllowDocUpload:M,displaySendButton:T}={}){e.requiredOfType(h,"string","options.cartId must be a string"),e.requiredOfType(m,"string","options.shopId must be a string");const f=await t.fetchPromise({service:y}),F=i.getInstance(f),[A,_,I,O,N,v,b]=await F.getFactories([i.Types.PERSON,i.Types.CART,i.Types.CART_ITEM,i.Types.SHOP,i.Types.TC_CONTRACT,i.Types.TC_DOCUMENT,i.Types.TENANT]),w=A.createModel(a.Types.ME),B=O.createModel(o.Types.SHOP,{id:m}),R=_.createModel(n.Types.CART,{id:h,[d.Fields.SHOP_ID]:m}),U=N.createCollection(c.Types.TERMS_AND_CONDITIONS);await Promise.all([w.fetchPromise(),B.fetchPromise(),R.fetchPromise({expands:[d.Expands.CART_ITEMS]}),U.fetchPromise({type:[u.TcTypes.DS_BUYER,u.TcTypes.DATA_PRIVACY]})]);const{doesNeedSignature:k,tcContract:L,privacyPolicyContract:V,tcDocument:x,privacyPolicyDocument:H}=await this.loadTermsOfUsePrivacyPolicyData({me:w,contracts:U,tcDocumentFactory:v});R.clearPendingChanges(),R.set("shopID",m);const q=I.createCollection(r.Types.CART_CART_ITEM,R.getItems());q.forEach(e=>e.clearPendingChanges());const Y=q.getRequestItemForService(y),G=Y.getOfferId();return Y.set(l.Fields.OFFER_ID,G),new p({me:w,cart:R,cartItems:q,shop:B,message:g,doesNeedSignature:k,tcContract:L,privacyPolicyContract:V,tcDocument:x,privacyPolicyDocument:H,multibiddingShopIds:P,service:y,maxFileSize:S,maxSpecificFileSize:C,tcContractFactory:N,tcDocumentFactory:v,tenantFactory:b,slotElementFactory:D,platformPurchaseUrl:E,alwaysAllowDocUpload:M,displaySendButton:T})}static async loadTermsOfUsePrivacyPolicyData({me:e,contracts:t,tcDocumentFactory:s}){const i="company"===e.getBuyerType()?e.getCompanyId():e.get("id"),a=this.findContract(t,u.DOCUMENT_TYPES.DATA_PRIVACY,i),n=this.findContract(t,u.DOCUMENT_TYPES.DS_BUYERS,i),r=a.getCurrentState()===u.STATUS.draft||n.getCurrentState()===u.STATUS.draft;let o,c;return r&&(o=s.createModel(h.Types.DS_BUYERS),c=s.createModel(h.Types.PRIVACY_POLICY),await Promise.all([o.fetchPromise(),c.fetchPromise()])),{doesNeedSignature:r,tcContract:n,privacyPolicyContract:a,tcDocument:o,privacyPolicyDocument:c}}static findContract(e,t,s){let i=e.find(function(e){return e.getDocumentType()===t&&e.getCurrentState()===u.STATUS.inEffect});return i||(i=e.find(function(e){return e.getDocumentType()===t&&e.getCurrentState()===u.STATUS.draft&&e.getConsumerID()===s})),i}}}),define("DS/MPFBiddingNewMessage/biddingOptions/PhaseBiddingOptions",["UWA/Class","DS/MPFBiddingNewMessage/biddingOptions/BuyerPhaseBiddingOptions","DS/MPFBiddingNewMessage/biddingOptions/SellerPhaseBiddingOptions"],function(e,t,s){"use strict";return e.extend({init:function(e){this.cart=e.cart,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment,this.buyerBiddingOptions=null,this.sellerBiddingOptions=null},getBuyerBiddingOptions:function(){return this.buyerBiddingOptions||(this.buyerBiddingOptions=new t({cart:this.cart,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment})),this.buyerBiddingOptions.getBiddingOptions()},getSellerBiddingOptions:function(){return this.sellerBiddingOptions||(this.sellerBiddingOptions=new s({cart:this.cart,cartPhases:this.cartPhases})),this.sellerBiddingOptions.getBiddingOptions()}})}),define("DS/MPFBiddingNewMessage/biddingOptions/BiddingOptionsHandler",["DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFServices/MarketplaceServices","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/biddingOptions/PhaseBiddingOptions","DS/MPFBiddingNewMessage/biddingOptions/MakeBiddingOptionsHandler","DS/MPFBiddingNewMessage/biddingOptions/InnovateBiddingOptions","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c){"use strict";return class{constructor({cart:i,cartItems:a,cartPhases:n,activePhasePayment:r,isBuyerView:o,isEmp:c,selection:h,service:d}){e.requiredOfPrototype(i,t,"options.cart must be a CartModel"),e.requiredOfPrototype(a,s,"options.cartItems must be a CartItemCollection"),e.requiredOfType(o,"boolean","options.isBuyerView must be a boolean"),e.requiredOfType(d,"string","options.service must be a string"),this.cart=i,this.cartItems=a,this.cartPhases=n,this.activePhasePayment=r,this.isBuyerView=o,this.isEmp=c,this.service=d,this.reset(),h&&this.setSelection({value:h.value})}getOptions(){return this.options}reset(){this.selectedIndex=null,this.options=this._createOptions()}resetOptions(){this.options=this._createOptions(),"number"==typeof this.selectedIndex&&this.selectedIndex>=this.options.length&&(this.selectedIndex=null)}getSelection(){if(this.hasSelection()){if("number"==typeof this.selectedIndex)return this.options[this.selectedIndex];if(this.options&&1===this.options.length)return this.options[0]}}setSelection({value:e}){this.selectedIndex=this.options.findIndex(t=>t.value===e)}clearSelection(){this.selectedIndex=null}hasSelection(){return"number"==typeof this.selectedIndex||this.options&&1===this.options.length}_findFirstRequestCartItem(){return this.cartItems.getRequestItemForService(this.service)}_createOptions(){let e=[];return this.service===i.MAKE?e=this._getMakeBiddingOptions():this.service===i.INNOVATE?e=this._getInnovateBiddingOptions():this.service===i.ENGINEERING&&(e=this._getEngineeringBiddingOptions()),(!e||e.length<1)&&(e=[this._getDefaultOption()]),e}_getDefaultOption(){return{value:a.SEND_MESSAGE,text:c.get("askForInformation"),icon:"question-circle"}}_getMakeBiddingOptions(){return r.getOptions({cart:this.cart,cartItem:this._findFirstRequestCartItem(),isBuyerView:this.isBuyerView,isEmp:this.isEmp})}_getEngineeringBiddingOptions(){const e=new n({cart:this.cart,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,isEmp:this.isEmp});return this.isBuyerView?e.getBuyerBiddingOptions():e.getSellerBiddingOptions()}_getInnovateBiddingOptions(){return o.getOptions({cart:this.cart,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,isBuyerView:this.isBuyerView})}}}),define("DS/MPFBiddingNewMessage/CancelConfirmationModalV2",["UWA/Class/View","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Input/Text","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/CancelReasonInput","i18n!DS/MPFBiddingNewMessage/assets/nls/CancelConfirmationModalV2"],function(e,t,s,i,a,n,r,o,c,h,d){"use strict";const l=Object.freeze({CART_CANCELLED:"cartCancelled"}),u=e.extend({className:"mpf-cancel-modal-v2",setup({cart:e,sendMessageHandler:t,isBuyerView:s}){r.requiredOfPrototype(e,o,"options.cart must be a CartModel"),r.requiredOfType(s,"boolean","options.isBuyerView must be a boolean"),this.cart=e,this.sendMessageHandler=t,this.confirmButton=this._createConfirmButton(),this.cancelButton=this._createCancelButton(),this.reasonInput=new h({isBuyerView:s}),this.commentInput=this._createCommentInput(),this.alert=this._createAlert(),this.modal=this._createModal()},render(){return this.container.setContent(this.modal),this},show({action:e=c.CANCEL}){this.action=e,this.setLoading(!1),this.modal.show()},hide(){this.modal.hide()},clear(){this.commentInput.setValue(""),this.reasonInput.clear()},validate(){return this.reasonInput.validate()},setLoading(e){(e=!1!==e)?(a.mask(this.modal.getBody()),this.confirmButton.load()):(a.unmask(this.modal.getBody()),this.confirmButton.load(!1))},async _cancelCart(){this.setLoading();try{await this.sendMessageHandler.cancel({action:this.action,message:this._parseMessage(this.commentInput.getValue()),reason:this.reasonInput.getValue()}),this.setLoading(!1),this.hide(),this.dispatchEvent(l.CART_CANCELLED)}catch(e){this.setLoading(!1),console.error(e);let t=d.get("unableToCancelCart");"Error.Injection"===(e&&e.response&&e.response.errorCode)&&(t=d.get("invalidCharactersMsg")),this.alert.add({className:"error",message:t}).show()}},_parseMessage:e=>e=(e=e.replaceAll("<","&lt;")).replaceAll(">","&gt;"),_createAlert:()=>new n({visible:!1,autoHide:!0,hideDelay:5e3}),_createCommentInput:()=>new i({placeholder:d.get("typeTextHere"),multiline:!0,rows:3}),_createModal(){return new t({header:{tag:"h4",text:d.get("cancelRequest")},body:[this.alert,{tag:"div",class:"mpf-info",text:d.get("areYouSureToCancel")},this.reasonInput.render(),{tag:"div",class:"mpf-comment-container",html:[{tag:"div",class:"mpf-label",text:d.get("doYouHaveOtherRemarks")},this.commentInput]}],footer:[this.confirmButton,this.cancelButton]})},_createConfirmButton:function(){return new s({className:"primary",value:d.get("confirm"),events:{onClick:()=>{this.validate()&&this._cancelCart()}}})},_createCancelButton:function(){return new s({value:d.get("cancel"),events:{onClick:this.hide.bind(this)}})},destroy(){this.stopListening(),this.modal.destroy(),this.reasonInput.destroy(),this.commentInput.destroy(),this.modal=null,this.reasonInput=null,this.commentInput=null,this.confirmButton=null,this.cancelButton=null,this._parent(),this.container=null}});return u.Events=l,u}),define("DS/MPFBiddingNewMessage/BiddingActionButtons",["UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/MPFServices/MarketplaceServices","DS/MPFServices/ObjectService","DS/MPFBiddingNewMessage/SendMessageHandler","DS/MPFBiddingNewMessage/CartChangeTracker","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/biddingOptions/MakeBiddingOptionsHandler","DS/MPFBiddingNewMessage/biddingOptions/InnovateBiddingOptions","DS/MPFBiddingNewMessage/biddingOptions/EngineeringBiddingOptions","DS/MPFBiddingNewMessage/CancelConfirmationModalV2","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m){"use strict";const g=Object.freeze({ACTION_STARTED:"actionStarted",ACTION_COMPLETED:"actionCompleted",EXTERNAL_ACTION:"externalAction",PAYMENT_DONE:"paymentDone",UPLOAD_PO_LATER:"uploadPoLater",ON_ERROR:"onError",VIEW_UPDATED:"viewUpdated"}),P=e.extend({className:"mpf-bidding-action-buttons",setup({sendMessageHandler:e,cart:t,cartPhases:s,cartItems:i,cartChangeTracker:n,shop:r,service:h,slot1:d,maskOnLoad:l=!0,...u}={}){this.sendMessageHandler=e,this.cart=t,this.cartItems=i,this.cartPhases=s,this.cartChangeTracker=n,this.shop=r,this.service=h,this.slot1=d,this.maskOnLoad=l,this.alert=this._createAlert(),this.biddingOptionsHandler=this._createBiddingOptionsHandler(u),this.cancelModal=this._createCancelModal({sendMessageHandler:e,...u}),this.listenTo(this.sendMessageHandler,o.Events.ON_PAYMENT_DONE,this._onPaymentDone.bind(this)),this.listenTo(this.sendMessageHandler,o.Events.UPLOAD_PO_LATER,this._onPaymentDone.bind(this,{eventName:g.UPLOAD_PO_LATER})),this.listenTo(this.cartChangeTracker,c.Events.ON_CHANGE,this._onCartChange.bind(this)),a.subscribe("MPPurchaseOrderUploaded",this._onCartChange.bind(this))},render(){const e=this.biddingOptionsHandler.getOptions().map(({action:e,label:s,icon:i,className:a,isDisabled:n=!1})=>new t({value:s,icon:i,className:a,disabled:n,events:{onClick:this._startAction.bind(this,{action:e})}}));return this.container.setContent([this.alert,this.cancelModal.render(),{tag:"div",class:"mpf-button-container",html:[this.slot1,{tag:"div",class:"mpf-action-button-container",html:e}]}]),this},resetAfterAction(){this.cancelModal.clear();const e=this.cart.getItems();return Array.isArray(e)&&e.length>0&&this.cartItems.reset(this.cart.getItems()),this.cartChangeTracker.reset(),this},destroy(){a.unsubscribe("MPPurchaseOrderUploaded"),this.stopListening(),this.cancelModal.destroy(),this.sendMessageHandler=null,this.biddingOptionsHandler=null,this.cancelModal=null,this.cart=null,this.cartItems=null,this.cartPhases=null,this._parent(),this.container=null},async _startAction({action:e}){if(e===h.CANCEL||e===h.CANCEL_PHASE)this.cancelModal.show({action:e});else if("function"==typeof e){const t=e();this.render(),this.dispatchEvent(g.EXTERNAL_ACTION,t)}else{const t=await this.sendMessageHandler.validateAction({action:e});if(t.isValid){this.dispatchEvent(g.ACTION_STARTED,{action:e}),this.maskOnLoad&&i.mask(this.container);try{await this.sendMessageHandler.doAction({action:e}),this.resetAfterAction().render(),this.maskOnLoad&&i.unmask(this.container),this.dispatchEvent(g.ACTION_COMPLETED,{action:e})}catch(t){this.maskOnLoad&&i.unmask(this.container),console.error(t),this.alert.add({className:"error",message:m.get("unableToCompleteAction")}).show(),this.dispatchEvent(g.ON_ERROR,{action:e})}}else t.errorMessage&&this.alert.add({className:"error",message:t.errorMessage}).show()}},_onCartChange(){this.render(),this.dispatchEvent(g.VIEW_UPDATED)},async _onPaymentDone({wasPaymentSuccessful:e,eventName:t}){this.dispatchEvent(g.ACTION_STARTED),this.maskOnLoad&&i.mask(this.container),await Promise.all([this.cart.fetchPromise({expand:["cart-items"]}),this.cartPhases&&this.cartPhases.fetchPromise()]),this.maskOnLoad&&i.unmask(this.container),this.resetAfterAction(),this.render(),this.dispatchEvent(t||g.PAYMENT_DONE,{wasPaymentSuccessful:e})},_createAlert:()=>new s({visible:!1,autoHide:!0,hideDelay:5e3}),_createBiddingOptionsHandler(e){const t={...e,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,cartChangeTracker:this.cartChangeTracker,isEmp:this.shop&&this.shop.isInternal()};return this.service===n.INNOVATE?new l(t):this.service===n.MAKE?new d(t):this.service===n.ENGINEERING?new u(t):void 0},_createCancelModal({sendMessageHandler:e,isBuyerView:t}){const s=new p({isBuyerView:t,cart:this.cart,sendMessageHandler:e});return this.listenTo(s,p.Events.CART_CANCELLED,()=>{this.resetAfterAction().render(),this.dispatchEvent(g.ACTION_COMPLETED,{action:h.CANCEL})}),s}});return P.Events=g,P}),define("DS/MPFBiddingNewMessage/BiddingComponentFactory",["DS/MPFServices/ObjectService","DS/MPFConnector/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFCartModel/CartModel","DS/MPFPersonModel/PersonFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFOfferModel/OfferFactory","DS/MPFShopModel/ShopFactory","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTenantModel/TenantFactory","DS/MPFBiddingNewMessage/CartChangeTracker","DS/MPFBiddingNewMessage/SendMessageHandler","DS/MPFBiddingNewMessage/BiddingMessageComponent","DS/MPFBiddingNewMessage/BiddingActionButtons","DS/MPFCartPhaseComponent/CartPhaseCreator","DS/MPFCartPhaseComponent/CartPhaseSummary","DS/MPFBidding/TimelineContainer","DS/MPFInnovateComponent/checkout/TenantSelectionComponent","DS/MPFInnovateComponent/bidding/InnovateStepProgressBar","DS/MPFView/EmptyView"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C,y,D,E,M,T,f){"use strict";const F={};class A{static getInstance({service:e,cartId:t,isBuyerView:s,validateSend:i,cartPatchOpFactory:a}){return F[t]?F[t]:(F[t]=new A({service:e,cartId:t,isBuyerView:s,validateSend:i,cartPatchOpFactory:a}),F[t])}constructor({service:t,cartId:s,isBuyerView:i,validateSend:a,cartPatchOpFactory:n}){e.requiredOfType(t,"string","options.service must be a string (see DS/MPFServices/MarketplaceServices)"),e.requiredOfType(s,"string","options.cartId must be a string"),e.requiredOfType(i,"boolean","options.isBuyerView must be a boolean"),this.service=t,this.cartId=s,this.isBuyerView=i,this.validateSend=a,this.cartPatchOpFactory=n,this._isLoaded=!1,this._isLoading=!1,this._loadingPromises=[]}addLoadingPromise(){const e=function(){const e={};return e.promise=new Promise((t,s)=>{e.resolve=t,e.reject=s}),e}();return this._loadingPromises.push(e),e.promise}async load(){if(this._isLoading)return this.addLoadingPromise();{this._isLoading=!0;const e=await t.fetchPromise({service:this.service}),s=i.getInstance(e),[a,r,o,c,h,l,u,p,m,P,S,C,y,D]=await s.getFactories([i.Types.PERSON,i.Types.COMPANY,i.Types.CART,i.Types.CART_ITEM,i.Types.CART_ITEM_DOC,i.Types.CART_PHASE,i.Types.TIMELINE_ITEM,i.Types.SHOP,i.Types.TC_CONTRACT,i.Types.TC_DOCUMENT,i.Types.CART_PAYMENT,i.Types.OFFER,i.Types.TENANT,i.Types.PORTFOLIO]);this.tcContractFactory=m,this.tcDocumentFactory=P,this.cartPaymentFactory=S,this.cartPhaseFactory=l,this.cartItemDocFactory=h,this.companyFactory=r,this.portfolioFactory=D,this.person=a.createModel(n.Types.ME),this.timelineItems=u.createCollection([],{parentResourceId:this.cartId}),await Promise.all([this.person.fetchPromise(),this.timelineItems.fetchPromise(),this._fetchPhasesAndPhasePayment({cartPhaseFactory:l,cartPaymentFactory:S}),this._fetchCartCompanyOffersShopAndNda({companyFactory:r,cartFactory:o,offerFactory:C,shopFactory:p}),this._fetchTenants({tenantFactory:y})]),this.cartItems=c.createCollection(d.Types.CART_CART_ITEM,this.cart.getItems()),this.cartChangeTracker=new g({cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases}),this.sendMessageHandler=this._createSendMessageHandler(),this._isLoaded=!0,this._isLoading=!1,this._loadingPromises.forEach(e=>e.resolve()),this._loadingPromises=[]}}async createStepProgressBar(){return this._isLoaded||await this.load(),new T({phases:this.cartPhases})}async createMessageComponent({maxFileSize:e,maxSpecificFileSize:t,slot1:s,slot2:i,slot3:a,message:n,files:r,maskOnLoad:o}={}){return this._isLoaded||await this.load(),new S({sendMessageHandler:this.sendMessageHandler,validateSend:this.validateSend,cartPatchOpFactory:this.cartPatchOpFactory,maxFileSize:e,maxSpecificFileSize:t,slot1:s,slot2:i,slot3:a,message:n,files:r,maskOnLoad:o,cart:this.cart,cartItems:this.cartItems,nda:this.nda,tcDocumentFactory:this.tcDocumentFactory,service:this.service,isBuyerView:this.isBuyerView})}async createActionButtons({slot1:e,maskOnLoad:t}={}){return this._isLoaded||await this.load(),new C({sendMessageHandler:this.sendMessageHandler,cartChangeTracker:this.cartChangeTracker,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,isBuyerView:this.isBuyerView,service:this.service,slot1:e,maskOnLoad:t})}async createCartPhaseCreator(){return this._isLoaded||await this.load(),new y({cart:this.cart,cartPhases:this.cartPhases,cartPhaseFactory:this.cartPhaseFactory,offers:this.offers,service:this.service,portfolioFactory:this.portfolioFactory,companyFactory:this.companyFactory})}async createCartPhaseSummary(){return this._isLoaded||await this.load(),this.cart.isSelfOrder()?f.getInstance():new D({cart:this.cart,cartPhases:this.cartPhases,cartPhaseFactory:this.cartPhaseFactory,offers:this.offers,service:this.service,isReadOnly:this.isBuyerView||this.service===s.INNOVATE,portfolioFactory:this.portfolioFactory,companyFactory:this.companyFactory})}async createTimelineContainer({serviceViewFactory:e,annotations3dViewFactory:t}={}){return this._isLoaded||await this.load(),new E({timelineItems:this.timelineItems,currentUserId:this.isBuyerView?this.person.get("id"):this.cart.getShopId(),cartItemDocFactory:this.cartItemDocFactory,serviceViewFactory:e,annotations3dViewFactory:t})}async createTenantSelectionComponent({platformPurchaseUrl:e}){return this._isLoaded||await this.load(),new M({cart:this.cart,tenants:this.tenants,platformPurchaseUrl:e})}_createSendMessageHandler(){return new P({cartChangeTracker:this.cartChangeTracker,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,me:this.person,shop:this.shop,company:this.company,tcContractFactory:this.tcContractFactory,activePhasePayment:this.activePhasePayment,isBuyerView:this.isBuyerView,validateSend:this.validateSend,cartPatchOpFactory:this.cartPatchOpFactory,service:this.service,locale:this.locale})}_hasPhasePayment(){return this.service===s.ENGINEERING||this.service===s.INNOVATE}async _fetchCartCompanyOffersShopAndNda({companyFactory:e,cartFactory:t,offerFactory:i,shopFactory:n}){const d=this.service===s.INNOVATE;this.cart=t.createModel(h.Types.CART,{id:this.cartId}),d?(await this.cart.fetchPromise({expand:["cart-items"]}),this.company=e.createModel(r.Types.COMPANY),this.shop=n.createModel(c.Types.SHOP),this.company.set("id",this.cart.getCompanyID()),this.shop.set("id",this.cart.getShopId()),this.isBuyerView&&this.cart.getState()===a.States.SUBMITTED&&(this.nda=this.tcContractFactory.createModel(p.Types.NDA,null,{parentResourceId:this.cartId})),this.cart.isInnovateBusinessExperienceOrder(this.service)&&!this.cart.isSelfOrder()&&(this.offers=i.createCollection(o.Types.SHOP_OFFERS,[],{parentResourceId:this.cart.getShopId()})),await Promise.all([!this.company.isNew()&&this.company.fetchPromise(),this.offers&&this.offers.fetchPromise(),this.shop.fetchPromise(),this.nda&&this.nda.fetchPromise()])):(this.company=e.createModel(r.Types.ME),await Promise.all([this._fetchCartShopAndNda({cartFactory:t,shopFactory:n}),this.company.fetchPromise()]))}async _fetchCartShopAndNda({shopFactory:e}){await this.cart.fetchPromise(),this.shop=e.createModel(c.Types.SHOP,{id:this.cart.getShopId()}),this.isBuyerView&&this.cart.getState()===a.States.SUBMITTED&&(this.nda=this.tcContractFactory.createModel(p.Types.NDA,null,{parentResourceId:this.cartId})),await Promise.all([this.shop.fetchPromise(),this.nda&&this.nda.fetchPromise()])}async _fetchPhasesAndPhasePayment({cartPhaseFactory:e,cartPaymentFactory:t}){if(this._hasPhasePayment()){this.cartPhases=e.createCollection(l.Types.CART_CART_PHASE,null,{parentResourceId:this.cartId}),await this.cartPhases.fetchPromise();const s=this.cartPhases.getActivePhase();this.activePhasePayment=t.createModel(u.Types.CART_PHASE_CART_PAYMENT,null,{parentResourceId:s&&s.get("id")}),s&&await this.activePhasePayment.fetchPromise()}}async _fetchTenants({tenantFactory:e}){this.service!==s.INNOVATE&&this.service!==s.CLICK_AND_BUY||(this.tenants=e.createCollection(m.Types.TENANTS,[],{parentResourceId:this.cartId}),await this.tenants.fetchPromise())}}return A}),define("DS/MPFBiddingNewMessage/BiddingNewMessageV2",["UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemCollection","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTCContractModel/TCContractModel","DS/MPFBiddingNewMessage/BiddingActionButtons","DS/MPFBiddingNewMessage/BiddingMessageComponent","DS/MPFBiddingNewMessage/CartChangeTracker","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/SendMessageHandler","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C,y){"use strict";const D=Object.freeze({READ_LAST_MESSAGE:"readLastMessage",PAYMENT_DONE:"paymentDone",UPLOAD_PO_LATER:"uploadPoLater",ACTION_PERFORMED:"actionPerformed",SAVING_ERROR:"savingError",VIEW_UPDATED:"viewUpdated"}),E=e.extend({tagName:"div",className:"mpf-bidding-new-message-v2",setup(e={}){i.requiredOfType(e.service,"string","options.service must be a string (see MarketplaceServices)"),i.requiredOfType(e.isBuyerView,"boolean","options.isBuyerView must be a boolean"),i.requiredOfPrototype(e.me,r,"options.me must be a PersonModel"),i.requiredOfPrototype(e.cart,h,"options.cart must be a CartModel"),i.requiredOfPrototype(e.cartItems,d,"options.cartItems must be a CartItemCollection"),i.requiredOfPrototype(e.tcContractFactory,u,"options.tcContractFactory must be a TCContractFactory"),i.requiredOfPrototype(e.tcDocumentFactory,l,"options.tcDocumentFactory must be a TCDocumentFactory"),e.isBuyerView&&(e.buyerType===n.COMPANY&&i.requiredOfPrototype(e.company,o,"options.company must be a CompanyModel"),e.cart.getState()===h.States.SUBMITTED&&(i.requiredOfPrototype(e.shop,c,"options.shop must be a ShopModel"),i.requiredOfPrototype(e.nda,p,"options.nda must be a TcContractModel"))),this.isBuyerView=!0===e.isBuyerView,this.buyerType=e.buyerType,this.service=e.service||a.INNOVATE,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.locale=e.locale,this.validateSend=e.validateSend,this.slot1=e.slot1,this.slot2=e.slot2,this.slot3=e.slot3,this.cartPatchOpFactory=e.cartPatchOpFactory,this.cartChangeTracker=this._createCartChangeTracker(e),this.sendMessageHandler=this._createSendMessageHandler(e),this.biddingActionButtons=this._createBiddingActionButtons(e),this.biddingMessageComponent=this._createBiddingMessageComponent(e)},render(){return this.container.setContent([this.biddingActionButtons.render(),this.biddingMessageComponent.render()]),this},mask(){s.mask(this.container)},unmask(){s.unmask(this.container)},destroy(){this.stopListening(),this.biddingActionButtons.destroy(),this.biddingMessageComponent.destroy(),this.sendMessageHandler.destroy(),this.cartChangeTracker.destroy(),this.biddingActionButtons=null,this.biddingMessageComponent=null,this.cartChangeTracker=null,this.sendMessageHandler=null,this._parent(),this.container=null},_createCartChangeTracker:({cart:e,cartItems:t,cartPhases:s})=>new P({cart:e,cartItems:t,cartPhases:s}),_createSendMessageHandler(e){return new C({cartChangeTracker:this.cartChangeTracker,me:e.me,cart:e.cart,cartItems:e.cartItems,cartPhases:e.cartPhases,activePhasePayment:e.activePhasePayment,shop:e.shop,company:e.company,tcContractFactory:e.tcContractFactory,cartPatchOpFactory:e.cartPatchOpFactory,isBuyerView:e.isBuyerView,validateSend:e.validateSend,service:e.service,locale:e.locale})},_createBiddingActionButtons(e){const s=new m({...e,cartChangeTracker:this.cartChangeTracker,sendMessageHandler:this.sendMessageHandler,maskOnLoad:!1,slot1:new t({value:y.get("readLastMessage"),events:{onClick:this.dispatchEvent.bind(this,D.READ_LAST_MESSAGE)}})});return this.listenTo(s,m.Events.VIEW_UPDATED,this.dispatchEvent.bind(this,D.VIEW_UPDATED)),this.listenTo(s,m.Events.ACTION_STARTED,this.mask.bind(this)),this.listenTo(s,m.Events.PAYMENT_DONE,({wasPaymentSuccessful:t})=>{this.unmask(),this.dispatchEvent(D.PAYMENT_DONE,{cart:e.cart,wasPaymentSuccessful:t})}),this.listenTo(s,m.Events.UPLOAD_PO_LATER,()=>{this.unmask(),this.dispatchEvent(D.UPLOAD_PO_LATER)}),this.listenTo(s,m.Events.ACTION_COMPLETED,({action:t})=>{this.unmask(),this.dispatchEvent(D.ACTION_PERFORMED,{action:t,cart:e.cart})}),s},_createBiddingMessageComponent(e){const t=new g({...e,sendMessageHandler:this.sendMessageHandler,maskOnLoad:!1});return this.listenTo(t,g.Events.START_SENDING,this.mask.bind(this)),this.listenTo(t,g.Events.ON_ERROR,this.unmask.bind(this)),this.listenTo(t,g.Events.MESSAGE_SENDED,()=>{this.unmask(),this.dispatchEvent(D.ACTION_PERFORMED,{action:S.SEND_MESSAGE})}),t}});return E.Events=D,E}),define("DS/MPFBiddingNewMessage/biddingOptions/ButtonsOptions",["UWA/Class/View","DS/UIKIT/Input/Button","DS/MPFServices/ObjectService","DS/MPFBiddingNewMessage/biddingOptions/BiddingOptionsHandler"],function(e,t,s,i){"use strict";const a=Object.freeze({OPTION_SELECTED:"optionSelected"}),n=e.extend({className:"mpf-bidding-options-container",setup:function({biddingOptionsHandler:e}={}){s.requiredOfPrototype(e,i,"options.biddingOptionsHandler must be a BiddingOptionsHandler"),this.biddingOptionsHandler=e},render:function(){const e=this.biddingOptionsHandler.getOptions();if(e.length>1){const t=e.map(e=>this._renderButton(e));this.container.setContent(t),this.container.show()}else this.container.setContent([]),this.container.hide();return this},_renderButton({icon:e,text:s,value:i}){return new t({icon:e,value:s,name:i,events:{onClick:()=>{this.biddingOptionsHandler.hasSelection()&&this.biddingOptionsHandler.getSelection().value===i?this.biddingOptionsHandler.clearSelection():this.biddingOptionsHandler.setSelection({value:i}),this.dispatchEvent(a.OPTION_SELECTED,{icon:e,text:s,value:i})}}})}});return n.Events=a,n}),define("DS/MPFBiddingNewMessage/BiddingMessageContent",["UWA/Core","UWA/Promise","UWA/String","UWA/Class/View","DS/UIKIT/Input/Text","DS/UIKIT/Badge","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyModel","DS/MPFTCContractModel/TCContractModel","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFAmdLazyLoader/AmdLazyLoader","DS/MPFCompanyModel/CompanyHelper","DS/MPFBiddingNewMessage/BiddingCartHelper","DS/MPFBiddingNewMessage/BiddingAddress","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFString/MPFString","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C,y,D,E,M,T,f,F,A,_,I,O,N,v,b){"use strict";const w={PAYMENT_DONE:"paymentDone"},B=i.extend({className:"mpf-bidding-message-content",setup:function(e){e||(e={}),this._checkPrototypes(e),this.service=e.service||o.ENGINEERING,this.buyerView=!0===e.buyerView,this.isDeliveryActive=!0===e.isDeliveryActive,this.buyerType=e.buyerType,this.me=e.me,this.company=e.company,this.shop=e.shop,this.cart=e.cart,this.cartItems=e.cartItems,this.cartPhases=e.cartPhases,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.tcContractFactory=e.tcContractFactory,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.addresses=e.addresses,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.annotations3dView=e.annotations3dView,this.hasPaymentPerPhase=e.hasPaymentPerPhase,this.countries=e.countries,this.locale=e.locale,this.uploadedFiles=e.uploadedFiles||[],this.request=this.cartItems.getRequestItemForService(this.service),this.textInput=this._createTextInput(e.message),this.fileListContainer=this._createFileListContainer(),this.buyerView&&this.isDeliveryActive&&(this.isShipping=!0,this.biddingAddressComponent=new O({buyerView:this.buyerView,buyerType:this.buyerType,me:this.me,company:this.company,addresses:this.addresses,cart:this.cart,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,companyFactory:this.companyFactory,addressFactory:this.addressFactory,countries:this.countries}))},render:function(){const t=[];return e.is(this.biddingAddressComponent)&&this.cart.getState()===l.States.DRAFT&&t.push(this.biddingAddressComponent.render()),Array.prototype.push.apply(t,[this.textInput,this.fileListContainer,this.annotations3dView.render()]),this.container.setContent(t),this},validate:function(e){let t;const s=""!==this.textInput.getValue().trim(),i=this.cart.getState()===l.States.DRAFT&&s,a=e!==N.SEND_REQUEST&&e!==N.SEND_MESSAGE&&e!==N.CANCEL&&e!==N.CANCEL_PHASE;t=i||a||s,e!==N.REJECT_PHASE_DELIVERY&&e!==N.NOTIFY_PHASE_DELIVERY||(t=t&&s);const n=!this.hasPaymentPerPhase||e===N.SEND_MESSAGE||e===N.CANCEL||this.hasPaymentPerPhase&&this.cartPhases.size()>0&&this.cartPhases.validate().isValid();return this.container.toggleClassName("mpf-invalid",!t),t&&n},exportContent:function(){return{message:this.textInput.getValue(),uploadedFiles:this.uploadedFiles}},getSpecificDocuments:function(){let e;return e=this.buyerView?this.uploadedFiles.filter(function(e){return e.docType===F.DocTypes.NDA}):this.uploadedFiles.filter(function(e){return e.docType===F.DocTypes.SALES_CONDITIONS})},getCartPatchOperations:function(s){const i=[];let a;const n=this.getSpecificDocuments();switch(s===N.SEND_REQUEST&&this.cart.getState()===l.States.DRAFT&&(i.push(I.getSubmittedStateCartOperation(this.cart.getShopID(),this.isDeliveryActive,this.isShipping?this.biddingAddressComponent.getSelectedAddress().get("id"):"")),this.isDeliveryActive&&i.push(I.getDeliveryRequestItemOperation(this.cart.get("id"),this.isShipping,this.cart.getShopID())),this.service===o.INNOVATE&&this.request.set([u.Fields.OFFER_ID],this.request.getOfferId()),i.push(I.getSubmittedStateCartItemOperation(this.request))),a=t.resolve(),s){case N.ACCEPT:this.service===o.INNOVATE&&this.cart.isSelfOrder()||i.push(I.getAcceptedStateCartItemOperation(this.request));break;case N.CANCEL:i.push(I.getCancelRequestOperation());break;case N.NOTIFY_WORK_STARTED:this.cartItems.forEach(function(e){i.push(I.getProcessingStateCartItemOperation(e))});break;case N.NOTIFY_SHIPPING:this.cartItems.forEach(e=>{i.push(I.getShippedStateCartItemOperation(e))});break;case N.NOTIFY_READY:this.cartItems.forEach(function(e){i.push(I.getReadyStateCartItemOperation(e))});break;case N.CONFIRM_DELIVERY:this.cartItems.forEach(e=>{i.push(I.getDeliveredStateCartItemOperation(e))});break;case N.PAY:a=this._launchCheckout()}return this.getDocAndAnnotationTimelineOperation(s,i,n),a.then(this._saveContract.bind(this,n)).then(t=>{let s;return e.is(t)&&(s=I.getAddContractOperation(t.get("id"),this.request.get("id"),t.getDocumentType()===M.DOCUMENT_TYPES.NDA?"nda":"custom-tc-seller"),i.push(s)),i})},_launchCheckout:function(){return this.cartPhases.fetchPromise().then(()=>this.cartPhases.isEmpty()?this._launchCheckoutV1():this._launchCheckoutV2())},_launchCheckoutV1:function(){return A.getInstance().get(["DS/MPFModalConfiguratorComponent/CheckoutLauncherFactory"]).then(([e])=>{const t=new e({serviceRequest:this.service,idCart:this.cart.id,linkToBankTransferFAQ:this.linkToBankTransferFAQ,locale:this.locale});return t.whenReady().then(()=>{this.listenTo(t,e.Events.PAYMENT_COMPLETED,this._dispatchPaymentEvent.bind(this)),this.listenTo(t,e.Events.PURCHASE_ORDER_UPLOADED,this._dispatchPaymentEvent.bind(this)),this.listenTo(t,e.Events.PAYMENT_DECLINED,this._dispatchPaymentEvent.bind(this)),t.show()})})},async _launchCheckoutV2(){const e=this.cart.id,[t,s]=await A.getInstance().get(["DS/MPFCheckout/CheckoutV2Factory","DS/MPFCheckout/CheckoutV2"]),i=await t.from({service:this.service,locale:this.locale,cartId:e});this.listenTo(i,s.Events.PAYMENT_DONE,this._dispatchPaymentEvent.bind(this)),i.inject(document.body).render().show()},getDocAndAnnotationTimelineOperation:function(t,s,i){const a=[];let n,r;this.uploadedFiles.filter(function(e){return e.docType===F.DocTypes.OTHER}).forEach(e=>{a.push(e.docID),s.push(I.getAddBiddingDocOperation(this.request.get("id"),e.docID))}),e.is(this.annotations3dView.getCartPatchOperations,"function")&&(r=(n=this.annotations3dView.getCartPatchOperations()).filter(function(e){return e.getOperation()===m.Operations.ADD&&"/bidding-documents"===e.getPath()}).map(function(e){return e.getValue().DocumentID}),Array.prototype.push.apply(a,r),Array.prototype.push.apply(s,n));const o=this._getTimelineMessageOperation(t,a,i);return o&&s.push(o),s},_getTimelineMessageOperation:function(e,t,s){let i=this.textInput.getValue();const a=e===N.PAY,n=""===i.trim(),r=0===t.length;if(!(a&&n&&r))return i=this._deleteUnauthorizedCharacters(i),s.length>0&&(this.buyerView?i+="\n\n"+b.get("ndaAdded"):i+="\n\n"+b.get("specificSalesConditionAdded")),I.getAddMessageOperation(this.buyerView,t,i,this.cart)},_deleteUnauthorizedCharacters:function(e){const t=new v(e).hideEmailAddresses().escapeHTML();return t.wasEmailReplaced()?t.toString()+"\n\n"+b.get("inappropriateContent"):t.toString()},_dispatchPaymentEvent:function(e){this.dispatchEvent(w.PAYMENT_DONE,e)},_saveContract:function(s){let i,a,n;return e.is(s)&&s.length>0?((i=s[0]).docType===F.DocTypes.NDA&&(n={consumerID:this.shop.getOwner(),documentID:i.docID,supplierID:this.buyerType===c.COMPANY?this.company.get("id"):this.me.get("id")}),i.docType===F.DocTypes.SALES_CONDITIONS&&(n={consumerID:this.cart.getOwnerId(),documentID:i.docID,supplierID:this.me.getCompanyId()}),(a=this.tcContractFactory.createModel(C.Types.EXISTING_DOCUMENT,n)).savePromise()):t.resolve()},displayAddressChoices:function(e,t){this.isShipping=e,this.biddingAddressComponent.manageAddressChoices(e)},addDocument:function(e){e.docType!==F.DocTypes.NDA&&e.docType!==F.DocTypes.SALES_CONDITIONS||this._deleteDocOfSameType(e),this.uploadedFiles.push(e),this.fileListContainer.setContent(this.uploadedFiles.map(this.createBadge.bind(this)))},createBadge:function(e){const t=this;return new n({closable:!0,content:e.docName,icon:"doc",events:{onClose:function(){t._deleteFileWithName(e.docName),this.destroy()}}})},_deleteDocOfSameType:function(e){for(let t=this.uploadedFiles.length-1;t>=0;t--)this.uploadedFiles[t].docType===e.docType&&this.uploadedFiles.splice(t,1)},_deleteFileWithName:function(e){this.uploadedFiles=this.uploadedFiles.filter(function(t){return t.docName!==e})},_createFileListContainer:function(){return e.createElement("div",{class:"mpf-file-list",html:this.uploadedFiles.map(e=>this.createBadge(e))})},_createTextInput:function(e){const t=this.cart.getState()===l.States.DRAFT?b.get("typeMessage")+"*":b.get("typeMessage");return new a({placeholder:t,rows:4,multiline:!0,value:e||"",events:{onKeyDown:this.validate.bind(this)}})},setMessage:function(e){this.textInput.setValue(e)},_checkPrototypes:function(e){r.requiredOfPrototype(e.me,h,"options.me must be a PersonModel"),r.requiredOfPrototype(e.cart,l,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartItems,p,"options.cartItems must be a CartItemCollection"),r.requiredOfPrototype(e.tcContractFactory,C,"options.tcContractFactory must be a TCContractFactory"),r.requiredOfPrototype(e.cartItemFactory,P,"options.cartItemFactory must be a CartItemFactory"),r.requiredOfPrototype(e.cartFactory,g,"options.cartFactory must be a CartFactory"),this.buyerView&&this.isDeliveryActive&&(r.requiredOfPrototype(e.companyFactory,y,"options.companyFactory must be a CompanyFactory"),r.requiredOfPrototype(e.addressFactory,D,"options.addressFactory must be an AddressFactory"),r.requiredOfPrototype(e.addresses,T,"options.addresses must be an AddressCollection"),r.requiredOfPrototype(e.countries,f,"options.countries must be a CountryCollection")),this.buyerView&&this.buyerType===c.COMPANY&&r.requiredOfPrototype(e.company,E,"options.company must be a CompanyModel"),this.buyerView&&F.isBuyerAllowedToUploadNDA(this.cart,this.request)&&r.requiredOfPrototype(e.shop,d,"options.shop must be a ShopModel")}});return B.Events=Object.freeze(w),B}),define("DS/MPFBiddingNewMessage/BiddingNewMessage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCompanyModel/CompanyModel","DS/MPFCartModel/CartModel","DS/MPFCartModel/CartItemModel","DS/MPFCartModel/CartItemCollection","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPhaseModel/CartPhaseCollection","DS/MPFCartModel/CartPatchArray","DS/MPFCartModel/CartPatchOperation","DS/MPFCartModel/CartFactory","DS/MPFCartModel/CartItemFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFOfferModel/OfferCollection","DS/MPFTCContractModel/TCContractModel","DS/MPFBiddingNewMessage/BiddingActions","DS/MPFBiddingNewMessage/biddingOptions/BiddingOptionsHandler","DS/MPFBiddingNewMessage/biddingOptions/ButtonsOptions","DS/MPFBiddingNewMessage/BiddingDeliveryMethod","DS/MPFBiddingNewMessage/BiddingUploadFileComponent","DS/MPFBiddingNewMessage/BiddingMessageContent","DS/MPFBiddingNewMessage/CancelConfirmationModal","DS/MPFCartPhaseComponent/CartPhaseCreator","DS/MPFCartPhaseComponent/CartPhaseHelper","DS/MPFUtils/MPFUtils","DS/MPFView/EmptyView","DS/MPFCartModel/CartDuplicateOperation","i18n!DS/MPFBiddingNewMessage/assets/nls/BiddingNewMessage","css!DS/MPFBiddingNewMessage/MPFBiddingNewMessage"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C,y,D,E,M,T,f,F,A,_,I,O,N,v,b,w,B,R,U,k,L,V,x,H){"use strict";const q=Object.freeze({PAYMENT_DONE:"paymentDone",ACTION_PERFORMED:"actionPerformed",OPTION_SELECTED:"optionSelected",PHASE_CANCELLED:"phaseCancelled",CART_DUPLICATED:"cartDuplicated"}),Y=s.extend({tagName:"div",className:"mpf-bidding-new-message",setup:function(e={}){this._checkPrototypes(e),this.isDeliveryActive=!0===e.isDeliveryActive,this.buyerView=!0===e.buyerView,this.buyerType=e.buyerType,this.cartFactory=e.cartFactory,this.cartItemFactory=e.cartItemFactory,this.addressFactory=e.addressFactory,this.companyFactory=e.companyFactory,this.tcDocumentFactory=e.tcDocumentFactory,this.tcContractFactory=e.tcContractFactory,this.cartPhaseFactory=e.cartPhaseFactory,this.cart=e.cart,this.cartItems=e.cartItems,this.cartPhases=e.cartPhases,this.activePhasePayment=e.activePhasePayment,this.me=e.me,this.company=e.company,this.shop=e.shop,this.offers=e.offers,this.multibiddingShopIds=e.multibiddingShopIds||[],this.cartDuplicateOperationDataProxy=e.cartDuplicateOperationDataProxy,this.addresses=e.addresses,this.countries=e.countries,this.service=e.service||o.INNOVATE,this.onMenuRefresh=e.onMenuRefresh||L.doNothing,this.validateSend=e.validateSend||L.alwaysTrue,this.buyerTermsOfUseComponent=e.buyerTermsOfUseComponent,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.annotations3dView=e.annotations3dView||V.getInstance(),this.hasPaymentPerPhase=!0===e.hasPaymentPerPhase||!0===e.hasPayementPerPhase,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.getPhaseAttributesUpdateForAction=e.getPhaseAttributesUpdateForAction||L.doNothing,this.message=e.message,this.uploadedFiles=e.uploadedFiles,this.nda=e.nda,this.locale=e.locale,this.request=this.cartItems.getRequestItemForService(this.service),this.request.clearPendingChanges(),this.biddingOptionsHandler=this._createBiddingOptionsHandler({selection:e.selectedOption}),this.sendButton=this._createSendButton(),this.messageLabelContainer=this._createMessageLabelContainer(),this.biddingDeliveryMethodComponent=this._createBiddingDeliveryMethodComponent(),this.messageContentComponent=this._createBiddingMessageComponent(),this.uploadFileComponent=this._createUploadFileComponent(),this.optionsMenu=this._createOptionsMenuComponent(),this.phaseCreator=this._createPhaseCreator(),this._initListeners(),i.subscribe("MPPurchaseOrderUploaded",this._onPaymentDone.bind(this))},render:function(){if(this.cart.getState()===u.States.CANCELLED)return this.container.setContent(),this;const t=[this.optionsMenu.render()];this.isDeliveryActive&&t.push(this.biddingDeliveryMethodComponent.render()),Array.prototype.push.apply(t,[this.messageLabelContainer,this.messageContentComponent.render(),this.phaseCreator.render()]),e.is(this.buyerTermsOfUseComponent)&&t.push(this.buyerTermsOfUseComponent.render());const s=e.createElement("div",{class:"mpf-bidding-buttons",html:[this.sendButton,this.uploadFileComponent.render()]});t.push(s);const i=this.getElement(".mask");i&&t.push(i),this.container.setContent(t);const a=this.biddingOptionsHandler.getSelection();return this.biddingOptionsHandler.getOptions().length>1&&!a&&(this.messageLabelContainer.hide(),this.messageContentComponent.hide(),this.uploadFileComponent.hide(),this.sendButton.hide()),a&&"accept"===a.value&&this.cartPhases.size()>0||this.phaseCreator.hide(),this},getCartItems:function(){return this.cartItems},exportContent:function(){return Object.assign({selectedOption:this.biddingOptionsHandler.getSelection()},this.messageContentComponent.exportContent())},destroy:function(){this.stopListening(),i.unsubscribe("MPPurchaseOrderUploaded"),this.biddingDeliveryMethodComponent&&this.biddingDeliveryMethodComponent.destroy(),this.uploadFileComponent.destroy(),this.messageContentComponent.destroy(),this.optionsMenu.destroy(),this.phaseCreator.destroy(),this.cart=null,this.cartItems=null,this.cartPhases=null,this.activePhasePayment=null,this.me=null,this.company=null,this.shop=null,this.addresses=null,this.countries=null,this._parent(),this.container=null},_performSendMessageAction:function(e){let s;switch(e){case O.SEND_MESSAGE:s=this._patchCart(e).then(()=>{this.dispatchEvent(q.ACTION_PERFORMED,{action:e})});break;case O.CANCEL:s=t.cast(this._displayCancelConfirmationModal({isPhaseCancel:!1}));break;case O.CANCEL_PHASE:s=t.cast(this._displayCancelConfirmationModal({isPhaseCancel:!0,phase:this.cartPhases.getActivePhase()}));break;case O.ACCEPT:s=this._accept(e);break;case O.ACCEPT_PHASE:s=this._updatePhasePatchAndRefresh(g.States.ACCEPTED,e);break;case O.NOTIFY_PHASE_WORK_STARTED:s=this._updatePhasePatchAndRefresh(g.States.PROCESSING,e);break;case O.NOTIFY_PHASE_DELIVERY:s=this._updatePhasePatchAndRefresh(g.States.READY,e,!0);break;case O.ACCEPT_PHASE_DELIVERY:s=this._updatePhasePatchAndRefresh(g.States.DELIVERED,e,!0);break;case O.REJECT_PHASE_DELIVERY:s=this._updatePhasePatchAndRefresh(g.States.PROCESSING,e);break;default:{const t=this._getPatchOperationFromExternalAttributeUpdate(e);s=this._patchCart(e,t).then(()=>{this.dispatchEvent(q.ACTION_PERFORMED,{action:e})});break}}return s},_sendMessage:function(){const t=this.biddingOptionsHandler.getSelection(),s=e.is(t)?t.value:"";return n.mask(this.container),this.deleteErrorMessage(),Promise.all([this.messageContentComponent.validate(s),this.validateSend({action:s,cart:this.cart,cartItems:this.cartItems})]).then(e=>{if(e[0]&&("boolean"!=typeof e[1]||!1!==e[1]))return this._performSendMessageAction(s);this.hasPaymentPerPhase&&this.phaseCreator.validate()}).catch(e=>{console.error(e),this._displayErrorMsg(e,s)}).finally(()=>{n.unmask(this.container)})},_accept:function(){let e;if(this.hasPaymentPerPhase){if(null===(e=this.phaseCreator.getCartPatchOperations()))return}else e=new S;const t=this._getPatchOperationFromExternalAttributeUpdate(O.ACCEPT);return e.add(t),this.messageContentComponent.getCartPatchOperations(O.ACCEPT).then(t=>{if(e.addAll(t),e.length()>0)return this.cart.megaPatch(e)}).then(()=>this.hasPaymentPerPhase&&this._refreshPhasesAndPayment()).then(()=>{this._refresh(),this._refreshTimeline(),this.dispatchEvent(q.ACTION_PERFORMED,{action:O.ACCEPT})})},_updatePhasePatchAndRefresh:function(e,t,s){const i=this.cartPhases.getActivePhase(),a=new S;return a.add(k.getPhaseStateUpdateOperation(i,e)),a.addAll(this._getDocAndAnnotationTimelineOperation(t)),a.add(this._getPatchOperationFromExternalAttributeUpdate(t)),this.cart.megaPatch(a).then(this.cartPhases.fetchPromise.bind(this.cartPhases)).then(()=>{s&&this._refreshNotices(),this._refreshTimeline(),this._refresh(),this.dispatchEvent(q.ACTION_PERFORMED,{action:t})})},_getDocAndAnnotationTimelineOperation:function(e){return this.messageContentComponent.getDocAndAnnotationTimelineOperation(e,[],this.messageContentComponent.getSpecificDocuments())},_megaPatchOnCart:function(e){const t=new S;return t.addAll(e),this.cart.megaPatch(t)},_patchCart:function(e,t){t=t||new S;const s=this.cart.getState()===u.States.DRAFT;return this._saveBuyerTCs().then(this.messageContentComponent.getCartPatchOperations.bind(this.messageContentComponent,e)).then(e=>{if(t.addAll(e),t.length()>0)return this.cart.megaPatch(t)}).then(this._duplicateCarts.bind(this,s)).then(this._refresh.bind(this)).then(this._patchToDeliveryStateIfReady.bind(this)).then(this._refreshTimeline.bind(this)).catch(this._displayErrorMsg.bind(this))},_getPatchOperationFromExternalAttributeUpdate:function(e){const t=this.service===o.INNOVATE,s=e===O.NOTIFY_PHASE_DELIVERY;if(this.hasPaymentPerPhase&&(!t||!s)){const t=this.getPhaseAttributesUpdateForAction({action:e});if(t){const e=this.cartPhases.getActivePhase();return k.getModifyPhaseOperation(e,t)}}},_duplicateCarts:function(e){if(e&&this.multibiddingShopIds.length>0){const e=new x({cartId:this.cart.id,dataProxy:this.cartDuplicateOperationDataProxy});return this.multibiddingShopIds.forEach(t=>{t!==this.cart.shopId&&e.addShop({shopId:t})}),e.execute().then(()=>{this.dispatchEvent(q.CART_DUPLICATED)})}return Promise.resolve()},_displayCancelConfirmationModal:function({isPhaseCancel:e,phase:t}){const s=new R;return this.container.addContent(s.render({isPhaseCancel:e,phase:t})),s.show(),this.listenTo(s,R.Events.CONFIRMED,()=>{e?this._onPhaseCancellationConfirmation(t,s):this._cancelCart(s)}),s},_cancelCart:function(e){return n.mask.bind(n,this.container),this._patchCart(O.CANCEL).then(function(){e.hide(),e.destroy()}).finally(n.unmask.bind(n,this.container))},_onPhaseCancellationConfirmation:function(e,t){n.mask(this.container),e.updateState(g.States.DELETED).then(this._patchCart.bind(this)).then(()=>{t.hide(),t.destroy(),n.unmask(this.container)}).then(this.dispatchEvent.bind(this,q.PHASE_CANCELLED)).catch(()=>{t.setLoading(!1),n.unmask(this.container)})},_displayErrorMsg:function(t,s){let i,a=this.container.getElement(".mpf-error");t&&console.error(t),i=e.is(t,"string")&&t.length>0?t:this.cart.getState()===u.States.DRAFT?H.get("requestCannotBeSend"):e.is(s)&&s===O.NOTIFY_PHASE_DELIVERY&&!this.cartPhases.getActivePhase().hasDocuments()?H.get("noDeliverables"):H.get("messageCannotBeSend"),e.is(a)?a.setContent(i):(a=e.createElement("div",{class:"mpf-error",text:i}),this.container.addContent(a))},deleteErrorMessage:function(){const e=this.container.getElement(".mpf-error");e&&e.setContent("")},_refreshTimeline:function(){i.publish("MPCartTimeline",{event:"refresh",cartId:this.cart.id})},_refreshNotices:function(){i.publish("MPFDeferredPaymentNotices",{event:"update"})},_saveBuyerTCs:function(){return e.is(this.buyerTermsOfUseComponent)?this.buyerTermsOfUseComponent.isChecked()?this.buyerTermsOfUseComponent.createContract():Promise.reject(new Error("TCs must be signed")):Promise.resolve()},_patchToDeliveryStateIfReady:function(){const e=new S;return this.cart.getState()===u.States.PROCESSING&&this.request.getState()===p.States.ready?(e.add(new C(C.Operations.modify,"/cart-items/"+this.request.get("id"),{currentState:p.STATUS.delivered})),this.cart.megaPatch(e).then(this._refresh.bind(this))):Promise.resolve()},_refresh:function(){this.cartItems.reset(this.cart.getItems()),this.cartItems.setParentResourceId(this.cart.get("id")),this.request=this.cartItems.getRequestItemForService(this.service),this.request.clearPendingChanges(),this.message="",this.uploadedFiles=[],this.biddingOptionsHandler.reset(),this.sendButton=this._createSendButton(),this.messageLabelContainer=this._createMessageLabelContainer(),this.biddingDeliveryMethodComponent=this._createBiddingDeliveryMethodComponent(),this.messageContentComponent=this._createBiddingMessageComponent(),this.uploadFileComponent=this._createUploadFileComponent(),this.optionsMenu=this._createOptionsMenuComponent(),e.is(this.buyerTermsOfUseComponent)&&(this.buyerTermsOfUseComponent.destroy(),this.buyerTermsOfUseComponent=null),this._initListeners(),this.render()},_refreshPhases:function(){if(this.hasPaymentPerPhase)return this.cartPhases.fetchPromise()},_refreshPhasesAndPayment:function(){return this.hasPaymentPerPhase?this.cartPhases.fetchPromise({expand:[P.Expands.DOCUMENTS]}).then(()=>{const e=this.cartPhases.getActivePhase();return this.activePhasePayment.clear({silent:!0}),e?(this.activePhasePayment.setParentResourceId(e.id),this.activePhasePayment.fetchPromise()):(this.activePhasePayment.setParentResourceId(null),Promise.resolve())}):Promise.resolve()},_onNewOptionSelected:function(){const e=this.biddingOptionsHandler.getSelection();if(e){const t=e.value===O.SEND_MESSAGE?H.get("send"):e.text;this.sendButton.setValue(t),this.messageLabelContainer.show(),this.messageContentComponent.show(),this.uploadFileComponent.show(),this.sendButton.show(),this.phaseCreator.hide(),this.hasPaymentPerPhase&&e.value===O.ACCEPT&&(this.phaseCreator.resetAlert(),this.phaseCreator.show()),this.messageContentComponent.container.removeClassName("mpf-invalid"),this.dispatchEvent(q.OPTION_SELECTED,e.value)}else this.messageLabelContainer.hide(),this.messageContentComponent.hide(),this.uploadFileComponent.hide(),this.sendButton.hide(),this.phaseCreator.hide()},_onNewDocument:function(t){this.messageContentComponent.addDocument(t);const s=this.container.getElement(".mpf-error");e.is(s)&&s.destroy()},_createMessageLabelContainer:function(){return e.createElement("div",{class:"mpf-label-message",text:H.get("message")})},_createSendButton:function(){let t;const s=this.biddingOptionsHandler.getSelection();return t=s?s.value===O.SEND_MESSAGE?H.get("send"):s.text:this.cart.getState()===u.States.DRAFT?H.get("sendForQuote"):H.get("send"),new a({className:"primary mpf-send-button",disabled:e.is(this.buyerTermsOfUseComponent),value:t,events:{onClick:this._sendMessage.bind(this)}})},_initListeners:function(){this.isDeliveryActive&&this.listenTo(this.biddingDeliveryMethodComponent,b.Events.DELIVERY_METHOD_CHANGED,this.messageContentComponent.displayAddressChoices.bind(this.messageContentComponent)),this.listenTo(this.uploadFileComponent,w.Events.DOCUMENT_SAVED,this._onNewDocument.bind(this)),this.listenTo(this.uploadFileComponent,w.Events.DOCUMENT_NOT_SAVED,this._displayErrorMsg.bind(this)),this.listenTo(this.optionsMenu,v.Events.OPTION_SELECTED,this._onNewOptionSelected.bind(this)),this.listenTo(this.messageContentComponent,B.Events.PAYMENT_DONE,this._onPaymentDone.bind(this)),e.is(this.buyerTermsOfUseComponent)&&this.listenTo(this.buyerTermsOfUseComponent.checkbox,"valueChanged",()=>{this.sendButton.setDisabled(!this.buyerTermsOfUseComponent.isChecked())})},_onPaymentDone:function(e){this.biddingOptionsHandler.reset(),n.mask(this.container),this.cart.fetchPromise({expand:[u.Expands.CART_ITEMS]}).then(this._refreshPhasesAndPayment.bind(this)).catch(this._displayErrorMsg.bind(this)).finally(()=>{this._refresh(),this._refreshTimeline(),this._refreshNotices(),n.unmask(this.container),this.dispatchEvent(q.PAYMENT_DONE)})},_createOptionsMenuComponent:function(){const e=new v({biddingOptionsHandler:this.biddingOptionsHandler});return this.onMenuRefresh(e),e},_createUploadFileComponent:function(){return new w({buyerView:this.buyerView,tcDocumentFactory:this.tcDocumentFactory,cart:this.cart,cartItem:this.request,maxFileSize:this.maxFileSize,maxSpecificFileSize:this.maxSpecificFileSize,nda:this.nda})},_createBiddingMessageComponent:function(){return new B({service:this.service,locale:this.locale,buyerView:this.buyerView,buyerType:this.buyerType,isDeliveryActive:this.isDeliveryActive,me:this.me,company:this.company,shop:this.shop,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,tcContractFactory:this.tcContractFactory,addressFactory:this.addressFactory,companyFactory:this.companyFactory,addresses:this.addresses,countries:this.countries,linkToBankTransferFAQ:this.linkToBankTransferFAQ,annotations3dView:this.annotations3dView,hasPaymentPerPhase:this.hasPaymentPerPhase,message:this.message,uploadedFiles:this.uploadedFiles})},setMessage:function(e){this.messageContentComponent.setMessage(e)},_createBiddingDeliveryMethodComponent:function(){if(this.isDeliveryActive)return new b({cart:this.cart})},_createPhaseCreator:function(){let e;return e=this.hasPaymentPerPhase?new U({cart:this.cart,cartPhases:this.cartPhases,cartPhaseFactory:this.cartPhaseFactory,offers:this.offers,service:this.service}):V.getInstance()},_createBiddingOptionsHandler(){return new N({cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,isBuyerView:this.buyerView,service:this.service})},_checkPrototypes:function(e){r.requiredOfPrototype(e.cart,u,"options.cart must be a CartModel"),r.requiredOfPrototype(e.cartItems,m,"options.cartItems must be a CartItemCollection"),r.requiredOfPrototype(e.me,h,"options.me must be a PersonModel"),r.requiredOfPrototype(e.tcContractFactory,f,"options.tcContractFactory must be a TCContractFactory"),r.requiredOfPrototype(e.tcDocumentFactory,T,"options.tcDocumentFactory must be a TCDocumentFactory"),r.requiredOfPrototype(e.cartItemFactory,D,"options.cartItemFactory must be a CartItemFactory"),r.requiredOfPrototype(e.cartFactory,y,"options.cartFactory must be a CartFactory"),this.buyerView&&(this.isDeliveryActive&&(r.requiredOfPrototype(e.companyFactory,E,"options.companyFactory must be a CompanyFactory"),r.requiredOfPrototype(e.addressFactory,M,"options.addressFactory must be an AddressFactory"),r.requiredOfPrototype(e.addresses,F,"options.addresses must be an AddressCollection"),r.requiredOfPrototype(e.countries,A,"options.countries must be a CountryCollection")),this.buyerType===c.COMPANY&&r.requiredOfPrototype(e.company,l,"options.company must be a CompanyModel"),w.isBuyerAllowedToUploadNDA(this.cart,this.request)&&r.requiredOfPrototype(e.shop,d,"options.shop must be a ShopModel"),this.cart.getState()===u.States.SUBMITTED&&r.requiredOfPrototype(e.nda,I,"options.nda must be a TcContractModel")),this.service===o.INNOVATE&&this.cartItems.getRequestItemForService(this.service).isInnovateBusinessExperience()&&!this.cart.isSelfOrder()&&r.requiredOfPrototype(e.offers,_,"options.offers must be a OfferCollection")}});return Y.Events=q,Y}),define("DS/MPFBiddingNewMessage/BiddingNewMessageFactory",["UWA/Core","UWA/Class","UWA/Promise","DS/MPFConnector/Connector","DS/MPFConnector/MarketplaceConnector","DS/MPFServices/MarketplaceServices","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFTcContractComponent/TermsOfUseOrderFactory","DS/MPFPersonModel/PersonFactory","DS/MPFShopModel/ShopFactory","DS/MPFCartModel/CartFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFOfferModel/OfferFactory","DS/MPFBuyer/BuyerType","DS/MPFCompanyModel/CompanyHelper","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseCollection","DS/MPFBiddingNewMessage/BiddingNewMessage","DS/MPFCartModel/CartDuplicateOperationDataProxy","DS/MPFBiddingNewMessage/BiddingUploadFileComponent"],function(e,t,s,i,a,n,r,o,c,h,d,l,u,p,m,g,P,S,C,y,D,E){"use strict";const M=t.extend({init:function(e={}){this._storeProperties(e)},getBiddingNewMessageComponent:function(){return this._getConnector().then(this._initFactories.bind(this)).then(this._fetchMeCart.bind(this)).then(this._initCartItems.bind(this)).then(this._fetchCartPhases.bind(this)).then(this._fetchActivePhasePayment.bind(this)).then(this._fetchShopAndOffers.bind(this)).then(this._fetchCompany.bind(this)).then(this._fetchAddressesAndCountries.bind(this)).then(this._getTCsForBuyer.bind(this)).then(this._getNda.bind(this)).then(this._createAnnotations3dView.bind(this)).then(this._buildBiddingNewMessageComponent.bind(this))},exportState:function(e){return Object.assign({service:this.service,connector:this.connector,buyerView:this.buyerView,isDeliveryActive:this.isDeliveryActive,cartID:this.cartID,shopID:this.shopID,onMenuRefresh:this.onMenuRefresh,validateSend:this.validateSend,linkToBankTransferFAQ:this.linkToBankTransferFAQ,annotations3dViewFactory:this.annotations3dViewFactory,maxFileSize:this.maxFileSize,hasPaymentPerPhase:this.hasPaymentPerPhase,getPhaseAttributesUpdateForAction:this.getPhaseAttributesUpdateForAction,unsavedPhases:this.cartPhases.filter(function(e){return e.isNew()})},e.exportContent())},fromExportedState:function(e){return this._storeProperties(e),this.getBiddingNewMessageComponent()},_storeProperties:function(e){this.service=e.service||n.ENGINEERING,this.locale=e.locale,this.connector=e.connector,this.buyerView=!0===e.buyerView,this.isDeliveryActive=!0===e.isDeliveryActive,this.cartID=e.cartID,this.shopID=e.shopID,this.multibiddingShopIds=e.multibiddingShopIds,this.onMenuRefresh=e.onMenuRefresh,this.validateSend=e.validateSend,this.linkToBankTransferFAQ=e.linkToBankTransferFAQ,this.annotations3dViewFactory=e.annotations3dViewFactory,this.maxFileSize=e.maxFileSize,this.maxSpecificFileSize=e.maxSpecificFileSize,this.hasPaymentPerPhase=!0===e.hasPaymentPerPhase||!0===e.hasPayementPerPhase,this.getPhaseAttributesUpdateForAction=e.getPhaseAttributesUpdateForAction,this.message=e.message,this.uploadedFiles=e.uploadedFiles,this.selectedOption=e.selectedOption,this.unsavedPhases=e.unsavedPhases},_getConnector:function(){var e=this;return Object.prototype.isPrototypeOf.call(i.prototype,this.connector)?s.resolve(this.connector):a.fetchPromise(this.options).then(function(t){e.connector=t})},_initFactories:function(){var e,t=this;return this.factorySupplier=r.getInstance(this.connector),e=[this.factorySupplier.getFactory(r.Types.PERSON),this.factorySupplier.getFactory(r.Types.SHOP),this.factorySupplier.getFactory(r.Types.CART),this.factorySupplier.getFactory(r.Types.CART_ITEM),this.factorySupplier.getFactory(r.Types.TC_DOCUMENT),this.factorySupplier.getFactory(r.Types.TC_CONTRACT),this.factorySupplier.getFactory(r.Types.CART_PHASE),this.factorySupplier.getFactory(r.Types.CART_PAYMENT),this.factorySupplier.getFactory(r.Types.OFFER)],this.isDeliveryActive&&(e.push(this.factorySupplier.getFactory(r.Types.ADDRESS)),e.push(this.factorySupplier.getFactory(r.Types.COUNTRY))),s.all(e).then(function(e){if(t.personFactory=e[0],t.shopFactory=e[1],t.cartFactory=e[2],t.cartItemFactory=e[3],t.tcDocumentFactory=e[4],t.tcContractFactory=e[5],t.cartPhaseFactory=e[6],t.cartPaymentFactory=e[7],t.offerFactory=e[8],t.isDeliveryActive)return t.addressFactory=e[9],t.countryFactory=e[10],t.addressFactory.whenReady()})},_fetchMeCart:function(){return this.me=this.personFactory.createModel(c.Types.ME),this.cart=this.cartFactory.createModel(d.Types.CART,{id:this.cartID}),s.all([this.me.fetchPromise(),this.cart.fetchPromise({expand:["cart-items"]})])},async _fetchShopAndOffers(){const e=this.cartItems.getRequestItemForService(this.service);let t=Promise.resolve(),s=Promise.resolve();return this.buyerView&&E.isBuyerAllowedToUploadNDA(this.cart,e)&&(this.shop=this.shopFactory.createModel(h.Types.SHOP,{id:this.shopID}),t=this.shop.fetchPromise({expand:[]})),this.service===n.INNOVATE&&e.isInnovateBusinessExperience()&&!this.cart.isSelfOrder()&&(this.offers=this.offerFactory.createCollection(m.Types.SHOP_OFFERS,[],{parentResourceId:this.shopID}),s=this.offers.fetchPromise()),Promise.all([t,s])},_fetchShop:function(){const e=this.cartItems.getRequestItemForService(this.service);return this.buyerView&&E.isBuyerAllowedToUploadNDA(this.cart,e)?(this.shop=this.shopFactory.createModel(h.Types.SHOP,{id:this.shopID}),this.shop.fetchPromise({expand:[]})):s.resolve()},_fetchCompany:function(){var t=this;const s=this.cartItems.getRequestItemForService(this.service);if(this.buyerView&&(this.isDeliveryActive||E.isBuyerAllowedToUploadNDA(this.cart,s)))return this.factorySupplier.getFactory(r.Types.COMPANY).then(function(e){return t.companyFactory=e,t.companyFactory.addressFactory=t.addressFactory,t.companyFactory.whenReady()}).then(function(){if(t.company=P.getCompanyFromPerson(t.me,t.companyFactory),e.is(t.company))return t.buyerType=g.COMPANY,t.company.fetchPromise()})},_fetchAddressesAndCountries:function(){if(this.buyerView&&this.isDeliveryActive)return this.countries=this.countryFactory.createCollection(),this.buyerType===g.COMPANY?(this.addresses=this.company.addresses,this.countries.fetchPromise()):(this.addresses=this.addressFactory.createCollection("me"),this.me.addresses=this.addresses,s.all([this.addresses.fetchPromise(),this.countries.fetchPromise()]))},_initCartItems:function(){return this.cartItems=this.cartItemFactory.createCollection("",this.cart.getItems()),this.cartItems.setParentResourceId(this.cartID),this.cartItems.forEach(e=>e.clearPendingChanges()),this.cartItems},_fetchCartPhases:function(){var e=this;return this.cartPhases=this.cartPhaseFactory.createCollection(l.Types.CART_CART_PHASE),this.cartPhases.setParentResourceId(this.cart.id),this.cartPhases.fetchPromise({expand:[C.Expands.DOCUMENTS]}).then(function(){if(Array.isArray(e.unsavedPhases))for(var t=0;t<e.unsavedPhases.length;t++){var s=e.unsavedPhases[t];s.getNumber()>e.cartPhases.size()&&e.cartPhases.push(s)}})},_fetchActivePhasePayment:function(){var e,t;return t=this.cartPhases.getActivePhase(),this.activePhasePayment=this.cartPaymentFactory.createModel(u.Types.CART_PHASE_CART_PAYMENT),t&&!t.isNew()?(this.activePhasePayment.setParentResourceId(t.id),e=this.activePhasePayment.fetchPromise()):e=s.resolve(),e},_getTCsForBuyer:function(){var e=this;return this.buyerView&&this.cart.getState()===S.States.DRAFT?new o({connector:this.connector,buyer:this.me,callback:function(){this.dispatchEvent("valueChanged")}}).displayTermsOfUse().then(function(t){e.buyerTermsOfUseComponent=t}):s.resolve()},_getNda:function(){if(this.buyerView&&this.cart.getState()===S.States.SUBMITTED)return this.nda=this.tcContractFactory.createModel(p.Types.NDA),this.nda.setParentResourceId(this.cartID),this.nda.fetchPromise()},_createAnnotations3dView:function(){e.is(this.annotations3dViewFactory,"function")&&(this.annotations3dView=this.annotations3dViewFactory({cart:this.cart,cartItems:this.cartItems}))},_buildBiddingNewMessageComponent:function(){return new y({service:this.service,locale:this.locale,isDeliveryActive:this.isDeliveryActive,buyerView:this.buyerView,buyerType:this.buyerType,cartFactory:this.cartFactory,cartItemFactory:this.cartItemFactory,addressFactory:this.addressFactory,companyFactory:this.companyFactory,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,cartPhaseFactory:this.cartPhaseFactory,me:this.me,company:this.company,shop:this.shop,offers:this.offers,addresses:this.addresses,countries:this.countries,cart:this.cart,cartItems:this.cartItems,cartPhases:this.cartPhases,activePhasePayment:this.activePhasePayment,onMenuRefresh:this.onMenuRefresh,validateSend:this.validateSend,buyerTermsOfUseComponent:this.buyerTermsOfUseComponent,linkToBankTransferFAQ:this.linkToBankTransferFAQ,annotations3dView:this.annotations3dView,multibiddingShops:this.multibiddingShops,cartDuplicateOperationDataProxy:new D(this.connector),hasPaymentPerPhase:this.hasPaymentPerPhase,maxFileSize:this.maxFileSize,maxSpecificFileSize:this.maxSpecificFileSize,getPhaseAttributesUpdateForAction:this.getPhaseAttributesUpdateForAction,message:this.message,uploadedFiles:this.uploadedFiles,selectedOption:this.selectedOption,nda:this.nda})}});return M.from=function(e){return new M(e).getBiddingNewMessageComponent()},M});