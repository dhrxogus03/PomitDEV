define("DS/DELWKOIndexServices/DELWKOIndexParser",["UWA/Core","UWA/Class","DS/DELPPWIndexServices_FD02/IndexParserNode","DS/DELPPWIndexServices_FD02/IndexParserProgressiveNode","DS/DELPPWLoggerModel_FD02/LoggerUtils","DS/DELWKODicoServices/DELWKODicoUtils"],function(e,t,n,i,r,a){"use strict";return t.singleton({name:"DELWKOIndexParser",_indexMapping:null,init:function(e){e=e||{},this._parent(e)},setIndexMapping:function(e){this._indexMapping=e},translateAttributeToPredicate:function(t,n){var i,r,s=[];if(e.is(this._indexMapping)){switch(i=(n=n||{}).type||"entity"){case"entity":r=this._indexMapping.IndexMapping.Entity.Key;break;case"relation":r=this._indexMapping.IndexMapping.Relation.Key}return t.forEach(function(e){var t=!1;r.forEach(function(n){n.database===e&&-1===s.indexOf(n.index)&&(s.push(n.index),t=!0)}),t||a.getDicoTypeIndexesForAttribute(e,i).forEach(function(e){s.push(e)})}),s}},translatePredicateToAttribute:function(t,n){var i,r,s;if(e.is(this._indexMapping)){switch(s=(n=n||{}).type||"entity",t instanceof Array?i=[]:(i={},n.fromExpandService&&(t=function(t){var n={};return t=t||{},Object.keys(t).forEach(function(i){var r=t[i];r instanceof Function||0===i.indexOf("_")||e.is(r)&&e.is(r.value)&&(n[i]=r.value)}),n}(t))),s){case"entity":r=this._indexMapping.IndexMapping.Entity.Key;break;case"relation":r=this._indexMapping.IndexMapping.Relation.Key}return t instanceof Array?t.forEach(function(e){var t;r.some(function(n){var i=n.index===e;return i&&(t=n),i}),t?-1===i.indexOf(t.database)&&i.push(t.database):a.getDicoTypeAttributesForIndex(e,s).forEach(function(e){i.push(e)})}):Object.keys(t).forEach(function(e){var n,o,u;r.some(function(t){var n=t.index===e;return n&&(u=t),n}),u?(n=t[u.index],r.some(function(e){var t=e.index===n;return t&&(o=e),t}),o&&(n=o.database),i[u.database]=n):(n=t[e],a.getDicoTypeAttributesForIndex(e,s).forEach(function(e){i[e]=n}))}),i}},parseProgressiveExpandNavigateResult:function(t){var n=null,r={},a=[];return"string"==typeof t?n=JSON.parse(t):"object"==typeof t&&null!==t&&(n=t),e.is(n)&&e.is(n.results,"array")&&n.results.forEach(function(t){var n,s,o,u,c,p;if(Object.prototype.hasOwnProperty.call(t,"Path")){if(Object.prototype.hasOwnProperty.call(t,"Path"))for(u=0;u<t.Path.length;u++){if(c=t.Path[u],p=r[c],!e.is(p))throw new Error("Result corruption : did not found "+c);0===u?(-1===a.indexOf(p)&&a.push(p),o=p):(o.addChild(p),o=p)}}else s=(n=new i(t)).getAttributeValue("resourceid"),r[s]=n}),a},parseNavigateResult:function(t){var i=null,a={},s=[];return"string"==typeof t?i=JSON.parse(t):"object"==typeof t&&null!==t&&(i=t),e.is(i)&&e.is(i.results,"array")&&i.results.forEach(function(t){var i,o,u,c,p,d;if(Object.prototype.hasOwnProperty.call(t,"attributes"))o=(i=new n(t)).getAttributeValue("did"),a[o]=i;else if(Object.prototype.hasOwnProperty.call(t,"path"))for(c=0;c<t.path.length;c++){if(p=t.path[c],d=a[p],!e.is(d))throw new Error("Result corruption : did not found "+p);0===c?(-1===s.indexOf(d)&&s.push(d),u=d):(u.addChild(d),u=d)}else r.warn("IndexParser.parseNavigateResult Unsupported element: "+JSON.stringify(t))}),s},parseFetchResult:function(t){var n={attributes:{},ds6w:{}};return e.is(t)&&e.is(t.attributes,"array")&&t.attributes.forEach(function(t){var i;if(e.is(t)&&e.is(t.format,"string"))switch(t.format){case"attribute":e.is(n.attributes[t.name])?e.is(n.attributes[t.name],"string")?(i=n.attributes[t.name],n.attributes[t.name]=[i,t.value]):e.is(n.attributes[t.name],"array")&&n.attributes[t.name].push(t.value):n.attributes[t.name]=t.value;break;case"ds6w_facet":n.ds6w[t.name]={value:t.value,dispValue:t.dispValue,type:t.type}}}),n}})});