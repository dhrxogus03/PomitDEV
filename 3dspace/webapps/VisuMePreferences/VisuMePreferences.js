define("DS/VisuMePreferences/MePreferences",["UWA/Core","DS/WAFData/WAFData"],function(e,t){let r=0,s=function(e){r<10&&(console.warn(e),r++)},n=!1,i=1,o=new class{constructor(){this._instances=new Map,this._updateToken=null,this.PREFERENCES={NAVIGATIONMODE:{repository:"VisualizationRepository",preference:"SWNavigationMode",datatype:"enum"},PRESELECTION:{repository:"VisualizationRepository",preference:"PreSelection",datatype:"boolean"},BACKGROUNDCOLOR:{repository:"VisualizationRepository",preference:"Background",datatype:"color"}}}_subscribeToPreferenceUpdates(){let e=this;require(["DS/PlatformAPI/PlatformAPI"],function(t){e._updateToken=t.subscribe("com.ds.mep:onPrefUpdate",function(t,r){if(t){let r=e._instances.get(t[2].tenantId);r&&r.processPreferences(JSON.parse(t[1].preferences))}})})}subscribe(e,t){let r=this._getInstance(),s=null;return r&&(s=r.subscribeToPreference(e.repository,e.preference,t),this._updateToken||this._subscribeToPreferenceUpdates()),s}unsubscribe(e){for(let[t,r]of this._instances)r.unsubscribeToPreference(e)}setPreference(e,t){let r=this._getInstance();r&&r.setPreference(e,t)}getCurrentTenant(){return window.widget&&window.widget.getValue("x3dPlatformId")}_getInstance(){let e=this.getCurrentTenant();if(!e)return null;if(this._instances.has(e))return this._instances.get(e);{let r=new class{constructor(e){this.tenant=e,this.urlPromise=this.getServiceUrl().then(e=>{e[0].url?this.url=e[0].url:this.url=e}).catch(e=>{this.urlPromise=null,s(e)}),this.url=null,this.preferences=new Map,this.fetchPreferencesTimeout=null}getServiceUrl(){let e=this;return new Promise(function(t,r){n?t("FakeURLForODT"):require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(s){s.getServiceUrl({serviceName:"mepreferences",platformId:e.tenant,onComplete:function(e){t(e)},onFailure:function(e){r(e)}})})})}subscribeToPreference(e,t,r){this.preferences.has(e)||this.preferences.set(e,new Map);let s=this.preferences.get(e);s.has(t)||s.set(t,{value:null,userOverloadFlag:null,locked:!1,callbacks:new Map});let n=s.get(t),o=i++;if(n.callbacks.set(o,r),this.url)this.fetchPreferences();else if(this.urlPromise){let e=this,t=function(){e.fetchPreferences()};this.urlPromise.then(t)}return o}unsubscribeToPreference(e){for(let[t,r]of this.preferences)for(let[t,s]of r)s.callbacks.has(e)&&s.callbacks.delete(e)}fetchPreferences(){this.fetchPreferencesTimeout&&clearTimeout(this.fetchPreferencesTimeout);let e=this,r=function(t){e.processPreferences(t)},n=function(e){s("failed to retrieve preferences"),s(e)};this.fetchPreferencesTimeout=setTimeout(function(){let s=e.url+"/api/v1/preferences?showUserOverloadFlag=true&getLockStateFlag=true",i={repositories:[]};for(let[t,r]of e.preferences){let e={name:t,preferenceNames:[]};i.repositories.push(e);for(let[t,s]of r)e.preferenceNames.push(t)}t.authenticatedRequest(s,{method:"POST",type:"json",data:JSON.stringify(i),headers:{"Content-Type":"application/json"},onComplete:r,onFailure:n})},30)}processPreferenceValue(e,t){let r=null;for(let[t,s]of Object.entries(o.PREFERENCES))s.preference==e&&(r=s);let s=t;if(r)switch(r.datatype){case"color":s=parseInt(t.replace("#",""),16);break;case"boolean":s="string"==typeof t?"true"===t:!!t}return s}processPreferences(e){try{let t=e.repositories;for(let e=0;e<t.length;e++){let r=t[e],s=this.preferences.get(r.name);for(let e=0;e<r.preferences.length;e++){let t=r.preferences[e],n=s.get(t.name);n.userOverloadFlag=void 0===t.userOverloadFlag||t.userOverloadFlag,n.locked=void 0!==t.lockState&&"false"!==t.lockState,n.value=this.processPreferenceValue(t.name,t.value);for(let[e,t]of n.callbacks)t(n.value,n.userOverloadFlag,n.locked)}}}catch(e){s("preferences data received isn't formated as expected"),s(e)}}setPreference(e,r){let s=this.url+"/api/v1/preferences",n={onFailure:function(){},onComplete:function(){},method:"PUT",type:"json",data:JSON.stringify({repositories:[{name:e.repository,preferences:[{name:e.preference,value:r,locked:!1,datatype:e.datatype}]}]})};t.authenticatedRequest(s,n)}}(e);return this._instances.set(e,r),r}}__setODTMode(){n=!0}};return UWA.namespace("THREEDS/MePreferences",o)});