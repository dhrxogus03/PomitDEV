define("DS/WebVisu360/DynamicNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,n,a,o,s){"use strict";var l=new e.Vector3,h=new e.Matrix4,c=new e.Matrix4,u=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this._headLength=i.headLength?i.headLength:20,this.viewpoint=i.viewpoint,this._initialPoint=i.initialPoint,this._finalPoint=i.finalPoint,this._head=i.head?i.head:0,this._noZ=!i.removeNoZ,this.constraintAxis=new e.Vector3(0,0,1),this.vertDist=i.vertDist?i.vertDist:0;var a=n.getWebappsAssetUrl("SceneGraphNodes","");this.mapHead=new e.ImageUtils.loadTexture(a+"models/textures/dynamicNode.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),i.customHead&&(this.mapHeadCusom=new e.ImageUtils.loadTexture(a+i.customHead,void 0,null,null,e.ImageUtils.crossOriginPolicy)),this.mapHead.anisotropy=8,this.materialHead=new e.MeshBasicMaterial({map:null,side:e.DoubleSide,color:i.color,transparent:!0,alphaTest:.05}),this.materialHead.force=!0;var l=(new o).createRectangle({width:1,height:1,fill:!0,fillColor:null,noEdge:!0,layerNb:this._noZ?1:0});this.nodeHead=s.createMeshNode(l,this.materialHead),this.nodeHead.setShadow(!1),this.nodeHead.setFrustumCulled(!1),this.nodeHead.setPickParent(!0),this.nodeHead.name="tête de la flèche",this.billBoardHead=new r({name:"billBoardNode_head",viewpoint:this.viewpoint}),this.billBoardHead.addChild(this.nodeHead),this.billBoardHead.setPickParent(!0),this.nodeHeadParent=new t,this.nodeHeadParent.setPickParent(!0),this.addChild(this.nodeHeadParent),this.nodeHeadParent.addChild(this.billBoardHead),this._updateData(),this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this.name="CustomizableNode";var h=this;return this.cbChange=function(e){h.viewpoint&&h.viewpoint!==e.viewpoint||"@onViewpointChange"===e.eventType&&h._CallBackEventHandler(e)},this.tokenChange=null,this},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i){return this._CallBackEventHandler(t,i),this.getMatrix()},_CallBackEventHandler:function(e,t){var i=this.getMatrixWorld().getMaxScaleOnAxis();l.getPositionFromMatrix(this.nodeHead.getMatrixWorld());var r=t||e.viewpoint,n=1/(i/r.camera.getWorldSizeFromPixelSize(1,l,r.viewer._getDivClientHeight(),2)),a=n*(this._head?this._headLength:0),o=-n*this.vertDist;h.makeScale(a,a,a),1===this._head&&(this.nodeHeadParent.setMatrix(c),l.set(-a/2,0,0),this.nodeHead.setMatrix(h.rotateX(.5*Math.PI).setPosition(l)),l.copy(this.constraintAxis).multiplyScalar(o),h.identity(),this.nodeHeadParent.setMatrix(h.setPosition(l))),this.billBoardHead.cbChange(e)},updateColor:function(e){this.materialHead.color=e},setHeadSize:function(e){this._headLength=e,this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadType:function(e){this._head=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},getNodeType:function(){return"DynamicNode"},_updateData:function(){switch(this.billBoardHead.setVisibility(!0),this.billBoardHead.setVisibilityFree(!1),this.billBoardHead.setConstraintAxis(this.constraintAxis),this.billBoardHead.setBillboardType("PseudoSpherical"),this._head){case 1:this.materialHead.map=this.mapHead;break;case 2:this.materialHead.map=this.mapHeadCusom}this.materialHead._invalidateDisplayRangeLists(),this.materialHead.updateDeferredMaterials()}});return u.types={TRIANGLE:1,CUSTOM:2},UWA.namespace("THREEDS/Nodes/DynamicNode",u)}),define("DS/WebVisu360/Vis360MarkerHandle",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Manipulators/HandlePointManipulator","DS/Animation/PropertyAnimation","DS/Visualization/PathElement","DS/Visualization/MaterialManager","DS/Visualization/GraphicAttributeSet","DS/WebVisu360/DynamicNode","DS/SceneGraphNodes/ArrowNode","DS/Visualization/GeometryHelper","WebappsUtils/WebappsUtils","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(e,t,i,r,n,a,o,s,l,h,c,u,d,m,p,g){"use strict";var v=t.extend({init:function(t){new l;this.markeNodeOpacity=.25,this.highlightNodeOpacity=.65,this.sag=80,this.highlightTubeNode,this.parameters=t,this.markerId=t.markerId,this.tileSet=t.tileSet,this.viewer=t.viewer,this.highlightNodeColor=this.markerNodeColor,this.modelMatrix=t.m3,this._parent();let o=this;var s=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!0,opacity:this.markeNodeOpacity,color:new e.Color(this.markerNodeColor)});s.force=!0,this.markerTubeNode=n.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,.5),internalRadius:t.internalRadius,externalRadius:t.externalRadius,sag:this.sag,material:s});const c=this.markerTubeNode.getPrimitives();var u=new h({basic:!0,colorIndex:e.COLORMAP_INDEX.FOREGROUND,inheritance:e.GASEnum.COLOR_INHERITANCE_OFF});this.markerTubeNode._setGAS([c[0]],u);var d=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!0,opacity:1e-4,color:new e.Color("rgb(255, 255, 255)")});d.force=!0;var m=n.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,.5),internalRadius:0,externalRadius:t.externalRadius,sag:this.sag,material:d});this.markerTubeNode.excludeFromHighlight(!0,!0),this.markerTubeNode.setVisibilityFree(!0),m.excludeFromHighlight(!0,!0),m.setVisibilityFree(!0);var p=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!0,opacity:this.highlightNodeOpacity,color:new e.Color("rgb(255, 255, 255)")});p.force=!0,this.highlightNode=n.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,.5),internalRadius:t.internalRadius,externalRadius:t.externalRadius+.1*t.externalRadius,sag:this.sag,material:p}),this.highlightNode.setPickable(i.PICKTHROUGH),this.highlightNode.excludeFromHighlight(!0,!0),this.highlightNode.setVisibility(!1),this.highlightNode.setVisibilityFree(!0);var g=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!0,opacity:this.highlightNodeOpacity,color:new e.Color("rgb(255, 255, 255)")});g.force=!0,this.contrastNode=n.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,.5),internalRadius:t.internalRadius,externalRadius:t.externalRadius+.1*t.externalRadius,sag:this.sag,material:g}),this.contrastNode.setPickable(i.PICKTHROUGH),this.contrastNode.excludeFromHighlight(!0,!0),this.contrastNode.setVisibility(!1),this.contrastNode.setVisibilityFree(!0),this.createDynamicNode();var v=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!0,opacity:.7,color:new e.Color("rgb(255, 255, 255)")});return v.force=!0,this.animationNode=n.createTubeNode({bottomCenterPoint:new e.Vector3(0,0,0),extrusionVector:new e.Vector3(0,0,.5),internalRadius:t.internalRadius,externalRadius:t.externalRadius+.1*t.externalRadius,sag:2*this.sag,material:v}),this.animationNode.setPickable(i.PICKTHROUGH),this.animationNode.excludeFromHighlight(!0,!0),this.animationNode.setVisibility(!1),this.animationNode.setVisibilityFree(!0),this.addChild(this.markerTubeNode),this.addChild(m),this.addChild(this.highlightNode),this.addChild(this.contrastNode),this.addChild(this.animationNode),this.setMatrix(t.m3),this._modelEvent=new r,this.manipulator=new a,this.manipulator.setExclusive(!0),this.manipulator.noCursorChange=!0,this.manipToken=this.manipulator.linkToNode(this),this.animation=null,this.override=null,this.manipulator.onPreactivate(function(e){e.markerId=o.markerId,e.tileSet=o.tileSet,o._modelEvent.publish({event:"Preactivate",data:e,context:this}),o.highlightNode.setVisibility(!0),e.viewer.render()}),this.manipulator.onEndPreactivate(function(e){e.markerId=o.markerId,e.tileSet=o.tileSet,o._modelEvent.publish({event:"EndPreactivate",data:e,context:this}),o.highlightNode.setVisibility(!1),e.viewer.render()}),this.manipulator.onPrimaryPointerClick(function(e){e.markerId=o.markerId,e.tileSet=o.tileSet,o._modelEvent.publish({event:"PrimaryPointerClick",data:e,context:this})}),this},createOverridePath:function(e){this._sceneGraphOverrideSet=new g(this.parents[0]);var t=this.viewer.getSceneGraphOverrideSetManager();t&&t.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet),this._path=new s,this._path.addElement(this.parents[0]),this._path.addElement(this),this._path.addElement(e),this.override=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path),this.override||(this.override=this._sceneGraphOverrideSet.createOverride(this._path))},createAnimation:function(){if(this.createOverridePath(this.animationNode),this.override){var t={_duration:7200,_marker:this.animationNode,_this:this,duration:function(){return this._duration},valueAt:function(t){var i=1+Math.abs(.2*Math.sin(t/288)),r=new e.Matrix4;r.makeScale(i,i,1),this._this.override.setPosition(r),this._this.viewer.render()}};this.animation=new o(this.animationNode,"scaleAnim",t)}},startAnimation:function(){this.animation&&(this.markerTubeNode.setVisibility(!1),this.animationNode.setVisibility(!0),this.animation.setLoop(1),this.animation.start())},stopAnimation:function(){this.animation&&(this.override=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path),this.override&&this._sceneGraphOverrideSet.deleteOverride(this.override),this.animationNode.setVisibility(!1),this.markerTubeNode.setVisibility(!0),this.animation.stop())},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},setToGhostState:function(){},setToNonGhostState:function(){},setHighlight:function(e){e?this.contrastNode.setVisibility(!0):this.contrastNode.setVisibility(!1)},createDynamicNode:function(){var t={name:"dynamic marker",headLength:22,sceneGraph:this.contrastNode,viewpoint:this.viewer.currentViewpoint,color:new i.Color(1,1,1,1),head:c.types.TRIANGLE,initialPoint:new e.Vector3(0,0,0),vertDist:35};this.dynamicNode=new c(t),this.dynamicNode.setMatrix((new e.Matrix4).rotateX(2*Math.PI/2)),this.dynamicNode.setPickable(i.PICKTHROUGH),this.contrastNode.addChild(this.dynamicNode)}});return UWA.namespace("DS/WebVisu360/Vis360MarkerHandle",v)}),define("DS/WebVisu360/Viewer360Manager",["DS/Visualization/PathElement","UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Viewpoint","DS/SceneGraphNodes/BillBoardNode3D","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Manipulators/Manipulator","DS/WebVisu360/Vis360MarkerHandle","DS/VisuEvents/EventsManager","DS/Selection/CSOManager"],function(e,t,i,r,n,a,o,s,l,h,c,u,d,m,p,g){"use strict";class v{constructor(e){this.viewer=e,this.requestedPosition=null,this.markerControllerMap=new Map,this.modelUnitScale=1,this.tileSetIndex=0,this.uriMatrixIndex=0,this._ambMinRadius=7e3,this._ambMaxRadius=1e5,this.ambRadius=this._ambMinRadius,this.matrixRefAmbience=new r.Matrix4;let t=new r.Vector3(0,0,1);t.normalize();let i=-Math.PI/2;this.matrixRefAmbience.makeRotationAxis(t,i),this.currentUriIndex=0,this.currentTileSet=null,this.currentImageTexture=null,this.nextUriIndex=0,this.nextTileSet=null,this.nextImageTexture=null,this._nearestMarkerPosition=-1,this._nearestTileset=null,this.tileSetTransitionReqInfo={},this.moveTo360ReqInfo={},this.baseAnimationDuration=1100,this.simpleMoveThreshold=.35,this.defaultMoveToDuration=1200,this._currentState=v.Mode_360.NONE,this._nextState=v.Mode_360.NONE,this.abortKeySet=new Set,this._abortDebug=!1,this._otherLogOn=!1,this._eventLogOn=!1,this._radiusLogOn=!1,this._increaseAnimTime=!1,this.timeOut=null,this._triangleDisplay=!!localStorage.getItem("__WEBVISU360_TRIANGLE_DISPLAY__"),this.runningOp={request360Tile:!1,first360ImageReq:!1,first360RePosition:!1,download360ImageReq:!1,animationTransition:!1,tileSetTransitionReq:!1,moveTo360Req:!1},this._viewerLastState={PickingActivation:!0,TrapSelectionState:!0,PreHighlightDisplay:!0,PickingCB_Activated:!0,AmbientLightColor:new r.Color(16777215),DistanceToTarget:0,FOV:45,customReframeCB:null,projectionType:null},this._viewpointLastState={DefaultControllerType:null},this._controlLastState={MouseInertia:!0,TouchInertia:!0,ReframeActive:!0,ReframeOnDoubleTap:!0,PanActive:!0,RotationRolling:!0,RotationSpeed:1,InvertHeadRotation:!1},this._ambienceLastState={gridState:!1,isOCA:!1,name:"Basic",isCustom:!1,isReset:!1},this._evtTokenMouse=[],void 0===p._isInit&&p.init(),this.externalObjectsRef={MePreferencesClientAPI:null,PlatformAPI:null},this._pref360Name="Invert360LookAroundNavigation"}getOOCManager(){return this.viewer._getOOCManager()}request360Mode(e,t,i){var n=void 0!==i&&i;if(!0===e&&this.haveData()&&this._currentState===v.Mode_360.MarkerOnly){if(this.runningOp.first360ImageReq||this.runningOp.animationTransition)return;t&&t.position?this.requestedPosition=t.position.clone():this.requestedPosition=this.viewer.currentViewpoint.getEyePosition().clone(),this._nextState=v.Mode_360.Load_360_Image;let e=this.selectClosestMarker();this.updateNearByImageData(e),this._storeAmbienceState(),this.nextTileSet=e.tileSet,this.requestKey={};this.requestKey;this.loadFirst360Image(e.uriIndex,e.tileSet)}else if(!0!==e&&!1!==e||this.haveData()||this._currentState!==v.Mode_360.NONE)if(n){this.requestKey={};let e=this.requestKey;this.request360Tiles().then(t=>{if(!this.abortKeySet.has(e)&&t&&t.length>0){let e=t.slice();this.update360Info(e),this.createNearByMarkers(),this._currentState===v.Mode_360.Complete_ON&&this.setPointCloudVisibility(!1),this.runningOp.tileSetTransitionReq&&this._start360TileSetTransitionAnim()}else this.abortKeySet.delete(e),this._abortDebug&&console.log("Aborted in request360Tiles")})}else!1===e&&this._currentState===v.Mode_360.Complete_ON&&(this._stop360Mode(),this._currentState=v.Mode_360.MarkerOnly,this.viewer._publish360ModeEvent(!1));else{if(!0===e&&(this.get360Mode()||this.runningOp.request360Tile||this.runningOp.first360ImageReq||this.runningOp.animationTransition))return;this.requestKey={};let i=this.requestKey;var a=v.Mode_360.NONE;!0===e&&this._currentState===v.Mode_360.NONE?a=v.Mode_360.Complete_ON:!1===e&&this._currentState===v.Mode_360.NONE&&(a=v.Mode_360.MarkerOnly),this.requestedPosition=new r.Vector3(0,0,0),t&&t.position?this.requestedPosition=t.position.clone():this.requestedPosition=this.viewer.currentViewpoint.getEyePosition().clone(),this.runningOp.request360Tile=!0,this.request360Tiles().then(e=>{if(!this.abortKeySet.has(i)&&e&&e.length>0){let t=e.slice();this.update360Info(t);let i=this.selectClosestMarker();this.updateNearByImageData(i),this.createNearByMarkers(),this._currentState=v.Mode_360.MarkerOnly,a===v.Mode_360.Complete_ON&&(this._storeAmbienceState(),this._nextState=v.Mode_360.Load_360_Image,this.nextTileSet=i.tileSet,this.loadFirst360Image(i.uriIndex,i.tileSet)),this.runningOp.request360Tile=!1}else this.abortKeySet.delete(i),this._abortDebug&&console.log("Aborted in request360Tiles")})}}onTileSetsRemoved(e){(this.runningOp.request360Tile||this.runningOp.animationTransition||this.runningOp.download360ImageReq||this.runningOp.first360ImageReq||this.runningOp.first360RePosition)&&(this.abortKeySet.add(this.requestKey),this._abortDebug&&(console.log("Added to abort due to"),console.log("   request360Tile "+this.runningOp.request360Tile),console.log("   animationTransition "+this.runningOp.animationTransition),console.log("   download360ImageReq  "+this.runningOp.download360ImageReq),console.log("   first360ImageReq "+this.runningOp.first360ImageReq),console.log("   first360RePosition "+this.runningOp.first360RePosition))),this.requestKey={};var t=!1,i=!1;let r=!1;for(let n=0;n<e.length;n++){if(e[n]&&this.markerControllerMap.has(e[n])){!0===this.runningOp.tileSetTransitionReq&&this.tileSetTransitionReqInfo&&this.tileSetTransitionReqInfo.iFromTileSet===e[n]&&this.currentTileSet===e[n]&&(r=!0);let t=this.markerControllerMap.get(e[n]);t&&(t.markerManager&&(t.markerManager.setMarkerVisibility(!1),t.markerManager.destroy_self()),t.nearByMarkerData&&(t.nearByMarkerData=[]),this.markerControllerMap.delete(e[n]))}e[n]===this.currentTileSet?(t=!0,e[n]):e[n]===this.nextTileSet&&(i=!0,e[n])}r?this.viewer.render():this._currentState===v.Mode_360.Complete_ON?this.haveData()?t&&(this._stop360Mode(),this.haveData()?this._currentState=v.Mode_360.MarkerOnly:this._currentState=v.Mode_360.NONE,this.viewer._publish360ModeEvent(!1)):(this._stop360Mode(),this.viewer._publish360ModeEvent(!1),this._currentState=v.Mode_360.NONE,this._resetSelf()):this._nextState===v.Mode_360.Load_360_Image?i&&(this._stop360Mode(),this._currentState=v.Mode_360.NONE,this.viewer._publish360ModeEvent(!1)):this._currentState===v.Mode_360.MarkerOnly&&(this.haveData()||(this._currentState=v.Mode_360.NONE,this._resetSelf()))}get360Mode(){return this._currentState===v.Mode_360.Complete_ON}request360Tiles(){let e,t,i=this.getOOCManager(),r=i.getRoots(),n=[];for(e=0;e<r.length;e++){let a=i.getTileSets(r[e]);if(a)for(t=0;t<a.length;t++){let e=a[t],i=e.getContentTypes();i&&i.indexOf("360")>=0&&n.push(e)}}let a=[];for(t=0;t<n.length;t++)a.push(this.requestTileSet360Tiles(n[t]));return Promise.all(a)}requestTileSet360Tiles(e){return new Promise((t,i)=>{let r=[];e.forceLoadTraverse({onExploreCB:(e,t)=>{"360"===e.contentType?r.push(e.uri):t.exploreChildren()},onLoadedCB:()=>{let i=new w(e,r);t(i)}})})}setPointCloudVisibility(e){let t,i=this.getPointCloudTileSets();for(t=0;t<i.length;t++)i[t].setVisibility(e),i[t].setVisibilityFree(!e)}setPointCloudOpacity(e){let t,i=this.getPointCloudTileSets();for(t=0;t<i.length;t++)i[t].setOpacity(e)}getPointCloudTileSets(){let e,t,i=[],r=this.getOOCManager(),n=r.getRoots();for(e=0;e<n.length;e++){let a=r.getTileSets(n[e]);if(a)for(t=0;t<a.length;t++){let e=a[t],r=e.getContentTypes();r&&r.indexOf("pointCloud")>=0&&i.push(e)}}return i}get360RootPathes(){let t,i,r=this.getOOCManager(),n=r.getRoots();for(t=0;t<n.length;t++){let a=r.getTileSets(n[t]);if(a)for(i=0;i<a.length;i++){let o=a[i].getContentTypes();if(o&&o.indexOf("360")>=0)return new e([r.getSceneGraphNode(n[t])])}}return null}_stop360Mode(){this._restoreViewerState(),this._restoreAmbienceState(),this._resetStoredAmbienceState(),this._optimizeLoadingState(!1),this.setPointCloudVisibility(!0),this._unsetMouseEventsMap();let e=this.markerControllerMap.get(this._nearestTileset);if(this._triangleDisplay&&e&&e.markerManager.setHighlightNode(!1,this._nearestMarkerPosition),this.currentImageTexture)var t=this.currentImageTexture,i=this,r=this.viewer.onPostRender(function(){t&&t.dispose(),i.viewer.unsubscribe(r)});this.viewer.render()}_prapareFor360ImageLoad(){this.setPointCloudVisibility(!1),this._setAmbienceState()}selectClosestMarker(){let e=0,t=null,i=this.requestedPosition.clone(),n=null;return this.markerControllerMap.forEach(function(a,o){if(a.nearByMarkerData)for(var s=0;s<a.nearByMarkerData.length;s++){var l=new r.Vector3(0,0,0),h=new r.Quaternion,c=new r.Vector3(0,0,0);a.nearByMarkerData[s].matrix.clone().decompose(l,h,c);var u=i.distanceTo(l);(null===n||u<n)&&(n=u,e=s,t=o)}}),{tileSet:t,uriIndex:e}}getData(e,t){if(t&&t.oocTileSet&&"360"===t.oocTileSet.getContentTypes()[0]&&t.tilesUris&&e<t.tilesUris.length){var i=new M;i.uriIndex=e,i.uri=t.tilesUris[e],i.url=t.oocTileSet.getTileContentUrl(t.tilesUris[e]),i.matrix=t.oocTileSet.getTileWorldMatrices(t.tilesUris[e])[0],i.markerOuterRadius=200,i.format=t.oocTileSet.getTileContentSpec(i.uri).format;var r=t.oocTileSet.getTileContentMetaData(t.tilesUris[e]);return r&&r[360]&&(r[360].fovHeight&&(i.povHeight=parseFloat(r[360].fovHeight)),r[360].povHeight&&(i.povHeight=parseFloat(r[360].povHeight)),i.povHeight=i.povHeight*this.modelUnitScale,r[360].type&&(i.type=r[360].type)),i}return null}updateNearByImageData(e){}update360Info(e){for(let r=0;r<e.length;r++)if(e[r]&&!this.markerControllerMap.has(e[r].oocTileSet)){if(this.tileSetTransitionReqInfo&&this.tileSetTransitionReqInfo&&this.tileSetTransitionReqInfo.iFromTileSet===e[r].oocTileSet)continue;var t=new S(this.viewer);for(let n=0;n<e[r].tilesUris.length;n++){var i=this.getData(n,e[r]);t.nearByMarkerData.push(i)}t.nearByMarkerData.length>0&&this.markerControllerMap.set(e[r].oocTileSet,t)}}createNearByMarkers(){var e=this;this.markerControllerMap.forEach(function(t,i){if(t&&!t.markerManager.bMarkerCreated){var a=t.markerManager.getOrCreateRootNode(),o=(e._getModelSize(),t.nearByMarkerData[0]?t.nearByMarkerData[0].markerOuterRadius-.25*t.nearByMarkerData[0].markerOuterRadius:150),l=t.nearByMarkerData[0]?t.nearByMarkerData[0].markerOuterRadius:200,h=new r.MeshBasicMaterial({side:r.DoubleSide,transparent:!0,opacity:.65,color:new r.Color("rgb(255, 255, 255)")});h.force=!0,t.dynamicMarkerNode=n.createTubeNode({bottomCenterPoint:new r.Vector3(0,0,0),extrusionVector:new r.Vector3(0,0,.5),internalRadius:o,externalRadius:l,sag:80,material:h}),t.dynamicMarkerNode.setPickable(s.PICKTHROUGH),t.dynamicMarkerNode.excludeFromHighlight(!0,!0),t.dynamicMarkerNode.setVisibility(!1),t.dynamicMarkerNode.setVisibilityFree(!0),t.dynamicMarkerNode.setNoZ(!0),a.addChild(t.dynamicMarkerNode);for(var c=0;c<t.nearByMarkerData.length;c++){var u={};u.internalRadius=t.nearByMarkerData[c].markerOuterRadius-.25*t.nearByMarkerData[c].markerOuterRadius,u.externalRadius=t.nearByMarkerData[c].markerOuterRadius,u.parent=a;var d=t.nearByMarkerData[c].povHeight-80,p=new r.Matrix4;p.makeTranslation(0,0,-d);var g=t.nearByMarkerData[c].matrix.clone().multiply(p);u.m3=g,u.viewer=e.viewer,u.markerId=c,u.tileSet=i;let n=new m(u);n.subscribe("PrimaryPointerClick",function(t){e._otherLogOn&&console.log(t.markerId),e._teleportOnClick(t.markerId,t.tileSet)});t.markerManager.addMarkerHandle(n)}t.markerManager.bMarkerCreated=!0,e.runningOp.tileSetTransitionReq&&a.setVisibility(!1),e.viewer.getRootNode().addChild(a)}}),this.viewer.render()}getOpenClickNavigation(){var e=!0,t=this.viewer.getNavigationParams();return void 0!==t.clickToNavigateIn360&&(e=t.clickToNavigateIn360),e}_storeAmbienceState(){var e=this.viewer.getVisuEnv();e&&e.includes("OCA")?(this._ambienceLastState.isOCA=!0,this._ambienceLastState.name=e.replace("OCA","")):e&&"Custom"===e?(this._ambienceLastState.isCustom=!0,this.prevAmbience=this.viewer.ambience.clone({viewer:this.viewer,v2:!0})):this._ambienceLastState.name=e,this._ambienceLastState.gridState=this.viewer.getGrid(),this._ambienceLastState.isReset=!1}_resetStoredAmbienceState(){this.prevAmbience=null,this._ambienceLastState.isOCA=!1,this._ambienceLastState.name="Basic",this._ambienceLastState.gridState=!1,this._ambienceLastState.isReset=!0}_restoreAmbienceState(){1!=this._ambienceLastState.isReset&&(this.viewer.removeAmbience(),this._ambienceLastState.isOCA?this.viewer.setVisuEnvOCA(this._ambienceLastState.name):this._ambienceLastState.isCustom?this.viewer.setAmbience(this.prevAmbience):this.viewer.setVisuEnv(this._ambienceLastState.name),this.viewer.setGrid(this._ambienceLastState.gridState),this.viewer.ambience.updateAmbience(),this.viewer.render())}_setAmbienceState(){this.viewer.removeAmbience(),this.viewer.ambience.setFiniteMode(!0),this.viewer.ambience.setGroundHeight(new r.Vector3(0,0,.1)),this.viewer.ambience.setGroundRadius(this.ambRadius),this.viewer.ambience.updateAmbience()}reframeIn360(e,t,i,n,a){var o=this.viewer.getNavigationParams(),s=null;if(o.reframe360CB&&(s=o.reframe360CB),a){this._inReframe=!0,this.reframeTargetCenter=i.center.clone(),this._adjustSightToCenter(this.reframeTargetCenter);var l=Math.max(this.viewer._getDivClientHeight()/this.viewer._getDivClientWidth(),1);this.distanceToReframeTarget=1.1*i.radius*l/Math.tan(this.viewer.currentViewpoint.getAngle()*Math.PI/360);var h=this.markerControllerMap.get(this.currentTileSet).markerManager.getMarkerHandle(this.currentUriIndex),c=new r.Vector3;h&&c.getPositionFromMatrix(h.getMatrix());var u=c.distanceTo(this.reframeTargetCenter),d=i.radius/u,m=new r.Vector3((1-d)*this.reframeTargetCenter.x+d*c.x,(1-d)*this.reframeTargetCenter.y+d*c.y,(1-d)*this.reframeTargetCenter.z+d*c.z),p=this._findNearestMarker(m,i.radius);this._teleportOnClick(p.nearestIndex,p.nearestTileset)}else s&&s.call()}_findNearestMarker(e,t){var i={nearestIndex:-1,nearestTileset:null};return this.markerControllerMap.forEach(function(t,n){for(var a=t.markerManager.getNoOfMarkers(),o=Number.MAX_VALUE,s=(new r.Vector3,0);s<a;s++){var l=t.markerManager.getMarkerHandle(s);if(l){var h=new r.Vector3;h.getPositionFromMatrix(l.getMatrix());var c=h.distanceTo(e);c<=o&&(o=c,i.nearestIndex=l.markerId,i.nearestTileset=l.tileSet,h.clone())}}}),i}_storeViewerState(){this._viewerLastState.TrapSelectionState=this.viewer.picking.trapSelection,this._viewerLastState.AmbientLightColor=this.viewer.ambientLight.color.clone(),this._viewerLastState.DistanceToTarget=this.viewer.currentViewpoint.getTargetDistance(),this._viewerLastState.FOV=this.viewer.currentViewpoint.getAngle(),this._viewerLastState.customReframeCB=this.viewer.currentViewpoint._customReframeCB,this._viewerLastState.projectionType=this.viewer.currentViewpoint.getProjectionType(),this._otherLogOn&&console.log("_storeViewerState :: angle "+this._viewerLastState.FOV),this._controlLastState.MouseInertia=this.viewer.currentViewpoint.control.mouseInertia,this._controlLastState.TouchInertia=this.viewer.currentViewpoint.control.touchInertia,this._controlLastState.ReframeActive=!this.viewer.currentViewpoint.control.lockReframe,this._controlLastState.ReframeOnDoubleTap=!this.viewer.currentViewpoint.control.lockReframeOnDblTap,this._controlLastState.PanActive=!this.viewer.currentViewpoint.control.lockPan,this._controlLastState.RotationRolling=!this.viewer.currentViewpoint.control.lockZ,this._controlLastState.RotationSpeed=this.viewer.currentViewpoint.control.rotateSpeed,this._controlLastState.InvertHeadRotation=this.viewer.currentViewpoint.control.getInvertHeadRotationActive(),this._viewpointLastState.DefaultControllerType=this.viewer.currentViewpoint.getDefaultController()}_setViewerState(){this.viewer.setAmbientLight(new r.Color(16777215)),this.viewer.setPicking({trapSelection:!1}),this.viewer.currentViewpoint.setDefaultController(!0,"LOOKAROUND"),this.viewer.currentViewpoint.setProjectionType(a.PERSPECTIVE),this.viewer.currentViewpoint.control.setRotationInertia({mouse:!0,touch:!0}),this.viewer.currentViewpoint.control.setReframeActive(!1),this.viewer.currentViewpoint.control.setReframeOnDoubleTap(!1),this.viewer.currentViewpoint.control.setPanActive(!1),this.viewer.currentViewpoint.control.setRotationRolling(!0),this.viewer.currentViewpoint.control.setRotationSpeed(4),this._syncWithMePref(),this.viewer.currentViewpoint.control.update(),this.viewer.currentViewpoint.onReframe(function(e,t,i,r){})}_restoreViewerState(){this.viewer.setPicking({trapSelection:this._viewerLastState.TrapSelectionState}),this.viewer.setAmbientLight(this._viewerLastState.AmbientLightColor),this._resetCameraFOV(this.viewer.currentViewpoint.getAngle()),this._otherLogOn&&console.log("Angle Changed due to 360 actions :: "+this.viewer.currentViewpoint.getAngle()),this.viewer.currentViewpoint.setAngle(this._viewerLastState.FOV),this.viewer.currentViewpoint.setDefaultController(!0,this._viewpointLastState.DefaultControllerType),this.viewer.currentViewpoint.control.setRotationInertia({mouse:this._controlLastState.MouseInertia,touch:this._controlLastState.TouchInertia}),this.viewer.currentViewpoint.control.setReframeActive(this._controlLastState.ReframeActive),this.viewer.currentViewpoint.control.setReframeOnDoubleTap(this._controlLastState.ReframeOnDoubleTap),this.viewer.currentViewpoint.control.setPanActive(this._controlLastState.PanActive),this.viewer.currentViewpoint.control.setRotationRolling(this._controlLastState.RotationRolling),this.viewer.currentViewpoint.control.setRotationSpeed(this._controlLastState.RotationSpeed),this.viewer.currentViewpoint.control.setInvertHeadRotationActive(this._controlLastState.InvertHeadRotation),this.viewer.currentViewpoint.control.update(),this.viewer.currentViewpoint.onReframe(this._viewerLastState.customReframeCB),this.viewer.currentViewpoint.setProjectionType(this._viewerLastState.projectionType),this._unsubscribeFromPrefUpdates()}_resetCameraFOV(e){var t=this._getNewDistanceToTarget(),i=this.viewer.currentViewpoint.getEyePosition().clone();if(e!=this._viewerLastState.FOV){let i=this._viewerLastState.FOV*(Math.PI/180),r=e*(Math.PI/180),n=2*t*Math.tan(r/2)/(2*Math.tan(i/2));this.viewer.currentViewpoint.camera.getLookAt().clone().multiplyScalar(n-t);t=n}if(t&&t>0){var r={eyePosition:i,distanceToTarget:t};this.viewer.currentViewpoint.setUnlockMoveIn360Mode&&this.viewer.currentViewpoint.setUnlockMoveIn360Mode(!0),this.viewer.currentViewpoint.moveTo(r),this.viewer.currentViewpoint.setUnlockMoveIn360Mode&&this.viewer.currentViewpoint.setUnlockMoveIn360Mode(!1)}}_resetSelf(){this.requestedPosition=null,this.modelUnitScale=1,this.markerControllerMap&&this.markerControllerMap.clear(),this.markerControllerMap=new Map,this.currentUriIndex=0,this.currentTileSet=null,this.currentImageTexture=null,this.nextUriIndex=0,this.nextTileSet=null,this.nextImageTexture=null,this._nearestMarkerPosition=-1,this._nearestTileset=null,this._currentState=v.Mode_360.NONE,this._nextState=v.Mode_360.NONE,this.tileSetTransitionReqInfo={},this.moveTo360ReqInfo={},this._viewerLastState.PickingActivation=!0,this._viewerLastState.TrapSelectionState=!0,this._viewerLastState.PreHighlightDisplay=!0,this._viewerLastState.PickingCB_Activated=!0,this._viewerLastState.AmbientLightColor=new r.Color(16777215),this._viewerLastState.DistanceToTarget=0,this._viewerLastState.FOV=45,this._viewerLastState.customReframeCB=null,this._viewerLastState.projectionType=null,this._viewpointLastState.DefaultControllerType=null,this._controlLastState.MouseInertia=!0,this._controlLastState.TouchInertia=!0,this._controlLastState.ReframeActive=!0,this._controlLastState.ReframeOnDoubleTap=!0,this._controlLastState.PanActive=!0,this._controlLastState.RotationRolling=!0,this._controlLastState.RotationSpeed=1,this._controlLastState.InvertHeadRotation=!1,this._resetStoredAmbienceState()}_teleportOnClick(e,t){if(!(this.runningOp.animationTransition||this.runningOp.download360ImageReq||this.runningOp.first360ImageReq))if(this._currentState!==v.Mode_360.Complete_ON||e===this.currentUriIndex&&t===this.currentTileSet){if(this._currentState===v.Mode_360.MarkerOnly){let i=null,r=this.markerControllerMap.get(t);e<r.nearByMarkerData.length&&(i=r.nearByMarkerData[e]),null!==i&&(this._simpleTeleport(i),this.currentUriIndex=e,this.currentTileSet=t)}}else{let i=this.markerControllerMap.get(t);if(i){i.markerManager.createAnimation(e),i.markerManager.startAnimation(e);let r=null,n=null,a=this.markerControllerMap.get(this.currentTileSet);this.currentUriIndex<a.nearByMarkerData.length&&(r=a.nearByMarkerData[this.currentUriIndex]),e<i.nearByMarkerData.length&&(n=i.nearByMarkerData[e]),null!==r&&null!==n&&t&&this.loadImageWithAnimation(n,r,t)}}}_simpleTeleport(e){let t=new r.Vector3(0,0,0);t.getPositionFromMatrix(e.matrix);let i=t.clone();this.viewer.currentViewpoint.control._getCameraFromAvatarPosition&&(i=this.viewer.currentViewpoint.control._getCameraFromAvatarPosition(t,this.viewer.currentViewpoint.camera.getLookAt().clone()));var n=this._getNewDistanceToTarget();this._otherLogOn&&console.log("_simpleTeleport distToTarget : "+n);var a;a={eyePosition:i,distanceToTarget:n,duration:800,interpolationType:0},this.viewer.currentViewpoint.moveTo(a)}_getNewDistanceToTarget(){var e;e=this._currentState===v.Mode_360.Complete_ON&&this._viewerLastState.DistanceToTarget?this._viewerLastState.DistanceToTarget:this.viewer.currentViewpoint.getTargetDistance();var t=this.viewer.currentViewpoint.getBoundingSphere().radius,i=Math.min(e,1e4,.1*t);return this._otherLogOn&&console.log("newDistToTarget"+i),i}loadFirst360Image(e,t){let i=null,r=this.markerControllerMap.get(t);r&&(r.nearByMarkerData&&e<r.nearByMarkerData.length&&(i=r.nearByMarkerData[e]),null!==i&&(this.ambRadius=5e4,this.runningOp.first360ImageReq=!0,this.loadImageWithAnimation(i,null,t)))}loadImageWithAnimation(e,t,i){this.requestKey={};let n=this.requestKey;var a=this,o=e,s=i,l=null;t&&(l=t);o.url;var h,c=-1,u=function(i){if(a.abortKeySet.has(n))return i&&i.dispose(),void(a._abortDebug&&console.log("Aborted in onTextureDowloadSuccess"));if(-1!==c&&c===i.id)if(a.nextImageTexture=i,a._otherLogOn&&(console.log("Texture Width "+a.nextImageTexture.mipmaps[0].width),console.log(a.nextImageTexture.mipmaps[0])),a.runningOp.download360ImageReq=!1,a.runningOp.first360ImageReq)a._onFirstTextureDownload(o,s);else{a._updateAmbienceRadius(o,l);let i=t.matrix.clone(),n=e.matrix.clone();if(t&&"latlon"===t.type){let e=new r.Vector3(0,0,0);e.getPositionFromMatrix(t.matrix),i.setPosition(new r.Vector3(0,0,0)),(i=i.multiplyMatrices(i,a.matrixRefAmbience)).setPosition(e)}if(e&&"latlon"===e.type){let t=new r.Vector3(0,0,0);t.getPositionFromMatrix(e.matrix),n.setPosition(new r.Vector3(0,0,0)),(n=n.multiplyMatrices(n,a.matrixRefAmbience)).setPosition(t)}a.viewer.ambience.setTransitionBackground({map:a.currentImageTexture,hdr:!1,matrix:i,radius:a.ambRadius},{map:a.nextImageTexture,hdr:!1,matrix:n,radius:a.ambRadius},.01),a.viewer.ambience.updateAmbience(),a.viewer.render(),a._onTextureDownload(o,l,s)}},d=function(e){a.runningOp.animationTransition=!1,a.runningOp.first360ImageReq&&(a.runningOp.first360ImageReq=!1),a._optimizeLoadingState(!1),a._otherLogOn&&console.log("Error while loading this url : "+e.sourceFile)};this.runningOp.download360ImageReq=!0,o&&"latlon"===o.type?h=new r.LatLongEnvMapping:(o&&"pinhole"===o.type||"cubemap"===o.type)&&(h=new r.CubeEnvMapping);var m=null;"BASIS"===o.format||"basis"===o.format?m=r.ImageUtils.loadBasisTexture(o.url,h,u,d,!0):"png"!==o.format&&"jpg"!==o.format||(m=r.ImageUtils.loadTexture(o.url,h,u,d,!0)),m&&(c=m.id),this._otherLogOn&&console.log("new nextImageTexture id"+c)}_onFirstTextureDownload(e,t){let i=this;var n=t;let a=e.matrix.clone(),o=new r.Vector3(0,0,0);o.getPositionFromMatrix(a);var s={eyePosition:o,interpolationType:1,duration:600,onEndCB:function(){if(i.runningOp.first360RePosition=!1,i.abortKeySet.has(l))return i._abortDebug&&console.log("Aborted in _onFirstTextureDownload"),void i._viewpointAnimation.stop();i._optimizeLoadingState(!0),i._prapareFor360ImageLoad();let t=new r.Vector3(0,0,0);t.getPositionFromMatrix(a),i._otherLogOn&&(console.log("NewPos"),console.log(t));let o=e.matrix.clone();if(e&&"latlon"===e.type){let e=new r.Vector3(0,0,0);e.getPositionFromMatrix(o),o.setPosition(new r.Vector3(0,0,0)),(o=o.multiplyMatrices(o,i.matrixRefAmbience)).setPosition(e)}i.viewer.ambience.setTransitionBackground({map:i.nextImageTexture,hdr:!1,matrix:o,radius:i.ambRadius},void 0,null,0),i.viewer.ambience.updateAmbience(),i.setPointCloudVisibility(!1),i.viewer._publish360ModeEvent(!0),i._setMouseEventsMap(),i._nextState=v.Mode_360.NONE,i._currentState=v.Mode_360.Complete_ON,i._storeViewerState(),i._setViewerState(),i.runningOp.first360ImageReq=!1,i.currentUriIndex=e.uriIndex,i.currentTileSet=n,i.runningOp.animationTransition=!1;let s=i.markerControllerMap.get(i.currentTileSet);if(s&&s.markerManager.setMarkerVisibility(!0),i.currentImageTexture)var h=i.currentImageTexture,c=i.viewer.onPostRender(function(){h&&h.dispose(),i.viewer.unsubscribe(c)});i.currentImageTexture=i.nextImageTexture,i.nextImageTexture=null,i.viewer.render()}};this.requestKey={};let l=this.requestKey;this.runningOp.first360RePosition=!0,this.viewer.currentViewpoint.moveTo(s)}_onTextureDownload(e,t,i){var n=e,a=i;let o=t.matrix.clone(),s=n.matrix.clone(),l=new r.Vector3(0,0,0);l.getPositionFromMatrix(s);let d=new r.Vector3(0,0,0);d.getPositionFromMatrix(o);let m=o.clone(),p=s.clone();if(t&&"latlon"===t.type){let e=new r.Vector3(0,0,0);e.getPositionFromMatrix(m),m.setPosition(new r.Vector3(0,0,0)),(m=o.multiplyMatrices(m,this.matrixRefAmbience)).setPosition(e)}if(e&&"latlon"===e.type){let e=new r.Vector3(0,0,0);e.getPositionFromMatrix(p),p.setPosition(new r.Vector3(0,0,0)),(p=s.multiplyMatrices(p,this.matrixRefAmbience)).setPosition(e)}this.requestKey={};let g=this.requestKey,w=this;var _=new u({position:d},{position:l},this.baseAnimationDuration);_.setInterpolator(function(e,t,i){return w._interpolatePos(e,t,i)}),this.onAnimationUpdate=function(e){if(w.abortKeySet.has(g))return w._abortDebug&&console.log("Aborted in onAnimationUpdate"),void w._viewpointAnimation.stop();w._onUpdateAnimation(e,w.currentImageTexture,m,w.nextImageTexture,p)};this.runningOp.animationTransition=!0,this.markerControllerMap.forEach(function(e,t){e.markerManager&&e.markerManager.setMarkerVisibility(!1)}),this._viewpointAnimation=new c(this,"onAnimationUpdate",_,function(e){if(e===h.State.STOPPED){if(w.abortKeySet.has(g))return w._abortDebug&&console.log("Aborted in onAnimationStop"),w._optimizeLoadingState(!1),void w._restoreAmbienceState();if(w._nextState=v.Mode_360.NONE,w.currentUriIndex=n.uriIndex,w.currentTileSet=a,w.runningOp.animationTransition=!1,w.currentImageTexture)var t=w.currentImageTexture,i=w.viewer.onPostRender(function(){t&&t.dispose(),w.viewer.unsubscribe(i)});if(w.currentImageTexture=w.nextImageTexture,w.nextImageTexture=null,w.markerControllerMap.forEach(function(e,t){e.markerManager&&e.markerManager.setMarkerVisibility(!0)}),w.viewer.render(),!0===w._inReframe&&w.reframeTargetCenter&&(w._adjustSightToCenter(w.reframeTargetCenter),w._inReframe=!1),w.runningOp.tileSetTransitionReq&&(w.runningOp.tileSetTransitionReq=!1,w.markerControllerMap.forEach(function(e,t){e.markerManager&&e.markerManager.setMarkerVisibility(!0)}),w.tileSetTransitionReqInfo.iTileSetTransitionCompleteCB&&w.tileSetTransitionReqInfo.iTileSetTransitionCompleteCB(),w.tileSetTransitionReqInfo={}),w.runningOp.moveTo360Req)var r=w.viewer.onPostRender(function(){if(w.viewer.unsubscribe(r),w.runningOp.moveTo360Req=!1,w.moveTo360ReqInfo&&w.moveTo360ReqInfo.options&&(void 0!==w.moveTo360ReqInfo.orientation||void 0!==w.moveTo360ReqInfo.options.orientation||void 0!==w.moveTo360ReqInfo.options.sightDirection||void 0!==w.moveTo360ReqInfo.options.upDirection||void 0!==w.moveTo360ReqInfo.options.fov)){w.viewer.currentViewpoint.control.update();let e=w.moveTo360ReqInfo.options;e.eyePosition=w.viewer.currentViewpoint.getEyePosition().clone(),e.ratioSize=void 0,e.interpolationType=1,void 0===e.duration&&(e.duration=w.defaultMoveToDuration),w.viewer.currentViewpoint.control.update(),w.viewer.currentViewpoint.moveTo(e),w.viewer.currentViewpoint.control.update()}else w.moveTo360ReqInfo&&w.moveTo360ReqInfo.options&&w.moveTo360ReqInfo.options.onEndCB&&w.moveTo360ReqInfo.options.onEndCB;w.moveTo360ReqInfo={}})}else e===h.State.RUNNING&&w.markerControllerMap.forEach(function(e,t){e.markerManager&&e.markerManager.stopAnimation()})}),this._viewpointAnimation.start(),this.viewer.render()}_adjustSightToCenter(e){var t=new r.Quaternion,i=new r.Matrix4;i.lookAt(this.viewer.currentViewpoint.getEyePosition().clone(),e,new r.Vector3(0,0,1)),t.setFromRotationMatrix(i),this.viewer.currentViewpoint.setUnlockMoveIn360Mode(!0),this.viewer.currentViewpoint.moveTo({eyePosition:this.viewer.currentViewpoint.getEyePosition().clone(),orientation:t,interpolationType:1,duration:700}),this.viewer.currentViewpoint.setUnlockMoveIn360Mode(!1),this.viewer.render()}_interpolatePos(e,t,i){var r={},n=t.position.clone();return n.lerp(i.position,e),r.position=n,r.t=e,r}_onUpdateAnimation(e,t,i,r,n){e.t>this.simpleMoveThreshold&&(this._otherLogOn&&console.log("data.t"+e.t),t&&i&&r&&n&&(this.viewer.ambience.setTransitionBackground({map:t,hdr:!1,matrix:i,radius:this.ambRadius},{map:r,hdr:!1,matrix:n,radius:this.ambRadius},Math.pow(e.t,7)),this._otherLogOn&&(console.log("currentImageTexture id "+t.id),console.log("nextImageTexture id"+r.id))));var a={eyePosition:e.position,interpolationType:1};this.viewer.currentViewpoint.setUnlockMoveIn360Mode&&this.viewer.currentViewpoint.setUnlockMoveIn360Mode(!0),this.viewer.currentViewpoint.moveTo(a),this.viewer.currentViewpoint.setUnlockMoveIn360Mode&&this.viewer.currentViewpoint.setUnlockMoveIn360Mode(!1)}_optimizeLoadingState(e){let t,i=this.getPointCloudTileSets();for(t=0;t<i.length;t++)i[t].setPauseLoading(e,"Viewer360Manager")}_updateAmbienceRadius(e,t){let i=new r.Vector3(0,0,0);i.getPositionFromMatrix(e.matrix);let n=new r.Vector3(0,0,0);n.getPositionFromMatrix(t.matrix);let a=0;i&&n&&(a=i.distanceTo(n)),this._radiusLogOn&&console.log("Distance: "+a);let o=1.3*a;this._radiusLogOn&&console.log("newAmbRadius "+o),o<this._ambMinRadius?o=this._ambMinRadius:o>this._ambMaxRadius&&(o=this._ambMaxRadius),this._radiusLogOn&&console.log("Radius after Max Cap "+o),Math.abs(o-this.ambRadius)>50&&!this.runningOp.first360ImageReq&&(this.ambRadius=o,this.viewer.ambience.setGroundHeight(new r.Vector3(0,0,.1)),this.viewer.ambience.setGroundRadius(this.ambRadius),this.viewer.ambience.updateAmbience(),this._radiusLogOn&&console.log("ambRadius"+this.ambRadius))}_setMouseEventsMap(){var e=this;this._evtTokenMouse=[],this._evtTokenMouse.push(p.addEvent(this.viewer.canvas,"onPrimaryPointerClick",function(t){e._onPrimaryPointerClick(t)})),this._evtTokenMouse.push(p.addEvent(this.viewer.canvas,"onMouseMove",function(t){e._onPrimaryPointerMove(t)}))}_unsetMouseEventsMap(){this._evtTokenMouse&&(this._evtTokenMouse.forEach(function(e){p.removeEventFromToken(e)}),this._evtTokenMouse=void 0)}_onPrimaryPointerMove(e){if(this.timeOut&&clearTimeout(this.timeOut),this.getOpenClickNavigation()&&!0!==this.runningOp.tileSetTransitionReq){this._triangleDisplay&&this.markerManager.setHighlightNode(!1,this._nearestMarkerPosition);var t=this._getNearestMarkerPosition(e);this._nearestMarkerPosition=t.nearestIndex;let d=this.markerControllerMap.get(this._nearestTileset);-1!=this._nearestMarkerPosition?(this._nearestTileset=t.nearestTileset,d=this.markerControllerMap.get(this._nearestTileset),this._triangleDisplay&&d.markerManager.setHighlightNode(!0,this._nearestMarkerPosition),this.viewer.currentViewpoint.control.isMoving()?d.dynamicMarkerNode.setVisibility(!1):d.dynamicMarkerNode.setVisibility(!0)):d&&d.dynamicMarkerNode.setVisibility(!1);var i=this._getMousePosition(e),n=this._getVectorFromMousePosition(i),a=this._getCurrentMarkerPosition(),o=new r.Plane;o.setFromNormalAndCoplanarPoint(new r.Vector3(0,0,1),a);var s=this.viewer.currentViewpoint.getEyePosition().clone(),l=(new r.Vector3).copy(s).sub(n);l.normalize();var h=new r.Ray(s,l).intersectPlane(o),c=new r.Matrix4;c.makeTranslation(h.x,h.y,h.z),d&&d.dynamicMarkerNode.setMatrix(c);var u=this;this.timeOut=setTimeout(function(){d&&d.dynamicMarkerNode.setVisibility(!1),u.viewer.render()},800),this.viewer.render()}}_onPrimaryPointerClick(e){if(this.getOpenClickNavigation()&&!this.runningOp.tileSetTransitionReq&&!this.runningOp.moveTo360Req){var t=this._getNearestMarkerPosition(e);t&&(this._nearestMarkerPosition=t.nearestIndex,-1!=this._nearestMarkerPosition&&this._teleportOnClick(this._nearestMarkerPosition,t.nearestTileset))}}_getMousePosition(e){var t=(new r.Vector2).copy(e.from[0].getCurrentPosition(this.viewer.canvas));return this.viewer.getMousePosition(t)}_getVectorFromMousePosition(e){var t=this.viewer.currentViewpoint.camera,i=new r.Vector3(e.x,e.y,0);return(new r.Projector).unprojectVector(i,t),i}_getModelSize(){let e=4*(1/this.viewer.currentViewpoint.getMMInSupportUnit());var t=new r.Vector3(0,0,1),i=new r.Vector3(0,e,1),n=new r.Projector;return n.unprojectVector(t,this.viewer.currentViewpoint.camera),n.unprojectVector(i,this.viewer.currentViewpoint.camera),t.sub(i).z}_getCurrentMarkerPosition(){var e=this.markerControllerMap.get(this.currentTileSet).markerManager.getMarkerHandle(this.currentUriIndex),t=new r.Vector3;return e&&t.getPositionFromMatrix(e.getMatrix()),t}_getNearestMarkerPosition(e){var t={nearestIndex:-1,nearestTileset:null},i=this._getMousePosition(e),n=this.viewer.pick(i,"mesh",!0);if(n&&0===n.path.length&&0===g.get().length){var a=this._getVectorFromMousePosition(i),o=this._getCurrentMarkerPosition(),s=(new r.Vector3).subVectors(o,a.clone()),l=this._createFrustum(s.normalize()),h=this._findNearestMarkerInFrustum(l,o);t=this._findNearestMarkerAlongRay(a,o,h)}return t}_createFrustum(e){var t=this.viewer.currentViewpoint.camera.clone();t.fov=180,t.lookAt(e),t.updateMatrix(),t.updateProjectionMatrix();var i=new r.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var n=new r.Frustum;return n.setFromMatrix(i),n}_findNearestMarkerInFrustum(e,t){var i=[];return this.markerControllerMap.forEach(function(t,n){for(var a=t.markerManager.getNoOfMarkers(),o=0;o<a;o++){var s=t.markerManager.getMarkerHandle(o);if(s){var l=new r.Vector3;l.getPositionFromMatrix(s.getMatrix()),e.containsPoint(l)&&i.push(s)}}}),i}_findNearestMarkerAlongRay(e,t,i){var n=[],a={nearestIndex:-1,nearestTileset:null},o=new r.Vector3(0,0,1),s=(new r.Vector3).subVectors(t,e);s.projectOnPlane(o);for(var l=i.length,h=Number.MAX_VALUE,c=-1,u=null,d=0;d<l;d++){if(g=i[d]){(v=new r.Vector3).getPositionFromMatrix(g.getMatrix());var m=(new r.Vector3).subVectors(t,v);m.projectOnPlane(o);var p=s.angleTo(m);Math.abs(p)<=.4&&n.push(g)}}l=n.length;for(d=0;d<l;d++){var g;if(g=n[d]){var v;(v=new r.Vector3).getPositionFromMatrix(g.getMatrix());var w=v.distanceTo(t);Math.abs(w)<=h&&(h=w,c=g.markerId,u=g.tileSet)}}return a.nearestIndex=c,a.nearestTileset=u,a}setInvert360LookAroundActive(e){let t=!e;this.viewer&&this.viewer.currentViewpoint&&this.viewer.currentViewpoint.control&&(this.viewer.currentViewpoint.control.setInvertHeadRotationActive(t),this.viewer.currentViewpoint.control.update())}getInvert360LookAroundActive(){return!!(this.viewer&&this.viewer.currentViewpoint&&this.viewer.currentViewpoint.control)&&!this.viewer.currentViewpoint.control.getInvertHeadRotationActive()}_syncWithMePref(){this._loadExternalObjects(),this.externalObjectsRef.MePreferencesClientAPI&&this._applyMePrefSetting(),this.externalObjectsRef.PlatformAPI&&this._subscribeToMePrefUpdates()}_loadExternalObjects(){var e=this;if(null===this.externalObjectsRef.MePreferencesClientAPI){require(["DS/MePreferencesClientAPI/MePreferencesClientAPI"],function(t){e.externalObjectsRef.MePreferencesClientAPI=t,e._applyMePrefSetting()})}if(null===this.externalObjectsRef.PlatformAPI){require(["DS/PlatformAPI/PlatformAPI"],function(t){e.externalObjectsRef.PlatformAPI=t,e._subscribeToMePrefUpdates()})}}_applyMePrefSetting(){this.externalObjectsRef.MePreferencesClientAPI&&this.externalObjectsRef.MePreferencesClientAPI.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:[this._pref360Name]}]).then(e=>{if(e&&e.repositories&&e.repositories[0]&&e.repositories[0].preferences&&e.repositories[0].preferences[0]){let t=JSON.parse(e.repositories[0].preferences[0].value);this.setInvert360LookAroundActive(t)}}).catch(e=>{})}_subscribeToMePrefUpdates(){var e=this;this.externalObjectsRef.PlatformAPI&&this.externalObjectsRef.PlatformAPI.subscribe("com.ds.mep:onPrefUpdate",function(t,i){if(t){let i=t[2].tenantId,r=JSON.parse(t[1].preferences).repositories;if(i&&i!=window.widget.getValue("x3dPlatformId"))return;let n=null,a=null;if(r){for(let e=0;e<r.length;e++)if("VisualizationRepository"==r[e].name){r[e].preferences.length&&(n=r[e].preferences);break}if(n)for(let t=0;t<n.length;t++)if(n[t].name==e._pref360Name){a=n[t].value;break}if(null!==a){let t=JSON.parse(a);e.setInvert360LookAroundActive(t)}}}})}_unsubscribeFromPrefUpdates(){this.externalObjectsRef.PlatformAPI&&this.externalObjectsRef.PlatformAPI.unsubscribe("com.ds.mep:onPrefUpdate")}haveData(){return!!this.markerControllerMap&&this.markerControllerMap.size>0}selectClosestMarkerInTileSet(e){let t=0,i=this.viewer.currentViewpoint.getEyePosition().clone(),n=null,a=this.markerControllerMap.get(e);if(a.nearByMarkerData)for(let e=0;e<a.nearByMarkerData.length;e++){var o=new r.Vector3(0,0,0),s=new r.Quaternion,l=new r.Vector3(0,0,0);a.nearByMarkerData[e].matrix.clone().decompose(o,s,l);var h=i.distanceTo(o);(null===n||h<n)&&(n=h,t=e)}return t}start360TileSetTransition(e,t,i){if(!(this.runningOp.tileSetTransitionReq||this.runningOp.animationTransition||this.runningOp.download360ImageReq||this.runningOp.first360ImageReq)&&this._currentState===v.Mode_360.Complete_ON&&t){this.runningOp.tileSetTransitionReq=!0,this.tileSetTransitionReqInfo={},this.tileSetTransitionReqInfo.iFromTileSet=e,this.tileSetTransitionReqInfo.iToTileSet=t,this.tileSetTransitionReqInfo.iTileSetTransitionCompleteCB=i;let r=this.markerControllerMap.get(this.currentTileSet);if(r){let e=null;this.currentUriIndex<r.nearByMarkerData.length&&(e=r.nearByMarkerData[this.currentUriIndex]),this.tileSetTransitionReqInfo.currentImageData=e}}}_start360TileSetTransitionAnim(){if(!(this.runningOp.animationTransition||this.runningOp.download360ImageReq||this.runningOp.first360ImageReq)&&this._currentState===v.Mode_360.Complete_ON&&this.tileSetTransitionReqInfo&&this.tileSetTransitionReqInfo.iToTileSet){let e=this.tileSetTransitionReqInfo.iToTileSet,t=this.markerControllerMap.get(e),i=null,r=this.selectClosestMarkerInTileSet(e);r<t.nearByMarkerData.length&&(i=t.nearByMarkerData[r]),this.tileSetTransitionReqInfo.currentImageData&&null!==this.tileSetTransitionReqInfo.currentImageData&&null!==i&&e&&this.loadImageWithAnimation(i,this.tileSetTransitionReqInfo.currentImageData,e)}}_selectClosestMarkerFrom(e){let t=0,i=null,n=e.clone(),a=null;if(this.markerControllerMap.forEach(function(e,o){if(e.nearByMarkerData)for(var s=0;s<e.nearByMarkerData.length;s++){var l=new r.Vector3(0,0,0),h=new r.Quaternion,c=new r.Vector3(0,0,0);e.nearByMarkerData[s].matrix.clone().decompose(l,h,c);var u=n.distanceTo(l);(null===a||u<a)&&(a=u,t=s,i=o)}}),null!==i)return{tileSet:i,uriIndex:t}}moveTo(e,t){if(void 0===e)return;let i=null,r=null;if(void 0!==e&&(this.moveTo360ReqInfo.options=Object.assign({},e)),void 0!==e&&void 0!==e.eyePosition&&(i=e.eyePosition.clone()),i&&(r=this._selectClosestMarkerFrom(i)),void 0!==this.moveTo360ReqInfo.fov){let e=100,t=20;viewpointAngleNew>e?this.moveTo360ReqInfo.fov=e:viewpointAngleNew<t&&(this.moveTo360ReqInfo.fov=t)}if(null===r||r.uriIndex===this.currentUriIndex&&r.tileSet===this.currentTileSet){if((null===r||r.uriIndex===this.currentUriIndex&&r.tileSet===this.currentTileSet)&&void 0!==this.moveTo360ReqInfo.options){let e=this.moveTo360ReqInfo.options;e.eyePosition=this.viewer.currentViewpoint.getEyePosition().clone(),e.ratioSize=void 0,e.interpolationType=1,void 0===e.duration&&(e.duration=this.defaultMoveToDuration),this.viewer.currentViewpoint.moveTo(e),this.viewer.currentViewpoint.control.update(),this.viewer.render()}}else this.runningOp.moveTo360Req=!0,this._teleportOnClick(r.uriIndex,r.tileSet)}}v.Mode_360={NONE:0,Complete_OFF:1,Complete_ON:2,MarkerOnly:3,Load_360_Image:4,Abort_360_Mode:6};class w{constructor(e,t){this.oocTileSet=e,this.tilesUris=t}}class _{constructor(e){this.bMarkerCreated=!1,this._markerHandleArray=[],this._markerHandleMatrixArray=[],this.currentIndex=-1,this._rootNearByNode=new l,this.token=null,this.viewer=e,this.token=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this))}onViewpointChange(){var e=this.viewer.currentViewpoint;if(e&&!this.viewer.get360Mode()){e.getMMInSupportUnit();var t=new r.Vector3(0,0,1),i=new r.Vector3(0,4,1),n=new r.Projector;n.unprojectVector(t,e.camera),n.unprojectVector(i,e.camera);let m=t.sub(i);for(var a=this.viewer.currentViewpoint.getEyePosition().clone(),o=(new r.Vector3).copy(e.camera.getLookAt()).multiplyScalar(e.camera.far).add(a),s=a.distanceTo(o),l=0;l<this._markerHandleArray.length;l++){var h=this._markerHandleArray[l];let e=new r.Vector3(0,0,0);e.getPositionFromMatrix(h.getMatrix());var c=a.distanceTo(e),u=Math.abs(c*m.y/(100*s)),d=new r.Matrix4;d.makeTranslation(0,0,u<500?u:500),d.multiply(this._markerHandleMatrixArray[l]),h.setMatrix(d)}}}isMarkerCreated(){return this.bMarkerCreated=!1}getOrCreateRootNode(){return this._rootNearByNode?this._rootNearByNode:(this._rootNearByNode=new l,this._rootNearByNode)}addMarkerHandle(e){this._markerHandleArray.push(e),this._markerHandleMatrixArray.push(e.getMatrix().clone()),this._rootNearByNode&&this._rootNearByNode.addChild(e)}getMarkerHandle(e){return this._markerHandleArray[e]}getNoOfMarkers(){return this._markerHandleArray.length}setMarkerVisibility(e){this._rootNearByNode&&this._rootNearByNode.setVisibility(e)}createAnimation(e){this._markerHandleArray[e]&&this._markerHandleArray[e].createAnimation()}startAnimation(e){this.currentIndex=e,this._markerHandleArray[this.currentIndex]&&this._markerHandleArray[this.currentIndex].startAnimation()}stopAnimation(){-1!==this.currentIndex&&this._markerHandleArray[this.currentIndex]&&this._markerHandleArray[this.currentIndex].stopAnimation(),this.currentIndex=-1}destroy_self(){this.stopAnimation(),this.viewer.currentViewpoint.unsubscribe(this.token),this.token=null,this.destroy3D_Markers(),this._markerHandleArray=[],this.bMarkerCreated=!1}destroy3D_Markers(){this._rootNearByNode&&(this._rootNearByNode.removeChildren(),this.viewer.getRootNode().removeChild(this._rootNearByNode),this._rootNearByNode=null)}setHighlightNode(e,t){-1!==t&&t<this._markerHandleArray.length&&this._markerHandleArray[t].setHighlight(e)}}class M{constructor(){this.isDetected=!1,this.matrix=null,this.uriIndex=-1,this.uri=null,this.url=null,this.povHeight=0,this.markerOuterRadius=400,this.type=null,this.format="basis"}}class S{constructor(e){this.nearByMarkerData=[],this.markerManager=new _(e)}}return v});