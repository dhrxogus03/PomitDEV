define("DS/VCXWebVisualization/VCXInteractor",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools","DS/VCXWebExperienceBase/VCXPathElementTools"],function(e,t,i,n,a){"use strict";var r=e.extend({init:function(e){this._pathElement=null,this._handle=null,this._type=r.EType.Pick,this._constraint=r.EConstraint.None,this._constraintReferential=r.EConstraintReferential.World,this._application=r.EApplication.None,this._active=!0,this._enable=!1,this._snappingBehavior=0,this.disabledByManipulable=!1,this._enableMultiSelect=!1,this._visibility=r.EVisibility.NoChange,this._manipulatorType=r.EManipulatorType.Handle,this._handleInfos=null,this._canonicsDetection=null,this._canonicsDefaultDetection=null,this._matrix=new i.Matrix4,this._component=e},isHandleNeeded:function(){return this.manipulatorType!==r.EManipulatorType.None},updateAxis:function(){var e;switch(this.constraint){case r.EConstraint.XAxis:e=n.getVxFromMatrix(this.matrixToUse);break;case r.EConstraint.YAxis:e=n.getVyFromMatrix(this.matrixToUse);break;case r.EConstraint.ZAxis:e=n.getVzFromMatrix(this.matrixToUse);break;case r.EConstraint.CustomAxis:e=this.constraintInfos.axis}return this.manipulator&&e&&(this.manipulator.axis=e),this.manipulator&&this.type===r.EType.Rotation&&(this.manipulator.centerPosition=n.getOFromMatrix(this.matrixToUse)),e},enable:function(){this._enable||(this.manipulator&&this.manipulator.enable(),t.publish({event:"VCX_INTERACTOR_ENABLE_CHANGED",data:{interactor:this,enable:!0}}),this._enable=!0)},disable:function(){this._enable&&(this.manipulator&&this.manipulator.disable(),t.publish({event:"VCX_INTERACTOR_ENABLE_CHANGED",data:{interactor:this,enable:!1}}),this._enable=!1)},isManipulated:function(){return this._inManipulation},setManipulated:function(e){this._inManipulation=e}});return r.EType={Pick:0,PlaneTranslation:1,LineTranslation:2,Scaling:3,Rotation:4,Screen:5},r.EConstraint={None:0,XAxis:1,YAxis:2,ZAxis:3,CustomAxis:4,Screen:5},r.EConstraintReferential={World:0,Object:1,Geometry:2},r.EApplication={None:0,"3DIllustration":2,"3DPlayCATIAComposer":4},r.EVisibility={NoChange:0,OnObjectOver:2,OnObjectSelected:4,OnInteractorOver:8,Always:16},r.EManipulatorType={None:0,Axis:1,Handle:2,BarHandle:3,Custom:4,ArrowHandle:5},r.ECursorDisplay={TopLeft:"nwse-resize",BottomRight:"nwse-resize",TopRight:"nesw-resize",BottomLeft:"nesw-resize",Top:"ns-resize",Bottom:"ns-resize",Left:"ew-resize",Right:"ew-resize"},r.enableInteractors=!0,Object.defineProperty(r.prototype,"matrixToUse",{enumerable:!0,get:function(){var e;if(this.constraintReferential===r.EConstraintReferential.Geometry&&this.geometry&&this.component){var t=this.component.QueryInterface("W3AISGNodeHolder").getPathElement(),n=a.buildPathElement(t,this.geometry);e=n&&n.getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer())}else e=this.constraintReferential===r.EConstraintReferential.Object&&this.component?this.component.QueryInterface("W3AISGNodeHolder").getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer()):this.matrix?this.matrix:new i.Matrix4;return e}}),Object.defineProperty(r.prototype,"handleMatrix",{enumerable:!0,get:function(){if(!this.handleLocation)return this.matrixToUse;var e;if(this.handleLocation===r.EConstraintReferential.Geometry&&this.geometry&&this.component){var t=this.component.QueryInterface("W3AISGNodeHolder").getPathElement(),n=a.buildPathElement(t,this.geometry);e=n&&n.getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer())}else e=this.handleLocation===r.EConstraintReferential.Object&&this.component?this.component.QueryInterface("W3AISGNodeHolder").getWorldMatrix(this.component._experienceBase.getManager("VCXContextManager").getMainViewer()):this.matrix?this.matrix:new i.Matrix4;return e}}),Object.defineProperty(r.prototype,"pathElement",{enumerable:!0,get:function(){return this._pathElement},set:function(e){return this._pathElement=e,this.manipulatorToken&&(this.manipulator&&this.manipulator.unlink(this.manipulatorToken),this.manipulatorToken=null),this._pathElement}}),Object.defineProperty(r.prototype,"handle",{enumerable:!0,get:function(){return this._handle},set:function(e){return this._handle=e,this.manipulatorToken&&(this.manipulator&&this.manipulator.unlink(this.manipulatorToken),this.manipulatorToken=null),this._handle}}),Object.defineProperty(r.prototype,"node",{enumerable:!0,get:function(){return this.isHandleNeeded()?this._handle&&this._handle.getHandleGeom():this._pathElement&&this._pathElement.getLastElement(!0)},set:function(e){if(e){if(this._component){var t=this._component.QueryInterface("W3AISGNodeHolder"),i=t&&t.giveSGNode();if(e===i)this.pathElement=t.getPathElement().clone();else{var n=[],a=e,r=this._component._experienceBase.getManager("VCXContextManager");if(!r)return;var s=r.getRootNode();if(!s)return;for(;a.parents&&a.parents[0]&&a!==i&&a!==s;)n.push(a),a=a.parents[0];if(a===i){this.pathElement=t.getPathElement().clone();for(var o=n.length-1;o>=0;o--)this._pathElement.addElement(n[o])}else if(a===s){var l=r.getRootComponent(),u=l&&l.QueryInterface("W3AISGNodeHolder").getPathElement();this.pathElement=u.clone(),this.pathElement.setFromArray(n)}}}}else this.pathElement=null}}),Object.defineProperty(r.prototype,"type",{enumerable:!0,get:function(){return this._type},set:function(e){this._type=e}}),Object.defineProperty(r.prototype,"constraint",{enumerable:!0,get:function(){return this._constraint},set:function(e){this._constraint=e}}),Object.defineProperty(r.prototype,"constraintReferential",{enumerable:!0,get:function(){return this._constraintReferential},set:function(e){this._constraintReferential=e}}),Object.defineProperty(r.prototype,"application",{enumerable:!0,get:function(){return this._application},set:function(e){"number"==typeof e&&(this._application=e)}}),Object.defineProperty(r.prototype,"active",{enumerable:!0,get:function(){if(r.enableInteractors)return!(!this.handleInfos||!this.handleInfos.stayVisible)||!this.disabledByManipulable&&this._active},set:function(e){this._active!==e&&(this._active=e,this.active?this.enable():this.disable())}}),Object.defineProperty(r.prototype,"enableMultiSelect",{enumerable:!0,get:function(){return this._enableMultiSelect},set:function(e){"boolean"==typeof e&&(this._enableMultiSelect=e)}}),Object.defineProperty(r.prototype,"snappingBehavior",{enumerable:!0,get:function(){return this._snappingBehavior},set:function(e){this._snappingBehavior=e}}),Object.defineProperty(r.prototype,"visibility",{enumerable:!0,get:function(){return this._visibility},set:function(e){this._visibility=e}}),Object.defineProperty(r.prototype,"manipulatorType",{enumerable:!0,get:function(){return this._manipulatorType},set:function(e){this._manipulatorType=e}}),Object.defineProperty(r.prototype,"handleInfos",{enumerable:!0,get:function(){return this._handleInfos},set:function(e){if(e){if(!(e.color||e.opacity||e.size))return!1;this._handleInfos||(this._handleInfos={}),e.color&&(this._handleInfos.color=e.color),e.opacity&&(this._handleInfos.opacity=e.opacity),e.size&&(this._handleInfos.size=e.size),e.stayVisible&&(this._handleInfos.stayVisible=e.stayVisible)}else this._handleInfos=null;return!0}}),Object.defineProperty(r.prototype,"matrix",{enumerable:!0,get:function(){return this._matrix},set:function(e){e instanceof i.Matrix4&&(this._matrix=e)}}),Object.defineProperty(r.prototype,"component",{enumerable:!0,get:function(){return this._component},set:function(e){this._component=e}}),Object.defineProperty(r.prototype,"canonicsDetection",{enumerable:!0,get:function(){return this._canonicsDetection},set:function(e){this._canonicsDetection=e}}),Object.defineProperty(r.prototype,"canonicsDefaultDetection",{enumerable:!0,get:function(){return this._canonicsDefaultDetection},set:function(e){this._canonicsDefaultDetection=e}}),Object.defineProperty(r.prototype,"manipulator",{enumerable:!0,get:function(e){return this._manipulator},set:function(e){this._manipulator=e}}),Object.defineProperty(r.prototype,"customIcon",{enumerable:!0,get:function(e){return this._customIcon},set:function(e){this._customIcon=e}}),r}),define("DS/VCXWebVisualization/VCXIViewpointController",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("DS/VCXWebVisualization/VCXBillBoardArrowNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/VCXWebSystem/VCXMathTools","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";var n=new i.Matrix4,a=new i.Matrix4;return e.extend({_getDynamicMatrix:function(e,r,s){e||(n.identity(),e=n);var o=s||r.viewpoint,l=t.getOFromMatrix(e).sub(o.getEyePosition()).normalize().clone();let u,c,h=t.getVxFromMatrix(e).clone().normalize(),p=t.getVzFromMatrix(e).clone().normalize(),d=t.getVyFromMatrix(e).clone().normalize();switch(this.BillBoardType){case"PRESERVE_X_AXIS":u=h,c=p;break;case"PRESERVE_Y_AXIS":u=d,c=p;break;case"PRESERVE_Z_AXIS":u=p,c=d;break;default:u=d,c=p}var g=new i.Plane;g.setFromNormalAndCoplanarPoint(u,t.getOFromMatrix(e));let _=new i.Vector3;g.projectPoint(l,_);const m=Math.acos(_.dot(c));switch(this.BillBoardType){case"PRESERVE_X_AXIS":a=(new i.Matrix4).makeRotationX(m);break;case"PRESERVE_Y_AXIS":a=(new i.Matrix4).makeRotationY(m);break;case"PRESERVE_Z_AXIS":default:a=(new i.Matrix4).makeRotationZ(m)}return a}})}),define("DS/VCXWebVisualization/VCXAPrepareRenderToTexture",["require","exports"],function(e,t){"use strict";return class{GetType(){return"VCXAPrepareRenderToTexture"}addOrNew(e,t){let i=this.propertyValues[e];i||(i=[]),i=i.concat(t),this.propertyValues[e]=i}constructor(){this.propertyValues=new Map,this.propertyValuesCache=new Map}async prepareRender(e,t){var i,n,a,r,s;if(this.propertyValuesCache.size>0)return;let o=null===(i=this._object)||void 0===i?void 0:i.QueryInterface("VCXIModifiable");if(o&&this.propertyValues){let i={fromChildClass:!0};null===(n=this.propertyValues[t])||void 0===n||n.forEach(e=>{let t=o.GetProperty(e);if(t){this.propertyValuesCache[e]=t.GetPropertyValue();let n=this.getValueForMask(e);n&&o.OnChangeProperty(e,n,i)}}),o.OnChangePropertiesEnd(),null===(s=null===(r=null===(a=this._object)||void 0===a?void 0:a.QueryInterface("W3AISGNodeHolder"))||void 0===r?void 0:r.getSGNode())||void 0===s||s.update(e)}}getValueForMask(e){}async postRender(e,t){var i,n,a,r,s;let o=null===(i=this._object)||void 0===i?void 0:i.QueryInterface("VCXIModifiable");if(o&&this.propertyValues){let i={fromChildClass:!0};null===(n=this.propertyValues[t])||void 0===n||n.forEach(e=>{if(this.propertyValuesCache[e]){let t=this.propertyValuesCache[e];t&&o.OnChangeProperty(e,t,i)}}),o.OnChangePropertiesEnd(),null===(s=null===(r=null===(a=this._object)||void 0===a?void 0:a.QueryInterface("W3AISGNodeHolder"))||void 0===r?void 0:r.getSGNode())||void 0===s||s.update(e)}this.propertyValuesCache.clear()}}}),define("DS/VCXWebVisualization/VCXImageManager",["require","exports","DS/VCXWebIO/VCXPixelImage","UWA/Class","DS/VCXWebIO/VCXCanvasServices","DS/VCXWebProperties/VCXColor","DS/CoreEvents/Events"],function(e,t,i,n,a,r,s){"use strict";class o{constructor(){this._imagesCacheSize=10,this._imagesCache=[]}postInitialize(){this.VCX_DOC_ADDED_CB=s.subscribe({event:"VCX_DOC_ADDED"},e=>{e&&e.docID&&this.clearCache(e.docID)})}unInitialize(){s.unsubscribe(this.VCX_DOC_ADDED_CB),this.VCX_DOC_ADDED_CB=null,this.clearCache()}_findInCache(e,t,i,n){for(var a=0;a<this._imagesCache.length;++a){let r=this._imagesCache[a];if(r.iDocID===e&&r.iEffect===t&&r.expectedWidth===i&&r.expectedHeight===n)return r}return null}_addToCache(e,t,i,n,a){let r={iDocID:e,iEffect:t,expectedWidth:i,expectedHeight:n,effectImage:a};this._imagesCache.length<this._imagesCacheSize?this._imagesCache[this._imagesCache.length]=r:(this._imagesCache=this._imagesCache.slice(1,this._imagesCacheSize),this._imagesCache[this._imagesCacheSize-1]=r)}clearCache(e){this._imagesCache=e?this._imagesCache.filter(e=>{e.iDocID}):[]}GetImageFromDocID(e,t,n,a){t||(t=0);var s=this._experienceBase.getManager("VCXDocManager").GetPropPath(e);if(!s)return Promise.reject(new Error("No property path"));var l=s.GetValueURL().Value,u=this._findInCache(e,t,n,a);if(u&&u.effectImage)return u.effectImage.deferred.promise;var c=document.createElement("canvas");c.deferred=UWA.Promise.deferred(),this._addToCache(e,t,n,a,c);var h=t&o.Effect.RemoveBorder,p=t&o.Effect.BlankRest,d=t&o.Effect.RedimensionPower2,g=new i;return void 0!==n&&void 0!==a&&g.setPreferredSize(n,a),g.loadFrom(l,()=>{var e=g.getPixelWidth(),t=g.getPixelHeight();if(h){var i={};if(g.buildBorderHist(i)){o=(new r).FromRGBA(0,0,0,0),_=(new r).FromRGBA(0,0,0,0);p&&(u=(new r).FromRGBA(0,0,0,1/255))}else{var n,a;for(var s in i)(void 0===n||i[s]>a)&&(n=s,a=i[s]);var o=(new r).FromHex(n),l=!1;if(a>t+e&&(l=!0),l){var u,_=(new r).FromRGBA(0,0,0,0);p&&(u=(new r).FromRGBA(0,0,0,1/255)),g.replaceKeyColorByOther(o,_,u)}}}if(g.fillCanvas(c),d&&(!g.isPowerOf2(g.getPixelWidth())||!g.isPowerOf2(g.getPixelHeight()))){var m=g.getNearestPow2(g.getPixelWidth()),f=g.getNearestPow2(g.getPixelHeight()),M=document.createElement("canvas");M.width=m,M.height=f;let e=M.getContext("2d");null==e||e.drawImage(c,0,0,m,f);var C=c.deferred;(c=M).deferred=C}c._IsReadyToUse=!0,c.deferred.resolve(c)}),c.deferred.promise}get componentType(){return"VCXImageManager"}}return function(e){let t;!function(e){e[e.None=0]="None",e[e.RedimensionPower2=1]="RedimensionPower2",e[e.RemoveBorder=2]="RemoveBorder",e[e.BlankRest=4]="BlankRest"}(t=e.Effect||(e.Effect={}))}(o||(o={})),o}),define("DS/VCXWebVisualization/VCXBillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/VCXWebSystem/VCXMathTools","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";new i.Projector;var n=new i.Vector3,a=new i.Matrix4,r=new i.Matrix4,s=new i.Matrix4;return e.extend({_getDynamicMatrix:function(e,o,l){if("PRESERVE_X_AXIS_Y_IN_CAM_PLANE"!==this.BillBoardType&&"PRESERVE_X_AXIS_Z_IN_CAM_PLANE"!==this.BillBoardType)return this._parent(e,o,l);e||(a.identity(),e=a);var u=l||o.viewpoint;s.identity(),s.extractRotation(e);var c,h=t.getOFromMatrix(e).sub(u.getEyePosition()).normalize();c="PRESERVE_X_AXIS_Y_IN_CAM_PLANE"===this.BillBoardType?t.getVzFromMatrix(e).dot(h):t.getVyFromMatrix(e).dot(h);var p=h.clone();return c<0&&p.negate(),r=t.getMatrixFromOVzVx(new i.Vector3,p,t.getVxFromMatrix(e)),a.getInverse(s),s.multiplyMatrices(a,r),this._matrix&&s.setPosition(n.getPositionFromMatrix(this._matrix)),s}})}),define("DS/VCXWebVisualization/VCXPickInfo",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools","DS/VCXWebVisu/VCXModifiablesAccess"],function(e,t,i,n){"use strict";var a=e.extend({init:function(e,i){if(this._experienceBase=i,this._viewer=e,!this._viewer&&this._experienceBase&&(this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer()),this._experienceBase){var n=this._experienceBase.getManager("VCXDressupManager").QueryInterface("VCXIModelNavigable");this._currentWorkingRoot=n.getWorkingRoot().GetObject()}this._pathElement=null,this._modifiableIsDirty=!0,this._modifiable=null,this._position=new t.Vector3,this._normal=new t.Vector3(0,1,0),this._xAxis=null,this._matrixIsDirty=!0,this._matrix=null,this._smartMouse=new t.Vector2},reset:function(){this._viewer=null,this._experienceBase=null,this._pathElement=null,this._modifiableIsDirty=!0,this._modifiable=null,this._position=null,this._normal=null,this._matrixIsDirty=!0,this._matrix=null,this._smartMouse=null,this._canonic=null},clone:function(){var e=new a(this._viewer,this._experienceBase);return e._pathElement=this._pathElement&&this._pathElement.clone(),e._modifiableIsDirty=this._modifiableIsDirty,e._modifiable=this._modifiable,e._position=this._position&&this._position.clone(),e._normal=this._normal&&this._normal.clone(),e._xAxis=this._xAxis&&this._xAxis.clone(),e._matrixIsDirty=this._matrixIsDirty,e._matrix=this._matrix&&this._matrix.clone(),e._smartMouse=this._smartMouse&&this._smartMouse.clone(),e._canonic=this._canonic,e.magnet=this.magnet,e}});return Object.defineProperty(a.prototype,"pathElement",{enumerable:!0,get:function(){return this._pathElement},set:function(e){this._pathElement=e,this._modifiableIsDirty=!0}}),Object.defineProperty(a.prototype,"modifiable",{enumerable:!0,get:function(){return this._modifiableIsDirty&&this._experienceBase&&(this._pathElement?(this._modifiable=n.GetModifiableFromPathElement(this._pathElement,this._experienceBase),this._modifiable):this._modifiable=null,this._modifiableIsDirty=!1),this._modifiable}}),Object.defineProperty(a.prototype,"canonic",{enumerable:!0,get:function(){return this._canonic},set:function(e){this._canonic=e}}),Object.defineProperty(a.prototype,"globalPosition",{enumerable:!0,get:function(){return this.zShiftRatio&&this.pathElement&&this.size?this._position.clone().add(this._normal.clone().normalize().multiplyScalar(this.size*this.zShiftRatio||0)):this._position},set:function(e){this._position=e,this._matrixIsDirty=!0}}),Object.defineProperty(a.prototype,"localPosition",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");return t?t.getPositionInLCS(this._viewer,this.globalPosition):this.globalPosition.clone()}}),Object.defineProperty(a.prototype,"globalNormal",{enumerable:!0,get:function(){return this._normal},set:function(e){this._normal=e,this._matrixIsDirty=!0}}),Object.defineProperty(a.prototype,"localNormal",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");if(t)return t.getDirectionInLCS(this._viewer,this.globalNormal)}}),Object.defineProperty(a.prototype,"globalXAxis",{enumerable:!0,get:function(){return this._xAxis},set:function(e){this._xAxis=e,this._matrixIsDirty=!0}}),Object.defineProperty(a.prototype,"localXAxis",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");if(t)return t.getDirectionInLCS(this._viewer,this.globalXAxis)}}),Object.defineProperty(a.prototype,"globalMatrix",{enumerable:!0,get:function(){return this._matrixIsDirty&&(this._xAxis?this._matrix=i.getMatrixFromOVzVx(this._position,this._normal,this._xAxis):this._matrix=i.getMatrixFromOVz(this._position,this._normal),this.zShiftRatio&&this.pathElement&&this.size&&this._matrix.setPosition(this._position.clone().add(this._normal.clone().normalize().multiplyScalar(this.size*this.zShiftRatio||0))),this._matrixIsDirty=!1),this._matrix}}),Object.defineProperty(a.prototype,"localMatrix",{enumerable:!0,get:function(){var e=this.modifiable;e||(e=this._currentWorkingRoot);var t=e.QueryInterface("W3AISGNodeHolder");if(t)return t.getMatrixInLCS(this._viewer,this.globalMatrix)}}),Object.defineProperty(a.prototype,"workingRootMatrix",{enumerable:!0,get:function(){var e=this._currentWorkingRoot.QueryInterface("W3AISGNodeHolder");if(e)return e.getMatrixInLCS(this._viewer,this.globalMatrix)}}),Object.defineProperty(a.prototype,"viewer",{enumerable:!0,get:function(){return this._viewer}}),Object.defineProperty(a.prototype,"smartMouse",{enumerable:!0,get:function(){return this._smartMouse},set:function(e){this._smartMouse=e}}),Object.defineProperty(a.prototype,"linkPathElement",{enumerable:!0,get:function(){return this.modifiable?this.modifiable.GetObject().QueryInterface("W3AISGNodeHolder").getPathElement():this._experienceBase.getManager("VCXContextManager").getRootPathElement()}}),Object.defineProperty(a.prototype,"size",{enumerable:!0,get:function(){var e=this.magnet&&this.magnet.radius;if(e>0)return 2*e;var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();return this.linkPathElement&&this.linkPathElement.getBoundingSphere(t).radius||1}}),a}),define("DS/VCXWebVisualization/VCXPublishRasterImage",["UWA/Class","DS/VCXWebIO/VCXPixelImage","DS/VCXWebKernelCommands/VCXCmdGoToScenario","i18n!DS/VCXWebVisualization/assets/nls/VCXWebVisualization"],function(e,t,i,n){"use strict";var a=e.extend({init:function(){},getUsePaperRatio:function(){return void 0===this._usePaperRatio||this._usePaperRatio},captureViewport:function(e,i){var n=e.getManager("VCXVisuManager");n.setTileOutput(!0);var a=this._viewer?this._viewer:e.getManager("VCXContextManager").getMainViewer(),r=i||1,s={data:null,width:r*a.SCREEN_WIDTH,height:r*a.SCREEN_HEIGHT};a.renderToTarget(s,a.currentViewpoint);var o=null;return null!==s.data&&(o=new t(s.data,s.width,s.height)).flipVertical(),n.setTileOutput(!1),UWA.Promise.resolve(o)},_doHiResImage:async function(e,i,a,r){var s=e.getManager("VCXExperience");await s.getAllActorsReadiness();var o=this._viewer||e.getManager("VCXContextManager").getMainViewer(),l=e.getManager("VCXVisuManager");l.hideDecorations("RasterImage",o),l.setTileOutput(!0);var u=e.getManager("VCXPaperManager"),c=u.AutoFit,h=u.Zoom,p=u.Pan.clone(),d=Math.floor(i),g=Math.floor(a);if(this.getUsePaperRatio()){var _=Math.floor(i*u.Ratio);Math.abs(g-_)>1&&(g=_)}var m=!0,f=null;this._image&&this._image.getPixelWidth()===d&&this._image.getPixelHeight()===g&&(f=this._image._bufferRGBA,m=!1);var M={data:f,width:d,height:g};let C={x:Math.floor(d/window.devicePixelRatio),y:Math.floor(g/window.devicePixelRatio)};var b;this.getUsePaperRatio()&&(u.AutoFit=!0,u.updatePaper({viewportSize:C}));var v=e.getManager("VCXContextManager").getActiveViewport().QueryInterface("VCXIModifiable").GetPropertyValue("Environment.SSAO")>1;let V={viewer:o,viewpoint:o.currentViewpoint,mainOverrideSet:void 0,buffer:void 0,viewportSize:C},x=e.ComponentsMap.GetComponentFromType("VCXDressup_Spec").concat(e.ComponentsMap.GetComponentFromType("VCXComponentOccurrenceComposer"));if(r)for(const e of x){let t=e.QueryInterface("VCXIPrepareRenderToTexture");t&&await t.prepareRender(V,"normal")}try{o.renderToTarget(M,o.currentViewpoint,g>o.SCREEN_HEIGHT,{SSAO:v,IterativeSSAO:!1,AntiAliasing:"SMAA",nbIterations:1})}catch(t){if(b=t,t instanceof RangeError&&e){var y=n["RasterImage.SizeTooBig"],P=e.getManager("VCXNotificationManager");if(P){var w={level:"error",title:"error",message:y};P.addNotification(w)}}throw t}if(!b&&null!==M.data&&(m&&(this._image=new t(M.data,M.width,M.height)),this._image.flipVertical(),r)){try{V.canvas=this._image.toCanvas();for(const e of x){let t=e.QueryInterface("VCXIPrepareRenderToTexture");t&&await t.postRender(V,"normal")}}catch(e){console.warn(e)}var S=V.canvas.getContext("2d").getImageData(0,0,V.canvas.width,V.canvas.height);this._image._bufferRGBA=new Uint8ClampedArray(S.data)}return this.getUsePaperRatio()&&(u.AutoFit=c,u.Zoom=h,u.Pan=p,u.updatePaper()),l.setTileOutput(!1),l.showDecorations("RasterImage",o),this._image},doHiRes:function(e,t,n,r,s){if(!e)return console.log("Experience is null !"),UWA.Promise.reject(new Error("Experience is null !"));var o=e.getManager("VCXScenarioManager");if(!o)return UWA.Promise.reject(new Error("VCXScenarioManager is null !"));if(!(r&&(r.mode===a.Mode.Selected||r.mode===a.Mode.All)))return this._doHiResImage(e,t,n,!0).then(e=>(e&&r.quality&&r.quality>=0&&r.quality<=1&&e.setQuality(r.quality),s&&s({image:e,scenario:o._Scenarios[o.GetCurrentScenario()]}),{image:e,scenario:o._Scenarios[o.GetCurrentScenario()]}));var l=e.getManager("VCXSelectionManager"),u=e.getManager("VCXSequenceManager");if(!u)return UWA.Promise.reject(new Error("VCXScenarioManager is null !"));for(var c=u?u.GetListSequencesFromType(0):[],h=[],p=0;p<c.length;p++){var d=c[p];if(d)for(var g=d.GetListScenariosId(),_=0;_<g.length;_++){var m=g[_],f=o.GetScenarios()[m];f&&f._ID&&(r.mode!==a.Mode.Selected||l.isIn(f))&&h.push(f._ID)}}var M=o?o.GetCurrentScenario():null,C=!1,b=e.getManager("VCXVisuManager");b&&(C=b.CameraControlsViewpoint,b.CameraControlsViewpoint=!0,b.CameraEasingTime=0);var v=this._viewer?this._viewer:e.getManager("VCXContextManager").getMainViewer();if(!v)return UWA.Promise.reject(new Error("viewer is null !"));if(!h.length)return UWA.Promise.reject(new Error("No scenario"));for(var V=e.getManager("VCXCommandManager"),x=null,y=[],P=0;P<h.length;++P)y.push(h[P]);return y.reduce((a,l)=>a.then(()=>((x=new i(o,V)).GoToScenario(l),V.Do(x),e._ManagerSet.update({viewer:v,viewpoint:v.currentViewpoint}),this._doHiResImage(e,t,n,!0).then(e=>{r&&r.quality&&r.quality>=0&&r.quality<=1&&e.setQuality(r.quality),s({image:e,scenario:o._Scenarios[l]})}))),UWA.Promise.resolve()).then(()=>{(x=new i(o,V)).GoToScenario(M),V.Do(x),b&&(b.CameraControlsViewpoint=C,b.CameraEasingTime=null)})},doThumbnailToDataUrl:async function(e,t,i,n){var r,s=e.getManager("VCXPaperManager"),o=Math.floor(t);r=this.getUsePaperRatio()?t*(s._ViewBoxPxSize.y/s._ViewBoxPxSize.x):Math.floor(i);const l=await this.doHiRes(e,o,r,{mode:a.Mode.Current,quality:.8,usePaper:!0});var u=l&&l.image;if(!u)return null;var c=document.createElement("canvas");c.width=u._width,c.height=u._height;var h=c.getContext("2d");let p,d;u._height<u._width?(p=n?u._height/n:u._width,d=u._height):(d=n?u._width*n:u._height,p=u._width);const g=document.createElement("canvas");g.width=p,g.height=d;const _=g.getContext("2d");let m=(c.width-g.width)/2,f=(c.height-g.height)/2;var M=h.getImageData(0,0,u._width,u._height);return M.data.set(u._bufferRGBA),_.putImageData(M,-m,-f),g.toDataURL("image/jpeg",.8)}});return a.Mode={Current:1,Selected:2,All:3},a}),define("DS/VCXWebVisualization/VCXIManipulable",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("DS/VCXWebVisualization/VCXIPrepareRenderToTexture",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("DS/VCXWebVisualization/VCXPaperManager",["DS/CoreEvents/Events","UWA/Class","DS/Visualization/ThreeJS_DS","css!DS/VCXWebVisualization/VCXWebVisualization.css"],function(e,t,i){"use strict";var n=t.extend({init:function(){},initialize:function(){this._PaperSize=new i.Vector2(297,210),this._zoom=1,this._lock=!1,this._fullFrame=!1,this._pan=new i.Vector2(0,0),this._panToCenter=new i.Vector2(0,0),this._viewer=null,this._ViewBox=new i.Vector2(0,0),this._ViewBoxSize=new i.Vector2(1,1),this._ViewBoxPx=new i.Vector2(0,0),this._ViewBoxPxSize=new i.Vector2(1,1),this._zPaper=null,this._paperDiv=null,this._paperDivContent=new UWA.Element("div",{id:"divPaperSpace"}),this._paperReferential=new i.Matrix4,this._usePaperReferential=!1},unInitialize:function(){if(this._paperDiv&&this._paperDiv.parentNode&&this._paperDiv.parentNode.removeChild(this._paperDiv),this._usableAreaUpdateEvent&&(e.unsubscribe(this._usableAreaUpdateEvent),delete this._usableAreaUpdateEvent),this._viewer){var t=this._viewer.currentViewpoint&&this._viewer.currentViewpoint.control;t&&t.onZoom&&t.onZoom(null),t&&t.onPan&&t.onPan(null);let e=this._viewer.div;e&&e.removeEvent&&this._onResizeDocking&&e.removeEvent("resize",this._onResizeDocking,!0)}this._viewer=null,this._paperDivContent=null},postInitialize:function(){if(this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer(),this._viewer){var t=this;this._usableAreaUpdateEvent=e.subscribe({event:"VCX_GUI_USABLEAREA_UPDATE"},function(e){(t._shouldConsiderUsableArea()&&JSON.stringify(e.area)!=JSON.stringify(t.area)||JSON.stringify(e.areaWithoutPanels)!=JSON.stringify(t._usableAreaRect))&&(t._usableAreaRect=e.area,t._usableAreaWithoutPanelsRect=e.areaWithoutPanels,t.updatePaper({propagateEvent:!0}))});var i=this._viewer.currentViewpoint;if(i&&i.control&&this._experienceBase.getManager("VCXContextManager").isSupported("Paper")&&this._experienceBase.getManager("VCXContextManager").isSupported("DisplayPaperCtrlBtns")){var n=i.control;n&&n.setPreventDefaultForCtrlKeyWheelActive&&n.setPreventDefaultForCtrlKeyWheelActive(!0);var a=function(e){if(e&&e.gesture&&e.gesture.currentEvent&&e.gesture.currentEvent[0]&&e.gesture.currentEvent[0].event&&e.gesture.currentEvent[0].event.ctrlKey||this._touchControl){var t=this._pan.clone();t.add(e.gesture.currentEvent[0].deltaPosition),this.Pan=t,e.defaultBehavior=!1}}.bind(this);n&&n.onPan&&n.onPan(a);var r=function(e){if(e&&e.factor&&e.evt&&e.evt.event&&e.evt.event.ctrlKey){var t=e.factor,i={x:e.evt.event.clientX,y:e.evt.event.clientY};this.zoomPaper(t,i),e.defaultBehavior=!1}}.bind(this);n&&n.onZoom&&n.onZoom(r)}if(!this._paperDiv){this._paperDiv=new UWA.Element("div",{id:"divPaperSpaceContainer"});var s=new UWA.Element("div",{id:"divPaperSpaceTop"}),o=new UWA.Element("div",{id:"divPaperSpaceLeft"}),l=new UWA.Element("div",{id:"divPaperSpaceBottom"}),u=new UWA.Element("div",{id:"divPaperSpaceRight"});this._paperDivContent.inject(this._paperDiv);new UWA.Element("div",{class:"paperCorners paperTop"}).inject(this._paperDivContent),new UWA.Element("div",{class:"paperCorners paperBottom"}).inject(this._paperDivContent);s.inject(this._paperDiv),o.inject(this._paperDiv),l.inject(this._paperDiv),u.inject(this._paperDiv),this._paperDiv.inject(this._viewer.div)}}this._autoFitDirty=!this._autoFit,this._autoFit=!0,this.updatePaper({propagateEvent:!0}),this._touchControl=!1;t=this;this._onResizeDocking=function(e){t.updatePaper({propagateEvent:!0})},this._onResizeWidget=function(e){e.target===window&&t.updatePaper({propagateEvent:!0})};let c=this._viewer.div;c&&c.addEvent&&this._onResizeDocking&&c.addEvent("resize",this._onResizeDocking,!1,0,!0)},update:function(e){this._frameToRender&&(this._frameToRender--,this._viewer.render())},setPreviewModeStyle(e){var t=document.getElementById("divPaperSpaceContainer");e?t.addClassName("vcxPreviewModeActive"):t.removeClassName("vcxPreviewModeActive")},postRender:function(e){this._zPaper=null},GetZPaper:function(e){if(null===this._zPaper){new i.Vector3;var t=this.ModelToMM2(e,e.viewer.getSceneBoundingSphere().center.clone());this._zPaper=t.z,this._zPaper>=1&&(this._zPaper=.8),this._zPaper<=0&&(this._zPaper=.2)}return this._zPaper},ToggleAutoFit:function(){return this.AutoFit=!this.AutoFit,this.AutoFit},ActivatePaperPan:function(e){this._touchControl=e},SetWidth:function(t){this._PaperSize.x=t,e.publish({event:"VCX_PAPER_RATIO_CHANGED"})},GetWidth:function(){return this._PaperSize.x},SetHeight:function(t){this._PaperSize.y=t,e.publish({event:"VCX_PAPER_RATIO_CHANGED"})},GetHeight:function(){return this._PaperSize.y},getDefaultOptions:function(){return{viewer:this._viewer,viewpoint:this._viewer.currentViewpoint}},getPaperReferential:function(){return this._paperReferential},shouldUsePaperReferential:function(){return this._usePaperReferential},setPaperReferential:function(e){this._paperReferential.copy(e)},setUsePaperReferential:function(e){this._usePaperReferential=e},_keepPaperCurrentPosition:function(e){var t=this._panToCenter.clone();this._panToCenter=e?new i.Vector2(this._usableAreaRect.left+.5*(this._usableAreaRect.width-this._viewportSize.x),this._usableAreaRect.top+.5*(this._usableAreaRect.height-this._viewportSize.y)):new i.Vector2(this._usableAreaWithoutPanelsRect.left+.5*(this._usableAreaWithoutPanelsRect.width-this._viewportSize.x),this._usableAreaWithoutPanelsRect.top+.5*(this._usableAreaWithoutPanelsRect.height-this._viewportSize.y)),this._pan=t.sub(this._panToCenter)},_shouldConsiderUsableArea:function(){if(!this._autoFit)return!1;if(this._experienceBase.odt)return!1;var e=this._viewer.div.clientWidth;if(this.lastUsableAreaWidth&&this.lastUsableAreaWidth.width===e)return this.lastUsableAreaWidth.useUsableArea;var t=this._experienceBase.getManager("VCXGUIManager").getUIResponsivenessParameters(e);return t&&"boolean"==typeof t.fitBetweenPanels?(this.lastUsableAreaWidth||(this.lastUsableAreaWidth={}),this.lastUsableAreaWidth.width=e,this.lastUsableAreaWidth.useUsableArea=t.fitBetweenPanels,t&&t.fitBetweenPanels):null},updatePaper:function(t){var n={};if(t&&(t.viewportSize||t.fullFrame))this._fullFrame=!0,this._specificViewer=!0,t.viewportSize?this._viewportSize=new i.Vector2(t.viewportSize.x,t.viewportSize.y):this._viewportSize=new i.Vector2(this._viewer.div.clientWidth,this._viewer.div.clientHeight),n.top=0,n.left=0,n.width=this._viewportSize.x,n.height=this._viewportSize.y;else{this._fullFrame=!1,this._specificViewer=!1,this._viewportSize=new i.Vector2(this._viewer.div.clientWidth,this._viewer.div.clientHeight),this._usableAreaRect||(this._usableAreaRect={top:0,left:0,width:this._viewportSize.x,height:this._viewportSize.y},this._usableAreaWithoutPanelsRect={top:0,left:0,width:this._viewportSize.x,height:this._viewportSize.y});var a=this._shouldConsiderUsableArea();if(a?(n.top=this._usableAreaRect.top,n.left=this._usableAreaRect.left,n.width=this._usableAreaRect.width,n.height=this._usableAreaRect.height):(n.top=this._usableAreaWithoutPanelsRect.top,n.left=this._usableAreaWithoutPanelsRect.left+20,n.width=this._usableAreaWithoutPanelsRect.width-40,n.height=this._usableAreaWithoutPanelsRect.height),this._autoFit){var r=this.Ratio,s=n.height/n.width;this._viewportSize.y>0&&(this._zoom=r>s?n.height/this._viewportSize.y:n.width/this._viewportSize.x),this._pan=new i.Vector2}}this._autoFit?this._panToCenter=new i.Vector2(n.left+.5*(n.width-this._viewportSize.x),n.top+.5*(n.height-this._viewportSize.y)):this._autoFitDirty&&!1===this._autoFit&&this._keepPaperCurrentPosition(a),this._autoFitDirty=!1,this._updateCameraOffset(t),t&&t.propagateEvent&&(e.publish({event:"/VCX/Paper/PanChanged",data:{value:this.Pan,updatePaper:!1,autoFit:this._autoFit}}),e.publish({event:"/VCX/Paper/ZoomChanged",data:{value:this.Zoom,updatePaper:!1,autoFit:this._autoFit}}),this.updatePaperViz(),this._frameToRender=2)},_updateViewBox:function(){var e=this.Size,t=this._viewportSize.y/this._viewportSize.x,i=e.y/e.x;let n=t;this._usableAreaRect&&this._usableAreaWithoutPanelsRect&&(n=this._shouldConsiderUsableArea()?this._usableAreaRect.height/this._usableAreaRect.width:this._usableAreaWithoutPanelsRect.height/this._usableAreaWithoutPanelsRect.width),i>n?(this._ViewBoxSize.y=e.y,this._ViewBoxSize.x=this._ViewBoxSize.y/t,this._ViewBoxPxSize.y=this._viewportSize.y,this._ViewBoxPxSize.x=this._ViewBoxPxSize.y/i):(this._ViewBoxSize.x=e.x,this._ViewBoxSize.y=this._ViewBoxSize.x*t,this._ViewBoxPxSize.x=this._viewportSize.x,this._ViewBoxPxSize.y=this._ViewBoxPxSize.x*i),this._ViewBoxSize.multiplyScalar(1/this.Zoom),this._ViewBox.subVectors(e,this._ViewBoxSize).multiplyScalar(.5),this._ViewBoxPxSize.multiplyScalar(this.Zoom),this._ViewBoxPx.subVectors(this._viewportSize,this._ViewBoxPxSize).multiplyScalar(.5),this._ViewBoxPx.add(this.Pan),this._ViewBoxPx.add(this._panToCenter)},updatePaperViz:function(){var e=document.getElementById("divPaperSpace"),t=document.getElementById("divPaperSpaceTop"),i=document.getElementById("divPaperSpaceLeft"),n=document.getElementById("divPaperSpaceRight"),a=document.getElementById("divPaperSpaceBottom");if(null!==e){var r=this._ViewBoxPx.x,s=this._ViewBoxPx.y,o=this._ViewBoxPxSize.x,l=this._ViewBoxPxSize.y;e.style.left=r+"px",e.style.top=s+"px",e.style.width=(o>0?o:0)+"px",e.style.height=(l>0?l:0)+"px",t.style.left="0px",t.style.top="0px",t.style.width=(this._viewportSize.x>0?this._viewportSize.x:0)+"px",t.style.height=(s>0?s:0)+"px",i.style.left="0px",i.style.top=s+"px",i.style.width=(r>0?r:0)+"px",i.style.height=(l>0?l:0)+"px",a.style.left="0px",a.style.top=s+l+"px",a.style.width=this._viewportSize.x+"px",a.style.height=this._viewportSize.y-(s+l)+"px",n.style.left=r+o+"px",n.style.top=s+"px",n.style.width=this._viewportSize.x-(r+o)+"px",n.style.height=l+"px"}},_updateCameraOffset:function(e){this._updateViewBox();let t=this._viewer;if(e&&e.viewer&&(t=e.viewer),t){var i=t.currentViewpoint;if(i){let e={fullWidth:this._ViewBoxPxSize.x,fullHeight:this._ViewBoxPxSize.y,x:-this._ViewBoxPx.x,y:-this._ViewBoxPx.y,width:this._viewportSize.x,height:this._viewportSize.y};i.setViewOffset(e)}}},MMToPixelRatio:function(e){e||(e=this.getDefaultOptions());var t=this._viewportSize.y;return e&&e.viewer&&e.viewer._zoomFactor&&(t*=e.viewer._zoomFactor),t/this._ViewBoxSize.y},_GetPan:function(e){if(this._specificViewer||e&&e.viewer&&e.viewer._isDigger){e||(e=this.getDefaultOptions());var t=new i.Vector2;return this._specificViewer&&t.add(this._ViewBoxPx),t.sub(e.viewpoint.camera),t.sub(new i.Vector2(this._viewportSize.x,this._viewportSize.y).multiplyScalar(.5)),t.add(this._ViewBoxPxSize.clone().multiplyScalar(.5)),e.viewer._zoomFactor&&t.multiplyScalar(e.viewer._zoomFactor),t}return(new i.Vector2).addVectors(this.Pan,this._panToCenter)},UnitValueToPixel:function(e){return e*this.MMToPixelRatio()*.352778*window.devicePixelRatio},MMToPixel:function(e){return e*this.MMToPixelRatio()},MMToPixelX:function(e){var t=0;return t=(e-this._ViewBox.x)*this.MMToPixelRatio(),t+=this.Pan.x,t+=this._panToCenter.x},MMToPixelY:function(e){var t=0;return t=(e-this._ViewBox.y)*this.MMToPixelRatio(),t+=this.Pan.y,t+=this._panToCenter.y},MMToPixel2:function(e,t){e||(e=this.getDefaultOptions());var n=new i.Vector2(0,0);return n.subVectors(t,this._ViewBox).multiplyScalar(this.MMToPixelRatio(e)).add(this._GetPan(e)),n},PixelToMM:function(e){return e/this.MMToPixelRatio()},PixelToMMX:function(e){return(e-(this.Pan.x+this._panToCenter.x))/this.MMToPixelRatio()+this._ViewBox.x},PixelToMMY:function(e){return(e-(this.Pan.y+this._panToCenter.y))/this.MMToPixelRatio()+this._ViewBox.y},PixelToMM2:function(e,t){e||(e=this.getDefaultOptions());var n=new i.Vector2(0,0);return n.subVectors(t,this._GetPan(e)).multiplyScalar(1/this.MMToPixelRatio(e)).add(this._ViewBox),n},ModelToMM2:function(e,t){var n=e.viewpoint.project(t),a=new i.Vector2(0,0);a=this.PixelToMM2(e,n);var r=new i.Vector3(0,0,0);return r.x=a.x,r.y=a.y,r.z=n.z,r},MMToModel2:function(e,t){var n=new i.Vector2(0,0);n.x=t.x,n.y=t.y;var a=new i.Vector2(0,0);a=this.MMToPixel2(e,n);var r=new i.Vector3(0,0,0);return r.x=a.x,r.y=a.y,r.z=t.z,e.viewpoint.unProject(r)},GetMmToPxRatio:function(e){var t=new i.Vector2(0,0),n=new i.Vector2(1,0),a=this.MMToPixel2(e,t),r=this.MMToPixel2(e,n);return a.distanceTo(r)},GetModelToPixelRatio:function(e,t){let i=t.clone().add(e.viewpoint.getUpDirection()),n=t.clone().sub(e.viewpoint.getUpDirection());var a=e.viewpoint.project(i),r=e.viewpoint.project(n);return.5*a.distanceTo(r)},GetPaperRatio:function(e,t){e||(e=this.getDefaultOptions());var n=1;if(!t||null===t)return n;var a=(new i.Vector3).addVectors(t,e.viewpoint.getUpDirection()),r=this.ModelToMM2(e,t),s=this.ModelToMM2(e,a),o=t.distanceTo(a),l=r.distanceTo(s);return 0!==l&&(n=o/l),n},GetModelPointFromModelPointAndPaperPosition:function(e,t,n,a){var r,s=e.viewpoint.getSightDirection(),o=e.viewpoint.getUpDirection(),l=(new i.Vector3).crossVectors(s,o).normalize(),u=(new i.Vector3).crossVectors(s,l).normalize(),c=l.multiplyScalar(n.x),h=u.multiplyScalar(n.y),p=c.clone().add(h).normalize();if(a>0){var d=Math.min(this.Size.x,this.Size.y);(g=a/(_=this.GetPaperRatio(e,t)))<.04*d?g=.04*d:g>.7*d&&(g=.7*d),r=g*_}else{var g,_;r=(g=Math.sqrt(n.x*n.x+n.y*n.y))*(_=this.GetPaperRatio(e,t))}var m=p.multiplyScalar(r);return(new i.Vector3).addVectors(t,m)},setPaperVisibility:function(e){if(this._paperDiv){!0===e?this._paperDiv.style.display="":!1===e?this._paperDiv.style.display="none":console.log("[VCXPaperManager::setPaperVisibility] Parameter is not a boolean. Aborting.");var t=this._experienceBase.getManager("VCXVisuManager").getActiveViewport();if(t){var i=t.QueryInterface("VCXIModifiable");if(i){i.OnChangePropertiesEnd();var n=i.QueryInterface("W3AISGNodeHolder");n&&n.setSGNodeDirty(!0)}}}},getPaperVisibility:function(){return!!this._paperDiv&&""===this._paperDiv.style.display},zoomPaper:function(e,t){var n=1+.05*e,a=.5*this._viewer.SCREEN_WIDTH,r=.5*this._viewer.SCREEN_HEIGHT;t.x>0&&t.x<this._viewer.SCREEN_WIDTH&&t.y>0&&t.y<this._viewer.SCREEN_HEIGHT&&(a=t.x,r=t.y);var s=.5*(this._ViewBoxPxSize.x>0?this._ViewBoxPxSize.x:0)+this._ViewBoxPx.x,o=.5*(this._ViewBoxPxSize.y>0?this._ViewBoxPxSize.y:0)+this._ViewBoxPx.y,l=n*(s-a)+a,u=n*(o-r)+r,c=this._pan.clone();c.add(new i.Vector2(l-s,u-o));var h=this.Zoom;this.Zoom*=n,h!==this.Zoom&&(this.Pan=c)}});return Object.defineProperty(n.prototype,"Pan",{enumerable:!0,get:function(){return this._fullFrame?new i.Vector2:this._pan},set:function(e){this._lock||this._pan.equals(e)||(this._pan=e,this._autoFitDirty=this._autoFit,this._autoFit=!1,this.updatePaper({propagateEvent:!0}))}}),Object.defineProperty(n.prototype,"Zoom",{enumerable:!0,get:function(){return this._fullFrame?1:this._zoom},set:function(e){this._lock||this._zoom!==e&&(this._zoom=e,this._zoom<=0&&(this._zoom=.01),this._autoFitDirty=this._autoFit,this._autoFit=!1,this.updatePaper({propagateEvent:!0}))}}),Object.defineProperty(n.prototype,"AutoFit",{enumerable:!0,get:function(){return this._autoFit},set:function(e){this._lock||(this._autoFitDirty=this._autoFit!==e,this._autoFit=e,this.updatePaper({propagateEvent:!0}))}}),Object.defineProperty(n.prototype,"Size",{enumerable:!0,get:function(){return new i.Vector2(this._PaperSize.x,this._PaperSize.y)}}),Object.defineProperty(n.prototype,"Ratio",{enumerable:!0,get:function(){var e=1;return this._PaperSize.x&&(e=this._PaperSize.y/this._PaperSize.x),e>1&&this._PaperSize.x>this._PaperSize.y?this._PaperSize.x/this._PaperSize.y:this._PaperSize.y/this._PaperSize.x}}),Object.defineProperty(n.prototype,"Lock",{enumerable:!0,get:function(){return this._lock},set:function(e){this._lock=e}}),Object.defineProperty(n.prototype,"componentType",{enumerable:!0,get:function(){return"VCXPaperManager"}}),n}),define("DS/VCXWebVisualization/VCXRulersUnitEnum",["require","exports","DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(e,t,i,n){"use strict";var a;return function(e){let t,a;!function(e){e[e.Micrometers=i.MICRON_UNIT]="Micrometers",e[e.Millimeters=i.MM_UNIT]="Millimeters",e[e.Centimeters=i.CM_UNIT]="Centimeters",e[e.Meters=i.M_UNIT]="Meters",e[e.Kilometers=i.KM_UNIT]="Kilometers",e[e.Inches=i.INCH_UNIT]="Inches",e[e.Feet=i.FOOT_UNIT]="Feet",e[e.Yards=i.YARD_UNIT]="Yards"}(t=e.VCXLinearRulerUnitEnum||(e.VCXLinearRulerUnitEnum={})),function(e){e[e.Radians=n.RAD_UNIT]="Radians",e[e.Degrees=n.DEG_UNIT]="Degrees",e[e.Grades=n.GRAD_UNIT]="Grades"}(a=e.VCXAngularRulerUnitEnum||(e.VCXAngularRulerUnitEnum={}))}(a||(a={})),a}),define("DS/VCXWebVisualization/VCXVisuManager",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Plugins/UserRenderList","DS/Effects/SpatialOccupationEffect","DS/VCXWebVisibility/VCXIVisibility","DS/Visualization/SceneGraphUtils","DS/Visualization/Ambience","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/Mesh/Mesh","DS/VCXWebSystem/VCXTextTools","DS/VCXWebVisu/VCXVisuTools","DS/VCXWebSystem/VCXHardwareServices","DS/Visualization/ModelLoader","DS/Visualization/Node3D","i18n!DS/VCXWebVisualization/assets/nls/VCXWebVisualization","DS/VCXWebVisualization/VCXInteractor"],function(e,t,i,n,a,r,s,o,l,u,c,h,p,d,g,_,m,f){"use strict";var M=e.extend({init:function(){this._onIdleSSAOCB=null,this._isInTransition=!1,this._CameraControlsViewpoint=!1,this._CameraEasingTime=5,this._modelLoaded=[]},postInitialize:function(){this._timerWithNoRefresh=0,this._idle=!1,this._idleCBs=[],this._idleIndex=1,this._activeViewport=null,this._bUpdateViewport=!0,this.CameraControlsViewpoint=!1,this._verticalFrame=new n.Matrix4,this._inverseVerticalFrame=new n.Matrix4,this._hideDecorationToken=0,"1"==this._experienceBase.getManager("VCXContextManager").getUrlVars().fps&&this._experienceBase.getManager("VCXContextManager").getMainViewer().setDebugFPS(!0),this._experienceBase.getManager("VCXContextManager").getMainViewer().setOIT(!0);var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();this._onViewpointToken=i.subscribe({event:"/VISU/"},t=>{t&&t.viewpoint&&"@onViewpointChange"===t.eventType&&e===t.viewpoint.viewer&&(this.viewpointHasMovedRequested=!0)}),this._onVisuAmbianceStateChangeToken=e.onVisuAmbianceStateChange&&e.onVisuAmbianceStateChange(()=>{this._ambienceProcessings&&(this._ambienceProcessings.resolve(),this._ambienceProcessings=null,this.showDecorations("AmbienceLoading",e))},()=>{if(!this._ambienceProcessings){this.hideDecorations("AmbienceLoading",e),this._ambienceProcessings=UWA.Promise.deferred();var t=this.QueryInterface("VCXIReadiness");t&&t.registerPromise(this._ambienceProcessings.promise)}},()=>{this._ambienceProcessings&&(this._ambienceProcessings.resolve(),this._ambienceProcessings=null,this.showDecorations("AmbienceLoading",e))}),this._experienceBase.getManager("VCXContextManager").isSupported("DefaultViewpointControler")&&window.widget&&(this._addNavigationPreferences(),this.SetController(window.widget.getValue("Mouse_Controls_Profile"),window.widget.getValue("Rotation_Rolling")),this._widgetEvents=window.widget.addEvents&&window.widget.addEvents({endEdit:e=>{e.submitted&&this._updateFromWidget()}}))},SetController:function(e,t){this._experienceBase.getManager("VCXContextManager").getMainViewer().currentViewpoint.getControl().setRotationRolling(t)},_updateFromWidget:function(){localStorage.setItem("DS_VCX_ROTATION_ROLLING",window.widget.getValue("Rotation_Rolling")),this.SetController(window.widget.getValue("Mouse_Controls_Profile"),window.widget.getValue("Rotation_Rolling"))},_addNavigationPreferences:function(){var e=localStorage.getItem("DS_VCX_ROTATION_ROLLING");e||(e=!1),window.widget.addPreference({type:"boolean",name:"Rotation_Rolling",label:"Rotation Rolling",defaultValue:e,disabled:!1})},unInitialize:function(){if(this._activeViewport=null,this._defaultAmbiencePromise&&delete this._defaultAmbiencePromise,this._widgetEvents&&window.widget.removeEvents(this._widgetEvents),this._idleCBs=[],delete this._spatialOccupationEffect,this._onViewpointToken&&(i.unsubscribe(this._onViewpointToken),this._onViewpointToken=null),this._onVisuAmbianceStateChangeToken){var e=this._experienceBase.getManager("VCXContextManager").getMainViewer();e&&e.unsubscribeFromArray(this._onVisuAmbianceStateChangeToken),this._onVisuAmbianceStateChangeToken=null}this.defaultAmbience&&(this.defaultAmbience.dispose(),this.defaultAmbience=null),this._defaultAmbiencePromise=null,this._modelLoaded=[]},getUpdatePriority:function(){return-7},getVersion:function(){return"3.1.3"},addOnIdleCB:function(e,t){var i={};return t||(t=.5),i.time=t,i.idle=!1,i.cbFunction=e,i.id=this._idleIndex,this._idleIndex++,this._idleCBs.push(i),i.id},removeOnIdleCB:function(e){for(var t=0;t<this._idleCBs.length;t++)if(this._idleCBs[t].id===e)return this._idleCBs.splice(t,1),!0;return!1},setActiveViewport:function(e){this._activeViewport=e},getActiveViewport:function(){return this._activeViewport},setUpdateViewport:function(e){this._bUpdateViewport=e},setUsableInteractors:function(e){f.enableInteractors=e},getUpdateViewport:function(){return this._bUpdateViewport},setTransitionMode:function(e){this._isInTransition=e},isInTransitionMode:function(){return this._isInTransition},setTileOutput:function(e){this._isInTileMode=e},setVertical:function(e){var t=new n.Vector3(1,0,0),i=new n.Vector3(0,1,0),a=new n.Vector3(0,0,1);switch(e){case 0:t.set(0,1,0),i.set(0,0,1),a.set(1,0,0);break;case 1:t.set(0,0,1),i.set(1,0,0),a.set(0,1,0);break;case 2:break;case 3:t.set(0,0,1),i.set(0,1,0),a.set(-1,0,0);break;case 4:t.set(1,0,0),i.set(0,0,1),a.set(0,-1,0);break;case 5:t.set(0,1,0),i.set(1,0,0),a.set(0,0,-1)}return this._verticalFrame.makeBasis(t,i,a),this._inverseVerticalFrame.getInverse(this._verticalFrame),this._verticalFrame},getMatrixToAdjustVertical:function(e){return this._verticalFrame},getInverseMatrixToAdjustVertical:function(e){return this._inverseVerticalFrame},getOccupationGrid:function(e,t,i){var n=this._experienceBase.getManager("VCXContextManager").getRootNode();if(n&&(n._PassToCheckAvailableSpaceAdded||(n._PassToCheckAvailableSpaceAdded=!0,n.setRenderPasses(["main","PassToCheckAvailableSpace"]))),this._previousSizeX===e&&this._previousSizeY===t||(this._previousSizeX=e,this._previousSizeY=t,this._spatialOccupationEffect=new r(i,{targetWidth:e,targetHeight:t,name:"PassToCheckAvailableSpace"})),this._spatialOccupationEffect){var a=this._experienceBase.getManager("VCXPaperManager");a.updatePaper({viewportSize:{x:this._previousSizeX,y:this._previousSizeY}});var s=this._spatialOccupationEffect.renderResult({flipImage:!1});return a.updatePaper(),i.currentViewpoint.camera._hasChanged=!1,s}},isInFrustum:function(e,t){if(this._isInTileMode)return!0;var i=!0;if(t.GetPropertyValue("Collab.HideIfOutsideAnchorFrustrum")){i=!1;var a=new n.Frustum;return a.setFromMatrix((new n.Matrix4).multiplyMatrices(e.viewpoint.camera.projectionMatrix,e.viewpoint.camera.matrixWorldInverse)),t.processAnchorsIDs(r=>{var o=t._Anchors[r];if(o){var l=!0,u=o.GetValueLink().Value;if(u){var c=this._experienceBase.ComponentsMap.GetComponentFromID(u);if(c){var h=c.QueryInterface("VCXIVisibility");h&&h.GetVisibility()===s.EVisState.Hidden&&(l=!1)}}if(l){var p=t.GetAnchorWorldMatrix(r,e);if(p&&a.containsPoint((new n.Vector3).getPositionFromMatrix(p)))return i=!0,!1}}}),i}return i},areAllAnchorsReadyAndVisible:function(e,t){let i=!0;return t.processAnchorsIDs(n=>{var a=t._Anchors[n];if(a){var r=a.GetValueLink().Value;if(r){var o=this._experienceBase.ComponentsMap.GetComponentFromID(r);if(o){const t=o.QueryInterface("W3AISGNodeHolder");if(t&&t.getPathElement()){var l=o.QueryInterface("VCXIVisibility");l&&(i=l.GetVisibility()!==s.EVisState.Hidden&&p.buildGraphicPropertiesStructure(o,e&&e.viewer,{getVisibility:!0})[0].visible.Visibility)}else i=!1}}}return i}),i},getRenderList:function(e){var t=this._experienceBase.getManager("VCXContextManager").getFrameWindow();return t?(t._renderList||(t._renderList={}),t._renderList[e]||(t._renderList[e]=new a(e)),t._renderList[e]):null},createViewerLayers:function(e){e.setPickingMode("@Edge",c.PICK_VISIBLE);var t=e.getUserPassManager();if(t){var i,n,a,r={};i="VCXBackground",(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setEnableStencilTest(!1),a.setEnableStencilWrite(!1),a.setDisableColorWrite(!1),a.setDisableBackFaceCulling(!1),a.setDisableDepthWrite(!0),a.setDepthFunc("ALWAYS"),r[i]=a),i="VCXBackground2DDressups",(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setEnableStencilTest(!1),a.setEnableStencilWrite(!1),a.setDisableColorWrite(!1),a.setDisableBackFaceCulling(!1),a.setDisableDepthWrite(!0),a.setDepthFunc("ALWAYS"),r[i]=a),i="VCXGround",(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setEnableStencilTest(!1),a.setEnableStencilWrite(!1),a.setDisableColorWrite(!1),a.setDisableBackFaceCulling(!1),a.setDisableDepthWrite(!0),a.setDepthFunc("ALWAYS"),r[i]=a),i="VCXBackground3DDressups",(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setEnableStencilTest(!1),a.setEnableStencilWrite(!1),a.setDisableColorWrite(!1),a.setDisableBackFaceCulling(!1),a.setDisableDepthWrite(!0),a.setDepthFunc("ALWAYS"),r[i]=a),i="VCXOc3DDressups",(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),n="VCXPreNOc3DDressups",i="VCXNOc3DDressups",(a=t.createUserClearPass(n,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setClearStencil(!0),a.setClearDepth(!0),r[n]=a),(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),n="VCXPreRaytracing",i="VCXRaytracing",(a=t.createUserClearPass(n,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setClearStencil(!1),r[n]=a),(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),n="VCXPre2DDressups",i="VCX2DDressups";(a=t.createUserClearPass(n,this.getRenderList(n)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setClearStencil(!0),a.setClearDepth(!0),r[n]=a),(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),(a=t.createUserRenderPass("VCX2DDressups2",this.getRenderList("VCX2DDressups2")))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r.VCX2DDressups2=a),n="VCXPre3DManipulators",i="VCX3DManipulators",(a=t.createUserClearPass(n,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setClearStencil(!1),a.setClearDepth(!0),r[n]=a),(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),n="VCXPreManipulators",i="VCXManipulators",(a=t.createUserClearPass(n,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setClearStencil(!1),a.setClearDepth(!0),r[n]=a),(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),n="VCXPreForeground",i="VCXForeground",(a=t.createUserClearPass(n,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),a.setClearStencil(!1),a.setClearDepth(!0),r[n]=a),(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a),i="VCXNoAADressups",(a=t.createUserRenderPass(i,this.getRenderList(i)))&&(a._passes[0].setScene(e.internalSceneGraph.scene),r[i]=a);var s=t.getSystemPass("main"),o=t.getSystemPass("infinitePlane"),l=t.getSystemPass("noEffectNoz"),u=t.getSystemPass("canvas2D");u._list="canvas2D",t.insertUserPassBeforePass(r.VCXGround,o),t.insertUserPassBeforePass(r.VCXBackground,r.VCXGround),t.insertUserPassAfterPass(r.VCXBackground2DDressups,o),t.insertUserPassAfterPass(r.VCXBackground3DDressups,r.VCXBackground2DDressups),t.insertUserPassAfterPass(r.VCXPreRaytracing,s),t.insertUserPassAfterPass(r.VCXRaytracing,r.VCXPreRaytracing),t.insertUserPassAfterPass(r.VCXOc3DDressups,r.VCXRaytracing),t.insertUserPassAfterPass(r.VCXPreNOc3DDressups,r.VCXOc3DDressups),t.insertUserPassAfterPass(r.VCXNOc3DDressups,r.VCXPreNOc3DDressups),t.insertUserPassAfterPass(r.VCXPre2DDressups,l),t.insertUserPassAfterPass(r.VCX2DDressups,r.VCXPre2DDressups),t.insertUserPassAfterPass(r.VCX2DDressups2,r.VCX2DDressups),t.insertUserPassAfterPass(r.VCXPre3DManipulators,r.VCX2DDressups2),t.insertUserPassAfterPass(r.VCX3DManipulators,r.VCXPre3DManipulators),t.insertUserPassAfterPass(r.VCXNoAADressups,u),t.insertUserPassAfterPass(r.VCXPreManipulators,r.VCXNoAADressups),t.insertUserPassAfterPass(r.VCXManipulators,r.VCXPreManipulators),t.insertUserPassAfterPass(r.VCXPreForeground,r.VCXManipulators),t.insertUserPassAfterPass(r.VCXForeground,r.VCXPreForeground),e.setPickingPriority([{id:"VCXMagnetCenterActive",priority:90},{id:"VCXMagnetPointActive",priority:80},{id:"VCXMagnetAxisActive",priority:70},{id:"VCXMagnetLineActive",priority:60},{id:"VCXMagnetCircleActive",priority:55},{id:"VCXMagnetPlaneActive",priority:10},{id:"VCXMagnetCenter",priority:50},{id:"VCXMagnetPoint",priority:40},{id:"VCXMagnetAxis",priority:30},{id:"VCXMagnetLine",priority:20},{id:"VCXMagnetCircle",priority:15},{id:"VCXMagnetPlane",priority:10},{id:"VCXDressup",priority:7},{id:"VCXSection",priority:-10},{id:"VCXMagnetGrid",priority:5}]),e._VCXLayersCreated=!0}},update:function(e){this._parent(e),this._experienceBase.getManager("VCXContextManager").applyToViewers(e=>{e._VCXLayersCreated||this.createViewerLayers(e)}),this.viewpointHasMoved=this.viewpointHasMovedRequested;var t=e.viewpoint.control.update();if(this.viewpointHasMoved|=t,this.viewpointHasMovedRequested=!1,this.viewpointHasMoved&&this.getActiveViewport()){var i=this.getActiveViewport().QueryInterface("VCXIViewpointController");i&&i.fromViewpoint()}this._renderPriorityDirty&&this.activateRenderPriorityIfNeeded()},dirtifyRenderPriority:function(){this._renderPriorityDirty=!0},setTransparentBackground:function(e){var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();e?(t.ambience.getBackground().setActivated(!1),t.setGrid(!1),t.setBackgroundColor("rgb(0,0,0)","0"),this._transparentBackground=!0):(t.removeAmbience(),t.restoreAmbiance(),this._transparentBackground=!1)},showDecorations:function(e,t,n){if(1===this._hideDecorationToken)i.publish({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION",data:{Source:e,viewer:t}});else if(this._hideDecorationToken<1)return;this._hideDecorationToken-=1,n&&t.render()},hideDecorations:function(e,t,n){0===this._hideDecorationToken&&i.publish({event:"VCX_TEMPORARILY_HIDE_DECORATION",data:{Source:e,viewer:t}}),this._hideDecorationToken+=1,n&&t.render()},updateGroundPosition:function(e){var t=this._experienceBase.getManager("VCXContextManager");if(t&&t.getMainViewer()){var a={},r=!1;if(e&&e.radius>0?(a.groundSize=2*e.radius,a.ambienceGroundSize=e.radius):r=!0,e&&e.position?a.groundCenter=e.position:r=!0,r){var s=t.getRootPathElement();if(s){var l=o.getOrientedBoundingBoxFromPathElements([s],new n.Matrix4,t.getMainViewer());l&&!isNaN(l.cornerPoint.x)&&(e&&e.radius>0||(a.groundSize=3*Math.max(l.firstAxis.x,l.secondAxis.y),a.ambienceGroundSize=20*a.groundSize),e&&e.position||(a.groundCenter=new n.Vector3(l.cornerPoint.x+.5*l.firstAxis.x,l.cornerPoint.y+.5*l.secondAxis.y,l.cornerPoint.z)))}}e&&e.ambience&&(a.groundCenter&&e.ambience.setGroundPosition(a.groundCenter),a.ambienceGroundSize&&e.ambience.setGroundRadius(a.ambienceGroundSize)),t.applyToViewers(function(e){e.setAutomaticPlaneUpdate(!1),e.setGroundOptions(a)}),i.publish({event:"VCX_GROUND_UPDATE_AUTO"})}},setDefaultAmbienceOptions:function(e){this.defaultAmbienceOptions=e},activateDefaultAmbience:function(e){var a=this._experienceBase.getManager("VCXContextManager");if(a&&"0"==a.getUrlVars().ambience)return UWA.Promise.resolve();var r="3DEXCITE";for(var s in M.EDefaultAmbience)if(M.EDefaultAmbience[s]===e){r=s;break}if("3DEXCITE"===r){if(!this._defaultAmbiencePromise){var o=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.requestedMap,u=t.getWebappsAssetUrl(this.defaultAmbienceOptions&&this.defaultAmbienceOptions.baseModule,this.defaultAmbienceOptions&&this.defaultAmbienceOptions.baseFolder),c=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasIBL,h=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasRoughness,p=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasBackGround,d=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.hasGround;let e=null;if(!(e=this.defaultAmbienceOptions&&this.defaultAmbienceOptions.is3dxc?new Promise((e,t)=>{var i=new g;i.setFileType("3dxc"),i.setOnLoadedCallback(function(t){e(t.ambiance)}),i.loadModel(u+o+".3dxc",new _)}):new Promise(e=>{var t=UWA.Promise.deferred(),i=UWA.Promise.deferred(),r=UWA.Promise.deferred(),s=new l({viewer:a.getMainViewer()});if(c){var d=u+o+"/"+o+".hdr",g=d?n.ImageUtils.loadHDRTexture(d,new n.LatLongReflectionMapping,void 0,void 0,void 0,void 0,void 0,!1):null;s.setIblMap({texture:g,generateRoughnessMap:!h,doneCallback:()=>{t&&t.resolve()}})}else t.resolve();if(h){var _=u+o+"/"+o+"_rmips.hdr",m=_?n.ImageUtils.loadHDRTexture(_,new n.LatLongReflectionMapping,void 0,void 0,void 0,void 0,void 0,!1):null;s.setRoughnessMap({texture:m,hasDiffuse:!0,doneCallback:()=>{i&&i.resolve()}})}else i.resolve();if(p){var f=u+o+"/"+o+"_BG.hdr",M=f?n.ImageUtils.loadHDRTexture(f,new n.LatLongEnvMapping,void 0,void 0,void 0,void 0,void 0,!1):null;s.setBackGroundMap({texture:M,mapping:new n.LatLongEnvMapping,hdr:!0,doneCallback:()=>{r.resolve()}})}else r.resolve();UWA.Promise.all([t.promise,i.promise,r.promise]).then(()=>e(s))})))throw new Error("Error with ambience settings");this._defaultAmbiencePromise=e.then(e=>{if(e.setFiniteMode(!1),!a.getActiveGround()&&d){var t={planeMirror:!0,blurryMirror:!0};e.setGroundOptions(t),e.setGroundReflectivitiy(.35),e.setGroundGlossiness(.25)}return e});var f=this.QueryInterface("VCXIReadiness");f&&f.registerPromise(this._defaultAmbiencePromise),this._experienceBase.getManager("VCXNotificationManager").addProgressNotification({strObjectName:m["ProgressNotification.DefaultAmbience"],strAction:m["ProgressNotification.Loading"],maskDisplayAdd:2,iPromise:this._defaultAmbiencePromise},!0)}return this._defaultAmbiencePromise.then(e=>{let t=this._experienceBase.getManager("VCXContextManager").getActiveViewport();if(!t||!t.QueryInterface("VCXIModifiable").GetPropertyValue("Viewport.ActiveAmbience")){if(!a._experienceBase.isValid)return console.error(new Error("Experience not valid anymore")),void e.dispose();this.requestSetAmbience(e,!1),this.updateGroundPosition({ambience:e}),a.getActiveGround()&&a.getActiveGround().update(),a.getActiveViewport()&&a.getActiveViewport().update({force:!0}),this._transparentBackground&&this.setTransparentBackground(!0),i.publish({event:"VCX_ENVIRONNEMENT_PROPERTY_CHANGED"}),this.defaultAmbience=e;var n=this.QueryInterface("VCXIReadiness");return n?n.isReady():UWA.Promise.resolve()}}),this._defaultAmbiencePromise}a.applyToViewers(e=>{e.setVisuEnvOCA(r)})},requestSetAmbience(e,t){var i=this._experienceBase.getManager("VCXContextManager");i.getMainViewer().removePlaneV2(),i.applyToViewers(n=>{n.setAmbience(e,t),this.updateGroundPosition({ambience:e}),i.getActiveGround()&&i.getActiveGround().update(),i.getActiveViewport()&&i.getActiveViewport().update({force:!0}),n.render()})},activateRenderPriorityIfNeeded:function(){this._renderPriorityDirty=!1;var e=this._experienceBase.getManager("VCXContextManager"),t=e.getMainViewer(),i=!1;e.getActiveViewport().renderMode===u.ERenderingMode.Custom&&this.hasOnePartRenderPriorityDifferentFromCentral()&&(i=!0),t.setRenderPriority&&(i?(t.setSectionCapping(!1),t.setRenderPriority(!0)):(t.setSectionCapping(!0),t.setRenderPriority(!1)),t.setRenderPriorityDefaultOpacity(.5),o.setRenderPriority(e.getRootPathElement(),2,t))},hasOnePartRenderPriorityDifferentFromCentral:function(){var e=this._experienceBase.getManager("VCXContextManager").getRootComponent();if(e){var t=e.QueryInterface("VCXIModelNavigable"),i=!1;t.traverse((e,t,n)=>{Number.isInteger(e.GetObject().priority)&&2!==e.GetObject().priority&&(i=!0,n.stop=!0)},void 0,{}),this._priorityDifferentFromCentral=i}return this._priorityDifferentFromCentral},postUpdate:function(e){this._parent(e),this.viewpointHasMoved=!1},load3DXMLModel:function(e,i){if(this._modelLoaded[e])return this._modelLoaded[e];if(!i)return null;let n=new _,a=t.getWebappsAssetUrl(i.module,i.path);i.callBackCreation&&i.callBackCreation(n);var r=new g;return r.setFileType("3dxml"),r.loadModel(a,n),this._modelLoaded[e]=n,n}});return M.getViewerOptions=function(){var e=!!localStorage&&localStorage.getItem("DS_COMPOSER_LOW_GRAPHIC_CARD_DETECTED");return d.isMobileDevice()||"1"===h.getUrlVars().ipad||e?(console.log("getViewerOptions :  MODE MOBILE"),{hdr:!1,mobile:!0,defaultAnimationLoop:!1,useOIT:!0,antiAliasing:!1,useShadowMap:!1,mirror:!1,ssao:!1,debugShadowLight:!1,debugBSphere:!1,debugPrimitiveBSphere:!1,debugRepBBox:!1,debugPicking:!1,picking:!0,prePicking:!0,multiViewerAuto:!0,infinitePlane:!1,displayGrid:!1,backgroundColor:15527148,planeV2:!0,triLights:!0,useQualityManager:!1,visuFaceMaterialsAsPBR:!1}):(console.log("getViewerOptions :  MODE DESKTOP"),{defaultAnimationLoop:!1,useOIT:!0,antiAliasing:"SMAA",useShadowMap:!1,mirror:!1,ssao:!1,debugShadowLight:!1,debugBSphere:!1,debugPrimitiveBSphere:!1,debugRepBBox:!1,debugPicking:!1,picking:!0,prePicking:!0,multiViewerAuto:!0,infinitePlane:!1,displayGrid:!1,backgroundColor:15527148,planeV2:!0,triLights:!0,useQualityManager:!1,visuFaceMaterialsAsPBR:!1})},Object.defineProperty(M.prototype,"CameraControlsViewpoint",{enumerable:!0,get:function(){return this._CameraControlsViewpoint},set:function(e){this._CameraControlsViewpoint=e}}),Object.defineProperty(M.prototype,"CameraEasingTime",{enumerable:!0,get:function(){return this._CameraEasingTime},set:function(e){this._CameraEasingTime=null===e?5:e}}),Object.defineProperty(M.prototype,"componentType",{enumerable:!0,get:function(){return"VCXVisuManager"}}),Object.defineProperty(M.prototype,"HasViewpointMoved",{enumerable:!0,get:function(){return this.viewpointHasMoved}}),M.EDefaultAmbience={Basic:10,WhiteDesign:20,BlueDesign:30,DarkDesign:40,Studio:50,PureWhite:60,WhiteExperience:70,WhiteMirror:80,WhiteReview:90,DarkMirror:100,DarkReview:110,Outdoor:120,Indoor:130,City:140,Road:150,"3DEXCITE":1e4},M}),define("DS/VCXWebVisualization/VCXMaterialManager",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderStyle","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/Visualization/PathElement","UWA/Class","DS/CoreEvents/Events","DS/WebappsUtils/WebappsUtils","DS/VCXWebSystem/VCXEnums","DS/VCXWebVisualization/VCXImageManager","DS/VCXWebPlatform/VCXPlatformServices","DS/VCXWebPlatform/VCX3DSpaceServices","DS/VCXWebKernelCommands/VCXCmdChangeComponent","DS/Visualization/MaterialManager"],function(e,t,i,n,a,r,s,o,l,u,c,h,p){"use strict";var d=a.extend({initialize:function(){this._renderStyles=new Map,this._materialsPhong=new Map,this._materialsBasic=new Map,this._materialsLineBasic=new Map,this._materialsPoint=new Map,this._materialsCustom=new Map,this._materialsDetails={},this._materialsActors=[],this._materialFlat=null,this._imagesCacheSize=10,this._imagesCache=[],this._nTexturesLoading=0,this._cbTextureLoaded=null,this._isDirty=!1},_releaseTexture:function(e){e&&e.dispose&&(e.dispose(),e=null)},_releaseMaterials:function(e){e&&e.size&&(e.forEach(function(e,t){e&&e.dispose&&e.dispose()}),e.clear(),e=null)},unInitialize:function(){this._releaseMaterials(this._renderStyles),this._releaseMaterials(this._materialsPhong),this._releaseMaterials(this._materialsBasic),this._releaseMaterials(this._materialsLineBasic),this._releaseMaterials(this._materialsPoint),this._releaseMaterials(this._materialsCustom),this._releaseTexture(this._materialFlat),this._imagesCacheSize=0,this._imagesCache=null,this.materialManager=null,this._nTexturesLoading=0,this._cbTextureLoaded=null,this._materialsActors=null},loadMaterialFromPath:function(t,i){return e.ImageUtils.loadTexture(s.getWebappsAssetUrl(t,i),void 0,void 0,void 0,!1)},postInitialize:function(){this.materialManager=new p},_findTextureInCache:function(e,t){if(this._imagesCache)for(var i=0;i<this._imagesCache.length;++i){var n=this._imagesCache[i];if(n.iDocID===e&&n.iEffect===t)return n.texture}return null},_addTextureToCache:function(e,t,i){if(this._imagesCache){var n={iDocID:e,iEffect:t,texture:i};this._imagesCache.length<this._imagesCacheSize?this._imagesCache[this._imagesCache.length]=n:(this._imagesCache=this._imagesCache.slice(1,this._imagesCacheSize),this._imagesCache[this._imagesCacheSize-1]=n)}},getRenderStyle:function(e,n,a){var r=e+"_"+n+"_"+(a?1:0),s=this._renderStyles.get(r);if(!s){switch((s=new t).setRenderMode("@Point",a),s.setRenderMode("WireEdge",a),s.setRenderMode("InfiniteFace",a),s.setRenderMode("AxisSystem",a),e){case i.ERenderingMode.Custom:case i.ERenderingMode.Smooth:s.setRenderMode("Face",!0),s.setRenderMode("InternalSharpEdge",!1),s.setRenderMode("InternalSmoothEdge",!1),s.setRenderMode("BoundaryEdge",!1),s.setFaceMode("MATERIAL");break;case i.ERenderingMode.SmoothOutline:s.setRenderMode("Face",!0),s.setFaceMode("MATERIAL"),s.setRenderMode("InternalSharpEdge",!0),s.setRenderMode("InternalSmoothEdge",n===i.EOutlineType.Construction),s.setRenderMode("BoundaryEdge",n===i.EOutlineType.Smart),s.setOutlineWidth(2);break;case i.ERenderingMode.Technical:case i.ERenderingMode.FlatTechnical:s.setRenderMode("Face",!0),s.setFaceMode("MATERIAL"),s.setRenderMode("Outline",!0),s.setRenderMode("InternalSharpEdge",!0),s.setRenderMode("InternalSmoothEdge",n===i.EOutlineType.Construction),s.setRenderMode("BoundaryEdge",n===i.EOutlineType.Smart),s.setOutlineWidth(2);break;case i.ERenderingMode.Silhouette:s.setRenderMode("Face",!0),s.setFaceMode("ZONLY"),s.setRenderMode("Outline",!0),s.setRenderMode("InternalSharpEdge",!0),s.setRenderMode("InternalSmoothEdge",n===i.EOutlineType.Construction),s.setRenderMode("BoundaryEdge",n===i.EOutlineType.Smart),s.setOutlineWidth(2)}this._renderStyles.set(r,s)}return s},getMaterialPoint:function(t,i,n){var a=t.getHex()+"|"+i+"|"+n,r=this._materialsPoint.get(a);return void 0===r&&((r=new e.ParticleBasicMaterial({color:t,opacity:i,size:n,sizeAttenuation:!1})).force=!0,this._materialsPoint.set(a,r)),r},getMaterialLine:function(t,i,n){var a=t.getHex()+"|"+i+"|"+n,r=this._materialsLineBasic.get(a);return void 0===r&&((r=new e.LineBasicMaterial({color:t,opacity:i,dashSize:0,gapSize:0,side:e.DoubleSide,polygonBorderMode:!0})).setLineWidth(n),r.force=!0,this._materialsLineBasic.set(a,r)),r},getMaterialBasic:function(t,i){var n=t.getHex()+"|"+i,a=this._materialsBasic.get(n);return void 0===a&&((a=new e.MeshBasicMaterial({color:t,opacity:i})).force=!0,this._materialsBasic.set(n,a)),a},getMaterialPhong:function(t,i,n){var a="";n&&(a=n);var r=t.getHex()+"|"+i+"|"+a,s=this._materialsPhong.get(r);if(void 0===s&&((s=new e.PhysicalMaterial({color:new e.Color(t.getHex()),opacity:i,side:e.DoubleSide,specular:new e.Color(16777215),roughness:1,metalness:0,force:!0})).line=new e.LineBasicMaterial({color:new e.Color(65280),lineWidth:1,opacity:1}),s.point=new e.ParticleBasicMaterial({color:new e.Color(16711680),size:1,opacity:1}),this._materialsPhong.set(r,s),n)){var o=e.ImageUtils.loadTexture(n,e.UVMapping);o.wrapS=e.RepeatWrapping,o.wrapT=e.RepeatWrapping,o.repeat.set(1,1),o.needsUpdate=!0,s.map=o,s.force=!0,s.update=!0,s.needsUpdate=!0}return s},getMaterialFlat:function(){return this._materialFlat||(this._materialFlat=new e.MeshBasicMaterial({NRECompatibility:!0,side:e.DoubleSide}),this._materialFlat.name="Flat"),this._materialFlat},createMaterial:function(t){return t._envID,new e.PhysicalMaterial({NRECompatibility:!0,side:e.DoubleSide,force:!0})},getSharedMaterial:function(e){var t=e._envID+"|"+e._textureDocID,i=this._materialsCustom.get(t);if(!i){switch(i=this.createMaterial(e),e._envID){case o.EnvironmentalId.None:case o.EnvironmentalId.PLM:i.color=o.Color.Black,i.specular=o.Color.White,i.roughness=1,i.metalness=0,i.name="None"}this._materialsCustom.set(t,i)}return i},isTextureVisible:function(e){switch(e){case o.EnvironmentalId.None:case o.EnvironmentalId.PLM:return!0}return!1},getBboxInNewBasis:function(t,i){var n=(new e.Matrix4).getInverse(t),a=new e.Vector3(i.min.x,i.min.y,i.min.z);a.applyMatrix4(n);var r=a.x,s=a.x,o=a.y,l=a.y,u=a.z,c=a.z;r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.min.x,a.y=i.min.y,a.z=i.max.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.min.x,a.y=i.max.y,a.z=i.min.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.min.x,a.y=i.max.y,a.z=i.max.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.max.x,a.y=i.min.y,a.z=i.min.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.max.x,a.y=i.min.y,a.z=i.max.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.max.x,a.y=i.max.y,a.z=i.min.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z),a.x=i.max.x,a.y=i.max.y,a.z=i.max.z,a.applyMatrix4(n),r>a.x?r=a.x:s<a.x&&(s=a.x),o>a.y?o=a.y:l<a.y&&(l=a.y),u>a.z?u=a.z:c<a.z&&(c=a.z);var h=new e.Box3;return h.min.x=r,h.min.y=o,h.min.z=u,h.max.x=s,h.max.y=l,h.max.z=c,h},getBbox:function(e){if(!e)return null;var t=e.QueryInterface("W3AISGNodeHolder").getPathElement();if(!t||void 0===t||!t.externalPath.length)return null;for(var i=new n,a=0;a<t.externalPath.length;++a)i.addElement(t.externalPath[a]);for(var r=i.getLastElement();r&&(!(r=r.children.length?r.children[0]:null)||(i.addElement(r),"InstanceRep"!==r.getNodeType())););var s=this._experienceBase.getManager("VCXContextManager").getMainViewer();return i.getBoundingBox(null,s)},doTextureUV:function(t,i){var n=t._textureProjectionMatrix||new e.Matrix4,a=new e.Matrix3,r=t._textureUVMatrix||new e.Matrix4;a.set(r.elements[0],r.elements[1],0,r.elements[4],r.elements[5],0,0,0,1),i.setMappingOperator(t._textureProjectionType,n,a,!0)},doTextureMappingPlanar:function(t,i){if(t){t.QueryInterface("W3AISGNodeHolder").getPathElement(),this._experienceBase.getManager("VCXContextManager").getMainViewer();var n=this.getBbox(t),a=1,r=1,s=1;r=a=t._textureUVscale<50?1+(50-t._textureUVscale)/2:1-(t._textureUVscale-50)/50,s=a;r*=t._textureUVratio<=50?t._textureUVratio/50:1+(t._textureUVratio-50)/5;var o=t._textureProjectionMatrix||new e.Matrix4,l=this.getBboxInNewBasis(o,n),u=l.max.x-l.min.x;u>0&&(a/=u);u=l.max.y-l.min.y;u>0&&(r/=u);u=l.max.z-l.min.z;u>0&&(s/=u);var c=(new e.Matrix4).copy(o);c.elements[12]=.5*(n.max.x+n.min.x),c.elements[13]=.5*(n.max.y+n.min.y),c.elements[14]=.5*(n.max.z+n.min.z),c=(new e.Matrix4).getInverse(c);var h=new e.Matrix4;h.scale(new e.Vector3(a,r,s)),c=(new e.Matrix4).multiplyMatrices(h,c);var p=new e.Matrix3,d=t._textureUVMatrix||new e.Matrix4;p.set(d.elements[0],d.elements[1],0,d.elements[4],d.elements[5],0,0,0,1);var g=new e.Matrix3;g.set(1,0,.5-d.elements[12],0,1,.5-d.elements[13],0,0,1);var _=(new e.Matrix3).multiplyMatrices(p,g);i.setMappingOperator(t._textureProjectionType,c,_,!0)}},doTextureMappingSpherical:function(t,i){if(t){var n=t.QueryInterface("W3AISGNodeHolder").getPathElement().getLastElement().getBoundingBox(),a=1,r=1,s=1;r=a=t._textureUVscale<50?1+(50-t._textureUVscale)/2:1-(t._textureUVscale-50)/50,s=a;r*=t._textureUVratio<=50?t._textureUVratio/50:1+(t._textureUVratio-50)/5;var o=(new e.Matrix4).makeRotationZ(Math.PI/2),l=t._textureProjectionMatrix||new e.Matrix4,u=(new e.Matrix4).multiplyMatrices(l,o),c=this.getBboxInNewBasis(u,n),h=Math.max(Math.max(c.max.x-c.min.x,c.max.y-c.min.y),c.max.z-c.min.z),p=h*Math.sqrt(2);p>0&&(a/=p);p=h*Math.sqrt(2);p>0&&(r/=p);p=h*Math.sqrt(2);p>0&&(s/=p),u.elements[12]=.5*(n.max.x+n.min.x),u.elements[13]=.5*(n.max.y+n.min.y),u.elements[14]=.5*(n.max.z+n.min.z),u=(new e.Matrix4).getInverse(u);var d=new e.Matrix4;d.scale(new e.Vector3(a,r,s)),u=(new e.Matrix4).multiplyMatrices(d,u);var g=new e.Matrix3,_=t._textureUVMatrix||new e.Matrix4;g.set(_.elements[0],_.elements[1],0,_.elements[4],_.elements[5],0,0,0,1);var m=new e.Matrix3;m.set(1,0,.5-_.elements[12],0,1,.5-_.elements[13],0,0,1);var f=(new e.Matrix3).multiplyMatrices(g,m);i.setMappingOperator(t._textureProjectionType,u,f,!0)}},applyTexture:function(t,i,n){i._textureBorderMode?(n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping):(n.wrapS=e.ClampToEdgeWrapping,n.wrapT=e.ClampToEdgeWrapping),n.repeat.set(1,1),n.needsUpdate=!0,t.map=n,t.needsUpdate=!0,t.updateDeferredMaterials()},loadTexture:function(t,i,n,a){var r=this._findTextureInCache(t._textureDocID,a);if(r)return this.applyTexture(i,t,r),UWA.Promise.resolve(r);var s=this._experienceBase.getManager("VCXImageManager");if(!s)return UWA.Promise.reject(new Error("No VCXImageManager"));this._nTexturesLoading++;var o=this;return s.GetImageFromDocID(t._textureDocID,a).then(function(n){o._nTexturesLoading--;var r=o._findTextureInCache(t._textureDocID,a);if(r)return o.applyTexture(i,t,r),r;var s=n.toDataURL("image/png"),l=UWA.Promise.deferred(),u=e.ImageUtils.loadTexture(s,{},function(e){o.applyTexture(i,t,e),o._cbTextureLoaded&&o._cbTextureLoaded(e,o._nTexturesLoading),l.resolve(e)});return o._addTextureToCache(t._textureDocID,a,u),l.promise})},hasTexturesLoading:function(){return this._nTexturesLoading>0},setMaterialAttributesFromOccurrence:function(t,n){if(n){var a=this.getSharedMaterial(t);if(a&&(n.color=a.color.clone(),n.specular=a.specular.clone(),n.normalMap=a.normalMap,n.metalnessMap=a.metalnessMap,n.roughnessMap=a.roughnessMap,n.glossinessMap=a.glossinessMap,n.specularMap=a.specularMap,n.transparent=a.transparent,n.metalness=a.metalness,n.shininess=a.shininess,n.glossiness=a.glossiness,n.roughness=a.roughness,n.specularContrib=a.specularContrib,n.transparent=a.transparent,n.NRECompatibility=a.NRECompatibility,n.side=a.side),this.isTextureVisible(t._envID)){var r=this._experienceBase.getManager("VCXDocManager"),s=null;r&&(s=r.GetPropPath(t._textureDocID));var u=null;s&&(u=s.GetValueURL());var c=null;if(u&&(c=u.Value),c){var h=l.Effect.RedimensionPower2;t.localColor&&(n.diffuseMulCoef=new e.Vector3(t.localColor.r,t.localColor.g,t.localColor.b)),n.diffuseAddCoef=new e.Vector3(0,0,0),t._textureTransparency?(n.transparent=!0,t._textureBlending&&(h|=l.Effect.RemoveBorder)):(n.transparent=!1,t._textureBlending||(n.color=o.Color.White,n.diffuseMulCoef=new e.Vector3(1,1,1))),t.getDirtyFlag(i.FDirty.EnvID|i.FDirty.TextureDocID|i.FDirty.TextureTransparency|i.FDirty.TextureBlending)&&this.loadTexture(t,n,c,h).then(function(e){})}if(t.getDirtyFlag(i.FDirty.TextureBorderMode)){var p=n.map;p&&(t._textureBorderMode?(p.wrapS=e.RepeatWrapping,p.wrapT=e.RepeatWrapping):(p.wrapS=e.ClampToEdgeWrapping,p.wrapT=e.ClampToEdgeWrapping),p.repeat.set(1,1),p.needsUpdate=!0)}t._textureProjectionType===o.TextureMapping.Planar?this.doTextureMappingPlanar(t,n):t._textureProjectionType===o.TextureMapping.Spherical?this.doTextureMappingSpherical(t,n):this.doTextureUV(t,n)}else n.map=null}},getLineMaterialFromParams:function(t,n){var a=null,r=null,s=null;if("number"==typeof t.type)if(t.type===i.ELineType.None)a="None";else if(t.type===i.ELineType.Solid)a="Solid";else{var o=this.getCustomLineDashPatternFromType(t.type);o?o[0]>0&&(r=o,s=!0):a="Solid"}else Array.isArray(t.dashPattern)&&(r=t.dashPattern,s=!0);if(n)return"string"==typeof a&&n.dashType!==a?n.setDashPatternType(a):r&&n.dashPattern!==r&&n.setDashPatternArray(r),"boolean"==typeof s&&n.isCPUPattern!==s&&n.setCPUPattern(s),n.handleByPrerender||("number"==typeof t.lineWidth&&n.lineWidth!==t.lineWidth||1===n.lineWidth&&!n.visible)&&(n.setLineWidth(t.lineWidth),n.visible=t.lineWidth>0),t.color&&!n.color.equals(t.color)&&(n.color=t.color),"number"==typeof t.opacity&&n.opacity!==t.opacity&&(n.opacity=t.opacity),t.vertexColors&&n.vertexColors!==t.vertexColors&&(n.vertexColors=t.vertexColors),!t.backMaterial||n.backMaterial&&n.backMaterial.id===t.backMaterial.id||t.backMaterial&&n.setBackMaterial(t.backMaterial),this._experienceBase.getManager("VCXContextManager").renderAll(),n;var l={force:!0,polygonBorderMode:t.polygonBorderMode,alphaTest:.005,scale:"number"==typeof t.scale?t.scale:5,lineWidth:"number"==typeof t.lineWidth?t.lineWidth:2,opacity:"number"==typeof t.opacity?t.opacity:1};return"number"==typeof a?l.dashType=a:r&&(l.dashPattern=new Float32Array(r)),t.backMaterial&&t.backMaterial.isCPUPattern?l.isCPUPattern=!0:"boolean"==typeof s&&(l.isCPUPattern=s),t.vertexColors&&(l.vertexColors=t.vertexColors),t.color&&(l.color=t.color),t.backMaterial&&(l.backMaterial=t.backMaterial),t.polygonOffset&&(l.polygonOffset=t.polygonOffset,l.polygonOffsetFactor=t.polygonOffsetFactor,l.polygonOffsetUnits=t.polygonOffsetUnits),new e.LineBasicMaterial(l)},getCustomLineDashPatternFromType:function(e){switch(e){case i.ELineType.SmallDash:return[2,2];case i.ELineType.MediumDash:return[6,2];case i.ELineType.DotDash:return[3,1,1,1];case i.ELineType.LongDash:return[10,2];case i.ELineType.Dot:return[1,1];case i.ELineType.VeryLongDash:return[14,2];default:return null}},createInternalMaterial:async function(e,t,i){var n=new h(this._experienceBase.getManager("VCXCommandManager"),this._experienceBase.ComponentsMap);let a=this._experienceBase.Factory.BuildComponent("VCXInternalMaterial_Spec");n.AddComponents([a]);try{return await this.populateMaterial(a,e.physicalID,t,i),this._isDirty=!0,this._experienceBase.getManager("VCXCommandManager").Do(n),a}catch(e){throw new Error(e)}},removeMaterialActorFromCache:function(e){let t=this._materialsActors.indexOf(e);t>-1&&this._materialsActors.splice(t)},addMaterialActorToCache:function(e){this._materialsActors.push(e)},populateMaterial:async function(e,t,i=[],n){let a=e.QueryInterface("VCXIMaterialCache");if(this.addMaterialActorToCache(e),a.hasDetails())return;let r={};if(r.PID=t,r.whereApplied=[],i.forEach(e=>{e._envID=o.EnvironmentalId.PLM,r.whereApplied.push(e.GetID())}),n&&n[t])r.type=n[t]["ds6w:type"],r.typeNLS=n[t]["ds6w:type"],r.name=n[t].name,r.title=n[t]["ds6w:label"],r.image=n[t].preview_url;else{const e=await c.Get3DSpaceURL();let i=e&&await u.getObjectInfo(t,e);if(!i)return;if(i.type&&(r.type=i.type),i.dataelements){let e=i.dataelements;e.hasOwnProperty("typeNLS")&&(r.typeNLS=e.typeNLS),e.hasOwnProperty("name")&&(r.name=e.name),e.hasOwnProperty("title")&&(r.title=e.title),e.hasOwnProperty("image")&&(r.image=e.image)}}if(a.populate(r),i.forEach(t=>t.originalMaterial=e.GetID()),"VCXInternalMaterial_Spec"===e.GetType()){let i=this.getMaterialPLM(t);i&&"CXPCoveringMaterial_Spec"===i.GetType()&&i.QueryInterface("VCXIMaterialCache").setInternalMaterial(e.GetID())}},getAllMaterials:function(){return this._materialsActors},getAllMaterialsfromPLM:function(e){return this._materialsActors.filter(t=>t.QueryInterface("VCXIMaterialCache").GetPID()===e)},update:function(e){if(localStorage.getItem("VCX_TweakingMaterial")){this._experienceBase.ComponentsMap.GetComponentFromType("CXPRenderingFeature_Spec").forEach(e=>{if(e.dirty){e.dirty=!1,e.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("VCXIMaterialCache").updateMaterialVisu()}})}this._isDirty&&this._experienceBase.getManager("VCXGUIManager")&&this._experienceBase.getManager("VCXGUIManager")._vcxMaterialCtrl&&(r.publish({event:"VCX_MATERIALS_PANEL_UPDATE_V2",data:null}),this._isDirty=!1)},getMaterialPLM:function(e){let t=this.getAllMaterialsfromPLM(e),i=t.find(e=>"CXPCoveringMaterial_Spec"===e.GetType());return i||(t.length>0?t[0]:null)},getMaterialsPLM:function(){let e=this._materialsActors.filter(e=>e.IsKindOf("CXPCoveringMaterial_Spec")),t=this._materialsActors.filter(e=>e.IsKindOf("VCXInternalMaterial_Spec"));for(let i of t){let t=!1;for(let n of e)if(n.QueryInterface("VCXIMaterialCache").GetPID()===i.QueryInterface("VCXIMaterialCache").GetPID()){t=!0;break}t||e.push(i)}return e.sort((e,t)=>e.QueryInterface("VCXIMaterialCache").GetPID().localeCompare(t.QueryInterface("VCXIMaterialCache").GetPID()))},populateCoverings:async function(){let e=this._experienceBase.ComponentsMap.GetComponentFromType("CXPCoveringMaterial_Spec").map(e=>new Promise(async t=>{let i=await e.QueryInterface("CATI3DXAssetProperties").getPhysicalId();await this.populateMaterial(e,i),t()}));await UWA.Promise.allSettled(e),this._isDirty=!0}});return Object.defineProperty(d.prototype,"componentType",{enumerable:!0,get:function(){return"VCXMaterialManager"}}),d}),define("DS/VCXWebVisualization/VCXAManipulable",["UWA/Class","DS/CoreEvents/Events","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebVisualization/VCXInteractor","DS/Mesh/MeshUtils"],function(e,t,i,n,a){"use strict";return e.extend({init:function(){this._interactors={},this._inManipulation=!1,this._isSnappable=!0},isManipulated:function(){return this._inManipulation},setManipulated:function(e){this._inManipulation=e},changePickability(e){var t=this.QueryInterface("W3AISGNodeHolder");t&&t.giveSGNode()&&t.giveSGNode().setPickable(e?a.PICKABLE:a.PICKTHROUGH)},isTextEditable:function(){return!1},startEditInPlace:function(){},getInteractor:function(e){return this._interactors[e]},getAllInteractors:function(){return this._interactors},getActiveInteractors:function(){var e={};for(var t in this._interactors)this._interactors.hasOwnProperty(t)&&!0===this._interactors[t].active&&(e[t]=this._interactors[t]);return e},updateInteractors:function(e){},isActive:function(){var e=this.GetObject(),t=(e.GetID(),this.QueryInterface("VCXIVisibility"));if(t&&t.GetVisibility()===i.EVisState.Hidden)return!1;var a=this.getActiveInteractors(),r=Object.keys(a);if(0===r.length)return!1;for(var s={selection:!1,hoveringObject:!1,hoveringHandle:!1},o=this.GetObject()._experienceBase.getManager("VCXSelectionManager"),l=0;l<r.length;++l){var u=a[r[l]];if(u.handleInfos&&u.handleInfos.stayVisible)return!0;if(!s.selection&&(!u.visibility||u.visibility&&u.visibility&n.EVisibility.OnObjectSelected)){if(o.isIn(e))return!0;s.selection=!0}if(!s.hoveringObject&&(!u.visibility||u.visibility&&u.visibility&n.EVisibility.OnObjectOver)){if(o.GetComponentsFromSelection("PSO").includes(e))return!0;s.hoveringObject=!0}s.hoveringHandle||u.visibility&&!(u.visibility&&u.visibility&n.EVisibility.OnInteractorOver)||(s.hoveringHandle=!0)}return!1},addInteractor:function(e,i){return!(!i||this._interactors[e])&&(this._interactors[e]=i,i.id||(i.id=e),i.enable(),t.publish({event:"VCX_INTERACTOR_ADDED",data:{interactor:i,manipulable:this}}),!0)},removeInteractor:function(e){return!!this._interactors[e]&&(delete this._interactors[e],!0)},enableInteractors:function(e){this._switchInteractors(e,!0)},disableInteractors:function(e){this._switchInteractors(e,!1)},_switchInteractors:function(e,t){if(Array.isArray(e))for(var i=0;i<e.length;++i){var n=e[i],a=this._interactors[n];if(a){a.disabledByManipulable=!t;var r=a.handle;r&&r.isDisplayed()&&!a.active&&r.Hide(!0)}}else console.log("Methods of VCXAManipulable enableInteractors & disableInteractors require an array as input !")},interact:function(){},linkSnappedDuringManipulation:function(e){},unLinkSnappedAfterManipulation:function(){}})}),define("DS/VCXWebVisualization/VCXOccurrenceComposerPrepareRenderToTexture",["require","exports","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/Visualization/ThreeJS_DS","DS/VCXWebVisualization/VCXAPrepareRenderToTexture","DS/VCXWebVisu/VCXVisuTools"],function(e,t,i,n,a,r){"use strict";return class extends a{GetType(){return"VCXOccurrenceComposerPrepareRenderToTexture"}async prepareRender(e,t){var i,a;if("normal"!==t&&(null===(a=null===(i=r.buildGraphicPropertiesStructure(this,null,{getVisibility:!0})[0])||void 0===i?void 0:i.visible)||void 0===a?void 0:a.Visibility)&&this._object._highlightSet&&this._object.HighlightData){var s=this._object.QueryInterface("W3AISGNodeHolder").getPathElement();let i={...this._object.HighlightData};"white"===t&&(i.color=new n.Color(16777215),i.outlineColor=new n.Color(16777215),i.haloColor=new n.Color(16777215),i.lineicHaloColor=new n.Color(16777215),i.lineicOutlineColor=new n.Color(16777215),i.outlineColor=new n.Color(16777215));var o=i.polite?new n.AdvancedPoliteHighlightData(i):new n.HaloHighlightData(i);this._highlightSetTmp=e.viewer.createHighlightSet(o,!1,i.polite,!0),this._highlightSetTmp.add(s,{highlightColor:o},!0)}}async postRender(e,t){var i,n;"normal"!==t&&(null===(n=null===(i=r.buildGraphicPropertiesStructure(this,null,{getVisibility:!0})[0])||void 0===i?void 0:i.visible)||void 0===n?void 0:n.Visibility)&&this._highlightSetTmp&&(e.viewer.removeHighlightSet(this._highlightSetTmp),delete this._highlightSetTmp)}}}),define("DS/VCXWebVisualization/VCXHandle",["UWA/Class","DS/CoreEvents/ModelEvents","DS/VCXWebVisualization/VCXBillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/VCXWebVisibility/VCXIVisibility","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","DS/VCXWebVisualization/VCXInteractor","DS/SceneGraphNodes/AxisSystemNode","DS/VCXWebSystem/VCXHardwareServices","DS/Mesh/MeshUtils"],function(e,t,i,n,a,r,s,o,l,u,c,h,p){"use strict";return e.extend({init:function(e){if(e.interactor){this._parentOwnerComponent=e.parentOwner,this._id=e.id,this.interactor=e.interactor,this._modelEvents=new t,this.manipulator=null,this.manipulatorTokens={};var i=this.interactor.data&&this.interactor.data.handleVisual;this.setColor(i&&i.color?i.color:this.getDefaultColor()),this.setOpacity(i&&i.opacity?i.opacity:this.getDefaultOpacity()),this.setSize(i&&i.size?i.size:this.getDefaultSize()),this._experienceBase=this._parentOwnerComponent._experienceBase,this._viewer=this._experienceBase.getManager("VCXContextManager").getMainViewer(),this.sceneGraph=this._viewer.getRootNode(),this._anchor=this._generateHandleGeom(e),this._anchor.setVisibilityInTree(!1),this._anchor.exludeFromBounding(!0),this._anchor.handle=this,this._stayVisible=!(!i||"boolean"!=typeof i.stayVisible)&&i.stayVisible,this.hiddingTime=1e3,this.showingTime=300,this.updateVisibility()}else console.log("Needs interactor in parameters to pursue creation of handle")},getSize:function(){return"number"!=typeof this._displaySize&&(this._displaySize=this.getDefaultSize()),this._displaySize},setSize:function(e){return"number"==typeof e&&(this._displaySize=e,this.fixedSizeNode&&this.fixedSizeNode.setRatio(this._displaySize),!0)},getDefaultSize:function(){return 16},getDefaultColor:function(){return new o.Color("#FFFFFF")},setColor:function(e){return e instanceof o.Color&&(this._color=e,this.pointMat&&(this.pointMat.color=this._color),!0)},getColor:function(){return this._color instanceof o.Color||(this._color=this.getDefaultColor()),this._color},getDefaultOpacity:function(){return 1},setOpacity:function(e){if("number"==typeof e)return this.opacity=e,this.pointMat&&(this.pointMat.opacity=this.opacity),!0;console.log("Issue with assignment of handle opacity")},getOpacity:function(){return"number"!=typeof this.opacity&&(this.opacity=this.getDefaultOpacity()),this.opacity},setPosition:function(e,t,i){this._anchor.setMatrix((new o.Matrix4).setPosition(new o.Vector3(e,t,i)))},setMatrix:function(e){this._anchor.setMatrix(e)},StayVisible:function(e){"boolean"==typeof e&&(this._stayVisible=e)},remove:function(){this.sceneGraph.remove(this._anchor),this._anchor.handle=null,this._anchor=null,this._experienceBase=null,this._viewer=null,this._parentOwnerComponent=null,this._id=null,this.interactor=null,this._modelEvents=null,this.manipulator=null,this.manipulatorTokens=null,this.sceneGraph=null},_getPointMaterial:function(){var e=l.getWebappsAssetUrl("VCXWebVisualization","texture");this.pointHandleTexture=new o.ImageUtils.loadTexture(e+"/VCX_Point.png"),this.pointHandleTexture.flipY=!1,this.pointHandleTexture.minFilter=o.LinearMipMapLinearFilter,this.pointDotHandleTexture=new o.ImageUtils.loadTexture(e+"/VCX_Point_Blue.png"),this.pointDotHandleTexture.flipY=!1,this.pointDotHandleTexture.minFilter=o.LinearMipMapLinearFilter;var t=new o.MeshBasicMaterial({map:this.pointHandleTexture,side:o.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return t.force=!0,t},_getRectangleMaterial:function(){var e=l.getWebappsAssetUrl("VCXWebVisualization","texture"),t=new o.ImageUtils.loadTexture(e+"/VCX_Bar.png");t.flipY=!1,t.minFilter=o.LinearMipMapLinearFilter,t.magFilter=o.NearestFilter;var i=new o.MeshBasicMaterial({map:t,side:o.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return i.force=!0,i},_getCustomIconMaterial:function(){var e=new o.MeshBasicMaterial({map:this.interactor.customIcon&&this.interactor.customIcon[0],side:o.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return e.force=!0,e},_getMaterial:function(){switch(this.interactor.manipulatorType){case u.EManipulatorType.Custom:return this._getCustomIconMaterial();case u.EManipulatorType.BarHandle:return this._getRectangleMaterial();default:return this._getPointMaterial()}},_generateHandleGeom:function(e){var t=new r(e.name);this.isPreactivated=!1,this.isManipulated=!1;var a=void 0===e.noz||e.noz,l={position:this.position,name:"billBoard1"};this.billBoardNode=new i(l);var c=this,h=[{id:0}],p=this._experienceBase.getManager("VCXVisuManager"),d=this._experienceBase.getManager("VCXGUIManager").isTouchActivated();h.push({id:1}),h.forEach(function(e){h[e.id].material=c._getMaterial();var t=s.createRectangleNode({width:1,height:1,cornerPoint:new o.Vector2(-.5,-.5),fill:!0,fillColor:null,noEdge:!0,layerNb:a?1:0,material:h[e.id].material});t.name="diskNode",t.setShadow(!1),t.setFrustumCulled(!1),t.excludeFromCSO(!0),t.excludeFromHighlight(!0,!0),t.setNoHighlightNoZ(!0),t.setMirror(!1),t.exludeFromBounding(!0),t.setRenderPasses([p.getRenderList("VCXPreManipulators"),p.getRenderList("VCXManipulators")]),h[e.id].node=t,c.billBoardNode.add(t)});var g=1,_=1;if(this.interactor.manipulatorType===u.EManipulatorType.BarHandle)g=2,_=2;else if(this.interactor.manipulatorType===u.EManipulatorType.Custom)g=this.interactor.scaleX||2,_=this.interactor.scaleY||2;h[0].node.setMatrix((new o.Matrix4).makeScale(g,_,1)),this.pointMat=h[0].material;var m=2;return d&&(m=4),h[1].node.setMatrix((new o.Matrix4).makeScale(g*m,_*m,1)),h[1].material.alphaTest=.005,h[1].material.opacity=0,h[1].material.depthTest=!1,h[1].material.depthWrite=!1,this.fixedSizeNode=new n({name:"fixedSizeNode3D",ratio:this._displaySize}),this.fixedSizeNode.add(this.billBoardNode),t.add(this.fixedSizeNode),this.sceneGraph.add(t),t},getHandleGeom:function(){return this._anchor},updateManipulatorCallbacks:function(e){if(e!==this.manipulator){if(this.manipulator&&this.manipulatorTokens){for(var t=Object.keys(this.manipulatorTokens),i=0;i<t.length;++i){var n=t[i],a=this.manipulatorTokens[n];this.manipulator.unsubscribe(a)}this.manipulatorTokens={},this.manipulator=null}this.manipulator=e}},_createManipulatorCallbacks:function(e){if(this._anchor){var t=this;this.manipulatorTokens.tokenBeginManipulate=e.subscribe("BeginManipulate",function(e){t.pointMat.color=new o.Color("#1B6E9C"),e.viewer.setCursor("-webkit-grabbing"),t.isManipulated=!0,t.fixedSizeNode.setRatio(1.2*t._displaySize),t._loadingOption&&t._loadingOption.isShowPickerDebug()&&t._debugHTMLAcquired(),t._handleInitPosition=e.intersection.position,e.handleID=t._id,t._modelEvents.publish({event:"BeginManipulate",data:e,context:this})}),this.manipulatorTokens.tokenManipulate=e.subscribe("Manipulate",function(e){t._loadingOption&&t._loadingOption.isShowPickerDebug()&&t._debugHTMLAcquired(),e.handleID=t._id,t._modelEvents.publish({event:"Manipulate",data:e,context:this})}),this.manipulatorTokens.tokenEndManipulate=e.subscribe("EndManipulate",function(e){e.handleID=t._id,t._modelEvents.publish({event:"EndManipulate",data:e,context:this}),t.isPreactivated?(e.viewer.setCursor("pointer"),t.pointMat.color=new o.Color("#A1D9ED")):(e.viewer.setCursor("auto"),t.pointMat.color=t.color,t.fixedSizeNode.setRatio(t._displaySize)),t.isManipulated=!1}),this.manipulatorTokens.tokenBeginPreactivate=e.subscribe("BeginPreactivate",function(e){t._modelEvents.publish({event:"BeginPreactivate",data:e,context:this}),t.isPreactivated=!0,t.isManipulated||(t.pointMat.color=new o.Color("#A1D9ED")),t.fixedSizeNode.setRatio(1.2*t._displaySize)}),this.manipulatorTokens.tokenPreactivate=e.subscribe("Preactivate",function(e){t._modelEvents.publish({event:"Preactivate",data:e,context:this})}),this.manipulatorTokens.tokenEndPreactivate=e.subscribe("EndPreactivate",function(e){t._modelEvents.publish({event:"EndPreactivate",data:e,context:this}),t.isPreactivated=!1,t.isManipulated||(t.pointMat.color=t.color,t.fixedSizeNode.setRatio(t._displaySize))})}else console.log("Manipulable node not found, abort.")},Show:function(){this.showingRequest=this.showingTime,this.hiddingRequest=-1,this.fixedSizeNode&&this.fixedSizeNode.setRatio(this._displaySize),this._anchor.setVisibility(!0),this._viewer.invalidatePickingBuffer()},Hide:function(e){this.hiddingRequest=this.hiddingTime,this.showingRequest=-1,(e||!1===this._stayVisible)&&(this.fixedSizeNode&&this.fixedSizeNode.setRatio(1),this._anchor.setVisibility(!1),this._viewer.invalidatePickingBuffer())},IsVisible:function(){return this._anchor.visible},isDisplayed:function(){return this.IsVisible()&&this.getOpacity()>0},updateVisibility:function(){var e=this._experienceBase.getManager("VCXSelectionManager"),t=!1,i=this._parentOwnerComponent,n=i.GetID(),r=i.QueryInterface("VCXIVisibility");if(r&&r.GetVisibility()===a.EVisState.Hidden)this.isDisplayed()&&this.Hide(!0);else{if(e.GetComponentsFromSelection("HSO").map(function(e){return e.GetID()}).includes(n))t=!0;else e.GetComponentsFromSelection("PSO").map(function(e){return e.GetID()}).includes(n)&&(t=!0);t||this._stayVisible?this.Show():this.Hide()}},getMatrixInWCS:function(){this._anchor.getMatrix(),this._anchor.getMatrixInWCS&&this._anchor.getMatrixInWCS();return this._anchor.getMatrix()},update:function(e){this.showingRequest>0?(this.fixedSizeNode&&this.fixedSizeNode.setRatio(this._displaySize),this._anchor.setVisibility(!0),this.pointMat.setOpacity(1-this.showingRequest/this.showingTime),this.showingRequest-=e.deltaTime,this.showingRequest<=0&&this.pointMat.setOpacity(1)):this.hiddingRequest>0&&(this.hiddingRequest-=e.deltaTime,this.pointMat.setOpacity(this.hiddingRequest/this.hiddingTime),this.hiddingRequest<=0&&(this.fixedSizeNode&&this.fixedSizeNode.setRatio(1),this._anchor.setVisibility(!1)))},_setBillboardType:function(){var e="Spherical";this.interactor.manipulatorType!==u.EManipulatorType.Handle&&(e=this.interactor.constraint===u.EConstraint.ZAxis?"PRESERVE_X_AXIS_Y_IN_CAM_PLANE":"PRESERVE_X_AXIS_Z_IN_CAM_PLANE"),this.billBoardNode.BillBoardType=e},updateTexture:function(e){if(this._setBillboardType(),this.interactor&&this.interactor.data&&"number"==typeof this.interactor.data.anchorID){var t=this.interactor._component.QueryInterface("VCXIModifiable").GetProperty("Actor.Anchor."+this.interactor.data.anchorID).GetPropertyValue().GetValueLink();this.pointMat.map=t&&t.Value?this.pointDotHandleTexture:this.pointHandleTexture}if(this.interactor.customIcon&&this.interactor.customIcon.length>1){this.currentTime|=0,this.currentSlot|=0,this.currentTime+=e.deltaTime;var i=this.preactivated?Math.floor(this.currentTime/300)%this.interactor.customIcon.length:0;this.currentSlot!==i&&(this.currentSlot=i,this.pointMat.map=this.interactor.customIcon[i],this._experienceBase.getManager("VCXContextManager").renderAll())}},_debugHTMLAcquired:function(){var e=this._experienceBase.getManager("VCXExperience");if(e.debugTools){var t='<div style="width:220px;padding:5px;"><div style="margin:5px;width:210px" align="center"><b>Anchor moving</b></div>';h.isTouchCompliantDevice()&&(t+='<div style="margin:5px;" align="left">Touch compliante: size increase</div>'),t+='<div style="width:200px;border:1px solid black; margin:5px;padding:5px;">';var i=e.debugTools.getImgCoord();t+="<div>";var n=(new o.Vector3).getPositionFromMatrix(this._initialMatrixInWCS),a=(new o.Vector3).getPositionFromMatrix(this._anchor.getMatrix());t+="Initial Position<br>",t+=i+n.x.toFixed(2)+"/"+n.y.toFixed(2)+"/"+n.z.toFixed(2)+"<br>",t+="Current Position<br>",t+=i+a.x.toFixed(2)+"/"+a.y.toFixed(2)+"/"+a.z.toFixed(2)+"<br>",t+="</div>",t+="</div>",t+="</div>",this._experienceBase.getManager("VCXExperience").debugTools.updateImmersiveConsole(t)}}})}),define("DS/VCXWebVisualization/VCXRulers",["require","exports","DS/Ruler/Ruler","DS/Ruler/AngularRuler","DS/Visualization/ThreeJS_DS","DS/VCXWebSystem/VCXMathTools","DS/VCXWebVisualization/VCXRulersUnitEnum"],function(e,t,i,n,a,r,s){"use strict";return class{constructor(e,t,a){if(this._linearManipulated="",this._angularManipulated="",a)this._options=a;else{const e={lightDisplay:!0,displayOrigin:!0,mainGrad:100,nbDecimals:1,nbSecondaryGrads:1,offset:150,unit:i.MM_UNIT,displayUnit:!0,displayRulerDuringLocalTransfo:!0},t={worldRadius:20,mainGrad:10,displayOrigin:!0,displayUnit:!0,lightDisplay:!0,graduationsDisplay:n.FULLSYMETRIC_GRADUATIONS,nbDecimals:1,nbSecondaryGrads:1,displayRulerDuringLocalTransfo:!0};this._options={LINEAR:e,ANGULAR:t}}this._experienceBase=t,this._frameWindow=e,this._linearRulers={X:null,Y:null,Z:null},this._angularRulers={X:null,Y:null,Z:null}}getLinearRulerByName(e){var t;return(null===(t=this._linearRulers)||void 0===t?void 0:t.hasOwnProperty(e))?this._linearRulers[e]:(console.warn("No linear ruler found with the following name",e),null)}getAngularRulerByName(e){var t;return(null===(t=this._angularRulers)||void 0===t?void 0:t.hasOwnProperty(e))?this._angularRulers[e]:(console.warn("No angular ruler found with the following name",e),null)}showLinearRuler(e,t){const i=this.getLinearRulerByName(e);i&&this._showRuler(i,t)}showAngularRuler(e,t){const i=this.getAngularRulerByName(e);i&&this._showRuler(i,t)}_showRuler(e,t){!e.ruler||e.getVisibleFlag()&&!t||(e.display(),e.setVisibleFlag(!0),e.setVisibilityFree(!0),e.hasBeenDisplayed=!0)}hideAllRulers(){[this._linearRulers,this._angularRulers].forEach(e=>{for(let t in e)e.hasOwnProperty(t)&&e[t]&&e[t].clear()})}destroy(){[this._linearRulers,this._angularRulers].forEach(e=>{for(let t in e)e.hasOwnProperty(t)&&e[t]&&(e[t].clear(),e[t].hasBeenDisplayed=!1,delete e[t])})}setCallbacksOnManipulateRulers(e,t){this._callbackOnManipulateLinear=e,this._callbackOnManipulateAngular=t}_createLinearRuler(){const e=new i(this._frameWindow,this._options.LINEAR);return this.setRulerUnit(e,"Length"),e.subscribe("RulerManipulateBegin",()=>{this.onTranslationRulerBeginManipulation()}),e.subscribe("RulerManipulate",()=>{this.onTranslationRulerManipulation()}),e.subscribe("RulerManipulateEnd",()=>{this.onTranslationRulerEndManipulation()}),e}_createAngularRuler(){const e=new n(this._frameWindow,this._options.ANGULAR);return this.setRulerUnit(e,"Angle"),e.subscribe("AngularRulerManipulateBegin",()=>{this.onAngularRulerBeginManipulation()}),e.subscribe("AngularRulerManipulate",()=>{this.onAngularRulerManipulation()}),e.subscribe("AngularRulerManipulateEnd",()=>{this.onAngularRulerEndManipulation()}),e}onAngularRulerBeginManipulation(){}onAngularRulerManipulation(){}onAngularRulerEndManipulation(){}onTranslationRulerBeginManipulation(){}onTranslationRulerManipulation(){}onTranslationRulerEndManipulation(){}set linearManipulated(e){this._linearManipulated=e}set angularManipulated(e){this._angularManipulated=e}get linearManipulated(){return this._linearManipulated}get angularManipulated(){return this._angularManipulated}setRulerUnit(e,t){if("Length"===t||"Angle"===t){if(e){const a=this._experienceBase.getManager("VCXUnitManager");let r="Length"===t?i.MM_UNIT:n.DEG_UNIT;if(a){let e=a.getUnitType(t).getDisplayUnit().Name;if(e){let t=s.VCXLinearRulerUnitEnum[e];t&&(r=t)}}e.unit=r}}else console.warn(t,"is not corresponding to the type of ruler")}updateLinearValue(e){const t=this.getLinearRulerByName(this.linearManipulated);if(t){let i=e.length();e.dot(t.direction)<=0&&(i=-i),t.setValue(i)}}updateAngularValue(e){const t=this.getAngularRulerByName(this.angularManipulated);if(t){var i=new a.Quaternion;let n;i.setFromRotationMatrix(e.rotationMatrix),n=r.getEulerFromQuaternion(i).dot(t.direction)>=0?180*e.angle/Math.PI:360-180*e.angle/Math.PI,t.setValue(n)}}}}),define("DS/VCXWebVisualization/VCXPlaneRulers",["require","exports","DS/VCXWebVisualization/VCXRulers","DS/Visualization/ThreeJS_DS"],function(e,t,i,n){"use strict";return class extends i{constructor(e,t){super(e,t,null),this._axisXRotation=new n.Vector3(1,0,0),this._axisYRotation=new n.Vector3(0,1,0),this._axisZTranslation=new n.Vector3(0,0,1),this._node=null,this._initialAngularValue={X:0,Y:0},this._initialLinearValue={Z:0}}set node(e){this._node=e}setAxisForTransformationRulers(e,t,i){this._axisXRotation.x=e,this._axisYRotation.y=t,this._axisZTranslation.z=i}createRulers(){this._linearRulers.Z=this._createLinearRuler(),this._angularRulers.X=this._createAngularRuler(),this._angularRulers.Y=this._createAngularRuler(),this.linearManipulated="Z"}_computeTranslationDirection(){if(this._node&&this._node.getChildByName("LeftMiddle")&&this._node.getChildByName("RightMiddle")&&this._node.getChildByName("TopMiddle")&&this._node.getChildByName("BottomMiddle")){let e=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("RightMiddle").getMatrixWorld().clone()),t=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("LeftMiddle").getMatrixWorld().clone()),i=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("TopMiddle").getMatrixWorld().clone()),a=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("BottomMiddle").getMatrixWorld().clone()),r=(new n.Vector3).subVectors(e,t),s=(new n.Vector3).subVectors(i,a),o=(new n.Vector3).crossVectors(r,s);return o.normalize(),o}return null}_computeDirectionRotation(){if(this._node&&this._node.getChildByName("LeftMiddle")&&this._node.getChildByName("RightMiddle")&&this._node.getChildByName("TopMiddle")&&this._node.getChildByName("BottomMiddle")&&this.angularManipulated){let e=null,t=null;if("Y"===this.angularManipulated&&(e=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("RightMiddle").getMatrixWorld().clone()),t=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("LeftMiddle").getMatrixWorld().clone())),"X"===this.angularManipulated&&(e=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("TopMiddle").getMatrixWorld().clone()),t=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("BottomMiddle").getMatrixWorld().clone())),e&&t){let i=(new n.Vector3).subVectors(e,t);return i.normalize(),i}}return null}_computeAxisRotation(){if(this._node&&this._node.getChildByName("LeftMiddle")&&this._node.getChildByName("RightMiddle")&&this._node.getChildByName("TopMiddle")&&this._node.getChildByName("BottomMiddle")&&this.angularManipulated){let e=null,t=null;if("X"===this.angularManipulated&&(e=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("RightMiddle").getMatrixWorld().clone()),t=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("LeftMiddle").getMatrixWorld().clone())),"Y"===this.angularManipulated&&(e=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("TopMiddle").getMatrixWorld().clone()),t=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("BottomMiddle").getMatrixWorld().clone())),e&&t){let i=(new n.Vector3).subVectors(e,t);return i.normalize(),i}}return null}updateTranslationRulers(){this.hideAllRulers();const e=this._linearRulers[this.linearManipulated];e&&this._node.getChildByName("CenterNode")&&(e.origin=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("CenterNode").getMatrixWorld()),e.direction=this._computeTranslationDirection(),this.setRulerUnit(e,"Length"),e.display(),e.setValue(0))}updateRotationRulers(){this.hideAllRulers();const e=this._angularRulers[this.angularManipulated];if(e&&this._node.getChildByName("CenterNode")){e.origin=(new n.Vector3).getPositionFromMatrix(this._node.getChildByName("CenterNode").getMatrixWorld());let t=this._computeAxisRotation();t&&(e.direction=t);let i=this._computeDirectionRotation();i&&(e.originVector=i),this.setRulerUnit(e,"Angle"),e.display(),e.setValue(0)}}onAngularRulerBeginManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180;this._initialAngularValue[this.angularManipulated]=e,this._callbackOnManipulateAngular.BeginManipulate()}onAngularRulerManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180-this._initialAngularValue[this.angularManipulated],t="X"===this.angularManipulated?this._axisXRotation:this._axisYRotation;const i=(new n.Matrix4).makeRotationAxis(t,e);this._callbackOnManipulateAngular.Manipulate(i)}onAngularRulerEndManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180-this._initialAngularValue[this.angularManipulated],t="X"===this.angularManipulated?this._axisXRotation:this._axisYRotation;const i=(new n.Matrix4).makeRotationAxis(t,e);this._callbackOnManipulateAngular.EndManipulate(i)}onTranslationRulerBeginManipulation(){this._callbackOnManipulateLinear.BeginManipulate(),this._initialLinearValue[this.linearManipulated]=this._linearRulers[this.linearManipulated].value}onTranslationRulerManipulation(){let e=this._linearRulers[this.linearManipulated].value-this._initialLinearValue[this.linearManipulated],t=new n.Vector3(0,0,this._axisZTranslation.z*e);this._callbackOnManipulateLinear.Manipulate(t)}onTranslationRulerEndManipulation(){let e=this._linearRulers[this.linearManipulated].value-this._initialLinearValue[this.linearManipulated],t=new n.Vector3(0,0,this._axisZTranslation.z*e);this._callbackOnManipulateLinear.EndManipulate(t)}}}),define("DS/VCXWebVisualization/VCXAnchorHandle",["DS/VCXWebVisualization/VCXHandle","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e)},getAnchorMatrixInWCS:function(){return this._parentOwnerComponent.QueryInterface("VCXIModifiable").GetAnchorWorldMatrix(this._id,null)},getMatrixInWCS:function(){return this.getAnchorMatrixInWCS()}})}),define("DS/VCXWebVisualization/VCXRobotRulers",["require","exports","DS/VCXWebVisualization/VCXRulers","DS/Visualization/ThreeJS_DS"],function(e,t,i,n){"use strict";const a=.001;return class extends i{constructor(e,t,i){super(e,i,null),this._robot=t,this._initialAngularValue={X:0,Y:0,Z:0},this._initialLinearValue={X:0,Y:0,Z:0}}createRulers(){this._linearRulers.X=this._createLinearRuler(),this._linearRulers.Y=this._createLinearRuler(),this._linearRulers.Z=this._createLinearRuler(),this._angularRulers.X=this._createAngularRuler(),this._angularRulers.Y=this._createAngularRuler(),this._angularRulers.Z=this._createAngularRuler()}updateRotationRulers(){this.hideAllRulers();let e="",t=null;if(this._robot.rotationArcYZ&&(this._robot.rotationArcYZ.isManipulated||this._robot.rotationArcYZ.isPreactivated)&&(e="X",t=this._robot.rotationArcYZ),this._robot.rotationArcXZ&&(this._robot.rotationArcXZ.isManipulated||this._robot.rotationArcXZ.isPreactivated)&&(e="Y",t=this._robot.rotationArcXZ),this._robot.rotationArcXY&&(this._robot.rotationArcXY.isManipulated||this._robot.rotationArcXY.isPreactivated)&&(e="Z",t=this._robot.rotationArcXY),t&&e&&this._angularRulers[e]){let i=new n.Vector3,a=new n.Vector3,r=new n.Vector3;this._robot.getMatrixWorld().extractBasis(i,a,r);let s=null;"Z"===e?s=i.clone():"Y"===e?s=r.clone():"X"===e&&(s=a.clone()),this._angularRulers[e].origin=(new n.Vector3).getPositionFromMatrix(this._robot.getMatrixWorld()),this._angularRulers[e].direction=t.axis,s&&(this._angularRulers[e].originVector=s.normalize()),this.setRulerUnit(this._angularRulers[e],"Angle"),this._angularRulers[e].display(),this._angularRulers[e].setValue(0),this.angularManipulated=e}}onTranslationRulerBeginManipulation(){this._callbackOnManipulateLinear.BeginManipulate(),this._initialLinearValue[this.linearManipulated]=this._linearRulers[this.linearManipulated].value}onTranslationRulerManipulation(){let e=this._linearRulers[this.linearManipulated].value,t=e-this._initialLinearValue[this.linearManipulated],i=this._linearRulers[this.linearManipulated].direction,n=i.clone(),a=i.clone();n.multiplyScalar(t),a.multiplyScalar(e),this._updateRobotTranslationMatrix(a),this._callbackOnManipulateLinear.Manipulate({translationVector:n})}onTranslationRulerEndManipulation(){this._callbackOnManipulateLinear.EndManipulate()}onAngularRulerBeginManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180;this._initialAngularValue[this.angularManipulated]=e,this._callbackOnManipulateAngular.BeginManipulate()}onAngularRulerManipulation(){let e=Math.PI*this._angularRulers[this.angularManipulated].value/180,t=e-this._initialAngularValue[this.angularManipulated],i=(new n.Matrix4).makeRotationAxis(this._angularRulers[this.angularManipulated].direction.clone(),t),a=(new n.Matrix4).makeRotationAxis(this._angularRulers[this.angularManipulated].direction.clone(),e);this._updateRobotRotationMatrix(a),this._callbackOnManipulateAngular.Manipulate({rotationMatrix:i})}onAngularRulerEndManipulation(){this._callbackOnManipulateAngular.EndManipulate()}_updateRobotRotationMatrix(e){let t=(new n.Matrix4).copy(e);t.multiply((new n.Matrix4).extractRotation(this._robot.initialMatrix));let i=t.setPosition((new n.Vector3).getPositionFromMatrix(this._robot.initialMatrix));this._robot.setMatrix(i)}_updateRobotTranslationMatrix(e){let t=new n.Vector3;t.getPositionFromMatrix(this._robot.initialMatrix),t.add(e);let i=(new n.Matrix4).copy(this._robot.getMatrix());this._robot.setMatrix(i.setPosition(t)),this._robot.updateCenterPosition(t)}updateTranslationRulers(){this.hideAllRulers();let e="",t=null;this._robot.arrowX&&(this._robot.arrowX.isManipulated||this._robot.arrowX.isPreactivated)&&(e="X",t=this._robot.arrowX),this._robot.arrowY&&(this._robot.arrowY.isManipulated||this._robot.arrowY.isPreactivated)&&(e="Y",t=this._robot.arrowY),this._robot.arrowZ&&(this._robot.arrowZ.isManipulated||this._robot.arrowZ.isPreactivated)&&(e="Z",t=this._robot.arrowZ),t&&e&&this._linearRulers[e]&&(this._linearRulers[e].origin=(new n.Vector3).getPositionFromMatrix(this._robot.getMatrixWorld()),this._linearRulers[e].direction=this._getTranslationAxis(e),this.setRulerUnit(this._linearRulers[e],"Length"),this._linearRulers[e].display(),this._linearRulers[e].setValue(0),this.linearManipulated=e)}_verifyCoordinatesToTolerance(e){e&&(Math.abs(e.x)<a&&(e.x=0),Math.abs(e.y)<a&&(e.y=0),Math.abs(e.z)<a&&(e.z=0))}_getTranslationAxis(e){let t=null,i=new n.Vector3,a=new n.Vector3,r=new n.Vector3;switch(this._robot.getMatrixWorld().extractBasis(i,a,r),e){case"X":t=i.clone();break;case"Y":t=a.clone();break;case"Z":t=r.clone()}return t&&(this._verifyCoordinatesToTolerance(t),t.normalize()),t}}}),define("DS/VCXWebVisualization/VCXRobotAdapter",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebModifiablesServices/VCXModifiablesServices","DS/CoreEvents/Events","DS/VCXWebSystem/VCXMathTools","DS/Mesh/MeshUtils","DS/VCXWebVisualization/VCXRobotRulers"],function(e,t,i,n,a,r,s,o,l){"use strict";var u=e.extend({initialize:function(){},postInitialize:function(){this._WUXEventTokens={};var e=this,i=this._experienceBase.getManager("VCXContextManager");this._WUXEventTokens.VCX_TEMPORARILY_HIDE_DECORATION=r.subscribe({event:"VCX_TEMPORARILY_HIDE_DECORATION"},function(t){var n=i.getMainViewer().getRobot();n&&(e._robotConnectedBeforeSave=n.isConnected,e._robotPositionMatrix=n.getMatrix(),"RasterImage"===t.Source&&i.getMainViewer().setReferenceAxisSystem(!1))}),this._WUXEventTokens.VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION=r.subscribe({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION"},function(t){var n=i.getMainViewer().getRobot();e._robotConnectedBeforeSave&&(n.setConnectionState(!0),n.fixedSizeNode3D.setRatio(7),n.setRobotMatrix(e._robotPositionMatrix),e._robotConnectedBeforeSave=null,e._robotPositionMatrix=null),"RasterImage"===t.Source&&i.getMainViewer().setReferenceAxisSystem(!0)});var n=this._experienceBase.getManager("VCXGUIManager");i.getMainViewer().setRobot(!0,{snapOnFace:!0,showOnlyManipulated:!0,touchMode:n.isTouchActivated()}),this._robot=this._experienceBase.getManager("VCXContextManager").getMainViewer().getRobot(),"replay"!==this._experienceBase.odt&&(this._rulers=new l(this._experienceBase.getManager("VCXContextManager").getFrameWindow(),this._robot,this._experienceBase),this._rulers.createRulers(),this._rulers.setCallbacksOnManipulateRulers({BeginManipulate:()=>this._allManipulationBeginCB({eventChannel:"TranslationBegin"}),Manipulate:e=>this._lineTranslationManipulationCB(e),EndManipulate:()=>this._allManipulationEndCB({eventChannel:"TranslationEnd"},"translation")},{BeginManipulate:()=>this._allManipulationBeginCB({eventChannel:"RotationBegin"}),Manipulate:e=>this._rotationManipulationCB(e),EndManipulate:()=>this._allManipulationEndCB({eventChannel:"RotationEnd"},"translation")}));var a=new t.Vector3(1,0,0),s=new t.Vector3(0,1,0),u=new t.Vector3(0,0,1);this._robot.updateAxis(a,s,u);var c=this._robot.ratio.docked;this._robot.setRatio({docked:n.isTouchActivated()?c+2:c,moving:c,connected:n.isTouchActivated()?c+2:c}),this._robot.setDisplayScalingNodes(!1);if(this._robot.setGetPositionCB((e,t,i)=>{var a=this._robot&&this._robot.fixedSizeNode3D.ratio/7,r=n&&n.getUsableArea(),s=r&&r.getBoundingClientRect();return s&&"number"==typeof a?{x:2*i*(s.right-100*a)/e-1,y:2*(1-i*((s.bottom-100*a)/t))-1}:{x:.85,y:-.8}}),this._experienceBase.getManager("VCXContextManager").getMainViewer().getReferenceAxisSystemNode&&this._experienceBase.getManager("VCXContextManager").getMainViewer().getReferenceAxisSystemNode().setGetPositionCB((e,t,i)=>{var a={x:null,y:null},r=n&&n.getUsableArea(),s=r&&r.getBoundingClientRect();return s?(a.x=Math.min(2*i*(s.right-20)/e-1,.85),a.y=Math.max(2*(1-i*((s.bottom-20)/t))-1,-.8)):(a.x=.85,a.y=-.8),a}),this._experienceBase.getManager("VCXContextManager").getPlayerMode())this._robot.robotHandle.setPickable(o.NOPICKABLE);else{e=this;this._robot.setMoveMode("CALLBACK_ONLY"),this._robot.setAddToHSO(!1),this._robot.setAddToCSO(!1),this.tokens={},this.tokens.lineTranslationBegin=this._robot.subscribe("ScalingBegin",function(t){t.target&&e._allManipulationBeginCB(t)}),this.tokens.lineTranslationManipulation=this._robot.subscribe("ScalingManipulation",function(t){t.target&&e._lineTranslationManipulationCB(t)}),this.tokens.lineTranslationEnd=this._robot.subscribe("ScalingEnd",function(t){t.target&&e._allManipulationEndCB(t,"scaling")}),this.tokens.lineTranslationBegin=this._robot.subscribe("LineTranslationBegin",function(t){t.target&&e._allManipulationBeginCB(t),e._rulers&&e._rulers.updateTranslationRulers()}),this.tokens.lineTranslationManipulation=this._robot.subscribe("LineTranslationManipulation",function(t){t.target&&e._lineTranslationManipulationCB(t),e._rulers&&e._rulers.updateLinearValue(t.translationVector)}),this.tokens.lineTranslationEnd=this._robot.subscribe("LineTranslationEnd",function(t){t.target&&e._allManipulationEndCB(t,"translation")}),this.tokens.planeTranslationBegin=this._robot.subscribe("PlaneTranslationBegin",function(t){t.target&&e._allManipulationBeginCB(t)}),this.tokens.planeTranslationManipulation=this._robot.subscribe("PlaneTranslationManipulation",function(t){t.target&&e._planeTranslationManipulationCB(t)}),this.tokens.planeTranslationEnd=this._robot.subscribe("PlaneTranslationEnd",function(t){t.target&&e._allManipulationEndCB(t,"translation")}),this.tokens.rotationBegin=this._robot.subscribe("RotationBegin",function(t){t.target&&e._allManipulationBeginCB(t),e._rulers&&e._rulers.updateRotationRulers()}),this.tokens.rotationManipulation=this._robot.subscribe("RotationManipulation",function(t){if(t.target&&e._rotationManipulationCB(t),t.angle&&t.rotationMatrix){let i={};i.angle=t.angle,i.rotationMatrix=t.rotationMatrix,e._rulers&&e._rulers.updateAngularValue(i)}}),this.tokens.rotationEnd=this._robot.subscribe("RotationEnd",function(t){t.target&&e._allManipulationEndCB(t,"translation")}),this.tokens.screenPlaneTranslationBegin=this._robot.subscribe("ScreenPlaneTranslationBegin",function(t){e._screenPlaneTranslationBeginCB(t)}),this.tokens.screenPlaneTranslationEnd=this._robot.subscribe("ScreenPlaneTranslationEnd",function(t){e._screenPlaneTranslationEndCB(t)}),this._arrayModifiables=null,this._initialFramesInParents=null,this._initialPivotsInParents=null,this._lastData=null}},unInitialize:function(){for(var e in this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(e)&&this._WUXEventTokens[e]&&(r.unsubscribe(this._WUXEventTokens[e]),this._WUXEventTokens[e]=null);if(this._rulers&&(this._rulers.destroy(),this._rulers=null),this._robot){if(!this._experienceBase.getManager("VCXContextManager").getPlayerMode())for(var t in this.tokens)if(this.tokens.hasOwnProperty(t)){var i=this.tokens[t];this._robot.unsubscribe(i),this.tokens[t]=null}this._robot.setGetPositionCB(null),this._robot=null,this.tokens=null}},_allManipulationBeginCB:function(e){this._saveInitialPositions(),this._togglePrePicking(!1),this._experienceBase.getManager("VCXCommandManager").StartTransaction("Robot "+e.eventChannel.substring(0,e.eventChannel.indexOf("Begin")))},_allManipulationEndCB:function(e,t){if(this._experienceBase.getManager("VCXCommandManager").EndTransaction("Robot "+e.eventChannel.substring(0,e.eventChannel.indexOf("Begin"))),this._togglePrePicking(!0),"record"===this._experienceBase.odt){var i=this._arrayModifiables.map(function(e){return e.GetObject().GetID()});if(this._lastData.translationVector){var n={commandName:"VCXTransformCmd",transformType:t,inputStr:this._lastData.translationVector.createJSON(),componentsIDs:i};this._experienceBase.getManager("VCXODTManager").LogAPI("VCXExecuteTransform",n)}}this._arrayModifiables=null,this._initialFramesInParents=null,this._initialPivotsInParents=null,this._lastData=null},_lineTranslationManipulationCB:function(e){this._arrayModifiables&&0!==this._arrayModifiables.length&&(this._updateWithManipulation("translation",e.translationVector,this._robot.initialMatrix),this._lastData=e)},_planeTranslationManipulationCB:function(e){this._lineTranslationManipulationCB(e)},_rotationManipulationCB:function(e){this._arrayModifiables&&0!==this._arrayModifiables.length&&(this._updateWithManipulation("rotation",e.rotationMatrix,this._robot.initialMatrix),this._lastData=e)},_screenPlaneTranslationBeginCB:function(e){var t=this._experienceBase.getManager("VCXContextManager").getContext(),n=i.getCommand("VCXTransformCmd",t);n&&!n.isRunning()&&n.end(),0===this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromCurrentSelection("VCXWebComponentOccurrence").length?(this._robot.setAddToHSO(!0),this._robot.setAddToCSO(!0)):(this._robot.setAddToHSO(!1),this._robot.setAddToCSO(!1)),this._togglePrePicking(!1)},_screenPlaneTranslationEndCB:function(e){if(e.target){r.publish({event:"VCX_DONT_CHNG_ROBOT_POS_AT_TRANSFORM_BEGIN"});var t=this._experienceBase.getManager("VCXContextManager").getContext(),n=i.getCommand("VCXTransformCmd",t);n&&!n.isRunning()&&n.begin()}this._togglePrePicking(!0)},_updateWithManipulation:function(e,i,r){var s=null;switch(e.toLowerCase()){case"rotation":if(!(i instanceof t.Matrix4))return void console.error("A THREE.Matrix4 object is needed as input !");s=function(e){return a.buildPropertyLocationWithRotationInWCS(e,i,r)};break;case"translation":if(!(i instanceof t.Vector3))return void console.error("A THREE.Vector3 object is needed as input !");s=function(e){return a.buildPropertyLocationWithTranslationInWCS(e,i,r)};break;default:return void console.error("A compatible manipulation type ('translation' or 'rotation') must be specified as argument !")}this._restoreLastInitPositions();for(var o=new n(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager")),l=0;l<this._arrayModifiables.length;l++){var u=s(this._arrayModifiables[l]);o.ChangeProperty(this._arrayModifiables[l],u)}this._experienceBase.getManager("VCXCommandManager").Push(o)},_saveInitialPositions:function(){this._arrayModifiables=[];var e=this._experienceBase.getManager("VCXSelectionManager").GetComponentsFromSelection("CSO");e=a.filterChildrenOfCompsFromArray(e);for(var t=0;t<e.length;++t)if(e[t].IsKindOf("VCXWebComponentOccurrence")&&!e[t].IsDressup){var i=e[t].QueryInterface("VCXIModifiable");i&&this._arrayModifiables.push(i)}if(0!==this._arrayModifiables.length){this._initialFramesInParents=[],this._initialPivotsInParents=[];for(t=0;t<this._arrayModifiables.length;t++){var n=this._arrayModifiables[t].GetProperty("Actor.Position").GetPropertyValue();this._initialFramesInParents[t]=n.GetFrame().GetValue(),this._initialPivotsInParents[t]=n.GetPivot().GetValue()}}},_restoreLastInitPositions:function(){for(var e=0;e<this._arrayModifiables.length;e++){var i=(new t.Matrix4).copy(this._initialFramesInParents[e]),n=(new t.Matrix4).copy(this._initialPivotsInParents[e]),r=a.buildPropertyLocationWithFramePivot(i,n);this._arrayModifiables[e].OnChangeProperty("Actor.Position",r.GetPropertyValue()),this._arrayModifiables[e].OnChangePropertiesEnd()}},_togglePrePicking:function(e){var t=this._experienceBase.getManager("VCXContextManager"),i=t&&t.getMainViewer();i&&i.setPrePicking({activated:e})},executeTransformODT:function(e){var i=null,n=new t.Matrix4;"rotation"===e.transformType?(i=new t.Matrix4,n.setFromJSON(e.initialMatrixStr)):"translation"===e.transformType&&(i=new t.Vector3),i.setFromJSON(e.inputStr);this._experienceBase.ComponentsMap.GetComponentsFromIDs(e.componentsIDs);this._saveInitialPositions(),this._updateWithManipulation(e.transformType,i,n),this._arrayModifiables=null},displayRobot:function(e,t){var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();i&&i.getRobot()&&(i.getRobot().setVisibility(e),e||(this._rulers&&this._rulers.hideAllRulers(),i.setReferenceAxisSystem(t)))}});return Object.defineProperty(u.prototype,"componentType",{enumerable:!0,get:function(){return"VCXRobotAdapter"}}),u}),define("DS/VCXWebVisualization/VCXArrowHandle",["DS/VCXWebVisualization/VCXHandle","DS/VCXWebVisualization/VCXBillBoardArrowNode3D","DS/VCXWebVisualization/VCXInteractor","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/FixedSizeNode3D","DS/WebappsUtils/WebappsUtils"],function(e,t,i,n,a,r,s,o){"use strict";return e.extend({init:function(e){this._parent(e)},_generateHandleGeom:function(e){var o=new a(e.name);this.isPreactivated=!1,this.isManipulated=!1;var l=this._experienceBase.getManager("VCXVisuManager");void 0===e.noz||e.noz;new n.Vector2(0,0);this.arrowNode=r.createRectangleNode({width:1,height:4,cornerPoint:new n.Vector2(0,0),fill:!0,fillColor:null,noEdge:!0,material:this._getMaterial()}),this.arrowNode.name="arrowNode",this.arrowNode.setShadow(!1),this.arrowNode.setFrustumCulled(!1),this.arrowNode.excludeFromCSO(!0),this.arrowNode.excludeFromHighlight(!0,!0),this.arrowNode.setMirror(!1),this.arrowNode.exludeFromBounding(!0),this.arrowNode.setRenderPasses([l.getRenderList("VCXPreManipulators"),l.getRenderList("VCXManipulators")]);let u=new n.Matrix4;u.identity();const c=new n.Vector3(1,0,0).applyMatrix4(u).normalize(),h=(new n.Vector3(0,1,0).applyMatrix4(u).normalize(),new n.Vector3(0,0,1).applyMatrix4(u).normalize());let p=new n.Matrix4;switch(e.interactor.constraint){case i.EConstraint.XAxis:p=(new n.Matrix4).makeRotationAxis(h,.5*Math.PI);break;case i.EConstraint.YAxis:break;case i.EConstraint.ZAxis:p=(new n.Matrix4).makeRotationAxis(c,-.5*Math.PI);break;case i.EConstraint.CustomAxis:p=(new n.Matrix4).makeRotationAxis(c,.5*Math.PI)}this.arrowNode.setMatrix(p.translate(new n.Vector3(-.5,0,0))),this.arrowNode.setMatrix(this.arrowNode.getMatrix());var d={position:this.position,name:"billBoardNode"};return this.billBoardNode=new t(d),this.billBoardNode.addChild(this.arrowNode),this.fixedSizeNode=new s({name:"fixedSizeNode3D",ratio:this._displaySize}),this.fixedSizeNode.addChild(this.billBoardNode),o.add(this.fixedSizeNode),this.sceneGraph.add(o),o},_getMaterial:function(){var e=o.getWebappsAssetUrl("VCXWebVisualization","texture"),t=new n.ImageUtils.loadTexture(e+"/AS_Arrow.png");t.flipY=!1;var i=new n.MeshBasicMaterial({map:t,side:n.DoubleSide,alphaTest:.05,enableClipPlanes:!1,opacity:this.opacity});return i.force=!0,i},_setBillboardType:function(){var e="Spherical";this.interactor.manipulatorType===i.EManipulatorType.ArrowHandle&&(e=this.interactor.constraint===i.EConstraint.XAxis?"PRESERVE_X_AXIS":this.interactor.constraint===i.EConstraint.YAxis?"PRESERVE_Y_AXIS":"PRESERVE_Z_AXIS"),this.billBoardNode&&(this.billBoardNode.BillBoardType=e)}})}),define("DS/VCXWebVisualization/VCXPickerTools",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/VCXWebVisualization/VCXPickInfo","DS/VCXWebVisualization/VCXInteractor","DS/Mesh/MeshUtils"],function(e,t,i,n,a,r){"use strict";return e.extend({init:function(e){this._experienceBase=e||null,this._verticalDecay=0,this._useNormalConstraintToCamera=!1,this._useNormalConstraint=!1,this._usePointConstraint=!1,this._currentComponent=null},clear:function(){this._experienceBase=null},setVerticalDecay:function(e){this._verticalDecay=e},setCurrentComponent:function(e){this._currentComponent=e},useNormalConstraintToCamera:function(e){this._useNormalConstraintToCamera=e},useNormalConstraint:function(e,i){this._useNormalConstraint=!!e,e&&(this._normalConstraint=(new t.Vector3).copy(i)),this.useNormalConstraintToCamera(!1)},usePointConstraint:function(e,i){this._usePointConstraint=!!e,e&&(this._pointConstraint=(new t.Vector3).copy(i))},pick2DonGround:function(e,t,i){return this.pick(e,{pageX:t,pageY:i}).pickInfo.globalPosition},setCanonicMode:function(e,t){this._experienceBase.getManager("VCXCanonicsManager")},pick:function(e,i,r,s){var o,l={mouse:{},viewer:e};r&&this._currentComponent&&(o=this._currentComponent.QueryInterface("VCXIManipulable").getInteractor(r));if(s&&s.event)l.mouse=e.getMousePosition(s.event.from[0].getCurrentPosition(e.div));else{let n=e.div.getBoundingClientRect(),a=i.pageX-n.left,r=i.pageY-n.top-this._verticalDecay;l.mouse=e.getMousePosition(new t.Vector2(a,r))}l.pickInfo?l.pickInfo.reset():(l.pickInfo=new n(e,this._experienceBase),l.pickInfo.zShiftRatio=0);var u=l.pickInfo,c=null;if((!o||o&&0===o.type)&&!this._usePointConstraint){if(s&&s.eventChannel&&"BeginManipulate"!==s.eventChannel&&"EndManipulate"!==s.eventChannel)c=s.intersection;else{let t=this._experienceBase.odt?"repHybrid":"mesh";i&&"DSpointermove"===i.type&&(t="mesh"),c=e.pick(l.mouse,t,!0,null,!1)}if(u.ray=c.ray,c&&c.path&&c.path.length>0&&c.path[0]){u.pathElement=c.path[0].clone(),!1===e.multiViewerFix&&u.pathElement.externalPath.splice(0,1);var h=u.modifiable;let t=!0;h&&h.GetObject().IsDressup&&!h.GetObject().IsPickerSensitive&&(t=!1),t?(c.position&&(u.globalPosition=c.position.clone(),this._lastValidPosition=u.globalPosition),c.normal&&(u.globalNormal=c.normal.clone())):(c=null,u.pathElement=null)}}if(l.mouse.xPix/=window.devicePixelRatio,l.mouse.yPix/=window.devicePixelRatio,!c||0===c.path.length)if(o&&o.tag&&o.tag.Snap2D&&(o.constraint===a.EConstraint.Screen||o.type===a.EType.Screen))this._experienceBase.getManager("VCXCanonicsManager").snap2D(this._currentComponent,o,l,s);else{var p=this._lastValidPosition?this._lastValidPosition:new t.Vector3;this._usePointConstraint&&(p=this._pointConstraint);var d=e.currentViewpoint.getSightDirection().clone().negate().normalize();this._useNormalConstraint&&(d=this._normalConstraint),this._useNormalConstraintToCamera&&(d=e.currentViewpoint.getSightDirection().clone().negate().normalize());var g=new t.Plane(d,0).setFromNormalAndCoplanarPoint(d,p),_=e.currentViewpoint.create3DRayFrom2DPoint(new t.Vector2(l.mouse.xPix,l.mouse.yPix)).intersectPlane(g);_&&(u.globalPosition=_),u.globalNormal=e.currentViewpoint.getSightDirection().clone().negate().normalize()}if(u.smartMouse.x=l.mouse.xPix,u.smartMouse.y=l.mouse.yPix,!o||o&&0===o.type){var m=this._experienceBase.getManager("VCXCanonicsManager");const e=this._experienceBase.getManager("VCX3DGridManager");let t=!1;e&&u.modifiable&&(t=e.checkSnappingGrid(u.modifiable.GetObject()));let i=null;t?(u.considerSnapFilter=!1,i=e.detectGrid(u.modifiable?u.modifiable.GetObject():null,u.ray,o,u)):(e&&e.manageAllGuidingLines(null,null),u.considerSnapFilter=!0),m&&m.pickCanonics(u,o,s)}return this._useNormalConstraint&&(u.globalNormal=this._normalConstraint),this._useNormalConstraintToCamera&&(u.globalNormal=e.currentViewpoint.getSightDirection().clone().negate().normalize()),l}})}),define("DS/VCXWebVisualization/VCXManipulatorManager",["DS/CoreEvents/Events","DS/Manipulators/ScreenPlaneManipulator","DS/Manipulators/LineTranslationManipulator","DS/Manipulators/HandlePointManipulator","DS/Manipulators/PlaneTranslationManipulator","DS/Manipulators/ScalingManipulator","DS/Manipulators/RotationManipulator","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebSystem/VCXMathTools","DS/VCXWebVisibility/VCXIVisibility","DS/VCXWebVisualization/VCXAnchorHandle","DS/VCXWebVisualization/VCXHandle","DS/VCXWebVisualization/VCXArrowHandle","DS/VCXWebVisualization/VCXInteractor","DS/VCXWebProperties/VCXPropertyMap","DS/Visualization/ThreeJS_DS","UWA/Class","DS/VCXWebVisualization/VCXPickerTools"],function(e,t,i,n,a,r,s,o,l,u,c,h,p,d,g,_,m,f){"use strict";var M=m.extend({init:function(){},initialize:function(){this._parent()},getInitPhase:function(){return 8},unInitialize:function(){for(var t in this._parent(),this.removeManipulators(),this.refreshHandlesFromComponentList(),this._WUXEventTokens)this._WUXEventTokens.hasOwnProperty(t)&&this._WUXEventTokens[t]&&(e.unsubscribe(this._WUXEventTokens[t]),this._WUXEventTokens[t]=null);for(;this._iManipulables&&this._iManipulables.length;){var i=this._iManipulables[0];this.unregisterManipulable(i)}this._iManipulables=null,this.unsubscribeAllInteractors(!0),this._manipulationTokens=null,this.bManipulationsAllowed=null,this._manipulatorsActive=null,this._manipulatorsPreactive=null,delete this._activeManipulables},postInitialize:function(){this._parent(),this._iManipulables=[],this._manipulationTokens={},this._WUXEventTokens={};var t=this._experienceBase.getManager("VCXContextManager").getMainViewer();"boolean"!=typeof this._manipulatorsActive&&t.getManipulators&&(this._manipulatorsActive=t.getManipulators()),"boolean"!=typeof this._manipulatorsPreactive&&(this._manipulatorsPreactive=t.pPicking&&t.manipulatorManager&&t.manipulatorManager.preActivation),t.setManipulators({activated:this._manipulatorsActive,preActivate:this._manipulatorsPreactive}),this._WUXEventTokens.VCX_INTERACTOR_CREATED=e.subscribe({event:"VCX_INTERACTOR_ADDED"},e=>{this.removeManipulators();e.interactor;var t=e.manipulable;this._iManipulables.includes(t)||this.registerManipulable(t)}),this._WUXEventTokens.VCX_PREHIGHLIGHT_EMPTY=e.subscribe({event:"VCX_PREHIGHLIGHT_EMPTY"},e=>{this._manipulationInProgress||this.removeManipulators()}),this._WUXEventTokens.VCX_HIGHLIGHT_EMPTY=e.subscribe({event:"VCX_HIGHLIGHT_EMPTY"},e=>{this._manipulationInProgress||this.removeManipulators()}),this._WUXEventTokens.VCX_PREHIGHLIGHT_REMOVE=e.subscribe({event:"VCX_PREHIGHLIGHT_REMOVE"},e=>{if(!this._manipulationInProgress){var t=e.map(function(e){return e.pathElement}),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.removeManipulators(i),this.refreshHandlesFromComponentList(i)}}),this._WUXEventTokens.VCX_HIGHLIGHT_REMOVE=e.subscribe({event:"VCX_HIGHLIGHT_REMOVE"},e=>{if(!this._manipulationInProgress){var t=e.map(function(e){return e.pathElement}),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.removeManipulators(i),this.refreshHandlesFromComponentList(i)}}),this._WUXEventTokens.VCX_SELECTION_REMOVE=e.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_REMOVE"},e=>{this._manipulationInProgress||(this.removeManipulators(e),this.refreshHandlesFromComponentList(e))}),this._WUXEventTokens.VCX_SELECTED_ACTORS_EMPTY=e.subscribe({event:"VCX_SELECTED_ACTORS_EMPTY"},e=>{this._manipulationInProgress||(this.removeManipulators(e),this.refreshHandlesFromComponentList(e))}),this._WUXEventTokens.VCX_PREHIGHLIGHT_ADD=e.subscribe({event:"VCX_PREHIGHLIGHT_ADD"},e=>{if(!this._manipulationInProgress){var t=e.map(function(e){return e.pathElement}),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.addManipulators(i,!1),this.refreshHandlesFromComponentList(i)}}),this._WUXEventTokens.VCX_HIGHLIGHT_ADD=e.subscribe({event:"VCX_HIGHLIGHT_ADD"},e=>{if(!this._manipulationInProgress){var t=e.map(function(e){return e.pathElement}),i=this._experienceBase.ComponentsMap.GetComponentsFromPathElements(t);this.addManipulators(i,!1),this.refreshHandlesFromComponentList(i)}}),this._WUXEventTokens.VCX_SELECTION_ADD=e.subscribe({event:"VCX_SELECTION_COMPONENTSLIST_ADD"},e=>{this._manipulationInProgress||(this.addManipulators(e,!0),this.refreshHandlesFromComponentList(e))}),this._WUXEventTokens.VCX_VISIBILITY_CHANGED=e.subscribe({event:"VCX_VISIBILITY_CHANGED"},e=>{if(e.visibility===u.EVisState.Hidden){this.refreshHandlesFromComponentList(e.components);for(let t of e.components){let e=t&&t.QueryInterface("VCXIManipulable");e&&e._rulers&&e._rulers.hideAllRulers()}}}),this._WUXEventTokens.VCX_DRESSUPS_REMOVE=e.subscribe({event:"VCX_DRESSUPS_REMOVED"},e=>{for(var t=0;t<e.length;++t){var i=e[t],n=i&&i.QueryInterface("VCXIManipulable");n&&this.unregisterManipulable(n),n&&n._rulers&&n._rulers.hideAllRulers()}}),this._WUXEventTokens.VCX_DRESSUPS_ADDED=e.subscribe({event:"VCX_DRESSUPS_ADDED"},e=>{this.removeManipulators();for(var t=0;t<e.length;++t){var i=e[t],n=i&&i.QueryInterface("VCXIManipulable");this._iManipulables.includes(n)||n&&this.registerManipulable(n)}}),this._WUXEventTokens.VCX_TEMPORARILY_HIDE_DECORATION=e.subscribe({event:"VCX_TEMPORARILY_HIDE_DECORATION"},e=>{if(!this._manipulationInProgress){var t=this.getActiveManipulables();this.refreshHandlesFromComponentList(t),this._allInteractorShouldBeHidden=!0}}),this._WUXEventTokens.VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION=e.subscribe({event:"VCX_RESTORE_TEMPORARILY_HIDDEN_DECORATION"},e=>{if(!this._manipulationInProgress){this._allInteractorShouldBeHidden=!1;var t=this.getActiveManipulables();this.refreshHandlesFromComponentList(t)}})},registerManipulable:function(e){this._iManipulables.push(e)},unregisterManipulable:function(e){for(var t=e.GetObject(),i=t.GetID(),n=0;n<this._iManipulables.length;++n){var a=this._iManipulables[n].GetObject().GetID();if(a===i)break}if(a===i){var r=this._iManipulables[n];if(r){var s=r.getAllInteractors();for(var o in s)if(s.hasOwnProperty(o)){let e=s[o];this.unsubscribeInteractor(t,e,!0)}this._iManipulables.splice(n,1)}}},unsubscribeAllInteractors:function(e){let t=[];for(let e in this._manipulationTokens)t.push(e);t.forEach(t=>{this.unsubscribeAllComponentInteractors(t,e)})},unsubscribeAllComponentInteractors:function(e,t){let i=[],n=this._manipulationTokens&&this._manipulationTokens[e];if(n)for(let e in n)i.push(e);i.forEach(i=>{this.unsubscribeInteractor(e,i,t)})},unsubscribeInteractor:function(e,t,i){var n=t.manipulator;if(n){var a=e.GetID();if(this._manipulationTokens&&this._manipulationTokens[a]&&this._manipulationTokens[a][t.id]){for(var r=Object.keys(this._manipulationTokens[a][t.id]),s=0;s<r.length;++s){var o=r[s];if("interactor"!==o){var l=this._manipulationTokens[a][t.id][o];l&&n.unsubscribe(l)}}delete this._manipulationTokens[a][t.id],n.interactor=null,t.manipulator.unlink(t.manipulatorToken),t.manipulator=null,t.manipulatorToken=null,i&&t.handle&&(t.handle.remove(),t.handle=null)}}},addManipulators:function(e){if(delete this._activeManipulables,Array.isArray(e)){this._experienceBase.getManager("VCXSelectionManager");for(var t=0;t<e.length;++t){var i=e[t],n=i&&i.QueryInterface("VCXIManipulable");if(n)-1===this._iManipulables.indexOf(n)&&this.registerManipulable(n)}}else console.warn("Data given by SelectionManager for adds have changed..")},removeManipulators:function(e){delete this._activeManipulables,this._manipulationInProgress=!1},updateAllInteractors:function(e){var t=e;if(!t){var i=this._experienceBase.getManager("VCXContextManager").getMainViewer();t={viewer:i,viewpoint:i.currentViewpoint}}if(Array.isArray(this._iManipulables)&&this._iManipulables.length>0)for(var n=0;n<this._iManipulables.length;n++)this._iManipulables[n].updateInteractors(t)},updateManipulatorOfInteractor:function(e,t,i){var n=e.GetObject(),a=e.QueryInterface("VCXIModifiable");let r=e.getInteractor(t);if(!r)return!1;if(r.data&&"number"==typeof r.data.anchorID&&!a.GetAnchorValue(r.data.anchorID))return r.manipulator&&this.unsubscribeInteractor(n,r,!0),delete e._interactors[t],!1;if(!r.active)return r.disable(),!1;var s=this.updateInteractorManipulator(e,r);if(r.manipulatorType!==d.EManipulatorType.None){if(!r.matrix)return console.error("Every interactor should have a set matrix"),!1;if(r.handle||(r.handle=this.createHandle(n,r)),!r.handle)return console.error("Handle not specified for this interactor"),!1;var o=r.handle;r.manipulatorToken||(r.manipulatorToken=s.linkToNode(r.node),o.updateManipulatorCallbacks(s)),o.setMatrix(r.handleMatrix),o.updateTexture(i);var l=r.handleInfos;r.handleInfos&&("boolean"==typeof l.stayVisible&&o.StayVisible(l.stayVisible),o.getOpacity()!==l.opacity&&o.setOpacity(l.opacity),o.getColor()!==l.color&&o.setColor(l.color),o.getSize()!==l.size&&o.setSize(l.size)),!o.isDisplayed()&&(r.visibility===d.EVisibility.Always||o.getOpacity()>0)?o.Show():!o.isDisplayed()||r.visibility!==d.EVisibility.NoChange&&0!==o.getOpacity()||o.Hide()}else!r.manipulatorToken&&r.pathElement&&(r.manipulatorToken=s.linkToNode(r.pathElement.getLastElement(!0))),s.setSelectionAllowed(!0);return r.active?r.enable():r.disable(),!0},updateManipulatorsOfManipulable:function(e,t){this._experienceBase.getManager("VCXContextManager"),this._experienceBase.getManager("VCXExperience");var i=!1,n=e.getAllInteractors();for(var a in n)i|=this.updateManipulatorOfInteractor(e,a,t);i&&(e._active=!0)},removeManipulatorsFromIManipulable:function(e){var t=e.getAllInteractors(),i=e.GetObject();for(var n in t)if(t.hasOwnProperty(n)){let e=t[n];var a=e&&e.manipulator;a&&this.unsubscribeInteractor(i,a.interactor,!0)}},disableManipulable:function(e){var t=e.getAllInteractors();e.GetObject();for(var i in t)if(t.hasOwnProperty(i)){let e=t[i];e&&e.disable()}e._active=!1},updateInteractorManipulator:function(e,t){return this._checkManipulatorMatchesInteractor(t)?t.updateAxis():(this.unsubscribeInteractor(e.GetObject(),t),this.generateInteractorManipulator(e,t)),t.manipulator},_checkManipulatorMatchesInteractor:function(e){if(!e||!e.manipulator)return!1;var o=e.manipulator,l=!1;switch(e.type){case d.EType.Pick:l=o instanceof n;break;case d.EType.PlaneTranslation:l=o instanceof a;break;case d.EType.LineTranslation:l=o instanceof i;break;case d.EType.Scaling:l=o instanceof r;break;case d.EType.Rotation:l=o instanceof s;break;case d.EType.Screen:l=o instanceof t;break;default:l=!1}return l},generateInteractorManipulator:function(e,o){var l=null;switch(o.type){case d.EType.Pick:l=new n;break;case d.EType.PlaneTranslation:l=new a({axis:o.updateAxis()});break;case d.EType.LineTranslation:l=new i({axis:o.updateAxis()});break;case d.EType.Scaling:l=new r({axis:o.updateAxis()});break;case d.EType.Rotation:l=new s({axis:o.updateAxis()});break;case d.EType.Screen:l=new t}l.checkManipulatorsOnCreation(!0),l.setExclusive(!0),o.manipulator=l,l.interactor=o;this._experienceBase.getManager("VCXContextManager");var u=l.subscribe("BeginPreactivate",this._beginPreactivateCB(e)),c=l.subscribe("Preactivate",this._preactivateCB(e)),h=l.subscribe("EndPreactivate",this._endPreactivateCB(e)),p=l.subscribe("BeginManipulate",this._beginManipulateCB(e)),g=l.subscribe("Manipulate",this._manipulateCB(e)),_=l.subscribe("EndManipulate",this._endManipulateCB(e)),m=l.subscribe("PrimaryPointerClick",this._primPointerClickCB(e)),f=l.subscribe("PrimaryPointerDoubleClick",this._primPointerDblClickCB(e)),M=e.GetObject().GetID();this._manipulationTokens[M]||(this._manipulationTokens[M]={}),this._manipulationTokens[M][o.id]={interactor:o,tokenBeginPreactivate:u,tokenPreactivate:c,tokenEndPreactivate:h,tokenBeginManipulate:p,tokenManipulate:g,tokenEndManipulate:_,tokenPrimPointerClick:m,tokenPrimPointerDblClick:f}},checkManipulationInProgress:function(){for(var e=!1,t=0;t<this._iManipulables.length;++t){if(this._iManipulables[t].isManipulated()){e=!0;break}}return e},createHandle:function(e,t){var i,n={parentOwner:e,id:t.id,manipulator:t.manipulator,interactor:t};t.data&&"number"==typeof t.data.anchorID?e.QueryInterface("VCXIModifiable").GetAnchorValue(t.data.anchorID)&&(i=new c(n)):i=t.manipulatorType&&t.manipulatorType===d.EManipulatorType.ArrowHandle?new p(n):new h(n);return i},_computeRequestedMatrix:function(e){var t=e.manipulator;let i=e.manipulator.interactor;var n=new _.Matrix4;function a(e){if(e.intersection.ray&&e.viewer&&e.viewer.currentViewpoint){t._lastValidPosition||(t._lastValidPosition=(new _.Vector3).getPositionFromMatrix(i.matrixToUse));var a=(new _.Plane).setFromNormalAndCoplanarPoint(e.viewer.currentViewpoint.getSightDirection(),t._lastValidPosition),r=e.intersection.ray.intersectPlane(a),s=null;s=e.manipulator._initNormal?e.manipulator._initNormal:e.viewer.currentViewpoint.getSightDirection().normalize().negate(),n=l.getMatrixFromOVz(r,s)}}switch(i.type){case d.EType.Screen:a(e);break;case d.EType.Pick:if(e.intersection.position&&e.intersection.path.length){t._lastValidPosition=e.intersection.position;var r=e.intersection.normal.clone().normalize();n=l.getMatrixFromOVzVx(e.intersection.position,r,l.getVxFromMatrix(i.initialMatrix))}else a(e);break;case d.EType.LineTranslation:case d.EType.PlaneTranslation:if(e.translationVector){n=i.initialMatrix.clone();var s=l.getOFromMatrix(i.initialMatrix);s.add(e.translationVector),n.setPosition(s)}break;case d.EType.Rotation:e.rotationMatrix&&((n=i.initialMatrix.clone()).setPosition((new _.Vector3).subVectors(l.getOFromMatrix(n),e.center)),(n=(new _.Matrix4).multiplyMatrices(e.rotationMatrix,n)).setPosition((new _.Vector3).addVectors(l.getOFromMatrix(n),e.center)));break;default:r=e.intersection.normal.clone().normalize();n=l.getMatrixFromOVzVx(e.intersection.position,r,l.getVxFromMatrix(i.initialMatrix))}return n},_changePropertiesFromPropSet:function(e,t){var i=e.GetHashing(),n=new g;n.AddOrModifyPropertySet(i,t);var a=new o(this._experienceBase.getManager("VCXScenarioManager"),this._experienceBase.getManager("VCXCommandManager"));a.ChangePropertiesFromMap(n),this._experienceBase.getManager("VCXCommandManager").Push(a)},refreshHandlesVisAndPositions:function(e){var t=e.GetObject(),i=e.getAllInteractors(),n=!0,a=e.QueryInterface("VCXIVisibility");a&&(n=a.GetVisibility());var r=this.getActiveManipulables().includes(e)&&n;for(var s in i)if(i.hasOwnProperty(s)){let e=i[s];if(e.handle){var o=e.handle;this._manipulationInProgress?o.isDisplayed()&&o.Hide(!0):r&&this.bManipulationsAllowed&&e.active&&!this._allInteractorShouldBeHidden?!o.isDisplayed()&&o.Show():o.isDisplayed()&&o.Hide(!0),o.isDisplayed()&&o.setMatrix(e.handleMatrix)}this.bManipulationsAllowed||this.unsubscribeInteractor(t,e,!0)}},refreshHandlesFromComponentList:function(e){if(Array.isArray(e))for(var t=0;t<e.length;++t){(n=(i=e[t])&&i.QueryInterface("VCXIManipulable"))&&this.refreshHandlesVisAndPositions(n)}else{if(!this._iManipulables)return;for(t=0;t<this._iManipulables.length;t++){var i,n;(n=(i=this._iManipulables[t])&&i.QueryInterface("VCXIManipulable"))&&this.refreshHandlesVisAndPositions(n)}}},getActiveManipulables:function(){if(this._activeManipulables)return this._activeManipulables;for(var e=[],t=[],i=this._experienceBase.getManager("VCXSelectionManager"),n=i.GetComponentsFromSelection("CSO"),a=[],r=0;r<n.length;++r){if(M=n[r].QueryInterface("VCXIManipulable")){var s=this._experienceBase.getManager("VCXContextManager").getMainViewer();M.updateInteractors({viewer:s,viewpoint:s.currentViewpoint});var o=M.getAllInteractors();for(var l in o)if(o.hasOwnProperty(l)){let t=o[l];if(t.handleInfos&&t.handleInfos.stayVisible){e.push(M);break}}a.push(M)}}if(a.length>1){var u=!0;if(this._lastManipulablesSelected&&this._lastManipulablesSelected.length>1&&a.length===this._lastManipulablesSelected.length)for(var c=0;c<a.length;++c){var h=a[c];if(!this._lastManipulablesSelected.indexOf(h)){u=!1;break}}else u=!1;if(u)t=this._lastReturnedList.slice();else{if(this._disabledInteractors){for(var p=Object.keys(this._disabledInteractors),d=0;d<p.length;++d){var g=p[d];(h=(I=this._experienceBase.ComponentsMap.GetComponentFromID(g))&&I.QueryInterface("VCXIManipulable"))&&h.enableInteractors(this._disabledInteractors[g])}this._disabledInteractors={}}for(var _=[],m=!0,f=0;f<a.length;++f){var M;o=(M=a[f]).getActiveInteractors(),Object.keys(o);if(m){for(var l in o)if(o.hasOwnProperty(l)){o[l].enableMultiSelect&&_.push(l)}m=!1}else for(var C=0;C<_.length;++C){var b=_[C];if(!b)continue;let e=o[b];e&&e.enableMultiSelect||(_[C]=null)}}if(0!==(_=_.filter(e=>Boolean(e))).length)for(f=0;f<a.length;++f){var v=(h=a[f]).getActiveInteractors(),V=Object.keys(v),x=V.slice();for(C=0;C<_.length;++C){var y=_[C],P=V.indexOf(y);P>=0&&(x[P]=null)}g=h.GetObject().GetID();this._disabledInteractors||(this._disabledInteractors={}),this._disabledInteractors[g]||(this._disabledInteractors[g]=[]),this._disabledInteractors[g]=x.filter(e=>Boolean(e)),h.disableInteractors(this._disabledInteractors[g]),V.length!==this._disabledInteractors[g].length&&t.push(h)}}}else{if(this._disabledInteractors)for(p=Object.keys(this._disabledInteractors),d=0;d<p.length;++d){g=p[d];(h=(I=this._experienceBase.ComponentsMap.GetComponentFromID(g))&&I.QueryInterface("VCXIManipulable"))&&h.enableInteractors(this._disabledInteractors[g])}if(this._disabledInteractors={},0===a.length){var w=i.GetComponentsFromSelection("PSO"),S=[];for(r=0;r<w.length;++r){var I;(h=(I=w[r]).QueryInterface("VCXIManipulable"))&&S.push(h)}t=1===S.length&&S[0]&&S[0].isActive()?[S[0]]:[]}else 1===a.length&&a[0]&&a[0].isActive()&&(t=[a[0]])}this._lastManipulablesSelected=a.slice(),this._lastReturnedList=t.slice();for(var R=0;R<e.length;++R){var D=e[R];t.indexOf(D)>=0&&(e[R]=null)}return e=e.filter(e=>Boolean(e)),this._activeManipulables=e.concat(t),this._activeManipulables},updateActiveInteractorsAndHandles:function(e){var t=this.getActiveManipulables();if(t)for(var i=0;i<t.length;i++)t[i].updateInteractors(e),this.refreshHandlesVisAndPositions(t[i])},preRender:function(e){e&&e.viewer&&e.viewer._isDigger||this.updateActiveInteractorsAndHandles(e)},getUpdatePriority:function(){return-6},update:function(e){if(this._parent(e),this.bManipulationsAllowed&&Array.isArray(this._iManipulables)&&this._iManipulables.length>0)for(var t=0;t<this._iManipulables.length;t++){var i=this._iManipulables[t];i.isManipulated()||(this.getActiveManipulables().includes(i)?this.updateManipulatorsOfManipulable(i,e):i._active&&this.disableManipulable(i))}},postRender:function(e){this._parent(e)},setManipulatorsRequirements:function(e){e&&("boolean"==typeof e.active&&(this._manipulatorsActive=e.active),"boolean"==typeof e.preActive&&(this._manipulatorsPreactive=e.preActive))},getManipulatorsRequirements:function(){return{activated:this._manipulatorsActive,preActivate:this._manipulatorsPreactive}},_manageCursorPreactivate:function(e,t){var i=e&&e.cursorPreactivate;return"function"==typeof i?i(e,t):"string"==typeof e.cursorPreactivate?e.cursorPreactivate:"grab"},_beginPreactivateCB:function(e){var t=this._experienceBase.getManager("VCXGUIManager");return i=>{let n=i.manipulator.interactor;n&&n.handle&&(n.handle.preactivated=!0);var a=this._manageCursorPreactivate(n,i);this._manipulationInProgress||t.SetCursor(a),e.interact(i)}},_preactivateCB:function(e){var t=this._experienceBase.getManager("VCXGUIManager");return i=>{this.manipulatorPreActivated=!0;let n=i.manipulator.interactor;var a=this._manageCursorPreactivate(n,i);this._manipulationInProgress||t.SetCursor(a);i.intersection.position;e.interact(i)}},_endPreactivateCB:function(e){var t=this._experienceBase.getManager("VCXGUIManager");return i=>{let n=i.manipulator.interactor;n&&n.handle&&(n.handle.preactivated=!1),this._manipulationInProgress||t.SetCursor("default"),e.interact(i),this.manipulatorPreActivated=!1}},_onManipulate:function(e,t){let i=t.manipulator.interactor;this._picker||(this._picker=new f(this._experienceBase)),this._picker.setCurrentComponent(e.GetObject());var n=this._experienceBase.getManager("VCXContextManager"),a=t&&t.event&&t.event.from&&t.event.from.length?t.event.from[0].event:{},r=this._picker.pick(n.getMainViewer(),a,i.id,t);(r.pickInfo.magnet||i.handle)&&(t.intersection.position=r.pickInfo.globalPosition.clone(),t.intersection.normal=r.pickInfo.globalNormal.clone(),t.intersection.path=[],r.pickInfo.pathElement&&(t.intersection.path[0]=r.pickInfo.pathElement.clone())),r.mouse&&(r.mouse.snapX||r.mouse.snapY)&&(t.intersection.ray=n.getMainViewer().currentViewpoint.create3DRayFrom2DPoint(new _.Vector2(r.mouse.xPix,r.mouse.yPix))),i.requestedMatrix=this._computeRequestedMatrix(t),t.requestedMatrix=i.requestedMatrix;var s=this.getActiveManipulables();s.includes(e)||s.push(e);for(var o=0;o<s.length;o++){var l=s[o];if(l)if(l.interact(t),i.requestedMatrix&&(i.requestedMatrix=null),i.requestedPropertyMap){var u=this._experienceBase.getManager("VCXScenarioManager");for(var c in i.requestedPropertyMap._map)if(i.requestedPropertyMap._map.hasOwnProperty(c)){var h=u.ModifiableServer.GetModifiableFromHashing(c),p=i.requestedPropertyMap.GetPropertySet(c);this._changePropertiesFromPropSet(h,p)}i.requestedPropertyMap=null}else if(i.requestedPropertySet){var d=l.QueryInterface("VCXIModifiable");this._changePropertiesFromPropSet(d,i.requestedPropertySet),i.requestedPropertySet=null}}},_beginManipulateCB:function(t){return i=>{this._experienceBase.getManager("VCXContextualContentManager")&&this._experienceBase.getManager("VCXContextualContentManager").contextualShortcutToolbarCtrl&&this._experienceBase.getManager("VCXContextualContentManager").contextualShortcutToolbarCtrl.hideContextualBar();var n=this._experienceBase.getManager("VCXDressupManager");n&&n.changeDressupsPickability(!1);var a=t.getActiveInteractors();for(var r in a)if(a.hasOwnProperty(r)){let e=a[r];e.initialMatrix=e.matrixToUse}t.setManipulated(!0),t.changePickability(!1),this._manipulationInProgress=!0;var s=this._experienceBase.getManager("VCXContextManager").getMainViewer();s.setPrePicking({activated:!1}),console.log("=====> desactivate picking"),this.refreshHandlesVisAndPositions(t),s.currentViewpoint.control._oldCursor="default";let o=i.manipulator.interactor;var u=o&&o.cursorManipulate||"grabbing";o&&o.setManipulated(!0);var c=this._experienceBase.getManager("VCXGUIManager");c&&c.SetCursor(u);var h=0,p=o&&o.id.split("Anchor.")[1];p&&(h=parseInt(p));var d=t.QueryInterface("VCXIModifiable"),g=d&&d.GetAnchorWorldMatrix(h,{viewer:s,viewpoint:s.currentViewpoint});g&&(i.manipulator._initNormal=l.getVzFromMatrix(g),i.manipulator._initPosition=l.getOFromMatrix(g)),e.publish({event:"VCX_INTERACTOR_BEGIN_MANIPULATE",data:{interactor:o,attachedOccurrences:d.GetAttachedOccurences&&d.GetAttachedOccurences(),attachedOccurrence:d.GetAttachedOccurence&&d.GetAttachedOccurence(h)}}),this._onManipulate(t,i),i.ignoreTransaction||this._experienceBase.getManager("VCXCommandManager").StartTransaction()}},_manipulateCB:function(e){return t=>{let i=t.manipulator.interactor;var n=i&&i.cursorManipulate||"grabbing",a=this._experienceBase.getManager("VCXGUIManager");a&&a.SetCursor(n),this._onManipulate(e,t)}},_endManipulateCB:function(t){return i=>{if(t.setManipulated(!1),t.changePickability(!0),this._manipulationInProgress=this.checkManipulationInProgress(),this._onManipulate(t,i),i.ignoreTransaction||this._experienceBase.getManager("VCXCommandManager").EndTransaction(),!this._manipulationInProgress){var n=this._experienceBase.getManager("VCXContextManager").getMainViewer();n&&n.setPrePicking({activated:!0}),console.log("====> Set highlight"),this.refreshHandlesVisAndPositions(t)}this._experienceBase.getManager("VCXGUIManager").SetCursor("default");var a=this._experienceBase.getManager("VCXCanonicsManager");a&&(a.clear(),this._picker=null),i.manipulator._initNormal&&(delete i.manipulator._initNormal,delete i.manipulator._initPosition);var r=t.getActiveInteractors();for(var s in r)if(r.hasOwnProperty(s)){let e=r[s];delete e.initialMatrix,e&&e.setManipulated(!1)}var o=this._experienceBase.getManager("VCXDressupManager");o&&o.changeDressupsPickability(!0),e.publish({event:"VCX_INTERACTOR_END_MANIPULATE"})}},_primPointerClickCB:function(t){return i=>{let n=i.manipulator.interactor;if(t.interact(i),n.requestedMatrix&&(n.requestedMatrix=null),n.requestedPropertySet){var a=t.QueryInterface("VCXIModifiable");this._changePropertiesFromPropSet(a,n.requestedPropertySet),n.requestedPropertySet=null}e.publish({event:"VCX_INTERACTOR_END_MANIPULATE"})}},_primPointerDblClickCB:function(e){return t=>{e.interact(t)}},_testMagnetLine:function(e,t){var i=t.QueryInterface("VCXIModifiable"),n=i.QueryInterface("VCXIMagnetLine");if(null===n)return;if(!n.isMagnetizable())return;for(var a=this._experienceBase.ComponentsMap.GetComponentFromType("VCXMagnetLine_Spec"),r=[],s=0;s<a.length;s++){const e=a[s];if(e){const t=e.QueryInterface("VCXIVisibility");if(t&&t.GetVisibility()){const t=e.QueryInterface("VCXIModifiable");t&&r.push(t)}}}if(0===r.length)return;const o=this._experienceBase.getManager("VCXPaperManager");var u=o.ModelToMM2({viewer:e.viewer,viewpoint:e.viewer.currentViewpoint},l.getOFromMatrix(e.manipulator.interactor.requestedMatrix)),c=new _.Vector2(u.x,u.y);for(s=0;s<r.length;s++){const t=r[s];if(t.isOnMagnetLine(c)){var h=t.getNewProposalMagnetPositionIn2D(i,c),p=o.MMToModel2(e,h);if(e.translationVector){var d=e.manipulator.initial3dIntersectionPoint.clone();e.translationVector.subVectors(p,d)}t.addModifiableAttached(i);break}t.removeModifiableAttached(i)}},getVersion:function(){return"3.1.3"}});return Object.defineProperty(M.prototype,"componentType",{enumerable:!0,get:function(){return"VCXManipulatorManager"}}),Object.defineProperty(M.prototype,"bManipulationsAllowed",{enumerable:!0,get:function(){if(this._allInteractorShouldBeHidden)return!1;var e=this._experienceBase.getManager("VCXContextManager");e&&e.getContext();return this._manipulatorsActive},set:function(){}}),M});