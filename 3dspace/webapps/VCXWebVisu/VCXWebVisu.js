define("DS/VCXWebVisu/VCXModifiablesAccess",["DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement"],function(e,t){"use strict";var r={getBestIdxElementCandidate:function(e){for(var t=e.length-1;t>0;t--)if(e[t].productType||e[t].worktype||e[t].userData&&e[t].userData.type){if(e[t].productType&&("Instance3D"===e[t].productType||"VPMInstance"===e[t].productType)||e[t].worktype&&"VPMInstance"===e[t].worktype||e[t].userData&&"VPMInstance"===e[t].userData.type)return t+1}else if(e[t]._isDressupNode)return t+1},CleanPathElement:function(e){var t=[];if(e){for(var i=[],n=(t=e.externalPath).length,a=0;a<n;a++)i[a]=t[a];var o=r.getBestIdxElementCandidate(i);return null!==o&&o<i.length&&i.splice(o,i.length-o),i}console.log("Missing pathElement !")},BuildCleanedPathElement:function(e){return new t(r.CleanPathElement(e))},getProductFromPathElement:function(e,r){let i=0;const n=new t;for(;i<e.externalPath.length;){n.addElement(e.getElement(i));const t=r.ComponentsMap.GetComponentFromPathElement(n);if(t&&"CXPExperience_Spec"!==t.GetType())return t;i++}},getModifiableFromPathElement:async function(e,t,i,n){let a;if(n&&!(a=r.GetModifiableFromPathElement(e,t,!0))){const r=t.getManager("VCXCAT3DXModelManager"),i=this.getProductFromPathElement(e,t),n=r&&await r.createComponentFromPathElement(e,i);return a=n&&n.QueryInterface("VCXIModifiable")}return r.GetModifiableFromPathElement(e,t,i)},GetModifiableFromPathElement:function(e,t,i){if(!e||!e.externalPath||!e.externalPath.length)return null;var n,a;if(e.externalPath[0].handle)n=e.externalPath[0].handle&&e.externalPath[0].handle.manipulator&&e.externalPath[0].handle.manipulator.interactor&&e.externalPath[0].handle.manipulator.interactor.component;else if(e.getLastElement(!0).magnet){var o=e.getLastElement(!0).magnet;n=o&&o.measurable&&o.measurable.getHolder()&&o.measurable.getHolder().GetObject()}else{var l=r.BuildCleanedPathElement(e);if(n=t.ComponentsMap.GetComponentFromPathElement(l),!i)for(;!n&&l&&l.externalPath&&l.externalPath.length;)l.externalPath.pop(),n=t.ComponentsMap.GetComponentFromPathElement(l)}if(!(a=n&&n.QueryInterface("VCXIModifiable"))){var s=t.getManager("VCXContextManager");s&&s.getUrlVars().debug&&console.log("Can't find modifiable associated to path: ",e)}return a},GetLinkedParentLevelFromPropertyValue(e,t,r){let i=null,n=e.match(/([^$]|^)\$\(([0-9a-z.|_-\s]*)#([0-9]*)#([0-9a-z._-]*)\)/i);if(!(n&&Array.isArray(n)&&n.length>3))return i=r.ComponentsMap.GetComponentFromID(t);let a=parseInt(n[3]),o=r.ComponentsMap.GetComponentFromID(t);if(o){for(;a>0;){let e=o.QueryInterface("VCXIModelNavigable").getParent().GetObject();e?o=e:console.log("/! GetLinkedParentLevelFromPropertyValue: bad parent level"),a--}i=o}return i},ValuateLinkedProperties:function(e,t,i,n,a){var o=e;let l=e;for(var s="",c=/([^$]|^)\$\(([0-9a-z.|_-\s]*)#([0-9]*)#([0-9a-z._-]*)\)/i,p=o.match(c);p;){var u=p[0],d=p.index,f=u.length;d>0&&(s+=o.substring(0,d+1)),s+=p[1];var g=p[2];""===g&&(g=i),""!==g&&"0"!==g||(g=n);var m=parseInt(p[3]),h=p[4],P=t.ComponentsMap.GetComponentFromID(g);if(P){for(;m>0;){var v=P.QueryInterface("VCXIModelNavigable").getParent().GetObject();v?P=v:console.log("/! ValuateLinkedProperties: bad parent level"),m--}var b=P.QueryInterface("VCXIModifiable");if(b){var y=b.GetProperty(h);if(y){var C="";C=a?a(y,t):y.GetPropertyValue().ToString(),s+=C=r.ValuateLinkedProperties(C,t,g,n,a)}}}for(o=o.substring(d+f);o&&"\n"===o[0];)o=o.substring(1),s+="\n";p=o.match(c)}return"$(##Actor.PartList.ID)"===l&&""===s?s="Id":s+=o,s},GetPathElementFromEvent:function(e,t){var r=t.getManager("VCXContextManager").getMainViewer();if(!r.div)return null;var i=r.getMousePosition(e.from[0].getCurrentPosition(r.div)),n=r.pick(i,"mesh",!1),a=null;return n&&n.path&&n.path.length>0&&(a=n.path[0].clone()),a},GetModifiableFromEvent:function(e,t){var i=r.GetPathElementFromEvent(e,t);return i&&r.GetModifiableFromPathElement(i,t)}};return r}),define("DS/VCXWebVisu/VCXVisuBuffers",["require","exports","DS/Visualization/ThreeJS_DS"],function(e,t,r){"use strict";class i{constructor({iCount:e,i0:t,isIndexed:r,bufferIndex:i,bufferVertex:n,bufferNormals:a,geometry:o}){this.iCount=e,this.i0=t,this.isIndexed=r,this.bufferIndex=i,this.bufferVertex=n,this.bufferNormals=a,this.geometry=o}static fromPrim(e){const t=e.getGroup(),r=t.geometry;return new i({iCount:e.getCount(),i0:e.getStart(),isIndexed:!t.nonIndexed,bufferIndex:r.vertexIndexArray,bufferVertex:r.vertexPositionArray,bufferNormals:r.vertexNormalArray,geometry:r})}getTriangle(e){if(this.bufferIndex.length<e+3)return{triangle:null,nextIndex:e};const t={index:(e-this.i0)/3,buffers:this,points:[]};for(let r=0;r<3;r++){const i=e+r;t.points.push({index:this.isIndexed?this.bufferIndex[i]:i})}return{triangle:t,nextIndex:e+3}}getTriangles(e,t){if(this.iCount<e-this.i0+3*t||this.bufferIndex.length<e+3*t)return{triangles:null,nextIndex:e};const r=[];for(let i=0;i<t;i++){const t=this.getTriangle(e);t.triangle&&(r.push(t.triangle),e=t.nextIndex)}return{triangles:r,nextIndex:e}}fillRays(e){e&&e.forEach(e=>{e.ray||(e.ray=new r.Ray,this.geometry.getVertexPosition(e.index,e.ray.origin),this.geometry.getVertexNormal(e.index,e.ray.direction),e.ray.direction.normalize())})}}return i}),define("DS/VCXWebVisu/VCXVisuTools",["require","exports","DS/VCXWebVisu/VCXModifiablesAccess","DS/Visualization/SceneGraphUtils","DS/VCXWebVisu/VCXVisuBuffers","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,r,i,n,a,o){"use strict";return class{static buildGraphicPropertiesStructure(e,t,r){var n,o=r&&(r.getColor||r.getAll),l=r&&(r.getOpacity||r.getAll),s=r&&(r.getMaterial||r.getAll||o||l),c=r&&(r.getWorldPosition||r.getAll),p=r&&(r.getVisibility||r.getAll),u=r&&(r.getRenderStyle||r.getAll);const d=[];for(var f=e,g=0;f;){g++;const r={};r.object=f;var m=f.QueryInterface("W3AISGNodeHolder").getPathElement();if(m){if(r.pathElement=m,1===g){if(r.cad={},s||o||l){const n=i.getCurrentGraphicProperties({pathElement:m,getMaterial:s,getColor:o,getOpacity:l});if(n&&n.length>0&&(s&&(r.cad.Material=n[0].material),o&&(r.cad.Color=n[0].color),l&&(r.cad.Opacity=n[0].opacity),c)){const i=t||e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer();r.cad.WorldPosition=m.getWorldMatrix(i)}}p&&(r.cad.Visibility=i.getCurrentVisibility(m))}var h=f.getSharedSceneGraphOverride&&f.getSharedSceneGraphOverride();if(h){var P={},v=!1;s&&null!=h.getMaterial()&&(v=!0,P.Material=h.getMaterial(),P.Material.isMatApp&&(P.Material=P.Material._material)),o&&null!=h.getColor()&&(v=!0,P.Color=new a.Color(h.getColor())),l&&null!=h.getOpacity()&&(v=!0,P.Opacity=h.getOpacity()),p&&null!=h.getVisibility()&&(v=!0,P.Visibility=h.getVisibility()),u&&null!=h.getRenderStyle()&&(v=!0,P.RenderStyle=h.getRenderStyle()),v&&(r.override=P)}}d.push(r),f=f.QueryInterface("VCXIModelNavigable")&&f.QueryInterface("VCXIModelNavigable").getParent()&&f.QueryInterface("VCXIModelNavigable").getParent().GetObject()}const b=d[0];b.visible={},b.cad?(s&&b.cad.hasOwnProperty("Material")&&(b.visible.Material=b.cad.Material),o&&(null===(n=b.cad)||void 0===n?void 0:n.hasOwnProperty("Color"))&&(b.visible.Color=b.cad.Color),l&&b.cad.hasOwnProperty("Opacity")&&(b.visible.Opacity=b.cad.Opacity),p&&b.cad.hasOwnProperty("Visibility")&&(b.visible.Visibility=b.cad.Visibility)):(s&&(b.visible.Material=null),o&&(b.visible.Color=new a.Color),l&&(b.visible.Opacity=1),p&&(b.visible.Visibility=!0),u&&(b.visible.RenderStyle=0));for(var y=0;y<d.length;y++){const e=d[y];e.override&&(s&&e.override.hasOwnProperty("Material")&&(b.visible.Material=e.override.Material),o&&e.override.hasOwnProperty("Color")&&(b.visible.Color=e.override.Color),l&&e.override.hasOwnProperty("Opacity")&&(b.visible.Opacity=e.override.Opacity),u&&e.override.hasOwnProperty("RenderStyle")&&(b.visible.RenderStyle=e.override.RenderStyle))}if(p){const r=t||e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer();b.visible.Visibility=r.getSceneGraphOverrideSetManager().getCurrentVisibility(b.pathElement)}if(l){var C=b.visible&&b.visible.Material,x=1;C&&(x=C.getOpacity()),b.visible.ComputedOpacity=x*(b.visible.hasOwnProperty("Opacity")?b.visible.Opacity:1)}return o&&(b.visible.hasOwnProperty("Material")&&b.visible.Material&&b.visible.Material.color?b.visible.ComputedColor=b.visible.Material.color:b.visible.hasOwnProperty("Color")&&(b.visible.ComputedColor=b.visible.Color)),d}static traverseComponentNodes(e,t){let i=e.QueryInterface("W3AISGNodeHolder"),n=i&&i.getPathElement(),a=e=>{let i=e.getChildrenPathes();i&&i.every(e=>{if(r.getBestIdxElementCandidate(e.externalPath)<e.externalPath.length){let r=t&&t(e);return r&&a(e),r}})},o=t&&t(n);return o&&a(n),o}static traverseAll(e,t){let i,a=[],l=0,s=c=>{let p={object:c,index:l,parentObject:null},u=!0;if(t.filterPathElement&&(u=t.filterPathElement(p)),u&&(t.processPathElement&&a.push(t.processPathElement(p)),t.processGeometry||t.processPrimitiveGroup||t.processPrimitive||t.processBuffers||t.processTriangle)){var d=c&&c.getLastElement();const l=d.mesh3js&&d.mesh3js.geometry;var f;(f=l&&!l.forEach?[l]:l)&&f.every((e,r)=>{let l={object:e,index:r,parentObject:p},s=!0;if(e.vertexIndexArray?t.filterGeometry&&(s=t.filterGeometry(l)):s=!1,s&&(t.processGeometry&&a.push(t.processGeometry(l)),t.processPrimitiveGroup||t.processPrimitive||t.processBuffers||t.processTriangle)){let r=e.drawingGroups;r&&r.every((e,r)=>{let s={object:e,index:r,parentObject:l},c=!0;if(t.filterPrimitiveGroup&&(c=t.filterPrimitiveGroup(s)),c&&(t.processPrimitiveGroup&&a.push(t.processPrimitiveGroup(s)),t.processPrimitive||t.processBuffers||t.processTriangle)){let r=!0;const l=e.getPrimitivesCount();for(let c=0;c<l&&r;++c){const l=new o.SGPrimitiveHelper;l.set(e,c);var p=THREEDS.SubElement.getFromSGNode(l);let u=i.clone();u.addElement(p);let d={object:l,index:c,parentObject:s,pathElement:u},f=!0;if(t.filterPrimitive&&(f=t.filterPrimitive(d)),f&&(t.processPrimitive&&a.push(t.processPrimitive(d)),t.processBuffers||t.processTriangle)){let r=n.fromPrim(l),i={object:r,index:0,parentObject:d},o=!0;if(r&&t.filterBuffers&&(o=t.filterBuffers(i)),r&&o&&(t.processBuffers&&a.push(t.processBuffers(i)),t.processTriangle)){let n=[],o=0,l=!0;for(let s=r.i0;s<r.i0+r.iCount&&l;4===e.glType?s+=3:s++){let e={index:o,buffers:r,points:[]};for(let t=0;t<3;t++){let i=s+t;n[i]||(n[i]={index:r.isIndexed?r.bufferIndex[i]:i}),e.points.push(n[i])}let c={object:e,index:o,parentObject:i};o++,t.processTriangle&&a.push(t.processTriangle(c)),t.postProcessTriangle&&(l=t.postProcessTriangle(c))}}r&&t.postProcessBuffers&&t.postProcessBuffers(i)}t.postProcessPrimitive&&(r=t.postProcessPrimitive(d))}}let u=!0;return t.postProcessPrimitiveGroup&&(u=t.postProcessPrimitiveGroup(s)),u})}let c=!0;return t.postProcessGeometry&&(c=t.postProcessGeometry(l)),c});let u=c.getChildrenPathes();u&&u.every(t=>r.getBestIdxElementCandidate(t.externalPath)<t.externalPath.length?s(t):!!e.GetObject()._experienceBase.ComponentsMap.GetComponentFromPathElement(t)||s(t))}let g=!0;return t.postProcessPathElement&&(g=t.postProcessPathElement(p)),l++,g},c=e.QueryInterface("W3AISGNodeHolder");const p=widget.enopadViewer,u=p&&p.getController();if(u){const e=c.getPathOfIDs();i=u&&e&&u.buildPathFromArray(e.ids,!0)}else i=c&&c.getPathElement();return s(i),a}}});