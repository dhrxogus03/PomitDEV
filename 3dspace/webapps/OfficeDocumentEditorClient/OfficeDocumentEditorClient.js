define("DS/OfficeDocumentEditorClient/Utils",["UWA/Utils","UWA/Promise","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PlatformAPI/PlatformAPI","DS/WAFData/WAFData"],function(e,t,o,n,r){"use strict";const s={service:{},data:{}},i={ERROR:{NO_DOCUMENT_URL_PROVIDED:1e3,SERVICE_NOT_FOUND:1001,NO_ROOT_ELEM:1002,UNKNOWN:1003,PLATFORM_ID_NOT_GRANTED:1004,ODE_SERVICE_NOT_FOUND:1005,XHR:1006,XHR_TIMEOUT:1007,INVALID_SERVER_RESPONSE:1008,FILE_FORMAT_NOT_SUPPORTED:1009,X3DPLAY_NOT_SUPPORTED:1010},getErrorKey:e=>{let t="";return Object.keys(i.ERROR).forEach((o,n)=>{i.ERROR[o]===e&&(t=o)}),t},isErrorSupported:e=>""!==i.getErrorKey(e),DOCTYPE:{WORD:"word",SPREADSHEET:"spreadsheet",PRESENTATION:"presentation",UNKNOWN:"unknown"},getDocumentKindFromExt:(e,t)=>{let o=(e||"").toLowerCase();const n=(t||"").toLowerCase().split(".").pop();""===o&&(o=n);return["doc","docx","rtf"].indexOf(o)>-1?i.DOCTYPE.WORD:["xls","xlsx","csv"].indexOf(o)>-1?i.DOCTYPE.SPREADSHEET:["ppt","pptx"].indexOf(o)>-1?i.DOCTYPE.PRESENTATION:i.DOCTYPE.UNKNOWN},getBackendInfo:o=>{const n=e.parseUrl(o);return n.path="/api/info",new t(function(t,o){const i="getBackendInfo";s.data[i]&&s.data[i].expiration<Date.now()?t(s.data[i].data):r.handleRequest(e.composeUrl(n),{method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(e,n)=>{if(!e||!e.service_name)return void o(new Error("unexpected response"));if(e.error)return void o(new Error(JSON.stringify(e.error)));const r=e.version.split("_")[0].split("."),a={major:r[0],minor:r[1],patch:r[2]},l=Object.assign({},e,{version_number:a});s.data[i]={data:l,expiration:Date.now()+6e5},t(l)},onFailure:o,onTimeout:o,authentication:"passport"})})},isInMobileApp:()=>!(!window.ds||"MOBILE"!==window.ds.env),isDeviceSupportedForEditingDoc:(e,t)=>{if(e)return!1;if(window.ds&&"MOBILE"===window.ds.env)return!1;const o="ontouchstart"in window||window.navigator.msMaxTouchPoints||!1,n=window.navigator.pointerEnabled||!1;return!/(mobi|ipod|phone|blackberry|opera mini|fennec|minimo|symbian|psp|nintendo ds|archos|skyfire|puffin|blazer|bolt|gobrowser|iris|maemo|semc|teashark|uzard)/.test(window.navigator.userAgent.toLowerCase())&&!(o&&!n&&t===i.DOCTYPE.WORD)},is404Error:e=>!!(e&&e.message&&e.message.indexOf("404")>-1),isDfcsUrl:e=>{let t=!1;try{const o=new URL(e);/^.*-dfcs\./.test(o.hostname)&&(t=!0)}catch(e){}return t},getServiceUrl:(n,r)=>{const a=`${n}_${r}`.toLowerCase();return new t(function(t,l){s.service[a]?t(s.service[a]):o.getPlatformServices({onComplete:function(o){const p=[];o.forEach(function(e){for(const t in e)t===r&&p.push({platformId:e.platformId,url:e[t]})});let c="";if(n){const t=p.filter(e=>(e.platformId||"").toLowerCase()===(n||"").toLowerCase());if(t.length>0){const o=e.parseUrl(t[0].url);o.path="/",o.query="",c=e.composeUrl(o)}}c?(s.service[a]=c,t(c)):l(i.ERROR.SERVICE_NOT_FOUND)},onFailure:()=>{l(i.ERROR.UNKNOWN)}})})},getOfficeDocumentEditorServiceUrl:e=>new t(function(t,o){i.getServiceUrl(e,"officedocumenteditor").then(e=>{let r=e;const s=n.getApplicationConfiguration("app.ode.url");s&&(r=s),r?t(r):o(i.ERROR.ODE_SERVICE_NOT_FOUND)}).catch(e=>{const r=n.getApplicationConfiguration("app.ode.url");r?t(r):o(e)})})};return i}),define("DS/OfficeDocumentEditorClient/Editor",["UWA/Core","UWA/Utils","UWA/Promise","DS/OfficeDocumentEditorClient/Utils","DS/WAFData/WAFData","DS/3DPlaySupport/AssetSupport","DS/3DPlayHelper/3DPlayHelper","DS/UIKIT/Spinner","DS/Usage/TrackerAPI","UWA/Data"],function(e,t,o,n,r,s,i,a,l,p){"use strict";const c={},E="ode-view-container-"+t.getUUID(),d="ode-3dplayer-view-container-"+t.getUUID(),u="ode-spinner-"+t.getUUID();let O;const m=[],D={};function f(){return this instanceof f?(this.session=this.generateNewSession(),this):new f}D.PREFIX="officedocumenteditor",D.CATEGORY={DOCUMENT:`${D.PREFIX}.document`},D.ACTION={OPEN:`${D.PREFIX}..open`,SAVE:`${D.PREFIX}..save`,CLOSE:`${D.PREFIX}..close`,GET_TEMPLATE:`${D.PREFIX}..get_template`},D.DIMENSIONS={TENANT:`${D.PREFIX}.tenant`,TEMPLATE:`${D.PREFIX}.template`,DOCUMENT_KIND:`${D.PREFIX}.documentKind`,OPEN_MODE:`${D.PREFIX}.openMode`,ERROR_KIND:`${D.PREFIX}.errorKind`,ERROR_VALUE:`${D.PREFIX}.errorValue`},D.DIMENSIONS_VAL={YES:"yes",NO:"no",PDF:"pdf",IMAGE:"image",EDITOR:"editor"},f.prototype.get=function(){return this.session},f.prototype.getNewSessionId=function(){return t.getUUID()},f.prototype.generateNewSession=function(){return{_id:this.getNewSessionId(),_startTime:Math.floor(Date.now()/1e3)}},f.prototype.getValue=function(e){return this.session[e]},f.prototype.setValue=function(e,t){this.session[e]=t},f.prototype.resetSession=function(){this.session=this.generateNewSession()};const R=new f,I=()=>{c.x3DPlayerInstance&&"function"==typeof c.x3DPlayerInstance.dispose&&(c.x3DPlayerInstance.dispose(),c.x3DPlayerInstance=null);const e=document.getElementById(d);e&&e.parentNode.removeChild(e)},N=e=>{e&&null!==e.elements&&e.destroy()},S={endpointUrl:"",url:"",key:"",platformId:"",spinner:null};return S.ERROR=Object.assign({},n.ERROR),S.setKey=((e,o)=>{if(S.key=e,!o)return;const n=document.getElementById(E);if(!n)return;if(!n.getElementsByTagName("iframe").length)return;const r=t.parseUrl(S.endpointUrl);r.path="",r.query="";const s=t.composeUrl(r);n.getElementsByTagName("iframe")[0].postMessage(JSON.stringify({kind:"ode.updateKey",key:e}),s)}),S.getKey=(()=>S.key),S.isGranted=(e=>(R.setValue(D.DIMENSIONS.TENANT,e.platformId),new o((s,i)=>{n.getOfficeDocumentEditorServiceUrl(e.platformId).then(a=>{((e,n)=>{const s=t.parseUrl(e);return s.path="/acl/get.json",s.query=`tenant=${n}`,new o((e,o)=>{r.handleRequest(t.composeUrl(s),{method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{t&&t.data?t.error?o(new Error(JSON.stringify(t.error))):(t.data.tenant||"").toLowerCase()===n.toLowerCase()?e(t):o(new Error("invalid response")):o(new Error("unexpected response"))},onFailure:o,onTimeout:o,authentication:"passport"})})})(a,e.platformId).then(()=>{s(!0)}).catch(e=>{n.is404Error(e)?s(!0):i(S.ERROR.PLATFORM_ID_NOT_GRANTED)})}).catch(()=>{i(S.ERROR.SERVICE_NOT_FOUND)})}))),S.isFileFormatSupported=(e=>new o((t,o)=>{const r=(e.format||"").toLowerCase().replace(".",""),s=n.getDocumentKindFromExt(r);s!==n.DOCTYPE.WORD&&s!==n.DOCTYPE.SPREADSHEET&&s!==n.DOCTYPE.PRESENTATION?o(new Error(S.ERROR.FILE_FORMAT_NOT_SUPPORTED)):t(!0)})),S.getDocumentTemplatesURL=(e=>(R.setValue(D.DIMENSIONS.TENANT,e.platformId),R.setValue(D.DIMENSIONS.TEMPLATE,D.DIMENSIONS_VAL.YES),new o((o,s)=>{n.getOfficeDocumentEditorServiceUrl(e.platformId).then(s=>{const i=()=>{const e=t.parseUrl(s);e.path="/resources/template.docx",e.query="v="+t.getUUID();const n=t.parseUrl(s);n.path="/resources/template.pptx",n.query="v="+t.getUUID();const r=t.parseUrl(s);r.path="/resources/template.xlsx",r.query="v="+t.getUUID(),o({docx:t.composeUrl(e),pptx:t.composeUrl(n),xlsx:t.composeUrl(r)})},a=t.parseUrl(s);a.path="/template/get.json";const l=[];l.push(`tenant=${t.encodeUrl(e.platformId)}`),a.query=l.join("&"),r.handleRequest(t.composeUrl(a),{timeout:8e3,responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:e=>{if(!e||!e.data||e.error)return void i();const t={};e.data.forEach(e=>{t[e.kind]=e.template_url,e.kind===n.DOCTYPE.WORD?t.docx=e.template_url:e.kind===n.DOCTYPE.SPREADSHEET?t.xlsx=e.template_url:e.kind===n.DOCTYPE.PRESENTATION&&(t.pptx=e.template_url)}),0!==Object.keys(t).length?(o(t),D.CATEGORY.DOCUMENT,D.ACTION.GET_TEMPLATE):i()},onFailure:i,onTimeout:i,authentication:"passport"})}).catch(e=>{let t=e;n.isErrorSupported(t)||(t=S.ERROR.SERVICE_NOT_FOUND),R.setValue(D.DIMENSIONS.ERROR_KIND,n.getErrorKey(t)),R.setValue(D.DIMENSIONS.ERROR_VALUE,e),D.CATEGORY.DOCUMENT,D.ACTION.GET_TEMPLATE,s(t)})}))),S.close=(()=>{D.CATEGORY.DOCUMENT,D.ACTION.CLOSE,R.resetSession(),m.forEach(e=>e()),m.splice(0,m.length),I();const e=document.getElementById(E);e&&e.parentNode.removeChild(e)}),S.init=S.open=(r=>{const l=Object.assign(r||{},{autoSaveDelayInSec:0});return R.setValue(D.DIMENSIONS.TENANT,l.platformId),R.setValue(D.DIMENSIONS.DOCUMENT_KIND,n.getDocumentKindFromExt(l.ext,l.url)),new o((r,f)=>{l.ext&&l.title&&l.title.substring(l.title.length-l.ext.length-1,l.title.length)!=="."+l.ext&&(l.title=l.title+"."+l.ext),l.url?l.rootElem?(I(),l.rootElem.empty(),l.rootElem.setStyles({display:"flex",justifyContent:"center",alignItems:"center"}),S.spinner=(e=>{const t=new a;return t.elements.container.setStyles({position:"absolute",zIndex:1}),t.elements.container.set("id",u),t.inject(e),t.show(),t})(l.rootElem),S.url=l.url,l.platformId&&(S.platformId=l.platformId),n.getOfficeDocumentEditorServiceUrl(l.platformId).then(e=>{const o=[];if(o.push(`url=${t.encodeUrl(l.url)}`),void 0!==l.title&&""!==l.title&&o.push(`title=${t.encodeUrl(l.title)}`),void 0!==l.ext&&""!==l.ext&&o.push(`ext=${t.encodeUrl(l.ext)}`),void 0!==l.docKeyToUse&&""!==l.docKeyToUse&&o.push(`docKeyToUse=${t.encodeUrl(l.docKeyToUse)}`),l.newDocument&&o.push("newDocument=true"),l.readOnly){o.push("readOnly=true");const e=n.getDocumentKindFromExt(l.ext,l.url);e===n.DOCTYPE.SPREADSHEET&&n.isDeviceSupportedForEditingDoc(l.isProxyEnabled,e)&&o.push("noPDF=true")}l.image&&(o.push("image=true"),l.imagePage&&o.push(`imagePage=${t.encodeUrl(l.imagePage)}`)),void 0!==l.platformId&&""!==l.platformId&&o.push(`platformId=${t.encodeUrl(l.platformId)}`),l.enableAutoSave&&o.push("enableAutoSave=true"),void 0!==l.saveOpts&&Object.keys(l.saveOpts).length>0&&o.push(`saveOpts=${t.encodeUrl(JSON.stringify(l.saveOpts))}`);const r=t.parseUrl(e);return r.path="/open",r.query=o.join("&"),S.endpointUrl=t.composeUrl(r),S.endpointUrl}).then(()=>(e=>{const t={provider:"FILE",filename:n.isInMobileApp()?p.proxifyUrl(e.endpointUrl,{proxy:"passport"}):e.endpointUrl,requestsOptions:{proxy:n.isInMobileApp()?"passport":"none",withCredentials:!0},format:"pdf",type:"pdf"},r=Object.assign({},t);e.playerConfig&&e.playerConfig.input&&e.playerConfig.input.asset&&Object.assign(r,{filename:e.url,requestsOptions:{proxy:"none"},format:e.ext,type:e.ext,tenant:e.platformId},e.playerConfig.input.asset),e.derivedFormatUrls&&e.derivedFormatUrls.pdf&&(r.filename=e.derivedFormatUrls.pdf,r.format="pdf",r.type="pdf");const i=(e,t)=>{s.checkSupport(e,{usage:"preview"},t)};return new o((o,s)=>{const a=n.getDocumentKindFromExt(e.ext,e.url);!e.readOnly||a===n.DOCTYPE.SPREADSHEET&&n.isDeviceSupportedForEditingDoc(e.isProxyEnabled,a)?o(null):i(r,e=>{e?o(r):(Object.assign(r,t),i(r,e=>{o(e?r:null)}))})})})(Object.assign({},l,{endpointUrl:S.endpointUrl,spinner:S.spinner}))).then(t=>{if(t)return(t=>{N(t.spinner),I(),t.rootElem.setStyles({display:"block"});const o=e.createElement("div",{id:d,styles:{height:"100%",width:"100%"}});o.inject(t.rootElem);const n=Object.assign({},t.playerConfig,{container:o});n.input=Object.assign(n.input||{},{asset:t.asset}),n.options=Object.assign(n.options||{},{loading:"autoplay"}),c.x3DPlayerInstance=new i(n),"function"==typeof t.on3DPlayerReady&&t.on3DPlayerReady(c.x3DPlayerInstance)})(Object.assign({},l,{asset:t,spinner:S.spinner})),r(!0),R.setValue(D.DIMENSIONS.OPEN_MODE,D.DIMENSIONS_VAL.PDF),l.image&&R.setValue(D.DIMENSIONS.OPEN_MODE,D.DIMENSIONS_VAL.IMAGE),D.CATEGORY.DOCUMENT,void D.ACTION.OPEN;(t=>{const o={frameborder:0,src:n.isInMobileApp()?p.proxifyUrl(t.url,{proxy:"passport"}):t.url,width:"100%",height:"100%",scrolling:!0,styles:{marginTop:"-36px",height:"calc(100% + 36px)"}},r=["allow-same-origin","allow-forms","allow-scripts","allow-popups"];n.isInMobileApp()||r.push("allow-downloads","allow-modals"),o.sandbox=r.join(" ");const s=e.createElement("iframe",o),i=e.createElement("div",{id:E,styles:{height:"100%",width:"100%",overflow:"hidden",border:"1px solid #dadada"}});s.inject(i),i.inject(t.rootElem);let a=!1;const l=e=>{if(!/(\.3ds\.com|\.3dexperience\.cn)$/.test(e.origin))return;let o;try{o=JSON.parse(e.data)}catch(e){return}switch(o.kind){case"iframe.ready":N(t.spinner);break;case"ode.onDocumentReady":a=!0,N(t.spinner),""!==o.key&&S.setKey(o.key,!1);break;case"ode.onDocumentStateChange":if(!t.autoSaveInput)return;if(!a)return;if(o.data)break;if(""===o.key)break;clearTimeout(O),O=setTimeout(()=>{const e=S.save(t.autoSaveInput);"function"==typeof t.onAutoSaveComplete&&e.then(e=>t.onAutoSaveComplete(null,e)).catch(e=>t.onAutoSaveComplete(e,null))},1e3+1e3*t.autoSaveDelayInSec)}};window.addEventListener("message",l),window.onbeforeunload=(e=>{window.removeEventListener("message",l)}),m.push(()=>{window.removeEventListener("message",l)})})(Object.assign({},l,{url:S.endpointUrl,spinner:S.spinner})),r(!0),R.setValue(D.DIMENSIONS.OPEN_MODE,D.DIMENSIONS_VAL.EDITOR),l.image&&R.setValue(D.DIMENSIONS.OPEN_MODE,D.DIMENSIONS_VAL.IMAGE),D.CATEGORY.DOCUMENT,D.ACTION.OPEN}).catch(e=>{N(S.spinner);let t=e;n.isErrorSupported(t)||(t=S.ERROR.UNKNOWN),f(t),R.setValue(D.DIMENSIONS.ERROR_KIND,n.getErrorKey(t)),R.setValue(D.DIMENSIONS.ERROR_VALUE,e),D.CATEGORY.DOCUMENT,D.ACTION.OPEN})):f(S.ERROR.NO_ROOT_ELEM):f(S.ERROR.NO_DOCUMENT_URL_PROVIDED)})}),S.save=(async e=>{const s=Object.assign(e||{},{}),i=await(()=>new o((e,t)=>{const o=new MessageChannel;o.port1.onmessage=(n=>{if(!n.data)return void t(new Error("unexpected response"));let r;try{r=JSON.parse(n.data)}catch(e){return}switch(r.kind){case"ode.docGetInfo":return o.port1.close(),void e(r.data)}t(new Error("unexpected response"))}),document.getElementById(E).getElementsByTagName("iframe")[0].contentWindow.postMessage({kind:"docGetInfo"},"*",[o.port2])}))(),a={key:s.key||S.key,url:S.url,callbackUrl:s.callbackUrl,params:s.params,headers:s.headers,filenameForUpload:s.filenameForUpload,firstCallUrl:s.firstCallUrl,hancomOpen:i.open,hancomUserSession:i.userSession||i.smb_index,hancomSmb:i.smb,hancomMode:i.mode||i.smb_app,hancomApp:i.smb_app},l=t.parseUrl(S.endpointUrl);l.path="/save",l.query="";const p=JSON.stringify(a);return new o((e,o)=>{r.handleRequest(t.composeUrl(l),{timeout:6e4,method:"POST",data:p,type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(t,r)=>{const s=document.getElementById(E).getElementsByTagName("iframe")[0];return s.focus(),s.contentWindow.postMessage({focusEditor:!0},"*"),t?t.error?(R.setValue(D.DIMENSIONS.ERROR_KIND,n.getErrorKey(S.ERROR.INVALID_SERVER_RESPONSE)),R.setValue(D.DIMENSIONS.ERROR_VALUE,t),D.CATEGORY.DOCUMENT,D.ACTION.SAVE,void o(new Error(JSON.stringify(t.error)))):(D.CATEGORY.DOCUMENT,D.ACTION.SAVE,void e(t)):(R.setValue(D.DIMENSIONS.ERROR_KIND,n.getErrorKey(S.ERROR.INVALID_SERVER_RESPONSE)),R.setValue(D.DIMENSIONS.ERROR_VALUE,t),D.CATEGORY.DOCUMENT,D.ACTION.SAVE,void o(new Error("unexpected response")))},onFailure:e=>{R.setValue(D.DIMENSIONS.ERROR_KIND,n.getErrorKey(S.ERROR.XHR)),R.setValue(D.DIMENSIONS.ERROR_VALUE,e),D.CATEGORY.DOCUMENT,D.ACTION.SAVE,o(e)},onTimeout:e=>{R.setValue(D.DIMENSIONS.ERROR_KIND,n.getErrorKey(S.ERROR.XHR_TIMEOUT)),R.setValue(D.DIMENSIONS.ERROR_VALUE,e),D.CATEGORY.DOCUMENT,D.ACTION.SAVE,o(e)},authentication:"passport"})})}),S.state=(e=>{const s=Object.assign(e||{},{}),i={key:s.key||S.key},a=(e,o,n)=>{const s=t.parseUrl(e);s.path="/state",s.query=Object.keys(i).map(e=>`${t.encodeUrl(e)}=${t.encodeUrl(i[e])}`).join("&"),r.handleRequest(t.composeUrl(s),{timeout:6e4,method:"GET",type:"json",responseType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:(e,t)=>{e?e.error?n(new Error(JSON.stringify(e.error))):o(e):n(new Error("unexpected response"))},onFailure:n,onTimeout:n,authentication:"passport"})};return new o((e,t)=>{s.platformId||!S.endpointUrl?n.getOfficeDocumentEditorServiceUrl(s.platformId).then(o=>{a(o,e,t)}).catch(t):a(S.endpointUrl,e,t)})}),S}),define("DS/OfficeDocumentEditorClient/OfficeDocumentEditorClient",["DS/OfficeDocumentEditorClient/Utils"],function(e){"use strict";let t="";try{t=window.location.host.split(".")[0].split("-")[0]}catch(e){}e.getOfficeDocumentEditorServiceUrl(t).then(e=>{const t=new URL(e);t.pathname="/resources/webapps/OfficeDocumentEditorClient",requirejs.undef("DS/OfficeDocumentEditorClient/Editor"),requirejs.undef("DS/OfficeDocumentEditorClient/Utils"),require.config({paths:{"DS/OfficeDocumentEditorClient/Editor":`${t.toString()}/OfficeDocumentEditorClient`,"DS/OfficeDocumentEditorClient/Utils":`${t.toString()}/OfficeDocumentEditorClient`}})}).catch(e=>{console.log(new Error("Cannot load ODE script, err:"+e))})});