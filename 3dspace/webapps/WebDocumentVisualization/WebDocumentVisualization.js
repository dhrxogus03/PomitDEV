define("DS/WebDocumentVisualization/WebDocumentVisualizationServices",["require","exports","DS/SceneGraphNodes/CSS3DNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/Selection/CSOManager","DS/Selection/PSOManager","UWA/Core","DS/Controls/ProgressBar","css!./WebDocumentVisualization.css"],function(e,t,n,o,i,a,r,l,s,c,d,u,m,g){"use strict";let f,h,p;const v=2,E=4,b=0,y=96/72,P=1,D=210,w=25.4,x={left:w-8,top:5,bottom:3},C=["iframe.css","patch.css","UIKIT.css","Menu.css","views.css","views_default.css","WebDocumentVisualization.css","bundle-min.css"];let S,I,M=[],k=1/0,A=[],T=[];function R(e){let t=document.createElement("textarea");return t.innerHTML=e,t.value}class L{static getMMPerPixelRatio(e){if(e){let t=e.currentViewpoint;return(t.camera.top-t.camera.bottom)/e.SCREEN_HEIGHT}return 25.4/96}static setCompareReqIDList(e,t){A=e,T=t}static getRequirementElements(e){return h=b,p=P,M.length=0,new Promise(function(t){(async()=>{let n=new Map,o=0,i=L.getMMPerPixelRatio();M.length=0;const a=function(e){if(this.canvas){let t=L.getMMPerPixelRatio(),n=this.canvas.getContext("2d");if(n){n.fillStyle="white",n.fillRect(0,0,(w-5)/t,this.height/t),this.selected?n.fillStyle="#368ec4":this.hovered?n.fillStyle="#77797c":n.fillStyle=e||"#f1f1f1";let o=this.pathId===M[0]?(w+x.top)/t:x.top/t,i=this.pathId===M[M.length-1]?(w+x.bottom)/t:x.bottom/t;n.fillRect(x.left/t,o,5,this.height/t-o-i)}}this.canvasTexture.needsUpdate=!0},r=function(){d.empty(),this.selected=!0,this.pathElement&&d.add({pathElement:this.pathElement})};for(let t=0;t<e.length;t++){let l=e[t];const u=l.pathId;if(void 0!==l.content){let f,h=m.createElement("div",{id:"WebDocReqElem-"+u,class:"WebDocRequirementsMainDiv"}),p=m.createElement("div",{class:"WebDocRequirementsMainContainer",styles:{width:D/i+"px","padding-top":0===n.size?w/i+"px":0,"padding-right":w/i+"px","padding-bottom":t===e.length-1?w/i+"px":0,"padding-left":w/i+"px"}}).inject(h);if("Chapter"===l.type){let e=m.createElement("div",{class:"WebDocRequirementChapterMainDiv",text:l.chapterLevelTag+" - "+(l.content?R(l.content):""),styles:{"font-size":l.fontSize+"px"}});p.appendChild(e)}else if("Comment"===l.type){let e=m.createElement("div",{class:"WebDocRequirementCommentMainDiv"}),t=m.createElement("div",{class:"WebDocRequirementCommentHeaderDiv"}).inject(e);m.createElement("span",{class:"WebDocRequirementChapterIndex",text:l.chapterLevelTag+" - "}).inject(t),m.createElement("span",{class:"WebDocRequirementCommentIndex",text:l.subLevelTag}).inject(t),l.typeIconUrl&&(f=m.createElement("img",{class:"WebDocRequirementCommentHeaderIconDiv",src:l.typeIconUrl,events:{error:function(){f.remove()}}}).inject(t)),m.createElement("div",{class:"WebDocRequirementCommentHeaderTitleDiv",text:l.title?R(l.title):""}).inject(t),m.createElement("div",{class:"WebDocRequirementCommentContentDiv",html:l.content?R(l.content):""}).inject(e),p.appendChild(e)}else if("Requirement"===l.type){let e=m.createElement("div",{class:"WebDocRequirementMainDiv"}),t=m.createElement("div",{class:"WebDocRequirementHeaderDiv"}).inject(e);m.createElement("span",{class:"WebDocRequirementChapterIndex",text:l.chapterLevelTag+" - "}).inject(t),m.createElement("span",{class:"WebDocRequirementIndex",text:l.subLevelTag}).inject(t),l.typeIconUrl&&(f=m.createElement("img",{class:"WebDocRequirementHeaderIconDiv",src:l.typeIconUrl,events:{error:function(){f.remove()}}}).inject(t)),m.createElement("div",{class:"WebDocRequirementHeaderTitleDiv",text:l.title?R(l.title):""}).inject(t),m.createElement("div",{class:"WebDocRequirementContentDiv",html:l.content?R(l.content):""}).inject(e),p.appendChild(e)}const v=h.querySelectorAll("img:not(.WebDocRequirementHeaderIconDiv)");v.length&&await new Promise(e=>{let n=0;const o=i=>{if(i instanceof ErrorEvent&&window.console.error(`Some images on element: ${t+1}, type: ${l.type} were not correctly loaded`),++n===v.length){for(let e=0;e<v.length;e++){const t=v[e];t.removeEventListener("load",o),t.removeEventListener("error",o)}e()}};for(let e=0;e<v.length;e++){const t=v[e];t.src&&t.src.startsWith("http")?fetch(t.src).then(e=>e.blob()).then(e=>{const n=new FileReader;n.onload=function(e){var n;t.addEventListener("load",o),t.addEventListener("error",o),t.src=null===(n=e.target)||void 0===n?void 0:n.result},n.onerror=o,n.readAsDataURL(e)}).catch(o):t.complete?o():(t.addEventListener("load",o),t.addEventListener("error",o))}});const E=e=>{var t;for(let n=0;n<e.length;n++){const o=e[n];if(o.tagName&&o.tagName.toLowerCase().startsWith("v:")){const e=Array.from(o.children);for(let n=0;n<e.length;n++){const i=e[n];null===(t=o.parentNode)||void 0===t||t.insertBefore(i,o)}o.remove(),E(e)}else o.children.length>0&&E(Array.from(o.children))}};E([h]),document.body.appendChild(h);let b=h.firstChild.getSize().height*i;document.body.removeChild(h);let y=o;o-=b;let P=h.cloneNode(!0);P.id=P.id+"Clone";let C=new g({infiniteFlag:!0,displayStyle:"lite",shape:"circular",height:30,emphasize:"info"});M.push(u);let S={pathId:u,type:"requirement",relType:l.type,html:h,title:l.title?R(l.title):"",content:P,height:b,selected:!1,hovered:!1,marginTop:0===n.size?w:0,marginBottom:t===e.length-1?w:0,progressBar:C,width:D,scale:0,coordinates:{top:y,bottom:y-b,left:-D/2,right:D/2},setAsCurrent:r,updateSelectionStatus:a};n.set(u,S);let I=m.createElement("div",{class:"WebDocRequirementsStatusDiv",styles:{left:x.left/i+"px",top:0===n.size?(w+x.top)/i+"px":x.top/i+"px",bottom:t===e.length-1?(w+x.bottom)/i+"px":x.bottom/i+"px"}}).inject(h);I.setAttribute("data-html2canvas-ignore","true"),I.setAttribute("draggable","true"),I.ondragstart=(e=>{S.pathElement&&!d.isIn({pathElement:S.pathElement})&&(e.ctrlKey||d.empty(),d.add({pathElement:S.pathElement}));let t=d.get(),n=[];for(let e=0;e<t.length;e++){let o=t[e].pathElement.getLastElement(!0);if(o.getReqInfo){let{id:e,type:t}=o.getReqInfo();n.push({envId:s.getPlatformId(),serviceId:"3DSpace",contextId:c.getSetting("pad_security_ctx"),objectId:e,objectType:t})}}if(e.dataTransfer&&(e.dataTransfer.setData("text",JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:n},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})),l.typeIconUrl)){const t=new Image;t.src=l.typeIconUrl,e.dataTransfer.setDragImage(t,10,10)}});let k=m.createElement("div",{class:"WebDocPageLoadingProgressBar"}).inject(h);k.setAttribute("data-html2canvas-ignore",!0),C.inject(k)}}if(!S){let e="";const t=document.styleSheets;for(let n=0;n<t.length;n++){const o=t[n].href;if(o){let t=o.split("/");if((t=t?t[t.length-1].split("?"):void 0)&&C.includes(t[0]))try{let t=document.styleSheets[n].cssRules;for(let n=0;n<t.length;n++)t[n].cssText&&(e+=t[n].cssText+"\n")}catch(t){try{e+=await fetch(o,{headers:{"Content-Type":"text/css",Accept:"text/css,*/*;q=0.1"}}).then(e=>e.text())+"\n"}catch(e){window.console.error(e)}}}}const n="http://www.w3.org/2000/svg";S=document.createElementNS(n,"svg");const o=document.createElementNS(n,"foreignObject");S.setAttributeNS(null,"width",(D/i).toString()),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.setAttributeNS(null,"externalResourcesRequired","true"),o.appendChild(document.createElement("body"));let a=document.createElement("style");"sstyleSheet"in a?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e)),S.appendChild(a),S.appendChild(o)}t(n)})()})}static getRequirementBookmarks(e){const t=[],n={1:t};return e.forEach(e=>{if(e.level>0){let t={pointedId:e.pathId,title:e.title?R(e.title):"",iconUrl:e.typeIconUrl,items:[]};n[e.level].push(t),n[e.level+1]=t.items}}),t}static renderElement(e,t,r){var l;if(e&&e.content&&S){let s=L.getMMPerPixelRatio();if(e.isRendering)return e.needsUpdate=!0,void t();e.isRendering=!0;const c=k/Math.floor(e.width/s),d=k/Math.floor(e.height/s),u=Math.min(e.scale*window.devicePixelRatio,5,c,d);if(e.canvas||(e.canvas=m.createElement("canvas")),e.canvas.width=Math.floor(e.width/s*u),e.canvas.height=Math.floor(e.height/s*u),!e.node){e.canvasTexture=new i.Texture(e.canvas,void 0,i.ClampToEdgeWrapping,i.ClampToEdgeWrapping,i.NearestFilter,i.NearestFilter),e.canvasTexture.needsUpdate=!0,e.canvasMaterial=new i.MeshBasicMaterial({force:!0,transparent:!0,map:e.canvasTexture}),e.node=o.createRectangleNode({width:e.width,height:e.height,fill:!0,noEdge:!0,material:e.canvasMaterial}),e.node.setName("WebDocElementNode"),e.node.getReqInfo=function(){return{id:e.pathId?e.pathId.split("/").pop():"",pathId:e.pathId,type:e.relType}},e.node.excludeFromHighlight(!0,!0);let t=new n(e.html,s,"WebDocRequirementContentNode");t.setPickability(!0),t.setPickable(a.PICKTHROUGH),t.setMatrix((new i.Matrix4).makeTranslation(e.width/2,e.height/2,0)),e.node.setMatrix((new i.Matrix4).makeTranslation(-e.width/2,e.coordinates.top-e.height,0)),e.node.addChild(t)}let g=this;S.setAttributeNS(null,"height",(e.height/s).toString());const f=null===(l=S.lastElementChild)||void 0===l?void 0:l.firstElementChild;null==f||f.appendChild(e.content);const h=new Image(e.canvas.width,e.canvas.height);h.onload=(()=>{var n;if(!e.canvas)return;const o=e.canvas.getContext("2d");o.scale(u,u);let i=void 0;A&&A.length&&A.indexOf(e.pathId)>=0?i="#FF8A2E":T&&T.length&&T.indexOf(e.pathId)>=0&&(i="#009ddb"),o.fillStyle="#ffffff",o.fillRect(0,0,e.canvas.width,e.canvas.height),o.drawImage(h,0,0),e&&e.canvasTexture&&e.updateSelectionStatus(i),null===(n=e.html.firstElementChild)||void 0===n||n.classList.add("loaded"),e.isRendering=!1,e.onError=!1,e.needsUpdate?(e.needsUpdate=!1,g.renderElement(e,t,r)):t()}),h.onerror=(()=>{e.isRendering=!1,e.needsUpdate=!1,e.onError?r&&r():(e.onError=!0,g.renderElement(e,t,r))}),h.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent((new XMLSerializer).serializeToString(S))}`,null==f||f.removeChild(e.content)}}static renderDocumentElements(e){if(!(e&&e.elements&&e.currentElement&&e.viewpoint&&e.onComplete))return e.onFailure?e.onFailure():void 0;if(k===1/0){const t=e.viewpoint.viewer.getWebGLContext();k=t.getParameter(t.MAX_TEXTURE_SIZE)}let t=e.scale||1,n=e.currentElement,o=e.viewpoint.getEyePosition().y+e.viewpoint.getCamera().bottom,i=0,a=0,r=this,l=0,s=function(){0===--l&&e.onComplete()};!function c(){if(n===e.elements.size+1&&(a++,n=e.currentElement-a,i=p),n<1||n>e.elements.size)return;let d=!1,u=M[n-1],m=e.elements.get(u);m&&(m.node||(d=!0),(!m.scale||Math.abs(m.scale-t)>.01)&&(d=!0,m.scale=t),m.visible=n>=e.currentElement,m.toLoad=!0,d&&(l++,"requirement"===m.type?r.renderElement(m,s,e.onFailure):r.renderPage(m,s,e.onFailure)),o>m.coordinates.top&&(m.visible=!1,i++),i<p?(n++,c()):a<p&&(m.visible=!1,a++,n=e.currentElement-a,c()))}(),0===l&&e.onComplete()}static computeCurrentElement(e,t,n,o=!1){let i=n||1;if(e&&t&&t.size&&i){let n=h||2e-4,a=e.getEyePosition().y+e.getCamera().top,r=!1,l=t.get(M[i-1]);if(l){if(a-l.coordinates.top>n/2)r=!0;else if(a-l.coordinates.bottom>n/2)return i>1&&o?this.computeCurrentElement(e,t,i-1,o):i;for(let e=r?i-2:i;r?e>=0:e<M.length;r?e--:e++)if(M[e]){let o=t.get(M[e]);if(o&&o.coordinates&&a-o.coordinates.bottom>n/2&&a-o.coordinates.top<=n/2)return e+1}}}return i||1}static updateElementsToLoad(e,t,n){if(!e||!n)return;let o=n.getEyePosition().y+n.getCamera().bottom,i=0,a=e.values();for(let n=0;n<e.size;n++){let e=a.next().value;e.selected?e.toLoad=!0:n+1<t-p?e.toLoad=!1:o>e.coordinates.top?(i++,e.toLoad=i<=p):e.toLoad=!0}}static cleanRequirementElements(e){var t;let n=e.values();for(let o=0;o<e.size;o++){let e=n.next().value;e&&e.canvas&&(null===(t=e.canvas)||void 0===t||t.destroy(),e.html&&e.html.destroy(),e.canvasTexture&&e.canvasTexture.dispose(),e.canvasMaterial&&e.canvasMaterial.dispose(),e.progressBar&&e.progressBar.destroy(),e.node&&e.node.removeChildren())}e.clear(),S&&(S.remove(),S=null),M.length=0}static getZoomLevel(e){let t=L.getMMPerPixelRatio(e);return parseInt((L.getMMPerPixelRatio()/t*100).toFixed(0))||100}static updateNodesInSession(e,t,n=!1){if(!e||!t||!t.size)return;let o=t.values();for(let i=0;i<t.size;i++){let i=o.next().value;if(i.node)if(n&&!i.toLoad&&i.loaded)i.loaded=!1,i.visible=!1,e.removeChild(i.node),"requirement"===i.type&&i.html.removeEvents();else if(i.toLoad&&!i.loaded&&(i.loaded=!0,e.addChild(i.node),"requirement"===i.type)){if(!i.pathElement){let e=[],t=i.node;for(;t&&!t.notAllowedInPathElement;)e.unshift(t),t=t.parents[0];i.pathElement=new l(e)}i.html.addEvents({mouseover:()=>{"requirement"!==i.type||u.isIn({pathElement:i.pathElement})||(u.empty(),u.add({pathElement:i.pathElement}))},click:e=>{if("requirement"===i.type){if(e.shiftKey&&I){let e=M.indexOf(i.pathId),n=M.indexOf(I);if(-1!==e&&-1!==n){let o=[];for(let i=Math.min(e,n);i<=Math.max(e,n);i++){let e=t.get(M[i]);e&&"requirement"===e.type&&o.push({pathElement:e.pathElement})}d.add(o)}}I=i.selected?i.pathId:null}}}),i.selected&&d.add({pathElement:i.pathElement})}}}static getElementIdAtIndex(e){return M[e]}static getElementIndexById(e){return M.indexOf(e)}static getPdfDocument(e){e&&e.dataBuffer&&e.onComplete||!e.onFailure?(window.PDFJS_VERSION="2.13.216",window.require(["DS/PDFjs/PDFjs"],t=>{h=E,p=v,(f=t).getDocument({cMapPacked:t.cMapPacked,cMapUrl:t.cMapUrl,data:e.dataBuffer,password:e.password}).promise.then(function(t){t?e.onComplete(t):e.onFailure&&e.onFailure()},function(t){"PasswordException"===t.name?t.code!==f.PasswordResponses.NEED_PASSWORD&&t.code!==f.PasswordResponses.INCORRECT_PASSWORD||!e.onIncorrectPassword?e.onFailure&&e.onFailure(t):e.onIncorrectPassword():e.onFailure&&e.onFailure(t)})})):e.onFailure()}static getPdfPages(e,t){return new Promise(function(n,o){e||o(new Error("The PDF Document is undefined"));let i=new Map,a=0,r=function(t){e.getPage(t.number).then(function(r){if(r){t.pageObj=r;let o=t.pageObj.getViewport({scale:y}),l=L.getMMPerPixelRatio(),s=o.width/2*l,c=i.get((t.number-1).toString()),d=t.number>1&&c?c.coordinates.bottom-h:0;t.coordinates.top=d,t.coordinates.bottom=d-o.height*l,t.coordinates.left=-s,t.coordinates.right=s,t.height=t.coordinates.top-t.coordinates.bottom,t.width=t.coordinates.right-t.coordinates.left,t.pageLayer=m.createElement("div",{id:"WebDocPageLayerPage"+t.number,class:"WebDocPageLayer"}),++a===e.numPages&&n(i)}else o(new Error("Page "+t.number+" not finded"))},o)};M.length=0;for(let n=0;n<e.numPages;n++){let e=n+1,o={type:"page",number:e,scale:t,rotationAngle:0,height:0,width:0,coordinates:{top:0,bottom:0,right:0,left:0}};M.push(e.toString()),i.set(e.toString(),o),r(o)}})}static getPdfCommentsFromPages(e){return new Promise(function(t,n){e||n(new Error("Pages are Undefined"));let o=[];e.size||t(o);let a=0;e.forEach(function(n){n.pageObj&&n.pageObj.getAnnotations().then(function(r){if(n.pageObj){let e=null,t=null,a=n.pageObj.getViewport({scale:n.scale*y});for(let l=0;l<r.length;l++)if("Popup"!==r[l].subtype)e=r[l].id,t=r[l].rect;else if(r[l].contentsObj&&r[l].contentsObj.str&&r[l].parentId&&r[l].parentId===e&&t){let s=null,c=L.getMMPerPixelRatio(),d=new i.Vector3(c*t[0]*y,c*-(a.viewBox[3]-t[3])*y,0);t&&t.length&&(s={position:d,width:c*(t[2]-t[0])*y,height:c*(t[3]-t[1])*y}),o.push({owner:{name:r[l].titleObj.str},content:r[l].contentsObj.str.split(/(?:\r\n|\r|\n)/g),isReadOnly:!0,pointedPage:n.number,pointedPosition:d,rect:s}),e=null,t=null}}++a===e.size&&t(o)})})})}static getPdfLinksFromPages(e,t){return new Promise(function(n,o){t||o(new Error("Pages are Undefined"));let a=[];t.size||n(a);let r=0;t.forEach(function(o){o.pageObj&&o.pageObj.getAnnotations().then(function(l){let s=l.filter(function(e){return"Link"===e.subtype});if(s&&s.length&&o.pageObj){let t=o.pageObj.getViewport({scale:o.scale*y}),n=m.createElement("div",{id:"WebDocAnnotationLayerPage"+o.number,class:"WebDocAnnotationLayer"}).inject(o.pageLayer);o.updateAnnotationScale=function(e){n.setStyle("transform","scale("+e/t.scale*y+")")},s.forEach(function(o){let r=m.createElement("section",{class:"WebDocLinkAnnotation"}).inject(n);r.setStyle("transform","scale("+t.scale+")");let l,s=o.rect;if(r.setStyles({"transform-origin":-s[0]+"px "+-(t.viewBox[3]-s[3])+"px 0px",left:s[0]+"px",top:t.viewBox[3]-s[3]+"px",width:s[2]-s[0]+"px",height:s[3]-s[1]+"px"}),o.url||o.unsafeUrl)l=m.createElement("a",{href:o.url?o.url:o.unsafeUrl}).inject(r),a.push({div:l,content:m.createElement("p",{text:o.url||o.unsafeUrl,styles:{margin:"2px",padding:0,userSelect:"text"}})});else if(o.dest){let t,n,s,c,d,u,g,f;l=m.createElement("a").inject(r);let h=L.getMMPerPixelRatio();Array.isArray(o.dest)?(u="object"==typeof o.dest[1]?o.dest[1].name:null,g=o.dest[2]?h*o.dest[2]*y:null,f=o.dest[3]?h*o.dest[3]*y:null,s="FitH"===u,c="FitV"===u||"Fit"===u,d=o.dest[4]||null,n=null!==g&&null!==f?new i.Vector3(g||0,f||0,0):null,"number"==typeof o.dest[0]?t=o.dest[0]+1:"object"==typeof o.dest[0]&&e.getPageIndex(o.dest[0]).then(function(e){t=e+1})):"string"==typeof o.dest&&e.getDestination(o.dest).then(function(o){o&&o.length&&(u="object"==typeof o[1]?o[1].name:null,g=o[2]?h*o[2]*y:null,f=o[3]?h*o[3]*y:null,s="FitH"===u,c="FitV"===u||"Fit"===u,d=o[4]||null,n=null!==g&&null!==f?new i.Vector3(g||0,f||0,0):null,e.getPageIndex(o[0]).then(function(e){t=e+1}))}),a.push({addClickListener:function(e){l.addEvent("click",function(){e({pointedPosition:n,pointedPage:t,fitAllIn:c,fitWidth:s,scale:d})})},remove:function(){l.removeEvents(),r.remove()}})}})}++r===t.size&&n(a)})})})}static getPdfBookmarks(e){return new Promise(function(t,n){e||n(new Error("The PDF Document is undefined")),e.getOutline().then(function(o){let a=[],r=0;if(o&&o.length){let l=function(){0===--r&&t(a)},s=function(t){let o=[];if(t&&t.length){let a=function(e,t){let n="object"==typeof t[1]?t[1].name:null,o=L.getMMPerPixelRatio(),a=t[2]?o*t[2]*y:null,r=t[3]?o*t[3]*y:null;e.fitWidth="FitH"===n,e.fitAllIn="FitV"===n||"Fit"===n,e.pointedPosition=null!==a&&null!==r?new i.Vector3(a||0,r||0,0):null};t.forEach(function(t){let i={title:unescape(t.title),bold:t.bold,italic:t.italic,items:s(t.items)};Array.isArray(t.dest)?(a(i,t.dest),"number"==typeof t.dest[0]?i.pointedPage=t.dest[0]+1:t.dest[0]&&"object"==typeof t.dest[0]&&(r++,e.getPageIndex(t.dest[0]).then(function(e){i.pointedPage=e+1,l()}).catch(()=>{i.pointedPage=void 0,l()}))):"string"==typeof t.dest&&(r++,e.getDestination(t.dest).then(function(t){t&&t.length&&(a(i,t),"number"==typeof t[0]?(i.pointedPage=t[0]+1,l()):e.getPageIndex(t[0]).then(function(e){i.pointedPage=e+1,l()}).catch(()=>{i.pointedPage=void 0,l()}))},n)),o.push(i)})}return o};a=s(o),0===r&&t(a)}else t(a)},n)})}static getMaxWidth(e,t){let n=e.values().next().value,o=n.coordinates.right-n.coordinates.left;for(let i=t;i<e.size&&(n=e.get((i+1).toString())).visible;i++)o=Math.max(o,n.coordinates.right-n.coordinates.left);return o}static renderPage(e,t,l){let s=this;if(f&&e&&e.pageObj){if(e.isRendering)return e.needsUpdate=!0,void t();e.isRendering=!0;let c=e.pageObj.getViewport({scale:e.scale*y});e.canvas||(e.canvas=m.createElement("canvas"),e.canvas.id="PDFcanvasPage"+e.number),e.canvas.height=c.height,e.canvas.width=c.width;let d=e.canvas.getContext("2d");if(d&&(d.fillStyle="white",d.fillRect(0,0,e.canvas.width,e.canvas.height)),!e.node){let t=e.width,l=e.height,s=e.coordinates.bottom;e.canvasTexture=new i.Texture(e.canvas),e.canvasTexture.needsUpdate=!0,e.canvasMaterial=new i.MeshBasicMaterial({force:!0,transparent:!0,map:e.canvasTexture});let d=o.createRectangleNode({width:t,height:l,fill:!0,noEdge:!0,material:e.canvasMaterial});d.setName("WebDocMeshPage"+e.number),d.setPickable(a.PICKTHROUGH),e.node=new r("WebDocNodePage"+e.number),e.node.addChild(d);let u=m.createElement("div",{id:"WebDocTextLayerPage"+e.number,class:"WebDocTextLayer"}).inject(e.pageLayer),h=new n(e.pageLayer,L.getMMPerPixelRatio()/e.scale,"WebDocLayerNodePage"+e.number);e.updateAnnotationScale&&e.updateAnnotationScale(e.scale),h.setPickability(!0),h.setMatrix((new i.Matrix4).makeTranslation(.5*t,.5*l,0)),h.setPickable(a.PICKTHROUGH),e.node.addChild(h);let p=(new i.Matrix4).makeRotationZ(e.rotationAngle),v=Math.abs(e.height*Math.cos(e.rotationAngle)-e.width*Math.sin(e.rotationAngle)),E=Math.abs(e.height*Math.sin(e.rotationAngle)+e.width*Math.cos(e.rotationAngle)),b=new i.Vector3(-e.width/2,-e.height/2,0).applyMatrix4(p);b.add(new i.Vector3(e.coordinates.left+E/2,s+v/2,0)),e.node.setMatrix((new i.Matrix4).setPosition(b).multiply(p));let y=m.createElement("div",{class:"WebDocPageLoadingProgressBar"}).inject(e.pageLayer),P=new g({infiniteFlag:!0,displayStyle:"lite",shape:"circular",height:80,emphasize:"info"}).inject(y);e.cssNode=h,e.destroyProgressBar=function(){var t;y.setStyle("display","none"),P.destroy(),null===(t=e.pageLayer)||void 0===t||t.removeChild(y)},e.pageObj.getTextContent().then(function(t){f.renderTextLayer({textContent:t,container:u,viewport:c,enhanceTextSelection:!0}),e.pageLayer&&e.canvas&&(e.pageLayer.style.left=e.canvas.offsetLeft+"px",e.pageLayer.style.top=e.canvas.offsetTop+"px",e.pageLayer.style.height=e.canvas.height+"px",e.pageLayer.style.width=e.canvas.width+"px")})}if(d){e.pageObj.render({canvasContext:d,viewport:c,enableWebGL:!0}).promise.then(function(){e&&e.canvasTexture&&(e.canvasTexture.needsUpdate=!0),e.destroyProgressBar&&(e.destroyProgressBar(),e.destroyProgressBar=null),e.isRendering=!1,e.needsUpdate?(e.needsUpdate=!1,s.renderPage(e,t,l)):t()},function(){l&&l()})}}}static cleanPdfPages(e){var t;let n=e.values();for(let o=0;o<e.size;o++){let e=n.next().value;e&&e.canvas&&(null===(t=e.canvas)||void 0===t||t.destroy(),e.canvasTexture&&e.canvasTexture.dispose(),e.canvasMaterial&&e.canvasMaterial.dispose(),e.progressBar&&e.progressBar.destroy(),e.node&&e.node.removeChildren())}e.clear(),M.length=0}}return L}),define("DS/WebDocumentVisualization/WebDocumentVisualizationController",["require","exports","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/WebDocumentVisualization/WebDocumentVisualizationServices","DS/CoreEvents/ModelEvents"],function(e,t,n,o,i,a,r,l,s){"use strict";class c{constructor(e){let t,c,d,u,m,g,f,h,p,v,E,b,y,P,D,w,x,C,S,I,M,k,A,T,R=this,L=null,V=e.context.getViewer(),W=e.context.getViewpoint(),q=e.context.getFrameWindow(),F=!0,z=!0,B=!1,O=!1,U=!0,N=!1,j=0,H=!0,Z=new s,_=[],X=[];const K=9.1,G=500;function J(e){if(!e)return;if(e.includes("/")||E.has(e))return E.get(e);const t=E.keys();for(let n=0;n<E.size;n++){const n=t.next().value;if(n.endsWith(e))return E.get(n)}}function $(e,t){Z.publish({event:e,data:t})}function Y(){let e=S?S.pages:E;l.updateElementsToLoad(e,b,W),l.updateNodesInSession(L,e,!0),V.render()}function Q(e){e.from[0].event instanceof TouchEvent&&(B||"Hold"===e.gesture.name&&(V.setPicking({showDivTrap:!0}),R.setTouchPanActive(!1)))}function ee(e){if(e.from[0].event instanceof TouchEvent&&!B&&U&&"Touch"===e.from[0].type)if("touchstart"===e.from[0].event.type||"begin"===e.state)V.divCssElement.setStyle("display","none"),V.manipulatorManager.setActivate(!1),V.setDefaultPicking(!1),x=W.getEyePosition(),w=e.from[0].getCurrentPosition(V.canvas),C=l.getMMPerPixelRatio(V);else if("touchmove"===e.from[0].event.type){let t=w.clone().sub(e.from[0].getCurrentPosition(V.canvas));W.moveTo({eyePosition:new i.Vector3(x.x+t.x*C,x.y-t.y*C,x.z),duration:0})}else"touchend"!==e.from[0].event.type&&"end"!==e.state||(V.manipulatorManager.setActivate(!0),V.setDefaultPicking(!0),V.divCssElement.setStyle("display","block"))}function te(e){let t=W.getEyePosition(),n=0,o=0,a=e.from[0].event;a.ctrlKey||(a.shiftKey?n=25*e.gesture.delta:o=25*e.gesture.delta,W.moveTo({eyePosition:new i.Vector3(t.x-n,t.y+o,t.z),duration:0}))}function ne(){if(N||!S&&!E)return;let e=W.getCamera(),t=l.getMMPerPixelRatio(V),n=v&&v.left?v.left*t:0,o=v&&v.right?v.right*t:0,a=v&&v.bottom?v.bottom*t:0,r=e.top,s=e.bottom+a,c=e.left+n,d=e.right-o,u=(o-n)/2,g=W.getEyePosition(),f=S?l.getMaxWidth(S.pages,b-1):E.values().next().value.width,h=g.x,p=g.y,y=g.z;g.x!==u&&(d-c>f?h=u:g.x+d>f/2?h=f/2-d:g.x+c<-f/2&&(h=-f/2-c));let P=S?S.pages:E,D=P.size;if(B){let e=l.getElementIdAtIndex(b-1),t=P.get(e);t&&(m||(m=t.coordinates.top-(g.y+r)),Math.abs(t.coordinates.top-(g.y+r)-m)>1e-5&&(p=t.coordinates.top-r-m))}let w=P.get(l.getElementIdAtIndex(D-1)),x=P.get(l.getElementIdAtIndex(0));w&&x&&(r-s>x.coordinates.top-w.coordinates.bottom?p=w.coordinates.bottom/2:p+r>0?p=-r:p+s<w.coordinates.bottom&&(p=w.coordinates.bottom-s));let C=l.getZoomLevel(V),I=W.getTargetDistance();C>G?(y+=I*C/G-I,W.setTargetDistance(I*C/G)):C<K&&(y+=I*C/K-I,W.setTargetDistance(I*C/K)),h===g.x&&p===g.y&&y===g.z||W.setEyePosition(new i.Vector3(h,p,y))}function oe(){if(!E&&!S)return;let e=S?S.pages:E,t=l.computeCurrentElement(W,e,b,Boolean(S&&M));l.renderDocumentElements({elements:e,currentElement:t,viewpoint:W,scale:l.getZoomLevel(V)/100,onComplete:function(){V&&V.render()}}),t!==b&&$("onCurrentElementChange",{value:b=t}),l.updateNodesInSession(L,e)}let ie=null;function ae(){if(!q)return;v||(v={left:0,right:0,bottom:0});let e=q.getImmersiveFrame(),t=0,n=0,o=e.getDockingElement(WUXDockAreaEnum.RightDockArea),i=e.getDockingElement(WUXDockAreaEnum.LeftDockArea),a=o.getContainedVisibleWindows().length>0,r=i.getContainedVisibleWindows().length>0;(a||o.interactiveDockAreaVisibleFlag)&&(t=o._collapserSize,o.collapseDockingZoneFlag||(t+=o.dockingZoneSize)),(r||i.interactiveDockAreaVisibleFlag)&&(n=i._collapserSize,i.collapseDockingZoneFlag||(n+=i.dockingZoneSize)),v.right=t,v.left=n,v.bottom=0,ne(),ie&&clearTimeout(ie),ie=setTimeout(()=>{oe(),ie=null},100)}function re(){if(!S)return;let e,t=W.getCamera(),n=l.getMMPerPixelRatio(V),o=v?v.left*n:0,a=v?v.right*n:0,r=v?v.bottom*n:0,s=(t.top,t.bottom,t.left+o),c=t.right-a-s,d=0,u=[],m=function(e){return(d+=e)===e||(d+=4,!!(M&&u.length<2&&d<c)||(d-=e+4,!1))},g=0,f=0,h=0,p=S.pages,E=p.get("1");if(E){let t=(new i.Matrix4).makeRotationZ(E.rotationAngle),n=p.values();for(let o=0;o<p.size;o++){let a=n.next().value,r=a.coordinates.right-a.coordinates.left;if(m(r))h=Math.max(h,a.coordinates.top-a.coordinates.bottom),u.push(o);else{g-=h,f=-d/2;for(let n=0;n<u.length;n++){let o=p.get((u[n]+1).toString());if(o){let n=o.coordinates.top-o.coordinates.bottom,a=o.coordinates.right-o.coordinates.left;o.coordinates.bottom=g+(h-n)/2,o.coordinates.top=o.coordinates.bottom+n,o.coordinates.left=f,o.coordinates.right=o.coordinates.left+a,o.node&&((e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t)).add(new i.Vector3(f+a/2,g+h/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))),f+=a+4}}g-=4,u.length=0,u.push(o),d=r,h=a.coordinates.top-a.coordinates.bottom}}if(u.length){g-=h,f=-d/2;for(let n=0;n<u.length;n++){let o=p.get((u[n]+1).toString());o&&(o.coordinates.top=g+o.coordinates.top-o.coordinates.bottom,o.coordinates.right=f+o.coordinates.right-o.coordinates.left,o.coordinates.bottom=g,o.coordinates.left=f,o.node&&((e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t)).add(new i.Vector3(f+(o.coordinates.right-o.coordinates.left)/2,g+h/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))),f+=o.coordinates.right-o.coordinates.left+4)}}}}function le(e){if(!E&&!S)return;let t=e.eventType||e.event;"@onViewpointBeginMove"===t?(O=!0,$("onScrollChange",{type:"start"})):"@onViewpointChange"===t&&O?(u.z!==e.viewpoint.position.z?B?(M&&re(),$("onZoomChange",{type:"change",value:l.getZoomLevel(V)})):(R.enableTextSelection(!1),$("onZoomChange",{type:"start",value:l.getZoomLevel(V)}),B=!0):oe(),ne(),$("onScrollChange",{type:"change"})):"@onViewpointEndMove"===t?(O=!1,B&&(M&&re(),u=W.getEyePosition(),$("onZoomChange",{type:"end",value:l.getZoomLevel(V)}),B=!1,m=null,R.enableTextSelection(!0)),N=!1,ne(),oe(),$("onScrollChange",{type:"end"}),$("onCurrentElementChange",{value:b,endMove:!0}),"requestIdleCallback"in window?(P&&(window.cancelIdleCallback(P),P=null),P=window.requestIdleCallback(Y)):(y&&(clearTimeout(y),y=null),setTimeout(Y,3e3))):"onSwapVisibleSpace"===t&&R.enableTextSelection(Boolean(V.getVisibleSpace()))}function se(e){let t,n=e.target;!S&&!E||n&&("P"===n.tagName||"textarea"===n.type||"input"===n.type||n.isContentEditable)||("End"===e.key||35===e.keyCode?R.setCurrentElement({elementID:S?S.document.numPages:l.getElementIdAtIndex(E.size-1)}):"Home"===e.key||36===e.keyCode?R.setCurrentElement({elementID:S?1:l.getElementIdAtIndex(0)}):M||("ArrowUp"===e.key||38===e.keyCode?(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y+20,t.z),duration:100})):"ArrowDown"===e.key||40===e.keyCode?(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y-20,t.z),duration:100})):e.ctrlKey||"ArrowRight"!==e.key&&39!==e.keyCode?e.ctrlKey||"ArrowLeft"!==e.key&&37!==e.keyCode?"PageUp"===e.key||33===e.keyCode?(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y+150,t.z),duration:200})):"PageDown"!==e.key&&34!==e.keyCode||(t=W.getEyePosition(),W.moveTo({eyePosition:new i.Vector3(t.x,t.y-150,t.z),duration:200})):R.centerViewpointAtNextOrPreviousElement(!1):R.centerViewpointAtNextOrPreviousElement(!0)))}function ce(e){var t;F&&z||(e.preventDefault(),null===(t=window.getSelection())||void 0===t||t.removeAllRanges())}function de(e){V.getDefaultPicking()&&("@onPrimaryPointerDownUniqueEvent"===e.eventType&&e.from[0].view.id&&e.from[0].view.id.includes("WebDocPageLayer")||e.from[0].view===V.canvas?V.setPicking({showDivTrap:!0}):"@onPrimaryPointerUpUniqueEvent"===e.eventType&&(V.setPicking({showDivTrap:!1}),R.setTouchPanActive(!0)))}function ue(){V.set2DMode(!0,"CATIA"),t=V.antiAliasing,V.setAntiAliasing("NoAA"),c={showDivTrap:V.picking.showDivTrap},V.setPicking({showDivTrap:!1}),W.setEyePosition(new i.Vector3(0,0,100)),W.setTargetDistance(100),u=W.getEyePosition()}function me(e){if(!e.target.hasClassName||!e.target.hasClassName("WebDocRequirementsStatusDiv"))return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}function ge(e){return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1}function fe(e){if(e&&e.pointedPage&&F&&H&&S){if(e.scale){let t=l.getZoomLevel(V)/100,n=W.getTargetDistance(),o=W.getEyePosition(),a=n*t/e.scale-n;W.setTargetDistance(n*t/e.scale),W.setEyePosition(new i.Vector3(o.x,o.y,o.z+a))}if(e.pointedPosition){let t=S.pages.get(e.pointedPage.toString());if(t){let n=t.coordinates;R.centerViewpointAtElementPosition({elementID:e.pointedPage,position:new i.Vector3(e.pointedPosition.x,e.pointedPosition.y-(n.top-n.bottom),0),duration:0,centerAtTopLeft:!0})}}else R.setCurrentElement({elementID:e.pointedPage});(e.fitAllIn||e.fitWidth)&&setTimeout(function(){R.fitCurrentElement(e.fitWidth)})}}function he(){var e,t;!function(){let e=W.getEyePosition();W.setEyePosition(new i.Vector3(e.x,0,e.z)),W.onCenterCamera(()=>{}),g=o.subscribe({event:"/VISU/"},le),document.addEventListener("selectionchange",ce),document.addEventListener("selectstart",ce),document.addEventListener("keyup",se),V.divCssElement.addEventListener("dragstart",me),V.divCssElement.addEventListener("contextmenu",ge),n.addEvent(V.divCssElement,"onMouseWheel",te),n.addEvent(V.canvas,"onMouseWheel",te),n.addEvent(V.divCssElement,"onPrimaryPointerDownUnique",de),n.addEvent(V.canvas,"onPrimaryPointerDownUnique",de),n.addEvent(V.divCssElement,"onPrimaryPointerUpUnique",de),n.addEvent(V.canvas,"onPrimaryPointerUpUnique",de),n.addEvent(V.divCssElement,"onSwipe",ee),n.addEvent(V.canvas,"onSwipe",ee),n.addEvent(V.divCssElement,"onHold",Q),n.addEvent(V.canvas,"onHold",Q),q.getImmersiveFrame().addEventListener("freeZoneResize",ae),p=V.onSwapVisibleSpace(function(){le({eventType:"onSwapVisibleSpace"})}),R.setTextSelectionFlag(!0),ae(),ne(),"requestIdleCallback"in window?(P&&(window.cancelIdleCallback(P),P=null),P=window.requestIdleCallback(Y)):(y&&(clearTimeout(y),y=null),setTimeout(Y,3e3))}(),oe();let a=W.getCamera(),r=l.getMMPerPixelRatio(V),s=v?v.left*r:0,c=v?v.right*r:0,d=v?v.bottom*r:0,u=(a.top,a.bottom,a.left+s),m=a.right-c,f=W.getEyePosition(),h=(S?null===(e=S.pages.get("1"))||void 0===e?void 0:e.width:null===(t=E.get(l.getElementIdAtIndex(0)))||void 0===t?void 0:t.width)||0;h*=2,W.moveTo({eyePosition:new i.Vector3((c-s)/2,0,f.z*h/(m-u)),distanceToTarget:W.getTargetDistance()*h/(m-u),duration:0}),j--}this.loadDocumentStream=function(t){if("Requirement"===t.type){if(!t.elementsToLoad||!t.elementsToLoad.length)return t.onFailure(new Error("No elements to load"));if(T=t.elementsToLoad,f="Requirement",d=t.phyId,j++,ue(),!A){const t=()=>{var e;let t=a.get(),n=_.slice();_.length=0,n.forEach(e=>{let t=J(e);if(t){let n;t.hovered=!1,k&&k.firstReqData&&k.firstReqData.length&&k.firstReqData.indexOf(e)>=0?n="#FF8A2E":k&&k.secondReqData&&k.secondReqData.length&&k.secondReqData.indexOf(e)>=0&&(n="#009ddb"),t.updateSelectionStatus(n)}});for(let n=0;n<t.length;n++){let o=null===(e=t[n].pathElement)||void 0===e?void 0:e.getLastElement(!0);if(o&&o.getReqInfo){let{pathId:e}=o.getReqInfo(),t=J(e);if(t){let n;t.hovered=!0,_.push(e),k&&k.firstReqData&&k.firstReqData.length&&k.firstReqData.indexOf(e)>=0?n="#FF8A2E":k&&k.secondReqData&&k.secondReqData.length&&k.secondReqData.indexOf(e)>=0&&(n="#009ddb"),t.updateSelectionStatus(n)}}}V.render()};let n=!1;const o=()=>{n=!1;let t=r.get(),o=X.slice();X.length=0,o.forEach(e=>{let t=J(e);t&&(t.selected=!1,t.updateSelectionStatus())});let i=!1;for(let e=0;e<t.length;e++){let o,a=t[e].pathElement.getLastElement(!0);if(a.getReqInfo){let{pathId:e}=a.getReqInfo();o=J(e)}else if(1===E.size){let e=E.values().next().value;e.node&&a===e.node.getParents()[0]&&(o=e,n=!0)}o&&(X.push(o.pathId),o.selected=!0,o.updateSelectionStatus(),o.loaded||(o.toLoad=!0,i=!0))}!n&&X.length&&(e.context.lockSelectionBroadcast(!0),$("onElementSelection",X[X.length-1])),i&&l.updateNodesInSession(L,E),V.render()};A={onPSOEmpty:a.onEmpty(t),onPSORemove:a.onRemove(t),onPSOAdd:a.onAdd(t),onCSOEmpty:r.onEmpty(o),onCSORemove:r.onRemove(o),onCSOAdd:r.onAdd(o)}}l.getRequirementElements(t.elementsToLoad).then(function(e){t.elementsToLoad&&(E=e,D=l.getRequirementBookmarks(t.elementsToLoad),b=1,L=t.fatherNode,l.renderDocumentElements({elements:E,currentElement:b,viewpoint:W,scale:l.getZoomLevel(V)/100,onFailure:t.onFailure,onComplete:function(){he(),t.onComplete()}}),l.updateNodesInSession(L,E),V.render())})}else"Document"===t.type&&t.dataBuffer?(f="Document",d=t.phyId,j++,ue(),l.getPdfDocument({dataBuffer:t.dataBuffer,password:t.password,onComplete:function(e){if(t.password&&t.onPasswordOk&&t.onPasswordOk(),e){l.getMMPerPixelRatio();let n=l.getMMPerPixelRatio()/l.getMMPerPixelRatio(V);l.getPdfPages(e,n).then(function(n){L=t.fatherNode,b=1,l.renderDocumentElements({elements:n,currentElement:b,viewpoint:W,scale:l.getZoomLevel(V)/100,onFailure:t.onFailure,onComplete:function(){Promise.all([l.getPdfCommentsFromPages(n),l.getPdfLinksFromPages(e,n),l.getPdfBookmarks(e)]).then(async function(o){!S&&t.dataBuffer&&(S={buffer:t.dataBuffer,document:e,pages:n,externalComments:o[0],links:o[1],bookmarks:o[2]}),S&&S.links&&S.links.length&&S.links.forEach(function(e){e.addClickListener&&e.addClickListener(fe)}),he(),await t.onComplete()},function(e){window.console.error(e),j--,d=null,t.onFailure()})}}),l.updateNodesInSession(L,n),V.render()},function(e){window.console.error(e),j--,d=null,t.onFailure(e)})}else j--,d=null,t.onFailure()},onIncorrectPassword:function(){j--,d=null,t.onIncorrectPassword?t.onIncorrectPassword():t.onFailure()},onFailure:function(e){j--,d=null,t.onFailure(e)}})):t.onFailure(new Error("Data type not supported"))},this.isLoading=function(){return j>0},this.getSelectedElementIDs=function(){return X&&X.length?X:[]},this.removeDocument=function(){P&&(window.cancelIdleCallback(P),P=null),y&&(clearTimeout(y),y=null),document.removeEventListener("selectstart",ce),document.removeEventListener("selectionchange",ce),document.removeEventListener("keyup",se),V.divCssElement.removeEventListener("dragstart",me),V.divCssElement.removeEventListener("contextmenu",ge),n.removeEvent(V.divCssElement,"onMouseWheel",te),n.removeEvent(V.canvas,"onMouseWheel",te),n.removeEvent(V.divCssElement,"onPrimaryPointerDownUnique",de),n.removeEvent(V.canvas,"onPrimaryPointerDownUnique",de),n.removeEvent(V.divCssElement,"onPrimaryPointerUpUnique",de),n.removeEvent(V.canvas,"onPrimaryPointerUpUnique",de),p&&(V.unsubscribe(p),p=null),n.removeEvent(V.divCssElement,"onSwipe",ee),n.removeEvent(V.canvas,"onSwipe",ee),n.removeEvent(V.divCssElement,"onHold",Q),n.removeEvent(V.canvas,"onHold",Q),q.getImmersiveFrame().removeEventListener("freeZoneResize",ae),c&&V.setPicking(c),t&&V.antiAliasing!==t&&"MSAA"===V.antiAliasing&&V.setAntiAliasing(t),V.get2DMode()&&V.set2DMode(!1),W.onCenterCamera(null),V.render(),g&&o.unsubscribe(g),A&&(a.unsubscribe(A.onPSOEmpty),a.unsubscribe(A.onPSORemove),a.unsubscribe(A.onPSOAdd),r.unsubscribe(A.onCSOEmpty),r.unsubscribe(A.onCSORemove),r.unsubscribe(A.onCSOAdd),A=void 0),E&&l.cleanRequirementElements(E),S&&(S.links&&S.links.length&&S.links.forEach(function(e){e.remove&&e.remove()}),l.cleanPdfPages(S.pages)),L&&L.removeChildren(),j=0,B=!1,O=!1,U=!1,F=!0,z=!0,L=t=D=w=u=c=null,m=g=x=S=d=null},this.clean=function(){R.removeDocument(),V=W=q=null},this.isADocumentDisplayed=function(){return Boolean("Requirement"===f&&E&&E.size||"Document"===f&&S&&S.pages.size)},this.getDocumentRotationAngle=function(){if(S&&S.pages){let e=S.pages.get("1");return e?e.rotationAngle:0}},this.getDocumentType=function(){return f},this.getDocumentBuffer=function(){if(S)return S.buffer},this.getDocumentLoadedID=function(){return d||void 0},this.getExternalComments=function(){if(S)return S.externalComments},this.getPDFHyperlinks=function(){if(S&&S.links)return S.links.filter(function(e){return e.div&&e.content})},this.setTouchPanActive=function(e){U=e},this.getTouchPanActive=function(){return U},this.forceElementsLoad=function(e){if(!e||!E)return;let t=!1;e.forEach(e=>{let n=J(e);n&&(t=!0,n.node||l.renderElement(n,()=>{}),n.pathElement&&n.loaded||(n.toLoad=!0))}),t&&l.updateNodesInSession(L,E)},this.getElementsVisualizationData=function(){let e=S?S.pages:E,t=e.get(l.getElementIdAtIndex(0)),n={visibleElements:[],current:b,elementLength:e.size,type:t?t.type:"page"};for(let t=b-1;t<e.size;t++){let o=e.get(l.getElementIdAtIndex(t));o&&o.visible&&n.visibleElements.push({number:o.number,title:o.title})}return n},this.setMultiPageVisibility=function(e){e!==M&&(M=e,ae(),re(),R.setCurrentElement({elementID:b}))},this.getMultiPageVisibility=function(){return M},this.getElementInfo=function(e){if(!e||!E)return;const t=J(e);return t?{title:t.title,index:l.getElementIndexById(t.pathId)+1,pathElement:t.pathElement}:void 0},this.getElementMatrix=function(e){if(!E&&!S||!e)return null;if("string"==typeof e&&E){let t=J(e);if(t){let e=new i.Vector3(t.coordinates.left,t.marginTop?t.coordinates.top-t.marginTop:t.coordinates.top,0);return(new i.Matrix4).setPosition(e)}}else if("number"==typeof e&&S&&S.pages&&e>=1&&e<=S.document.numPages){let t=S.pages.get(e.toString());if(t){let e=Math.abs(t.height*Math.cos(t.rotationAngle)-t.width*Math.sin(t.rotationAngle)),n=Math.abs(t.height*Math.sin(t.rotationAngle)+t.width*Math.cos(t.rotationAngle)),o=(new i.Matrix4).makeRotationZ(t.rotationAngle),a=new i.Vector3(-t.width/2,t.height/2,0).applyMatrix4(o);return a.add(new i.Vector3(t.coordinates.left+n/2,t.coordinates.top-e/2,0)),(new i.Matrix4).setPosition(a).multiply(o)}}return null},this.getPageRotation=function(e){if(!S||!S.pages||!e||e<1||e>S.document.numPages)return;let t=S.pages.get(e.toString());return t?t.rotationAngle:void 0},this.getPointedElemIDAtPosition=function(e){if(!E&&!S||!e)return;let t=S?S.pages:E,n=1,o=t.size;for(;n<=o;){let i=Math.floor((n+o)/2),a=l.getElementIdAtIndex(i-1),r=t.get(a);if(!r)break;{let t=r.coordinates;if(t.top>e.y&&t.bottom<e.y)return t.left<e.x&&t.right>e.x?S?i:a:void 0;t.top<e.y?o=i-1:n=i+1}}},this.enableTextSelection=function(e){z!==e&&(V.divCssElement.setStyle("display",e?"block":"none"),z=e)},this.setTextSelectionFlag=function(e){if(F!==e){if(F=e,e){let e=".WebDocTextLayer > span:not(.WebDocPageLoadingProgressBar):hover{ cursor: text}",t=document.createElement("style");t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),h=t}else h&&document.getElementsByTagName("head")[0].removeChild(h);R.setLinkActivationFlag(e)}},this.setLinkActivationFlag=function(e){if(H!==e)if(H=e,e)I&&document.getElementsByTagName("head")[0].removeChild(I);else{let e=".WebDocLinkAnnotation { display: none }",t=document.createElement("style");t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),I=t}},this.centerViewpointAtElementPosition=function(e){if(!S&&!E||!e.position)return;let t=e.offsetYPix||0,n=W,o=n.getEyePosition(),a=R.getElementMatrix(e.elementID);if(a){let r=(new i.Vector3).getPositionFromMatrix(a),s=new i.Vector3(e.position.x,e.position.y,0).applyMatrix4(a.setPosition(new i.Vector3)),c=n.getCamera(),d=l.getMMPerPixelRatio(V),u={left:v?v.left*d:0,right:v?v.right*d:0,bottom:v?(v.bottom-t)*d:0},m=s.x+r.x+(u.right-u.left)/(e.centerAtTopLeft?1:2),g=s.y+r.y+u.bottom;e.centerAtTopLeft&&(m+=c.right,g+=c.bottom),n.moveTo({eyePosition:new i.Vector3(m,g,o.z),duration:void 0===e.duration?200:e.duration})}},this.centerViewpointAtNextOrPreviousElement=function(e){if(!S&&!E)return;let t=1,n=S?S.pages:E;if(M&&S&&b<n.size){let e=n.get(l.getElementIdAtIndex(b-1)),o=n.get(l.getElementIdAtIndex(b));if(e&&o){let n=e.coordinates,i=o.coordinates;Math.abs(n.top-i.top)<1e-5&&t++}}let o=b+(e?t:-t);o=o<1?1:o<=n.size?o:n.size;let i=l.getElementIdAtIndex(o-1);R.setCurrentElement({elementID:S?o:i,duration:100})},this.getCurrentElementId=function(){return S?b:l.getElementIdAtIndex(b-1)},this.getElementCoordinates=function(e){if("number"==typeof e){let t=S&&S.pages.get(e.toString());return t?t.coordinates:void 0}if("string"==typeof e){let t=J(e);return t?t.coordinates:void 0}},this.setCurrentElement=function(e){let t,n=W.getEyePosition();if("number"==typeof e.elementID&&e.elementID>=1&&S){let o=S&&S.pages.get(e.elementID.toString());o&&(t=new i.Vector3(n.x,o.coordinates.top-W.getCamera().top,n.z))}else if("string"==typeof e.elementID){let o=J(e.elementID);if(!o)return;t=new i.Vector3(n.x,o.coordinates.top-W.getCamera().top,n.z),o&&o.setAsCurrent()}W.moveTo({eyePosition:t,duration:e.duration||0})},this.reframeOnElements=function(e){if(!S&&!E)return;let t=W.getCamera(),n=W.getEyePosition(),o=l.getMMPerPixelRatio(V),a=v?v.left*o:0,r=v?v.right*o:0,s=v?v.bottom*o:0,c=t.top,d=t.bottom+s,u=t.left+a,m=t.right-r,g=-1/0,f=1/0,h=1/0,p=-1/0,b=!1;if(e.forEach(e=>{var t,n;let o=S?null===(t=S.pages.get(e))||void 0===t?void 0:t.coordinates:null===(n=J(e))||void 0===n?void 0:n.coordinates;o&&(b=!0,g=Math.max(g,o.top),f=Math.min(f,o.bottom),h=Math.min(h,o.left),p=Math.max(p,o.right))}),b){let e,t,o,l=(r-a)/2;Math.abs((m-u)/(p-h))<Math.abs((c-d)/(g-f))?(t=g-(c-d)/2*((p-h)/(m-u)),e=n.z*(p-h)/(m-u),o=W.getTargetDistance()*(p-h)/(m-u)):(t=(g+f)/2,e=n.z*(g-f)/(c-d),o=W.getTargetDistance()*(g-f)/(c-d)),N=!0,W.moveTo({eyePosition:new i.Vector3(l,t,e),distanceToTarget:o,duration:400})}},this.fitCurrentElement=function(e=!1){var t;if(S||E)if(e){let e=W.getCamera(),n=l.getMMPerPixelRatio(V),o={left:v?v.left*n:0,right:v?v.right*n:0,bottom:v?v.bottom*n:0},a={top:e.top,bottom:e.bottom+o.bottom,left:e.left+o.left,right:e.right-o.right},r=W.getEyePosition(),s=(S?l.getMaxWidth(S.pages,b-1):null===(t=E.get(l.getElementIdAtIndex(0)))||void 0===t?void 0:t.width)||0;W.moveTo({eyePosition:new i.Vector3((o.right-o.left)/2,r.y,r.z*s/(a.right-a.left)),distanceToTarget:W.getTargetDistance()*s/(a.right-a.left),duration:400})}else{let e=l.getElementIdAtIndex(b-1);R.reframeOnElements([e])}},this.setDocumentRotationAngle=function(e){if(!S||!S.pages)return;let t=(new i.Matrix4).makeRotationZ(e),n=0;S.pages.forEach(function(o){o.rotationAngle=e;let a=Math.abs(o.height*Math.cos(e)-o.width*Math.sin(e)),r=Math.abs(o.height*Math.sin(e)+o.width*Math.cos(e));if(o.coordinates.top=n,o.coordinates.bottom=n-a,o.coordinates.right=r/2,o.coordinates.left=-r/2,n-=a+4,o.node){let e=new i.Vector3(-o.width/2,-o.height/2,0).applyMatrix4(t);e.add(new i.Vector3(0,o.coordinates.bottom+a/2,0)),o.node.setMatrix((new i.Matrix4).setPosition(e).multiply(t))}}),V.render(),R.setCurrentElement({elementID:b}),$("onDocumentRotationAngleChange",{rotationAngle:e})},this.getDocumentBookmarks=function(){return(S?S.bookmarks:D)||[]},this.getDocumentLength=function(){return S?S.document.numPages:E?E.size:0},this.getLoadedReqElement=function(){return T},this.setRequirementCompareData=function(e){k={firstReqData:e.firstReqData,secondReqData:e.secondReqData},e&&e.firstReqData&&e.secondReqData&&l.setCompareReqIDList(e.firstReqData,e.secondReqData),V&&V.render()},this.subscribe=function(e,t){return e&&t?Z.subscribe({event:e},t):""},this.unsubscribe=function(e){null!=e&&Z.unsubscribe(e)}}}let d=[];return class{static getWebDocumentVisualizationController(e={context:null}){let t;for(let n=0;n<d.length;n++)if(d[n].context===e.context)return t=d[n].controller,d[n].count++,t;let n=new c(e);return(t=Object.freeze({isLoading:()=>!!n&&n.isLoading(),loadDocumentStream:e=>{if(n)return n.loadDocumentStream(e)},enableTextSelection:e=>{if(n)return n.enableTextSelection(e)},forceElementsLoad:e=>{n&&n.forceElementsLoad(e)},getDocumentType:()=>n?n.getDocumentType():null,getElementInfo:e=>{if(n)return n.getElementInfo(e)},getElementMatrix:e=>{if(n)return n.getElementMatrix(e)},getPageRotation:e=>{if(n)return n.getPageRotation(e)},getPointedElemIDAtPosition:e=>{if(n)return n.getPointedElemIDAtPosition(e)},getDocumentLoadedID:()=>{if(n)return n.getDocumentLoadedID()},getElementsVisualizationData:()=>{if(n)return n.getElementsVisualizationData()},getDocumentBookmarks:()=>{if(n)return n.getDocumentBookmarks()},getDocumentRotationAngle:()=>{if(n)return n.getDocumentRotationAngle()},getExternalComments:()=>{if(n)return n.getExternalComments()},getPDFHyperlinks:()=>{if(n)return n.getPDFHyperlinks()},getTouchPanActive:()=>{if(n)return n.getTouchPanActive()},setTouchPanActive:e=>{if(n)return n.setTouchPanActive(e)},setDocumentRotationAngle:e=>{if(n)return n.setDocumentRotationAngle(e)},getMultiPageVisibility:()=>{if(n)return n.getMultiPageVisibility()},setMultiPageVisibility:e=>{if(n)return n.setMultiPageVisibility(e)},getCurrentElementId:()=>{if(n)return n.getCurrentElementId()},getElementCoordinates:e=>{if(n)return n.getElementCoordinates(e)},setCurrentElement:e=>{if(n)return n.setCurrentElement(e)},setTextSelectionFlag:e=>{if(n)return n.setTextSelectionFlag(e)},setLinkActivationFlag:e=>{if(n)return n.setLinkActivationFlag(e)},isADocumentDisplayed:()=>!!n&&n.isADocumentDisplayed(),getDocumentBuffer:()=>{if(n)return n.getDocumentBuffer()},getDocumentLength:()=>{if(n)return n.getDocumentLength()},getLoadedReqElement:()=>{if(n)return n.getLoadedReqElement()},setRequirementCompareData:e=>{if(n)return n.setRequirementCompareData(e)},centerViewpointAtElementPosition:e=>{if(n)return n.centerViewpointAtElementPosition(e)},centerViewpointAtNextOrPreviousElement:e=>{if(n)return n.centerViewpointAtNextOrPreviousElement(e)},fitCurrentElement:e=>{if(n)return n.fitCurrentElement(e)},reframeOnElements:e=>{if(n)return n.reframeOnElements(e)},subscribe:(e,t)=>n?n.subscribe(e,t):"",unsubscribe:e=>{if(n)return n.unsubscribe(e)},removeDocument:()=>{if(n)return n.removeDocument()},getSelectedElementIDs:()=>n?n.getSelectedElementIDs():[],clean:()=>{n&&(n.clean(),n=null)}}))&&d.push({context:e.context,controller:t,count:1}),t}static giveWebDocumentVisualizationController(e){if(e&&e.context)for(let t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].controller}static unreferenceWebDocumentVisualizationController(e){if(e&&e.context)for(let t=0;t<d.length;t++)if(d[t].context===e.context){d[t].count--,0===d[t].count&&(d[t].controller.clean(),d.splice(t,1));break}}}}),define("DS/WebDocumentVisualization/WebDocumentBookmarksController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/Visualization/ThreeJS_DS","DS/WebDocumentVisualizationUI/WebDocumentBookmarksPanel","DS/WebDocumentVisualization/WebDocumentVisualizationController"],function(e,t,n,o,i,a){"use strict";class r{constructor(e){let t,r,l,s,c,d=e.context;function u(){let e=a.giveWebDocumentVisualizationController({context:d});if(e&&t&&!l){let n=e.getCurrentElementId();if("number"==typeof n){let o=e.getElementCoordinates(n);o&&t.highlightBookmark({pageNumber:n,yCoordinate:d.getViewpoint().getEyePosition().y+d.getViewpoint().getCamera().top-o.bottom})}else"string"==typeof n&&t.highlightBookmark({elementId:n})}}this.displayBookmarksPanel=function(){let e=a.giveWebDocumentVisualizationController({context:d});if(e){if(c=e.subscribe("onScrollChange",function(e){"start"!==e.type&&(u(),"end"===e.type&&(l=!1))}),t||(t=new i,r||(r={onBookmarkSelected:t.subscribe("onBookmarkSelected",function(t){if(t&&t.target&&e){if(l=!0,t.target.pointedPosition){let n=e.getElementCoordinates(t.target.pointedPage);n&&e.centerViewpointAtElementPosition({elementID:t.target.pointedPage,position:new o.Vector3(t.target.pointedPosition.x,t.target.pointedPosition.y-(n.top-n.bottom),0),duration:0,centerAtTopLeft:!0})}else e.setCurrentElement({elementID:t.target.pointedPage||t.target.pointedId});(t.target.fitAllIn||t.target.fitWidth)&&setTimeout(function(){l=!0,e&&e.fitCurrentElement(t.target.fitWidth)}),s.isSmallWidth()&&s.collapsePanel()}}),onBookmarkExpanded:t.subscribe("onBookmarkExpanded",u)})),!s){let o=e.getDocumentBookmarks();if(o){let e=t.buildPanel(o);const i=300,a=160,r=250;(s=new n({id:"WebDocBookmarksPanel",className:"WebDocBookmarksPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-bookmark",immersiveFrame:d.getFrameWindow().getImmersiveFrame(),viewerFrame:d.getFrameWindow().getViewerFrame(),content:e,minWidth:r,width:i,minHeight:a,height:a,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea})).ensureVisible()}}u()}},this.setPanelVisibilityFlag=function(e){s&&e!==s.getPanelVisibilityFlag()&&s.setPanelVisibilityFlag(e)},this.destroyBookmarksPanel=function(){if(c){let e=a.giveWebDocumentVisualizationController({context:d});e&&e.unsubscribe(c)}if(t&&r){Object.keys(r).forEach(function(e){t&&r&&t.unsubscribe(r[e])}),t.cleanPanel()}s&&(s.setPanelVisibilityFlag(!1),s.clean()),t=s=r=c=null},this.clean=function(){this.destroyBookmarksPanel(),d=null}}}let l=[];return class{static getWebDocumentBookmarksController(e){let t;for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller,l[n].count++,t;let n=new r(e);return t=Object.freeze({displayBookmarksPanel:()=>{n&&n.displayBookmarksPanel()},setPanelVisibilityFlag:e=>{n&&n.setPanelVisibilityFlag(e)},destroyBookmarksPanel:()=>{n&&n.destroyBookmarksPanel()},clean:()=>{n&&(n.clean(),n=null)}}),l.push({context:e.context,controller:t,count:1}),t}static giveWebDocumentBookmarksController(e){let t;if(e&&e.context)for(let n=0;n<l.length;n++)if(l[n].context===e.context)return t=l[n].controller}static unreferenceWebDocumentBookmarksController(e){if(e&&e.context)for(let t=0;t<l.length;t++)l[t].context===e.context&&(l[t].count--,0===l[t].count&&(l[t].controller.clean(),l.splice(t,1)))}}});