define("DS/Web3DXCityFoundation/Geocoder",["DS/Visualization/ThreeJS_DS","DS/WebappsUtils/WebappsUtils","VENProj4js-2.7.2/js/proj4"],function(t,o,e){"use strict";var n=null;function r(){if(null!==n)throw new Error("Cannot instantiate more than one MySingleton, use MySingleton.getInstance()");this.initialize()}return window.Proj4js||(window.Proj4js=e),r.getInstance=function(){return null===n&&(n=new r),n},r.projList={},r.prototype={initialize:function(){this.baseURL="",this.earthRadius=6378137,this.defaultProjection="EPSG:900913",this.projections={}},setBaseUrl:function(t,o){this.baseURL=t;var e=!0,n=2,r=function(t){e&=t,0===--n&&void 0!==o&&o(e)};this.loadProjection("WGS84",r.bind(this)),this.loadProjection("EPSG:900913",r.bind(this))},setDefaultProjection:function(t,o){this.defaultProjection=t,this.loadProjection(this.defaultProjection,o)},getDefaultProjection:function(){return this.defaultProjection},getProjectProjection:function(){return this.defaultProjection},projectionReady:function(t){var o=r.getInstance().projections[t];return void 0!==o&&1===o.ready},loadProjection:function(t,n,i){var a,s,c,l,d=function(o){var n,a;if(a=r.getInstance().projections[t],o&&void 0===a.proj4js){var s=t;!0!==i&&(s=e.defs[t],e.defs(t,s)),a.proj4js=new e.Proj(s,function(t,o){null===t&&(a.proj4js=o,d(!0))})}for(o?console.log("GEOCODER:loadProjection -> Projection "+t+" LOADED"):console.error("GEOCODER:loadProjection -> FAILLED to load projection "+t),a.ready=o?1:-1,n=0;n<a.cb.length;++n)void 0!==a.cb[n]&&a.cb[n](o);a.cb=[]};if(void 0===this.projections[t])if(this.projections[t]={ready:0,cb:[n]},l=d.bind(this),function(o){var n=r.getInstance().projections[t];n.proj4js=new e.Proj(t,function(t,o){null===t&&(n.proj4js=o,d(!0))})}.bind(this),i)l(!0);else try{for(c in(s={}).type="text/javascript",s.src=o.getWebappsBaseUrl()+"VENProj4js/defs/"+t.replace(/:/gi,"")+".js",a=document.createElement("script"),s)a[c]=s[c];return a.onerror=function(){l(!1)},a.onload=function(){l(!0)},a.onreadystatechange=function(){"complete"!==a.readyState&&"loaded"!==a.readyState||l(!0)},document.getElementsByTagName("head")[0].appendChild(a),!0}catch(t){return l(!1),!1}else switch(this.projections[t].ready){case 0:this.projections[t].cb.push(n);break;case 1:void 0!==n&&n(!0);break;default:void 0!==n&&n(!1)}},projForWebWorker:function(o,n,r,i,a,s){var c;return void 0!==o.x&&void 0!==o.y?c=new t.Vector3(o.x,o.y):void 0!==o.lat&&void 0!==o.lon?c=new t.Vector3(o.lon,o.lat):o instanceof Array&&o.length>=2&&(c=new t.Vector3(o[0],o[1])),n&&""!==n||(n=this.defaultProjection),i&&""!==i||(i=this.defaultProjection),n!==i&&(!s||"WGS84"!==n&&"EPSG:4326"!==n&&"EPSG:4329"!==n||(c.x=Utils.toDeg(c.x),c.y=Utils.toDeg(c.y)),c=e.transform(r,a,c),!s||"WGS84"!==i&&"EPSG:4326"!==i&&"EPSG:4329"!==i||(c.x=Utils.toRad(c.x),c.y=Utils.toRad(c.y))),c},proj:function(o,n,r,i){var a;if(void 0!==o.x&&void 0!==o.y?a=new t.Vector3(o.x,o.y):void 0!==o.lat&&void 0!==o.lon?a=new t.Vector3(o.lon,o.lat):o instanceof Array&&o.length>=2&&(a=new t.Vector3(o[0],o[1])),n&&""!==n||(n=this.defaultProjection),this.loadProjection(n),r&&""!==r||(r=this.defaultProjection),this.loadProjection(r),n!==r){if(!i||"WGS84"!==n&&"EPSG:4326"!==n&&"EPSG:4329"!==n||(a.x=Utils.toDeg(a.x),a.y=Utils.toDeg(a.y)),this.projections[n].ready>0&&this.projections[r].ready>0){var s=this.projections[n].proj4js,c=this.projections[r].proj4js;a=e.transform(s,c,a)}!i||"WGS84"!==r&&"EPSG:4326"!==r&&"EPSG:4329"!==r||(a.x=Utils.toRad(a.x),a.y=Utils.toRad(a.y))}return a},latlonToMercator:function(t,o,e){return this.proj([o,t],"WGS84","EPSG:900913",e)},mercatorToLatlon:function(t,o,e){return this.proj([t,o],"EPSG:900913","WGS84",e)},proj2worldMatrix:function(o,e,n){var r=this.earthRadius+(void 0!==o.z?o.z:0),i=this.toGeographic(this.proj(o,e,"EPSG:900913",n),!0),a=r*Math.cos(i.y),s=a*Math.cos(i.x),c=a*Math.sin(i.x),l=r*Math.sin(i.y),d=(new t.Matrix4).makeRotationY(.5*Math.PI-i.y);return(new t.Matrix4).makeRotationZ(i.x).multiply(d).multiply((new t.Matrix4).makeRotationZ(.5*Math.PI)).setPosition(new t.Vector3(s,c,l))},proj2world:function(o,e,n){var r=new t.Vector3;return r.getPositionFromMatrix(this.proj2worldMatrix(o,e,n)),r},world2proj:function(t,o,e){var n=Math.atan2(t.z,Math.sqrt(t.y*t.y+t.x*t.x)),r=Math.atan2(t.y,t.x);return e||(n=Utils.toDeg(n),r=Utils.toDeg(r)),this.proj([r,n],"WGS84",o,e)},computeMercatorScaleFactor:function(t,o,e,n){if(!this.projectionReady(e))return 1;var r=this.proj([t,o],e,"WGS84",n);return n?Math.min(100,Math.max(1,1/Math.cos(r.y))):Math.min(100,Math.max(1,1/Math.cos(Utils.toRad(r.y))))},reverseGeocodingAt:function(t,o,e){e||(e=this.defaultProjection);var n=this.proj2D([t,o],"WGS84",e),r="http://nominatim.openstreetmap.org/reverse?format=json&lat="+n.y+"&lon="+n.x+"&zoom=18&addressdetails=1";return UWA.Ajax.request(r,{async:!1,cors:!0,onComplete:function(t){return JSON.parse(t).display_name}}),"nowhere"},toGeographic:function(t,o){var e=57.29577951308232*(t.x/6378137),n=e-360*Math.floor((e+180)/360),r=57.29577951308232*(1.5707963267948966-2*Math.atan(Math.exp(-1*t.y/6378137)));return r>85?r=90:r<-85&&(r=-90),o?{y:Utils.toRad(r),x:Utils.toRad(n)}:{y:r,x:n}},getLandPositionFromName:function(o,e,n,r){var i="http://nominatim.openstreetmap.org/search?q="+o+"&format=json";UWA.Ajax.request(i,{cors:!0,onComplete:function(o){if(void 0===JSON.parse(o)[0])return console.error("Error: Destination request failed!"),void n(void 0);e||(e=this.defaultProjection);var i=void 0;i=r?new t.Vector2(p.x,p.y):new t.Vector2(p.x,p.y,0),n(i)},onFailure:function(){n(void 0)}})}},r.getInstance()});