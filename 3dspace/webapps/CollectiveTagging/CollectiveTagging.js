/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
define("DS/CollectiveTagging/CollectiveTaggingHelpers",["UWA/Core","UWA/Class","UWA/Class/Debug","UWA/Promise","UWA/Element","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/UIKIT/Input/Button","DS/Controls/Editor","DS/TagNavigator/userTags/UserTagsModel","DS/TagNavigator/userTags/UserTagsView","DS/TagNavigator/userTags/utils/UserTagsUtils","DS/SNInfraUX/SearchUtils","DS/SNInfraUX/Logger","DS/SNResultUX/utils/SearchServices","DS/SNResultUX/utils/ExternalComponentHelpers","i18n!DS/SNResultUX/assets/nls/SNResultUX.json"],function(e,t,i,n,s,o,r,a,l,c,u,d,g,m,_,f,h){"use strict";let T=t.singleton(i,{_urlAddIdea:"/api/idea/add",_communityGet:"/api/community/get",_swymURLPromise:null,_3DSearchURLPromise:null,_CsrfTokenPromise:null,_communityIdPromise:null,_CsrfToken:void 0,_communityId:"",_modal:null,init:function(){m.log("DS/CollectiveTagging/CollectiveTaggingHelpers Init"),this._swymURLPromise=T._getSericeURLPromise("3DSwym"),this._3DSearchURLPromise=T._getSericeURLPromise("3DSearch"),this._CsrfTokenPromise=T._getCsrfTokenPromise(),this._communityIdPromise=T._communityIdPromise()},displayModalAddTag:function(e){this._currentTab="add",this._buildModalTag(e)},requestRemoveTag:function(e){this._currentTab="remove",this._sendrequest(e)},getCsrfTokenPromise:function(){return this._CsrfTokenPromise},getCommunityIdPromise:function(){return this._communityIdPromise},addNewTagIdea:function(e,t,i,s){let r=this;return new n(function(n,a){let l={};T._getswymSericeURLPromise().then(function(c){let u=c+r._urlAddIdea,d={"X-DS-SWYM-CSRFTOKEN":e,"content-type":"application/json;charset=UTF-8"},g={params:{community_id:t,title:i,message:s,published:1}},m={method:"POST",type:"json",timeout:12e4,headers:d,data:l=JSON.stringify(g),onComplete:n,onFailure:function(e,t){a(e,t)}};o.authenticatedRequest(u,m)})})},_getswymSericeURLPromise:function(){return this._swymURLPromise},_get3DSearchSericeURLPromise:function(){return this._3DSearchURLPromise},_getCsrfTokenPromise:function(){let e=this;return new n(function(t,i){T._getswymSericeURLPromise().then(function(n){let s=n+"/api/index/tk",r={method:"GET",type:"json",onComplete:function(i){let n=i.result.ServerToken;UWA.is(n,"string")&&(e._CsrfToken=n,t(e._CsrfToken))},onFailure:function(e,t){i(e,t)}};o.authenticatedRequest(s,r)})})},_getSericeURLPromise:function(e){let t=this;return new n(function(i,n){let s=t._getTenant();r.getServiceUrl({serviceName:e,platformId:s,onComplete:function(s){s?("3DSwym"===e&&(t._swymUrl=s),i(s)):n()},onFailure:function(e){n(e)}})})},_communityIdPromise:function(){let t=this;return new n(function(i,n){let s='[ds6w:type]:"swym:Community" AND ';s+="(",s+='[ds6w:label]:"'+h.get("Company_Community_Name")+'"',s+=")";let r=t._getFedSearchServiceData({query:s,source:["swym"],order_by:"asc",order_field:"ds6w:label",nresults:1});T._get3DSearchSericeURLPromise().then(function(n){r.onComplete=function(n){let s=JSON.parse(n);e.is(s)&&e.is(s.results,"array")&&(t._communityId=s.results[0].attributes[0].value,i(t._communityId),m.log("DS/CollectiveTagging/CollectiveTaggingHelpers _getCommunityIdFromTitle: ",t._communityId))},o.authenticatedRequest(n+"/search",r)})})},_getFedSearchServiceData:function(e){return{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},data:JSON.stringify({with_indexing_date:!0,with_nls:!1,label:"label-1574068635089",locale:window&&window.dsLang?window.dsLang:"en",query:e.query,refine:e.refine?e.refine:{},specific_source_parameter:e.specific_source_parameter,select_predicate:["ds6w:label","ds6w:description"],source:e.source,tenant:this._getTenant(),nresults:e.nresults?e.nresults:1,order_by:e.order_by,order_field:e.order_field,start:0,with_synthesis:!0}),onComplete:function(e,t){}}},_getTenant:function(){return g.getActiveTenant()},_buildModalTag:function(t){if(!e.is(t))return;let i=this;f.modal({title:h.get("collectiveTagging.title"),content:this._buildaddTagTab(t),CB:[{buttonKind:"ok",label:h.get("collectiveTagging.sendButton"),function:()=>{i._sendrequest(t),f.destroyModal()}},{buttonKind:"cancel"}]})},_buildaddTagTab:function(t){if(!e.is(t))return;let i=s.create("div",{class:"collectiveAddTag"}),n=s.create("div",{class:"collectiveAddTagText"});n.inject(i);let o=s.create("span",{class:"collectiveAddTagText-text"});o.setText(h.get("collectiveTagging.addTagsText")),o.inject(n),this._buildaddTagForm(t).inject(n);let r=s.create("div",{class:"collectiveAddTagDescription"});return r.inject(i),(o=s.create("span",{class:"collectiveAddTagText-text"})).setText(h.get("collectiveTagging.addTagsDesc")),o.inject(r),this._description=new l({placeholder:h.get("collectiveTagging.addPlace"),requiredFlag:!1,nbRows:4,newLineMode:"enter"}),this._description.inject(r),i},_sendrequest:function(t){let i=this;T.getCsrfTokenPromise().then(function(n){T.getCommunityIdPromise().then(function(s){let o=[],r=1;e.is(t.object_ids)?r=(o=t.object_ids).length:o.push(t.object_id);let a=0,l=!1;for(;a<r;a++){let r,c,u=o[a];if(t.object_id=u,"add"===i._currentTab){let t=i._userTagsView._autoComplete;if(e.is(t)){let e=t.value;r=h.get("collectiveTagging.addRequest");let n=e.length;for(let t=0;t<n;t++){r+=e[t],r+=" "}c=i._description.value}}else if("remove"===i._currentTab){let i=t._userTagsView._autoComplete;if(e.is(i)){let e=i.value;r=h.get("collectiveTagging.removeRequest");let n=e.length;for(let t=0;t<n;t++){r+=e[t],r+=" "}c=t._description.value}}c+="<br>",c+='<span class="labelAddTagRequest" style="font-weight: bold">'+h.get("collectiveTagging.addobjecturl")+"</span>";let d=decodeURI(i._buildLink(t));c+=d='<a href="'+d+'">'+d+"</a>",T.addNewTagIdea(n,s,r,c).then(function(e){!1===l&&(_._displayAlert({message:h.get("collectiveTagging.commit"),className:"success"}),l=!0)})}})})},_buildLink:function(t){if(!e.is(t))return;let i="/#",n="/",s=this._communityId.split(":");s.length>2&&(i+=s[s.length-2],i+=":",i+=s[s.length-1]);let o=t.object_id.split(":");return o.length>2&&(n+=o[o.length-2],n+=":",n+=o[o.length-1]),this._swymUrl+i+n},_buildaddTagForm:function(e){var t=s.create("form",{class:"formAddTag"}),i=s.create("div",{class:"divAddTag"});i.inject(t);let n=e.actionsHelper.getPlatformID({id:e.object_ids[0]}),o=[],r=e.object_ids,a=[];for(let t of r)a.push(e.collection.get(t));o=g.getTaggerSubjectURIForMultipleSources(a,n);var l=new c({subjects:o,applicativeSuggestions:[],platformId:n,readOnly:!1});let m=e.collection.search_ressources.getActiveTenant(),_=this._getContainerId(a);if(1==this._getSubjectUriCount(o)&&_){let e={appName:"3DSearch",currentUser:g.getUserId(),platformId:m,vocabSuggestions:!1,communityTags:!0,communityId:_};d.getSuggestionsFor3DSwymContent(e).then(function(e){UWA.is(e,"object")&&UWA.is(e.suggestions,"array")&&l.set("applicativeSuggestions",e.suggestions)})}return this._userTagsView=new u({model:l,suggestsInfo:{placeHolder:h.get("add_tag.add_tag_default_text"),filterMessage:"customFilterMessage...",allowFreeText:!0,vocabSuggestions:!0},manageDirtyState:!0,onCommit:this._actionOnCommit.bind(this),onFailure:this._actionOnFailure.bind(this),onSuggestDisplayed:function(){},touchMode:!1,onSelectionChange:T._onSelectionChangeInView.bind(this)}).render().inject(i),t},_actionOnCommit:function(){},_actionOnFailure:function(){},_onSelectionChangeInView:function(e){this.okBtn&&(e>0?this.okBtn.enable():this.okBtn.disable())},_getContainerId:function(t){let i;for(let n of t)if(i=n.get("ds6w:containerUid"),e.is(i))break;return i},_getSubjectUriCount:function(e){return e.filter(e=>e.uri).length},destroy:function(){this._parent()}});return T});