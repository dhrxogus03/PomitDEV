define("DS/TerminologySelector/service/TerminologyWebService",["DS/IPClassifyActive/service/IPClassifyActiveWebService","text!DS/TerminologySelector/assets/Terminology_setting.json","DS/WidgetServices/WidgetServices","DS/IPClassifyUtil/IPClassifyAlert","i18n!DS/TerminologySelector/assets/nls/TerminologySelector","text!DS/TerminologySelector/assets/config/webservices.conf.json","DS/BrowsingStructureAPI/service/BrowsingStructureAPI"],function(e,t,n,o,i,s,r){"use strict";var a=JSON.parse(s);const l=["VPMInstance","VPMReference"];var c=null,d=Object.assign({},e);d.get3DSearchUrl=function(){return new Promise(function(e,t){n.get3DSearchUrlAsync({onComplete:e,onFailure:t})})},d.attachTerminology=function(e){var t={};UWA.extend(t,e);var n=e.csrfValue,o=e.spaceUrl,i=e.attachTerm?a.attachTerm:a.attachTerminology,s=o+i.replace(new RegExp("{ID}","g"),e.terminologyID);return t.method="PATCH",t.headers={Accept:"application/json","content-type":"application/json","Accept-Language":widget.lang?widget.lang:widget.getValue("lang"),SecurityContext:this.getSecurityContext(),ENO_CSRF_TOKEN:n},t.type="json",t.payload=[],e.itemsID.forEach(function(n){var i={identifier:n,relativePath:"/resources/v1/modeler/dseng/dseng:EngItem/"+n,type:e.isInstance?"VPMInstance":"VPMReference",source:o};t.payload.push(i)}),t.data=UWA.Json.encode(t.payload),this._executeRequest(s,t,"attachTerminologies")},d.updateNodes=function(e){return r.updateNodes(e)},d.attachTerminologies=function(e){var t=this;return UWA.extend({},e),t.get3DSpaceUrl().then(function(n){return new Promise(function(o,i){var s=n;t.createCSRFTokens({onComplete:function(n){var i=JSON.parse(n).csrf.value;e.onComplete=e.onComplete||function(){},e.onFailure=e.onFailure||function(){};var r={csrfValue:i,spaceUrl:s,terminologyID:"",itemsID:e.itemsID,isInstance:e.isInstance},a=[];e.terminologiesId&&e.terminologiesId.forEach(function(n,o){r.terminologyID=n,r.attachTerm=!1,a.push(new Promise(function(n,o){r.onComplete=function(t){e.onComplete.call(this,t),n(t)},r.onFailure=function(t){e.onFailure.call(this,t),o({error:t,id:r.terminologyID})},t.attachTerminology(r)}))}),e.termsId&&e.termsId.forEach(function(n,o){r.terminologyID=n,r.attachTerm=!0,a.push(new Promise(function(n,o){r.onComplete=function(t){e.onComplete.call(this,t),n(t)},r.onFailure=function(t){e.onFailure.call(this,t),o({error:t,id:r.terminologyID})},t.attachTerminology(r)}))}),Promise.allSettled(a).then(function(e){let t=e.filter(function(e){return"fulfilled"===e.status}).map(function(e){return{id:e.value.member[0].id,title:e.value.member[0].title,name:e.value.member[0].name}}),n=e.filter(function(e){return"rejected"===e.status}).map(function(e){return{id:e.reason.id}});o({success:t,error:n})})},onFailure:function(e){i(e)}},s)})})},d.detachTerminology=function(e){var t={};UWA.extend(t,e);var n=e.csrfValue,o=e.spaceUrl,i=e.detachTerm?a.detachTerm:a.detachTerminology,s=o+i.replace(new RegExp("{ID}","g"),e.terminologyID);return t.method="PATCH",t.headers={Accept:"application/json","content-type":"application/json","Accept-Language":widget.lang?widget.lang:widget.getValue("lang"),SecurityContext:this.getSecurityContext(),ENO_CSRF_TOKEN:n},t.type="json",t.payload=[],e.itemsID.forEach(function(n){var i={identifier:n,relativePath:"/resources/v1/modeler/dseng/dseng:EngItem/"+n,type:e.isInstance?"VPMInstance":"VPMReference",source:o};t.payload.push(i)}),t.data=UWA.Json.encode(t.payload),this._executeRequest(s,t,"detachTerminologies")},d.detachTerminologies=function(e){var t=this;return UWA.extend({},e),t.get3DSpaceUrl().then(function(n){return new Promise(function(o,i){var s=n;t.createCSRFTokens({onComplete:function(n){var i=JSON.parse(n).csrf.value;e.onComplete=e.onComplete||function(){},e.onFailure=e.onFailure||function(){};var r={csrfValue:i,spaceUrl:s,terminologyID:"",itemsID:e.itemsID,isInstance:e.isInstance},a=[];e.terminologiesId&&e.terminologiesId.forEach(function(n,o){r.terminologyID=n,r.detachTerm=!1,a.push(new Promise(function(n,o){r.onComplete=function(t){e.onComplete.call(this,t),n(t)},r.onFailure=function(t){e.onFailure.call(this,t),o({error:t,id:r.terminologyID})},t.detachTerminology(r)}))}),Promise.allSettled(a).then(function(e){let t=e.filter(function(e){return"fulfilled"===e.status}).map(function(e){return{id:e.value.member[0].id,title:e.value.member[0].title,name:e.value.member[0].name}}),n=e.filter(function(e){return"rejected"===e.status}).map(function(e){return{id:e.reason.id}});o({success:t,error:n})})},onFailure:i},s)})})},d.getResultIntersectionOfTerminologies=function(e,t){t=t||!1;var n=e.member,o=[];if(n&&n.length>1)o=n.map(function(e){var n=t?e.browsingNodes:e.browsingStructures,o=[];return n&&n.member&&n.member.length>0&&(o=n.member.map(function(e){return e.identifier})),o}).reduce(function(e,t){return e.filter(function(e){return t.includes(e)})});else if(n&&1===n.length){var i=t?n[0].browsingNodes:n[0].browsingStructures;i&&i.member&&i.member.length>0&&(o=i.member.map(function(e){return e.identifier}))}return o.slice()},d.getAssociatedTermsPerInstance=function(e){return new Promise(function(t){d.getAssociatedTerminologies({itemsID:e.itemsID,isInstance:!0,onComplete:function(e){var n=[];let o=[];e&&(n=d.getResultIntersectionOfTerminologies(e,!0),e.member&&e.member.forEach(e=>{o[e.id]=e.browsingNodes.member.map(e=>e.identifier)})),t({intersection:n,nodesPerInstances:o})},onFailure:function(e){t({intersection:[],nodesPerInstances:{}})}})})},d.getAssociatedTerminologies=function(e){var t=this,n={};UWA.extend(n,e);var o=e.isInstance;return t.get3DSpaceUrl().then(function(i){var s=i;t.createCSRFTokens({onComplete:function(i){var r=JSON.parse(i).csrf.value,l=o?a.locateTerm:a.locateTerminology,c=s+l;n.method="POST",n.headers={Accept:"application/json","content-type":"application/json","Accept-Language":widget.lang?widget.lang:widget.getValue("lang"),SecurityContext:t.getSecurityContext(),ENO_CSRF_TOKEN:r},n.type="json",n.payload=[],e.itemsID.forEach(function(t){var o={identifier:t,relativePath:"/resources/v1/modeler/dseng/dseng:EngItem/"+t,type:e.isInstance?"VPMInstance":"VPMReference",source:s};n.payload.push(o)}),n.data=UWA.Json.encode(n.payload);t._executeRequest(c,n,"getAssociatedTerminologies")},onFailure:e.onFailure},s)})},d.getSearchQuery=function(){return'type: "Terminology" AND [ds6w:status]: "Terminology.Released"'},d.getType_filter_bo=function(){return["Terminology","Term"]},d.getLabel=function(e){return"ActiveTerminology-"+(window.top.dsUserLogin?window.top.dsUserLogin:"unknown")+"-"+(new Date).getTime()},d.getSetting=function(){return JSON.parse(t)},d.fetchObjectsForFindInTree=function(e){var t=this,n=[];if(n.push(t.get3DSearchUrl()),this.getSecurityContext()||n.push(this.initSecurityContext()),!UWA.is(e,"object"))throw new Error("Invalid inputs for TerminologyWebService.fetchObjectsForFindInTree");t=this;var o={};UWA.extend(o,e),Promise.allSettled(n).then(function(n){var i=n[0].value+"/search",s=widget.lang?widget.lang:widget.getValue("lang");o.payload={},o.payload.locale=s,e.searchFTSquery&&(o.payload.query="[ds6w:label]:(*"+e.searchFTSquery+"*)"),e.rscIdToSearch&&(o.payload.query="physicalid:"+e.rscIdToSearch),o.payload.select_bo=["physicalid","ds6w:type","ds6w:globalType","ds6w:label"],"TermSection_All"===e.type?o.payload.specific_source_parameter={"3dspace":{search_in_context:{expand:{root_path_physicalid:e.pid,type_filter_bo:["Terminology","Term"]}}}}:o.payload.specific_source_parameter={"3dspace":{search_in_context:{expand:{root_physicalid:e.pid,type_filter_bo:["Terminology","Term"]}}}},o.payload.nresults=100,o.payload.source=["3dspace"],o.payload.login={"3dspace":{SecurityContext:t._securityContext}};var r=new Date,a=window.top.dsUserLogin?window.top.dsUserLogin:"unknown";return o.payload.label=("TerminologyFetchObjectsForFindInTree_"+a+"_"+r.getTime()).replace(new RegExp(" ","g"),"_").replace(new RegExp(",","g"),"").replace(new RegExp("/","g"),"-"),o.timeout=12e4,o.method="POST",o.payload.tenant=t.getTenantID(),o.headers={Accept:"application/json","content-type":"application/json","Accept-Language":s,SecurityContext:t.getSecurityContext()},o.type="json",o.data=UWA.Json.encode(o.payload),t._executeRequest(i,o,"_fetchObjectsForFindInTree")})},d.createCSRFTokens=function(e,t){var n=e,o=t+"/resources/v1/application/CSRF";n.method="GET",this._executeRequest(o,n,"TerminologyAssociation-createCSRFToken")},d.searchTerminologies=function(e){var t={};if(UWA.extend(t,e),!UWA.is(t,"object"))throw new Error("Invalid inputs for TerminologyWebService.searchTerminologies");var n=e.searchTerms?'type: "Term" AND [ds6w:status]: "Term.Released" ':'type: "Terminology" AND [ds6w:status]: "Terminology.Released"',o=this;o.get3DSearchUrl().then(function(i){var s=i+"/search",r=widget.lang?widget.lang:widget.getValue("lang");t.payload={with_nls:!1,with_indexing_date:!0,select_predicate:["ds6w:label","ds6w:created","ds6w:reservedBy","relcount","taxonomies","ds6w:classification","icon_2ddefaultthb.subtype","mxid","predicatename"],select_file:["icon","thumbnail_2d"],order_field:"ds6w:label",order_by:"asc",nresults:100},t.payload.locale=r,t.payload.query=n,t.payload.tenant=o.getTenantID(),t.payload.next_start=void 0,t.payload.start=void 0,t.payload.source=["3dspace"],t.payload.login={"3dspace":{SecurityContext:o.getSecurityContext()}},t.payload.label=o.getLabel(),null!=e.next_start?t.payload.next_start=e.next_start:t.payload.start=0,t.method="POST",t.headers={Accept:"application/json","content-type":"application/json","Accept-Language":r},t.type="json",t.data=UWA.Json.encode(t.payload),t.withoutSC=!0,t.timeout=12e4,o._executeRequest(s,t,"searchTerminologies")}).catch(e.onFailure)},d.expandV2Terms=function(e){var t={};UWA.extend(t,e);var n=this;return n.get3DSpaceUrl().then(function(o){var i=o+a.expandV2,s=widget.lang?widget.lang:widget.getValue("lang");t.payload={batch:{expands:[]},outputs:{format:"entity_relation",hits:{predefined_computation:["icons"]},select_object:["physicalid","ds6w:label","ds6w:type","name"],select_relation:["physicalid"]}};var r=[];e.physicalIds.forEach(function(e){var t={label:"terminology-expandv2-"+e,root:{physical_id:e},filter:{all:1},graph:{descending_condition_object:{uql:'(taxonomies:"types/Term") OR (taxonomies:"types/Terminology")'}}};r.push(t)}),t.payload.batch.expands=r,t.method="POST",t.headers={Accept:"application/json","content-type":"application/json","Accept-Language":s,SecurityContext:n.getSecurityContext(),SecurityToken:window.top.dsUserLogin+"|"+n.getSecurityContext()+"|preferred"},t.type="json",t.data=UWA.Json.encode(t.payload),n._executeRequest(i,t,"expandV2Terminologies")})},d.loadNodesDetails=function(e){return new Promise(t=>{this._loadNodesDetails(e).then(t).catch(()=>{o.displayNotification({...i.nodeInfo_error,className:"error"}),t(null)})})},d._loadNodesDetails=function(e){return new Promise((t,n)=>{this.get3DSpaceUrl().then(o=>{{var i={},s=o+a.loadNodesDetails;i.method="POST",i.headers={Accept:"application/json","content-type":"application/json"},i.type="json";let r=[];return e.forEach(e=>r.push(e)),i.payload={nodes:r},i.onComplete=t,i.onFailure=n,i.data=UWA.Json.encode(i.payload),this._executeRequest(s,i,"loadNodesDetails")}})})},d.getTypeInfo=function(e){var t,n=this,o=n.get3DSpaceUrl().then(function(o){var i=o,s={};UWA.extend(s,e);var r=i+a.getTypeInfo;return s.method="POST",s.headers={Accept:"application/json","content-type":"application/json"},s.type="json",s.payload=e.types.slice(),s.data=UWA.Json.encode(s.payload),t=n._executeRequest(r,s,"getTypeInfo")});return o.cancel=function(){t&&t.cancel()},o};let m=null;return d.getSubTypesVPMRefInst=function(){return m=m||new Promise((e,t)=>{var n={};n.types=l,n.onComplete=function(t){c=Object.keys(t),e(c)},n.onFailure=(()=>{m=null,t()}),this.getTypeInfo(n)})},d.canBeAddedToBrowsingStructureOrNode=function(e){var t=this,n={};return UWA.extend(n,e),t.get3DSpaceUrl().then(function(o){var i=o;t.createCSRFTokens({onComplete:function(o){var s=JSON.parse(o).csrf.value,r=e.isBrowsingNode?a.canBeAddedToBrowsingNode:a.canBeAddedToBrowsingStructure,l=i+r;n.method="POST",n.headers={Accept:"application/json","content-type":"application/json","Accept-Language":widget.lang?widget.lang:widget.getValue("lang"),SecurityContext:t.getSecurityContext(),ENO_CSRF_TOKEN:s},n.type="json",n.payload={objectIds:e.objectIds},n.data=UWA.Json.encode(n.payload);t._executeRequest(l,n,"canBeAddedToBrowsingStructure")},onFailure:e.onFailure},i)})},d.canBeAddedToBrowsingStructure=function(e){var t=this;return new Promise(function(n,o){t.canBeAddedToBrowsingStructureOrNode({onComplete:function(e){n(e)},onFailure:function(e){o(e)},objectIds:e.objectIds,isBrowsingNode:!1})})},d.canBeAddedToBrowsingNode=function(e){var t=this;return new Promise(function(n,o){t.canBeAddedToBrowsingStructureOrNode({onComplete:function(e){n(e)},onFailure:function(e){o(e)},objectIds:e.objectIds,isBrowsingNode:!0})})},d}),define("DS/TerminologySelector/commands/TerminologyCtxMenuCommands",["i18n!DS/TerminologySelector/assets/nls/TerminologySelector","DS/WidgetServices/WidgetServices","DS/WebappsUtils/WebappsUtils"],function(e,t,n){"use strict";return{ExpandAllCmd:function(e,t){e.plmType;var n=[];"TREE"===t&&e&&n.push(e),n.length&&n.forEach(function(e){null===e.options.children||"TREE"!==t&&"Folder"!==e.plmType&&"TermSection_All"!==e.plmType||e.expand({expandLevel:"All"})})},CollapseAllCmd:function(e,t){e.plmType;var n=[];"TREE"===t&&e&&n.push(e),n.length&&n.forEach(function(e){e.collapseAll(),e.removeChildren()})},_addCtxCmd:function(e,t,n,o){var i=!1;!1!==n.spaceAvailability&&(i=!0),i&&(o&&("separator"!==o.type||t.length>0)&&t.push(o),t.push(n))},GetContextualMenuForTerminology:function(t,o){var i,s=this,r=[],a=!!t.white_Click&&t.white_Click;void 0===(i=!0===a?i=Folder_CSO.getCurrentFolder():t.nodeModel)&&(i=t);var l={label:e.CMDExpandAll,icon:"url("+n.getWebappsAssetUrl("IPClassifyNav","icons/32/I_ExpandAll.png")+")",callback:function(){s.ExpandAllCmd(i,o)},searchAvailability:!0},c={label:e.CMDCollapseAll,icon:"url("+n.getWebappsAssetUrl("IPClassifyNav","icons/32/I_CollapseAll.png")+")",callback:function(){s.CollapseAllCmd(i,o)},searchAvailability:!0};return this._addCtxCmd(o,r,l,{type:"separator"}),this._addCtxCmd(o,r,c),r}}}),define("DS/TerminologySelector/utils/TerminologyUtil",["DS/Notifications/NotificationsManagerUXMessages","DS/PlatformAPI/PlatformAPI","DS/IPClassifyUtil/IPClassifyAlert","i18n!DS/TerminologySelector/assets/nls/TerminologySelector","DS/Notifications/NotificationsManagerViewOnScreen"],function(e,t,n,o,i){var s=e;i.setNotificationManager(s);var r={putValuesInBold:function(e,t){let n=e.matchAll(/{([^}]*)}/g),o=null,i=0,s=UWA.createElement("span");for(;(o=n.next())&&!0!==o.done;){let n=o.value[1],r=o.value.index,a=e.substring(i,r);i=r+o.value[0].length,s.appendChild(document.createTextNode(a));let l=t[n];Array.isArray(l)||(l=[l]),l.forEach((e,t)=>{0!==t&&s.appendChild(document.createTextNode(", ")),UWA.createElement("b",{text:e}).inject(s)})}let r=e.substring(i);return s.appendChild(document.createTextNode(r)),s},extractNodesLists:function(e){let t={allNodes:new Set,intersection:[]};for(var n in e){let o=e[n];if(0===t.intersection.length)t.intersection=o;else{let e=t.intersection.filter(e=>o.includes(e));t.intersection=e}o.forEach(e=>{t.allNodes.add(e)})}return t},sendPublicNotification:function(e,n,o){t.publish(e,n),o&&r.sendWebInWinNotification(e,n)},sendWebInWinNotification:function(e,t){window.dscef&&window.dscef.sendString(e,t?"string"!=typeof t?JSON.stringify(t):t:"")},searchNodesById:function(e,t){return e.search({match:function(e){if(t&&e.nodeModel.getID&&e.nodeModel.getID()&&-1!==e.nodeModel.getID().indexOf(t))return!0}})},getTerminologyParent:function(e){if(!e)return null;var t=e.getParent();return t&&"RootFolder"===t.getType()?t:this.getTerminologyParent(t)},getPathTerms:function(e){var t=e.getParents(),n=t.filter(e=>"RootFolder"===e.getType())[0],o=t.filter(e=>"Folder"===e.getType());return{parentTerminology:n,pathTerms:[e.id].concat(o.map(e=>e.id)),pathTermsTitle:[e.getLabel()].concat(o.map(e=>e.getLabel()))}},compareArray:function(e,t){return e.length===t.length&&e.every(function(e){return t.includes(e)})},createDataForEventAssociationUpdate:function(e,t,n,o,i,s,r){var a=this,l={widgetID:widget.id,browsingStructures:{add:[],remove:[],referencesID:e||[]},browsingNodes:{add:[],remove:[],relationsID:t||[]}};function c(e,t,n){let o=e;var i=[];return o&&o.success&&void 0!==o.success.length&&o.success.forEach((e,t)=>{var o={},s=null;n?(o.nodeID=e.id,o.nodeName=e.name,o.nodeTitle=e.title,(s=r(e.id))&&(o.nodeName=o.nodeName?o.nodeName:s.name,o.nodeTitle=o.nodeTitle?o.nodeTitle:s.title,o.structureID=s.parentTerminology.id,o.structureTitle=s.parentTerminology.title,o.ds6w=a.getsixwfromPredicateName(s.predicatename),o.path=s.path,o.pathTitle=s.pathTitle)):(o.structureID=e.id,o.structureTitle=e.title,o.structureName=e.name,s=r(e.id),o.ds6w=a.getsixwfromPredicateName(s.predicatename)),i.push(o)}),i}return l.browsingStructures.add=c(n,!1,!1),l.browsingNodes.add=c(o,!1,!0),l.browsingStructures.remove=c(i,!0,!1),l.browsingNodes.remove=c(s,!0,!0),l},getsixwfromPredicateName:function(e){if(e)return"ds6w:"+e.charAt(0).toLowerCase()+e.slice(1)},displayReponseAssociations:function(e,t,i,s){if(t||i){var r="",a="",l="",c="";if(s?(r=o.title_association_success_terms,a=o.title_association_error_terms):(r=o.title_association_success_terminologies,a=o.title_association_error_terminologies),t&&(t.success&&t.success.length>0&&(l+=s?o.association_success_terms:o.association_success_terminologies,l=o.replace(l,{terminologies:t.success.map(function(e){return e.title})})),t.error&&t.error.length>0&&(c=t.error,"string"!=typeof t.error&&(c=s?o.association_error_terms:o.association_error_terminologies,c=o.replace(c,{terminologies:t.error.map(function(t){return e[t.id].title})})))),i&&(i.success&&i.success.length>0&&(c&&(c+="\n"),l+=s?o.detach_success_terms:o.detach_success_terminologies,l=o.replace(l,{terminologies:i.success.map(function(e){return e.title})})),i.error&&i.error.length>0)){let t=i.error;"string"!=typeof i.error&&(t=s?o.detach_error_terms:o.detach_error_terminologies,t=o.replace(t,{terminologies:i.error.map(function(t){return e[t.id].title})})),c+=t}return l&&n.displayNotification({title:r,message:l,className:"success"}),!c||(n.displayNotification({title:a,message:c,className:"error"}),!1)}}};return r}),define("DS/TerminologySelector/commands/TerminologyGlobalCommand",["UWA/Core","DS/ApplicationFrame/Command","DS/TerminologySelector/service/TerminologyWebService","DS/Controls/Loader","DS/Controls/ModalContainer","DS/IPClassifyUtil/IPClassifyAlert","i18n!DS/TerminologySelector/assets/nls/TerminologySelector"],function(e,t,n,o,i,s,r){"use strict";return t.extend({isInsert:!0,datas:{},launchComponent:function(e,t){},init:function(e){var t=this;this._parent(e,{mode:"exclusive",isAsynchronous:!1}),this.getXSOFromContext().then(function(e){e&&(n.getSubTypesVPMRefInst().then(function(e){t._check_selection(e)}).catch(function(e){t.disable()}),e.onChange(function(){n.getSubTypesVPMRefInst().then(function(e){t._check_selection.call(t,e)}).catch(function(e){t.disable()})}))})},beginExecute:function(){},execute:function(){var e=this;this.getSelectedNodesFromContext().then(function(t){if(t&&t.length>0&&t.length<=20){var a=new o({showButtonFlag:!0});a.on(r.loading);let l=!1;a.elements.stopButton.addEventListener("buttonclick",function(e){l=!0,a.off(),i.removeModal(widget.body)}),i.createModal(widget.body,a.elements.container),n.getSubTypesVPMRefInst().then(function(n){l||(a.off(),i.removeModal(widget.body),(e.isValidPromise||e.isValidSelection(t,n)).then(function(n){n?e.launchComponent(t):s.displayNotification({message:r.error_command_selection,className:"error"})}))}).catch(function(e){a.off(),i.removeModal(widget.body),e&&"cancel"==e.error||s.displayNotification({message:r.error_run_command,className:"error"})})}else s.displayNotification({message:r.error_command_selection,className:"error"})})},endExecute:function(){},isValidSelection:function(e,t){},_check_selection:function(e){var t=this;t.isValidPromise=void 0,t.disable(),this.getXSOFromContext().then(function(n){var o=n.get();if(o&&o.length>0&&o.length<=20){var i=t.isValidSelection(o,e);i.then(function(e){e&&t.enable()}),t.isValidPromise=i}})},getSelectedNodesFromContext:function(){var e=["DS/PADUtils/PADContext"];return new Promise((t,n)=>{require(e,function(e){t(e.get().getSelectedNodes())})})},getXSOFromContext:function(){var e=["DS/PADUtils/PADContext"];return new Promise((t,n)=>{require(e,function(e){e.get()&&t(e.get().options.model.getXSO())})})}})}),define("DS/TerminologySelector/utils/TermConfirmation",["DS/Windows/Dialog","DS/Controls/Button","DS/WebappsUtils/WebappsUtils","DS/TerminologySelector/utils/TerminologyUtil","i18n!DS/TerminologySelector/assets/nls/TerminologySelector"],function(e,t,n,o,i){return{confirm:({immersiveFrame:s,instanceNames:r,oldNodes:a,newNodes:l})=>new Promise(c=>{let d=!1,m="";r.length>1&&(m="Multi");let u=[...a],g=[...l],p=u.join(", "),f=g.join(", "),h=r[0],y=i.replace(i["addRemoveMsg"+m],{oldNodes:p,newNodes:f,objTitle:h!==i.default_instance?h+" ":""}),T=o.putValuesInBold(i["addRemoveConfirm"+m],{oldNodes:u,newNodes:g}),S=i.replace(i["addRemoveTitle"+m],{objTitle:h}),v=UWA.createElement("div",{class:"addRemoveContent"});UWA.createElement("img",{class:"warningIcon",src:n.getWebappsAssetUrl("TerminologySelector","icons/32/warning.png")}).inject(v),UWA.createElement("span",{class:"mainMsg",text:y}).inject(v),UWA.createElement("div",{class:"confirmMsg",html:T}).inject(v);let _=new e({immersiveFrame:s,title:S,content:v,activeFlag:!1,modalFlag:!0,buttons:{Ok:new t({label:i.addRemoveButton,onClick:function(){d=!0,_.close()}}),Cancel:new t({label:i.cancelButton,onClick:function(){_.close()}})}});_.getContent().addClassName("termConfirmation"),_.addEventListener("close",()=>{_.destroy(),c(d)})})}}),define("DS/TerminologySelector/TerminologyAssociation/TerminologyAssociation",["DS/IPClassifyActive/IPClassifyActive","DS/TerminologySelector/service/TerminologyWebService","DS/TerminologySelector/utils/TerminologyUtil","DS/IPClassifyUtil/IPClassifyAlert","DS/PlatformAPI/PlatformAPI","i18n!DS/TerminologySelector/assets/nls/TerminologySelector","DS/WebappsUtils/WebappsUtils","DS/TerminologySelector/commands/TerminologyCtxMenuCommands","DS/TerminologySelector/utils/TermConfirmation","DS/Controls/Loader","DS/Controls/ModalContainer","DS/Controls/TooltipModel","text!DS/TerminologySelector/assets/Terminology_setting.json"],function(e,t,n,o,i,s,r,a,l,c,d,m,u){var g={iconName:"browsing-structure-root",fontIconFamily:1},p={iconName:"browsing-structure-node",fontIconFamily:1};const f="RootFolder",h="Folder";return e.extend({name:"TerminologyAssociation",_rootNodeFavorite:null,_rootNodeFolders:null,_rootNodeTrash:null,_requestInfo:{},_searchKeys:{},_pathInfo:{},_subBookmarkExpand:{},_favoriteSection:null,_allSection:"TermSection_All",_findInTreeNLS:s,init:function(e){var i=this;this.items=e.items,this.isInstance=e.isInstance||!1,this.deactivateAssociate=e.deactivateAssociate||!1,this.alreadySelected=e.alreadySelected||null,this._promiseNodesInfo=Promise.resolve({}),e.dataProvider={},e.selectionMode="DefaultMulti",e.authoring=!1,e.dialogButtons=!0,e.favoriteButton=!1,e.hideFavorite=!0,e.multiSelectionComponent={withClassify:!1,launchDialog:!e.webinwin,NLS:s.multiSelectionComponent},e.popOverDialogProperties={modalFlag:!0},e.multiSelectionComponent.NLS.widget_name=i.isInstance?s.widget_name_associate_terms:s.widget_name_associate_terminologies,e.dataProvider.widgetDataProvider={getWidgetIcon:function(){return"browsing-structure-root-add-to"},getSettings:function(){return JSON.parse(u)},getAdditionalSearchAttributes:function(){return["predicatename"]}},this._parent(e),this._preDefinedNodes=!!e.nodes,this._getNodesPerInstances(),e.webinwin||this.nestedMenuInContext.popover.elements.container.addClassName("TerminologyAssociation"),this.nestedMenuInContext._modelEvents.subscribe({event:"IPActive/NodeSelection/OnChange"},function(){var e=i.nestedMenuInContext.nestedMenu?i.nestedMenuInContext.nestedMenu._treeView:null,t=e?e.getTreeDocument():null;if(i.nestedMenuInContext._classifyButton.tooltipInfos=null,t){var o=[],r=[];if(t.getSelectedNodes().length<1)i.disableButtonAssociate(s.tooltip_selection_empty);else if(i.alreadySelected&&i.alreadySelected.length>0){n.compareArray(i.alreadySelected.map(e=>e.id),t.getSelectedNodes().map(e=>e.getID()))&&i.disableButtonAssociate(s.tooltip_selection_no_changes)}t.getSelectedNodes().forEach(function(e){if(i.isInstance&&e.getType()!==h||!i.isInstance&&e.getType()!==f)i.disableButtonAssociate(s.tooltip_selection_rows_invalid);else if(e.getType()===h&&!(o.indexOf(e.id)>-1)){o.push(e.id);var t=n.getTerminologyParent(e);t&&(r.indexOf(t.id)>-1||r.push(t.id))}})}}),this.nestedMenuInContext.addEvent("select",function(e){if(i.options.isInstance){var t=i.nestedMenuInContext.nestedMenu?i.nestedMenuInContext.nestedMenu._treeView:null,r=t?t.getTreeDocument():null;if(e.getType()===h){var a=n.getTerminologyParent(e);a&&r.getSelectedNodes().forEach(function(t){if(t.getType()===h&&t.id!==e.id){var i=n.getTerminologyParent(t);i&&i.id===a.id&&(t.unselect(),o.displayNotification({allowUnsafeHTML:!0,className:"info",message:n.putValuesInBold(s.infoChangeNode,{oldNodes:t.getLabel(),newNodes:e.getLabel()})}))}})}else r.getSelectedNodes().length>1&&r.getSelectedNodes().forEach(t=>{t.getType()!==h&&t!==e&&t.unselect()})}}),this.nestedMenuInContext.addEvent("onClassifyMultiple",async e=>{var r=i.nestedMenuInContext.nestedMenu?i.nestedMenuInContext.nestedMenu._treeView:null,a=r?r.getTreeDocument():null,m=i.nestedMenuInContext?i.nestedMenuInContext.getMultiSelectorContainer().getParent():null,u=new c;u.on(s.loading),d.createModal(m,u.elements.container),await this._getNodesPerInstances();let g=await this._promiseNodesInfo;var p=[],y=[],T={},S=a.getSelectedNodes();let v={};S.forEach(function(e,t){if(e.getType()!==f||y.indexOf(e.id)>-1){if(e.getType()===h&&!(p.indexOf(e.id)>-1)){p.push(e.id);var o=n.getPathTerms(e);if(o){let t=o.parentTerminology.getID();v[t]||(T[e.id]={id:e.id,title:e.getLabel(),parentTerminology:{id:o.parentTerminology.getID(),title:o.parentTerminology.getLabel()},predicatename:o.parentTerminology.options.predicatename,path:o.pathTerms,pathTitle:o.pathTermsTitle},v[t]=e.id)}}}else y.push(e.id),T[e.id]={id:e.id,title:e.getLabel(),predicatename:e.options.predicatename}});let _={},I=new Set,w=new Set,C=new Set,b={};if(this.options.nodes){for(let e in this.options.nodes){let t=this.options.nodes[e],n=Object.values(v),o=0;t.forEach(t=>{if(t){let i=g[t].structureId;if(v[i]){if(v[i]!==t){I.add(T[v[i]].title),w.add(g[t].label),C.add(t);let n=b[e];n||(n=b[e]={}),n[v[i].id]=t}}else n.splice(o,0,t),o++}}),_[e]=n}let e=0===w.size;if(e||(e=await l.confirm({immersiveFrame:this.options.immersiveFrame,instanceNames:this.items.map(e=>e.label?e.label:s.default_instance),oldNodes:w,newNodes:I})),!e)return u.off(),void d.removeModal(m);let t=n.extractNodesLists(_);this._preDefinedNodes&&(p=t.intersection),n.sendWebInWinNotification("BrowsingStructureUpdated",{modified:_})}var A=i.items.map(function(e){return e.label}).filter(function(e){return e}),D=i.items.map(function(e){return e.id});if(i.dispatchEvent("associateTerminology",{terminologiesID:y,termsID:p,updatedSelection:_,replacementMap:b}),i.deactivateAssociate)u.off(),d.removeModal(m),i.nestedMenuInContext._classifyButton&&i._closePanel();else{let e=null;(e=p.length>0?t.updateNodes({itemsID:D,nodesToAttach:p,nodesToDetach:[...C]}):t.attachTerminologies({terminologiesId:y,itemsID:D,isInstance:i.isInstance,onComplete:function(){var e="";e=D.length>1?s.success_association_references_terminology:s.success_association_reference_terminology,e=s.replace(e,{items:A.length>0?A:"",terminology:T[this.terminologyID]?T[this.terminologyID].title:""}),o.displayNotification({title:i.isInstance?s.title_association_success_terms:s.title_association_success_terminologies,message:e,className:"success"})},onFailure:function(){var e="";e=i.isInstance?D.length>1?s.error_association_instances_term:s.error_association_instance_term:D.length>1?s.error_association_references_terminology:s.error_association_reference_terminology,e=s.replace(e,{items:A.length>0?A:"",terminology:T[this.terminologyID]?T[this.terminologyID].title:""}),o.displayNotification({title:s.association_error,message:e,className:"error"})}})).then(function(e){u.off(),d.removeModal(m);var t=i.isInstance?null:e,o=i.isInstance?i.generateResultsFromNode(T,p):null,s=i.isInstance?D:null,r=i.isInstance?null:D;let a=n.createDataForEventAssociationUpdate(r,s,t,o,null,null,function(e){return T[e]});i.isInstance&&n.displayReponseAssociations(T,o,null,!0);let l=!e.error||e.error.length<1;n.sendPublicNotification("BrowsingStructureAssociationUpdate",a,l),l&&i.nestedMenuInContext._classifyButton&&i._closePanel()}).catch(function(e){console.log(e),u.off(),d.removeModal(m);let t=e&&e.err&&e.err.error?e.err.error:s.error_association_service;o.displayNotification({title:s.association_error,message:t,className:"error"})})}}),this.nestedMenuInContext.addEvent("onSelectorCancel",this._closePanel.bind(this))},_getNodesPerInstances:function(){return this._nodePerInstancePromise=this._nodePerInstancePromise?this._nodePerInstancePromise:new Promise((e,o)=>{if(this.isInstance){let i=Promise.resolve({nodesPerInstances:this.options.nodes});this.options.nodes||(i=t.getAssociatedTermsPerInstance({itemsID:this.items.map(function(e){return e.id})})),i.then(t=>{this.options.nodes=t.nodesPerInstances;let o=n.extractNodesLists(this.options.nodes);this._allNodes=o.allNodes,this.alreadySelected=o.intersection.map(e=>({id:e})),this._reloadNodesInfo(),e()}).catch(o)}else this.options.nodes={},e()}),this._nodePerInstancePromise},generateResultsFromNode:function(e,t){let n=null;return n={success:[],error:[]},t.forEach(t=>{if(t){let o=e[t];n.success.push(o)}}),n},_closePanel:function(){Object.getPrototypeOf(this.nestedMenuInContext.nestedMenu)._expandedNodes=[],this.nestedMenuInContext.destroy(),!0===this.options.winClosable&&n.sendWebInWinNotification("onPanelClose")},_reloadNodesInfo:function(){this._promiseNodesInfo=t.loadNodesDetails(this._allNodes)},_getWebServiceRef:function(){return t},_getPlmType:function(e){return"Terminology"===e?f:"Term"===e?h:void 0},_getRootIcon:function(){return r.getWebappsAssetUrl("TerminologySelector","icons/22/Browsing_Structure_22.png")},_getFavoritesIcon:function(){return null},_getRootName:function(){return s.name_Section_AllFolders},_getFavoritesName:function(){return null},_getActiveIcon:function(e){return this.isInstance?r.getWebappsAssetUrl("TerminologySelector","icons/22/Browsing_Node_22.png"):r.getWebappsAssetUrl("TerminologySelector","icons/22/Browsing_Structure_22.png")},_getFocusBtnTooltip:function(){return s.terminology_btn_focus},_showMessageWhileEmpty:function(e){return e?s.terminology_msg_empty:s.terminology_msg_noterminology},_getIcon:function(e,t){var n;return!function(e){let t=e.getType?e.getType():e.type;return e&&("Terminology"===t||t===f)}(e)?function(e){let t=e.getType?e.getType():e.type;return e&&("Term"===t||t===h)}(e)&&(n=p):n=g,n},couldBeExpand:function(e){return!0},couldBeValid:function(e,t,n,o){return!!(e&&e.getID&&e.getID())},couldBeSelected:function(e){return!0},_getContextualMenu:function(e,t){return a.GetContextualMenuForTerminology(e,t)},disableButtonAssociate:function(e){this.nestedMenuInContext._classifyButton&&(this.nestedMenuInContext._classifyButton.disabled=!0),e&&(this.nestedMenuInContext._classifyButton.tooltipInfos=new m({shortHelp:e}))}})}),define("DS/TerminologySelector/commands/AssociateTerminologiesCommand",["DS/Windows/ImmersiveFrame","DS/TerminologySelector/commands/TerminologyGlobalCommand","DS/TerminologySelector/TerminologyAssociation/TerminologyAssociation","DS/IPClassifyUtil/IPClassifyAlert","DS/TerminologySelector/service/TerminologyWebService","i18n!DS/TerminologySelector/assets/nls/TerminologySelector"],function(e,t,n,o,i,s){"use strict";return t.extend({labelTopBar:s.widget_name_associate_terminologies,init:function(e){this._parent(e)},launchComponent:function(t){this._parent(t);var o=[];if(t.forEach(function(e){e.getID()&&o.push({id:e.getID(),label:e.getLabel()})}),o&&o.length>0){let t=widget.immersiveFrame;t||(t=new e).inject(widget.body),new n({immersiveFrame:t,items:o,isInstance:!1})}},isValidSelection:function(e,t){this._parent(e,t);return new Promise(function(n){var o=!0,s=[];e.forEach(function(e){if(e.getID()){var n=e.options.type||e.getType&&e.getType();if(n){if(n&&!t.includes(n))return void(o=!1)}else s.push(e.getID())}else o=!1}),o?s.length>0?i.canBeAddedToBrowsingStructure({objectIds:s}).then(function(e){e.isValid?n(!0):n(!1)}).catch(function(){n(!1)}):n(!0):n(!1)})}})}),define("DS/TerminologySelector/commands/AssociateTermsCommand",["DS/Windows/ImmersiveFrame","DS/TerminologySelector/commands/TerminologyGlobalCommand","DS/TerminologySelector/TerminologyAssociation/TerminologyAssociation","DS/IPClassifyUtil/IPClassifyAlert","DS/TerminologySelector/service/TerminologyWebService","i18n!DS/TerminologySelector/assets/nls/TerminologySelector"],function(e,t,n,o,i,s){"use strict";return t.extend({labelTopBar:s.widget_name_associate_terms,init:function(e){this._parent(e)},launchComponent:function(t){this._parent(t);var o=[];if(t.forEach(function(e){e.getRelationID&&e.getRelationID()&&o.push({id:e.getRelationID()})}),o&&o.length>0){let t=widget.immersiveFrame;t||(t=new e).inject(widget.body),new n({immersiveFrame:t,items:o,isInstance:!0})}},isValidSelection:function(e,t){this._parent(e,t);return new Promise(function(n){var o=!0,s=[];e.forEach(function(e){if(e.getRelationID&&e.getRelationID())if(e.options.relationtype){if(e.options.relationtype&&!t.includes(e.options.relationtype))return void(o=!1)}else s.push(e.getRelationID());else o=!1}),o?s.length>0?i.canBeAddedToBrowsingNode({objectIds:s}).then(function(e){e.isValid?n(!0):n(!1)}).catch(function(){n(!1)}):n(!0):n(!1)})}})}),define("DS/TerminologySelector/TerminologyManagement/TerminologyManagement",["UWA/Controls/Abstract","UWA/Class/Options","UWA/Class/Events","DS/IPClassifyUtil/IPClassifyUtility","DS/WidgetServices/WidgetServices","DS/WUXAutoComplete/AutoComplete","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/Controls/Button","DS/Controls/TooltipModel","DS/Windows/Dialog","DS/Controls/Loader","DS/Controls/ModalContainer","DS/IPClassifyUtil/IPClassifyAlert","DS/PlatformAPI/PlatformAPI","DS/TerminologySelector/service/TerminologyWebService","DS/TerminologySelector/utils/TerminologyUtil","DS/TerminologySelector/utils/TermConfirmation","DS/TerminologySelector/TerminologyAssociation/TerminologyAssociation","i18n!DS/TerminologySelector/assets/nls/TerminologySelector","css!DS/TerminologySelector/TerminologySelector.css"],function(e,t,n,o,i,s,r,a,l,c,d,m,u,g,p,f,h,y,T,S){const v="term",_="terminology";var I={iconName:"browsing-structure-root",fontIconFamily:1},w={iconName:"browsing-structure-node",fontIconFamily:1};return e.extend(t,n,{name:"TerminologyManagement",init:function(e){this._parent(e);this.instances=e.instances,this.references=e.references,this.initialSelectedTerms=[],this.initialSelectedTerminologies=[],this._replacementMap={},this._mapTreeNodes={},this.autocompleteTerminologies=null,this.autocompleteTerms=null,this.mapTerminologyinfo={};let t=null,n=Promise.resolve({}),o=null;if(e.nodes){let i=h.extractNodesLists(e.nodes);t=i.allNodes,this.initialSelectedTerms=i.intersection,this._currentSelection=this.initialSelectedTerms.map(e=>({id:e})),this._selectedItems=e.nodes,o=Promise.resolve(i.intersection),n=f.loadNodesDetails(t)}else o=this.getAssociatedTerms();var s=[this.getAssociatedTerminologies(),o,this.getTerminologies(),n];let r=Promise.resolve();if(void 0===e.associateStructure){let e=["KSM","KPW","CTR","MCV","KPZ","CIO"];r=new Promise(t=>{i.getGrantedRoles(n=>{n.every(t=>(this.options.associateStructure=e.indexOf(t)>=0,!this.options.associateStructure)),t()},i.getTenantID())}),s.push(r)}this.initialPromise=Promise.all(s),r.then(()=>{if(e.instances.length>0||!0===this.options.associateStructure||e.webInWin){if(this.elements.masterContainer=UWA.createElement("div",{class:"terminologyManagement-masterContainer"}),this.container=UWA.createElement("div",{class:"terminologyManagement-container"}).inject(this.elements.masterContainer),e.instances.length>1||e.references.length>1){let t=e.instances.length>1&&e.references.length>1&&this.options.associateStructure?S.infoMultiselectionAll:null;t=(t=!t&&e.instances.length>1?S.infoMultiselectionBN:t)||S.infoMultiselectionBS;let n=UWA.createElement("div",{class:"multiselMessage"});UWA.createElement("span",{class:"wux-ui-3ds wux-ui-3ds-2x wux-ui-3ds-info"}).inject(n),UWA.createElement("span",{class:"message",text:t+" "+S.infoMultiEnd}).inject(n),n.inject(this.container)}if(this.elements.cancel=new l({label:S.cancel,emphasize:"secondary",onClick:this._closePanel.bind(this)}),this.elements.save=new l({label:S.save,emphasize:"primary",onClick:this.saveAssociations.bind(this)}),e.webInWin){this.elements.masterContainer.inject(e.container);let t=UWA.createElement("div",{class:"buttonBar"}).inject(this.elements.masterContainer);this.elements.save.inject(t),this.elements.cancel.inject(t)}else{let t=[S.terminology_management];if(e.references.length>0&&!0===this.options.associateStructure)if(1===e.references.length){let n=e.references[0].label;t.push(n||S.default_object)}else t.push(S.replace(S.title_nbObjects,{nb:e.references.length}));if(e.instances.length>0)if(1===e.instances.length){let n=e.instances[0].label;t.push(n||S.default_instance)}else t.push(S.replace(S.title_nbInstances,{nb:e.instances.length}));this.createModal(e.container,t.join(" - "),this.elements.masterContainer),parentContainer=this.container.getParent()}this.loader=new m,this.loader.on(S.loading),u.createModal(this.elements.masterContainer,this.loader.elements.container),this.createContentTerminologyManagement().inject(this.container)}else g.displayNotification({className:"error",message:S.noStructureLicence})})},_closePanel:function(){this.dialog&&this.dialog.close(),h.sendWebInWinNotification("onPanelClose")},createAutocompleteComponent:function(e,t,n,o,i){var r=UWA.createElement("div",{class:"terminologyManagement-autocomplete-container "+i||""});UWA.createElement("div",{class:"terminologyManagement-autocomplete-label",text:e}).inject(r);var a=UWA.createElement("div",{class:"terminologyManagement-autocomplete-line"}).inject(r),d=UWA.createElement("div",{class:"terminologyManagement-autocomplete"}).inject(a),m=UWA.createElement("div",{class:"terminologyManagement-button-browse"}).inject(a),u=new s({elementsTree:t,allowFreeInputFlag:!1}).inject(d);return new l({displayStyle:"lite",label:"Browse",onClick:o,icon:{iconName:"open-in-a-new-window",fontIconFamily:1},showLabelFlag:!1}).inject(m).tooltipInfos=new c({shortHelp:S.tooltip_browse}),r.inject(n),u},setPossibleDatasAutocomplete:function(e,t){e.elementsTree=t},setValuesAutocomplete:function(e,t){e.value=t},createContentTerminologyManagement:function(){var e=this,t=UWA.createElement("div",{class:"terminologyManagement-autocompletes-container"});function n(e,t,n){var o=new a({label:e.label,value:e.id,icon:t,type:n,title:e.label,name:e.name,predicatename:e.predicatename});return o.id=e.id,o}return this.initialPromise.then(i=>{var s=i[0],a=i[1],l=i[2].terminologies||[],c=i[2].terms||[],d=i[2].relationsTerms||[];let m=!1;s&&l&&!this.options.deactivateAssociate&&!0===this.options.associateStructure&&(m=!0,e.autocompleteTerminologies=e.createAutocompleteComponent(S.associated_terminologies_reference,[],t,e.browseAssociations.bind(e,e.references,!1),"browsingstructure-autocomplete"),e.setPossibleDatasAutocomplete(e.autocompleteTerminologies,function(e,t){var o=new r;return o.prepareUpdate(),e.forEach(function(e){var i=n(e,t?w:I,t?v:_);o.addRoot(i)}),o.expandAll(),o.pushUpdate(),o}(l)),e.displayAssociateTerminologies(s)),a&&c&&(m=!0,e.autocompleteTerms=e.createAutocompleteComponent(S.associated_terms_instance,[],t,e.browseAssociations.bind(e,e.instances,!0),"browsingnode-autocomplete"),e.autocompleteTerms.addEventListener("change",async function(){if(e.autocompleteTerms.selectedItems){let t={},n=[],i={},s=new Set,r=new Set;e.autocompleteTerms.selectedItems.forEach(e=>{s.add(e.id)});for(let o=e.autocompleteTerms.selectedItems.length-1;o>=0;o--){let a=e.autocompleteTerms.selectedItems[o];if(r.add(a.id),a.options.type===_)n.push(a);else{let o=a.getRoot().id,r=t[o];if(r){n.push(a);for(let t in e._selectedItems){let n=e._replacementMap[t];if(n){let e=n[a.id];e&&(n[r.id]=e,delete n[a.id])}}}else t[o]=a;if(0===e._currentSelection.filter(e=>e.id===a.id).length){let t=e._mapTreeNodes[a.id].getRoot(),n=new Set;t.getAllDescendants().forEach(e=>{n.add(e.id)});let o=!1;for(let t in e._selectedItems){let r=!1,l=null,c=-1,d=null;if(e._selectedItems[t].every((m,u)=>{let g=m===a.id;if(n.has(m)){let n=!g&&s.has(m);if(!g){let t=e._mapTreeNodes[m];l=t.getLabel(),c=u,d=a.getLabel(),n&&(o=!0)}if(!n){let e=i[t];e||(e=i[t]={}),e[a.id]=m}}return!(r=r||g)||c<0}),!o&&l&&!(o=await y.confirm({immersiveFrame:e.options.immersiveFrame,instanceNames:e.instances.map(e=>e.label?e.label:S.default_instance),oldNodes:[l],newNodes:[d]})))return void a.unselect();r||(c>=0&&e._selectedItems[t].splice(c,1),e._selectedItems[t].push(a.id))}}}}e._currentSelection.forEach(t=>{if(!r.has(t.id))for(let n in e._selectedItems){let o=e._selectedItems[n].indexOf(t.id);if(o>=0){e._selectedItems[n].splice(o,1);let i=e._replacementMap[n];if(i){let o=i[t.id];o&&e._selectedItems[n].push(o),delete i[t.id]}}}}),e._replacementMap=o.concatJsonValue(e._replacementMap,i),e._currentSelection=[...e.autocompleteTerms.selectedItems],n.forEach(e=>{e.unselect()})}}),l&&d&&e.setPossibleDatasAutocomplete(e.autocompleteTerms,function(e,t,o){var i=new r;return i.prepareUpdate(),t.forEach(e=>{var t=n(e,I,_);i.addRoot(t),this._mapTreeNodes[e.id]=t}),e.forEach(e=>{var t=n(e,w,v);this._mapTreeNodes[e.id]=t}),o.forEach(e=>{var t=this._mapTreeNodes[e.parent],n=this._mapTreeNodes[e.child];t&&n&&t.addChild(n)}),i.getRoots().forEach(function(e,t){e.sortChildren({isRecursive:!0,sortFunction:function(e,t){return e.options.label.localeCompare(t.options.label)>=1?1:-1}})}),i.expandAll(),i.pushUpdate(),i}.call(e,c,l,d)),e.displayAssociateTerms(a)),m||UWA.createElement("div",{class:"emptyManager",text:S.warningEmptyManager}).inject(t),e.loader.off(),u.removeModal(this.elements.masterContainer)}),t},createModal:function(e,t,n){that=this,this.dialog=new d({immersiveFrame:this.options.immersiveFrame,title:t,content:n,activeFlag:!1,height:"auto",minHeight:50,width:500,modalFlag:!0,domId:"terminologyManagementDialog",buttons:{Cancel:this.elements.cancel,Save:this.elements.save}})},browseAssociations:function(e,t,n){var i=this,s=null;i.autocompleteTerms&&t?(i.saveInfoSelection(i.autocompleteTerms),s=(s=i.autocompleteTerms.value||[]).map(e=>{var t=i.mapTerminologyinfo[e].path?i.mapTerminologyinfo[e].path.slice():[];return t.shift(),t.push(i.mapTerminologyinfo[e].parentTerminology.id),{id:e,path:t}})):!t&&i.autocompleteTerminologies&&(i.saveInfoSelection(i.autocompleteTerminologies),s=(s=i.autocompleteTerminologies.value||[]).map(e=>({id:e}))),new T({immersiveFrame:this.options.immersiveFrame,items:e,isInstance:t,deactivateAssociate:!0,alreadySelected:s,nodes:this._selectedItems}).addEvent("associateTerminology",function(e){if(i.autocompleteTerminologies&&!t){let t=i.autocompleteTerminologies.value;t=[...t,...e.terminologiesID],i.setValuesAutocomplete(i.autocompleteTerminologies,t)}i.autocompleteTerms&&t&&(i._selectedItems=e.updatedSelection,e.replacementMap&&(i._replacementMap=o.concatJsonValue(i._replacementMap,e.replacementMap)),i.setValuesAutocomplete(i.autocompleteTerms,e.termsID))})},generateResultsFromNode:function(e){let t=null;return t={success:[],error:[]},e.forEach(e=>{if(e){let n=this.mapTerminologyinfo[e]||this.saveNode(that._mapTreeNodes[e]);t.success.push(n)}}),t},saveAssociations:async function(){var e=this,t=new m;t.on(S.loading),u.createModal(this.elements.masterContainer,t.elements.container);var n=[],o=[],i=[],s=[];if(e.autocompleteTerminologies){var r=e.autocompleteTerminologies.value||[];e.saveInfoSelection(e.autocompleteTerminologies),n=l(e.initialSelectedTerminologies,r),i=c(e.initialSelectedTerminologies,r)}if(e.autocompleteTerms){var a=e.autocompleteTerms.value||[];e.saveInfoSelection(e.autocompleteTerms),o=l(e.initialSelectedTerms,a);let t=new Set;for(let n in e._replacementMap){let o=e._replacementMap[n];for(let e in o){let n=o[e];n!==e&&t.add(n)}}o.forEach(e=>t.add(e)),o=[...t],s=c(e.initialSelectedTerms,a)}function l(e,t){return d(e,t)}function c(e,t){return d(t,e)}function d(e,t){var n=[];return e.forEach(function(e){t.includes(e)||n.push(e)}),n}if(!0!==this.options.deactivateAssociate){var p=[],y=i.length>0?f.attachTerminologies({terminologiesId:i,itemsID:e.references.map(function(e){return e.id}),isInstance:!1}):Promise.resolve(null),T=n.length>0?f.detachTerminologies({terminologiesId:n,itemsID:e.references.map(function(e){return e.id}),isInstance:!1}):Promise.resolve(null),v=s.length>0||o.length>0?f.updateNodes({itemsID:e.instances.map(function(e){return e.id}),nodesToAttach:s,nodesToDetach:o}):Promise.resolve(null);p.push(y,T,v),Promise.all(p).then(n=>{var i=n[0],r=n[1];let a=n[2];var l=this.generateResultsFromNode(o),c=this.generateResultsFromNode(s);a&&a.error&&(c=a,l=null);var d=!0,m=!0;let g=h.createDataForEventAssociationUpdate(e.references.map(function(e){return e.id}),e.instances.map(function(e){return e.id}),i,c,r,l,function(t){return e.mapTerminologyinfo[t]||e.saveNode(e._mapTreeNodes[t])});(i||r)&&(d=h.displayReponseAssociations(e.mapTerminologyinfo,i,r)),(c||l)&&(m=h.displayReponseAssociations(e.mapTerminologyinfo,c,l,!0));let p=d&&m;h.sendPublicNotification("BrowsingStructureAssociationUpdate",g,p),p?this._closePanel():(d&&(i||r)&&e.updateAssociatedTerminologies(),m&&(c||l)&&e.updateAssociatedTerms()),t.off(),u.removeModal(this.elements.masterContainer)}).catch(e=>{console.log(e),t.off(),u.removeModal(this.elements.masterContainer),g.displayNotification({title:S.association_error,message:e.error&&"string"==typeof e.error?e.error:S.error_association_service,className:"error"})})}else{if(this.options.nodes){let e=(await this.initialPromise)[3],t=[];s.forEach(n=>{e[n]||t.push(n)});let n=t.length>0?f.loadNodesDetails(t):Promise.resolve({}),i=await n;if(null!=i){let t={},n={};for(var _ in s.forEach(t=>{let o=e[t];o=o||i[t],n[o.structureId]=t}),this.options.nodes){let i=this.options.nodes[_],s=Object.values(n);i.forEach(t=>{let i=e[t];if(i){let e=i.structureId;!n[e]&&o.indexOf(t)<0&&s.push(t)}}),t[_]=s}h.sendWebInWinNotification("BrowsingStructureUpdated",{modified:t}),this._closePanel()}}t.off(),u.removeModal(this.elements.masterContainer)}},getAssociatedTerminologies:function(){var e=this;if(e.references&&e.references.length>0)return new Promise(function(t,n){f.getAssociatedTerminologies({itemsID:e.references.map(function(e){return e.id}),isInstance:!1,onComplete:function(n){var o=n?f.getResultIntersectionOfTerminologies(n,!1):[];e.initialSelectedTerminologies=o,t(o)},onFailure:function(e){t([])}})})},getAssociatedTerms:function(){return new Promise((e,t)=>{this.instances&&this.instances.length>0?f.getAssociatedTermsPerInstance({itemsID:this.instances.map(function(e){return e.id})}).then(t=>{this._selectedItems=t.nodesPerInstances,this.initialSelectedTerms=t.intersection,this._currentSelection=this.initialSelectedTerms.map(e=>({id:e})),e(t.intersection)}).catch(t):e(null)})},displayAssociateTerminologies:function(e){this.setValuesAutocomplete(this.autocompleteTerminologies,e),this.saveInfoSelection(this.autocompleteTerminologies)},displayAssociateTerms:function(e){this.setValuesAutocomplete(this.autocompleteTerms,e),this.saveInfoSelection(this.autocompleteTerms)},saveInfoSelection:function(e){(e.selectedItems||[]).forEach(e=>{this.saveNode(e)})},saveNode:function(e){this.mapTerminologyinfo[e.id]={id:e.id,title:e.options.title,name:e.options.name,predicatename:e.options.predicatename||void 0};var t=e.getParents();if(t.length>0){var n=e.getRoot(),o=t.map(e=>e.id),i=t.map(e=>e.options.title);o.splice(-1),i.splice(-1);var s=[e.id].concat(o),r=[e.options.title].concat(i);this.mapTerminologyinfo[e.id].parentTerminology={id:n.id,title:n.options.title},this.mapTerminologyinfo[e.id].path=s,this.mapTerminologyinfo[e.id].pathTitle=r,this.mapTerminologyinfo[e.id].predicatename=n.options.predicatename||void 0}return this.mapTerminologyinfo[e.id]},updateAssociatedTerminologies:function(){this.getAssociatedTerminologies().then(e=>{e&&this.displayAssociateTerminologies(e)})},updateAssociatedTerms:function(){this.getAssociatedTerms().then(e=>{e&&this.displayAssociateTerms(e)})},getTerminologies:function(){var e=this;return new Promise(function(t,n){f.searchTerminologies({searchTerms:!1,onComplete:function(n){var o=n.results,i=e.parseDataSearch(o),s={};s.terminologies=i||[],e.instances&&e.instances.length>0&&i&&i.length>0?f.expandV2Terms({physicalIds:i.map(function(e){return e.id}),onComplete:function(n){var o=e.parseDataExpandV2(n)||{};UWA.extend(o,s),o.terminologies=i||[],t(o)},onFailure:function(e){g.displayNotification({message:S.error_get_terms,className:"error"}),t(s)}}):t(s)},onFailure:function(e){console.log(e),g.displayNotification({message:S.error_get_terminologies,className:"error"}),t({})}})})},parseDataExpandV2:function(e){var t=e.results,n=[],o=[];return t&&t.length>0?(t.forEach(function(e){e.from&&e.to?o.push({parent:e.from,child:e.to}):"Term"===e["ds6w:type"]&&n.push({label:e["ds6w:label"],id:e.resourceid,name:e.name,icon:e.icon})}),{terms:n,relationsTerms:o}):null},parseDataSearch:function(e){var t=[];return e&&e.length>0&&e.forEach(function(e){var n=e.attributes,o={};n.forEach(function(e,t){"resourceid"===e.name&&(o.id=e.value),"name"===e.name&&(o.name=e.value),"ds6w:label"===e.name&&(o.label=e.value),"type_icon_url"===e.name&&(o.icon=e.value),"predicatename"===e.name&&(o.predicatename=e.value)}),t.push(o)}),t}})}),define("DS/TerminologySelector/commands/TerminologyManagementCommand",["DS/Windows/ImmersiveFrame","DS/TerminologySelector/commands/TerminologyGlobalCommand","DS/TerminologySelector/TerminologyManagement/TerminologyManagement","DS/IPClassifyUtil/IPClassifyAlert","DS/TerminologySelector/service/TerminologyWebService","i18n!DS/TerminologySelector/assets/nls/TerminologySelector"],function(e,t,n,o,i,s){"use strict";return t.extend({labelTopBar:s.terminology_management,init:function(e){this._parent(e)},launchComponent:function(t){this._parent(t);var o=[],i=[],s=!0;if(t.forEach(function(e){e.getID()&&o.push({id:e.getID(),label:e.getLabel()}),s&&e.getRelationID&&e.getRelationID()?i.push({id:e.getRelationID()}):(s=!1,i=[])}),o&&o.length>0||i&&i.length>0){let t=require("DS/PADUtils/PADContext"),s=!1;t.get()&&(s=t.get().associateStructure);let r=widget.immersiveFrame;r||(r=new e).inject(widget.body),new n({immersiveFrame:r,container:document.body,references:o,instances:i,associateStructure:s})}},isValidSelection:function(e,t){this._parent(e,t);return new Promise(function(n){var o=!0,s=[],r=[];if(e.forEach(function(e){if(e.getID()){var n=e.options.type||e.getType&&e.getType();if(n){if(n&&!t.includes(n))return void(o=!1)}else r.push(e.getID());if(e.getRelationID&&e.getRelationID())if(e.options.relationtype){if(e.options.relationtype&&!t.includes(e.options.relationtype))return void(o=!1)}else s.push(e.getRelationID())}else o=!1}),o)if(r.length>0||s.length>0){var a=[r.length>0?i.canBeAddedToBrowsingStructure({objectIds:r}):{isValid:!0},s.length>0?i.canBeAddedToBrowsingNode({objectIds:s}):{isValid:!0}];Promise.all(a).then(function(e){var t=e[0],o=e[1];t.isValid&&o.isValid?n(!0):n(!1)}).catch(function(){n(!1)})}else n(!0);else n(!1)})}})});