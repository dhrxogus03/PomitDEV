define("DS/CAT3DAnnotPlayServices/CAT3DAnnotPlayServices",["DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController"],function(e,t,r,n,i){"use strict";let o=null;return{getContextualCommandList:function({ctxViewer:t,getSelectedAnnotationsVisibilityFlag:r}){let n=!1;t.getExecutionContext&&(n=!0);let i,o=[];if(!t)return o;let a=e.get(),l=t.getRootBagPath();const s=e.get().map(e=>{if(l.isAParentOf(e.pathElement)||e.pathElement.getLastElement(!0).getAnnotationClassType)return e.pathElement}).filter(e=>{if(e)return e});if(0===s.length)return o;let c=!1,p=!1;for(i=0;i<s.length;i++){if(!c){let e="function"==typeof r&&r();if(!0===e||!1===e||void 0===e){let t;t=1===a.length&&(a[0].pathElement.getLastElement(!0).getAnnotationClassType&&"tpsAnnotationSet"===a[0].pathElement.getLastElement(!0).getAnnotationClassType()||!a[0].pathElement.getLastElement(!0).getAnnotationClassType)?e?"CAT3DAnnotationSetHideHdr":"CAT3DAnnotationSetShowHdr":e?"CAT3DAnnotationHideHdr":"CAT3DAnnotationShowHdr",n?o.push({type:"handler",identifier:t}):o.push({line:1,name:e?"CAT3DAnnotationHideStr":"CAT3DAnnotationShowStr",hdr_list:[t]}),c=!0}}let e=s[i].getParentPath(),t=s[i].getLastElement(!0);(t.getAnnotationClassType&&"tpsAnnotationSet"!==t.getAnnotationClassType()||!t.getAnnotationClassType)&&1===s.length&&(p||e&&"RootBag"!==e.getLastElement(!0).name&&(n?o.push({type:"handler",identifier:"CAT3DAnnotationLevelSelectorHdr"}):o.push({line:1,name:"CAT3DAnnotationLevelSelectorStr",hdr_list:["CAT3DAnnotationLevelSelectorHdr"]}),p=!0))}return n?{WAfrCtxBarRow1:{model:o}}:{cmdList:o}},initSelAndPrefMgrs:async function({ctxViewer:e}){let a=n.getSelectionManager({context:e});a.setActiveState(!0);let l=t.getPreferenceManager({context:e.getFrameWindow()});await i.initPrefManager({context:e.getFrameWindow()});let s,c={},p=!1,g="Perspective",f=!1,u="selectParentReference";if(l){l.setUnitsPreferencesDisplayFlag(!0),l.setDisplayPreferencesDisplayFlag(!0),l.set3DSelectionPreferencesDisplayFlag(!0),l.setMeasurePreferencesDisplayFlag(!0),l.setClippingPreferencesDisplayFlag(!0);let t=i.getPreferenceDefinitions({attributePrefs:!1});s=t[0].id,l.addPreferences(t),o=l.subscribe("com.ds.mep:onPrefUpdate",function(t){let r=JSON.parse(t[1].preferences);for(let e=0;e<r.repositories.length;e++)for(let t=0;t<r.repositories[e].preferences.length;t++)"SelectParentReferenceOr3DShape"===r.repositories[e].preferences[t].name?(c.selectParentReferenceOr3DShape=r.repositories[e].preferences[t].value,u=c.selectParentReferenceOr3DShape):"Select3DGeometry"===r.repositories[e].preferences[t].name?(c.select3DGeometry="true"===r.repositories[e].preferences[t].value,f=c.select3DGeometry):"ProjectionType"===r.repositories[e].preferences[t].name?(c.projectionType=r.repositories[e].preferences[t].value,g=c.projectionType):"Gravity"===r.repositories[e].preferences[t].name&&(c.gravity="true"===r.repositories[e].preferences[t].value,p=c.gravity);if(e&&e.getViewer()&&e.getViewer().currentViewpoint&&e.getViewer().currentViewpoint.control){let t=c.gravity?c.gravity:p;e.getViewer().currentViewpoint.getControl().setRotationRolling(!t),e.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!t)}if(e&&e.getViewer()&&e.getViewer().currentViewpoint&&e.getViewer().currentViewpoint.setProjectionType(c.projectionType?c.projectionType:g),a){let e=c.select3DGeometry?c.select3DGeometry:f;a.setPicking(e?0:1)}if(a){let e=c.selectParentReferenceOr3DShape?c.selectParentReferenceOr3DShape:u;a.selectParentReference("select3DShape"!==e)}}),r.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]}]).then(t=>{let r=t.repositories;for(let e=0;e<r.length;e++)if("VisualizationRepository"===r[e].name)p="true"===r[e].preferences[0].value;else if("FrameGeneral"===r[e].name)g=r[e].preferences[0].value;else if("SelectionRepository"===r[e].name){let t=r[e].preferences;for(let e=0;e<t.length;e++)"Select3DGeometry"===t[e].name?f="true"===t[e].value:"SelectParentReferenceOr3DShape"===t[e].name&&(u=t[e].value)}"boolean"==typeof p&&(e.getViewer().currentViewpoint.getControl().setRotationRolling(!p),e.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!p)),"Perspective"!==g&&"Parallel"!==g||e.getViewer().currentViewpoint.setProjectionType("Perspective"===g?0:1),a&&a.setPicking(f?0:1),a&&a.selectParentReference("select3DShape"!==u)}).catch(t=>{"boolean"==typeof p&&(e.getViewer().currentViewpoint.getControl().setRotationRolling(!p),e.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!p)),"Perspective"!==g&&"Parallel"!==g||e.getViewer().currentViewpoint.setProjectionType("Perspective"===g?0:1),a&&a.setPicking(f?0:1),a&&a.selectParentReference("select3DShape"!==u),window.console.warn("Could not get server value, default value set instead.",t)})}return{selMgr:a,prefMgr:l,prefID:s,tokenPrefMgr:{}}},cleanSelAndPrefMgrs:function({ctxViewer:e,selMgr:r,prefMgr:a,prefID:l,tokenPrefMgr:s}){if(e){if(a&&s){a&&a.removePreferences([l]);let r=Object.keys(s);for(let e=0;e<r.length;e++)a.unsubscribe(s[r[e]]);o&&(a.unsubscribe(o),o=null),i.cleanPrefManager(),t.unreferencePreferenceManager({context:e.getFrameWindow()})}r&&n.unreferenceSelectionManager({context:e})}}}});