/*!  COPYRIGHT DASSAULT SYSTEMES 2021   */
define("DS/ENOXInterWdgCom/views/ENOWidgetLinkOptionsPanel",["css!DS/ENOXInterWdgCom/ENOXInterWdgCom","UWA/Controls/Abstract","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ButtonGroup","i18n!DS/ENOXInterWdgCom/assets/nls/ENOXInterWdgCom.json","DS/Controls/TooltipModel","DS/Windows/ImmersiveFrame","DS/Windows/Dialog"],function(t,i,e,n,s,d,o,r,a){"use strict";return i.extend({name:"pad3dviewer-widgetlinkoptions-panel-body",_modal:null,init:function(t){this._parent(t);var i=this;this._features=t.features;let h=new e({onClick:i._onOKDialog.bind(i),domId:"PAD3DWidgetLinkOptionsPanel-OK-button",disabled:!1}),l=UWA.createElement("div",{class:this.getClassNames()}),g=d.widgetLinkOptionsPanel.subTitle;g+="<br><br>",UWA.createElement("div",{class:this.getClassNames()+"-subTitle",content:g}).inject(l);let u=UWA.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question eno-widgetlink-options-tooltip"});u.tooltipInfos=new o({shortHelp:d.widgetLinkOptionsPanel.contentHelp});let c=UWA.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question eno-widgetlink-options-tooltip"});c.tooltipInfos=new o({shortHelp:d.widgetLinkOptionsPanel.viewPointHelp}),this.buttonGroup=new s({type:"checkbox"});let _=!0;for(let i in t.features)t.features[i]||(_=!1);let p=new n({type:"checkbox",label:d.widgetLinkOptionsPanel.all,value:0,checkFlag:_}),b=!1;p.addEventListener("buttonclick",function(t){b=!0,k.checkFlag=p.checkFlag,y.checkFlag=p.checkFlag,b=!1});let k=new n({type:"checkbox",label:d.widgetLinkOptionsPanel.content,value:1,checkFlag:t.features.Content});u.inject(k.getContent());let y=new n({type:"checkbox",label:d.widgetLinkOptionsPanel.viewPoint,value:2,checkFlag:t.features.ViewPoint});c.inject(y.getContent()),this.buttonGroup.addEventListener("change",function(t){if(!b){let t=Object.keys(i._features).length;i.buttonGroup.value.length===t?(p.mixedState=!1,p.checkFlag=!0):i.buttonGroup.value.length>0&&i.buttonGroup.value.length<t?(p.checkFlag=!1,p.mixedState=!0):(p.mixedState=!1,p.checkFlag=!1)}}.bind(this)),this.buttonGroup.addChild(k),this.buttonGroup.addChild(y),p.inject(l),this.buttonGroup.inject(l);var f=new r({identifier:"widgetlink-options_immersive-frame"});f.inject(document.getElementsByClassName("disableMainUX")[0]);i=this;this._dialog=new a({domId:"widgetlink-options-dialog-frame",immersiveFrame:f,width:"auto",height:"auto",title:d.widgetLinkOptionsPanel.title,content:l,modalFlag:!1,resizableFlag:!1,closeButtonFlag:!1,buttons:{Ok:h,Cancel:new e({onClick:i._onCloseDialog.bind(i),domId:"PAD3DWidgetLinkOptionsPanel-Cancel-button"})}})},_onCloseDialog:function(t){this.dispatchEvent("onCancel",{event:t}),t.dsModel.dialog.close()},_onOKDialog:function(t){this.dispatchEvent("onConfirm",{features:this.buttonGroup.value}),t.dsModel.dialog.close()},getDialog:function(){return this._dialog}})}),define("DS/ENOXInterWdgCom/LinkManager",["text!DS/ENOXInterWdgCom/assets/init/ENOWidgetLinkEvents.json","DS/PADServices/utils/PADTrackerManager","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADContext","DS/PADServices/utils/GlobalModelEvents","DS/PADUtils/PADSettingsMgt"],function(t,i,e,n,s,d){"use strict";var o=JSON.parse(t),r=!1;function a(){this._widgetLink=null,this._biFilterReady=!1,this._linkedAppsBIFilterReady=!1,this._subscriptions=new Map,this._attemptedSubscriptions=new Map,this._initiatorLinks=new Map,this._isSynchronizing=!1,this._matchingFeatures=[],this._isInitiator=!1,this._initiatorHasBeenSet=!1,this._receivedInitEvent=!1,this._nbLinkedWithSync=0,this._readyForSync=!1,this._waitingForPanelConfirmation=!1,this._nbReadyForSync=0,this._widgetsWithErrors=[],this._countFinishedSync=0,this._WidgetLinkAMD="DS/WidgetLink/WidgetLink"}a.prototype.initializeWidgetLink=function(t,i){const e=parent.require?parent.require:require;return new Promise((o,r)=>{!window.__karma__||d.getSetting("widgetlink-odt")?e([this._WidgetLinkAMD],function(e){let d=this;if(this.getSyncFeatures())this._syncFeatures=this.getSyncFeatures();else{let t={Content:!0,ViewPoint:!0};this.setSyncFeatures(t),this._syncFeatures=t}if(this._widgetLink=e.get(t),t){this._widgetLink.setLinkability(i),this._setMatchingFeatures(this._widgetLink.getLinked()),this.addWidgetLinkHit("initialize",t.getValue("appId")),this._nbLinkedBeforeLink=this.getLinked().length,this._linkViewAllSync=this._widgetLink.createView(t=>t.matchLinkability().matchingImplements.includes("ENXContentSync2D")||t.matchLinkability().matchingImplements.includes("ENXContentSync3D")),s.subscribeOnce({event:"ENXModel/Root/FBIProxy"},()=>{d._biFilterReady=!0,d._widgetLink.publish("DS/ExternalWdgtCom/BIFilterReady"),d.getLinkability().implements.includes("ENXContentSync3D")&&this.getLinked().filter(function(t){t.matchLinkability().matchingImplements.includes("ENXContentSync3D")&&n.get().getStatusBar&&n.get().getStatusBar()&&n.get().getStatusBar().toggleWidgetLinkOptions&&n.get().getStatusBar().toggleWidgetLinkOptions(!0)})}),this._biFiltersReadyPromise=new Promise(function(t){this._resolveBIFiltersPromise=t}.bind(this)),this._nbBIFilterReadyReceived=0,this._widgetLink.subscribe("DS/ExternalWdgtCom/BIFilterReady",function(){this._nbBIFilterReadyReceived++,this.getLinkedWithMatchingFeatures(["ENXContentSync2D","ENXContentSync3D"]).length===this._nbBIFilterReadyReceived&&(d._linkedAppsBIFilterReady=!0,d._biFilterReady?d._resolveBIFiltersPromise():s.subscribeOnce({event:"ENXModel/Root/FBIProxy"},()=>{d._resolveBIFiltersPromise()}))}.bind(this)),this._widgetLink.subscribe("DS/ExternalWdgtCom/IsBIFilterReady",function(){this._biFilterReady&&this._widgetLink.publish("DS/ExternalWdgtCom/BIFilterReady")}.bind(this)),this._allSubscribeAfterLinkReady=new Promise(function(t){this._resolveAllSubscribeAfterLinkReady=t}.bind(this)),this._subscribeAfterLinkReady=new Promise(function(t){this._resolveSubscribeAfterLinkReady=t}.bind(this)),this._nbSubscribeAfterLinkReceived=0,this._widgetLink.subscribe("DS/ExternalWdgtCom/SubscribeAfterLinkReady",function(){let t=this.getLinkedWithMatchingFeatures(["ENXContentSync2D","ENXContentSync3D"]).length;this._nbSubscribeAfterLinkReceived++,this._nbSubscribeAfterLinkReceived>=t&&(this._isSubscribeAfterLinkReady?this._resolveAllSubscribeAfterLinkReady():this._subscribeAfterLinkReady.then(()=>{this._resolveAllSubscribeAfterLinkReady()}))}.bind(this)),this._widgetLink.subscribe("DS/ExternalWdgtCom/IsSubscribeAfterLinkReady",function(){this._isSubscribeAfterLinkReady&&this._widgetLink.publish("DS/ExternalWdgtCom/SubscribeAfterLinkReady")}.bind(this)),this._widgetLink.subscribe("DS/ExternalWdgtCom/GetSyncFeatures",function(){this._linkViewAllSync.publish("DS/ExternalWdgtCom/PublishSyncFeatures",{widgetID:t.id,syncFeatures:this._syncFeatures})}.bind(this)),this._readyForSyncPromise=new Promise(function(t){this._resolveReadyForSyncPromise=t}.bind(this)),this._nbReadyForSync=0,this._widgetLink.subscribe("DS/InternalWdgtCom/ReadyForSync",function(){let t=this.getLinkedWithMatchingFeatures(["ENXContentSync2D","ENXContentSync3D"]).length;if(this._syncEnded=!1,this._isInitiator&&!this._waitingForPanelConfirmation){let i=t-this._nbLinkedWithSync;this._nbReadyForSync++,i===this._nbReadyForSync&&(this._readyForSync?(this._onSync(),this._isInitiator=!1):this._readyForSyncPromise.then(function(){this._onSync(),this._isInitiator=!1}.bind(this)),this._nbLinkedWithSync=t)}}.bind(this)),this._widgetLink.subscribe("DS/InternalWdgtCom/InitiatorSet",function(t){this._initiatorHasBeenSet=!0,this.setSourceWidgetId(t.initiatorID)}.bind(this)),this._widgetLink.subscribe("DS/InternalWdgtCom/LinkBIProxyOfLinks",function(t){this._linkBIProxyOfLinks()}.bind(this)),this._widgetLink.subscribe("DS/InternalWdgtCom/SetInitiatorOnLoad",function(i){i.fromLink?i.fromWidgetId&&-1===i.fromWidgetId.localeCompare(t.id)&&(this._setInitiatorOnLoad(i.fromWidgetId),this._receivedInitEvent=!0):(this._setInitiatorOnLoad(i.fromWidgetId),this._receivedInitEvent=!0)}.bind(this)),this._widgetLink.addEventListener("link",this._onLink.bind(this)),this._widgetLink.addEventListener("unlink",this._onUnLink.bind(this));let e=this.getLinked().length,o=0;this._widgetLink.subscribe("DS/InternalWdgtCom/WidgetLinkInitialized",function(i){++o===i.nbLinked&&this._widgetLink.publish("DS/InternalWdgtCom/SetInitiatorOnLoad",{fromWidgetId:t.id})}.bind(this)),this._widgetLink.publish("DS/InternalWdgtCom/WidgetLinkInitialized",{fromWidgetId:t.id,nbLinked:e}),this._isLoaded=!0,this._nbLinkedWithSync=this.getLinkedWithMatchingFeatures(["ENXContentSync2D","ENXContentSync3D"]).length,this._widgetLink.subscribe("DS/ExternalWdgtCom/FinishedSync",this._onFinishSync.bind(this))}o()}.bind(this)):(console.warn("We are in karma test environment, thus preventing the use of WidgetLink."),o())})},a.prototype._setInitiatorOnLoad=function(t){this._initiatorHasBeenSet||(this._isInitiator=!0,this._initiatorLinks.set(t,!0),this._initiatorHasBeenSet=!0,this.setSourceWidgetId(widget.id),this._linkBIProxyOfLinks(),this._widgetLink.publish("DS/InternalWdgtCom/InitiatorSet",{initiatorID:widget.id}),this._widgetLink.publish("DS/InternalWdgtCom/LinkBIProxyOfLinks"))},a.prototype._setMatchingFeatures=function(t){let i=[];t.forEach(t=>{let e=t.matchLinkability().matchingFeatures;e.length>0&&(i=i.concat(e))}),this._matchingFeatures=[...new Set(i)]},a.prototype._onLink=function(t){return new Promise((i,e)=>{let d=this.getLinked().length-this._nbLinkedBeforeLink;this._nbLinkedBeforeLink=this.getLinked().length,void 0!==widget.id&&(t.initiator===widget.id?t.link.id!==widget.id?this._initiatorLinks.set(t.link.id,!0):t.target.id!==widget.id&&this._initiatorLinks.set(t.target.id,!0):t.link.id!==widget.id?this._initiatorLinks.set(t.link.id,!1):t.target.id!==widget.id&&this._initiatorLinks.set(t.target.id,!1)),void 0!==widget.id&&t.initiator===widget.id?(this._isInitiator=!0,this.setSourceWidgetId(widget.id),this._initiatorHasBeenSet=!0,this._widgetLink.publish("DS/InternalWdgtCom/InitiatorSet",{initiatorID:widget.id})):this._isInitiator=!1,d>0&&(this._biFiltersReadyPromise=new Promise(function(t){this._resolveBIFiltersPromise=t}.bind(this)),this._allSubscribeAfterLinkReady=new Promise(function(t){this._resolveAllSubscribeAfterLinkReady=t}.bind(this)),this._subscribeAfterLinkReady=new Promise(function(t){this._resolveSubscribeAfterLinkReady=t}.bind(this))),this._nbSubscribeAfterLinkReceived=0,this._nbBIFilterReadyReceived=0;let o=function(t,e){this.setWidgetSynchronizing(!1);let s=this._widgetLink.getLinked();e&&this._isInitiator&&(this._widgetLink.publish("DS/InternalWdgtCom/LinkBIProxyOfLinks"),this._linkBIProxyOfLinks()),this._setMatchingFeatures(s),t.link.id!==widget.id?this.addWidgetLinkHit("link",t.link.appId):this.addWidgetLinkHit("link",t.target.appId),this._linkViewAllSync.publish("DS/ExternalWdgtCom/IsBIFilterReady"),this._subscribeAfterLink().then(function(){this._isSubscribeAfterLinkReady=!0,this._resolveSubscribeAfterLinkReady(),this._widgetLink.publish("DS/ExternalWdgtCom/SubscribeAfterLinkReady"),this._isInitiator&&this._widgetLink.publish("DS/ExternalWdgtCom/IsSubscribeAfterLinkReady")}.bind(this));let d=[this._allSubscribeAfterLinkReady,this._biFiltersReadyPromise];Promise.all(d).then(function(){if(n.get()&&this._isLoaded){if(t.link.id!==widget.id?n.get()._onLink(t.link.id):t.target.id!==widget.id&&n.get()._onLink(t.target.id),this._isInitiator&&!this.isWidgetSynchronizing()){let i=this.createView(function(i){return i.id===g(t)}.bind(this)),n=!1;this.getLinkability().implements.includes("ENXContentSync3D")&&this.getLinked().filter(function(t){t.matchLinkability().matchingImplements.includes("ENXContentSync3D")&&(n=!0)}),n?i.publish("DS/ExternalWdgtCom/SyncContent3D",{fromWidgetId:widget.id}):e||(this._readyForSync=!0,this._resolveReadyForSyncPromise())}s.filter(function(t){t.matchLinkability().matchingImplements.includes("ENXContentSync3D")&&n.get().getStatusBar&&n.get().getStatusBar()&&n.get().getStatusBar().toggleWidgetLinkOptions&&n.get().getStatusBar().toggleWidgetLinkOptions(!0)})}this._nbReadyForSync=0,this._widgetLink.publish("DS/InternalWdgtCom/ReadyForSync",{fromWidgetId:widget.id}),i()}.bind(this))}.bind(this);if(n.get()&&n.get()._readyCheckPromises&&n.get()._readyCheckPromises.length>0)Promise.all(n.get()._readyCheckPromises).then(function(){o(t)});else if(this._biFilterReady)o(t);else{let i=s.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{this._widgetLink.publish("DS/InternalWdgtCom/WidgetLinkInitialized",{fromWidgetId:widget.id,nbLinked:this.getLinked().length}),o(t,!0),s.unsubscribe(i),this._biFilterReady=!0})}})},a.prototype._onUnLink=function(t){let i=t.link;if(this._nbLinkedBeforeLink=this.getLinked().length,i){let e;this._setMatchingFeatures(this._widgetLink.getLinked()),this._subscribeAfterLink(),this._biFilterReady?(this._resetSourceWidgetId(),this._unLinkBIProxy(i.id),this._initiatorHasBeenSet=!1):s.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{this._resetSourceWidgetId(),this._unLinkBIProxy(i.id)}),t.link.id!==widget.id?(this._initiatorLinks.set(t.link.id,!1),n.get()&&n.get()._onUnLink(t.link.id),e=t.link.appId):t.target.id!==widget.id&&(this._initiatorLinks.set(t.target.id,!1),e=t.target.appId,n.get()&&n.get()._onUnLink(t.target.id)),this.addWidgetLinkHit("unlink",e);let d=!1;this.getLinked().filter(function(t){t.matchLinkability().matchingImplements.includes("ENXContentSync3D")&&(d=!0)}),!d&&n.get()&&n.get().getStatusBar&&n.get().getStatusBar()&&n.get().getStatusBar().toggleWidgetLinkOptions&&n.get().getStatusBar().toggleWidgetLinkOptions(!1)}this._nbLinkedWithSync=this.getLinkedWithMatchingFeatures(["ENXContentSync2D","ENXContentSync3D"]).length},a.prototype.addWidgetLinkHit=function(t,e){var n=i.getPADTracker({eventCategory:"widgetlink",eventAction:t,appId:widget.getValue("appId")});n.setEventData({eventLabel:e,eventValue:e}),n.trackPageEvent()},a.prototype.updateLinkability=function(t){this._widgetLink?(this._widgetLink.setLinkability(t),this._setMatchingFeatures(this._widgetLink.getLinked()),this._subscribeAfterLink()):this._handleNoWidgetLink()},a.prototype.getLinkability=function(){if(this._widgetLink)return this._widgetLink.getLinkability();this._handleNoWidgetLink()},a.prototype.createView=function(t){if(this._widgetLink)return this._widgetLink.createView(t);this._handleNoWidgetLink()},a.prototype.subscribe=function(t,i){if(this._widgetLink){let e=t.split("/"),n=e[e.length-1],s=o[n];if(s){let e=s.feature,n=s.syncFeature,d=this._attemptedSubscriptions.get(t)||[];d.push(i),this._attemptedSubscriptions.set(t,d);let o=function(t,i){let e=this._widgetLink.subscribe(t,i);return this._subscriptions.set(t,e),e}.bind(this);if(this._matchingFeatures.includes(e))return o(t,i);if("ENXContentSync"===e&&(this._matchingFeatures.includes("ENXContentSync2D")||this._matchingFeatures.includes("ENXContentSync3D"))){if(!n)return o(t,i);if(this._syncFeatures&&this._syncFeatures[n])return o(t,i)}else{if("ENXContent"===e&&this._matchingFeatures.includes("ENXOpen"))return o(t,i);if("ENXAuthoring"===e&&(this._matchingFeatures.includes("ENXAuthoring2D")||this._matchingFeatures.includes("ENXAuthoring3D")))return o(t,i)}}}else this._handleNoWidgetLink()},a.prototype._reSubscribe=function(t,i){let e=l(t);if(e){let n=e.feature,s=e.syncFeature;if(this._matchingFeatures.includes(n))return this._widgetLink.subscribe(t,i);if("ENXContentSync"===n&&(this._matchingFeatures.includes("ENXContentSync2D")||this._matchingFeatures.includes("ENXContentSync3D"))){if(!s)return this._widgetLink.subscribe(t,i);if(this._syncFeatures[s])return this._widgetLink.subscribe(t,i)}else{if("ENXContent"===n&&this._matchingFeatures.includes("ENXOpen"))return this._widgetLink.subscribe(t,i);if("ENXAuthoring"===n&&(this._matchingFeatures.includes("ENXAuthoring2D")||this._matchingFeatures.includes("ENXAuthoring3D")))return this._widgetLink.subscribe(t,i)}}},a.prototype._subscribeAfterLink=function(){return new Promise(function(t,i){for(const[t,i]of this._attemptedSubscriptions){this.unsubscribe(t);for(let e=0;e<i.length;e++)this._reSubscribe(t,i[e])}t()}.bind(this))},a.prototype.unsubscribe=function(t){this._widgetLink?this._widgetLink.unsubscribe(t):this._handleNoWidgetLink()},a.prototype.publish=function(t,i){if(this._widgetLink){if(this._widgetLink.getLinked().length>0){let e=t.split("/"),n=e[e.length-1],s=o[n].syncFeature;s?this._syncFeatures[s]&&this._widgetLink.publish(t,i):this._widgetLink.publish(t,i)}}else this._handleNoWidgetLink()},a.prototype.getLinkedWithAppId=function(t){return this.getLinked().filter(i=>i.appId===t)},a.prototype.setSourceWidgetId=function(t){this._linkSrcWdgtID=t},a.prototype.getSourceWidgetId=function(){return this._linkSrcWdgtID},a.prototype._resetSourceWidgetId=function(){this.getPreviousNGFUXID()?this._linkSrcWdgtID=this.getPreviousNGFUXID():this._linkSrcWdgtID=widget.id},a.prototype._linkBIProxyOfLinks=function(){if(this.getSyncFeature("Content")){let t=this.getLinkedWithMatchingFeatures(["ENXContentSync2D","ENXContentSync3D"]);if(t.length>0){let i=new Map,e=function(){try{t.forEach(t=>{let e=widget.id===t.id?t._widgetLink.id:t.id;i.get(e)&&i.get(e).Content&&(this._biFilterReady?n.get()._linkBIProxy(this._linkSrcWdgtID):s.subscribeOnce({event:"ENXModel/Root/FBIProxy"},()=>{n.get()._linkBIProxy(this._linkSrcWdgtID)}))})}catch(t){console.error(t.stack),console.error("Something went wrong with WidgetLink BIProxy")}}.bind(this),d=0,o=this._widgetLink.subscribe("DS/ExternalWdgtCom/PublishSyncFeatures",s=>{i.set(s.widgetID,s.syncFeatures),++d===t.length&&(this._widgetLink.unsubscribe(o),n.get()&&this._linkedAppsBIFilterReady?e():this._biFiltersReadyPromise.then(()=>{e()}))});this._linkViewAllSync.publish("DS/ExternalWdgtCom/GetSyncFeatures")}}},a.prototype.addEventListener=function(t,i){return this._widgetLink?this._widgetLink.addEventListener(t,i):void this._handleNoWidgetLink()},a.prototype.getLinked=function(){return this._widgetLink?this._widgetLink.getLinked():(this._handleNoWidgetLink(),[])},a.prototype.getLinkedWithMatchingFeatures=function(t){return this._widgetLink?this.getLinked().filter(function(i){let e=i.matchLinkability().matchingFeatures;for(let i=0;i<t.length;i++)if(e.includes(t[i]))return!0;return!1}):void this._handleNoWidgetLink()},a.prototype.setLinked=function(t){this._widgetLink?"undefined"!=typeof widget&&widget.id&&top.require("DS/Dashboard/WidgetLinkManager").setLinked(widget.id,t):this._handleNoWidgetLink()},a.prototype._handleNoWidgetLink=function(){r||(console.error("Widget Link is not initialized, further calls to Widget Link will be ignored"),r=!0)},a.prototype._onSync=function(){if(this.getSyncFeature("Content")&&!n.get()._isChoosingWLOptionsFromLink){let t=this.getLinked().filter(t=>t.matchLinkability().matchingImplements.includes("ENXContentSync2D")||t.matchLinkability().matchingImplements.includes("ENXContentSync3D"));if(t.length>0){let i=0;this._nbWdgtsToSync=0;let e=[n.get()._onGetInfosForSync({fromLinkManager:!0})],s=this._widgetLink.subscribe("DS/ExternalWdgtCom/GetInfosForSync",n=>{if(e.push(n),i++,n.is3D?!n.isChoosingWLOptionsFromLink&&n.contentFeatureEnabled&&this._nbWdgtsToSync++:this._nbWdgtsToSync++,i===t.length&&(this._widgetLink.unsubscribe(s),this._nbWdgtsToSync>0)){let t=0;for(let i=0;i<e.length;i++)if(e[i].content.length>0){t=i;break}this._nbWdgtsToSync++,this._launchSync(e[t])}});this._linkViewAllSync.publish("DS/ExternalWdgtCom/GetInfosForSync",{get:!0,fromLinkManager:!0})}}},a.prototype._launchSync=function(t){let i={fromWidgetId:widget.id,srcWidgetID:t.id,rootsToSync:t.content,hiddenPaths:t.hiddenPaths,shownPaths:t.shownPaths,nbWdgtsToSync:this._nbWdgtsToSync};this._widgetsWithErrors=[],n.get()._onSyncContent(i),this._linkViewAllSync.publish("DS/ExternalWdgtCom/SyncContent",i)},a.prototype._onFinishSync=function(t){t&&t.notSupportedError&&this._widgetsWithErrors.push(t.notSupportedError),this._countFinishedSync++,this._countFinishedSync>=this._nbWdgtsToSync&&(this._syncEnded||(n.get()._endSync({isInitiator:!0,widgetsWithErrors:this._widgetsWithErrors}),this._linkViewAllSync.publish("DS/ExternalWdgtCom/EndSync",{widgetsWithErrors:this._widgetsWithErrors}),this._syncEnded=!0,this._nbWdgtsToSync=0,this._countFinishedSync=0))},a.prototype.isLinkedWithPartnerApp=function(t){let i=this.getLinked();return!!i&&i.filter(i=>i.x3dSharedId===t).length>0},a.prototype._unLinkBIProxy=function(t){if(n.get()){let i=this._initiatorLinks.get(t)?widget.id:t;n.get()._unLinkBIProxy(i),this._isInitiator=!1,delete this._linkSrcWdgtID}},a.prototype.isWidgetSynchronizing=function(){return this._isSynchronizing},a.prototype.setWidgetSynchronizing=function(t){this._isSynchronizing=t},a.prototype.enableSyncFeature=function(t){this._syncFeatures[t]=!0,this.setSyncFeatures(this._syncFeatures);for(const[i,e]of this._attemptedSubscriptions){if(l(i).syncFeature===t){this.unsubscribe(i);for(let t=0;t<e.length;t++)this._reSubscribe(i,e[t])}}},a.prototype.disableSyncFeature=function(t){this._syncFeatures[t]=!1,this.setSyncFeatures(this._syncFeatures);for(const[t,i]of this._attemptedSubscriptions){let i=l(t);void 0===i.syncFeature||this._syncFeatures[i.syncFeature]||this.unsubscribe(t)}},a.prototype.getSyncFeatures=function(){return widget&&void 0!==widget&&"function"==typeof widget.getValue&&widget.getValue("syncFeatures")?JSON.parse(widget.getValue("syncFeatures")):void 0},a.prototype.getSyncFeature=function(t){if(this._syncFeatures)return this._syncFeatures[t]},a.prototype.setSyncFeatures=function(t){widget&&"undefined"!=typeof widget&&widget.setValue("syncFeatures",JSON.stringify(t))},a.prototype.isLinkInitiator=function(){return this._isInitiator},a.prototype.isInitiatorOfLink=function(t){return this._initiatorLinks.get(t)},a.prototype.getPreviousNGFUXID=function(){return this._previousNGFUXID},a.prototype.setPreviousNGFUXID=function(t){this._previousNGFUXID=t};let h,l=function(t){let i=t.split("/"),e=i[i.length-1];return o[e]},g=function(t){return widget&&"undefined"!=typeof widget?t.target.id===widget.id?t.link.id:t.target.id:null};return h||(h=new a)}),define("DS/ENOXInterWdgCom/Proxy",["i18n!DS/PADUtils/assets/nls/PADUtils.json","text!DS/ENOXInterWdgCom/assets/conf/InterCommWdg.json","DS/PlatformAPI/PlatformAPI","DS/ENOXInterWdgCom/LinkManager","DS/Utilities/UUID","DS/PADUtils/PADSettingsMgt"],function(t,i,e,n,s,d){"use strict";var o=JSON.parse(i),r={};for(var a in o.events)if(void 0!==o.events[a]){var h=l(a);o.events[a].callback=h,r[h]=a}function l(t){return"on"+t.charAt(0).toUpperCase()+t.slice(1)}function g(t,i,e){var n=i+t;return e&&void 0!==o.events[t]&&!0===o.events[t].private&&(n+=e),n}function u(t){for(var i in t)void 0!==t[i]&&void 0===p.prototype[i]&&(p.prototype[i]=function(t){return function(i){this.__publish(t,i)}}(i))}function c(t,i,e){return{metadata:{uid:s.v4(),originUid:t,timestamp:Date.now(),appid:(n="/no_private_channel","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?n="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?n="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(n="/"+widget.getValue("appId")+"_"+widget.id)),n),xappid:"undefined"!=typeof widget&&null!==widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"default-app-id",originWidgetId:void 0!==e?e:"undefined"!=typeof widget&&null!==widget?widget.id:"default-widget-id"},data:i};var n}function _(t,i,e,n,s){this.ownerProxyUid=t,this.eventHandlingFunction=i,this.ignoreMyEvents=e,this.lastConsumeEvent=void 0,this.topic=n,this.isPrivate=s,s&&(this.topic=this.topic.substr(0,this.topic.lastIndexOf("/")))}function p(t){if(this._uid=s.v4(),this._commands=t.commands,this._subs=[],this._widgetLinkSubs=[],this._debugAppId="unknown","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?this._debugAppId=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(this._debugAppId=widget.data.x3dAppId)),t.commands){for(var i in t.commands)if(void 0!==t.commands[i]&&void 0===o.events[i]){o.events[i]=Object.assign(t.commands[i],{undefinedDefaultEvent:!0});var e=l(i);o.events[i].callback=e,r[e]=i}u(t.commands),this._cmds=t.commands}this._otherPrefix=t.prefix,this._privateChannel=t.privateChannel,this.addProxyEvents(t)}return u(o.events),_.prototype.handleEvent=function(t){if(!(!0===this.ignoreMyEvents&&t.metadata.originUid===this.ownerProxyUid||!0===t.metadata.ignoreFromSameWidgetId&&t.metadata.originWidgetId===("undefined"!=typeof widget&&null!==widget?widget.id:"")))try{if(this.lastConsumeEvent!==t.metadata.uid){this.lastConsumeEvent=t.metadata.uid;let i="unknown";"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?i=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(i=widget.data.x3dAppId)),this.isPrivate&&console.warn("3DEXPERIENCER2023XFD02 : Received "+this.eventHandlingFunction.name+" using PlatformAPI. PlatformAPI for Interwidget communication is now deprecated, use WidgetLink instead, this support is gonna be removed soon"),this.eventHandlingFunction(t.data,t.metadata)}}catch(i){console.error("Error while handling event %o",t),console.error(i)}},_.prototype.handleEventWL=function(t){try{let i="unknown";"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?i=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(i=widget.data.x3dAppId)),t.metadata?this.lastConsumeEvent!==t.metadata.uid&&(this.lastConsumeEvent=t.metadata.uid,this.eventHandlingFunction(t.data,t.metadata)):this.eventHandlingFunction(t)}catch(i){console.error("Error while handling event %o",t),console.error(i)}},p.prototype.destroy=function(){this._subs&&(this._subs.forEach(function(t){e.unsubscribe(t)}),delete this._subs),this._widgetLinkSubs&&(this._widgetLinkSubs.forEach(function(t){n.unsubscribe(t)}),delete this._widgetLinkSubs),this.destroyed=!0},p.prototype.addProxyEvents=function(t){let i=t.prefix?t.prefix:this._otherPrefix,s=t.privateChannel?t.privateChannel:this._privateChannel,a=t.events;if(a)for(var h in a){var l=r[h];if(l){var u=a[h];if("function"==typeof u||Array.isArray(u)&&u.length>0&&"function"==typeof u[0]){var c,p=!0;"function"==typeof u?c=u:(c=u[0],p=u.length<2||!1!==u[1]);var b=g(l,o.prefix,s);let t=!!this._commands[l]&&this._commands[l].private;if(d.getSetting("activateWidgetLink")){var k=g(l,o.prefix);let d=!!this._commands[l]&&this._commands[l].isWidgetLink,r=!!this._commands[l]&&this._commands[l].isPlatformAPI;var y=new _(this._uid,c,p,b,t);let a=d&&"undefined"!=typeof widget&&null!==widget&&widget.data&&void 0===window.__karma__;a&&(n.subscribe(k,y.handleEventWL.bind(y)),this._widgetLinkSubs.push(k)),r&&this._subs.push(e.subscribe(b,y.handleEvent.bind(y))),i&&this._cmds[l]&&(b=g(l,i,s),k=g(l,i),a&&(n.subscribe(k,y.handleEventWL.bind(y)),this._widgetLinkSubs.push(k)),r&&this._subs.push(e.subscribe(b,y.handleEvent.bind(y))))}else{y=new _(this._uid,c,p,b,t);this._subs.push(e.subscribe(b,y.handleEvent.bind(y))),i&&this._cmds[l]&&(b=g(l,i,s),this._subs.push(e.subscribe(b,y.handleEvent.bind(y))))}}else console.warn("Input [events.%s] is not a function",h)}else console.info("Input [events.%s] is not a known event",h)}},p.prototype.__publish=function(t,i){if(!0===this.destroyed)throw new Error("This proxy has been destroyed");var s=g(t,o.prefix,this._privateChannel);if(d.getSetting("activateWidgetLink")){var r=g(t,o.prefix);let d=!!this._commands[t]&&this._commands[t].isWidgetLink,h=!!this._commands[t]&&this._commands[t].isPlatformAPI;var a=c(this._uid,i,this.odtWidgetId);let l=d&&"undefined"!=typeof widget&&null!==widget&&widget.data&&void 0===window.__karma__;l?n.publish(r,a):h&&e.publish(s,a,["web","web-in-win"]),this._otherPrefix&&(s=g(t,this._otherPrefix,this._privateChannel),r=g(t,this._otherPrefix),l&&n.publish(r,a),h&&e.publish(s,a,["web","web-in-win"]))}else{a=c(this._uid,i,this.odtWidgetId);this._subs.push(e.publish(s,a,["web","web-in-win"])),this._otherPrefix&&(s=g(t,this._otherPrefix,this._privateChannel),this._subs.push(e.publish(s,a,["web","web-in-win"])))}},p});