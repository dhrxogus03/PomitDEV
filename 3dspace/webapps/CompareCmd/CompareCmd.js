define("DS/CompareCmd/CompareCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/WAFData/WAFData","i18n!DS/CompareCmd/assets/nls/CompareCmd"],function(e,t,o,n,r,i){"use strict";var a=function(){};return a("compareCmd module is loading"),e.extend({name:"compare_command",context:null,defaultOptions:{disregardSelectedNodes:!1},init:function(e){if(this.context=e.context,this.runOptions=e.runOptions,this._parent(e,{mode:"exclusive",isAsynchronous:!1}),"CompareJSONHdr"==this._id&&(this.baseEnable=this.enable,this.baseDisable=this.disable,this.enable=function(e){null!=e&&"SnapshotsWidget"==e.by&&this.baseEnable()},this.disable=function(e){null!=e&&"SnapshotsWidget"==e.by&&this.baseDisable()}),null==this.context){var t=this;require(["DS/PADUtils/PADContext"],function(e){var o=e.get();if(null!=o&&(t.context=o,null!=t.context.getPADTreeDocument)){var n=t.context.getPADTreeDocument().getXSO();t._boundCheck=t.checkSelect.bind(t),n.onPostAdd(t._boundCheck),n.onPostRemove(t._boundCheck),t._isEnabled=t.getEnableCmd()}})}this.setCommandAvailability(this.getEnableCmd())},setCommandAvailability:function(e){var o=t.getCommand(this._id,this);o&&(!0===e?o.enable():o.disable())},getEnableCmd:function(){var e=this,t=!1;return n.hasRole(function(o){if(!0===o&&null!=e.context&&(e.context.getPADTreeDocument||"LifecycleWidget"===e.context.widgetType)){var n=0;n=e.context.getPADTreeDocument?e.context.getPADTreeDocument().getXSO().get().length:e.context.getSelectedNodes().length,t=n>0}},["InternalDS","PAR","PAU","CSV"]),t},checkSelect:function(){var e=this.getEnableCmd();this.setCommandAvailability(e)},beginExecute:function(){a("BEGIN EXECUTE of compareCmd")},execute:function(){var e=this.runOptions||{};switch(this._id){case"CompareHdr":return this.execute_CompareHdr(this.context,e);case"CompareJSONHdr":this.execute_CompareSnapshots();break;case"CompareV1Hdr":e.app="COMPARE",e.version="1";break;case"CompareV2Hdr":e.app="COMPARE",e.version="2";break;case"CompareNewRevFromHdr":e.app="NRF",e.version="2",e.cmdOptions={ImmediateCompare:!0,AllowCompareOfIdentical:!1,ImmediateRevisionOf:!0,AllowDuplicatesInRevisionsDialog:!1,DisableRootInRevisionsDialog:!0,ControlOKButtonInRevisionsDialog:!0,SupportsCompareCustomization:!1,input:[{NoDropZones:!0,NoFilterOf:!0,NoOpenContent:!0,NoRemove:!0},{NoDropZones:!0,NoFilterOf:!0,NoOpenContent:!0}]};break;case"CompareMergeHdr":e.app="MERGE",e.version="2",e.cmdOptions={ImmediateCompare:!1,AllowCompareOfIdentical:!1,ImmediateRevisionOf:!0,AllowDuplicatesInRevisionsDialog:!1,DisableRootInRevisionsDialog:!0,ControlOKButtonInRevisionsDialog:!0,RevisionsDialogOKButtonLabel:i.revisionsDialogOKButtonLabelMerge,SupportsCompareCustomization:!1,settings:[{Label:i.createARevisionNRF,Value:"viewSettings.MERGE_STRUCT_VIEW.createARevision"}],input:[{Label:i.leftDropLabelNRF,NoDropZones:!0,NoFilterOf:!0,NoOpenContent:!0,NoRemove:!0,RevisionsDialogTitle:i.leftRevisionsDialogTitleMerge},{Label:i.rightDropLabelNRF,NoDropZones:!0,NoFilterOf:!0,NoOpenContent:!0,RevisionsDialogTitle:i.rightRevisionsDialogTitleMerge}]};break;case"CompareProtoHdr":e.app="COMPARE",e.version="proto";break;default:return this.NLS_showMessage("cmdNotImplented","compare-alert-error"),!1}return this._execute_CompareApp(this.context,e)},endExecute:function(){},getTenant:function(){var e="undefined"!=typeof widget&&widget?widget.getValue("x3dPlatformId"):null;return null!=e&&""!=e||(e="OnPremise"),e},execute_CompareSnapshots:function(){var e=this,t=this.getTenant();return require(["DS/ListSnapshots/CmdCtx"],function(o){if(o){var n=o.ctx;if(null!=n&&null!=n.getCompareIDs&&"function"==typeof n.getCompareIDs)n.getCompareIDs(function(o){e.launchCompare(t,o)},function(e){this.NLS_showMessage("requestError","compare-alert-error")});else if(void 0===n){var r=[],i=e.options.CompareIds;null!=i&&i.forEach(function(e){r.push({ID:e,TYPE:"snapshotID"})}),e.launchCompare(t,r)}}else console.log("invalid prereq on DS/ListSnapshots/CmdCtx")}),!0},execute_CompareHdr:function(e,t){var o=this,n=this.getTenant(),r=this.getObjSpecArray(e),i=this.getFilterProxy(e);return this.validateInput(n,r,function(){o.launchCompare(n,r,i,t)})},_execute_CompareApp:function(e,t){t=t||{};var o=this,n=o.getTenant(),r=o.getObjSpecArray(e),i=o.getFilterProxy(e);t.viewDefType=null!=t.viewSetMod&&null!=t.viewSetName?"AS_GIVEN":"LOOKUP";return 1==t.skipValidate?o.launchCompare(n,r,i,t):this.validateInput(n,r,function(){o.launchCompare(n,r,i,t)})},getFilterProxy:function(e){var t=null;null!=e&&void 0!==e._biFilter&&null!==e._biFilter&&void 0!==e._biFilter._biFilter&&null!==e._biFilter._biFilter&&(t={appId:e._biFilter._biFilter._appId,widgetId:e._biFilter._biFilter._widgetId});return t},getObjSpecArray:function(e){var t=[];if(null!=e&&0==this.options.disregardSelectedNodes&&null!=e.getSelectedNodes&&"function"==typeof e.getSelectedNodes){var o=e.getSelectedNodes(),n=e.getSecurityContext().SecurityContext,r=this.getTenant();o.forEach(function(e){var o=e.getID(),i=(e.options||e.object).type;i||"function"!=typeof e.getType||(i=e.getType()),t.push({id:o,objIDType:"modelID",objType:i,contextId:n,objTenant:r})})}else t=this.options.CompareIds;return t},checkFormat_PhysID:function(e){if(null==e||e.constructor!=String||32!=e.length)return!1;for(var t=0;t<32;t++){var o=e.charAt(t);if(0==(o>="a"&&o<="f"||o>="A"&&o<="F"||o>="0"&&o<="9"))return!1}return!0},checkFormat_editCommands:function(e){if(null==e||e.constructor!=Array||0==e.length)return"Empty or missing edit commands";for(var t=0;t<e.length;t++){var o=e[t];if(null==o.op)return"Command is missing operator";switch(o.op){case"INSERT":if(0==this.checkFormat_PhysID(o.inNode))return"Bad or missing inNode in INSERT operation";break;case"REMOVE":if(0==this.checkFormat_PhysID(o.rmNode))return"Bad or missing rmnode in REMOVE operation";break;case"REPLACE":if(0==this.checkFormat_PhysID(o.inNode))return"Bad or missing inNode in REPLACE operation";if(0==this.checkFormat_PhysID(o.rmNode))return"Bad or missing rmnode in REPLACE operation";break;default:return"Unknown op: '"+o.op+"'"}if(0==this.checkFormat_PhysID(o.parent))return"Bad or missing parent"}return 0},validateInput:function(e,t,o){var i=this;if(null==t||t.constructor!=Array||0==t.length)return this.NLS_showMessage("objectNotSelected","compare-alert-error"),!1;if(t.length>5)return this.NLS_showMessage("selectFiveOrFewer","compare-alert-error"),!1;for(var a=[],s=[],l=0;l<t.length;l++){var c=t[l];if(null==c||""==c)return this.NLS_showMessage("objSpec is NULL","compare-alert-error"),!1;var u=null,p=null;if(u=c.constructor==String?c:c.id,null!=c.commands&&(p=c.commands),0==this.checkFormat_PhysID(u)){var d="Invalid root ID: "+u;return null!=c.commands&&(d+=" in objSpec: "+JSON.stringify(c)),this.NLS_showMessage(d,"compare-alert-error"),!1}if(null!=p){var m=this.checkFormat_editCommands(p);if(0!=m)return this.NLS_showMessage(m+" in objSpec: '"+JSON.stringify(c)+"'.","compare-alert-error"),!1}-1==a.indexOf(u)&&a.push(u),c.contextId&&s.push(c.contextId)}var h=a.join(),g=null;g=1==i.options.isODT?"/resources/compare/getObjState?objectIds="+h:n.get3DSpaceWSUrl(e,"/resources/compare/getObjState","objectIds="+h);var f={Accept:"application/json"};s.length&&(f.securityContext=s[0]);try{r.authenticatedRequest(g,{proxy:"passport",timeout:12e4,method:"GET",headers:f,onComplete:function(e){i.checkValidateResults(e,o)}})}catch(e){i.NLS_showMessage("requestError","compare-alert-error")}return!0},checkValidateResults:function(e,t){JSON.parse(e).results.forEach(function(e){if(0==e.exists)return this.NLS_showMessage("OBJ_NOT_FOUND","compare-alert-error"),!1}),t()},launchCompare:function(e,t,n,r){var i=null;void 0!==this.context&&null!==this.context&&(i=o._getSecurityContextFromContext(this.context));var a=this,s=null;if(r=r||{},null!=t){var l=[];t.forEach(function(t){var o="unknown",n=null,r=null,i=null,a=null,s=null;t.constructor==String?(o="modelID",n=t):(o=null!=t.commands?"IDPlusCommands":null!=t.TYPE?t.TYPE:t.objIDType,n=t.id,i=t.objType,a=t.contextId,r=t.commands,s=t.objTenant);var c=null!=s?s:e;l.push({idType:o,objectId:n,objectType:i,contextId:a,commands:r,envId:c,serviceId:"3DSpace",displayName:"",path:""})}),s={items:l,immediateCompare:p}}var c=widget.getPreference("useIndex"),u=null==c||c.value,p=!0===a.ImmediateCompare,d=o.getCurrentAppName(this.context),m={envId:e,protocol:"3DXContent",version:"1.0",source:d=d||"ENOSTDE_AP",widgetId:widget.id,useIndex:u,biProxyCtx:n,data:s,runOptions:r,appContextId:i};if(1==this.options.isODT||1==r.isODT){var h=JSON.stringify(m);require(["DS/CompareWidget/CompareWidget"],function(e){widget.setValue("X3DContentId",h),e.onLoad_forODT()})}else{a=this;require(["UWA/Utils/InterCom"],function(e){var t=new e.Socket("compassPageSocket");t.subscribeServer("com.ds.compass",window.parent),t.dispatchEvent("onSetX3DContent",m,"compassPageSocket"),t.dispatchEvent("onLaunchApp",{appId:"ENOCOMP_AP"},"compassPageSocket")})}},NLS_showMessage:function(e,t){"compare-alert-console"==t?console.error(e):require(["DS/CompareCommon/CompareAlert","i18n!DS/CompareCmd/assets/nls/CompareCmd"],function(o,n){var r=null!=n[e]?n[e]:e;o.doAlert({msg:r,alertStyle:t})},function(o){console.log("%%%% CompareWidget:: Failed to show "+t+": '"+e+"', error:"+o)})}})});