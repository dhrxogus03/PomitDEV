/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/SMAMpwManagers/SMAMpwMatOverrideManager",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(e,i,t,r,s,n){"use strict";var o=function(e,i){var t;if(e&&e.rootNode&&i){for(var r=[i],n=i.parents[0];n&&n!==e.rootNode;)r.unshift(n),n=n.parents[0];r.unshift(e.rootNode),t=new s(r)}return t},a=function(e,i,t){var r;if(e&&t){var s=e.getOverridesFromPathElement(t);if(s)for(var n,o=0;o<s.length&&!n;o++){var a=s[o].getMaterial();(n=a&&a.mpwMatID===i)&&(r=s[o])}}return r},h=function(e,i,t,r){if(e&&e.rootNode&&i&&t){var s=o(e,i),n=a(e,r,s);n||(n=e.createOverride(s)),n?n.setMaterial(t,!0):console.warn("SMAMpwMatOverrideManager - createOverride failed. check that the provided node is actually attached to SG")}},v=function(e,i,t,r){if(e&&e.rootNode&&i&&t){var s=o(e,i),n=a(e,r,s);n&&n.setMaterial(null,!0)}},l=function(e,i){var t;if(e.length>0&&i){for(var r=0;e[r].id!==i&&r<e.length;)r++;r<e.length&&(t={index:r,set:e[r]})}return t},p=i.extend({init:function(){this._parent(),this._sets=[]},getOverrideSet:function(e){var i=l(this._sets,e);return i&&i.set?i.set.sgOverrideSet:void 0},createOverrideSet:function(e){if(e&&e.id&&e.viewer&&e.root){this.getOverrideSet(e.id)&&console.error("SMAMpw SceneGraphOverrideSet is already defined for this viewer");var i=e.viewer.getSceneGraphOverrideSetManager();if(i){var t=new n(e.root);this._sets.push({id:e.id,sgOverrideSet:t,viewer:e.viewer}),i.pushSceneGraphOverrideSet(t)}}else console.error("SMAMpwMatOverrideManager createOverrideSet :invalid args")},cleanOverrideSet:function(e){var i=l(this._sets,e);if(i&&i.set){var t=i.set.sgOverrideSet.getOverrides();i.set.sgOverrideSet.deleteOverrides(t),this._sets.splice(i.index,1)}},applyMaterialOverride:function(e,i,t,r){var s=this.getOverrideSet(e);h(s,i,t,r)},removeMaterialOverride:function(e,i,t,r){var s=this.getOverrideSet(e);v(s,i,t,r)},getPassFailMaterial:function(){if(!this._passFailMat){var e=r.ImageUtils.loadTexture(t.getWebappsBaseUrl()+"SMAMpwManagers/assets/textures/SMAMpwPassFail.jpg");this._passFailMat=new r.PhysicalMaterial({color:16777215,map:e}),this._passFailMat.mpwMatID="MPW_PASSFAILMAT_ID"}return this._passFailMat},updatePassFailMaterialMap:function(e,i,t,r){var s=this.getOverrideSet(e);if(s)for(var n=s.getOverridesTargetingNode(i),o=0;o<n.length;o++){var a=n[o],h=a?a.getMaterial():void 0;h&&"MPW_PASSFAILMAT_ID"===h.mpwMatID&&(h.map.offset.x=t,h.map.repeat.x=r)}},applyPassFailMaterial:function(e,i){var t=this.getOverrideSet(e);t&&i&&h(t,i,this.getPassFailMaterial(),"MPW_PASSFAILMAT_ID")},removePassFailMaterial:function(e,i){var t=this.getOverrideSet(e);t&&i&&v(t,i,!0,"MPW_PASSFAILMAT_ID")}});return e.namespace("DS/SMAMpwManagers/SMAMpwMatOverrideManager",p)}),define("DS/SMAMpwManagers/SMAMpwResultProbingManager",["css!DS/SMAMpwManagers/SMAMpwResultProbing.css","UWA/Core","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/ThreeJS_DS"],function(e,i,t,r,s,n){"use strict";class o{constructor(e){this._texturePathFilter=e.texturePathFilter,this._computeProbingValue=e.computeProbingValue}testPathForTextureFS(e){return this._texturePathFilter(e)}computeProbingValue(e,i,t){return this._computeProbingValue({element:e,u:i,v:t})}}const a=window.devicePixelRatio||1,h=5*a,v=100*a,l=5*a,p=70*a,g={nonTouch:{L:new n.Vector2(35*a,0),R:new n.Vector2(-65*a,0),T:new n.Vector2(0,40*a),TL:new n.Vector2(35,40*a),TR:new n.Vector2(-65,40*a)},touch:{L:new n.Vector2(50*a,0),R:new n.Vector2(-50*a,0),T:new n.Vector2(-70*a,70*a),TL:new n.Vector2(170*a,70*a),TR:new n.Vector2(-60*a,70*a)}},c={L:new n.Vector2(30*a,0),R:new n.Vector2(-25*a,0),T:new n.Vector2(-35*a,-40*a),TL:new n.Vector2(90*a,-40*a),TR:new n.Vector2(-25*a,-40*a)};let _=i.Class.extend({init:function(e){this._isProbingActive=!1,this._viewer=e.viewer,this._rootNode=e.viewer.getRootNode(),this._syncEvent=e.syncEvent,this._valueDisplayPrecision=e.valueDisplayPrecision?e.valueDisplayPrecision:3,this._probingDiv=i.createElement("div",{id:"probingField_"+this._viewer.id.toString(),class:"simux-probing-field"}),this._probingText=new i.Element("span",{class:"simux-probing-value"}).inject(this._probingDiv),this._probingMarkerDiv=i.createElement("div",{id:"probingMarker"+this._viewer.id.toString(),class:"simux-probing-marker"});let t=this;this.onSwipeProbing=function(e){let i=t._viewer.magnifier;if(i&&i.active){let r=i.getContent();("function"==typeof r.isHidden?r.isHidden():"none"===r.style.display)||t.onMoveProbing(e)}},this.onMoveProbing=function(e){if(e&&t._viewer){let i=e.from[0].getCurrentPosition(t._viewer.canvas);if(t._syncEvent){let e={position2D:{x:i.x,y:i.y}};r.publish({event:t._syncEvent,data:e})}t.processProbingPosition(i)}},this.onReleaseProbing=function(){t._probingCSS2DNode&&t._probingCSS2DNode.setVisibility(!t._probeShow),t._probingMarker&&t._probingMarker.setVisibility(!t._probeShow)}},startProbing:function(e){if(this._textureMin=void 0,this._textureMax=void 0,e&&(void 0!==e.labels?this._labels=e.labels:(this._textureMin=e.textureMin,this._textureMax=e.textureMax),this._unitText="",this._idFilter=e.idFilter,e.textureFSProbingOptions&&(this._textureFSProbingStrategy=new o(e.textureFSProbingOptions)),t&&r&&this._viewer&&this._viewer.canvas)){if(this._probeShow=this._viewer.visibleSpace,this._viewer.unsubscribe(this._visSwapCb),this._visSwapCb=this._viewer.onSwapVisibleSpace(function(e){this._probeShow=e.visibleSpace,this._probingCSS2DNode&&this._probingCSS2DNode.setVisibility(!this._probeShow),this._probingMarker&&this._probingMarker.setVisibility(!this._probeShow)}.bind(this)),!this._probingCSS2DNode){let e=this._rootNode;e&&(this._probingCSS2DNode=new s({html:this._probingDiv,name:"SimNavProbingCSS2D"}),this._probingCSS2DNode.setPickability(!1),this._probingCSS2DNode.setVisibility(!this._probeShow),e.add(this._probingCSS2DNode),this._probingMarker=new s({html:this._probingMarkerDiv,name:"SimNavProbingMarker"}),this._probingMarker.setPickability(!1),this._probingMarker.setVisibility(!this._probeShow),e.add(this._probingMarker)),this._probingPosMatrix||(this._probingPosMatrix=new n.Matrix4);let i=window.devicePixelRatio||1;this._magStateToRestore=this._viewer.magnifier&&this._viewer.magnifier.active,t.isTouch&&(this._viewer.setMagnifier({activated:!0}),this._viewer.magnifier&&(this._magShiftVector={x:this._viewer.magnifier.shiftVector.x,y:this._viewer.magnifier.shiftVector.y},t.addEvent(this._viewer.canvas,"onSwipe",this.onSwipeProbing),t.addEvent(this._viewer.canvas,"onRelease",this.onReleaseProbing)));let r=t.isTouch&&this._magShiftVector?this._magShiftVector.x:-30,o=t.isTouch&&this._magShiftVector?-40-this._magShiftVector.y:-40;this._probingOffset=new n.Vector2(r*i,o*i)}t.addEvent(this._viewer.canvas,"onMouseMove",this.onMoveProbing),this._viewpointChangeCallback=r.subscribe({event:"/VISU/"},function(e){"@onViewpointBeginMove"===e.eventType?this._viewpointManipulation=!0:"@onViewpointEndMove"===e.eventType&&(this._viewpointManipulation=!1)}.bind(this)),this._isProbingActive=!0}},stopProbing:function(){if(t&&r&&this._viewer&&this._viewer.canvas&&(t.removeEvent(this._viewer.canvas,"onMouseMove",this.onMoveProbing),t.removeEvent(this._viewer.canvas,"onSwipe",this.onSwipeProbing),t.removeEvent(this._viewer.canvas,"onRelease",this.onReleaseProbing),r.unsubscribe(this._viewpointChangeCallback),this._viewpointManipulation=!1),this._isProbingActive=!1,this._textureMin=void 0,this._textureMax=void 0,this._labels=void 0,this._viewer&&this._viewer.canvas){let e=this._rootNode;e&&this._probingCSS2DNode&&e.remove(this._probingCSS2DNode),e&&this._probingMarker&&e.remove(this._probingMarker),this._probingCSS2DNode=void 0,this._probingMarker=void 0,this._viewer.magnifier&&this._viewer.setMagnifier({activated:this._magStateToRestore}),this._viewer.unsubscribe(this._visSwapCb)}},isProbingActive:function(){return this._isProbingActive},getUnitPostFix:function(){return this._unitText},setProbingUnit:function(e,i){e?this._unitText="":i&&(this._unitText=" "+i.toString())},processProbingPosition:function(e,i){if(this._probingCSS2DNode&&this._probingCSS2DNode.setVisibility(!this._probeShow),this._probingMarker&&this._probingMarker.setVisibility(!this._probeShow),this._viewer&&this._viewer.canvas&&this._isProbingActive&&!this._viewpointManipulation&&(void 0!==this._textureMin&&void 0!==this._textureMax||void 0!==this._labels)&&(i=i||this._viewer.pick(this._viewer.getMousePosition(e),"primHybrid",!0))){let e=i.path;if(e.length>0){let t=e[0].externalPath,r=t[0].name,s=t[1].getModelIdentification(),n="annotGroupNode"===t[1].name;if("Experience"!==r&&"DMUReviewBag"!==r&&"root-bag-web"!==r&&!n&&(!this._idFilter||this._idFilter&&s===this._idFilter)){let e=i.position,r=i.uv,s=!1;if(this._textureFSProbingStrategy){let i=t.filter(e=>this._textureFSProbingStrategy.testPathForTextureFS(e)),n=i[i.length-1];if(n){let i=this._textureFSProbingStrategy.computeProbingValue(n,r.x,r.y),t=isNaN(i)?"":i.toPrecision(this._valueDisplayPrecision);this.updateProbingToDisplay(t,e),s=!0}}if(!s&&r&&!isNaN(r.x)){let i;if(void 0!==this._labels){let t=Math.round(this._labels.length*r.x+.5);0<t&&t<=this._labels.length&&(i=this._labels[t-1],this.updateProbingToDisplay(i,e))}else{i=((this._textureMax-this._textureMin)*r.x+this._textureMin).toPrecision(this._valueDisplayPrecision),this.updateProbingToDisplay(i,e)}}}}}},updateProbingToDisplay:function(e,i){if(this._viewer&&this._viewer.canvas){if(this._probingPosMatrix.setPosition(i),this._probingCSS2DNode){this._probingText.setText(e+this.getUnitPostFix()),this._probingCSS2DNode.setMatrix(this._probingPosMatrix);let i=new n.Vector2(0,0);i=i.addVectors(i,this._probingOffset),this._probingCSS2DNode.setOffset(i),this._probingCSS2DNode.updatePosition();let r=new n.Vector2(0,0),s={w:parseInt(this._probingCSS2DNode.css2DNode.element.parentElement.clientWidth),h:parseInt(this._probingCSS2DNode.css2DNode.element.parentElement.clientHeight)},o=parseInt(this._probingCSS2DNode.css2DNode.element.style.top),a=parseInt(this._probingCSS2DNode.css2DNode.element.style.left),_=t.isTouch,d=_?g.touch:g.nonTouch,S=function(e){e.length>0&&(i=i.addVectors(i,d[e]),_&&(r=r.addVectors(r,c[e])))},u="";o<l&&(u="T"),S(u),a<h||"T"===u&&a<p?u="T"===u?"TL":"L":(a>s.w-v||"T"===u&&a>s.w-v)&&(u="T"===u?"TR":"R"),S(u);let f=this._viewer.magnifier;_&&f&&f.active&&(f.shiftVector.x=this._magShiftVector.x+r.x,f.shiftVector.y=this._magShiftVector.y+r.y),this._probingCSS2DNode.setOffset(i),this._probingCSS2DNode.updatePosition(),this._probingCSS2DNode.setVisibility(this._probeShow)}this._probingMarker&&(this._probingMarker.setMatrix(this._probingPosMatrix),this._probingMarker.setVisibility(this._probeShow)),this._viewer.render()}}});return i.namespace("DS/SMAMpwManagers/SMAMpwResultProbingManager",_)}),define("DS/SMAMpwManagers/SMAMpwTextureMapProcessor",["UWA/Core","UWA/Class"],function(e,i){"use strict";var t=function(e,i){var t={uvOffset:0,uvScale:1};if(e&&e.from&&e.to&&(e.from.min!==e.to.min||e.from.max!==e.to.max)){var r=isNaN(i)?3:i;t.uvScale=0,parseFloat(e.from.max.toPrecision(r))>parseFloat(e.from.min.toPrecision(r))&&(parseFloat(e.to.max.toPrecision(r))>parseFloat(e.to.min.toPrecision(r))&&(t.uvScale=(e.to.max-e.to.min)/(e.from.max-e.from.min)),t.uvOffset=(e.to.min-e.from.min)/(e.from.max-e.from.min))}return t},r=function(e,i,t){e&&(e.offset.x=i,e.repeat.x=t)},s=function(e,i,t){if(e){var s=e.getPrimitives();if(s)for(var n=0;n<s.length;n++){var o=s[n];if(o&&o.sgNode&&o.sgNode.getGroup()){var a=o.sgNode.getGroup();if(a){var h=!1;if(a.material){var v=a.material.getPDSFXUniform("RetexturingScale"),l=a.material.getPDSFXUniform("RetexturingShift");v&&l?(a.material.updatePDSFXUniform("RetexturingScale",t),a.material.updatePDSFXUniform("RetexturingShift",i),h=!0):a.material.map&&(r(a.material.map,i,t),h=!0)}h||a.gas&&a.gas.map&&r(a.gas.map,i,t)}}}}},n=i.extend({init:function(){this._parent()},applyToNode:function(e){!function(e){if(e&&e.node){var i=e.uvOffset,r=e.uvScale;if(Array.isArray(e.rangeTransformations)&&e.rangeTransformations.length>0){i=0,r=1;for(var n=0;n<e.rangeTransformations.length;n++){var o=e.rangeTransformations[n];if(o){var a=t(o,e.precision);i=i*a.uvScale+a.uvOffset,r*=a.uvScale}}}if(!isNaN(i)&&!isNaN(r))for(var h=e.node.children,v=0;v<h.length;v++){var l=h[v];if(l&&(void 0===e.childCondition||e.childCondition(l))){if(0===l.children.length)s(l,i,r);else for(var p=0;p<l.children.length;p++){var g=l.children[p];if(e.frameCondition&&(e.frameCondition(g,p)||(g=null)),g){var c=g.children[0];c&&s(c,i,r)}}e.childPostProcessing&&e.childPostProcessing(l,i,r)}}}}(e)}});return e.namespace("DS/SMAMpwManagers/SMAMpwTextureMapProcessor",n)});