define("DS/ENOFilterBIUX/NGFSessionStorage",["UWA/Class","UWA/Class/Options","DS/PlatformAPI/PlatformAPI"],function(e,t,i){"use strict";return e.singleton(t,{init:function(){this.clear()},setItem:function(e,t){this._setItems.push({key:e,value:t})},removeItem:function(e){this._removeItems.push(e)},clear:function(){this._removeItems=[],this._setItems=[]},publish:function(){let e={};e.removeItems=this._removeItems,e.setItems=this._setItems,(this._setItems.length||this._removeItems.length)&&i.publish("NGFilter_SessionStorage",e),this.clear()}})}),define("DS/ENOFilterBIUX/FBISettings",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Class/Debug","UWA/Data","DS/WebappsUtils/WebappsUtils","text!DS/ENOFilterBIUX/assets/FBISettings.json"],function(e,t,i,r,n,s,o){"use strict";var a=function(e){return/(http|https):\/\//.test(e)};return t.singleton(i,r,{options:{fbi_settings:{}},loadComplete:!1,settings_loaded:[],onCompleteLoad:void 0,init:function(e){this.options=JSON.parse(o),this.debugMode=this.getDebugMode()},load:function(e){this.log("FBISettings load"),this.settings_loaded.indexOf(e.url)&&(this.onCompleteLoad=e.onComplete,this._loadSettings(e.url),this.settings_loaded.push(e.url))},urlSettings:function(e){for(var t in e.debug_me&&(this.options.FBI_settings.debug_mode=!0),!0===this.options.FBI_settings.debug_mode&&(this.debugMode=!0),this.log("updateSettings from the URL done"),e)if("debug_me"===t)this.log("Debug mode already taken into account");else{var i=e[t];void 0!==i&&"string"==typeof i.valueOf()&&i.length>0&&("false"==i.toLowerCase()?i=!1:"true"==i.toLowerCase()&&(i=!0)),this.options.FBI_settings[t]=i}},initialize:function(e){this.options=UWA.extend(this.options,e,!0),this.debugMode=this.getDebugMode()},setOption:function(e,t){this.options.fbi_settings[e]=t},serialize:function(){return JSON.stringify(this.options)},getDebugMode:function(){return!!(this.options&&this.options.fbi_settings&&this.options.fbi_settings.debug_mode)},getOption:function(e,t){return this.options?this.options.fbi_settings&&void 0!==this.options.fbi_settings[e]?this.options.fbi_settings[e]:this.options.NGF_settings&&void 0!==this.options.NGF_settings[e]?this.options.NGF_settings[e]:void 0!==this.options[e]?this.options[e]:void 0!==t?t:void 0:void 0},_loadSettings:function(t){var i=this,r={timeout:5e4,method:"GET",data:{},type:"json",headers:{Accept:"application/ds-json"},onComplete:function(e){i.log("FBISettings load settings onComplete");var t={};(t="string"==typeof e?JSON.parse(e):e).error?i.log("Bad format for FBISettings"):i.initialize(t),i.loadComplete=!0,"function"==typeof i.onCompleteLoad&&i.onCompleteLoad.call(void 0,null),i.log("Available FBI Settings:\n"+JSON.stringify(i.options))},onFailure:function(t){e.log("No settings found"),"function"==typeof i.onCompleteLoad&&i.onCompleteLoad.call(void 0,null)},onTimeout:function(e){i.log("No settings found timeout reach")}};try{if(!a(t)){var o="";o=s.getWebappsBaseUrl();o=o.replace(/\/$/,""),this.log("Base URL "+o),a(o)||(this.log("The base URL is not a valid one (webapp context?)"),o=""),t=o+t}this.log("Used URL "+t),n.request(t,r)}catch(e){this.log("Failure : "+e)}}})}),define("DS/ENOFilterBIUX/FilterBIProxyController",["UWA/Class","UWA/Core"],function(e,t){"use strict";var i=[],r=e.singleton({WIDGETS_PRIORITIES:[],init:function(e){r.WIDGETS_PRIORITIES.push(0)},add:function(e){i.push(e)},addPriority:function(e){for(var t=r.WIDGETS_PRIORITIES.length,i=0;i<t;i++)if(r.WIDGETS_PRIORITIES[i]!==e){r.WIDGETS_PRIORITIES.push(e);break}},minPriority:function(){return Math.min.apply(null,r.WIDGETS_PRIORITIES)},removePriority:function(e){for(var t=r.WIDGETS_PRIORITIES.length,i=0;i<t;i++)r.WIDGETS_PRIORITIES[i]===e&&delete r.WIDGETS_PRIORITIES[i]},remove:function(e){for(var t=i.length-1;t>=0;t--){var r=i[t];if(r.appId===e.appId&&r.widgetId===e.widgetId){i.splice(t,1);break}}1===i.length&&i[0].setProxyAsMaster()},synchronize:function(e,t,r){i.forEach(function(i){i.appId===e&&t(r)})}});return r}),define("DS/ENOFilterBIUX/ExpandV2FormatServices",["UWA/Core","UWA/Class","UWA/Class/Options"],function(e,t,i){"use strict";var r=t.singleton(i,{emptyFilterFormat:function(e){var t={filter:{}};t.filter.or={},t.filter.or.filters=[];var i={and:{}};return i.and.filters=[],t.filter.or.filters.push(i),t},isEmptyFilter:function(e){var t=this,i=!0,r=function(e){var i=t.getV2CombinationType(e),r=i?e[i].filters:[];return!r||!r.length},n=this.getV2CombinationType(e);if("and_not"===n)i=!1;else{var s=e[n].filters;if(s&&s.length)for(var o=s.length,a=0;a<o&&i;a++)i="and_not"!==(n=this.getV2CombinationType(s[a]))&&r(s[a])}return i},getCombinationType:function(e){var t;return e.union?t="union":e.intersection?t="intersection":e.minus&&(t="minus"),t},updateWithAppParams:function(e,t,i){var r=UWA.clone(t),n=i.staticMapping,s=this.getV2CombinationType(r.filter),o={};o="and_not"===s?r.filter[s].left.and:r.filter[s];for(var a=0;a<o.filters.length;a++){var l=this.getV2CombinationType(o.filters[a]),c=[];if(n&&c.push({static_mapping_filter:1}),i.prefixPathArray&&i.prefixPathArray.length&&c.push(this.prefixPathFormat(e,i.prefixPathArray)),i.inFrustumObj&&Object.keys(i.inFrustumObj).length&&c.push(this.appInFrustumFormat(i.inFrustumObj)),i.inParallelFrustumObj&&Object.keys(i.inParallelFrustumObj).length&&c.push(this.appInParallelFrustumFormat(i.inParallelFrustumObj)),i.appQueryStr&&c.push(this.appSequenceFormat(i.appQueryStr)),i.volumeObj&&Object.keys(i.volumeObj).length)for(var u=0;u<i.volumeObj.length;u++)i.volumeObj[u].box_filter?c.push(this.volumeBoxFilterFormat(i.volumeObj[u].box_filter)):i.volumeObj[u].sphere_filter?c.push(this.volumeSphereFilterFormat(i.volumeObj[u].sphere_filter)):i.volumeObj[u].assembly_shape_filter?c.push(this.volumeAssemblyShapeFilterFormat(i.volumeObj[u].assembly_shape_filter)):i.volumeObj[u].plane_section_filter?c.push(this.planeSectionFilterFormat(i.volumeObj[u].plane_section_filter)):console.log("*** UpdateFilterQueryV2WithAppParams, volumeObj unknown case:"+i.volumeObj[u]);if(i.find_in_context&&c.push(this.appSequenceFormat(i.find_in_context)),i.tagger_select&&c.push(this.taggerSelectFormat(i.tagger_select)),i.find_subpaths&&c.push(this.appSubPathsFormat(i.find_subpaths)),i.appQueryObj){if(console.warn("appQueryObj key usage has been deprecated since R2022xFD04 - cf FilterBIComponentProxy jsdoc"),"and_not"!==l){var d={and_not:{}};d.and_not.left={},d.and_not.left.and={},d.and_not.left.and=o.filters[a][l],d.and_not.right={},d.and_not.right.or={},d.and_not.right.or.filters=[],o.filters[a]=d,l="and_not"}i.appQueryObj.keep&&o.filters[a].and_not.right.or.filters.push(this.appSequenceNOTFormat(i.appQueryObj.keep)),i.appQueryObj.remove&&o.filters[a].and_not.right.or.filters.push(this.appSequenceFormat(i.appQueryObj.remove))}for(var h=0;h<c.length;h++)"and_not"===l?o.filters[a][l].left.and.filters.push(c[h]):o.filters[a].and.filters.push(c[h]);o.filters[a].and_not&&0===o.filters[a].and_not.left.and.filters.length&&o.filters[a].and_not.left.and.filters.push({all:1})}return 0===o.filters.length&&o.filters.push({all:1}),r},explicitPathsFormat:function(e){var t={prefix_filter:{}};t.prefix_filter.prefix_path=[];for(var i=0;i<e.length;i++)t.prefix_filter.prefix_path.push(e[i]);return t},sequenceFilterFormat:function(e){if(e&&e.length){for(var t=[],i=0;i<e.length;i++){var r=e[i],n={sequence_filter:{}};n.sequence_filter.sequence=[];for(var s=0;s<r.length;s++)n.sequence_filter.sequence.push({uql:r[s]});t.push(n)}return t}},configFormat:function(e){if(e){var t={};return t.config_filter=e,t}},volumeBoxFilterFormat:function(e){if(e&&Object.keys(e).length){var t={};return t.box_filter=e,t}},volumeSphereFilterFormat:function(e){if(e&&Object.keys(e).length){var t={};return t.sphere_filter=e,t}},volumeAssemblyShapeFilterFormat:function(e){if(e&&Object.keys(e).length){var t={assembly_shape_filter:{}};return e.assembly_shape_path?t.assembly_shape_filter=UWA.extend(e):(t.assembly_shape_filter.assembly_shape_path={},t.assembly_shape_filter.assembly_shape_path.physical_id_path=[],t.assembly_shape_filter.assembly_shape_path.physical_id_path=e.root_path_physicalid[0],t.assembly_shape_filter.distance=e.distance,t.assembly_shape_filter.intersection_mode=e.intersection_mode),t}},planeSectionFilterFormat:function(e){if(e&&Object.keys(e).length){var t={};return t.plane_section_filter=e,t}},volumeFormat:function(e){if(e&&Object.keys(e).length){var t=Object.keys(e),i={};i[t]={},i[t].filters=[];for(var r=Object.keys(e[t]),n=0;n<r.length;n++)"NGFVolumeBox"===r[n]?i[t].filters.push(this.volumeBoxFilterFormat(e[t][r[n]])):"NGFVolumeSphere"===r[n]?i[t].filters.push(this.volumeSphereFilterFormat(e[t][r[n]])):"NGFVolumeAssemblyShape"===r[n]?i[t].filters.push(this.volumeAssemblyShapeFilterFormat(e[t][r[n]])):console.log("*** volumeFormat, NGFVolumeObj unknown case:"+r[n]);return i}},getFilterCombinationFormat:function(e){var t="or";switch(e.toLowerCase()){case"union":t="or";break;case"intersection":t="and";break;case"minus":t="and_not";break;default:console.log("ExpandV2FormatServices.filterCombinationFormat, non supported format => OR by default",+CVData.combinationStr),t="or"}return t},getV2CombinationType:function(e){var t;return e.or?t="or":e.and?t="and":e.and_not?t="and_not":console.log(" RCIII getV2CombinationTYpe : unknown combination"),t},filterLeftRightFormat:function(e){if(e.needsRemove){var t={and_not:{}};return t.and_not.left={},t.and_not.right={},t}},prefixPathFormat:function(e,t){var i={};return t&&t.length>0?i=this.explicitPathsFormat(t):(i.prefix_filter={},i.prefix_filter.prefix_path=[],i.prefix_filter.prefix_path.push({physical_id_path:[e]})),i},selectionOutputs:function(e){e&&e.outputs?function(e){e.outputs.matching_lengths=1,e.outputs.format="entity_relation_occurrence"}(e):function(e){e.outputs={matching_lengths:1,format:"entity_relation_occurrence"}}(e)},selectionAggrProcessors:function(e,t){var i=r.taggerSelectFormat(selectedIds).and.filters[0];t.aggregation_processors&&t.aggregation_processors[0].truncate?(t.aggregation_processors[0].truncate.compute_matching_subpaths_lengths=1,t.aggregation_processors[0].truncate.sequence_filter=i):t.aggregation_processors.push({truncate:{max_distance_from_prefix:1,sequence_filter:i}})},subPathAggrProcessors:function(e,t){var i=r.appSubPathsFormat(e).or.filters[0];t.aggregation_processors&&t.aggregation_processors[0].truncate?t.aggregation_processors[0].truncate.sequence_filter=i:t.aggregation_processors.push({truncate:{sequence_filter:i}})},groupingAggrProcessorsFormat:function(e,t,i,r,n){var s="Other"===r,o=[],a=function(e){var t={truncate:{}};return t.truncate.max_distance_from_prefix=1,t.truncate.prefix_filter={prefix_path:[{physical_id_path:[e]}]},t},l=function(e,i){var r={synthesis:{}};return s||(r.synthesis.group_by_facet=1),r.synthesis.mode="tree_leaf",r.synthesis.name=t,i&&(r.synthesis.synthesis_only=1),r},c=function(e,t){var i={synthesis:{}};return s||(i.synthesis.group_by_facet=1),i.synthesis.mode="tree_leaf_instance",i.synthesis.name=e,t&&(i.synthesis.synthesis_only=1),i};return"Inst"===r&&(o.push(a(e)),n&&o.push(c(t,!0))),"Ref"===r&&(o.push(a(e)),n&&o.push(l(0,!0))),"Other"===r&&(o.push(a(e)),n&&(o.push(l()),o.push(c(t,!1)))),o},_internalInstSeq:function(e,t){var i={sequence_filter:{}};return i.sequence_filter.sequence=[],i.sequence_filter.sequence.push({uql:"physicalid:"+e}),i.sequence_filter.sequence.push({statement:"NEXT"}),i.sequence_filter.sequence.push({uql:"(mxobjecttype:(RELATIONSHIP) AND "+t+")"}),i},_internalRefSeq:function(e,t){var i={sequence_filter:{}};return i.sequence_filter.sequence=[],i.sequence_filter.sequence.push({uql:"physicalid:"+e}),i.sequence_filter.sequence.push({statement:"NEXT"}),i.sequence_filter.sequence.push({uql:"(mxobjecttype:(RELATIONSHIP) AND NOT( "+t+"))"}),i.sequence_filter.sequence.push({statement:"NEXT"}),i.sequence_filter.sequence.push({uql:"(mxobjecttype:(BUSINESSOBJECT) AND "+t+")"}),i},_internalComputeGroupingBSDNode:function(e,t,i){var n=[];n.push(r._internalManageSpecialTags(e,i));for(var s="(",o=0;o<n.length;o++)s+="["+t+"]:("+n[o]+")",s+=o<n.length-1?" OR ":"";return s+=")"},_internalComputeGroupingTags:function(e,t){for(var i=e.predicate,n=[],s=0;s<e.object.length;s++){var o=e.object[s];if(n.push(r._internalManageSpecialTags(o,t)),e.object[s].merged&&e.object[s].merged.length)for(var a=0;a<e.object[s].merged.length;a++){var l=e.object[s].merged[a].object;n.push(l)}}for(var c="(",u=0;u<n.length;u++)c+="["+i+"]:("+n[u]+")",c+=u<n.length-1?" OR ":"";return c+=")"},_escapeCharIfNeeded:function(e){return["(",")","{","}","?","*","=",":","<",">","\\"].forEach(t=>{0<=e.indexOf(t)&&(e=e.replaceAll(t,"\\"+t))}),e},tagGroupingFormat:function(e,t,i,r){var n={};return"Inst"===r&&(n.filters=[],n.filters.push(this._internalInstSeq(e,t))),"Ref"===r&&(n.filters=[],n.filters.push(this._internalRefSeq(e,t))),"Other"===r&&(n.left={all:1},n.right={},n.right.or={},n.right.or.filters=[],n.right.or.filters.push(this._internalRefSeq(e,t)),n.right.or.filters.push(this._internalInstSeq(e,t))),n},cleanPredicateFromLineage:function(e){var t=e.split("/");return t.length>1?t[t.length-1]:e},_internalManageSpecialTags:function(e,t){var i=[],n=e.object||e,s=[],o=function(e){return e=e.replaceAll("/","_47_"),r._escapeCharIfNeeded(e)};if(Array.isArray(n)){var a=[];n.forEach(e=>{Array.isArray(e)?e.length>1?console.log("******** _internalManageSpecialTags - invalid hierarchical tag format"):e.forEach(e=>{a.push(o(e))}):a.push(o(e))}),s=function(e){if(Array.isArray(e))return e.join("/")}(a),t||(s+="*")}else s=o(n);return i.push(s),i},taggerSelectFormat:function(e){var t={sequence_filter:{}};t.sequence_filter.sequence=[];var i="";for(var n in e){for(var s=this.cleanPredicateFromLineage(n),o="(",a=0;a<e[n].length;a++){o+="["+s+"]:("+r._internalManageSpecialTags(e[n][a])+")",o+=a<e[n].length-1?" OR ":""}o+=")",i.length&&(i+=" AND "),i+=o}return t.sequence_filter.sequence.push({uql:i}),t},appSequenceFormat:function(e){if(e){var t={sequence_filter:{}};return t.sequence_filter.sequence=[],t.sequence_filter.sequence.push({uql:e,uql_prefix_handler:"starPH"}),t}},appSequenceNOTFormat:function(e){if(e){var t={sequence_filter:{}};return t.sequence_filter.sequence=[],t.sequence_filter.sequence.push({uql:"NOT ("+e+")"}),t}},appSubPathsFormat:function(e){var t={or:{}};return t.or.filters=[],e.forEach(function(e){var i={sequence_filter:{}};i.sequence_filter.sequence=[],e.forEach(function(e){i.sequence_filter.sequence.push({uql:"physicalid:"+e}),i.sequence_filter.sequence.push({statement:"NEXT"})}),i.sequence_filter.sequence.splice(i.sequence_filter.sequence.length-1),t.or.filters.push(i)}),t},appInFrustumFormat:function(e){if(e&&Object.keys(e).length){var t={};return t.in_frustum=e,t}},appInParallelFrustumFormat:function(e){if(e&&Object.keys(e).length){var t={};return t.in_parallel_frustum=e,t}},fromNGFV1ToV2:function(e,t,i){if(t){var r=this._getCombinationTypeFromV1ToV2(t),n=this._getQueryExpandTypeFromV1ToV2(t[r]),s=t[r][n],o=this.getFilterCombinationFormat(r),a={filter:{}},l=0;"and_not"===o?(l=1,a.filter.and_not={},a.filter.and_not.left={},a.filter.and_not.right={}):a.filter[o]={};for(var c=[],u=0;u<s.length;u++){var d=0,h=[],p=[];if(s[u].sequence_filter&&s[u].sequence_filter.length)for(var f=s[u].sequence_filter,g=0;g<f.length;g++){for(var _=f[g].definition,I=[],F=[],m=0;m<_.length;m++)_[m]["q.query"]&&(_[m].type_filter_bo?"seq_remove"===f[g].option[0]?(F.push("([ds6w:type]:"+_[m].type_filter_bo+" AND "+_[m]["q.query"]+")"),d=1):I.push("([ds6w:type]:"+_[m].type_filter_bo+" AND "+_[m]["q.query"]+")"):"seq_remove"===f[g].option[0]?(F.push(_[m]["q.query"]),d=1):I.push(_[m]["q.query"]));I&&I.length&&h.push(I),F&&F.length&&p.push(F)}var v=[];if(s[u].root_path_physicalid&&s[u].root_path_physicalid.length>0)for(var y=0;y<s[u].root_path_physicalid.length;y++)s[u].root_path_physicalid[y].length>1&&v.push({physical_id_path:s[u].root_path_physicalid[y]});var b=[];if(s[u].find_path_filter&&s[u].find_path_filter.length){for(var S=0;S<s[u].find_path_filter.length;S++)for(var x=0;x<s[u].find_path_filter[S].path_physicalid.length;x++)b.push({physical_id_path:s[u].find_path_filter[S].path_physicalid[x]});d=1}var N={};s[u].config_filter&&(N=s[u].config_filter);var P={};s[u].volume_filter&&(P=s[u].volume_filter);var C={};d?(C.and_not={},C.and_not.left={},C.and_not.left.and={},C.and_not.left.and.filters=[],C.and_not.right={},C.and_not.right.or={},C.and_not.right.or.filters=[]):(C.and={},C.and.filters=[]),h&&h.length&&(C.and_not&&C.and_not.left?C.and_not.left.and.filters=this.sequenceFilterFormat(h):C.and.filters=this.sequenceFilterFormat(h)),p&&p.length&&(C.and_not.right.or.filters=this.sequenceFilterFormat(p)),v&&v.length&&(C.and_not&&C.and_not.left?C.and_not.left.and.filters.push(this.explicitPathsFormat(v)):C.and.filters.push(this.explicitPathsFormat(v))),b&&b.length&&C.and_not&&C.and_not.right&&C.and_not.right.or.filters.push(this.explicitPathsFormat(b)),N&&Object.keys(N).length&&(C.and_not&&C.and_not.left?C.and_not.left.and.filters.push(this.configFormat(N)):C.and.filters.push(this.configFormat(N))),P&&Object.keys(P).length&&(C.and_not&&C.and_not.left?C.and_not.left.and.filters.push(this._volumeFormatFromV1ToV2(P)):C.and.filters.push(this._volumeFormatFromV1ToV2(P))),c.push(C)}if(c.length)if(l)a.filter.and_not.left.and={},a.filter.and_not.left.and.filters=[],a.filter.and_not.left.and.filters.push(c[0]),a.filter.and_not.right.or={},a.filter.and_not.right.or.filters=[],a.filter.and_not.right.or.filters.push(c[1]);else{a.filter[o]={},a.filter[o].filters=[];for(y=0;y<c.length;y++)a.filter[o].filters.push(c[y])}return a}console.log("fromNGFV1ToV2: !CVQuery as input")},_getCombinationTypeFromV1ToV2:function(e){var t;return e.union?t="union":e.intersection?t="intersection":e.minus&&(t="minus"),t},_getQueryExpandTypeFromV1ToV2:function(e){var t;return e.expand?t="expand":e.expand3d&&(t="expand3d"),t},_volumeFormatFromV1ToV2:function(e){if(e&&Object.keys(e).length){var t=Object.keys(e),i={};i[t]={},i[t].filters=[];for(var r=e[t],n=r.length,s=0;s<n;s++){var o=r[s];if(o.box)i[t].filters.push(this.volumeBoxFilterFormat(o.box));else if(o.sphere)i[t].filters.push(this.volumeSphereFilterFormat(o.sphere));else if(o.assemblyshape)i[t].filters.push(this.volumeAssemblyShapeFilterFormat(o.assemblyshape));else if(o.and||o.or){var a=this._volumeFormatFromV1ToV2(o);i[t].filters.push(a)}else console.log("*** volumeFormat, NGFVolumeObj unknown case:"+keys[s])}return i}}});return r}),Number.isInteger=Number.isInteger||function(e){"use strict";return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},define("DS/ENOFilterBIUX/FBIServices",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Class/Promise","UWA/Date","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/ENOFilterBIUX/FBISettings","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/UWPClientCode/I18n","DS/PlatformAPI/PlatformAPI"],function(e,t,i,r,n,s,o,a,l,c,u){"use strict";var d=t.singleton(i,{DEFAULT_LANG:"en",_nodes:[],_groupedData:{},_tree:[],_expandSynthesisURL:null,_tenantId:null,init:function(){this.setOption("fromWebInWin",0)},_setTree:function(e){this._tree=e},_setNodes:function(e){this._nodes=e},cleanAll:function(){this._groupedData={},this._tree=[],this._nodes=[]},getPlatformServices:function(e){var t=this;return this.getOption("fromWebInWin")?new r(function(i,r){for(var n=t.getOption("str_platformServices"),s=0;s<n.length;s++)if(e===n[s].platformId){t._tenantId=e;break}t.setMyAppsUrl(),i()}):new r(function(i,r){t._tenantId!==e?o.getPlatformServices({onComplete:function(r){t.setOption("str_platformServices",r);for(var n=0;n<r.length;n++)e===r[n].platformId&&(t._tenantId=e,i())},onFailure:function(e){r(e)}}):i()})},getFetchV2Url:function(e,t){if(Array.isArray(d.getOption("str_platformServices")))return this.getPlatformServiceUrl(e||this._tenantId,t)+"/cvservlet/fetch/v2";throw new Error("Platform services not initialize yet")},getPlatformServiceUrl:function(e,t){var i=this._getPlatformUrlAccordingToTenant(e);return i?i[t||"3DSpace"]:i},_getPlatformUrlAccordingToTenant:function(e){for(var t,i=e||this._tenantId,r=this.getOption("str_platformServices"),n=0;n<r.length;n++)if(i===r[n].platformId){t=r[n];break}return t},getUserID:function(){var e;if(this.getOption("fromWebInWin")){var t=this.getOption("str_platformServices");e=t&&t.length&&t[0].userID?t[0].userID:""}else{var i=u.getUser();e=i&&i.login?i.login:""}return e},getMyAppsUrl:function(){return this.getOption("myappsurl")?this.getOption("myappsurl"):(console.warn("myappsurl value empty"),"")},setMyAppsUrl:function(){var e=this;this.getOption("myappsurl")||window&&window.dscef&&window.dscef.getMyAppsURL&&window.dscef.getMyAppsURL().then(function(t){e.setOption("myappsurl",t)})},getRESTHeaders:function(e){var t={Accept:"application/json","Content-Type":"application/json","Accept-Language":d.getLanguage().toLowerCase()};return e&&(t.SecurityContext=e),t},getPlatformId:function(){return this._getPlatformUrlAccordingToTenant().platformId},fetch:function(e,t,i,n){this._setTree(i),this._setNodes(t);var s=this,o=this._buildArrayPid(),a=o.length/1e3,l=Number.isInteger(a)?a:parseInt(a)+1,c=[];return new r(function(e,t){d.getPlatformServices(s._tenantId).then(function(){for(var t=[],i=0;i<l;i++){c.push(s._executeFetch(o,t,[],1e3*i,1e3,n))}return r.all(c).then(function(t){var i=null;if(t.length){for(var r={results:[]},n=0;n<t.length;n++)if(t[n].results)for(var o=0;o<t[n].results.length;o++)r.results.push(t[n].results[o]);i=s._parse(r)}else i=s._parse(t[0]);e(i)})}).catch(function(e){console.log("FBIServices.fetch: Error in getPlatformServices")})})},fetchWithSynthesis:function(e,t){var i=this;return new r(function(r,n){i.getPlatformServices(i._tenantId).then(function(){i._executeFetchWithSynthesis(e,0,t).then(function(e){r(e)},function(e){console.log(e),n([])})})})},refineFetchWithoutSynthesis:function(e,t,i){var n=this;return new r(function(r,o){n.getPlatformServices(n._tenantId).then(function(){s.authenticatedRequest(n.getFetchV2Url(n._tenantId,i),{headers:d.getRESTHeaders(),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_refineFetchWithoutSynthesis",physicalid:e,tenant:n._tenantId,with_synthesis:!1,refine:t||{},start:0,select_file:[],local:d.getLanguage().toLowerCase(),select_predicate:[]}),onComplete:function(e){r(e)},onFailure:function(e){o(e)}})}).catch(function(e){console.log("refineFetchWithoutSynthesis: Error in getPlatformServices")})})},launchOrRefineFetchWithPredicates:function(e,t,i,n){Array.isArray(i)||(i=[i]);var o=this;return new r(function(r,a){o.getPlatformServices(o._tenantId).then(function(){s.authenticatedRequest(o.getFetchV2Url(o._tenantId,n),{headers:d.getRESTHeaders(),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_launchOrRefineFetchWithPredicates",physicalid:t,tenant:o._tenantId,with_synthesis:!1,refine:e||{},start:0,select_file:[],local:d.getLanguage().toLowerCase(),select_predicate:i||[]}),onComplete:function(e){r(e)},onFailure:function(e){console.log(e),a(e)}})}).catch(function(e){console.log("launchOrRefineFetchWithPredicates: Error in getPlatformServices")})})},_buildArrayPid:function(){for(var e=this._nodes,t=e.length,i=[],r=0;r<t;r++)i[r]=e[r];return i},_parse:function(t){for(var i=t.results,r={},n=[],s=[],o={},a=0;a<i.length;a++)for(var l=i[a].attributes,c=this._getIdPathsForID(l[0].value),u=1;u<l.length;u++)if("internal"!==l[u].format){r[l[u].name]||(r[l[u].name]={}),"attribute"===l[u].format&&(o[l[u].name]||(o[l[u].name]=!0,s.push({sixw:l[u].name,type:l[u].type.toLowerCase()}))),"date"===l[u].type&&(l[u].value=l[u].value.split("-").join("/").substr(0,10)),r[l[u].name][l[u].value]||(r[l[u].name][l[u].value]={},r[l[u].name][l[u].value].format=l[u].format,r[l[u].name][l[u].value].type=l[u].type,r[l[u].name][l[u].value].dispValue=l[u].dispValue||l[u].value,r[l[u].name][l[u].value].value=l[u].value||l[u].dispValue);for(var d=0;d<c.length;d++)r[l[u].name][l[u].value][c[d].id]={pathID:c[d].id,path:c[d].path}}for(var h in r)if(r.hasOwnProperty(h))for(var p in r[h])r[h].hasOwnProperty(p)&&"ds6w_facet"===r[h][p].format&&n.push({object:r[h][p].value,sixw:h,count:this._getObjectSize(r[h][p]),type:r[h][p].type,dispValue:r[h][p].dispValue});return e.extend(this._groupedData,r,!0),{response:t,grouped:r,summary:n,suggested:s,unfilteredStructure:this._groupedData}},_getObjectSize:function(e){var t,i=0;for(t in e)e.hasOwnProperty(t)&&"string"!=typeof e[t]&&-1===t.lastIndexOf("dispValue")&&-1===t.lastIndexOf("value")&&i++;return i},findColoredPaths:function(t,i){var r={},n={};if("date"===i.type)for(var s in n=t[i.predicate])n.hasOwnProperty(s)&&-1!==s.indexOf(i.object)&&e.merge(r,n[s]);else r=Array.isArray(i.object)?t[i.predicate][this._buildValueForHierarchicalTags(i.object)]:t[i.predicate][i.object];return r},_buildValueForHierarchicalTags:function(e){var t=!1,i=e[e.length-1];if(e.length>1&&i.contains("/")){var r;t=!0;for(var n=0;n<e.length-2;n++)r=e[n].concat(","+e[n+1]);r&&(i=r+","+i),i=i.replace(/\//g,",")}return t?i:e},_getIdPathsForID:function(e){var t=this;return this._tree.filter(function(i){var r=i.path;return e===t._nodes[r[r.length-1]]})},_getIdPaths:function(e,t,i){return e.filter(function(e){var r=e.path;return i===t[r[r.length-1]]})},convertFromIndexToPID:function(e,t){for(var i=[],r="",n=0;n<t.length;n++){for(var s=0;s<t[n].length;s++)r+=e[t[n][s]],s<t[n].length-1&&(r+="-");var o=!1;if(i.lastIndexOf(r)>-1){for(var a=i.length-1;a>=0;a--)if(i[a].lastIndexOf(r+"_")>-1){r+="_"+(parseInt(i[a].substring(i[a].lastIndexOf("_")+1))+1),o=!0;break}!1===o&&(r+="_1")}i.push(r),r=""}return i},convertFromPIDToIndexAsync:function(e,t,i,r){var n=[],s=[],o=[];!function(e,t,r,s,o){o=o||window,s=s||100;var a=0;!function l(){for(var c=s;c--&&a<e.length;)t.call(o,e[a],a,e),++a;a<e.length?setTimeout(l,1):r.call(i,n)}()}(t,function(t){if(t.lastIndexOf("-")>-1){s=t.split("-");for(var i=0;i<s.length;i++)s[i].lastIndexOf("_")>-1&&(s[i]=s[i].substr(0,s[i].indexOf("_"))),o.push(e.indexOf(s[i]));s=[]}else o.push(e.indexOf(t));n.push(o),o=[]},r,25,this)},convertFromPIDToIndex:function(e,t){for(var i=[],r=[],n=[],s=0;s<t.length;s++){if(t[s].lastIndexOf("-")>-1){r=t[s].split("-");for(var o=0;o<r.length;o++)r[o].lastIndexOf("_")>-1&&(r[o]=r[o].substr(0,r[o].indexOf("_"))),n.push(e.indexOf(r[o]));r=[]}else n.push(e.indexOf(t[s]));i.push(n),n=[]}return i},splitListOfPID:function(e){var t=[];if(e.lastIndexOf("-")>-1){t=e.split("-");for(var i=0;i<t.length;i++)t[i].lastIndexOf("_")>-1&&(t[i]=t[i].substr(0,t[i].indexOf("_")))}else e.lastIndexOf("_")>-1&&(e=e.substr(0,e.indexOf("_"))),t.push(e);return t},getLanguage:function(){return"undefined"!=typeof widget?widget.lang:c.getCurrentLanguage()},getNlsInfosForFacets:function(e){for(var t=this,i=UWA.clone(e),n={},s=0;s<i.length;s++){var o=i[s];if(o.sixw)if(Array.isArray(o.object)&&o.object.length)i[s].dispValue=o.object.join("/");else{var a=o.sixw.split("/"),c=a.length-1;n[a[c]]||(n[a[c]]=[]),n[a[c]].push(o.object)}else if("ds6w_facet"===o.format){if(Array.isArray(o.value)&&o.value.length&&Array.isArray(o.value[0]))i[s].dispValue=o.value[0].join("/");else{var u=o.name.split("/"),h=u.length-1;n[u[h]]||(n[u[h]]=[]),n[u[h]].push(o.value)}}}if(this.getOption("fromWebInWin")){var p={myAppsBaseUrl:d.getMyAppsUrl(),userId:d.getUserID(),lang:d.getLanguage()};l.setConfigForMyApps(p)}return new r(function(e,r){t.getNlsOfPropertiesValues(n).then(function(t){for(var r in t)if(t.hasOwnProperty(r))for(var n=t[r],s=0;s<i.length;s++){var o=i[s].sixw||i[s].name;if(o){var a=o.lastIndexOf("/");if(-1!==o.indexOf(r,a)){var l=i[s].object||i[s].value;i[s].dispValue=n[l]||l}}else console.log(' => getNlsInfosForFacets / No Nls set (not "sixw") for : '+i[s])}e(i)},function(t){console.log("getNlsInfosForFacets / Retrieve Nls failed !, error = "+t),i.forEach(function(e){e.dispValue=e.dispValue||e.object||e.value}),e(i)})})},_executeFetch:function(e,t,i,n,o,a,l){var c=this;return new r(function(r,u){s.authenticatedRequest(c.getFetchV2Url(c._tenantId,a),{headers:d.getRESTHeaders(l),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_ExecuteFetch",physicalid:e,tenant:c._tenantId,with_synthesis_attribute:!0,nresults:o||1e3,start:n||0,select_file:t||[],local:d.getLanguage().toLowerCase(),select_predicate:i||[]}),onComplete:function(e){e.results;if(e.results){for(var t=[],i=0;i<e.results.length;i++)for(var n=0;n<e.results[i].attributes.length;n++)t.push(e.results[i].attributes[n]);d.getNlsInfosForFacets(t).then(function(t){for(var i=0;i<e.results.length;i++)for(var n=0;n<e.results[i].attributes.length;n++)for(var s=0;s<t.length;s++)e.results[i].attributes[n].name===t[s].name&&e.results[i].attributes[n].value===t[s].value&&(e.results[i].attributes[n].dispValue=t[s].dispValue);r(e)})}else r([])},onFailure:function(e){u(e)}})})},arePredicatesExcludedFromSynthesis:function(){return a.getOption("ExcludePredicatesFromSynthesis")?1:0},_executeFetchWithSynthesis:function(e,t,i){var n=this;return new r(function(r,o){d.arePredicatesExcludedFromSynthesis();s.authenticatedRequest(n.getFetchV2Url(n._tenantId,i),{headers:d.getRESTHeaders(),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_ExecuteFetchWithSynthesis",physicalid:e,tenant:n._tenantId,with_synthesis:!0,nresults:1,start:t||0,select_file:[],local:d.getLanguage().toLowerCase(),select_predicate:[]}),onComplete:function(e){var t=e.facets||[];d.getNlsInfosForFacets(t).then(function(e){r(e)})},onFailure:function(e){console.log(e),o(e)}})})},getInfosFromIds:function(e,t,i){var n=this;return new r(function(r,s){var o=[],a=["ds6w:label","ds6wg:revision"],l={};l[a[0]]="",l[a[1]]="",n.getPredicatesInfosFromIds(e,a,t,i).then(function(e){for(var t=e.length,i=0;i<t;i++){var n={};n.id=e[i].id,n.thumbnail=e[i].thumbnail,n.icon=e[i].icon;for(var s=0;s<a.length;s++)for(var c=0;c<e[i].predicates.length;c++){var u=e[i].predicates[c];if(u.name.endsWith(a[s])){l[a[s]]=u.value;break}}n.label=l[a[0]],n.revision=l[a[1]],o.push(n)}r(o)}).catch(function(e){console.log("FBIServices: Error in getPredicatesInfosFromIds")})})},getPredicatesInfosFromIds:function(e,t,i,n){var s=this,o=[],a=[];return"boolean"==typeof i&&!0===i&&(o=["icon","thumbnail_2d"],a=["preview_url","type_icon_url"]),new r(function(i,l){s.getPlatformServices(s._tenantId).then(function(){var c=function(e,t,i,l,c){return new r(function(r,u){s._executeFetch(e,o,t,i,l,c,n).then(function(e){for(var i=a.concat(t),n=i.length,s=[],o=e.results?e.results.length:0,l=0;l<o;l++){for(var c=e.results[l].attributes,u=c.length,d={},h=[],p=0;p<u;p++){var f=c[p];if("resourceid"===f.name)d.id=f.value;else if("preview_url"===f.name)d.thumbnail=f.value;else if("type_icon_url"===f.name)d.icon=f.value;else for(var g=0;g<n;g++){f.name;if(f.name.endsWith(i[g])){h.push(f);break}}}d.id&&(d.predicates=h,s.push(d))}r(s)},function(e){console.log(e),u([])})})},u={};s.getRootsInfos(e).forEach(e=>{var t=e.serviceId;u[t]||(u[t]=[]),u[t].push(e.rootId)});var d=[];for(var h in u){var p=u[h].length;d.push(c(u[h],t,0,p,h))}return r.all(d).then(function(e){var t=[];e.forEach(e=>{t=t.concat(e)}),i(t)},function(e){console.log(e),l([])})}).catch(function(e){console.log("getPredicatesInfosFromIds: Error in getPlatformServices")})})},getCVQueryBuildMode:function(){if(void 0===this._cvQueryBuildMode){var e=a.getOption("BuildCVQueryMode");this._cvQueryBuildMode=1===e?1:0}return this._cvQueryBuildMode},getProgressiveExpandItemTemplate:function(e,t,i){var r={label:"",root:{}};r.root.physical_id=e;var n=a.getOption("ProgressiveExpandLimitMaxPath");return n&&-1!==n&&(r.parameters={},r.parameters.limit_max_path=n),r.filter=t||{},r.aggregation_processors=i||[],r},getProgressiveQueryTemplate:function(e,t,i){var r={batch:{}};if(r.batch.expands=[],e&&t){var n=this.getProgressiveExpandItemTemplate(e,t,i);r.batch.expands.push(n)}return r.outputs={},r},getNlsOfPropertiesValues:function(e){return new r(function(t,i){l.getNlsOfPropertiesValues(JSON.stringify(e),{tenantId:d.getPlatformId(),lang:d.getLanguage(),onComplete:function(e){t(e)},onFailure:function(e){console.log("getNlsInfosForFacets / Retrieve Nls failed !, error = "+e),i(e)}})})},getRootsInfos:function(e){var t=[];return(e=Array.isArray(e)?e:[e]).forEach(e=>{t.push({rootId:e.rootId||e,rootAlias:e.rootAlias,serviceId:e.serviceId||"3DSpace"})}),t}});return d}),Number.isInteger=Number.isInteger||function(e){"use strict";return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},define("DS/ENOFilterBIUX/NGFServices",["UWA/Core","UWA/Class","UWA/Date","UWA/Class/Options","UWA/Class/Promise","DS/WAFData/WAFData","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","i18n!DS/ENOFilterBIUX/assets/nls/ENOFilterBIUX","text!DS/ENOFilterBIUX/assets/FilterTrackerMetrics.json","DS/PADServices/utils/PADTrackerManager","DS/ENOFilterBIUX/ExpandV2FormatServices","DS/PlatformAPI/PlatformAPI"],function(e,t,i,r,n,s,o,a,l,c,u,d,h,p){"use strict";var f=t.singleton(r,{CVQUERY_VERSIONS:["420.6.1"],EXPAND_SERVICES:{none:0,progressive:1,expand:2,expand3d:4},APP_URL:"",EXPAND_INTENT:{fullPaths:0,partialPaths:1},init:function(){let e=new URL(decodeURIComponent(window.location.href)),t=e.searchParams.get("widgetDomain"),i=t?t.indexOf("?"):-1;if(-1!==i){let r=t.substring(i+1).split("=");2===r.length&&r[0].startsWith("NGF")&&e.searchParams.set(r[0],r[1])}let r=e.searchParams.get("NGFDebug"),n=!r||"all"!==r&&"1"!==r?0:1;this._debug={},r=e.searchParams.get("NGFDebugElapsedTime"),this._debug.elapsedTime=r&&"1"===r?1:0,r=e.searchParams.get("NGFDebug"),this._debug.ngf=r&&"1"===r||n?1:0,r=e.searchParams.get("NGFDebugCmds"),this._debug.extendedCmds=r&&"1"===r?1:0,r=e.searchParams.get("NGFDebugExtension"),this._debug.extension=r&&"1"===r||n?1:0,r=e.searchParams.get("NGFDebugLeftPanelCmds"),this._debug.LeftPanelCmds=r&&"1"===r?1:0,r=e.searchParams.get("NGFDebugSynthesisTimeOut"),r=parseFloat(r),this._debug.SynthesisTimeOut=isNaN(r)?0:r,r=e.searchParams.get("NGFICLifecycleCmd"),this._debug.ICLifecycleCmd=r&&"1"===r?1:0,this._isActivated={},r=e.searchParams.get("NGFTimeInDate"),this._isActivated.timeInDate=r&&"1"===r?1:0;let s=1===a.getOption("EasyAttributeOn")?1:0;r=e.searchParams.get("NGFEasyAttribute"),this._isActivated.easyAttribute=s||(r&&"1"===r||n?1:0),r=e.searchParams.get("NGFSelectionRead"),this._isActivated.newSelectionRead=r&&"1"===r?1:0,r=e.searchParams.get("NGFRepairOnDrop"),this._isActivated.RepairOnDrop=r&&"0"===r?0:1,r=e.searchParams.get("NGFUIToAutoComplete"),this._isActivated.UIToAutoComplete=r&&"0"===r?0:1,r=e.searchParams.get("NGFMultiRoot"),this._isActivated.MultiRoot=r&&"1"===r?1:0,this._isActivated.QueryV2FromModel=0===a.getOption("QueryV2FromModel")?0:1},_getURL:function(e,t,i){if(Array.isArray(o.getOption("str_platformServices"))){var r=e||this.getTenant();return o.getPlatformServiceUrl(r,t)+i}throw new Error("Platform services not initialize yet")},getGetEcoSystemUrl:function(e,t){return this._getURL(e,t,"/resources/enorelnav/navigate/getecosystem?tenant="+(e||this.getTenant()))},getFederateSearchUrl:function(e){return this._getURL(e,"3DSearch","/search")},addURLParam:function(e){this.APP_URL=e&&e.param?e.param:""},getProgressiveExpandUrl:function(e,t){var i="/cvservlet/progressiveexpand/v2?output_format=cvjson";return this.APP_URL.length&&(i+="&"+this.APP_URL),this._getURL(e,t,i)},getGetFilterQueryUrl:function(e,t){return this._getURL(e,t,"/resources/FilterBIAPI/Filter/getFilterQuery")},getGetFiltersFromIdsUrl:function(e,t){return this._getURL(e,t,"/resources/FilterBIAPI/Filter/getFiltersFromIds")},getGetFilterFromIdUrl:function(e,t){return this._getURL(e,t,"/resources/FilterBIAPI/Filter/getFilterFromId")},getExpandSynthesisUrl:function(e,t){return this._getURL(e,t,"/cvservlet/multiexpand")},getBasicsInDBFromIdsUrl:function(e,t){return this._getURL(e,t,"/resources/FilterBIAPI/Filter/getBasicsInDBFromIds?tenant="+(e||this.getTenant()))},getAllDataFromFilterIds:function(e,t,i){var r=this;return e=Array.isArray(e)?e:[e],new n(function(n,a){void 0===e?(console.log(" ***ERROR NGF getAllDataFromFilterIds, invalidFilterId"),a({msg:c.get("invalidFilterId"),eventID:"warning"})):s.authenticatedRequest(r.getGetFiltersFromIdsUrl(t),{headers:o.getRESTHeaders(i),method:"POST",data:JSON.stringify(e),type:"json",proxy:"passport",timeout:"60000",onComplete:function(e){var t={},i={},s=[];if(e.success){t.success=[],i.success=[];for(var o=0;o<e.success.length;o++){for(var a=Object.keys(e.success[o]),l=0;l<a.length;l++)t.success[a[l]]||(t.success[a[l]]=[]),e.success[o][a[l]].filterPhysicalId=a[l],t.success[a[l]].push(e.success[o][a[l]]),s[l]=t.success[a[l]][l];i.success.push(s[o])}}else n(r.manageNlsDroppedErrorMessages(e));n(i)},onFailure:function(e){n(r.manageNlsDroppedErrorMessages(e))}})})},getFilterDataFromFilterId:function(e,t,i){return e=Array.isArray(e)?e:[e],new n(function(r,n){f.getAllDataFromFilterIds(e,t,i).then(function(e){e.success&&r(e),e.failure&&r(e)},function(e){n(e)})})},manageNlsDroppedErrorMessages:function(e){if(e.failure)for(var t=0;t<e.failure.length;t++)e.failure[t].filterName?e.failure[t].msg=e.failure[t].filterName+" : "+c.get(e.failure[t].msg):e.failure[t].msg=c.get(e.failure[t].msg);return e},filteredExpandWithSynthesis:function(e,t,i,r,n,s){var o=1===a.getOption("ProgressiveSynthesisOn")?1:0;return f.isProgressiveExpandActive()&&o?this._progressiveFilteredExpandWithSynthesis(e,t,r,n,s):this._v1FilteredExpandWithSynthesis(e,t,i,r)},_v1FilteredExpandWithSynthesis:function(t,r,l,c){var u=this,d=[...r.keys()],h={};d.forEach(e=>{if(r.get(e)){var t=r.get(e).serviceId;h[t]||(h[t]=[]),h[t].push(r.get(e).rootId)}});var p=function(t,r,l,c,h){return new n(function(n,p){var g={},_=Date.now(),I="Proxy_Expand_synthesis_duration",F=function(e,i){var r={};r[e]=i,u.setPerformanceTracker(t.widgetId,"NGF-Proxy_Expand_Synthesis","NGFilter_Proxy",r,1)},m=(l=l||u.EXPAND_SERVICES.expand)&u.EXPAND_SERVICES.expand?"CVQuery":"CVQuery3D";d.length?d.forEach(function(e){if(r.get(e)&&r.get(e).filterInfos){var t=UWA.clone(r.get(e).filterInfos.objQuery[m]),i=f.getCombinationType(t),n=f.getQueryExpandType(i);g.union||(g.union={}),g.union[n]||(g.union[n]=[]);for(var s=t[i][n],o=0;o<s.length;o++)g.union[n].push(s[o])}}):(F(I,Date.now()-_),n([])),0===Object.keys(g).length&&(console.log("NGFServices.filteredExpandWithSynthesis KO : queryForExpandSynthesis undefined"),F(I,Date.now()-_),n([]));var v=e.Date.strftime(new i,"%Y-%m-%d-%H:%M:%S");g.label="FilterBI_FilteredExpandWithSynthesis_"+v,g.max_count_path="1",g.synthesis_mode=c,s.authenticatedRequest(f.getExpandSynthesisUrl(t.tenantId,h),{headers:o.getRESTHeaders(),method:"POST",data:JSON.stringify(g),type:"json",proxy:"passport",timeout:a.getOption("timeoutExpandSynthesis"),onComplete:function(e){var t=e.facets||[];o.getNlsInfosForFacets(t).then(function(e){F(I,Date.now()-_),n(e)})},onFailure:function(e){F(I,-1),p(e)}})})},g=[];for(var _ in h){h[_].length;g.push(p(t,r,l,c,_))}return n.all(g).then(function(e){var t=[];return e.forEach(e=>{t=t.concat(e)}),t},function(e){return console.log(e),[]})},_progressiveFilteredExpandWithSynthesis:function(t,r,l,c,u){var d=this,g={};u.forEach(e=>{if(r.get(e)){var t=r.get(e).serviceId;g[t]||(g[t]=[]),g[t].push(r.get(e).rootId)}});var _=function(t,r,l,c,u,g){var _=[];if(!u||0===u.length)return new n(function(e){e([])});if(u.forEach(t=>{if(r.get(t)&&r.get(t).filterInfos){var i=e.clone(r.get(t).filterInfos.objQueryV2).batch.expands[0],n=o.getProgressiveExpandItemTemplate(i.root.physical_id,i.filter,i.aggregation_processors),s=p.getUser()?p.getUser().externalId:"rci";s=s||"rci",n.label="FilterBI_Synthesis-"+s+"-ENOREFS_AP-"+Date.now();var a={synthesis:{name:"ProgressiveExpand_Synthesis",mode:l,synthesis_only:1,group_by_facet:1}};1===f.isRootExcludedFromSynthesis()&&(a.synthesis.exclude_root_from_count=!0),n.aggregation_processors.push(a);var u=d.buildV2GraphProperty(c);u&&(n.graph=u),h.isEmptyFilter(n.filter)&&(n.filter={all:1}),_.push(n)}}),0===_.length)return console.log(" => ProgressiveFilteredExpandWithSynthesis KO : data for progressiveExpand undefined"),new n(function(e){e([])});var I=o.getProgressiveQueryTemplate();I.batch.expands=_,I.outputs={synthesis:["ProgressiveExpand_Synthesis"]};var F=o.getOption("scc_preferredData"),m=F&&F.length?"include_predicates":"facet_name";if(I.outputs[m]=F&&F.length?F:"ds6w",!F||0===F.length){var v=o.getOption("scc_excludedData"),y=v&&v.length?"exclude_predicates":"facet_name";I.outputs[y]=v&&v.length?v:"ds6w"}return new n(function(e,r){var n=Date.now(),l="Proxy_Expand_synthesis_duration",c=function(e,i){var r={};r[e]=i,d.setPerformanceTracker(t.widgetId,"NGF-Proxy_Progressive_Expand_Synthesis","NGFilter_Proxy",r,1)},u="ProgressiveExpandSynthesis_"+i.strftime(new i,"%Y-%m-%d-%H:%M:%S");s.authenticatedRequest(f.getProgressiveExpandUrl(f.getTenant(),g),{label:u,headers:o.getRESTHeaders(t.securityContext),method:"POST",data:JSON.stringify(I),type:"json",proxy:"passport",timeout:a.getOption("timeoutExpandSynthesis"),onComplete:function(t){if(t.errors)console.log(" ==> Expand synthesis / Error : "+u),t.errors.forEach(function(e){console.log("     . "+e.code+": "+e.reason)}),c(l,-1),r(t.errors);else{var i=t.results;if(i.length&&i[0].synthesis){var s=i[0].synthesis.facets||[];o.getNlsInfosForFacets(s).then(function(t){c(l,Date.now()-n),e(t)})}else c(l,Date.now()-n),e([])}},onFailure:function(e){console.log(" ==> Expand synthesis / Failure : "+u),console.log("   . "+e),c(l,-1),r(e)}})})},I=[];for(var F in g){g[F].length;I.push(_(t,r,l,c,g[F],F))}return n.all(I).then(function(e){var t=[];return e.forEach(e=>{t=t.concat(e)}),t},function(e){return console.log(e),[]})},getPredicatesFacetValue:function(){var e="ds6w";if(1===f.arePredicatesExcludedFromSynthesis()){var t=a.getOption("PredicatesExcludedFromSynthesis",[]);e=JSON.parse('["'+(t.length?t.join('","'):e)+'"]')}return e},getCurrentSpecificationVersion:function(){var e=f.CVQUERY_VERSIONS.length-1;return f.CVQUERY_VERSIONS[e]},isLastSpecificationVersion:function(e){return this.getCurrentSpecificationVersion()===e},getCombinationQuery:function(e){if(e)return e.union||e.intersection||e.minus},getCVQueryType:function(e){var t;return e.CVQuery?t="CVQuery":e.CVQuery3D&&(t="CVQuery3D"),t},getCombinationType:function(e){var t;return e.union?t="union":e.intersection?t="intersection":e.minus&&(t="minus"),t},getQueryExpand:function(e){return e.expand||e.expand3d},getQueryExpandType:function(e){var t;return e.expand?t="expand":e.expand3d&&(t="expand3d"),t},getQueryFormat:function(e){var t=1===a.getOption("ExpandServicesOn")?e:void 0;t=t||Object.keys(this.EXPAND_SERVICES),t=Array.isArray(t)?t:[t];var i=0;return t.forEach(e=>{this.EXPAND_SERVICES[e]&&(i|=this.EXPAND_SERVICES[e])}),i},getExpandIntent:function(e){return this.EXPAND_INTENT[e]||0},buildEmptyFilter:function(e){var t='"CVQuery":{"root_physicalid":"'+e+'"}',i=t;i=i.replace('"CVQuery"','"CVQuery3D"');var r=o.getProgressiveExpandItemTemplate(e,{or:{filters:[]}}),n='"CVQueryV2":'+JSON.stringify({filter:r.filter});return"{"+t+","+i+(n.length?","+n:"")+"}"},emptyFilterV1Format:function(e){var t={CVQuery:{}};return t.CVQuery.union={},t.CVQuery.union.expand=[],t.CVQuery.union.expand[0]={},t.CVQuery.union.expand[0].root_path_physicalid=[[e]],1===o.getCVQueryBuildMode()&&(t.CVQuery.specVersion=f.getCurrentSpecificationVersion(),t.CVQuery3D={},t.CVQuery3D.specVersion=f.getCurrentSpecificationVersion(),t.CVQuery3D.union={},t.CVQuery3D.union.expand3d=UWA.clone(t.CVQuery.union.expand)),t},groupingFilterV1Format:function(e,t){for(var i=f.emptyFilterV1Format(e),r=t.groupingPredicate,n=[],s=0;s<t.groupingTags.length;s++){var o=t.groupingTags[s];Array.isArray(o)&&(o=o.join("/")),n.push(o)}for(var a="(",l=0;l<n.length;l++)a+="(["+r+"]:("+n[l]+"))",a+=l<n.length-1?" OR ":"";return a+=")",i.CVQuery.union.expand[0].sequence_filter=[],i.CVQuery.union.expand[0].sequence_filter.push({option:[t.other?"seq_remove":"seq_keep"],definition:[{"q.query":"(physicalid:"+e+")"},{"q.query":a}]}),i},_getFilterSpecification:function(e){return e.filterToApply?e.filterToApply.specification:e.specification?e.specification:void 0},getFilterUIComponents:function(e){return this._getFilterSpecification(e)?this._getFilterSpecification(e).data.filterUIComponents:e.filterUIComponents},computeUXId:function(e,t){return e+(t?"_"+t:"")},isDebugActive:function(e){return this._debug[e]},isActivated:function(e){return this._isActivated[e]},setFilteringContext:function(e){this.updateFilteringContext(e)},updateFilteringContext:function(t){var i=this._filteringContext||{},r=i.tenant;this._filteringContext=e.merge(t,i),r!==this.getTenant()&&o.getPlatformServices(this.getTenant()).then(function(){})},getTenant:function(){return this._filteringContext?this._filteringContext.tenant:"OnPremise"},isProgressiveExpandActive:function(){return 1===a.getOption("ProgressiveExpandOn")?1:0},_getFilterTrackerMetrics:function(){return u},_getTracker:function(e,t,i){if("isWebInWin"===i)var r={appId:"ENOREFS_AP",type:"",category:e,action:t};else{var n={tenant:this.getTenant(),appID:"ENOREFS_AP",widgetid:i||"AdvFilter",eventCategory:e,eventAction:t};"performance"===e?r=d.getPADTracker(n,this._getFilterTrackerMetrics()):"usage"===e&&(r=d.getPADTracker(n))}return r},setUsageTracker:function(e,t,i){var r,n="string"==typeof i?{eventLabel:i,eventValue:1}:{eventLabel:i.label,eventValue:i.value};"isWebInWin"===e?((r=this._getTracker("usage",t,e)).label=n.eventLabel,r.value=n.eventValue,sendNotificationToWin("AddUsageProbe",JSON.stringify(r))):(r=this._getTracker("usage",t,e))&&(r.setEventData(n),r.trackPageEvent())},setPerformanceTracker:function(e,t,i,r,n){var s;"isWebInWin"===e?((s=this._getTracker("performance",t,e)).stepName=i,s.label=Object.keys(r),sendNotificationToWin("StartPerfoProbe",JSON.stringify(s)),n&&sendNotificationToWin("EndPerfoProbe",JSON.stringify(s))):(s=this._getTracker("performance",t,e))&&(s.addMultivaluedEventData(i,r),n&&s.trackPageEvent())},_getPreferredSecurityContextUrl:function(e,t){return this._getURL(e,t,"/resources/pno/person/getsecuritycontext")},getPreferredSecurityContext:function(e,t){var i=this;return new n(function(r,n){o.getPlatformServices(i.getTenant()).then(function(){s.authenticatedRequest(i._getPreferredSecurityContextUrl(e,t),{headers:o.getRESTHeaders(),method:"GET",type:"json",proxy:"passport",onComplete:function(e){r(e?e.SecurityContext:"")},onFailure:function(e){console.log("\n\n ===> getPreferredSecurityContext failed, Error ="+e+"\n\n"),n(e)}})})})},buildV2GraphProperty:function(e){var t=void 0;if(e){if(e.graph)t=e.graph;else{var i=["","types","reltypes"],r=["descending_condition","descending_condition_object","descending_condition_relation"];["","_bo","_rel"].forEach(function(n,s){var o=e["q.iterative_filter_query"+n],a=e["type_filter"+n],l=e["no_type_filter"+n],c="";if(a){var u=" OR ";a.forEach(function(e){c+='(flattenedtaxonomies:"'+i[s]+"/"+e+'")'+u}),c=c.endsWith(u)?c.substring(0,c.length-u.length):c}var d="";if(l){u=" OR ";l.forEach(function(e){d+='(flattenedtaxonomies:"'+i[s]+"/"+e+'")'+u}),d=d.endsWith(u)?d.substring(0,d.length-u.length):d}var h=o||"";c.length&&(c="("+c+")",h+=h.length?" AND  "+c:c),d.length&&(d="NOT("+d+")",h+=h.length?" AND "+d:d),h.length&&((t=t||{})[r[s]]={uql:c.length||d.length?"("+h+")":h})})}f.isDebugActive("ngf")&&console.log("\n ==> buildGraphPorperty\n appQueryParam = "+JSON.stringify(e)+"\n graph = "+JSON.stringify(t))}return t},getDisplaySeparator:function(){var e=a.getOption("displayRoot_Separator")||" - ";return e=-1===e.indexOf("|")?e:e.split("|").join("-")},isRootExcludedFromSynthesis:function(){return a.getOption("ExcludeRootFromSynthesis")?1:0},arePredicatesExcludedFromSynthesis:function(){return o.arePredicatesExcludedFromSynthesis()},getFilterBasics:function(e,t){var i=this,r=Array.isArray(e)?e:[e];return new n(function(e,n){s.authenticatedRequest(i.getBasicsInDBFromIdsUrl(),{headers:o.getRESTHeaders(t),method:"POST",data:JSON.stringify(r),onComplete:function(t){var i=JSON.parse(t).success;i?e(i):n([])},onFailure:function(e){n({})}})})},getConvertPublicSpecToFilterSpecUrl:function(e,t){return this._getURL(e,t,"/resources/FilterInternal/Filter/convertPublicSpecToFilterSpec")},convertPublicSpecToFilterSpec:function(e,t){var i=this;return new n(function(r,n){s.authenticatedRequest(i.getConvertPublicSpecToFilterSpecUrl(),{headers:o.getRESTHeaders(e),method:"POST",data:JSON.stringify(t),type:"json",proxy:"passport",onComplete:function(e){r(e)},onFailure:function(e,t){console.log("==> convertPublicSpecToFilterSpec / error ="+t.error),n(t)}})})},getConvertFilterIdSpecToPublicSpecUrl:function(e,t){return this._getURL(e,t,"/resources/FilterInternal/Filter/convertFilterIdSpecToPublicSpec")},convertFilterIdSpecToPublicSpec:function(e,t){var i=this;return new n(function(r,n){s.authenticatedRequest(i.getConvertFilterIdSpecToPublicSpecUrl()+"?filterId="+encodeURIComponent(t),{headers:o.getRESTHeaders(e),method:"GET",type:"json",proxy:"passport",onComplete:function(e){r(e)},onFailure:function(e){n(e)}})})},getConvertVolatileFilterSpecToPublicSpecUrl:function(e,t){return this._getURL(e,t,"/resources/FilterInternal/Filter/convertVolatileFilterSpecToPublicSpec")},convertVolatileFilterSpecToPublicSpec:function(e,t){var i=this;return new n(function(r,n){s.authenticatedRequest(i.getConvertVolatileFilterSpecToPublicSpecUrl(),{headers:o.getRESTHeaders(e),method:"POST",data:JSON.stringify(t),type:"json",proxy:"passport",onComplete:function(e){r(e)},onFailure:function(e){n(e)}})})},_mergeTagData:function(e,t){if(e||(e={allfilters:{},localfilters:{}}),t&&(t.allfilters||t.localfilters)){for(var i=0;i<Object.keys(t.allfilters).length;i++){var r=Object.keys(t.allfilters)[i];t.allfilters[r].forEach(i=>{-1===(e.allfilters[r]?e.allfilters[r].findIndex(e=>i.object===e.object):-1)&&e.allfilters[r].push(t.allfilters[r][i])})}for(i=0;i<Object.keys(t.localfilters).length;i++){r=Object.keys(t.localfilters)[i];t.localfilters[r].forEach(i=>{-1===(e.localfilters[r]?e.localfilters[r].findIndex(e=>i.object===e.object):-1)&&e.localfilters[r].push(t.localfilters[r][i])})}}return e},getSecurityContext:function(){},upgradeAndCompleteQuery:function(e){var t={},i=e.CVQuery?e.CVQuery:e,r=(i="string"==typeof i?JSON.parse(i):i).specVersion||void 0;if(f.isLastSpecificationVersion(r))t.CVQuery=i,t.CVQuery.specVersion=r;else{for(var n=i,s=f.CVQUERY_VERSIONS,o=s.length,a=s.indexOf(r)+1;a<o;a++)n=this._migrateCVQuery(n,s[a]);t.CVQuery=n,t.CVQuery.specVersion=f.getCurrentSpecificationVersion()}var l=f.getCombinationQuery(t.CVQuery);if(t.CVQuery&&l&&(t.CVQuery3D=UWA.clone(t.CVQuery),!l.expand3d)){var c=f.getCombinationQuery(t.CVQuery3D),u=f.getQueryExpand(c);c.expand3d=u,delete c.expand}for(var d=f.getCombinationQuery(t.CVQuery3D),h=f.getQueryExpand(d),p=0;p<h.length;p++)if(h[p].sequence_filter)for(var g=0;g<h[p].sequence_filter.length;g++)"seq_cut"===h[p].sequence_filter[g].option[0]&&(h[p].sequence_filter[g].option=["seq_keep"]);var _=f.getCombinationType(t.CVQuery3D);return t.CVQuery3D[_].expand3d=h,t},_migrateCVQuery:function(e,t){var i={};switch(t){case f.CVQUERY_VERSIONS[0]:i=e.union?e:f.buildGlobalUnionCVQuery(e)}return i},buildGlobalUnionCVQuery:function(e){var t={union:{}};return t.union.expand=[],t.union.expand[0]=e,e.root_physicalid&&(t.union.expand[0].root_path_physicalid=[[e.root_physicalid]],delete e.root_physicalid),t},_upgradeFilterSpecification:function(e){var t={toFeedUI:{combinationOfSpecification:"union",keepChildren:!0}},i=e.filterUIComponents[0];if("object"==typeof i){var r=i.toFeedUI;r?r.combinationOfSpecification||e.filterUIComponents.unshift(t):e.filterUIComponents=[t,{isActivated:"1",filterSpecificationName:c.get("defaultGroupName"),toFeedUI:e.filterUIComponents}]}else{for(var n=c.get("defaultGroupName"),s=[t],o=0;o<e.filterUIComponents.length;o++)s.push({isActivated:"1",filterSpecificationName:n,toFeedUI:e.filterUIComponents[o]});e.filterUIComponents=s}}});return f}),Number.isInteger=Number.isInteger||function(e){"use strict";return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},define("DS/ENOFilterBIUX/FBIProxyServices",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Class/Promise","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBISettings","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,r,n,s,o){"use strict";return t.singleton(i,{completeCVQueryWithAppSpecs:function(e,t,i){var r=UWA.clone(e),s=n.getCombinationQuery(r);if(t.volume_filter&&Object.keys(t.volume_filter).length)if(s&&s.expand3d)for(var o=0;o<s.expand3d.length;o++)s.expand3d[o].volume_filter?s.expand3d[o].volume_filter.and=UWA.extend(t.volume_filter,s.expand3d[o].volume_filter):s.expand3d[o].volume_filter=UWA.clone(t.volume_filter),i&&t.volume_filter&&t.volume_filter.assemblyshape&&s.expand3d[o].config_filter&&(s.expand3d[o].volume_filter.assemblyshape.config_filter=s.expand3d[o].config_filter);else r.volume_filter=UWA.clone(t.volume_filter),i&&r.config_filter&&r.volume_filter&&r.volume_filter.assemblyshape&&(r.volume_filter.assemblyshape.config_filter=r.config_filter);if(t.find_in_context&&Object.keys(t.find_in_context).length)if(s&&s.expand)for(var a=0;a<s.expand.length;a++)s.expand[a].find_in_context=UWA.clone(t.find_in_context);else if(s&&s.expand3d)for(var l=0;l<s.expand3d.length;l++)s.expand3d[l].find_in_context=UWA.clone(t.find_in_context);else r.find_in_context=UWA.clone(t.find_in_context);if(t.root_path_physicalid&&Object.keys(t.root_path_physicalid).length)if(s&&s.expand)for(var c=0;c<s.expand.length;c++)s.expand[c].root_path_physicalid=UWA.clone(t.root_path_physicalid);else if(s&&s.expand3d)for(var u=0;u<s.expand3d.length;u++)s.expand3d[u].root_path_physicalid=UWA.clone(t.root_path_physicalid);else r.root_path_physicalid=UWA.clone(t.root_path_physicalid);if(t.find_path_filter&&Object.keys(t.find_path_filter).length)if(s&&s.expand)for(var d=0;d<s.expand.length;d++)s.expand[d].find_path_filter=UWA.clone(t.find_path_filter);else if(s&&s.expand3d)for(var h=0;h<s.expand3d.length;h++)s.expand3d[h].find_path_filter=UWA.clone(t.find_path_filter);else r.find_path_filter=UWA.clone(t.find_path_filter);if(t["q.iterative_filter_query_bo"]&&Object.keys(t["q.iterative_filter_query_bo"]).length)if(s&&s.expand)for(d=0;d<s.expand.length;d++)s.expand[d]["q.iterative_filter_query_bo"]=UWA.clone(t["q.iterative_filter_query_bo"]);else if(s&&s.expand3d)for(h=0;h<s.expand3d.length;h++)s.expand3d[h]["q.iterative_filter_query_bo"]=UWA.clone(t["q.iterative_filter_query_bo"]);else r["q.iterative_filter_query_bo"]=UWA.clone(t["q.iterative_filter_query_bo"]);return r},getCompletedQueriesFromFilterIds:function(e,t,i){return new r(function(r,s){n.getAllDataFromFilterIds(e,t,i).then(function(e){var t={};e.success&&(t.success=[],e.success.forEach(e=>{var i,r=JSON.parse(e.filterCVQuery);(i=0===o.getCVQueryBuildMode()?n.upgradeAndCompleteQuery(r):r).filterTitle=e.filterTitle,i.filterPhysicalId=e.filterPhysicalId||e.filterId,i.rootPhysicalId=e.rootPhysicalId,t.success.push(i)})),e.failure&&(t.failure=[],e.failure.forEach(e=>{t.failure.push(e)})),r(t)},function(e){s(e)})})},completeCVQueryWithAppParams:function(t,i,r,s){var o=i||{};delete o.graph;var a={expand_iter:void 0===r?"-1":r};if(t.CVQuery){t.CVQuery="string"==typeof t.CVQuery?JSON.parse(t.CVQuery):t.CVQuery;var l=n.getCombinationQuery(t.CVQuery);if(l)for(var c=n.getQueryExpand(l),u=0;u<c.length;u++){var d=e.merge(c[u],a);d=e.merge(c[u],o),c[u]=d}else t.CVQuery=e.merge(t.CVQuery,a),t.CVQuery=e.merge(t.CVQuery,o)}if(t.CVQuery3D){t.CVQuery3D="string"==typeof t.CVQuery3D?JSON.parse(t.CVQuery3D):t.CVQuery3D;var h=n.getCombinationQuery(t.CVQuery3D);if(h)for(var p=n.getQueryExpand(h),f=0;f<p.length;f++){var g=e.merge(p[f],a);g=e.merge(p[f],o),p[f]=g}else t.CVQuery3D=e.merge(t.CVQuery3D,a),t.CVQuery3D=e.merge(t.CVQuery3D,o)}if(t.CVQueryV2){var _=t.CVQueryV2.batch?t.CVQueryV2.batch.expands:void 0;if(_&&_.length){var I=n.buildV2GraphProperty(i);I&&(t.CVQueryV2.batch.expands[0].graph=I)}}return t}})}),define("DS/ENOFilterBIUX/ENOFBIWebInWinManager",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/FBIServices","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/TagNavigatorProxy/TaggerWebInWinProxy"],function(e,t,i,r,n,s,o){"use strict";var a=0;return o.extend(i,{init:function(e){if(e.proxyId=e.widgetId+"_FBIWebInWin_"+ ++a,e.filteringMode="FilteringOnServer","undefined"!=typeof dscef){sendNotificationWebInWin("event4taggerWebInWin","initTaggerWebinWin")}this._parent.call(this,e)},_dispatchEvent:function(t){if(!e.is(t,"object")||!e.is(t.notif_name)||void 0===t.notif_parameters)throw console.log("E_INVALIDARG in ENOFBIWebInWinManager, expect to have parameters.notif_name arg & parameters.notif_parameters in _dispathTowin !!!"),"No parameters.notif_name arg & parameters.notif_parameters given to _dispatchEvent method !";var i=e.is(t.notif_parameters,"string")?t.notif_parameters:JSON.stringify(t.notif_parameters);"undefined"!=typeof dscef&&sendNotificationWebInWin(t.notif_name,i)}})}),define("DS/ENOFilterBIUX/Abstract_FBIComponentProxy",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","DS/TagNavigatorProxy/TagNavigatorProxy","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/ENOFilterBIUX/FBIProxyServices","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/ExpandV2FormatServices","UWA/Promise","DS/PlatformAPI/PlatformAPI","i18n!DS/ENOFilterBIUX/assets/nls/ENOFilterBIUX","DS/Utilities/Utils","DS/ENOFilterBIUX/ENOFBIWebInWinManager","DS/SNInfraUX/TaggerConfigAccess","DS/ENOFilterBIUX/NGFSessionStorage"],function(e,t,i,r,n,s,o,a,l,c,u,d,h,p,f,g){"use strict";return t.extend(i,{init:function(e){var t=this;if(this._defaultServiceId="3DSpace",e.isWebInWin){e.platformServices&&n.setOption("str_platformServices",e.platformServices),n.setOption("fromWebInWin",1);var i=e.widgetId?e.widgetId:"ENOWIWTaggerProxy";this._optionWIWI={tenant:e.tenant||"OnPremise",appId:e.appId,widgetId:i,platformServices:e.platformServices,events:{addFilterChangeListener:t.filterBIFilter.bind(t),addCriteriaChangeListener:t.filterBIFilter.bind(t),colorize:t.filterBIColorize.bind(t),onAdditionalFilterChange:t.filterNGFilter.bind(t)},colorize:e.colorize,exclude:e.exclude},this._taggerWiWiManager&&this._taggerWiWiManager.die(),this._taggerWiWiManager=new p(this._optionWIWI),this._taggerWiWiManager.toggleProxyFocus(!0)}this._enableTagsOnDemand=!1,r.getFeatureStatus(["enableTagsOnDemand"]).then(function(e){t._enableTagsOnDemand=e?e.enableTagsOnDemand:void 0,t._initDataFromSCC(t._enableTagsOnDemand)});let s=[];["NGF_DisplayDensity","NGF_Most-Recent-Used"].forEach(e=>{localStorage.getItem(e)&&(s.push({key:e,value:localStorage.getItem(e)}),localStorage.removeItem(e))}),s.length&&u.publish("NGFilter_LocalStorage",s),this._initProxyData(e),u.subscribe("NGFilter_Volume",this._onFilterVolume.bind(this)),u.subscribe("Frame3DXInfra.onPanelClose",this._onCloseFilterPanel.bind(this)),u.subscribe("Frame3DXInfra.onPanelOpen",this._onOpenFilterPanel.bind(this)),u.subscribe("Frame3DXInfra.ViewChange",this._onViewChange.bind(this)),u.subscribe("Frame3DXInfra.WidgetRemoved",this._onWidgetRemoved.bind(this)),this._NGFUXIdImpact({type:"subscribeEvents",data:{NGFUXId:this._NGFUXId}}),u.subscribe("NGFilter_saved",this._onSavedFilter.bind(this)),a.isDebugActive("extendedCmds")&&u.subscribe("NGFilter_Debug",this._onNGFDebug.bind(this)),this._shareFilterSpec&&(this._allSharingSpecEvents(),this._allLinkingWgtsEvents())},_initDataFromSCC:function(e){var t=this;this._excludedData=[],this._preferredData=[],n.setOption("scc_excludedData",[]),n.setOption("scc_preferredData",[]),f.get6WTagsConfiguration({appID:this._appId,tenantID:this._tenantId}).then(function(i){for(var r in i)0===i[r].weight?t._excludedData.push(r):e&&t._preferredData.push(r);n.setOption("scc_excludedData",t._excludedData),n.setOption("scc_preferredData",t._preferredData)}).catch(function(e){console.log("_initDataFromSCC: Error in get6WTagsConfiguration")})},_initProxyData:function(e){var t=this;this.optionsToKeep=e,this._tenantId=e.tenant||"OnPremise",n.getPlatformServices(this._tenantId).then(function(){a.setFilteringContext({tenant:t._tenantId}),this._computedSecurityCtxByAPI||t.setDefaultSecurityContext(e.securityContext)}).catch(function(e){console.log("_initProxyData: Error in getPlatformServices")}),this._isProxyActive=!0,this.optionsToKeep.NGFUXId&&a.setUsageTracker(this._widgetId,"NGF-Tagger-NGFUXId",{label:"NGFUXId",value:this.optionsToKeep.NGFUXId}),this._NGFUXId=this.optionsToKeep.NGFUXId||this.optionsToKeep.appId,this._appId=this.optionsToKeep.appId||"fakeAppId",this._widgetId=this.optionsToKeep.widgetId,e.appQueryParam&&this.setAppQueryParam(e.appQueryParam),this._queryFormat=a.getQueryFormat(e.expandServices||e.queryFormat),this._directTaggerProxy=!1,this._setPathTagsWithSynthesis=!1,this._fetchWithSynthesis=!1,this._expandIterParam=e.expandIterParam?e.expandIterParam:"-1",this._expandWithSynthesis=!!e.ExpandSynthesisON,this._expandWithSynthesis&&(this._proxySynthesisMode=s.getOption("synthesis_mode")),this._facetsToFeedTagger={},this._mRootsDataInSession=new Map,this._proxyFeedsTagger=!!e.enableTags,this._applyNGFilterCount=0,this._tagData=void 0,this._keepVolatileTags=[],this.volatileTags={};this._NGFUXId,this._widgetId;this._configUsed=1;var i=!0===e.volumeFilterAvailable,r=!1!==e.selectionFilterAvailable,o=!1!==e.attributeFilterAvailable;this.optionsToKeep.volumeFilterAvailable=i,this.optionsToKeep.selectionFilterAvailable=r,this.optionsToKeep.attributeFilterAvailable=o,this._NGFUXIdImpact({type:"criteriaAvaibility",data:{identifier:this._NGFUXId+"-"+this._widgetId,volumeFilterUsed:i,selectionFilterUsed:r,attributeFilterUsed:o,configFilterUsedfigAvaibility:this._configUsed}}),e.shareFilterSpec&&(this._shareFilterSpec=!0),this._predicates=[],this._nodes=[],this._paths=[],this._tree=[],this._unFilteredPathIDs=[],this._unfilteredTree=[],this._filteredData={},this._colorizedData={},this._nodesIN=[],this._odtSummary=[],this._filterBIToKeep={},this._isFetchCustoDone=!1},taggerWebInWinEvent:function(e){var t=JSON.stringify(e.proxyId).indexOf("_FBIWebInWin"),i=JSON.stringify(e.proxyId).substring(1,t);e.event_id;this.optionsToKeep.widgetId===i&&("addFilterChangeListener"===e.event_id?this.filterBIFilter(e.data):"colorize"===e.event_id?this.filterBIColorize(e.data):"unColorize"===e.event_id?this.filterBIUnColorize(e.data):console.log("\n  ===> Abstract taggerWebInWinEvent/ evt non supported = "+e.event_id))},destroy:function(){var e=this._NGFUXId+"-"+this._widgetId;g.clear(),g.removeItem("NGFilter_Volume_"+e),g.removeItem("NGFilter_Context_"+e),g.removeItem("NGFilter_Attribute_"+e),sessionStorage.removeItem("NGFilter_AppQueryParam_"+e),sessionStorage.removeItem("NGFilter_MonoSixw_"+e),g.publish(),this._cleanNGFSessionItems(),this._parent()},_onWidgetRemoved:function(e){for(var t=[],i=sessionStorage.length,r=0;r<i;r++){var n=sessionStorage.key(r);-1!==n.indexOf(e.id)&&t.push(n)}g.clear(),t.forEach(e=>{sessionStorage.removeItem(e),g.removeItem(e)}),g.publish(),u.publish("NGFilter_WidgetRemoved",{NGFUXId:this._NGFUXId,appId:this._NGFUXId,widgetId:this._widgetId,widgetIdRemoved:e.id,volumeAvailable:this.optionsToKeep.volumeFilterAvailable,contextAvailable:this.optionsToKeep.selectionFilterAvailable,attributeAvailable:this.optionsToKeep.attributeFilterAvailable})},_cleanNGFSessionItems:function(){g.clear();var e=this._NGFUXId+"-"+this._widgetId,t=this._getAllRootsInSession()?this._getAllRootsInSession().length:0;this._mRootsDataInSession.forEach(function(e,t){var i=a.computeUXId(this._NGFUXId,t),r="NGF_isUXBuilt_"+i,n="NGF_tagMgtRunning_"+i;g.removeItem(r),g.removeItem(n)}),t||sessionStorage.removeItem("NGFilter_AppQueryParam_"+e),g.publish()},_onToggleProxyFocus:function(e){if(e&&this.myTagProxy&&this.optionsToKeep){var t=e.widgetId;if(this.optionsToKeep.widgetId===t){var i=e.focus||!0;this.myTagProxy.toggleProxyFocus(i)}}},_setTaggerLocalFilter:function(e){var t=this.myTagProxy.getCurrentFilter();if(this.myTagProxy&&this._needsFiltering(e,t))if(Object.keys(e.allfilters).length||Object.keys(e.localfilters).length){this._keepTagDataInSession(e);var i=UWA.clone(e.allfilters);t&&t.allfilters&&Object.keys(t.allfilters).forEach(e=>{t.allfilters[e].forEach(t=>{let r=i[e]?i[e].findIndex(e=>t.object===e.object):-1;-1!==r&&i[e].splice(r,1)}),i[e]&&!i[e].length&&delete i[e]}),Object.keys(i)&&this.myTagProxy.addLocalFilter(i,!1)}else this._keepTagDataInSession(e),this.myTagProxy.clearLocalFilter(!1)},updateTenant:function(e){e&&this._tenantId!==e&&((this._getAllRootsInSession()?this._getAllRootsInSession().length:0)&&this.removeRoots(this._getAllRootsInSession()),this._tenantId=e,a.updateFilteringContext({tenant:e}),this.setDefaultSecurityContext())},setDefaultSecurityContext:function(e){var t=this;this._computedSecurityCtxByAPI=1;var i=function(e){u.publish("NGFilter.SetDefaultSecurityContext",{NGFUXId:t._NGFUXId,securityContext:e});var i=t._NGFUXId+"-"+t._widgetId;t._NGFUXIdImpact({type:"securityContext",data:{identifier:i,securityContext:e}})};if(e){if(this._defaultSC!==e){this._defaultSC=e;var r=this._defaultSC.indexOf("ctx::"),n=-1===r?this._defaultSC:this._defaultSC.substring(r+"ctx::".length);i(n)}}else a.getPreferredSecurityContext(this._tenantId,this._defaultServiceId).then(e=>{t._defaultSC=e,i(e)},e=>{console.log(" ===> getPreferredSecurityContext() error can be IGNORED with ODT in case of ODT replay")})},odtSetFilters:function(e){this.myTagProxy&&(this.myTagProxy.filters=e)},odtKeepActiveFilters:function(e){e&&(this._filterBIToKeep=e)},_initTaggerProxy:function(t,i,n){var o="FilteringOnServer";null!=i?o="FilteringOnServer":null!=t&&(o="WithFilteringServices");var a=this.optionsToKeep;a.events=e.merge(a.events||{},{addFocusChangeListener:function(e){u.publish("NGFilter.addFocusChangeListener",e)}});var l={widgetId:a.widgetId,tenant:a.tenant,filteringMode:o,colorize:n||a.colorize,events:a.events,exclude:a.exclude,contextId:a.contextId};this._expandWithSynthesis&&(l.enableTagsOnDemand=this._enableTagsOnDemand),void 0!==a.exclude&&(l.exclude=a.exclude),void 0!==a.enableGrouping&&(l.enableGrouping={maxLevels:1,maxPerLevel:-1,maxHierarchyPerLevel:1}),this.optionsToKeep.appId&&(-1===this.optionsToKeep.appId.indexOf("_")&&console.debug("***CAUTION*** : appId is not a real appId: "+this.optionsToKeep.appId),l.appId=this.optionsToKeep.appId),this.optionsToKeep.selection&&(l.selection=this.optionsToKeep.selection),this.myTagProxy||(this.myTagProxy=r.createProxy(l),this.myTagProxy.setAdditionalFilterProperties({title:d.get("activeFilters"),icon:{fonticon:"filter"}}),s.getOption("TaggerDateRanges")&&this._expandWithSynthesis&&this.myTagProxy.configurePredicates({"ds6w:created":{freeInputOnly:!0},"ds6w:modified":{freeInputOnly:!0}}),this.myTagProxy||console.log("#############  ERREUR init TaggerProxy in FilterBIComponentProxy"),this.myTagProxy.addEvent("colorize",this.filterBIColorize.bind(this)),this.myTagProxy.addEvent("unColorize",this.filterBIUnColorize.bind(this)),this.myTagProxy.addEvent("onFilterChange",this.filterBIFilter.bind(this)),this.myTagProxy.addEvent("onGroupingChange",this.filterBIGrouping.bind(this)),this.myTagProxy.addEvent("onSelection",this.filterBISelection.bind(this)),this.myTagProxy.addEvent("onLoadMoreTags",this.filterBIMoreTags.bind(this)),this.myTagProxy.addEvent("onAdditionalFilterChange",this.filterNGFilter.bind(this)))},_completeAppOptions:function(e){var t={};return t.exclude=!(!this._excludedData||!this._excludedData.length)||s.getOption("exclude"),void 0!==e.enableGrouping?t.enableGrouping=e.enableGrouping:!0===s.getOption("enableGrouping")&&(t.enableGrouping={}),t},_setTags:function(e,t,i){var r=this;if(n.getOption("fromWebInWin"))return this._taggerWiWiManager||(this._taggerWiWiManager=new p(this._optionWIWI)),this._taggerWiWiManager.toggleProxyFocus(!0),void this._setTagsWIWIOr3DD(e,t,i);this.myTagProxy||this._initTaggerProxy(e,t),!t||t.length?(this._tagsToSet&&"object"==typeof this._tagsToSet&&Object.keys(this._tagsToSet).length&&(this._setTaggerLocalFilter(this._tagsToSet),this._tagsToSet=void 0),this._directTaggerProxy?this._setTagsWIWIOr3DD(e,t,i):(this._setVolatilesSummariesAfterProxyCreation&&this.setVolatileTags(this._setVolatilesSummariesAfterProxyCreation),this._setPathTagsWithSynthesis||this._fetchWithSynthesis?this._setTagsWIWIOr3DD(e,t,i):(this._expandWithSynthesis||(this.myTagProxy&&(this.myTagProxy.filters=this.myTagProxy.getCurrentFilter()),Object.keys(this.myTagProxy.filters).length&&Object.keys(this.myTagProxy.filters.allfilters).length&&(0===n._getObjectSize(this._filterBIToKeep)||this._filterBIToKeep&&this._filterBIToKeep.allfilters&&Object.keys(this.myTagProxy.filters.allfilters).length>=Object.keys(this._filterBIToKeep.allfilters).length)&&(!0===this._currentlyDispatchingAVolatileFilterEvent?this._currentlyDispatchingAVolatileFilterEvent=!1:this.filterBIFilter(this.myTagProxy.filters))),null!=t?(this.myTagProxy.filters&&(this._filterBIToKeep=this.myTagProxy.filters),Array.isArray(t)&&t.length?this._expandWithSynthesis&&!t[0].dispValue?n.getNlsInfosForFacets(t).then(function(t){r._setTagsWIWIOr3DD(e,t,i)}):this._setTagsWIWIOr3DD(e,t,i):this._setTagsWIWIOr3DD(null,[])):this._setTagsWIWIOr3DD(null,[])))):this._setTagsWIWIOr3DD(null,[])},_setTagsWIWIOr3DD:function(e,t,i){n.getOption("fromWebInWin")?this._taggerWiWiManager.setTags(e,t,i):this.myTagProxy.setTags(e,t,i)},unsetTags:function(){null!==this.myTagProxy&&void 0!==this.myTagProxy&&this.myTagProxy.unsetTags()},filterBIColorize:function(e){},_needsFiltering:function(e,t,i){if(this._taggerUpdatedFromNGF&&!i)return this._taggerUpdatedFromNGF=!1,!1;var r=function(e){const t=new Set;return JSON.stringify(e,(e,i)=>("field"!==e&&t.add(e),i)),JSON.stringify(e,Array.from(t).sort())},n=function(e,t){if((void 0===e||e&&0===Object.keys(e).length)&&void 0===t||e&&0===Object.keys(e).length&&t&&0===Object.keys(t).length)return!0;if(e&&Object.keys(e).length&&(void 0===t||t&&0===Object.keys(t).length))return!1;if(e&&t&&Object.keys(e).length!==Object.keys(t).length)return!1;for(var i in e){if(void 0===t[i]||!t[i])return!1;if(r(e[i])!==r(t[i]))return!1}return!0};return!n(e.allfilters,t.allfilters)||!n(e.localfilters,t.localfilters)},filterBIUnColorize:function(e){(this._getAllRootsInSession()?this._getAllRootsInSession().length:0)&&(a.setUsageTracker(this._widgetId,"NGF-Tagger-ColorizeEvent","Uncolorize"),this.dispatchEvent("FilterBIUnColorizeEvent",e))},_cleanUnFilteredTree:function(e,t,i){return i?e===t:!!e.includes(t)},_cleanTree:function(e,t,i){return i?e===t:!!e.includes(t)},cleanProxy:function(){(this._fetchWithSynthesis||this._proxyFeedsTagger||this._directTaggerProxy)&&this.myTagProxy&&this._setTagsWIWIOr3DD(null,[]),this._initProxyData(this.optionsToKeep),this._taggerWiWiManager&&(this._taggerWiWiManager.die(),this._taggerWiWiManager=null)},filterNGFilter:function(e){!(!e||!Array.isArray(e.filter)||e.filter.length)?u.publish("NGFilter.RemoveFromTaggerACV",e.filter):console.log("filterNGFilter, non supported case: data = "+e.filter)},filterBIFilter:function(e,t){},filterBIGrouping:function(e){},filterBISelection:function(e){},filterBIMoreTags:function(e){},addSubjects:function(e){null!==this.myTagProxy&&void 0!==this.myTagProxy&&this.myTagProxy.addSubjects(e)},focusOnSubjects:function(e,t){null!==this.myTagProxy&&void 0!==this.myTagProxy&&this.myTagProxy.focusOnSubjects(e,t)},unfocus:function(){null!==this.myTagProxy&&void 0!==this.myTagProxy&&this.myTagProxy.unfocus()},toggleProxyFocus:function(e){null!==this.myTagProxy&&void 0!==this.myTagProxy&&this.myTagProxy.toggleProxyFocus(e)},getCurrentFilter:function(){if(null!==this.myTagProxy&&void 0!==this.myTagProxy)return this.myTagProxy.getCurrentFilter()},die:function(){this.cleanProxy(),null!==this.myTagProxy&&void 0!==this.myTagProxy?(this.myTagProxy.die(),this.resetNGFilterUI()):null!==this._taggerWiWiManager&&void 0!==this._taggerWiWiManager&&this._taggerWiWiManager&&this._taggerWiWiManager.die()},activate:function(){return null!==this.myTagProxy&&void 0!==this.myTagProxy?(this._isProxyActive=!0,this.myTagProxy.activate()):null!==this._taggerWiWiManager&&void 0!==this._taggerWiWiManager?(this._isProxyActive=!0,this._taggerWiWiManager.activate()):void 0},deactivate:function(){return null!==this.myTagProxy&&void 0!==this.myTagProxy?(this._isProxyActive=!1,this.myTagProxy.deactivate()):null!==this._taggerWiWiManager&&void 0!==this._taggerWiWiManager?(this._isProxyActive=!1,this._taggerWiWiManager.deactivate()):void 0},setPredicates:function(e){this._predicates=e},setPathTags:function(e,t){},removeRoot:function(e){var t=this;this._parent(e),this.resetNGFilterUI({appId:this.optionsToKeep.appId,widgetId:this.optionsToKeep.widgetId,rootIds:Array.isArray(e)?e:[e],NGFUXId:this._NGFUXId,displayFilter:0}),this._removeRootsDataInSession(e),h.debounce(function(e){t.refreshTagger()},200)()},removeRoots:function(e){this.removeRoot(e)},_setDirectTaggerMode:function(e){this._directTaggerProxy=e},_updateFilteredRootsInSession:function(e,t){var i={},r={},s=!1;if(t){var o,c;if(i={CVQuery:t.CVQuery,CVQuery3D:t.CVQuery3D},t.CVQueryV2)t.CVQueryV2.filter?(o=t.CVQueryV2.filter,c=t.CVQueryV2.aggregation_processors):(o=t.CVQueryV2.batch.expands[0].filter,c=t.CVQueryV2.batch.expands[0].aggregation_processors),r=n.getProgressiveQueryTemplate(e,o,c)}else{i=a.emptyFilterV1Format(e),this._queryFormat&a.EXPAND_SERVICES.expand||delete i.CVQuery,this._queryFormat&a.EXPAND_SERVICES.expand3d||delete i.CVQuery3D;var u=l.emptyFilterFormat().filter;r=n.getProgressiveQueryTemplate(e,u),this._keepFilterIdInSession(e,void 0),s=!0}0===n.getCVQueryBuildMode()&&(i=a.upgradeAndCompleteQuery(i));var d={CVQuery:i.CVQuery,CVQuery3D:i.CVQuery3D,CVQueryV2:r};if(r=(d=this.completeCVQueryWithAppParams(d,this._expandIterParam,this._expandWithSynthesis)).CVQueryV2,i={CVQuery:d.CVQuery,CVQuery3D:d.CVQuery3D},this._mRootsDataInSession.has(e)||this._keepRootsInSession(e),this._mRootsDataInSession.has(e)){var h=this._mRootsDataInSession.get(e),p=h.filterInfos?h.filterInfos.filterId:void 0;h.filterInfos={objQuery:i,objQueryV2:r,fakeFilter:s,filterId:p}}},_keepFilterIdInSession:function(e,t){if(t){var i={};this._mRootsDataInSession.has(e)&&this._mRootsDataInSession.get(e).filterInfos?((i=this._mRootsDataInSession.get(e)).filterInfos.filterId=t,this._mRootsDataInSession.set(e,i)):(this._keepRootsInSession(e),this._mRootsDataInSession.has(e)&&((i=this._mRootsDataInSession.get(e)).filterInfos={},i.filterInfos.filterId=t,this._mRootsDataInSession.set(e,i)))}},_keepTagDataInSession:function(t){this._tagData=e.clone(t)},_removeTagDataInSession:function(){this._tagData=void 0},emptyFilter:function(e){e.rootIds=this._getAllRootsInSession(),this.dispatchEvent("ApplyNGFilter",e),this._cleanNGFSessionItems()},_getAllRootsInSession:function(){return[...this._mRootsDataInSession.keys()]},_getRootsInSession:function(){return n.getRootsInfos(Array.from(this._mRootsDataInSession.values()))},_getAllFilteredRootsInSession:function(){var e=[];return this._mRootsDataInSession.forEach(function(t,i){t.filterInfos&&Object.keys(t.filterInfos).length&&e.push(i)}),e},_keepRootsInSession:function(e){if(void 0!==e){var t=Array.isArray(e)?e:[e];n.getRootsInfos(t).forEach(e=>{var t=e.rootId;this._mRootsDataInSession.has(t)||this._mRootsDataInSession.set(t,{rootId:t,serviceId:e.serviceId})})}},_keepRootsAliasInSession:function(e){var t=this,i=Array.isArray(e)?e:[e];return new c(function(e){n.getInfosFromIds(i,!1,t._defaultSC).then(function(r){r.forEach(function(e){if(!t._mRootsDataInSession.has(e.id)){var r=i.find(t=>e.id===t.rootId);t._keepRootsInSession({rootId:e.id,serviceId:r?r.serviceId:void 0})}if(t._mRootsDataInSession.has(e.id)){var n=t._mRootsDataInSession.get(e.id);n.rootAlias=e.label,t._mRootsDataInSession.set(e.id,n)}}),e()})})},_getNbRootsWithTags:function(){var e=this._getAllRootsInSession()?this._getAllRootsInSession().length:0;if(this._tagData&&e)return e},_removeRootsDataInSession:function(e){(e=Array.isArray(e)?e:[e]).forEach(e=>{this._mRootsDataInSession.delete(e)})},getQueriesInSession:function(e){if(this._mRootsDataInSession.has(e)&&this._mRootsDataInSession.get(e).filterInfos){var t=this._mRootsDataInSession.get(e).filterInfos;return{objQuery:t.objQuery,objQueryV2:t.objQueryV2?t.objQueryV2:void 0,filterId:t.filterId?t.filterId:void 0,fakeFilter:t.fakeFilter?t.fakeFilter:void 0}}},_onSavedFilter:function(e){this._keepFilterIdInSession(e.rootID,e.filterId),this.dispatchEvent("SaveNGFilterAbstract",{rootId:e.rootID,filterId:e.filterId})},onApplyNGFilter:function(e){},setNGFilterOptions:function(e){this._queryFormat=a.getQueryFormat(e.expandServices),this._NGFUXIdImpact({type:"queryFormat",data:{identifier:this._NGFUXId+"-"+this._widgetId,queryFormat:this._queryFormat}}),this._expandIntent=a.getExpandIntent(e.expandIntent),this._NGFUXIdImpact({type:"expandIntent",data:{identifier:this._NGFUXId+"-"+this._widgetId,expandIntent:this._expandIntent}}),this._lightCB=e.lightCBMsg||!1,this._NGFUXIdImpact({type:"lightCB",data:{identifier:this._NGFUXId+"-"+this._widgetId,lightCB:this._lightCB}})},resetNGFilterUI:function(e){if(void 0!==e){var t=e.widgetId||"?";t===this.optionsToKeep.widgetId?(e.NGFUXId=this._NGFUXId,e.rootIds&&(e.rootIds=Array.isArray(e.rootIds)?e.rootIds:[e.rootIds],e.rootIds.forEach(e=>{this._mRootsDataInSession.has(e)&&this._updateFilteredRootsInSession(e)})),u.publish("NGFilter.RemoveFilter",e)):console.log(" ERROR : Invalid data for reset filter ( widgetId  = "+t+")")}},retrieveFiltersFromIds:function(e){var t=this;if(this._tenantId===e.droppedEnvId){e.fromDropOnFilter?a.setUsageTracker(this._widgetId,"NGF-Tagger-DropOnFilter",this._getAppId()):a.setUsageTracker(this._widgetId,"NGF-Tagger-Drop",this._getAppId()),(e.filterObjects&&e.filterObjects.length>1||e.filterIds&&e.filterIds.length>1)&&t.droppedData.callback({success:[],failure:[{msg:d.get("multiFiltersDrop"),eventID:"warning"}]});var i=[];if(e.filterObjects)for(var r=0;r<e.filterObjects.length;r++)i.push(e.filterObjects[r].objectId);else i=e.filterIds;this._retrieveFilter_time0=Date.now(),e.fromDropOnFilter?a.setPerformanceTracker(t._widgetId,"NGF-DropFilterOnFilter","NGFilter_Proxy",{Drop_Filter_duration:Date.now()-this._retrieveFilter_time0},1):a.setPerformanceTracker(t._widgetId,"NGF-DropFilter","NGFilter_Proxy",{Drop_Filter_duration:Date.now()-this._retrieveFilter_time0},1),n.getPlatformServices(this._tenantId).then(function(){a.getAllDataFromFilterIds(i,t._tenantId,t._defaultSC).then(function(i){if(i.success){var r=[],n=[];if(i.success.forEach(e=>{t._mRootsDataInSession.has(e.rootPhysicalId)?r.push(e.rootPhysicalId):n.push({rootId:e.rootPhysicalId,serviceId:e.serviceId})}),r&&r.length&&!t._fromSynchro)e.callback({success:[],failure:[{msg:d.get("dropFilterOnSameRoot"),eventID:"warning"}]});else{var s=t._areRootsCompliantWithSession(n);if(s)console.log("==> retrieveFiltersFromIds / Error: Roots are not compliant with the session"),console.log(s),e.callback({success:[],failure:[s]});else{var o=[].concat(n);t._getRootsInSession().forEach(e=>{e.rootAlias||o.push({rootId:e.rootId,serviceId:e.serviceId})}),t._keepRootsAliasInSession(o).then(function(){for(var r=0;r<i.success.length;r++){var n=i.success[r];t.setFilterSpecification({specification:{type:"NGFilter_RetrieveFilter",data:{addedNodesList_LogicalID:n.addedNodesList_LogicalID,excludedNodesList_LogicalID:n.excludedNodesList_LogicalID,proximityNodesList_LogicalID:n.proximityNodesList_LogicalID,addedNodesList_PhysicalID:n.addedNodesList_PhysicalID,excludedNodesList_PhysicalID:n.excludedNodesList_PhysicalID,proximityNodesList_PhysicalID:n.proximityNodesList_PhysicalID,volumeUsed:t.optionsToKeep.volumeFilterAvailable,contextUsed:t.optionsToKeep.selectionFilterAvailable,attributeUsed:t.optionsToKeep.attributeFilterAvailable,filterId:n.filterPhysicalId,filterName:n.filterName,filterTitle:n.filterTitle,dropOption:e.fromDropOnFilter?"dropOnFilter":"drop",filterMdl:n.filterUIComponents,filterUIComponents:n.filterUIComponents,filterDescription:n.filterDescription,serviceId:n.serviceId}},rootID:n.rootPhysicalId,rootAlias:t._mRootsDataInSession.get(n.rootPhysicalId).rootAlias,applyFilter:e.fromDropOnFilter=1,displayFilter:1});var s=a.computeUXId(t._NGFUXId,n.rootPhysicalId);t._subscribe0&&(t._subscribe0.unsubscribe("NGFilter.ApplyDroppedFilters/"+s),t._subscribe0=void 0),t._callbackOnDrop||(t._callbackOnDrop={}),t._callbackOnDrop[s]=e.callback,t._subscribe0=u.subscribe("NGFilter.ApplyDroppedFilters/"+s,t._applyFilterOnDrop.bind(t))}})}}}else i.success||(i.success=[]),i.failure||(i.failure=[{eventID:"error",msg:d.get("retriveFilterFailed")+(i?"\n"+i.toString():"")}]),t._callbackOnDrop=e.callback,t._callbackOnDrop(i),t._callbackOnDrop=void 0},function(t){e.callback({success:[],failure:[{eventID:"error",msg:t}]})})},function(t){e.callback({success:[],failure:[{eventID:"error",msg:t}]})})}else console.log("**** ERROR FilterBIComponentProxy : tenant has to be updated : newTenant = "+e.droppedEnvId+", previous tenant ="+this._tenantId)},_fromBIFilterToNGFUX:function(e){this._dropOption=e.dropOption,e.rootServiceId=e.serviceId||"3DSpace"},retrieveFilters:function(e){return e.filterObjects[0].objectId?(e.droppedEnvId=e.filterObjects[0].envId,this.retrieveFiltersFromIds(e)):e.filterIds?(e.droppedEnvId||(e.droppedEnvId=e.filterObjects[0].envId),this.retrieveFiltersFromIds(e)):void console.log("*********** FilterBIComponentProxy.retrieveFilters KO : use filterId instead of filterName")},_applyFilterOnDrop:function(t){if(t.success&&t.success.length){var i=a.computeUXId(this._NGFUXId,t.success[0].rootId);if(this._callbackOnDrop&&this._callbackOnDrop[i]){this._setFocusToWidget(),g.clear();for(var r=t.success.length,n=0;n<r;n++){var s,o=a.getCVQueryType(t.success[n].filter);if(t.success[n].hideChildren=this._checkCutInfo(t.success[n].filter[o]),"tbd"===t.success[n].filter&&(s=!0,t.success[n].filter=this.getQueriesInSession(t.success[n].rootId)?this.getQueriesInSession(t.success[n].rootId):void 0,t.success[n].filter)){t.success[n].filter.objQuery&&(t.success[n].filter=e.merge(t.success[n].filter,t.success[n].filter.objQuery),delete t.success[n].filter.objQuery),t.success[n].filter.objQueryV2&&(t.success[n].filter.CVQueryV2=t.success[n].filter.objQueryV2,delete t.success[n].filter.objQueryV2);var l=this._mRootsDataInSession.has(t.success[n].rootId)?this._mRootsDataInSession.get(t.success[n].rootId).rootAlias:void 0;t.success[n].rootAlias=l,t.success[n].fromDropOnFilter="dropOnFilter"===t.success[n].dropOption,t.success[n].filterId=t.success[n].filter.filterId}t.success[n].filter&&!s&&(u.publish("NGFilter.SynchroBIOnFilter/"+this._NGFUXId,{rootId:t.success[n].rootId,filter:t.success[n].filter,filterId:t.success[n].filterId,fromDropOnFilter:t.success[n].fromDropOnFilter,tagsInMdl:t.success[n].fromDropOnFilter?void 0:t.success[n].tagsInMdl}),!0!==t.success[n].fromDropOnFilter?(this._updateFilteredRootsInSession(t.success[n].rootId,t.success[n].filter),this._tagsToSet=t.success[n].tagsInMdl):this._updateFilteredRootsInSession(t.success[n].rootId),t.success[n].filterId&&this._keepFilterIdInSession(t.success[n].rootId,t.success[n].filterId),this._shareFilterSpec&&this._keepShareSpec(t.success[n]),t.success[n].fromDropOnFilter?a.setPerformanceTracker(this._widgetId,"NGF-DropFilterOnFilter","NGFilter_Proxy",{Drop_Filter_duration:Date.now()-this._retrieveFilter_time0},1):a.setPerformanceTracker(this._widgetId,"NGF-DropFilter","NGFilter_Proxy",{Drop_Filter_duration:Date.now()-this._retrieveFilter_time0},1));let r="NGF_tagMgtRunning_"+i;g.setItem(r,!1),t.success[n].filter&&this.cleanUselessDataForApps(t.success[n].filter),t.success[n].tagsInMdl&&delete t.success[n].tagsInMdl}g.publish(),console.log((t.success,t.success)),this._callbackOnDrop[i](t)}this._callbackOnDrop&&this._callbackOnDrop[i]&&(this._callbackOnDrop[i]=void 0)}else if(t.failure&&t.failure.length){i=a.computeUXId(this._NGFUXId,t.failure[0].rootId);this.removeRoot(t.failure[0].rootId),delete t.failure[0].rootId,this._callbackOnDrop&&this._callbackOnDrop[i]&&(this._callbackOnDrop[i](t),this._callbackOnDrop[i]=void 0)}},_onSynchroBI:function(e){e.filter&&e.filter.widget!==this._widgetId?(e.filter&&(e.fromDropOnFilter?this._updateFilteredRootsInSession(e.rootId):this._updateFilteredRootsInSession(e.rootId,e.filter)),e.filterId&&this._keepFilterIdInSession(e.rootId,e.filterId),this._tagsToSet=e.tagsInMdl,this._fromSynchro=!0):e.empty&&e.widget!==this._widgetId&&this.myTagProxy&&this.myTagProxy.getCurrentFilter().localfilters&&this._setTaggerLocalFilter(e.emptyTags)},setVolatileTags:function(e){if(this.myTagProxy||this._taggerWiWiManager){if(e.summary){this._setPathTagsWithSynthesis||this._fetchWithSynthesis?(this._volatileTags=e.summary,this._facetsToFeedTagger=this._facetsToFeedTagger.concat(e.summary),this._setTagsWIWIOr3DD(null,this._facetsToFeedTagger)):(this._summary=this._summary.concat(e.summary),this._volatileTags=e.summary,this._setTagsWIWIOr3DD(null,this._summary));for(var t=0;t<e.summary.length;t++){var i=e.summary[t].sixw;-1===this._keepVolatileTags.indexOf(i)&&this._keepVolatileTags.push(i)}}if(e.colorMap){for(var r in e.colorMap)e.colorMap.hasOwnProperty(r)&&-1===this._keepVolatileTags.indexOf(r)&&this._keepVolatileTags.push(r);n.getOption("fromWebInWin")?this._taggerWiWiManager.setColorMap(e.colorMap):this.myTagProxy.setColorMap(e.colorMap)}delete this._setVolatilesSummariesAfterProxyCreation}else this._setVolatilesSummariesAfterProxyCreation=e},checkVolatileTags:function(e){var t,i,r,n={isVolatileTag:!1};if(r=this.volatileTags,!e)return this.volatileTags={},n;for(var s in r)r.hasOwnProperty(s)&&void 0===e[s]&&delete this.volatileTags[s];for(var o in e)if(e.hasOwnProperty(o)&&this._keepVolatileTags.indexOf(o)>-1){if(i=e[t=o],!this.volatileTags[t])return this.volatileTags[t]=i,n.isVolatileTag=!0,n.predicateName=t,n;if(i.length===this.volatileTags[t].length)return this.volatileTags[t]=i,n.isVolatileTag=!0,n.predicateName=t,n}return n},completeCVQueryWithAppSpecs:function(e,t,i){return o.completeCVQueryWithAppSpecs(e,t,i)},completeCVQueryWithAppParams:function(e,t,i){return o.completeCVQueryWithAppParams(e,this.getAppQueryParam(),t,i)},_onCloseFilterPanel:function(e){if("dataFilterPanelCtn"===e.tag){"dropOnFilter"===this._dropOption&&this._expandWithSynthesis&&this.refreshTagger(),this.dispatchEvent("NGFilter_CloseAbstract",e);var t=this._getAllRootsInSession();g.clear(),t.forEach(e=>{let t="NGF_tagMgtRunning_"+a.computeUXId(this._NGFUXId,e);g.setItem(t,!1)}),g.publish(),this._fromSynchro&&(this._fromSynchro=void 0)}},_onOpenFilterPanel:function(e){if("taggerCtn"===e.tag){"dropOnFilter"===this._dropOption&&this._expandWithSynthesis&&this.refreshTagger(),this.dispatchEvent("NGFilter_CloseAbstract",e);var t=this._getAllRootsInSession();g.clear(),t.forEach(e=>{let t="NGF_tagMgtRunning_"+a.computeUXId(this._NGFUXId,e);g.setItem(t,!1)}),g.publish()}},_onFilterVolume:function(e){this._NGFUXId===e.NGFUXId&&this.optionsToKeep.volumeFilterAvailable&&this.dispatchEvent("NGFilter_VolumeAbstract",e)},setVolumeFilter:function(e){var t,i=e.volume;if(i){e.NGFUXId=this._NGFUXId,e.appId=this._NGFUXId;var r=i.root_path_physicalid;if(r&&r.length){t=r[0][0];var s=e.filteredRoot||t;e.rootId=s,e.rootAlias="",e.UXId=a.computeUXId(this._NGFUXId,s);let c=i.type;"box"===c?(i.corner_min=i.corner_min.map(Number),i.corner_max=i.corner_max.map(Number),i.transformation_matrix=i.transformation_matrix.map(Number)):"sphere"===c?(i.center=i.center.map(Number),i.radius=parseFloat(i.radius)):"proximity"!==c&&"space"!==c||(i.distance=isNaN(i.distance)?0:parseFloat(i.distance));var o=[];"proximity"===i.type||"space"===i.type?r[0].forEach(function(e){o.push(e)}):o.push(t),o.push(s);var l=this;n.getInfosFromIds(o,!0).then(function(t){for(var i=[],r=o.length-1,n=t.length,a=0;a<r;a++)for(var c=0;c<n;c++)if(o[a]===t[c].id){i.push(t[c].label);break}var u=t.findIndex(function(e){return s===e.id});-1!==u&&(e.rootAlias=t[u].label),l._updateVolumeFilter(e,i)},function(t){l._updateVolumeFilter(e)})}}void 0===t&&u.publish("NGFilter_CancelVolumeDefined",{NGFUXId:this._NGFUXId})},_updateVolumeFilter:function(e,t){if(e.volume.root_path_alias=t,e.id){var i=e.id.split("_");if(2<=i.length){var r=i[1].split("-");2<=r.length&&(e.specId=parseInt(r[0]),e.setId=parseInt(r[1]))}}this.setFilterSpecification({specification:{type:"NGFilter_VolumeDefined",data:e},volumeUsed:!0,UXId:e.UXId,rootID:e.rootId,rootAlias:e.rootAlias,applyFilter:0,displayFilter:1})},_onViewChange:function(e){if(this._widgetId===e.id){var t={type:e.type,NGFUXId:this._NGFUXId,widgetId:this._widgetId};u.publish("NGFilter_ViewChange",t)}},setProxyAsMaster:function(e){this.optionsToKeep.synthesis_priority=1},getExpandBSDSpec:function(t,i,r){const n=t[0][0];var s={},o=i.predicate,c=i.nodePath,u=a.buildV2GraphProperty(this.getAppQueryParam());(s={batch:{}}).batch.expands=[];for(let e=0;e<t.length;e++){var d=this.getQueriesInSession(n)&&!this.getQueriesInSession(n).fakeFilter?this.getQueriesInSession(n).objQueryV2:void 0,h="expandBSDNodeSpec_"+e,p=l._internalComputeGroupingBSDNode(c,o,!0);s.batch.expands.push(this._internalGetBSDGroup(d,t[e],p,o,u,r,h))}return e.clone(s)},getExpandSpec:function(t,i,r){t=Array.isArray(t)?t:[t];var n={},s=a.buildV2GraphProperty(this.getAppQueryParam());(n={batch:{}}).batch.expands=[];for(let a=0;a<t.length;a++){const p=t[a];var o=this.getQueriesInSession(p)&&!this.getQueriesInSession(p).fakeFilter?this.getQueriesInSession(p).objQueryV2:void 0;if(i.groupingIntent){var c=l._internalComputeGroupingTags(i.groupingIntent[0],!0);i.groupingIntent[0].other?n.batch.expands.push(this._internalGetGroupingSpec(o,p,c,s,"labelPrefix","Other","Other",!1)):(n.batch.expands.push(this._internalGetGroupingSpec(o,p,c,s,"labelPrefix","KeepInst","Inst",!1)),n.batch.expands.push(this._internalGetGroupingSpec(o,p,c,s,"labelPrefix","KeepRef","Ref",!1)))}if(i.expandIntent){var u={};o?u.filter=o.objQueryV2.batch.expands[0].filter:u=l.emptyFilterFormat(p);var d=e.clone(l.updateWithAppParams(p,u,i.expandIntent)),h=e.clone(this.completeCVQueryWithAppParams(d,this._expandIterParam,this._expandWithSynthesis));h.root=p,h.label=r+"_"+p+"_expand",h.graph=s,h.aggregation_processors=o?o.objQueryV2.batch.expands[0].aggregation_processors:[],this._completeCVQueryForExpand(i.expandIntent,h,n),n.batch.expands.push(h)}}return e.clone(n)},_completeCVQueryForExpand:function(e,t,i){var r=e?e.expandIntent:null;r&&r.tagger_select?(l.selectionAggrProcessors(r.tagger_select,t),l.selectionOutputs(i)):r&&r.find_subpaths&&l.subPathAggrProcessors(r.tagger_select,t)},getSequenceFilterFromAppIntent:function(e){var t=e?e.V2:null;if(t&&t.tagger_select){var i=l.taggerSelectFormat(t.tagger_select);return i?i.sequence_filter:null}if(t&&t.find_subpaths){var r=l.appSubPathsFormat(t.find_subpaths);return r?r.or.filters[0].sequence_filter:null}if(t&&t.find_in_context){var n=l.appSequenceFormat(t.find_in_context);return n?n.sequence_filter:null}console.log("getSequenceFilterFromAppIntent, non supported case "+JSON.stringify(e))},buildSpecFromAppIntent:function(e){var t=e?e.V2:null;return t&&t.tagger_select?l.taggerSelectFormat(t.tagger_select):t&&t.find_subpaths?l.appSubPathsFormat(t.find_subpaths):t&&t.find_in_context?l.appSequenceFormat(t.find_in_context):void console.log("getSequenceFilterFromAppIntent, non supported case "+JSON.stringify(e))},GetFilterSpec:function(e,t){return this.getFilterSpec(e,t)},getFilterSpec:function(e,t){var i=this.getQueriesInSession(e);return this._internGetFilterSpec(e,i,t)},getFilterIdSpec:function(e,t){var i=this;return new c(function(r,s){o.getCompletedQueriesFromFilterIds([e],i._tenantId).then(function(e){if(e.success){var o=e.success[0].rootPhysicalId,a={},l={};if(e.success[0]){var c,u;if(a={CVQuery:e.success[0].CVQuery,CVQuery3D:e.success[0].CVQuery3D},e.success[0].CVQueryV2)e.success[0].CVQueryV2.filter?(c=e.success[0].CVQueryV2.filter,u=e.success[0].CVQueryV2.aggregation_processors):(c=e.success[0].CVQueryV2.batch.expands[0].filter,u=e.success[0].CVQueryV2.batch.expands[0].aggregation_processors),l=n.getProgressiveQueryTemplate(o,c,u),a.objQueryV2=l;else console.log("getFilterIdSpec ERROR : missing CVQueryV2"+e.success),s({msg:d.get("invalidFilterId"),eventID:"warning"});var h=i.completeCVQueryWithAppParams(a,i._expandIterParam);r(i._internGetFilterSpec(o,h,t))}}e.failure&&s({msg:d.get("invalidFilterId"),eventID:"warning"})})})},_internGetFilterSpec:function(t,i,r){if((i||r)&&(!(i&&i.fakeFilter&&r.V1)||Object.keys(r.V1).length)&&(!(i&&i.fakeFilter&&r.V2)||Object.keys(r.V2).length)&&(i||!r.V1||Object.keys(r.V1).length)&&(i||!r.V2||Object.keys(r.V2).length)){if(r.V1&&this._queryFormat){var n={};if(r.V1.groupingFilter){if(i&&!i.fakeFilter)return void console.log("*** ERROR * - getFilterSpec, called on group fake node, with already user filter");var s=a.groupingFilterV1Format(t,r.V1.groupingFilter);i.objQuery=this.completeCVQueryWithAppParams("string"==typeof s?JSON.parse(s):s,"1",this._expandSynthesisON),i.objQuery.CVQuery3D&&delete i.objQuery.CVQuery3D,n=e.clone(i.objQuery)}else{if(!i){i={};var o=a.emptyFilterV1Format(t);i.objQuery=this.completeCVQueryWithAppParams("string"==typeof o?JSON.parse(o):o,this._expandIterParam,this._expandSynthesisON)}Object.keys(r.V1).length?(i.objQuery&&i.objQuery.CVQuery&&(n.CVQuery=UWA.clone(this.completeCVQueryWithAppSpecs(i.objQuery.CVQuery,r.V1))),i.objQuery&&i.objQuery.CVQuery3D&&(n.CVQuery3D=UWA.clone(this.completeCVQueryWithAppSpecs(i.objQuery.CVQuery3D,r.V1)))):n=e.clone(i.objQuery)}return n}if(r.V2){var c={},u=r.V2;if(i){var d={filter:i.objQueryV2.batch.expands[0].filter,aggregation_processors:i.objQueryV2.batch.expands[0].aggregation_processors};c=e.clone(l.updateWithAppParams(t,d,u))}else{var h=l.emptyFilterFormat(t);c=e.clone(l.updateWithAppParams(t,h,u))}return c}}},getGroupingBSDSpec:function(e,t,i){for(var r=[],s=n.getProgressiveQueryTemplate(),o=a.buildV2GraphProperty(this.getAppQueryParam()),l=0;l<e.length;l++){var c=e[l].length,u=e[l][c-1],d="BSDGroupOnInstance_SynthesisPath_"+l;r.push(d);var h="BSDGroupOnInstance_Rateau_"+l;r.push(h);var p=this.getQueriesInSession(u)&&!this.getQueriesInSession(u).fakeFilter?this.getQueriesInSession(u).objQueryV2:void 0;s.batch.expands.push(this._internalGetBSDGroup(p,e[l],null,null,o,i,d)),s.batch.expands.push(this._internalGetBSDGroup(p,e[l],null,t,o,i,h))}return s.outputs={facet_name:"ds6w",include_predicates:[t],synthesis:r},s},getGroupingSpec:function(e,t,i){var r=[];if(!(1<t.length)){for(var s=t[0].predicate,o=(e[0][0],n.getProgressiveQueryTemplate()),c=a.buildV2GraphProperty(this.getAppQueryParam()),u=0;u<e.length;u++){var d=e[u].length,h=e[u][d-1],p="GroupingSynthesis_"+u,f="OtherSynthesis_"+u;r.push(p),r.push(f);var g=this.getQueriesInSession(h)&&!this.getQueriesInSession(h).fakeFilter?this.getQueriesInSession(h).objQueryV2:void 0,_=l._internalComputeGroupingTags(t[0]);o.batch.expands.push(this._internalGetGroupingSpec(g,h,_,c,i,p,"Inst",!0)),o.batch.expands.push(this._internalGetGroupingSpec(g,h,_,c,i,p,"Ref",!0)),o.batch.expands.push(this._internalGetGroupingSpec(g,h,_,c,i,f,"Other",!0))}return o.outputs={facet_name:"ds6w",include_predicates:[s],synthesis:r},o}console.log("**** ERROR * getGroupingSpec : Group on SEVERAL predicates not supported")},_internalGetBSDGroup:function(e,t,i,r,s,o,a){var l={},c=t[0],u=t[t.length-1],d={and:{}};d.and.filters=[];var h=!1,p=!0;if(i){var f={sequence_filter:{}};f.sequence_filter.sequence=[],f.sequence_filter.sequence.push({uql:"physicalid:"+u}),f.sequence_filter.sequence.push({statement:"NEXT"}),f.sequence_filter.sequence.push({uql:"(mxobjecttype:(RELATIONSHIP) AND "+i+")"}),d.and.filters.push(f)}else if(r){var g={sequence_filter:{}};g.sequence_filter.sequence=[],g.sequence_filter.sequence.push({uql:"physicalid:"+u}),g.sequence_filter.sequence.push({statement:"NEXT"}),g.sequence_filter.sequence.push({uql:'(mxobjecttype:(RELATIONSHIP)) AND (NOT listofcfgfields:"'+r+'")'}),d.and.filters.push(g)}else d.and.filters.push({all:1}),h=!0,p=!1;l.aggregation_processors=[];var _={truncate:{}};_.truncate.max_distance_from_prefix=1,_.truncate.prefix_filter={prefix_path:[{physical_id_path:void 0===t?[c]:t}]},l.aggregation_processors.push(_);var I={synthesis:{}};p||(I.synthesis.group_by_facet=1),I.synthesis.mode="tree_leaf_instance",I.synthesis.name=a,h&&(I.synthesis.synthesis_only=1),l.aggregation_processors.push(I);var F=n.getProgressiveExpandItemTemplate(c,d);return l.filter=F.filter,e&&l.filter.and.filters.push(e.batch.expands[0].filter),l.root=F.root,l.label=o+"_"+t[t.length-1],s&&(l.graph=s),l},_internalGetGroupingSpec:function(e,t,i,r,s,o,a,c){var u={},d={},h="Other"===a?"and_not":"and";d[h]={},"and"===h?(d[h].filters=[],d[h].filters=l.tagGroupingFormat(t,i,r,a).filters):d[h]=l.tagGroupingFormat(t,i,r,a),u.aggregation_processors=l.groupingAggrProcessorsFormat(t,o,i,a,c);var p=n.getProgressiveExpandItemTemplate(t,d);u.filter=p.filter,e&&("and_not"===h?(delete u.filter.and_not.left,u.filter.and_not.left={},u.filter.and_not.left.or={},u.filter.and_not.left.or.filters=[],u.filter.and_not.left.or.filters.push(e.batch.expands[0].filter)):u.filter.and.filters.push(e.batch.expands[0].filter)),u.root=p.root;var f="Other"===a?"Other":"Grouping";return u.label=s+"_"+t+"_"+f,r&&(u.graph=r),u},HasFilter:function(e){return this.hasFilter(e)},hasFilter:function(e){var t={hasFilter:!1},i=this.getQueriesInSession(e);return i&&i.objQuery&&(i.fakeFilter?t.hasFilter=!1:(t.hasFilter=!0,t.filterId=i.filterId)),t},shareFilterSpec:function(e){var t=this;e.serviceId=e.serviceId||"3DSpace";var i=this._areRootsCompliantWithSession({rootId:e.fromRootId,serviceId:e.serviceId});if(i)console.log("==> shareFilterSpec / Error: Roots are not compliant with the session"),console.log(i),e.callback({success:[],failure:[i]});else{a.setUsageTracker(this._widgetId,"NGF-Tagger-Share",this._getAppId());var r=a.computeUXId(this._NGFUXId,e.fromRootId);this._callbackOnDrop||(this._callbackOnDrop={}),this._callbackOnDrop[r]=e.callback;var n=this._getAllRootsInSession(),s=[];if((n?n.find(function(t){return t===e.fromRootId}):void 0)?s.push(e.fromRootId):n.push(e.fromRootId),s&&s.length)e.callback({success:[],failure:[{msg:d.get("dropFilterOnSameRoot"),eventID:"warning"}]});else{this._subscribe&&this._subscribe[r]&&(this._subscribe[r].unsubscribe("NGFilter.ApplyDroppedFilters/"+r),this._subscribe[r]=void 0);var o=e.fromSourceCtx.NGFUXId||e.fromSourceCtx.appId;u.subscribe("NGF_sh_filteredMdlsResponse/"+o,function(i){u.unsubscribe("NGF_sh_filteredMdlsResponse/"+o);var n=i.fromSourceCtx.NGFUXId||i.fromSourceCtx.appId;o===n&&(t._subscribe||(t._subscribe={}),t._subscribe[r]=u.subscribe("NGFilter.ApplyDroppedFilters/"+r,t._applyFilterOnDrop.bind(t)),t.setFilterSpecification({specification:{type:"NGFilter_ShareFilterSpec",data:{rootID:i.fromRootId,rootAlias:i.rootAlias,filterId:i.filterId,dropOption:e.fromDropOnFilter?"dropOnFilter":"drop",filterMdl:i.filterMdl,filterUIComponents:i.filterMdl,volumeUsed:i.volumeUsed,contextUsed:i.contextUsed,attributeUsed:i.attributeUsed,configUsed:i.configUsed,queryFormat:i.queryFormat,expandIntent:i.expandIntent,serviceId:i.serviceId}},rootID:i.fromRootId,rootAlias:i.rootAlias,applyFilter:e.fromDropOnFilter=1,displayFilter:1}))}),u.publish("NGF_sh_filteredMdls/"+o,e)}}},linkWith:function(e){var t=this,i=!1,r=this._getAllRootsInSession();r&&0!==r.length||(i=!0),this._widgetId===e.srcWgtId?i?e.callback({success:"link done",failure:[]}):u.subscribe("NGF_link_done/"+e.srcWgtId,function(t){u.unsubscribe("NGF_link_done/"+e.srcWgtId),e.callback({success:"link done",failure:[]})}):(u.subscribe("NGF_lnkUnlnk_srcDataResponse/"+this._widgetId,function(n){u.unsubscribe("NGF_lnkUnlnk_srcDataResponse/"+t._widgetId);var s=JSON.parse(n);if(s.rootID&&s.rootID.length){var o={rootID:r,specification:{type:"NGFilter_Link",data:{NGFUXId:s.NGFUXId,widgetId:e.srcWgtId,rootID:s.rootID,rootAlias:s.rootAlias,volumeUsed:s.volumeUsed,contextUsed:s.contextUsed,attributeUsed:s.attributeUsed,configUsed:s.configUsed,queryFormat:s.queryFormat,expandIntent:s.expandIntent,eventName:"NGF_link_done/"+e.srcWgtId,tagData:s.tags,empty:s.empty}},applyFilter:t._needsApplyFilter(s,s.rootID[0])};t.setFilterSpecification(o)}else i=!0;var a=t._NGFUXId,l=t.getAppQueryParam();t._NGFUXId=s.NGFUXId;var c=s.NGFUXId+"-"+t._widgetId,d=a+"-"+t._widgetId;t._NGFUXIdImpact({type:"subscribeEvents",data:{NGFUXId:s.NGFUXId,toClean:a}}),t._NGFUXIdImpact({type:"criteriaAvaibility",data:{identifier:c,volumeFilterUsed:t.optionsToKeep.volumeFilterAvailable,selectionFilterUsed:t.optionsToKeep.selectionFilterAvailable,attributeFilterUsed:t.optionsToKeep.attributeFilterAvailable,configFilterUsedfigAvaibility:t._configUsed,toClean:d}}),t._NGFUXIdImpact({type:"queryFormat",data:{identifier:c,queryFormat:t._queryFormat,toClean:d}}),t._NGFUXIdImpact({type:"expandIntent",data:{identifier:c,expandIntent:t._expandIntent,toClean:d}}),t._NGFUXIdImpact({type:"appQueryParam",data:{identifier:c,appQueryParam:l,toClean:d}}),t._NGFUXIdImpact({type:"securityContext",data:{identifier:c,securityContext:t._defaultSC,toClean:d}}),t._NGFUXIdImpact({type:"lightCB",data:{identifier:c,lightCB:t._lightCB,toClean:d}}),t._mRootsDataInSession=new Map(Object.entries(s.BIData)),t._keepTagDataInSession(s.tags),i?e.callback({success:"link done",failure:[]}):u.subscribe("NGF_link_done/"+e.srcWgtId,function(t){u.unsubscribe("NGF_link_done/"+e.srcWgtId),e.callback({success:"link done",failure:[]})})}),u.publish("NGF_lnkUnlnk_srcData/"+e.srcWgtId,this._widgetId))},_needsApplyFilter:function(e,t){var i=e.BIData&&e.BIData[t]?e.BIData[t].filterInfos:void 0,r=!!i&&!i.fakeFilter,n=this._mRootsDataInSession&&this._mRootsDataInSession.get(t)?this._mRootsDataInSession.get(t).filterInfos:void 0,s=!!n&&!n.fakeFilter;return!!(r||!r&&s)},unlink:function(e){var t=this;this._widgetId===e.srcWgtId?u.subscribe("NGF_unlink_done/"+e.srcWgtId,function(t){u.unsubscribe("NGF_unlink_done/"+e.srcWgtId),e.callback({success:"unlink done",failure:[]})}):this._widgetId===e.widgetId&&this._NGFUXId!==e.NGFUXId&&(u.subscribe("NGF_lnkUnlnk_srcDataResponse/"+t._widgetId,function(i){u.unsubscribe("NGF_lnkUnlnk_srcDataResponse/"+t._widgetId);var r=JSON.parse(i),n=t.getAppQueryParam();t._keepTagDataInSession(r.tags),t._NGFUXId=e.NGFUXId;var s=e.NGFUXId+"-"+t._widgetId,o=e.srcWgtId+"-"+t._widgetId;if(t._NGFUXIdImpact({type:"subscribeEvents",data:{NGFUXId:e.NGFUXId,toClean:e.srcWgtId}}),t._NGFUXIdImpact({type:"criteriaAvaibility",data:{identifier:s,volumeFilterUsed:t.optionsToKeep.volumeFilterAvailable,selectionFilterUsed:t.optionsToKeep.selectionFilterAvailable,attributeFilterUsed:t.optionsToKeep.attributeFilterAvailable,configFilterUsedfigAvaibility:t._configUsed,toClean:o}}),t._NGFUXIdImpact({type:"queryFormat",data:{identifier:s,queryFormat:t._queryFormat,toClean:o}}),t._NGFUXIdImpact({type:"expandIntent",data:{identifier:s,expandIntent:t.expandIntent,toClean:o}}),t._NGFUXIdImpact({type:"appQueryParam",data:{identifier:s,appQueryParam:n,toClean:o}}),t._NGFUXIdImpact({type:"securityContext",data:{identifier:s,securityContext:t._defaultSC,toClean:o}}),t._NGFUXIdImpact({type:"lightCB",data:{identifier:s,lightCB:t._lightCB,toClean:o}}),r.rootID&&r.rootID.length){var a={rootID:r.rootID,rootAlias:r.rootAlias,specification:{type:"NGFilter_Unlink",data:{NGFUXId:r.NGFUXId,widgetId:e.srcWgtId,rootID:r.rootID,rootAlias:r.rootAlias,volumeUsed:r.volumeUsed,contextUsed:r.contextUsed,attributeUsed:r.attributeUsed,configUsed:r.configUsed,queryFormat:r.queryFormat,expandIntent:r.expandIntent,tagData:r.tags,eventName:"NGF_unlink_done/"+e.srcWgtId,empty:r.empty}},applyFilter:0};t.setFilterSpecification(a)}u.subscribe("NGF_unlink_done/"+e.srcWgtId,function(t){u.unsubscribe("NGF_unlink_done/"+e.srcWgtId),e.callback({success:"unlink done",failure:[]})})}),u.publish("NGF_lnkUnlnk_srcData/"+e.srcWgtId,this._widgetId))},refreshTagger:function(){this._fetchWithSynthesis?this.setTagsWithFetchSynthesis(this._getAllRootsInSession()):this._expandWithSynthesis&&this._proxyFeedsTagger&&this._setTagsWithFilteredExpandSynthesis()},RetrievePrdFromFilterId:function(e){return this.retrieveRootFromFilterId(e,!1)},retrieveRootFromFilterId:function(e,t){var i=this;return new c(function(r,s){if(e.length>1)s({msg:d.get("multiFiltersDrop"),eventID:"warning"});else{var o=e[0];n.getPlatformServices(i._tenantId).then(function(){a.getFilterDataFromFilterId(o,i._tenantId,i._defaultSC).then(function(e){if(e.success){var n=e.success[0];t&&this.setFilterSpecification({specification:{type:"NGFilter_RetrieveRoot",data:{filterId:o,dropOption:"dropOnFilter",serviceId:n.serviceId,configUsed:i._configUsed,volumeUsed:i.optionsToKeep.volumeFilterAvailable,contextUsed:i.optionsToKeep.selectionFilterAvailable,attributeUsed:i.optionsToKeep.attributeFilterAvailable}},rootID:n.rootPhysicalId,rootAlias:i._mRootsDataInSession.get(n.rootPhysicalId).rootAlias,applyFilter:0,displayFilter:1}),r(n.rootPhysicalId)}else s({msg:d.get("invalidFilterId"),eventID:"warning"})})})}})},_checkCutInfo:function(e){var t=!1;if(e&&e.sequence_filter)"seq_cut"===e.sequence_filter.option&&(t=!0);else{var i=a.getCombinationQuery(e);if(i){var r=a.getQueryExpand(i);if(r&&r[0].sequence_filter)-1!==r[0].sequence_filter[0].option.indexOf("seq_cut")&&(t=!0)}}return t},_setFocusToWidget:function(){widget&&widget.dispatchEvent("onViewRequest",{focus:!0})},getCtxForSharing:function(){return this._shareFilterSpec?{appId:this._NGFUXId,widgetId:this._widgetId}:void 0},areRootsSharable:function(e,t){var i=Array.isArray(e)?e:[e];return t?new Promise(function(e,r){var n=t.NGFUXId||t.appId;u.subscribe("NGF_sh_filteredRootsResponse/"+n,function(t){u.unsubscribe("NGF_sh_filteredRootsResponse/"+n),e(t)}),u.publish("NGF_sh_filteredRoots/"+n,{rootIds:i,widgetId:t.widgetId})}):new Promise(function(e,t){for(var r=0;r<i.length;r++)toReturn.push({rootId:i[r],hasFilter:!1})})},_allSharingSpecEvents:function(){u.subscribe("NGF_sh_filteredRoots/"+this._NGFUXId,this._onSourceFilteredRootsCB.bind(this)),u.subscribe("NGF_sh_filteredMdls/"+this._NGFUXId,this._onSourceShareFilterSpecCB.bind(this))},_allLinkingWgtsEvents:function(){u.subscribe("NGF_lnkUnlnk_srcData/"+this._widgetId,this._onSourceDataForLnkUnlnk.bind(this))},_onRenameNGFilter:function(e){var t=[];e&&t.push({displayValue:e,icon:"I_DefineFilter"}),this.myTagProxy&&this.myTagProxy.setAdditionalFilter(t),this._appliedFilterValue=e},_NGFUXIdImpact:function(e){var t=e.type,i=e.data;g.clear();let r="";switch(t){case"subscribeEvents":i.toClean&&(u.unsubscribe("onApplyNGFilter/"+i.toClean),u.unsubscribe("NGFilter.SynchroBIOnFilter/"+i.toClean),u.unsubscribe("NGFilter.onRenameNGFilter/"+i.toClean),this._shareFilterSpec&&(u.unsubscribe("NGF_sh_filteredRoots/"+i.toClean),u.unsubscribe("NGF_sh_filteredMdls/"+i.toClean))),u.subscribe("onApplyNGFilter/"+i.NGFUXId,this.onApplyNGFilter.bind(this)),this._subscribeSynchro=u.subscribe("NGFilter.SynchroBIOnFilter/"+i.NGFUXId,this._onSynchroBI.bind(this)),u.subscribe("NGFilter.onRenameNGFilter/"+i.NGFUXId,this._onRenameNGFilter.bind(this)),this._shareFilterSpec&&(u.subscribe("NGF_sh_filteredRoots/"+i.NGFUXId,this._onSourceFilteredRootsCB.bind(this)),u.subscribe("NGF_sh_filteredMdls/"+i.NGFUXId,this._onSourceShareFilterSpecCB.bind(this)));break;case"criteriaAvaibility":let e=i.toClean;e&&(g.removeItem("NGFilter_Volume_"+e),g.removeItem("NGFilter_Context_"+e),g.removeItem("NGFilter_Attribute_"+e)),e=i.identifier,g.setItem("NGFilter_Volume_"+e,i.volumeFilterUsed),g.setItem("NGFilter_Context_"+e,i.selectionFilterUsed),g.setItem("NGFilter_Attribute_"+e,i.attributeFilterUsed);break;case"queryFormat":i.toClean&&(r="NGFilter_ExpandType_"+i.toClean,sessionStorage.removeItem(r),g.removeItem(r)),r="NGFilter_ExpandType_"+i.identifier,sessionStorage.setItem(r,i.queryFormat),g.setItem(r,i.queryFormat);break;case"expandIntent":i.toClean&&(r="NGFilter_ExpandIntent_"+i.toClean,sessionStorage.removeItem(r),g.removeItem(r)),r="NGFilter_ExpandIntent_"+i.identifier,sessionStorage.setItem(r,i.expandIntent),g.setItem(r,i.expandIntent);break;case"appQueryParam":i.toClean&&sessionStorage.removeItem("NGFilter_AppQueryParam_"+i.toClean),this.setAppQueryParam(i.appQueryParam);break;case"securityContext":i.toClean&&sessionStorage.removeItem("NGFilter_SecurityContext_"+i.toClean),sessionStorage.setItem("NGFilter_SecurityContext_"+i.identifier,i.securityContext);break;case"lightCB":i.toClean&&g.removeItem("NGFilter_lightCB_"+i.toClean),g.setItem("NGFilter_lightCB_"+i.identifier,i.lightCB)}g.publish()},_onSourceDataForLnkUnlnk:function(e){var t=this._getAllFilteredRootsInSession(),i=[],r=[];for(let e=0;e<t.length;e++)i.push(this._mRootsDataInSession.get(t[e])?this._mRootsDataInSession.get(t[e]).rootAlias:"");for(let e=0;e<t.length;e++)r.push(this._mRootsDataInSession.get(t[e])&&this._mRootsDataInSession.get(t[e]).filterInfos?this._mRootsDataInSession.get(t[e]).filterInfos.fakeFilter:void 0);var n={NGFUXId:this._NGFUXId,BIData:Object.fromEntries(this._mRootsDataInSession.entries()),tags:this._tagData,volumeUsed:this.optionsToKeep.volumeFilterAvailable,configUsed:this._configUsed,attributeUsed:this.optionsToKeep.attributeFilterAvailable,contextUsed:this.optionsToKeep.selectionFilterAvailable,queryFormat:this._queryFormat,expandIntent:this._expandIntent,rootID:t,rootAlias:i,empty:r};u.publish("NGF_lnkUnlnk_srcDataResponse/"+e,JSON.stringify(n))},_onSourceFilteredRootsCB:function(e){var t=[];if(this._shareFilterSpec&&this.optionsToKeep.widgetId===e.widgetId){for(var i=0;i<e.rootIds.length;i++){var r=!!this.hasFilter&&this.hasFilter(e.rootIds[i]).hasFilter;t.push({rootId:e.rootIds[i],hasFilter:r})}u.publish("NGF_sh_filteredRootsResponse/"+this._NGFUXId,t)}},_onSourceShareFilterSpecCB:function(t){var i=t.fromSourceCtx.NGFUXId||t.fromSourceCtx.appId;if(this._shareFilterSpec&&this._NGFUXId===i){var r=this.hasFilter(t.fromRootId);if(r&&r.hasFilter){t.filterId=r.filterId;var n=e.merge(t,this._shareSpec[t.fromRootId]);u.publish("NGF_sh_filteredMdlsResponse/"+this._NGFUXId,n)}else console.log("_onSourceShareFilterSpecCB’, filter not applied in widget1 ")}},_keepShareSpec:function(e){if(this._shareFilterSpec){this._shareSpec||(this._shareSpec={});var t=e.filterRootIds?e.filterRootIds[0]:e.rootId;this._shareSpec[t]={},this._shareSpec[t].filterMdl=e.filterMdl,this._shareSpec[t].rootAlias=e.filterRootAlias?e.filterRootAlias[0]:e.rootAlias,this._shareSpec[t].filterTitle=e.filterTitle,this._shareSpec[t].filterId=e.filterId}},setFilterSpecification:function(e){var t=Array.isArray(e.rootID)?this._mRootsDataInSession.get(e.rootID[0]):this._mRootsDataInSession.get(e.rootID),i=t?t.serviceId:this._defaultServiceId,r=this._NGFUXId,n={NGFUXId:r,widgetTenant:this._tenantId,appId:r,widgetId:this.optionsToKeep.widgetId,rootID:e.rootID,rootAlias:e.rootAlias,configUsed:this._configUsed,volumeUsed:this.optionsToKeep.volumeFilterAvailable,contextUsed:this.optionsToKeep.selectionFilterAvailable,attributeUsed:this.optionsToKeep.attributeFilterAvailable,appQueryParam:this.getAppQueryParam(),UXId:e.UXId||a.computeUXId(r,e.rootID),filterToApply:e,securityContext:this._defaultSC||this.optionsToKeep.securityContext,queryFormat:this._queryFormat,expandIntent:this._expandIntent,serviceId:e.serviceId||i,display:e.displayFilter};u.publish("Frame3DXInfra.Update",{type:"Filter",options:n})},setStatus:function(e){this.myTagProxy?this.myTagProxy.setStatus(e):console.log("*****  ERROR : FilterBIComponentProxy.setStatus, tagger Proxy undefined")},setAppQueryParam:function(e){var t=e?JSON.stringify(e):{};sessionStorage.setItem("NGFilter_AppQueryParam_"+this._NGFUXId+"_"+this._widgetId,t)},getAppQueryParam:function(){var e=sessionStorage.getItem("NGFilter_AppQueryParam_"+this._NGFUXId+"_"+this._widgetId);return e&&Object.keys(e).length?JSON.parse(e):void 0},_copyFromAnyFilterToRoots:function(t,i,r){var s=this;i=[...new Set(i)],n.getInfosFromIds(i,!1).then(function(n){var o=n.length,a=[];i.forEach(function(e){for(var t=0;t<o;t++)if(e===n[t].id){a.push({id:n[t].id,alias:n[t].label,revision:n[t].revision,service:s._defaultServiceId});break}});var l=r?e.clone(r):{};l.resetFilter=void 0===l.resetFilter?0:l.resetFilter,l.displayNotif=0,s.setFilterSpecification({rootID:"-",rootAlias:"-",specification:{type:"NGFilter_CopyFromAnyFilterToRoots",data:{filterId:t,rootInfos:a,options:l}},applyFilter:void 0===l.applyFilter?1:l.applyFilter})})},_getAppId:function(){return"undefined"!=typeof widget&&null!==widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):this.optionsToKeep.appId?this.optionsToKeep.appId:"unknown"},cleanUselessDataForApps:function(e){e&&(e.tagsInMdl&&delete e.tagsInMdl,e.filterMdl&&delete e.filterMdl,this._queryFormat&a.EXPAND_SERVICES.progressive||delete e.CVQueryV2,this._queryFormat&a.EXPAND_SERVICES.expand||delete e.CVQuery,this._queryFormat&a.EXPAND_SERVICES.expand3d||delete e.CVQuery3D,!0!==this._lightCB&&"true"!==this._lightCB||delete e.CVQueryV2)},_areRootsCompliantWithSession:function(e,t){t=t||"MultiServiceId",e=Array.isArray(e)?e:[e];var i;switch(t){case"MultiServiceId":var r=this._getRootsInSession();if(r.length){var s=r[0].serviceId,o=n.getRootsInfos(e).filter(e=>s!==e.serviceId);o.length&&(i=function(e,t){var i={};switch(e){case"MultiServiceId":var r=t.servicedeId;i.error=e,i.msg=d.get("MultiServiceIdInSessionNotAvailable"),i.serviceId=r,i.data=t.data;break;default:i.error="RootsNotCompliantWithSession"}return i}(t,{servceId:s,data:o}))}}return i},setHighDepthTagsAvailability:function(e){console.log("FilterBIComponentProxy.setHighDepthTagsAvailability - deprecated")},_cleanTagsFromPublicFilterSpec:function(e){var t=!0,i=!1,r=this.myTagProxy&&this.myTagProxy.getCurrentFilter();if(r&&r.allfilters&&Object.keys(r.allfilters).length){let r;e&&e.specification&&e.specification.filter&&e.specification.filter.filterSpecifications&&(r=e.specification.filter.filterSpecifications),i=function(e){var t,i;if(r){let n=-1;if(r.forEach((e,t)=>{i=e.filterCriteria.findIndex(e=>"tag"===e.criteriaType),n=t}),-1!==i&&(t=r[n].filterCriteria[i]),t)return Object.keys(t.tagsDefinition).forEach(i=>{var r=[];e.allfilters[i]&&t.tagsDefinition[i].forEach(t=>{let n=e.allfilters[i].findIndex(e=>t.object!==e.object);-1!==n&&r.push(e.allfilters[i][n])}),r.length?t.tagsDefinition[i]=r:delete t.tagsDefinition[i]}),!(!t.tagsDefinition||!Object.keys(t.tagsDefinition).length)||(r[n].filterCriteria.splice(i,1),!1)}return!(!t||!t.length)}(this.myTagProxy.getCurrentFilter()),r&&r.forEach(e=>{let i=!1;e.filterCriteria.length&&(i=e.filterCriteria.find(e=>"tag"!==e.criteriaType)),t=!!i})}return{hasNGF:t,hasPublicTag:i}},_setPublicFilterSpecification:function(e){var t=this;e.rootID=e.rootId||e.rootID,delete e.rootId;var i=this._cleanTagsFromPublicFilterSpec(e);if(i.hasPublicTag||i.hasNGF||!e.eventName)e.specification={type:"NGFilter_SetPublicFilterSpec",data:e.specification},e.eventName&&(e.proxyEvent=e.eventName+"/"+t._NGFUXId+"-"+t._widgetId,this._subscribeSetPublicSpec=u.subscribe(e.proxyEvent,function(i){t._subscribeSetPublicSpec&&t._subscribeSetPublicSpec.unsubscribe(e.proxyEvent),delete t._subscribeSetPublicSpec,t.dispatchEvent(e.eventName,i)})),this.setFilterSpecification(e);else{u.publish(e.eventName,{status:1})}},_getPublicFilterSpecificationFromVolatileFilter:function(e){var t=this;e.rootID=e.rootId||e.rootID,delete e.rootId,!(!!this.hasFilter(e.rootID)&&this.hasFilter(e.rootID).hasFilter)&&e.eventName?this.dispatchEvent(e.eventName,{status:0,error:{level:"error",title:d.get("GetPublicFilterSpecification"),message:d.get("NoFilterDefinedOnRoot")}}):(e.specification={type:"NGFilter_GetPublicFilterSpecFromVolatile",data:{}},e.eventName&&(e.proxyEvent=e.eventName+"/"+t._NGFUXId+"-"+t._widgetId,this._subscribeGetPublicSpec=u.subscribe(e.proxyEvent,function(i){t._subscribeGetPublicSpec&&t._subscribeGetPublicSpec.unsubscribe(e.proxyEvent),delete t._subscribeGetPublicSpec,t.dispatchEvent(e.eventName,i)})),e.displayFilter=0,this.setFilterSpecification(e))},_getPublicFilterSpecificationFromFilterId:function(e){var t=this,i=e.eventName||"";a.convertFilterIdSpecToPublicSpec(this._defaultSC,e.filterId).then(e=>{if(i){var r={status:1,publicSpec:e};t.dispatchEvent(i,r)}},function(e){var r="object"==typeof e&&e.getMessage?e.getMessage():e;if(console.log("==> GetPublicFilterFromFilterId /  err = "+r),i){var n={status:0,error:{level:"error",title:d.get("GetPublicFilterSpecification"),message:r}};t.dispatchEvent(i,n)}})},_addURLParam:function(e){a.addURLParam(e)},_onNGFDebug:function(e){var t=this,i=e.type,r=e.data;switch(i){case"NGFilter_Dbg_SetCopyFromAnyFilterOnRoots":if(this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId){var s=r.options&&r.options.eventName?r.options.eventName:"";s&&(this._subscribeFilterOnRoots=u.subscribe(s,function(e){console.log("==> Debug / Callback Of Copy From Any Filter to Roots : "+e),t._subscribeFilterOnRoots.unsubscribe(s),delete t._subscribeFilterOnRoots}.bind(this))),this._copyFromAnyFilterToRoots(r.filterID,r.rootIDs,r.options)}break;case"NGFilter_Dbg_UpdateTenant":this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId&&this.updateTenant(r.tenant);break;case"NGFilter_Dbg_SetDefaultSecurityContext":this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId&&this.setDefaultSecurityContext(r.sc);break;case"NGFilter_Dbg_LinkUnlink":this._queryFormat&a.EXPAND_SERVICES.expand3d&&n.getInfosFromIds(this._getRootsInSession(),!1).then(function(i){var r=[],n=[];i.forEach(function(e){r.push(e.id),n.push(e.label)});var s=e.data;if(s.rootID=r,s.rootAlias=n,e.data.eventName){var o=e.data.eventName+"/"+t._widgetId;e.data.eventName=o,t._dbgLink=u.subscribe(o,function(e){console.log("==> Debug / Callback on "+o+", results ="+e.results),t._dbgLink.unsubscribe(o),delete t._dbgLink}.bind(t))}"NGFilter_Link"===s.specification.type?(t.setFilterSpecification(s),t._saveNGFUXId=t._NGFUXId,t._NGFUXId=s.specification.data.NGFUXId):(t._NGFUXId=t._saveNGFUXId,delete t._saveNGFUXId,t.setFilterSpecification(s))});break;case"NGFilter_Dbg_SetConfigSpecfication":this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId&&this.setFilterSpecification(r);break;case"NGFilter_Dbg_SetPublicFilterSpecfication":this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId&&(r.eventName&&this.addEvent(r.eventName,function(e){console.log("==> Debug / Callback of Set Public Filter Specification,  status = "+e.status+(e.status?"":", err = "+e.error.message)),t.removeEvent(r.eventName)}),this._setPublicFilterSpecification(r));break;case"NGFilter_Dbg_GetPublicFilterSpecFromVolatile":this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId&&(r.eventName&&this.addEvent(r.eventName,function(e){var i=e.status;console.log("==> Debug / Callback of Get Public Filter Specification from Volatile, event = "+r.eventName+",  status = "+e.status),i?console.log("            Public Filter Spec = "+JSON.stringify(e.publicSpec)):console.log("            Error = "+e.error.message),t.removeEvent(r.eventName)}),this._getPublicFilterSpecificationFromVolatileFilter(r));break;case"NGFilter_Dbg_GetPublicFilterSpecFromFilterId":this._NGFUXId===r.NGFUXId&&this._widgetId===r.widgetId&&(r.eventName&&this.addEvent(r.eventName,function(e){var i=e.status;console.log("==> Debug / Callback of Get Public Filter Specification from FilterId, event = "+r.eventName+", status = "+e.status),i?console.log("            Public Filter Spec = "+JSON.stringify(e.publicSpec)):console.log("            Error = "+e.error.message),t.removeEvent(r.eventName)}),this._getPublicFilterSpecificationFromFilterId(r))}}})}),define("DS/ENOFilterBIUX/FilterBIComponentProxy",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","DS/TagNavigatorProxy/TagNavigatorProxy","DS/ENOFilterBIUX_ExSy/ExSy_FBIComponentProxy","DS/ENOFilterBIUX_Fetch/Fetch_FBIComponentProxy","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/ENOFilterBIUX/FBIProxyServices","DS/ENOFilterBIUX/NGFServices","UWA/Promise","DS/PlatformAPI/PlatformAPI","i18n!DS/ENOFilterBIUX/assets/nls/ENOFilterBIUX"],function(e,t,i,r,n,s,o,a,l,c,u,d,h){"use strict";return t.extend(i,{CONFIG_FILTER:"NGFilter_ConfigDefined",init:function(e){return e.ExpandSynthesisON?this._biFilter=new n(e):this._biFilter=new s(e),this._biFilter.addEvent("FilterBIColorizeEvent",this.filterBIColorize.bind(this)),this._biFilter.addEvent("FilterBIUnColorizeEvent",this.filterBIUnColorize.bind(this)),this._biFilter.addEvent("FilterBIFilteringEvent",this.filterBIFilter.bind(this)),this._biFilter.addEvent("fetchFilterBIFilteringEvent",this.fetchFilterBIFilter.bind(this)),this._biFilter.addEvent("fetchFilterBIColorizeEvent",this.fetchFilterBIColorize.bind(this)),this._biFilter.addEvent("ColorizeVolatileEvent",this.filterBIColorizeVolatile.bind(this)),this._biFilter.addEvent("FilterVolatileEvent",this.filterBIFilterVolatile.bind(this)),this._biFilter.addEvent("SelectVolatileEvent",this.filterBISelectVolatile.bind(this)),this._biFilter.addEvent("ApplyNGFilterAbstract",this.NGFApplyNGFilter.bind(this)),this._biFilter.addEvent("NGFilter_VolumeAbstract",this.filterBIFilterVolume.bind(this)),this._biFilter.addEvent("NGFilter_CloseAbstract",this.filterBICloseFilterPanel.bind(this)),this._biFilter.addEvent("SaveNGFilterAbstract",this.NGFSaveNGFilter.bind(this)),this._biFilter.addEvent("FilterBIGroupingEvent",this.filterBIGrouping.bind(this)),this._biFilter.addEvent("FilterBISelectionAbstract",this.filterBISelection.bind(this)),this},cleanProxy:function(){this._biFilter.cleanProxy()},setPathTags:function(e,t){this._biFilter._setDirectTaggerMode(!1),this._biFilter.setPathTags(e,t)},removeRoot:function(e){this._biFilter.removeRoot(e)},removeRoots:function(e){this._biFilter.removeRoots(e)},setVolume:function(e){this._biFilter.setVolumeFilter(e)},setVolumeFilter:function(e){this._biFilter.setVolumeFilter(e)},updateTenant:function(e){this._biFilter.updateTenant(e)},setAppQueryParam:function(e){this._biFilter.setAppQueryParam(e)},odtSetFilters:function(e){this._biFilter.odtSetFilters(e)},odtKeepActiveFilters:function(e){this._biFilter.odtKeepActiveFilters(e)},addFilterChangeListenerThruBI:function(e){this._biFilter.addFilterChangeListenerThruBI(e)},filterBIColorize:function(e){this.dispatchEvent("FilterBIColorize",e)},filterBIColorizeVolatile:function(e){this.dispatchEvent("ColorizeVolatile",e)},filterBIUnColorize:function(e){this.dispatchEvent("FilterBIUnColorize",e)},filterBIFilter:function(e){this.dispatchEvent("FilterBIFilteringEvent",e)},fetchFilterBIFilter:function(e){this.dispatchEvent("fetchFilterBIFilteringEvent",e)},fetchFilterBIColorize:function(e){this.dispatchEvent("fetchFilterBIColorizeEvent",[e])},filterBIGrouping:function(e){this.dispatchEvent("FilterBIGroupingEvent",e)},filterBISelection:function(e){this.dispatchEvent("FilterBISelectionEvent",e)},filterBISelectVolatile:function(e){this.dispatchEvent("SelectVolatile",e)},filterBIFilterVolatile:function(e){this.dispatchEvent("FilterVolatile",e)},NGFApplyNGFilter:function(e){this.dispatchEvent("ApplyNGFilter",e)},filterBIFilterVolume:function(e){this.dispatchEvent("NGFilter_Volume",e)},filterBICloseFilterPanel:function(e){this.dispatchEvent("NGFilter_Close",e)},NGFSaveNGFilter:function(e){this.dispatchEvent("SaveNGFilter",e)},viewChange:function(){},_cleanUnFilteredTree:function(e,t,i){this._biFilter._cleanUnFilteredTree(e,t,i)},_cleanTree:function(e,t,i){this._biFilter._cleanTree(e,t,i)},setPredicates:function(e){this._predicates=e},addSubjects:function(e){null!==this.myTagProxy&&void 0!==this.myTagProxy&&this.myTagProxy.addSubjects(e)},destroy:function(){this._biFilter.destroy()},setTags:function(e,t,i){this._biFilter._setDirectTaggerMode(!0),this._biFilter._setTags(e,t,i)},unsetTags:function(){this._biFilter.unsetTags()},focusOnSubjects:function(e,t){this._biFilter.focusOnSubjects(e,t)},unfocus:function(){this._biFilter.unfocus()},toggleProxyFocus:function(e){this._biFilter.toggleProxyFocus(e)},getCurrentFilter:function(){this._biFilter.getCurrentFilter()},die:function(){this._biFilter.die()},activate:function(){this._biFilter.activate()},deactivate:function(){this._biFilter.deactivate()},setVolatileTags:function(e){this._biFilter.setVolatileTags(e)},checkVolatileTags:function(e){this._biFilter.checkVolatileTags(e)},emptyFilter:function(e){this._biFilter.emptyFilter(e)},setNGFilterOptions:function(e){this._biFilter.setNGFilterOptions(e)},resetNGFilterUI:function(e){this._biFilter.resetNGFilterUI(e)},retrieveFiltersFromIds:function(e){this._biFilter.retrieveFiltersFromIds(e)},retrieveFilters:function(e){this._biFilter.retrieveFilters(e)},setTagsWithExpandSynthesis:function(e,t){t&&console.warn("Parameter appQueryParam in setTagsWithExpandSynthesis has been deprecated since R2022xFD03"),this._biFilter.setTagsWithExpandSynthesis(e,t)},setTagsWithFetchSynthesis:function(e,t,i){this._biFilter._setDirectTaggerMode(!1),this._biFilter.setTagsWithFetchSynthesis(e,t,i)},setSynthesisMode:function(e){this._biFilter.setSynthesisMode(e)},completeCVQueryWithAppSpecs:function(e,t,i){return this._biFilter.completeCVQueryWithAppSpecs(e,t,i)},getSequenceFilterFromAppIntent:function(e){return this._biFilter.getSequenceFilterFromAppIntent(e)},buildSpecFromAppIntent:function(e){return this._biFilter.buildSpecFromAppIntent(e)},getExpandSpec:function(e,t,i){return t&&t.expandIntent&&t.expandIntent.appQueryObj&&console.warn("appQueryObj key in getExpandSpec has been deprecated since R2022xFD04"),this._biFilter.getExpandSpec(e,t,i)},GetFilterSpec:function(e,t){return this._biFilter.GetFilterSpec(e,t)},getFilterSpec:function(e,t){return t&&t.expandIntent&&t.expandIntent.appQueryObj&&console.warn("appQueryObj key in getFilterSpec has been deprecated since R2022xFD04"),this._biFilter.getFilterSpec(e,t)},getExpandBSDSpec:function(e,t,i){return this._biFilter.getExpandBSDSpec(e,t,i)},getGroupingBSDSpec:function(e,t,i){for(var r=0;r<e.length;r++)if(e[0][0]!==e[r][0])return void console.log("**** ERROR * getGroupingSpec, listOfInputPaths not on same root");return this._biFilter.getGroupingBSDSpec(e,t,i)},getGroupingSpec:function(e,t,i){for(var r=0;r<e.length;r++)if(e[0][0]!==e[r][0])return void console.log("**** ERROR * getGroupingSpec, listOfInputPaths not on same root");if(e&&!(e.length>1))return this._biFilter.getGroupingSpec(e,t,i);console.log("*** ERROR * getGroupingSpec, listOfInputPaths >1 ")},setGroupingStatus:function(e){e?(e.action="grouping",this._biFilter.setStatus(e)):console.log("*****  ERROR : FilterBIComponentProxy.setGroupingStatus, no data provided ")},setSelectStatus:function(e){e?(e.action="selection",this._biFilter.setStatus(e)):console.log("*****  ERROR : FilterBIComponentProxy.setSelectStatus, no data provided ")},refreshTagger:function(){return this._biFilter.refreshTagger()},getFilterIdSpec:function(e,t){return this._biFilter.getFilterIdSpec(e,t)},HasFilter:function(e){return this._biFilter.HasFilter(e)},hasFilter:function(e){return this._biFilter.hasFilter(e)},linkWith:function(e){return this._biFilter.linkWith(e)},unlink:function(e){return this._biFilter.unlink(e)},shareFilterSpec:function(e){return this._biFilter.shareFilterSpec(e)},getCtxForSharing:function(){return this._biFilter.getCtxForSharing()},areRootsSharable:function(e,t){return this._biFilter.areRootsSharable(e,t)},RetrievePrdFromFilterId:function(e){return this._biFilter.RetrievePrdFromFilterId(e)},retrieveRootFromFilterId:function(e,t){return this._biFilter.retrieveRootFromFilterId(e,t)},setProxyAsMaster:function(e){this._biFilter.setProxyAsMaster(e)},setFilterSpecification:function(e){var t="Invalid Specification";e&&e.specification&&e.rootID&&e.rootAlias&&(t="Invalid Specification type",-1!==["NGFilter_ConfigDefined","NGFilter_CopyFromAnyFilterToRoots"].indexOf(e.specification.type)&&(t="Invalid Specification data",e.specification.data&&(t="",this._biFilter.setFilterSpecification(e)))),t.length&&console.log("*** ERROR / setFilterSpecification - "+t)},copyFromAnyFilterToRoots:function(e,t,i){this._biFilter._copyFromAnyFilterToRoots(e,t,i)},setDefaultSecurityContext:function(e){this._biFilter.setDefaultSecurityContext(e)},setHighDepthTagsAvailability:function(e){this._biFilter.setHighDepthTagsAvailability(e)},taggerWebInWinEvent:function(e){this._biFilter.taggerWebInWinEvent(e)},setPublicFilterSpecification:function(e){var t=this;e.eventName&&this._biFilter.addEvent(e.eventName,i=>{t._biFilter.removeEvent(e.eventName),t.dispatchEvent(e.eventName,i)}),this._biFilter._setPublicFilterSpecification(e)},getPublicFilterSpecification:function(e){var t=this;e.rootId?(e.eventName&&this._biFilter.addEvent(e.eventName,i=>{t._biFilter.removeEvent(e.eventName),t.dispatchEvent(e.eventName,i)}),this._biFilter._getPublicFilterSpecificationFromVolatileFilter(e)):(console.log("==> getPublicFilterSpecification / Invalid input data, data = "+e),e.eventName&&this.dispatchEvent(e.eventName,{status:0,error:{level:"error",title:h.get("GetPublicFilterSpecification"),message:h.get("GetPublicFilterInvalidData")}}))},getPublicFilterSpecificationFromFilterId:function(e){var t=this;e.filterId?(e.eventName&&this._biFilter.addEvent(e.eventName,i=>{t._biFilter.removeEvent(e.eventName),t.dispatchEvent(e.eventName,i)}),this._biFilter._getPublicFilterSpecificationFromFilterId(e)):(console.log("==> getPublicFilterSpecificationFromId / Invalid input data, data = "+e),e.eventName&&this.dispatchEvent(e.eventName,{status:0,error:{level:"error",title:h.get("GetPublicFilterSpecification"),message:h.get("GetPublicFilterInvalidData")}}))},_addURLParam:function(e){var t="Invalid data";e&&e.services&&(t="Invalid Service",-1!==["progressive"].indexOf(e.services)&&(t="",this._biFilter._addURLParam(e))),t.length&&console.log("*** ERROR / _addURLParam - "+t)}})}),define("DS/ENOFilterBIUX/FilterComponent",["UWA/Core","UWA/Class","DS/WAFData/WAFData","DS/WebappsUtils/WebappsUtils","DS/ENOFilterBIUX/FilterBIComponentProxy"],function(e,t,i,r,n){return t.extend({_tree:[],init:function(e){this._nodesPath=e.nodesPath,this._widgetID=e.widgetID,this._fedSearchURL="https://vdevpril862dsy.ux.dsone.3ds.com/federated/search",this._groupedData={};this._filterBIProxy=this._instanciateProxy(),this._filterBIProxy.addEvent("FilterBIColorize",this.onTaggerColorization.bind(this)),this._filterBIProxy.addEvent("FilterBIUnColorize",this.onTaggerUnColorization.bind(this)),this._filterBIProxy.addEvent("FilterBIFilter",this.onTaggerFilter.bind(this)),this._setPredicates(["ds6w:description"]),this._filterBIProxy.setPathTags(this._nodesPath)},_buildQuery:function(){var e=this._nodesPath.nodes.length;this._currentQuery="";for(var t=0;t<e;t++)this._currentQuery+='physicalid:"'+this._nodesPath.nodes[t]+'"',e!==t+1&&(this._currentQuery+=" OR ")},fetch:function(){i.proxifiedRequest(this._fedSearchURL,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",type:"json",proxy:"passport",data:JSON.stringify({query:this._currentQuery,order_by:"asc",order_field:"update",locale:"en",nresults:40,start:0,tenant:"OnPremise",select_predicate:["ds6w:created"],label:"FBIServices"}),onComplete:this._parse.bind(this),onFailure:function(e){console.log(e)}})},_parse:function(e){var t=e.results,i=(e.facets,this);t.forEach(function(e){for(var t=e.attributes,r=[],n=0;n<t.length;n++)if("internal"!==t[n].format)if(i._groupedData[t[n].name]||(i._groupedData[t[n].name]={}),r=i._getIdPathsForID(t[0].value),i._groupedData[t[n].name][t[n].value])for(var s=0;s<r.length;s++)i._groupedData[t[n].name][t[n].value].push(r[s].id);else{i._groupedData[t[n].name][t[n].value]=[];for(var o=0;o<r.length;o++)i._groupedData[t[n].name][t[n].value].push(r[o].id)}})},_getIdPathsForID:function(e){var t=this;return this._tree.filter(function(i){var r=i.path;return e===t._nodesPath.nodes[r[r.length-1]]})},_instanciateProxy:function(){var e={widgetId:this._widgetID,tenant:"OnPremise",processingMode:"appProcessing",colorize:!0};return new n(e)},_setPredicates:function(e){this._filterBIProxy.setPredicates(e)},onTaggerColorization:function(e){console.log("RCIIIIIIIIIIIIIIIIIIIIII on FilterComponentjs.onTaggerColorization")},onTaggerUnColorization:function(e){console.log("RCIIIIIIIIIIIIIIIIIIIIII on FilterComponentjs.onTaggerUnColorization")},onTaggerFilter:function(e){console.log("RCIIIIIIIIIIIIIIIIIIIIII on FilterComponentjs.onTaggerFilter")},_findLastItems:function(e,t){for(var i,r,n={},s=0;s<t.length;s++)n[i=(r=t[s])[r.length-1]]?n[i].count+=1:n[i]={id:e[i],count:1}}})});