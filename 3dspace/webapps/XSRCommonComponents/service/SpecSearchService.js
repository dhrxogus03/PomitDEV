define("DS/XSRCommonComponents/service/SpecSearchService",["UWA/Core","UWA/Promise","DS/Controls/Abstract","DS/XSRCommonComponents/utils/Constants","DS/XSRCommonComponents/utils/RequestUtil","DS/XSRCommonComponents/utils/IndexServiceProvider","DS/XSRCommonComponents/utils/Notification"],function(e,t,n,s,i,a,r){"use strict";return n.extend({predicates:["PID","name","revision","state","ds6w:realizedChangeAction","ds6w:proposedChangeAction","ds6w:changeRequired","ds6w:changeContext","ds6w:description","ds6w:label","ds6w:created","ds6wg:EnterpriseExtension.V_PartNumber","ds6w:identifier","ds6w:modified","ds6w:type","ds6w:responsible","ds6w:status","ds6wg:revision","ds6w:policy","ds6w:ManufacturerEquivalentItemExtension.ManufacturerName","owner","ds6w:status_value","ds6wg:ManufacturerEquivalentItemExtension.PartSource","ds6wg:ManufacturerEquivalentItemExtension.PartSourceURL","ds6wg:ManufacturerEquivalentItemExtension.ManufacturerPartNumber"],keyMapping:{resourceid:"physicalid","ds6w:modified":"modified","ds6w:status":"CURRENT","ds6w:label":"LABEL","ds6w:identifier":"name",preview_url:"thumbnail","ds6w:type":"type","ds6w:created":"originated","ds6w:description":"DESCRIPTION","ds6wg:revision":"revision","ds6w:policy":"policy","ds6wg:EnterpriseExtension.V_PartNumber":"partNumber","ds6w:what/ds6w:realizedChangeAction":"ds6w:realizedChangeAction","ds6w:what/ds6w:proposedChangeAction":"ds6w:proposedChangeAction","ds6w:what/ds6w:changeRequired":"ds6w:changeRequired","ds6w:what/ds6w:changeContext":"ds6w:changeContext","ds6w:when/ds6w:modified":"modified","ds6w:what/ds6w:status":"CURRENT","ds6w:what/ds6w:type":"type","ds6w:when/ds6w:created":"originated","ds6w:who/ds6w:responsible":"owner"},init:function(e){this.appCore=e.appCore,this.basicModelEvents=e.appCore.basicModelEvents,this.nextStart=0,this.total=null},getKeyMappings:function(){return this.keyMapping},getSpecifications:function(e,n){var r=this;r.selectedPanel=e.currentPanel;var o=i.getloginUser(),c=e.globalSearchQuery?e.globalSearchQuery.trim():"",E=""!==c,T={};return T=E?{key:"query",value:"("+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_TECHNICAL_SPECIFICATION+'" OR '+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_TEST_METHOD_SPECIFICATION+'" OR '+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_VPMREFERENCE+'") AND NOT([ds6w:kind]:"ManufacturerEquivalentItemExtension") AND ('+e.filter+") AND NOT("+s.TEXT_POLICY+'=="'+s.POLICY_PRD_DATA_SPEC+'" OR '+s.TEXT_POLICY+'=="'+s.POLICY_RES_PRD_DATA_SPEC+'") AND owner=='+o.login+' AND (label:"'+c+'"OR description:"'+c+'"OR ds6wg_58_enterpriseextension_46_v_95_partnumber:"'+c+'"OR identifier:"'+c+'")'}:{key:"query",value:"("+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_TECHNICAL_SPECIFICATION+'" OR '+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_TEST_METHOD_SPECIFICATION+'" OR '+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_VPMREFERENCE+'") AND NOT([ds6w:kind]:"ManufacturerEquivalentItemExtension") AND ('+e.filter+") AND NOT("+s.TEXT_POLICY+'=="'+s.POLICY_PRD_DATA_SPEC+'" OR '+s.TEXT_POLICY+'=="'+s.POLICY_RES_PRD_DATA_SPEC+'") AND owner=='+o.login},new t(function(e,t){(new a).searchSpecifications(T,r.predicates,r.nextStart,void 0).then(function(n){r.processRecentsData(n,E).then(function(t){e(t)}).catch(function(){console.log(err),t()})}).catch(function(e){console.log(e),t()})})},getSearchData:function(e,n){var s,i=this;return s={key:"query",value:'(flattenedtaxonomies:"types/'+e+'")'},new t(function(e,t){(new a).searchSpecifications(s,i.predicates,0,n,void 0).then(function(t){let n=i.processSearchResult(t);e(n)}).catch(function(e){console.log(e),t()})})},getRecentSpecsData:function(){var e=this;return new t(function(t,n){var i={key:"select_type",value:[s.TYPE_TECHNICAL_SPECIFICATION,s.TYPE_TEST_METHOD_SPECIFICATION,s.TYPE_VPMREFERENCE]};return(new a).recentSpecifications(i,e.predicates,e.nextStart).then(function(s){s?t.call(e,s):n()})})},processSearchResult:function(e){let t=this.getKeyMappings();var n=[];"string"==typeof e&&(e=JSON.parse(e));var i=e.infos.nresults,a=e.results;this.nextStart=e.infos.next_start,this.total=e.infos.nhits;for(var r=0;r<i;r++){var o=a[r].attributes,c={},E=[];c.isMEI=!1;for(var T=0;T<o.length;T++){var u=o[T],d=u.name;"ds6wg:ManufacturerEquivalentItemExtension.ManufacturerPartNumber"===d&&(c.isMEI=!0),t.hasOwnProperty(d)?(c[t[d]]=u.dispValue||u.value,(u.dispValue||u.value)&&(c[t[d].concat("actualValue")]=u.value)):(c[u.name]=u.dispValue||u.value,"ds6w:what/ds6w:kind"===d&&E.push(u.value),(u.dispValue||u.value)&&(c[u.name.concat("actualValue")]=u.value))}c.kindOfs=E,"Version"!==c.policy&&c.policy!==s.POLICY_PRD_DATA_SPEC&&c.policy!==s.POLICY_RES_PRD_DATA_SPEC&&n.push(c)}return n},_combinewithRecents:function(e,t){for(var n=0;n<t.length;n++){for(var s=t[n],i=s.physicalid,a=!1,r=0;r<e.length;r++){if(e[r].physicalid===i){a=!0;var o=s.CURRENT;this.isNodeStatebelongsToPanel(o,this.selectedPanel)?Object.assign(e[r],s):e.splice(r,1),r=e.length+1}}a||this.isNodeStatebelongsToPanel(s.CURRENT,this.selectedPanel)&&e.push(s)}return e},processRecentsData:function(e,n){var s=this;return new t(function(t,n){s.getRecentSpecsData().then(function(n){var i=s.processSearchResult(n);"string"==typeof e&&(e=JSON.parse(e)),s.nextStart=e.infos.next_start,s.total=e.infos.nhits;var a=s.processSearchResult(e);i&&i.length>0?t(s._combinewithRecents(a,i)):t(a)}).catch(function(e){s.displayErrorNotification(e)})})},isNodeStatebelongsToPanel:function(e,t){var n=e?e.toUpperCase():void 0;if(n)return t===s.WELCOMEPANEL_ID_INWORK?n!=="Released".toUpperCase()&&n!=="Obsolete".toUpperCase():t===s.WELCOMEPANEL_ID_RELEASED?n==="Released".toUpperCase():t===s.WELCOMEPANEL_ID_OBSOLETE?n==="Obsolete".toUpperCase():void 0},displayErrorNotification:function(e){console.log(e),r.displayNotification({eventID:"error",msg:e.message})},allUserData:function(){var e=this,n=i.getloginUser(),r={key:"query",value:"("+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_TECHNICAL_SPECIFICATION+'" OR '+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_TEST_METHOD_SPECIFICATION+'" OR '+s.TEXT_FLAT_TAXONOMY+':"'+s.TEXT_TYPES+"/"+s.TYPE_VPMREFERENCE+'") AND NOT('+s.TEXT_POLICY+'=="'+s.POLICY_PRD_DATA_SPEC+'" OR '+s.TEXT_POLICY+'=="'+s.POLICY_RES_PRD_DATA_SPEC+'") AND '+s.TEXT_OWNER+"=="+n.login};return new t(function(t,n){(new a).searchSpecifications(r,e.predicates,e.nextStart,void 0).then(function(n){"string"==typeof n&&(n=JSON.parse(n));var s=e.processSearchResult(n);t(s)}).catch(function(e){console.log(e),n()})})}})});