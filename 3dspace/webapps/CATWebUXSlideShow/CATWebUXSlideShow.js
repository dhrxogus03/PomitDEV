/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXSlideShow/CATWebUXSlideShowController",["UWA/Core","UWA/Class","DS/CATWebUXComponents/CATWebUXNotification","DS/WebappsUtils/WebappsUtils","DS/VisuEvents/EventsManager","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Utilities/TouchUtils","DS/CATWebUXComponents/DMUCommandsManager","i18n!DS/CATWebUXSlideShow/assets/nls/CATWebUXSlideShow","css!DS/CATWebUXSlideShow/CATWebUXSlideShow.css"],function(e,t,i,n,o,r,l,d,a,s,c,S){"use strict";var u=t.extend({init:function(t){this._parent(t);var u,C,h,v,f=t||{},m=!1,w=this,g=new l,b=f.context,A=b.getViewer(),x={},p={},y={},U={},W={},E="windowed",T=b.getUIFrame(),P=[],X=f.params&&f.params.activateRotation;let k=null,D=!1;function I(e,t){g.publish({event:e,data:t,context:w})}function M(e){e.ctrlKey||"ArrowLeft"!==e.key&&37!==e.keyCode&&"ArrowUp"!==e.key&&38!==e.keyCode&&"PageUp"!==e.key&&33!==e.keyCode?e.ctrlKey||"ArrowRight"!==e.key&&39!==e.keyCode&&"ArrowDown"!==e.key&&40!==e.keyCode&&"PageDown"!==e.key&&34!==e.keyCode?"Escape"===e.key||27===e.keyCode?(E="noViewRequested",w.setActiveState(!1)):"Home"===e.key||36===e.keyCode?I("onFirstSlideCB"):"End"!==e.key&&35!==e.keyCode||I("onLastSlideCB"):I("onNextSlideCB"):I("onPreviousSlideCB")}function H(){C&&(clearTimeout(C),C=0),p.left.setStyles({opacity:null}),p.right.setStyles({opacity:null}),p.exitSlideShow.setStyles({opacity:null}),s.getTouchMode()||(C=setTimeout(function(){p.left.setStyles({opacity:0}),p.right.setStyles({opacity:0}),p.exitSlideShow.setStyles({opacity:0})},2e3))}function B(){A.currentViewpoint.getControl()._changeState(5)}function N(){A.currentViewpoint.getControl()._changeState(-1)}function _(e){if(e&&e.getId){var t=e.getId();if(-1!==P.indexOf(t))return;"CATWebUXSlideShowPreviousHdr"!==t&&"CATWebUXSlideShowNextHdr"!==t&&"CATWebUXSlideShowExitHdr"!==t?w.setActiveState(!1):e.ControllerID=f.id}}this.getID=function(){return f.id},this.setListOfCommandsAllowed=function(e){e&&e.length&&(P=e)},this.setActiveState=function(t){var i=0;if(m!==t)if(m=t)I("onActiveStateModified",{state:m,onBeginSlideShow:function(t){if(t){let t;if(b.getExecutionContext||(t=b.getActionBar(),v=t.options.context),d.empty(),a.empty(),y.left=function(){I("onPreviousSlideCB"),H()},p.left=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowLeftArrowMainDiv"}).inject(T),o.addEvent(p.left,"onPrimaryPointerClick",y.left),x.left=e.createElement("div",{class:"CATWebUXSlideShowMainDiv"}).inject(p.left),x.left.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_PreviousSlideText.png")',backgroundSize:"contain",left:"30px"}),x.left.title=S.previousSlide,y.right=function(){I("onNextSlideCB"),H()},p.right=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowRightArrowMainDiv"}).inject(T),o.addEvent(p.right,"onPrimaryPointerClick",y.right),x.right=e.createElement("div",{class:"CATWebUXSlideShowMainDiv"}).inject(p.right),x.right.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_NextSlideText.png")',backgroundSize:"contain",right:"30px"}),x.right.title=S.nextSlide,p.exitSlideShow=e.createElement("div",{class:"CATWebUXSlideShowDiv",id:"CATWebUXSlideShowExitDiv"}).inject(T),p.exitSlideShow.setStyles({background:'url("'+n.getWebappsAssetUrl("CATWebUXSlideShow","textures/")+'I_ExitSlideShowText.png")',backgroundSize:"contain"}),y.cross=function(){w.setActiveState(!1)},o.addEvent(p.exitSlideShow,"onPrimaryPointerClick",y.cross),p.exitSlideShow.title=S.exitSlideShow,document.addEventListener("keyup",M),o.addEvent(A.canvas,"onPrimaryPointerMoveUnique",H),o.addEvent(A.canvas,"onMouseMove",H),o.addEvent(A.canvas,"onPrimaryPointerClick",H),o.addEvent(A.divCssElement,"onPrimaryPointerMoveUnique",H),o.addEvent(A.divCssElement,"onMouseMove",H),o.addEvent(A.divCssElement,"onPrimaryPointerClick",H),o.addEvent(A.canvas,"onPrimaryPointerDownUnique",B),o.addEvent(A.canvas,"onPrimaryPointerUpUnique",N),H(),b.getExecutionContext)b.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).hideMainComponent();else"displayed"===localStorage.getItem("CATWebUXSlideShowABPreferences")?t.open():t.close();b.getContextualUIManager().register({subscriberId:"CATWebUXSlideShow",workbenchName:"CATWebUXSlideShowWkb",module:"CATWebUXSlideShow",context:v,cmdPrefix:"",fileName:"CATWebUXSlideShowWkb.xml",merge:!0,onContextualMenuReady:function(){return b.getExecutionContext?[{type:"WAfrDefaultHandlerItem",handlerId:"AnnotSlideShowPreviousHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"AnnotSlideShowNextHdr"},{type:"WAfrDefaultHandlerItem",handlerId:"AnnotSlideShowExitHdr"}]:{cmdList:[{name:"CATWebUXSlideShowPreviousStr",line:1,hdr_list:["CATWebUXSlideShowPreviousHdr"]},{name:"CATWebUXSlideShowNextStr",line:1,hdr_list:["CATWebUXSlideShowNextHdr"]},{name:"CATWebUXSlideShowExitStr",line:1,hdr_list:["CATWebUXSlideShowExitHdr"]}]}}}),b.getExecutionContext||(U.onActionBarOpen=t.onActionBarOpen(function(){localStorage.setItem("CATWebUXSlideShowABPreferences","displayed")}),U.onActionBarClose=t.onActionBarClose(function(){localStorage.setItem("CATWebUXSlideShowABPreferences","closed")})),W.cmds=c.onCommandStart(_,v),(E=window&&window.widget?window.widget.getView().type:null)&&"fullscreen"!==E&&window.widget.requestView({type:"fullscreen"}),X||A.get2DMode()||(A.currentViewpoint.control.setMouseRotationActive(!m),A.currentViewpoint.control.setTouchRotationActive(!m)),h={activated:A.picking.activated,trapSelection:A.picking.trapSelection},A.setPicking({activated:!1,trapSelection:!1});let i=c.getCommandCheckHeader("FlyWalkCmd",v);i&&(i.getState()&&(D=!0,i.setState(!1)),k=i.onStateChange(function(){D=!1,w.setActiveState(!1)}))}else m=!1,w.displaySlideInformation({type:"error",message:S.slideShowCannotBeLaunched,notificationType:"BasicNotification"}),I("onSlideShowAborted"),I("onActiveStateModified",{state:m})}});else{if(k){let e=c.getCommandCheckHeader("FlyWalkCmd",v);e&&(b.getExecutionContext||e._modelEvents.unsubscribe(k),D&&e.setState(!0))}D=!1,k=null,C&&(clearTimeout(C),C=0),p.left&&(o.removeEvent(p.left,"onPrimaryPointerClick",y.left),T.removeChild(p.left),p.left.destroy(),p.left=null),p.right&&(o.removeEvent(p.right,"onPrimaryPointerClick",y.right),T.removeChild(p.right),p.right.destroy(),p.right=null),p.exitSlideShow&&(o.removeEvent(p.exitSlideShow,"onPrimaryPointerClick",y.cross),T.removeChild(p.exitSlideShow),p.exitSlideShow.destroy(),p.exitSlideShow=null),document.removeEventListener("keyup",M),o.removeEvent(A.canvas,"onPrimaryPointerMoveUnique",H),o.removeEvent(A.canvas,"onMouseMove",H),o.removeEvent(A.canvas,"onPrimaryPointerClick",H),o.removeEvent(A.divCssElement,"onPrimaryPointerMoveUnique",H),o.removeEvent(A.divCssElement,"onMouseMove",H),o.removeEvent(A.divCssElement,"onPrimaryPointerClick",H),o.removeEvent(A.canvas,"onPrimaryPointerDownUnique",B),o.removeEvent(A.canvas,"onPrimaryPointerUpUnique",N),b.getContextualUIManager().unregister("CATWebUXSlideShow"),W.cmds&&r.unsubscribe(W.cmds),E&&"noViewRequested"!==E&&window.widget.requestView({type:E});var l=Object.keys(U);if(b.getExecutionContext)b.getExecutionContext().getComponent(WAfrStandardComponentKey.UIComponent).showMainComponent();else{var s=b.getActionBar();for(i=0;i<l.length;i++)s.removeCallback(U[l[i]]);s.open()}u&&u.destroy();let e=b.getExecutionContext?void 0:c._commands._cmdContext;if(e){["CATWebUXSlideShowPreviousHdr","CATWebUXSlideShowNextHdr","CATWebUXSlideShowExitHdr"].forEach(function(t){e[t]&&(e[t]._destroy&&e[t]._destroy(),delete e[t])})}E="windowed",C=u=null,x={},p={},y={},U={},W={},X||A.get2DMode()||(A.currentViewpoint.control.setMouseRotationActive(!m),A.currentViewpoint.control.setTouchRotationActive(!m)),h&&A.setPicking(h),h=null,I("onActiveStateModified",{state:m})}},this.getActiveState=function(){return m},this.subscribe=function(e,t){return e&&t?g.subscribe({event:e},t):void 0},this.unsubscribe=function(e){g&&e&&g.unsubscribe(e)},this.displaySlideInformation=function(e){u||(u=new i),u.build({notificationType:e.notificationType||"CustomNotification",body:T,frmWindow:b,duration:2e3,message:e.message?e.message:e.primary,secondary:e.secondary,hidden:e.hidden,icon:e.icon,fontIcon:e.fontIcon})},this.activatePreviousSlide=function(){I("onPreviousSlideCB")},this.activateNextSlide=function(){I("onNextSlideCB")},this.clearController=function(){this.setActiveState(!1),u&&u.destroy(),b=u=g=T=null}}}),C=[];return t.singleton({init:function(){},giveSlideShowController:function(e){var t;if(e&&e.context&&e.id)for(var i=0;i<C.length;i++)e.context.getExecutionContext?C[i].context===e.context&&(t=C[i].controller):C[i].context===e.context&&C[i].id===e.id&&(t=C[i].controller);return t},getSlideShowController:function(e){var t;if(e&&e.context&&e.id){if(t=this.giveSlideShowController(e))return t;var i=new u(e);t=Object.freeze({getID:function(){if(i)return i.getID()},setActiveState:function(e){i&&i.setActiveState(e)},getActiveState:function(){return i?i.getActiveState():null},setListOfCommandsAllowed:function(e){i&&i.setListOfCommandsAllowed(e)},displaySlideInformation:function(e){i&&i.displaySlideInformation(e)},clearController:function(){i&&(i.clearController(),i=null)},activateNextSlide:function(){i&&i.activateNextSlide()},activatePreviousSlide:function(){i&&i.activatePreviousSlide()},subscribe:function(e,t){return i?i.subscribe(e,t):null},unsubscribe:function(e){i&&i.unsubscribe(e)}}),C.push({context:e.context,controller:t,id:e.id})}return t},unreferenceSlideShowController:function(e){if(e&&e.context&&e.id)for(var t=0;t<C.length;t++)if(C[t].context===e.context&&C[t].id===e.id){C[t].controller.clearController(),C.splice(t,1);break}}})}),define("DS/CATWebUXSlideShow/CATWebUXSlideShowCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(e,t){"use strict";let i,n,o="",r=[];var l=e.extend({init:function(e){this._parent(e,{}),i=this;for(var t=0;t<e.arguments.length;t++)"ControllerID"===e.arguments[t].ID&&(o=e.arguments[t].Value);var n=this.onStateChange(function(){i.getState()?l.BeginSlideShow():l.EndSlideShow()}),r=this._destroy;this._destroy=function(){i._modelEvents.unsubscribe(n),r.call(i)}},_destroy:function(){this._parent()}});return l.BeginSlideShow=function(e,d){if(d){let e=Object.keys(d.args),t=Object.values(d.args);e.forEach(e=>{t.forEach(t=>{r.push({ID:e,Value:t})})});for(var a=0;a<r.length;a++)"ControllerID"===r[a].ID&&(o=r[a].Value);d.executionContext&&(n=d.executionContext)}var s=t.giveSlideShowController({context:n?n.getComponent("Viewer").getFrameWindow():i.getFrameWindow(),id:o});if(s){var c=s.subscribe("onActiveStateModified",function(t){setTimeout(function(){t.state||(s.unsubscribe(c),i&&i.setState&&i.setState(!1),l.EndSlideShow(e,d))})}),S=s.subscribe("onSlideShowAborted",function(){setTimeout(function(){s.unsubscribe(S),i&&i.setState&&i.setState(!1),l.EndSlideShow(e,d)})});if(n){let e=n.getComponent(WAfrStandardComponentKey.HandlerComponent);e&&e.setCheckState({id:"CATWebUXSlideShowHdr",state:!0})}s.setActiveState(!0),require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("command","PresentationMode")})}e&&e()},l.EndSlideShow=function(e,l){if(l){if(!r||!r.length){let e=Object.keys(l.args),t=Object.values(l.args);e.forEach(e=>{t.forEach(t=>{r.push({ID:e,Value:t})})})}for(var d=0;d<r.length;d++)"ControllerID"===r[d].ID&&(o=r[d].Value);l.executionContext&&(n=l.executionContext)}if(n){n.getComponent(WAfrStandardComponentKey.HandlerComponent).setCheckState({id:"CATWebUXSlideShowHdr",state:!1})}var a=t.giveSlideShowController({context:n?n.getComponent("Viewer").getFrameWindow():i.getFrameWindow(),id:o});a&&a.setActiveState(!1),e&&e()},l}),define("DS/CATWebUXSlideShow/CATWebUXSlideShowNavigationCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(e,t){"use strict";let i,n;return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0})},beginExecute:function(){i=this.options.ID,n=this.options&&this.options.args?this.options.args.ControllerID:this.ControllerID,i.includes("Next")?i="CATWebUXSlideShowNextHdr":i.includes("Previous")?i="CATWebUXSlideShowPreviousHdr":i.includes("Exit")&&(i="CATWebUXSlideShowExitHdr");var e=t.giveSlideShowController({context:this.getFrameWindow(),id:n});if(e)switch(i){case"CATWebUXSlideShowPreviousHdr":e.activatePreviousSlide();break;case"CATWebUXSlideShowNextHdr":e.activateNextSlide();break;case"CATWebUXSlideShowExitHdr":e.setActiveState(!1)}this.cancel()}})});