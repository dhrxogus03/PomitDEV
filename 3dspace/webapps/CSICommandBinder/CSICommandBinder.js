define("DS/CSICommandBinder/CSICommandBinder",["DS/ExperienceKernel/ExperienceKernel","DS/CSICommandBinder/CSIAsyncType","DS/CSICommandBinder/CSIParameters","DS/CSICommandBinder/CSIErrorReport","DS/CSICommandBinder/CSIArgumentCheck","DS/CSICommandBinder/CSIRecord","DS/CSICommandBinder/CSIHeader"],function(e,t,n,r,o,i,s){"use strict";var a=s.ENodeMessageType,d=s.MessageBuilder,c=s.MessageReader,u=Object.freeze({select:0,functionCall:1,functionSuccess:2,functionError:3,functionProgress:4,commandBegin:5,commandDo:6,commandEnd:7,commandSuccess:8,commandError:9,commandTerminate:10,interrupt:11,event:12}),m=function(){},p=0,l={},_={defaultsOptions:e.defaultsOptions,Parameters:n,poolMap_:{},forwardRecordFunction_:function(){},declareType:function(e){return n.prototype.declareType(e)},getPool:function(e){return void 0===this.poolMap_[e]&&(this.poolMap_[e]=new f(e)),this.poolMap_[e]},createNode:function(e,t){return i.isRecordActivated_&&(t.canDisconnectFromHypervisor=!1),this.getPool(e).createNode(t)}},h=function(e,t,n){var r=e.readString("error");return void 0===r&&(r=JSON.stringify(e.toJSObject())),t+" version "+n+" returned an error: "+r};_.createParameters=function(e,t){var r=new n;if(void 0===e&&void 0===t)return r;if("string"==typeof e&&void 0!==t){var o=n.prototype.serializeMap_[e];if(void 0!==o&&o(r,t))return r.typeName_=e,r}};var f=function(e){this.pool_=e,this.nodeCount_=1};f.prototype.createNode=function(e){(e=e||{}).pool=this.pool_;var t=new v(e);//!< each node has its own index to generate guid for commands
return t.index_=this.nodeCount_++,t};var v=function(t){"boolean"==typeof t.rdf_bypass_getActiveTypes&&(this.rdf_bypass_getActiveTypes_=t.rdf_bypass_getActiveTypes,delete t.rdf_bypass_getActiveTypes),"boolean"==typeof t.replayMode&&(this.replayMode_=t.replayMode,delete t.replayMode),this.monitorIndex_=1,this.monitorCallback_=m,this.monitorCallbackOverrideInterrupt_=function(){};var n=this;t.onBinary=function(e,t){var o=new c(e);if(!o.isValid())return r.warning("CSI Web Client (version "+s.EProtocolVersion.v3+") received an unsupported message"),!1;if(o.getMessageType()===a.emit){var i=o.getTargetName(),d=o.getArguments();return n.monitorCallback_(u.event,void 0,i,void 0,d),l[i].forEach(function(e){e.nodeId.equals(t)&&(e.callback instanceof Function?e.callback(d):e.callback instanceof b&&e.callback.callDomains(d))}),!0}return!1},this.eknode_=new e.Node(t)};function y(e,t){var n=new c(e);if(n.isValid()){var o=n.getMessageType();return o!==a.serverToClientSuccess&&o!==a.serverToClientProgress&&o!==a.serverToClientError?o===a.clientCommandInstanceDeleted?"commandTerminated":void r.warning(t+"received unexpected callback -bad msgType-"):{reader:n,msgType:o}}r.warning(t+"CSI Web Client (version "+s.EProtocolVersion.v3+") received a message with an unsupported version")}function g(e,t){var n,o=e.onAnswer?e.onAnswer:e.onComplete;n=o instanceof Function?o:o instanceof b?function(e){o.callDomains(e)}:function(){};var i=e.onError;i instanceof Function||(i=function(t){r.error(h(t,e.command,e.version))});var s=e.onTerminate instanceof Function?e.onTerminate:function(){},d="command: "+e.command+"_v"+e.version+" ";return function(r){var o=y(r,d);if(void 0===o)return!1;if("string"==typeof o)return t(u.commandTerminate,e.index_,e.command,e.version),s(),!0;var{reader:c,msgType:m}=o,p=c.getArguments();return m===a.serverToClientError?(t(u.commandError,e.index_,e.command,e.version,p),i(p),!0):m===a.serverToClientSuccess?(t(u.commandSuccess,e.index_,e.command,e.version,p),n(p),!0):void 0}}v.prototype.setMonitorCallback=function(t){t?(this.monitorCallback_=function(e,n,r,o,i){t({eventType:e,index:n,name:r,version:o,parameters:i})},this.monitorCallbackOverrideInterrupt_=function(t,n,r,o){o.interrupt=function(){e.Interruption.prototype.interrupt.apply(o,arguments),t.monitorCallback_(u.interrupt,r,n.name,n.version,n.parameters)}}):(this.monitorCallback_=m,this.monitorCallbackOverrideInterrupt_=function(){})},v.prototype.stop=function(){if(void 0!==this.eknode_)return this.eknode_.stop()},v.prototype.isPoolSelectable=function(e,t){if(void 0!==this.eknode_)return this.eknode_.isPoolSelectable(e,t)},v.prototype.createIterativeRequest=function(e){return o.check(e,"createIterativeRequest"),new S(this,e)},v.prototype.createRequest=function(e){return o.check(e,"createRequest"),new R(this,e)},v.prototype.call=function(e,r){if(!o.check(e,"callFunction"))return!1;var i=this.monitorIndex_++,s=new d;s.setMessageType(a.clientFunctionCall),s.setTargetName(e.name),s.setTargetVersion(e.version),s.setGuid(i),s.setDebugMode(e.debug),s.setArguments(e.parameters);var c=e.parameters instanceof n?e.parameters:new n;return!!t.storeFunction({functionRequest:e,functionGuid:i,node:this,messageBuilder:s,parameters:[c],interruption:r})||this.callInternal(e,i,s,r)},v.prototype.callInternal=function(t,r,o,i){this.monitorCallback_(u.functionCall,r,t.name,t.version,t.parameters);var s=function(e,t,r){var o=e.onSuccess instanceof Function?e.onSuccess:function(){},i=e.onError instanceof Function?e.onError:function(t){throw new Error(h(t,e.name,e.version))},s=e.onProgress instanceof Function?e.onProgress:function(){},d=!1;return{onBinary:function(n){var c=y(n,"function: "+e.name+"_v"+e.version+" ");if(void 0===c)return!1;var{reader:m,msgType:p}=c,l=m.getArguments();return p===a.serverToClientSuccess?(d=!0,t(u.functionSuccess,r,e.name,e.version,l),o(l),!0):p===a.serverToClientError?(d=!0,t(u.functionError,r,e.name,e.version,l),i(l),!0):p===a.serverToClientProgress?(t(u.functionProgress,r,e.name,e.version,l),s(l),!0):void 0},join:function(){if(!d&&"csiGetActiveTypes"!==e.name){var t=new n;t.writeInt32("errorCode",500),t.writeString("error","The connection with the server node has been closed before any success or error answer"),t.declareType("CSISystemError"),i(t)}}}}(t,this.monitorCallback_,r),d=new e.Multiplexer(this.eknode_,s);return i?(this.monitorCallbackOverrideInterrupt_(this,t,r,i),d.sendBinaryWithInterrupt(t.destinationNodeId,o.createBinary(),i)):d.sendBinary(t.destinationNodeId,o.createBinary()),d.close(),!0},v.prototype.select=function(e,n){if(this.monitorCallback_(u.select,0,e),0!==e.length){var r=void 0;return r=void 0===n?this.eknode_.connect(e).select():this.eknode_.connect(e).select(n),!0!==this.rdf_bypass_getActiveTypes_&&t.getActiveTypes(_,this,r,e),!0===this.replayMode_&&i.setReplayMode(this,r,!0),_.forwardRecordFunction_(this,r,e),r}},v.prototype.subscribe=function(e,t,n){return null==e?r.error("INVALID USE of Node.subscribe(); the target node id is invalid."):"string"!=typeof t||""===t?r.error("INVALID USE of Node.subscribe(); the event name must be a non-null string."):n instanceof b||n instanceof Function?(this.eknode_.subscribe(e,t),l[t]=[{id:++p,nodeId:e,callback:n}],!0):r.error("INVALID USE of Node.subscribe(); the subscribe object must be a function or a response.")},v.prototype.unsubscribe=function(e,t){return null==e?r.error("INVALID USE of Node.unsubscribe(); the target node id is invalid."):"string"!=typeof t||""===t?r.error("INVALID USE of Node.unsubscribe(); the event name must be a non-null string."):(l[t]&&(this.eknode_.unsubscribe(e,t),l[t]=[]),!0)},v.prototype.subscribeToEvent=function(e,t,n){if(null==e)return r.error("INVALID USE of Node.subscribeToEvent(); the target node id is invalid."),-1;if("string"!=typeof t||""===t)return r.error("INVALID USE of Node.subscribeToEvent(); the event name must be a non-null string."),-1;if(!(n instanceof Function))return r.error("INVALID USE of Node.subscribeToEvent(); functionCB must be a Function."),-1;this.eknode_.subscribe(e,t),t in l||(l[t]=[]);var o=++p;return l[t].push({id:o,nodeId:e,callback:n}),o},v.prototype.subscribeToEventWithSubject=function(e,t,n,o){return"string"!=typeof n||""===n?(r.error("INVALID USE of Node.subscribeToEventWithSubject(); the subject name must be a non-null string."),-1):this.subscribeToEvent(e,t+"/"+n,o)},v.prototype.unsubscribeFromEvent=function(e){var t=!1,n=null,r=null;for(var o in l)if(Object.prototype.hasOwnProperty.call(l,o)){var i,s=l[o];for(i=s.length-1;i>=0;--i)if(s[i].id===e){r=o,n=s[i].nodeId,s.splice(i,1),t=!0;break}if(t){var a=!0;for(i=0;i<s.length;++i)if(n.equals(s[i].nodeId)){a=!1;break}return a&&this.eknode_.unsubscribe(n,r),!0}}return!1};var b=function(){this.domainMap_={}};b.prototype.onAnswerDomain=function(e,t){this.domainMap_[e]=t},b.prototype.hasDomain=function(e){return this.domainMap_.hasOwnProperty(e)},b.prototype.getDomainCallback=function(e){if(this.domainMap_.hasOwnProperty(e))return this.domainMap_[e]},b.prototype.getDomains=function(){return Object.keys(this.domainMap_).sort()},b.prototype.callDomains=function(e){var t=e.readStringArray("domainNames"),n=e.readParameters("domains","Parameters");if(void 0!==n&&t instanceof Array&&t.length)for(var r=0;r<t.length;r++){var o=t[r],i=n.readParameters(o,"Parameters");this.domainMap_.hasOwnProperty(o)&&i&&this.domainMap_[o](i)}};var I=function(){this.EKInterruptions_=[]};I.prototype.interrupt=function(){return this.EKInterruptions_.forEach(function(e){e.interrupt()}),this.EKInterruptions_=[],!0},I.prototype.sendBinary=function(t,n,r){var o=new e.Interruption;return this.EKInterruptions_.push(o),t.sendBinaryWithInterrupt(n,r,o)};var C=function(e,t){t.index_=e.monitorIndex_++,this.node_=e,this.commandRequest_=t,this.beginHasBeenCalled_=!1,this.csiInterruption_=new I,void 0===this.commandRequest_.destinationNodeId&&(this.commandRequest_.destinationNodeId=e.select(t.destinationPool)),this.messageBuilder_=new d,this.messageBuilder_.setMessageType(a.clientToServer),this.messageBuilder_.setTargetName(t.command),this.messageBuilder_.setTargetVersion(t.version),this.messageBuilder_.setGuid(t.index_),this.messageBuilder_.setDebugMode(t.debug),this.messagePayload_=new n};(C.prototype={eBegin:0,eSend:1,eEnd:2}).setHeaderParameters=function(e,t){var n=void 0;if(e===C.prototype.eBegin){if(this.beginHasBeenCalled_)return r.error("INVALID USE of IterativeRequest.begin(parameters); has already been called and cannot be called anymore.");n="beginParameters",this.beginHasBeenCalled_=!0}else n=e===C.prototype.eSend?"sendParameters":"endParameters";return null==t||t.isEmpty()?this.messagePayload_.writeUint8(n,1):this.messagePayload_.writeParameters(n,"Parameters",t),!0},C.prototype.clearHeader=function(){this.messagePayload_=new n},C.prototype.interrupt=function(){return this.node_.monitorCallback_(u.interrupt,this.commandRequest_.index_,this.commandRequest_.command,this.commandRequest_.version),this.csiInterruption_.interrupt()},C.prototype.sendEKResult=function(){this.messageBuilder_.setArguments(this.messagePayload_);var t={onBinary:g(this.commandRequest_,this.node_.monitorCallback_)},n=new e.Multiplexer(this.node_.eknode_,t);return n.sendBinary(this.commandRequest_.destinationNodeId,this.messageBuilder_.createBinary()),n.close(),this.clearHeader(),!0},C.prototype.sendEKResultWithInterruption=function(){this.messageBuilder_.setArguments(this.messagePayload_);var t={onBinary:g(this.commandRequest_,this.node_.monitorCallback_)},n=new e.Interruption;this.csiInterruption_.EKInterruptions_.push(n);var r=new e.Multiplexer(this.node_.eknode_,t);return r.sendBinaryWithInterrupt(this.commandRequest_.destinationNodeId,this.messageBuilder_.createBinary(),n),r.close(),this.clearHeader(),!0},C.prototype.sendMsgOnDisconnection=function(){this.messageBuilder_.setArguments(this.messagePayload_);var e=this.node_.eknode_.sendBinaryOnDisconnection(this.commandRequest_.destinationNodeId,this.messageBuilder_.createBinary());return this.clearHeader(),e};var R=function(e,t){this.impl_=new C(e,t),this.command_=t.command};R.prototype.interrupt=function(){return this.impl_.interrupt()},R.prototype.send=function(e,n,o){if(3!==arguments.length&&0!==arguments.length)return r.error("INVALID USE of Request.send(beginParameters, doParameters, endParameters); requires 3 arguments (null or undefined accepted as empty parameters).");if(this.used_)return r.error("INVALID USE of Request.send(beginParameters, doParameters, endParameters); has already been called and cannot be called anymore on this one shot request.");if(t.storeFunction({commandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e,n,o]}))return!0;this.used_=!0,this.impl_.setHeaderParameters(C.prototype.eBegin,e),this.impl_.setHeaderParameters(C.prototype.eSend,n),this.impl_.setHeaderParameters(C.prototype.eEnd,o);var i=this.impl_.node_.monitorCallback_,s=this.impl_.commandRequest_.index_,a=this.impl_.commandRequest_.command,d=this.impl_.commandRequest_.version;return i(u.commandBegin,s,a,d,e),i(u.commandDo,s,a,d,n),i(u.commandEnd,s,a,d,o),this.impl_.sendEKResultWithInterruption()},R.prototype.sendOnDisconnection=function(e,t,n){return this.impl_.setHeaderParameters(C.prototype.eBegin,e),this.impl_.setHeaderParameters(C.prototype.eSend,t),this.impl_.setHeaderParameters(C.prototype.eEnd,n),this.impl_.sendMsgOnDisconnection(),!0};var S=function(e,t){this.impl_=new C(e,t)};return S.prototype.interrupt=function(){return this.impl_.interrupt()},S.prototype.begin=function(e){return!!t.storeFunction({iterativeCommandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e],iterative:0})||!!this.impl_.setHeaderParameters(C.prototype.eBegin,e)&&(this.impl_.node_.monitorCallback_(u.commandBegin,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResult())},S.prototype.send=function(e){return!!t.storeFunction({iterativeCommandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e],iterative:1})||(this.impl_.setHeaderParameters(C.prototype.eSend,e),this.impl_.node_.monitorCallback_(u.commandDo,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResultWithInterruption())},S.prototype.end=function(e){return!!t.storeFunction({iterativeCommandRequest:this,userCommandRequest:this.impl_.commandRequest_,node:this.impl_.node_,parameters:[e],iterative:2})||(this.impl_.setHeaderParameters(C.prototype.eEnd,e),this.impl_.node_.monitorCallback_(u.commandEnd,this.impl_.commandRequest_.index_,this.impl_.commandRequest_.command,this.impl_.commandRequest_.version,e),this.impl_.sendEKResult())},_.defaultResponse_=new b,_.getDefaultResponse=function(){return this.defaultResponse_},_.Response=b,_.Private={Node:v,Request:R,IterativeRequest:S},_.MonitorEventType=u,i.initRecorder(_),_});