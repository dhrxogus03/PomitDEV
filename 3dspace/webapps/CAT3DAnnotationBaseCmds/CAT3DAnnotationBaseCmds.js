/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationShowHideCmd",["DS/CATWebUXComponents/DMUCommand","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,i,o,a,r){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0})},beginExecute:function(){var e=function(e){var t;if(e.getLastElement(!0).getAnnotationClassType){for(var n=e;n;){if((t=n.getLastElement(!0)).getAnnotationClassType&&"tpsAnnotationSet"===t.getAnnotationClassType())return n;n=n.getParentPath()}return null}for(var i=e.getChildrenPathes(),o=0;o<i.length;o++)if((t=i[o].getLastElement(!0)).getAnnotationClassType&&"tpsAnnotationSet"===t.getAnnotationClassType())return i[o]},n=i.get();if(n){this.ctxBarPosition=this.getFrameWindow().getContextualUIManager().getContextualBar().getPosition(),this.ctxBarPosition=this.ctxBarPosition?{x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}:{x:0,y:0};for(var s=o.giveAnnotationModelLoader({context:n}),l=t.get(),d="CAT3DAnnotationShowHdr"===this.options.ID||"CAT3DAnnotationSetShowHdr"===this.options.ID,g=0;g<l.length;g++){var c=l[g].pathElement.clone();if(c.internalPath.length)for(;c.internalPath.length;)c=c.getParentPath();for(;!r.isPLMNode(c.getLastElement(!0))&&!c.getLastElement(!0).getAnnotationClassType;)c=c.getParentPath();var u,h=e(c),A=c.getLastElement(!0);if(A.getAnnotationClassType){A.setVisibility(d);var f=A.getAnnotationClassType();if("tpsView"===f||"tpsCapture"===f){var m=A.getVisibleAnnotations(h,!0);for(u=0;u<m.length;u++)m[u].getLastElement(!0).setVisibility(d)}else"tpsAnnotationSet"===f&&d&&s.setAnnotationSetFavoriteCtxPath(h.getParentPath())}else if(r.is3DLeaf(A)){var C=!1;h&&(C=!0,h.getLastElement(!0).setVisibility(d),d&&s.setAnnotationSetFavoriteCtxPath(h.getParentPath())),!C&&d&&s.loadFTAModel({path:c})}else if(r.isReference(A)){var p=s.getDirectChildrenAnnotSets(c);if(p.length)for(u=0;u<p.length;u++)p[u].annotSetPath.getLastElement(!0).setVisibility(d);s.loadFTAModel({path:c});let e,t=[];if(a.getPreference("CATWebUXMePreferences_LoadARMAnnotations")&&t.push(s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV5ARM),a.getPreference("CATWebUXMePreferences_LoadLevelAssemblyAnnotations")&&t.push(s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV6Prd),a.getPreference("CATWebUXMePreferences_LoadFirstAssemblyLevelAnnotations")){t=Object.values(s.CONTEXT_TYPE_ANNOT_SET);let n={assemblyPrefix:a.getPreference("CATWebUXMePreferences_FirstAssemblyLevelAnnotationsPrefix")||"",assemblySuffix:a.getPreference("CATWebUXMePreferences_FirstAssemblyLevelAnnotationsSuffix")||""};e={[s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV5Std]:n,[s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV5ARM]:a.getPreference("CATWebUXMePreferences_LoadARMAnnotations")?void 0:n,[s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV5Prd]:n,[s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV6Std]:n,[s.CONTEXT_TYPE_ANNOT_SET.CATFTASetCtxTypeV6Prd]:a.getPreference("CATWebUXMePreferences_LoadLevelAssemblyAnnotations")?void 0:n}}t.length&&s.loadFTAModel({path:c,ctxTypes:t,conditions:e})}}n.getViewer().render()}this._endExecute()},_endExecute:function(){for(var e=t.get(),i=[],o=0;o<e.length;o++)i.push({pathElement:e[o].pathElement.clone()});t.empty(),n.empty(),t.add(i),n.add(i),this.ctxBarPosition&&(this.getFrameWindow().getExecutionContext?this.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!0,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}):this.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y})),this.ctxBarPosition=null,this.cancel()},destroy:function(){this._endExecute()}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr",["UWA/Class","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationPanels/CAT3DAnnotationStandardsInfoPanel","DS/Windows/Dialog","DS/Controls/Button","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(e,t,n,i,o,a,r,s,l){"use strict";return e.extend({init:function(){this._parent();var e,d,g=this,c=t.get(),u=r.giveAnnotationController({context:c}),h=s.giveAnnotationModelLoader({context:c});this.build=function(t){var r;if(e&&e.cleanPanel(),u&&h){(e=new i).subscribe("onPreferenceModified",function(e){n.setPreference("3DAnnotSemStd",JSON.stringify(e))}),e.subscribe("onShowAllClick",function(){u.onAdditionalInfosRequired({controller:"AnnotStandardMgr"}).getJSONModel(function(t){e.updatePanel(t)})});var s=n.getPreference("3DAnnotSemStd"),A=!0,f=h.getLoadedAnnotationSets();if(1===f.length)A=!1;else{for(var m=0,C=0;C<f.length;C++)f[C].getSemanticStandards&&(m+=1);m<2&&(A=!1)}r=new a({emphasize:"primary",label:l.CloseButton,onClick:function(){e&&e.cleanPanel(),e=null,d.destroy()}}),(d=new o({modalFlag:!0,maximizeButtonFlag:!0,resizableFlag:!0,width:750,height:800,ensureHeightDefinitionOnHierarchy:!0,title:l.InfosPanelTitle,content:e.buildPanel(t,s||JSON.stringify({groupBy:"0",columnSize:{name:"200",code:"200",standard:"200",year:"200",title:"1000"}}),A),immersiveFrame:c.getFrameWindow().getImmersiveFrame(),buttons:{Close:r}})).addEventListener("close",function(){d&&g&&(e&&e.cleanPanel(),e=null,d.destroy())}),d.addEventListener("keydown",function(e){p(e)}),d.addEventListener("keypress",function(e){p(e)})}function p(t){if(d&&g){var n=t.keyCode||t.which;13!==n&&27!==n||(e&&e.cleanPanel(),e=null,d.destroy())}}},this.clearManager=function(){this.destroyPanel(),e=g=c=u=h=null},this.destroyPanel=function(){e&&e.cleanPanel(),d&&d.destroy()}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotShowAttrRelatedInfosCmd",["UWA/Core","DS/CAT3DAnnotationPanels/CAT3DAnnotationPliesAndLayersPanel","DS/CATWebUXComponents/DMUCommandCheckHeader","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesSubTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes"],function(e,t,n,i,o,a,r,s,l,d,g,c){"use strict";var u,h,A,f,m,C,p,v,S,D,b={};let T=l.getPreference("CATWebUXMePreferences_Units");function y(){let e;u&&u.setState&&u.setState(!1),A&&(e=A.getComponent(WAfrStandardComponentKey.HandlerComponent)).setCheckState({id:"AttrRelatedInfos",state:!1})}function P(){var e,t;if(f&&m&&C){if(f.maximizedFlag){var n=window.getComputedStyle(f.getContent());t=Math.round(parseInt(n.width)),e=Math.round(parseInt(n.height))}else if(f.currentDockArea)if(f.currentDockArea===WUXDockAreaEnum.LeftDockArea||f.currentDockArea===WUXDockAreaEnum.RightDockArea){let n=h.getExecutionContext?h.getFrameWindow().getImmersiveFrame().getDockingElement(WUXDockAreaEnum.BottomDockArea).dockingZoneSize+10:0;e=h.getFrameWindow().getImmersiveFrame().getContent().offsetHeight-30-n,t=f.getWidth()}else e=f.getHeight(),t=h.getFrameWindow().getImmersiveFrame().getContent().offsetWidth-30;else e=f.getHeight(),t=f.getWidth();var i=e-10-m.getTextualAndListHeight();C.parentNode&&(i<e/2?(i=e/2,C.parentNode.setStyles({"overflow-y":"scroll"})):C.parentNode.setStyles({overflow:"hidden"})),m.updateViewerSize(t-10,i)}}function w(e){var t=e.split("&#xA;"),n=[];t.forEach(function(e){n=n.concat(e.split("&#10;"))});var i=[];return n.forEach(function(e){i=i.concat(e.split(/(\r\n|\n|\r)/gm))}),n}function E(e,t,n){var i=[],o=c[e.type];o=e.attrType&&g[e.category]&&g[e.category][e.attrType]?g[e.category][e.attrType]:void 0;var a=function(e){var t,n,i,o=[];if(Array.isArray(e))for(t=0;t<e.length;t++)if(i=e[t].Magnitude,(n=e[t].Value)&&e[t].Name){i&&i.toLowerCase&&(i=i.toLowerCase());var a=!1;s.isMagnitudeSupported(i)?(n=s.convertUnitValueToString(e[t].Value,i.charAt(0).toUpperCase()+i.slice(1),T[i.charAt(0).toUpperCase()+i.slice(1)],T[i.charAt(0).toUpperCase()+i.slice(1)+"CalcDisplay"],T.TrailingZeros,{displaySymbol:!1}),a=!0):"boolean"===i?n=("1"===n).toString():"string"===i&&(n=w(n)),o.push({colID:e[t].Name,title:e[t].Name+(a?" ("+l.getUnitDetails(i,T).symbol+")":""),value:n,hidden:e[t].Hidden})}return o}(e.param);return a&&a.length&&(i=i.concat(a)),{uuid:e.uuid,attrType:e.type,attrSubtype:e.attrType,pointedUuids:e.pointedAttrs,idPath:t,isAStructuralItem:e.isRootAttr,name:e.name,type:o,activeState:e.activeState,icon:e.icon,attributes:i,hidden:n}}function L(){var e;if(o.get().some(function(t){return t.pathElement.getLastElement(!0).getAttributeCategory&&"4"===t.pathElement.getLastElement(!0).getAttributeCategory()&&32===t.pathElement.getLastElement(!0).getAttributeType()&&(e=t.pathElement),e}),e&&!e.isEqual(v)&&e.getLastElement(!0).getPointedFeatureIds&&Array.isArray(e.getLastElement(!0).getPointedFeatureIds())){if(v=e.clone(),m&&m.clean(),C)for(;C.firstChild;)C.removeChild(C.firstChild);m=null,S={name:null,entities:null,thickness:null,thicknessUnit:l.getUnitDetails("length",T).symbol,directionUnit:l.getUnitDetails("angle",T).symbol,plies:[]};var n,i,a,r,d=e.getLastElement(!0).getAttributeParam(),g={};for(r=0;r<d.length;r++)if(n=d[r],i=n.Name,a=n.Value,"Core Sample"===i)S.name=a;else if("Entities Number"===i)S.entities=a;else if("Thickness"===i)S.thickness=s.convertUnitValueToString(a,"Length",T.Length,T.LengthCalcDisplay,T.TrailingZeros,{displaySymbol:!1});else if(-1!==i.indexOf("CoreThickness")){var c=i.split("CoreThickness")[1];c&&a&&(g[c]=a)}for(var u=[],A=e.clone();A&&A.getLastElement(!0).getAnnotationClassType&&"tpsRoot"!==A.getLastElement(!0).getAnnotationClassType();)A=A.getParentPath();var p=function(e,t){if(t&&t.getLastElement(!0).getAnnotationUuid&&t.getLastElement(!0).getAnnotationUuid()===e)return t;for(var n,i=t.getChildrenPathes(),o=0;o<i.length;o++)if(n=p(e,i[o]))return n},b=[];for(e.getLastElement(!0).getPointedFeatureIds().forEach(function(e){b=b.concat(e.uuids)}),b.forEach(function(e){var t=p(e,A);if(t){var o=t.getLastElement(!0).getAttributeParam(),l={path:t.clone()};for(r=0;r<o.length;r++)n=o[r],i=n.Name,a=n.Value,"PlyName"===i?l.name=a:"Direction"===i?(l.direction=parseFloat(a)*Math.PI/180,l.directionNls=s.convertUnitValueToString(l.direction,"Angle",T.Angle,T.AngleCalcDisplay,T.TrailingZeros,{displaySymbol:!1})):"Cured Thickness"===i&&(l.curedThickness=parseFloat(a),l.curedThicknessNls=s.convertUnitValueToString(l.curedThickness,"Length",T.Length,T.LengthCalcDisplay,T.TrailingZeros,{displaySymbol:!1}));!l.curedThickness&&g[t.getLastElement(!0).getAnnotationUuid()]&&(l.curedThickness=parseFloat(g[t.getLastElement(!0).getAnnotationUuid()]),l.curedThicknessNls=s.convertUnitValueToString(l.curedThickness,"Length",T.Length,T.LengthCalcDisplay,T.TrailingZeros,{displaySymbol:!1})),S.plies.push(l);var d=[];t.getLastElement(!0).getPointedFeatureIds()&&(t.getLastElement(!0).getPointedFeatureIds().forEach(function(e){d=d.concat(e.uuids)}),d.forEach(function(e){var t=p(e,A);t&&t.getLastElement(!0).getAttributeType&&14===t.getLastElement(!0).getAttributeType()&&u.push({path:t.clone()})}))}}),f.title=S.name,f.icon=v.getLastElement(!0).getAnnotationIcon(),(m=new t).subscribe("onPlyListExpandedOrCollapsed",P),m.subscribe("onPlyAndLayersPanelCreated",P),r=0;r<S.plies.length;r++)S.plies[r].attrModel=E(S.plies[r].path.getLastElement(!0).toJSON(),[r]);for(S.rosettesAttrModel=[],r=0;r<u.length;r++)S.rosettesAttrModel.push(E(u[r].path.getLastElement(!0).toJSON(),[S.plies.length+r],!0));var y=m.build(S);C.appendChild(y),D||(h.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",P),D=1)}}let x=n.extend({init:function(e){this._parent(e,{}),u=this,h=a.get(),T=l.getPreference("CATWebUXMePreferences_Units");var t=this.onStateChange(function(){u.getState()?x.ShowAttrRelatedInfos():x.HideAttrRelatedInfos()}),n=this._destroy;this._destroy=function(){x.clean(!0),u._modelEvents.unsubscribe(t),n.call(u),h=u=null}}});return x.clean=function(e){if(f&&f.clean(),m&&m.clean(),D&&h.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",P),D=null,C=null,e){p&&o.unsubscribe(p),p=null;var t=i.giveAnnotationModelLoader({context:h});t&&b.onAnnotationSetRemoved&&t.unsubscribe(b.onAnnotationSetRemoved),b={}}f=m=C=v=S=null},x.ShowAttrRelatedInfos=function(t,n){!h&&n?h=n.executionContext.getComponent("Viewer"):h||n||(h=a.get()),!A&&n&&(A=n.executionContext),p=o.onAdd(L);var s=i.giveAnnotationModelLoader({context:h});s&&(b.onAnnotationSetRemoved=s.subscribe("onAnnotationSetRemoved",y)),x.clean(),function(){C=new e.Element("div");var t={id:"CAT3DAnnotAttrInfosPanel",className:"CAT3DAnnotAttrInfosPanel",title:d.relatedAttrPanelTitle,immersiveFrame:h.getFrameWindow().getImmersiveFrame(),viewerFrame:h.getFrameWindow().getViewerFrame(),content:C,minWidth:320,width:320,minHeight:300,height:300,closeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea|WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,closePanelCB:y,onPanelResizedCB:P};(f=new r(t)).ensureVisible(),L()}(),t&&"function"==typeof t&&t()},x.HideAttrRelatedInfos=function(e,t){!h&&t?h=t.executionContext.getComponent("Viewer"):h||t||(h=a.get()),!A&&t&&(A=t.executionContext),x.clean(!0),e&&"function"==typeof e&&e()},x}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationLevelSelectorCmd",["DS/CATWebUXComponents/DMUCommand","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,i,o,a){"use strict";var r=function(e){if(!e)return!1;for(var t=e;t&&!t.getLastElement(!0).getAnnotationClassType;)t=t.getParentPath();return t},s=function(e){if(!e)return null;var t,n=void 0!==e.getLastElement(!0).getAnnotationID?e.getLastElement(!0).getAnnotationID():null,i=e.getParentPath().getParentPath();if(!i.getLastElement(!0).getAnnotationClassType||"tpsAnnotationSet"!==i.getLastElement(!0).getAnnotationClassType())return null;var o=null,a=i.getChildrenPathes();for(t=0;t<a.length;t++)if("RootViews"===a[t].getLastElement(!0).getAnnotationType()){o=a[t];break}if(o){var r=o.getChildrenPathes();for(t=0;t<r.length;t++){var s=r[t].getLastElement(!0).getTPSList();if(s&&s.length)for(var l=0;l<s.length;l++)if(s[l]===n)return r[t]}}};return e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0});var l,d=this,g=o.get(),c=!1,u=0,h={x:0,y:0};function A(){d.isRunning()&&(l=void 0,t.destroyView()),n.unsubscribe(u),d.cancel()}this.beginExecute=function(){u=n.onEmpty(function(){!d._isRunning&&!g.getExecutionContext||c||A()});var e=d.getFrameWindow().getContextualUIManager().getContextualBar();h=e&&e.getPosition()?e.getPosition():{x:0,y:0},e&&(h.x=h.x+e.elements.container.getDimensions().width-40*window.devicePixelRatio,h.y=h.y-e.elements.container.getDimensions().height/2-10*window.devicePixelRatio,e.hide()),function(){var e=l;if(!e){var o=n.get();e=l=o.length>0?o[o.length-1]:void 0}if("pathElement"in e&&e.pathElement){var u,f=e.pathElement,m=r(f);u=m?function(){var e=[],t={levels:e};if(!m.getLastElement(!0).getAnnotationClassType||"tpsAnnotationSet"!==m.getLastElement(!0).getAnnotationClassType()){e.push({pathElement:m,name:m.getLastElement(!0).getAnnotationName(),icon:m.getLastElement(!0).getAnnotationIcon()});var n=m.getParentPath();if(n.getLastElement(!0).getAnnotationClassType&&"tpsRoot"===n.getLastElement(!0).getAnnotationClassType()){var i=n.getLastElement(!0).getAnnotationType?n.getLastElement(!0).getAnnotationType():null;if(i&&"RootViews"!==i&&"RootCaptures"!==i&&"RootGeometries"!==i){var o=s(m);o&&e.push({pathElement:o,name:o.getLastElement(!0).getAnnotationName(),icon:o.getLastElement(!0).getAnnotationIcon()})}n=n.getParentPath()}return n.getLastElement(!0).getAnnotationClassType&&"tpsAnnotationSet"===n.getLastElement(!0).getAnnotationClassType()&&e.push({pathElement:n,name:n.getLastElement(!0).getAnnotationName(),icon:n.getLastElement(!0).getAnnotationIcon()}),t}}:function(e){for(var t=[],n=[],i=[],o=f;o;){var r=o.getLastElement(!0);if(a.isPLMNode(r)&&(a.isReference(r)||a.is3DLeaf(r))){var s={pathElement:o,idRef:a.getNodeID(r)};t.push(s),n.push(s.idRef),i.push({node:o.getLastElement(!0),id:s.idRef});var l=o.externalPath.length>1?o.externalPath[o.externalPath.length-2]:null;a.isPLMNode(l)&&a.isInstance(l)&&(n.push(s.idInst=a.getNodeID(l)),i.push({node:l,id:s.idInst}))}o=o.getParentPath()}var d,c,u=["ds6w:label","type_icon_url"],h=function(n){t.forEach(function(e){e.name=n[e.idRef]?n[e.idRef]["ds6w:label"]:"",e.idInst&&n[e.idInst]&&n[e.idInst]["ds6w:label"]&&(e.name+=" ("+n[e.idInst]["ds6w:label"]+")"),e.icon=n[e.idRef]?n[e.idRef].type_icon_url:void 0,d&&c&&(e.canvasColor=c.getColorValueForPredicate(n[e.idRef][d])),delete e.idRef,delete e.idInst}),e(t)};if("3DXML"===a.getLoadedAssetType()){for(var A=[],m=0;m<i.length;m++){var C=a.getNodeInfos(i[m].node);A[i[m].id]={},A[i[m].id]["ds6w:label"]=C.name,A[i[m].id].type_icon_url=C.icon}h(A)}else(c=g.getController()).isColorizeActivated()&&c.isStandalone()&&u.push(d=c.getBIColorMap().predicate),c.getAttributes({ids:n,attributes:u,callbacks:{onComplete:h,onFailure:function(){e(t)}}});return t};var C={positionX:h.x,positionY:h.y,uiFrame:g.getFrameWindow().getUIFrame(),getLevels:u,onHover:function(e){i.empty(),i.add(e)},onLeave:function(e){l&&(i.remove(e),i.add(l))},onSelect:function(e){c=!0,n.empty(),i.empty(),l.pathElement=e.pathElement;var t=l;setTimeout(function(){A(),n.add(t),i.add(t),d.getFrameWindow().getExecutionContext?d.getFrameWindow().getContextualUIManager()._showContextualBar({hideWithDistance:!0}):d.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:!0})},0),c=!1}};t.createView(C)}else A()}()},this.destroy=function(){A(),d.done()}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationResetDisplayHistoryCmd",["DS/CATWebUXComponents/DMUCommand","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/PADUtils/views/PADAlert"],function(e,t,n,i){"use strict";var o="";return require(["i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(e){o=e.DisplayHistorySuccessfulLbl}),e.extend({init:function(e){this._parent(e,{mode:"shared",isAsynchronous:!0})},beginExecute:function(){var e,a,r=t.get(),s=n.giveAnnotationModelLoader({context:r}).getLoadedAnnotationSets();for(e=0;e<s.length;e++){var l=s[e].getRootAnnotationNode("RootCaptures");if(l&&l.children&&l.children.length)for(a=0;a<l.children.length;a++)l.children[a].setDisplayFlag(!1);if((l=s[e].getRootAnnotationNode("RootViews"))&&l.children&&l.children.length)for(a=0;a<l.children.length;a++)l.children[a].setDisplayFlag(!1)}i.displayNotification({eventID:"info",msg:o}),this.end()}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds",[],function(){}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBlankingCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader"],function(e){"use strict";let t,n,i=e.extend({init:function(e){this._parent(e,{}),t=(n=this).getFrameWindow();var o=this.onStateChange(function(){n.getState()?i.SetBlanking():i.ResetBlanking()}),a=this._destroy;this._destroy=function(){n._modelEvents.unsubscribe(o),a.call(n)};var r=localStorage.getItem("CAT3DAnnotationBlankingCmd");this.setState("true"===r)},_destroy:function(){this._parent()}});return i.SetBlanking=function(e,i){!t&&i?t=i.executionContext.getComponent("Viewer"):t||i||(t=n.getFrameWindow()),t.getViewer().displayBlankingPolygon&&t.getViewer().displayBlankingPolygon(!0),t.getViewer().render(),localStorage.setItem("CAT3DAnnotationBlankingCmd","true"),e&&e()},i.ResetBlanking=function(e,i){!t&&i?t=i.executionContext.getComponent("Viewer"):t||i||(t=n.getFrameWindow()),t.getViewer().displayBlankingPolygon&&t.getViewer().displayBlankingPolygon(!1),t.getViewer().render(),localStorage.setItem("CAT3DAnnotationBlankingCmd","false"),e&&e()},i}),define("DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CAT3DAnnotationPanels/CAT3DAnnotationThumbnailPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CATWebUXComponents/DMUCommandsManager","DS/Visualization/SceneGraphUtils","DS/Visualization/Viewpoint","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Selection/HSOManager","DS/Visualization/PathElement","DS/Visualization/IdPath"],function(e,t,n,i,o,a,r,s,l,d,g,c,u,h,A,f){"use strict";var m=t.extend({init:function(t){this._parent(t);var m,C,p,v,S,D,b,T,y,P,w,E,L,x,F,B,I,V=t||{},U=!1,k=!1,M=!1,W=!1,R=null,_=null,O=!0,N=[],X=V.ctxViewer,H=!1,G={},z={},j={},q=0,Y=0,Z=0,J=0,K=0,Q=0,$=150,ee=0,te=this,ne=e.createElement("canvas");let ie;var oe=function(e){if(N&&N.length&&N[e[0]]&&N[e[0]].children&&N[e[0]].children[e[1]]&&N[e[0]].children[e[1]].path){var t=N[e[0]].children[e[1]].path.getChildrenPathes();if(t&&t.length&&t[e[2]]){var n=t[e[2]].getChildrenPathes();if(n&&n.length&&n[e[3]])return n[e[3]]}}},ae=function(e){for(var t=0;t<N.length;t++)for(var n=0;n<N[t].children.length;n++)for(var i=N[t].children[n].path,o=0;o<i.getChildrenPathes().length;o++)for(var a=i.getChildrenPathes()[o],r=0;r<a.getChildrenPathes().length;r++)if(a.getChildrenPathes()[r].isEqual(e))return[t,n,o,r];return null},re=function(e,t){(!t||t&&!e.getLastElement(!0).previewUpdated)&&T.getFTAViewOrCaptureDisplayInfos({path:e,cb:async function(n){var i,o=function(){t&&t()};if(!U||!R)return void o();var a=X.getViewer(),r=[e],s=[],g=X.getRootBagPath().getLastElement(!0);if(X.getViewer().comparisonActive)return;var c,h=!!X.getFrameWindow().getReviewModelVisibleFlag&&X.getFrameWindow().getReviewModelVisibleFlag();h&&X.getFrameWindow().setReviewModelVisibleFlag&&X.getFrameWindow().setReviewModelVisibleFlag(!1);var m=y.getOrderedAnnotationSetPaths();for(i=0;i<m.length;i++)m[i].annotSetPath.isAParentOf(e)&&(c=m[i].annotSetPath,r.push(c)),s.push(m[i].annotSetPath);if(!c)return void o();var C=e.getLastElement(!0),P=a.infinitePlane;a.displayInfinitePlane(!1);var w=a.useShadowPlane;a.setShadowPlane(!1);var B=a.useSSAO;a.setSSAO(!1);var I=a.getShadow();a.setShadow(!1);var V=a.getGrid();a.setGrid(!1);var k=a.getMirror(),M=a.blurryMirror;a.setMirror(!1,!1);var W=c.getChildrenPathes();for(i=0;i<W.length;i++)for(var _=W[i].getChildrenPathes(),O=0;O<_.length;O++)s.push(_[O]);if(e.externalPath[0]!==X.getDecorationBag()){var N=X.getRootBagPath().getChildrenPathes();if(X.getRootBagPath().isAParentOf(e))for(i=0;i<N.length;i++)N[i].isAParentOf(e)?r.push(N[i]):s.push(N[i])}const H=function(e,t){e&&e.length&&l.applyVisibilityToPaths(e,t)};var G=b();const z=[],j=[];if(G){if(G.hiddenBodies&&G.hiddenBodies.length&&G.hiddenBodies[0].getLastElement)for(i=0;i<G.hiddenBodies.length;i++)l.getVisibilityFromPath&&!l.getVisibilityFromPath(G.hiddenBodies[i])&&j.push(G.hiddenBodies[i]);if(G.visibleBodies&&G.visibleBodies.length&&G.visibleBodies[0].getLastElement)for(i=0;i<G.visibleBodies.length;i++)l.getVisibilityFromPath&&l.getVisibilityFromPath(G.visibleBodies[i])&&z.push(G.visibleBodies[i])}H(j,1),H(z,0);const q=[],Y=[];if(n.hiddenBodies&&n.hiddenBodies.length||n.visibleBodies&&n.visibleBodies.length){if(n.visibleBodies&&n.visibleBodies.length)for(i=0;i<n.visibleBodies.length;i++)l.getVisibilityFromPath&&!l.getVisibilityFromPath(n.visibleBodies[i])&&Y.push(n.visibleBodies[i]);if(n.hiddenBodies&&n.hiddenBodies.length)for(i=0;i<n.hiddenBodies.length;i++)(l.getVisibilityFromPath&&l.getVisibilityFromPath(n.hiddenBodies[i])||!l.getVisibilityFromPath)&&q.push(n.hiddenBodies[i])}H(Y,1),H(q,0),F&&F.visibleAssemblyPathElts&&F.visibleAssemblyPathElts.length&&(s=s.concat(F.visibleAssemblyPathElts)),F&&F.hiddenAssemblyPathElts&&F.hiddenAssemblyPathElts.length&&(r=r.concat(F.hiddenAssemblyPathElts)),n.visibleAnnotations&&n.visibleAnnotations.length&&(r=r.concat(n.visibleAnnotations)),n.hiddenAssemblyPathElts&&n.hiddenAssemblyPathElts.length&&(s=s.concat(n.hiddenAssemblyPathElts)),n.visibleAssemblyPathElts&&n.visibleAssemblyPathElts.length&&(r=r.concat(n.visibleAssemblyPathElts));var Z=X.getController().getRootBagId();L||(L=new u(g,Z)),x||(x=new u(X.getDecorationBag())),a.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(L),a.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(x);let J,K,Q=[],$=[],ee=s.filter(e=>e.externalPath[0]===X.getDecorationBag()?e:null),te=s.filter(e=>e.externalPath[0]===X.getDecorationBag()?null:e);ee.length&&(J=x.createOverride({pathes:ee}))&&(J.setVisibility(!1),$.push(J)),te.length&&(J=L.createOverride({pathes:te}))&&(J.setVisibility(!1),Q.push(J)),ee=r.filter(e=>e.externalPath[0]===X.getDecorationBag()?e:null),te=r.filter(e=>e.externalPath[0]===X.getDecorationBag()?null:e),ee.length&&(K=x.createOverride({pathes:ee}))&&(K.setVisibility(!0),$.push(K)),te.length&&(K=L.createOverride({pathes:te}))&&(K.setVisibility(!0),Q.push(K)),n.visibleAssemblyIdPaths&&n.visibleAssemblyIdPaths.length&&((J=L.createIdPathOverride({idPathes:new f([Z]),propagateUntilRepRefs:!0})).setVisibility(!1),Q.push(J),(K=L.createIdPathOverride({idPathes:[new f([Z])]}))&&(K.setVisibility(!0),Q.push(K)),n.visibleAssemblyIdPaths.forEach(function(e){(K=L.createIdPathOverride(e))&&(K.setVisibility(!0),Q.push(K))}));var ie=a.getNodes(),oe=[];for(i=0;i<ie.length;i++)-1!==ie[i].name.indexOf("3D Grid")&&(oe.push(new u(ie[i])),a.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(oe[oe.length-1]),oe[oe.length-1].createOverride({pathes:[new A([ie[i]])]}).setVisibility(!1));var re=S();v(re),n.clippingInfos&&p(n.clippingInfos);let se=X.getFrameWindow().getViewpoint();E||(E=new d({viewer:X.getViewer(),projectionType:se.getProjectionType(),angle:se.getAngle(),near:se.getCamera().near,far:se.getCamera().far})).getControl().setMode(se.getControl()._mode),E.setProjectionType(se.getProjectionType());let le=t?E:se,de={distanceToTarget:le.getTargetDistance(),origin:le.getEyePosition(),projectionType:le.getProjectionType(),sight:le.getSightDirection(),target:le.getTarget(),up:le.getUpDirection()};D(le,T.getDisplayAreaInfos(n.path),0);var ge=await async function(e,t,n){let i=2*n,o=2*t,a=X.getViewer().SCREEN_HEIGHT,r=Math.round(a*(t/n)),s=new ImageData(r,a);X.getViewer().renderToTarget(s,e),ne.height=i,ne.width=o;var l=ne.getContext("2d");if(l){let e=await createImageBitmap(s,0,0,s.width,s.height);l.clearRect(0,0,ne.width,ne.height),l.scale(1,-1),l.drawImage(e,0,0,ne.width,-ne.height),e.close()}return ne.toDataURL("image/jpeg",.3)}(le,200,113);for(C.setPreview(ge),C.previewUpdated=!0,R.setAdditionalInformations([{idPath:ae(e),infos:{preview:ge}}]),D(le,de,0),h&&X.getFrameWindow().setReviewModelVisibleFlag&&X.getFrameWindow().setReviewModelVisibleFlag(!0),L.deleteOverrides(L.getOverrides()),x.deleteOverrides(x.getOverrides()),a.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(L),a.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(x),i=0;i<oe.length;i++)a.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(oe[i]);H(q,1),H(Y,0),H(j,0),H(z,1),P&&a.displayInfinitePlane(P),w&&a.setShadowPlane(w),B&&a.setSSAO(B),I&&a.setShadow(I),V&&a.setGrid(V),(k||M)&&a.setMirror(k,M),n.clippingInfos&&v(n.clippingInfos),re&&p(re),X.getViewer().render(),o()}})};let se;var le=function(e){var t=function(){"requestIdleCallback"in window?window.requestIdleCallback(le):(se&&(clearTimeout(se),se=null),se=setTimeout(le,1e3))};if(U&&R&&m&&!M)if(!X.getFrameWindow().getViewpoint().isMoving()&&(!e||e.timeRemaining()>0)&&Q>=0&&0===h.get().length&&T&&y&&!y.isRunning()&&!T.isRunning()&&!X.getController().isRunning())for(var n=R.getThumbnailsIDPaths(),i=0;i<n.length;i++){var o=oe(n[i]);if(o&&!o.getLastElement(!0).previewUpdated)return void re(o,t)}else setTimeout(t,500)},de=function(){j.onViewOrCaptureDisplayed||(j.onViewOrCaptureDisplayed=T.subscribe("onViewOrCaptureDisplayed",function(e){!e||e&&!e.path||(F=e,R&&R.setAdditionalInformations([{idPath:ae(e.path),infos:{displayFlag:!0}}]))})),j.onFilteringAndClippingRemoved||(j.onFilteringAndClippingRemoved=T.subscribe("onFilteringAndClippingRemoved",function(){F=null})),"requestIdleCallback"in window?window.requestIdleCallback(le):(se&&(clearTimeout(se),se=null),se=setTimeout(le,1e3))},ge=function(){setTimeout(function(){if(U&&R){for(var e=R.getThumbnailsIDPaths(),t=0;t<e.length;t++){var n=oe(e[t]);n&&n.getLastElement(!0).previewUpdated&&(n.getLastElement(!0).previewUpdated=!1)}de()}},100)},ce=function(e){U&&(Q+=!0===e?1:-1,ee&&(clearTimeout(ee),ee=0),_&&(_.setEnableFlag(Q>=0),Q<0&&(ee=setTimeout(function(){U&&_&&_.setEnableFlag(!0),Q=0},2e4))))},ue=function(){for(var e=0,t=0;t<N.length;t++)if(N[t].children)for(var n=0;n<N[t].children.length;n++){var i=N[t].children[n];if(i.isVisible)for(var o=0;o<i.children.length;o++){var a=i.children[o];if(("RootViews"===a.type||"RootCaptures"===a.type)&&a.children.length>0){e++;break}}}return 0===e||1===e?228:248},he=function(){var e=window&&window.widget?window.widget.id:"";if("undefined"!=typeof sessionStorage)if("true"===sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+e))sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+e,"false"),_.setWidth(ue());else{var t=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+e));t&&t!==ue()&&(sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+e,"true"),_.setWidth(t))}},Ae=function(e){var t=oe(e.idPath);t&&(T.displayFTAViewOrCapture({path:t,data:6===t.getLastElement(!0).getAnnotationType()?{label:e.label,icon:e.icon.replace("icons/22/","icons/32/")}:null}),!m||"requestIdleCallback"in window||t.getLastElement(!0).previewUpdated||R.setAdditionalInformations([{idPath:e.idPath,infos:{preview:null}}])),_&&_.isSmallWidth()&&_.collapsePanel()},fe=function(){var e=s.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",X.getCommandContext?X.getCommandContext():null);if(e){e.begin();for(var t=R.getThumbnailsIDPaths(),n=[],i=0;i<t.length;i++)n.push({idPath:t[i],infos:{displayFlag:!1}});n.length&&R.setAdditionalInformations(n)}},me=function(e){if(e){for(var t=[],n=0;n<e.length;n++){var i=oe(e[n].idPath);if(i){for(var o=i.getLastElement(!0),a=e[n].dataTypes,r={idPath:e[n].idPath,infos:{}},s=0;s<a.length;s++)"preview"===a[s]?r.infos.preview=o.getPreview():"displayFlag"===a[s]&&(r.infos.displayFlag=o.getDisplayFlag());t.push(r)}}R.setAdditionalInformations(t)}},Ce=function(){if(!R){var e=s.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",X.getCommandContext?X.getCommandContext():null);R=new i({additionalCmdAvailability:null!=e}),(z={}).onBrowserPanelResized=R.subscribe("onBrowserPanelResized",he),z.onInfoStandardsClicked=R.subscribe("onInfoClick",function(e){P.build(e)}),z.onThumbnailSelected=R.subscribe("onThumbnailSelected",Ae),z.onDeleteDisplayHistory=R.subscribe("onDeleteDisplayHistory",fe),z.onAdditionalInfosRequired=R.subscribe("onAdditionalInfosRequired",me)}R.setDisplayOnlyCapturesFlag(g.getPreference("CATWebUXMePreferences_DisplayOnlyCaptures")),N.backgroundColor="#"+new n.Color(X.getViewer().backgroundColor).getHexString();var t=R.buildPanel(N);if(t){var a,r=ue(),l=window&&window.widget?window.widget.id:"";if("true"===sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+l)&&(a=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+l))),a||(a=void 0!==w?w:r),a=a>=r?a:r,_)_.setMinWidth(r);else{var d={id:"CAT3DAnnotBrowserPanel",className:"CAT3DAnnotBrowserSidePanel",showTitleFlag:!1,icon:"fonticon fonticon-viewBrowser CAT3DAnnotBrowserIcon",immersiveFrame:X.getFrameWindow().getImmersiveFrame(),viewerFrame:X.getFrameWindow().getViewerFrame(),content:t,minWidth:r,width:a,widthStep:212,closeButtonFlag:!1,minHeight:324,height:324,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:"right"===V.defaultDockingSide?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizedCB:function(e){if((e.currentDockArea===WUXDockAreaEnum.RightDockArea||e.currentDockArea===WUXDockAreaEnum.LeftDockArea)&&(w=e.width,e.widthModifiedInteractively)){var t=window&&window.widget?window.widget.id:"";sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+t,"true"),sessionStorage.setItem("CAT3DAnnotBrowserWidth_"+t,e.width)}}};_=new o(d)}_.setEnableFlag(Q>=0)}_&&R&&_.setPanelVisibilityFlag(O&&0!==R.getThumbnailsIDPaths().length),de()},pe=function(){K&&(clearTimeout(K),K=0),I&&(clearInterval(I),I=null),_&&(w=_.getWidth(),_.clean(),_=null),R&&R.cleanPanel()};var ve=function(){if(U&&T.getActiveState())if(M||y.isRunning()){if(I)return;I=setInterval(function(){(M||y.isRunning())&&U&&T.getActiveState()||(clearInterval(I),I=null,ve())},100)}else K&&(clearTimeout(K),K=0),K=setTimeout(function(){U?W||(W=!0,N.splice(0,N.length),C(function(e){if(W=!1,U){N=e;for(var t=0;t<N.length;t++)if(N[t].children)for(var n=0;n<N[t].children.length;n++){var i=N[t].children[n];if(i.isVisible)for(var o=0;o<i.children.length;o++){var a=i.children[o];if(("RootViews"===a.type||"RootCaptures"===a.type)&&a.children.length>0)return Ce(),void(_&&_.setEnableFlag(Q>=0))}}pe()}else pe()})):pe(),$=150,K=0},$)};this.setActiveState=function(e){if(U=e,T&&y&&ie){if(!C){var t=T.onAdditionalInfosRequired({controller:"AnnotBrowser"});C=t.getJSONModel,p=t.addClipping,v=t.removeClipping,S=t.getCurrentClippingInfos,D=t.reframe,b=t.getOverloadedPaths}if(Q=0,U)H||(P=new c,j.onAnnotUIDisabled=T.subscribe("onAnnotUIDisabled",function(){te.setPanelVisibilityFlag(!1)}),j.onAnnotUIEnabled=T.subscribe("onAnnotUIEnabled",function(){te.setPanelVisibilityFlag(!0)}),j.onAnnotControllerActiveStateChanged=T.subscribe("onAnnotControllerActiveStateChanged",function(e){e.state?ve():pe()}),j.onAnnotationsLinkedDataSolved=T.subscribe("onAnnotationsLinkedDataSolved",function(){de()}),G.onAnnotModelLoaderActiveStateChanged=y.subscribe("onAnnotModelLoaderActiveStateChanged",function(e){e.state?ve():pe()}),G.onAnnotationVisibilityModifiedToken=y.subscribe("onAnnotationVisibilityModified",function(e){"tpsAnnotationSet"===e.node.getAnnotationClassType()&&ve()}),G.onAnnotationSetLoadedToken=y.subscribe("onAnnotationSetLoaded",function(){ce(!0),ve(),P&&P.destroyPanel()}),G.onAnnotationSetPartiallyLoaded=y.subscribe("onAnnotationSetPartiallyLoaded",function(){ce(!0),ve()}),G.onAnnotationSetRemovedToken=y.subscribe("onAnnotationSetRemoved",function(){$=0,ve(),P&&P.destroyPanel()}),G.onAnnotationSetBeginLoadToken=y.subscribe("onAnnotationSetBeginLoad",function(){ce(!1)}),G.onAnnotationSetLoadingFailedToken=y.subscribe("onAnnotationSetLoadingFailed",function(){ce(!0)}),G.onNoAnnotationSetLoadedToken=y.subscribe("onNoAnnotationSetLoaded",function(e){e&&e.loadingAlreadyStarted&&ce(!0)}),G.onAnnotationSetLoadingCanceledToken=y.subscribe("onAnnotationSetLoadingCanceled",function(){ce(!0)}),m=g.getPreference("CATWebUXMePreferences_UpdateThumbnails"),de(),Y=g.subscribe("onPreferenceModified",function(e){"CATWebUXMePreferences_DisplayOnlyCaptures"===e.preference&&ve(),"CATWebUXMePreferences_UpdateThumbnails"===e.preference&&(m=e.value,de())}),G.onVisuModificationToken=y.subscribe("onAnnotationParentVisibilityModified",function(){ve()}),q=X.subscribe({event:"onModelUpdated"},ge),Z=X.getViewer().onBackgroundModify(ge),J=X.getViewer().onSwapVisibleSpace?X.getViewer().onSwapVisibleSpace(function(){M=0===X.getViewer().getVisibleSpace(),1===X.getViewer().getVisibleSpace()?ve():pe()}):null,M=0===X.getViewer().getVisibleSpace(),H=!0),ve();else{var n,i;if(R){for(n=Object.keys(z),i=0;i<n.length;i++)R.unsubscribe(z[n[i]]);R=null}if(z={},_&&(_.clean(),_=null),H){for(n=Object.keys(G),i=0;i<n.length;i++)y.unsubscribe(G[n[i]]);for(n=Object.keys(j),i=0;i<n.length;i++)T.unsubscribe(j[n[i]]);Y&&g.unsubscribe(Y),Z&&X.getViewer().unsubscribe(Z),J&&X.getViewer()&&X.getViewer().unsubscribe(J),q&&X.unsubscribe(q),ie&&(g.cleanPrefManager(),ie=!1),pe(),P.clearManager()}K&&(clearTimeout(K),K=0),ee&&(clearTimeout(ee),ee=0),G={},j={},Y=0,Z=0,J=0,q=0,H=!1,P=null,N.length=0}}else B||(B=setInterval(function(){y=r.giveAnnotationModelLoader({context:X}),(T=a.giveAnnotationController({context:X}))&&y&&(clearInterval(B),B=null,ie?te.setActiveState(U):g.initPrefManager({context:X.getFrameWindow()}).then(()=>{ie=!0,te.setActiveState(U)}))},100))},this.getActiveState=function(){return U},this.clearController=function(){this.setActiveState(!1),B&&clearInterval(B),W=!1,_=T=y=null,F=B=null,C=null,X=te=ne=L=x=null},this.setControllerEnableFlag=function(e){let t="true"===localStorage.getItem("WebAfr_v2_activated")?"AnnotationBrowser":"CAT3DAnnotationBrowserHdr";var n=s.getCommandCheckHeader(t,X.getCommandContext());n&&(e?n.enable():n.disable()),k?(te.setActiveState(!0),k=!1):e||U&&(te.setActiveState(!1),k=!0,C=T=y=null)},this.setPanelVisibilityFlag=function(e){O=e,_&&R&&_.setPanelVisibilityFlag(O&&0!==R.getThumbnailsIDPaths().length)},this.getPanelVisibilityFlag=function(){return O}}}),C=[];return t.singleton({init:function(){},give3DAnnotBrowserController:function(e){if(e&&e.context)for(var t=0;t<C.length;t++)if(C[t].context===e.context)return C[t].browserController},get3DAnnotBrowserController:function(e){var t;if(e&&e.context&&!(t=this.give3DAnnotBrowserController(e))){var n=new m({ctxViewer:e.context,defaultDockingSide:e.defaultDockingSide});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return n?n.getActiveState():null},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return n?n.getPanelVisibilityFlag():null},setControllerEnableFlag:function(e){if(n)return n.setControllerEnableFlag(e)},clearController:function(){n&&(n.clearController(),n=null)}}),C.push({context:e.context,browserController:t})}return t},unreference3DAnnotBrowserController:function(e){if(e&&e.context)for(var t=0;t<C.length;t++)if(C[t].context===e.context){C[t].browserController.clearController(),C.splice(t,1);break}}})}),define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBrowserCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(e,t,n){"use strict";var i,o=e.extend({init:function(e){this._parent(e,{});var t=this,n=this.onStateChange(function(){t.getState()?o.OpenAnnotBrowser():o.CloseAnnotBrowser()}),i=this._destroy;this._destroy=function(){t._modelEvents.unsubscribe(n),i.call(t)},this.setState("false"!==localStorage.getItem("CAT3DAnnotationBrowserCmd"),!0)},_destroy:function(){this._parent()}});return o.OpenAnnotBrowser=async function(e,o){!i&&o?i=o.executionContext.getComponent("Viewer"):i||o||(i=t.get());let a=n.get3DAnnotBrowserController({context:i,defaultDockingSide:"defaultDockingSide"});await a.setActiveState(!0),localStorage.setItem("CAT3DAnnotationBrowserCmd","true"),e&&e()},o.CloseAnnotBrowser=async function(e,a){!i&&a?i=a.executionContext.getComponent("Viewer"):i||a||(i=t.get());var r=o.options&&o.options.arguments&&1===o.options.arguments.length&&"defaultDockingSide"===o.options.arguments[0].ID?o.options.arguments[0].Value:null;let s=n.get3DAnnotBrowserController({context:i,defaultDockingSide:r});await s.setActiveState(!1),localStorage.setItem("CAT3DAnnotationBrowserCmd","false"),e&&e()},o});