/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationAttributeController/CAT3DAnnotationAttributeController",["UWA/Class","DS/Selection/CSOManager","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationPanels/CAT3DAnnotationAttrListTable","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXComponents/DMUCommandsManager","DS/PADUtils/views/PADAlert","i18n!DS/CAT3DAnnotationAttributeController/assets/nls/CAT3DAnnotationAttributeController","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesSubTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes"],function(e,t,n,i,r,a,o,l,s,c,u,p,h,d,g,f,A,m,y){"use strict";var b={},v={},D=e.extend({init:function(e){this._parent(e);var D,C,S,T,k,P,U,w=this,I=[],E={},F=[],L=!1,M=!1,x=!0,R=(e||{}).ctxViewer,V=!1,B={},O={},_={},W=0,N={},X=!1,q=150,j=0,H=0,Z=0,J=!1,z=[],G=s.getPreference("3DAnnotAttributesOrderedList"),K=new n,Q=[],Y=!1,$=!1,ee=!1;let te=null;var ne=!0;let ie=!1;var re={6:[{type:4,state:!1},{type:5,state:!0},{type:6,state:!1}]},ae={6:5};function oe(e,t){K.publish({event:e,data:t})}function le(e){var t=e.split("&#xA;"),n=[];t.forEach(function(e){n=n.concat(e.split("&#10;"))});var i=[];return n.forEach(function(e){i=i.concat(e.split(/(\r\n|\n|\r)/gm))}),n}function se(e){var t,n,i,r=[];if(Array.isArray(e))for(t=0;t<e.length;t++){if(i=e[t].Magnitude,!(n=e[t].Value)||!e[t].Name)continue;i&&i.toLowerCase&&(i=i.toLowerCase());var a=!1;let o=s.getPreference("CATWebUXMePreferences_Units");u.isMagnitudeSupported(i)?(n=u.convertUnitValueToString(e[t].Value,i.charAt(0).toUpperCase()+i.slice(1),o[i.charAt(0).toUpperCase()+i.slice(1)],o[i.charAt(0).toUpperCase()+i.slice(1)+"CalcDisplay"],o.TrailingZeros,{displaySymbol:!1}),a=!0):"boolean"===i?n=("1"===n).toString():"string"===i&&(n=le(n)),r.push({colID:e[t].Name,title:e[t].Name+(a?" ("+s.getUnitDetails(i,o).symbol+")":""),value:n,hidden:e[t].Hidden})}else if(e){var o=e.split(/(\r\n|\n|\r)/gm);for(t=0;t<o.length;t++)if(10!==o[t].charCodeAt(0)){var l=o[t].indexOf("=");-1===l&&(l=o[t].indexOf(":")),-1!==l?r.push({colID:o[t].substring(0,l),title:o[t].substring(0,l),value:o[t].substring(l+1,o[t].length)}):r.push({colID:"otherParams",title:f.otherParams,value:o[t]})}}return r}function ce(e,t,n){var i,r,a,o,l,c=y[e.type];if(n){if(i={},e.hyperlink.hyperlinksAndComments?(i.hyperlinksAndComments=e.hyperlink.hyperlinksAndComments,r=!0):e.hyperlink&&e.hyperlink.requirements&&(i.navReq=e.hyperlink.requirements,r=!0),r)return{uuid:e.uuid,idPath:t.slice(),isAStructuralItem:e.isRootAttr,name:e.name,type:e.type,attrType:e.type,activeState:e.activeState,icon:e.icon,attributes:i}}else{var p;if(i=[],47===e.type){r=!0,c=e.attrType&&m[e.category]&&m[e.category][e.attrType]?m[e.category][e.attrType]:void 0;var h=se(e.param);h&&h.length&&(i=i.concat(h)),p=e.pointedAttrs}else if(47!==e.type){if(r=!0,e.noaText&&i.push({colID:"noaText",title:f.noaText,value:e.noaText}),e.noaType&&i.push({colID:"noaType",title:f.noaType,value:e.noaType}),e.text&&i.push({colID:"text",title:f.text,value:le(e.text)}),e.generalTolerance||e.tabulatedLimit&&e.toleranceLimits){let t=s.getPreference("CATWebUXMePreferences_Units");var d=37===e.type||13===e.type?"angle":"length",g=" ("+s.getUnitDetails(d,t).symbol+")",A="length"===d?"mm":"deg",b="length"===d?"m":"rad";if(e.generalTolerance){if(i.push({colID:"generalToleranceName",title:f.generalToleranceName,value:e.generalTolerance.name}),(o=e.generalTolerance.variation.split(" / ")).length){for(var v=0;v<o.length;v++)o[v]=o[v].replace("°","");a=u.convert(o[0],d,A,b),l="",isNaN(a)||(l+=u.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1}),l+=" / ",a=u.convert(o[1],d,A,b),l+=u.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})),i.push({colID:"generalToleranceVariation",title:f.generalToleranceVariation+g,value:l})}}else i.push({colID:"tabulatedLimit",title:f.tabulatedLimit,value:e.tabulatedLimit}),a=u.convert(e.toleranceLimits.min,d,A,b),i.push({colID:"toleranceLimitMin",title:f.toleranceLimitMin+g,value:u.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})}),a=u.convert(e.toleranceLimits.max,d,A,b),i.push({colID:"toleranceLimitMax",title:f.toleranceLimitMax+g,value:u.convertUnitValueToString(a,d.charAt(0).toUpperCase()+d.slice(1),t[d.charAt(0).toUpperCase()+d.slice(1)],t[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})})}e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.hiddenText&&i.push({colID:"hiddenText",title:f.hiddenText,value:le(e.hyperlink.hyperlinksAndComments.hiddenText)}),e.hyperlink&&e.hyperlink.failureModes&&e.hyperlink.failureModes.length&&i.push({colID:"failureModes",title:f.failureModes,value:e.hyperlink.failureModes}),e.hyperlink&&e.hyperlink.requirements&&i.push({colID:"navReq",title:f.navReq,value:e.hyperlink.requirements}),e.hyperlink&&e.hyperlink.relatedDocs&&i.push({colID:"relatedDocs",title:f.relatedDocs,value:e.hyperlink.relatedDocs}),e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.urls&&e.hyperlink.hyperlinksAndComments.urls.length&&i.push({colID:"urls",title:f.urls,value:e.hyperlink.hyperlinksAndComments.urls})}if(r)return{uuid:e.uuid,attrType:e.type,attrSubtype:e.attrType,pointedUuids:p,idPath:t,isAStructuralItem:e.isRootAttr,name:e.name,type:c,activeState:e.activeState,icon:e.icon,attributes:i}}}function ue(e){var t=[];return e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.hiddenText&&t.push({colID:"hiddenText",title:f.hiddenText,value:le(e.hyperlink.hyperlinksAndComments.hiddenText)}),e.hyperlink&&e.hyperlink.failureModes&&e.hyperlink.failureModes.length&&t.push({colID:"failureModes",title:f.failureModes,value:e.hyperlink.failureModes}),e.hyperlink&&e.hyperlink.requirements&&t.push({colID:"navReq",title:f.navReq,value:e.hyperlink.requirements}),e.hyperlink&&e.hyperlink.relatedDocs&&t.push({colID:"relatedDocs",title:f.relatedDocs,value:e.hyperlink.relatedDocs}),e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.urls&&e.hyperlink.hyperlinksAndComments.urls.length&&t.push({colID:"urls",title:f.urls,value:e.hyperlink.hyperlinksAndComments.urls}),t}function pe(e,t,n){var i,r,a,o,l,c,p=[],h=!1,d=y[e.type];if(47===e.type&&e.category===n){h=!0,d=e.attrType&&m[e.category]&&m[e.category][e.attrType]?m[e.category][e.attrType]:void 0;var g=se(e.param);g&&g.length&&(p=p.concat(g)),l=e.pointedAttrs,"6"===n&&1===e.attrType&&g&&g.length&&g.some(function(e){if("VisuMode"===e.colID)return ae[6]=parseFloat(e.value),!0})}else if("3DAnnotations"===n&&47!==e.type){if(h=!0,e.noaText&&p.push({colID:"noaText",title:f.noaText,value:e.noaText}),e.noaType&&p.push({colID:"noaType",title:f.noaType,value:e.noaType}),e.text&&p.push({colID:"text",title:f.text,value:le(e.text)}),e.generalTolerance||e.tabulatedLimit&&e.toleranceLimits){let t=s.getPreference("CATWebUXMePreferences_Units");var A=37===e.type||13===e.type?"angle":"length",b=" ("+s.getUnitDetails(A,t).symbol+")",v="length"===A?"mm":"deg",D="length"===A?"m":"rad";if(e.generalTolerance){if(p.push({colID:"generalToleranceName",title:f.generalToleranceName,value:e.generalTolerance.name}),(a=e.generalTolerance.variation.split(" / ")).length){for(var C=0;C<a.length;C++)a[C]=a[C].replace("°","");r=u.convert(a[0],A,v,D),o="",isNaN(r)||(o+=u.convertUnitValueToString(r,A.charAt(0).toUpperCase()+A.slice(1),t[A.charAt(0).toUpperCase()+A.slice(1)],t[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1}),o+=" / ",r=u.convert(a[1],A,v,D),o+=u.convertUnitValueToString(r,A.charAt(0).toUpperCase()+A.slice(1),t[A.charAt(0).toUpperCase()+A.slice(1)],t[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})),p.push({colID:"generalToleranceVariation",title:f.generalToleranceVariation+b,value:o})}}else p.push({colID:"tabulatedLimit",title:f.tabulatedLimit,value:e.tabulatedLimit}),r=u.convert(e.toleranceLimits.min,A,v,D),p.push({colID:"toleranceLimitMin",title:f.toleranceLimitMin+b,value:u.convertUnitValueToString(r,A.charAt(0).toUpperCase()+A.slice(1),t[A.charAt(0).toUpperCase()+A.slice(1)],t[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})}),r=u.convert(e.toleranceLimits.max,A,v,D),p.push({colID:"toleranceLimitMax",title:f.toleranceLimitMax+b,value:u.convertUnitValueToString(r,A.charAt(0).toUpperCase()+A.slice(1),t[A.charAt(0).toUpperCase()+A.slice(1)],t[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],t.TrailingZeros,{displaySymbol:!1})})}p=p.concat(ue(e))}if(e.children&&e.children.length){var S;c=[];for(var T=0;T<e.children.length;T++)(S=pe(e.children[T],t.concat([T]),n))&&c.push(S)}return h&&(i={idPath:t,pointedUuids:l,attrType:e.type,attrSubtype:e.attrType,uuid:e.uuid,isAStructuralItem:e.isRootAttr,name:e.name,type:d,displayFlag:e.displayFlag,activeState:e.activeState,icon:e.icon,attributes:p,children:c}),i}function he(e,t,n){var i=[];if("3DAnnotations"===n&&e.hyperlink){var r=[];(r=r.concat(ue(e))).length&&i.push({uuid:e.uuid,idPath:t.slice(),isAStructuralItem:e.isRootAttr,name:e.name,type:y[e.type],attrType:e.type,displayFlag:e.displayFlag,activeState:e.activeState,icon:e.icon,attributes:r})}for(var a=0;a<e.children.length;a++){var o=e.children[a];if("RootViews"!==o.type&&"RootCaptures"!==o.type)for(var l=0;l<o.children.length;l++){var s=pe(o.children[l],[t[0],t[1],a,l],n);s&&i.push(s)}}return i}function de(){var e,t,n=Object.keys(E);for(e=0;e<n.length;e++)E[n[e]].splice(0,E[n[e]].length);if(E={},Y){if(E.result=[],I&&I.length)for(e=0;e<I.length;e++){var i=I[e].getLastElement(!0);for(t=i;t&&t.getAnnotationClassType&&"tpsAnnotationSet"!==t.getAnnotationClassType();)t=t.parents[0];if(t.isVisible()){var r=ce(i.toJSON(),[e],i===t);r&&(E.result[0]||E.result.push({elements:[]}),E.result[0].elements.push(r))}}}else if(I&&I.length)for(e=0;e<I.length;e++)for(var a=0;a<I[e].children.length;a++)if((t=I[e].children[a]).isVisible)for(var o=0;o<G.length;o++)if(null===z||z&&-1===z.indexOf(G[o])){var l={elements:he(t,[e,a],G[o]),section:{idPath:[e,a],name:t.referenceLabel+" / "+t.name,icon:t.referenceIcon}};l.elements.length&&(E[G[o]]||(E[G[o]]=[]),E[G[o]].push(l))}}var ge=function(){Z&&(clearTimeout(Z),Z=0),F&&F.length&&(F.forEach(function(e){e.panel.clean();for(var t=Object.keys(e.tokensBrowserPanel),n=0;n<t.length;n++)e.attrUI.unsubscribe(e.tokensBrowserPanel[t[n]]);e.attrUI.destroy(),e.attrUI=null}),F.length=0)},fe=function(){!L||J?ge():(Z&&(clearTimeout(Z),Z=0),Z=setTimeout(function(){L&&w&&(w._internalRefresh(),q=150,Z=0)},q))},Ae=function(e){L&&(j+=!0===e?1:-1,H&&(clearTimeout(H),H=0),F.length&&(F.forEach(function(e){e.panel.setEnableFlag(j>=0)}),j<0&&(H=setTimeout(function(){L&&F&&F.forEach(function(e){e.panel.setEnableFlag(!0)}),j=0},2e4))))},me=function(e){var t;if(I&&I.length){var n,i,r;t=[];for(var a=0;a<I.length;a++){if(Y){if(e.isEqual(I[a])){t=[a];break}}else if(I[a].path.isAParentOf(e)){t.push(a);for(var o=0;o<I[a].children.length;o++)if((r=I[a].children[o].path).isAParentOf(e))for(t.push(o);!r.isEqual(e);){i=!1,n=r.getChildrenPathes();for(var l=0;l<n.length;l++)if(n[l].isAParentOf(e)||n[l].isEqual(e)){t.push(l),r=n[l],i=!0;break}if(!i)return}}}}return t},ye=function(e,t,n){e&&e.length&&e.forEach(function(e){var i=e.pathElement,r={path:i.clone(),attributes:[]},a=[],o=i.getLastElement(!0);if(o&&o.getAnnotationClassType){var l=me(i);l&&a.push({idPath:l,infos:t})}else{var c=C.getPontingAnnotations(i,!0);if(c&&c.length)for(var u=0;u<c.length;u++)"tpsAttribute"===c[u].getLastElement(!0).getAnnotationClassType()&&(a.push({idPath:me(c[u]),infos:t}),r.attributes.push(c[u].clone()))}a.length&&F.forEach(function(e){(n||!e.attrUI.getDiscipline()||"display"!==s.getPreference("CAT3DAnnotAttrRowSelection_"+e.attrUI.getDiscipline()))&&e.attrUI.setAdditionalInformations(a)})})},be=function(e){X||J||ye(e,{activeState:!0,displayFlag:!0})},ve=function(e){X||J||ye(e,{activeState:!1})},De=function(){X||J||F&&F.length&&F.forEach(function(e){if(!e.attrUI.getDiscipline()||e.attrUI.getDiscipline()&&"display"!==s.getPreference("CAT3DAnnotAttrRowSelection_"+e.attrUI.getDiscipline())){var t=e.attrUI.getDisplayedIDPaths(!0);t&&t.length&&e.attrUI.setAdditionalInformations(t.map(function(e){return{idPath:e,infos:{activeState:!1}}}))}})},Ce=function(e){if(e&&I&&I.length&&I[e[0]]){if(Y)return I[e[0]];if(I[e[0]].children&&I[e[0]].children[e[1]]){if(2===e.length)return I[e[0]].children[e[1]].path;if(I[e[0]].children[e[1]].path){for(var t,n=I[e[0]].children[e[1]].path.getChildrenPathes(),i=2;i<e.length;i++)n&&n[e[i]]&&(n=(t=n[e[i]]).getChildrenPathes());return t}}}};function Se(e){e&&oe("onCommentSelected",{path:Ce(e.idPath)})}var Te,ke=function(e){if(!X){var n;if(X=!0,Y)t.empty();else{var i=b[e.discipline];i&&i.length&&(t.remove(i),i.length=0),b[e.discipline]=[]}var r=[],a=[],o=e.currentSelection;for(n=0;n<o.length;n++){var l=Ce(o[n].idPath);l&&(o[n].activeState?(Y||b[e.discipline].push({pathElement:l}),r.push({pathElement:l,filterOpts:re})):o[n].activeState||a.push({pathElement:l}),l.getLastElement(!0).setDisplayFlag(!!o[n].activeState||l.getLastElement(!0).getDisplayFlag()))}r.length&&t.add(r),a.length&&t.add(a),X=!1}};function Pe(){Te&&clearTimeout(Te),Te=setTimeout(function(){if(Te=null,C)if(L){var e=[];Object.keys(v).forEach(function(t){e=e.concat(v[t]),Y||ye(v[t],{activeState:!0,displayFlag:!0},!0)}),C.isolatePaths({paths:e.map(function(e){return e.pathElement}),opts:re})}else C.isolatePaths({paths:[],opts:re})})}var Ue=function(e){if(!X){X=!0;var t=e.currentSelection;v[e.discipline]=[];for(var n=0;n<t.length;n++){var i=Ce(t[n].idPath);i&&t[n].activeState&&(v[e.discipline].push({pathElement:i}),i.getLastElement(!0).setDisplayFlag(!0))}Pe(),X=!1}},we=function(e){var t=Ce(e.idPath);t&&t.getLastElement(!0).getDisplayFlag&&t.getLastElement(!0).getDisplayFlag()!==e.flag&&t.getLastElement(!0).setDisplayFlag(e.flag)};function Ie(e){e.state,s.setPreference("CAT3DAnnotColumnSort_"+e.discipline,e.state)}function Ee(e){var n=[];"display"===e.state?(s.setPreference("CAT3DAnnotAttrRowSelection_"+e.discipline,e.state),n=b[e.discipline]?b[e.discipline].slice():null,v[e.discipline]=b[e.discipline]?b[e.discipline].slice():[],b[e.discipline]=[],n&&n.length&&(X=!0,t.remove(n),X=!1),Pe()):(n=v[e.discipline]?v[e.discipline].slice():null,b[e.discipline]=v[e.discipline]?v[e.discipline].slice():[],v[e.discipline]=[],Pe(),n&&n.length&&(n.forEach(function(e){e.filterOpts=re}),X=!0,t.add(n),X=!1),s.setPreference("CAT3DAnnotAttrRowSelection_"+e.discipline,e.state))}function Fe(e){b[e.discipline]&&b[e.discipline].length?(X=!0,t.remove(b[e.discipline].slice()),X=!1,b[e.discipline].length=0):v[e.discipline]&&(v[e.discipline]=[],Pe()),s.setPreference("CAT3DAnnotAttrAttrDisplay_"+(Y?"result":e.discipline),e.state)}function Le(e){if(re[e.discipline]=e.state,"display"===s.getPreference("CAT3DAnnotAttrRowSelection_"+e.discipline))Pe();else{var n=b[e.discipline]?b[e.discipline].slice():null;n&&n.length&&(X=!0,n.forEach(function(e){e.filterOpts=re}),t.remove(n),t.add(n),X=!1)}}function Me(e){var n,i;for(i=0;i<F.length;i++)if(F[i].discipline===e.discipline){n=F[i];break}var r=[];if(t.get().forEach(function(t){var n=t.pathElement.getLastElement(!0);n.getAnnotationClassType&&("3DAnnotations"===e.discipline&&47!==n.getAnnotationType()||n.getAttributeCategory&&e.discipline===n.getAttributeCategory())&&r.push(n)}),n){var a=function(e){if(e.setDisplayFlag(!1),e.children&&e.children.length&&e.children[0].setDisplayFlag)for(var t=0;t<e.children.length;t++)a(e.children[t])},o=S.getLoadedAnnotationSets();for(i=0;i<o.length;i++)for(var l=o[i].children,s=0;s<l.length;s++){var c=l[s];if("RootCaptures"!==c.getAnnotationType()&&"RootViews"!==c.getAnnotationType())for(var u,p=l[s].children,h=0;h<p.length;h++)u=p[h],("3DAnnotations"===e.discipline&&47!==u.getAnnotationType()||u.getAttributeCategory&&e.discipline===u.getAttributeCategory())&&-1===r.indexOf(u)&&a(u)}g.displayNotification({eventID:"info",msg:f.DisplayHistorySuccessfulLbl})}}function xe(e){var t,n;if(Y)t=F[0];else for(n=0;n<F.length;n++)if(F[n].discipline===e.discipline){t=F[n];break}if(t){var i,r=t.attrUI.getDisplayedIDPaths(!0);if(r.length){var a,o=[];for(n=0;n<r.length;n++)(a=Ce(r[n]))&&(o.push(a),(i=C.getAllRelatedPaths(a))&&i.length&&(o=o.concat(i)));o.length&&R.getViewer().currentViewpoint.reframeOn(400,o,{reframeSpace:"visibleSpace",withInternalSceneGraph:!0})}}F[0].panel&&F[0].panel.isSmallWidth()&&F[0].panel.collapsePanel()}function Re(e){if(ne&&e&&e.discipline&&F){var t=R.getRootBagPath().getChildrenPathes().map(function(e){return{node:e.getLastElement(!0),id:p.getNodeID(e.getLastElement(!0))}});if(t&&t.length){var n=function(n){for(var i="",r=0;r<t.length;r++)r>0&&(i+="_"),i+=n[t[r].id]["ds6w:label"];F.some(function(t){if(t.discipline===e.discipline){var n=t.attrUI.exportAsCSV(e);if(n){var r=new Blob([n],{type:"text/csv"}),a=window.URL.createObjectURL(r),o=document.createElement("a");o.style.display="none",o.download=i+"_"+A[t.discipline]+".csv",o.href=a,document.body.appendChild(o),window.__karma__&&window.__karma__.config?oe("onAttributeTableExported",{fileName:i+"_"+A[t.discipline]+".csv",content:n}):o.click(),window.URL.revokeObjectURL(a),document.body.removeChild(o),p._sendUsageProbe("command",e.onlySelectedRows?"ExportSelectedTechnologicalAttrToCSV":"ExportVisibleTechnologicalAttrToCSV")}return!0}})};if("3DXML"===p.getLoadedAssetType()){for(var i=0;i<t.length;i++){var r=p.getNodeInfos(t[i].node);(void 0)[t[i].id]={},(void 0)[t[i].id]["ds6w:label"]=r.name}n(void 0)}else R.getController().getAttributes({ids:t.map(function(e){return e.id}),attributes:["ds6w:label"],callbacks:{onComplete:n,onFailure:n}})}}}function Ve(e){if(L&&F&&F.length){var t=[],n={};e&&e.length&&e.forEach(function(e){if(e&&e.getLastElement(!0).getAttributeCategory){var i=e.getLastElement(!0).getAttributeCategory();-1===t.indexOf(i)&&t.push(i),n[i]||(n[i]=[]),n[i].push({pathElement:e})}}),t.forEach(function(e){F.some(function(t){if(t.attrUI.getDiscipline()===e)return"display"===s.getPreference("CAT3DAnnotAttrRowSelection_"+e)?w.setDisplayedElementPaths(n[e]):w.setSelectedElementPaths(n[e]),!0})})}Q=e}function Be(e){e.colIdx&&F[0].panel&&F[0].panel.isSmallWidth()&&F[0].panel.collapsePanel()}let Oe=["dragenter","dragover","drop"];function _e(e){e.stopPropagation()}function We(){const e=R.getViewer().canvas,t=R.getFrameWindow().getImmersiveFrame();return Oe.forEach(n=>{e.addEventListener(n,_e),t.addEventListener(n,_e)}),!0}function Ne(){const e=R.getViewer().canvas,t=R.getFrameWindow().getImmersiveFrame();return Oe.forEach(n=>{e.removeEventListener(n,_e),t.addEventListener(n,_e)}),!0}var Xe=function(e,t){for(var n,a=0;a<F.length;a++)if(F[a].discipline===e){n=F[a];break}n||(n={discipline:e},F.push(n)),n&&n.attrUI&&n.attrUI.cleanPanel(),n.attrUI=new i,n.tokensBrowserPanel={},n.tokensBrowserPanel.onAttrActiveStateModified=n.attrUI.subscribe("onAttrActiveStateModified",ke),n.tokensBrowserPanel.onAttrDisplayStateModifiedCB=n.attrUI.subscribe("onAttrDisplayStateModified",Ue),n.tokensBrowserPanel.onAttrDisplayFlagModified=n.attrUI.subscribe("onAttrDisplayFlagModified",we),n.tokensBrowserPanel.onDeleteDisplayHistory=n.attrUI.subscribe("onDeleteDisplayHistory",Me),n.tokensBrowserPanel.onSwitchEnableColumnSort=n.attrUI.subscribe("onSwitchEnableColumnSort",Ie),n.tokensBrowserPanel.onSwitchRowSelectionMode=n.attrUI.subscribe("onSwitchRowSelectionMode",Ee),n.tokensBrowserPanel.onSwitchAttributeDisplayMode=n.attrUI.subscribe("onSwitchAttributeDisplayMode",Fe),n.tokensBrowserPanel.onSwitchMultiRepDisplayMode=n.attrUI.subscribe("onSwitchMultiRepDisplayMode",Le),n.tokensBrowserPanel.onReframeOn=n.attrUI.subscribe("onReframeOn",xe),n.tokensBrowserPanel.onExportToCSVRequired=n.attrUI.subscribe("onExportToCSVRequired",Re),n.tokensBrowserPanel.onAttributeClicked=n.attrUI.subscribe("onAttributeClicked",function(e){C&&C.solveAttributeLink(e)}),n.tokensBrowserPanel.onCommentClicked=n.attrUI.subscribe("onCommentClicked",Se),n.tokensBrowserPanel.onDSpointerhit=n.attrUI.subscribe("onDSpointerhit",Be);var o=s.getPreference("CAT3DAnnotAttrRowSelection_"+e);o=o||"highlight";var l=s.getPreference("CAT3DAnnotAttrAttrDisplay_"+e);l=l||"columns";var u=s.getPreference("CAT3DAnnotColumnSort_"+e);u=u||"disabled";var p=n.attrUI.buildPanel({model:t,discipline:e,disciplineNls:A[e],rowSelectionCurrentState:o,columnSortCurrentState:u,attributeDisplayCurrentState:l,representationMode:re[e],multiRepDefaultMode:ae[e],allowExport:!1!==ne,onDragStartColumnHeader:We,onDragEndColumnHeader:Ne});if(p)if(n.panel)n.panel.content=p;else{var h=c.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");"3DAnnotations"===e?h+="I_W3DAnnot_NodeAnnotationSet.png":"0"===e?h+="I_W3DAnnot_MechanicalAttribute.png":"1"===e?h+="I_W3DAnnot_ElectricalAttribute.png":"2"===e?h+="I_W3DAnnot_KnowledgeAttribute.png":"3"===e?h+="I_W3DAnnot_StructureAttribute.png":"4"===e?h+="I_W3DAnnot_CompositeAttribute.png":"5"===e?h+="I_W3DAnnot_GeometricalAttribute.png":"6"===e?h+="I_W3DAnnot_LayeredPrdAttribute.png":"7"===e&&(h+="I_W3DAnnot_PathwayAttribute.png"),n.panel=new r({id:"CAT3DAnnotAttrBrowserPanel"+e,className:"CAT3DAnnotAttrBrowserPanel",title:A[e],icon:h,immersiveFrame:R.getFrameWindow().getImmersiveFrame(),viewerFrame:R.getFrameWindow().getViewerFrame(),closeButtonFlag:!1,content:p,minHeight:50,minWidth:180,height:180,snappableFlag:!0,allowMaximizeFlag:!0,maximizeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea})}n&&n.panel.setPanelVisibilityFlag(x&&0!==n.attrUI.getDisplayedIDPaths().length)};this.setResultRepresentationModeFlag=function(e){e!==$&&($=e,Y?w.hideAttributeResultTable():(ge(),fe()))},this.getResultRepresentationModeFlag=function(){return $},this.displayAttributeResultTable=function(e){I.length=0;for(var t=0;t<e.length;t++)I.push(e[t].clone());Y=!0,fe()},this.hideAttributeResultTable=function(){Y&&(I.length=0,ge(),Y=!1,fe())},this._internalRefresh=function(){if($&&!Y||!$&&Y)ge();else if(!L||J)ge();else{var e,n,a,o=t.get().slice();if(Y){if(de(),F)for(e=F.length-1;e>=0;e--){for(F[e].panel&&(F[e].panel.clean(),F[e].panel=null),a=Object.keys(F[e].tokensBrowserPanel),n=0;n<a.length;n++)F[e].attrUI.unsubscribe(F[e].tokensBrowserPanel[a[n]]);F[e].attrUI.cleanPanel(),F.splice(e,1)}if(!E.result.length||!E.result[0].elements||!E.result[0].elements.length)return;!function(){F&&F.length&&F[0].attrUI&&F[0].attrUI.cleanPanel(),F&&F.length||(F=[{}]),F[0].attrUI=new i,F[0].tokensBrowserPanel={},F[0].tokensBrowserPanel.onAttrActiveStateModified=F[0].attrUI.subscribe("onAttrActiveStateModified",ke),F[0].tokensBrowserPanel.onReframeOn=F[0].attrUI.subscribe("onReframeOn",xe),F[0].tokensBrowserPanel.onDeleteDisplayHistory=F[0].attrUI.subscribe("onDeleteDisplayHistory",Me),F[0].tokensBrowserPanel.onSwitchAttributeDisplayMode=F[0].attrUI.subscribe("onSwitchAttributeDisplayMode",Fe),F[0].tokensBrowserPanel.onAttributeClicked=F[0].attrUI.subscribe("onAttributeClicked",function(e){C&&C.solveAttributeLink(e)}),F[0].tokensBrowserPanel.onDSpointerhit=F[0].attrUI.subscribe("onDSpointerhit",Be);var e=s.getPreference("CAT3DAnnotAttrAttrDisplay_result");e=e||"columns";var t=F[0].attrUI.buildPanel({model:E.result,attributeDisplayCurrentState:e,onDragStartColumnHeader:We,onDragEndColumnHeader:Ne});t&&(F[0].panel?F[0].panel.content=t:F[0].panel=new r({id:"CAT3DAnnotResultAttrBrowserPanel",className:"CAT3DAnnotAttrBrowserPanel CAT3DAnnotResultAttrBrowserPanel",title:f.resultAttrPanelTitle,icon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attributes",immersiveFrame:R.getFrameWindow().getImmersiveFrame(),viewerFrame:R.getFrameWindow().getViewerFrame(),closeButtonFlag:!1,content:t,minHeight:50,minWidth:180,height:180,snappableFlag:!0,allowMaximizeFlag:!0,maximizeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea})),F&&F.length&&F[0].panel.setPanelVisibilityFlag(0!==F[0].attrUI.getDisplayedIDPaths().length)}(),F.length&&(F.forEach(function(e){e.panel.setEnableFlag(j>=0)}),ye(o,{activeState:!0}),Pe(),Q.length&&Ve(Q),Q.length=0)}else k||(k=C.onAdditionalInfosRequired({controller:"AnnotAttrBrowser"}).getJSONModel),I.splice(0,I.length),k(function(t){I=t,z=D?D.getAttributeTypesFiltered():null,de();var i=Object.keys(E);for(e=F.length-1;e>=0;e--)if(-1===i.indexOf(F[e].discipline)){for(F[e].panel.clean(),a=Object.keys(F[e].tokensBrowserPanel),n=0;n<a.length;n++)F[e].attrUI.unsubscribe(F[e].tokensBrowserPanel[a[n]]);F[e].attrUI.cleanPanel(),F.splice(e,1)}for(e=i.length-1;e>=0;e--)Xe(i[e],E[i[e]]);F&&F.length&&(F.forEach(function(e){e.panel.setPanelVisibilityFlag(x),e.panel.setEnableFlag(j>=0),e.attrUI.forceCommentColumnVisibilityFlag(ee),e.attrUI.setCommentInformation(P)}),ye(o,{activeState:!0})),Pe(),Q.length&&Ve(Q),Q.length=0})}},this.setDisplayedElementPaths=function(e,t){if(L){v={},t&&(re=t);var n=[],i={};e&&e.length&&e.forEach(function(e){if(e.pathElement&&e.pathElement.getLastElement(!0).getAttributeCategory){var t=e.pathElement.getLastElement(!0).getAttributeCategory();v[t]||(v[t]=[]),v[t].push(e),-1===n.indexOf(t)&&n.push(t),i[t]||(i[t]=[]),i[t].push(me(e.pathElement))}}),n.forEach(function(e){s.setPreference("CAT3DAnnotAttrRowSelection_"+e,"display"),F.some(function(t){if(t.attrUI.getDiscipline()===e){t.attrUI.setRowSelectionMode("display"),re&&re[e]&&t.attrUI.setMultiRepOption(re[e]);for(var n=t.attrUI.getDisplayedIDPaths(!0)||[],r=i[e].slice(),a=r.length-1;a>=0;a--){for(var o=!1,l=n.length-1;l>=0;l--)if(JSON.stringify(r[a])===JSON.stringify(n[l])){n.splice(l,1),o=!0;break}o&&r.splice(a,1)}var s=n.map(function(e){return{idPath:e,infos:{activeState:!1}}});return(s=s.concat(r.map(function(e){return{idPath:e,infos:{activeState:!0,displayFlag:!0}}}))).length&&t.attrUI.setAdditionalInformations(s),!0}})}),Pe()}},this.setSelectedElementPaths=function(e,n){var i=[],r=[];e&&e.length&&e.forEach(function(e){if(e.pathElement&&e.pathElement.getLastElement(!0).getAttributeCategory){var t=e.pathElement.getLastElement(!0).getAttributeCategory();-1===i.indexOf(t)&&i.push(t)}r.push({pathElement:e.pathElement.clone(),filterOpts:re})}),L&&(n&&(re=n),i.forEach(function(e){s.setPreference("CAT3DAnnotAttrRowSelection_"+e,"highlight"),F.some(function(t){if(t.attrUI.getDiscipline()===e)return t.attrUI.setRowSelectionMode("highlight"),!0})})),t.add(r)},this.getDisplayedElementPaths=function(){if(L){var e=[];return Object.keys(v).forEach(function(t){e=e.concat(v[t])}),e}},this.getDisplayedElementsFilteringOpts=function(){return re},this.setActiveState=function(e){var n;if(L=e,C&&S&&ie)if(L)V||(N.onPostAdd=t.onPostAdd(be),N.onPostRemove=t.onPostRemove(ve),N.onEmpty=t.onEmpty(De),D=l.give3DAnnotFilterController({context:R}),(U=h.getPreferenceManager({context:R.getFrameWindow()}))&&(te=U.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)if("cke"===t.repositories[e].name)for(let n=0;n<t.repositories[e].preferences.length;n++){let i=t.repositories[e].preferences;["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"].includes(i[n].name)&&fe()}})),D&&(B.onAnnotationFilterActiveStateModified=D.subscribe("onAnnotationFilterActiveStateModified",function(){var e=D.getAttributeTypesFiltered(),t=!1;if((!z&&e&&e.length||!e&&z&&z.length||e&&z&&e.length!==z.length)&&(t=!0),!t)for(n=0;n<e.length;n++)if(e[n]!==z[n]){t=!0;break}t&&fe()}),B.onAttributesVisibilityModified=D.subscribe("onAttributesVisibilityModified",fe)),O.onAnnotControllerActiveStateChanged=C.subscribe("onAnnotControllerActiveStateChanged",function(e){e.state?fe():ge()}),O.onFeatureFocusRequired=C.subscribe("onFeatureFocusRequired",function(e){e&&e.paths&&Ve(e.paths)}),O.onAnnotationsLinkedDataSolved=C.subscribe("onAnnotationsLinkedDataSolved",function(e){!0===e.succeeded&&fe()}),O.onBeginDisplayViewOrCapture=C.subscribe("onBeginDisplayViewOrCapture",function(e){if(e&&(e.path||e.uuid)){let e=s.getPreference("CATWebUXMePreferences_KeepSelectedFeatures");Object.keys(v).forEach(function(t){"3DAnnotations"!==t&&e||(ye(v[t],{activeState:!1},!0),delete v[t])}),e||t.empty(),Pe()}}),_.onAnnotModelLoaderActiveStateChanged=S.subscribe("onAnnotModelLoaderActiveStateChanged",function(e){e.state?fe():ge()}),_.onAnnotationVisibilityModifiedToken=S.subscribe("onAnnotationVisibilityModified",function(e){e&&e.node&&e.node.getAnnotationClassType&&"tpsAnnotationSet"===e.node.getAnnotationClassType()&&(e.node.isVisible()||(Object.keys(v).forEach(function(t){if(v[t]&&v[t].length)for(var n=v[t].length-1;n>=0;n--)(!v[t][n]||v[t][n]&&e.path.isAParentOf(v[t][n]))&&v[t].splice(n,1)}),v={},Pe()),fe())}),_.onAnnotationSetLoadedToken=S.subscribe("onAnnotationSetLoaded",function(){Ae(!0),fe()}),_.onAnnotationSetPartiallyLoaded=S.subscribe("onAnnotationSetPartiallyLoaded",function(){Ae(!0),fe()}),_.onAnnotationSetRemovedToken=S.subscribe("onAnnotationSetRemoved",function(){var e;q=0,(e=S.getOrderedAnnotationSetPaths())&&e.length&&(e=e.map(e=>e.annotSetPath)),Object.keys(v).forEach(function(t){for(var n=v[t].length-1;n>=0;n--){var i=!1;if(e&&e.length)for(var r=e.length-1;r>=0;r--)if(v[t][n]&&v[t][n].pathElement&&e[r].isAParentOf(v[t][n].pathElement)){i=!0;break}i||v[t].splice(n,1)}}),fe()}),_.onAnnotationSetBeginLoadToken=S.subscribe("onAnnotationSetBeginLoad",function(){Ae(!1)}),_.onAnnotationSetLoadingFailedToken=S.subscribe("onAnnotationSetLoadingFailed",function(){Ae(!0)}),_.onNoAnnotationSetLoadedToken=S.subscribe("onNoAnnotationSetLoaded",function(e){e&&e.loadingAlreadyStarted&&Ae(!0)}),_.onAnnotationSetLoadingCanceledToken=S.subscribe("onAnnotationSetLoadingCanceled",function(){Ae(!0)}),_.onVisuModificationToken=S.subscribe("onAnnotationParentVisibilityModified",function(){fe()}),W=R.getViewer().onSwapVisibleSpace?R.getViewer().onSwapVisibleSpace(function(){J=0===R.getViewer().getVisibleSpace(),1===R.getViewer().getVisibleSpace()?fe():ge()}):null,J=0===R.getViewer().getVisibleSpace(),V=!0),Pe(),fe();else{if(V){t.unsubscribe(N.onPostAdd),t.unsubscribe(N.onPostRemove),t.unsubscribe(N.onEmpty);var i=Object.keys(B);if(D)for(n=0;n<i.length;n++)D.unsubscribe(B[i[n]]);for(U&&(te&&(U.unsubscribe(te),te=null),h.unreferencePreferenceManager({context:R.getFrameWindow()}),U=null),i=Object.keys(O),n=0;n<i.length;n++)C.unsubscribe(O[i[n]]);for(i=Object.keys(_),n=0;n<i.length;n++)S.unsubscribe(_[i[n]]);W&&R.getViewer()&&R.getViewer().unsubscribe(W),Pe(),W=0,B={},_={},O={},N={},ge(),Q.length=0,V=!1}ie&&(s.cleanPrefManager(),ie=!1)}else T||(T=setInterval(function(){S=o.giveAnnotationModelLoader({context:R}),(C=a.giveAnnotationController({context:R}))&&S&&(clearInterval(T),T=null,ie?w.setActiveState(L):s.initPrefManager({context:R.getFrameWindow()}).then(()=>{ie=!0,w.setActiveState(L)}))},100))},this.getActiveState=function(){return L},this.setControllerEnableFlag=function(e){let t="true"===localStorage.getItem("WebAfr_v2_activated")?"AnnotationSemanticBrowser":"CAT3DAnnotSemanticAttrBrowserHdr";var n=d.getCommandCheckHeader(t,R.getCommandContext());n&&(e?n.enable():n.disable()),M?(w.setActiveState(!0),M=!1):e||L&&(w.setActiveState(!1),M=!0,k=C=S=null)},this.setPanelVisibilityFlag=function(e){x=e,!Y&&F&&F.length&&F.forEach(function(e){e.panel.setPanelVisibilityFlag(x&&0!==e.attrUI.getDisplayedIDPaths().length)})},this.getPanelVisibilityFlag=function(){return x},this.forceCommentColumnVisibilityFlag=function(e){ee!==e&&(ee=e,F.forEach(function(e){e.attrUI.forceCommentColumnVisibilityFlag(ee)}))},this.updateCommentColumn=function(e){JSON.stringify(P)!==JSON.stringify(e)&&(P=e,F.forEach(function(e){e.attrUI.setCommentInformation(P)}))},this.clearController=function(){this.setActiveState(!1),T&&clearInterval(T),F=I=null,D=C=S=z=null,k=null,K=R=w=null},this.allowTableExportInCSV=function(e){ne=e},this.subscribe=function(e,t){return e&&t?K.subscribe({event:e},t):void 0},this.unsubscribe=function(e){K&&e&&K.unsubscribe(e)}}}),C=[];return e.singleton({init:function(){},give3DAnnotAttrBrowserController:function(e){if(e&&e.context)for(var t=0;t<C.length;t++)if(C[t].context===e.context)return C[t].attrCtrl},get3DAnnotAttrBrowserController:function(e){var t=this.give3DAnnotAttrBrowserController(e);if(e&&e.context&&!t){var n=new D({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},setResultRepresentationModeFlag:function(e){n&&n.setResultRepresentationModeFlag(e)},getResultRepresentationModeFlag:function(){if(n)return n.getResultRepresentationModeFlag()},setDisplayedElementPaths:function(e,t){n&&n.setDisplayedElementPaths(e,t)},getDisplayedElementsFilteringOpts:function(){return n?n.getDisplayedElementsFilteringOpts():null},setSelectedElementPaths:function(e,t){n&&n.setSelectedElementPaths(e,t)},getDisplayedElementPaths:function(){if(n)return n.getDisplayedElementPaths()},setControllerEnableFlag:function(e){n&&n.setControllerEnableFlag(e)},displayAttributeResultTable:function(e){n&&n.displayAttributeResultTable(e)},hideAttributeResultTable:function(){n&&n.hideAttributeResultTable()},forceCommentColumnVisibilityFlag:function(e){n&&n.forceCommentColumnVisibilityFlag(e)},updateCommentColumn:function(e){n&&n.updateCommentColumn(e)},clearController:function(){n&&(n.clearController(),n=null)},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return!!n&&n.getPanelVisibilityFlag()},allowTableExportInCSV:function(e){n&&n.allowTableExportInCSV(e)},subscribe:function(e,t){return n?n.subscribe(e,t):void 0},unsubscribe:function(e){n&&n.unsubscribe(e)}}),C.push({context:e.context,attrCtrl:t,counter:1})}else if(e&&e.context)for(var i=0;i<C.length;i++)if(C[i].context===e.context){C[i].counter++;break}return t},unreference3DAnnotAttrBrowserController:function(e){if(e&&e.context)for(var t=0;t<C.length;t++)if(C[t].context===e.context){C[t].counter--,C[t].counter<=0&&(C[t].attrCtrl.clearController(),C.splice(t,1));break}}})});