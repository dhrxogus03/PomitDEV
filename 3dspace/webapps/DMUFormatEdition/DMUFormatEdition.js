define("DS/DMUFormatEdition/DMUEditFormatsCmd",["UWA/Utils","DS/CATWebUXComponents/DMUCommand","DS/DMUControls/EXPNotify","DS/DMUBaseExperience/DMUContextManager","DS/DMUPlaySlide/DMUFormat","DS/DMUBaseUIControllers/DMUSlidesController","i18n!DS/DMUFormatEdition/assets/nls/DMUFormatEdition"],function(e,t,r,i,n,o,a){"use strict";return t.extend({init:function(t){this._parent(t,"exclusive");var s,d=this;this.beginExecute=function(){var t=i.getReviewContext({viewer:d.getFrameWindow().getViewer()});if(!t)return void this.done();let l=t.getValidation();if(l||t){let f=l?l.getCurrentMarkup():null;for(;f&&"Markup"!==f.getValType();)f=f.getParentRepRef().getParent();f&&f.getValType&&"Markup"===f.getValType()&&(f=f.getRepRef());var m=f?f.getMarkupContent():t.getCurrentSessionMarkup();if(m){m.isVisible()||(t.getTransientReviewBag().removeDMUObjects(),m.setVisibleFlag(!0));var g=t.getEnvironment().getEnvironmentInfo(),u=!t.getUIManager().getFormatEditionModeFlag();if(t.getUIManager().setFormatEditionModeFlag(u),u&&!m.getFormats().length){var h=new n(d.getFrameWindow().getViewer(),m);h.setAttributes([{name:"sID",value:m.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:m.computeNewName({object:h,prefix:a.normalFormatTitle})}]),h.updateEnvironmentOverload({target:t.getEnvironment(),state:g}),m.addFormat(h),h.fireEvent("onDMUObjectInitialized",{dmuObject:h,dmuCont:m,mkpRepRef:f});var D=o.giveDMUSlidesController({context:d.getFrameWindow()});D&&D.setActiveSlide(h,{duration:0})}s&&s.destroy(),s=new r({body:d.getFrameWindow().getUIFrame(),type:"info",message:u?a.formatEditionModeStarted:a.slideEditionModeStarted});var c=i.giveEventsController({viewer:d.getFrameWindow().getViewer()});c&&c.fireEvent(u?"onFormatsEditionModeStarted":"onFormatsEditionModeEnded")}}d.end(),d.done&&d.done()}}})}),define("DS/DMUFormatEdition/DMUFormatEdition",[],function(){}),define("DS/DMUFormatEdition/DMUFormatChooserCtrl",["UWA/Core","UWA/Class","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUBaseExperience/DMUContextManager","DS/DMUControls/DMUThumbnailChooser","DS/DMUBaseUIControllers/DMUSlidesController","DS/WebappsUtils/WebappsUtils","DS/CATWebUXComponents/DMUCommandsManager","i18n!DS/DMUFormatEdition/assets/nls/DMUFormatEdition"],function(e,t,r,i,n,o,a,s,d,l){"use strict";var m=t.extend({init:function(t){this._parent(t);var m,g=t||{},u=!1,h=null,D={},c=!1,f=this,U=e.createElement("canvas"),M=function(){m&&(m.clean(),m=null),h&&(h.setPanelVisibilityFlag(!1),h.clean(),h=null)},p=function(){u&&f.setActiveState(!1)};this.setActiveState=function(t){(u=t)?(c||(D.onAdd=r.onAdd(p),D.onRemove=r.onRemove(p),D.onEmpty=r.onEmpty(p),c=!0),function(){if(M(),u){var t,r=n.getReviewContext({viewer:g.frmWindow.getViewer()});if(r){var D=r.getCurrentSessionMarkup();if(D){var c=D.getFormats(),p=D.getCurrentSlide(),v=r.getUIManager().getSelectedObjects(),C=!1;if(v&&v.length){for(t=v.length-1;t>=0;t--){if("DMUSlide"!==v[t].getType())return;v[t]===p&&(C=!0,v.splice(t,1))}p&&C&&v.push(p);var S=1===v.length?v[0].getPointedFormats():null;if(!v.length)return;var F=[],w=e.createElement("img",{src:p&&C?p.getPreview():v[0].getPreview()}),E=U.getContext("2d");U.width=w.width,U.height=w.height,E.drawImage(w,0,0,w.width,w.height);for(var b=E.getImageData(0,0,w.width,w.height),A=0;A<b.height;A++)for(var W=0;W<b.width;W++){var y=4*A*b.width+4*W,x=(b.data[y]+b.data[y+1]+b.data[y+2])/3;b.data[y]=x,b.data[y+1]=x,b.data[y+2]=x}for(E.putImageData(b,0,0,0,0,w.width,w.height),F.push({id:"noFormat",title:l.NoFormat,icon:s.getWebappsAssetUrl("DMUFormatEdition","icons/22/I_DMU_NoFormat.png"),preview:U.toDataURL("image/jpg"),isSelected:S&&0===S.length}),t=0;t<c.length;t++)F.push({id:c[t].getAttribute("sID"),title:c[t].getAttribute("sName"),icon:s.getWebappsAssetUrl("DMUPlaySlide","icons/22/I_DMUFormat.png"),preview:c[t].getPreview(),isSelected:S&&-1!==S.indexOf(c[t])});(m=new o(g.frmWindow)).build({thumbnailData:F,onThumbnailSelectedCB:function(e){var r="noFormat"===e.id?[]:[e.id];for(t=0;t<v.length;t++){var i=v[t].getAttribute("sPointedFormats")||[];(i.length!==r.length||i.length&&r.length&&r[0]!==i[0])&&(v[t].setAttribute("sPointedFormats","noFormat"===e.id?[]:[e.id]),v[t].fireEvent("onSaveRequested",{}),v[t].refreshNode())}p&&C&&p.fireEvent("onSlidePreviewRefreshRequired",{dmuObject:p}),g.frmWindow.getViewer().render()},additionalCommands:1===v.length?[{nls:l.generateFormat,icon:s.getWebappsAssetUrl("DMUSlideEdition","icons/32/I_GenerateFormatCmd.png"),cb:function(){var e=n.getContextViewer({viewer:g.frmWindow.getViewer()});if(e){var t=d.getCommand("DMUGenerateFormatHdr",e.getCommandContext());t&&t.begin()}f.setActiveState(!1)}}]:[]});var P,H=m.getWidth()+10,I=m.getHeight()+10,O={id:"DMUFormatChooser",className:"DMUFormatChooserPanel",title:l.FormatChooserPanelTitle,titleBarVisibleFlag:!1,frameWindow:g.frmWindow,immersiveFrame:g.frmWindow.getImmersiveFrame(),viewerFrame:g.frmWindow.getViewerFrame(),content:m.getContent(),minHeight:I,height:I,minWidth:H,width:H,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,closePanelCB:function(){f.setActiveState(!1)}};h=new i(O);var _=a.giveDMUSlidesController({context:g.frmWindow});_&&(P=_.getActiveThumbnailCtxMenuPosition()),P&&(P.offsetX=P.x,P.offsetY=P.y-I/2),h.setPanelPosition(P),h.elements.container.setStyles({borderWidth:"0px"})}}}}}()):(c&&(r.unsubscribe(D.onAdd),r.unsubscribe(D.onRemove),r.unsubscribe(D.onEmpty),D={},c=!1),M())},this.getActiveState=function(){return u},this.clearController=function(){f.setActiveState(!1),m=h=U=null}}}),g=[];return t.singleton({init:function(){},getDMUFormatChooserCtrl:function(e){var t=this.giveDMUFormatChooserCtrl(e);if(!t&&e&&e.frmWindow){var r=new m({frmWindow:e.frmWindow});t=Object.freeze({setActiveState:function(e){r&&r.setActiveState(e)},getActiveState:function(){if(r)return r.getActiveState()},clearController:function(){r&&(r.clearController(),r=null)}}),g.push({frmWindow:e.frmWindow,ctrl:t})}return t},giveDMUFormatChooserCtrl:function(e){if(e&&e.frmWindow)for(var t=0;t<g.length;t++)if(g[t].frmWindow===e.frmWindow)return g[t].ctrl},unreferenceDMUFormatChooserCtrl:function(e){if(e&&e.frmWindow)for(var t=0;t<g.length;t++)if(g[t].frmWindow===e.frmWindow){g[t].ctrl.clearController(),g.splice(t,1);break}}})}),define("DS/DMUFormatEdition/DMUUpdateFormatSessionOverloadCmd",["DS/CATWebUXComponents/DMUCommand","DS/DMUBaseExperience/DMUContextManager"],function(e,t){"use strict";return e.extend({init:function(e){e.mode="shared",this._parent(e);var r=this;this.beginExecute=function(){var e=t.getReviewContext({viewer:r.getFrameWindow().getViewer()});if(e){var i=e.getCurrentSessionMarkup();if(i){var n=i.getCurrentSlide();if(n){var o=n.getEnvironmentOverload(),a=e.getEnvironment().getEnvironmentInfo();a.sFocusProperty=o.state.sFocusProperty,n.updateEnvironmentOverload({target:e.getEnvironment(),state:a}),n.fireEvent("onDMUSlideSessionInfoChanged",{dmuObject:n})}}}r.end()}}})}),define("DS/DMUFormatEdition/DMUFormatContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/Selection/CSOManager","DS/DMUBaseUI/DMUToolsContextualBar"],function(e,t,r){"use strict";return e.extend({getSharedContextualMenuCommandList:function(e){var t=[];if(e&&e.length&&e.forEach(function(e){-1===t.indexOf(e.getType())&&t.push(e.getType())}),1===t.length&&(-1!==t.indexOf("DMUSlide")||-1!==t.indexOf("DMUFormat"))){for(var r=this.getContextualMenuCommandList(),i=0;i<e.length;i++)if(e[i].getObjectOverloads&&e[i].getObjectOverloads().length)return"true"===localStorage.getItem("WebAfr_v2_activated")?r.unshift({type:"WAfrDefaultHandlerItem",handlerId:"DMURemoveOverloadHdr"}):r.unshift({line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]}),r;return r}return[]},getContextualMenuCommandList:function(){var e=[],i=[],n="true"===localStorage.getItem("WebAfr_v2_activated");if("DMUSlide"===this.getType()||"DMUFormat"===this.getType()){if(this.getAttribute("sParentSlideID")||(n?i.push("DMUSlide"===this.getType()?"slideCmdHdr":"DMUFormatCmdHdr"):e.push({line:1,name:"DMUSlideOrFormatStr",hdr_list:["DMUSlide"===this.getType()?"slideCmdHdr":"DMUFormatCmdHdr"]})),this.isReadOnly()||(n?i.push("DMUCutHdr"):e=e.concat([{line:1,name:"DMUCutStr",hdr_list:["Format_DMUCutHdr"]}])),n?i.push("DMUCopyHdr","DMUPasteHdr","DMUPasteSpecialHdr"):e=e.concat([{line:1,name:"DMUCopyStr",hdr_list:["Format_DMUCopyHdr"]},{line:1,name:"DMUPasteStr",hdr_list:["Format_DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["Format_DMUPasteSpecialHdr"]}]),"DMUSlide"===this.getType()&&this.getParent()&&this.getParent().getParent()&&this.getParent().getParent().getValidation()){if(n?i.push("DMUCreateSlideReplyHdr"):e.push({line:1,name:"DMUCreateSlideReplyStr",hdr_list:["DMUCreateSlideReplyHdr"]}),this.getParent().getParent().getRestrictions().highlight.canCreate&&window.widget&&"ENOR3V_AP"===window.widget.getValue("appId")){const t=this.getAssociatedHighlightData();t&&t.length||(n?i.push("DMUAddHighlightHdr"):e.push({line:1,name:"DMUAddHighlightStr",hdr_list:["DMUAddHighlightHdr"]})),t&&!(t.length<2)||t[0]&&t[0].hasIssue||(n?i.push("issueTemplate"===localStorage.getItem("issueCreationType")?"DMUGenerateIssueFromTemplateFromSelectionHdr":"DMUGenerateIssueFromSelectionHdr"):e.push({line:1,name:"DMUGenerateIssueFromSelectionStr",hdr_list:["issueTemplate"===localStorage.getItem("issueCreationType")?"DMUGenerateIssueFromTemplateFromSelectionHdr":"DMUGenerateIssueFromSelectionHdr"]}))}}if(this.isReadOnly()||(n?i.push("DMUDeleteHdr"):e.push({line:1,name:"DMUDeleteStr",hdr_list:["Format_DMUDeleteHdr"]})),!this.isReadOnly()&&"DMUSlide"===this.getType()&&!this.getAttribute("sParentSlideID"))if(n?i.push("DMUFormatChooserHdr"):e.push({line:1,name:"DMUFormatChooserStr",hdr_list:["DMUFormatChooserHdr"]}),1===t.get().length)this.getPointedFormats&&this.getPointedFormats().length&&(n?i.push("DMUEditAssociatedFormatHdr"):e.push({line:1,name:"DMUEditAssociatedFormatStr",hdr_list:["DMUEditAssociatedFormatHdr"]}));r.isCloud()&&!this.isReadOnly()&&"DMUSlide"===this.getType()&&this.isPreview&&!this.isPreview()&&(n?i.push("DMUSetAsPreviewHdr"):e.push({line:1,name:"DMUSetAsPreviewStr",hdr_list:["DMUSetAsPreviewHdr"]}))}if(n){for(let t=0;t<i.length;t++)"DMUAddHighlightHdr"===i[t]?e.push({type:"WAfrDefaultHandlerItem",handlerId:i[t],hdr_list:["DMUAddHighlightHdr"]}):e.push({type:"WAfrDefaultHandlerItem",handlerId:i[t]});return e}return e},register:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:"markup"===e.experience||"DMUFormat"===e.type?{type:e.type,module:"DMUFormatEdition",workbenchName:"DMUFormatContextHdr"}:{type:e.type,module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:"markup"===e.experience||"DMUFormat"===e.type?{type:e.type,module:"DMUFormatEdition",workbenchName:"DMUFormatContextHdr"}:{type:e.type,module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})}})}),define("DS/DMUFormatEdition/DMUFormatExport",["require","exports","DS/DMUBaseExperience/EXPUtils"],function(e,t,r){"use strict";return class{static getObjectDefinition(e){function t(e,t){let i={};if(e&&t){let n=e.getParameters(),o=n.length;for(let e=0;e<o;e++){let o=n[e];if(o.isOverloadable&&void 0!==t[o.name]){let e=i,n=o.JSONname.split(".");for(;n.length;){let i=n.shift();if(i){if(0===n.length){let n=r.typeToStr(t[o.name],o.type);null!=n&&""!==n&&(e[i]=n);break}void 0===e[i]&&(e[i]={}),e=e[i]}}}}}return i}let i={EnvironmentOverload:{},ObjectOverloads:[]},n=e.getEnvironmentOverload();if(n){let e={targetId:"environment",state:t(n.target,n.state)};i.EnvironmentOverload=e}let o=e.getObjectOverloads();return o&&o.forEach(function(e){let r={targetId:e.target._sID,state:t(e.target,e.state)};i.ObjectOverloads.push(r)}),e.getSlideApplicativeContext()&&(i.ApplicativeContext=e.getSlideApplicativeContext()),i}}}),define("DS/DMUFormatEdition/DMUFormatChooserCmd",["DS/CATWebUXComponents/DMUCommand","DS/DMUFormatEdition/DMUFormatChooserCtrl"],function(e,t){"use strict";return e.extend({init:function(e){var r=e||{};r.mode="shared",this._parent(r);var i=this,n=t.getDMUFormatChooserCtrl({frmWindow:i.getFrameWindow()});this.beginExecute=function(){n&&!n.getActiveState()&&n.setActiveState(!0),i.end()};var o=this._destroy;this._destroy=function(){t.unreferenceDMUFormatChooserCtrl({frmWindow:i.getFrameWindow()}),n=null,o.call(i),i.done()}}})});