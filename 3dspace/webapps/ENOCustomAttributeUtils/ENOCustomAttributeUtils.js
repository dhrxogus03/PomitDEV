define("DS/ENOCustomAttributeUtils/scripts/CustomAttributeUtils",["DS/PlatformAPI/PlatformAPI","DS/WAFData/WAFData","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/UIKIT/Alert","DS/UIKIT/Mask","i18n!DS/ENOCustomAttributeUtils/assets/nls/ENOCustomAttribute"],function(e,t,i,n,r,a){"use strict";var s={getFilterModel:function(e){var t={};for(let n in e){var i=e[n].dataIndex;e[n].filterId?t[i]={filterId:e[n].filterId,filterModel:e[n].filterModel}:"boolean"==e[n].dataType?t[i]={filterId:"set",filterModel:[]}:"number"==e[n].dataType||"integer"==e[n].dataType||"real"==e[n].dataType?t[i]={filterId:"number",filterModel:""}:"datetime"==e[n].dataType?t[i]={filterId:"date",filterModel:""}:"string"==e[n].dataType&&(e[n].range?t[i]={filterId:"set",filterModel:[]}:t[i]={filterId:"stringRegexp",filterModel:""})}return t},fetchNLSForClassifiedInterface:function(e,t){var i={};return new Promise(function(n,r){var a="/resources/v1/modeler/dslib/dslib:Class/"+e+"?$mask=dslib:ClassMask";s.makeWSCallWithCSRF(t.settings.url+a,"GET","enovia","application/json","",function(t){Array.isArray(t.member)&&1==t.member.length?(i.id=t.member[0].id,i.type=t.member[0].name,i.typeNLS=t.member[0].title):(i.id=e,i.type=e,i.typeNLS=e),n(i)},function(t){i.id=e,i.type=e,i.typeNLS=e,n(i)},t)})},fetchNLSForType:function(e,t){var i={};return new Promise(function(n,r){var a="/resources/dictionary/class/"+e+"/attributes";s.makeWSCallWithCSRF(t.settings.url+a,"GET","enovia","application/json","",function(t){UWA.is(t.NLSName)&&""!=t.NLSName?(i.type=e,i.typeNLS=t.NLSName):(i.type=e,i.typeNLS=e),n(i)},function(t){i.type=e,i.typeNLS=e,n(i)},t)})},compareValuesOfTwoNode:function(e,t){return e>t?1:e==t?0:e<t?-1:void 0},isColumnAlreadyExist:function(e,t){let i=!1;for(let n=0;n<e.length;n++)if(e[n].dataIndex===t){i=!0;break}return i},isTypeAlreadyExist:function(e,t){let i=!1;for(let n=0;n<e.length;n++)if(e[n].curi==="ds6wg:"+t){i=!0;break}return i},isExtensionAlreadyExist:function(e,t){let i=!1;for(let n=0;n<e.length;n++)if(e[n].curi==="ds6wg:"+t){i=!0;break}return i},isClassifiedExtensionAlreadyExist:function(e,t){let i=!1;for(let n=0;n<e.length;n++)if(e[n].curi===t){i=!0;break}return i},uniqueBy:function(e,t){return[...new Map(e.map(e=>[t(e),e])).values()]},getCustoColsDef:function(e,t){let i=new Array;for(let n=0;n<e.columns.length;n++){let r=e.columns[n];if(t.includes(r.dataIndex))i.push(r);else if(r.children)for(let e=0;e<r.children.length;e++){let n=r.children[e];t.includes(n.dataIndex)&&i.push(n)}}return i},getCustoColDef:function(e,t){for(let i=0;i<e.length;i++){let n=e[i];if(n.dataIndex===t)return n}},booleanAggregation:function(e,t){let i="";for(var n=0;n<e.length;n++){let r=e[n].options.grid[""+t];if(!0!==r){if(!1===r){i=!1;break}i="";break}i=!0}return i},rangeAggregation:function(e,t){let i=0,n=0,r=0;for(var a=0;a<e.length;a++)isNaN(e[a].options.grid[""+t])||(i+=Number(e[a].options.grid[""+t]),r++);return n=Math.round(i/r)},sumAvgAggregation:function(e,t){let i=0,n=0,r=0;for(var a=0;a<e.length;a++)isNaN(e[a].options.grid[""+t])||(i+=Number(e[a].options.grid[""+t]),r++);return`&#x2211; ${i} | x&#772; ${n=i/r} `},addAggregrationOnPredicate:function(e,t){let i=e.dataIndex,n=e.dataType,r=e.range;e.getCellClassName=function(e){if(e.rowID>=0&&e.nodeModel.options.grid.id==t.settings.aggregationRowID)return t.settings.aggregationRowClass},e.getCellValue=function(e){if(e.nodeModel.getAttributeValue("isLastNode")){var a=e.nodeModel.getBrothers();return a=a.filter(e=>"Cancelled"!=e.options.grid.maturity&&e.options.grid.id!=t.settings.aggregationRowID),"boolean"===n?s.booleanAggregation(a,i):"number"===n?r?s.rangeAggregation(a,i):s.sumAvgAggregation(a,i):""}return e.nodeModel.getAttributeValue(i)}},applyCustomAttributes:async function(e,t,i){i.settings.tenant=widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",i.settings.ENO_CSRF_TOKEN=await s.getCSRFToken(i),t=t||"Default View";let n=i.dgvHandle,a=i.ootb_columns,o=[],l=[],d=[],g=this,u=[];a.filter(e=>{if(e.ds6wIndexMapping)return e.ds6wIndexMapping});if(n.treeDocument.getAllDescendants().length>0){e.forEach(e=>{if(e.identifier==t){let t=e.columnsVisibleFlag;t&&(u=Object.keys(t).filter(e=>t[e]))}}),u.forEach(e=>{g.isColumnAlreadyExist(a,e)||"ContextualMenuColumn"===e||o.push(e)});for(let e=0;e<n.model.length;e++){let t=n.model[e];UWA.is(i.settings.aggregationRowRequired)&&!0===i.settings.aggregationRowRequired&&t.options.grid.id===i.settings.aggregationRowID||UWA.is(t.options.grid.isCategory)&&!0===t.options.grid.isCategory||!UWA.is(t.options.grid.id)||(l.push(t.options.grid.id),d.push(t))}if(o.length>0&&l.length>0){let e=s.getCustoColsDef(n,o);s.updateAsynAttributeColumn(o,l,d,i,e);let t=n.treeDocument.getFilterManager().filterModel,r=s.getFilterModel(e);Object.keys(r).forEach(e=>{t[e]=r[e]}),n.treeDocument.setFilterModel(t),n.treeDocument.reapplyFilterModel()}}i.dgvDiv&&r.unmask(i.dgvDiv)},launchCustomViewManager:async function(e){e.dgvDiv&&r.mask(e.dgvDiv),await this.updateColumnDefinition(e),e.dgvHandle.getCustomViewsManager().showCustomViewsDialog(),e.dgvDiv&&r.unmask(e.dgvDiv)},processSizeAllColumnsToFitCustomData:function(e,t,i,n){let r=new Array;Array.isArray(n)&&n.forEach(e=>{for(let t=0;t<i.dgvHandle.columns.length;t++){let n=i.dgvHandle.columns[t];n.dataIndex!==e&&n.dataIndex!==i.dgvHandle.layout.getDataIndexFromColumnIndex(e)||r.push({di:n.dataIndex,width:n.width})}}),e.forEach(e=>{e.identifier===t&&Array.isArray(n)&&r.length>0&&(UWA.is(e.columnsWidth)?r.forEach(t=>{e.columnsWidth[t.di]=t.width}):(e.columnsWidth={},r.forEach(t=>{e.columnsWidth[t.di]=t.width})))}),i.dgvHandle.getCustomViewsManager().setCustomViews(e)},processCustomViews:function(e,t,i,n){i.dgvHandle.identifier;let r=void 0,a=void 0;(UWA.is(n.columnWidthChange)||UWA.is(n.columnVisibleStateChange))&&i.dgvHandle.columns.forEach(e=>{!UWA.is(n.columnWidthChange)||n.columnWidthChange!==e.dataIndex&&i.dgvHandle.layout.getDataIndexFromColumnIndex(n.columnWidthChange)!==e.dataIndex||(r={di:e.dataIndex,width:e.width}),!UWA.is(n.columnVisibleStateChange)||n.columnVisibleStateChange!==e.dataIndex&&i.dgvHandle.layout.getDataIndexFromColumnIndex(n.columnVisibleStateChange)!==e.dataIndex||(a={di:e.dataIndex,visibleFlag:e.visibleFlag})}),e.forEach(e=>{e.identifier===t&&(UWA.is(n.columnWidthChange)&&UWA.is(r)&&(UWA.is(e.columnsWidth)?e.columnsWidth[r.di]=r.width:(e.columnsWidth={},e.columnsWidth[r.di]=r.width)),UWA.is(n.columnVisibleStateChange)&&UWA.is(a)&&(UWA.is(e.columnsVisibleFlag)?e.columnsVisibleFlag[a.di]=a.visibleFlag:(e.columnsVisibleFlag={},e.columnsVisibleFlag[a.di]=a.visibleFlag)))}),i.dgvHandle.getCustomViewsManager().setCustomViews(e)},restoreCustomViews:async function(e,t){await s.updateColumnDefinition(t);let i=e.customViews,n=e.currentCustomViewIdentifier;t.dgvHandle.getCustomViewsManager().setCustomViews(i),t.dgvHandle.getCustomViewsManager().setCurrentCustomView(n),UWA.is(t.dgvHandle.getCustomViewsManager().getCurrentCustomView())&&Array.isArray(t.dgvHandle.getCustomViewsManager().getCurrentCustomView().sortModel)&&t.dgvHandle.getCustomViewsManager().getCurrentCustomView().sortModel.length>0&&(t.dgvHandle.sortModel=t.dgvHandle.getCustomViewsManager().getCurrentCustomView().sortModel,t.dgvHandle.reapplySortModel()),s.applyCustomAttributes(i,n,t)},updateColumnDefinition:async function(e){let t=this;e.settings.tenant=widget.getValue("x3dPlatformId")?widget.getValue("x3dPlatformId"):"OnPremise",e.settings.ENO_CSRF_TOKEN=await s.getCSRFToken(e);let i=e.dgvHandle,n=e.ootb_columns,o=[],l=[],d=[],g=[];i.columns;let u=[];if((u=UWA.is(e.settings.iterateRootNodesOnly)&&!0===e.settings.iterateRootNodesOnly?i.treeDocument.getRoots():i.treeDocument.getAllDescendants()).forEach(i=>{if(!i.options.grid.sourceType||"CSD"!=i.options.grid.sourceType){if(i.options.grid.isInstanceOperation&&"TRUE"===i.options.grid.isInstanceOperation&&i.options.grid.after_details&&i.options.grid.after_details.dataelements["ds6w:type"]?!1===t.isTypeAlreadyExist(o,i.options.grid.after_details.dataelements["ds6w:type"])&&(i.options.grid.type_instance_NLS?o.push({curi:"ds6wg:"+i.options.grid.after_details.dataelements["ds6w:type"],NLS:i.options.grid.type_instance_NLS,isCustom:!0}):o.push({curi:"ds6wg:"+i.options.grid.after_details.dataelements["ds6w:type"],NLS:i.options.grid.after_details.dataelements["ds6w:type"],isCustom:!0})):i.options.grid.type&&!1===t.isTypeAlreadyExist(o,i.options.grid.type)&&o.push({curi:"ds6wg:"+i.options.grid.type,NLS:i.options.grid.typeNLS,isCustom:!0}),UWA.is(e.settings.refRequired)&&!0===e.settings.refRequired&&i.options.grid.refType&&!1===t.isTypeAlreadyExist(o,i.options.grid.refType)&&o.push({curi:"ds6wg:"+i.options.grid.refType,NLS:i.options.grid.refTypeNLS,isCustom:!0}),i.options.grid.interfaces)for(let e of i.options.grid.interfaces)!1===t.isExtensionAlreadyExist(l,e)&&l.push({curi:"ds6wg:"+e,NLS:e,isCustom:!0});if(i.options.grid.classes)for(let e of i.options.grid.classes)!1===t.isClassifiedExtensionAlreadyExist(d,e.name)&&d.push({curi:e.name,NLS:e.NLS,isCustom:!0,attrs:e.attrs})}}),l.length>0){let t=await s.getExtensionsForClass(o.map(e=>e.curi.substring(6)).filter(e=>{if(""!=e)return e}),e);for(let e=0;e<l.length;e++)l[e].NLS=s.getExtensionNLS(t,l[e].curi)}if(o=[...o,...l],i.columns.forEach(e=>{for(let t=0;t<o.length;t++)if(UWA.is(o[t].isCustom)&&!1===o[t].isCustom&&o[t].curi===e.dataIndex){o.splice(t,1);break}}),o.length>0){var c=[];for(var f of o){var m=f.curi.substring(6);m&&"MSFDocumentInterface"!=m&&"Change Update Stamps"!=m&&c.push(m)}d.forEach(async t=>{let i=await s.fetchNLSForClassifiedInterface(t.curi,e);t.NLS=i.typeNLS,t.curi=i.type,t.id=i.id});var p=await s.getPropertyForClassGrid(c,e.settings);if(p&&"[object Error]"!==Object.prototype.toString.call(p)){var h=p.classPredicates;t.customAttributesList=[];for(var y=0;y<o.length;y++)for(var C=0;C<h.length;C++){var A=h[C];if(o[y].curi===A.className){for(var w=[],b=A.vocabularyPredicateInfo,v=0;v<b.length;v++){var S=b[v];let i="";switch(S.range.dataTypes[0].substring(S.range.dataTypes[0].indexOf("#")+1)){case"string":i="string";break;case"boolean":i="boolean";break;case"integer":case"real":case"number":i="number";break;case"dateTime":case"timestamp":i="datetime";break;default:i="string"}let n={dataIndex:S.uri,text:S.nlsName,editableFlag:!1,allowUnsafeHTMLContent:!0,range:S.hasOwnProperty("rangeValues"),visibleFlag:!1,typeRepresentation:i,dataType:i};UWA.is(e.settings.aggregationRowRequired)&&!0===e.settings.aggregationRowRequired&&(n.compareFunction=function(t,i,n,r,a){if(n.options.grid.id!=e.settings.aggregationRowID&&r.options.grid.id!=e.settings.aggregationRowID){if(t>i)return 1;if(t==i)return 0;if(t<i)return-1}return!1},s.addAggregrationOnPredicate(n,e)),S.hasOwnProperty("userAccess")&&t.customAttributesList.push(S),w.push(n),n=null}var x={dataIndex:o[y].curi,text:o[y].NLS,visibleFlag:!1,children:w};g.push(x),x=null;break}}let r=t.removeAndGetcommonPredicatesFromAllTypes(g,n),a=[];for(let e=0;e<n.length;e++){let t=n[e];t.children&&t.children.forEach(e=>{e.ds6wIndexMapping&&a.push(e)}),t.ds6wIndexMapping&&a.push(t)}let l=a.map(e=>e.ds6wIndexMapping);for(let e of r)l.includes(e.dataIndex)||s.isColumnAlreadyExist(i.columns,e.dataIndex)||i.addColumnOrGroup(e);for(let e of l){let t=!1;for(let i=0;i<g.length;i++){for(let n=0;n<g[i].children.length;n++)if(g[i].children[n].dataIndex===e){g[i].children.splice(n,1),t=!0;break}if(!0===t)break}}for(let t of d){for(w=[],v=0;v<t.attrs.length;v++){var I=t.attrs[v],N="";switch(I.type){case"string":N="string";break;case"boolean":N="boolean";break;case"integer":case"real":case"number":N="number";break;case"dateTime":case"timestamp":N="datetime";break;default:N="string"}let i={dataIndex:I.curi,text:I.NLS,visibleFlag:!1,typeRepresentation:N,dataType:N,editableFlag:!1,allowUnsafeHTMLContent:!0,range:S.hasOwnProperty("rangeValues")};UWA.is(e.settings.aggregationRowRequired)&&!0===e.settings.aggregationRowRequired&&(i.compareFunction=function(t,i,n,r,a){if(n.options.grid.id!=e.settings.aggregationRowID&&r.options.grid.id!=e.settings.aggregationRowID){if(t>i)return 1;if(t==i)return 0;if(t<i)return-1}return!1},s.addAggregrationOnPredicate(i,e)),w.push(i),i=null}x={dataIndex:t.curi,text:t.NLS,visibleFlag:!1,children:w};g.push(x),x=null}for(let e of g)s.isColumnAlreadyExist(i.columns,e.dataIndex)||i.addColumnOrGroup(e)}else s.message("error",a.CUSTOM_ATTR_FED_SERVICE_DOWN),e.dgvDiv&&r.unmask(e.dgvDiv)}},getExtensionNLS:function(e,t){let i=t.substring(6),n=i;for(let t=0;t<e.results.length;t++){let r=e.results[t];if(r.interfaces)for(let e=0;e<r.interfaces.length;e++)if(i===r.interfaces[e].name){n=r.interfaces[e].nlsName;break}}return n},getExtensionsForClass:function(e,t){return new Promise(function(i,n){var r={classes:e},a=JSON.stringify(r);s.makeWSCallWithCSRF(t.settings.url+"/resources/dictionary/class/interfaces","POST","enovia","application/json",a,function(e){i(e)},n,t)})},getPropertyForClassGrid:function(e,t){return new Promise(function(n,r){let a=t.tenant;var s="en";widget&&widget.getValue("lang")&&(s=widget.getValue("lang"));let o={tenantId:a,lang:s,onComplete:function(e){n(e)},onFailure:function(e){n(e)}};i.getPropertiesForClass(e,o)})},removeAndGetcommonPredicatesFromAllTypes:function(e,t){let i=this;for(let t of e)t.children=i.uniqueBy(t.children,e=>e.dataIndex);let n=[];for(let t=0;t<e.length;t++){for(let i=0;i<e[t].children.length;i++){let r=e[t].children[i],a=!1;for(let i=0;i<e.length;i++)if(i!==t)for(let t=0;t<e[i].children.length;t++)if(r.dataIndex===e[i].children[t].dataIndex||UWA.is(e[i].children[t].ds6wIndexMapping)&&r.dataIndex===e[i].children[t].ds6wIndexMapping){a=!0,e[i].children.splice(t,1);break}!0===a?(n.push(r),e[t].children[i].isCommon=!0):e[t].children[i].isCommon=!1}let i=[];for(let n=0;n<e[t].children.length;n++)!1===e[t].children[n].isCommon&&i.push(e[t].children[n]);for(let e of i)delete e.isCommon;for(let e of n)delete e.isCommon;e[t].children=i}for(let i of t){for(let e=0;e<n.length;e++)if(i.dataIndex===n[e].dataIndex){n.splice(e,1);break}for(let t=0;t<e.length;t++)for(let n=0;n<e[t].children.length;n++)if(i.dataIndex===e[t].children[n].dataIndex){e[t].children.splice(n,1);break}}return n},updateAsynAttributeColumn:async function(e,t,i,n,a){var o=this;window.performance.now();s.getCustomAttributesWithUXService(e,t,n).then(function(t){let l=t.data;if(null!=l){Array.isArray(i)&&i.length>0&&i[0].getTreeDocument().prepareUpdate();const t=[...new Set(o.customAttributesList.map(e=>JSON.stringify(e)))].map(e=>JSON.parse(e));o.customInfo=t.reduce(function(e,t){return null!=t.rangeValues&&(e[t.uri]=t.rangeValues),e},{});for(let t=0;t<l.length;t++){let n=i.filter(e=>e.options.grid.id===l[t].id),r=[...e],d=l[t];if(Array.isArray(n)&&n.length>0){for(let e=0;e<n.length;e++)for(let t=0;t<r.length;t++){let i=s.getCustoColDef(a,r[t]),l=d[r[t]],g="";if(UWA.is(l)&&""!==l){if(i&&i.dataType)switch(i.dataType){case"integer":case"real":case"number":Array.isArray(l)&&(l=l.length>0?l[0]:""),""!==l&&(g=Number(l));break;case"dateTime":case"timestamp":Array.isArray(l)&&(l=l.length>0?l[0]:""),""!==l&&(g=new Date(l));break;case"string":if(o.customInfo&&o.customInfo[r[t]]){let e=o.getNLSAttributeValue(l,o.customInfo[r[t]]);0!=e.length&&(l=e)}if(Array.isArray(l))for(let e=0;e<l.length;e++)g+=l[e],e<=l.length-2&&(g+=",");else g=l;break;case"boolean":Array.isArray(l)&&(l=l.length>0?l[0]:""),g="TRUE"==l||"True"==l||"true"==l||"FALSE"!=l&&"False"!=l&&"false"!=l&&l;break;default:g=l}else console.log("Either Column Def or its Data type is undefined!");n[e].setAttribute(r[t],g)}}}}Array.isArray(i)&&i.length>0&&i[0].getTreeDocument().pushUpdate(),e.length>0&&n.dgvDiv&&r.unmask(n.dgvDiv)}})},getNLSAttributeValue:function(e,t){var i=[];return Array.isArray(e)||e.split(","),e.forEach(e=>{t.literalInfo.forEach(t=>{e.trim()==t.value.trim()?i.push(t.nlsValue):e=e})}),i},getCustomAttributesWithUXService:function(e,t,i){return new Promise(function(n,r){let a=[...e],o={data:[{physicalid:t,label:"custo attr fetch",select_predicate:a}]},l=JSON.stringify(o);s.makeWSCallWithCSRF(i.settings.url+"/resources/v1/chguxservices/connectedChange/genericResourceFetch","POST","enovia","application/json",l,function(e){let t={};n(t=e)},function(e){r(e)},i)})},makeWSCallWithCSRF:function(e,i,n,a,o,l,d,g){var u="application/json",c=(new Date).getTime();e=-1==e.indexOf("?")?e+"?tenant="+g.settings.tenant+"&timestamp="+c:e+"&tenant="+g.settings.tenant+"&timestamp="+c;var f=encodeURIComponent(g.settings.securityContext),m=g.settings.ENO_CSRF_TOKEN;l=l||function(){},d=d||function(){};var p=widget.getValue("lang");widget.lang&&(p=widget.lang);var h={};h.method=i,h.timeout=12e6,null!=g&&null!=g.isSwymUrl&&0!=g.isSwymUrl||(h.type="json"),g.settings.isNative?h.headers=f?{Accept:u,"Content-Type":a,SecurityContext:f,"Accept-Language":p,ENO_CSRF_TOKEN:m}:{Accept:u,"Content-Type":a,"Accept-Language":p}:(n&&(h.auth={passport_target:n}),h.proxy=window.UWA.Data.proxies.passport?"passport":"ajax",h.headers=f?{Accept:u,"Content-Type":a,SecurityContext:f,"Accept-Language":p,ENO_CSRF_TOKEN:m}:{Accept:u,"Content-Type":a,"Accept-Language":p}),null!=g&&null!=g.issueVersion&&""!=g.issueVersion&&(h.headers[g.issueVersion]=g.version),o&&(h.data=o),h.onComplete=function(e){var t=void 0;if(e.data&&Array.isArray(e.data)&&e.data[0]&&e.data[0]["error report"]&&Array.isArray(e.data[0]["error report"])){var i=e.data[0]["error report"],n="";t=[];for(var r=0;r<i.length;r++){var a=i[r];a&&a.message&&(n=n+a.message+"<br>"),a&&a.id&&t.push(a.id)}s.message("error",n),e.data.splice(0,1)}l(e,t)},h.onFailure=function(t,o){console.log("Error in calling url: "+e),console.log("Additional Details:: httpMethod: "+i+" authentication: "+n+" securityContext: "+f+" ContentType: "+a),console.log("Error Detail: "+t),console.log("Error Data: "+JSON.stringify(o)),o&&o.errorMessage?s.message("error",o.errorMessage):o&&o.error&&o.error.message?s.message("error",o.error.message):o&&o.internalError?s.message("error",o.internalError):o&&o.error?s.message("error",o.error):t&&t.message?s.message("error",t.message):s.message("error","Something went wrong, please check logs for more details"),d(t,o),widget.body&&r.unmask(widget.body)},h.onTimeout=function(){console.log("Timedout for url: "+e),s.message("error","Webservice Timedout, please refresh and try again"),widget.body&&r.unmask(widget.body)},t.authenticatedRequest(e,h)},getCSRFToken:function(e){return new Promise(function(t,i){s.makeWSCallWithCSRF(e.settings.url+"/resources/v1/application/CSRF","GET","enovia","application/json","",function(e){t(e.csrf.value)},i,e)})},message:function(e,t){this.alertCA=new n({closable:!0,visible:!0,autoHide:"error"!==e,hideDelay:5e3,className:"wp-alert"}).inject(document.body,"top"),this.alertCA.add({className:e,message:t})}};return s});