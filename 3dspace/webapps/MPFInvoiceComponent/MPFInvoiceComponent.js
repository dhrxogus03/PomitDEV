define("DS/MPFInvoiceComponent/InvoiceUploadModal",["UWA/Core","UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Modal","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/UIKIT/Input/Button","DS/UIKIT/Input/File","DS/MPFView/FieldTextInputV2","DS/MPFCartModel/CartModel","DS/MPFInvoiceModel/InvoiceDocumentModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFServices/ObjectService","i18n!DS/MPFInvoiceComponent/assets/nls/InvoiceComponent","css!DS/MPFUI/MPFUI","css!DS/MPFInvoiceComponent/MPFInvoiceComponent"],function(e,t,i,n,o,s,a,c,r,l,d,h,u,m){"use strict";const v=Object.freeze({INVOICE_UPLOADED:"invoiceUploaded"}),p=t.extend({setup:function(e){u.requiredOfPrototype(this.model,l,"options.model must be a CartModel"),u.requiredOfPrototype(e.invoiceDocument,d,"options.invoiceDocument must be an InvoiceDocumentModel"),this.cart=this.model,this.cartPayment=e.cartPayment,this.invoiceDocument=e.invoiceDocument,this.isPaymentPerPhase=e.isPaymentPerPhase,this.alert=this._createAlert(),this.warningMessage=this._createWarningMessage(),this.invoiceNumberField=this._createInvoiceNumberField(),this.invoiceFileField=this._createInvoiceFileField(),this.saveButton=this._createSaveButton(),this.cancelButton=this._createCancelButton(),this.modal=this._createModal()},render:function(){const e=[this.alert,this.warningMessage,this.invoiceNumberField.render(),this.invoiceFileField],t=[this.saveButton,this.cancelButton];return this.modal.setBody(e),this.modal.setFooter(t),this.modal.show(),this},validate:function(){const e=this.invoiceNumberField.validate().isValid,t=this._validateIvoiceFileField();return e&&t},save:function(){o.mask(this.modal.getBody()),this.saveButton.load(),this.cancelButton.disable(),this.validate()?this._saveSelectedFile().then(this._saveCartOrPayment.bind(this)).then(()=>{o.unmask(this.modal.getBody()),this.saveButton.load(!1),this.cancelButton.enable(),this.modal.hide(),i.publish("MPCartTimeline",{event:"refresh",cartId:this.cart.get("id")}),this.dispatchEvent(v.INVOICE_UPLOADED)}).catch(()=>{o.unmask(this.modal.getBody()),this.saveButton.load(!1),this.cancelButton.enable(),this.alert.add({className:"error",visible:!0,message:m.get("anErrorOccured")})}):(o.unmask(this.modal.getBody()),this.saveButton.load(!1),this.cancelButton.enable())},reset:function(){this.invoiceNumberField.resetValue(),this.fileInput.clear(),this._removeRedBorders()},destroy:function(){this.modal.destroy(),this.invoiceNumberField.destroy(),this.cart=null,this.invoiceDocument=null,this._parent(),this.container=null},_saveSelectedFile:function(){const e=this.fileInput.getContent().getElement("input").files[0];return this.invoiceDocument.saveFile(e)},_saveCart:function(){return this.cart.savePromise({[l.Fields.BUYER_INVOICE_DOCUMENT_PID]:this.invoiceDocument.id,[l.Fields.BUYER_INVOICE_NUMBER]:this.invoiceNumberField.getValue()},{patch:!0})},_savePayment:function(){return this.cartPayment.savePromise({[h.Fields.BUYER_INVOICE_DOCUMENT_PID]:this.invoiceDocument.id,[l.Fields.BUYER_INVOICE_NUMBER]:this.invoiceNumberField.getValue()},{patch:!0})},_saveCartOrPayment:function(){return this.isPaymentPerPhase?this._savePayment():this._saveCart()},_createAlert:function(){return new s({closable:!0,visible:!0,autoHide:!0,maximumVisibleMessages:2})},_createWarningMessage:function(){return e.createElement("div",{class:"alert-message alert-warning alert-has-icon",html:[{tag:"span",class:"icon fonticon"},{tag:"span",text:m.get("uploadWarning")}]})},_createInvoiceNumberField:function(){return new r({model:this.cart,fieldName:l.Fields.BUYER_INVOICE_NUMBER,fieldLabel:m.get("invoiceNumber"),required:!0,readOnly:!1,dynamicValidation:!0})},_createInvoiceFileField:function(){return this.fileInput=new c({buttonText:m.get("invoiceFile"),events:{onChange:this._validateIvoiceFileField.bind(this)}}),e.createElement("div",{class:"mpf-invoice-file-input mpf-entry-v2",html:[{tag:"label",html:[{tag:"span",class:"mpf-label",html:[m.get("invoiceOrderDocument"),'&nbsp;<span class="mpf-required">*</span>']},this.fileInput]}]})},_createSaveButton:function(){return new a({className:"primary",value:m.get("uploadInvoice"),events:{onClick:this.save.bind(this)}})},_createCancelButton:function(){return new a({value:m.get("cancel"),events:{onClick:()=>{this.modal.hide()}}})},_createModal:function(){return new n({renderTo:document.body,header:m.get("invoiceUpload"),className:"mpf-invoice-upload-modal",events:{onHide:this.reset.bind(this)}})},_validateIvoiceFileField:function(){const e=!!this.fileInput.getValue();return e?this.invoiceFileField.removeClassName("mpf-invalid"):this.invoiceFileField.addClassName("mpf-invalid"),e},_removeRedBorders:function(){this.invoiceFileField.removeClassName("mpf-invalid")}});return p.Events=v,p}),define("DS/MPFInvoiceComponent/ProceedToPaymentNoticeComponent",["UWA/Class/View","DS/MPFNoticeComponent/ImportantNoticeComponent","i18n!DS/MPFInvoiceComponent/assets/nls/InvoiceComponent"],function(e,t,i){"use strict";return e.extend({setup:function(e={}){this.showExplanationLink=!1!==e.showExplanationLink,this.notice=this._createNotice()},render:function(){return this.container.setContent(this.notice.render()),this},destroy:function(){this.notice.destroy(),this.notice=null,this._parent(),this.container=null},_createNotice:function(){return new t({message:i.get("proceedToPayment"),linkText:this.showExplanationLink?i.get("learnMoreAboutDifferedPayment"):null,linkUrl:this.showExplanationLink?"/faq/proceed-to-deferred-payment":null})}})}),define("DS/MPFInvoiceComponent/InvoiceUploadNoticeComponent",["UWA/Class/View","DS/MPFNoticeComponent/ImportantNoticeComponent","DS/MPFInvoiceComponent/InvoiceUploadModal","DS/MPFCartModel/CartModel","DS/MPFInvoiceModel/InvoiceDocumentModel","DS/MPFServices/ObjectService","i18n!DS/MPFInvoiceComponent/assets/nls/InvoiceComponent"],function(e,t,i,n,o,s,a){"use strict";const c=Object.freeze({INVOICE_UPLOADED:"invoiceUploaded"}),r=e.extend({setup:function(e){s.requiredOfPrototype(this.model,n,"options.model must be a CartModel"),s.requiredOfPrototype(e.invoiceDocument,o,"options.invoiceDocument must be a InvoiceDocumentModel"),this.cart=this.model,this.cartPayment=e.cartPayment,this.invoiceDocument=e.invoiceDocument,this.purchaseOrder=e.purchaseOrder,this.isPaymentPerPhase=e.isPaymentPerPhase,this.showExplanationLink=!1!==e.showExplanationLink,this.notice=this._createNotice(),this.modal=this._createModal(),this.listenTo(this.notice,t.Events.BUTTON_CLICKED,this._showModal.bind(this)),this.listenTo(this.modal,i.Events.INVOICE_UPLOADED,this._onInvoiceUploaded.bind(this))},render:function(){return this.container.setContent([this.notice.render(),this.modal]),this},destroy:function(){this.stopListening(),this.notice.destroy(),this.modal.destroy(),this.notice=null,this.modal=null,this.cart=null,this.cartPayment=null,this.invoiceDocument=null,this._parent(),this.container=null},_showModal:function(){this.modal.render()},_onInvoiceUploaded:function(){this.dispatchEvent(c.INVOICE_UPLOADED)},_createNotice:function(){return new t({message:[{tag:"p",text:a.get("invoicePaymentNoticeMessage")},{tag:"p",text:a.get("invoiceInfoNoticeMessage",this.purchaseOrder.getNumber(),this.purchaseOrder.getLabel())}],linkUrl:this.showExplanationLink?"/faq/proceed-to-deferred-payment":null,linkText:this.showExplanationLink?a.get("learnMoreAboutDifferedPayment"):null,buttonLabel:a.get("uploadInvoice")})},_createModal:function(){return new i({model:this.cart,cartPayment:this.cartPayment,invoiceDocument:this.invoiceDocument,isPaymentPerPhase:this.isPaymentPerPhase})}});return r.Events=c,r});