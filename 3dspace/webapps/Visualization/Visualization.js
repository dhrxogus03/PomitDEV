/*!  COPYRIGHT DASSAULT SYSTEMES 2014   */
/*! based on Three.js Copyright Â© 2010-2014 three.js authors */
/*! Uses SMAA. Copyright (C) 2011 by Jorge Jimenez, Jose I. Echevarria,
Belen Masia, Fernando Navarro and Diego Gutierrez. */
define("DS/Visualization/Layers",["DS/Mesh/ThreeJS_Base"],function(e){function t(e,t){if(t<=e.getPrimitiveStart(0))return 0;for(var i,r=e.getPrimitivesCount()-1,n=0;r-n>1;)i=Math.floor((r+n)/2),e.getPrimitiveStart(i)<t?n=i:r=i;return r}const i=e.__visibleInCurrentSpaceSimple;var r=function(e,t,i,r,n,s,a){this.layerNum=e||0,this.material=r||null,this.gas=null,n&&(this.gas=n.__getGAS(this.gas)),this.start=t||0,this.count=i||0,this.primitiveStart=0,this.primitiveCount=0,this.primitiveOverrideMaterial=s||null,this.noZ=void 0!==a?a:-1};r.prototype={constructor:r,clone:function(){var e=new r(this.layerNum,this.start,this.count,this.material,this.gas,void 0,this.noZ);return e.primitiveStart=this.primitiveStart,e.primitiveCount=this.primitiveCount,e},skip:function(e,t){return this.layerNum<=0||!!e&&(this.gas&&this.gas.isGAS?!this.gas.visibleInCurrentSpace(e,t):!i(e.visible,e.visibilityFree,t,null))},getMaterial:function(){return this.primitiveOverrideMaterial?this.primitiveOverrideMaterial:this.material}};var n=function(e,t,i){this.geometry=void 0!==e?e:null,this.drawableGroup=void 0!==t?t:null,this.drawableInterval=void 0!==i?i:null};n.prototype={constructor:n,clone:function(){var e=new n;return e.geometry=this.geometry,e.drawableGroup=this.drawableGroup,e.drawableInterval=this.drawableInterval.clone(),e},_computeOrientedBoundingBox:function(t){var i=!0,r=this.drawableInterval,n=this.geometry,s=n.vertexIndexArray,a=new e.Vector3,o=new e.Vector3,l=new e.Vector3;if(r.layerNum&&r.count){var h=r.start,c=r.start+r.count;if(i){i=!1;var d=s[h];n.getVertexPosition(d,l),a.set(l.x,l.y,l.z).applyMatrix4(t),o.set(l.x,l.y,l.z).applyMatrix4(t)}for(var u=h;u<c;u++){d=s[u];n.getVertexPosition(d,l),l.applyMatrix4(t),l.x<a.x&&(a.x=l.x),l.y<a.y&&(a.y=l.y),l.z<a.z&&(a.z=l.z),l.x>o.x&&(o.x=l.x),l.y>o.y&&(o.y=l.y),l.z>o.z&&(o.z=l.z)}}return new e.Box3(a,o)}};var s=function(e){this.layers=[],this.upToDate=!1,this.mesh=e};return s.prototype={constructor:s,clone:function(e){for(var t=new s(this.mesh),i=0;i<this.layers.length;i++){var r=this.layers[i].clone();e&&(r.drawableInterval.layerNum=0),t.addLayerInterval(r)}return t},getIntervals:function(e,t,i){for(var r=[],n=0;n<this.layers.length;n++){var s=this.layers[n];s.geometry!==e||t&&s.drawableGroup!==t||r.push(i?s:s.drawableInterval)}return r},getInterval:function(e){for(var t=e.group,i=t.geometry,r=this.getIntervals(i,t),n=0;n<r.length;n++){var s=r[n];if(e.start>=s.start&&e.start+e.count<=s.start+s.count)return s}return null},addLayerInterval:function(e){this.layers.push(e),this.upToDate=!1},removeIntervals:function(e,t){for(var i=void 0!==t,r=0;r<this.layers.length;r++){var n=this.layers[r];n.geometry==e&&(!i||i&&n.drawableGroup==t)&&(this.layers.splice(r,1),r--)}this.upToDate=!1},addPrimitivesToLayersOpacity:function(e,t,i){var r=[];this.addPrimitivesToLayers_internal(e,t,function(e){var t=r[e.id];return t||((t=e.clone()).opacity=i,t.transparent=!0,r[e.id]=t),t}),this.upToDate=!1},addPrimitivesToLayers:function(e,t,i,r,n,s){this.addPrimitivesToLayers_internal(e,t,function(){return i},r,n,s),this.upToDate=!1},addPrimitivesToLayers_internal:function(e,t,i,r,n,s){var a;this.mesh._flagAsGSSOInvalidated();var o=new Map;for(a=0;a<e.length;a++){var l=e[a],h=l.getGroup(),c=o.get(h);c||(c=[],o.set(h,c)),c.push(l)}var d=[];for(o.forEach((e,t)=>{d.push(e)}),a=0;a<d.length;a++)d[a].sort(function(e,t){return e.getStart()<t.getStart()?-1:e.getStart()>t.getStart()?1:0});for(a=0;a<d.length;a++){var u=d[a][0].getGroup(),p=u.geometry,f=i(u.gas);this.addPrimitivesToLayer(p,u,d[a],t,f,r,n,s)}},addPrimitivesToLayer:function(e,i,s,a,o,l,h,c){var d,u,p=this.getIntervals(e,i,!0),f=[],g=function(e){return l?l.__getGAS(e):e};if(p.length){var m=0,v=p[m].drawableInterval,_=g(v.gas),y=void 0===o?v.material:o,S=void 0===h?v.primitiveOverrideMaterial:h,x=void 0===c?v.noZ:c;d=v.start,u=v.count;var b=0,w=!0;for(E=0;E<s.length;E++){var M=(T=s[E]).getStart(),C=T.getCount();if(C&&(w||b!==M)){for(w=!1,b=M;M+C>d+u;)u&&f.push(new r(v.layerNum,d,u,v.material,v.gas,v.primitiveOverrideMaterial,v.noZ)),_=g((v=p[++m].drawableInterval).gas),y=void 0===o?v.material:o,S=void 0===h?v.primitiveOverrideMaterial:h,x=void 0===c?v.noZ:c,d=v.start,u=v.count;if(a!==v.layerNum||y!==v.material||_!==v.gas||S!==v.primitiveOverrideMaterial||x!==v.noZ){M>d&&f.push(new r(v.layerNum,d,M-d,v.material,v.gas,v.primitiveOverrideMaterial,v.noZ)),f.push(new r(a,M,C,y,_,S,x));var P=M+C;u=v.count-P+v.start,d=P}}}u>0&&f.push(new r(v.layerNum,d,u,v.material,v.gas,v.primitiveOverrideMaterial,v.noZ));for(var E=m+1;E<p.length;E++)f.push(p[E].drawableInterval);this.removeIntervals(e,i)}else for(E=0;E<s.length;E++){var T=s[E];f.push(new r(a,T.start,T.count,o||null,l||null,h||null,c))}var A=f[0].layerNum,D=f[0].material,I=f[0].gas,R=f[0].primitiveOverrideMaterial,O=f[0].noZ;for(d=f[0].start,u=0,E=0;E<f.length;E++){var L=f[E];if(L.layerNum===A&&L.material===D&&L.gas===I&&L.primitiveOverrideMaterial===R&&L.noZ===O)u+=L.count;else{var V=new r(A,d,u,D,I,R,O);this.addLayerInterval(new n(e,i,V)),A=L.layerNum,D=L.material,R=L.primitiveOverrideMaterial,I=L.gas,O=L.noZ,d=L.start,u=L.count}if(E==f.length-1){V=new r(A,d,u,D,I,R,O);this.addLayerInterval(new n(e,i,V))}}for(E=0;E<this.layers.length;E++){var F=this.layers[E],B=F.drawableGroup;if(B===i&&F.geometry===e){var N=F.drawableInterval,G=0,k=B.getPrimitivesCount();if(k){if(k<20)for(;N.start>B.getPrimitiveStart(G);)G++;else G=t(B,N.start);for(N.primitiveStart=G;N.start+N.count>B.getPrimitiveStart(G)+B.getPrimitiveCount(G);)G++;N.primitiveCount=G-N.primitiveStart+1}else N.primitiveStart=0,N.primitiveCount=0}}},setDGToLayer:function(e,t,i,r,n,s,a){for(var o=this.getIntervals(e,t),l=0;l<o.length;l++){var h=o[l];void 0!==i&&(h.layerNum=i),void 0!==r&&(h.material=r),void 0!==n&&(h.gas=n.__getGAS(h.gas)),void 0!==a&&(h.noZ=a),void 0!==s&&(h.primitiveOverrideMaterial=s)}}},{DrawableInterval:r,LayerInterval:n,BufferLayer:s}});var Stats=function(){var e,t,i,r,n,s,a,o,l=0,h=0,c=Date.now(),d=c,u=c,p=0,f=1e3,g=0,m=[[16,16,48],[0,255,255]],v=0,_=1e3,y=0,S=[[16,48,16],[0,255,0]];for((e=document.createElement("div")).style.cursor="pointer",e.style.width="80px",e.style.opacity="0.9",e.style.zIndex="10001",e.addEventListener("mousedown",function(e){e.preventDefault(),0==(l=(l+1)%2)?(i.style.display="block",s.style.display="none"):(i.style.display="none",s.style.display="block")},!1),(i=document.createElement("div")).style.textAlign="left",i.style.lineHeight="1.2em",i.style.backgroundColor="rgb("+Math.floor(m[0][0]/2)+","+Math.floor(m[0][1]/2)+","+Math.floor(m[0][2]/2)+")",i.style.padding="0 0 3px 3px",e.appendChild(i),(r=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",r.style.fontSize="9px",r.style.color="rgb("+m[1][0]+","+m[1][1]+","+m[1][2]+")",r.style.fontWeight="bold",r.innerHTML="FPS",i.appendChild(r),(n=document.createElement("div")).style.position="relative",n.style.width="74px",n.style.height="30px",n.style.backgroundColor="rgb("+m[1][0]+","+m[1][1]+","+m[1][2]+")",i.appendChild(n);n.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height="30px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+m[0][0]+","+m[0][1]+","+m[0][2]+")",n.appendChild(t);for((s=document.createElement("div")).style.textAlign="left",s.style.lineHeight="1.2em",s.style.backgroundColor="rgb("+Math.floor(S[0][0]/2)+","+Math.floor(S[0][1]/2)+","+Math.floor(S[0][2]/2)+")",s.style.padding="0 0 3px 3px",s.style.display="none",e.appendChild(s),(a=document.createElement("div")).style.fontFamily="Helvetica, Arial, sans-serif",a.style.fontSize="9px",a.style.color="rgb("+S[1][0]+","+S[1][1]+","+S[1][2]+")",a.style.fontWeight="bold",a.innerHTML="MS",s.appendChild(a),(o=document.createElement("div")).style.position="relative",o.style.width="74px",o.style.height="30px",o.style.backgroundColor="rgb("+S[1][0]+","+S[1][1]+","+S[1][2]+")",s.appendChild(o);o.children.length<74;)(t=document.createElement("span")).style.width="1px",t.style.height=30*Math.random()+"px",t.style.cssFloat="left",t.style.backgroundColor="rgb("+S[0][0]+","+S[0][1]+","+S[0][2]+")",o.appendChild(t);return{domElement:e,update:function(){c=Date.now(),v=c-d,_=Math.min(_,v),y=Math.max(y,v),a.textContent=v+" MS ("+_+"-"+y+")";var e=Math.min(30,30-v/200*30);o.appendChild(o.firstChild).style.height=e+"px",d=c,h++,c>u+1e3&&(p=Math.round(1e3*h/(c-u)),f=Math.min(f,p),g=Math.max(g,p),r.textContent=p+" FPS ("+f+"-"+g+")",e=Math.min(30,30-p/100*30),n.appendChild(n.firstChild).style.height=e+"px",u=c,h=0)}}};define("DS/Visualization/Info",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0};t.prototype.reset=function(){this.programs=0,this.geometries=0,this.textures=0,this.renderTargets=0,this.sharedbuffers=0};const i=function(e){this.name=e||"",this._duration=0,this._parent=null,this.children=[]};i.prototype.push=function(e){e._parent=this,this.children.push(e)},i.prototype.start=function(){this._duration=performance.now()},i.prototype.end=function(){this._duration=performance.now()-this._duration};const r=function(){this.activated=!1,this.curNode=null,this.frameTypeMap=new Map};r.prototype.enable=function(e){this.activated=e,this.curNode=null,e&&this.frameTypeMap.clear()},r.prototype.pushRoot=function(e){this.activated&&(this.curNode=new i,this.frameTypeMap.set(e,this.curNode),this.curNode.start())},r.prototype.popRoot=function(){this.activated&&(this.curNode&&this.curNode.end(),this.curNode=null)},r.prototype.push=function(e){if(this.curNode){var t=new i(e);this.curNode.push(t),this.curNode=t,this.curNode.start()}},r.prototype.pop=function(){this.curNode&&(this.curNode.end(),this.curNode=this.curNode._parent)};const n=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0,this.nbRenderCuttingElement=0};return n.prototype.reset=function(){this.calls=0,this.vertices=0,this.faces=0,this.lines=0,this.points=0,this.objectUniformCalls=0,this.swapMaterials=0,this.swapPrograms=0,this.swapBuffers=0,this.unsharedBuffers=0,this.swapScenes=0,this.cullingCalls=0,this.culledMeshes=0,this.culledGeometries=0,this.culledDGTriangles=0,this.culledDGLines=0,this.nbDGs=0,this.nbReps=0,this.nbDGsSSBProcessed=0,this.nbRenderCuttingElement=0},n.prototype.getRendering=function(){return{swapMaterials:this.swapMaterials,swapPrograms:this.swapPrograms,swapScenes:this.swapScenes,objectUniformCalls:this.objectUniformCalls,swapBuffers:this.swapBuffers,unsharedBuffers:this.unsharedBuffers,nbRenderCuttingElement:this.nbRenderCuttingElement}},n.prototype.getGeometries=function(){return{calls:this.calls,vertices:this.vertices,faces:this.faces,lines:this.lines,points:this.points,nbDGs:this.nbDGs,nbReps:this.nbReps,nbDGsSSBProcessed:this.nbDGsSSBProcessed}},n.prototype.getCulling=function(){return{cullingCalls:this.cullingCalls,culledMeshes:this.culledMeshes,culledGeometries:this.culledGeometries,culledDGTriangles:this.culledDGTriangles,culledDGLines:this.culledDGLines}},{MemoryInfo:t,RenderTimeInfo:r,RenderInfo:n}}),define("DS/Visualization/JSONReader",["DS/VisuLoaders/JSONReader"],function(e){"use strict";return e}),define("Visualization/JSONReader",["DS/Visualization/JSONReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/JSONReader"),e}),define("DS/Visualization/SubsurfaceGenerator",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t=function(){this.computedTextures=new Map,this.size=64,this.radiusR=null,this.depthR=null,this.radiusG=null,this.depthG=null,this.radiusB=null,this.depthB=null;var e=this.utilities.linspace(-1,1,this.size);this.theta=this.utilities.applyToArray(e,function(e){return Math.acos(e)}),this.sinTheta=this.utilities.applyToArray(this.theta,function(e){return e>.5*Math.PI?0:Math.sin(e)}),this.aux=Math.PI*Math.PI*Math.sqrt(.31830988618)/this.size};return t.prototype={constructor:t,modelFunction:function(e){var t=e.scatteringCoeffs,i=Math.max(Math.min(e.subsurfaceAnisotropy,.99),-.99);t=this.utilities.applyToArray(t,function(e){return e*(1-i)});var r=this.utilities.sumArray(e.absorptionCoeffs,t),n=this.utilities.applyToArray(this.utilities.multiplyArray(e.absorptionCoeffs,r),function(e){return Math.sqrt(3*e)}),s=-1.44/(e.eta*e.eta)+.71/e.eta+.668+.0636*e.eta,a=(1+s)/(1-s),o=this.utilities.applyToArray(r,function(e){return 1/Math.max(e,1e-20)}),l=this.utilities.applyToArray(o,function(e){return 4*a/3*e}),h=this.utilities.applyToArray(o,function(e){return 5*e});this.depthR=this.utilities.linspace(0,15*o[0],this.size),this.radiusR=this.utilities.linspace(.5*o[0],7.5*o[0],this.size),this.depthG=this.utilities.linspace(0,15*o[1],this.size),this.radiusG=this.utilities.linspace(.5*o[1],7.5*o[1],this.size),this.depthB=this.utilities.linspace(0,15*o[2],this.size),this.radiusB=this.utilities.linspace(.5*o[2],7.5*o[2],this.size);var c=this.utilities.multiplyArray(t,o),d=function(e,t){return(t*e+1)*Math.exp(-t*e)/(e*e*e)},u=.25/Math.PI,p=function(e,t){for(var i=n[e],r=o[e],s=l[e],a=h[e],p=0,f=-2;f<=2;f++){var g=2*f*(a+s),m=g+r,v=g-r-s,_=Math.sqrt(t*t+m*m),y=Math.sqrt(t*t+v*v);p+=m*d(_,i)-v*d(y,i)}var S=c[e];return p*u*S};return{red:function(e){return p(0,e)},green:function(e){return p(1,e)},blue:function(e){return p(2,e)}}},sssLUTBuilder:function(e,t,i){return this.utilities.integrate(function(r){var n=t*Math.abs(2*Math.sin(.5*r));return Math.max(Math.cos(i+r),0)*e(n)},-Math.PI,Math.PI)/Math.max(this.utilities.integrate(function(i){var r=t*Math.abs(2*Math.sin(.5*i));return e(r)},-Math.PI,Math.PI),1e-20)},translucencyLUTBuilder:function(e,t,i){return this.utilities.integrateT(function(i){return 2*Math.PI*i*e(Math.sqrt(i*i+t*t))},i[this.size-1])},setTexture:function(t,i,r){var n=new e.DataTexture(t,i,r,e.RGBFormat,e.FloatType);return n.minFilter=e.LinearFilter,n.magFilter=e.LinearFilter,n.generateMipmaps=!1,n.flipY=!1,n.needsUpdate=!0,n},decreaseUseCount:function(e){if(this.computedTextures.has(e)){var t=this.computedTextures.get(e);t.useCount--,0===t.useCount&&(t.textures.sssLUT.dispose(),this.computedTextures.delete(e))}},dispose:function(){this.computedTextures.forEach(function(e,t,i){e.textures.sssLUT.dispose()}),this.computedTextures.clear()},_getComputedTextures:function(e){var t=-1;return this.computedTextures.forEach(function(i,r,n){var s,a,o,l,h,c,d;s=i.options,a=e,o=Math.abs(s.scatteringCoeffs[0]-a.scatteringCoeffs[0])<1e-6&&Math.abs(s.scatteringCoeffs[1]-a.scatteringCoeffs[1])<1e-6&&Math.abs(s.scatteringCoeffs[2]-a.scatteringCoeffs[2])<1e-6,l=Math.abs(s.absorptionCoeffs[0]-a.absorptionCoeffs[0])<1e-6&&Math.abs(s.absorptionCoeffs[1]-a.absorptionCoeffs[1])<1e-6&&Math.abs(s.absorptionCoeffs[2]-a.absorptionCoeffs[2])<1e-6,h=Math.abs(s.color[0]-a.color[0])<1e-6&&Math.abs(s.color[1]-a.color[1])<1e-6&&Math.abs(s.color[2]-a.color[2])<1e-6,c=Math.abs(s.eta-a.eta)<1e-6,d=Math.abs(s.subsurfaceAnisotropy-a.subsurfaceAnisotropy)<1e-6,o&&l&&c&&h&&d&&(i.useCount++,t=r)}),t>-1?this.computedTextures.get(t).textures:null},compute:function(t){var i=this._getComputedTextures(t);if(null!==i)return i;for(var r=Date.now(),n=this.modelFunction(t),s=this.size+2+3+2+3,a=new Float32Array(this.size*s*3),o=this.size+2,l=this.size+7,h=t.color,c=0;c<this.size;c++){for(var d=this.radiusR[c],u=this.radiusG[c],p=this.radiusB[c],f=0,g=0,m=0,v=0;v<this.size;v++){var _,y,S,x=this.theta[v];_=h[0]*this.sssLUTBuilder(n.red,d,x),S=h[1]*this.sssLUTBuilder(n.green,u,x),y=h[2]*this.sssLUTBuilder(n.blue,p,x),a[3*this.size*c+3*v+0]=_,a[3*this.size*c+3*v+1]=S,a[3*this.size*c+3*v+2]=y,c==this.size-1&&(a[3*this.size*this.size+3*v+0]=_,a[3*this.size*this.size+3*v+1]=S,a[3*this.size*this.size+3*v+2]=y),f+=_*this.sinTheta[v],g+=S*this.sinTheta[v],m+=y*this.sinTheta[v]}f*=this.aux,g*=this.aux,m*=this.aux;for(var b=this.depthR[c],w=this.depthG[c],M=this.depthB[c],C=this.translucencyLUTBuilder(n.red,b,this.depthR),P=this.translucencyLUTBuilder(n.green,w,this.depthG),E=this.translucencyLUTBuilder(n.blue,M,this.depthB),T=0;T<3;T++){var A=this.size*(o+T);a[3*A+3*c+0]=f,a[3*A+3*c+1]=g,a[3*A+3*c+2]=m;var D=this.size*(l+T);a[3*D+3*c+0]=C,a[3*D+3*c+1]=P,a[3*D+3*c+2]=E}}var I=this.setTexture(a,this.size,this.size+5+5),R=Date.now();e.VisualizationTraces.info((R-r)/1e3);var O={sssLUT:I,translucencyDepth:[this.depthR[this.size-1],this.depthG[this.size-1],this.depthB[this.size-1]]};return this.computedTextures.set(I.id,{textures:O,options:{eta:t.eta,absorptionCoeffs:t.absorptionCoeffs.slice(0),scatteringCoeffs:t.scatteringCoeffs.slice(0),subsurfaceAnisotropy:t.subsurfaceAnisotropy,color:t.color.slice(0)},useCount:1}),O},toImage:function(){var e=document.createElement("canvas");document.body.appendChild(e);var t=e.getContext("2d"),i=this;this.computedTextures.forEach(function(r,n,s){!function(r,n,s,a){e.height=s,e.width=n;for(var o=0;o<s;++o)for(var l=0;l<n;++l)t.fillStyle="rgb("+255*r[3*i.size*o+3*l]+", "+255*r[3*i.size*o+3*l+1]+",+"+255*r[3*i.size*o+3*l+2]+")",t.fillRect(l,o,1,1);var h=e.toDataURL("image/png"),c=document.createElement("a");c.download=a,c.innerHTML="Download File",c.href=h,c.click()}(r.textures.sssLUT.image.data,r.textures.sssLUT.image.width,r.textures.sssLUT.image.height,"sssLUT")})},utilities:{linspace:function(e,t,i){var r=Math.floor(i);if(r<=1)return[t];for(var n=(t-e)/(i-1),s=[],a=0;a<r;a++)s[a]=e+a*n;return s},sumElements:function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t},multiplyArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]*t[n];return r},sumArray:function(e,t){for(var i=Math.min(t.length,e.length),r=[],n=0;n<i;n++)r[n]=e[n]+t[n];return r},applyToArray:function(e,t){for(var i=[],r=0;r<e.length;r++)i[r]=t(e[r]);return i},integrate:function(e,t,i){var r=this.linspace(t,i,120),n=this.applyToArray(r,e);return.5*(i-t)/120*(2*this.sumElements(n)-n[119]-n[0])},integrateT:function(e,t){var i=this.linspace(0,t,1e3),r=this.applyToArray(i,e);return.5*t/1e3*(2*this.sumElements(r)-r[999]-r[0])}}},t}),define("DS/Visualization/CGRReader",["DS/VisuLoaders/CGRReader"],function(e){"use strict";return e}),define("Visualization/CGRReader",["DS/Visualization/CGRReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/CGRReader"),e}),define("DS/Visualization/WidelinesHelper",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],function(e,t){"use strict";return{_computeLineDistances:function(t,i){for(var r,n,s=[],a=t.vertexIndexArray,o=i&&i.length===a.length,l=new e.Vector3,h=new e.Vector3,c=0;c<t.drawingGroups.length;c++)for(var d=t.drawingGroups[c],u=d.start,p=d.count,f=0;f<p;f++){var g=f+u,m=0;if(o&&(m=i[g]),f>0){if((r=a[g])===(n=a[g-1]))continue;t.getVertexPosition(r,l),t.getVertexPosition(n,h);var v=l.distanceTo(h);Math.abs(v)>1e-6&&!(f%2)?(s[2*r]=m,s[2*r+1]=m):(s[2*r]=m+v+s[2*n],s[2*r+1]=m+v+s[2*n])}else{var _=a[g];s[2*_]=m,s[2*_+1]=m}}t.needsUpdate=!0,t.vertexLineDistancesArray=new Float32Array(s)},_computeWideLineDistances:function(e){this._computeLineDistances(e.wideLinesLinker.parentGeometry,[]);for(var t=[],i=e.wideLinesLinker.parentGeometry.vertexLineDistancesArray,r=e.wideLinesLinker.lineStructureMap,n=0;n<e.drawingGroups.length;n++)for(var s=e.drawingGroups[n],a=r.get(s),o=a.sides,l=a.primitives,h=0,c=0;c<l.length;c++)for(var d=l[c],u=0;u<d.length;u++)for(var p=d[u],f=!p.endLine&&!p.begLine||p.isLoopedWith||p.fusedWith?4:2,g=0;g<f;g++){var m=i[2*p.cur];if(o[h]%2==0)if(t.push(m),p.isLoopedWith)t.push(m);else if(p.fusedWith){var v=l[p.fusedWith.primIndex][0];v=i[2*v.cur],Math.abs(v-m)<1e-6?t.push(i[2*p.next]):t.push(m)}else t.push(i[2*p.next]);else t.push(i[2*p.prev]),t.push(m);h++}e.needsUpdate=!0,e.vertexLineDistancesArray=new Float32Array(t)},_computePixelLineDistances:function(t,i,r,n){var s=new e.Matrix4;s.multiplyMatrices(r,i);var a=!!t.vertexLinePixelDistancesArray,o=!t.cpuPatternMatrix||!t.cpuPatternMatrix.equals(s);if(a&&!o)return!1;t.cpuPatternMatrix=s;for(var l,h,c=[],d=t.vertexIndexArray,u=new e.Vector4,p=new e.Vector4,f=new e.Vector2,g=new e.Vector2,m=0;m<t.drawingGroups.length;m++)for(var v=t.drawingGroups[m],_=v.start,y=0,S=v.count;y<S;y++){var x=y+_;if(y>0){if((l=d[x])===(h=d[x-1]))continue;t.getVertexPosition(l,u),t.getVertexPosition(h,p);var b=u.distanceTo(p);if(Math.abs(b)>1e-6&&!(y%2))c[2*l]=0,c[2*l+1]=0;else{u.w=1,u.applyMatrix4(s),p.w=1,p.applyMatrix4(s),f.x=.5*(u.x/u.w+1)*n.width,f.y=.5*(u.y/u.w+1)*n.height,g.x=.5*(p.x/p.w+1)*n.width,g.y=.5*(p.y/p.w+1)*n.height;var w=f.distanceTo(g);c[2*l]=w+c[2*h],c[2*l+1]=w+c[2*h]}}else{var M=d[x];c[2*M]=0,c[2*M+1]=0}}return t.needsUpdate=!0,t.vertexLinePixelDistancesArray=new Float32Array(c),!0},_computePixelWideLineDistances:function(e,t,i,r){var n=!!e.vertexLinePixelDistancesArray,s=this._computePixelLineDistances(e.wideLinesLinker.parentGeometry,t,i,r);if(n&&!s)return!1;e.cpuPatternMatrix=e.wideLinesLinker.parentGeometry.cpuPatternMatrix;for(var a=[],o=e.wideLinesLinker.parentGeometry.vertexLinePixelDistancesArray,l=e.wideLinesLinker.lineStructureMap,h=0;h<e.drawingGroups.length;h++)for(var c=e.drawingGroups[h],d=l.get(c),u=d.sides,p=d.primitives,f=0,g=0;g<p.length;g++)for(var m=p[g],v=0;v<m.length;v++)for(var _=m[v],y=!_.endLine&&!_.begLine||_.isLoopedWith||_.fusedWith?4:2,S=0;S<y;S++){var x=o[2*_.cur];if(u[f]%2==0)if(a.push(x),_.isLoopedWith)a.push(x);else if(_.fusedWith){var b=p[_.fusedWith.primIndex][0];b=o[2*b.cur],Math.abs(b-x)<1e-6?a.push(o[2*_.next]):a.push(x)}else a.push(o[2*_.next]);else a.push(o[2*_.prev]),a.push(x);f++}return e.needsUpdate=!0,e.vertexLinePixelDistancesArray=new Float32Array(a),!0},_computeWideLineDG:function(i,r,n,s,a){var o=i.wideLinesLinker,l=o.originalDGToWideDG.get(n);if(l)return l;if(!i.vertexIndexArray)return null;l=new t.DrawingGroup,n instanceof t.DrawingGroup?l=n.clone():(l.gas=n.gas,l.gasIndex=n.gasIndex,l._geomType=n._geomType,l.layers=n.layers,l.material=n.material,l.copyPrimitives(n.primitives),l.count=n.count),l.geometry=r,l.glType=4,o.originalDGToWideDG.set(n,l);var h=new e.Vector3,c=new e.Vector3,d=function(e,t){return i.getVertexPosition(e,h),i.getVertexPosition(t,c),Math.abs(h.x-c.x)<1e-6&&Math.abs(h.y-c.y)<1e-6&&Math.abs(h.z-c.z)<1e-6},u=function(){for(var e=[],r=0,s=new t.SGPrimitiveHelper,a=0;a<n.getPrimitivesCount();a++){s.set(n,a),e.push([]);for(var o=s.getStart();o<s.getStart()+s.getCount();o++){var l=(o-s.getStart())%2,h={cur:r=i.vertexIndexArray[o],prev:l?i.vertexIndexArray[o-1]:r,next:l?r:i.vertexIndexArray[o+1],begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};e[a].push(h)}}return e}(),p=function(e,t){for(var i=0;i<e.length;i++){var r=e[i];if(!(r.length<1))for(var n=0;n<r.length;n++){t(r[n],r,n)}}};p(u=function(e){for(var t=[],i=0;i<e.length;i++)if(t.push([]),!((w=e[i]).length<1))for(var r=0;r<w.length;r++){var n=w[r];if(n.cur!==n.next)t[i].push(n);else if(r<w.length-1){var s=r+1,a=w[s];if(n.cur===a.cur){for(var o=r+2;o<w.length&&n.cur===w[o].cur;o++)s=o;a=w[s];var l={cur:n.cur,next:a.next,prev:n.prev,begLine:!1,endLine:!1,fusedBack:!1,fusedWith:null};r=s,t[i].push(l)}else t[i].push(n)}else t[i].push(n)}return t}(u),function(e){e.next===e.cur?e.endLine=!0:e.prev===e.cur&&(e.begLine=!0)});p(u,function(e,t,i){if(e.endLine&&i<t.length-1){var r=t[i+1];r.begLine&&d(e.cur,r.cur)&&(e.endLine=!1,r.begLine=!1)}});p(u,function(e,t,i){if(d(e.cur,e.next)&&!e.endLine&&!e.begLine)for(var r=i+1;r<t.length;r++){var n=t[r];if(!d(e.cur,n.cur))break;if(n.prev=e.prev,n.endLine)break;d(n.next,n.cur)?n.colorIndex||(n.colorIndex=e.cur):(e.next=n.next,e.endSkip=!0,n.baseSkip=!0)}});!function(e){if(!(e.length<2)){for(var t=[],r=0;r<e.length;r++)if(!((u=e[r]).length<1)){var n=u[u.length-1],s=u[0];d(n.cur,n.next)&&(i.getVertexPosition(n.cur,h),t.push([h.x,h.y,h.z,r,1])),d(s.prev,s.cur)&&(i.getVertexPosition(s.cur,h),t.push([h.x,h.y,h.z,r,0]))}t.sort(function(e,t){var i=e[0]-t[0];if(Math.abs(i)<1e-6){var r=e[1]-t[1];if(Math.abs(r)<1e-6){var n=e[2]-t[2];if(Math.abs(n)<1e-6){var s=e[3]-t[3];return 0===s?0:s>0?1:-1}return n>0?1:-1}return r>0?1:-1}return i>0?1:-1});for(var a=0;a<t.length;a++){var o=t[a];if(0!==o[4])for(var l=a+1;l<t.length;l++){var c=t[l];if(1!==c[4]&&c[3]!==o[3]){if(Math.abs(o[0]-c[0])<1e-6&&Math.abs(o[1]-c[1])<1e-6&&Math.abs(o[2]-c[2])<1e-6){n=(u=e[o[3]])[u.length-1];var u,p=e[c[3]][0];if(!p.fusedBack){n.next=p.next,p.prev=n.prev,n.fusedWith={primIndex:c[3]},p.fusedBack=!0;break}}break}}}}}(u);p(u,function(e,t,i){var r=t.length;if(e.begLine)for(var n=i+1;n<r;n++){var s=t[n];if(s.endLine){n-i>1&&d(s.cur,e.cur)&&(s.isLoopedWith=!0,e.prev=s.prev,s.next=e.next);break}}});for(var f=[],g=[],m=[],v=[],_=0,y=new e.Vector3,S=new e.Vector3,x=new e.Vector3,b=0;b<u.length;b++)for(var w=u[b],M=0;M<w.length;M++){var C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2;L.indRef=_,L.inds=[];for(var P=0;P<C;P++)L.inds.push(_),v[_]=P%2==0?1:-1,4===C?v[_]*=P<2?1:2:L.begLine&&(v[_]*=2),i.getVertexPosition(L.cur,y),i.getVertexPosition(L.prev,S),i.getVertexPosition(L.next,x),f[3*_]=y.x,f[3*_+1]=y.y,f[3*_+2]=y.z,g[3*_]=S.x,g[3*_+1]=S.y,g[3*_+2]=S.z,m[3*_]=x.x,m[3*_+1]=x.y,m[3*_+2]=x.z,_++}o.lineStructureMap.set(l,{sides:v.slice(0),primitives:u.slice(0)});var E=null;if(i.vertexColorArray){var T=new e.Vector4;E=[];for(_=0,b=0;b<u.length;b++)for(w=u[b],M=0;M<w.length;M++)for(C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2,P=0;P<C;P++){var A=L.colorIndex>=0?L.colorIndex:L.cur;i.getVertexColor(A,T),E[4*_]=T.x,E[4*_+1]=T.y,E[4*_+2]=T.z,E[4*_+3]=T.w,_++}}var D=null;const I=i.vertexPatternStartEndArray;if(I){D=[];for(_=0,b=0;b<u.length;b++)for(w=u[b],M=0;M<w.length;M++)for(C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2,P=0;P<C;P++){A=L.cur;for(var R=0;R<2;R++)D[2*_+R]=I[2*A+R];_++}}var O=null;if(s.isCPUPattern||(!i.vertexLineDistancesArray&&s.isDashedLine&&this._computeLineDistances(i,[]),!i.vertexLineDistancesArray&&s.politeMaterial&&this._computeLineDistances(i,[]),i.vertexLineDistancesArray&&a&&this._computeLineDistances(i,[])),i.vertexLineDistancesArray){const e=i.vertexLineDistancesArray;O=[];for(_=0,b=0;b<u.length;b++)for(w=u[b],M=0;M<w.length;M++){var L;for(C=!(L=w[M]).endLine&&!L.begLine||L.isLoopedWith||L.fusedWith?4:2,P=0;P<C;P++){var V=e[2*L.cur];if(v[_]%2==0)if(O.push(V),L.isLoopedWith)O.push(V);else if(L.fusedWith){var F=u[L.fusedWith.primIndex][0];F=e[2*F.cur],Math.abs(F-V)<1e-6?O.push(e[2*L.next]):O.push(V)}else O.push(e[2*L.next]);else O.push(e[2*L.prev]),O.push(V);_++}}}var B=[],N=0;for(b=0;b<u.length;b++){if(!((w=u[b]).length<1)){l._setPrimitiveCount(0,b);M=0;for(M=0;M<w.length;M++){var G=w[M],k=G.inds;if(G.endLine||G.begLine){if(G.endLine){G.isLoopedWith&&(B.push(k[0]),B.push(k[1]),B.push(k[2]),B.push(k[3]),B.push(k[2]),B.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b));continue}var U=w[M+1].inds;B.push(k[0]),B.push(k[1]),B.push(U[0]),B.push(U[1]),B.push(U[0]),B.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)}else if(G.baseSkip||(B.push(k[0]),B.push(k[1]),B.push(k[2]),B.push(k[3]),B.push(k[2]),B.push(k[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)),!G.endSkip){U=w[M+1].inds;B.push(k[2]),B.push(k[3]),B.push(U[0]),B.push(U[1]),B.push(U[0]),B.push(k[3]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)}}if(w[w.length-1].fusedWith){var z=w[M-1].inds;B.push(z[0]),B.push(z[1]),B.push(z[2]),B.push(z[3]),B.push(z[2]),B.push(z[1]),l._setPrimitiveCount(l.getPrimitiveCount(b)+6,b)}l._setPrimitiveStart(N,b),N+=l.getPrimitiveCount(b)}}var H={count:B.length,start:0},W=0;return r.vertexPositionArray&&(W=r.vertexPositionArray.length/3,f=Array.prototype.slice.call(r.vertexPositionArray).concat(f)),r.vertexPreviousPositionArray&&(g=Array.prototype.slice.call(r.vertexPreviousPositionArray).concat(g)),r.vertexNextPositionArray&&(m=Array.prototype.slice.call(r.vertexNextPositionArray).concat(m)),r.vertexSideExtrusionArray&&(v=Array.prototype.slice.call(r.vertexSideExtrusionArray).concat(v)),r.vertexColorArray&&(E=Array.prototype.slice.call(r.vertexColorArray).concat(E)),r.vertexPatternStartEndArray&&(D=Array.prototype.slice.call(r.vertexPatternStartEndArray).concat(D)),r.vertexLineDistancesArray?(W-r.vertexLineDistancesArray.length/2>0&&this._computeWideLineDistances(r),O=Array.prototype.slice.call(r.vertexLineDistancesArray).concat(O)):null!==O&&O.length>0&&W>0&&(this._computeWideLineDistances(r),O=Array.prototype.slice.call(r.vertexLineDistancesArray).concat(O)),r.vertexIndexArray&&(H.start=r.vertexIndexArray.length,B.forEach(function(e,t,i){i[t]+=W}),B=Array.prototype.slice.call(r.vertexIndexArray).concat(B)),r.needsUpdate=!0,r.vertexPositionArray=f,r.vertexPreviousPositionArray=g,r.vertexNextPositionArray=m,r.vertexSideExtrusionArray=v,E&&(r.vertexColorArray=E),O&&(r.vertexLineDistancesArray=O),D&&(r.vertexPatternStartEndArray=D),r.vertexIndexArray=B,l.start=H.start,l.count=H.count,r.drawingGroups.push(l),l}}});for(var _materialsBase="DS/Materials/",_toLoad=["DeferrableMaterial","DeferredCaches","LineBasicMaterial","LineDSMaterial","Material","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","ParticleBasicMaterial","PhysicalMaterial","CATGraphicalMaterial","ShaderMaterial","ShaderMaterialDS","DSPBR19x","DSPBR21x","DSPBR22x","DSPBR25x","GASPBR","OutlineMaterial","SectionBuilderMaterial","OldInfraMaterial","CubeMapMaterial","FiniteEnvMapMaterial","FiniteTransitionEnvMapMaterial","GradientBackgroundMaterials","LatLongMapMaterial","SimpleMapMaterial","GridMaterial","SmallPlaneMaterial","PlaneMaterial","HatchingMaterials","ShaderDynamicPrefixBuilder"],i=0;i<_toLoad.length;i++)_toLoad[i]=_materialsBase+_toLoad[i];_toLoad.push("DS/Mesh/ThreeJS_Base"),define("DS/Visualization/Materials",_toLoad,function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R){"use strict";return{cleanPredefinedMaterialTextureCache:function(){for(var e=t._loadPredefinedMaterialTextures(!0,function(){},!0),i=0;i<e.length;i++)e[i]._canBeUsed()&&e[i].dispose()},cleanPredefinedMaterialCache:function(){for(var e=[t.PredefinedMaterials],i=0;i<e.length;i++)e[i].forEach(function(e,t,i){var r,n;if(e.material.dispose)e.material.dispose();else for(r in e.material)(n=e.material[r])&&n.dispose&&n.dispose();i.delete(t)})},cleanDeferredCache:function(e){for(var i=[t.DefaultMaterials,t.GeomTypeMaterials,t.PredefinedMaterials],r=0;r<i.length;r++)i[r].forEach(function(t,i,r){if(t.usedBy.delete(e),t.usedBy.size<1){var n,s;if(t.material.dispose)t.material.dispose();else for(n in t.material)(s=t.material[n])&&s.dispose&&s.dispose();r.delete(i)}})},DeferrableMaterial:e,LineBasicMaterial:i,LineDSMaterial:r,Material:n,MeshBasicMaterial:s,MeshLambertMaterial:a,MeshPhongMaterial:o,ParticleBasicMaterial:l,PhysicalMaterial:h,_CATGraphicalMaterial:c,ShaderMaterial:d,ShaderMaterialDS:u,DSPBR19xMaterial:p,DSPBR21xMaterial:f,DSPBR22xMaterial:g,DSPBR25xMaterial:m,_GASPBRMaterial:v,_OutlineMaterial:_._OutlineMaterial,_WideOutlineMaterial:_._WideOutlineMaterial,_SectionMaterial:y._SectionMaterial,_WideSectionMaterial:y._WideSectionMaterial,_OldInfraMaterial:S,CubeMapMaterial:x,FiniteEnvMapMaterial:b,FiniteTransitionEnvMapMaterial:w,GradientBackgroundMaterial2:M.GradientBackgroundMaterial2,GradientBackgroundMaterial3:M.GradientBackgroundMaterial3,GradientBackgroundMaterial4:M.GradientBackgroundMaterial4,LatLongMapMaterial:C,SimpleMapMaterial:P,GridMaterial:E,SmallPlaneMaterial:T,PlaneMaterial:A,ShaderDynamicPrefixBuilder:I,HatchingMeshMaterial:D.HatchingMeshMaterial,ScreenSizeHatchingMeshMaterial:D.ScreenSizeHatchingMeshMaterial}}),function(){var e=[];"file:"!==window.location.protocol&&(e.push("text!Visualization/assets/ambiences.json"),e.push("text!Visualization/assets/compare.json")),define("DS/Visualization/JSONSettings",e,function(e,t){"use strict";return{configAmbiences:e?JSON.parse(e):null,compareSettings:t?JSON.parse(t):null,getDefaultViewSettings:function(){return this.configAmbiences?this.configAmbiences.defaultViews:null},getEmulateScreenDoorTransparency:function(){return!!this.configAmbiences&&this.configAmbiences.emulateScreenDoorTransparency},_dbg_forceEmulateScreenDoorTransparency:function(e){this.configAmbiences&&this.configAmbiences.hasOwnProperty("emulateScreenDoorTransparency")&&(this.configAmbiences.emulateScreenDoorTransparency=e)}}})}(),define("DS/Visualization/OBJReader",["DS/VisuLoaders/OBJReader"],function(e){"use strict";return e}),define("Visualization/OBJReader",["DS/Visualization/OBJReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OBJReader"),e});var modules=[],_shaderChunkBase="DS/ShaderBuilders/Commons/";for(_toLoad=["AlphaShaders","ClipShaders","ColorShaders","CoreShaders","EnvMapShaders","FogShaders","MappingShaders","PDSFXShaders","ScenegraphShaders","ShadowingShaders","VerticeShaders"],i=0;i<_toLoad.length;i++)modules.push(_shaderChunkBase+_toLoad[i]);function HighlightMeshData(e,t){this.selectionId=e,this.renderable=t}define("DS/Visualization/ShaderChunk",modules,function(e,t,i,r,n,s,a,o,l,h,c){"use strict";var d={};return Object.assign(d,r),Object.assign(d,l),Object.assign(d,o),Object.assign(d,h),Object.assign(d,s),Object.assign(d,t),Object.assign(d,a),Object.assign(d,n),Object.assign(d,e),Object.assign(d,i),Object.assign(d,c),d}),define("DS/Visualization/IdPathWatcher",["DS/CoreEvents/Events"],function(e){"use strict";var t=function(t){this.viewer=t.viewer,this.onIdPathActiveCB=t.onIdPathActiveCB,this.onIdPathInactiveCB=t.onIdPathInactiveCB,this.idPathes=new Map,this.macroNodes=new Map,this.token=e.subscribe({event:"/VISU/onSceneGraphUpdate"},this.onSceneGraphUpdate.bind(this))};t.prototype.addIdPath=function(e,t){var r=this.idPathes.get(t);r||(r=new i(t),this.idPathes.set(t,r),this.addIdPath_internal(e,r))},t.prototype.removeIdObject=function(e){var t=this.idPathes.get(e);if(t){var i,r,n=t.firstNode;if(n.single)(i=n.macroNode).removeSingleNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null;else for(;null!==n;)(i=n.macroNode).removeNode(n),i.isEmpty()&&this.macroNodes.delete(i.id),n.macroNode=null,r=n.nextNode,n.nextNode=null,n=r;t.firstNode=null,this.idPathes.delete(e)}},t.prototype.addIdPath_internal=function(e,t){var i,r=e.ids,n=1===r.length;if(t.count+=r.length,0!==r.length){var a=this.viewer.getIdPathMatcher(),o=null,l=this.createNode(r[0],t,n),h=null,c=a.idToNode(r[0]);for(t.firstNode=l,i=0;i<r.length-1;i++)o=l,l=this.createNode(r[i+1],t),o.nextNode=l,s(h=c,c=a.idToNode(l.macroNode.id))&&(o.active=!0,t.count--);o=l,h=c,n?o.single=!0:t.count--,o.single&&h&&h._hasOccurrenceInViewer(this.viewer)&&(o.active=!0,t.count--),0===t.count&&this.onIdPathActiveCB(t.idObject)}},t.prototype.getMacroNode=function(e){var t=this.macroNodes.get(e);return t||(t=new r(e),this.macroNodes.set(e,t)),t},t.prototype.createNode=function(e,t,i){var r=this.getMacroNode(e);return i?r.createSingleNode(t):r.createNode(t)},t.prototype.onSceneGraphUpdate=function(e){"ADD"===e.eventType?this.onAddChild(e.fromNode,e.toNode):"REMOVE"===e.eventType&&this.onRemoveChild(e.fromNode,e.toNode)},t.prototype.onAddChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),s=this.macroNodes.get(r),a=this.macroNodes.get(n);a&&s&&s.onAddChild(a,this,e),s&&s.onAddSingle(this,e),a&&a.onAddSingle(this,t)},t.prototype.onRemoveChild=function(e,t){var i=this.viewer.getIdPathMatcher(),r=i.nodeToId(e),n=i.nodeToId(t),s=this.macroNodes.get(r),a=this.macroNodes.get(n);a&&s&&(s.onRemoveChild(a,this),a.onRemoveSingle(this))},t.prototype.getIdPathMatcher=function(){return this.viewer.getIdPathMatcher()},t.prototype.dispose=function(){this.token&&(e.unsubscribe(this.token),this.token=null)};var i=function(e){this.idObject=e,this.count=0,this.firstNode=null},r=function(e){this.id=e,this.nodeSet=null,this.singleNodeSet=null};r.prototype.getNode3D=function(e){return e.getIdPathMatcher().idToNode(this.id)},r.prototype.createNode=function(e){var t=new n(this);return t.idPath=e,this.nodeSet||(this.nodeSet=new Set),this.nodeSet.add(t),t},r.prototype.createSingleNode=function(e){var t=new n(this);return t.idPath=e,this.singleNodeSet||(this.singleNodeSet=new Set),this.singleNodeSet.add(t),t},r.prototype.onAddChild=function(e,t,i){this.nodeSet&&this.nodeSet.forEach(i=>{i.nextNode&&i.nextNode.macroNode===e&&i.activate(t)})},r.prototype.onAddSingle=function(e,t){this.singleNodeSet&&this.singleNodeSet.forEach(t=>{t.activate(e)})},r.prototype.onRemoveChild=function(e,t){this.nodeSet&&this.nodeSet.forEach(i=>{i.nextNode&&i.nextNode.macroNode===e&&i.deactivate(t)})},r.prototype.onRemoveSingle=function(e){let t=null;this.singleNodeSet&&this.singleNodeSet.forEach(i=>{i.single&&i.active&&(null===t&&(t=this.getNode3D(e)),null!=t&&0!==t.parents.length||i.deactivate(e))})},r.prototype.removeNode=function(e){this.nodeSet&&this.nodeSet.delete(e)},r.prototype.removeSingleNode=function(e){this.singleNodeSet&&this.singleNodeSet.delete(e)},r.prototype.isEmpty=function(){return!(this.nodeSet&&0!==this.nodeSet.size||this.singleNodeSet&&0!==this.singleNodeSet.size)};var n=function(e){this.macroNode=e,this.idPath=null,this.nextNode=null,this.active=!1,this.single=!1};function s(e,t){var i;if(e&&t)if(e.children.length<t.parents.length){for(i=0;i<e.children.length;i++)if(e.children[i]===t)return!0}else for(i=0;i<t.parents.length;i++)if(t.parents[i]===e)return!0;return!1}return n.prototype.activate=function(e){this.active||(this.active=!0,this.idPath.count--,0===this.idPath.count&&e.onIdPathActiveCB(this.idPath.idObject))},n.prototype.deactivate=function(e){var t=this.idPath.count;this.active&&(this.active=!1,this.idPath.count++,0===t&&e.onIdPathInactiveCB(this.idPath.idObject))},t}),define("DS/Visualization/ExplicitGeometries",["DS/Mesh/ThreeJS_Base","DS/Object3D/Object3D","DS/Object3D/Mesh"],function(e,t,i){"use strict";var r={LegacyGeometry:function(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this.name="",this._type=0,this.vertices=[],this.colors=[],this.normals=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.tangentsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1}};return r.LegacyGeometry.prototype={constructor:r.LegacyGeometry,applyMatrix:function(t){for(var i=(new e.Matrix3).getInverse(t).transpose(),r=0,n=this.vertices.length;r<n;r++){this.vertices[r].applyMatrix4(t)}for(r=0,n=this.faces.length;r<n;r++){var s=this.faces[r];s.normal.applyMatrix3(i).normalize();for(var a=0,o=s.vertexNormals.length;a<o;a++)s.vertexNormals[a].applyMatrix3(i).normalize();s.centroid.applyMatrix4(t)}},computeCentroids:function(){var t,i,r;for(t=0,i=this.faces.length;t<i;t++)(r=this.faces[t]).centroid.set(0,0,0),r instanceof e.Face3?(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.divideScalar(3)):r instanceof e.Face4&&(r.centroid.add(this.vertices[r.a]),r.centroid.add(this.vertices[r.b]),r.centroid.add(this.vertices[r.c]),r.centroid.add(this.vertices[r.d]),r.centroid.divideScalar(4))},computeFaceNormals:function(){for(var t=new e.Vector3,i=new e.Vector3,r=0,n=this.faces.length;r<n;r++){var s=this.faces[r],a=this.vertices[s.a],o=this.vertices[s.b],l=this.vertices[s.c];t.subVectors(l,o),i.subVectors(a,o),t.cross(i),t.normalize(),s.normal.copy(t)}},computeVertexNormals:function(t){var i,r,n,s,a,o;if(void 0===this.__tmpVertices){for(this.__tmpVertices=new Array(this.vertices.length),o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i]=new e.Vector3;for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?a.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3]:a instanceof e.Face4&&(a.vertexNormals=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3])}else for(o=this.__tmpVertices,i=0,r=this.vertices.length;i<r;i++)o[i].set(0,0,0);if(t){var l,h,c,d,u=new e.Vector3,p=new e.Vector3,f=new e.Vector3,g=new e.Vector3,m=new e.Vector3;for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?(l=this.vertices[a.a],h=this.vertices[a.b],c=this.vertices[a.c],u.subVectors(c,h),p.subVectors(l,h),u.cross(p),o[a.a].add(u),o[a.b].add(u),o[a.c].add(u)):a instanceof e.Face4&&(l=this.vertices[a.a],h=this.vertices[a.b],c=this.vertices[a.c],d=this.vertices[a.d],f.subVectors(d,h),p.subVectors(l,h),f.cross(p),o[a.a].add(f),o[a.b].add(f),o[a.d].add(f),g.subVectors(d,c),m.subVectors(h,c),g.cross(m),o[a.b].add(g),o[a.c].add(g),o[a.d].add(g))}else for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?(o[a.a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal)):a instanceof e.Face4&&(o[a.a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal),o[a.d].add(a.normal));for(i=0,r=this.vertices.length;i<r;i++)o[i].normalize();for(n=0,s=this.faces.length;n<s;n++)(a=this.faces[n])instanceof e.Face3?(a.vertexNormals[0].copy(o[a.a]),a.vertexNormals[1].copy(o[a.b]),a.vertexNormals[2].copy(o[a.c])):a instanceof e.Face4&&(a.vertexNormals[0].copy(o[a.a]),a.vertexNormals[1].copy(o[a.b]),a.vertexNormals[2].copy(o[a.c]),a.vertexNormals[3].copy(o[a.d]))},computeTangents:function(){var t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T=[],A=[],D=new e.Vector3,I=new e.Vector3,R=new e.Vector3,O=new e.Vector3,L=new e.Vector3;for(r=0,n=this.vertices.length;r<n;r++)T[r]=new e.Vector3,A[r]=new e.Vector3;function V(e,t,i,r,n,s,a){h=e.vertices[t],c=e.vertices[i],d=e.vertices[r],u=l[n],p=l[s],f=l[a],g=c.x-h.x,m=d.x-h.x,v=c.y-h.y,_=d.y-h.y,y=c.z-h.z,S=d.z-h.z,x=p.x-u.x,b=f.x-u.x,w=p.y-u.y,M=f.y-u.y,C=1/(x*M-b*w),D.set((M*g-w*m)*C,(M*v-w*_)*C,(M*y-w*S)*C),I.set((x*m-b*g)*C,(x*_-b*v)*C,(x*S-b*y)*C),T[t].add(D),T[i].add(D),T[r].add(D),A[t].add(I),A[i].add(I),A[r].add(I)}for(t=0,i=this.faces.length;t<i;t++)o=this.faces[t],l=this.faceVertexUvs[0][t],o instanceof e.Face3?V(this,o.a,o.b,o.c,0,1,2):o instanceof e.Face4&&(V(this,o.a,o.b,o.d,0,1,3),V(this,o.b,o.c,o.d,1,2,3));var F=["a","b","c","d"];for(t=0,i=this.faces.length;t<i;t++)for(o=this.faces[t],s=0;s<o.vertexNormals.length;s++)L.copy(o.vertexNormals[s]),a=o[F[s]],P=T[a],R.copy(P),R.sub(L.multiplyScalar(L.dot(P))).normalize(),O.crossVectors(o.vertexNormals[s],P),E=O.dot(A[a])<0?-1:1,o.vertexTangents[s]=new e.Vector4(R.x,R.y,R.z,E);this.hasTangents=!0},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new e.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere),this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var t,i,r,n,s,a,o,l,h,c={},d=[],u=[],p=Math.pow(10,4);for(this.__tmpVertices=void 0,r=0,n=this.vertices.length;r<n;r++)t=this.vertices[r],void 0===c[i=[Math.round(t.x*p),Math.round(t.y*p),Math.round(t.z*p)].join("_")]?(c[i]=r,d.push(this.vertices[r]),u[r]=d.length-1):u[r]=u[c[i]];var f=[];for(r=0,n=this.faces.length;r<n;r++)if((s=this.faces[r])instanceof e.Face3){s.a=u[s.a],s.b=u[s.b],s.c=u[s.c],a=[s.a,s.b,s.c];for(var g=-1,m=0;m<3;m++)if(a[m]==a[(m+1)%3]){g=m,f.push(r);break}}else if(s instanceof e.Face4){s.a=u[s.a],s.b=u[s.b],s.c=u[s.c],s.d=u[s.d],a=[s.a,s.b,s.c,s.d];for(g=-1,m=0;m<4;m++)a[m]==a[(m+1)%4]&&(g>=0&&f.push(r),g=m);if(g>=0){a.splice(g,1);var v=new e.Face3(a[0],a[1],a[2],s.normal,s.color,s.materialIndex);for(o=0,l=this.faceVertexUvs.length;o<l;o++)(h=this.faceVertexUvs[o][r])&&h.splice(g,1);s.vertexNormals&&s.vertexNormals.length>0&&(v.vertexNormals=s.vertexNormals,v.vertexNormals.splice(g,1)),s.vertexColors&&s.vertexColors.length>0&&(v.vertexColors=s.vertexColors,v.vertexColors.splice(g,1)),this.faces[r]=v}}for(r=f.length-1;r>=0;r--)for(this.faces.splice(r,1),o=0,l=this.faceVertexUvs.length;o<l;o++)this.faceVertexUvs[o].splice(r,1);var _=this.vertices.length-d.length;return this.vertices=d,_},clone:function(){for(var t=new r.LegacyGeometry,i=this.vertices,n=0,s=i.length;n<s;n++)t.vertices.push(i[n].clone());var a=this.faces;for(n=0,s=a.length;n<s;n++)t.faces.push(a[n].clone());var o=this.faceVertexUvs[0];for(n=0,s=o.length;n<s;n++){for(var l=o[n],h=[],c=0,d=l.length;c<d;c++)h.push(new e.Vector2(l[c].x,l[c].y));t.faceVertexUvs[0].push(h)}return t},dispose:function(){this.dispatchEvent({type:"dispose"})}},r.ParticleSystem=class extends t{constructor(t,i){super(),this.geometry=t,this.material=void 0!==i?i:new e.ParticleBasicMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.geometry&&null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.frustumCulled=!1,console.log("ExplicitGeometries.ParticleSystem is deprecated. Please use SceneGraphFactory.createMeshNode instead.")}clone(e){return void 0===e&&(e=new r.ParticleSystem(this.geometry,this.material)),e.sortParticles=this.sortParticles,t.prototype.clone.call(this,e),e}},r.Line=class extends t{constructor(t,i,r){super(),this.geometry=t,this.material=void 0!==i?i:new e.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==r?r:e.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())}static call(e,t,i,n){console.warn("Old school inheritance on Line, please migrate to ES6 classes");var s=new r.Line(t,i,n);Object.assign(e,s)}clone(e){return void 0===e&&(e=new r.Line(this.geometry,this.material,this.type)),t.prototype.clone.call(this,e),e}},r.SkinnedMesh=class extends i{constructor(t,i,r){super(t,i,!0),this.useVertexTexture=void 0===r||r,this.identityMatrix=new e.Matrix4,this.bones=[],this.boneMatrices=[],window.sealWebVisuObjects&&Object.seal(this)}},r.CircleGeometry=function(t,i,n,s){r.LegacyGeometry.call(this),t=t||50,n=void 0!==n?n:0,s=void 0!==s?s:2*Math.PI,i=void 0!==i?Math.max(3,i):8;var a,o=[],l=new e.Vector3,h=new e.Vector2(.5,.5);for(this.vertices.push(l),o.push(h),a=0;a<=i;a++){var c=new e.Vector3,d=n+a/i*s;c.x=t*Math.cos(d),c.y=t*Math.sin(d),this.vertices.push(c),o.push(new e.Vector2((c.x/t+1)/2,-(c.y/t+1)/2+1))}var u=new e.Vector3(0,0,-1);for(a=1;a<=i;a++){var p=a,f=a+1;this.faces.push(new e.Face3(p,f,0,[u,u,u])),this.faceVertexUvs[0].push([o[a],o[a+1],h])}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.CircleGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CubeGeometry=function(t,i,n,s,a,o){r.LegacyGeometry.call(this);var l=this;this.width=t,this.height=i,this.depth=n,this.widthSegments=s||1,this.heightSegments=a||1,this.depthSegments=o||1;var h=this.width/2,c=this.height/2,d=this.depth/2;function u(t,i,r,n,s,a,o,h){var c,d,u,p=l.widthSegments,f=l.heightSegments,g=s/2,m=a/2,v=l.vertices.length;"x"===t&&"y"===i||"y"===t&&"x"===i?c="z":"x"===t&&"z"===i||"z"===t&&"x"===i?(c="y",f=l.depthSegments):("z"===t&&"y"===i||"y"===t&&"z"===i)&&(c="x",p=l.depthSegments);var _=p+1,y=f+1,S=s/p,x=a/f,b=new e.Vector3;for(b[c]=o>0?1:-1,u=0;u<y;u++)for(d=0;d<_;d++){var w=new e.Vector3;w[t]=(d*S-g)*r,w[i]=(u*x-m)*n,w[c]=o,l.vertices.push(w)}for(u=0;u<f;u++)for(d=0;d<p;d++){var M=d+_*u,C=d+_*(u+1),P=d+1+_*(u+1),E=d+1+_*u,T=new e.Face4(M+v,C+v,P+v,E+v);T.normal.copy(b),T.vertexNormals.push(b.clone(),b.clone(),b.clone(),b.clone()),T.materialIndex=h,l.faces.push(T),l.faceVertexUvs[0].push([new e.Vector2(d/p,1-u/f),new e.Vector2(d/p,1-(u+1)/f),new e.Vector2((d+1)/p,1-(u+1)/f),new e.Vector2((d+1)/p,1-u/f)])}}u("z","y",-1,-1,this.depth,this.height,h,0),u("z","y",1,-1,this.depth,this.height,-h,1),u("x","z",1,1,this.width,this.depth,c,2),u("x","z",1,-1,this.width,this.depth,-c,3),u("x","y",1,-1,this.width,this.height,d,4),u("x","y",-1,-1,this.width,this.height,-d,5),this.computeCentroids(),this.mergeVertices()},r.CubeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.CylinderGeometry=function(t,i,n,s,a,o){r.LegacyGeometry.call(this),t=void 0!==t?t:20,i=void 0!==i?i:20;var l,h,c=(n=void 0!==n?n:100)/2,d=s||8,u=a||1,p=[],f=[];for(h=0;h<=u;h++){var g=[],m=[],v=h/u,_=v*(i-t)+t;for(l=0;l<=d;l++){var y=l/d,S=new e.Vector3;S.x=_*Math.sin(y*Math.PI*2),S.y=-v*n+c,S.z=_*Math.cos(y*Math.PI*2),this.vertices.push(S),g.push(this.vertices.length-1),m.push(new e.Vector2(y,1-v))}p.push(g),f.push(m)}var x,b,w=(i-t)/n;for(l=0;l<d;l++)for(0!==t?(x=this.vertices[p[0][l]].clone(),b=this.vertices[p[0][l+1]].clone()):(x=this.vertices[p[1][l]].clone(),b=this.vertices[p[1][l+1]].clone()),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*w).normalize(),b.setY(Math.sqrt(b.x*b.x+b.z*b.z)*w).normalize(),h=0;h<u;h++){var M=p[h][l],C=p[h+1][l],P=p[h+1][l+1],E=p[h][l+1],T=x.clone(),A=x.clone(),D=b.clone(),I=b.clone(),R=f[h][l].clone(),O=f[h+1][l].clone(),L=f[h+1][l+1].clone(),V=f[h][l+1].clone();this.faces.push(new e.Face4(M,C,P,E,[T,A,D,I])),this.faceVertexUvs[0].push([R,O,L,V])}if(!o&&t>0)for(this.vertices.push(new e.Vector3(0,c,0)),l=0;l<d;l++){M=p[0][l],C=p[0][l+1],P=this.vertices.length-1,T=new e.Vector3(0,1,0),A=new e.Vector3(0,1,0),D=new e.Vector3(0,1,0),R=f[0][l].clone(),O=f[0][l+1].clone(),L=new e.Vector2(O.u,0);this.faces.push(new e.Face3(M,C,P,[T,A,D])),this.faceVertexUvs[0].push([R,O,L])}if(!o&&i>0)for(this.vertices.push(new e.Vector3(0,-c,0)),l=0;l<d;l++){M=p[h][l+1],C=p[h][l],P=this.vertices.length-1,T=new e.Vector3(0,-1,0),A=new e.Vector3(0,-1,0),D=new e.Vector3(0,-1,0),R=f[h][l+1].clone(),O=f[h][l].clone(),L=new e.Vector2(O.u,1);this.faces.push(new e.Face3(M,C,P,[T,A,D])),this.faceVertexUvs[0].push([R,O,L])}this.computeCentroids(),this.computeFaceNormals()},r.CylinderGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry=function(e,t){void 0!==e?(r.LegacyGeometry.call(this),e=e instanceof Array?e:[e],this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()):e=[]},r.ExtrudeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var i=e.length,r=0;r<i;r++){var n=e[r];this.addShape(n,t)}},r.ExtrudeGeometry.prototype.addShape=function(t,i){var n,s,a,o,l,h,c,d,u=void 0!==i.amount?i.amount:100,p=void 0!==i.bevelThickness?i.bevelThickness:6,f=void 0!==i.bevelSize?i.bevelSize:p-2,g=void 0!==i.bevelSegments?i.bevelSegments:3,m=void 0===i.bevelEnabled||i.bevelEnabled,v=void 0!==i.curveSegments?i.curveSegments:12,_=void 0!==i.steps?i.steps:1,y=i.extrudePath,S=!1,x=i.material,b=i.extrudeMaterial,w=void 0!==i.UVGenerator?i.UVGenerator:r.ExtrudeGeometry.WorldUVGenerator;this.shapebb;y&&(n=y.getSpacedPoints(_),S=!0,m=!1,s=void 0!==i.frames?i.frames:new e.TubeGeometry.FrenetFrames(y,_,!1),a=new e.Vector3,o=new e.Vector3,l=new e.Vector3),m||(g=0,p=0,f=0);var M=this,C=this.vertices.length,P=t.extractPoints(v),E=P.shape,T=P.holes,A=!e.Shape.Utils.isClockWise(E);if(A){for(E=E.reverse(),c=0,d=T.length;c<d;c++)h=T[c],e.Shape.Utils.isClockWise(h)&&(T[c]=h.reverse());A=!1}var D=e.Shape.Utils.triangulateShape(E,T),I=E;for(c=0,d=T.length;c<d;c++)h=T[c],E=E.concat(h);function R(e,t,i){return t||console.log("die"),t.clone().multiplyScalar(i).add(e)}var O,L,V,F,B,N,G=E.length,k=D.length;I.length,Math.PI;function U(t,i,n){return function(t,i,n){var s,a,o,l,h,c=r.ExtrudeGeometry.__v1,d=r.ExtrudeGeometry.__v2,u=r.ExtrudeGeometry.__v3,p=r.ExtrudeGeometry.__v4,f=r.ExtrudeGeometry.__v5,g=r.ExtrudeGeometry.__v6;if(c.set(t.x-i.x,t.y-i.y),d.set(t.x-n.x,t.y-n.y),s=c.normalize(),a=d.normalize(),u.set(-s.y,s.x),p.set(a.y,-a.x),f.copy(t).add(u),g.copy(t).add(p),f.equals(g))return p.clone();f.copy(i).add(u),g.copy(n).add(p),o=s.dot(p),l=g.sub(f).dot(p),0===o&&(console.log("Either infinite or no solutions!"),0===l?console.log("Its finite solutions."):console.log("Too bad, no solutions."));if((h=l/o)<0)return function(t,i,r){var n=Math.atan2(i.y-t.y,i.x-t.x),s=Math.atan2(r.y-t.y,r.x-t.x);n>s&&(s+=2*Math.PI);var a=(n+s)/2,o=-Math.cos(a),l=-Math.sin(a);return new e.Vector2(o,l)}(t,i,n);return s.multiplyScalar(h).add(f).sub(t).clone()}(t,i,n)}for(var z=[],H=0,W=I.length,j=W-1,X=H+1;H<W;H++,j++,X++){j===W&&(j=0),X===W&&(X=0);I[H],I[j],I[X];z[H]=U(I[H],I[j],I[X])}var q,Z,Y=[],Q=z.concat();for(c=0,d=T.length;c<d;c++){for(h=T[c],q=[],H=0,j=(W=h.length)-1,X=H+1;H<W;H++,j++,X++)j===W&&(j=0),X===W&&(X=0),q[H]=U(h[H],h[j],h[X]);Y.push(q),Q=Q.concat(q)}for(O=0;O<g;O++){for(F=p*(1-(V=O/g)),L=f*Math.sin(V*Math.PI/2),H=0,W=I.length;H<W;H++)$((B=R(I[H],z[H],L)).x,B.y,-F);for(c=0,d=T.length;c<d;c++)for(h=T[c],q=Y[c],H=0,W=h.length;H<W;H++)$((B=R(h[H],q[H],L)).x,B.y,-F)}for(L=f,H=0;H<G;H++)B=m?R(E[H],Q[H],L):E[H],S?(o.copy(s.normals[0]).multiplyScalar(B.x),a.copy(s.binormals[0]).multiplyScalar(B.y),l.copy(n[0]).add(o).add(a),$(l.x,l.y,l.z)):$(B.x,B.y,0);for(Z=1;Z<=_;Z++)for(H=0;H<G;H++)B=m?R(E[H],Q[H],L):E[H],S?(o.copy(s.normals[Z]).multiplyScalar(B.x),a.copy(s.binormals[Z]).multiplyScalar(B.y),l.copy(n[Z]).add(o).add(a),$(l.x,l.y,l.z)):$(B.x,B.y,u/_*Z);for(O=g-1;O>=0;O--){for(F=p*(1-(V=O/g)),L=f*Math.sin(V*Math.PI/2),H=0,W=I.length;H<W;H++)$((B=R(I[H],z[H],L)).x,B.y,u+F);for(c=0,d=T.length;c<d;c++)for(h=T[c],q=Y[c],H=0,W=h.length;H<W;H++)B=R(h[H],q[H],L),S?$(B.x,B.y+n[_-1].y,n[_-1].x+F):$(B.x,B.y,u+F)}function K(e,t){var i,r;for(H=e.length;--H>=0;){i=H,(r=H-1)<0&&(r=e.length-1);var n=0,s=_+2*g;for(n=0;n<s;n++){var a=G*n,o=G*(n+1);ee(t+i+a,t+r+a,t+r+o,t+i+o,e,n,s,i,r)}}}function $(t,i,r){M.vertices.push(new e.Vector3(t,i,r))}function J(r,n,s,a){r+=C,n+=C,s+=C,M.faces.push(new e.Face3(r,n,s,null,null,x));var o=a?w.generateBottomUV(M,t,i,r,n,s):w.generateTopUV(M,t,i,r,n,s);M.faceVertexUvs[0].push(o)}function ee(r,n,s,a,o,l,h,c,d){r+=C,n+=C,s+=C,a+=C,M.faces.push(new e.Face4(r,n,s,a,null,null,b));var u=w.generateSideWallUV(M,t,o,i,r,n,s,a,l,h,c,d);M.faceVertexUvs[0].push(u)}!function(){if(m){var e=0,t=G*e;for(H=0;H<k;H++)J((N=D[H])[2]+t,N[1]+t,N[0]+t,!0);for(t=G*(e=_+2*g),H=0;H<k;H++)J((N=D[H])[0]+t,N[1]+t,N[2]+t,!1)}else{for(H=0;H<k;H++)J((N=D[H])[2],N[1],N[0],!0);for(H=0;H<k;H++)J((N=D[H])[0]+G*_,N[1]+G*_,N[2]+G*_,!1)}}(),function(){var e=0;for(K(I,e),e+=I.length,c=0,d=T.length;c<d;c++)K(h=T[c],e),e+=h.length}()},r.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(t,i,r,n,s,a){var o=t.vertices[n].x,l=t.vertices[n].y,h=t.vertices[s].x,c=t.vertices[s].y,d=t.vertices[a].x,u=t.vertices[a].y;return[new e.Vector2(o,l),new e.Vector2(h,c),new e.Vector2(d,u)]},generateBottomUV:function(e,t,i,r,n,s){return this.generateTopUV(e,t,i,r,n,s)},generateSideWallUV:function(t,i,r,n,s,a,o,l,h,c,d,u){var p=t.vertices[s].x,f=t.vertices[s].y,g=t.vertices[s].z,m=t.vertices[a].x,v=t.vertices[a].y,_=t.vertices[a].z,y=t.vertices[o].x,S=t.vertices[o].y,x=t.vertices[o].z,b=t.vertices[l].x,w=t.vertices[l].y,M=t.vertices[l].z;return Math.abs(f-v)<.01?[new e.Vector2(p,1-g),new e.Vector2(m,1-_),new e.Vector2(y,1-x),new e.Vector2(b,1-M)]:[new e.Vector2(f,1-g),new e.Vector2(v,1-_),new e.Vector2(S,1-x),new e.Vector2(w,1-M)]}},r.ExtrudeGeometry.__v1=new e.Vector2,r.ExtrudeGeometry.__v2=new e.Vector2,r.ExtrudeGeometry.__v3=new e.Vector2,r.ExtrudeGeometry.__v4=new e.Vector2,r.ExtrudeGeometry.__v5=new e.Vector2,r.ExtrudeGeometry.__v6=new e.Vector2,r.ShapeGeometry=function(e,t){r.LegacyGeometry.call(this),e instanceof Array==!1&&(e=[e]),this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()},r.ShapeGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.ShapeGeometry.prototype.addShapeList=function(e,t){for(var i=0,r=e.length;i<r;i++)this.addShape(e[i],t);return this},r.ShapeGeometry.prototype.addShape=function(t,i){void 0===i&&(i={});var n,s,a,o=void 0!==i.curveSegments?i.curveSegments:12,l=i.material,h=void 0===i.UVGenerator?r.ExtrudeGeometry.WorldUVGenerator:i.UVGenerator,c=(this.shapebb,this.vertices.length),d=t.extractPoints(o),u=d.shape,p=d.holes,f=!e.Shape.Utils.isClockWise(u);if(f){for(u=u.reverse(),n=0,s=p.length;n<s;n++)a=p[n],e.Shape.Utils.isClockWise(a)&&(p[n]=a.reverse());f=!1}var g=e.Shape.Utils.triangulateShape(u,p),m=u;for(n=0,s=p.length;n<s;n++)a=p[n],u=u.concat(a);var v,_,y=u.length,S=g.length;m.length;for(n=0;n<y;n++)v=u[n],this.vertices.push(new e.Vector3(v.x,v.y,0));for(n=0;n<S;n++){var x=(_=g[n])[0]+c,b=_[1]+c,w=_[2]+c;this.faces.push(new e.Face3(x,b,w,null,null,l)),this.faceVertexUvs[0].push(h.generateBottomUV(this,t,i,x,b,w))}},r.PlaneGeometry=function(t,i,n,s){var a,o;r.LegacyGeometry.call(this),this.width=t,this.height=i,this.widthSegments=n||1,this.heightSegments=s||1;var l=t/2,h=i/2,c=this.widthSegments,d=this.heightSegments,u=c+1,p=d+1,f=this.width/c,g=this.height/d,m=new e.Vector3(0,0,1);for(o=0;o<p;o++)for(a=0;a<u;a++){var v=a*f-l,_=o*g-h;this.vertices.push(new e.Vector3(v,-_,0))}for(o=0;o<d;o++)for(a=0;a<c;a++){var y=a+u*o,S=a+u*(o+1),x=a+1+u*(o+1),b=a+1+u*o,w=new e.Face4(y,S,x,b);w.normal.copy(m),w.vertexNormals.push(m.clone(),m.clone(),m.clone(),m.clone()),this.faces.push(w),this.faceVertexUvs[0].push([new e.Vector2(a/c,1-o/d),new e.Vector2(a/c,1-(o+1)/d),new e.Vector2((a+1)/c,1-(o+1)/d),new e.Vector2((a+1)/c,1-o/d)])}this.computeCentroids()},r.PlaneGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.SphereGeometry=function(t,i,n,s,a,o,l){r.LegacyGeometry.call(this),this.radius=t||50,this.widthSegments=Math.max(3,Math.floor(i)||8),this.heightSegments=Math.max(2,Math.floor(n)||6),s=void 0!==s?s:0,a=void 0!==a?a:2*Math.PI,o=void 0!==o?o:0,l=void 0!==l?l:Math.PI;var h,c,d=[],u=[];for(c=0;c<=this.heightSegments;c++){var p=[],f=[];for(h=0;h<=this.widthSegments;h++){var g=h/this.widthSegments,m=c/this.heightSegments,v=new e.Vector3;v.x=-this.radius*Math.cos(s+g*a)*Math.sin(o+m*l),v.y=this.radius*Math.cos(o+m*l),v.z=this.radius*Math.sin(s+g*a)*Math.sin(o+m*l),this.vertices.push(v),p.push(this.vertices.length-1),f.push(new e.Vector2(g,1-m))}d.push(p),u.push(f)}for(c=0;c<this.heightSegments;c++)for(h=0;h<this.widthSegments;h++){var _=d[c][h+1],y=d[c][h],S=d[c+1][h],x=d[c+1][h+1],b=this.vertices[_].clone().normalize(),w=this.vertices[y].clone().normalize(),M=this.vertices[S].clone().normalize(),C=this.vertices[x].clone().normalize(),P=u[c][h+1].clone(),E=u[c][h].clone(),T=u[c+1][h].clone(),A=u[c+1][h+1].clone();Math.abs(this.vertices[_].y)===this.radius?(this.faces.push(new e.Face3(_,S,x,[b,M,C])),this.faceVertexUvs[0].push([P,T,A])):Math.abs(this.vertices[S].y)===this.radius?(this.faces.push(new e.Face3(_,y,S,[b,w,M])),this.faceVertexUvs[0].push([P,E,T])):(this.faces.push(new e.Face4(_,y,S,x,[b,w,M,C])),this.faceVertexUvs[0].push([P,E,T,A]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new e.Sphere(new e.Vector3,t)},r.SphereGeometry.prototype=Object.create(r.LegacyGeometry.prototype),r.TextGeometry=function(t,i){var n=e.FontUtils.generateShapes(t,i);i.amount=void 0!==i.height?i.height:50,void 0===i.bevelThickness&&(i.bevelThickness=10),void 0===i.bevelSize&&(i.bevelSize=8),void 0===i.bevelEnabled&&(i.bevelEnabled=!1),r.ExtrudeGeometry.call(this,n,i)},r.TextGeometry.prototype=Object.create(r.ExtrudeGeometry.prototype),r}),function(){var e="file:"!==window.location.protocol?"text!Visualization/assets/svgmode.json":null;define("DS/Visualization/GetSVGMode",[e],function(e){var t=e&&JSON.parse(e);return{getWebGLMode:function(){return!(t&&"svg"===t.svgMode||window.v6ViewerSVGBrowserMode)}}})}(),define("DS/Visualization/SceneGraphConverter",["DS/VisuLoaders/SceneGraphConverter"],function(e){"use strict";return e}),define("Visualization/SceneGraphConverter",["DS/Visualization/SceneGraphConverter","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraphConverter"),e}),define("DS/Visualization/ParticlesLoader",["DS/VisuLoaders/ParticlesLoader"],function(e){"use strict";return e}),define("Visualization/ParticlesLoader",["DS/Visualization/ParticlesLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ParticlesLoader"),e}),define("DS/Visualization/SectionBuilder",["DS/Mesh/Mesh"],function(e){"use strict";var t;function i({geom:e,index_ranges:t,plane:i,deduplication:r=null}){const n=e.vertexPositionArray;function s(e){const t=3*e;return i.x*n[t]+i.y*n[t+1]+i.z*n[t+2]+i.w}const a=[];function o(e){const t=3*e;a.push(n[t],n[t+1],n[t+2])}function l(e,t,i){const r=3*e,s=3*t,o=(1-i)*n[r]+i*n[s],l=(1-i)*n[r+1]+i*n[s+1],h=(1-i)*n[r+2]+i*n[s+2];a.push(o,l,h)}const h=e.vertexIndexArray,c=r?e=>r[h[e]]:e=>h[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=c(e),i=c(e+1),r=c(e+2),n=s(t),a=s(i),h=s(r),d=n*a<=0?-n/(a-n):null,u=a*h<=0?-a/(h-a):null,p=h*n<=0?-h/(n-h):null;if(null===d&&null===u&&null===p)continue;let f=!1;Number.isNaN(d)&&(o(t),o(i),f=!0),Number.isNaN(u)&&(o(i),o(r),f=!0),Number.isNaN(p)&&(o(r),o(t),f=!0),f||(null!==d&&d<1&&l(t,i,d),null!==u&&u<1&&l(i,r,u),null!==p&&p<1&&l(r,t,p))}}return new Float32Array(a)}function r(e,t){const i=e.length;for(let r=0;r<i;r+=3)e[r]+=t.x,e[r+1]+=t.y,e[r+2]+=t.z}function n({renderable:n,clipPlanes:s,sectionLines:a,lineWidth:o=1,color:l="#000000",visibleSpace:h}){if(0===s.length)return null;const c=(new t.Matrix4).copy(n.matrixWorld).transpose(),d=s.map(e=>new t.Vector4(e.normal.x,e.normal.y,e.normal.z,e.constant).applyMatrix4(c)),u=function(e,i){let r=new Map;function n(e,t,i){const n=r.get(e);n?n.push([t,t+i]):r.set(e,[[t,t+i]])}if(e.layer)for(let r=0;r<e.layer.layers.length;r++){const s=e.layer.layers[r].drawableGroup;if(s._geomType!==t.GeomTypeEnum.FACE)continue;const a=e.layer.layers[r].drawableInterval;a.skip(e,i)||n(s.geometry,a.start,a.count)}else{const i=e.geometry.length;for(let r=0;r<i;r++){const i=e.geometry[r];for(let e=0;e<i.drawingGroups.length;e++){const r=i.drawingGroups[e];r._geomType===t.GeomTypeEnum.FACE&&n(i,r.start,r.count)}}}return r}(n,h),p=[];u.forEach((e,n)=>{const s=function({geom:e,index_ranges:n,planes:s,clipPlanes:a,sectionLines:o,deduplication:l=null}){const h=[];for(let a=0;a<s.length;a++)if(o[a]){const o=s[a],c=i({geom:e,index_ranges:n,plane:o,deduplication:l});r(c,new t.Vector3(o.x,o.y,o.z).normalize().multiplyScalar(5e-4)),h.push(c)}else h.push([]);const c=[];for(let e=0;e<h.length;e++){const t=h[e];let i=t.length;for(let r=0;r<s.length;r++){if(r===e)continue;const n=s[r];let a=0;for(let e=0;e<i;e+=6){const i=t[e],r=t[e+1],s=t[e+2],o=t[e+3],l=t[e+4],h=t[e+5],c=n.x*i+n.y*r+n.z*s+n.w,d=n.x*o+n.y*l+n.z*h+n.w;let u=null;c*d<=0?0==(u=-c/(d-c))&&d<0?u=null:1===u&&c<0&&(u=null):c>0&&(u=NaN),Number.isNaN(u)?a!==e?(t[a++]=i,t[a++]=r,t[a++]=s,t[a++]=o,t[a++]=l,t[a++]=h):a+=6:null!==u&&(t[a++]=(1-u)*i+u*o,t[a++]=(1-u)*r+u*l,t[a++]=(1-u)*s+u*h,c>0?(t[a++]=i,t[a++]=r,t[a++]=s):(t[a++]=o,t[a++]=l,t[a++]=h))}i=a}0!==i&&c.push(t.subarray(0,i))}return c}({geom:n,index_ranges:e=function(e){if(e.length<2)return e;e.sort((e,t)=>e[0]-t[0]);let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),planes:d,sectionLines:a});p.push(...s)});let f=0;for(let e=0;e<p.length;e++)f+=p[e].length;const g=new Float32Array(f);let m=0;for(let e=0;e<p.length;e++)g.set(p[e],m),m+=p[e].length;let v=[];for(let e=0;e<f/3;e++)v.push(e);v=new Uint32Array(v);const _=new t.BufferGeometryDS;_.vertexPositionArray=g,_.vertexIndexArray=v,_.boundingSphere=n.boundingSphere,_.boundingBox=n.boundingBox;const y=new t.LineBasicMaterial({color:l,lineWidth:o,force:!0});y.enableClipPlanes=!1,y.side=t.DoubleSide,y.polygonOffset=!0,y.polygonOffsetFactor=-1.5,y.polygonOffsetUnits=-10;const S={start:0,count:_.vertexIndexArray.length},x=new e.DrawingGroup(y,y,1,0,_.vertexIndexArray.length,[S],void 0,0);return _.drawingGroups=[x],x.geometry=_,_}var s=function(e){for(var t=1;t<e;)t*=2;return t};return class{constructor({renderable:e,renderer:i,lineWidth:r,color:n,clipPlanes:s,sectionLines:a}){t=THREEDS.Core,this._color=new t.Color(n||0),this.lineWidth=r||1,this.wide=this.lineWidth>1,this._renderable=e,this.clipPlanes=s,this.sectionLines=this.computeInternalSectionLineArray(s,a),this.resetBuffers(),this.renderer=i,this.sectionLineGeometry=null}resetBuffers(){this.indexArray=null,this.currentsArray=null,this.edgeLastIndexArray=null,this._Id=0,this._edgeId=0,this.halfEdges=[],this.halfEdgesStructure=null,this._positionArray=null}allocateArrays(e){if(this.wide){this.indexArray=new Uint32Array(3*e*2);var t=6*e;this.currentsArray=new Float32Array(2*t),this.edgeLastIndexArray=new Float32Array(6*e*2)}else this.indexArray=new Uint32Array(2*e),t=6*e,this.currentsArray=new Float32Array(t),this.edgeLastIndexArray=new Float32Array(6*e)}addEdgeIndices(e,t,i){var r=this.indexArray,n=this.currentsArray,s=this.edgeLastIndexArray,a=this._edgeId;if(this.wide){var o=4*a,l=4*a+1,h=4*a+2,c=4*a+3;r[6*a]=o,r[6*a+1]=h,r[6*a+2]=c,r[6*a+3]=o,r[6*a+4]=c,r[6*a+5]=l,n[12*a]=e,n[12*a+1]=t,n[12*a+2]=i,n[12*a+3]=e,n[12*a+3+1]=t,n[12*a+3+2]=i,n[12*a+6]=t,n[12*a+6+1]=i,n[12*a+6+2]=e,n[12*a+9]=t,n[12*a+9+1]=i,n[12*a+9+2]=e,s[12*a]=1,s[12*a+1]=1,s[12*a+2]=0,s[12*a+3]=1,s[12*a+3+1]=-1,s[12*a+3+2]=0,s[12*a+6]=-1,s[12*a+6+1]=1,s[12*a+6+2]=0,s[12*a+9]=-1,s[12*a+9+1]=-1,s[12*a+9+2]=0}else r[2*a]=2*a,r[2*a+1]=2*a+1,n[6*a]=e,n[6*a+1]=t,n[6*a+2]=i,n[6*a+3]=t,n[6*a+4]=i,n[6*a+5]=e,s[6*a]=1,s[6*a+1]=0,s[6*a+2]=0,s[6*a+3]=-1,s[6*a+4]=0,s[6*a+5]=0;this._edgeId++}processTriangleIndices(e,t,i){this.addEdgeIndices(e,t,i),this.addEdgeIndices(t,i,e),this.addEdgeIndices(i,e,t)}computeSectionLineGeometry(){!!localStorage.getItem("useCPUSection")||(this.clipPlanes=null),this.clipPlanes?this.sectionLineGeometry=n({renderable:this._renderable,clipPlanes:this.clipPlanes,sectionLines:this.sectionLines,lineWidth:this.lineWidth,color:this._color,visibleSpace:this.renderer.visibleSpace}):this.computeSectionLineGeometry_old()}setColor(e){if(null===e)return;const t=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;t&&t.color.set(e)}computeInternalSectionLineArray(e,t){let i=null;if(t||!e)i=t;else{let t;for(i=[],t=0;t<e.length;t++)i.push(!0)}return i}update({width:e,color:t,clipPlanes:i,sectionLines:r}){this.setColor(t);const n=this.sectionLineGeometry&&this.sectionLineGeometry.drawingGroups[0].material;if(this.clipPlanes){if(n){if(!i||this.clipPlanes.length!==i.length)return!1;const t=this.computeInternalSectionLineArray(i,r);for(let e=0;e<this.clipPlanes.length;e++)if(!this.clipPlanes[e].equals(i[e])||this.sectionLines[e]!==t[e])return!1;return n.setLineWidth(e),!0}return!1}return this.lineWidth===e}dispose(){this.sectionLineGeometry&&this.sectionLineGeometry.dispose(),this.sectionLineGeometry=null}computeSectionLineGeometry_old(){var e,t,i,r,n,s,a=THREEDS.Core,o=this._renderable,l=[],h=this.renderer.visibleSpace,c=0;if(o.layer){var d={};for(u=0;u<o.layer.layers.length;u++)P=o.layer.layers[u].drawableGroup,(w=o.layer.layers[u].drawableInterval).skip(o,h)||(d[P.geometry.id]=P.geometry,c+=P._geomType===a.GeomTypeEnum.FACE?w.count:0);for(var u in d)l.push(d[u])}else{l=o.geometry;for(var p=o.geometry.length,u=0;u<p;u++){(C=o.geometry[u]).drawingGroups.length;for(var f=0;f<C.drawingGroups.length;f++)c+=(P=C.drawingGroups[f])._geomType===a.GeomTypeEnum.FACE?P.count:0}}if(0===c)return null;this.allocateArrays(c);var g=0,m=0,v=[],_=[];for(u=0;u<l.length;u++)v[u]=g,_[u]=m,g+=l[u].vertexIndexArray.length,m+=l[u].vertexPositionArray.length;if(1===l.length)e=l[0].vertexIndexArray,t=l[0].vertexPositionArray;else{e=new Uint32Array(g),t=new Float32Array(m);var y=0,S=0;for(u=0;u<l.length;u++){for(var x=l[u],b=0;b<x.vertexIndexArray.length;b++)e[y]=_[u]/3+x.vertexIndexArray[b],y++;for(b=0;b<x.vertexPositionArray.length;b++)t[S]=x.vertexPositionArray[b],S++}}if(this.halfEdgesStructure={},s=e.length,this.maxIndices=s,this._positionArray=t,o.layer)for(u=0;u<o.layer.layers.length;u++){var w;if(P=o.layer.layers[u].drawableGroup,!(w=o.layer.layers[u].drawableInterval).skip(o,h)&&P._geomType===a.GeomTypeEnum.FACE){var M=l.indexOf(P.geometry);for(E=v[M]+w.start;E<v[M]+w.start+w.count;E+=3)i=e[E],r=e[E+1],n=e[E+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,s)}}else for(p=l.length,u=0;u<p;u++){var C=l[u];for(f=0;f<C.drawingGroups.length;f++){var P;if((P=C.drawingGroups[f])._geomType===a.GeomTypeEnum.FACE)for(var E=v[u]+P.start;E<v[u]+P.start+P.count;E+=3)i=e[E],r=e[E+1],n=e[E+2],i!==r&&r!==n&&i!==n&&this.processTriangleIndices(i,r,n,s)}}this.sectionLineGeometry=this.createNewGeometry(),this.resetBuffers()}createNewGeometry(t){var i,r=THREEDS.Core,n=this.indexArray.length,a=[],o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),h=l*l,c=this._positionArray.length/3,d=Math.ceil(c/h),u=c-Math.floor(c/h)*h,p=Math.sqrt(u),f=s(p),g=s(u/f),m=3*((d-1)*h+f*g),v=new Float32Array(m);v.set(this._positionArray);for(var _=0;_<d-1;_++){var y;(y=new r.DataTexture(v.subarray(_*h*3,(_+1)*h*3),l,l,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,y.magFilter=r.NearestFilter,y.generateMipmaps=!1,y.flipY=!1,y.needsUpdate=!0,a.push(y)}(y=new r.DataTexture(v.subarray((d-1)*h*3,m),f,g,r.RGBFormat,r.FloatType)).minFilter=r.NearestFilter,y.magFilter=r.NearestFilter,y.generateMipmaps=!1,y.flipY=!1,y.needsUpdate=!0,a.push(y);var S={NB_OUTLINE_MAPS:d,MAX_OUTLINE_MAP_SIZE:l.toFixed(1),LAST_OUTLINE_MAP_SIZE_X:f.toFixed(1),LAST_OUTLINE_MAP_SIZE_Y:g.toFixed(1)};(i=this.wide?new r._WideSectionMaterial(S,a,.5*this.lineWidth):new r._SectionMaterial(S,a)).color.set(this._color);var x=new e.DrawingGroup(i,i,this.wide?4:1,0,n),b=new r.BufferGeometryDS;return b.drawingGroups=[],x.geometry=b,b.drawingGroups.push(x),b.vertexPositionArray=this.currentsArray,b.vertexUvArray=this.edgeLastIndexArray,b.vertexIndexArray=this.indexArray,b.boundingSphere=this._renderable.boundingSphere,b.boundingBox=this._renderable.boundingBox,b}}}),define("DS/Visualization/BufferGPUManager",["UWA/Class","DS/Mesh/ThreeJS_Base"],function(e,t){"use strict";const i=t.IsFirefox;var r=e.extend({init:function(){return this.__builder__=null,this.reset(),this},reset:function(){this._gl=null,this._infos=new Map,this.initAtLoading=!1,this.sharedGeometriesToInit=new Map,this.intermediaryArray=null,this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null,this.fillMapGeomBufferSize=!1,this.mapGeomBufferSize=new Map},addToMapGeomBufferSize:function(e){this.fillMapGeomBufferSize&&this.mapGeomBufferSize.set(e.id,e.getBuffersMemorySize())},addGeometryFromObject:function(e){if(e.geometry&&!(2!==e.geometry._type&&e.geometry.length<0)){var t=e.geometry;if(2===t._type&&(t=[t]),t[0])if(t[0].sharedBuffers)this.sharedGeometriesToInit.has(t[0].id)||(this.sharedGeometriesToInit.set(t[0].id,t),this.initAtLoading&&this.allocateShared(!1));else if(this.initAtLoading)for(var i=0;i<t.length;i++)this.allocateDirect(t[i],e),this.allocateInstancingBuffers(e,null)}},geometryInfoDecrement:function(){this._infos.forEach(function(e,t,i){e.memory.geometries--})},geometryInfoIncrement:function(){this._infos.forEach(function(e,t,i){e.memory.geometries++})},sharedBufferInfoIncrement:function(){this._infos.forEach(function(e,t,i){e.memory.sharedbuffers++})},doInterleavingThroughCompute:function(e,t,i){},allocateDirect:function(e){e.wideLinesLinker&&!e.wideLinesLinker._isParent(e)&&e.__setTypedArraysForWidelines();let i=!1;if(!e.vertexBufferGPU){const r=e.getVertexCount(),n=r>0?e.layout.clone():null;if(r>0&&n&&n.size()>0){this.addToMapGeomBufferSize(e);let s=null;if(!e.editable&&this.interleaveThroughCompute&&this._device)this.doInterleavingThroughCompute(e,n,r);else{let i=void 0,a=void 0,o=n.getFullInterleaving();if(o)i=e.buffers[o.bufferId],a=o.stride;else{n.interleave();const t=(a=n.getFullInterleaving().stride)*r;!e.editable&&this.intermediaryArray&&this.intermediaryArray.byteLength>=t?i=this.intermediaryArray.subarray(0,t):(i=new Uint8Array(t),e.editable||(this.intermediaryArray=i)),e.exportRaw({target_array:i,target_layout:n})}if(this._device){s=new t.WEBGPUVertexBuffer(this._device,i.byteLength);const e=new Uint8Array(s.buffer.getMappedRange());s.buffer._ab=e,e.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),s.buffer.unmap()}else s=new t.GLVertexBuffer({gl:this._gl}),this._gl&&this._gl.bindBuffer(this._gl.ARRAY_BUFFER,s.buffer),this._gl&&this._gl.bufferData(this._gl.ARRAY_BUFFER,i,e.editable?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW);e.editable&&(s.interleavedData=i)}s.nbGeometries=1,s.numVertices=r,s.layout=n,e.vertexBufferGPU=s,e.vertexOffsetGPU=0,e.vertexCountGPU=s.numVertices,this.geometryInfoIncrement(),e._markAllAttributesClean(),i=!0}}if(!e.indexBufferGPU){let r=e.vertexIndexArray;if(0!==e.vertexOffsetGPU){const t=e.vertexOffsetGPU;r=e.vertexIndexArray.map(e=>e+t)}let n=null;if(this._device){if(n=new t.WEBGPUIndexBuffer(this._device,r?4*Math.ceil(r.byteLength/4):0),r){const e=new Uint8Array(n.buffer.getMappedRange());n.buffer._ab=e,e.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength)),n.buffer.unmap()}}else n=new t.GLIndexBuffer({gl:this._gl}),r&&(this._gl&&this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,n.buffer),this._gl&&this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.STATIC_DRAW));n.use32bitIndexBuffer=!!r&&r instanceof Uint32Array,n.numIndices=r?r.length:0,n.nbGeometries=1,e.indexBufferGPU=n,e.indexOffsetGPU=0,e.indexCountGPU=n.numIndices,e._markIndexClean(),i=!0}i&&e.noMeshInRAM&&!e.sharedBuffers&&!e.editable&&e.clearMeshInRAM(!1)},allocateInstancingBuffers:function(e,t){let i=t&&t._instancingInfos?t._instancingInfos:e&&e._instancingInfos?e._instancingInfos:null;if(i&&i.instanceAttribArrays){var r=i.instanceAttribArrays;for(var n in r)"id"!==n&&null!==r[n].array&&null===r[n].buffer&&(r[n].buffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,r[n].buffer),r[n].isDynamic?this._gl.bufferData(this._gl.ARRAY_BUFFER,r[n].array,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,r[n].array,this._gl.STATIC_DRAW),r[n].buffer.itemSize=r[n].itemSize,r[n].buffer.numItems=i.nbInstances)}},allocateShared:function(e){if(0==this.sharedGeometriesToInit.size)return;let r=Number.MAX_SAFE_INTEGER;if(i){parseFloat(navigator.userAgent.substr(navigator.userAgent.length-4))>=60&&(r=250)}const n=[],s={};if(this.sharedGeometriesToInit.forEach(e=>{for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;if(i.vertexBufferGPU&&i.vertexBufferGPU.isShared)continue;if(!i.vertexIndexArray){console.warn("no geometry available, are you trying to reattach a mesh while noMeshInRAM has been activated?");continue}const a=i.layout.getSignature();let o=s[a];o||(o={geoms:[],dgCount:0,vertexCount:0,indexCount:0},s[a]=o),o.geoms.push(i),o.vertexCount+=i.getVertexCount(),o.indexCount+=i.vertexIndexArray.length,o.dgCount+=i.drawingGroups.length,(o.vertexCount>2097152||o.dgCount>r)&&(n.push(o),s[a]=null)}}),e)for(let e in s){const t=s[e];t&&t.dgCount>0&&n.push(t)}for(let e=0;e<n.length;e++){const i=n[e];let r=i.geoms[0].layout.clone();r.interleave();const s=r.getFullInterleaving().stride,o=s*i.vertexCount;let l=t.supportedExtensions.elementIndexUint&&i.vertexCount>65535;const h=i.indexCount*(l?4:2);let c=null,d=null,u=null,p=null;this._device?(c=new t.WEBGPUVertexBuffer(this._device,o),u=new Uint8Array(c.buffer.getMappedRange()),c.buffer._ab=u,(d=new t.WEBGPUIndexBuffer(this._device,4*Math.ceil(h/4))).numIndices=i.indexCount,d.use32bitIndexBuffer=l,p=new Uint8Array(d.buffer.getMappedRange()),d.buffer._ab=p):(c=new t.GLVertexBuffer({gl:this._gl}),d=new t.GLIndexBuffer({gl:this._gl,numIndices:i.indexCount,use32bitIndexBuffer:l})),c.numVertices=i.vertexCount,c.nbGeometries=i.geoms.length,c.isShared=!0,c.layout=r,d.nbGeometries=i.geoms.length,d.isShared=!0,this.sharedBufferInfoIncrement();for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e];this.sharedGeometriesToInit.delete(t.id),(t.vertexBufferGPU||t.indexBufferGPU)&&(t.deallocate(this._gl,null),this.geometryInfoDecrement()),t.vertexBufferGPU=c,t.indexBufferGPU=d;for(var a=0;a<t.meshList.length;a++)t.meshList[a]._flagAsGSSOInvalidated()}this._device||(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,c.buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,o,this._gl.STATIC_DRAW));let f=0;for(let e=0;e<i.geoms.length;e++){const t=i.geoms[e],r=t.getVertexCount(),n=r*s;t.vertexOffsetGPU=f/s,t.vertexCountGPU=r;let a=null;this.sharingIntermediaryArray&&this.sharingIntermediaryArray.length>=n?a=this.sharingIntermediaryArray.subarray(0,n):(a=new Uint8Array(n),this.sharingIntermediaryArray=a),t.exportRaw({target_array:a,target_layout:c.layout}),this._device?u.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength),f):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,f,a),f+=n,t.noMeshInRAM&&t.clearMeshInRAM(!0),this.geometryInfoIncrement()}this._device||(this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,d.buffer),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,h,this._gl.STATIC_DRAW));let g=0;for(let e=0;e<i.geoms.length;e++){let t=i.geoms[e];const r=t.vertexIndexArray.length;t.indexOffsetGPU=g,t.indexCountGPU=r;let n=null,s=d.use32bitIndexBuffer?this.sharingIntermediaryIndex32Array:this.sharingIntermediaryIndex16Array;s&&s.length>=r?n=s.subarray(0,r):d.use32bitIndexBuffer?(n=new Uint32Array(r),this.sharingIntermediaryIndex32Array=n):(n=new Uint16Array(r),this.sharingIntermediaryIndex16Array=n);for(let e=0;e<r;e++)n[e]=t.vertexOffsetGPU+t.vertexIndexArray[e];this._device?p.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),g*d.bytesPerIndex):this._gl.bufferSubData(this._gl.ELEMENT_ARRAY_BUFFER,g*d.bytesPerIndex,n),g+=r,t.noMeshInRAM&&(t.vertexIndexArray=null)}this._device&&(c.buffer.unmap(),d.buffer.unmap())}e&&(this.sharingIntermediaryArray=null,this.sharingIntermediaryIndex16Array=null,this.sharingIntermediaryIndex32Array=null)},deallocate:function(e){if(null!=e)for(let t=0;t<e.length;t++)this._gl.deleteBuffer(e[t])},setGLContext:function(e,t,i){this._gl=t,this._infos.set(e,i)},setWEBGPUContext:function(e,t,i){this._device=t,this._infos.set(e,i)},dispose:function(e){this._infos.delete(e),0==this._infos.size&&this.reset()}}),n=new r;return n.__builder__=r,n}),define("DS/Visualization/ImageUtils",["DS/Mesh/ThreeJS_Base","DS/GPUFormats/GPUFormats"],function(e,t){"use strict";let i={};var r=null;i.BasisUsage={NOT_BASIS:-1,NO_TRANSCODE:0,RGB:t.RGB_S3TC_DXT1_Format,RGBA:t.RGBA_S3TC_DXT5_Format,RGBHQ:t.RGBA_BPTC_UNORM_Format,NORMAL_MAP:t.REDGREEN_RGTC2_Format,GRAYSCALE:t.RED_RGTC1_Format,BC1:t.RGB_S3TC_DXT1_Format,BC3:t.RGBA_S3TC_DXT5_Format,BC7:t.RGBA_BPTC_UNORM_Format,BC5:t.REDGREEN_RGTC2_Format,BC4:t.RED_RGTC1_Format};var n={__initBasis__:function(e){null===r?require(["DS/BasisLoader/BasisLoader"],function(t){(r=t)(function(){e()})}):r(function(){e()})}};i.Utils=n;var s=function(t,i,r,n,s,a){var o=r.s3tcSupport,l=r.astcSupport,h=r.etcSupport,c=r.etc1Support,d=r.pvrtcSupport,u=r.rgtcSupport,p=r.bptcSupport,f=r.basisUsage,g=!1;switch(f){case 0:return t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA32,void(t.textureType=e.UnsignedByteType);case e.RGB_S3TC_DXT1_Format:if(o)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC1_RGB);break;case e.RGBA_S3TC_DXT5_Format:if(o)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC3_RGBA);break;case e.RED_RGTC1_Format:if(u)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC4_R);g=!0;break;case e.REDGREEN_RGTC2_Format:if(u)return t.textureFormat=f,void(t.transcodeFormat=i.cTFBC5_RG);g=!0;break;case e.RGBA_BPTC_UNORM_Format:if(p)return t.textureFormat=f,void(t.transcodeFormat=n?i.cTFBC7_M5_RGBA:i.cTFBC7_M6_RGB);if(o)return t.textureFormat=n?e.RGBA_S3TC_DXT5_Format:e.RGB_S3TC_DXT1_Format,void(t.transcodeFormat=n?i.cTFBC3_RGBA:i.cTFBC1_RGB);g=!0}if(l)return t.textureFormat=e.RGBA_ASTC_4x4_Format,void(t.transcodeFormat=i.cTFASTC_4x4_RGBA);if(d)if(t.textureFormat=e.RGB_PVRTC_4BPPV1_Format,t.transcodeFormat=i.cTFPVRTC1_4_RGB,n&&(t.textureFormat=e.RGBA_PVRTC_4BPPV1_Format,t.transcodeFormat=i.cTFPVRTC1_4_RGBA),0!=(s&s-1)||0!=(a&a-1))console.error("ERROR: PVRTC1 requires square power of 2 textures");else{if(s==a)return;console.error("ERROR: PVRTC1 requires square power of 2 textures")}else{if(c&&!n)return t.textureFormat=e.RGB_ETC1_Format,void(t.transcodeFormat=i.cTFETC1_RGB);if(h)return t.textureFormat=e.RGBA8_ETC2_EAC_Format,void(t.transcodeFormat=i.cTFETC2_RGBA)}g?(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 8888 fallback"),t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA32,t.textureType=e.UnsignedByteType):n?(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgba 4444 fallback"),t.textureFormat=e.RGBAFormat,t.transcodeFormat=i.cTFRGBA4444,t.textureType=e.UnsignedShort4444Type):(e.VisualizationTraces.info("No supported compression format for basis/ktx2, rgb ushort565 fallback"),t.textureFormat=e.RGBFormat,t.transcodeFormat=i.cTFRGB565,t.textureType=e.UnsignedShort565Type)},a=function(e,t,i,r,n){var s=document.createElement("canvas");s.width=t,s.height=i;var a=s.getContext("2d"),o=a.getImageData(0,0,t,i);o.data.set(new Uint8ClampedArray(e)),a.putImageData(o,0,0);var l=document.createElement("canvas"),h=l.getContext("2d");return l.width=r,l.height=n,h.drawImage(s,0,0,t,i,0,0,r,n),o=h.getImageData(0,0,r,n),new Uint8Array(o.data)};n.loadKTX2Texture=function(t,i,o,l,h,c,d){var u=!!e.supportedExtensions.compressedTexturesS3TC,p=!!e.supportedExtensions.compressedTexturesRGTC,f=!!e.supportedExtensions.compressedTexturesBPTC,g=!!e.supportedExtensions.compressedTexturesASTC,m=!!e.supportedExtensions.compressedTexturesETC,v=!!e.supportedExtensions.compressedTexturesETC1,_=!!e.supportedExtensions.compressedTexturesPVRTC,y=new e.CompressedTexture;if(y.image={},i&&(y.mapping=i),null===c||c===e.BasisUsage.NOT_BASIS)return y.loadEndStatus=e.AssetLoadingStatus.ERROR,console.error("Missing required format parameter"),y;var S=function(){var i;i=function(i,r){if(!i)return y.loadEndStatus=e.AssetLoadingStatus.ERROR,console.error("Missing KTX2File in BasisLoader"),void(l&&l());!function(t,i,r,o,l,h,c,d){var u=function(o){var l=function(t,i){console.warn(i),r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),t.close(),t.delete()},u=new t(new Uint8Array(o));if(!1!==r.flipY&&(console.warn("Non matching image convention for ktx2 texture, full rgba 8888 decompression for flipping"),d.basisUsage=0),u.isValid()){var p=u.getLevels();if(p<1)l(u,"No levels in .ktx2 file");else{var f=u.getFaces();if(f>1)if(6!==f)f=1;else{r.extraFaces=new Array(5);for(var g=0;g<5;g++)r.extraFaces[g]=new e.Texture.Face(null,[])}if(u.getHeader().pixelDepth>0)l(u,"Non 2D textures are not supported in .ktx2 files");else if(u.getLayers()>0)l(u,"Array textures are not supported in .ktx2 files");else if(u.startTranscoding()){var m=u.getWidth(),v=u.getHeight(),_={textureFormat:0,transcodeFormat:0,textureType:0},y=!1;n.is_pow2(m)&&n.is_pow2(v)||(console.warn("Non power of two compressed ktx2 texture, full rgba 8888 decompression for resizing"),y=!0,d.basisUsage=0);var S=u.getHasAlpha();s(_,i,d,S,m,v),r.format=_.textureFormat,0!==_.textureType&&(r.flipY=!1!==r.flipY,r.type=_.textureType),r.sRGB=2===u.getDFDTransferFunc(),r.premultipliedAlpha=(1&u.getDFDFlags())>0;for(var x=0;x<f;x++){const t=0===x?r.mipmaps:r.extraFaces[x-1].mipmaps;for(var b=0;b<p;b++){var w=u.getImageLevelInfo(b,0,x);m=w.origWidth,v=w.origHeight;var M={data:null,width:0,height:0};t.push(M);var C=u.getImageTranscodedSizeInBytes(b,0,x,_.transcodeFormat),P=new Uint8Array(C);if(!u.transcodeImage(P,b,0,x,_.transcodeFormat,S,-1,-1))return void l(u,"transcodeImage failed");var E=m>=4?m+3&-4:m,T=v>=4?v+3&-4:v;M.width=E,M.height=T,y?n.is_pow2(m)&&n.is_pow2(v)?M.data=P:(e.VisualizationTraces.info("Resizing ktx2 texture to power of two"),M.width=n.nearest_smaller_pow2(m),M.height=n.nearest_smaller_pow2(v),M.data=a(P,m,v,M.width,M.height)):_.textureType===e.UnsignedShort565Type||_.textureType===e.UnsignedShort4444Type?M.data=new Uint16Array(P.buffer):M.data=P}}for(u.close(),u.delete(),r.loadEndStatus=e.AssetLoadingStatus.READY,r.needsUpdate=!0,h&&h(r),g=0;g<r.onLoadCallbacks.length;g++)r.onLoadCallbacks[g](r)}else l(u,"startTranscoding failed")}}else l(u,"Invalid .ktx2 file")};if("string"==typeof o){var p=new XMLHttpRequest;p.withCredentials=!!l,p.responseType="arraybuffer",p.open("GET",o,!0),p.onload=function(){n.nbTexturesBeingLoaded--,u(p.response)},p.onerror=function(){r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),n.nbTexturesBeingLoaded--},n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,p.send(null)}else{if(!(o instanceof Uint8Array))return void console.error("Invalid ktx2 data: returning empty texture");u(o.buffer)}}(i,r,y,t,h,o,l,{s3tcSupport:u,astcSupport:g,etc1Support:v,etcSupport:m,pvrtcSupport:_,rgtcSupport:p,bptcSupport:f,basisUsage:c})},null===r?require(["DS/BasisLoader/BasisLoader"],function(e){(r=e)(function(e){i(e.KTX2File,e.BasisFormat)})}):r(function(e){i(e.KTX2File,e.BasisFormat)})};return d?(y.loadEndStatus=e.AssetLoadingStatus.PAUSED,y.onRequest=function(){y.loadEndStatus=e.AssetLoadingStatus.LOADING,S(),y.onRequest=null}):(y.loadEndStatus=e.AssetLoadingStatus.LOADING,S()),y};n.loadBasisTexture=function(t,i,o,l,h,c,d,u){var p=!!e.supportedExtensions.compressedTexturesS3TC,f=!!e.supportedExtensions.compressedTexturesRGTC,g=!!e.supportedExtensions.compressedTexturesBPTC,m=!!e.supportedExtensions.compressedTexturesASTC,v=!!e.supportedExtensions.compressedTexturesETC,_=!!e.supportedExtensions.compressedTexturesETC1,y=!!e.supportedExtensions.compressedTexturesPVRTC,S=u||new e.CompressedTexture;if(S.image={},i&&(S.mapping=i),null===c||c===e.BasisUsage.NOT_BASIS)return S.loadEndStatus=e.AssetLoadingStatus.ERROR,console.error("Missing required format parameter"),S;var x=function(){var i;i=function(i,r){if(!i)return S.loadEndStatus=e.AssetLoadingStatus.ERROR,console.error("Missing BasisFile in BasisLoader"),void(l&&l());!function(t,i,r,o,l,h,c,d){var u=function(o){var l=function(t,i){console.warn(i),r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),t.close(),t.delete()},u=new t(new Uint8Array(o)),p=u.getFileDesc().yFlipped;p!==r.flipY&&(console.warn("Non matching image convention for basis texture, full rgba 8888 decompression for flipping"),d.basisUsage=0);var f=u.getNumImages(),g=u.getNumLevels(0);if(f&&g)if(u.startTranscoding()){var m=u.getImageWidth(0,0),v=u.getImageHeight(0,0);if(f>1)if(6!==f)f=1;else{for(var _=!1,y=0;y<f;y++){var S=u.getNumLevels(y),x=u.getImageWidth(y,0),b=u.getImageHeight(y,0);if(_=S!==g||x!==m||b!==v)break}if(_)f=1;else{r.extraFaces=new Array(5);for(var w=0;w<5;w++)r.extraFaces[w]=new e.Texture.Face(null,[])}}var M={textureFormat:0,transcodeFormat:0,textureType:0},C=!1;n.is_pow2(m)&&n.is_pow2(v)||(console.warn("Non power of two compressed basis texture, full rgba 8888 decompression for resizing"),C=!0,d.basisUsage=0);var P=u.getHasAlpha();for(s(M,i,d,P,m,v),r.format=M.textureFormat,0!==M.textureType&&(r.flipY=p!==r.flipY,r.type=M.textureType),y=0;y<f;y++){const t=0===y?r.mipmaps:r.extraFaces[y-1].mipmaps;for(var E=0;E<g;E++){m=u.getImageWidth(y,E),v=u.getImageHeight(y,E);var T={data:null,width:0,height:0};t.push(T);var A=u.getImageTranscodedSizeInBytes(y,E,M.transcodeFormat),D=new Uint8Array(A);if(!u.transcodeImage(D,y,E,M.transcodeFormat,0,P))return void l(u,"transcodeImage failed");var I=m>=4?m+3&-4:m,R=v>=4?v+3&-4:v;T.width=I,T.height=R,C?n.is_pow2(m)&&n.is_pow2(v)?T.data=D:(e.VisualizationTraces.info("Resizing basis texture to power of two"),T.width=n.nearest_smaller_pow2(m),T.height=n.nearest_smaller_pow2(v),T.data=a(D,m,v,T.width,T.height)):M.textureType===e.UnsignedShort565Type||M.textureType===e.UnsignedShort4444Type?T.data=new Uint16Array(D.buffer):T.data=D}}for(u.close(),u.delete(),r.loadEndStatus=e.AssetLoadingStatus.READY,r.needsUpdate=!0,h&&h(r),w=0;w<r.onLoadCallbacks.length;w++)r.onLoadCallbacks[w](r)}else l(u,"startTranscoding failed");else l(u,"Invalid .basis file")};if("string"==typeof o){var p=new XMLHttpRequest;p.withCredentials=!!l,p.responseType="arraybuffer",p.open("GET",o,!0),p.onload=function(){n.nbTexturesBeingLoaded--,u(p.response)},p.onerror=function(){r.loadEndStatus=e.AssetLoadingStatus.ERROR,c&&c(),n.nbTexturesBeingLoaded--},n.nbTexturesBeingLoaded++,r.loadEndStatus=e.AssetLoadingStatus.LOADING,p.send(null)}else{if(!(o instanceof Uint8Array))return void console.error("Invalid basis data: returning empty texture");u(o.buffer)}}(i,r,S,t,h,o,l,{s3tcSupport:p,astcSupport:m,etc1Support:_,etcSupport:v,pvrtcSupport:y,rgtcSupport:f,bptcSupport:g,basisUsage:c})},null===r?require(["DS/BasisLoader/BasisLoader"],function(e){(r=e)(function(e){i(e.BasisFile,e.BasisFormat)})}):r(function(e){i(e.BasisFile,e.BasisFormat)})};return d?(S.loadEndStatus=e.AssetLoadingStatus.PAUSED,S.onRequest=function(){S.loadEndStatus=e.AssetLoadingStatus.LOADING,x(),S.onRequest=null}):(S.loadEndStatus=e.AssetLoadingStatus.LOADING,x()),S},n.nbTexturesBeingLoaded=0,n.crossOrigin="anonymous",n.is_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)===t},n.nearest_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},n.nearest_greater_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.ceil(t))},n.nearest_smaller_pow2=function(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.floor(t))},n._loadTextureWithProxy=function(t,i,r,n,s,a,o,l){return window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(t=UWA.Data.proxifyUrl(t,{proxy:"passport"})),e.ImageUtils.loadTexture(t,i,r,n,s,a,o,l)},n.loadTexture=function(t,i,r,s,a,o,l,h,c){var d=document.createElement("canvas");d.width=16,d.height=16;var u=h;u?(u.image=d,u.mapping=i):u=new e.Texture(d,i),u.loadEndStatus=e.AssetLoadingStatus.LOADING;var p=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),f=!t.startsWith("data:");if(p&&f&&(void 0===a||!1===a)){var g={headers:new Object,method:"GET",authentication:"ajax",timeout:36e5,async:!0,type:"blob",onComplete:function(t){var i=URL.createObjectURL(t),a=new Image,l=new e.ImageLoader;l.addEventListener("load",function(t){n.nbTexturesBeingLoaded--,u.needsUpdate=!0,u.loadEndStatus=e.AssetLoadingStatus.READY;var i,s,l,h;if(h=c&&(a.width>c||a.height>c),l=o&&(!n.is_pow2(a.width)||!n.is_pow2(a.height)),h||l){if(i=a.width,s=a.height,l&&(i=n.nearest_pow2(a.width),s=n.nearest_pow2(a.height)),h){for(;i>c||s>c;)i/=2,s/=2;i=Math.floor(i),s=Math.floor(s)}u.image.width=i,u.image.height=s,u.image.getContext("2d").drawImage(a,0,0,i,s)}else u.image=a;r&&r(u);for(var d=0;d<u.onLoadCallbacks.length;d++)u.onLoadCallbacks[d](u)}),l.addEventListener("error",function(t){n.nbTexturesBeingLoaded--,s&&s(t.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR}),l.load(i,a)},onFailure:function(t){n.nbTexturesBeingLoaded--,s&&s(event.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR},onTimeout:function(){n.nbTexturesBeingLoaded--,s&&s(event.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR}};UWA.Data.request(t,g)}else{var m=new Image;null!==a&&(m.crossOrigin=a?"use-credentials":"anonymous");var v=new e.ImageLoader;v.addEventListener("load",function(t){n.nbTexturesBeingLoaded--,u.needsUpdate=!0,u.loadEndStatus=e.AssetLoadingStatus.READY;var i,s,a,l;if(l=c&&(m.width>c||m.height>c),a=o&&(!n.is_pow2(m.width)||!n.is_pow2(m.height)),l||a){if(i=m.width,s=m.height,a&&(i=n.nearest_pow2(m.width),s=n.nearest_pow2(m.height)),l){for(;i>c||s>c;)i/=2,s/=2;i=Math.floor(i),s=Math.floor(s)}u.image.width=i,u.image.height=s,u.image.getContext("2d").drawImage(m,0,0,i,s)}else u.image=m;if(e.WebGPU){!async function(e){e.imageBitmap=await createImageBitmap(e.image)}(u)}r&&r(u);for(var h=0;h<u.onLoadCallbacks.length;h++)u.onLoadCallbacks[h](u)}),v.addEventListener("error",function(t){n.nbTexturesBeingLoaded--,s&&s(t.message),u.loadEndStatus=e.AssetLoadingStatus.ERROR}),m.crossOrigin&&(v.crossOrigin=m.crossOrigin),l?(u.loadEndStatus=e.AssetLoadingStatus.PAUSED,u.onRequest=function(){u.loadEndStatus=e.AssetLoadingStatus.LOADING,v.load(t,m),n.nbTexturesBeingLoaded++,u.onRequest=null}):(v.load(t,m),n.nbTexturesBeingLoaded++),u.sourceFile=t}return u},n.loadTexture2=function(e,t,i,r,s){return console.warn("loadTexture2 is deprecated, use loadTexture with forcePowerOfTwo parameter activated"),n.loadTexture(e,t,i,r,s,!0)},n.loadTGATexture=function(t,i,r,s,a,o){var l=new e.DataTexture(new Uint8Array(16),2,2,e.RGBAFormat,e.UnsignedByteType);l.mapping=i;var h=new XMLHttpRequest;return h.onload=function(){n.nbTexturesBeingLoaded--;var t=new Uint8Array(h.response),i=12,s=t[i]+256*t[i+1],a=t[i+=2]+256*t[i+1];i+=4,l.image.data=new Uint8Array(4*s*a);var o=l.image.data;l.image.width=s,l.image.height=a;for(var c=0;c<a;c++)for(var d=0;d<s;d++){var u=c*s+d;o[4*u]=t[i+4*u+2],o[4*u+1]=t[i+4*u+1],o[4*u+2]=t[i+4*u],o[4*u+3]=t[i+4*u+3]}l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.needsUpdate=!0,r&&r(l);for(var p=0;p<l.onLoadCallbacks.length;p++)l.onLoadCallbacks[p](l)},h.onerror=function(){s&&s(),n.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,h.open("GET",t,!0),h.responseType="arraybuffer",h.withCredentials=!!a,h.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,h.open("GET",t,!0),h.responseType="arraybuffer",h.withCredentials=!!a,h.send(null)),l},n.loadHDRTexture=function(t,i,r,s,a,o,l,h,c,d){var u=d||new e.DataTexture;u.loadEndStatus=e.AssetLoadingStatus.LOADING,u.hdr=!0,u.sRGB=!1,u.mapping=i,u.needsSH=!1,u.shFactorsR=null,u.shFactorsG=null,u.shFactorsB=null;var p=new XMLHttpRequest;return p.onload=function(){n.nbTexturesBeingLoaded--;var t=p.response,s=n.parseRadianceHDR(t,i,a,o,l);if(!n.is_pow2(s.width)||!n.is_pow2(s.height)){var h=n.nearest_pow2(s.width),c=n.nearest_pow2(s.height);!function(e,t,i,r){if(t){for(var n=new Float32Array(3*i*r),s=(e.width-1)/(i-1),a=(e.height-1)/(r-1),o=0;o<r;o++)for(var l=0;l<i;l++){var h=i*o+l,c=s*l,d=a*o,u=e.width*Math.floor(d)+Math.floor(c);n[3*h]=e.data[3*u],n[3*h+1]=e.data[3*u+1],n[3*h+2]=e.data[3*u+2]}e.data=n,e.width=i,e.height=r}}(s,a,h,c)}u.format=s.format,u.type=s.type,u.image.data=s.data,u.image.width=s.width,u.image.height=s.height,u.loadEndStatus=e.AssetLoadingStatus.READY,u.needsSH&&n.computeSphericalHarmonics(u),u.generateMipmaps=!0,u.needsUpdate=!0,r&&r(u);for(var d=0;d<u.onLoadCallbacks.length;d++)u.onLoadCallbacks[d](u)},p.onerror=function(){u.loadEndStatus=e.AssetLoadingStatus.ERROR,s&&s(),n.nbTexturesBeingLoaded--},c?(u.loadEndStatus=e.AssetLoadingStatus.PAUSED,u.onRequest=function(){u.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,p.open("GET",t,!0),p.responseType="arraybuffer",p.withCredentials=!!h,p.send(null),u.onRequest=null}):(u.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,p.open("GET",t,!0),p.responseType="arraybuffer",p.withCredentials=!!h,p.send(null)),u},n._loadTextureVisu=function(e,t,i,r,s,a,o){var l=require.toUrl("DS/"+e+"/assets/"+t);return n.loadTexture(l,i,r,s,a,o)};return n.streamHDRFormat=function(e,t,i){for(var r=function(e,t){var i=function(e,t,i){for(var r=0;r<t.length;r++)e[i++]=t.charCodeAt(r);return i},r="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",n="-Y "+t+" +X "+e,s=new Uint8Array("#?RADIANCE".length+1+r.length+1+"FORMAT=32-bit_rle_rgbe".length+2+n.length+1+e*t*4),a=0;return a=i(s,"#?RADIANCE",a),s[a++]=10,a=i(s,r,a),s[a++]=10,a=i(s,"FORMAT=32-bit_rle_rgbe",a),s[a++]=10,s[a++]=10,a=i(s,n,a),s[a++]=10,{buffer:s,offset:a,width:e,height:t}}(t,i),n=r.buffer,s=r.offset,a=i-1,o=0;o<i;o++){for(var l=t-1,h=0;h<t;h++){for(var c=0;c<4;c++)n[s+4*(t*o+h)+c]=e[4*(t*a+l)+c];l--}a--}return function(e){for(var t=function(e){for(var t=new Uint8Array(2*e.length),i=0;i<e.length;i++)t[i]=e[i];return t},i=e.offset,r=i,n=new Uint8Array(e.buffer.length),s=0;s<i;s++)n[s]=e.buffer[s];for(var a=new Uint8Array(4+5*e.width),o=0;o<e.height;o++){var l=0;a[l++]=2,a[l++]=2,a[l++]=e.width>>8,a[l++]=255&e.width;for(var h=0;h<4;h++){var c=[];for(s=0;s<e.width;){for(var d=0,u=e.buffer[i+4*(o*e.width+s)+h],p=u;s<e.width&&p===u&&d<127;)d++,s++,u=p,p=e.buffer[i+4*(o*e.width+s)+h];if(d>3){if(c.length){a[l++]=c.length;for(var f=0;f<c.length;f++)a[l++]=c[f];c=[]}a[l++]=128+d,a[l++]=u}else{if(c.length+d>127){for(a[l++]=c.length,f=0;f<c.length;f++)a[l++]=c[f];c=[]}c.push(u),d>1&&c.push(u),d>2&&c.push(u)}}if(c.length)for(a[l++]=c.length,f=0;f<c.length;f++)a[l++]=c[f]}r+l>=n.length&&(n=t(n));for(var g=0;g<l;g++)n[r++]=a[g]}var m=new Uint8Array(r);for(s=0;s<r;s++)m[s]=n[s];e.buffer=m}(r),new Blob([r.buffer],{type:"application/octet-binary"})},n.generateBlankHDRTexture=function(t,i){var r=new e.DataTexture;r.hdr=!0,r.sRGB=!1,r.mapping=new e.LatLongReflectionMapping,r.needsSH=!1,r.shFactorsR=null,r.shFactorsG=null,r.shFactorsB=null,r.format=e.RGBAFormat,r.type=e.UnsignedByteType,r.image.width=t,r.image.height=i,r.loadEndStatus=e.AssetLoadingStatus.READY,r.generateMipmaps=!0,r.needsUpdate=!0;for(var n=new Uint8Array(4*t*i),s=0;s<t*i;s++)n[4*s]=255,n[4*s+1]=255,n[4*s+2]=255,n[4*s+3]=127;return r.image.data=n,r},n.computeSphericalHarmonics=function(t){t.mapping;var i,r,n=t.image.data,s=t.image.width,a=t.image.height;if(void 0!==n){if(null===t.shFactorsR){var o=[];for(i=0;i<3;i++)for(o[i]=[],r=0;r<9;r++)o[i][r]=0;var l=function(e){return Math.abs(e)<1e-4?1:Math.sin(e)/e},h=function(e,t,i,r,a,l){var h,c=4*(s*t+e),d=Math.pow(2,n[c+3]-128);for(h=0;h<3;h++){var u,p=1/256*n[c+h]*d;u=.282095,o[h][0]+=p*u*i,u=.488603,o[h][1]+=p*(u*a)*i,o[h][2]+=p*(u*l)*i,o[h][3]+=p*(u*r)*i,u=1.092548,o[h][4]+=p*(u*r*a)*i,o[h][5]+=p*(u*a*l)*i,o[h][7]+=p*(u*r*l)*i,u=.315392,o[h][6]+=p*(u*(3*l*l-1))*i,u=.546274,o[h][8]+=p*(u*(r*r-a*a))*i}return o};if(t.mapping instanceof e.LatLongReflectionMapping)for(r=0;r<a;r++)for(i=0;i<s;i++){c=i/s,d=r/a,f=Math.PI*(2*c-1),p=Math.PI*d,g=Math.sin(p)*Math.cos(f),m=Math.sin(p)*Math.sin(f),v=Math.cos(p),h(i,r,Math.PI/s*2*(Math.PI/a)*Math.sin(p),g,m,v)}else for(i=0;i<s;i++)for(r=0;r<s;r++){var c,d,u,p,f,g,m,v;d=(s/2-i)/(s/2),c=(r-s/2)/(s/2),(u=Math.sqrt(c*c+d*d))>1||(p=Math.PI*u,f=Math.atan2(d,c),g=Math.sin(p)*Math.cos(f),m=Math.sin(p)*Math.sin(f),v=Math.cos(p),h(i,r,2*Math.PI/s*(2*Math.PI/s)*l(p),g,m,v))}var _=function(){var t,i,r;i=.429043,r=.511664;var n=[];for(n[0]=new e.Matrix4,n[1]=new e.Matrix4,n[2]=new e.Matrix4,t=0;t<3;t++)n[t].elements[0]=i*o[t][8],n[t].elements[1]=i*o[t][4],n[t].elements[2]=i*o[t][7],n[t].elements[3]=r*o[t][3],n[t].elements[4]=i*o[t][4],n[t].elements[5]=-i*o[t][8],n[t].elements[6]=i*o[t][5],n[t].elements[7]=r*o[t][1],n[t].elements[8]=i*o[t][7],n[t].elements[9]=i*o[t][5],n[t].elements[10]=.743125*o[t][6],n[t].elements[11]=r*o[t][2],n[t].elements[12]=r*o[t][3],n[t].elements[13]=r*o[t][1],n[t].elements[14]=r*o[t][2],n[t].elements[15]=.886227*o[t][0]-.247708*o[t][6];return n}();null!==_&&(t.shFactorsR=_[0],t.shFactorsG=_[1],t.shFactorsB=_[2])}}else t.needsSH=!0},n.loadTextureCube=function(t,i,r,s){var a={images:[],loadCount:0},o=new e.Texture;o.loadEndStatus=e.AssetLoadingStatus.LOADING,void 0!==i&&(o.mapping=i),o.flipY=!1;for(var l=0;l<t.length;++l){var h=new Image;a.images[l]=h,h.onload=function(){if(a.loadCount+=1,n.nbTexturesBeingLoaded--,6===a.loadCount){o.loadEndStatus!==e.AssetLoadingStatus.ERROR&&(o.loadEndStatus=e.AssetLoadingStatus.READY),o.needsUpdate=!0,o.image=a.images[0],o.extraFaces=new Array(5);for(var t=1;t<a.images.length;t++)o.extraFaces[t-1]=new e.Texture.Face(a.images[t],null);r&&r(o);for(t=0;t<o.onLoadCallbacks.length;t++)o.onLoadCallbacks[t](o)}},h.onerror=function(){a.loadCount+=1,n.nbTexturesBeingLoaded--,o.loadEndStatus=e.AssetLoadingStatus.ERROR,s&&s()},h.crossOrigin=this.crossOrigin,n.nbTexturesBeingLoaded++,h.src=t[l]}return o},n.parseRadianceHDR=function(t,i,r,n,s){var a,o={data:null,width:0,height:0,format:r?e.RGBFormat:e.RGBAFormat,type:r?e.FloatType:e.UnsignedByteType},l={offset:0,data:new Uint8Array(t)},h="";for(a=0;a<10;a++)h+=String.fromCharCode(l.data[l.offset++]);if("#?RADIANCE"!==h)return o;for(var c,d=0;c=d,10!=(d=l.data[l.offset++])||10!=c;);for(var u="";10!=(d=l.data[l.offset++]);)u+=String.fromCharCode(d);if(null===new RegExp(/[-,+][X,Y]\s+([0-9]+)\s+[-,+][X,Y]\s+([0-9]+)/i).exec(u))return o;o.height=RegExp.$1,o.width=RegExp.$2,o.data=r?new Float32Array(o.width*o.height*3):new Uint8Array(o.width*o.height*4);for(var p=new Uint8Array(4*o.width),f=n?(o.height-1)*(r?3:4)*o.width:0,g=function(e,t){return.00390625*t*e},m=function(e,t,i,r){for(s&&(r+=3*(t-1));t-- >0;){var n=Math.pow(2,e[4*t+3]-128);i[r++]=g(n,e[4*t]),i[r++]=g(n,e[4*t+1]),i[r++]=g(n,e[4*t+2]),s&&(r-=6)}},v=function(e,t,i,r){for(;t-- >0;)i[r++]=e[4*t],i[r++]=e[4*t+1],i[r++]=e[4*t+2],i[r++]=e[4*t+3]},_=function(e,t,i){var r,n;if(t<8||t>32767)return y(e,0,t,i);if(2!==(r=i.data[i.offset]))return y(e,0,t,i);if(i.offset++,e[1]=i.data[i.offset++],e[2]=i.data[i.offset++],r=i.data[i.offset++],2!=e[1]||128&e[2])return e[0]=2,e[3]=r,y(e,1,t-1,i);for(r=0;r<4;r++)for(n=0;n<t;){var s=i.data[i.offset++];if(s>128){s&=127;for(var a=i.data[i.offset++];s--;)e[4*n+r]=a,n++}else for(;s--;)e[4*n+r]=i.data[i.offset++],n++}return!(i.data.length===i.offset)},y=function(e,t,i,r){for(var n,s=0;i>0;)if(e[4*t]=r.data[r.offset++],e[4*t+1]=r.data[r.offset++],e[4*t+2]=r.data[r.offset++],e[4*t+3]=r.data[r.offset++],1===e[4*t]&&1===e[4*t+1]&&1===e[4*t+2]){for(n=e[4*t+3]<<s;n>0;n--)e[4*t]=e[4*(t-1)],e[4*t+1]=e[4*(t-1)+1],e[4*t+2]=e[4*(t-1)+2],e[4*t+3]=e[4*(t-1)+3],t++,i--;s+=8}else t++,i--,s=0;return!0},S=o.height-1;S>=0;S--)_(p,o.width,l),r?(m(p,o.width,o.data,f),n?f-=3*o.width:f+=3*o.width):(v(p,o.width,o.data,f),f+=4*o.width);return o},n.streamDDS=function(t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}for(var r=i("DXT1"),n=i("DXT3"),s=i("DXT5"),a=0,o=0;o<t.mipmaps.length;o++)a+=t.mipmaps[o].data.length;var l=new ArrayBuffer(128+a),h=new Int32Array(l,0,32);switch(h[0]=542327876,h[1]=124,h[2]=659463,h[3]=t.image.height,h[4]=t.image.width,h[5]=65536,h[7]=t.mipmaps.length,h[19]=32,h[20]=4,t.format){case e.RGB_S3TC_DXT1_Format:h[21]=r;break;case e.RGB_S3TC_DXT3_Format:h[21]=n;break;case e.RGB_S3TC_DXT5_Format:h[21]=s;break;case e.RGBAFormat:h[20]|=1;case e.RGBFormat:h[20]|=64,h[23]=255,h[24]=65280,h[25]=16711680,h[26]=4278190080;break;default:return void console.error("ImageUtils.streamDDS(): Unsupported FourCC code: ")}h[27]=4198408;var c=new Uint8Array(l,128,a),d=0;for(o=0;o<t.mipmaps.length;o++){for(var u=t.mipmaps[o].data,p=0;p<u.length;p++)c[d+p]=u[p];d+=u.length}return l},n.crossOriginPolicy=!0,n.loadTextureFromFormat=function(e,t,i,r){var s;return"dds"===t?s=n.loadCompressedTexture(blobUrl,null,function(){i&&i(s)},function(){r&&r(s)},!0):"hdr"===t?s=n.loadHDRTexture(blobUrl,null,function(){i&&i(s)},function(){r&&r(s)},!0,!1,!0):(s=n.loadTexture(blobUrl,null,function(){i&&i(s)},function(){r&&r(s)},void 0,!0)).flipY=!0,s},n.loadCompressedTexture=function(t,i,r,s,a,o,l){var h=l||new e.CompressedTexture;h.mapping=i;var c=new XMLHttpRequest;return c.onload=function(){n.nbTexturesBeingLoaded--;var t=c.response,i=n.parseDDS(t,!0,a);if(h.sRGB=i.sRGB,h.format=i.format,i.type&&(h.type=i.type),h.width=i.width,h.height=i.height,i.isCubemap){h.image={data:null,width:i.width,height:i.height};var s=i.mipmaps.length/i.mipmapCount;h.extraFaces=new Array(s-1);for(var o=0;o<s;o++){var l=h;o>0&&(l=new e.Texture.Face(null,[]),h.extraFaces[o-1]=l);for(var d=0;d<i.mipmapCount;d++)l.mipmaps.push(i.mipmaps[o*i.mipmapCount+d])}var u=h.extraFaces[2];h.extraFaces[2]=h.extraFaces[1],h.extraFaces[1]=u}else h.mipmaps=i.mipmaps,h.image.width=i.width,h.image.height=i.height;h.generateMipmaps=!1,(!h.mipmaps||h.mipmaps&&h.mipmaps.length<2)&&(1003!=h.magFilter&&1006!=h.magFilter&&(h.magFilter=1006),1003!=h.minFilter&&1006!=h.minFilter&&(h.minFilter=1006)),h.needsUpdate=!0,h.loadEndStatus=e.AssetLoadingStatus.READY,r&&r(h);for(d=0;d<h.onLoadCallbacks.length;d++)h.onLoadCallbacks[d](h)},o?(h.loadEndStatus=e.AssetLoadingStatus.PAUSED,h.onRequest=function(){h.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.send(null),h.onRequest=null}):(h.loadEndStatus=e.AssetLoadingStatus.LOADING,n.nbTexturesBeingLoaded++,c.open("GET",t,!0),c.responseType="arraybuffer",c.send(null)),h},n.loadCompressedTextureFromBuffer=function(t,i){var r=new e.CompressedTexture;r.loadEndStatus=e.AssetLoadingStatus.READY,r.mapping=i;var s=n.parseDDS(t,!0);return r.format=s.format,r.mipmaps=s.mipmaps,r.image.width=s.width,r.image.height=s.height,r.generateMipmaps=!1,r.needsUpdate=!0,r},n.parseDDS=function(t,i,r){void 0===r&&(r=!0);var s={mipmaps:[],width:0,height:0,sRGB:!1,format:null,mipmapCount:1};function a(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function o(e){var t=e[4];e[4]=e[7],e[7]=t,t=e[5],e[5]=e[6],e[6]=t}function l(e){var t=e[4];e[4]=e[5],e[5]=t}function h(e){var t=e[0];e[0]=e[6],e[6]=t,t=e[1],e[1]=e[7],e[7]=t,t=e[2],e[2]=e[4],e[4]=t,t=e[3],e[3]=e[5],e[5]=t,o(e.subarray(8,16))}function c(e){var t=e[0];e[0]=e[2],e[2]=t,t=e[1],e[1]=e[3],e[3]=t,o(e.subarray(8,16))}function d(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,o(e.subarray(8,16))}function d(e){var t=e[2]+256*(e[3]+256*e[4]),i=e[5]+256*(e[6]+256*e[7]),r=(4095&t)<<12|(16773120&t)>>12,n=(4095&i)<<12|(16773120&i)>>12;e[2]=255&n,e[3]=(65280&n)>>8,e[4]=(16711680&n)>>8,e[5]=255&r,e[6]=(65280&r)>>8,e[7]=(16711680&r)>>8,o(e.subarray(8,16))}function u(e){var t=(4095&e[2]+256*(e[3]+256*e[4]))<<12;e[2]=255&t,e[3]=(65280&t)>>8,e[4]=(16711680&t)>>8,o(e.subarray(8,16))}function p(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}var f=a("DXT1"),g=a("DXT3"),m=a("DXT5"),v=a("DX10"),_=new Int32Array(t,0,36);if(542327876!==_[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),s;var y,S,x=_[23],b=_[24],w=_[25],M=_[26],C=_[21];if(C===v){var P=_[32];(4&_[34]||6===_[35])&&(s.isCubemap=!0),28===P?(s.format=e.RGBAFormat,y=4):6===P&&(s.format=e.RGBFormat,y=12,s.type=e.FloatType,r=!1)}else{switch(C){case f:y=8,s.format=e.RGB_S3TC_DXT1_Format;break;case g:y=16,s.format=e.RGBA_S3TC_DXT3_Format;break;case m:y=16,s.format=e.RGBA_S3TC_DXT5_Format;break;default:if(r=!1,116===C)s.format=e.RGBAFormat,s.type=e.FloatType,y=16;else if(113==C);else if(32===_[22]&&16711680&_[23]&&65280&_[24]&&255&_[25]&&4278190080&_[26])s.format=e.RGBAFormat,y=4;else{if(!(64&_[20]))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",(S=C,String.fromCharCode(255&S,S>>8&255,S>>16&255,S>>24&255))),s;1&_[20]?(s.format=e.RGBAFormat,y=4):(s.format=e.RGBFormat,y=3)}}var E=_[28];if(s.isCubemap=!!(512&E),s.isCubemap&&(!(1024&E)||!(2048&E)||!(4096&E)||!(8192&E)||!(16384&E)||!(32768&E)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),s}s.mipmapCount=1,131072&_[2]&&!1!==i&&(s.mipmapCount=Math.max(1,_[7])),s.width=_[4],s.height=_[3];var T=_[1]+4;C===v&&(T+=20);for(var A=s.isCubemap?6:1,D=C===f||C===g||C===m,I=0;I<A;I++){var R=s.width,O=s.height,L=R*O;D&&(L=Math.ceil(R/4)*Math.ceil(O/4)),L*=y;for(var V=0;V<s.mipmapCount;V++){var F=null;D?(T+L>t.byteLength&&console.log("dxterror"),F=new Uint8Array(t,T,L)):F=16===y?new Float32Array(t,T,L/4):12===y?new Float32Array(t,T,L/4):0===C&&3!==y?n.getImageFromColorMasks(t,T,L,x,b,w,M):n.loadARGBMip(t,T,R,O,y);var B={data:F,width:R,height:O};s.mipmaps.push(B),T+=L,(R/=2)<1&&(R=1),(O/=2)<1&&(O=1),L=D?Math.ceil(R/4)*Math.ceil(O/4):R*O,L*=y}}return r&&function(t,i,r,n,s){var a,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T;switch(n){case e.RGB_S3TC_DXT1_Format:g=8,a=o,f=l;break;case e.RGBA_S3TC_DXT3_Format:g=16,a=h,f=c;break;case e.RGBA_S3TC_DXT5_Format:g=16,a=d,f=u;break;default:return console.error("flip dds error"),s}for(m=t,v=i,x=0;x<r&&(w=s[x].data,S=(_=Math.floor((m+3)/4))*(y=Math.floor((v+3)/4)),1!=v);++x){if(2==v)for(E=0;E<_;E++)f(w.subarray(b,E*g)),b=+g;else{for(b=0,E=1;E<=S;E++)a(w.subarray(b,E*g)),b+=g;T=g*_,P=new Uint8Array(T);for(var A=0;A<y/2;++A)M=w.subarray(A*T,(A+1)*T),C=w.subarray((y-A-1)*T,(y-A)*T),p(P,M),p(M,C),p(C,P)}(m/=2)<1&&(t=1),(v/=2)<1&&(i=1)}}(s.width,s.height,s.mipmapCount,s.format,s.mipmaps),s},n.loadARGBMip=function(e,t,i,r,n){for(var s=i*r*n,a=(4-n*i%4)%4,o=s+r*a,l=new Uint8Array(e,t,s),h=new Uint8Array(o),c=0,d=0,u=0;u<r;u++){for(var p=0;p<i;p++){var f,g=l[d],m=l[++d],v=l[++d];d++,4===n&&(f=l[d],d++),h[c]=g,h[++c]=m,h[++c]=v,c++,4===n&&(h[c]=f,c++)}c+=a}return h},n.getImageFromColorMasks=function(e,t,i,r,s,a,o){for(var l=new Int32Array(e,t,i/4),h=new Uint8Array(i),c=n.computeMaskShift(r),d=n.computeMaskShift(s),u=n.computeMaskShift(a),p=n.computeMaskShift(o),f=0;f<i/4;f++){var g=l[f];h[4*f]=(g&r)>>c,h[4*f+1]=(g&s)>>d,h[4*f+2]=(g&a)>>u,h[4*f+3]=(g&o)>>p}return h},n.computeMaskShift=function(e){for(var t=e,i=0;!(1&t);)t>>=1,i++;return i},n.loadVideoTexture=function(t,i,r){var n=new e.Texture(t,i);return n.forceUpdate=!0,n.generateMipmaps=!1,n.minFilter=1006,n.flipY=void 0!==r?r:n.flipY,n.loadEndStatus=e.AssetLoadingStatus.READY,n},n.loadFromCanvas=function({width:t,height:i,draw:r}){const n=document.createElement("canvas");n.width=t,n.height=i;const s=n.getContext("2d");s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,t,i),s.globalAlpha=1;try{r(s)}catch(e){console.log(e)}const a=new e.Texture(n,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);return a.needsUpdate=!0,a},i}),define("DS/Visualization/UniformsLib",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";return{common:{diffuse:{type:"c",value:new e.Color(16777215)},opacity:{type:"f",value:1},colorBufferType:{type:"f",value:0},map:{type:"t",value:null},mapHDRSize:{type:"v2",value:new e.Vector4(2048,1024)},offsetBumpMap:{type:"v2",value:new e.Vector4(0,0)},repeatBumpMap:{type:"v2",value:new e.Vector4(1,1)},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},envMapExposureSpecular:{type:"f",value:1},envMapExposureDiffuse:{type:"f",value:1},envMapHDRSize:{type:"v2",value:new e.Vector4(2048,1024)},envMapHDRToMipsRatio:{type:"f",value:1},ambienceMatrix:{type:"m4",value:new e.Matrix4},flipEnvMap:{type:"f",value:1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},refractionRatioMap:{type:"t",value:null},combine:{type:"i",value:0},reflectivityEnvMap:{type:"t",value:null},morphTargetInfluences:{type:"f",value:0},renderIteration:{type:"i",value:0},mappingType:{type:"i",value:0},mappingTransformSemantic:{type:"i",value:1},mappingNormTransformation:{type:"m3",value:new e.Matrix3},mappingObjTransformation:{type:"m4",value:new e.Matrix4},mappingUVTransformation:{type:"m3",value:new e.Matrix3},invScreenSize:{type:"v2",value:new e.Vector2},aoTexture:{type:"t",value:null},aoParams:{type:"v2",value:new e.Vector2}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new e.Vector2(1,1)}},lights:{ambientLightColor:{type:"fv",value:[],lightUniform:!0},directionalLightDirection:{type:"fv",value:[],lightUniform:!0},directionalLightColor:{type:"fv",value:[],lightUniform:!0},directionalIBLLightDirection:{type:"fv",value:[],lightUniform:!0},directionalIBLLightColor:{type:"fv",value:[],lightUniform:!0},directionalPhongLightDirection:{type:"fv",value:[],lightUniform:!0},directionalPhongLightColor:{type:"fv",value:[],lightUniform:!0},pointLightColor:{type:"fv",value:[],lightUniform:!0},pointLightPosition:{type:"fv",value:[],lightUniform:!0},pointLightPhysicalAttenuation:{type:"iv",value:[],lightUniform:!0},pointLightDistance:{type:"fv1",value:[],lightUniform:!0},spotLightColor:{type:"fv",value:[],lightUniform:!0},spotLightPosition:{type:"fv",value:[],lightUniform:!0},spotLightDirection:{type:"fv",value:[],lightUniform:!0},spotLightPhysicalAttenuation:{type:"iv",value:[],lightUniform:!0},spotLightDistance:{type:"fv1",value:[],lightUniform:!0},spotLightAngleCos:{type:"fv1",value:[],lightUniform:!0},spotLightInnerAngleCos:{type:"fv1",value:[],lightUniform:!0},iesLightColor:{type:"fv",value:[],lightUniform:!0},iesLightPosition:{type:"fv",value:[],lightUniform:!0},iesLightDistance:{type:"fv1",value:[],lightUniform:!0},iesLightPhysicalAttenuation:{type:"iv",value:[],lightUniform:!0},iesLightTexture:{type:"tv",value:[],lightUniform:!0},matrixWorldInv:{type:"m4v",value:[],lightUniform:!0},sphereLightColor:{type:"fv",value:[],lightUniform:!0},sphereLightPosition:{type:"fv",value:[],lightUniform:!0},sphereLightData:{type:"fv",value:[],lightUniform:!0},diskLightColor:{type:"fv",value:[],lightUniform:!0},diskLightPosition:{type:"fv",value:[],lightUniform:!0},diskLightData:{type:"fv",value:[],lightUniform:!0},diskLightNormal:{type:"fv",value:[],lightUniform:!0},diskLightUp:{type:"fv",value:[],lightUniform:!0},tubeLightColor:{type:"fv",value:[],lightUniform:!0},tubeLightPosition:{type:"fv",value:[],lightUniform:!0},tubeLightData:{type:"fv",value:[],lightUniform:!0},tubeLightRight:{type:"fv",value:[],lightUniform:!0},rectangleLightColor:{type:"fv",value:[],lightUniform:!0},rectangleLightPosition:{type:"fv",value:[],lightUniform:!0},rectangleLightNormal:{type:"fv",value:[],lightUniform:!0},rectangleLightUp:{type:"fv",value:[],lightUniform:!0},rectangleLightData:{type:"fv",value:[],lightUniform:!0},precomputedAreaTexture:{type:"t",value:null,lightUniform:!0}},clipPlanes:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:!0},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0},polygonSize:{type:"iv1",value:[0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0},extrusionPlaneU:{type:"fv3",value:[0,0,1],clipPlanesUniform:!0},extrusionPlaneV:{type:"fv3",value:[1,0,0],clipPlanesUniform:!0},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0},scissorSize:{type:"iv1",value:[],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0}},particle:{diffuse:{type:"c",value:new e.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null}},shadowmap:{shadowMap:{type:"tv",value:[],shadowUniform:!0},transparentShadowMap:{type:"tv",value:[],shadowUniform:!0},shadowMapSize:{type:"v2v",value:[],shadowUniform:!0},shadowMapNear:{type:"fv1",value:[],shadowUniform:!0},shadowMapFar:{type:"fv1",value:[],shadowUniform:!0},shadowMapCube:{type:"tcv",value:[],shadowUniform:!0},transparentShadowMapCube:{type:"tcv",value:[],shadowUniform:!0},shadowPointPosition:{type:"fv",value:[],shadowUniform:!0},shadowNearCube:{type:"fv1",value:[],shadowUniform:!0},shadowFarCube:{type:"fv1",value:[],shadowUniform:!0},shadowBiasCube:{type:"fv1",value:[],shadowUniform:!0},shadowDarknessCube:{type:"fv1",value:[],shadowUniform:!0},shadowMatrix:{type:"m4v",value:[],shadowUniform:!0},poissonDisk:{type:"v2v",value:[],shadowUniform:!0},shadowCameraPosition:{type:"fv",value:[],shadowUniform:!0},lowPartShadowCameraPosition:{type:"fv",value:[],shadowUniform:!0},directionalLightColorNoIntensity:{type:"fv",value:[],shadowUniform:!0},spotLightColorNoIntensity:{type:"fv",value:[],shadowUniform:!0},pointLightColorNoIntensity:{type:"fv",value:[],shadowUniform:!0}},lines:{scale:{type:"f",value:1},totalSize:{type:"f",value:0},halfWidth:{type:"f",value:.5},pixelSize:{type:"v2",value:new e.Vector2(.01,.01)},dashPattern:{type:"fv1",value:new Float32Array(2)},patternOffset:{type:"f",value:0}},postprocess:{brightness:{type:"f",value:0},crushblacks:{type:"f",value:0},burnhighlights:{type:"f",value:0},saturation:{type:"f",value:1},colorCorrection:{type:"v3",value:{x:1,y:1,z:1}}},deferred:{pickingColor:{type:"c",value:new e.Color(0)},rgbaDepth:{type:"t",value:null},highlightID:{type:"f",value:1},iHighlightColor:{type:"v4",value:new e.Vector4(0,.6,1,1)},iHighlightLineicColor:{type:"v4",value:new e.Vector4(0,1,1,1)},iHighlightIntensity:{type:"v2",value:new e.Vector2(1,-1)},positionComponent:{type:"v3",value:new e.Vector3(1,0,0)}}}}),define("DS/Visualization/Curves",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";let t={LineCurve:function(e,t){this.v1=e,this.v2=t}};return t.LineCurve.prototype=Object.create(e.Curve.prototype),t.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},t.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},t.LineCurve.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},t.QuadraticBezierCurve=function(e,t,i){this.v0=e,this.v1=t,this.v2=i},t.QuadraticBezierCurve.prototype=Object.create(e.Curve.prototype),t.QuadraticBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),new e.Vector2(i,r)},t.QuadraticBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x),r=e.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.CubicBezierCurve=function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},t.CubicBezierCurve.prototype=Object.create(e.Curve.prototype),t.CubicBezierCurve.prototype.getPoint=function(t){var i,r;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new e.Vector2(i,r)},t.CubicBezierCurve.prototype.getTangent=function(t){var i,r;i=e.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var n=new e.Vector2(i,r);return n.normalize(),n},t.SplineCurve=function(e){this.points=null==e?[]:e},t.SplineCurve.prototype=Object.create(e.Curve.prototype),t.SplineCurve.prototype.getPoint=function(t){var i,r,n,s=new e.Vector2,a=[],o=this.points;return n=(i=(o.length-1)*t)-(r=Math.floor(i)),a[0]=0==r?r:r-1,a[1]=r,a[2]=r>o.length-2?o.length-1:r+1,a[3]=r>o.length-3?o.length-1:r+2,s.x=e.Curve.Utils.interpolate(o[a[0]].x,o[a[1]].x,o[a[2]].x,o[a[3]].x,n),s.y=e.Curve.Utils.interpolate(o[a[0]].y,o[a[1]].y,o[a[2]].y,o[a[3]].y,n),s},t.EllipseCurve=function(e,t,i,r,n,s,a){this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=n,this.aEndAngle=s,this.aClockwise=a},t.EllipseCurve.prototype=Object.create(e.Curve.prototype),t.EllipseCurve.prototype.getPoint=function(t){var i=this.aEndAngle-this.aStartAngle;this.aClockwise||(t=1-t);var r=this.aStartAngle+t*i,n=this.aX+this.xRadius*Math.cos(r),s=this.aY+this.yRadius*Math.sin(r);return new e.Vector2(n,s)},t.LineCurve3=e.Curve.create(function(e,t){this.v1=e,this.v2=t},function(t){var i=new e.Vector3;return i.subVectors(this.v2,this.v1),i.multiplyScalar(t),i.add(this.v1),i}),t.QuadraticBezierCurve3=e.Curve.create(function(e,t,i){this.v0=e,this.v1=t,this.v2=i},function(t){var i,r,n;return i=e.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),r=e.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),n=e.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z),new e.Vector3(i,r,n)}),t.CubicBezierCurve3=e.Curve.create(function(e,t,i,r){this.v0=e,this.v1=t,this.v2=i,this.v3=r},function(t){var i,r,n;return i=e.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=e.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),n=e.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new e.Vector3(i,r,n)}),t.SplineCurve3=e.Curve.create(function(e){this.points=null==e?[]:e},function(t){var i,r,n,s=new e.Vector3,a=[],o=this.points;n=(i=(o.length-1)*t)-(r=Math.floor(i)),a[0]=0==r?r:r-1,a[1]=r,a[2]=r>o.length-2?o.length-1:r+1,a[3]=r>o.length-3?o.length-1:r+2;var l=o[a[0]],h=o[a[1]],c=o[a[2]],d=o[a[3]];return s.x=e.Curve.Utils.interpolate(l.x,h.x,c.x,d.x,n),s.y=e.Curve.Utils.interpolate(l.y,h.y,c.y,d.y,n),s.z=e.Curve.Utils.interpolate(l.z,h.z,c.z,d.z,n),s}),e.ClosedSplineCurve3=e.Curve.create(function(e){this.points=null==e?[]:e},function(t){var i,r,n,s=new e.Vector3,a=[],o=this.points;return n=(i=(o.length-0)*t)-(r=Math.floor(i)),r+=r>0?0:(Math.floor(Math.abs(r)/o.length)+1)*o.length,a[0]=(r-1)%o.length,a[1]=r%o.length,a[2]=(r+1)%o.length,a[3]=(r+2)%o.length,s.x=e.Curve.Utils.interpolate(o[a[0]].x,o[a[1]].x,o[a[2]].x,o[a[3]].x,n),s.y=e.Curve.Utils.interpolate(o[a[0]].y,o[a[1]].y,o[a[2]].y,o[a[3]].y,n),s.z=e.Curve.Utils.interpolate(o[a[0]].z,o[a[1]].z,o[a[2]].z,o[a[3]].z,n),s}),t.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},t.CurvePath.prototype=Object.create(e.Curve.prototype),t.CurvePath.prototype.add=function(e){this.curves.push(e)},t.CurvePath.prototype.checkConnection=function(){},t.CurvePath.prototype.closePath=function(){var t=this.curves[0].getPoint(0),i=this.curves[this.curves.length-1].getPoint(1);t.equals(i)||this.curves.push(new e.LineCurve(i,t))},t.CurvePath.prototype.getPoint=function(e){for(var t,i=e*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=i){var s=1-(r[n]-i)/(t=this.curves[n]).getLength();return t.getPointAt(s)}n++}return null},t.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},t.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e,t=[],i=0,r=this.curves.length;for(e=0;e<r;e++)i+=this.curves[e].getLength(),t.push(i);return this.cacheLengths=t,t},t.CurvePath.prototype.getBoundingBox=function(){var t,i,r,n,s,a,o,l,h,c,d=this.getPoints();t=i=Number.NEGATIVE_INFINITY,n=s=Number.POSITIVE_INFINITY;var u=d[0]instanceof e.Vector3;for(c=u?new e.Vector3:new e.Vector2,l=0,h=d.length;l<h;l++)(o=d[l]).x>t?t=o.x:o.x<n&&(n=o.x),o.y>i?i=o.y:o.y<s&&(s=o.y),u&&(o.z>r?r=o.z:o.z<a&&(a=o.z)),c.add(o);var p={minX:n,minY:s,maxX:t,maxY:i,centroid:c.divideScalar(h)};return u&&(p.maxZ=r,p.minZ=a),p},t.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},t.CurvePath.prototype.createGeometry=function(t){for(var i=new e.Geometry,r=0;r<t.length;r++)i.vertices.push(new e.Vector3(t[r].x,t[r].y,t[r].z||0));return i},t.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},t.CurvePath.prototype.getTransformedPoints=function(e,t){var i,r,n=this.getPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var i,r,n=this.getSpacedPoints(e);for(t||(t=this.bends),i=0,r=t.length;i<r;i++)n=this.getWrapPoints(n,t[i]);return n},t.CurvePath.prototype.getWrapPoints=function(e,t){var i,r,n,s,a,o,l=this.getBoundingBox();for(i=0,r=e.length;i<r;i++){s=(n=e[i]).x,a=n.y,o=s/l.maxX,o=t.getUtoTmapping(o,s);var h=t.getPoint(o),c=t.getNormalVector(o).multiplyScalar(a);n.x=h.x+c.x,n.y=h.y+c.y}return e},t.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},t.Path=function(e){t.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},t.Path.prototype=Object.create(t.CurvePath.prototype),t.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},t.Path.prototype.moveTo=function(t,i){var r=Array.prototype.slice.call(arguments);this.actions.push({action:e.PathActions.MOVE_TO,args:r})},t.Path.prototype.lineTo=function(t,i){var r=Array.prototype.slice.call(arguments),n=this.actions[this.actions.length-1].args,s=n[n.length-2],a=n[n.length-1],o=new e.LineCurve(new e.Vector2(s,a),new e.Vector2(t,i));this.curves.push(o),this.actions.push({action:e.PathActions.LINE_TO,args:r})},t.Path.prototype.quadraticCurveTo=function(t,i,r,n){var s=Array.prototype.slice.call(arguments),a=this.actions[this.actions.length-1].args,o=a[a.length-2],l=a[a.length-1],h=new e.QuadraticBezierCurve(new e.Vector2(o,l),new e.Vector2(t,i),new e.Vector2(r,n));this.curves.push(h),this.actions.push({action:e.PathActions.QUADRATIC_CURVE_TO,args:s})},t.Path.prototype.bezierCurveTo=function(t,i,r,n,s,a){var o=Array.prototype.slice.call(arguments),l=this.actions[this.actions.length-1].args,h=l[l.length-2],c=l[l.length-1],d=new e.CubicBezierCurve(new e.Vector2(h,c),new e.Vector2(t,i),new e.Vector2(r,n),new e.Vector2(s,a));this.curves.push(d),this.actions.push({action:e.PathActions.BEZIER_CURVE_TO,args:o})},t.Path.prototype.splineThru=function(t){var i=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,n=r[r.length-2],s=r[r.length-1],a=[new e.Vector2(n,s)];Array.prototype.push.apply(a,t);var o=new e.SplineCurve(a);this.curves.push(o),this.actions.push({action:e.PathActions.CSPLINE_THRU,args:i})},t.Path.prototype.arc=function(e,t,i,r,n,s){var a=this.actions[this.actions.length-1].args,o=a[a.length-2],l=a[a.length-1];this.absarc(e+o,t+l,i,r,n,s)},t.Path.prototype.absarc=function(e,t,i,r,n,s){this.absellipse(e,t,i,i,r,n,s)},t.Path.prototype.ellipse=function(e,t,i,r,n,s,a){var o=this.actions[this.actions.length-1].args,l=o[o.length-2],h=o[o.length-1];this.absellipse(e+l,t+h,i,r,n,s,a)},t.Path.prototype.absellipse=function(t,i,r,n,s,a,o){var l=Array.prototype.slice.call(arguments),h=new e.EllipseCurve(t,i,r,n,s,a,o);this.curves.push(h);var c=h.getPoint(o?1:0);l.push(c.x),l.push(c.y),this.actions.push({action:e.PathActions.ELLIPSE,args:l})},t.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);for(var i=[],r=0;r<e;r++)i.push(this.getPoint(r/e));return i},t.Path.prototype.getPoints=function(t,i){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(t,i);t=t||12;var r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x=[];for(r=0,n=this.actions.length;r<n;r++)switch(a=(s=this.actions[r]).action,o=s.args,a){case e.PathActions.MOVE_TO:case e.PathActions.LINE_TO:x.push(new e.Vector2(o[0],o[1]));break;case e.PathActions.QUADRATIC_CURVE_TO:for(l=o[2],h=o[3],u=o[0],p=o[1],x.length>0?(f=(m=x[x.length-1]).x,g=m.y):(f=(m=this.actions[r-1].args)[m.length-2],g=m[m.length-1]),v=1;v<=t;v++)_=v/t,y=e.Shape.Utils.b2(_,f,u,l),S=e.Shape.Utils.b2(_,g,p,h),x.push(new e.Vector2(y,S));break;case e.PathActions.BEZIER_CURVE_TO:for(l=o[4],h=o[5],u=o[0],p=o[1],c=o[2],d=o[3],x.length>0?(f=(m=x[x.length-1]).x,g=m.y):(f=(m=this.actions[r-1].args)[m.length-2],g=m[m.length-1]),v=1;v<=t;v++)_=v/t,y=e.Shape.Utils.b3(_,f,u,c,l),S=e.Shape.Utils.b3(_,g,p,d,h),x.push(new e.Vector2(y,S));break;case e.PathActions.CSPLINE_THRU:m=this.actions[r-1].args;var b=[new e.Vector2(m[m.length-2],m[m.length-1])],w=t*o[0].length;b=b.concat(o[0]);var M=new e.SplineCurve(b);for(v=1;v<=w;v++)x.push(M.getPointAt(v/w));break;case e.PathActions.ARC:var C=o[0],P=o[1],E=o[2],T=o[3],A=o[4],D=!!o[5],I=A-T,R=2*t;for(v=1;v<=R;v++)_=v/R,D||(_=1-_),O=T+_*I,y=C+E*Math.cos(O),S=P+E*Math.sin(O),x.push(new e.Vector2(y,S));break;case e.PathActions.ELLIPSE:C=o[0],P=o[1];var O,L=o[2],V=o[3];T=o[4],A=o[5],D=!!o[6],I=A-T,R=2*t;for(v=1;v<=R;v++)_=v/R,D||(_=1-_),O=T+_*I,y=C+L*Math.cos(O),S=P+V*Math.sin(O),x.push(new e.Vector2(y,S))}var F=x[x.length-1];return Math.abs(F.x-x[0].x)<1e-10&&Math.abs(F.y-x[0].y)<1e-10&&x.splice(x.length-1,1),i&&x.push(x[0]),x},t.Path.prototype.toShapes=function(){var i,r,n,s,a,o=[],l=new t.Path;for(i=0,r=this.actions.length;i<r;i++)a=(n=this.actions[i]).args,(s=n.action)==e.PathActions.MOVE_TO&&0!=l.actions.length&&(o.push(l),l=new t.Path),l[s].apply(l,a);if(0!=l.actions.length&&o.push(l),0==o.length)return[];var h,c,d=[],u=!e.Shape.Utils.isClockWise(o[0].getPoints());if(1==o.length)return h=o[0],(c=new e.Shape).actions=h.actions,c.curves=h.curves,d.push(c),d;if(u)for(c=new e.Shape,i=0,r=o.length;i<r;i++)h=o[i],e.Shape.Utils.isClockWise(h.getPoints())?(c.actions=h.actions,c.curves=h.curves,d.push(c),c=new e.Shape):c.holes.push(h);else{for(i=0,r=o.length;i<r;i++)h=o[i],e.Shape.Utils.isClockWise(h.getPoints())?(c&&d.push(c),(c=new e.Shape).actions=h.actions,c.curves=h.curves):c.holes.push(h);d.push(c)}return d},t}),define("DS/Visualization/OccurrencePath",["UWA/Class"],function(e){"use strict";var t=e.extend({init:function(e){this.path=[],this.setFromArray(e)},getSize:function(){return this.path.length},getNodeName:function(e){return e<0||e>=this.path.length?null:this.path[e]},add:function(e){this.path.push(e)},setFromArray:function(e){var t;if(void 0!==e&&e instanceof Array)for(t=0;t<e.length;t++)""!==e[t]&&this.path.push(e[t])},isEqual:function(e){var t;if(this.path.length!==e.path.length)return!1;for(t=0;t<e.path.length;t++)if(this.path[t]!==e.path[t])return!1;return!0},isIncludedIn:function(e){var t,i,r,n=!1;for(i=0;i<this.path.length;i++){for(t=this.path[i],n=!1,r=0;r<e.path.length;r++)if(t===e.path[r]){n=!0;break}if(!n)return!1}return!0}});return UWA.namespace("THREEDS/OccurrencePath",t)}),define("Visualization/OccurrencePath",["DS/Visualization/OccurrencePath","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OccurrencePath"),e}),define("DS/Visualization/ThreeDXLoader",["DS/VisuLoaders/ThreeDXLoader"],function(e){"use strict";return e}),define("DS/Visualization/SectionCappingPassCreator",["UWA/Class"],function(e){"use strict";return e.extend({init:function(){},setupViewer:function(e){}})}),define("Visualization/SectionCappingPassCreator",["DS/Visualization/SectionCappingPassCreator","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SectionCappingPassCreator"),e}),define("DS/Visualization/SessionNodesWithSectionProfile",[],function(){"use strict";return null}),define("DS/Visualization/ImplicitGeometries",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t,i,r,n,s,a={};class o{constructor(t,i){this.origin=void 0!==t?t:new e.Vector3,this.axis=void 0!==i?i.normalize():new e.Vector3}at(t,i){return i||(i=new e.Vector3),i.copy(this.axis).multiplyScalar(t).add(this.origin)}parameter(t,i){return(i||new e.Vector3).subVectors(t,this.origin).dot(this.axis)}project(t,i){i||(i=new e.Vector3);const r=this.parameter(t,i);return this.at(r/this.axis.lengthSq(),i)}distanceToSquared(e,t){return this.project(e,t).distanceToSquared(e)}distanceTo(e,t){return Math.sqrt(this.distanceToSquared(e,t))}applyMatrix4(e){return this.origin.applyMatrix4(e),this.axis.transformDirection(e),this}clone(){return new o(this.origin,this.axis)}}return a.InfiniteLine3=o,a.Line3=function(t,i){this.start=void 0!==t?t:new e.Vector3,this.end=void 0!==i?i:new e.Vector3},a.Line3.prototype={constructor:a.Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},center:function(t){return(t||new e.Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return(t||new e.Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,i){var r=i||new e.Vector3;return this.delta(r).multiplyScalar(t).add(this.start)},closestPointToPointParameter:(t=new e.Vector3,i=new e.Vector3,function(r,n){t.subVectors(r,this.start),i.subVectors(this.end,this.start);var s=i.dot(i),a=i.dot(t)/s;return n&&(a=e.Math.clamp(a,0,1)),a}),closestPointToPoint:function(t,i,r){var n=this.closestPointToPointParameter(t,i),s=r||new e.Vector3;return this.delta(s).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)},clone:function(){return(new a.Line3).copy(this)}},a.Box2=function(t,i){this.min=void 0!==t?t:new e.Vector2(1/0,1/0),this.max=void 0!==i?i:new e.Vector2(-1/0,-1/0)},a.Box2.prototype={constructor:a.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y)}else this.makeEmpty();return this},setFromCenterAndSize:(r=new e.Vector2,function(e,t){var i=r.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y},center:function(t){return(t||new e.Vector2).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector2).subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(t){return new e.Vector2((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(t,i){return(i||new e.Vector2).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector2;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new a.Box2).copy(this)}},a.Box3=function(t,i){this.min=void 0!==t?t:new e.Vector3(1/0,1/0,1/0),this.max=void 0!==i?i:new e.Vector3(-1/0,-1/0,-1/0)},a.Box3.prototype={constructor:a.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setValues:function(e,t,i,r,n,s){this.min.x=e,this.min.y=t,this.min.z=i,this.max.x=r,this.max.y=n,this.max.z=s},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var i=1,r=e.length;i<r;i++)(t=e[i]).x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y),t.z<this.min.z?this.min.z=t.z:t.z>this.max.z&&(this.max.z=t.z)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var t=new e.Vector3;return function(e,i){var r=t.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}}(),createJSON:function(){return[this.min.x,this.min.y,this.min.z,this.max.x,this.max.y,this.max.z]},setFromJSON:function(e){this.min.set(e[0],e[1],e[2]),this.max.set(e[3],e[4],e[5])},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},singlePoint:function(){return this.max.x<=this.min.x&&this.max.y<=this.min.y&&this.max.z<=this.min.z},center:function(t){return(t||new e.Vector3).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(t){return(t||new e.Vector3).subVectors(this.max,this.min)},getArea:function(){var e=this.size();return 2*(e.x*e.y+e.x*e.z+e.y*e.z)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(t){return new e.Vector3((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},clampPoint:function(t,i){return(i||new e.Vector3).copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new e.Vector3;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),getBoundingSphere:function(){var t=new e.Vector3;return function(e){var i=e||new a.Sphere;return i.center=this.center(),i.radius=.5*this.size(t).length(),i}}(),isIntersectingWith:function(t,i){function r(e,t){let i=1/0,r=-1/0;for(let n=0;n<t.length;n++){const s=e.dot(t[n]);s<i&&(i=s),s>r&&(r=s)}return[i,r]}const n=t.getPoints(i).map(e=>e.clone()),s=this.getPoints();function a(e){if(e.lengthSq()<=1e-6)return!1;const t=r(e,s),i=r(e,n);return t[1]<=i[0]||i[1]<=t[0]}const o=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1),(new e.Vector3).copy(n[4]).sub(n[0]),(new e.Vector3).copy(n[2]).sub(n[0]),(new e.Vector3).copy(n[1]).sub(n[0])];for(let e=0;e<6;e++)if(a(o[e]))return!1;const l=new e.Vector3;for(let e=0;e<3;e++){l.copy(o[e]);for(let e=0;e<3;e++)if(l.cross(o[e+3]),a(l))return!1}return!0},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(n=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3],function(e){return n[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),n[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),n[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),n[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),n[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),n[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),n[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.makeEmpty(),this.setFromPoints(n),this}),getPoints:function(){var t=[new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3,new e.Vector3];return function(e){return t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),t}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new a.Box3).copy(this)},mergeWithBox:function(e){this.expandByPoint(e.min),this.expandByPoint(e.max)},isNaN:function(){return!(!this.min.isNaN()&&!this.max.isNaN())},fromDGBoundingBoxArray:function(e){var t=this,i=e.length;if(i>1){var r=function(t){for(var r=e[0],n=1;n<i;n++){var s=e[n];r.fastBBox.min[t]>s.fastBBox.min[t]&&(r=s)}return r},n=function(t){for(var r=e[0],n=1;n<i;n++){var s=e[n];r.fastBBox.max[t]<s.fastBBox.max[t]&&(r=s)}return r},s=function(e){for(var i=r(e);t.min[e]>=i.fastBBox.min[e];)i.flagMinAttr(e),t.min[e]=Math.min(i.getMinAttr(e),t.min[e]),i=r(e)};s("x"),s("y"),s("z");var a=function(e){for(var i=n(e);t.max[e]<=i.fastBBox.max[e];)i.flagMaxAttr(e),t.max[e]=Math.max(i.getMaxAttr(e),t.max[e]),i=n(e)};a("x"),a("y"),a("z")}else if(i>0){var o=e[0];this.union(o.getRealBBox())}return this},getPlanes:function(){var t=new e.Vector3,i=new e.Vector3,r=null,n=[];return t.set(this.min.x,this.max.y,this.min.z),i.set(this.min.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.min.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,t,i),n.push(r),i.set(this.min.x,this.max.y,this.min.z),(r=new e.Plane).setFromCoplanarPoints(this.min,i,t),n.push(r),t.set(this.max.x,this.max.y,this.min.z),i.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),i.set(this.min.x,this.max.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,t,i),n.push(r),t.set(this.max.x,this.min.y,this.max.z),(r=new e.Plane).setFromCoplanarPoints(this.max,i,t),n.push(r),n}},a.DGBoundingBoxArray=function(e){this.fastBBox=e.fastBBox.clone(),this._realBBox=e.fastBBox.singlePoint()?e.fastBBox.clone():null,this.matrix=e.matrix.clone(),this.renderable=e.renderable,this.obj=[]},a.DGBoundingBoxArray.prototype.computeFunction=function(){for(var t=new e.Box3,i=0;i<this.obj.length;i++){var r=this.obj[i]._computeOrientedBoundingBox(this.matrix,-1,0,!1,null,null,0);t.union(r)}this._realBBox=t},a.DGBoundingBoxArray.prototype.getRealBBox=function(){return null===this._realBBox&&this.computeFunction(),this._realBBox},a.DGBoundingBoxArray.prototype.getMinAttr=function(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.min[e]},a.DGBoundingBoxArray.prototype.getMaxAttr=function(e){return null===this._realBBox&&this.computeFunction(),this._realBBox.max[e]},a.DGBoundingBoxArray.prototype.flagMaxAttr=function(e){this.fastBBox.max[e]=-1/0},a.DGBoundingBoxArray.prototype.flagMinAttr=function(e){this.fastBBox.min[e]=1/0},a.DGBoundingBoxArray.prototype.addDG=function(e){this.obj.push(e)},a.DGBoundingBoxArray.prototype.setDGs=function(e){this.obj=e},a.DGBoundingBoxArray.prototype.empty=function(){return 0===this.obj.length},a.Sphere=function(t,i){this.center=void 0!==t?t:new e.Vector3,this.radius=void 0!==i?i:0,this.pixelRadius=0},a.Sphere.prototype={constructor:a.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setSimple:function(e,t,i,r){return this.center.set(e,t,i),this.radius=r,this.pixelRadius=0,this},reset:function(){return this.setSimple(0,0,0,0)},createJSON:function(){return[this.center.x,this.center.y,this.center.z,this.radius]},setFromJSON:function(e){this.center.set(e[0],e[1],e[2]),this.radius=e[3]},setFromCenterAndPoints:function(e,t){for(var i=0,r=0,n=t.length;r<n;r++){var s=e.distanceToSquared(t[r]);i=Math.max(i,s)}return this.center=e,this.radius=Math.sqrt(i),this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this.pixelRadius=e.pixelRadius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius+1e-6},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},containsSphere:function(e){return this.center.distanceTo(e.center)<=this.radius-e.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsLine:function(e){var t=e[1].clone().sub(e[0]),i=this.center.clone().sub(e[0]),r=t.dot(i),n=t.dot(t),s=e[0].clone().add(t.clone().multiplyScalar(r/n));if(!this.containsPoint(s))return!1;var a=s.sub(e[0]).dot(t);return a>=0&&a<=n},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},clampPoint:function(t,i){var r=this.center.distanceToSquared(t),n=i||new e.Vector3;return n.copy(t),r>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(t){var i=t||new e.Box3;return i.set(this.center,this.center),i.expandByScalar(this.radius),i},applyMatrix4:function(e){return e&&(this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis()),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new a.Sphere).copy(this)},mergeWithSphere:function(e,t){var i,r,n;this.radius<e.radius?(i=this,r=e):(i=e,r=this);var s,a=r.center.distanceTo(i.center),o=Math.max(e.pixelRadius,this.pixelRadius);a+i.radius<=r.radius?t.copy(r):(s=((n=.5*(i.radius+r.radius+a))-r.radius)/a,t.radius=n,t.center.x=s*i.center.x+(1-s)*r.center.x,t.center.y=s*i.center.y+(1-s)*r.center.y,t.center.z=s*i.center.z+(1-s)*r.center.z),t.pixelRadius=o},isNaN:function(){return!(isFinite(this.radius)&&!this.center.isNaN())},_updateRatio:function(t){0!==t&&(this.pixelRadius+=this.center.length()*t,this.set(new e.Vector3,this.radius+this.center.length()),this.radius*=t,this.pixelRadius=Math.max(this.pixelRadius,this.radius),this.radius=0)}},a.BoundingSphere=function(e,t,i){a.Sphere.call(this,e,t),this.state=0,i&&this.setState(i)},a.BoundingSphere.prototype=Object.create(a.Sphere.prototype),a.BoundingSphere.prototype.states=["EMPTY","NORMAL","INFINITE"],a.BoundingSphere.prototype.setState=function(e){this.state=this.states.indexOf(e)},a.BoundingSphere.prototype.getState=function(){return this.states[this.state]},a.Triangle=function(t,i,r){this.a=void 0!==t?t:new e.Vector3,this.b=void 0!==i?i:new e.Vector3,this.c=void 0!==r?r:new e.Vector3},a.Triangle.normal=(s=new e.Vector3,function(t,i,r,n){var a=n||new e.Vector3;a.subVectors(r,i),s.subVectors(t,i),a.cross(s);var o=a.lengthSq();return o>0?a.multiplyScalar(1/Math.sqrt(o)):a.set(0,0,0)}),a.Triangle.barycoordFromPoint=function(){var t=new e.Vector3,i=new e.Vector3,r=new e.Vector3;return function(n,s,a,o,l){t.subVectors(o,s),i.subVectors(a,s),r.subVectors(n,s);var h=t.dot(t),c=t.dot(i),d=t.dot(r),u=i.dot(i),p=i.dot(r),f=h*u-c*c,g=l||new e.Vector3;if(0==f)return g.set(-2,-1,-1);var m=1/f,v=(u*d-c*p)*m,_=(h*p-c*d)*m;return g.set(1-v-_,_,v)}}(),a.Triangle.containsPoint=function(){var t=new e.Vector3;return function(e,i,r,n){var s=a.Triangle.barycoordFromPoint(e,i,r,n,t);return s.x>=0&&s.y>=0&&s.x+s.y<=1}}(),a.Triangle.prototype={constructor:a.Triangle,set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var t=new e.Vector3,i=new e.Vector3;return function(){return t.subVectors(this.c,this.b),i.subVectors(this.a,this.b),.5*t.cross(i).length()}}(),midpoint:function(t){return(t||new e.Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return a.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new a.Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return a.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return a.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new a.Triangle).copy(this)}},a.Spline=function(t){this.points=t;var i,r,n,s,a,o,l,h,c,d=[],u={x:0,y:0,z:0};function p(e,t,i,r,n,s,a){var o=.5*(i-e),l=.5*(r-t);return(2*(t-i)+o+l)*a+(-3*(t-i)-2*o-l)*s+o*n+t}this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return i=(this.points.length-1)*e,r=Math.floor(i),n=i-r,d[0]=0===r?r:r-1,d[1]=r,d[2]=r>this.points.length-2?this.points.length-1:r+1,d[3]=r>this.points.length-3?this.points.length-1:r+2,o=this.points[d[0]],l=this.points[d[1]],h=this.points[d[2]],c=this.points[d[3]],a=n*(s=n*n),u.x=p(o.x,l.x,h.x,c.x,n,s,a),u.y=p(o.y,l.y,h.y,c.y,n,s,a),u.z=p(o.z,l.z,h.z,c.z,n,s,a),u},this.getControlPointsArray=function(){var e,t,i=this.points.length,r=[];for(e=0;e<i;e++)t=this.points[e],r[e]=[t.x,t.y,t.z];return r},this.getLength=function(t){var i,r,n,s,a=0,o=0,l=0,h=new e.Vector3,c=new e.Vector3,d=[],u=0;for(d[0]=0,t||(t=100),n=this.points.length*t,h.copy(this.points[0]),i=1;i<n;i++)r=i/n,s=this.getPoint(r),c.copy(s),u+=c.distanceTo(h),h.copy(s),a=(this.points.length-1)*r,(o=Math.floor(a))!=l&&(d[o]=u,l=o);return d[d.length]=u,{chunks:d,total:u}},this.reparametrizeByArcLength=function(t){var i,r,n,s,a,o,l,h,c=[],d=new e.Vector3,u=this.getLength();for(c.push(d.copy(this.points[0]).clone()),i=1;i<this.points.length;i++){for(o=u.chunks[i]-u.chunks[i-1],l=Math.ceil(t*o/u.total),s=(i-1)/(this.points.length-1),a=i/(this.points.length-1),r=1;r<l-1;r++)n=s+r*(1/l)*(a-s),h=this.getPoint(n),c.push(d.copy(h).clone());c.push(d.copy(this.points[i]).clone())}this.points=c}},a.Plane=function(t,i){this.normal=void 0!==t?t:new e.Vector3(1,0,0),this.constant=void 0!==i?i:0},a.Plane.prototype={constructor:a.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new e.Vector3,i=new e.Vector3;return function(e,r,n){var s=t.subVectors(n,r).cross(i.subVectors(e,r)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}}(),copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToPointSquared:function(e){const t=this.distanceToPoint(e);return t*t},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(t,i){var r=this.distanceToPoint(t);return(i||new e.Vector3).copy(this.normal).multiplyScalar(r)},isIntersectionLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectLine:function(){var t=new e.Vector3;return function(i,r){var n=r||new e.Vector3,s=i.delta(t),a=this.normal.dot(s);if(0==a)return 0==this.distanceToPoint(i.start)?n.copy(i.start):void 0;var o=-(i.start.dot(this.normal)+this.constant)/a;return o<0||o>1?void 0:n.copy(s).multiplyScalar(o).add(i.start)}}(),containsPoint(e,t=1e-9){return this.distanceToPointSquared(e)<t},containsInfiniteLine(e,t=1e-9){return this.normal.dot(e.axis)<t&&this.containsPoint(e.origin,t)},containsPlane(e,t=1e-9){return Math.abs(this.normal.dot(e.normal))>1-t&&e.containsPoint(this.coplanarPoint())},coplanarPoint:function(t){return(t||new e.Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new e.Vector3,i=new e.Vector3;return function(r,n){n=n||(new e.Matrix3).getInverse(r).transpose();var s=t.copy(this.normal).applyMatrix3(n),a=this.coplanarPoint(i);return a.applyMatrix4(r),this.setFromNormalAndCoplanarPoint(s,a),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new a.Plane).copy(this)}},a.Frustum=function(e,t,i,r,n,s){this.planes=[void 0!==e?e:new a.Plane,void 0!==t?t:new a.Plane,void 0!==i?i:new a.Plane,void 0!==r?r:new a.Plane,void 0!==n?n:new a.Plane,void 0!==s?s:new a.Plane]},a.Frustum.prototype={constructor:a.Frustum,set:function(e,t,i,r,n,s){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(r),a[4].copy(n),a[5].copy(s),this},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,i=e.elements,r=i[0],n=i[1],s=i[2],a=i[3],o=i[4],l=i[5],h=i[6],c=i[7],d=i[8],u=i[9],p=i[10],f=i[11],g=i[12],m=i[13],v=i[14],_=i[15];return t[0].setComponents(a-r,c-o,f-d,_-g).normalize(),t[1].setComponents(a+r,c+o,f+d,_+g).normalize(),t[2].setComponents(a+n,c+l,f+u,_+m).normalize(),t[3].setComponents(a-n,c-l,f-u,_-m).normalize(),t[4].setComponents(a-s,c-h,f-p,_-v).normalize(),t[5].setComponents(a+s,c+h,f+p,_+v).normalize(),this},intersectsBox:function(e){const t=this.planes;for(let i=0;i<6;i++){const r=t[i];if(_vector.x=r.normal.x>0?e.max.x:e.min.x,_vector.y=r.normal.y>0?e.max.y:e.min.y,_vector.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(_vector)<0)return!1}return!0},intersectsSphere:function(e){for(var t=this.planes,i=e.center,r=-e.radius,n=0;n<6;n++){if(t[n].distanceToPoint(i)<r)return!1}return!0},containsSphere:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e.center)-e.radius<0)return!1;return!0},containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0},clone:function(){return(new a.Frustum).copy(this)},computeOutcode:function(e){var t=0;return e.dot(this.planes[0].normal)+this.planes[0].constant<0&&(t|=1),e.dot(this.planes[1].normal)+this.planes[1].constant<0&&(t|=2),e.dot(this.planes[2].normal)+this.planes[2].constant<0&&(t|=4),e.dot(this.planes[3].normal)+this.planes[3].constant<0&&(t|=8),e.dot(this.planes[4].normal)+this.planes[4].constant<0&&(t|=16),e.dot(this.planes[5].normal)+this.planes[5].constant<0&&(t|=32),t},intersectsLine:function(t){var i=[],r=[new e.Vector3,new e.Vector3];r[0].copy(t[0]),r[1].copy(t[1]),i[0]=this.computeOutcode(r[0]),i[1]=this.computeOutcode(r[1]);for(var n=0;n<4;n++){if(0===i[0]||0===i[1])return!0;if(0!=(i[0]&i[1]))break;var s=new e.Vector3(r[0].x-r[1].x,r[0].y-r[1].y,r[0].z-r[1].z),a=0,o=null;1&i[0]?o=this.planes[0]:2&i[0]?o=this.planes[1]:4&i[0]?o=this.planes[2]:8&i[0]?o=this.planes[3]:16&i[0]?o=this.planes[4]:32&i[0]&&(o=this.planes[5]),o&&(a=-(r[0].dot(o.normal)+o.constant)/s.dot(o.normal)),r[0].add(s.multiplyScalar(a)),i[0]=this.computeOutcode(r[0])}return!1},intersectsTriangle:function(e){return this.intersectsLine([e[0],e[1]])||this.intersectsLine([e[1],e[2]])||this.intersectsLine([e[2],e[0]])},intersectsObject:function(t,i,r){var n=this.planes,s=t._getMMMatrix(),a=t.geometry.boundingSphere,o=-a.radius*s.getMaxScaleOnAxis(),l=e.Frustum.__v2;null!==a?l.copy(a.center):l.set(0,0,0),l.applyMatrix4(s);for(var h=0;h<6;h++)if(n[h].distanceToPoint(l)<=o)return!1;return!0},performFrustumCulling:function(e,t){for(var i=this.planes,r=-e,n=null,s=null,a=0;a<6;a++)if((s=(n=i[a]).normal).x*t.x+s.y*t.y+s.z*t.z+n.constant<=r)return!1;return!0},performFrustumCullingNoNearFar:function(e,t){for(var i=this.planes,r=-e,n=null,s=null,a=0;a<4;a++)if((s=(n=i[a]).normal).x*t.x+s.y*t.y+s.z*t.z+n.constant<=r)return!1;return!0},getCorners:function(){var t=[],i=new e.Matrix4,r=new e.Matrix4,n=this;function s(t,s,a){var o=n.planes[t],l=n.planes[s],h=n.planes[a];i.set(o.normal.x,o.normal.y,o.normal.z,0,l.normal.x,l.normal.y,l.normal.z,0,h.normal.x,h.normal.y,h.normal.z,0,0,0,0,1),r.getInverse(i);var c=(new e.Vector4).set(-o.constant,-l.constant,-h.constant,1);return c.applyMatrix4(r),c}return t[0]=s(1,2,5),t[1]=s(0,2,5),t[2]=s(0,3,5),t[3]=s(1,3,5),t[4]=s(1,2,4),t[5]=s(0,2,4),t[6]=s(0,3,4),t[7]=s(1,3,4),t},intersectsObject:function(t,i,r){var n=this.planes,s=t._getMMMatrix(),a=t.geometry.boundingSphere,o=-a.radius*s.getMaxScaleOnAxis(),l=e.Frustum.__v2;null!==a?l.copy(a.center):l.set(0,0,0),l.applyMatrix4(s);for(var h=0;h<6;h++)if(n[h].distanceToPoint(l)<=o)return!1;return!0}},a.Frustum.__v2=new e.Vector3,a.Face4=function(t,i,r,n,s,a,o){this.a=t,this.b=i,this.c=r,this.d=n,this.normal=s instanceof e.Vector3?s:new e.Vector3,this.vertexNormals=s instanceof Array?s:[],this.color=a instanceof e.Color?a:new e.Color,this.vertexColors=a instanceof Array?a:[],this.vertexTangents=[],this.materialIndex=void 0!==o?o:0,this.centroid=new e.Vector3},a.Face4.prototype={constructor:a.Face4,clone:function(){var e,t,i=new a.Face4(this.a,this.b,this.c,this.d);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},a.Face3=function(t,i,r,n,s,a){this.a=t,this.b=i,this.c=r,this.normal=n instanceof e.Vector3?n:new e.Vector3,this.vertexNormals=n instanceof Array?n:[],this.color=s instanceof e.Color?s:new e.Color,this.vertexColors=s instanceof Array?s:[],this.vertexTangents=[],this.materialIndex=void 0!==a?a:0,this.centroid=new e.Vector3},a.Face3.prototype={constructor:a.Face3,clone:function(){var e,t,i=new a.Face3(this.a,this.b,this.c);for(i.normal.copy(this.normal),i.color.copy(this.color),i.centroid.copy(this.centroid),i.materialIndex=this.materialIndex,e=0,t=this.vertexNormals.length;e<t;e++)i.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,t=this.vertexColors.length;e<t;e++)i.vertexColors[e]=this.vertexColors[e].clone();for(e=0,t=this.vertexTangents.length;e<t;e++)i.vertexTangents[e]=this.vertexTangents[e].clone();return i}},a.mergeBoundingSphereInto=function(e,t,i,r){if(t&&!t.isNaN()){var n=t.clone();r&&n._updateRatio(r),i&&n.applyMatrix4(i),e?e.mergeWithSphere(n,e):e=n}return e},a.mergeBoundingBoxInto=function(t,i,r,n){if(i&&!i.isNaN()){var s=i.clone();n&&(s.max=new e.Vector3(0,0,0),s.min=new e.Vector3(0,0,0)),r&&s.applyMatrix4(r),t?t.mergeWithBox(s):t=s}return t},a}),define("DS/Visualization/ProxyAbstraction",["DS/WAFData/WAFData"],function(e){"use strict";return class{useNoProxy(e){this.proxyUsage=0,this.server=null,this.sport=null,this.withCredentials=e}useProxyDefinedBy(e,t){this.proxyUsage=1,this.server=e,this.sport=t}useUWAProxy(e){this.proxyUsage=2,this.server=null,this.sport=null,this.proxymode=e.proxymode,this.requestsOptions=e.requestsOptions}rewriteUrlUsingProxyDef(e,t,i){var r=e.indexOf("/"),n=e.indexOf("/",r+2);return e.slice(0,r)+"//"+t+":"+i+e.slice(n,e.length)}executeGetHttpRequest(t,i,r,n,s,a){var o,l,h=(o=s,l=t,function(e){o&&o({url:l,type:"LOAD",responseCode:e})});if(2===this.proxyUsage){var c=this.requestsOptions||{};c.headers=c.headers||new Object,a&&(c.headers.Accept=a),c.data&&(c.data.GET=c.data.GET||r),c.method=c.method||"GET",c.timeout=36e5,c.async=!0,c.onComplete=n,c.onFailure=function(e){for(var t=e.message.split('"'),i=null,r=0;r<t.length-1;r++)-1!=t[r].search("return ResponseCode with value")&&(i=parseInt(t[r+1]));i&&h(i)},c.onTimeout=function(e){h(408)},c.type=i,c.proxymode&&(c.authentication=c.proxymode),e.handleRequest(t,c)}else{1===this.proxyUsage&&(t=this.rewriteUrlUsingProxyDef(t,this.server,this.sport));var d=new XMLHttpRequest;d.open("GET",t,!0),d.onload=function(e){var t=d.status;200===t||0===t&&this.response&&this.response.byteLength>0?n(this.response):h(t)},d.onerror=function(e){h(d.status)},d.ontimeout=function(e){h(408)},d.timeout=36e5,this.withCredentials&&(d.withCredentials=!0),"arraybuffer"===i&&(d.responseType=i),"blob"===i&&(d.responseType=i),d.send(r)}}fetchUint8Array(e,t,i,r){return new Promise((n,s)=>{this.executeGetHttpRequest(e,t,i,e=>n(new Uint8Array(e)),s,r)})}}}),define("DS/Visualization/PLMMaterialServicesItf",[],function(){"use strict";var e=function(){this.implementation=null};return e.prototype.setImplementation=function(e){this.implementation=e},e.prototype.loadMaterials=function(e,t,i){this.implementation.loadMaterials(e,t,i)},e.prototype.loadMaterialConnections=function(e,t){this.implementation.loadMaterialConnections(e,t)},new e}),define("DS/Visualization/IdPathMatcher",[],function(){"use strict";var e=function(e){this._idToNodeCB=e.idToNodeCB,this._nodeToIdCB=e.nodeToIdCB,this._isNodeRepRefCB=e.isNodeRepRefCB};return e.prototype.idToNode=function(e){return this._idToNodeCB(e)},e.prototype.nodeToId=function(e){return this._nodeToIdCB(e)},e.prototype.isNodeRepRef=function(e){return this._isNodeRepRefCB(e)},e}),define("DS/Visualization/SkinningTransformation",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=function(){this.useEulerAngles=!1,this.skinningMap=null,this.skinningMapWidth=0,this.skinningMapWidth=0,this.nbBones=0};t.prototype.setSkinningMatrices=function(t,i){var r;(!this.nbBones&&i&&(this.nbBones=i),this.skinningMapWidth&&this.skinningMapHeight)||(r=this.nbBones>256?64:this.nbBones>64?32:this.nbBones>16?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!1,this.skinningMap)this.skinningMap.image.data.set(new Float32Array(t.buffer,0,12*this.nbBones),0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(new Float32Array(t.buffer,0,12*this.nbBones),0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.setSkinningEulerAngles=function(t,i){var r;this.skinningMapWidth&&this.skinningMapHeight||(r=i>512?64:i>128?32:i>32?16:8,this.skinningMapWidth=r,this.skinningMapHeight=r);if(this.useEulerAngles=!0,this.skinningMap)this.skinningMap.image.data.set(t,0);else{var n=new Float32Array(this.skinningMapWidth*this.skinningMapHeight*3);n.set(t,0),this.skinningMap=new e.DataTexture(n,this.skinningMapWidth,this.skinningMapHeight,e.RGBFormat,e.FloatType),this.skinningMap.minFilter=e.NearestFilter,this.skinningMap.magFilter=e.NearestFilter,this.skinningMap.generateMipmaps=!1,this.skinningMap.flipY=!1}this.skinningMap.needsUpdate=!0},t.prototype.dispose=function(){this.skinningMap&&this.skinningMap.dispose()};const i=function(){this.useEulerAngles=!1,this.skinningInstancingMaps=null,this.skinningInstancingMapsInfo=null};return i.prototype.setInstancingSkinningMatrices=function(t,i,r){var n,s;if(this.useEulerAngles=!1,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var a=function(e){for(var t=1;t<e;)t*=2;return t},o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),h=l*l,c=i*r*4,d=Math.ceil(c/h),u=c-Math.floor(c/h)*h,p=a(Math.sqrt(u)),f=a(u/p),g=3*((d-1)*h+p*f);n={nbBones:i,maxTextureSize:l,nbTextures:d,lastTextureSizeX:p,lastTextureSizeY:f},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(s=new Float32Array(g)).set(t,0));for(var m=0;m<n.nbTextures-1;m++){var v;if(this.skinningInstancingMaps[m])this.skinningInstancingMaps[m].image.data.set(t.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),0);else(v=new e.DataTexture(s.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[m]=v;this.skinningInstancingMaps[m].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((v=new e.DataTexture(s.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,s.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=v);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.setInstancingSkinningEulerAngles=function(t,i,r){var n,s;if(this.useEulerAngles=!0,this.skinningInstancingMapsInfo&&this.nbBones===i)n=this.skinningInstancingMapsInfo;else{var a=function(e){for(var t=1;t<e;)t*=2;return t},o=debugWebGLV6Viewer.renderer.renderer.context,l=o.getParameter(o.MAX_TEXTURE_SIZE),h=l*l,c=i*r*2,d=Math.ceil(c/h),u=c-Math.floor(c/h)*h,p=a(Math.sqrt(u)),f=a(u/p),g=3*((d-1)*h+p*f);n={nbBones:i,maxTextureSize:l,nbTextures:d,lastTextureSizeX:p,lastTextureSizeY:f},this.skinningInstancingMapsInfo=n}this.skinningInstancingMaps||(this.skinningInstancingMaps=new Array(n.nbTextures),(s=new Float32Array(g)).set(t,0));for(var m=0;m<n.nbTextures-1;m++){var v;if(this.skinningInstancingMaps[m])this.skinningInstancingMaps[m].image.data.set(t.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),0);else(v=new e.DataTexture(s.subarray(m*n.maxTextureTotalSize*3,(m+1)*n.maxTextureTotalSize*3),n.maxTextureSize,n.maxTextureSize,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[m]=v;this.skinningInstancingMaps[m].needsUpdate=!0}this.skinningInstancingMaps[n.nbTextures-1]?this.skinningInstancingMaps[n.nbTextures-1].image.data.set(t.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,t.length),0):((v=new e.DataTexture(s.subarray((n.nbTextures-1)*n.maxTextureTotalSize*3,s.length),n.lastTextureSizeX,n.lastTextureSizeY,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,v.magFilter=e.NearestFilter,v.generateMipmaps=!1,v.flipY=!1,this.skinningInstancingMaps[n.nbTextures-1]=v);this.skinningInstancingMaps[n.nbTextures-1].needsUpdate=!0},i.prototype.dispose=function(){if(this.skinningInstancingMaps)for(var e=0;e<this.skinningInstancingMaps.length;e++){var t=this.skinningInstancingMaps[e];t&&t.dispose()}},{SkinningTransformations:t,SkinningTransformationsInstancing:i}}),define("DS/Visualization/StreamVisuLoader",["DS/VisuLoaders/StreamVisuLoader"],function(e){"use strict";return e}),define("Visualization/StreamVisuLoader",["DS/Visualization/StreamVisuLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/StreamVisuLoader"),e}),define("DS/Visualization/OccurrenceInterfaceFactory",["UWA/Class"],function(e){"use strict";return e.extend({init:function(e,t){this._occurrenceExplorer=e,this.viewer=t},getOccurrenceItf:function(e){var t=e._getUniqueOccurrence(this.viewer);return t?this._occurrenceExplorer.getOccurrenceInterface(t):null},getOccurrenceItfMulti:function(e){var t,i=e._getOccurrences(this.viewer),r=[];for(t=0;t<i.length;t++)r.push(this._occurrenceExplorer.getOccurrenceInterface(i[t]));return r},getUserRootOccurrenceItf:function(){var e=this.viewer.internalSceneGraph.userRoot._occurrences[0];return this._occurrenceExplorer.getOccurrenceInterface(e)}})}),define("DS/Visualization/RenderPriorityManager",["UWA/Class","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,t,i){"use strict";return e.extend({init:function(e){this.viewer=e,this.enabled=!1,this.passes=this._createPasses(e)},setEnabled:function(e){e=!!e,this.enabled!==e&&(this.enabled=e,this._enablePasses(this.enabled),this.viewer.internalSceneGraph.root._forceUpdate())},_enablePasses:function(e){if(this.passes){var t,i=this.viewer;if(e)for(t=0;t<this.passes.length;t++)i.renderer.mainComposer.addPass(this.passes[t]);else i.renderer.mainComposer.removePasses(this.passes)}},_createPasses:function(e){var r=[],n=new i("renderPriorityClear");n.defaults.clear=!1,n.setClearStencil(!0),n.clearStencilValue=0,n.idString="renderPriority",r.push(n);var s,a,o;for(s=0;s<=4;s++)(a=new t(null,null,null,null,null,null,"renderPriorityStencilP"+s)).idString="p"+s,a.stencilRef=s,a.enableStencilTest=!0,a.setStencilFunc("GEQUAL"),a.setStencilOps("REPLACE","REPLACE"),a.setEnableStencilWrite(!0),r.push(a),4!==s&&((o=new t(null,null,null,null,null,null,"renderPriorityDrawP"+s)).idString="p"+s,o.stencilRef=s,o.enableStencilTest=!0,o.setStencilFunc("LESS"),o.setStencilOps("KEEP","KEEP"),o.useRenderPriorityOpacity=!0,o.setEnableStencilWrite(!1),r.push(o));return r}})}),define("DS/Visualization/UniformsUtils",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";return{merge:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=this.clone(e[t]))n[i]=r[i];return n},mergeNoClone:function(e){var t,i,r,n={};for(t=0;t<e.length;t++)for(i in r=e[t])n[i]=r[i];return n},clone:function(t){var i,r,n,s={};for(i in t)for(r in s[i]={},t[i])(n=t[i][r])instanceof e.Color||n instanceof e.Vector2||n instanceof e.Vector3||n instanceof e.Vector4||n instanceof e.Matrix4?s[i][r]=n.clone():n instanceof Array?s[i][r]=n.slice():s[i][r]=n;return s}}}),define("DS/Visualization/WebGLObjectManager",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";const t=Math.abs;class i{constructor(e,t){this.object=t,this.frustumCulled=t.frustumCulled}_performCulling(e,i,r){const n=this.object;var s=n.worldCenter,a=n.worldRadius;r.currentRenderPointsOnly=!1;var o=!1;if(e.pixelCulling>0){var l=e.pixelCullingCst;if(!e.isOrtho){var h=e.matrixWorldInverse.elements;l*=t(h[2]*s.x+h[6]*s.y+h[10]*s.z+h[14])}a<l&&(!1===n.hasPoint?o=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!o&&i.performFrustumCulling(a,s)}}class r extends i{constructor(e,t){super(e,t)}_performCulling(e,i,r){const n=this.object;var s=n.worldCenter,a=n.worldRadius;if(e.pixelCulling>0){var o=e.pixelCullingCst;if(!e.isOrtho){var l=e.matrixWorldInverse.elements;o*=t(l[2]*s.x+l[6]*s.y+l[10]*s.z+l[14])}if(a<o)return!1}return i.performFrustumCulling(a,s)}}const n=e._VisuFilterType;function s(e){return e._occurrence?e._occurrence:e}var a=function(){this._prevs=[],this._nexts=[],this._objects=[],this._emptySpace=null,this._emptySpaceSize=0,this._fragmentationSize=0,this._lastDefrag=0,this._first=-1,this._last=-1,this.size=0,this._orderedObjects=null,this._lookUpMap=new Map};return a.prototype.getObjects=function(){if(this._tryDefrag(),null===this._orderedObjects&&(this._orderedObjects=[],!this._isEmpty())){this._orderedObjects.push(this._objects[this._first]);for(var e=this._nexts[this._first];e>=0;e=this._nexts[e])this._objects[e]&&this._orderedObjects.push(this._objects[e])}return this._orderedObjects},a.prototype._defrag=function(){this._emptySpaceSize=0,this._emptySpace=null,this._fragmentationSize=0;var e=this.getObjects();this._first=e.length>0?0:-1,this._last=e.length-1,this._objects=new Array(e.length),this._prevs=new Array(e.length),this._nexts=new Array(e.length),this._lookUpMap=new Map;for(let r=0;r<e.length;r++){var t=e[r];this._objects[r]=t,this._setPrevious(r,r-1),r===e.length-1?this._setNext(r,-1):this._setNext(r,r+1);var i=s(t.object);this._lookUpMap.has(i)?this._lookUpMap.get(i).push(r):this._lookUpMap.set(i,[r])}},a.prototype._tryDefrag=function(){this._lastDefrag++,this._lastDefrag>100&&(this._lastDefrag=0,(this._emptySpaceSize>0||this._fragmentationSize>0)&&this._defrag())},a.prototype.getLinkedList=function(){return this._isEmpty()?null:(this._tryDefrag(),{first:this._first,nexts:this._nexts,objects:this._objects})},a.prototype._isEmpty=function(){return-1===this._first},a.prototype._hasEmpty=function(){return null!==this._emptySpace},a.prototype._pop=function(){this._hasEmpty()&&this._emptySpaceSize--,this._emptySpace=this._emptySpace?this._emptySpace.prev:null},a.prototype._push=function(e){this._emptySpace={index:e,prev:this._emptySpace},this._emptySpaceSize++},a.prototype._getInsertionIndex=function(){var e=-1;return this._hasEmpty()?(e=this._emptySpace.index,this._pop()):e=this._objects.length,e},a.prototype._getNext=function(e){return this._nexts[e]},a.prototype._hasNext=function(e){return-1!==this._nexts[e]},a.prototype._setNext=function(e,t){this._nexts[e]=t},a.prototype._getPrevious=function(e){return this._prevs[e]},a.prototype._hasPrevious=function(e){return-1!==this._prevs[e]},a.prototype._setPrevious=function(e,t){this._prevs[e]=t},a.prototype.add=function(e){if(null!==e){var t=this._getInsertionIndex();if(this._isEmpty())this._objects[t]=e,this._setNext(t,-1),this._setPrevious(t,-1),this._first=t,this._last=t;else{var i=this._getInsertionStructure(e.object);if(i){if(i.before>-1||i.after>-1){if(this._objects[t]=e,this._nexts[t]=-1,this._prevs[t]=-1,i.after>-1){var r=i.after;this._setNext(t,this._getNext(r)),this._setPrevious(t,r),this._hasNext(t)?this._setPrevious(this._getNext(r),t):this._last=t,this._setNext(r,t)}else{var n=i.before;this._setNext(t,n),this._setPrevious(t,this._getPrevious(n)),this._hasPrevious(t)?this._setNext(this._getPrevious(n),t):this._first=t,this._setPrevious(n,t)}this._getNext(t)!==t+1&&-1!==this._getNext(t)?this._fragmentationSize++:this._getPrevious(t)!==t-1&&-1!==this._getPrevious(t)&&this._fragmentationSize++}}else this._objects[t]=e,this._setNext(t,-1),this._setPrevious(t,this._last),this._setNext(this._last,t),this._last=t}var a=s(e.object);this._lookUpMap.has(a)?this._lookUpMap.get(a).push(t):this._lookUpMap.set(a,[t]),this._orderedObjects=null,this.size++}},a.prototype._getInsertionStructure=function(e){var t=e._occurrence;if(t&&(t.prev||t.next)){if(!t.prev)return{before:this._first,after:-1};if(!t.next)return{before:-1,after:this._last};for(var i=!1,r=t.prev,n=t.next,s={before:-1,after:-1};;){var a;if(r&&!i)if(a=this._lookUpMap.get(r)){for(var o=a.length-1;o>=0&&(s.after=a[o],!(s.after>-1));o--);i=!0}else r=r.prev;if(n&&!i)if(a=this._lookUpMap.get(n)){for(o=0;o<a.length&&(s.before=a[o],!(s.before>-1));o++);i=!0}else n=n.next;if(i){if(s.after<0&&s.before<0)throw"Hol'up";return s}if(null===r&&null===n)break}return{before:this._first,after:-1}}return null},a.prototype._shuffle=function(){var e=this.size,t=this._prevs,i=this._objects,r=this._nexts,n=Math.ceil(Math.random()*(e-2)),s=Math.ceil(Math.random()*(e-2));if(0!==n&&0!==s&&n!=s&&r[n]!==s&&r[s]!==n){var a=t[n],o=r[n],l=t[s],h=r[s],c=i[n],d=i[s];c&&d&&(this._first===n?this._first=s:this._first===s&&(this._first=n),this._last===n?this._last=s:this._last===s&&(this._last=n),r[a]=s,t[o]=s,r[l]=n,t[h]=n,r[n]=h,t[n]=l,r[s]=o,t[s]=a,i[n]=d,i[s]=c,this._getNext(n)!==n+1&&-1!==this._getNext(n)?this._fragmentationSize++:this._getPrevious(n)!==n-1&&-1!==this._getPrevious(n)&&this._fragmentationSize++)}},a.prototype._applyToObject=function(e,t){if(null!==e){var i=s(e);if(this._lookUpMap.has(i))for(var r=this._lookUpMap.get(i),n=0;n<r.length;n++)r[n]>-1&&t(this._objects[r[n]])}},a.prototype._remove=function(e){if(null===e)return!1;var t=s(e);if(this._lookUpMap.has(t)){for(var i=this._lookUpMap.get(t),r=0,n=0,a=0;a<i.length;a++){var o=i[a],l=this._objects[o];l?l.object===e&&(this._objects[o]=null,i[a]=-1,this._hasPrevious(o)?this._hasNext(o)?(this._setNext(this._getPrevious(o),this._getNext(o)),this._setPrevious(this._getNext(o),this._getPrevious(o))):(this._setNext(this._getPrevious(o),-1),this._last=this._getPrevious(o)):this._hasNext(o)?(this._setPrevious(this._getNext(o),-1),this._first=this._getNext(o)):(this._first=-1,this._last=-1),this._push(o),r++,this.size--):n++}return r+n===i.length&&this._lookUpMap.delete(t),r>0}return!1},a.prototype.remove=function(e){this._remove(e)&&(this._orderedObjects=null,(this._emptySpaceSize>1e3||this._fragmentationSize>1e3)&&this._defrag())},a.prototype.removeCollection=function(e){var t=0,i=this;e.forEach(function(e,r,n){i._remove(e)&&t++}),t>0&&(this._orderedObjects=null,(this._emptySpaceSize>1e3||this._fragmentationSize>1e3)&&this._defrag())},a.prototype.clear=function(){this._prevs=[],this._nexts=[],this._objects=[],this._emptySpace=null,this._emptySpaceSize=0,this._fragmentationSize=0,this._lastDefrag=0,this._orderedObjects=null,this.size=0,this._lookUpMap.clear()},a.__WebGLObject=i,a.__WebGLObjectNoPoints=r,a.__WebGLObjectCurvedPipe=class extends r{constructor(e,t){super(e,t)}_performCulling(e,t,i){var r=super._performCulling(e,t,i);return r&&this.object._computeLOD(e,i),r}},a.__WebGLObjectFixedSize=class extends i{constructor(e,t){super(e,t)}_performCulling(e,i,r){const n=this.object;var s=n.worldCenter,a=n.pixelRadius;r.currentRenderPointsOnly=!1;var o=!1,l=e.pixelCulling;if(l>0&&a<l&&(!1===n.hasPoint?o=!0:r.currentRenderPointsOnly=!0),r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),o)return!1;var h=a*e._pixelToWorldSizeCst;if(!e.isOrtho){var c=e.matrixWorldInverse.elements;h*=t(c[2]*s.x+c[6]*s.y+c[10]*s.z+c[14])}return i.performFrustumCulling(h,s)}},a.__WebGLObjectHybrid=class extends i{constructor(e,t){super(e,t)}_performCulling(e,i,r){const n=this.object;var s=n.worldCenter,a=n.worldRadius,o=n.pixelRadius*e._pixelToWorldSizeCst,l=1;if(!e.isOrtho){var h=e.matrixWorldInverse.elements;o*=l=t(h[2]*s.x+h[6]*s.y+h[10]*s.z+h[14])}a+=o,r.currentRenderPointsOnly=!1;var c=!1;if(e.pixelCulling>0){var d=e.pixelCullingCst;e.isOrtho||(d*=l),a<d&&(!1===n.hasPoint?c=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!c&&i.performFrustumCulling(a,s)}},a.__WebGLObjectHybridNoPoints=class extends i{constructor(e,t){super(e,t)}_performCulling(e,i,r){const n=this.object;var s=n.worldCenter,a=n.worldRadius,o=n.pixelRadius*e._pixelToWorldSizeCst,l=1;if(!e.isOrtho){var h=e.matrixWorldInverse.elements;o*=l=t(h[2]*s.x+h[6]*s.y+h[10]*s.z+h[14])}if(a+=o,e.pixelCulling>0){var c=e.pixelCullingCst;if(e.isOrtho||(c*=l),a<c)return!1}return i.performFrustumCulling(a,s)}},a.__WebGLObjectInstancing=class extends i{constructor(e,t){super(e,t)}_performCulling(e,i,r){const n=this.object;let s=n._occurrence;for(;s&&!s.node._instancingInfos;)s=s.parent;var a=n.worldCenter,o=n.worldRadius,l=s?s.node.getPixelCullingRadius(n,s):o,h=n.pixelRadius*e._pixelToWorldSizeCst,c=1;if(!e.isOrtho){var d=e.matrixWorldInverse.elements;c=t(d[2]*a.x+d[6]*a.y+d[10]*a.z+d[14]),h*=c-=o}o+=h,l+=h,r.currentRenderPointsOnly=!1;var u=!1;if(e.pixelCulling>0){var p=e.pixelCullingCst;e.isOrtho||(p*=c),l<p&&(!1===n.hasPoint?u=!0:r.currentRenderPointsOnly=!0)}return r.previousRenderPointsOnly!==r.currentRenderPointsOnly&&(r.invalidated=!0,r.previousRenderPointsOnly=r.currentRenderPointsOnly),!u&&i.performFrustumCulling(o,a)}},a.__WebGLObjectInstancingNoPoints=class extends i{constructor(e,t){super(e,t)}_performCulling(e,i,r){const n=this.object;let s=n._occurrence;for(;s&&!s.node._instancingInfos;)s=s.parent;var a=n.worldCenter,o=n.worldRadius,l=s?s.node.getPixelCullingRadius(n,s):o,h=n.pixelRadius*e._pixelToWorldSizeCst,c=1;if(!e.isOrtho){var d=e.matrixWorldInverse.elements;c=t(d[2]*a.x+d[6]*a.y+d[10]*a.z+d[14]),h*=c-=o}if(o+=h,l+=h,e.pixelCulling>0){var u=e.pixelCullingCst;if(e.isOrtho||(u*=c),l<u)return!1}return i.performFrustumCulling(o,a)}},a.__WebGLObjectLOD=class extends i{constructor(e,t){super(e,t.object),this.webGLObject=t,this.lodFilter=this.object._occurrence._getFilter(n._LOD_BRANCH)}get frustumCulled(){return!0}set frustumCulled(e){this.webGLObject&&(this.webGLObject.frustumCulled=e)}_performCulling(e,t,i){return!!this.lodFilter.canRender()&&(!this.webGLObject.frustumCulled||this.webGLObject._performCulling(e,t,i))}},a}),define("DS/Visualization/DAEReader",["DS/VisuLoaders/DAEReader"],function(e){"use strict";return e}),define("Visualization/DAEReader",["DS/Visualization/DAEReader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/DAEReader"),e}),define("DS/Visualization/XMLV6Loader",["DS/VisuLoaders/XMLV6Loader"],function(e){"use strict";return e}),define("Visualization/XMLV6Loader",["DS/Visualization/XMLV6Loader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/XMLV6Loader"),e}),define("DS/Visualization/HighlightData",["DS/Mesh/ThreeJS_Base"],function(e){"use strict";var t="true"===localStorage.getItem("__1x3HL__"),i=function(){this._needsDepth=!1,this.outlineEnabled=!0,this.outlineColor=(new e.Color).setRGB(1,1,1),this.outlineAlpha=1,this.outlineThickness=1,this.haloEnabled=!0,this.haloColor=(new e.Color).setRGB(1,1,1),this.haloIntensity=2,this.haloThickness=4,this.color=(new e.Color).setRGB(1,1,1),this.colorEnabled=!0,this._id=0,this.priority=1,this.clearDepth=!1};i.prototype._setOutlineData=function(e){this.outlineEnabled=void 0!==e.outlineEnabled?e.outlineEnabled:this.outlineEnabled,void 0!==e.outlineColor&&this.outlineColor.copy(e.outlineColor),this.outlineAlpha=void 0!==e.outlineAlpha?e.outlineAlpha:this.outlineAlpha,this.outlineThickness=void 0!==e.outlineThickness?e.outlineThickness:this.outlineThickness},i.prototype._setHaloData=function(e){this.haloEnabled=void 0!==e.haloEnabled?e.haloEnabled:this.haloEnabled,void 0!==e.haloColor&&this.haloColor.copy(e.haloColor),this.haloIntensity=void 0!==e.haloIntensity?e.haloIntensity:this.haloIntensity,this.haloThickness=void 0!==e.haloThickness?e.haloThickness:this.haloThickness,this.haloThickness=Math.min(this.haloThickness,4)},i.prototype._setGenericData=function(e){void 0!==e.priority&&0!==this.priority&&0!==e.priority&&(this.priority=e.priority),void 0!==e.clearDepth&&0!==this.priority&&(this.clearDepth=e.clearDepth)},i.prototype._setColorData=function(e){this.colorEnabled=void 0!==e.colorEnabled?e.colorEnabled:this.colorEnabled,void 0!==e.color&&this.color.copy(e.color)},i.prototype.isEqual=function(e){return(void 0===e.outlineEnabled||e.outlineEnabled===this.outlineEnabled)&&((void 0===e.outlineAlpha||e.outlineAlpha===this.outlineAlpha)&&((void 0===e.haloEnabled||e.haloEnabled===this.haloEnabled)&&((void 0===e.haloIntensity||e.haloIntensity===this.haloIntensity)&&(!(void 0!==e.outlineColor&&!this.outlineColor.equals(e.outlineColor))&&((void 0===e.outlineThickness||this.outlineThickness===e.outlineThickness)&&(!(void 0!==e.haloColor&&!this.haloColor.equals(e.haloColor))&&(!(void 0!==e.color&&!this.color.equals(e.color))&&((void 0===e.colorEnabled||e.colorEnabled===this.colorEnabled)&&((void 0===e.priority||e.priority===this.priority)&&(void 0===e.clearDepth||e.clearDepth===this.clearDepth))))))))))},i.prototype._updateMixPassUniforms=function(e,t){this._id=t;var i=4*(t-1);const r=e.getUniform("iHaloColors"),n=e.getUniform("iOutlineColors"),s=e.getUniform("iLineicOutlineColors"),a=e.getUniform("iColors");r[i]=this.haloEnabled?this.haloColor.r:0,r[i+1]=this.haloEnabled?this.haloColor.g:0,r[i+2]=this.haloEnabled?this.haloColor.b:0,n[i]=this.outlineEnabled?this.outlineColor.r:0,n[i+1]=this.outlineEnabled?this.outlineColor.g:0,n[i+2]=this.outlineEnabled?this.outlineColor.b:0,n[i+3]=this.outlineEnabled?this.outlineAlpha:-1,s[i]=0,s[i+1]=0,s[i+2]=0,s[i+3]=this.outlineEnabled?this.outlineThickness:0,a[i]=this.colorEnabled?this.color.r:0,a[i+1]=this.colorEnabled?this.color.g:0,a[i+2]=this.colorEnabled?this.color.b:0},i.prototype._updateMaterialUniforms=function(e,t,i){e.iHighlightColor?t.uniform4f(e.iHighlightColor,this.color.r,this.color.g,this.color.b,1):e.iHighlightLineicColor?t.uniform4f(e.iHighlightLineicColor,this.outlineColor.r,this.outlineColor.g,this.outlineColor.b,1):t.uniform1f(e.highlightID,this._id),e.rgbaDepth&&i.loadTexture(t,e.rgbaDepth,i.politeDepthBuffer)};var r=function(e){i.call(this),this.intensity=1,this._setData(e)};(r.prototype=Object.create(i.prototype))._updateMixPassUniforms=function(e,t){i.prototype._updateMixPassUniforms.call(this,e,t);var r=4*(t-1);const n=e.getUniform("iHaloColors"),s=e.getUniform("iLineicHaloColors"),a=e.getUniform("iColors");n[r+3]=this.haloEnabled?this.haloIntensity*this.haloIntensity:0,a[r+3]=this.colorEnabled?this.intensity:0,s[r]=0,s[r+1]=0,s[r+2]=0,s[r+3]=-1},r.prototype.isEqual=function(e){return!!i.prototype.isEqual.call(this,e)&&(void 0===e.intensity||e.intensity===this.intensity)},r.prototype._updateMaterialUniforms=function(e,t,r){i.prototype._updateMaterialUniforms.call(this,e,t,r),(e.iHighlightColor||e.iHighlightLineicColor)&&t.uniform2f(e.iHighlightIntensity,this.colorEnabled?this.intensity:0,-1)},r.prototype._setColorData=function(e){i.prototype._setColorData.call(this,e),this.intensity=void 0!==e.intensity?e.intensity:this.intensity},r.prototype._setData=function(e){e=e||{},this._setColorData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e)};var n=function(t){i.call(this),this._needsDepth=!0,this.visibleAlpha=1,this.occludedAlpha=1,this.lineicOutlineColor=(new e.Color).setRGB(1,1,1),this.lineicHaloColor=(new e.Color).setRGB(1,1,1),this._setData(t)};return(n.prototype=Object.create(i.prototype)).isEqual=function(e){return!!i.prototype.isEqual.call(this,e)&&((void 0===e.visibleAlpha||e.visibleAlpha===this.visibleAlpha)&&((void 0===e.occludedAlpha||e.occludedAlpha===this.occludedAlpha)&&(!(void 0!==e.lineicOutlineColor&&!this.lineicOutlineColor.equals(e.lineicOutlineColor))&&!(void 0!==e.lineicHaloColor&&!this.lineicHaloColor.equals(e.lineicHaloColor)))))},n.prototype._updateMixPassUniforms=function(e,t){i.prototype._updateMixPassUniforms.call(this,e,t);var r=4*(t-1);const n=e.getUniform("iHaloColors"),s=e.getUniform("iLineicHaloColors"),a=e.getUniform("iLineicOutlineColors"),o=e.getUniform("iColors");n[r+3]=this.haloEnabled?1.4*this.haloIntensity:0,o[r+3]=this.colorEnabled?this.visibleAlpha:0,s[r+3]=this.colorEnabled?this.occludedAlpha:0,a[r]=this.outlineEnabled?this.lineicOutlineColor.r:0,a[r+1]=this.outlineEnabled?this.lineicOutlineColor.g:0,a[r+2]=this.outlineEnabled?this.lineicOutlineColor.b:0,s[r]=this.haloEnabled?this.lineicHaloColor.r:0,s[r+1]=this.haloEnabled?this.lineicHaloColor.g:0,s[r+2]=this.haloEnabled?this.lineicHaloColor.b:0},n.prototype._updateMaterialUniforms=function(e,t,r){i.prototype._updateMaterialUniforms.call(this,e,t,r),(e.iHighlightColor||e.iHighlightLineicColor)&&t.uniform2f(e.iHighlightIntensity,Math.max(this.visibleAlpha,.3),Math.max(this.occludedAlpha,.1))},n.prototype._setPoliteData=function(e){i.prototype._setColorData.call(this,e),this.visibleAlpha=void 0!==e.visibleAlpha?e.visibleAlpha:this.visibleAlpha,this.occludedAlpha=void 0!==e.occludedAlpha?e.occludedAlpha:this.occludedAlpha},n.prototype._setData=function(e){e=e||{},this._setPoliteData(e),this._setHaloData(e),this._setOutlineData(e),this._setGenericData(e),void 0!==e.lineicOutlineColor&&this.lineicOutlineColor.copy(e.lineicOutlineColor),void 0!==e.lineicHaloColor&&this.lineicHaloColor.copy(e.lineicHaloColor)},{DefaultHighlightData:{halo:new r({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloThickness:4,haloIntensity:2,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(0,.6,1),visibleAlpha:.6,occludedAlpha:.15,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),lineicHaloColor:t?(new e.Color).setRGB(0,.85,1):(new e.Color).setRGB(0,1,1),haloIntensity:2,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),lineicOutlineColor:t?(new e.Color).setRGB(0,1,1):(new e.Color).setRGB(0,.6,1),outlineAlpha:1,outlineThickness:1})},DefaultPreHighlightData:{halo:new r({colorEnabled:!1,color:(new e.Color).setRGB(0,.6,1),intensity:1,haloEnabled:!0,haloColor:(new e.Color).setRGB(0,.6,1),haloIntensity:2,haloThickness:1,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(0,1,1),outlineAlpha:1,outlineThickness:1}),advancedpolite:new n({colorEnabled:!0,color:(new e.Color).setRGB(.97,.97,.97),visibleAlpha:.3,occludedAlpha:0,haloEnabled:!0,haloColor:(new e.Color).setRGB(.67,.67,.69),lineicHaloColor:t?(new e.Color).setRGB(.7,.7,.72):(new e.Color).setRGB(1,1,1),haloIntensity:1.3,haloThickness:4,outlineEnabled:!0,outlineColor:(new e.Color).setRGB(.97,.97,.97),lineicOutlineColor:t?(new e.Color).setRGB(1,1,1):(new e.Color).setRGB(.7,.7,.72),outlineAlpha:1,outlineThickness:1})},HaloHighlightData:r,AdvancedPoliteHighlightData:n}}),define("DS/Visualization/ShaderLib",["DS/ShaderBuilders/MeshPhongShaderBuilder","DS/ShaderBuilders/LineBasicShaderBuilder","DS/ShaderBuilders/ParticleBasicShaderBuilder","DS/ShaderBuilders/MeshBasicShaderBuilder","DS/ShaderBuilders/MeshLambertShaderBuilder","DS/ShaderBuilders/PBRShaderBuilder","DS/ShaderBuilders/CubeMapShaderBuilder","DS/ShaderBuilders/SimpleMapShaderBuilder","DS/ShaderBuilders/GradientBackgroundShaderBuilder","DS/ShaderBuilders/LatLongMapShaderBuilder","DS/ShaderBuilders/FiniteTransitionEnvMapShaderBuilder","DS/ShaderBuilders/FiniteEnvMapShaderBuilder"],function(e,t,i,r,n,s,a,o,l,h,c,d){"use strict";return{basic:r,lambert:n,phong:e,particle_basic:i,line:t,physicalDS:s,finiteenvmap:d,gradient2:l.Gradient2Builder,gradient3:l.Gradient3Builder,gradient4:l.Gradient4Builder,latlong:h,cubemap:a,finitetransition:c,simplemap:o}}),define("DS/Visualization/Detector",[],function(){"use strict";return{canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!(!window.WebGLRenderingContext||!document.createElement("canvas").getContext("experimental-webgl")&&!document.createElement("canvas").getContext("webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e;return this.webgl||(e=window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />':'Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>',e+='Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'),e}}}),define("Visualization/Detector",["DS/Visualization/Detector","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Detector"),e}),define("DS/Visualization/StaticOverrideSet",["DS/Mesh/MeshUtils"],function(e){"use strict";var t=1;function i(e,i){this.id=t++,this.path=e,this.materialApplication=i}i.prototype.deactivate=function(){this.apply(!1)},i.prototype.apply=function(e){this.path.internalPath.length>0?this.apply_internal(e):this.apply_external(e)},i.prototype.apply_external=function(e){var t,i,r,n,s,a,o;if(e)for(t=this.path.externalPath[0]._occurrences,i=0;i<t.length;i++)o=(r=t[i]).depth,(n=this.path._getOccurrenceFromRootOccurrence(r))&&(s=n.matAppOverride,(a=this.materialApplication)._depth=o,s&&!a.isPrioritary(s,o)||(n.matAppOverride=a.clone()),a._depth=-1);else for(t=this.path._getOccurrences(null),i=0;i<t.length;i++)(n=t[i]).matAppOverride=null},i.prototype.apply_internal=function(t){var i,r,n=this.path.externalPath[0]._occurrences,s=this.path.getLastElement(),a=s&&s instanceof e.SGPrimitiveHelper?[s]:s.getPrimitives();for(r=0;r<n.length;r++)i=n[r],this.applyToRootOccurrence_internal(t,i,a)},i.prototype.applyToRootOccurrence_internal=function(e,t,i){var r=this.path._getOccurrenceFromRootOccurrence(t);if(r){for(var n=r._getRenderableOccurrences(),s=n.length,a=0;a<s;a++){var o=n[a];o&&o._flagAsGSSOInvalidated()}if(i){var l=e?this.materialApplication.clone():null;l&&(l._depth=t.depth);for(a=0;a<n.length;a++)this.applyToRenderable(n[a],i,l)}}},i.prototype.applyToRenderable=function(e,t,i){null===e.layer&&e.initLayers(1),e.layer.addPrimitivesToLayers(t,1,void 0,void 0,i)};var r=function(e){this.root=e,this._overrides=[]};return r.prototype.addStaticOverride=function(e,t){if(e.externalPath[0]===this.root){var r=new i(e,t);return this._overrides.push(r),r.id}return-1},r.prototype.clear=function(){this._deactivateStaticOverrides(),this._overrides=[]},r.prototype.applyStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!0)},r.prototype._deactivateStaticOverrides=function(){var e;for(e=0;e<this._overrides.length;e++)this._overrides[e].apply(!1)},r}),define("DS/Visualization/XMLV43Loader",["DS/VisuLoaders/XMLV43Loader"],function(e){"use strict";return e}),define("Visualization/XMLV43Loader",["DS/Visualization/XMLV43Loader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/XMLV43Loader"),e}),define("DS/Visualization/Utils",["UWA/Class","UWA/Utils","DS/Visualization/ProxyAbstraction"],function(e,t,i){"use strict";var r=e.extend({init:function(){}});return r.parseUrl=function(e){return t.parseUrl(e)},r.getExtension=function(e){var t=e.replace(/\.\./g,"");if(1===(t=t.split(".")).length||""===t[0]&&2===t.length)return"";var i=t.pop(),r=i.indexOf("?")+1;return t=r?i.substring(0,r-1):i,null!==new RegExp(/^[a-zA-Z0-9_]+$/).exec(t)?t:""},r.getDomain=function(e){var i=e;return t.isAbsoluteUrl(e)||(i=window.location),r.parseUrl(i).hostname},r.getWorkerFromSpec=function(e,t){var n=window.URL||window.webkitURL,s=new i;r.setProxyFromSpec(e,s);var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"";s.executeGetHttpRequest(a,"blob",null,function(e){var i=n.createObjectURL(e),r=new Worker(i);t&&t(r)})},r.getJSFromSpec=function(e,t){var n=new i;r.setProxyFromSpec(e,n);var s=e.serverurl?e.serverurl:"";s+=e.filename?e.filename:"",e.module&&e.filename&&(s=require.toUrl("DS/"+e.module+"/"+e.filename));n.executeGetHttpRequest(s,"text",null,function(e){t&&t(e)},null,"text/plain, text/javascript, application/javascript, application/x-javascript")},r.getWorkerFromSpecs=function(e,t){var i=window.URL||window.webkitURL,n="",s=function(a){r.getJSFromSpec(e[a],function(r){if(n+=r,a<e.length-1)s(a+1);else if(t){var o=new Blob([n],{type:"application/javascript"}),l=i.createObjectURL(o),h=new Worker(l);t(h)}})};s(0)},r.getWorkerBlobFromSpecs=function(e,t){var i=window.URL||window.webkitURL,n="",s=function(a){r.getJSFromSpec(e[a],function(r){if(n+=r,a<e.length-1)s(a+1);else if(t){var o=new Blob([n],{type:"application/javascript"}),l=i.createObjectURL(o);t(l)}})};s(0)},r.getFileURLFromSpec=function(e,t){var n=window.URL||window.webkitURL,s=new i;r.setProxyFromSpec(e,s);var a=e.serverurl?e.serverurl:"";a+=e.filename?e.filename:"";s.executeGetHttpRequest(a,"blob",null,function(e){var i=n.createObjectURL(e);t&&t(i)})},r.getFilesURLFromSpec=function(e,t){var i=[],n=function(s){r.getFileURLFromSpec(e[s],function(r){i.push(r),s<e.length-1?n(s+1):t&&t(i)})};n(0)},r.setProxyFromSpec=function(e,t){if(e.proxyurl)if("none"===e.proxyurl)t.useNoProxy(e.withCredentials);else{var i=r.parseUrl(e.proxyurl);if(null===i)t.useUWAProxy();else if(null!=i.hostname)t.useProxyDefinedBy(i.hostname,i.port);else if(0==(n=e.proxyurl.indexOf("http://127.0.0.1"))){var n=e.proxyurl.lastIndexOf(":"),s=e.proxyurl.slice(n+1,e.proxyurl.length);s=s.replace("/",""),t.useProxyDefinedBy("127.0.0.1",8023)}}else t.useUWAProxy({proxymode:e.requiredAuth,requestsOptions:e.requestsOptions,login:e.login,contextid:e.contextid})},UWA.namespace("THREEDS/Utils",r)}),define("Visualization/Utils",["DS/Visualization/Utils","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Utils"),e}),define("DS/Visualization/FixedSizeArrayPool",["DS/Visualization/WidelinesHelper","DS/Mesh/ThreeJS_Base"],function(e,t){var i=function(){},r=0,n=0,s=new Map,a=null,o=null;localStorage.getItem("curvedPipesDebug")&&"true"===localStorage.getItem("curvedPipesDebug")&&(o={nbTokens:0,nbInstData:0,tokens:{},tokenPool:a,instData:{},maxNbInstances:{},instDataPool:s},window._debugTokenPool=o);var l=function(e,t,i){this.id=r++,this.idsArray=new Float32Array(2*e),this.idsBuffer=null,this.includesPicking=t,this.pickingColorArray=t?new Float32Array(3*e):null,this.pickingColorBuffer=null,this.lastId=-1,this.igId=i,this._maxNbInstances=e,this.key="",this.objectToIdInArray=new Map,this.idToObjectArray=new Map,this.updateData=!0,this._next=null,o&&(o.nbInstData++,o.instData[this.id]=this,o.maxNbInstances[e]?o.maxNbInstances[e]++:o.maxNbInstances[e]=1)};l.prototype.addInstance=function(e,t,i,r,n){if(this.lastId!==this._maxNbInstances-1){this.lastId++;var s=i.dgIndex+"_"+i.index,a=this.objectToIdInArray.get(s);void 0===a?(this.objectToIdInArray.set(s,this.lastId),this.idToObjectArray.set(this.lastId,s),a=this.lastId):console.log("what!!");var o=t.idInMaps,l=t.matrixId4,h=2*a;if(this.idsArray[h]=l,this.idsArray[h+1]=o*n,this.pickingColorArray){var c=3*a;this.pickingColorArray[c]=r.r,this.pickingColorArray[c+1]=r.g,this.pickingColorArray[c+2]=r.b}this.updateData=!0}else console.error("there has been an issue : not enough room to add instances")},l.prototype.removeInstances=function(e,t,i){for(var r=0;r<i.length&&-1!==this.lastId;r++){i[r].bin===this.igId&&this.removeInstance(e,t,r)}return-1===this.lastId},l.prototype.removeInstance=function(e,t,i){var r=e+"_"+t+"_"+i,n=this.objectToIdInArray.get(r),s=this.idToObjectArray.get(this.lastId);if(void 0!==n){if(this.objectToIdInArray.delete(r),this.idToObjectArray.delete(n),n!==this.lastId){var a=this.idsArray[2*this.lastId],o=this.idsArray[2*this.lastId+1];if(this.idsArray[2*n]=a,this.idsArray[2*n+1]=o,this.pickingColorArray){var l=this.pickingColorArray[3*this.lastId],h=this.pickingColorArray[3*this.lastId+1],c=this.pickingColorArray[3*this.lastId+2];this.pickingColorArray[3*n]=l,this.pickingColorArray[3*n+1]=h,this.pickingColorArray[3*n+2]=c}var d=this.objectToIdInArray.get(s);this.objectToIdInArray.set(s,n),this.idToObjectArray.delete(d),this.idToObjectArray.set(n,s),this.updateData=!0}this.lastId--}},l.prototype.copyDataTo=function(e){for(var t=this.idsArray.length,i=0;i<t;i++)e.idsArray[i]=this.idsArray[i];if(this.pickingColorArray){var r=this.pickingColorArray.length;for(i=0;i<r;i++)e.pickingColorArray[i]=this.pickingColorArray[i]}this.objectToIdInArray.forEach(function(t,i){e.objectToIdInArray.set(i,t)}),this.idToObjectArray.forEach(function(t,i){e.idToObjectArray.set(i,t)}),e.lastId=this.lastId,e.includesPicking=this.includesPicking,e.updateData=!0},l.prototype.resetForReuse=function(e){this.lastId=-1,this.igId=e,this.objectToIdInArray?this.objectToIdInArray.clear():this.objectToIdInArray=new Map,this.idToObjectArray?this.idToObjectArray.clear():this.idToObjectArray=new Map,null===this.idsArray&&(this.idsArray=new Float32Array(2*this._maxNbInstances)),this.includesPicking&&null===this.pickingColorArray&&(this.pickingColorArray=new Float32Array(3*this._maxNbInstances)),this.updateData=!0};var h=function(e,t,r,s,a,l,h){this.object=e,this.geometry=t,this.dg=r,this.start=s,this.count=a,this.previous=null,this.next=null,this.doRenderLineModePolygonOffset={doIt:!1,enable:!1,unit:1,factor:1},this.doSetMaterialFaces={doubleSided:!1,forceSide:!1,flipSided:!1},this.zSortKey=0,this.draw=i,this.updateLineInfos=!1,this.matApp=l,this.gas=h,this._programID=0,e&&(this._programID|=e._programID),l&&(this._programID|=l._programID),o&&(this.__id=n++)};h.prototype.reset=function(){this.object=null,this.geometry=null,this.dg=null,this.start=0,this.count=0,this.zSortKey=0,this.matApp=null,this.gas=null,this._programID=0};const c=new t.Matrix4;h.prototype._updateWideLineAndPatternStuff=function(i,r,n){const s=r.domElement;if(i.isDashedLine&&i.isCPUPattern)if(i.isWideLine||i.is2DLine){if(!r.renderVolumesOnly)if(l=this.geometry){var a=this.object,o=(new t.Matrix4).multiplyMatrices(n.matrixWorldInverse,a._getMMMatrix());e._computePixelWideLineDistances(l,o,n.projectionMatrix,s)}}else{a=this.object,o=(new t.Matrix4).multiplyMatrices(n.matrixWorldInverse,a._getMMMatrix());var l=this.geometry;e._computePixelLineDistances(l,o,n.projectionMatrix,s)}const h=this.dg;if(h&&h._updateLineWithShapes){let e=c,i=1;if(h._updateLineWithShapes.needProjectionMatrix){e=new t.Matrix4(s.width/2,0,0,0,0,s.height/2,0,0,0,0,1,0,0,0,0,1).multiply(n.projectionMatrix).multiply(n.matrixWorldInverse).multiply(this.object._getMMMatrix())}else i=this.object._getMMMatrix().getScaleOnAxisX();h._updateLineWithShapes.cb(e,i)}};var d=function(e,t,i,r,n,s,a,l,c,d){h.call(this,e,t,i,r,n,s,a),o&&(o.nbTokens++,o.tokens[this.__id]=this),this.autoInstancingData=u.prototype.allocate_autoInstData(l,c,d),this.instanced=!0};d.prototype.releaseAutoInstData=function(){var e=s.get(this.autoInstancingData.key)||null;this.autoInstancingData._next=e,s.set(this.autoInstancingData.key,this.autoInstancingData),o&&(o.nbInstData--,o.maxNbInstances[this.autoInstancingData._maxNbInstances]--,delete o.instData[this.autoInstancingData.id])};var u=function(){this.bySizePools={},this.pool5=this.bySizePools[5]={list:[],nextAvailable:0,lastCount:0},this.timerClean=void 0},p=null;return u.prototype.allocate=function(e,t,r,n,s,a,o){var l=null;if(p){l=p;p=p.next,l.object=e,l.geometry=t,l.dg=r,l.start=n,l.count=s,l.previous=null,l.next=null,l.doRenderLineModePolygonOffset.doIt=!1,l.doRenderLineModePolygonOffset.enable=!1,l.doRenderLineModePolygonOffset.unit=1,l.doRenderLineModePolygonOffset.factor=1,l.doSetMaterialFaces.doubleSided=!1,l.doSetMaterialFaces.forceSide=!1,l.doSetMaterialFaces.flipSided=!1,l.draw=i,l.zSortKey=0,l.matApp=a,l.gas=o,l._programID=0,e&&(l._programID|=e._programID),a&&(l._programID|=a._programID)}else l=new h(e,t,r,n,s,a,o);return l},u.prototype.release=function(e){e.next=p,p=e,e.reset()},u.prototype.allocateInstancedCurvedPipeSection=function(e,t,r,n,s,l,h,c,p,f){var g=null;if(a){g=a;a=a.next,g.object=e,g.geometry=t,g.dg=r,g.start=n,g.count=s,g.previous=null,g.next=null,g.higher=null,g.lower=null,g.doRenderLineModePolygonOffset.doIt=!1,g.doRenderLineModePolygonOffset.enable=!1,g.doRenderLineModePolygonOffset.unit=1,g.doRenderLineModePolygonOffset.factor=1,g.doSetMaterialFaces.doubleSided=!1,g.doSetMaterialFaces.forceSide=!1,g.doSetMaterialFaces.flipSided=!1,g.draw=i,g.zSortKey=0,g.matApp=l,g.gas=h,g._programID=0,e&&(g._programID|=e._programID),l&&(g._programID|=l._programID),g.autoInstancingData=u.prototype.allocate_autoInstData(c,p,f),o&&(o.nbTokens++,o.tokens[g.__id]=g)}else g=new d(e,t,r,n,s,l,h,c,p,f);return g},u.prototype.releaseInstanced=function(e){e.releaseAutoInstData(),e.autoInstancingData=null,e.next=a,a=e,o&&(o.nbTokens--,delete o.tokens[e.__id])},u.prototype.allocate_autoInstData=function(e,t,i){var r=e.toString()+(t?"p":""),n=s.get(r)||null,a=null;n?(a=n,s.set(r,n._next),a._next=null,a.resetForReuse(i),o&&(o.nbInstData++,o.maxNbInstances[e]?o.maxNbInstances[e]++:o.maxNbInstances[e]=1,o.instData[a.id]=a)):(a=new l(e,t,i)).key=r;var h=debugWebGLV6Viewer.renderer.renderer.context;return a.idsBuffer||(a.idsBuffer=h.createBuffer()),h.bindBuffer(h.ARRAY_BUFFER,a.idsBuffer),h.bufferData(h.ARRAY_BUFFER,a.idsArray,h.DYNAMIC_DRAW),t&&(a.pickingColorBuffer||(a.pickingColorBuffer=h.createBuffer()),h.bindBuffer(h.ARRAY_BUFFER,a.pickingColorBuffer),h.bufferData(h.ARRAY_BUFFER,a.pickingColorArray,h.DYNAMIC_DRAW)),a},u.prototype.dispose=function(){p=null,a=null,s.clear()},u}),define("Visualization/FixedSizeArrayPool",["DS/Visualization/FixedSizeArrayPool","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/FixedSizeArrayPool"),e}),define("DS/Visualization/GeometryProcessing",["DS/Mesh/ThreeJS_Base","DS/Visualization/ImplicitGeometries"],function(e,t){"use strict";const i=new Uint32Array(2),r=new Float64Array(i.buffer);function n(e,t){return e>t?(i[0]=e,i[1]=t):(i[0]=t,i[1]=e),Number.isFinite(r[0])?r[0]:`${e}:${t}`}const s=(1+Math.sqrt(5))/2,a=2*Math.PI*s,o=Math.PI*Math.sqrt(5),l=1/Math.sqrt(5),h=1/Math.log(s+1),c={PLANE:3,AXIS:2,POINT:1,NONE:0,space_none:()=>({type:c.NONE}),space_point:e=>({type:c.POINT,point:e}),space_axis:e=>({type:c.AXIS,axis:e}),space_plane:e=>({type:c.PLANE,plane:e}),compute(i,r=null){if(r||(r=[0,i.vertexIndexArray.length]),2!==r.length||r[1]<=r[0])return this.space_none();const n=i.vertexIndexArray;let s=r[0];const a=r[1];function o(e){return i.getVertexPosition(n[s],e),e}const l=new e.Vector3;o(l),s++;const h=new e.Vector3;for(;s<a&&o(h).distanceToSquared(l)<1e-6;)s++;if(s>=a)return this.space_point(l);const c=new t.InfiniteLine3(l,(new e.Vector3).subVectors(h,l));s++;const d=new e.Vector3;for(;s<a&&c.distanceToSquared(o(h),d)<1e-6;)s++;if(s>=a)return this.space_axis(c);const u=(new e.Vector3).crossVectors(c.axis,d.subVectors(h,l)).normalize(),p=new t.Plane(u,-u.dot(l));for(s++;s<a&&p.distanceToPointSquared(o(h))<1e-6;)s++;return s>=a?this.space_plane(p):this.space_none()},combine(e,t,i=1e-9){if(!e||!t)return e||t;switch(e.type){case c.POINT:switch(t.type){case c.POINT:return this._combine_point_point(e.point,t.point,i);case c.AXIS:return this._combine_point_axis(e.point,t.axis,i);case c.PLANE:return this._combine_point_plane(e.point,t.plane,i)}case c.AXIS:switch(t.type){case c.POINT:return this._combine_point_axis(t.point,e.axis,i);case c.AXIS:return this._combine_axis_axis(e.axis,t.axis,i);case c.PLANE:return this._combine_axis_plane(e.axis,t.plane,i)}case c.PLANE:switch(t.type){case c.POINT:return this._combine_point_plane(t.point,e.plane,i);case c.AXIS:return this._combine_axis_plane(t.axis,e.plane,i);case c.PLANE:return this._combine_plane_plane(e.plane,t.plane,i)}}return this.space_none()},fit({plane:e,space:t,transform:i}){switch(t.type){case c.NONE:return!1;case c.POINT:return e.containsPoint(t.point.clone().applyMatrix4(i));case c.AXIS:return e.containsInfiniteLine(t.axis.clone().applyMatrix4(i));case c.PLANE:return e.containsPlane(t.plane.clone().applyMatrix4(i));default:return!1}},_combine_point_point(t,i,r){return t.distanceToSquared(i)<r?this.space_point(t):this.space_axis(t,(new e.Vector3).subVectors(i,t))},_combine_point_axis(i,r,n){const s=new e.Vector3;return r.distanceToSquared(i,s)<n?this.space_axis(r):(s.subVectors(i,r.origin).cross(r.axis).normalize(),this.space_plane(new t.Plane(s,-s.dot(i))))},_combine_point_plane(e,t,i){return t.containsPoint(e,i)?this.space_plane(t):this.space_none()},_combine_axis_axis(i,r,n){const s=new e.Vector3;return i.distanceToSquared(r.origin,s)<n&&Math.abs(i.axis.dot(r.axis))>1-n?this.space_axis(i):(s.crossVectors(i.axis,r.axis).normalize(),this.space_plane(new t.Plane(s,-s.dot(i.origin))))},_combine_axis_plane(e,t,i){return t.containsInfiniteLine(e,i)?this.space_plane(t):this.space_none()},_combine_plane_plane(e,t,i){return e.containsPlane(t,i)?this.space_plane(e):this.space_none()}};return{deduplicateVerticesExactMatch:function(e,t=3){const i=e.length/t,r=new Float32Array(t),n=new Uint16Array(r.buffer);let s=null;switch(t){case 2:s=function(t){const i=2*t;return r[0]=e[i],r[1]=e[i+1],String.fromCharCode(n[0],n[1],n[2],n[3])};break;case 3:s=function(t){const i=3*t;return r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],String.fromCharCode(n[0],n[1],n[2],n[3],n[4],n[5])};break;default:s=function(i){const s=i*t;for(let i=0;i<t;i++)r[i]=e[s+i];return String.fromCharCode(...n)}}const a=new Map,o=i>65535?new Uint32Array(i):new Uint16Array(i);for(let e=0;e<i;e++){const t=s(e);let i=a.get(t);void 0===i&&a.set(t,i=e),o[e]=i}return o},mergeIndexBuffers:function(e){let t=!1,i=0;for(let r=0;r<e.length;r++)e[r]instanceof Uint32Array&&(t=!0),i+=e[r].length;const r=t?new Uint32Array(i):new Uint16Array(i);let n=0;for(let t=0;t<e.length;t++)r.set(e[t],n),n+=e[t].length;return r},computeFaceNormals:function({geom:t,index_ranges:i,alloc_output:r=null}){const n=t.vertexPositionArray,s=t.vertexIndexArray,a=r?r(s.length):new Float32Array(s.length);function o(e,t){e*=3,t.x=n[e],t.y=n[e+1],t.z=n[e+2]}const l=new e.Vector3,h=new e.Vector3,c=new e.Vector3;for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3)o(s[e],l),o(s[e+1],h),o(s[e+2],c),c.sub(h),h.sub(l),h.cross(c),a[e]=h.x,a[e+1]=h.y,a[e+2]=h.z}return a},FitPlaneSpace:c,FibonacciSpiral:{get:function(t,i,r=null){const n=1-(2*t+1)/i,s=Math.sqrt(1-n*n),o=t*a,l=s*Math.cos(o),h=s*Math.sin(o);return r?r.set(l,h,n):r=new e.Vector3(l,h,n),r},inv:function(t,i){const r=1-1/i,n=Math.min(Math.atan2(t.y,t.x),Math.PI),a=t.z,c=e=>e-Math.floor(e),d=Math.max(2,Math.floor(Math.log(i*(1-a*a)*o)*h)),u=Math.pow(s,d)*l,p=Math.round(u),f=Math.round(u*s),g=2*p/i,m=2*f/i,v=2*Math.PI*(c((p+1)*s)-(s-1)),_=2*Math.PI*(c((f+1)*s)-(s-1)),y=1/(m*v-g*_),S=Math.floor(y*(m*n+_*(a-r))),x=Math.floor(y*(-g*n-v*(a-r)));let b=8,w=0,M=new e.Vector3;for(let e=0;e<4;e++){const r=Math.floor(e/2),n=e-2*r,s=Math.floor(p*(n+S)+f*(r+x));this.get(s,i,M);const a=t.distanceToSquared(M);a<b&&(b=a,w=s)}return w}},computeAdjacencyTriangleToTriangle:function({geom:e,index_ranges:t,deduplication:i=null,bijective:r=!0,result:s=null}){s||(s=new Uint32Array(e.vertexIndexArray.length));const a=new Map;function o(e,t,i,o){const l=n(e,t),h=a.get(l);void 0===h?a.set(l,4*i+o):(s[(h>>>2)+h%4]=1+4*i+o,r&&(s[i+o]=1+h),a.delete(l))}const l=e.vertexIndexArray,h=i?e=>i[l[e]]:e=>l[e];for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let e=i;e<r;e+=3){const t=h(e+0),i=h(e+1),r=h(e+2);o(t,i,e,0),o(i,r,e,1),o(r,t,e,2)}}return{adjacency:s,boundary:a}},extractBoundaryEdges:function(e,t){let i=e.values(),r=i.next();const n=[];for(;!r.done;){const e=r.value>>>2,s=r.value%4;n.push(t[e+s]),n.push(t[e+(s+1)%3]),r=i.next()}return Uint32Array.from(n)},edgeKey:n}}),define("DS/Visualization/OutlineBuilder",["DS/Mesh/Mesh","DS/Visualization/GeometryProcessing","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],function(e,t,i){"use strict";var r,n=!1;const s=(e,t,r)=>i.FunctionHandler.callFunction(e,t,r),a="";class o{constructor(e){this.type=e,this.array=null}get(e=0){return(!this.array||this.array.length<e)&&(this.array=new this.type(this._alloc_size(e))),0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}realloc(e=0){if(!this.array)return this.get(e);if(0===e||this.array.length<e){const t=new this.type(this._alloc_size(e));t.set(this.array),this.array=t}return 0===e?new this.type(this.array.buffer):new this.type(this.array.buffer,0,e)}_alloc_size(e){return Math.max(this.array?2*this.array.length:10,e)}}new o(Uint32Array),new o(Uint32Array);function l(e,t,i,r,n,s,a,o){for(let l=i;l<r;l+=3){const i=3*t[l],r=3*t[l+1],h=3*t[l+2],c=e[i],d=e[i+1],u=e[i+2],p=e[r],f=e[r+1],g=e[r+2],m=e[h]-c,v=e[h+1]-d,_=e[h+2]-u,y=p-c,S=f-d,x=g-u,b=n*(v*x-_*S)+s*(_*y-m*x)+a*(m*S-v*y);o[l+1]=b<0?-1:b>0?1:0}}const h=new o(Int8Array);new o(Uint32Array);const c=new o(Uint32Array);function d(e,i,r,n){const s=performance.now();let a=e.__deduplication;a||(a=e.__deduplication=t.deduplicateVerticesExactMatch(e.vertexPositionArray,e.compressedVertices?2:3));const o=performance.now();e.__segmentEdges||(e.__segmentEdges=new Map);let d=e.__segmentEdges.get(r);if(!d){const n=t.computeAdjacencyTriangleToTriangle({geom:e,index_ranges:i,deduplication:a,bijective:!1,result:e.__adjTri2Tri});d={boundary:t.extractBoundaryEdges(n.boundary,e.vertexIndexArray),inner:function({geom:e,adjTri2Tri:t,index_ranges:i=null}){const r=e.vertexIndexArray,n=e.vertexPositionArray;function s(e){const t=3*r[e+0],i=3*r[e+1],s=3*r[e+2],a=n[t],o=n[t+1],l=n[t+2],h=n[i],c=n[i+1],d=n[i+2],u=n[s]-a,p=n[s+1]-o,f=n[s+2]-l,g=h-a,m=c-o,v=d-l;return[p*v-f*m,f*g-u*v,u*m-p*g]}let a=[];function o(e,i,r){const n=t[i+r];n&&(function(e,t){const i=e[1]*t[2]-e[2]*t[1],r=e[2]*t[0]-e[0]*t[2],n=e[0]*t[1]-e[1]*t[0];return 0===i&&0===r&&0===n}(e,s(n-1>>>2))||a.push(4*i+r))}for(let e=0;e<i.length;e++){const t=i[e][0],r=i[e][1];for(let e=t;e<r;e+=3){const t=s(e);o(t,e,0),o(t,e,1),o(t,e,2)}}return new Uint32Array(a)}({geom:e,adjTri2Tri:n.adjacency,index_ranges:i})},e.__adjTri2Tri=n.adjacency,e.__segmentEdges.set(r,d)}const u=e.__adjTri2Tri,p=performance.now(),f=function({geom:e,view_direction:t,index_ranges:i}){const r=e.vertexIndexArray,n=e.vertexPositionArray,s=h.get(e.vertexIndexArray.length);for(let e=0;e<i.length;e++)l(n,r,i[e][0],i[e][1],t.x,t.y,t.z,s);return s}({geom:e,view_direction:n,index_ranges:i}),g=performance.now(),m=function({indices:e,adjTri2Tri:t,grouped_edges:i,tri_visibility:r}){let n=c.get(),s=0;function a(t){s+1>=n.length&&(n=c.realloc());const i=t>>>2,r=t%4;n[s++]=e[i+r],n[s++]=e[i+(r+1)%3]}const o=i.boundary,l=o.length;if(l>0)for(let e=0;e<l;e++)s>=n.length&&(n=c.realloc()),n[s++]=o[e];const h=i.inner,d=h.length;for(let e=0;e<d;e++){const i=h[e],n=i>>>2,s=t[n+i%4],o=s-1>>>2;s&&r[n+1]*r[o+1]<=0&&a(i)}return n.slice(0,s)}({indices:e.vertexIndexArray,adjTri2Tri:u,grouped_edges:d,index_ranges:i,tri_visibility:f}),v=performance.now();return window.time_outlines.dedup+=o-s,window.time_outlines.adj+=p-o,window.time_outlines.visibility+=g-p,window.time_outlines.outlines+=v-g,m}function u(e,t,i=!1){let n=e.__outline_segments;return n||(n=e.__outline_segments=function(e,t,i=!1){let n=new Map;function s(e,t,i,r){const s=n.get(e),a=s.get(t);a?a.push([i,i+r]):s.set(t,[[i,i+r]])}function a(e){n.get(e)||n.set(e,new Map)}if(e.layer)for(let i=0;i<e.layer.layers.length;i++){const n=e.layer.layers[i].drawableGroup,o=e.layer.layers[i].drawableInterval;o.skip(e,t)||(a(n.geometry),n._geomType===r.GeomTypeEnum.FACE&&s(n.geometry,0,o.start,o.count))}else{const t=e.geometry.length;for(let i=0;i<t;i++){const t=e.geometry[i];a(t);for(let e=0;e<t.drawingGroups.length;e++){const i=t.drawingGroups[e];if(i._geomType!==r.GeomTypeEnum.FACE)continue;const n=i.getPrimitivesCount();for(let e=0;e<n;e++){const r=i.getPrimitiveRep(e);s(t,r?r.cgmId:0,i.getPrimitiveStart(e),i.getPrimitiveCount(e))}0===n&&s(t,0,i.start,i.count)}}}const o=[];return n.forEach((e,t)=>{const r=[];e.forEach((e,t)=>r.push({ranges:function(e){if(e.length<2)return e;e.sort((e,t)=>e[0]-t[0]);let t=0;for(let i=1;i<e.length;i++){const r=e[t],n=e[i];n[0]>r[1]?e[++t]=n:n[1]>r[1]&&(r[1]=n[1])}return e.length=t+1,e}(e),id:t})),(i||r.length>0)&&o.push({geom:t,components:r})}),o.sort((e,t)=>e.geom.id-t.geom.id),o}(e,t,i)),n}function p({geom:e,new_indices:t=null,gl:i}){if(t){e.indexBufferGPU&&e.indexBufferGPU.numIndices<t.length?(e.indexBufferGPU.deallocate(i),e.indexBufferGPU=null,e.revision++):(e.markIndexStale(0,t.length),e.vertexBufferGPU&&(e.vertexBufferGPU.needsUpdate=!0)),e.vertexIndexArray=t;const r=e.drawingGroups[0];r.count=r._primitives[0].count=e.vertexIndexArray.length,e.wideLinesLinker&&e.wideLinesLinker.linkedGeometry.dispose()}return e}function f({width:e,color:t="#000000",show_hidden:i=!1,polite_color:n="#aaaaaa"}){const o=new r.Color(t),l=new r.Color(n),h=i?{ComputeAlbedo:function(e,t){const i=e.variableHandler,r=e.functionHandler;return`                 \n                        ${(e=>i.bool(e))("occluded")}  = ${r.cF("correctZFighting",null,[])};\n                        ${(e=>i.vec3(e))("color")}  = ${e.vGetAlbedo()};\n                        if (occluded) {\n                            color = ${(t=>e.getUniform(t))("occludedColor")};\n                            ${e.vSetFragDepth("0.001")};\n                        } else {        \n                            ${e.vSetFragDepth("0.0")};\n                        }\n                        return color;\n                    `}}:{ComputeDiscard:function(e,t){return`\n                        return ${e.functionHandler.cF("correctZFighting",null,[])};\n                    `}};let c=new r.LineBasicMaterial({color:o,lineWidth:e,depthTest:i,force:!0});return c._activatePDSFXMigrated(),c._PDSFXData._uniqueID="CPUOutlinesPDSFX",i&&(c._PDSFXData._uniqueID="hidden"+c._PDSFXData._uniqueID),c.setPDSFXGlobalShaderCode(null,function(e){const t=e.variableHandler,i=e.functionHandler,r=t=>e.getTextureUniform(t),n=t=>e.getUniform(t),o=t=>e.getVarying(t),l=e=>t.float(e),h=e=>t.vec2(e),c=e=>t.vec3(e),d=e=>t.vec4(e);let u;u=e.pdsfxDefines.renderToFloatTexture?`\n                ${i.dF("getNormalDepth","v4",[i.prmV2("coord")])}{\n\t\t\t\t\t${d("res")} = ${i.sample2DTexture(r("depthBuffer"),"coord")};\n\t\t\t\t\t${c("normal")}  = normalize(2.0 * res.xyz - 1.0);\n\t\t\t\t\t${l("depth")}  = res.w;\n\t\t\t\t\tif (depth < 0.01) {\n                        depth = 1.0;\n                    }\n\t\t\t\t\treturn ${d()}(normal,depth);\n\t\t\t\t}\n\n                ${i.dF("getPolygonOffset","f",[i.prmV2("coord"),i.prmV3("vN"),i.prmF("depth")])} {\n                    ${(e=>t.mat4(e))("P")} = ${e.vGetProjectionMatrix()};\n                    ${(e=>t.bool(e))("isPersp")}  = P[2][3] == -1.0;\n\n                    ${l("slopeFactor")} = 0.1;\n                    if (isPersp) {\n                        slopeFactor = 1.0;\n                    }\n\n                    ${h("sr")}  = 2.0 / ${n("depthMapSize")};\n                    ${h("vC")}  = (${e.vGetFragCoord()}.xy - 0.5) / ${n("depthMapSize")};\n                    vC = 2.0*vC - 1.0;\n\n                    ${l("K")}  = dot(${c()}(P[1][1] * (vC.x + P[2][0]), P[0][0] * (vC.y + P[2][1]), -P[0][0] * P[1][1]), vN);\n                    ${h("offset")}  = ${h()}(P[1][1] * vN.x*sr.x, P[0][0] * vN.y*sr.y);\n\n                    ${l("factor")}  = (-depth - 0.5 * (P[2][2] - 1.0)) / K;\n                    ${l("dFdxOfZ")}  = abs(offset.x * factor);\n                    ${l("dFdyOfZ")}  = abs(offset.y * factor);\n\n                    ${l("slope")}  = max(dFdxOfZ, dFdyOfZ);\n                    slope = min(max(slope, 1e-6), 1e-3);\n\n                    return (slope * slopeFactor) + (DEPTH_PRECISION * 1.5);\n                }\n\n\t\t\t\t${i.dF("getDepth","f",[i.prmV2("coord")])} {\n                    ${d("nDepth")}  = ${i.cF("getNormalDepth","v4",[i.prmV2("coord")])};\n                    ${l("offset")}  =  ${i.cF("getPolygonOffset","f",[i.prmV2("coord"),i.prmV3("nDepth.xyz"),i.prmF("nDepth.w")])};\n\n                    return nDepth.w + offset;\n                }\n                `:`      \n                    ${i.dF("getDepth","f",[i.prmV2("coord")])} {\n                        ${d("rgba_depth")}  = ${i.sample2DTexture(r("depthBuffer"),"coord")};\n                        ${l("depth")}  = ${s("unpackRGBA","f",[i.prmV4("rgba_depth")])};\n                        if (depth > 1e-6) {\n                            return depth + DEPTH_PRECISION;\n                        }\n                        return 1.0;\n\n                    }\n                `;let p=a;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)0===e&&e===t||(p=`\n                        ${p}\n                        coordtoUse = coord + ${h()}(${l()}(${e}), ${l()}(${t})) * ${h()}(dx, dy);\n                        num_closer += ${i.cF("depthSampleTest","f",[i.prmV2("coordtoUse"),i.prmF("delta"),i.prmF("depth")])};\n                    `);return`\n                ${u}\n                ${i.dF("depthSampleTest","f",[i.prmV2("coord"),i.prmF("delta"),i.prmF("depth")])}{\n                    ${l("fDepth")}  = ${i.cF("getDepth","f",[i.prmV2("coord")])};\n                    if (fDepth < depth) {\n                        return delta;\n                    }\n                    return 0.0;\n                }\n\n                ${i.dF("correctZFighting","b",[])}{\n                    ${h("coord")}   = 0.5 + 0.5 * ${o("cP")}.xy / ${o("cP")}.w;\n                    ${l("depth")}  = 0.5 + 0.5 * ${o("cP")}.z / ${o("cP")}.w - 0.00002;\n\n                    ${h("coordtoUse")} = coord;\n                    if(depth <= ${i.cF("getDepth","f",[i.prmV2("coordtoUse")])}){\n                        return false;\n                    }\n                    ${l("delta")}  = 1.0/8.0;\n                    ${l("dx")}  = 0.5/${n("depthMapSize")}.x;\n                    ${l("dy")}  = 0.5/${n("depthMapSize")}.y;\n\n                    ${l("num_closer")}  = 0.0;\n                    ${p}\n                    // if at this point enough tests failed, discard\n                    return num_closer > 0.8;\n                }\n            `}),c.setPDSFXOverridableFunctions({ProcessClipSpacePosition:function(e,t){const i=e.variableHandler,r=e.pdsfxDefines,n=t=>e.getVarying(t),s=i.dereference()+t[0];return`\n                    ${r.wideLine?`\n                        ${n("cP")} =  ${e.vGetProjectionMatrix()} * ${e.vGetWorldViewMatrix()} * ${(e=>i.vec4(e))()}(${e.vGetAttribPosition()}, 1.0);\n                        `:`\n                        ${n("cP")} = ${s};\n                        `}\n                `}},h),c.setPDSFXUniforms({depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new r.Vector2(.01,.01)},occludedColor:{type:"v3",value:new r.Vector3(l.r,l.g,l.b)}}),c.setPDSFXVaryings({cP:{type:"v4"}}),c._refreshPDSFXUniforms_private=function(e,t){e.requestRealDepthBuffer(),e.dBuffer&&(c.updatePDSFXUniform("depthBuffer",e.dBuffer),c.updatePDSFXUniform("depthMapSize",new r.Vector2(e.dBuffer.width,e.dBuffer.height)))},c}window.time_outlines={dedup:0,adj:0,visibility:0,outlines:0,total:0,old_setup:0,old_add_edges:0,old_sort_edges:0,old_process_edges:0,old_total:0,print_cpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["dedup".padStart(e),"adj".padStart(e),"visibility".padStart(e),"outlines".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.dedup),t(this.adj),t(this.visibility),t(this.outlines),t(this.total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (CPU):\n${i}\n${r}\n\n`)},print_gpu:function(e=10){const t=t=>t.toFixed(1).padStart(e),i=["setup".padStart(e),"add".padStart(e),"sort".padStart(e),"process".padStart(e),"total".padStart(e)].join(" / "),r=[t(this.old_setup),t(this.old_add_edges),t(this.old_sort_edges),t(this.old_process_edges),t(this.old_total)].join("   ").replaceAll(".",",");console.log(`Outline statistics (GPU):\n${i}\n${r}\n\n`)},print:function(e=10){this.print_cpu(e),this.print_gpu(e)}};let g=null,m=null;function v({width:e,showHiddenOutlines:t}){t&&!m?m=f({width:e,show_hidden:!0}):t||g||(g=f({width:e,show_hidden:!1}));const i=t?m:g;return i.setLineWidth(e),i}var _=function(e){for(var t=1;t<e;)t*=2;return t},y=[];class S{constructor(e){this._renderable=e,this.indexArray=null,this.firstIndicesArray=null,this.lastIndexArray=null,this._Id=0,this._edgeId=0,this.width=1}createNewGeometry(e){const t=THREEDS.Core,i=this.createMaterial(),r=this.createDg(i),n=new t.BufferGeometryDS;return n.drawingGroups=[],r.geometry=n,n.drawingGroups.push(r),n.vertexPositionArray=this.firstIndicesArray,n.vertexNormalArray=this.lastIndexArray,n.vertexIndexArray=this.indexArray,n.boundingSphere=this._renderable.boundingSphere,n.boundingBox=this._renderable.boundingBox,n}}class x extends S{constructor(e){super(e),this.width=1}initArrays(){this._Id=0,this._edgeId=0,this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.firstIndicesArray,s=this.lastIndexArray,a=this._edgeId;n[6*a]=e,n[6*a+1]=t,n[6*a+2]=i,n[6*a+3]=t,n[6*a+4]=e,n[6*a+5]=r,s[6*a]=r,s[6*a+1]=0,s[6*a+2]=0,s[6*a+3]=i,s[6*a+4]=0,s[6*a+5]=0,this._edgeId++}createMaterial(){return w.TexturesManager.createSimpleMaterial()}createDg(t){const i=this.firstIndicesArray.length/3,r=THREEDS.Core,n=new e.DrawingGroup(t,t,1,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE);return n.nonIndexed=!0,n}}class b extends S{constructor(e,t){super(e),this.width=t,this.curr_Id=0}initArrays(){this._Id=0,this._edgeId=0,this.curr_Id=0,this.indexArray=[],this.firstIndicesArray=[],this.lastIndexArray=[]}createFinalArrays(){this.indexArray=new Uint32Array(this.indexArray),this.firstIndicesArray=new Float32Array(this.firstIndicesArray),this.lastIndexArray=new Float32Array(this.lastIndexArray)}addFullEdgeIndices(e,t,i,r){const n=this.indexArray,s=this.firstIndicesArray,a=this.lastIndexArray;n[this._Id++]=this.curr_Id,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+2,n[this._Id++]=this.curr_Id+1,n[this._Id++]=this.curr_Id+3,this.curr_Id+=4;const o=this._edgeId;s[12*o]=e,s[12*o+1]=t,s[12*o+2]=i,s[12*o+3]=t,s[12*o+4]=e,s[12*o+5]=r,s[12*o+6]=e,s[12*o+7]=t,s[12*o+8]=i,s[12*o+9]=t,s[12*o+10]=e,s[12*o+11]=r,a[12*o]=r,a[12*o+1]=-1,a[12*o+2]=0,a[12*o+3]=i,a[12*o+4]=2,a[12*o+5]=0,a[12*o+6]=r,a[12*o+7]=1,a[12*o+8]=0,a[12*o+9]=i,a[12*o+10]=-2,a[12*o+11]=0,this._edgeId++}createMaterial(){return w.TexturesManager.createWideMaterial(.5*this.width)}createDg(t){const i=this.indexArray.length,r=THREEDS.Core;return new e.DrawingGroup(t,t,4,0,i,void 0,void 0,r.GeomTypeEnum._OUTLINE)}}class w{constructor(e,t,i,r){this._renderable=e,this._oGeometry=1===t?new x(e):new b(e,t),w.TexturesManager.sortCount!==i&&(w.TexturesManager.clean(r),w.TexturesManager.sortCount=i)}computeOutlineGeometry(e){var t=this,i=0,s=0,a=0,o=this._renderable,l=[],h=[],c=[];if(o.layer){for(var d={},u=0;u<o.layer.layers.length;u++){var p=o.layer.layers[u].drawableGroup;if(!(L=o.layer.layers[u].drawableInterval).skip(o,e)&&p._geomType===r.GeomTypeEnum.FACE){var f=d[p.geometry.id];f?f.intervals.push(L):d[p.geometry.id]={geometry:p.geometry,intervals:[L]}}}var g=[];for(var u in d)g.push(d[u]);g.sort(function(e,t){return e.geometry.id-t.geometry.id});for(u=0;u<g.length;u++)l[u]=g[u].geometry,h[u]=g[u].intervals}else l=o.geometry;var m=function(e,t,i,r){var n=l[e].vertexPositionArray,s=l[t].vertexPositionArray,a=0;return n[3*i]<s[3*r]?a=-1:n[3*i]>s[3*r]?a=1:n[3*i+1]<s[3*r+1]?a=-1:n[3*i+1]>s[3*r+1]?a=1:n[3*i+2]<s[3*r+2]?a=-1:n[3*i+2]>s[3*r+2]&&(a=1),a},v=function(e,t,i,r){if(m(r,r,e,t)>0){var n=e;e=t,t=n}return{i1:e,i2:t,i3:i,geomId:r}},_=function(e,t){var i=l[e.geomId].vertexPositionArray,r=l[t.geomId].vertexPositionArray;return i[3*e.i1]<r[3*t.i1]?-1:i[3*e.i1]>r[3*t.i1]?1:i[3*e.i1+1]<r[3*t.i1+1]?-1:i[3*e.i1+1]>r[3*t.i1+1]?1:i[3*e.i1+2]<r[3*t.i1+2]?-1:i[3*e.i1+2]>r[3*t.i1+2]?1:i[3*e.i2]<r[3*t.i2]?-1:i[3*e.i2]>r[3*t.i2]?1:i[3*e.i2+1]<r[3*t.i2+1]?-1:i[3*e.i2+1]>r[3*t.i2+1]?1:i[3*e.i2+2]<r[3*t.i2+2]?-1:i[3*e.i2+2]>r[3*t.i2+2]?1:e.i1===t.i1?e.i2===t.i2?0:t.i2-e.i2:t.i1-e.i1},S=y,x=0,b=function(e,t,r){for(var n=t.start;n<t.start+t.count;n+=3)if(i=e[n],s=e[n+1],a=e[n+2],i!==s&&s!==a&&i!==a){var o=v(i,s,a,r);S[x++]=o;var l=v(s,a,i,r);S[x++]=l;var h=v(a,i,s,r);S[x++]=h}},M=function(e){for(var i=0,r=0,n=0,s=0,a=0,o=null,l=null;i<x-1;)o=S[i],l=S[i+1],s=o.geomId,a=l.geomId,r=e?e[s]/3:0,0===m(s,a,o.i1,l.i1)&&0===m(s,a,o.i2,l.i2)?(n=e?e[a]/3:0,t._oGeometry.addFullEdgeIndices(r+o.i1,r+o.i2,r+o.i3,n+l.i3),i+=2):(t._oGeometry.addFullEdgeIndices(r+o.i1,r+o.i2,r+o.i3,r+o.i3),i++);x&&i===x-1&&(s=(o=S[i]).geomId,r=e?e[s]/3:0,t._oGeometry.addFullEdgeIndices(r+o.i1,r+o.i2,r+o.i3,r+o.i3))};if(n)for(var C=0;C<l.length;C++){this._oGeometry.initArrays(),x=0;var P=(R=l[C]).vertexIndexArray;if(o.layer){var E=h[C];for(u=0;u<E.length;u++){b(P,L=E[u],C)}}else for(var T=0;T<R.drawingGroups.length;T++){(p=R.drawingGroups[T])._geomType===r.GeomTypeEnum.FACE&&b(P,p,C)}S.length=x,x&&S.sort(_),M(),this._oGeometry.createFinalArrays(),c.push(this._oGeometry.createNewGeometry(e))}else{var A=[],D=0;for(u=0;u<l.length;u++)A[u]=D,l[u].vertexIndexArray.length,D+=l[u].vertexPositionArray.length;this._oGeometry.initArrays();var I=l.length;for(u=0;u<I;u++){var R;P=(R=l[u]).vertexIndexArray;if(o.layer){E=h[u];for(var O=0;O<E.length;O++){var L;b(P,L=E[O],u)}}else for(T=0;T<R.drawingGroups.length;T++){(p=R.drawingGroups[T])._geomType===r.GeomTypeEnum.FACE&&b(P,p,u)}}if(0===x)return null;S.length=x,S.sort(_),M(A),this._oGeometry.createFinalArrays(),c.push(this._oGeometry.createNewGeometry(e))}return w.TexturesManager.addRenderableGeometries(this._renderable,l,c),c}}w.halfEdgesArray=[],w.convertOutlineGeometry=function(t,i,r,n){w.ConversionMaterialsManager.sortCount!==n&&(w.ConversionMaterialsManager.clean(),w.ConversionMaterialsManager.sortCount=n);var s=THREEDS.Core,a=null,o=null,l=null,h=0,c=0,d=t.vertexPositionArray,u=t.vertexNormalArray,p=t.vertexPositionArray.length,f=0,g=t.drawingGroups[0].material,m=0,v=0,_=0,y=0,S=0,x=0,b=0,M=0,C=null,P=0;if(i<r){P=4,m=(f=p/3)/2,h=2*p,c=3*f,a=new Float32Array(h),o=new Float32Array(h),l=new Uint32Array(c);for(var E=0;E<m;E++)l[b++]=M,l[b++]=M+1,l[b++]=M+2,l[b++]=M+2,l[b++]=M+1,l[b++]=M+3,M+=4,v=d[6*E],_=d[6*E+1],y=d[6*E+2],S=u[6*E],x=u[6*E+2],a[12*E]=v,a[12*E+1]=_,a[12*E+2]=y,a[12*E+3]=_,a[12*E+4]=v,a[12*E+5]=S,a[12*E+6]=v,a[12*E+7]=_,a[12*E+8]=y,a[12*E+9]=_,a[12*E+10]=v,a[12*E+11]=S,o[12*E]=S,o[12*E+1]=-1,o[12*E+2]=x,o[12*E+3]=y,o[12*E+4]=2,o[12*E+5]=x,o[12*E+6]=S,o[12*E+7]=1,o[12*E+8]=x,o[12*E+9]=y,o[12*E+10]=-2,o[12*E+11]=x;C=w.ConversionMaterialsManager.createWideMaterialFromOther(g,.5*r)}else{P=1,m=(f=t.vertexIndexArray.length)/6,h=p/2,c=f/3,a=new Float32Array(h),o=new Float32Array(h);for(E=0;E<m;E++)v=d[12*E],_=d[12*E+1],y=d[12*E+2],S=u[12*E],x=u[12*E+2],a[6*E]=v,a[6*E+1]=_,a[6*E+2]=y,a[6*E+3]=_,a[6*E+4]=v,a[6*E+5]=S,o[6*E]=S,o[6*E+1]=0,o[6*E+2]=x,o[6*E+3]=y,o[6*E+4]=0,o[6*E+5]=x;C=w.ConversionMaterialsManager.createSimpleMaterialFromWide(g)}s=THREEDS.Core;var T=new e.DrawingGroup(C,C,P,0,c,void 0,void 0,s.GeomTypeEnum._OUTLINE);T.nonIndexed=1===P;var A=new s.BufferGeometryDS;return A.drawingGroups=[],T.geometry=A,A.drawingGroups.push(T),A.vertexPositionArray=a,A.vertexNormalArray=o,A.vertexIndexArray=l,A.boundingSphere=t.boundingSphere,A.boundingBox=t.boundingBox,t.dispose(),t=null,A},w.convertWideWidth=function(e,t,i){w.ConversionMaterialsManager.sortCount!==i&&(w.ConversionMaterialsManager.clean(),w.ConversionMaterialsManager.sortCount=i);for(var r=e[0].drawingGroups[0].material,n=w.ConversionMaterialsManager.createWideMaterialFromOther(r,.5*t),s=0;s<e.length;s++)e[s].drawingGroups[0].material=n},w.TexturesManager={sortCount:-1,nbVertices:0,newSimpleMaterial:function(e,t){return new THREEDS.Core._OutlineMaterial(e,t)},newWideMaterial:function(e,t,i){return new THREEDS.Core._WideOutlineMaterial(e,t,i)},addRenderableGeometries:function(e,t,i){this.isClean=!1;let r=0;for(let s=0;s<t.length;s++){const a=t[s];this.geometriesAssociated.push({renderable:e,geom:a,renderableOffset:this.nbVertices,outlineGeom:n?i[s]:i[0],finalizeOutlines:n||!s}),n?this.nbVertices+=a.vertexPositionArray.length/3:r+=a.vertexPositionArray.length/3}n||(this.nbVertices+=r),this._updateTextureDefines()},_updateTextureDefines:function(){var e=this.nbVertices;this.textureDefines.NB_OUTLINE_MAPS=Math.ceil(e/this.maxTextureTotalSize);var t=e-Math.floor(e/this.maxTextureTotalSize)*this.maxTextureTotalSize,i=Math.sqrt(t),r=_(i),n=_(t/r);this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=r,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=n},geometriesAssociated:[],textureDefines:{NB_OUTLINE_MAPS:0,MAX_OUTLINE_MAP_SIZE:-1,LAST_OUTLINE_MAP_SIZE_X:0,LAST_OUTLINE_MAP_SIZE_Y:0},maxTextureSize:-1,maxTextureTotalSize:-1,isClean:!0,simpleOutlineMaterial:null,wideOutlineMaterials:null,createSimpleMaterial:function(){if(null!==this.simpleOutlineMaterial)return this.simpleOutlineMaterial;var e=this.newSimpleMaterial(null,null);return this.simpleOutlineMaterial=e,e},createWideMaterial:function(e){if(null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={}),this.wideOutlineMaterials[e])return this.wideOutlineMaterials[e];var t=this.newWideMaterial(null,null,e);return this.wideOutlineMaterials[e]=t,t},finalize:function(){var e=THREEDS.Core,t=this.textureDefines.NB_OUTLINE_MAPS;if(0!==t){for(var i=this.maxTextureSize,r=this.maxTextureTotalSize,n=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X,s=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y,a=[],o=0;o<t;o++){var l=o===t-1?n*s:r;a.push(new Float32Array(3*l))}var h=0,c=0,d=this.geometriesAssociated,u=d.length,p=null,f=0;for(o=0;o<u;o++){var g=d[o];p=g.geom,f=g.renderableOffset,g.renderable;var m=a[h];if(c+p.vertexPositionArray.length<=3*r)m.set(p.vertexPositionArray,c),c+=p.vertexPositionArray.length;else{for(var v=0;v<3*r-c;v++)m[c+v]=p.vertexPositionArray[v];m=a[++h];var _=p.vertexPositionArray.length-3*r+c;for(v=0;v<_;v++)m[v]=p.vertexPositionArray[3*r-c+v];c=_}if(g.finalizeOutlines)for(var y=g.outlineGeom,S=y.vertexPositionArray,x=y.vertexNormalArray,b=x.length/3,w=0;w<b;w++){var M=S[3*w]+f,C=S[3*w+1]+f,P=S[3*w+2]+f,E=x[3*w]+f,T=Math.floor(M/r),A=Math.floor(C/r),D=Math.floor(P/r),I=Math.floor(E/r);S[3*w]=M-T*r,S[3*w+1]=C-A*r,S[3*w+2]=P-D*r,x[3*w]=E-I*r,x[3*w+2]=16*(16*(16*I+D)+A)+T}}for(var R=[],O=0;O<t-1;O++){(L=new e.DataTexture(a[O],i,i,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,L.magFilter=e.NearestFilter,L.generateMipmaps=!1,L.flipY=!1,L.needsUpdate=!0,R.push(L)}var L;if((L=new e.DataTexture(a[O],n,s,e.RGBFormat,e.FloatType)).minFilter=e.NearestFilter,L.magFilter=e.NearestFilter,L.generateMipmaps=!1,L.flipY=!1,L.needsUpdate=!0,R.push(L),null!==this.simpleOutlineMaterial){this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,this.simpleOutlineMaterial.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),this.simpleOutlineMaterial.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);var V={occludedColor:{type:"v3",value:new e.Vector3(this.simpleOutlineMaterial.occludedColor.r,this.simpleOutlineMaterial.occludedColor.g,this.simpleOutlineMaterial.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:R,length:this.simpleOutlineMaterial.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)}};this.simpleOutlineMaterial.setPDSFXUniforms(V)}if(null!==this.wideOutlineMaterials){var F=null;for(var B in this.wideOutlineMaterials){(F=this.wideOutlineMaterials[B]).defines.NB_OUTLINE_MAPS=this.textureDefines.NB_OUTLINE_MAPS,F.defines.MAX_OUTLINE_MAP_SIZE=this.textureDefines.MAX_OUTLINE_MAP_SIZE.toFixed(1),F.defines.LAST_OUTLINE_MAP_SIZE_X=this.textureDefines.LAST_OUTLINE_MAP_SIZE_X.toFixed(1),F.defines.LAST_OUTLINE_MAP_SIZE_Y=this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y.toFixed(1);V={occludedColor:{type:"v3",value:new e.Vector3(F.occludedColor.r,F.occludedColor.g,F.occludedColor.b)},outlinePositionMaps:{type:"t2v",value:R,length:F.defines.NB_OUTLINE_MAPS},depthBuffer:{type:"t2",value:null},depthMapSize:{type:"v2",value:new e.Vector2(.01,.01)},outlineHalfWidth:{type:"f",value:parseFloat(B)},pixelSize:{type:"v2",value:new e.Vector2}};F.setPDSFXUniforms(V)}}}},clean:function(e){this.isClean=!0,this.simpleOutlineMaterial=null,this.wideOutlineMaterials=null,this.nbVertices=0,this.textureDefines.MAX_OUTLINE_MAP_SIZE<0&&(this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxTextureSize=Math.min(this.maxTextureSize,4096),this.textureDefines.MAX_OUTLINE_MAP_SIZE=this.maxTextureSize,this.maxTextureTotalSize=this.maxTextureSize*this.maxTextureSize),this.textureDefines.NB_OUTLINE_MAPS=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_X=0,this.textureDefines.LAST_OUTLINE_MAP_SIZE_Y=0,this.geometriesAssociated.length=0}},w.ConversionMaterialsManager={sortCount:-1,simpleOutlineMaterials:null,wideOutlineMaterials:null,createSimpleMaterialFromWide:function(e){null===this.simpleOutlineMaterials&&(this.simpleOutlineMaterials={});var t=e.getPDSFXUniform("outlinePositionMaps").value;if(this.simpleOutlineMaterials[t[0].id])return this.simpleOutlineMaterials[t[0].id];var i=e.defines,r=w.TexturesManager.newSimpleMaterial(i,t);return this.simpleOutlineMaterials[t[0].id]=r,r},createWideMaterialFromOther:function(e,t){null===this.wideOutlineMaterials&&(this.wideOutlineMaterials={});var i=e.getPDSFXUniform("outlinePositionMaps").value;if(this.wideOutlineMaterials[t]||(this.wideOutlineMaterials[t]={}),this.wideOutlineMaterials[t][i[0].id])return this.wideOutlineMaterials[t][i[0].id];var r=e.defines,n=w.TexturesManager.newWideMaterial(r,i,t);return this.wideOutlineMaterials[t][i[0].id]=n,n},clean:function(){this.simpleOutlineMaterials=null,this.wideOutlineMaterials=null}};const M={fetchFromOccurrences({object:e,width:t,viewDirection:i}){let r=e.outlinesGeometry;if(r&&r.geometry||e.layer)return r;const n=e._occurrence.node._occurrences;for(let s=0;s<n.length;s++){const a=n[s].renderable,o=a.outlinesGeometry;if(a!==e&&o&&o.geometry&&!a.layer&&(t===o.outlineWidth&&!i==!o.viewDirection&&(!i||i.equals(o.viewDirection)))){r&&r.dispose(),e.outlinesGeometry=r=o,r.refs++;break}}return r},implementation(e){const t=e.outlinesGeometry;if(t)return t.viewDirection?"cpu":"gpu"},isOutdated({object:e,viewDirection:t}){let i=e.outlinesGeometry;return!!i&&(!i.upToDate||e.layer&&!e.layer.upToDate||i.viewDirection&&!t)},updateMaterialGPU({object:e,width:t,showHiddenOutlines:i,_sortCount:r}){const n=e.outlinesGeometry;let s=n&&n.geometry;if(!s)return;for(var a=0;a<s.length;a++)s[a].drawingGroups[0].material.setShowHiddenOutlines(i);const o=n.outlineWidth;o!==t&&(n.outlineWidth=t,1===o||1===t?(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)):w.convertWideWidth(n.geometry,t,r))},updateMaterialCPU({object:e,width:t,showHiddenOutlines:i}){const r=e.outlinesGeometry;let n=r&&r.geometry;if(!n)return;if(!(r.outlineWidth!==t||r.showHiddenOutlines!==i))return;r.outlineWidth=t,r.showHiddenOutlines=i;const s=v({width:t,showHiddenOutlines:i});for(let e=0;e<n.length;e++)n[e].drawingGroups[0].material=s},create({object:t,viewDirection:i,width:n,_sortCount:s,_gl:a,showHiddenOutlines:o,visibleSpace:l}){let h=null;if(i){const i=v({width:n,showHiddenOutlines:o});h=u(t,l).map(n=>(function({renderable:t,material:i,vertexSourceGeometry:n=null,indices:s=null}){const a=new r.BufferGeometryDS;a.vertexIndexArray=s,n&&(a.vertexPositionArray=n.vertexPositionArray,a.vertexBufferGPU=n.vertexBufferGPU,a.vertexOffsetGPU=n.vertexOffsetGPU),a.vertexBufferGPU&&a.vertexBufferGPU.nbGeometries++,a.boundingSphere=t.boundingSphere,a.boundingBox=t.boundingBox;const o=s?s.length:0,l={start:0,count:o},h=new e.DrawingGroup(i,i,1,0,o,[l],void 0,r.GeomTypeEnum._OUTLINE);return a.drawingGroups=[h],h.geometry=a,a})({renderable:t,material:i,vertexSourceGeometry:n.geom})),w.TexturesManager.sortCount!==s&&(w.TexturesManager.clean(a),w.TexturesManager.sortCount=s)}else{if(h=new w(t,n,s,a).computeOutlineGeometry(l))for(var c=0;c<h.length;c++)h[c].noMeshInRAM=!0,h[c].drawingGroups[0].material.setShowHiddenOutlines(o)}return h?(t.outlinesGeometry={geometry:h,outlineWidth:n,showHiddenOutlines:o,viewDirection:i,upToDate:!0,refs:1,dispose(){this.refs--,0===this.refs&&(Array.isArray(this.geometry)?this.geometry.forEach(e=>e.dispose()):this.geometry&&this.geometry.dispose()),this.geometry=null}},h):null},prepare({object:e,width:t,viewDirection:i,_sortCount:n,_gl:s,showHiddenOutlines:a,visibleSpace:o}){if(r=THREEDS.Core,e._isDecal())return{outlineBG:[],created:!1,invalidateGSSO:!1};switch(M.fetchFromOccurrences({object:e,width:t,viewDirection:i}),M.isOutdated({object:e,viewDirection:i})&&(e.clearOutlines(),e.layer&&(e.layer.upToDate=!0)),M.implementation(e)){case"cpu":M.updateMaterialCPU({object:e,width:t,showHiddenOutlines:a});break;case"gpu":M.updateMaterialGPU({object:e,width:t,showHiddenOutlines:a,_sortCount:n})}let l=e.outlinesGeometry&&e.outlinesGeometry.geometry,h=!1;l||(h=!!(l=M.create({object:e,viewDirection:i,width:t,_sortCount:n,_gl:s,showHiddenOutlines:a,visibleSpace:o})));const c=l&&!e.outlinesGeometry.viewDirection;return l?Array.isArray(l)||(l=[l]):l=[],{outlineBG:l,created:h,invalidateGSSO:c}},refresh({object:e,viewDirection:i,width:n,gl:s,visibleSpace:a}){r=THREEDS.Core;let o=e.outlinesGeometry;if(!o)return;let l=o.geometry;if(l)if(!i==!o.viewDirection){if(i){if(0===l.length)return;M.updateMaterialCPU({object:e,width:n,showHiddenOutlines:o.showHiddenOutlines});let r=!1;for(let e=0;e<l.length;e++)l[e].vertexIndexArray||(r=!0);if(!r&&o.viewDirection.equals(i))return;!function({renderable:e,view_direction:i,geometry:r=null,gl:n,visibleSpace:s}){const a=performance.now();let o=u(e,s);r||(r=Array(o.length));for(let e=0;e<o.length;e++){const s=o[e],a=s.geom;let l=[];for(let e=0;e<s.components.length;e++){const t=s.components[e];l.push(d(a,t.ranges,t.id,i))}l=t.mergeIndexBuffers(l),p({geom:r[e],new_indices:l,gl:n})}const l=performance.now();window.time_outlines.total+=l-a}({renderable:e,view_direction:i,geometry:l,gl:s,visibleSpace:a}),o.viewDirection=i}else if(o.outlineWidth!==n)return void e._flagAsGSSOInvalidated()}else e._flagAsGSSOInvalidated()}};return w.prepareOutlines=function(e){return M.prepare(e)},w.refreshOutlines=function(e){return M.refresh(e)},w}),define("DS/Visualization/Shapes",["DS/Mesh/ThreeJS_Base","DS/Visualization/Curves"],function(e,t){"use strict";let i={};var r,n,s;return i.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase();this.faces[t]=this.faces[t]||{},this.faces[t][e.cssFontWeight]=this.faces[t][e.cssFontWeight]||{},this.faces[t][e.cssFontWeight][e.cssFontStyle]=e;this.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var i,r=this.getFace(),n=this.size/r.resolution,s=0,a=String(e).split(""),o=a.length,l=[];for(i=0;i<o;i++){var h=new t.Path,c=this.extractGlyphPoints(a[i],r,n,s,h);s+=c.offset,l.push(c.path)}return{paths:l,offset:s/2}},extractGlyphPoints:function(e,t,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M=[],C=t.glyphs[e]||t.glyphs["?"];if(C){if(C.o)for(c=(h=C._cachedOutline||(C._cachedOutline=C.o.split(" "))).length,d=r,u=r,a=0;a<c;)switch(h[a++]){case"m":p=h[a++]*d+n,f=h[a++]*u,s.moveTo(p,f);break;case"l":p=h[a++]*d+n,f=h[a++]*u,s.lineTo(p,f);break;case"q":if(g=h[a++]*d+n,m=h[a++]*u,y=h[a++]*d+n,S=h[a++]*u,s.quadraticCurveTo(y,S,g,m),w=M[M.length-1])for(v=w.x,_=w.y,o=1,l=this.divisions;o<=l;o++){var P=o/l;i.Shape.Utils.b2(P,v,y,g),i.Shape.Utils.b2(P,_,S,m)}break;case"b":if(g=h[a++]*d+n,m=h[a++]*u,y=h[a++]*d+n,S=h[a++]*-u,x=h[a++]*d+n,b=h[a++]*-u,s.bezierCurveTo(g,m,y,S,x,b),w=M[M.length-1])for(v=w.x,_=w.y,o=1,l=this.divisions;o<=l;o++)P=o/l,i.Shape.Utils.b3(P,v,y,x,g),i.Shape.Utils.b3(P,_,S,b,m)}return{offset:C.ha*r,path:s}}}},i.FontUtils.generateShapes=function(e,t){var r=void 0!==(t=t||{}).size?t.size:100,n=void 0!==t.curveSegments?t.curveSegments:4,s=void 0!==t.font?t.font:"helvetiker",a=void 0!==t.weight?t.weight:"normal",o=void 0!==t.style?t.style:"normal";i.FontUtils.size=r,i.FontUtils.divisions=n,i.FontUtils.face=s,i.FontUtils.weight=a,i.FontUtils.style=o;for(var l=i.FontUtils.drawText(e).paths,h=[],c=0,d=l.length;c<d;c++)Array.prototype.push.apply(h,l[c].toShapes());return h},r=i.FontUtils,n=function(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},s=function(e,t,i,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_,y,S;if(o=e[s[t]].x,l=e[s[t]].y,h=e[s[i]].x,c=e[s[i]].y,d=e[s[r]].x,1e-10>(h-o)*((u=e[s[r]].y)-l)-(c-l)*(d-o))return!1;for(g=d-h,m=u-c,v=o-d,_=l-u,y=h-o,S=c-l,a=0;a<n;a++)if(a!==t&&a!==i&&a!==r&&(p=e[s[a]].x,g*((f=e[s[a]].y)-c)-m*(p-h)>=0&&v*(f-u)-_*(p-d)>=0&&y*(f-l)-S*(p-o)>=0))return!1;return!0},r.Triangulate=function(e,t){var i=e.length;if(i<3)return null;var r,a,o,l=[],h=[],c=[];if(n(e)>0)for(a=0;a<i;a++)h[a]=a;else for(a=0;a<i;a++)h[a]=i-1-a;var d=i,u=2*d;for(a=d-1;d>2;){if(u--<=0)return console.log("Warning, unable to triangulate polygon!"),t?c:l;if(d<=(r=a)&&(r=0),d<=(a=r+1)&&(a=0),d<=(o=a+1)&&(o=0),s(e,r,a,o,d,h)){var p,f,g,m,v;for(p=h[r],f=h[a],g=h[o],l.push([e[p],e[f],e[g]]),c.push([h[r],h[a],h[o]]),m=a,v=a+1;v<d;m++,v++)h[m]=h[v];u=2*--d}}return t?c:l},r.Triangulate.area=n,i.Shape=function(){t.Path.apply(this,arguments),this.holes=[]},i.Shape.prototype=Object.create(t.Path.prototype),i.Shape.prototype.extrude=function(t){return new e.ExtrudeGeometry(this,t)},i.Shape.prototype.makeGeometry=function(t){return new e.ShapeGeometry(this,t)},i.Shape.prototype.getPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},i.Shape.prototype.getSpacedPointsHoles=function(e){var t,i=this.holes.length,r=[];for(t=0;t<i;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},i.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},i.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},i.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},i.Shape.Utils={removeHoles:function(t,i){var r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y=t.concat(),S=y.concat(),x=[];for(o=0;o<i.length;o++){for(h=i[o],Array.prototype.push.apply(S,h),c=Number.POSITIVE_INFINITY,l=0;l<h.length;l++){p=h[l];var b=[];for(u=0;u<y.length;u++)f=y[u],d=p.distanceToSquared(f),b.push(d),d<c&&(c=d,s=l,a=u)}r=a-1>=0?a-1:y.length-1,n=s-1>=0?s-1:h.length-1;var w=[h[s],y[a],y[r]],M=e.FontUtils.Triangulate.area(w),C=[h[s],h[n],y[a]],P=e.FontUtils.Triangulate.area(C),E=a,T=s;s+=-1,(a+=1)<0&&(a+=y.length),a%=y.length,s<0&&(s+=h.length),s%=h.length,r=a-1>=0?a-1:y.length-1,n=s-1>=0?s-1:h.length-1,w=[h[s],y[a],y[r]];var A=e.FontUtils.Triangulate.area(w);C=[h[s],h[n],y[a]],M+P>A+e.FontUtils.Triangulate.area(C)&&(s=T,(a=E)<0&&(a+=y.length),a%=y.length,s<0&&(s+=h.length),s%=h.length,r=a-1>=0?a-1:y.length-1,n=s-1>=0?s-1:h.length-1),g=y.slice(0,a),m=y.slice(a),v=h.slice(s),_=h.slice(0,s);var D=[h[s],y[a],y[r]],I=[h[s],h[n],y[a]];x.push(D),x.push(I),y=g.concat(v).concat(_).concat(m)}return{shape:y,isolatedPts:x,allpoints:S}},triangulateShape:function(t,r){var n,s,a,o,l,h,c=i.Shape.Utils.removeHoles(t,r),d=c.shape,u=c.allpoints,p=c.isolatedPts,f=e.FontUtils.Triangulate(d,!1),g={};for(n=0,s=u.length;n<s;n++)void 0!==g[l=u[n].x+":"+u[n].y]&&console.log("Duplicate point",l),g[l]=n;for(n=0,s=f.length;n<s;n++)for(o=f[n],a=0;a<3;a++)void 0!==(h=g[l=o[a].x+":"+o[a].y])&&(o[a]=h);for(n=0,s=p.length;n<s;n++)for(o=p[n],a=0;a<3;a++)void 0!==(h=g[l=o[a].x+":"+o[a].y])&&(o[a]=h);return f.concat(p)},isClockWise:function(t){return e.FontUtils.Triangulate.area(t)<0},b2p0:function(e,t){var i=1-e;return i*i*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},b3p0:function(e,t){var i=1-e;return i*i*i*t},b3p1:function(e,t){var i=1-e;return 3*i*i*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,i,r,n){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,n)}},i}),define("DS/Visualization/CullingSystem",["DS/Visualization/WebGLObjectManager","DS/Object3D/Camera"],function(e,t){"use strict";var i=0,r={_INVISIBLE:0,_VISIBLE:1,_FRESH:2},n={_GSSO:0,_REMOVE_AND_GSSO:1,_REMOVE:2,_NOTHING:3,_SKIP:4,_MAYBE_REMOVE_AND_GSSO:5},s=function(e){this.webglObject=e,this.invalidated=!0,this.previousCullingStatus=r._FRESH,this.action=n._NOTHING,this.previousRenderPointsOnly=!1,this.currentRenderPointsOnly=!1,this.object=e.object},a=function(){this.map=new Map};a.prototype.get=function(e,t){var i=null,r=this.map.get(e.id);return r||(r=new Map,this.map.set(e.id,r)),(i=r.get(t))||(i=new l(e),r.set(t,i),e._cullingSystems.push(i)),i},a.prototype.resetCullingStatuses=function(e){this.map.forEach(function(t,i){t.forEach(function(t,i){t._resetCullingStatuses(e)})})},a.prototype.dispose=function(){this.map.clear()};var o=new a,l=function(e){this.id=i++,this.scene=e,this.objectManagers={},this.lastComposerContextsSeen=new Set,this.currComposerContextsSeen=new Set};return l.prototype.isSet=function(e){return!!this.objectManagers[e]},l.prototype.setFromIdString=function(t){this.objectManagers[t]={list:new e,frame:-1};var i=this.objectManagers[t].list,r=this.scene.getWebGLObjectsLinkedList(t);if(r)for(var n=r.first;n>-1;n=r.nexts[n])i.add(new s(r.objects[n]))},l.prototype.getWebGLObjectsLinkedList=function(e){return this.scene.getWebGLObjectsLinkedList(e),this.scene.getWebGLObjectsLinkedList(null),this.objectManagers&&this.objectManagers[e]&&this.objectManagers[e].list?this.objectManagers[e].list.getLinkedList():null},l.prototype.getWebGLObjects=function(e){return this.scene.getWebGLObjectsLinkedList(e),this.scene.getWebGLObjectsLinkedList(null),this.objectManagers&&this.objectManagers[e]&&this.objectManagers[e].list?this.objectManagers[e].list.getObjects():[]},l.prototype._resetCullingStatuses=function(){for(var e in this.objectManagers)this.objectManagers[e].frame=-1;if(this.currComposerContextsSeen.size>0){var t=this;this.lastComposerContextsSeen.clear(),this.currComposerContextsSeen.forEach(function(e){t.lastComposerContextsSeen.add(e)}),this.currComposerContextsSeen.clear()}},{WebGLObjectCullingStatus:s,__CullingSystemFactory:o,VISIBILITY_STATUS:r,INCREMENTAL_ACTIONS:n}}),define("DS/Visualization/RendererGlobals",["DS/Mesh/ThreeJS_Base","DS/RenderEngineUtils/RenderEngineUtils","DS/GPUFormats/GPUFormats","DS/Visualization/ImplicitGeometries","DS/Visualization/ExplicitGeometries","DS/Object3D/Object3D","DS/Object3D/Light","DS/Object3D/Camera","DS/Object3D/Mesh","DS/Object3D/Scene","DS/Visualization/WebGLObjectManager","DS/ShaderBuilders/Commons/DefaultShaders","DS/Visualization/ShaderChunk","DS/ShaderBuilders/Commons/DeferrableShaders","DS/Visualization/UniformsUtils","DS/Visualization/UniformsLib","DS/Visualization/ImageUtils","DS/Visualization/Shapes","DS/Visualization/Curves","DS/Visualization/HighlightData","DS/Visualization/SubsurfaceGenerator"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S){"use strict";String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};var x=new e.Color;Object.assign(e,i);var b={FrontSide:0,BackSide:1,DoubleSide:2};b.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,b.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,b.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,b.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,b.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,b.AllPointsRenderPointMask=b.BoundaryPointRenderPointMask|b.SharpPointRenderPointMask|b.SmoothPointRenderPointMask|b.SurfacicPointRenderPointMask|b.FreePointRenderPointMask,b.AllPointsButSurfacicPointsRenderPointMask=b.BoundaryPointRenderPointMask|b.SharpPointRenderPointMask|b.SmoothPointRenderPointMask|b.FreePointRenderPointMask,e.Constants=b,e.FrontSide=b.FrontSide,e.BackSide=b.BackSide,e.DoubleSide=b.DoubleSide,e.NoOccurrences="true"===localStorage.getItem("WebVisuPrivate_NoOccurrences"),e.disableJHGDev=!0,e.WebGLVersion=1,e.BlockPoints={FRAME:0,OBJECT:1},e._setForceDevicePixelRatio=function(e){this._forceDevicePixelRatio=e},e._forceDevicePixelRatio=-1,e.getDevicePixelRatio=function(){return-1!==this._forceDevicePixelRatio?this._forceDevicePixelRatio:window.devicePixelRatio},e.getColorHex=function(e){return x.set(e),x.getHex()},e._createDummyTexture=function(t){for(var i=new Uint8Array(16),r=0;r<4;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return n.generateMipmaps=!1,n.needsUpdate=!0,n},e._AmbianceGenerators={viewers:[],loading:!1,manager:null,_available:!1,_dummyRoughnessTexture:e._createDummyTexture([200,200,200,127]),_needsUpdate:function(){return!!this._available&&this.manager._needsUpdate()},cb:null,errorCount:0,init:function(e){if(this._dummyRoughnessTexture.hasDiffuse=!0,!this.loading&&!this.manager&&null===this.manager){this.loading=!0;var t=this;require(["DS/Visualization/AmbianceGenerator"],function(i){t.loading=!1,t.manager=new i(t.cb),t._available=t.available(e);for(var r=0;r<t.viewers.length;r++)t.viewers[r].forceRender=!0})}},available:function(t){var i=!!e.supportedExtensions.textureHalfFloat&&!!e.supportedExtensions.renderToHalfFloatTexture&&!!e.supportedExtensions.textureHalfFloatLinear||!!e.supportedExtensions.textureFloat&&!!e.supportedExtensions.renderToFloatTexture&&!!e.supportedExtensions.textureFloatLinear;return i||(0===t&&this.errorCount<10?console.warn("Warning: device does not support automatic mip map generation for hdrs, please set one yourself"):1===t&&this.errorCount<11&&console.warn("Warning: device does not support fabrics under ibl"),this.errorCount++),i},getAmbiance:function(e,t,i,r){return this._available?this.manager.getAmbiance(e,t,i,r).ambiance:this._dummyRoughnessTexture},update:function(e,t){return!!this._needsUpdate()&&this.manager.update(e,t)},decreaseUseCount:function(e){this._available&&this.manager.decreaseUseCount(e)},_decreaseSceneUseCount:function(e){this._available&&(this.manager.decreaseUseCount(e.envMipMapID),e.envMipMapID=null,this.manager.decreaseUseCount(e.envMipMapSheenID),e.envMipMapSheenID=null)},keep:function(e){return this._available?this.manager.keep(e):null},setCallBack:function(e){this.cb=e,this._available&&this.manager._setCB(e)},dispose:function(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1),0===this.viewers.length&&(this.manager&&(this.manager.dispose(),this.manager=null),this._available=!1,this._dummyRoughnessTexture&&this._dummyRoughnessTexture.dispose())}},e._SSSGenerator={viewers:[],manager:null,init:function(){null===this.manager&&(this.manager=new S)},getTextures:function(e){return this.manager?this.manager.compute(e):null},decreaseUseCount:function(e){this.manager&&this.manager.decreaseUseCount(e)},dispose:function(e){var t=this.viewers.indexOf(e);t>-1&&this.viewers.splice(t,1),0===this.viewers.length&&this.manager&&(this.manager.dispose(),this.manager=null)}};var w=[];w.push(new e.Vector2(-.770613,-.239161)),w.push(new e.Vector2(.654029,-.712337)),w.push(new e.Vector2(-.307109,.184156)),w.push(new e.Vector2(.511665,.311578)),w.push(new e.Vector2(.950228,-.256954)),w.push(new e.Vector2(-.00583136,-.537149)),w.push(new e.Vector2(-.692077,.433278)),w.push(new e.Vector2(-.357517,.88078)),w.push(new e.Vector2(.278742,.859941)),w.push(new e.Vector2(-.631555,-.471973)),w.push(new e.Vector2(-.480475,-.732053)),w.push(new e.Vector2(-.486058,.576291)),w.push(new e.Vector2(.190138,-.625394)),w.push(new e.Vector2(-.176393,-.166675)),w.push(new e.Vector2(.0663065,-.333703)),w.push(new e.Vector2(.348117,-.812683)),w.push(new e.Vector2(.0817859,.0594559)),w.push(new e.Vector2(.375191,-.0632498)),w.push(new e.Vector2(.770788,-.0723965)),w.push(new e.Vector2(.800971,.431381)),w.push(new e.Vector2(-.100114,.320657)),w.push(new e.Vector2(.285262,.61499)),w.push(new e.Vector2(-.579148,.219349)),w.push(new e.Vector2(-.684372,-.0462647)),w.push(new e.Vector2(-.313914,-.939188)),w.push(new e.Vector2(-.414696,.367707)),w.push(new e.Vector2(.698927,.219188)),w.push(new e.Vector2(.971183,.130313)),w.push(new e.Vector2(.0822042,.526062)),w.push(new e.Vector2(-.214193,.522263)),w.push(new e.Vector2(-.0751906,.901432)),w.push(new e.Vector2(.488676,-.253098)),w.push(new e.Vector2(-.580828,.778049)),w.push(new e.Vector2(.816108,-.536974)),w.push(new e.Vector2(.51456,.543311)),w.push(new e.Vector2(-.213744,-.428735)),w.push(new e.Vector2(.293803,-.405018)),w.push(new e.Vector2(.169169,.259656)),w.push(new e.Vector2(.445091,-.594255)),w.push(new e.Vector2(-.453123,-.1009)),w.push(new e.Vector2(-.420509,-.388243)),w.push(new e.Vector2(.576791,.0184982)),w.push(new e.Vector2(.610535,.759891)),w.push(new e.Vector2(.692311,-.348235)),w.push(new e.Vector2(.0912182,.752741)),w.push(new e.Vector2(-.840539,.203544)),w.push(new e.Vector2(.0673295,-.961926)),w.push(new e.Vector2(-.951943,.0129663)),w.push(new e.Vector2(-.14793,-.811125)),e._poissonDisk=w,e.__renderTargetID=0,e.CullFaceNone=0,e.CullFaceBack=1,e.CullFaceFront=2,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=0,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=1,e.PCFSoftShadowMap=2,e.PCFInterpolShadowMap=3,e.PCFPoissonShadowMap=4,e.PCFOptimizedShadowMap=5,e.ESMShadowMap=6,e.ESMImprovedShadowMap=7,e.LowQuality=0,e.MediumQuality=1,e.HighQuality=2,e.NoShading=0,e.FlatShading=1,e.SmoothShading=2,e.FrontToBack=0,e.BackToFront=1,e.DrawCallSorting={FrontToBackSort:e.FrontToBack,BackToFrontSort:e.BackToFront,RenderDepthSort:2,NeverSort:3,DecalSort:4,GLTypeSort:5},e.VertexColorType={NoColors:0,Face:1,RGBA:2,RGB:3,A:4,R:8,G:16,B:32},e.NoColors=e.VertexColorType.NoColors,e.FaceColors=e.VertexColorType.Face,e.VertexColors=e.VertexColorType.RGBA,e.VertexColorsRGBA=e.VertexColorType.RGBA,e.VertexColorsRGB=e.VertexColorType.RGB,e.VertexColorsA=e.VertexColorType.A,e.NoBlending=0,e.NormalBlending=1,e.AdditiveBlending=2,e.SubtractiveBlending=3,e.MultiplyBlending=4,e.CustomBlending=5,e.NormalDepthBlending=6,e.AlphaBlending=7,e.GroundShadowBlending=8,e.TransparentShadowBlending=9,e.OITAccumBlending=10,e.OITRevealBlending=11,e.AddEquation=100,e.SubtractEquation=101,e.ReverseSubtractEquation=102,e.MinEquation=103,e.MaxEquation=104,e.ZeroFactor=200,e.OneFactor=201,e.SrcColorFactor=202,e.OneMinusSrcColorFactor=203,e.SrcAlphaFactor=204,e.OneMinusSrcAlphaFactor=205,e.DstAlphaFactor=206,e.OneMinusDstAlphaFactor=207,e.DstColorFactor=208,e.OneMinusDstColorFactor=209,e.SrcAlphaSaturateFactor=210,e.MultiplyOperation=0,e.MixOperation=1,e.AddOperation=2,e.SmoothEdgeRenderLineModeMask=e.GeomTypeEnum.SMOOTH_EDGE,e.SharpEdgeRenderLineModeMask=e.GeomTypeEnum.SHARP_EDGE,e.WireEdgeRenderLineModeMask=e.GeomTypeEnum.WIRE_EDGE,e.BoundaryEdgeRenderLineModeMask=e.GeomTypeEnum.BOUNDARY_EDGE,e.HideAllRenderLineMode=0,e.OutlineMask=e.GeomTypeEnum._OUTLINE,e.SectionLineMask=e.GeomTypeEnum._SECTION_LINE,e.HideWireEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideSmoothEdgesRenderLineMode=e.GeomTypeEnum.EDGE|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.HideInternalEdgesRenderLineMode=e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowAllRenderLineMode=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.WireEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.ShowOutlinesAndEdgesRenderLineMode=e.OutlineMask|e.ShowAllRenderLineMode,e.ShowOutlinesHideEdgesRenderLineMode=e.OutlineMask|e.HideAllRenderLineMode,e.BodyLinesMask=e.GeomTypeEnum.EDGE|e.SmoothEdgeRenderLineModeMask|e.SharpEdgeRenderLineModeMask|e.BoundaryEdgeRenderLineModeMask,e.NoNoZPriorityMask=e.GeomTypeEnum.EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE|e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum.HIDDEN_SEAM_EDGE,e.HideAllModelFaces=0,e.ShowAllFaces=e.GeomTypeEnum.FACE|e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum.AXIS_SYSTEM,e.BoundaryPointRenderPointMask=e.GeomTypeEnum.BOUNDARY_POINT,e.SharpPointRenderPointMask=e.GeomTypeEnum.SHARP_POINT,e.SmoothPointRenderPointMask=e.GeomTypeEnum.SMOOTH_POINT,e.SurfacicPointRenderPointMask=e.GeomTypeEnum.SURFACIC_POINT,e.FreePointRenderPointMask=e.GeomTypeEnum.FREE_POINT,e.AllPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask|e.FreePointRenderPointMask,e.AllPointsButSurfacicPointsRenderPointMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.FreePointRenderPointMask,e.BodyPointsMask=e.BoundaryPointRenderPointMask|e.SharpPointRenderPointMask|e.SmoothPointRenderPointMask|e.SurfacicPointRenderPointMask,e.__QA_AUTOMATION_MASK__=e.GeomTypeEnum.FACE|e.GeomTypeEnum.UNKNOWN_0D|e.GeomTypeEnum.UNKNOWN_1D|e.GeomTypeEnum.UNKNOWN_2D|e.GeomTypeEnum.UNKNOWN,e.loadingModels=!1,e._ForbidRenderableStates={NO_TRANSPARENT:1,NO_INVISIBLE_PLANE:2,NO_UNKNOWN:4,ONLY_LIGHTED:8,NO_EDGES_IF_HAS_FACES:16},e._SaveGeneratedRoughnessMaps=!1,e._DownloadGeneratedRoughnessMaps=!0,e.glStates={currentFramebuffer:void 0,currentWidth:0,currentHeight:0,currentXOffset:0,currentYOffset:0},e.DefaultAppearanceMode={BASIC:0,_GASLOOK_OLD:.5,GASLOOK:1,_TRANSPARENT:2,CLAY:3,WHITE_MAT_PLASTER:4,GREY_SHINY_PLASTIC:5,CAST_ALUMINUM:6,MACHINED_ALUMINUM:7,CAST_STEEL:8,BRUSHED_STEEL:9,MACHINED_STAINLESS_STEEL:10,COPPER:11,BRASS:12,GENERIC_PLASTIC:13,GENERIC_METAL:14,__QA_AUTOMATION__:15},e._DebugMaterialMode={NO_DEBUG:0,NORMAL:1,DEPTH:2,SHADOW:3,GEOM_UV:4,MAPPING_UV:5,GEOM_UV2:6,MAPPING_UV2:7},e.MaterialToUse={originalMaterial:0,normalMaterial:1,depthMaterial:2,normalDepthIoRRoughnessMaterial:3,shadowMapDepthMaterial:4,highlightMaterial:5,pickingMaterial:6,pickingMaterialInstancing:7,oitAccumMaterial:8,oitRevealMaterial:9,ZOnlyMaterial:10,depthRGBAMaterial:11,normalDepthMaterial:12,decalNormalStencilDepthMaterial:13,transparentShadowMaterial:14,texCoordMaterial:15,_fakeOriginalMaterial:16,gpuPositionMaterial:17,totalMaterial:18};var M=e.MaterialToUse;M.pickingPassMaterial=function(e){return e===M.pickingMaterial||e===M.pickingMaterialInstancing||e===M.normalMaterial||e===M.depthMaterial||e===M.gpuPositionMaterial},M.mainMaterial=function(e){return e===M.originalMaterial||e===M.oitAccumMaterial||e===M.oitRevealMaterial},e._isSelectionMaterial=function(e){switch(e){case M.normalMaterial:case M.depthMaterial:case M.highlightMaterial:case M.pickingMaterial:case M.pickingMaterialInstancing:return!0;default:return!1}},e.MaterialHasPriority=[!1,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0,!0,!1,!0],e.HaloHighlightData=y.HaloHighlightData,e.AdvancedPoliteHighlightData=y.AdvancedPoliteHighlightData,e.DefaultHighlightData=y.DefaultHighlightData,e.DefaultPreHighlightData=y.DefaultPreHighlightData;var C,P,E=e.GeomTypeEnum,T={};!function(){var e,t,i=["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","HIDDEN_SEAM_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","HIDDEN_SEAM_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE","UNKNOWN","AXIS_SYSTEM","_OUTLINE"],r={EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,HIDDEN_SEAM_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,HIDDEN_SEAM_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:2,FACE:2,UNKNOWN:2,AXIS_SYSTEM:2,_OUTLINE:1};for(e=0;e<i.length;e++)T[E[t=i[e]]]=r[t];T[E.SMOOTH_EDGE|E._HIGH_CURVATURE_EDGE]=r.SMOOTH_EDGE}(),e.dimensionMapping=T,e.Line3=r.Line3,e.Box2=r.Box2,e.Box3=r.Box3,e.mergeBoundingBoxInto=r.mergeBoundingBoxInto,e.DGBoundingBoxArray=r.DGBoundingBoxArray,e.Sphere=r.Sphere,e.mergeBoundingSphereInto=r.mergeBoundingSphereInto,e.BoundingSphere=r.BoundingSphere,e.Frustum=r.Frustum,e.Plane=r.Plane,e.Math={clamp:function(e,t,i){return e<t?t:e>i?i:e},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0},degToRad:(P=Math.PI/180,function(e){return e*P}),radToDeg:(C=180/Math.PI,function(e){return e*C})},e.Spline=r.Spline,e.Triangle=r.Triangle,e.Vertex=function(e){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),e},e.UV=function(t,i){return console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead."),new e.Vector2(t,i)},e.Clock=function(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},e.extend(e.Clock.prototype,{start:function(){this.startTime=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),this.oldTime=this.startTime,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}}),e.Object3D=s,e.Projector=function(){var t=new e.Matrix4;this.projectVector=function(e,i){return i.matrixWorldInverse.getInverse(i.matrixWorld),t.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),e.applyProjection(t)},this.unprojectVector=function(e,i){return i.projectionMatrixInverse.getInverse(i.projectionMatrix),t.multiplyMatrices(i.matrixWorld,i.projectionMatrixInverse),e.applyProjection(t)},this.pickingRay=function(t,i){t.z=-1;var r=new e.Vector3(t.x,t.y,1);return this.unprojectVector(t,i),this.unprojectVector(r,i),r.sub(t).normalize(),new e.Raycaster(t,r)}},e.Face3=r.Face3,e.Face4=r.Face4,e.Geometry=n.LegacyGeometry,e.GeometryIdCount=0,e._CameraRoles=o._CameraRoles,e._FrameTypes=o._FrameTypes,e.Camera=o.BaseCamera,e.OrthographicCamera=o.OrthographicCamera,e.PerspectiveCamera=o.PerspectiveCamera,e.Light=a.BaseLight,e.AmbientLight=a.AmbientLight,e.AreaLightUnits=a.AreaLightUnits,e.SphereLight=a.SphereLight,e.DiskLight=a.DiskLight,e.TubeLight=a.TubeLight,e.RectangleLight=a.RectangleLight,e.DirectionalLight=a.DirectionalLight,e.DirectionalIBLLight=a.DirectionalIBLLight,e.DirectionalPhongLight=a.DirectionalPhongLight,e.PointLight=a.PointLight,e.SpotLight=a.SpotLight,e.IESLight=a.IESLight,e.ImageLoader=function(){e.EventDispatcher.call(this),this.crossOrigin=null},e.ImageLoader.prototype={constructor:e.ImageLoader,load:function(e,t){var i=this;void 0===t&&(t=new Image),t.addEventListener("load",function(){i.dispatchEvent({type:"load",content:t})},!1),t.addEventListener("error",function(){i.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),i.crossOrigin&&(t.crossOrigin=i.crossOrigin),t.src=e}},e.MeshFaceMaterial=function(e){this.materials=e instanceof Array?e:[]},e.MeshFaceMaterial.prototype.clone=function(){return new e.MeshFaceMaterial(this.materials.slice(0))};e.Particle=class extends s{constructor(e){super(),this.material=e}clone(t){return void 0===t&&(t=new e.Particle(this.material)),super.clone(t),t}},e.ParticleSystem=n.ParticleSystem,e.Line=n.Line,e.LineStrip=0,e.LinePieces=1,e.Mesh=l;e.CSS3DNode=class extends s{constructor(t){super(),this.element=t||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.geometry=new e.Geometry,this.geometry.boundingSphere=new e.Sphere}};e.Bone=class extends s{constructor(t){e.Object3D.call(this)}},e.SkinnedMesh=n.SkinnedMesh,e.Sprite=function(t){e.Object3D.call(this)},e.Sprite.prototype=Object.create(e.Object3D.prototype),e.WebGLObjectManager=c,e.Scene=h,e.StateSortingResult=t.StateSortingResult;return e.VertexStage=0,e.FragmentStage=1,e.PDSFXPolygonOffsetParams={Backward2:[4,4],Backward1:[2,2.3],Backward0:[1,1],Neutral:[0,0],Frontward0:[-.9,-1],Frontward1:[-2,-2]},e._DefaultShaderChunk=d,e._ShaderChunk=u,e._DeferredShaderChunk=p,e.UniformsUtils=f,e.UniformsLib=g,e.ShaderLib={},e.lastContextId=-1,e.RendererMode={static:0,dynamic:1,override:2,_count:3},e.GeometryUtils={center:function(t){t.computeBoundingBox();var i=t.boundingBox,r=new e.Vector3;return r.addVectors(i.min,i.max),r.multiplyScalar(-.5),t.applyMatrix((new e.Matrix4).makeTranslation(r.x,r.y,r.z)),t.computeBoundingBox(),r}},e.BasisUsage=m.BasisUsage,e.ImageUtils=m.Utils,e.FontUtils=v.FontUtils,e.LineCurve=_.LineCurve,e.QuadraticBezierCurve=_.QuadraticBezierCurve,e.CubicBezierCurve=_.CubicBezierCurve,e.SplineCurve=_.SplineCurve,e.EllipseCurve=_.EllipseCurve,e.LineCurve3=_.LineCurve3,e.QuadraticBezierCurve3=_.QuadraticBezierCurve3,e.CubicBezierCurve3=_.CubicBezierCurve3,e.SplineCurve3=_.SplineCurve3,e.ClosedSplineCurve3=_.ClosedSplineCurve3,e.CurvePath=_.CurvePath,e.Path=_.Path,e.PathActions=_.PathActions,e.Shape=v.Shape,e.CubeGeometry=n.CubeGeometry,e.CircleGeometry=n.CircleGeometry,e.CylinderGeometry=n.CylinderGeometry,e.ExtrudeGeometry=n.ExtrudeGeometry,e.ShapeGeometry=n.ShapeGeometry,e.PlaneGeometry=n.PlaneGeometry,e.SphereGeometry=n.SphereGeometry,e.TextGeometry=n.TextGeometry,e.CameraHelper=class extends e.Line{constructor(t){super(),this._tokens={},this.geometry=new e.Geometry,this.material=new e.LineBasicMaterial({color:16777215,vertexColors:e.VertexColorType.Face}),this.type=e.LinePieces,this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.frustumCulled=!1,this.pointMap={};this.addLine("n1","n2",16755200),this.addLine("n2","n4",16755200),this.addLine("n4","n3",16755200),this.addLine("n3","n1",16755200),this.addLine("f1","f2",16755200),this.addLine("f2","f4",16755200),this.addLine("f4","f3",16755200),this.addLine("f3","f1",16755200),this.addLine("n1","f1",16755200),this.addLine("n2","f2",16755200),this.addLine("n3","f3",16755200),this.addLine("n4","f4",16755200),this.addLine("p","n1",16711680),this.addLine("p","n2",16711680),this.addLine("p","n3",16711680),this.addLine("p","n4",16711680),this.addLine("u1","u2",43775),this.addLine("u2","u3",43775),this.addLine("u3","u1",43775),this.addLine("c","t",16777215),this.addLine("p","c",3355443),this.addLine("cn1","cn2",3355443),this.addLine("cn3","cn4",3355443),this.addLine("cf1","cf2",3355443),this.addLine("cf3","cf4",3355443),this.camera=t,this.update(t)}addLine(e,t,i){this.addPoint(e,i),this.addPoint(t,i)}addPoint(t,i){this.geometry.vertices.push(new e.Vector3),this.geometry.colors.push(new e.Color(i)),void 0===this.pointMap[t]&&(this.pointMap[t]=[]),this.pointMap[t].push(this.geometry.vertices.length-1)}update(){e.CameraHelper.prototype.__c.projectionMatrix.copy(this.camera.projectionMatrix),this.setPoint("c",0,0,-1),this.setPoint("t",0,0,1),this.setPoint("n1",-1,-1,-1),this.setPoint("n2",1,-1,-1),this.setPoint("n3",-1,1,-1),this.setPoint("n4",1,1,-1),this.setPoint("f1",-1,-1,1),this.setPoint("f2",1,-1,1),this.setPoint("f3",-1,1,1),this.setPoint("f4",1,1,1),this.setPoint("u1",.7,1.1,-1),this.setPoint("u2",-.7,1.1,-1),this.setPoint("u3",0,2,-1),this.setPoint("cf1",-1,0,1),this.setPoint("cf2",1,0,1),this.setPoint("cf3",0,-1,1),this.setPoint("cf4",0,1,1),this.setPoint("cn1",-1,0,-1),this.setPoint("cn2",1,0,-1),this.setPoint("cn3",0,-1,-1),this.setPoint("cn4",0,1,-1),this.geometry.verticesNeedUpdate=!0}setPoint(t,i,r,n){e.CameraHelper.prototype.__v.set(i,r,n),e.CameraHelper.prototype.__projector.unprojectVector(e.CameraHelper.prototype.__v,e.CameraHelper.prototype.__c);var s=this.pointMap[t];if(void 0!==s)for(var a=0,o=s.length;a<o;a++)this.geometry.vertices[s[a]].copy(e.CameraHelper.prototype.__v)}},e.CameraHelper.prototype.__projector=new e.Projector,e.CameraHelper.prototype.__v=new e.Vector3,e.CameraHelper.prototype.__c=new e.Camera,e}),define("DS/Visualization/ThreeJS_R57",["DS/Visualization/RendererGlobals","DS/Visualization/FixedSizeArrayPool","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","DS/Visualization/BufferGPUManager","DS/Visualization/ShaderChunk","UWA/Data","WebappsUtils/WebappsUtils","DS/Visualization/Materials","DS/Visualization/ShaderLib","DS/Visualization/CullingSystem","DS/GPUFormats/GPUFormats","DS/RenderEngineUtils/RenderEngineUtils","DS/Visualization/SkinningTransformation","DS/Visualization/Info","DS/RenderEngineUtils/BufferUtils","DS/ShaderBuilders/ShaderUtils/UniformUtils","DS/ShaderBuilders/ShaderUtils/ShaderInOutUtils","DS/ShaderBuilders/ShaderUtils/TypeUtils","DS/ShaderBuilders/ShaderUtils/AttributeUtils","DS/ShaderBuilders/ShaderUtils/FunctionUtils","DS/ShaderBuilders/WebGPUShaderBuilder","DS/GPURenderer/WebGPURenderPipelines","DS/ShaderBuilders/PDSFXShaderBuilder"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w){"use strict";var M=!0,C=window.SIMULATE_EXPERIENCE_PLAYER,P=e.Constants;const E=e.BodyLinesMask,T=e.BodyPointsMask;self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array;var A={TRIANGLE_STRIP:5,TRIANGLES:4,LINE_STRIP:3,LINES:1,POINTS:0};const D=new e.Matrix4;var I=new e.Color,R=new e.Vector3,O=e.__visibleInCurrentSpace,L=e.__visibleInCurrentSpaceSimple;const V=e.ProgramIDs;var F,B;!function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(t){var i=Date.now(),r=Math.max(0,16-(i-e)),n=window.setTimeout(function(){t(i+r,!1)},r);return e=i+r,n}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(e){window.clearTimeout(e)}}();const N=e.dimensionMapping;var G=e.GeomTypeEnum;const k=e.PlaneViewMode;var U=e._ForbidRenderableStates,z=e._toFastProperties;const H=e._AmbianceGenerators,W=(e._SSSGenerator,e.TextureBlendOperations),j=new w.Fragment,X=new w.Vertex;var q=function(){this.program=null,this.id=0,this.uniformLocations=null,this.globalUniformLocations=null,this.pdsfxUniformLocations=null,this.postProUniformLocations=null,this.lightUniformLocations=null,this.shadowUniformLocations=null,this.clippingUniformLocations=null,this.objectUniformLocations=null,this.attributes={position:-1,normal:-1,uv:-1,uv2:-1,tangent:-1,binormal:-1,color:-1,skinIndex:-1,skinWeight:-1,lineDistance:-1,linePixelDistance:-1,previousPos:-1,followingPos:-1,sideExtrusion:-1,patternStartEnd:-1},this.uvOrBinOrTan=!1,this.instanceAttributes={},this.flattenedUniformArrays={},this._clipPlanesVersion=-1,this._lightsKey=0,this._ambianceKey=0,this._materialToUse=0},Z=e.DefaultAppearanceMode,Y=e._DebugMaterialMode,Q=e.MaterialToUse,K=e._isSelectionMaterial,$=c.VISIBILITY_STATUS,J=c.INCREMENTAL_ACTIONS,ee=c.__CullingSystemFactory;Object.assign(e,l);var te=new e.DSPBR19xMaterial({color:14540253,roughness:.34,specular:16777215,ior:1.4,metalness:0,specularContrib:1,opacity:1,transparency:0}),ie=l.ShaderDynamicPrefixBuilder._VertexPrefixBuilder,re=l.ShaderDynamicPrefixBuilder._FragmentPrefixBuilder;const ne=e.FragmentStage;Object.assign(e,p);const se={set(){},get:()=>"SHADERCHUNK_ACCESS_NON_COMPILING_CODE;"};Object.defineProperty(e,"ShaderChunk",{get:function(){return new Proxy({},se)},set:function(){throw"NO"}}),e.ShaderLib=h;for(var ae=0,oe=e.RendererMode,le=new Array(oe._count),he=0;he<oe._count;he++)le[he]=he;var ce=function(e,t,i,r,n){if(i)e.setRenderTarget(t.currentNormalStencilDepthBuffer);else if(r){if(null==t.currentTexCoordBuffer){var s=e.getViewportSize();t.currentTexCoordBuffer=e.renderTargetPool.buildRenderTarget(s.width,s.height,"decalTex"),e.clearTarget(t.currentTexCoordBuffer,!0,!0,!0)}e.setRenderTarget(t.currentTexCoordBuffer)}else n&&e.setRenderTarget(t.currentRGBADepthBuffer)},de=function(e,t,i){i&&e.setRenderTarget(t)};const ue=u.StateSortingCacheItem,pe=e.DrawCallSorting;return e.WebRenderer=class{constructor(i){this.newMaterialInheritance=!1,this._useRenderDepthDL=!1,this._pbrCheck=null,this.renderPointMode=0,this.renderLineMode=e.ShowAllRenderLineMode,this.renderFaceMode=e.ShowAllFaces,this.clippingSphereOptim=void 0===window.WUXClippingSphereOptim||window.WUXClippingSphereOptim,this.renderHiddenEdges=!1,this.halfVisibleSmoothEdges=!1,this.outlineWidth=1,this.ratioSSB=100,this.colorizeSSB=!1;var r=new e.PickingMode;this.pickingModeMSB=r.pickingModeMSB,this.pickingModeLSB=r.pickingModeLSB,this.generateInfos=!1,this.__A2XMode=!1,this.currentFrameIndex=0,this._currentFrameType=-1,this.renderIteration=0,this.sortCount=0,this._VRCompatible=!1,this._VRFrameBuffer=null,this.resetGSSOCacheFrame=0,this.useBackfaceCullingWithNoCapping=!1,this.useCustomCappingForClipPolyline=!1,this.shaderVersions=new Array(oe._count);for(var s=0;s<oe._count;s++)this.shaderVersions[s]=0;this.currentRendererMode=oe.static,this.forcePolygonOffset=e.PolygonOffsetForceStatus.DEFAULT,this.overrideWireframeFix=!1,i=i||{},this._texturesToResize=new Set,this.positionComponent=new e.Vector3(1,0,0),this.precision=void 0!==i.precision?i.precision:"highp",this.precisionInt=void 0!==i.precision?i.precision:"highp",this.divCSS3DRoot=void 0!==i.divCSS?i.divCSS:document.createElement("div"),this.useCompositing=i.useCompositing;var a=!(!navigator.webdriver||localStorage.getItem("WebVisuEnableAAWithWebdriver"));this._sortRenderListByBuffer=void 0!==i.sortRenderListByBuffer&&i.sortRenderListByBuffer,this.canvas=void 0!==i.canvas?i.canvas:document.createElement("canvas"),this.alpha=void 0===i.alpha||i.alpha,this.premultipliedAlpha=void 0===i.premultipliedAlpha||i.premultipliedAlpha,this.antialias=void 0!==i.antialias&&!a&&i.antialias,this.stencil=void 0===i.stencil||i.stencil,this.preserveDrawingBuffer=void 0!==i.preserveDrawingBuffer&&i.preserveDrawingBuffer,this.width=0,this.height=0,this.widthHalf=0,this.heightHalf=0,this.domElement=this.canvas,this.currentPass=null,this.id=ae++,this.useRenderPriorityOpacity=!1,this.renderPriorityDefaultOpacity=1,this.devicePixelRatio=void 0!==i.devicePixelRatio?i.devicePixelRatio:e.getDevicePixelRatio()||1,this.splitScreenMode=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sectionCappingEnabled=!1,this.materialToUseList={originalMaterial:null,mainMaterial:null,lightedMaterial:null,isDecalNotPossiblePass:null,depthMaterial:null,depthRGBAMaterial:null,normalDepthReflMaterial:null,normalDepthMaterial:null,normalMaterial:null,zOnlyMaterial:null,zOnlyPass:null,dialogPass:null,outlineFriendly:null,pickingMaterial:null,pickingPassMaterial:null,shadowMaterial:null,highlightMaterial:null,oitMaterial:null,transparentShadowMaterial:null,positionMaterial:null},this.decalBuffers={currentNormalStencilDepthBuffer:null,currentTexCoordBuffer:null,currentRGBADepthBuffer:null},this.lastRenderTarget,this.visibleSpace=void 0!==i.visibleSpace?i.visibleSpace:1,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.gammaInput=!1,this.gammaOutput=!1,this.renderTargetPool=null,this.simpleGamma=!0,this.lensFlareEnabled=!0,this.baseLightDirection=new e.Vector3(0,0,1),this.shadowMapEnabled=!1,this.transparentShadowEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=e.PCFShadowMap,this.shadowMapQuality="Low",this.shadowMapCullFace=e.CullFaceFront,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this._renderScale=1,this._internalPixelScale=1,this.flakesMode=0,this.gasAsPhong=!1,this._useIBLColor=!1,this.clipPlanesEnabled=!1,this.clipPlanes=[],this.clipPlanesTolerance=.005,this.disableBackFaceClipPlanes=0,this.maxMorphTargets=8,this.maxMorphNormals=4,this.disableDepthWrite=!1,this.disableDepthTest=!1,this.disableColorWrite=!1,this.enableStencilWrite=!1,this.disableBackFaceCulling=!1,this.disableSetColorWrite=!1,this._inheritanceSolver=new u.InheritanceSolver(this),this.renderVolumesOnly=!1,this.materialMode=!0,this._defaultAppearanceType=Z.BASIC,this._debugMaterialMode=Y.NO_DEBUG,this._backgroundViewMode=e.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._backgroundColor=null,this._customMaterialModeParams={colorFromGAS:!1,color:new e.Color,shininess:1,opacity:1},this._GlobalZModeFilter=null,this.useCPUOutlines=this._inheritanceSolver._useCPUOutlines,this._fixedPointSize=null,this.enableRenderPluginsPre=!0,this.enableRenderPluginsPost=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.refractionColorBuffer=null,this.reflectionColorBuffer=null,this.aoBuffer=null,this.ambianceGenerators=null,this.sssGenerator=null,this.dBuffer=null,this.requestDBuffer=!1,this._dBufferNextFrame=!1,this.requestRealDepthBuffer=function(){this._dBufferNextFrame=!0},this._requestPoliteDepthBuffer=!1,this._politeDBufferNextFrame=!1,this.requestPoliteDepthBuffer=function(){this._politeDBufferNextFrame=!0,this._requestPoliteDepthBuffer=!0},this.politeDepthBuffer=null,this._NoMeshInRamWarningCount=0,this.maxPolyLineSize=0,this.maxNbPolyLine=0,this.maxScissorSize=0,this.maxNbScissor=0,this.useClippingCylinder=!1,this.info={memory:new f.MemoryInfo,renderMap:new Map,render:null,renderTime:new f.RenderTimeInfo},this.memoryInfo=this.info.memory,this.currentRenderInfo=null,this.inlinedPostProcess={activated:!1,brightness:0,tonemapping:2,crushblacks:0,burnhighlights:0,saturation:1,colorCorrection:{x:1,y:1,z:1}},this.resetInlinedPostProcess=function(){this.inlinedPostProcess.activated=!1,this.inlinedPostProcess.brightness=0,this.inlinedPostProcess.tonemapping=2,this.inlinedPostProcess.crushblacks=0,this.inlinedPostProcess.burnhighlights=0,this.inlinedPostProcess.saturation=1,this.inlinedPostProcess.colorCorrection={x:1,y:1,z:1}},this._enableClearScissor=!1,this.frameUBOArray=null,this.frameUBOBuffer=null,this.float32Matrix4x3Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[12]=e[12],t[13]=e[13],t[14]=e[14],this},this.float32Matrix4x4Temp=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.float32Matrix4x4Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this},this.float32Matrix3x3Temp=new Float32Array([1,0,0,0,1,0,0,0,1]),this.float32Matrix3x3Temp.setDoubles=function(e){var t=this;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this},this._dummyTexture=e._createDummyTexture([0,0,0,255]);var o=this;this.forceCPUTBCompute=!1,this._clipPlanesState={uniforms:{nbClipPlanes:{type:"i",value:0,clipPlanesUniform:!0},clipPlaneEquations:{type:"fv4",value:[],clipPlanesUniform:!0},clipPlaneActive:{type:"iv1",value:[],clipPlanesUniform:!0},clipFrontOpacity:{type:"f",value:1,clipPlanesUniform:!0},clipBackOpacity:{type:"f",value:0,clipPlanesUniform:!0},scissorSize:{type:"iv1",value:[],clipPlanesUniform:!0},scissorPoints:{type:"t",value:null,clipPlanesUniform:!0},polygonSize:{type:"iv1",value:[0],clipPlanesUniform:!0},polygonPoints:{type:"t",value:null,clipPlanesUniform:!0},extrusionPlaneU:{type:"fv",value:[0,0,1],clipPlanesUniform:!0},extrusionPlaneV:{type:"fv",value:[1,0,0],clipPlanesUniform:!0},cylinderClipZone:{type:"i",value:0,clipPlanesUniform:!0},cylinderCenter:{type:"v3",value:null,clipPlanesUniform:!0},cylinderAxisU:{type:"v3",value:new e.Vector3(0,0,1),clipPlanesUniform:!0},cylinderAxisV:{type:"v3",value:new e.Vector3(1,0,0),clipPlanesUniform:!0}},version:-1,disabled:!1,update:function(t,i,r,n,s,a){if(r||t!==i||this.disabled&&n.enableClipPlanes){var l=t&&t.clipPlanes,h=o.clipPlanesEnabled?o.clipPlanes:[];l&&(h=l);var c,d,u,p=[];for(u=0;u<h.length&&p.length<6;u++)(d=(c=h[u])&&c.clippingContext&&c.clippingContext[o.id])&&d.clippingPlaneAdded&&p.push(c);var f=-1,g=t&&t.getClippingSettings();for(g&&0===g.frontOpacity&&(f=1),u=0;u<p.length;u++){var m,v=o.clipPlanesEnabled||l;m=s instanceof e.OrthographicCamera?-p[u].normal.dot(s.getLookAt()):p[u].distanceToPoint(s.position),p[u].enabled=v&&(0==o.disableBackFaceClipPlanes||f*m>0)}o.setupClipPlanes(null,p,s,t),o.refreshUniformsClipPlanes(this.uniforms,o._clipPlanes,n&&n.clipPlaneIndex,t,a),o.refreshUniformsClipPolyLine(this.uniforms,t?t.clipPolyLine:null,s,o.currentFrameIndex,o.maxNbPolyLine,t,a),t&&t.scissor&&"polyline"===t.scissor.type?o.refreshUniformsScissorPolyLine(this.uniforms,t.scissor,s,o.currentFrameIndex,o.maxNbScissor):o.refreshUniformsScissorPolyLine(this.uniforms,null),o.refreshUniformsClipCylinder(this.uniforms,t?t.getClipCylinder():null),this.disabled=!1,this.version++}else o.disabled||n.enableClipPlanes||(this.disabled=!0,o.refreshUniformsClipPlanes(this.uniforms,{length:0,eqs:[],states:[]},0))}},this.currentModelMatrix=null,this.currentCamera=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.programs=[],this.programs_counter=0,this.lightsKey=0,this.ambianceKey=0,this.currentGeometryGroupHash=null,this.currentMaterialId=-1,this.currentMaterialOverrideId=-1,this.lightsNeedUpdate=!0,this.tryCleanPrograms=!1,this.currentProgramID=1,this.usedTextureUnits=0,this.scene=null,this.currentScene=null,this.camera=null,this.frustum=new e.Frustum,this.lights={ambient:[0,0,0,0],directional:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[]},directionalIBL:{length:0,colors:[],positions:[]},directionalPhong:{length:0,colors:[],positions:[]},point:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[]},spot:{length:0,colors:[],colorsPhong:[],colorsNoIntensity:[],positions:[],physicalAttenuations:[],directions:[]},sphere:{length:0,colors:[],positions:[]},rectangle:{length:0,colors:[],positions:[],normals:[],ups:[]},disk:{length:0,colors:[],positions:[],normals:[],ups:[]},tube:{length:0,colors:[],positions:[],rights:[]},ies:{length:0,colors:[],positions:[],distances:[],iesLightTexture:[],matrixWorldInv:[],physicalAttenuations:[]}},this.currentInstanceAttribsId=-1,this.projScreenMatrix=new e.Matrix4,this.gpuStates={doubleSided:-1,flipSided:-1,orientation:1,blendEquation:-1,blendSrc:-1,blendDst:-1,depthTest:-1,depthFunc:-1,colorWrite:-1,depthWrite:-1,stencilWrite:-1,polygonOffset:null,polygonOffsetFactor:null,polygonOffsetUnits:null,lineWidth:1,viewportX:0,viewportY:0,viewportWidth:0,viewportHeight:0,viewportInvWidth:0,viewportInvHeight:0,viewportScale:1,scissor:!1,scissorRect:{x:-1/0,y:-1/0,width:0,height:0},clearColor:void 0!==i.clearColor?new e.Color(i.clearColor):new e.Color(0),clearAlpha:void 0!==i.clearAlpha?i.clearAlpha:0},this._clipPlanes={length:0,eqs:[],states:[],sectionLines:[],hasCapping:!1},this.rendererInfo={gpu:"Unknown",vendor:"Unknown"},this.fixedSizeArrayPool=new t,this.bufferGPUManager=n,this.bufferUtils=new g(this),this.bufferUtils.setInfo(this.info.memory),this.dummySSLRTexture=new e.DataTexture(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),2,2,e.RGBAFormat,e.UnsignedByteType),this.dummySSLRTexture.needsUpdate=!0,this.dummySSAOTexture=new e.DataTexture(new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]),2,2,e.RGBAFormat,e.UnsignedByteType),this.dummySSAOTexture.needsUpdate=!0,this.monoTransparDL=!0===localStorage.getItem("__WEBVISU_MONO_TRANSPARDL__"),this.newHLPOC="true"===localStorage.getItem("__WEBVISU_NEWHL_POC__"),this.visuFilterType=e._VisuFilterType,this.outlineGeomType=e.GeomTypeEnum._OUTLINE,this.tokens=[],this._pixelSize=new e.Vector2,this.objectsToGSSO=[],this.packESM=!1,this._gpuPickingTolerance=0,this._smallTargetPicking=0,this._heuristicNormalRadius=0,this.useOIT=!1,this.useSSLR=!1,this.useSSAO=!1,this.useSSAOIterative=!1,this.ssaoParams=null,this.useSSLRefraction=!1,this.precomputedTexture=null,this.boundaryEdgeMaterialInfo={color:new e.Color(255),enabled:!1},this.precomputedAreaTexture=null,this.materialToUse=e.MaterialToUse.originalMaterial,this._forbidRenderableState=0,this.shadowMapSoft=!1,this.gpuAntiAliasing=!1,this.forceMaterialDoubleSide=!0,this.cuttingScene=null,this.backupCuttingMaterial=null,this.cameraSystem_cameraIndex=-1,this.diffuseModified=!1,this.onTextureDispose=function(e){var t=e.target;t.removeEventListener("dispose",o.onTextureDispose),o.deallocateTexture(t),t.textures&&(t.usedTexture=-1),o.memoryInfo.textures--;var i=o?o.__glResources__.texture.indexOf(t):-1;i>=0&&o.__glResources__.texture.splice(i,1)},this.onRenderTargetDispose=function(e){var t=e.target;t.removeEventListener("dispose",o.onRenderTargetDispose),o.deallocateRenderTarget(t),o.memoryInfo.renderTargets--;var i=o?o.__glResources__.renderTarget:null;i&&i[t.uniqueID]&&delete i[t.uniqueID]},this.onMaterialDispose=function(e){var t=e.target;t.removeEventListener("dispose",o.onMaterialDispose);var i=null!==t.program?t.program.program:null;o.deallocateMaterial(t,i,!0)},this.deallocateTexture=function(e){let t=o.gl;if(e.__webglInit){e.__webglInit=!1;for(let i=0;i<e.__webglTexture.length;i++)t.deleteTexture(e.__webglTexture[i]);e.needsUpdate=!0}},this.deallocateRenderTarget=function(t){let i=o.gl;if(t&&t.__webglTexture){for(let e=0;e<t.__webglTexture.length;e++)i.deleteTexture(t.__webglTexture[e]);if(t instanceof e.WebGLRenderTargetCube)for(var r=0;r<6;r++)i.deleteFramebuffer(t.__webglFramebuffer[r]),i.deleteRenderbuffer(t.__webglRenderbuffer[r]);else i.deleteFramebuffer(t.__webglFramebuffer),i.deleteRenderbuffer(t.__webglRenderbuffer)}},this.deallocateMaterial=function(e,t,i){if(null!==t){if(i)return e.programManager.disposeAllPrograms(o.deallocateMaterial),void e._deallocate(o);e.program=null;for(var r=0;r<o.programs.length;r++){var n=o.programs[r];if(null!==n.program&&n.program.program===t){n.usedTimes--,0===n.usedTimes&&(o.tryCleanPrograms=!0);break}}}}}initGL(e,t,i){}setDefaultGLState(){}paramThreeToGL(e){}buildDepthFunctionValues(){}_setWorldOrientation(e){this.baseLightDirection=e.upVector.clone()}initFrameUBO(){}updateFrameUBO(t){for(var i=t.matrixWorldInverse.elements,r=0;r<16;r++)this.frameUBOArray[r]=i[r];var n=t.projectionMatrix.elements;for(r=0;r<16;r++)this.frameUBOArray[r+16]=n[r];R.getPositionFromMatrix(t.matrixWorld),this.frameUBOArray[32]=R.x,this.frameUBOArray[33]=R.y,this.frameUBOArray[34]=R.z,this.frameUBOArray[36]=e.SplitFloat32(R.x).low,this.frameUBOArray[37]=e.SplitFloat32(R.y).low,this.frameUBOArray[38]=e.SplitFloat32(R.z).low}createRenderPass(){}submitRenderPass(){}dispose(){for(var e=0;e<this.renderPluginsPre.length;e++)this.renderPluginsPre[e].dispose&&this.renderPluginsPre[e].dispose();for(e=0;e<this.renderPluginsPost.length;e++)this.renderPluginsPost[e].dispose&&this.renderPluginsPost[e].dispose();this.ambianceGenerators&&(this.ambianceGenerators=null),this.sssGenerator&&(this.sssGenerator=null),this._cleanProgramPool(!0),this.dummySSLRTexture.dispose(),this.dummySSAOTexture.dispose(),this.renderPluginsPre=[],this.renderPluginsPost=[],this.bufferGPUManager.dispose(this.id),ee.dispose(),this.fixedSizeArrayPool=null,this.getContext=null,this.divCSS3DRoot=null,this.canvas=null,this.__glResources__=null,this.context=null,this.currentCamera=null,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.bufferUtils.dispose()}clearCurrentBuffer(){this.currentVertexBuffer=null,this.currentIndexBuffer=null}setPickingPriorityMapping(t,i){if(t){t.sort(function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:0});for(var r={},n=null,s=0,a=0;a<t.length;a++)(o=t[a]).priority>0?(n&&n.priority===o.priority||(s++,(l=i.getDisplayListByName("PICKING_H"+s))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_H"+s,priority:-s,drawCallSort:pe.FrontToBackSort,side:P.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache())),r[o.id]=l):0===o.priority&&(r[o.id]=null),n=o;for(n=null,s=0,a=t.length-1;a>=0;a--){var o,l;if((o=t[a]).priority<0)n&&n.priority===o.priority||(s--,(l=i.getDisplayListByName("PICKING_L"+-s))||(l=i.addDisplayList(new e.DisplayList({name:"PICKING_L"+-s,priority:2048-s,drawCallSort:pe.FrontToBackSort,side:P.FrontSide,polygonOffset:!1,pickingPriority:!0})),this.resetGSSOCache())),r[o.id]=l;n=o}i._pickingPriorityMapping=r}else i._pickingPriorityMapping=null}setCurrentPass(e){this.currentPass=e}setDisableColorWrite(e){this.disableColorWrite=e}setDisableDepthWrite(e){this.disableDepthWrite=e}setDisableDepthTest(e){this.disableDepthTest=e}setEnableStencilWrite(e){this.enableStencilWrite=e}setDisableBackFaceCulling(e){this.disableBackFaceCulling=e}setFaceCulling(t,i){let r=this.gl,n=this.gpuStates;n.orientation=0,n.flipSided=void 0,n.doubleSided=void 0,t===e.CullFaceNone?(r&&r.disable(r.CULL_FACE),n.doubleSided=!0):(i===e.FrontFaceDirectionCW?r&&r.frontFace(r.CW):r&&r.frontFace(r.CCW),t===e.CullFaceBack?r&&r.cullFace(r.BACK):t===e.CullFaceFront?r&&r.cullFace(r.FRONT):r&&r.cullFace(r.FRONT_AND_BACK),r&&r.enable(r.CULL_FACE),n.doubleSided=!1)}_hasClippingWithoutCapping(){return this.maxPolyLineSize>0?!this.useBackfaceCullingWithNoCapping&&!this.useCustomCappingForClipPolyline:this.useClippingCylinder&&this._clipPlanesState.value?!this.useBackfaceCullingWithNoCapping:!this.useBackfaceCullingWithNoCapping&&!(this.sectionCappingEnabled&&this._clipPlanes.hasCapping)&&this._clipPlanes.length>0}setMaterialFacesSimple(e,t,i,r){var n=e.doSetMaterialFaces,s=e.object,a=n.flipSided,o=n.doubleSided||this.disableBackFaceCulling||s._forceBackFacesOnSolid&&e.dg._dimension>=2&&!n.forceSide||r,l=s.orientation*i.orientation;let h=this.gl,c=this.gpuStates;c.doubleSided!==o&&(o?h&&h.disable(h.CULL_FACE):h&&h.enable(h.CULL_FACE),c.doubleSided=o),c.flipSided===a&&c.orientation===l||(a?l>=0?h&&h.frontFace(h.CW):h&&h.frontFace(h.CCW):l>=0?h&&h.frontFace(h.CCW):h&&h.frontFace(h.CW),c.orientation=l,c.flipSided=a)}setMaterialFacesSimpleDebug(t,i,r){var n=i.side===P.DoubleSide,s=i.side===P.BackSide,a=void 0!==t.object?t.object.orientation:1;void 0!==r&&(a*=r.orientation),t.object instanceof e.Mesh&&(a=-a);let o=this.gl,l=this.gpuStates;l.doubleSided!==n&&(n?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),l.doubleSided=n),l.flipSided===s&&l.orientation===a||(s?a>=0?o.frontFace(o.CW):o.frontFace(o.CCW):a>=0?o.frontFace(o.CCW):o.frontFace(o.CW),l.orientation=a,l.flipSided=s)}setMaterialFaces(e,t,i,r){var n=r&&3===t._bodyDim,s=e.side===P.BackSide,a=!n&&!s&&e.side!==P.FrontSide||this.disableBackFaceCulling,o=void 0!==t?t.orientation:1;void 0!==i&&(o*=i.orientation);let l=this.gl,h=this.gpuStates;h.doubleSided!==a&&(a?l.disable(l.CULL_FACE):l.enable(l.CULL_FACE),h.doubleSided=a),h.flipSided===s&&h.orientation===o||(s?o>=0?l.frontFace(l.CW):l.frontFace(l.CCW):o>=0?l.frontFace(l.CCW):l.frontFace(l.CW),h.orientation=o,h.flipSided=s)}setMaterialFacesDebug(t,i,r){var n=t.side===P.DoubleSide,s=t.side===P.BackSide,a=void 0!==i?i.orientation:1;void 0!==r&&(a*=r.orientation),i instanceof e.Mesh&&(a=-a);let o=this.gl,l=this.gpuStates;l.doubleSided!==n&&(n?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),l.doubleSided=n),l.flipSided===s&&l.orientation===a||(s?a>=0?o.frontFace(o.CW):o.frontFace(o.CCW):a>=0?o.frontFace(o.CCW):o.frontFace(o.CW),l.orientation=a,l.flipSided=s)}getDepthFunc(){return this.gpuStates.depthFunc}setDepthFunc(e){this.gpuStates.depthFunc=e}setDepthTest(e){this.gpuStates.depthTest=e}setColorWrite(e){}setDepthWrite(e){}setStencilWrite(e){}setLineWidth(e){let t=this.gpuStates;null!=e&&e!==t.lineWidth&&(this.gl.lineWidth(e),t.lineWidth=e)}setPolygonOffset(e,t,i){let r=this.gl,n=this.gpuStates;n.polygonOffset!==e&&(e?r&&r.enable(r.POLYGON_OFFSET_FILL):r&&r.disable(r.POLYGON_OFFSET_FILL),n.polygonOffset=e),!e||n.polygonOffsetFactor===t&&n.polygonOffsetUnits===i||(r&&r.polygonOffset(t,i),n.polygonOffsetFactor=t,n.polygonOffsetUnits=i)}setBlending(t,i,r,n){let s=this.gl,a=this.gpuStates;if(s&&t!==s._oldBlending){switch(t){case e.NoBlending:s.disable(s.BLEND);break;case e.AdditiveBlending:s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE);break;case e.SubtractiveBlending:s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.ONE_MINUS_SRC_COLOR);break;case e.MultiplyBlending:s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.SRC_COLOR);break;case e.CustomBlending:s.enable(s.BLEND);break;case e.NormalDepthBlending:s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.ZERO,s.ONE,s.ONE,s.ZERO);break;case e.AlphaBlending:s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA);break;case e.GroundShadowBlending:s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.ZERO,s.SRC_COLOR,s.ONE,s.ONE_MINUS_SRC_ALPHA);break;case e.TransparentShadowBlending:s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ZERO,s.ONE_MINUS_SRC_ALPHA);break;case e.OITAccumBlending:s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ONE);break;case e.OITRevealBlending:s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.ONE_MINUS_SRC_COLOR);break;default:s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)}s._oldBlending=t}t===e.CustomBlending?(i!==a.blendEquation&&(s&&s.blendEquation(this.paramThreeToGL(i)),a.blendEquation=i),r===a.blendSrc&&n===a.blendDst||(s&&s.blendFunc(this.paramThreeToGL(r),this.paramThreeToGL(n)),a.blendSrc=r,a.blendDst=n)):(a.blendEquation=null,a.blendSrc=null,a.blendDst=null)}generateDefines(e){var t,i,r=[];for(var n in e)!1!==(t=e[n])&&(i="#define "+n+" "+t,r.push(i));return r.join("\n")}_setShaderUtilsContext(e=!1,t=null,i=null,r=null,n=null,s=null){var a={isWebGPU:e,__uniforms__:t,__attributes__:i,__varyings__:r,__builtins__:n,__functions__:s,__fetchedUniforms__:t?{}:null};return y._context=a,_._context=a,v._context=a,S.FunctionHandler._context=a,m._context=a,a}buildProgram(t,i,r,n){let a=this.materialToUseList,o=this.gl,l=this.glSupports;var h,c,d="",u="",p={},f={},g={},S=i.defines||{};null===t&&(d=i.fragmentShader,u=i.vertexShader,p=i.uniforms,f=i.varyings,g=i.attributes,S=i.defines,c=[d,u].join());let x=this._setShaderUtilsContext(r.WebGPU,p,g,f,{},new Map);var b="SHADOWMAP_TYPE_BASIC";r.shadowMapType===e.PCFShadowMap?b="SHADOWMAP_TYPE_PCF":r.shadowMapType===e.PCFSoftShadowMap?b="SHADOWMAP_TYPE_PCF_SOFT":r.shadowMapType===e.PCFInterpolShadowMap?b="SHADOWMAP_TYPE_PCF_INTERPOL":r.shadowMapType===e.PCFPoissonShadowMap?b="SHADOWMAP_TYPE_PCF_POISSON":r.shadowMapType===e.PCFOptimizedShadowMap?b="SHADOWMAP_TYPE_PCF_OPTI":r.shadowMapType===e.ESMShadowMap?b="SHADOWMAP_TYPE_ESM":r.shadowMapType===e.ESMImprovedShadowMap&&(b="SHADOWMAP_TYPE_ESM_IMPROVED");var w="SHADOWMAP_QUALITY_LOW";r.shadowMapQuality===e.MediumQuality?w="SHADOWMAP_QUALITY_MEDIUM":r.shadowMapQuality===e.HighQuality&&(w="SHADOWMAP_QUALITY_HIGH"),r.shadowMapTypeDefine=b,r.shadowMapQualityDefine=w,r.useMRT=l&&!!l.glExtensionDrawBuffers;var M=this.generateDefines(S);r.customDefines=S,z(r);var C={WebGLVersion:r.WebGLVersion,WebGPU:r.WebGPU,vertexTextures:!l||l.supportsVertexTextures,renderToFloatTexture:!l||l.renderToFloatTexture,renderToHalfFloatTexture:!l||l.renderToHalfFloatTexture,maxTextureSize:l?l.maxTextureSize.toFixed(1):16384,fragDepth:!l||l.glExtensionFragDepth,drawBuffers:!l||l.glExtensionDrawBuffers,depthBits:e.supportedExtensions?e.supportedExtensions.depthBits:0},P="",E="",T=!1,A=null;if(r.PDSFX){var D={pixelLineDistance:r.cpuPattern,wideLine:r.wideLine,gammaOutput:r.gammaOutput,gammaInput:r.gammaInput,extDerivatives:r.extDerivatives,fixedSize:r.fixedSize,billboard:r.billboard,highlightMaterial:a.highlightMaterial};Object.assign(D,C);const t=e=>y.addPDSFXAttribute(e),n=e=>y.addPDSFXInstancingAttribute(e);var I;A=(I=i._PDSFXData)._uniqueID,j._initContext(r.customDefines,D,r),X._initContext(r.customDefines,D,r);var R="",O="",L="";if(I.pdsfxUniforms){var V=I.pdsfxUniforms;for(var F in V){var B=V[F],N=e.ToGLSLTypes[B.type];if(N){var G=`\n                    ${m.addPDSXUniform({uniformName:F,uniformType:B.type,size:B.length?B.length:0})}            \n                `;N.isInt?B.stage===ne?L=`\n                            ${L}\n                            ${G}\n                        `:O=`\n                            ${O}\n                            ${G}\n                        `:R=`\n                        ${R}\n                        ${G}\n                    `}}}var k="";if(I.pdsfxVaryings){var U=I.pdsfxVaryings;for(var H in U){var W=U[H];k=`\n                    ${k}\n                    ${v.addVarying({varyingName:"INTERNAL_PDSFX_CUSTOM_VARYING"+H,varyingType:W.type,size:W.length?W.length:0,checkName:!1})}\n                `}}var Z="";if(I.pdsfxAttributes){var Y=I.pdsfxAttributes;for(var Q in Y)Z=`\n                        ${Z}\n                        ${($=Y[Q]).instancing?n({attributeName:Q,attributeType:$.type}):t({attributeName:Q,attributeType:$.type})}\n                    `}if(I.pdsfxAttributesInternal){var K=I.pdsfxAttributesInternal;for(var Q in K){var $;Z=`\n                        ${Z}\n                        ${($=K[Q]).instancing?n({attributeName:Q,attributeType:$.type}):t({attributeName:Q,attributeType:$.type})}\n                    `}}var J=I._getGlobalVertexCode(X);T=J.includes("attribute ");var ee=[Z,k,R,O,s.PDSFX_common_pars(r),s.PDSFX_getters_vertex(r),J,`           \n                ${_.createStructure({structName:"TangentSpace",attributes:[{type:"v3",name:"Position"},{type:"v3",name:"Normal"},{type:"v3",name:"Tangent"},{type:"v3",name:"Binormal"}]})}\n                `,I._getPDSFXOverridableFunctions_VS(X)].join("\n"),te=I._getGlobalFragmentCode(j);r.pdsfxUseDiscard=I.PDSFX_OverridableFunctions_FS.ComputeDiscard&&I.PDSFX_OverridableFunctions_FS.ComputeDiscard!==s.PDSFXComputeDiscard_FS;var se=[k,R,L,s.PDSFX_common_pars(r),s.PDSFX_getters_fragment(r),te,I._getPDSFXOverridableFunctions_FS(j)].join("\n");if(I.CPULargeScale)r.largeScale=!1;else{var ae="vGetWorldViewMatrix",oe=[...ee.matchAll(ae)],le=[...se.matchAll(ae)];(oe&&oe.length>1||le&&le.length>1)&&(r.largeScale=!1)}r.useUV||(ae="vGetAttribTexCoord0",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.useUV=!0)),r.useUV||(ae="vGetAttribTexCoord1",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.useUV=!0)),r.useUV||(ae="vGetAttribTexCoord2",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.useUV=!0)),r.pdsfxUseTangentBinormal||(ae="vGetAttribTangent",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.pdsfxUseTangentBinormal=!0)),r.pdsfxUseTangentBinormal||(ae="vGetAttribBinormal",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.pdsfxUseTangentBinormal=!0)),r.pdsfxUseVertexColors||(ae="vGetAttribColor",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.pdsfxUseVertexColors=!0)),r.pdsfxUseVertexColors||(ae="_vGetAttribColorAlpha",(oe=[...ee.matchAll(ae)])&&oe.length>1&&(r.pdsfxUseVertexColors=!0)),r.useUV||(ae="vGetTexCoord0",(le=[...se.matchAll(ae)])&&le.length>1&&I.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord0===s.PDSFXComputeObjectTexCoord0_VS&&(r.useUV=!0)),r.useUV||(ae="vGetTexCoord1",(le=[...se.matchAll(ae)])&&le.length>1&&I.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord1===s.PDSFXComputeObjectTexCoord1_VS&&(r.useUV=!0)),r.useUV||(ae="vGetTexCoord2",(le=[...se.matchAll(ae)])&&le.length>1&&I.PDSFX_OverridableFunctions_VS.ComputeObjectTexCoord2===s.PDSFXComputeObjectTexCoord2_VS&&(r.useUV=!0)),r.pdsfxUseTangentBinormal||(ae="vGetViewTangent",(le=[...se.matchAll(ae)])&&le.length>1&&I.PDSFX_OverridableFunctions_VS.ComputeObjectTangent===s.PDSFXComputeObjectTexCoord0_VS&&(r.pdsfxUseTangentBinormal=!0)),r.pdsfxUseTangentBinormal||(ae="vGetViewBinormal",(le=[...se.matchAll(ae)])&&le.length>1&&I.PDSFX_OverridableFunctions_VS.ComputeObjectBinormal===s.PDSFXComputeObjectTexCoord0_VS&&(r.pdsfxUseTangentBinormal=!0)),j.dispose(),X.dispose(),P=ee,E=se}var he=t;"custom"===t?he=t+"_"+i.postProBuilder.getUniqueID():null===t&&(T=!0);var ce=[2===C.WebGLVersion?"#version 300 es":"",2===C.WebGLVersion?"#define GLSL300ES":"","precision "+this.precision+" float;","precision "+this.precisionInt+" int;",M,C.vertexTextures?"#define VERTEX_TEXTURES":"",C.renderToFloatTexture?"#define RENDER_TO_FLOAT_TEXTURE":"",C.renderToHalfFloatTexture?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"",ie(r),_.float({name:"MAX_TEXTURE_SIZE",constant:!0})+"="+C.maxTextureSize+";"].join("\n"),de=[2===C.WebGLVersion?"#version 300 es":"",2===C.WebGLVersion?"#define GLSL300ES":"",C.fragDepth?"#extension GL_EXT_frag_depth : enable":"",1===C.WebGLVersion?"#extension  GL_OES_standard_derivatives : enable":"",C.drawBuffers?"#extension GL_EXT_draw_buffers : require":"",C.renderToFloatTexture?"#define RENDER_TO_FLOAT_TEXTURE":"",C.renderToHalfFloatTexture?"#define RENDER_TO_HALF_FLOAT_TEXTURE":"","precision "+this.precision+" float;","precision "+this.precisionInt+" int;",M,re(r),_.float({name:"DEPTH_PRECISION",constant:!0})+"="+C.depthBits+";",_.float({name:"MAX_TEXTURE_SIZE",constant:!0})+"="+C.maxTextureSize+";"].join("\n");for(I=0,h=this.programs.length;I<h;I++){var ue=this.programs[I];if(ue.contextID===(o?o.contextId:0)&&ue.program._materialToUse===r.materialToUse&&ue.shaderID===he&&ue.pdsfx===r.PDSFX&&ue.pdsfx_uniqueID===A&&ue.code===c&&ue.prefix_vertex===ce&&ue.prefix_fragment===de&&(A||ue.pdsfx_fragment===E&&ue.pdsfx_vertex===P))return ue.usedTimes<=0&&(ue.program.id=this.programs_counter++),ue.usedTimes++,ue.program}var pe=new q;return pe._lightsKey=this.lightsKey,pe._ambianceKey=this.ambianceKey,pe._materialToUse=r.materialToUse,this.buildShader(i,t,r,pe,u,d,ce,de,P,E,n,T,x),pe.id=this.programs_counter++,this.programs.push({program:pe,code:c,usedTimes:1,prefix_vertex:ce,prefix_fragment:de,pdsfx_uniqueID:A,pdsfx_fragment:E,pdsfx_vertex:P,shaderID:he,pdsfx:r.PDSFX,contextID:o?o.contextId:0}),this.memoryInfo.programs=this.programs.length,pe}addLineNumbers(e){for(var t=e.split("\n"),i=0,r=t.length;i<r;i++)t[i]=i+1+": "+t[i];return t.join("\n")}isPowerOfTwo(e){return 0==(e&e-1)}filterFallback(t){return t===e.NearestFilter||t===e.NearestMipMapNearestFilter||t===e.NearestMipMapLinearFilter?this.gl.NEAREST:this.gl.LINEAR}setTextureParameters(t,i,r){let n=this.gl,s=this.glSupports;r?(n.texParameteri(t,n.TEXTURE_WRAP_S,this.paramThreeToGL(i.wrapS)),n.texParameteri(t,n.TEXTURE_WRAP_T,this.paramThreeToGL(i.wrapT)),n.texParameteri(t,n.TEXTURE_MAG_FILTER,this.paramThreeToGL(i.magFilter)),n.texParameteri(t,n.TEXTURE_MIN_FILTER,this.paramThreeToGL(i.minFilter))):(i.wrapS===e.ClampToEdgeWrapping&&i.wrapT===e.ClampToEdgeWrapping||i.wrapS===e._ClampToBorderWrapping&&i.wrapT===e._ClampToBorderWrapping||console.warn("Non power of two textures must be clamp to edge, falling back on it"),n.texParameteri(t,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_MAG_FILTER,this.filterFallback(i.magFilter)),n.texParameteri(t,n.TEXTURE_MIN_FILTER,this.filterFallback(i.minFilter))),s.glExtensionTextureFilterAnisotropic&&i.type!==e.FloatType&&(i.anisotropy>1||i.__oldAnisotropy)&&(n.texParameterf(t,s.glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,s.maxAnisotropy)),i.__oldAnisotropy=i.anisotropy)}initTexture(e,t){if(t)if(e.onUpdate){var i=e.onUpdate;e.onUpdate=function(){i(),t()}}else e.onUpdate=t;e._setupTexture(this.gl,this,this.isPowerOfTwo,this.paramThreeToGL,this.getInternalFormatFromFormatAndType,this.setTextureParameters,this.onTextureDispose,null,this.glSupports.maxCubemapSize)}setTexture(t,i){let r=this.gl;t.onRequest&&t.onRequest(),!t._isReady()&&t._substituteTexture&&(t=t._substituteTexture);var n=t.isCubeMap&&t.isCubeMap();if(!n&&t.lods&&t.lods.length){var s=t.usedTexture;if(-1===s)t.lastUsedTexture=-1;else{var a=t.textures[s];a&&a.loadEndStatus===e.AssetLoadingStatus.READY?(a.__webglInit||this.__glResources__.textureLODPool.add({textureLOD:t,lod:s,size:a.image?4*a.image.width*a.image.height:0}),t.lastUsedTexture=s,t=a):-1!==t.lastUsedTexture&&(t=t.textures[t.lastUsedTexture])}this.__glResources__.textureLODPool.removeUnusedTextures()}if(t.needsUpdate||t.forceUpdate)t._setupTexture(r,this,this.isPowerOfTwo,this.paramThreeToGL,this.getInternalFormatFromFormatAndType,this.setTextureParameters,this.onTextureDispose,i,this.glSupports.maxCubemapSize);else{if(!t.__webglTexture)return void this.setTexture(this._dummyTexture,i);r.activeTexture(r.TEXTURE0+i),r.bindTexture(n?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D,t.__webglTexture[0])}}setCubeTextureDynamic(e,t){let i=this.gl;e.onRequest&&e.onRequest(),i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_CUBE_MAP,e.__webglTexture[0])}setupFrameBuffer(e,t,i){let r=this.gl;if(r.bindFramebuffer(r.FRAMEBUFFER,e),t)for(let e=0;e<t.__webglTexture.length;e++)r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+e,i,t.__webglTexture[e],0)}setupRenderBuffer(e,t){let i=this.gl;i.bindRenderbuffer(i.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e)):i.renderbufferStorage(i.RENDERBUFFER,i.RGBA4,t.width,t.height)}setRenderTarget(t){let i=this.gpuStates;var r,n,s,a;t?this.RTTmatchViewport?(r=i.viewportWidth,n=i.viewportHeight,s=i.viewportX,a=i.viewportY):(r=t.width,n=t.height,s=0,a=0):(r=i.viewportWidth,n=i.viewportHeight,s=i.viewportX,a=i.viewportY),e.glStates.currentWidth===r&&e.glStates.currentHeight===n&&e.glStates.currentXOffset===s&&e.glStates.currentYOffset===a||(this.gl&&this.gl.viewport(s,a,r,n),this.gl&&this.gl.scissor(s,a,r,n),e.glStates.currentWidth=r,e.glStates.currentHeight=n,e.glStates.currentXOffset=s,e.glStates.currentYOffset=a)}updateRenderTargetMipmap(t){let i=this.gl;if(t instanceof e.WebGLRenderTargetCube){for(let e=0;e<t.__webglTexture.length;e++)i.bindTexture(i.TEXTURE_CUBE_MAP,t.__webglTexture[e]),i.generateMipmap(i.TEXTURE_CUBE_MAP);i.bindTexture(i.TEXTURE_CUBE_MAP,null)}else{for(let e=0;e<t.__webglTexture.length;e++)i.bindTexture(i.TEXTURE_2D,t.__webglTexture[e]),i.generateMipmap(i.TEXTURE_2D);i.bindTexture(i.TEXTURE_2D,null)}}getInternalFormatFromFormatAndType(t,i,r){let n=this.gl;if(2===e.WebGLVersion){switch(t){case n.RGBA:switch(i){case n.UNSIGNED_BYTE:return n.RGBA8;case n.BYTE:return n.RGBA8_SNORM;case n.HALF_FLOAT:return n.RGBA16F;case n.FLOAT:return n.RGBA32F}break;case n.RGB:switch(i){case n.UNSIGNED_BYTE:return n.RGB8;case n.BYTE:return n.RGB8_SNORM;case n.HALF_FLOAT:return n.RGB16F;case n.FLOAT:return r?n.R11F_G11F_B10F:n.RGB32F}break;case n.RED:switch(i){case n.UNSIGNED_BYTE:return n.R8;case n.BYTE:return n.R8_SNORM;case n.HALF_FLOAT:return n.R16F;case n.FLOAT:return n.R32F}break;case n.RG:switch(i){case n.UNSIGNED_BYTE:return n.RG8;case n.BYTE:return n.RG8_SNORM;case n.HALF_FLOAT:return n.RG16F;case n.FLOAT:return n.RG32F}}return t}return t}allocateLights(e){var t,i,r,n={dirLights:0,dirIBLLights:0,dirPhongLights:0,pointLights:0,spotLights:0,sphereLights:0,rectangleLights:0,iesLights:0,tubeLights:0,diskLights:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).onlyShadow||r.allocate(n);return{directional:n.dirLights,directionalIBL:n.dirIBLLights,directionalPhong:n.dirPhongLights,point:n.pointLights,spot:n.spotLights,sphere:n.sphereLights,rectangle:n.rectangleLights,ies:n.iesLights,tube:n.tubeLights,disk:n.diskLights}}allocateShadows(e){var t,i,r,n={dirLight:0,dirIBLLight:0,spotLight:0,tex2d:0,texCube:0};for(t=0,i=e.length;t<i;t++)(r=e[t]).castShadow&&r.allocateShadows(this,n);return n}getSupportedExtensions(){return e.supportedExtensions}loadUniformsGeneric(e,t){}restoreGLContext(){}getContext(){return this.gl}supportsVertexTextures(){return this.glSupports.supportsVertexTextures}supportsFloatTextures(){let e=this.glSupports;return!e||e.glExtensionTextureFloat&&(e.glExtensionColorBufferFloat||e.renderToFloatTexture)}supportsHalfFloatTextures(){let e=this.glSupports;return!e||e.glExtensionTextureHalfFloat&&(e.glExtensionColorBufferHalfFloat||e.renderToHalfFloatTexture)}getRendererInfo(){return this.rendererInfo}supportsFloatLinearTextures(){return!this.glSupports||this.glSupports.glExtensionTextureFloatLinear}supportsHalfFloatLinearTextures(){return this.glSupports.glExtensionTextureHalfFloatLinear}supportsStandardDerivatives(){return this.glSupports.glExtensionStandardDerivatives}supportsCompressedTextureS3TC(){return this.glSupports.glExtensionCompressedTextureS3TC}supportsMinMaxBlending(){return this.glSupports.glExtensionBlendMinMax}supportsElementIndexUint(){return this.glSupports.glExtensionElementIndexUint||2===e.WebGLVersion}supportsDrawBuffers(){return!this.glSupports||this.glSupports.glExtensionDrawBuffers}getMaxAnisotropy(){return this.glSupports.maxAnisotropy}getPrecision(){return this.precision}setGLSize(t,i,r,n,s,a){this.devicePixelRatio=this._renderScale*(e.getDevicePixelRatio()||1),this.canvas.width=Math.floor(t*this.devicePixelRatio),this.canvas.height=Math.floor(i*this.devicePixelRatio),this._VRCompatible?(this.canvas.style.width="100%",this.canvas.style.height="100%"):(this.canvas.style.width=s+"px",this.canvas.style.height=a+"px"),this.setViewport(0,0,Math.floor(r*this.devicePixelRatio),Math.floor(n*this.devicePixelRatio)),this.width=t,this.height=i,this.widthHalf=this.width/2,this.heightHalf=this.height/2,this.divCSS3DRoot.style.width=t+"px",this.divCSS3DRoot.style.height=i+"px";for(var o=0;o<this.divCSS3DRoot.childNodes.length;o++){var l=this.divCSS3DRoot.childNodes[o];l.style.width=t+"px",l.style.height=i+"px"}}setViewport(t,i,r,n){let s=this.gpuStates;var a=s.viewportX,o=s.viewportY,l=s.viewportWidth,h=s.viewportHeight;s.viewportX=void 0!==t?t:0,s.viewportY=void 0!==i?i:0,s.viewportWidth=void 0!==r?r:this.canvas.width,s.viewportHeight=void 0!==n?n:this.canvas.height,s.viewportX===a&&s.viewportY===o&&e.glStates.currentXOffset===s.viewportX&&e.glStates.currentYOffset===s.viewportY&&s.viewportWidth===l&&s.viewportHeight===h&&e.glStates.currentWidth===s.viewportWidth&&e.glStates.currentHeight===s.viewportHeight||this.gl&&this.gl.viewport(s.viewportX,s.viewportY,s.viewportWidth,s.viewportHeight),e.glStates.currentWidth=s.viewportWidth,e.glStates.currentHeight=s.viewportHeight,e.glStates.currentXOffset=s.viewportX,e.glStates.currentYOffset=s.viewportY,s.viewportInvWidth=1/s.viewportWidth,s.viewportInvHeight=1/s.viewportHeight}removeSplitScreenMode(){this.splitScreenMode&&(this.activateSplitScreenMode(!1),this.splitScreenMode=null)}setSplitScreenMode(e,t){this.splitScreenMode={x:e,y:t,active:!1},this.activateSplitScreenMode(!0)}activateSplitScreenMode(e){let t=this.gpuStates;this.splitScreenMode&&e!==this.splitScreenMode.active&&(e?(this.setScissor(this.splitScreenMode.x,this.splitScreenMode.y,t.viewportWidth,t.viewportHeight),this.enableScissorTest(!0),this.setViewport(this.splitScreenMode.x,this.splitScreenMode.y,t.viewportWidth,t.viewportHeight)):(this.enableScissorTest(!1),this.setViewport(0,0,t.viewportWidth,t.viewportHeight)),this.splitScreenMode.active=!!e)}getViewportSize(){let e=this.gpuStates;return{width:e.viewportWidth,height:e.viewportHeight}}getViewport(){let e=this.gpuStates;return{width:e.viewportWidth,height:e.viewportHeight,x:e.viewportX,y:e.viewportY}}setScissor(e,t,i,r){let n=this.gpuStates;n.scissorRect.x=e,n.scissorRect.y=t,n.scissorRect.width=i,n.scissorRect.height=r,this.gl.scissor(e,t,i,r)}enableScissorTest(e){let t=this.gl;this.gpuStates.scissor=e,t&&(e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST))}getScissorTest(){return this.gpuStates.scissor}setClearColor(e,t){let i=this.gpuStates;i.clearColor.copy(e),i.clearAlpha=t,this.gl&&this.gl.clearColor(i.clearColor.r,i.clearColor.g,i.clearColor.b,i.clearAlpha)}getClearColor(){return this.gpuStates.clearColor}getClearAlpha(){return this.gpuStates.clearAlpha}clear(e,t,i){}clearTarget(e,t,i,r){this.setRenderTarget(e),this.clear(t,i,r)}_getReflectionColorBufferResult(e){return this.reflectionColorBuffer&&!e?this.reflectionColorBuffer.getResult("RayMarching"):this.dummySSLRTexture}_getRefractionColorBufferResult(e){return this.refractionColorBuffer&&!e?this.refractionColorBuffer.getResult("RayMarching"):this.dummySSLRTexture}_getAOBufferResult(e){return this.aoBuffer&&!e?this.aoBuffer.getResult("SSAO"):this.dummySSAOTexture}addPostPlugin(e){e.init(this),this.renderPluginsPost.push(e)}addPrePlugin(e){e.init(this),this.renderPluginsPre.push(e)}updateShadowMap(e,t){let i=this.gpuStates;this.gl._currentProgram=null,this.gl._oldBlending=-1,i.depthTest=-1,i.colorWrite=-1,i.depthWrite=-1,this.currentGeometryGroupHash=-1,this.currentVertexBuffer=-1,this.currentIndexBuffer=-1,this.currentMaterialId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0,i.doubleSided=-1,i.flipSided=-1,this.shadowMapPlugin.update(e,t)}epsilon(e){return Math.abs(e)<1e-6?0:e}getCameraCSSMatrix(e){var t=e.elements;return"matrix3d("+this.epsilon(t[0])+","+this.epsilon(-t[1])+","+this.epsilon(t[2])+","+this.epsilon(t[3])+","+this.epsilon(t[4])+","+this.epsilon(-t[5])+","+this.epsilon(t[6])+","+this.epsilon(t[7])+","+this.epsilon(t[8])+","+this.epsilon(-t[9])+","+this.epsilon(t[10])+","+this.epsilon(t[11])+","+this.epsilon(t[12])+","+this.epsilon(-t[13])+","+this.epsilon(t[14])+","+this.epsilon(t[15])+")"}getObjectCSSMatrix(e){var t=e.elements;return"translate3d(-50%,-50%,0) matrix3d("+this.epsilon(t[0])+","+this.epsilon(t[1])+","+this.epsilon(t[2])+","+this.epsilon(t[3])+","+this.epsilon(-t[4])+","+this.epsilon(-t[5])+","+this.epsilon(-t[6])+","+this.epsilon(-t[7])+","+this.epsilon(t[8])+","+this.epsilon(t[9])+","+this.epsilon(t[10])+","+this.epsilon(t[11])+","+this.epsilon(t[12])+","+this.epsilon(t[13])+","+this.epsilon(t[14])+","+this.epsilon(t[15])+")"}_cleanProgramPool(e){if(this.tryCleanPrograms&&e){if(this.programs.filter(e=>e.usedTimes<=0||null===e.program).length>0){for(var t=[],i=0;i<this.programs.length;i++){var r=this.programs[i];null!==r.program&&(r.usedTimes<=0?(this.gl&&this.gl.deleteProgram(r.program.program),this&&this.memoryInfo.programs--):t.push(r))}this.programs=t}this.tryCleanPrograms=!1}}initSharedBuffersDS(e,t){}renderBufferDirect(t,i,r,n,s){if(!1===r.visible)return;let a=this.gl;var o,l,h,c,d,u,p,f=!1;l=(o=this.setProgram(t,i,r,s,void 0,n,r.programManager.getProgramID(s,null),null,this.materialToUse)).attributes,h=n.attributes;var g=!1,m=r.wireframe?1:0,v=16777215*n.id+2*o.id+m;if(v!==this.currentGeometryGroupHash&&(this.currentGeometryGroupHash=v,g=!0),g&&this.disableAttributes(),s instanceof e.Mesh){var _=h.index;if(_){var y=n.offsets;y.length>1&&(g=!0);for(var S=0,x=y.length;S<x;S++){var b=y[S].index;if(g){for(d in h)"index"!==d&&(u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,b*p*4)));a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,_.buffer)}a.drawElements(A.TRIANGLES,y[S].count,a.UNSIGNED_SHORT,2*y[S].start),this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=y[S].count,this.currentRenderInfo.faces+=y[S].count/3,f=!0}}else{if(g)for(d in h)"index"!==d&&(u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,0)));var w=n.attributes.position;a.drawArrays(A.TRIANGLES,0,w.numItems/3),f=!0,this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=w.numItems/3,this.currentRenderInfo.faces+=w.numItems/3/3}}else if(s instanceof e.ParticleSystem){if(g){for(d in h)u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,0));w=h.position,a.drawArrays(a.POINTS,0,w.numItems/3),f=!0,this.currentRenderInfo.calls++,this.currentRenderInfo.points+=w.numItems/3}}else if(s instanceof e.Line&&g){for(d in h)u=l[d],p=(c=h[d]).itemSize,u>=0&&(a.bindBuffer(a.ARRAY_BUFFER,c.buffer),this.enableAttribute(u),a.vertexAttribPointer(u,p,a.FLOAT,!1,0,0));this.setLineWidth(r.lineWidth),w=h.position,a.drawArrays(A.LINE_STRIP,0,w.numItems/3),f=!0,this.currentRenderInfo.calls++,this.currentRenderInfo.points+=w.numItems}return f}getRenderMode(t=null,i=!1){let r=this.materialToUseList;var n=e.RenderMode;F||(F=new n);var s=e.PickingMode;B||(B=new s);var a=this.renderLineMode||0,o=this.renderPointMode||0,l=this.renderFaceMode,h=this.outlineWidth,c=this.halfVisibleSmoothEdges?1:0,d=this.renderHiddenEdges?1:0;let u=!1;var p=F;if(t){var f=null,g=t._occurrence;if(g){var m=g.renderMode;if(m){if(m._repViewNothing&&(u=!0),h=m._outlineWidth,m._halfVisibleSmoothEdges>-1&&(c=m._halfVisibleSmoothEdges),m._hiddenEdges>-1&&(d=m._hiddenEdges),m._hasReplaceMask&&m._hasReplaceMask()){F._setFromMasks(o,a,l);var v=new n;v._setReplace(F,m),m=v}m._useRenderLineMask&&(a=m.getMasks()[1]),m._useRenderPointMask&&(o=m.getMasks()[2]),m._useRenderFaceMask&&(l=m.getMasks()[0])}f=g.pickingMode}i||!r.highlightMaterial&&!r.pickingPassMaterial||(f||(f=B)._fromRenderer(this),p._setFromMasks(o,a,l),[l,a,o]=f.getPickingMasks(p),r.normalMaterial&&(a&=~E,o&=~T),r.highlightMaterial&&(l|=G.FACE))}return p.setRepViewNothing(u),p._setFromMasks(o,a,l),p.setOutlineWidth(h),p.setHalfVisibleSmoothEdges(c),p.setHiddenEdges(d),p}getMaterialMode(e=null,t=null,i=!1){if(e){if(e._occurrence&&null!==e._occurrence.faceMode)return e._occurrence.faceMode.material;if(e.materialMode<2)return!!e.materialMode}var r=!1;return null!==t&&(r=!t.areFacesVisible()),!i&&this.materialMode&&!r}getRenderLineMode(e){var t=e&&e._occurrence&&e._occurrence.renderMode;return t&&t._useRenderLineMask?t.getMasks()[1]:this.renderLineMode}recompileAllShaders(e){e=e||le;for(var t=0;t<e.length;t++)this.shaderVersions[e[t]]++}setupPickingMaterial(e,t,i){var r=i.pickingID>>16&255,n=(i.pickingID>>8&255)/255,s=(255&i.pickingID)/255;t==A.LINES||e&&e.lineWidth?r|=64:t!=A.TRIANGLES&&null!=t||(r|=128),I.setRGB(r/255,n,s)}enableAttributes(e){let t=this.gl;if(t){for(var i in e)t._enabledAttributes[i]||(t.enableVertexAttribArray(i),t._enabledAttributes[i]=!0);for(var i in t._enabledAttributes)t._enabledAttributes[i]&&!e[i]&&(t.disableVertexAttribArray(i),t._enabledAttributes[i]=!1)}}renderInterval(e,t,i,r,n,s,a,o,l,h,c,u,p,f,g,m){let v=this.gl,_=this.gpuStates;this.currentRenderInfo.nbDGs++;var y=a.glType,S=0;if(M||!M&&!C){var x=a.cullingData;if(x&&!e.isOrtho){var b=y===A.TRIANGLES?l/3:l/2;if((b/=x.length)>this.ratioSSB){var w=e.performPixelCullingOnDG(i,s,a,o,l);if(this.currentRenderInfo.nbDGsSSBProcessed++,y===A.TRIANGLES?this.currentRenderInfo.culledDGTriangles+=(l-w)/3:y===A.LINES&&(this.currentRenderInfo.culledDGLines+=(l-w)/2),this.colorizeSSB?S=1-w/(l+1):l=w,0===l)return!1}}}let P=this.materialToUseList;var E,T,D=null,R=a._instancingInfos?a._instancingInfos:i._instancingInfos?i._instancingInfos:null,O=R?R.instanceAttribArrays:null,L=null!==O,V=s.vertexBufferGPU,F=s.indexBufferGPU,B=!1;R&&(this.bufferGPUManager.deallocate(R.staleGLBuffers),R.staleGLBuffers=[],L||(a._instancingInfos?a._instancingInfos=null:i._instancingInfos&&(i._instancingInfos=null))),s.needsUpdate&&(s.needsUpdate=!1,s.deallocate(v,this.info),B=!0);var N=v?v._currentProgram:0,G=r.programManager.getTokenProgramID(p);r.program&&r.program.shaderIO;let U=null;if(u||G!==this.currentProgramID)r.previousOccurrenceRenderingOverride=null,this.setProgram(e,t,r,i,c,s,G,f,g,m),this.use_webgpu&&(U=this.setRenderPipeline(r,i,s,!1));else if(this.use_webgpu)U=this.setRenderPipeline(r,i,s,!0);else{var z=r.program.objectUniformLocations;this[z.funcName](z,i,s,r,e,t,f),f&&f._mappingOperator&&f._loadMappingOperatorUniforms(r,this,v)}if(this.use_webgpu){var H=i._webgpuBinding[r.id];this.setBindGroup(U.layoutOrder.indexOf("Object"),H.bindGroup),this.prevObjectBindGroupIsDefault=H.isDefault,-1!==U.layoutOrder.indexOf("Light")&&this.setBindGroup(U.layoutOrder.indexOf("Light"),this.webgpuLightBinding.bindGroup)}else{if(g){var W=r.program.uniformLocations;this.loadGASUniforms(v,r,W,c,g)}if(P.pickingMaterial)this.setupPickingMaterial(r,y,i),(W=r.program.uniformLocations).pickingColor?v.uniform3f(W.pickingColor,I.r,I.g,I.b):v.uniform3f(W.diffuse,I.r,I.g,I.b);else if(i._applyPlaneViewMode===k.LOWLIGHT||i._applyPlaneViewMode===k.LOWLIGHT_NO_PICK)(W=r.program.uniformLocations).diffuse&&v.uniform3f(W.diffuse,.26,.4,.33),this.diffuseModified=!0;else if(this.colorizeSSB&&S)(W=r.program.uniformLocations).diffuse&&v.uniform3f(W.diffuse,S,0,0);else if(this.diffuseModified){if((W=r.program.uniformLocations)&&W.diffuse){var j=v.getUniform(r.program.program,W.diffuse);j&&.26===j.r&&.4===j.g&&.33===j.b&&v.uniform3f(W.diffuse,r.color.r,r.color.g,r.color.b)}this.diffuseModified=!1}if(!P.shadowMaterial&&!P.transparentShadowMaterial&&(r.map&&r.map.lods&&r.map.chooseTexture(e,i),r._PDSFXData&&r._PDSFXData.pdsfxTextures))for(let t=0;t<r._PDSFXData.pdsfxTextures.length;t++)r._PDSFXData.pdsfxTextures[t].value&&r._PDSFXData.pdsfxTextures[t].value.lods&&r._PDSFXData.pdsfxTextures[t].value.chooseTexture(e,i);P.positionMaterial&&(W=r.program.uniformLocations).positionComponent&&v.uniform3f(W.positionComponent,this.positionComponent.x,this.positionComponent.y,this.positionComponent.z)}E=r.program,T=E.attributes,D=E.instanceAttributes;var X=!1,q=f&&f._mappingOperator?f._mappingOperator.mappingType:r.mappingType;!(E.uvOrBinOrTan&&q<1)||s.compressedNormals||s.vertexBufferGPU&&s.vertexBufferGPU.layout.has("uv")||(s.vertexIndexArray?(s.computeUVs(),s.deallocate(v,this.info),B=!0):this._NoMeshInRamWarningCount<1&&(console.warn("uv computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++));var Z=q<1&&(r.requireVertexTangentBinormal()||this.forceCPUTBCompute);if(s.vertexBufferGPU?!(Z&&s.vertexBufferGPU.layout.has("uv")&&s.vertexBufferGPU.layout.has("normal"))||s.vertexBufferGPU.layout.has("binormal")&&s.vertexBufferGPU.layout.has("tangent")||(s.vertexIndexArray?(s.computeTangents(),s.deallocate(v,this.info),B=!0):this._NoMeshInRamWarningCount<2&&(console.warn("tangent binormal computation unavailable in noMeshInRAM mode"),this._NoMeshInRamWarningCount++)):!(s.vertexUvArray&&s.vertexNormalArray&&Z)||s.vertexBinormalArray&&s.vertexTangentArray||(s.computeTangents(),s.deallocate(v,this.info),B=!0),V&&F||(B=!0),L)for(var Y in this.currentInstanceAttribsId!==O.id&&(this.currentInstanceAttribsId=O.id,X=!0),O)if("id"!==Y){if(!O[Y].buffer){this.bufferGPUManager.allocateInstancingBuffers(i,a);break}O[Y].isDynamic&&(v.bindBuffer(v.ARRAY_BUFFER,O[Y].buffer),v.bufferData(v.ARRAY_BUFFER,O[Y].array,v.DYNAMIC_DRAW),O[Y].isDynamic=!1)}if(B&&(this.bufferGPUManager.allocateDirect(s),V=s.vertexBufferGPU,F=s.indexBufferGPU),!V||!F)return!1;if(s._uploadStaleIndices(v),s._uploadStaleVertices(v),V!==this.currentVertexBuffer&&(this.currentVertexBuffer=V,X=!0),X){if(this.currentRenderInfo.swapBuffers++,this.currentRenderInfo.unsharedBuffers+=s.sharedBuffers&&!V.isShared?1:0,v&&v.bindBuffer(v.ARRAY_BUFFER,V.buffer),V.layout.forEach(function(e){const t=T[e.name];if(!Number.isInteger(t)||t<0)return;const i=d.VertexAttribute[e.type];v&&v.vertexAttribPointer(t,i.components,i.native,i.normalized,e.stride,e.offset)}),L)for(var Q in O)"id"!==Q&&(v.bindBuffer(v.ARRAY_BUFFER,O[Q].buffer),D[Q]>=0&&O[Q].array&&(O[Q].isMat4?(v.vertexAttribPointer(D[Q],O[Q].itemSize,v.FLOAT,!1,64,0),v.vertexAttribPointer(D[Q]+1,O[Q].itemSize,v.FLOAT,!1,64,16),v.vertexAttribPointer(D[Q]+2,O[Q].itemSize,v.FLOAT,!1,64,32),v.vertexAttribPointer(D[Q]+3,O[Q].itemSize,v.FLOAT,!1,64,48)):v.vertexAttribPointer(D[Q],O[Q].itemSize,v.FLOAT,!1,0,0)));this.use_webgpu&&this.currentRenderState.currentPassGPU.setVertexBuffer(0,V.buffer,0)}if(F!==this.currentIndexBuffer&&(this.currentIndexBuffer=F,v&&v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,F.buffer),this.use_webgpu&&this.currentRenderState.currentPassGPU.setIndexBuffer(F.buffer,F.format,0)),v&&N!=v._currentProgram){var K={};if(L)for(var Q in O)"id"!==Q&&D[Q]>=0&&(O[Q].isMat4?(K[D[Q]]=!0,K[D[Q]+1]=!0,K[D[Q]+2]=!0,K[D[Q]+3]=!0):K[D[Q]]=!0);i.isCurvedPipe&&(D.specialMeshIds>=0&&(K[D.specialMeshIds]=!0),D.specialMeshPicking>=0&&p.autoInstancingData.pickingColorBuffer?K[D.specialMeshPicking]=!0:D.specialMeshPicking=-1),V.layout.forEach(function(e){const t=T[e.name];!Number.isInteger(t)||t<0||(K[t]=!0)}),this.enableAttributes(K)}var $=!1,J=!1;if(h&&h.scissor&&"box"===h.scissor.type){$=!0;var ee,te,ie,re,ne=h.scissor.data;ne.updateClipRect(e,this.currentFrameIndex,_.viewportWidth,_.viewportHeight),v.enable(v.SCISSOR_TEST),_.scissor?(ee=Math.max(_.scissorRect.x,ne.clipX0),te=Math.max(_.scissorRect.y,ne.clipY0),ie=Math.min(_.scissorRect.x+_.scissorRect.width,ne.clipX1)-ee,re=Math.min(_.scissorRect.y+_.scissorRect.height,ne.clipY1-te)):(ee=ne.clipX0,te=ne.clipY0,ie=ne.clipX1-ne.clipX0,re=ne.clipY1-ne.clipY0),v.scissor(ee,te,ie,re),(ee+ie<0||te+re<0||ee>_.viewportWidth||te>_.viewportHeight)&&(J=!0)}if(!J)if(p)this.use_webgpu?a.glType===A.TRIANGLES&&this.currentRenderState.currentPassGPU.drawIndexed(l,1,o):p.draw(v,p,l,this.glSupports.DSInstancedArrays,O,D);else{const e=s.indexBufferGPU,t=y===A.TRIANGLES||y===A.TRIANGLE_STRIP;r.wireframe&&t?v.drawElements(A.LINE_STRIP,l,e.glFormat,o*e.bytesPerIndex):y===A.POINTS&&s.vertexPositionArray&&s.vertexPositionArray.nonindexedPoints?v.drawArrays(y,s.vertexIndexArray[o],l):a.nonIndexed?v.drawArrays(y,o,l):this.use_webgpu?this.currentRenderState.currentPassGPU.drawIndexed(l):v.drawElements(y,l,e.glFormat,(s.indexOffsetGPU+o)*e.bytesPerIndex)}return $&&(_.scissor?v.enable(v.SCISSOR_TEST):v.disable(v.SCISSOR_TEST),_.scissorRect.x!==-1/0&&v.scissor(_.scissorRect.x,_.scissorRect.y,_.scissorRect.width,_.scissorRect.height)),this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=l,y===A.TRIANGLES?this.currentRenderInfo.faces+=l/3:y===A.LINES?this.currentRenderInfo.lines+=l/2:y===A.POINTS&&(this.currentRenderInfo.points+=l),!0}renderSectionLines(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g){if(r.__isSectionLine){var m=0;for(m=0;m<this._clipPlanes.length;m++)if(this._clipPlanes.sectionLines[m]){var v=r.program;r.clipPlaneIndex=m+1,v&&v.program===this.gl._currentProgram&&this.gl.uniform1i(v.pdsfxUniformLocations.currentClipPlane,m),this._clipPlanesState.update(h,null,!0,r,e,!0),this.renderInterval.apply(this,arguments)}r.clipPlaneIndex=0,this._clipPlanesState.update(h,null,!0,r,e,!1)}else this.renderInterval.apply(this,arguments)}renderBuffer(t,i,r,n,s,a){if(!1===r.visible)return!1;let o=this.gl;var l,h,c,d,u,p;h=(l=this.setProgram(t,i,r,s,a,null,r.programManager.getProgramID(s,null),null,null,this.materialToUse)).attributes,this.materialToUseList.pickingMaterial&&(this.setupPickingMaterial(r,null,s),r.program.uniformLocations.pickingColor?o.uniform3f(r.program.uniformLocations.pickingColor,I.r,I.g,I.b):o.uniform3f(r.program.uniformLocations.diffuse,I.r,I.g,I.b));var f=!1,g=r.wireframe?1:0,m=16777215*n.id+2*l.id+g;if(m!==this.currentGeometryGroupHash&&(this.currentGeometryGroupHash=m,f=!0),f&&this.disableAttributes(),!r.morphTargets&&h.position>=0?f&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglVertexBuffer),this.enableAttribute(h.position),o.vertexAttribPointer(h.position,3,o.FLOAT,!1,0,0)):s.morphTargetBase&&this.setupMorphTargets(r,n,s),f){if(n.__webglCustomAttributesList)for(u=0,p=n.__webglCustomAttributesList.length;u<p;u++)h[(d=n.__webglCustomAttributesList[u]).buffer.belongsToAttribute]>=0&&(o.bindBuffer(o.ARRAY_BUFFER,d.buffer),this.enableAttribute(h[d.buffer.belongsToAttribute]),o.vertexAttribPointer(h[d.buffer.belongsToAttribute],d.size,o.FLOAT,!1,0,0));h.color>=0&&n.__colorArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglColorBuffer),this.enableAttribute(h.color),o.vertexAttribPointer(h.color,3,o.FLOAT,!1,0,0)),h.normal>=0&&n.__normalArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglNormalBuffer),this.enableAttribute(h.normal),o.vertexAttribPointer(h.normal,3,o.FLOAT,!1,0,0)),h.tangent>=0&&n.__tangentArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglTangentBuffer),this.enableAttribute(h.tangent),o.vertexAttribPointer(h.tangent,4,o.FLOAT,!1,0,0)),h.uv>=0&&n.__uvArray&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglUVBuffer),this.enableAttribute(h.uv),o.vertexAttribPointer(h.uv,2,o.FLOAT,!1,0,0)),h.uv2>=0&&n.__uv2Array&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglUV2Buffer),this.enableAttribute(h.uv2),o.vertexAttribPointer(h.uv2,2,o.FLOAT,!1,0,0)),(s._skinning||s._skinningInstancing)&&h.skinIndex>=0&&h.skinWeight>=0&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglSkinIndicesBuffer),this.enableAttribute(h.skinIndex),o.vertexAttribPointer(h.skinIndex,4,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,n.__webglSkinWeightsBuffer),this.enableAttribute(h.skinWeight),o.vertexAttribPointer(h.skinWeight,4,o.FLOAT,!1,0,0)),h.lineDistance>=0&&(o.bindBuffer(o.ARRAY_BUFFER,n.__webglLineDistanceBuffer),this.enableAttribute(h.lineDistance),o.vertexAttribPointer(h.lineDistance,2,o.FLOAT,!1,0,0))}return s instanceof e.Mesh?(r.wireframe?(this.setLineWidth(r.wireframeLinewidth),f&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n.__webglLineBuffer),o.drawElements(A.LINES,n.__webglLineCount,o.UNSIGNED_SHORT,0)):(f&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n.__webglFaceBuffer),o.drawElements(A.TRIANGLES,n.__webglFaceCount,o.UNSIGNED_SHORT,0)),this.currentRenderInfo.calls++,this.currentRenderInfo.vertices+=n.__webglFaceCount,this.currentRenderInfo.faces+=n.__webglFaceCount/3):s instanceof e.Line?(c=s.type===e.LineStrip?A.LINE_STRIP:A.LINES,this.setLineWidth(r.lineWidth),o.drawArrays(c,0,n.__webglLineCount),this.currentRenderInfo.calls++):s instanceof e.ParticleSystem&&(o.drawArrays(o.POINTS,0,n.__webglParticleCount),this.currentRenderInfo.calls++,this.currentRenderInfo.points+=n.__webglParticleCount),!0}enableAttribute(e){let t=this.gl;t._enabledAttributes[e]||(t.enableVertexAttribArray(e),t._enabledAttributes[e]=!0)}disableAttributes(){let e=this.gl;for(var t in e._enabledAttributes)e._enabledAttributes[t]&&(e.disableVertexAttribArray(t),e._enabledAttributes[t]=!1)}setupMorphTargets(e,t,i){}isQAAutomationMode(){return this._defaultAppearanceType===e.DefaultAppearanceMode.__QA_AUTOMATION__}_getDefaultAppearanceType(){let e=this.materialToUseList;var t=this._defaultAppearanceType;return(e.zOnlyPass||e.dialogPass)&&(t=Z.BASIC),t}getStateSortedObjects(t,r){let n=this.materialToUseList;var s=this.camera,a=this.scene;this.sortCount++;var o=r.getDisplayListByName("DEPTHVALUE"),l=r.getDisplayListByName("DEPTHVALUE2"),h=r.getDisplayListByName("EDGE"),c=r.getDisplayListByName("OUTLINE"),d=r.getDisplayListByName("POINT"),u=r.getDisplayListByName("SOLID"),p=r.getDisplayListByName("SURFACE"),f=r.getDisplayListByName("SURFACE_CURVED_PIPE"),g=r.getDisplayListByName("SURFACE_CURVED_PIPE_TRANSPAR"),m=r.getDisplayListByName("BACK"),v=r.getDisplayListByName("NOZ"),_=r.getDisplayListByName("DECALS"),y=r.getDisplayListByName("RenderDepth"),S=r.getDisplayListByName("TRANSPAR"),x=r.getDisplayListByName("TRANSPAR1D"),b=r.getDisplayListByName("NOZTRANSPAR"),w=r.getDisplayListByName("EDGEPRIMITIVESELECTION"),M=(r.getDisplayListByName("EDGEADJACENCESELECTION"),r.getDisplayListByName("POINTPRIMITIVESELECTION")),C=this._getDefaultAppearanceType(),P=C===e.DefaultAppearanceMode.__QA_AUTOMATION__,A=[d,h,p,p,v,u],D=[this.monoTransparDL?S:x,this.monoTransparDL?S:x,S,S,b,S],I=(n.originalMaterial&&!this._debugMaterialMode||n.transparentShadowMaterial||n.pickingPassMaterial||n.zOnlyMaterial)&&!this.cuttingScene,R=this.newHLPOC&&!e.__unrolledHighlight()||P,O=e.GeomTypeEnum._OUTLINE,L=this;const F={outlinesCreated:!1,objectWithTransientGSSO:new Set,sortCount:this.sortCount,outlinesCameraDirection:null};this._inheritanceSolver.setFrameContext(function(t,i,s,v,b){if(s._sceneGraphOrderMode)return 2==s._sceneGraphOrderMode?{mainDL:o,subDL:null}:{mainDL:l,subDL:null};if(i&&i._geomType===O||s.defines&&void 0!==s.defines.NB_OUTLINE_MAPS)return{mainDL:c,subDL:null};if(s.isBackMaterial)return{mainDL:m,subDL:null};var C;if(n.pickingPassMaterial&&r._pickingPriorityMapping&&t.pickingPriorityID){var F=t.pickingPriorityID.points;if(i.glType>=4?F=t.pickingPriorityID.faces:i.glType>=1&&(F=t.pickingPriorityID.edges),F&&(C=r._pickingPriorityMapping[F]),C)return{mainDL:C,subDL:null}}if(null!==t.renderDepth&&L._useRenderDepthDL)return{mainDL:y,subDL:null};var B=t._priorityMode,G=v&&v!==i?v.noZ:-1,k=G>=0?G:i&&i._noZPriority>=0?i._noZPriority:t&&t._noZPriority?4:-1;-1==k&&b&&b._type==e.GASTypeEnum.NOZ&&(k=b._priority);var U=null;if(k>=0&&!(i._geomType&e.NoNoZPriorityMask))switch(B){case e.PriorityMode.ClassicPriority2D:U=b&&b._type==e.GASTypeEnum.NOZ&&b._transparent?r.getDisplayListByPriority(k):r.getDisplayListByPriority(e.displayListPriorityEnum.priority[k]);break;case e.PriorityMode.ClassicPriority:U=r.getDisplayListByPriority(e.displayListPriorityEnum.priority[k]);break;case e.PriorityMode.Advanced:U=r.getDisplayListByPriority(e.displayListPriorityEnum.priorityP[k]);break;case e.PriorityMode.SceneGraphOrder:U=r.getDisplayListByPriority(e.displayListPriorityEnum.OTHER3D);break;case e.PriorityMode.DepthPriority:U=b&&b._type==e.GASTypeEnum.NOZ&&b._transparent?r.getDisplayListByPriority(k):r.getDisplayListByPriority(e.displayListPriorityEnum.OTHER2D)}var z=null;if(n.highlightMaterial&&(a.highlightData._needsDepth||P))if((t._programID&V.PRIMITIVE_HIGHLIGHT)>0)R&&(0==i.glType&&(z=M),1!=i.glType||s.is2DLine||(z=w));else{if(0==i.glType&&(i._geomType&T)>0&&!P)return{mainDL:null,subDL:null};if(1==i.glType&&(i._geomType&E)>0&&!P)return{mainDL:null,subDL:null}}if(U)return{mainDL:U,subDL:null};if(z)return{mainDL:z,subDL:null};var H,W=function(t,i,r){var s=2;return t?(t._getDimension||(t._getDimension=function(e,t){var i=2,r=this;if(r._geomType)i=e[r._geomType];else switch(r.glType){case 0:i=0;break;case 1:i=1;break;default:i=2}return 2===i&&(i=r.gas&&0===r.gas.side?5:2),this._dimension=i,i}),s=-1,2===(s=n.originalMaterial||-1===t._dimension?t._getDimension(N,i):t._dimension)&&r&&0===r.side&&(s=5),s):(i instanceof e.Line&&(s=1),s)}(i,t,b),j=s,X=s.overridable&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,q=null;if(!X||s.isPhysicalMaterial&&0!==s.transparency||X.internalMaterialOverride&&s===X.internalMaterialOverride.material||null!==(H=X.getOpacity(W))&&(q=H<1),L.useRenderPriorityOpacity&&L.computeRenderPriorityOpacity(1,X)<1&&(q=!0),t._vertexColors&&(s.useGASColor||s._isFromGAS)){var Z=t._vertexColors;q=q||(Z&e.VertexColorType.A)>0||Z<=e.VertexColorType.RGBA}var Y=s.useGASColor&&b&&b._transparent&&b._alpha<1;C=I&&(q||null===q&&!s.iterative&&j.getOpacity()<1||j.transparent||Y)?D[W]:A[W],t.isCurvedPipe&&(C!==p&&C!==u||(C=f),C===S&&(C=g));var K=null;return n.isDecalNotPossiblePass||!t._isInDecalPass()||!s._deferredMaterials[Q.decalNormalStencilDepthMaterial]||C!==S&&C!==x&&C!==p&&C!==u&&C!==h&&C!==d&&C!==f&&C!==g||(K=C,C=_),{mainDL:C,subDL:K}},s,C,r.id,n.zOnlyPass,n.pickingPassMaterial),this._inheritanceSolver.enableOutlineHanding(n.outlineFriendly,F);for(var B=this.resetGSSOCacheFrame,G=(s&&s.isOrtho,0);G<t.length;++G){var k=t[G];if(k){var U=k.object,z=U._gsso_cache?U._gsso_cache[r.id]:null;if(!U.filtered)if((z?z.length:0)>0&&z[0].resetFrameIndex>=B){U.renderLineMode=z[0].renderLineMode;for(var H=0;H<z.length;H++){var W=z[H],j=r._displayLists[W.dlIndex];W.addDrawable(j,U)}}else!n.originalMaterial&&U instanceof e.Line||n.pickingPassMaterial&&!U.noPickThrough||n.pickingPassMaterial&&U.applyBackgroundViewMode&&!this._pickBackgroundNodes||this._inheritanceSolver.solve(U)}}for(F.outlinesCreated&&i.TexturesManager.finalize(),he=0;he<r._displayLists.length;he++)r._displayLists[he].finalize();F.objectWithTransientGSSO.forEach(e=>e._flagAsGSSOInvalidated()),this._inheritanceSolver.reset()}addDGToDL({object:t,geometry:i,dg:r=null,dgInterval:n=null,material:s,originalMaterial:a,renderMode:o=null,getDLFromObjectFunc:l,geomDisposeFunc:h,camera:c,matApp:d=null,gasMaterial:u=null,gasStruct:p=null,materialMode:f=!1}){this.gl;let g=this.materialToUseList,m=!!this.cuttingScene;if(!(this.clippingSphereOptim&&t.frustumCulled&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.clippingContext)||t.occurrenceRenderingOverride.clippingContext._isBoundingSphereVisible(t.boundingSphere,t.matrixWorld,m)){var v=s,_=a;if(this.gasAsPhong&&v.isPhysicalMaterial&&null!==v._phongFallbackMaterial&&((v=v._phongFallbackMaterial)._deferredMaterialsInit||v.updateDeferredMaterials(),!(v=v._deferredMaterials[this.materialToUse])))return!1;var y=!this.isQAAutomationMode()&&t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.getFullMaterial(f),S=null;(v.overridable||v._forceAllowFullMaterialOverride)&&y&&(y.isMatApp?(S=y._getMaterialFromGLType(r.glType,r._geomType)||null)&&(v=S,_=S,d=y):(S=y,(g.originalMaterial||g.oitMaterial||g.transparentShadowMaterial||v.deferrable)&&(r.glType===A.POINTS?"POINTS"===S.targetPrimitiveType:r.glType===A.LINES||r.glType===A.POINTS?"LINES"===S.targetPrimitiveType:"FACES"===S.targetPrimitiveType)&&(g.originalMaterial||(!S._deferredMaterialsInit&&S.updateDeferredMaterials(),S=S._deferredMaterials[this.materialToUse]),v=S,_=S)));var x=!g.isDecalNotPossiblePass&&t._isReceivingDecal(),b=!1;if((g.shadowMaterial||g.transparentShadowMaterial)&&!t.castShadow){if(!x)return!1;b=!0}if(g.normalDepthMaterial&&(!t.enableNormalDepth||this._debugMaterialMode>0)){if(!x)return!1;b=!0}if(g.normalDepthMaterial||g.shadowMaterial||g.transparentShadowMaterial){if(t._noZPriority||r._noZPriority>=0)return!1;if(r.glType<=A.LINE_STRIP)return!1}if(r&&(this._forbidRenderableState&U.NO_UNKNOWN)>0&&(0===r._geomType||(r._geomType&e.RenderMode.unknownMask)>0)&&"Small Plane"!==v.getType()){if(!x)return!1;b=!0}if((this._forbidRenderableState&U.NO_INVISIBLE_PLANE)>0&&"Small Plane"===v.getType())return!1;if((this._forbidRenderableState&U.ONLY_LIGHTED)>0&&(!v._canUseLights()||g.zOnlyPass)){if(!x)return!1;b=!0}var w=s.useGASColor&&p&&p._transparent&&p._alpha<1;if(!_.deferrable||!_._transparencyOnGPU(t)){if(((this._forbidRenderableState&U.NO_TRANSPARENT)>0||g.shadowMaterial&&!_._forceOpaqueShadowMapPass())&&_)if(t.occurrenceRenderingOverride){var M=null;if((C=t.occurrenceRenderingOverride.materialOverride)&&(M=C.getOpacity(_.__dimension)),null!==M){if(M<1){if(!x)return!1;b=!0}}else if(S){if(S.getOpacity()<1||S.transparent){if(!x)return!1;b=!0}}else if(_.getOpacity()<1||_.transparent||w){if(!x)return!1;b=!0}}else if(_.getOpacity()<1||_.transparent||w){if(!x)return!1;b=!0}if(g.transparentShadowMaterial&&_){var C,P=_.transparent||w;if(t.occurrenceRenderingOverride)M=null,(C=t.occurrenceRenderingOverride.materialOverride)&&(M=C.getOpacity(_.__dimension)),null!==M?M<1&&(P=!0):S?(S.getOpacity()<1||S.transparent)&&(P=!0):_.getOpacity()<1&&(P=!0);else _.getOpacity()<1&&(P=!0);if(!P||_._forceOpaqueShadowMapPass()){if(!x)return!1;b=!0}}}if((this.__A2XMode&&(v.isWideLine||v.isDashedLine)||v._isLineWithShapes)&&r&&(r._geomType&E)>0&&(_=v=v._getBodyEdgeMaterial()),r&&!g.pickingPassMaterial&&!g.shadowMaterial&&!g.transparentShadowMaterial&&!this.renderVolumesOnly&&(_._isLineWithShapes||1===_.__dimension&&r._dependentDGs)){let i=D,s=1;_._worldSizePattern?s=t._getMMMatrix().getScaleOnAxisX():i=new e.Matrix4(this.domElement.width/2,0,0,0,0,this.domElement.height/2,0,0,0,0,1,0,0,0,0,1).multiply(c.projectionMatrix).multiply(c.matrixWorldInverse).multiply(t._getMMMatrix());let a=_._computeDependentDGs(r,n,i,s);for(let e=0;e<a.length;e++){let i=a[e].material;i._deferredMaterialsInit||i.updateDeferredMaterials(),this.addDGToDL({object:t,geometry:a[e].geometry,dg:a[e],dgInterval:a[e],material:i._deferredMaterials[this.materialToUse],originalMaterial:i,renderMode:o,getDLFromObjectFunc:l,geomDisposeFunc:h,camera:c,matApp:d,gasMaterial:u,gasStruct:p,materialMode:f})}}if(!g.pickingPassMaterial&&_._isLineWithShapes&&_._isBidimLine)return!1;for(var T=o?o._hiddenEdges>0:this.renderHiddenEdges,I=v.polite||T&&r&&r._geomType&&(r._geomType&E)>0?2:1,R=0;R<I;R++){R&&(v.politeMaterial||(v.politeMaterial=v.clone(),g.highlightMaterial||(v.politeMaterial.transparent=!0,v.politeMaterial.opacity=.3,v.politeMaterial.depthTest=!1,v.politeMaterial.depthWrite=!1)),v=v.politeMaterial);var O=l(t,r,v,n,p),L=O.mainDL,V=O.subDL;if(L){var F,B=t._gsso_cache[L.ssrId],N=L.drawCallSort===pe.DecalSort,G=this.currentPass&&this.currentPass.isOITPass;if(t.isCurvedPipe){var k=e.InstancedCurvedPipeManager,z=k._initMatricesMap(),H=t.id+"_"+i.drawingGroups.indexOf(r),W=k._perRenderableData.get(H);if(!W)continue;for(var j=k._instancingGroups,X=W.length,q=0;q<X;q++)if(ie=j[W[q].bin]){var Z=ie._initCurvesMaps(k),Y=!ie.materials[v.id];if(Y&&(ie.materials[v.id]=v.clone(),k.setPDSFXParamsOnMaterial(ie.materials[v.id])),v=ie.materials[v.id],Y&&(v.updatePDSFXUniform("curvesMaps",ie._curvesMaps),v.updatePDSFXUniform("curvesMapsProperties",ie._curvesMapsProperties),v.updatePDSFXUniform("curvesMatrices",k._matricesMaps),v.updatePDSFXUniform("curvesMatricesProperties",k._curvesMatricesProperties)),Z)for(var K in ie.materials)(re=ie.materials[K]).updatePDSFXUniform("curvesMaps",ie._curvesMaps),re.updatePDSFXUniform("curvesMapsProperties",ie._curvesMapsProperties);var $=t.currentLOD;-1===$&&($=ie._LODGeometries.length-1);var J=ie._LODGeometries[$],ee=J.drawingGroups[0],te={dgIndex:H,index:q};F=new ue({dlIndex:L.index,resetFrameIndex:this.resetGSSOCacheFrame,renderLineMode:t.renderLineMode,material:v,geometry:J,dg:ee,dgInterval:ee,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:d,gasMaterial:u,cpInfos:te}),B.__addCacheItem(F,L,m,G),F.addDrawable(L,t)}if(z)for(q=0;q<j.length;q++){var ie;if(ie=j[q])for(var K in ie.materials){var re;(re=ie.materials[K]).updatePDSFXUniform("curvesMatrices",k._matricesMaps),re.updatePDSFXUniform("curvesMatricesProperties",k._curvesMatricesProperties)}}return!0}if(N&&x){if(F=new ue({dlIndex:L.index,resetFrameIndex:this.resetGSSOCacheFrame,renderLineMode:t.renderLineMode,material:_._deferredMaterials[Q.decalNormalStencilDepthMaterial],geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:Q.decalNormalStencilDepthMaterial,matApp:d,gasMaterial:u,sectionCapping:m}),B.__addCacheItem(F,L,m,G),F.addDrawable(L,t),t._decalData.needDrawUvs&&(F=new ue({dlIndex:L.index,resetFrameIndex:this.resetGSSOCacheFrame,renderLineMode:t.renderLineMode,material:_._deferredMaterials[Q.texCoordMaterial],geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:Q.texCoordMaterial,matApp:d,gasMaterial:u}),B.__addCacheItem(F,L,m,G),F.addDrawable(L,t)),e._mobileDevice&&(F=new ue({dlIndex:L.index,resetFrameIndex:this.resetGSSOCacheFrame,renderLineMode:t.renderLineMode,material:_._deferredMaterials[Q.depthRGBAMaterial],geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:Q.depthRGBAMaterial,matApp:d,gasMaterial:u}),B.__addCacheItem(F,L,m,G),F.addDrawable(L,t)),!b){var ne=t._gsso_cache[V.ssrId];F=new ue({dlIndex:V.index,resetFrameIndex:this.resetGSSOCacheFrame,renderLineMode:t.renderLineMode,material:v,geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:d,gasMaterial:u}),ne.__addCacheItem(F,V,m,G),F.addDrawable(V,t)}}else F=new ue({dlIndex:L.index,resetFrameIndex:this.resetGSSOCacheFrame,renderLineMode:t.renderLineMode,dlIndex:L.index,material:v,geometry:i,dg:r,dgInterval:n,renderVolumesOnly:this.renderVolumesOnly,geomDisposeFunc:h,materialToUse:this.materialToUse,matApp:d,gasMaterial:u}),B.__addCacheItem(F,L,m,G),F.addDrawable(L,t)}}return!0}}resetGSSOCache(){this.resetGSSOCacheFrame++}_setToneMapping(e){this.gammaInput=e>0,this.simpleGamma=e<2}increaseFrameCount(e,t){ee.resetCullingStatuses(this.currentFrameIndex),this.currentFrameIndex++,this._currentFrameType=e,this.info.render=this.info.renderMap.get(e),this.info.render||(this.info.render=new f.RenderInfo,this.info.renderMap.set(e,this.info.render)),this.currentRenderInfo=this.info.render,t||this.info.render.reset()}setMaterialShaders(e,t,i){var r=e.buildLib(t,i);return[r.vertexShader,r.fragmentShader]}getTextureUnit(){var e=this.usedTextureUnits;return e>=this.glSupports.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+this.glSupports.maxTextures),this.usedTextureUnits+=1,e}setProgram(t,i,r,n,s,a,o,l,h,c){let d=this.gl;this.gpuStates,this.usedTextureUnits=0;let u=this.materialToUseList;var p=d?d.contextId:0,f=this.id,g=this.currentRendererMode,m=r.programManager;if(c===m.currentMaterialToUse&&g===m.currentRendererMode&&f===m.currentRendererId&&p===m.currentContextId||m.setActive(p,f,g,c),!r.needsUpdate){var v=r.program;r.program=m.getProgram(o,this.shaderVersions[this.currentRendererMode],this.deallocateMaterial),null===r.program&&this.initMaterial(r,i,n,a,o,l,c),v!==r.program&&r._notifyDLtoBeSortedNextFrame()}u.lightedMaterial&&r.lights&&r.program&&(r.program._lightsKey!==this.lightsKey||r.program._ambianceKey!==this.ambianceKey)&&r.program._materialToUse===c&&(m.disposeCurrentProgram(this.deallocateMaterial,o),this.initMaterial(r,i,n,a,o,l,c)),r.needsUpdate&&(m.disposeAllPrograms(this.deallocateMaterial),this.initMaterial(r,i,n,a,o,l,c),r.needsUpdate=!1);var _=r._PDSFXData&&r._PDSFXData.PDSFX,y=!1,S=!1,x=r.program,b=x.uniformLocations,w=x.pdsfxUniformLocations,M=x.globalUniformLocations,C=x.program,P=s?s.id:-1;if(r.id===this.currentMaterialId&&P===this.currentMaterialOverrideId||(this.currentRenderInfo.swapMaterials++,this.currentMaterialId=r.id,this.currentMaterialOverrideId=P,y=!0),d&&C!==d._currentProgram&&(this.currentRenderInfo.swapPrograms++,d.useProgram(C),d._currentProgram=C,this.currentVertexBuffer=null,this.currentIndexBuffer=null,S=!0,y=!0,this.currentModelMatrix=null),this.currentScene===this.scene&&t===this.currentCamera||(this.currentRenderInfo.swapScenes++,S=!0),this.use_webgpu)return S&&(t!==this.currentCamera&&(this.currentCamera=t),this.currentScene=this.scene,y&&r.lights&&u.lightedMaterial&&this.lightsNeedUpdate&&(this.setupLights(i,t),this.lightsNeedUpdate=!1)),this.currentProgramID=o,x;var E=x.objectUniformLocations;if(this[E.funcName](E,n,a,r,t,i,l),l&&l._mappingOperator&&l._loadMappingOperatorUniforms(r,this,d),y&&(r.refreshUniforms(this,n,s),null!==r._shaderID?(r.loadUniforms(this,d,b,s,h,l),_&&r._PDSFXData._pdsfxUniformsList&&(r._refreshPDSFXUniforms_private(this,n,s),this.loadUniformsGeneric(w,r._PDSFXData._pdsfxUniformsList))):this.loadUniformsGeneric(b,r.uniformsList),u.highlightMaterial&&r.deferrable&&this.scene.highlightData._updateMaterialUniforms(M,d,this)),S){1===e.WebGLVersion&&(d.uniformMatrix4fv(M.projectionMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.projectionMatrix.elements)),M.viewMatrix&&d.uniformMatrix4fv(M.viewMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.matrixWorldInverse.elements)),M.cameraPosition&&(R.getPositionFromMatrix(t.matrixWorld),d.uniform3f(M.cameraPosition,R.x,R.y,R.z),d.uniform3f(M.lowPartCameraPosition,e.SplitFloat32(R.x).low,e.SplitFloat32(R.y).low,e.SplitFloat32(R.z).low)));let s=this.gpuStates;if(_){if(M.projectionInvMatrix&&d.uniformMatrix4fv(M.projectionInvMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.projectionMatrixInverse.elements)),M.viewInvMatrix&&d.uniformMatrix4fv(M.viewInvMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.matrixWorld.elements)),M.viewInvTranspMatrix&&(d.uniformMatrix4fv(M.viewInvTranspMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.matrixWorld.transpose().elements)),t.matrixWorld.transpose()),M.lowlightColor){var T=e._getColorMap(this)[e.COLORMAP_INDEX.LOWLIGHT];this.gammaInput&&(T=I.copyToLinear(T,this.simpleGamma)),d.uniform3f(M.lowlightColor,T.r,T.g,T.b)}M.nearFarLogFactor&&d.uniform3f(M.nearFarLogFactor,t.near,t.far,1/Math.log(t.far/t.near)),M.viewportSize&&d.uniform2f(M.viewportSize,s.viewportWidth,s.viewportHeight)}if(M.pixelToWorldSizeCst&&d.uniform1f(M.pixelToWorldSizeCst,t._pixelToWorldSizeCst),M.billCameraPos||M.billCameraLookAt){d.uniform3f(M.billCameraPos,t.position.x,t.position.y,t.position.z);var A=t.getLookAt();d.uniform3f(M.billCameraLookAt,A.x,A.y,A.z),d.uniform3f(M.billCameraUp,t.up.x,t.up.y,t.up.z),d.uniformMatrix4fv(M.invViewMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.matrixWorld.elements)),d.uniformMatrix4fv(M.invProjectionMatrix,!1,this.float32Matrix4x4Temp.setDoubles(t.projectionMatrixInverse.elements))}y&&(M.viewInfo&&(d.uniform2f(M.viewInfo,t.near,t.far),this.loadTexture(d,M.currentNormalStencilDepth,this.decalBuffers.currentNormalStencilDepthBuffer),this.loadTexture(d,M.currentTexCoord,this.decalBuffers.currentTexCoordBuffer),M.currentRGBADepth&&this.loadTexture(d,M.currentRGBADepth,this.decalBuffers.currentRGBADepthBuffer)),r.lights&&u.lightedMaterial&&(this.lightsNeedUpdate&&(this.setupLights(i,t),this.lightsNeedUpdate=!1),this.loadUniformsLights(d,x.lightUniformLocations,this.lights,x,r._usePhongLighting)),!n.receiveShadow||u.shadowMaterial||u.transparentShadowMaterial||this.loadUniformsShadow(d,x,i,this.lights,r),this.loadUniformsPostProcess(d,x)),t!==this.currentCamera&&(this.currentCamera=t),this.currentScene=this.scene}return(S||x._clipPlanesVersion!==this._clipPlanesState.version)&&(r.enableClipPlanes&&this.loadClippingUniforms(d,x.clippingUniformLocations),x._clipPlanesVersion=this._clipPlanesState.version),this.currentProgramID=o,x}refreshUniformsClipPlanes(e,t,i,r,n){if(e.nbClipPlanes){e.nbClipPlanes.value=t.length,e.clipPlaneEquations.value=t.eqs,e.clipPlaneActive.value=t.states.slice(0);var s=r&&r.getClippingSettings();!s||n?(e.clipFrontOpacity.value=1,e.clipBackOpacity.value=0):(e.clipFrontOpacity.value=s.frontOpacity<.5?0:1,e.clipBackOpacity.value=s.backOpacity<.5?0:1),i&&(e.clipPlaneActive.value[i-1]=0)}}refreshUniformsClipPolyLine(e,t,i,r,n,s,a){if(e.polygonPoints){t&&t.updateCamera(i,r),e.polygonPoints.value=t?t.getTexture():null;var o,l,h=[],c=[],d=[];for(o=0;o<n;o++)t&&o<t.getCount()?(l=t.polyLines[o],h.push(l.closedPoints2d.length),c.push(l.viewPlaneU.x),c.push(l.viewPlaneU.y),c.push(l.viewPlaneU.z),d.push(l.viewPlaneV.x),d.push(l.viewPlaneV.y),d.push(l.viewPlaneV.z)):(h.push(0),c.push(0),c.push(0),c.push(0),d.push(0),d.push(0),d.push(0));e.polygonSize.value=h.length>0?h:[0],e.extrusionPlaneU.value=c,e.extrusionPlaneV.value=d;var u=s&&s.getClippingSettings();e.clipBackOpacity.value=!u||a?0:u.backOpacity<.5?0:1}}refreshUniformsScissorPolyLine(e,t,i,r,n){if(e.scissorPoints){t&&t.updateTexture(i,r),e.scissorPoints.value=t?t.texture:null;var s,a=t?t.getNbVertices():[];for(s=a.length;s<n;s++)a.push(0);e.scissorSize.value=a.length>0?a:[0]}}refreshUniformsClipCylinder(e,t){e.cylinderClipZone&&(e.cylinderClipZone.value=t?t.clipOutside?1:-1:0,t&&t.center&&(e.cylinderCenter.value=t.center),t&&t.axisU&&(e.cylinderAxisU.value=t.axisU.clone().multiplyScalar(1/t.axisU.lengthSq())),t&&t.axisV&&(e.cylinderAxisV.value=t.axisV.clone().multiplyScalar(1/t.axisV.lengthSq())))}setColorGamma(e,t,i,r,n,s){var a=I.copyToLinear(i,n);e[t]=a.r*r,e[t+1]=a.g*r,e[t+2]=a.b*r,e[t+3]=0,s&&(s[t]=a.r,s[t+1]=a.g,s[t+2]=a.b,s[t+3]=0)}setColorLinear(e,t,i,r,n){e[t]=i.r*r,e[t+1]=i.g*r,e[t+2]=i.b*r,e[t+3]=0,n&&(n[t]=i.r,n[t+1]=i.g,n[t+2]=i.b,n[t+3]=0)}setupLights(e,t){var i,r,n=this.lights,s={ambient:[0,0,0],directional:{dirCount:0,dirLength:0,dirColors:n.directional.colors,dirColorsPhong:n.directional.colorsPhong,dirPositions:n.directional.positions,dirColorsNoIntensity:n.directional.colorsNoIntensity},directionalIBL:{dirIBLCount:0,dirIBLLength:0,dirIBLColors:n.directionalIBL.colors,dirIBLPositions:n.directionalIBL.positions},directionalPhong:{dirPhongCount:0,dirPhongLength:0,dirPhongColors:n.directionalPhong.colors,dirPhongPositions:n.directionalPhong.positions},point:{pointCount:0,pointLength:0,pointColors:n.point.colors,pointColorsPhong:n.point.colorsPhong,pointPositions:n.point.positions,pointPhysicalAttenuations:n.point.physicalAttenuations,pointColorsNoIntensity:n.point.colorsNoIntensity},spot:{spotCount:0,spotLength:0,spotColors:n.spot.colors,spotColorsPhong:n.spot.colorsPhong,spotPositions:n.spot.positions,spotPhysicalAttenuations:n.spot.physicalAttenuations,spotDirections:n.spot.directions,spotColorsNoIntensity:n.spot.colorsNoIntensity},ies:{iesCount:0,iesLength:0,iesColors:n.ies.colors,iesPositions:n.ies.positions,iesPhysicalAttenuations:n.ies.physicalAttenuations,iesDistances:n.ies.distances,iesLightTexture:n.ies.iesLightTexture,matrixWorldInv:n.ies.matrixWorldInv},rectangle:{rectangleCount:0,rectangleLength:0,rectangleColors:n.rectangle.colors,rectanglePositions:n.rectangle.positions,rectangleNormals:n.rectangle.normals,rectangleUps:n.rectangle.ups},sphere:{sphereCount:0,sphereLength:0,sphereColors:n.sphere.colors,spherePositions:n.sphere.positions},disk:{diskCount:0,diskLength:0,diskColors:n.disk.colors,diskNormals:n.disk.normals,diskUps:n.disk.ups,diskPositions:n.disk.positions},tube:{tubeCount:0,tubeLength:0,tubeColors:n.tube.colors,tubeRights:n.tube.rights,tubePositions:n.tube.positions},camera:t};for(i=0,r=e.length;i<r;i++){var a=e[i];a.onlyShadow||a.setup(s,this.setColorGamma,this.setColorLinear,this)}var o=function(e,t){for(i=4*s[e][t+"Length"],r=Math.max(s[e][t+"Colors"].length,4*s[e][t+"Count"]);i<r;i++)(i+1)%4&&(s[e][t+"Colors"][i]=0);n[e].length=s[e][t+"Length"]};o("directional","dir"),o("directionalIBL","dirIBL"),o("directionalPhong","dirPhong"),o("point","point"),o("spot","spot"),o("ies","ies"),o("rectangle","rectangle"),o("disk","disk"),o("sphere","sphere"),o("tube","tube"),n.ambient[0]=s.ambient[0],n.ambient[1]=s.ambient[1],n.ambient[2]=s.ambient[2]}setupClipPlanes(t,i,r,n){this._clipPlanes.hasCapping=!0;var s,a,o,l=0,h=0,c=n&&n.clippingContext;for(s=0,a=i.length;s<a;s++){o=i[s],h=4*l,(new e.Matrix4).copy(r.matrixWorld).transpose();var d=(new e.Plane).copy(o);d.constant+=this.clipPlanesTolerance,d.applyMatrix4(r.matrixWorldInverse),this._clipPlanes.eqs[h]=d.normal.x,this._clipPlanes.eqs[h+1]=d.normal.y,this._clipPlanes.eqs[h+2]=d.normal.z,this._clipPlanes.eqs[h+3]=d.constant,this._clipPlanes.states[s]=o.enabled?1:0,this._clipPlanes.sectionLines[s]=!c||c._hasPlaneSectionLine(o),c&&!c._hasPlaneCapping(o)&&(this._clipPlanes.hasCapping=!1),l++}this._clipPlanes.length=l}render(t,r,n,s,a,o){if(r instanceof e.Camera==0)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");var l=e._mobileDevice,h=(e._vrDevice,e._mobileHighlight);let c=!!this.cuttingScene,d=this.gl,u=this.materialToUseList;this.scene=t,this.camera=r,this.lastRenderTarget=n,this._initGlobals(),this._cleanProgramPool(this.currentFrameIndex%100==0&&this.materialToUseList.originalMaterial),this.initFrameUBO();var p=t.__lights;t.__lights.sort(t._lightSort);var f=t.computeLightsKey();this.lightsKey=f.key,this.lightingSet=!1,this._updateSceneAndCamera(),this._updatePassStates(s);var g=this.currentPass?this.currentPass.idString:null;"main"===t.defaultRenderList||"main"!==g&&g||(g=t.defaultRenderList);var m=this.currentPass.composer?this.currentPass.composer.composerContext:null,v=e.StateSortingResult._getCullingSystem(r,t,m,this._currentFrameType,this.currentPass),_=this.resetGSSOCacheFrame>a._resetGSSOCacheIndex,y=m?m.id:"mtU_"+this.materialToUse;v.lastComposerContextsSeen.has(y)||(v.objectManagers[g]=null,_=!0),v.currComposerContextsSeen.add(y);var S=this.currentFrameIndex;v.isSet(g)||v.setFromIdString(g);var x=v.getWebGLObjectsLinkedList(g);const b=this.currentRendererMode===oe.dynamic;var w=this.objectsToGSSO;if(null!==x&&o){a._resetGSSOCacheIndex=this.resetGSSOCacheFrame;var M=a.id,C=x.first,P=x.nexts,E=x.objects;window.webVisuPerfo.startPerfo("cull");var T=v.objectManagers[g],A=S>T.frame;T.frame=S;for(var D=$._INVISIBLE,I=$._VISIBLE,R=($._FRESH,J._GSSO),O=J._REMOVE_AND_GSSO,F=J._REMOVE,B=J._NOTHING,N=J._SKIP,G=J._MAYBE_REMOVE_AND_GSSO,k=0,z=0,H=0,W=null,j=!1,X=!1,q=this.visibleSpace,Z=0,Y=C;Y>-1;Y=P[Y]){var K=(W=E[Y]).webglObject,ee=K.object;if(A){var ie=W.previousCullingStatus;W.action=B,L(ee.visible,ee.visibilityFree,q,ee.layer)&&(!K.frustumCulled||++Z&&K._performCulling(r,this.frustum,W))?(W.previousCullingStatus=I,W.invalidated||_?(W.invalidated=!1,W.action=O,ee._gsso_cache=null,ee._sgOrdered=!1):ie!==I?W.action=R:ee._sgOrdered&&(W.action=G)):(W.previousCullingStatus=D,H++,W.invalidated||_?(W.invalidated=!1,W.action=F,ee._gsso_cache=null,ee._sgOrdered=!1):W.action=ie!==D?F:N)}switch(W.action){case B:break;case N:continue;case R:w[k++]=K,ee.renderPointsOnly=W.currentRenderPointsOnly;break;case O:j=!0,ee._removeFromStateSortingResult(M),w[k++]=K,ee.renderPointsOnly=W.currentRenderPointsOnly;break;case G:X=!0,z++,w[k++]=K,ee.renderPointsOnly=W.currentRenderPointsOnly;break;case F:j=!0,ee._removeFromStateSortingResult(M);continue}W.previousCullingStatus===I&&(ee.beforeRenderCB&&!u.pickingPassMaterial&&ee.beforeRenderCB(ee,{viewpoint:r._viewpoint,camera:r}),this.setupMatrices(ee,r))}if(this.currentRenderInfo.culledMeshes+=H,this.currentRenderInfo.cullingCalls+=Z,window.webVisuPerfo.endPerfo("cull"),window.webVisuPerfo.startPerfo("sort"),window.webVisuPerfo.endPerfo("sort"),window.webVisuPerfo.startPerfo("gsso"),k-z>0){if(w.length=k,X){for(var re=0;re<k;re++)w[re].object._removeFromStateSortingResult(M);for(re=0;re<a._displayLists.length;re++)a._displayLists[re].clearNeverSort()}this.getStateSortedObjects(w,a)}if(j)for(re=0;re<a._displayLists.length;re++)a._displayLists[re].cleanMaterialListAndDRLs();this._sortDisplayLists(a),window.webVisuPerfo.endPerfo("gsso")}var ne=!1;window.webVisuPerfo.startPerfo("draw");var se=null,ae=this.materialToUse===Q.oitAccumMaterial,le=this.materialToUse===Q.oitRevealMaterial,he=u.mainMaterial,ue=this.useOIT&&this.currentPass.isOITPass&&u.mainMaterial,fe=!u.mainMaterial&&!u.outlineFriendly,ge=u.highlightMaterial&&t.highlightData,me=ge&&h,ve=this.materialToUse,_e=!1,ye=!1,Se=!1,xe=-1;if(!this.useCompositing&&u.oitMaterial){var be=0,we=a._displayLists.filter(e=>e.canOIT);for(re=0;re<we.length;re++){var Me=we[re];be+=Me._materialList.length,ye=ye||Me.drawCallSort===pe.DecalSort&&Me._materialList.length>0||Me._materialList.filter(e=>e._objectsTransparentOnGPU||e.material._transparencyOnGPU(null)).length>0}_e=0===be}this.createRenderPass(),this.updateFrameUBO(r);var Ce=this.forcePolygonOffset!==e.PolygonOffsetForceStatus.DEFAULT,Pe=this.forcePolygonOffset===e.PolygonOffsetForceStatus.ENABLED,Ee=!!c&&this.getClipPlanesUseObjectMaterial();if(!_e)for(var Te=a._displayLists.length,Ae=0;Ae<Te;Ae++){var De=a._displayLists[Ae],Ie=De.drawCallSort===pe.DecalSort,Re=De._materialList,Oe=De.active?Re.length:0;if(-1!==xe||0!==Oe){var Le=!this.disableDepthTest&&De.depthTest;if(Ie){var Ve=this.getViewportSize();this.decalBuffers.currentNormalStencilDepthBuffer=this.renderTargetPool.buildRenderTarget(Ve.width,Ve.height,"decal"),this.clearTarget(this.decalBuffers.currentNormalStencilDepthBuffer,!0,!0,!0),l&&(this.decalBuffers.currentRGBADepthBuffer=this.renderTargetPool.buildRenderTarget(Ve.width,Ve.height,"uintNearest"),this.clearTarget(this.decalBuffers.currentRGBADepthBuffer,!0,!0,!0)),this.setRenderTarget(n)}var Fe=null;De.depthFunc&&(Fe=this.gpuStates.depthFunc,this.setDepthFunc(this.depthFuncs[De.depthFunc])),u.pickingMaterial&&(Ae>0&&(De.pickingPriority||ne)&&d.clear(d.DEPTH_BUFFER_BIT),ne=!!De.pickingPriority),De.useStencil&&De.noz&&this.materialToUseList.originalMaterial&&(d.enable(d.STENCIL_TEST),d.stencilFunc(d.ALWAYS,1,255),d.stencilOp(d.KEEP,d.KEEP,d.REPLACE),d.stencilMask(255));var Be=De.depthWrite;De.hasTranspar&&ue&&(Be=!0);var Ne=le&&De.canOIT,Ge=ae&&De.canOIT,ke=ue&&De.canOIT;ye&&(De.canOIT?(-1===xe&&(xe=Ae),this.setColorWrite(!1),this.disableSetColorWrite=!0,Ne=!1,Ge=!1,ve=Q._fakeOriginalMaterial,Se=!Ie):xe>-1&&(Oe=0)),!De.canOIT&&u.oitMaterial&&(this.setColorWrite(!1),this.disableSetColorWrite=!0,ve=Q._fakeOriginalMaterial);for(var Ue="OUTLINE"==De.name,ze=(De.name,null),He=null,We=null,je=!1,Xe=0;Xe<Oe;Xe++){var qe=Re[Xe];if(!qe.drawOnlyOnStaticFrames||!b){var Ze=qe._forceAlphaBlending,Ye=qe.displayRangeList,Qe=Ye&&Ye.getFirstDrawable(),Ke=qe.material;if(Qe&&(!Se||qe._objectsTransparentOnGPU||Ke._transparencyOnGPU(null))){var $e=!1,Je=!1,et=!1,tt=Ne,it=Ge,rt=ke,nt=ve,st=fe;if(Ie){var at=!1;switch(qe.materialToUse){case Q.decalNormalStencilDepthMaterial:$e=!0,at=!0;break;case Q.texCoordMaterial:Je=!0,at=!0;break;case Q.depthRGBAMaterial:et=!0,at=!0;break;default:if(u.mainMaterial=he,ye){let e=this.disableSetColorWrite;this.disableSetColorWrite=!1,this.setColorWrite(!1),this.disableSetColorWrite=e}}if(at){if(nt=qe.materialToUse,ye){let e=this.disableSetColorWrite;this.disableSetColorWrite=!1,this.setColorWrite(!0),this.disableSetColorWrite=e}u.mainMaterial=!1,rt=!1,tt=!1,it=!1,st=!0}}var ot=Ye.materialOverride;if(c){let e=qe.occurrenceRenderingOverride,t=e&&e.clippingContext,i=ze?ze._isCappingUsingPlaneMaterial():0;je&&(!ze||t!==ze||Ee&&1===i||2===i)&&(this.renderCuttingElements(We,r,p,He.occurrenceRenderingOverride)&&(se=null),je=!1),He=qe,ze=t,We=Ke}if(this.currentGeometryGroupHash=null,this.clipPlanesEnabled||!this.cuttingScene||qe.occurrenceRenderingOverride&&qe.occurrenceRenderingOverride.clipPlanes){rt!==Ke.isOIT&&(rt?Ke._programID|=V.OIT:Ke._programID&=~V.OIT,Ke.isOIT=rt),Ke.deferrable&&(this._forbidRenderableState&U.NO_TRANSPARENT?Ke._programID|=V.SKIP_TRANSPAR:Ke._programID&=~V.SKIP_TRANSPAR);var lt=Ke;if(!Ke.areTexturesLoaded()&&u.mainMaterial){if(Ke.transparent||Ke.getOpacity()<1)continue;lt=te}if(this.ambianceKey=Ke._computeAmbianceKeyAndProcessMaterial(u.lightedMaterial,t,f,this,r),tt)this.setBlending(e.OITRevealBlending,0,0,0);else if(it)this.setBlending(e.OITAccumBlending,0,0,0);else if(u.transparentShadowMaterial)this.setBlending(e.TransparentShadowBlending,0,0,0);else if(st)me?this.setBlending(e.NormalBlending,e.AddEquation,e.SrcAlphaFactor,e.OneMinusSrcAlphaFactor):this.setBlending(e.NoBlending);else if(Ke.useBlending||!Ke.iterative&&(Ke.transparent||Ke.getOpacity()<1))this.setBlending(Ke.blending,Ke.blendEquation,Ke.blendSrc,Ke.blendDst);else{var ht=Ze;ot&&ot.hasTransparency(Ke.__dimension)?ht=!0:this.useRenderPriorityOpacity&&this.computeRenderPriorityOpacity(1,ot)<1&&(ht=!0),this._renderToCanvas&&this._doBlendingOnCanvas&&(ht=!0),ht?this.setBlending(e.NormalBlending,e.AddEquation,e.SrcAlphaFactor,e.OneMinusSrcAlphaFactor):this.setBlending(e.NoBlending)}ge?this.setDepthTest(Le):Qe.dg&&!Qe.dg.glType&&Qe.dg._geomType===e.GeomTypeEnum.SURFACIC_POINT&&De.depthTest?this.setDepthTest(!0):st?this.setDepthTest(Le):this.setDepthTest(Ke.depthTest&&Le);var ct=Be;!Be&&this.currentPass&&(!this.currentPass.isRobotPass&&De.hasTranspar&&(lt.opacityMap||lt.map||(1===lt.getOpacity()||u.pickingPassMaterial)&&null===ot||ot&&(1===ot.getOpacity(Ke.__dimension)||u.pickingPassMaterial))&&(Be=!0),this.currentPass.isRobotPass&&u.pickingPassMaterial&&(Be=!0)),st?(this.setDepthWrite(Be&&!this.disableDepthWrite),this.setColorWrite(!this.disableColorWrite)):it||tt?(this.setDepthWrite(!1),this.setColorWrite(Ke.colorWrite&&!this.disableColorWrite)):(this.setDepthWrite(Ke.depthWrite&&Be&&!this.disableDepthWrite),this.setColorWrite(Ke.colorWrite&&!this.disableColorWrite)),c||!u.mainMaterial||this.gpuStates.colorWrite?Ke._programID&=~V.NO_COLOR_WRITE:Ke._programID|=V.NO_COLOR_WRITE,Be=ct,Ke.polygonOffset&&!Ce&&this.setPolygonOffset(Ke.polygonOffset,Ke.polygonOffsetFactor,Ke.polygonOffsetUnits),this._clipPlanesState.update(qe.occurrenceRenderingOverride,se,!1,lt,r,!!this.cuttingScene),se=qe.occurrenceRenderingOverride;var dt=!1,ut=null;if(this.useRenderPriorityOpacity&&0===this.computeRenderPriorityOpacity(1,ot))continue;var pt=!0,ft=this.tokens,gt=this._hasClippingWithoutCapping(),mt=0;Ye.tree.forEach(function(e,t){ft[mt++]=e.next});var vt=null;Ke.depthFunc&&(vt=this.gpuStates.depthFunc,this.setDepthFunc(this.depthFuncs[Ke.depthFunc]));for(var _t=0;_t<mt;++_t)for(ut=ft[_t];null!==ut;ut=ut.next){var yt=ut.dg,St=ut.object,xt=ut.geometry,bt=ut.matApp,wt=ut.gas;if(Ue&&St&&St.outlinesGeometry&&yt._geomType===e.GeomTypeEnum._OUTLINE){let t=null;if(this.useCPUOutlines(r)){let i=new e.Vector4(0,0,1,0).applyMatrix4(r.matrixWorld);i.applyMatrix4((new e.Matrix4).getInverse(St.matrixWorld)),t=new e.Vector3(i.x,i.y,i.z).normalize()}i.refreshOutlines({object:St,viewDirection:t,width:this.getRenderMode(St)._outlineWidth,gl:d,visibleSpace:this.visibleSpace}),ut.start=yt.start,ut.count=yt.count}if(ut.updateLineInfos&&ut._updateWideLineAndPatternStuff(lt,this,r,e),ut.doRenderLineModePolygonOffset.doIt&&(Ce?this.setPolygonOffset(Pe,2*ut.doRenderLineModePolygonOffset.factor,2*ut.doRenderLineModePolygonOffset.unit):this.setPolygonOffset(ut.doRenderLineModePolygonOffset.enable,ut.doRenderLineModePolygonOffset.factor,ut.doRenderLineModePolygonOffset.unit)),Ie&&ce(this,this.decalBuffers,$e,Je,et),this.setMaterialFacesSimple(ut,lt,r,gt),2===xt._type){var Mt=!1;if(ot&&ot.colorOverride){var Ct=!1;if((ot.colorOverride.hasASMInherit()||St._occurrence.gas&&St._occurrence.gas.hasASMInherit())&&(Ct=!0),Ct&&(ot._setDisableColorOverride(!1),yt&&((yt._geomType&e.BodyLinesMask)>0||yt._geomType===e.GeomTypeEnum._OUTLINE))){var Pt=this.getRenderMode(St);this.overrideWireframeFix&&Pt&&!Pt.areFacesVisible()||(ot._setDisableColorOverride(!0),Mt=!0)}}St&&null!==St.sectionLinesBuilder&&St.sectionLinesBuilder.sectionLineGeometry&&xt===St.sectionLinesBuilder.sectionLineGeometry?this.renderSectionLines(r,p,St,lt,null,xt,yt,ut.start,ut.count,qe.occurrenceRenderingOverride,ot,pt,ut,bt,wt,nt):dt=this.renderInterval(r,p,St,lt,null,xt,yt,ut.start,ut.count,qe.occurrenceRenderingOverride,ot,pt,ut,bt,wt,nt),Mt&&ot._setDisableColorOverride(!1),dt&&(pt=!1)}else dt=1===xt._type?this.renderBufferDirect(r,p,Ke,xt,St):this.renderBuffer(r,p,Ke,xt,St);c&&dt&&(je=!0),Ie&&de(this,n,$e||Je||et)}Ke._programID&=~V.NO_COLOR_WRITE,vt&&this.setDepthFunc(vt)}}}}c&&je&&We&&this.renderCuttingElements(We,r,p,He.occurrenceRenderingOverride)&&(se=null),!De.canOIT&&u.oitMaterial&&(this.disableSetColorWrite=!1,this.setColorWrite(!0),ve=this.materialToUse),ye&&xe>-1&&(!De.canOIT||Ae===Te-1)&&(Ae=xe-1,ye=!1,xe=-1,this.disableSetColorWrite=!1,this.setColorWrite(!0),ve=this.materialToUse,Se=!1),Fe&&this.setDepthFunc(Fe),De.useStencil&&De.noz&&this.materialToUseList.originalMaterial&&d.disable(d.STENCIL_TEST),Ie&&(this.renderTargetPool.pushRenderTarget(this.decalBuffers.currentNormalStencilDepthBuffer,null),this.decalBuffers.currentNormalStencilDepthBuffer=null,this.renderTargetPool.pushRenderTarget(this.decalBuffers.currentTexCoordBuffer,null),this.decalBuffers.currentTexCoordBuffer=null,l&&(this.renderTargetPool.pushRenderTarget(this.decalBuffers.currentRGBADepthBuffer,null),this.decalBuffers.currentRGBADepthBuffer=null))}}u.mainMaterial=he,window.webVisuPerfo.endPerfo("draw"),this._restorePassStates(),this.submitRenderPass()}doRenderPlugins(e,t,i,r,n){this.initWebGLObjects(t);var s=0;for(s=0;s<e.length;s++)e[s].noRenderTarget||this.setRenderTarget(r);this.renderPlugins(e,t,i,n)}renderObjects(t,i,r,n,s,a,o,l){var h,c,d,u,p,f,g;i?(p=t.length-1,f=-1,g=-1):(p=0,f=t.length,g=1),2===e.WebGLVersion&&this.updateFrameUBO(n),this.currentVertexBuffer=null,this.currentIndexBuffer=null;for(var m=p;m!==f;m+=g)if(null!==(h=t[m])){if(d=(c=h.object).geometry.geometryGroupsList[0],o)u=o;else{if(void 0===(u=h.object.material[this.materialToUse])&&(u=h.object.material),!u)continue;a||u.useBlending?this.setBlending(u.blending,u.blendEquation,u.blendSrc,u.blendDst):this.setBlending(e.NoBlending),this.setDepthTest(u.depthTest&&!this.disableDepthTest),this.setDepthWrite(u.depthWrite&&!this.disableDepthWrite),this.forcePolygonOffset===e.PolygonOffsetForceStatus.DEFAULT&&setPolygonOffset(u.polygonOffset,u.polygonOffsetFactor,u.polygonOffsetUnits)}if(this.setMaterialFaces(u),1===d._type)this.renderBufferDirect(n,s,u,d,c);else if(2===d._type||d.length>=0){var v=c.geometry.length||1,_=c.geometry.length?c.geometry[0]:c.geometry;for(m=0;m<v;m++){for(var y=_.drawingGroups,S=0;S<y.length;S++)this.renderInterval(n,s,c,u,null,_,y[S],y[S].start,y[S].count,null,l,!0,0,token,null);if(1===v)break;_=c.geometry[m+1]}}else this.renderBuffer(n,s,u,d,c,l)}}_commonShaderOptionsBuilder(t,i,r,n,s,a,o,l){let h=this.materialToUseList,c=this.glSupports;var d={WebGLVersion:e.WebGLVersion,extDerivatives:!this.glSupports||!!this.glSupports.glExtensionStandardDerivatives||e.WebGLVersion>=2,materialToUse:o,selectionMaterial:K(o),mobile:e.mobileVersion,mobileDevice:e._mobileDevice,vrDevice:e._vrDevice,appleDevice:e._appleDevice,renderToFloatTexture:!c||c.renderToFloatTexture,noCompositing:!this.useCompositing,mobileHL:e._mobileHighlight,deferrable:t.deferrable,depthDebugMaterial:l&&this._debugMaterialMode===Y.DEPTH,normalDebugMaterial:l&&this._debugMaterialMode===Y.NORMAL,shadowMapDebugMaterial:l&&this._debugMaterialMode===Y.SHADOW,geomUVDebug:l&&this._debugMaterialMode===Y.GEOM_UV,mappingUVDebug:l&&this._debugMaterialMode===Y.MAPPING_UV,geomUV2Debug:l&&this._debugMaterialMode===Y.GEOM_UV2,mappingUV2Debug:l&&this._debugMaterialMode===Y.MAPPING_UV2,useOIT:t.isOIT,maxDirLights:0,maxDirIBLLights:0,maxDirPhongLights:0,maxPointLights:0,maxSpotLights:0,maxSphereLights:0,maxTubeLights:0,maxDiskLights:0,maxRectangleLights:0,maxIESLights:0,lightMapMode:0,useLighting:!1,maxDirShadows:0,maxDirIBLShadows:0,maxSpotShadows:0,maxShadows:0,maxShadowsCube:0,uintESM:this.packESM,shadowMapType:this.shadowMapType,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,fixedSize:r&&r._ratioData&&r._ratioData.ratio>0,alphaTest:t.alphaTest,discardOrOpaque:t.alphaTest&&t.alphaTestMode===e.AlphaTestMode.DISCARD_OR_OPAQUE,doubleSided:t.side===P.DoubleSide,flipSided:t.side===P.BackSide,vertexColors:t.vertexColors>0,objectVertexColors:r._vertexColors>0&&(t.useGASColor||t._isFromGAS),sizeAttenuation:t.sizeAttenuation,largeScale:(s&V.LARGE_SCALE)>0,useNormalMatrix:(s&V.NON_UNIFORM_SCALE)>0,noZObject:(s&V.NOZ_OBJECT)>0,politeHighlight:(s&V.POLITE_HIGHLIGHT)>0,primitiveHighlight:(s&V.PRIMITIVE_HIGHLIGHT)>0,clipPlanesEnabled:this.clipPlanes.length>0&&t.enableClipPlanes,useClippingCylinder:this.useClippingCylinder&&t.enableClipPlanes,maxPolygonSize:t.enableClipPlanes?Math.max(this.maxPolyLineSize,this.maxScissorSize):0,maxPolyLineSize:t.enableClipPlanes?this.maxPolyLineSize:0,maxNbPolyLine:t.enableClipPlanes?this.maxNbPolyLine:0,maxScissorSize:t.enableClipPlanes?this.maxScissorSize:0,maxNbScissor:t.enableClipPlanes?this.maxNbScissor:0,billboard:r&&r._billboardData&&r._billboardData.type>=1,isMultiInstanced:r&&r._instancingInfos&&r._instancingInfos.isInstanceNode3D,defaultInstancing:r._instancingInfos&&r._instancingInfos.useDefaultInstancing,instancingMeshSelectionMode:r&&r._instancingInfos&&"mesh"===r._instancingInfos.instancingSelectionMode,compressedVertices:n&&n.compressedVertices,compressedNormals:n&&n.compressedNormals,compressedUVs:n&&n.compressedUVs,compressedColors:n&&n.compressedColors,gpuTangentBinormal:!this.forceCPUTBCompute&&n&&!n.hasTangentBinormal(),map:t._isTextureAvailable("map"),mapHDR:!!t.map&&t.map.hdr,sslrefractionEnabled:this.useSSLRefraction,sslreflectionEnabled:this.useSSLR,useSSAO:!1,shadowPass:h.shadowMaterial||h.transparentShadowMaterial,skipTranspar:(s&V.SKIP_TRANSPAR)>0,inlinedPostProActivated:this.inlinedPostProcess.activated,inlinedPostProTonemapping:this.inlinedPostProcess.tonemapping,extFragDepth:!c||!!c.glExtensionFragDepth,gammaInput:this.gammaInput,gammaOutput:this.gammaOutput,simpleGamma:this.simpleGamma,fogViewMode:this._backgroundViewMode===e.BackgroundViewMode.FOG||this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT,lowlightViewMode:this._backgroundViewMode===e.BackgroundViewMode.LOWLIGHT};return d.vertexColors=d.vertexColors||d.objectVertexColors,d.alphaTest||K(o)||t._disableForcedAlphaTest||!t._isTransparent(r)||(d.alphaTest=1e-5),r._skinning?Object.assign(d,{skinning:!0,useEulerAngles:r._skinning.useEulerAngles,skinningMapWidth:r._skinning.skinningMapWidth,skinningMapHeight:r._skinning.skinningMapHeight}):r._skinningInstancing&&Object.assign(d,{skinning:!0,useEulerAngles:r._skinningInstancing.useEulerAngles,skinningInstancingMapsInfo:r._skinningInstancing.skinningInstancingMapsInfo}),d}_lightedShaderOptionsBuilder(t,i,r,n,s,a,o){var l=this.allocateLights(i),h=this.allocateShadows(i),c=h.dirLight,d=h.dirIBLLight,u=h.spotLight,p=h.tex2d,f=h.texCube,g=0;if(t.envMap){var m=t.envMap.mapping;m instanceof e.SphericalReflectionMapping?g=1:m instanceof e.LatLongReflectionMapping&&(g=2)}var v=!1,_=0,y=!1;a&&a._lightMap&&a._lightMap.texture?(v=!0,_=a._lightMap.mode,y=a._lightMap.linear):(v=r&&!!r.lightMapData,_=r&&!!r.lightMapData&&r.lightMapData.lightMapMode,y=!0);var S={maxDirLights:l.directional,maxDirIBLLights:l.directionalIBL,maxDirPhongLights:l.directionalPhong,maxPointLights:l.point,maxSpotLights:l.spot,maxSphereLights:l.sphere,maxTubeLights:l.tube,maxDiskLights:l.disk,maxRectangleLights:l.rectangle,maxIESLights:l.ies,lightMap:v,lightMapMode:_,lightMapLinear:!!v&&y,lightMapMappingType:-1,useLighting:!0,reflectivityEnvMap:t._isTextureAvailable("reflectivityEnvMap"),maxDirShadows:c,_maxDirIBLShadows:d,maxDirIBLShadows:0,maxSpotShadows:u,maxShadows:p,maxShadowsCube:f,_shadowMapEnabled:this.shadowMapEnabled&&r.receiveShadow,shadowMapEnabled:this.shadowMapEnabled&&p>0&&r.receiveShadow,shadowMapCubeEnabled:this.shadowMapEnabled&&f>0&&r.receiveShadow,transparentShadowEnabled:this.shadowMapEnabled&&this.transparentShadowEnabled&&!(t.transparent||t.getOpacity()<1),useSSAO:this.useSSAO||this.useSSAOIterative,metal:t.metal,wrapAround:t.wrapAround,reflectionProbes:t.reflectionProbes,useFiniteEnvMap:t.useFiniteEnvMap,envMap:!!t.envMap,envMapSheen:!!t.envMap&&t._sheenData&&null!==t._sheenData.envMipMap,envMapDiffuse:t.envMipMap&&t.envMipMap[1]&&t.envMipMap[1].hasDiffuse,envMapHDR:t.envMap&&t.envMap.hdr,envMapRGBHDR:t.envMap&&t.envMap.rgbHdr,envMapRGBsRGB:t.envMap&&t.envMap.sRGB,envMapping:g,useIBLColor:this._useIBLColor,flakesMode:this.flakesMode,sslrefraction:!1,sslreflection:!1,specularMap:t._isTextureAvailable("specularMap"),specularMapLinear:!!t.specularMap&&t.specularMap.hdr};return(S.maxRectangleLights||S.maxSphereLights||S.maxDiskLights)&&(S.hasAreaLights=!0),S}_textureShaderOptionsBuilder(e,t,i,r,n,s,a,o){var l=e._getTextures(!0).filter(function(e){return!!e}).length>0||a===Q.texCoordMaterial||o&&this._debugMaterialMode===Y.GEOM_UV||o&&this._debugMaterialMode===Y.MAPPING_UV||o&&this._debugMaterialMode===Y.GEOM_UV2||o&&this._debugMaterialMode===Y.MAPPING_UV2;return{useUV:l=s&&s._lightMap?l||!!s._lightMap.texture:l||i&&!!i.lightMapData,mappingType:s&&s._mappingOperator?s._mappingOperator.mappingType:e.mappingType,mappingUseFragment:!!(s&&s._mappingOperator||i&&i.lightMapData)||e.mappingUseFragment,textureBlending:e.textureBlending,textureFormat:e.textureBlending===W.REPLACE&&e.map?e.map.format:0,needTangent:e.needTangent,needTangentBinormal:e.requireTangentBinormal(),needTangentBinormalVertex:e.requireVertexTangentBinormal()}}initMaterial(e,t,i,r,n,s,a){e.addEventListener("dispose",this.onMaterialDispose);var o=this.gl?this.gl.contextId:0,l=this.id,h=this.currentRendererMode,c=e.programManager;a===c.currentMaterialToUse&&h===c.currentRendererMode&&l===c.currentRendererId&&o===c.currentContextId||c.setActive(o,l,h,a);let d=this.materialToUseList;var u=e._shaderID,p=d.mainMaterial,f=d.lightedMaterial;d.lightedMaterial=d.mainMaterial&&e._canUseLights()&&a!==Q._fakeOriginalMaterial&&0==(n&V.NO_COLOR_WRITE);var g=this._commonShaderOptionsBuilder(e,t,i,r,n,s,a,p);if(d.lightedMaterial?(Object.assign(g,this._lightedShaderOptionsBuilder(e,t,i,r,n,s,a)),g.sslrefractionEnabled&&!g.skipTranspar&&(g.sslrefraction=!0),g.sslreflectionEnabled&&(g.sslreflection=!0),g.isDeferredMaterial=!1):g.isDeferredMaterial=!p,Object.assign(g,this._textureShaderOptionsBuilder(e,t,i,r,n,s,a,p)),d.pickingPassMaterial||(g.dashedLine=e.isDashedLine,g.cpuPattern=e.isCPUPattern,g.patternSize=e.isDashedLine&&e.dashPattern?e.dashPattern.length:0),d.pickingMaterial&&(g.specialPickingInstancing=i&&i.isCurvedPipe,g._definePickingInstancing=e._definePickingInstancing),(d.lightedMaterial||d.shadowMaterial||d.transparentShadowMaterial)&&(g.shadowMapQuality=this.shadowMapEnabled&&i.receiveShadow&&this.shadowMapQuality,g.shadowMapDebug=this.shadowMapEnabled&&i.receiveShadow&&this.shadowMapDebug,g.shadowMapCascade=this.shadowMapEnabled&&i.receiveShadow&&this.shadowMapCascade),g._isDecal=(n&V.DECALS)>0,d.isDecalNotPossiblePass||(g.isDecal=g._isDecal,g.isDecal&&0==g.mappingUseFragment&&(g.mappingUseFragment=!0)),e._setMaterialShaderOptions(g,d.lightedMaterial,d.normalDepthMaterial||d.normalMaterial,d.shadowMaterial||d.transparentShadowMaterial,d.normalDepthReflMaterial,d.pickingPassMaterial),e._PDSFXData&&e._PDSFXData.PDSFX){var m=e._PDSFXData;g.PDSFX=!0,g.pdsfxUseTangentBinormal=!1,g.pdsfxUseVertexColors=!1,g.pdsfxUseMap=m.pdsfxTextures&&m.pdsfxTextures.length>0}"Custom"===e.getType()&&(g.useUV=!0,g.needTangent=!0,g.needTangentBinormal=!0,g.gpuTangentBinormal=!1,g.needTangentBinormalVertex=!1),e.enableReceiveShadowOnCapping=g.shadowMapEnabled;var v=e.program;this.use_webgpu&&this.wgpuShaderBuilder.isSupported(e,g)&&(g.WebGPU=!0),e.program=this.buildProgram(u,e,g,r?r.layout:null),this._setShaderUtilsContext(),v!==e.program&&e._notifyDLtoBeSortedNextFrame(),c.addProgram(n,e.program,this.shaderVersions[this.currentRendererMode]),!this.use_webgpu&&e.buildUniformsList(),d.lightedMaterial=f}_initGlobals(){this.currentRenderInfo||(this.currentRenderInfo=new f.RenderInfo);let e=this.materialToUseList;e.originalMaterial=this.materialToUse===Q.originalMaterial,e.mainMaterial=Q.mainMaterial(this.materialToUse),e.lightedMaterial=e.mainMaterial,e.depthMaterial=this.materialToUse===Q.depthMaterial,e.depthRGBAMaterial=this.materialToUse===Q.depthRGBAMaterial,e.normalDepthReflMaterial=this.materialToUse===Q.normalDepthIoRRoughnessMaterial,e.normalDepthMaterial=e.normalDepthReflMaterial||this.materialToUse===Q.normalDepthMaterial,e.normalMaterial=this.materialToUse===Q.normalMaterial,e.zOnlyMaterial=this.materialToUse===Q.ZOnlyMaterial,e.shadowMaterial=this.materialToUse===Q.shadowMapDepthMaterial,e.outlineFriendly=e.originalMaterial||e.zOnlyMaterial,e.pickingMaterial=this.materialToUse===Q.pickingMaterial||this.materialToUse===Q.pickingMaterialInstancing,e.highlightMaterial=this.materialToUse===Q.highlightMaterial,e.positionMaterial=this.materialToUse===Q.gpuPositionMaterial,e.pickingPassMaterial=Q.pickingPassMaterial(this.materialToUse),e.oitMaterial=this.materialToUse===Q.oitAccumMaterial||this.materialToUse===Q.oitRevealMaterial,e.isDecalNotPossiblePass=e.pickingPassMaterial||e.highlightMaterial,e.transparentShadowMaterial=this.materialToUse===Q.transparentShadowMaterial,e.zOnlyPass=!!this.currentPass&&("ZOnly"===this.currentPass.idString||"background"===this.currentPass.idString),e.dialogPass=!!this.currentPass&&"dialogPass"===this.currentPass.name,this.currentGeometryGroupHash=null,this.currentMaterialId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0,this.currentVertexBuffer=null,this.currentIndexBuffer=null,this.gpuStates.viewportScale=this.currentPass&&this.currentPass.composer&&this.currentPass.composer.composerContext?this.currentPass.composer.composerContext._internalScaleForViewport:1}_sortDisplayLists(e){if(this.scene.isBackground)for(t=0;t<e._displayLists.length;t++)(i=e._displayLists[t])._materialList.sort(function(e,t){var i=e.displayRangeList.getFirstDrawable(),r=t.displayRangeList.getFirstDrawable(),n=i?i.object.renderDepth:0,s=r?r.object.renderDepth:0;return s?n?s!==n?s-n:i.object.id!==r.object.id?r.object.id-i.object.id:e.material.id-t.material.id:1:-1});else for(var t=0;t<e._displayLists.length;t++){var i;if((i=e._displayLists[t]).drawCallSort!==pe.NeverSort)if(i.drawCallSort===pe.DecalSort)i._materialList.sort(function(e,t){var i=e.decalSortID.key,r=t.decalSortID.key;return i===r&&(i=-e.decalSortID.layer)==(r=-t.decalSortID.layer)&&(i=-e.decalSortID.internalSortKey,r=-t.decalSortID.internalSortKey),i-r});else if(i.drawCallSort===pe.RenderDepthSort){const e=this.camera;i._materialList.sort(function(t,i){const r=t.displayRangeList.getFirstDrawable(),n=i.displayRangeList.getFirstDrawable(),s=r.object,a=n.object,o=s.renderDepth,l=a.renderDepth;if(o!==l)return o-l;const h=e.matrixWorldInverse.elements,c=s.worldRadius,d=s.worldCenter,u=h[2]*d.x+h[6]*d.y+h[10]*d.z+h[14]+c,p=a.worldRadius,f=a.worldCenter,g=h[2]*f.x+h[6]*f.y+h[10]*f.z+h[14]+p;if(Math.abs(u-g)>1e-6)return u-g;const m=t.glType;return i.glType-m})}else if(i.drawCallSort===pe.GLTypeSort)i._materialList.sort(function(e,t){var i=e.glType;return t.glType-i});else if(i.drawCallSort!==pe.BackToFrontSort||this.currentPass.isOITPass&&i.canOIT)i._sortByClippingContext?i._materialList.sort(function(e,t){var i=e.material,r=t.material,n=e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.clippingContext,s=t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.clippingContext;let a=n?n.id:-1,o=s?s.id:-1;return o!==a?o-a:i.program&&r.program?r.program!==i.program?i.program.id-r.program.id:e.occurrenceRenderingOverrideId!==t.occurrenceRenderingOverrideId?e.occurrenceRenderingOverrideId-t.occurrenceRenderingOverrideId:i.id-r.id:r.id-i.id}):i._sortByProgramNextFrame&&(i._sortByProgramNextFrame=!1,i._materialList.sort(function(e,t){var i=e.material,r=t.material;return i.program&&r.program?r.program!==i.program?i.program.id-r.program.id:e.occurrenceRenderingOverrideId!==t.occurrenceRenderingOverrideId?e.occurrenceRenderingOverrideId-t.occurrenceRenderingOverrideId:i.id-r.id:r.id-i.id}));else{for(var r=0;r<i._materialList.length;r++)i._materialList[r].displayRangeList.sortDrawablesBackToFront(this.camera);i._materialList.sort(function(e,t){var i=e.displayRangeList.getFirstDrawable(),r=t.displayRangeList.getFirstDrawable(),n=i?i.zSortKey:0,s=r?r.zSortKey:0;return s!==n?n-s:i&&r&&i.object.id!==r.object.id?i.object.id-r.object.id:t.material.id-e.material.id})}}}renderCuttingElements(t,i,r,n){function s(t){return!(!t||!(t instanceof e.MeshBasicMaterial||t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)||t.map)}if(this.cuttingScene){var a,o=this.gl;o.stencilFunc(o.NOTEQUAL,100,255),o.colorMask(!0,!0,!0,!0),o.stencilMask(0),o.enable(o.CULL_FACE),this.setDepthWrite(!0);var l=this.disableBackFaceClipPlanes;this.disableBackFaceClipPlanes=0;var h=n&&n.clipPlanes,c=this.cuttingScene.getWebGLObjects("main"),d=n&&n.getClippingSettings();if(d&&0===d.frontOpacity&&o.cullFace(o.FRONT),h){var u,p=[];for(u=0;u<h.length;u++)(v=h[u].clippingContext&&h[u].clippingContext[this.id])&&v.clippingMeshIndex>0&&p.push(c[v.clippingMeshIndex-1]);c=p}var f,g,m=0,v=n&&n.clippingContext,_=this.materialToUse===Q.depthRGBAMaterial||this.materialToUse===Q.normalDepthIoRRoughnessMaterial||this.materialToUse===Q.normalDepthMaterial||this.materialToUse===Q.ZOnlyMaterial;for(m=c.length-1;m>=0;m-=1)if(null!==c[m]&&(!v||v._hasPlaneCapping(c[m].object.clippingPlane))){if(g=null,a=null,n&&n.sectionCappingMaterials){for(g=n.sectionCappingMaterials.defaultMaterial,f=0;f<n.sectionCappingMaterials.length;f++)if(n.sectionCappingMaterials[f].clippingPlane===c[m].object.clippingPlane){g=n.sectionCappingMaterials[f].material;break}g&&(g.clipPlaneIndex=m+1,c[m].object.geometry.normalsNeedUpdate=!0)}var y;this.setupMatriceswithModelMatrix(c[m].object,i),t&&t.enableReceiveShadowOnCapping&&(c[m].object.receiveShadow=!0),_||!g&&c[m].object.material.clipPlaneUseModelMaterial?(_||s(t)?(g=t,a=n&&!_&&n.materialOverride):(this.backupCuttingMaterial||(this.backupCuttingMaterial=e.MaterialUtils.createShinyFaceMaterial({color:"black"})),g=this.backupCuttingMaterial),g.clipPlaneIndex=m+1):((g=g||c[m].object.material)&&(g.clipPlaneIndex=m+1),e.HatchingMeshMaterial&&(g instanceof e.HatchingMeshMaterial||g instanceof e.ScreenSizeHatchingMeshMaterial)&&(g.autoSpaceColor&&(s(t)?(y=n&&n.getOverrideColor(t),g.spaceColor=y||t.color):(y=n&&n.getOverrideColor(),g.spaceColor=y||new e.Color(16777215))),g.autoStripesColor&&(s(t)?g.stripesColor=y||t.color:g.stripesColor=y||new e.Color(0)))),this._clipPlanesState.update(n,null,!0,g,i,!0),this.bufferUtils.updateObject(c[m].object,g),g._renderedClipPlane=c[m].object.clippingPlane,this.setPolygonOffset(!0,1,1),!g.transparent&&g.opacity>=1&&(this.currentRenderInfo&&this.currentRenderInfo.nbRenderCuttingElement++,this.renderObjects([c[m]],!1,"",i,r,!0,g,a)),g._renderedClipPlane=null,(_||c[m].object.material.clipPlaneUseModelMaterial)&&(g.clipPlaneIndex=0)}return d&&0===d.frontOpacity&&o.cullFace(o.BACK),this.setDepthWrite(!1),o.disable(o.CULL_FACE),o.stencilFunc(o.ALWAYS,100,255),o.colorMask(!1,!1,!1,!1),o.stencilMask(255),this.clear(!1,!1,!0),this.disableBackFaceClipPlanes=l,this._clipPlanesState.update(null,null,!0,t,i),!0}return!1}getClipPlanesUseObjectMaterial(){if(this.cuttingScene){let t,i=this.cuttingScene.getWebGLObjects("main",this.currentFrameIndex);for(t=0;t<i.length;t++){let r=i[t].object.material;if(!r||r.clipPlaneUseModelMaterial)return!0;if(r instanceof e.HatchingMeshMaterial&&(r.autoSpaceColor||r.autoStripesColor))return!0}}return!1}renderAssets(){var e=!1,t=this.lastRenderTarget;null!==this.ambianceGenerators&&(e=e||H.update(this.currentFrameIndex,this)),e&&this.setRenderTarget(t)}updateCSSNodes(t,i){var r=t.getWebGLObjectsLinkedList("css2d"),n=t.getWebGLObjectsLinkedList("css3d");if(i.matrixWorldInverse.getInverse(i.matrixWorld),n&&i._viewpoint){var s=i.isOrtho?i.projectionMatrix.elements[5]*this.heightHalf:.5/Math.tan(e.Math.degToRad(.5*i.fov))*this.height,a=i._viewpoint.divCameraCSSElement;i.isOrtho?(this.divCSS3DRoot.style.WebkitPerspective="",this.divCSS3DRoot.style.MozPerspective="",this.divCSS3DRoot.style.oPerspective="",this.divCSS3DRoot.style.perspective=""):(this.divCSS3DRoot.style.WebkitPerspective=s+"px",this.divCSS3DRoot.style.MozPerspective=s+"px",this.divCSS3DRoot.style.oPerspective=s+"px",this.divCSS3DRoot.style.perspective=s+"px"),w=i.isOrtho?"scale("+s+")translate("+this.epsilon(-(i.right+i.left)/2)+"px,"+this.epsilon((i.top+i.bottom)/2)+"px)"+this.getCameraCSSMatrix(i.matrixWorldInverse)+"translate("+this.widthHalf+"px,"+this.heightHalf+"px)":"translate3d(0,0,"+s+"px)"+this.getCameraCSSMatrix(i.matrixWorldInverse)+" translate3d("+this.widthHalf+"px,"+this.heightHalf+"px, 0)",a.style.WebkitTransform=w,a.style.MozTransform=w,a.style.oTransform=w,a.style.transform=w}var o=null;if(r)for(var l=r.first,h=r.nexts,c=r.objects,d=l;d>-1;d=h[d])if(null!==(y=c[d])&&(!(x=(S=y.object)._getFilter(this.visuFilterType._MATERIAL_TO_USE))||x.materialToUse===this.materialToUse)&&O(S.visible,S.visibilityFree,this.visibleSpace,void 0,S._occurrence)){if(this.renderIteration>0)continue;var u=new e.Vector3;u.copy(S.position);var p=!1;if(this.clipPlanesEnabled)for(var f=0;f<this.clipPlanes.length;f++){var g=this.clipPlanes[f];if(g.normal.x*S.position.x+g.normal.y*S.position.y+g.normal.z*S.position.z+g.constant<0){p=!0;break}}if((i.isOrtho||i.getLookAt().dot(i.position.clone().sub(u))<0)&&!p){(new e.Projector).projectVector(u,i),S.element.style.display="block";var m=e.getDevicePixelRatio()||1,v=S.offset.x/m,_=S.offset.y/m;S.element.style.left=v+.5*(u.x+1)*this.domElement.clientWidth+"px",S.element.style.top=_-.5*(u.y-1)*this.domElement.clientHeight+"px",o||(o=[]),o.push({domElement:S.element,z:u.z,alwaysOnTopIndex:S._occurrence?S._occurrence.node._alwaysOnTopIndex:null})}else S.element.style.display="none"}if(n)for(l=n.first,h=n.nexts,c=n.objects,d=l;d>-1;d=h[d]){var y,S,x;if(null!==(y=c[d])&&(!(x=(S=y.object)._getFilter(this.visuFilterType._MATERIAL_TO_USE))||x.materialToUse===this.materialToUse)&&O(S.visible,S.visibilityFree,this.visibleSpace,void 0,S._occurrence)){if(this.renderIteration>0)continue;if(i._viewpoint){var b=(new e.Matrix4).multiplyMatrices(S.matrixWorld,S.scaleCSS),w=this.getObjectCSSMatrix(b),M=S.element;M.style.WebkitTransform=w,M.style.MozTransform=w,M.style.oTransform=w,M.style.transform=w,M.style.pointerEvents="auto",M.style.display="block",M.parentNode!==a&&a.appendChild(M)}}}if(o){o.sort(function(e,t){var i=null!==e.alwaysOnTopIndex,r=null!==t.alwaysOnTopIndex;if(i||r){if(!i)return-1;if(!r)return 1;if(e.alwaysOnTopIndex!==t.alwaysOnTopIndex)return e.alwaysOnTopIndex-t.alwaysOnTopIndex}return t.z-e.z});for(var C=0;C<o.length;C++)o[C].domElement.style.zIndex=20+C}}setupMatrices(t,i){t._modelViewMatrix&&t._modelViewMatrix._multiplyMatricesMV(i.matrixWorldInverse,t.matrixWorld),t.isUniformlyScaled||(t._normalMatrix.getInverse((new e.Matrix4).multiplyMatrices(i.matrixWorldInverse,t.matrixWorld)),t._normalMatrix.transpose()),t.modelViewInvMatrix&&t.modelViewInvMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld),t.modelViewInvTranspMatrix&&t.modelViewInvTranspMatrix.multiplyMatricesAndInverse(i.matrixWorldInverse,t.matrixWorld).transpose()}setupMatriceswithModelMatrix(e,t){this.setupMatrices(e,t),e._matrixWorldForDoubleGPU._fromMatrix4WithLowPartTranslation(e.matrixWorld)}renderPlugins(t,i,r,n){if(!t.length)return;let s=this.gl,a=this.gpuStates;for(var o=0,l=t.length;o<l;o++)s._currentProgram=null,this.currentCamera=null,this.currentVertexBuffer=-1,this.currentIndexBuffer=-1,s._oldBlending=-1,a.depthTest=-1,a.colorWrite=-1,a.depthWrite=-1,a.doubleSided=-1,a.flipSided=-1,this.currentGeometryGroupHash=-1,this.currentMaterialId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0,t[o].render(i,r,e.glStates.currentWidth,e.glStates.currentHeight,n),s._currentProgram=null,this.currentCamera=null,this.currentVertexBuffer=-1,this.currentIndexBuffer=-1,s._oldBlending=-1,a.depthTest=-1,a.colorWrite=-1,a.depthWrite=-1,a.doubleSided=-1,a.flipSided=-1,this.currentGeometryGroupHash=-1,this.currentMaterialId=-1,this.currentMaterialOverrideId=-1,this.currentModelMatrix=null,this.lightsNeedUpdate=!0}resetPassInfo(){}_updatePassStates(t){this.enableRenderPluginsPre&&this.renderPlugins(this.renderPluginsPre,this.scene,this.camera),this.setRenderTarget(this.lastRenderTarget),(this.autoClear||t)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.setStencilWrite(this.enableStencilWrite),this.setBlending(e.NoBlending),this._clipPlanesState.update(null,null,!0,null,this.camera)}_restorePassStates(){this.enableRenderPluginsPost&&this.renderPlugins(this.renderPluginsPost,this.scene,this.camera),this.lastRenderTarget&&this.lastRenderTarget.generateMipmaps&&this.lastRenderTarget.minFilter!==e.NearestFilter&&this.lastRenderTarget.minFilter!==e.LinearFilter&&updateRenderTargetMipmap(this.lastRenderTarget),this.setColorWrite(!0),this.setDepthTest(!0),this.setDepthWrite(!0)}_updateSceneAndCamera(){this.autoUpdateScene&&this.scene.updateMatrixWorld(),this.cuttingScene&&this.cuttingScene.updateMatrixWorld(),this.autoUpdateObjects&&this.initWebGLObjects(this.scene),this.cuttingScene&&this.initWebGLObjects(this.cuttingScene);let t=this.camera;void 0===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),t.orientation||(t.orientation=t.matrixWorld.determinant()>0?1:-1),this.projScreenMatrix.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this.frustum.setFromMatrix(this.projScreenMatrix);let i=this.gpuStates.viewportScale;var r=t.getCameraConstant(this.devicePixelRatio,e.glStates.currentHeight/i);t.fullWidth?(r*=t.height/t.fullHeight,t.useRealSize?t.useRealSize&&t.visualizedHeight&&(t._pixelToWorldSizeCst=t.getCameraConstant(this.devicePixelRatio,t.fullHeight/i)):t._pixelToWorldSizeCst=r):t._pixelToWorldSizeCst=r,t.pixelCullingCst=t.pixelCulling*r,t._cstLOD=r;var n=this.domElement;this._pixelSize.x=2/n.width,this._pixelSize.y=2/n.height,t.fullWidth&&t.pickingRatioW&&(this._pixelSize.x/=t.pickingRatioW,this._pixelSize.y/=t.pickingRatioH)}computeRenderPriorityOpacity(e,t){var i=t?t.getRenderPriorityOpacity():null;return(null===i||i<0)&&(i=this.renderPriorityDefaultOpacity),i*e}},self._typeface_js={faces:e.FontUtils.faces,loadFace:e.FontUtils.loadFace},e}),define("Visualization/ThreeJS_R57",["DS/Visualization/ThreeJS_R57","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ThreeJS_R57"),e}),define("DS/Visualization/AmbianceGenerator",["DS/CoreEvents/Events","UWA/Class","DS/Effects/ConvertLatLongToDualParaboloid","DS/Effects/GenerateMipMaps","DS/Effects/ComputeMipMapRoughness","DS/Visualization/ThreeJS_R57"],function(e,t,i,r,n,s){"use strict";var a=s._AmbianceGenerators,o=t.extend({init:function(t,n){this.nbSamples=n,this.onDoneCallBack=null,this.texture=null,this.mode=null,s.EventDispatcher.call(this),this.finished=!1;var o=this;this.addEventListener("done",function(t){if(t.isDone&&a.viewers.forEach(function(e){e.render()}),t.isDone){var i=Date.now();s.VisualizationTraces.info("INFO: Finished computing ambiance in "+(i-t.initTime)/1e3+" seconds"),e.publish({event:"/VISU/IBLComputed",data:{eventChannel:"/VISU/IBLComputed",eventType:"@onIBLComputed"}})}o.onDoneCallBack&&t.isDone&&o.onDoneCallBack()}),this.renderer=t.renderer.renderer,this.convertEffect=new i(this.renderer,t.renderer.renderTargetPool),this.mipMapEffect=new r(this.renderer,t.renderer.renderTargetPool),this.computeEffect=null,this.frameIndex=0,this.init=!1},dispose:function(){this.convertEffect.dispose(),this.convertEffect=null,this.mipMapEffect.dispose(),this.mipMapEffect=null,this.computeEffect.dispose(),this.computeEffect=null,this.init=!1},_setNbSamples:function(){console.warn("A virtual function has been called")},setValues:function(e,t){if(e){this.texture=e;var i=e.composerContext&&e.composerContext.width,r=e.composerContext&&e.composerContext.height;if(e instanceof s.Texture){if(!e._isReady())return;i=e.image.width,r=e.image.height}else e instanceof s.WebGLRenderTarget&&(i=e.width,r=e.height);this.convertEffect.setSize(i,r),this.mipMapEffect.setSize(i,r),this.computeEffect.setSize(i,r),this.convertEffect.setEnvMap(e),this.mipMapEffect.setInput(this.convertEffect.composers[0]),this.mode=t,this.init=!0}},_execute:function(e){this.init&&(e&&(this.convertEffect.execute(),this.mipMapEffect.execute(),this.computeEffect.setInput(this.mipMapEffect.getResult().composerContext.getResult(void 0,!0)),this._setNbSamples(),this.computeEffect.setMode(this.mode)),this.computeEffect.execute())},_getResult:function(){if(!this.init)return{};var e=this.isDone();e&&s._SaveGeneratedRoughnessMaps&&this.computeEffect._saveResult();var t=this.computeEffect.composers[this.computeEffect.nbMipMaps].composerContext.getResult(void 0,e);return t&&(t.hdr=!0,t.hasDiffuse=0===this.computeEffect.modeValue,t.mapping=new s.LatLongReflectionMapping),t},setCallBack:function(e){this.onDoneCallBack=e},isDone:function(){return this.finished}}),l=o.extend({init:function(e,t){this._parent(e,t),this.computeEffect=new n.ComputeMipMapRoughnessFIS(this.renderer,e.renderer.renderTargetPool)},_isExecuteReady:function(){var e=!this.texture.loadEndStatus||this.texture.loadEndStatus===s.AssetLoadingStatus.READY;return a.viewers.forEach(function(t){e=e&&!t._renderingToTarget&&!t.renderer._needPerformanceSuite()}),e},execute:function(){var e=Date.now(),t=this._isExecuteReady();return t&&(this._execute(!0),this.finished=!0,this.dispatchEvent({type:"done",time:e,initTime:Date.now(),isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}}),h=o.extend({init:function(e,t){this._parent(e,t),this.timeFactor=s._mobileDevice?1.5:1,this.computeEffect=new n.ComputeMipMapRoughnessIterative(this.renderer,e.renderer.renderTargetPool),this.initTime=0},_isExecuteReady:function(e){var t=0===this.computeEffect.iter||!this.texture.loadEndStatus||this.texture.loadEndStatus===s.AssetLoadingStatus.READY,i=this;return a.viewers.forEach(function(r){t=t&&!r._QMMode&&r.renderIteration>0&&e-r.timeIter0>i.timeFactor*r.delayBeforeIteration&&!r.renderer._needPerformanceSuite()&&!r._renderingToTarget}),t},execute:function(){var e=Date.now(),t=this._isExecuteReady(e);return t&&(this._execute(0===this.computeEffect.iter),this.finished=this.computeEffect.iter>=this.computeEffect.nbIterations,this.dispatchEvent({type:"done",time:e,initTime:this.initTime,iteration:this.computeEffect.iter,isDone:this.isDone()})),t?this._getResult():null},_setNbSamples:function(){this.computeEffect.setNbSamples(this.nbSamples)}});return t.extend({init:function(e){this.generators=new Map,this.generated=new Map,this.toCompute=[],this.cb=e},_getViewer:function(){return a.viewers[0]},_getGenerator:function(e,t){if(t&&(e+="-iterative"),!this.generators.has(e)){var i=this._getViewer(),r=t?new h(i,512):new l(i,512);this.cb&&r.setCallBack(this.cb),this.generators.set(e,r)}return this.generators.get(e)},_getAmbiance:function(e,t){return t&&(e+="-iterative"),this.generated.get(e)},_updateAmbiance:function(e,t,i,r,n){i&&(t+="-iterative"),this.generated.set(t,{ambiance:e,complete:r,usedBy:n})},_disposeGenerator:function(e,t){if(t&&(e+="-iterative"),this.generators.has(e)){var i=this.generators.get(e);this.generators.delete(e),i.dispose()}},_setCB:function(e){this.cb=e,this.generators.forEach(function(t,i,r){t.setCallBack(e)})},getAmbiance:function(e,t,i,r){var n=e;t&&(e+="-iterative"),this.generated.has(e)||(this.generated.set(e,{ambiance:a._dummyRoughnessTexture,complete:!1,usedBy:new Set}),this.toCompute.push({name:n,iterative:t,hdr:i.hdr,brdf:i.brdf}));var s=this.generated.get(e);return s.usedBy.add(r),s},keep:function(e){var t=null;return this.generated.forEach(function(i,r,n){i.usedBy.has(e)&&(1!==i.usedBy.size?console.error("Internal roughness map, access refused"):i.ambiance!==dummyTexture&&i.ambiance.complete?(i.usedBy.delete(e),t=i.ambiance,n.delete(r)):console.error("Roughness map not finished, access refused"))}),t},decreaseUseCount:function(e){if(e){var t=this;this.generated.forEach(function(i,r,n){if(i.usedBy.delete(e),i.usedBy.size<1&&(i.ambiance&&i.ambiance.dispose(),n.delete(r),t.generators.has(r))){var s=t.generators.get(r);t.generators.delete(r),s.dispose()}})}},dispose:function(){this.generated.forEach(function(e,t,i){e.ambiance.dispose()}),this.generated.clear(),this.generators.forEach(function(e,t,i){e.dispose()}),this.generators.clear(),this.toCompute=[]},_needsUpdate:function(){for(var e=this.toCompute,t=0;t<e.length;t++){var i=e[t],r=this._getAmbiance(i.name,i.iterative);if(r&&!r.complete)return!0}return!1},update:function(e,t){for(var i=this.toCompute,r=0,n=!1,s=0;s<i.length;s++){var o=i[s],l=this._getAmbiance(o.name,o.iterative);if(l&&!l.complete){var h=this._getGenerator(o.name,o.iterative);if(h.init||h.setValues(o.hdr,o.brdf),h.init&&h.renderer===t&&h.frameIndex<e&&!h.isDone()){var c=h.execute();c&&(n=!0,this._updateAmbiance(c,o.name,o.iterative,h.isDone(),l.usedBy)),h.frameIndex=e,h.isDone()&&(this._disposeGenerator(o.name,o.iterative),r++)}}else this._disposeGenerator(o.name,o.iterative),r++}return r===i.length&&(this.toCompute=[],this.generators.clear()),a.viewers.forEach(function(e){e.forceRender=!0}),n}})}),define("DS/Visualization/OccurrenceRenderingOverride",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(e,t){"use strict";var i,r=function(e,t){this.id=i.getNewId(),this.materialOverride=t instanceof r?t.materialOverride:t,this.opacity=e.opacity,this.renderPriorityActivated=!1};r.prototype.getOpacity=function(e){return this.materialOverride?this.materialOverride.getOpacity(e):null},r.prototype.getColor=function(){return this.materialOverride?this.materialOverride.getColor():null},r.prototype.getFullMaterial=function(){return this.materialOverride?this.materialOverride.getFullMaterial():null},r.prototype.clone=function(){return new r({opacity:this.opacity},this.materialOverride)},r.prototype.getRenderPriorityOpacity=function(){return null===this.opacity?null:this.opacity},r.prototype.hasTransparency=function(e){var t=this.getOpacity(e);return null!==t&&t<1},r.prototype.isPGPOnly=function(){return!1};var n=0,s=new WeakMap;function a(e){var t;return s.has(e)?t=s.get(e):(t=n++,s.set(e,t)),t}var o=0,l=e.extend({init:function(){this.id=o++,this.clipPlanes=[],this.clippingContext=null,this.clipPolyLine=null,this.scissor=null,this.materialOverride=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null},clone:function(){var e=new l;return e.clipPlanes=this.clipPlanes,e.clippingContext=this.clippingContext,e.clipPolyLine=this.clipPolyLine,e.scissor=this.scissor,e.sectionLinesProperties=this.sectionLinesProperties,this.materialOverride instanceof r?e.materialOverride=this.materialOverride.clone():e.materialOverride=this.materialOverride,e},getFullMaterial:function(e){return this.materialOverride&&this.materialOverride.getFullMaterial(e)},getClippingSettings:function(){return this.clippingContext&&this.clippingContext.clippingSettings},setRenderPriority:function(e){e&&null!==e.opacity&&(this.materialOverride=new r(e,this.materialOverride))},getOverrideColor:function(e){if(!this.materialOverride)return null;if(e&&!e.overridable)return e.overridable;var i=this.getFullMaterial();if(i&&!i.overridable)return i.color;var r=this.materialOverride.getColor();return 0!==r&&r?new t.Color(r):null},isPurePGP:function(){return!this.clipPolyLine&&!this.scissor&&this.materialOverride&&this.materialOverride.isPGPOnly()&&!this.sectionCappingMaterials},getGSSOId:function(e){if(e){var t,i="";if(this.clipPlanes)for(t=0;t<this.clipPlanes.length;t++)i+="p"+a(this.clipPlanes[t]);return this.clippingContext&&(i+="k"+this.clippingContext.id),i+=this.materialOverride.getPGPGSSOId()}return""+this.id},getClipCylinder:function(){return this.clippingContext&&this.clippingContext.cylinder}});return l.setOverrideLink2Class=function(e){i=e},l}),define("Visualization/OccurrenceRenderingOverride",["DS/Visualization/OccurrenceRenderingOverride","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/OccurrenceRenderingOverride"),e}),define("DS/Visualization/BufferGeometry",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Visualization/WidelinesHelper","DS/GPUFormats/VertexAttribute","DS/CoreEvents/Events"],function(e,t,i,r,n){"use strict";let s=0;class a{constructor(){this.buffer=null,this.nbGeometries=0,this.isShared=!1}_deleteBuffer(e){}deallocate(e,t){this.nbGeometries--,0===this.nbGeometries&&(t&&this.isShared&&t.memory.sharedbuffers--,this._deleteBuffer(e),this.buffer=null)}}class o extends a{constructor(e,t,i){super(),this.buffer=e.createBuffer({size:t,usage:i,mappedAtCreation:!0})}_deleteBuffer(e){this.buffer.destroy()}}e.WEBGPUIndexBuffer=class extends o{constructor(e,t){super(e,t,GPUBufferUsage.INDEX),this.use32bitIndexBuffer=!1,this.numIndices=0}get byteLength(){return this.numIndices*this.bytesPerIndex}get bytesPerIndex(){return this.use32bitIndexBuffer?4:2}get format(){return this.use32bitIndexBuffer?"uint32":"uint16"}};e.WEBGPUVertexBuffer=class extends o{constructor(e,t){super(e,t,GPUBufferUsage.VERTEX),this.numVertices=0,this.interleavedData=null,this.id=s++,this.layout=null,this.needsUpdate=!1}};class l extends a{constructor({gl:e}){super(),this.buffer=e&&e.createBuffer()}_deleteBuffer(e){e&&e.deleteBuffer(this.buffer)}}e.GLIndexBuffer=class extends l{constructor({gl:e,numIndices:t=0,use32bitIndexBuffer:i=!1}){super({gl:e}),this.use32bitIndexBuffer=i,this.numIndices=t}get byteLength(){return this.numIndices*this.bytesPerIndex}get bytesPerIndex(){return this.use32bitIndexBuffer?4:2}get glFormat(){return this.use32bitIndexBuffer?5125:5123}};e.GLVertexBuffer=class extends l{constructor({gl:e}){super({gl:e}),this.numVertices=0,this.interleavedData=null,this.id=s++,this.layout=null,this.needsUpdate=!1}};class h{constructor(){this.clear()}clear(){this._attributes=new Map,this._cached_signature=null}clone(){const e=new h;return this._attributes.forEach((t,i)=>e._attributes.set(i,Object.assign({},t))),e._cached_signature=this._cached_signature,e}set(e){for(let t in e)this.setAttribute(Object.assign({name:t},e[t]))}setAttribute({name:t,type:i,offset:r,stride:n,bufferId:s=0}){if(!e.VertexAttribute[i])throw new Error(`Vertex attribute '${t}': unknown type (${i}), see GPUFormats.VertexAttribute for acceptable data types`);if(r<0||r>=n)throw new Error(`Invalid offset/stride, expected 0 <= offset (${r}) < stride (${n})`);this._attributes.set(t,{name:t,type:i,offset:r,bufferId:s,stride:n}),this._computeSignature()}remove(e){this._attributes.delete(e),this._computeSignature()}get(e){return this._attributes.get(e)}has(e){return this._attributes.has(e)}getNames(){return[...this._attributes.keys()]}size(){return this._attributes.size}forEach(e){this._attributes.forEach(t=>e(t))}_computeSignature(){let e=[];this._attributes.forEach(t=>e.push(`|${t.name}:${t.type}>`)),this._cached_signature=e.sort().join()}getSignature(){return this._cached_signature}getBufferStrides(){const e=[];return this._attributes.forEach(t=>e[t.bufferId]=t.stride),e}getBufferAttributes(){const e=[];return this._attributes.forEach(t=>{e[t.bufferId]?e[t.bufferId].push(t.name):e[t.bufferId]=[t.name]}),e}pickAnyAttribute({bufferId:e=-1}={}){if(0===this.size())return null;const t=this._attributes.values();if(e<0)return t.next().value;for(let i=t.next();!i.done;i=t.next())if(i.value.bufferId===e)return i.value;return null}isFullInterleaved(){return!!this.getFullInterleaving()}getFullInterleaving(){if(0===this._attributes.size)return;const e=this._attributes.values();let t=e.next().value,i=t.bufferId,r=t.stride;for(let n=e.next();!n.done;n=e.next())if(i!==(t=n.value).bufferId||r!==t.stride)return;return{bufferId:i,stride:r}}interleave({order:t=null,targetBufferId:i=0,allAttributes:r=!0}={}){if(r)if(t){const e=new Set(t);for(let i of this._attributes.keys())e.has(i)||t.push(i)}else t=this.getNames();else if(!t)return;let n=0;for(let r=0;r<t.length;r++){const s=this._attributes.get(t[r]);s&&(s.offset=n,s.bufferId=i,n+=e.VertexAttribute[s.type].size)}for(let e=0;e<t.length;e++){const i=this._attributes.get(t[e]);i&&(i.stride=n)}}}e.VertexLayout=h;class c{constructor(e,t,i){let r,n;this.parentGeometry=e,this.linkedGeometry=t,this.attrName=i,this.parentGeometry[i]=this,this.linkedGeometry[i]=this,r=(()=>{this.parentGeometry.removeEventListener("dispose",r),this.linkedGeometry.dispose()}),this.parentGeometry.addEventListener("dispose",r),n=(()=>{this.linkedGeometry.removeEventListener("dispose",n),this.parentGeometry[i]=null,this.linkedGeometry[i]=null}),this.linkedGeometry.addEventListener("dispose",n)}_isStale(){return this.parentGeometry.revision>this.linkedGeometry.revision}_isParent(e){return this.parentGeometry===e}}class d extends c{constructor(e,t){super(e,t,"wideLinesLinker"),this.lineStructureMap=new Map,this.originalDGToWideDG=new Map}}const u={no_access(){throw new Error("No data for this attribute")},raw_vec3:e=>(function(t,i){const r=3*t;i.x=e[r],i.y=e[r+1],i.z=e[r+2]}),quantized_vec3:(e,t,i)=>(function(r,n){const s=2*r,a=e[s],o=e[s+1];n.x=t.x*(Math.floor(a/256)+i.x),n.z=t.z*(Math.floor(o/256)+i.z),n.y=t.y*(a%256*256+o%256+i.y)})};class p{constructor(){e.EventDispatcher.call(this),this.id=e.GeometryIdCount++,this._type=2,this.needsUpdate=!1,this.decorations=null,this.indexBufferGPU=null,this.indexOffsetGPU=0,this.indexCountGPU=0,this.vertexBufferGPU=null,this.vertexOffsetGPU=0,this.vertexCountGPU=0,this.sharedBuffers=!1,this.noMeshInRAM=!1,this.vertexIndexArray=null,this.buffers=[],this.layout=new h,this.staleIndices=null,this.staleAttributes=null,this.revision=0,this.getVertexPosition=u.no_access,this.getVertexNormal=u.no_access,this.getVertexColor=u.no_access,this.getUV=u.no_access,this.getUV2=u.no_access,this.dynamic=!1,this.boundingBox=null,this.boundingSphere=null,this.lightMap=null,this.drawingGroups=[],this.meshList=[],this.wideLinesLinker=null,this.cpuPatternMatrix=null,this.editable=!1,this.__impl_compressedNormals=void 0,this.__impl_compressedVertices=void 0,this.__impl_compressedUVs=void 0,this.__impl_compressedColors=void 0,this.quantizedVector=null,this.offsetVector=null}static copyRaw({count:e,size:t,src_buffer:i,src_offset:r,src_stride:n,tgt_buffer:s,tgt_offset:a,tgt_stride:o}){let l=Uint8Array;t%4==0&&n%4==0&&o%4==0?(l=Uint32Array,t/=4,n/=4,o/=4):t%2==0&&n%2==0&&o%2==0&&(l=Uint16Array,t/=2,n/=2,o/=2);const h=new l(i,r),c=new l(s,a);for(let i=0;i<e;i++){const e=i*n,r=i*o;for(let i=0;i<t;i++)c[r+i]=h[e+i]}}static copyRawAttribute({source_bgds:t,source_attr:i,source_vertex_offset:r=0,target_array:n,target_attr:s,target_vertex_offset:a=0,num_vertices:o}){if(i.type||(i=t.layout.get(i)),i.type!==s.type)throw new Error(`Cannot copy attributes with different types (${i.type} -> ${s.type})`);if(o||(o=t.getVertexCount()),!o)return;const l=i.stride,h=s.stride,c=t.buffers[i.bufferId];p.copyRaw({count:o,size:e.VertexAttribute[i.type].size,src_buffer:c.buffer,tgt_buffer:n.buffer,src_offset:c.byteOffset+r*l+i.offset,tgt_offset:n.byteOffset+a*h+s.offset,src_stride:l,tgt_stride:h})}exportRaw({target_array:e,target_layout:t}){t.forEach(t=>{p.copyRawAttribute({source_bgds:this,source_attr:t.name,target_array:e,target_attr:t})})}markIndexStale(e,t){return e||(e=0),t||(t=this.vertexIndexArray.length),this.staleIndices?(this.staleIndices[0]=Math.min(this.staleIndices[0],e),this.staleIndices[1]=Math.max(this.staleIndices[1],t)):this.staleIndices=[e,t],this.revision++,!!(this.wideLinesLinker||this.vertexLineDistancesArray||this.vertexLinePixelDistancesArray||this.drawingGroups.filter(e=>null!==e._dependentDGs).length>0)&&(n.publish({event:"/VISU/_LINESHAPES_DG_UPDATE",data:{eventChannel:"/VISU/_LINESHAPES_DG_UPDATE",eventType:"@_LINESHAPES_DG_UPDATE",extraData:{geometry:this}}}),!0)}isStale(){return this.staleIndices||this.staleAttributes}isAttributeStale(e){return!(!this.staleAttributes||!this.staleAttributes.get(e))}markAttributeStale(e,t,i){t||(t=0),i||(i=this.getVertexCount()),this.staleAttributes||(this.staleAttributes=new Map);let r=this.staleAttributes.get(e);return r?(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i)):this.staleAttributes.set(e,[t,i]),this.revision++,!!(this.wideLinesLinker||this.vertexLineDistancesArray||this.vertexLinePixelDistancesArray||this.drawingGroups.filter(e=>null!==e._dependentDGs).length>0)&&(n.publish({event:"/VISU/_LINESHAPES_DG_UPDATE",data:{eventChannel:"/VISU/_LINESHAPES_DG_UPDATE",eventType:"@_LINESHAPES_DG_UPDATE",extraData:{geometry:this}}}),!0)}markAllAttributesStale(e,t){e||(e=0),t||(t=this.getVertexCount()),this.layout.forEach(i=>this.markAttributeStale(i.name,e,t))}_markIndexClean(){this.staleIndices=null}_markAttributeClean(e){this.staleAttributes.delete(e),0===this.staleAttributes.size&&(this.staleAttributes=null)}_markAllAttributesClean(){this.staleAttributes=null}getBuffersMemorySize(){let e=this.vertexIndexArray?this.vertexIndexArray.byteLength:0;for(let t=0;t<this.buffers.length;t++)this.buffers[t]&&(e+=this.buffers[t].byteLength);return e}getBufferWithAttribute(e,t){const i=this.layout.get(e);if(i){const e=this.buffers[i.bufferId];if(!t&&e&&e.buffer&&e.buffer instanceof ArrayBuffer){const t=r[i.type],n=t.size/t.components;return new t.className(e.buffer,e.byteOffset,e.byteLength/n)}return e}return null}getBufferIdWithAttribute(e){const t=this.layout.get(e);return t?t.bufferId:-1}_uploadStaleIndices(e){if(!this.staleIndices)return;const[t,i]=this.staleIndices;this._markIndexClean();const r=this.indexBufferGPU;if(!r)return;let n=this.vertexIndexArray.subarray(t,i);if(0!==this.vertexOffsetGPU){const e=this.vertexOffsetGPU;n=n.map(t=>t+e)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.buffer),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,(this.indexOffsetGPU+t)*r.bytesPerIndex,n)}_uploadStaleVertices(t){if(!this.staleAttributes)return;const i=this.staleAttributes;this._markAllAttributesClean();const r=this.vertexBufferGPU;if(!r)return;let n=2**32,s=-(2**32);if(i.forEach((t,i)=>{t[0]<n&&(n=t[0]),t[1]>s&&(s=t[1]),e.BufferGeometryDS.copyRawAttribute({source_bgds:this,source_attr:i,source_vertex_offset:t[0],target_array:r.interleavedData,target_attr:r.layout.get(i),target_vertex_offset:t[0]+this.vertexOffsetGPU,num_vertices:t[1]-t[0]})}),r.needsUpdate=!1,n>=s)return;const a=r.layout.pickAnyAttribute().stride,o=this.vertexOffsetGPU+a*n,l=this.vertexOffsetGPU+a*s,h=new Uint8Array(r.interleavedData.buffer,r.interleavedData.byteOffset+o,l-o);t.bindBuffer(t.ARRAY_BUFFER,r.buffer),t.bufferSubData(t.ARRAY_BUFFER,o,h)}_compactArrays(e){if(!e.has(this)){e.add(this);var t=this.drawingGroups;this.drawingGroups=new Array(t.length);for(var i=0;i<t.length;i++)this.drawingGroups[i]=t[i],t[i]._compactArrays();var r=this.meshList;this.meshList=new Array(r.length);for(i=0;i<r.length;i++)this.meshList[i]=r[i]}}getVertexCount(){if(0===this.buffers.length)return 0;const e=this.layout.pickAnyAttribute();return e&&this.buffers[e.bufferId]?this.buffers[e.bufferId].byteLength/e.stride:0}_updateAccessors(){this._updateVertexPositionAccessor(),this._updateVertexNormalAccessor(),this._updateVertexColorAccessor(),this._updateVertexUVAccessor(),this._updateVertexUV2Accessor()}_getVertexPositionAccessor(){const e=this.getBufferWithAttribute("position",this.compressedVertices);return e?this.compressedVertices?u.quantized_vec3(e,this.quantizedVector,this.offsetVector):u.raw_vec3(e):u.no_access}_updateVertexPositionAccessor(){this.getVertexPosition=this._getVertexPositionAccessor()}hasTangentBinormal(){return this.layout.has("tangent")&&this.layout.has("binormal")}clearMeshInRAM(e){e||(this.vertexIndexArray=null),this.buffers=[],this._updateAccessors()}clear(){this.clearMeshInRAM(),this.layout.clear(),this.needsUpdate=!0}_getVertexNormalAccessor(){const e=this.getBufferWithAttribute("normal",this.compressedNormals);if(!e)return u.no_access;return this.compressedNormals?function(t,i){const r=e[t],n=(s=r,{x:Math.floor(s/4096)/4095,y:s%4096/4095});var s,a,o;if(i.x=2*n.x-1,i.y=2*n.y-1,i.z=1-Math.abs(i.x)-Math.abs(i.y),i.z<=0){const e=(a=i.x,o=i.y,{x:a>=0?1:-1,y:o>=0?1:-1}),t=i.x;i.x=-Math.abs(i.y)*e.x+e.x,i.y=-Math.abs(t)*e.y+e.y}}:u.raw_vec3(e)}_updateVertexNormalAccessor(){this.getVertexNormal=this._getVertexNormalAccessor()}_getVertexColorAccessor(){const e=this.getBufferWithAttribute("color",this.compressedColors);if(!e)return u.no_access;return this.compressedColors?function(t,i){const r=e[2*t],n=e[2*t+1],s=Math.floor(r/65536),a=Math.floor(r/256)%256,o=r%256,l=n;return i.x=s/255,i.y=a/255,i.z=o/255,i.w=l/255,i}:function(t,i){const r=4*t;return i.x=e[r],i.y=e[r+1],i.z=e[r+2],i.w=e[r+3],i}}_updateVertexColorAccessor(){this.getVertexColor=this._getVertexColorAccessor()}_getVertexUVAccessor(e){if(!e)return u.no_access;return this.compressedUVs?function(t,i){var r=e[2*t],n=e[2*t+1],s=Math.floor(r/256),a=Math.floor(n/256),o=r%256*256+n%256;return i.x=s/65535,i.y=o/65535,i.z=a/65535,i}:u.raw_vec3(e)}_updateVertexUVAccessor(){this.getUV=this._getVertexUVAccessor(this.getBufferWithAttribute("uv",this.compressedUVs))}_updateVertexUV2Accessor(){this.getUV2=this._getVertexUVAccessor(this.getBufferWithAttribute("uv2",this.compressedUVs))}startIteration(){return!0}endIteration(){return!0}getDGRange(){const e=this.drawingGroups;let t=1/0,i=-1/0;for(let r=0;r<e.length;r++){const{start:n,count:s}=e[r];t=Math.min(t,n),i=Math.max(i,n+s)}return[t,i]}computeBoundingBox(){var t=[0,0,0],i=[0,0,0],r=this.getVertexCount();if(r>=1){t=[1/0,1/0,1/0],i=[-1/0,-1/0,-1/0];for(var n=new e.Vector3,s=0;s<r;s++)this.getVertexPosition(s,n),isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||(n.x<t[0]&&(t[0]=n.x),n.y<t[1]&&(t[1]=n.y),n.z<t[2]&&(t[2]=n.z),n.x>i[0]&&(i[0]=n.x),n.y>i[1]&&(i[1]=n.y),n.z>i[2]&&(i[2]=n.z))}return t=new e.Vector3(t[0],t[1],t[2]),i=new e.Vector3(i[0],i[1],i[2]),this.boundingBox=new e.Box3(t,i),this.boundingBox}_computeOrientedBoundingBox(t,i){if(!t)return null;var r=t.isIdentity(),n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,o=this.vertexIndexArray,l=this.getVertexCount();if(l>=1){var h=new e.Vector3;if(i)for(var c=!0,d=0;d<i.length;d++){var u=i[d];if(u.layerNum&&u.count){if(c){c=!1;var p=o[u.start];this.getVertexPosition(p,h),s.set(h.x,h.y,h.z),a.set(h.x,h.y,h.z),r||(s.applyMatrix4(t),a.applyMatrix4(t))}for(var f=u.start;f<u.start+u.count;f++){p=o[f];this.getVertexPosition(p,h),n.set(h.x,h.y,h.z),r||n.applyMatrix4(t),n.x<s.x&&(s.x=n.x),n.y<s.y&&(s.y=n.y),n.z<s.z&&(s.z=n.z),n.x>a.x&&(a.x=n.x),n.y>a.y&&(a.y=n.y),n.z>a.z&&(a.z=n.z)}}}else{this.getVertexPosition(0,h),s.set(h.x,h.y,h.z),a.set(h.x,h.y,h.z),r||(s.applyMatrix4(t),a.applyMatrix4(t));for(var g=1;g<l;g++)this.getVertexPosition(g,h),n.set(h.x,h.y,h.z),r||n.applyMatrix4(t),n.x<s.x&&(s.x=n.x),n.y<s.y&&(s.y=n.y),n.z<s.z&&(s.z=n.z),n.x>a.x&&(a.x=n.x),n.y>a.y&&(a.y=n.y),n.z>a.z&&(a.z=n.z)}}return new e.Box3(s,a)}computeBoundingSphere(){this.boundingSphere||(this.boundingSphere=new e.Sphere);var t=this.boundingBox;t&&(this.boundingSphere.radius=t.max.clone().sub(t.min).multiplyScalar(.5).length(),this.boundingSphere.center=t.max.clone().add(t.min).multiplyScalar(.5))}computeUVs(t){if(!this.vertexUvArray){var i=new Float32Array(3*this.getVertexCount());this.vertexUvArray=i;var r=new e.Vector3;if(this.vertexNormalArray){t||(t=this.computeBoundingBox());for(var n=[t.min.x,t.min.y,t.min.z],s=[t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z],a=0;a<i.length/3;a++){var o=3*a,l=new e.Vector3;this.getVertexNormal(a,l);var h=Math.abs(l.x),c=Math.abs(l.y),d=0;c>h&&(h=c,d=1),(c=Math.abs(l.z))>h&&(h=c,d=2);var u=(d+1)%3,p=(d+2)%3;this.getVertexPosition(a,r);var f=[r.x,r.y,r.z];i[o]=(f[u]-n[u])/Math.min(s[u],s[p]),i[o+1]=(f[p]-n[p])/Math.min(s[u],s[p]),i[o+2]=0}}}}_computeUV(t,i,r){var n=new e.Vector3,s=new e.Vector3;this.getVertexNormal(t,n),this.getVertexPosition(t,s);var a=Math.abs(n.x),o=Math.abs(n.y),l=0;o>a&&(a=o,l=1),(o=Math.abs(n.z))>a&&(a=o,l=2);var h=(l+1)%3,c=(l+2)%3,d=[i.min.x,i.min.y,i.min.z],u=[i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z],p=[s.x,s.y,s.z];r.set((p[h]-d[h])/Math.min(u[h],u[c]),(p[c]-d[c])/Math.min(u[h],u[c]))}computeTangents(t){let i=this.vertexTangentArray,r=this.vertexBinormalArray;if(r&&i)return;if(i){var n=new e.Vector3,s=new e.Vector3,a=new e.Vector3;r=this.vertexBinormalArray=new Float32Array(i.length);for(var o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),n.normalize(),s.set(i[o],i[o+1],i[o+2]),s.normalize(),a.crossVectors(n,s),r[o]=a.x,r[o+1]=a.y,r[o+2]=a.z;return}o=0;var l=0,h=0,c=0,d=new e.Vector3,u=new e.Vector3,p=new e.Vector3,f=new e.Vector2,g=new e.Vector2,m=new e.Vector2,v=new e.Vector2,_=new e.Vector2,y=new e.Vector3,S=new e.Vector3,x=new e.Vector3,b=(n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,new e.Vector3),w=0,M=0,C=0,P=0,E=0,T=0,A=0,D=3*this.getVertexCount();for(i||(i=this.vertexTangentArray=new Float32Array(D)),r||(r=this.vertexBinormalArray=new Float32Array(D)),o=0;o<i.length;o++)i[o]=0,r[o]=0;var I=this.computeBoundingBox(),R=this.vertexIndexArray;const O=this.vertexUvArray;for(var L=0;L<this.drawingGroups.length;L++){var V=this.drawingGroups[L];if(4===V.glType)for(o=V.start;o<V.start+V.count;o+=3){l=R[o],h=R[o+1],c=R[o+2],this.getVertexPosition(l,d),this.getVertexPosition(h,u),this.getVertexPosition(c,p),O?(this.getUV(l,f),this.getUV(h,g),this.getUV(c,m)):(this._computeUV(l,I,f),this._computeUV(h,I,g),this._computeUV(c,I,m)),y.subVectors(u,d),S.subVectors(p,d),v.subVectors(g,f),_.subVectors(m,f);var F=v.x*_.y-_.x*v.y;Math.abs(F)>1e-8?(w=(F=1/F)*(_.y*y.x-v.y*S.x),M=F*(_.y*y.y-v.y*S.y),C=F*(_.y*y.z-v.y*S.z),P=F*(v.x*S.x-_.x*y.x),E=F*(v.x*S.y-_.x*y.y),T=F*(v.x*S.z-_.x*y.z)):(w=1,M=0,C=0,P=0,E=1,T=0),i[3*l]+=w,i[3*h]+=w,i[3*c]+=w,i[3*l+1]+=M,i[3*h+1]+=M,i[3*c+1]+=M,i[3*l+2]+=C,i[3*h+2]+=C,i[3*c+2]+=C,r[3*l]+=P,r[3*h]+=P,r[3*c]+=P,r[3*l+1]+=E,r[3*h+1]+=E,r[3*c+1]+=E,r[3*l+2]+=T,r[3*h+2]+=T,r[3*c+2]+=T}}for(o=0;o<i.length;o+=3)this.getVertexNormal(o/3,n),s.set(i[o],i[o+1],i[o+2]),a.set(r[o],r[o+1],r[o+2]),s.normalize(),a.normalize(),A=n.dot(s),(b=(new e.Vector3).copy(s)).sub(x.copy(n).multiplyScalar(A)),b.normalize(),i[o]=b.x,i[o+1]=b.y,i[o+2]=b.z,r[o]=a.x,r[o+1]=a.y,r[o+2]=a.z}computeLineDistances(e){i._computeLineDistances(this,e)}computeWideLine(t,r){var n,s=!1;return!this.wideLinesLinker||this.wideLinesLinker._isStale()?(this.wideLinesLinker&&this.wideLinesLinker._isStale()&&(this.vertexLinePixelDistancesArray=null),this.wideLinesLinker&&(s=!0,this.wideLinesLinker.linkedGeometry.dispose()),(n=new e.BufferGeometryDS).revision=this.revision,n.editable=this.editable,new d(this,n)):n=this.wideLinesLinker.linkedGeometry,i._computeWideLineDG(this,n,t,r,s)}__setTypedArraysForWidelines(){var t=this.vertexPositionArray;if(!(t instanceof Float32Array)){var i=this.vertexPreviousPositionArray,r=this.vertexNextPositionArray,n=this.vertexSideExtrusionArray,s=this.vertexColorArray,a=this.vertexLineDistancesArray,o=this.vertexLinePixelDistancesArray,l=this.vertexPatternStartEndArray,h=this.vertexIndexArray;this.vertexPositionArray=new Float32Array(t),this.vertexPreviousPositionArray=new Float32Array(i),this.vertexNextPositionArray=new Float32Array(r),this.vertexSideExtrusionArray=new Float32Array(n),s&&(this.vertexColorArray=new Float32Array(s)),a&&(this.vertexLineDistancesArray=new Float32Array(a)),o&&(this.vertexLinePixelDistancesArray=new Float32Array(o)),l&&(this.vertexPatternStartEndArray=new Float32Array(l)),t.length>196608&&e.supportedExtensions.elementIndexUint?this.vertexIndexArray=new Uint32Array(h):this.vertexIndexArray=new Uint16Array(h)}}deallocate(e,t){t&&(this.vertexBufferGPU||this.indexBufferGPU)&&t.memory.geometries--,this.vertexBufferGPU&&(this.vertexBufferGPU.deallocate(e,t),this.vertexBufferGPU=null),this.indexBufferGPU&&(this.indexBufferGPU.deallocate(e,t),this.indexBufferGPU=null)}addRefVBO(t,i){i||this.meshList.push(t);var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount++;for(var i=t._getTextures(!1),n=0;n<i.length;n++){(s=i[n])&&s._source===e.AssetSource.MATERIAL_MANAGER&&s._useCount++}if(t._PDSFXData&&t._PDSFXData.pdsfxTextures)for(let i=0;i<t._PDSFXData.pdsfxTextures.length;i++){var s;(s=t._PDSFXData.pdsfxTextures[i].value)&&s._source===e.AssetSource.MATERIAL_MANAGER&&s._useCount++}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}};r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&t.matApp._lightMap.texture._useCount++);for(var n=0;n<this.drawingGroups.length;n++){var s=this.drawingGroups[n];r(s.material),r(s.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&this.lightMap._useCount++}releaseVBO(t,i){var r=function(t){if(t&&t._source===e.AssetSource.MATERIAL_MANAGER){t._useCount--,t._useCount<=0&&t.dispose();for(var i=t._getTextures(!1),n=0;n<i.length;n++){(s=i[n])&&s._source===e.AssetSource.MATERIAL_MANAGER&&(s._useCount--,s._useCount<=0&&s.dispose())}if(t._PDSFXData&&t._PDSFXData.pdsfxTextures)for(let i=0;i<t._PDSFXData.pdsfxTextures.length;i++){var s;(s=t._PDSFXData.pdsfxTextures[i].value)&&s._source===e.AssetSource.MATERIAL_MANAGER&&(s._useCount--,s._useCount<=0&&s.dispose())}r(t.line),r(t.politeMaterial),r(t.backMaterial),r(t.point)}},s=this.meshList.indexOf(t);if(-1!==s){i||this.meshList.splice(s,1),r(t.material),r(t.gas),t.matApp&&(r(t.matApp._material),r(t.matApp._materialGeomFace),r(t.matApp._materialLine),r(t.matApp._materialPoint),t.matApp._lightMap&&t.matApp._lightMap.texture&&t.matApp._lightMap.texture._source===e.AssetSource.MATERIAL_MANAGER&&(t.matApp._lightMap.texture._useCount--,t.matApp._lightMap.texture._useCount<=0&&t.matApp._lightMap.texture.dispose()));for(var a=0;a<this.drawingGroups.length;a++){var o=this.drawingGroups[a];r(o.material),r(o.gas)}this.lightMap&&this.lightMap._source===e.AssetSource.MATERIAL_MANAGER&&(this.lightMap._useCount--,this.lightMap._useCount<=0&&this.lightMap.dispose())}else console.warn("BufferGeometryDS tried to break the link with a THREE.Mesh, but it failed !");0===this.meshList.length&&(n.publish({event:"/VISU/_LINESHAPES_DG_UPDATE",data:{eventChannel:"/VISU/_LINESHAPES_DG_UPDATE",eventType:"@_LINESHAPES_DG_UPDATE",extraData:{geometry:this}}}),this.dispose())}dispose(){this.dispatchEvent({type:"dispose"})}clone(i){var r=new e.BufferGeometryDS;for(let e=0;e<this.buffers.length;e++)r.buffers.push(this.buffers[e].slice());r.layout=this.layout.clone(),r._updateAccessors(),r.compressedNormals=this.compressedNormals,r.compressedVertices=this.compressedVertices,r.compressedUVs=this.compressedUVs,r.compressedColors=this.compressedColors,this.vertexIndexArray&&(r.vertexIndexArray=this.vertexIndexArray.slice()),r.boundingBox=this.boundingBox?this.boundingBox.clone():null,r.boundingSphere=this.boundingSphere?this.boundingSphere.clone():null,r.offsetVector=this.offsetVector,r.quantizedVector=this.quantizedVector,r.drawingGroups=[];for(var n=0;n<this.drawingGroups.length;n++){var s=this.drawingGroups[n],a=[],o=new t.DrawingGroup(s.gas,s.material,s.glType,s.start,s.count,null,null,s._geomType,s.gasIndex);if(s instanceof t.DrawingGroup)for(l=0;l<s.getPrimitivesCount();l++){c=new t.SGPrimitive({type:s.getPrimitiveType(l),cgmId:s.getPrimitiveCgmId(l),rep:s.getPrimitiveRep(l),group:o,start:s.getPrimitiveStart(l),count:s.getPrimitiveCount(l)});a.push(c)}else for(var l=0;l<s._primitives.length;l++){var h=s._primitives[l],c=new t.SGPrimitive({type:h.type,cgmId:h.cgmId,rep:h.rep,group:o,start:h.start,count:h.count});a.push(c)}o.geometry=r,o._primitives=a,r.drawingGroups.push(o)}return r}merge(t,i,r){if(!t.layout||!this.layout)throw new Error("Need vertex layout to be able to merge buffers");if(t.layout.getSignature()!==this.layout.getSignature())throw new Error("Cannot merge buffers with different layouts");const n=this.getVertexCount(),s=t.getVertexCount(),a=this.layout.getBufferAttributes(),o=this.layout.getBufferStrides();for(let e=0;e<this.buffers.length;e++){const i=o[e],r=new Uint8Array(i*(n+s));r.set((l=this.buffers[e],new Uint8Array(l.buffer,l.byteOffset,l.byteLength)));const h=a[e];for(let e=0;e<h.length;e++)p.copyRawAttribute({source_bgds:t,source_attr:t.layout.get(h[e]),source_vertex_offset:0,target_array:r,target_attr:this.layout.get(h[e]),target_vertex_offset:n,num_vertices:s});this.buffers[e]=new Float32Array(r.buffer)}var l;this.markAllAttributesStale();const h=this.vertexIndexArray.length,c=t.vertexIndexArray.length,d=h+c>=65536?new Uint32Array(h+c):new Uint16Array(h+c);function u(e){e&&(e.isShared?(e.nbGeometries--,0===e.nbGeometries&&e.deallocate(i,r)):e.deallocate(i,r))}d.set(this.vertexIndexArray,0),d.set(t.vertexIndexArray.map(e=>e+n),h),this.vertexIndexArray=d,u(this.vertexBufferGPU),this.vertexBufferGPU=null,u(this.indexBufferGPU),this.indexBufferGPU=null;for(let e=0;e<t.drawingGroups.length;e++){let i=t.drawingGroups[e];i.geometry=this,i.start+=h;for(let e=0;e<i.getPrimitivesCount();e++)i._setPrimitiveStart(i.getPrimitiveStart(e)+h,e);this.drawingGroups.push(i)}for(let i=0;i<this.meshList.length;i++){let r=this.meshList[i];if(r.layer)for(let i=0;i<t.drawingGroups.length;i++){let n=t.drawingGroups[i],s=new e.DrawableInterval(1,n.start,n.count);s.primitiveStart=0,s.primitiveCount=n.getPrimitivesCount();let a=new e.LayerInterval(this,n,s);r.layer.layers.push(a)}}return this}}function f(t,i,r,n){t.buffers[i]?t.layout.setAttribute({name:r,type:n,offset:0,stride:e.VertexAttribute[n].size,bufferId:i}):t.layout.remove(r)}e.BufferGeometryDS=p;const g=new Map([["vertexPositionArray",(e,t)=>{f(e,t,"position",e.compressedVertices?"float32x2":"float32x3"),e._updateVertexPositionAccessor()}],["vertexNormalArray",(e,t)=>{f(e,t,"normal",e.compressedNormals?"float32":"float32x3"),e._updateVertexNormalAccessor()}],["vertexUvArray",(e,t)=>{f(e,t,"uv",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUVAccessor()}],["vertexUv2Array",(e,t)=>{f(e,t,"uv2",e.compressedUVs?"float32x2":"float32x3"),e._updateVertexUV2Accessor()}],["vertexColorArray",(e,t)=>{f(e,t,"color",e.compressedColors?"float32x2":"float32x4"),e._updateVertexColorAccessor()}],["vertexTangentArray",(e,t)=>f(e,t,"tangent","float32x3")],["vertexBinormalArray",(e,t)=>f(e,t,"binormal","float32x3")],["vertexLineDistancesArray",(e,t)=>f(e,t,"lineDistance","float32x2")],["vertexLinePixelDistancesArray",(e,t)=>f(e,t,"linePixelDistance","float32x2")],["vertexPatternStartEndArray",(e,t)=>f(e,t,"patternStartEnd","float32x2")],["vertexPreviousPositionArray",(e,t)=>f(e,t,"previousPos","float32x3")],["vertexNextPositionArray",(e,t)=>f(e,t,"followingPos","float32x3")],["vertexSideExtrusionArray",(e,t)=>f(e,t,"sideExtrusion","float32")],["vertexSkinIndexArray",(e,t)=>f(e,t,"skinIndex","float32x4")],["vertexSkinWeightArray",(e,t)=>f(e,t,"skinWeight","float32x4")]]),m=new Map([["vertexPositionArray","position"],["vertexNormalArray","normal"],["vertexUvArray","uv"],["vertexUv2Array","uv2"],["vertexColorArray","color"],["vertexTangentArray","tangent"],["vertexBinormalArray","binormal"],["vertexLineDistancesArray","lineDistance"],["vertexLinePixelDistancesArray","linePixelDistance"],["vertexPatternStartEndArray","patternStartEnd"],["vertexPreviousPositionArray","previousPos"],["vertexNextPositionArray","followingPos"],["vertexSideExtrusionArray","sideExtrusion"],["vertexSkinIndexArray","skinIndex"],["vertexSkinWeightArray","skinWeight"]]);function v(t){const i=m.get(t);Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){return this.getBufferWithAttribute(i,!0)},set:function(e){let r=this.getBufferIdWithAttribute(i);-1===r&&(r=this.buffers.length),this.buffers[r]=e,g.get(t)(this,r)}})}function _(t,i,r=!1){const n=`__impl_${t}`,s=i.map(e=>m.get(e));Object.defineProperty(e.BufferGeometryDS.prototype,t,{get:function(){return void 0===this[n]&&(this[n]=r),this[n]},set:function(e){this[n]=e;for(let e=0;e<s.length;e++){const t=this.getBufferIdWithAttribute(s[e]);-1!==t&&g.get(i[e])(this,t)}}})}function y(e,t){Object.defineProperty(e.prototype,t,{get:()=>{throw new Error(`(GET) Invalid property: ${t}`)},set:()=>{throw new Error(`(SET) Invalid property: ${t}`)}})}return _("compressedNormals",["vertexNormalArray"]),_("compressedVertices",["vertexPositionArray"]),_("compressedUVs",["vertexUvArray","vertexUv2Array"]),_("compressedColors",["vertexColorArray"]),v("vertexPositionArray"),v("vertexNormalArray"),v("vertexUvArray"),v("vertexUv2Array"),v("vertexTangentArray"),v("vertexBinormalArray"),v("vertexColorArray"),v("vertexLineDistancesArray"),v("vertexLinePixelDistancesArray"),v("vertexPatternStartEndArray"),v("vertexPreviousPositionArray"),v("vertexNextPositionArray"),v("vertexSideExtrusionArray"),v("vertexSkinIndexArray"),v("vertexSkinWeightArray"),y(e.GLVertexBuffer,"indexBuffer"),y(e.GLVertexBuffer,"indexNumItems"),y(e.GLVertexBuffer,"indexData"),y(e.GLVertexBuffer,"numItems"),y(e.GLVertexBuffer,"geometries"),y(e.GLVertexBuffer,"start"),y(e.GLVertexBuffer,"count"),y(e.BufferGeometryDS,"glFormatTypeIndex"),y(e.BufferGeometryDS,"use32bitIndexBuffer"),y(e.BufferGeometryDS,"itemSize"),y(e.BufferGeometryDS,"numItems"),e}),define("DS/Visualization/Polygon",["DS/Visualization/ThreeJS_R57"],function(e){"use strict";var t={};const i=function(){this.corner=[]};i.prototype={constructor:i,clone:function(e){var t=e||new i;t.empty();for(var r=0;r<this.corner.length;r++)t.addPoint(this.corner[r]);return t},empty:function(){this.corner=[]},applyMatrix4:function(e){for(var t=0;t<this.corner.length;t++)this.corner[t].applyMatrix4(e);return this},addPoint:function(t){return this.corner.push((new e.Vector3).copy(t)),this},addPoints:function(e){return this.corner=e,this},addPointAtIndex:function(t,i){return this.corner[t]=new e.Vector3,this.corner[t].copy(i),this},clipByPlane:function(t,r){var n=new i,s=this.corner.length;if(s<3)return n;for(var a=[],o=0;o<s;o++)a[o]=t.distanceToPoint(this.corner[o])>0;for(o=0;o<s;o++){var l=(o+1)%s;if(!a[o]||!a[l])if(a[o]){var h=new e.Vector3,c=new e.Line3(this.corner[o],this.corner[l]);void 0!==t.intersectLine(c,h)&&(r.addPoint(h),n.addPoint(h)),r.addPoint(this.corner[l])}else if(a[l]){h=new e.Vector3,c=new e.Line3(this.corner[o],this.corner[l]);void 0!==t.intersectLine(c,h)&&(r.addPoint(h),n.addPoint(h))}else r.addPoint(this.corner[l])}return n.corner.length&&2!==n.corner.length&&(this.clone(r),n.empty()),n}},t.CGPolygon=i;const r=function(){return this.polygon=[],this};r.prototype={constructor:r,addPolygon:function(e){this.polygon.push(e)},removePolygon:function(e){e>=this.polygon.length||e<0?console.log("CGPoly: trying to remove a polygon which does not exist !"):this.polygon.splice(e,1)},empty:function(){this.polygon=[]},clone:function(e){var t=e||new r;t.empty();for(var i=0;i<this.polygon.length;i++)t.addPolygon(this.polygon[i].clone());return t},applyMatrix4:function(e){for(var t=0;t<this.polygon.length;t++)this.polygon[t].applyMatrix4(e);return this},setFromBox:function(t){var i;(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.min)),i.addPoint(new e.Vector3(t.min.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.min.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.min)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.min.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.min)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.min.y,t.max.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.max)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.min.z)),i.addPoint(new e.Vector3(t.max.x,t.max.y,t.min.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.max)),i.addPoint(new e.Vector3(t.max.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.min.z)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.max.z)),this.addPolygon(i),(i=new e.CGPolygon).addPoint((new e.Vector3).copy(t.max)),i.addPoint(new e.Vector3(t.min.x,t.max.y,t.max.z)),i.addPoint(new e.Vector3(t.min.x,t.min.y,t.max.z)),i.addPoint(new e.Vector3(t.max.x,t.min.y,t.max.z)),this.addPolygon(i)},setFromFrustumPoints:function(t){for(var i=new e.CGPolygon,r=0;r<4;r++)i.addPoint((new e.Vector3).copy(t[r]));this.addPolygon(i),i=new e.CGPolygon;for(r=4;r<8;r++)i.addPointAtIndex(r-4,(new e.Vector3).copy(t[11-r]));this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[0]),i.addPoint(t[3]),i.addPoint(t[7]),i.addPoint(t[4]),this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[1]),i.addPoint(t[5]),i.addPoint(t[6]),i.addPoint(t[2]),this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[4]),i.addPoint(t[5]),i.addPoint(t[1]),i.addPoint(t[0]),this.addPolygon(i),(i=new e.CGPolygon).addPoint(t[6]),i.addPoint(t[7]),i.addPoint(t[3]),i.addPoint(t[2]),this.addPolygon(i)},clipByPlane:function(t){var i,n,s=new r,a=new r;for(i=0;i<this.polygon.length;i++){var o=new e.CGPolygon,l=this.polygon[i].clipByPlane(t,o);o.corner.length&&(s.addPolygon(o),l.corner.length&&2===l.corner.length?a.addPolygon(l):l.corner.length>0&&console.log("plane / polygon intersection is not a segment : "+l.corner.length+" points"))}if(a.polygon.length>=3){var h=new e.CGPolygon,c=a.polygon[a.polygon.length-1];for(h.addPoint(c.corner[0]),h.addPoint(c.corner[1]),a.removePolygon(a.polygon.length-1);a.polygon.length>0;){var d=h.corner[h.corner.length-1],u=1/0,p=-1,f=-1;for(i=0;i<a.polygon.length;i++){var g=a.polygon[i];if(2===g.corner.length){for(n=0;n<g.corner.length;n++){var m=g.corner[n].distanceToSquared(d);if(m<1e-4)break;m<u&&(u=m,p=i,f=n)}if(n<g.corner.length){h.addPoint(g.corner[(n+1)%2]);break}}else console.log("convex hull clipping : intersection segment has length > 2")}if(i<a.polygon.length)a.removePolygon(i);else{if(!(p>=0)){console.log("failed to build the intersection polygon btw polyhedra and plane");break}h.addPoint(a.polygon[p].corner[(f+1)%2]),a.removePolygon(p)}}h.corner.splice(h.corner.length-1,1),s.addPolygon(h)}return s},clipByPlanes:function(e){if(!e.length)return null;for(var t=this.clipByPlane(e[0]),i=1;i<e.length;i++)t=t.clipByPlane(e[i]);return t},clipByBox:function(e){for(var t=e.getPlanes(),i=this.clipByPlane(t[0]),r=1;r<6;r++)i=i.clipByPlane(t[r]);return i},getPoints:function(){var e,t,i,r=[];for(t=0;t<this.polygon.length;t++)for(e=this.polygon[t],i=0;i<e.corner.length;i++)r.push(e.corner[i]);return r}},t.CGPoly=r;return t.CGPolyHelper=class extends e.Line{constructor(t){super(),this._tokens={},this.frustumCulled=!1,this.geometry=new e.Geometry,this.material=new e.LineBasicMaterial({color:16777215,vertexColors:e.VertexColorType.Face}),this.type=e.LinePieces,this.matrixWorld=new e.Matrix4,this.matrixAutoUpdate=!1;for(var i=0;i<1e3;i++)this.geometry.vertices.push(new e.Vector3),this.geometry.colors.push(new e.Color(16711680));this.update(t,new e.Color(16711680))}update(t,i){var r,n=0;for(r=0;r<t.polygon.length;r++)for(var s=t.polygon[r],a=s.corner.length,o=0;o<a;o++){var l=s.corner[o];this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(i),n++,l=s.corner[(o+1)%a],this.geometry.vertices[n].copy(l),this.geometry.colors[n].copy(i),n++}var h=n>0?this.geometry.vertices[n-1]:new e.Vector3;for(r=n;r<1e3;r++)this.geometry.vertices[r].copy(h),this.geometry.colors[r].copy(i);this.geometry.verticesNeedUpdate=!0,this.geometry.colorsNeedUpdate=!0}},t}),define("DS/Visualization/ThreeJS_DS",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/Ray","DS/Intersection/Raycaster","DS/Visualization/BufferGeometry","DS/Shaders/DeferredShaders","DS/ShaderBuilders/PostPro/HighlightShaderBuilders","DS/Materials/DeferredCaches","DS/RenderEngineUtils/RenderEngineUtils","DS/Visualization/Layers","DS/Object3D/Object3D","DS/Object3D/Mesh","DS/Visualization/Polygon"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f){"use strict";var g,m;window.SIMULATE_EXPERIENCE_PLAYER,new i.Color;i.mobileVersion=!1,i._mobileHighlight=!0,i._mobileDevice=!1,i._vrDevice=!1,i._appleDevice=!1,i._visuFaceMaterialsAsPBR=!1,i._CATGraphicalAsPBR=!0,i._GASFaceMaterialsAsPBR=!1,i._NREGASOnNodeInit=!1,i._DeferredShaders=o,i._AdvancedHighlightShader=l,i.DefaultNormalDepthMaterials=h.DefaultNormalDepthMaterials,i.DefaultShadowDepthMaterials=h.DefaultShadowDepthMaterials,i.DefaultPickingMaterials=h.DefaultPickingMaterials,i.DefaultHighlightMaterials=h.DefaultHighlightMaterials,i.DefaultMaterials=h.DefaultMaterials,i.PredefinedMaterials=h.PredefinedMaterials,i.GeomTypeMaterials=h.GeomTypeMaterials,i.DeferredMaterial=h.DeferredMaterial,i.__tmpIsA2X=!1,window.webVisuPerfo||(window.webVisuPerfo={startPerfo:function(){},endPerfo:function(){},setStats:function(){}}),i.getPixelsPerMM=function(){return 96/25.4},Object.assign(i,f),i.BackgroundViewMode={NORMAL:0,FOG:1,LOWLIGHT:2,GHOST:3,NO_DISPLAY:4},i._loadPredefinedMaterialTextures=h._loadPredefinedMaterialTextures,i.MaterialUtils={_addParameters:function(e,t,i){for(var r=0;r<i.length;r++)void 0!==t[i[r]]&&(e[i[r]]=t[i[r]]);var n=["line","point","depthWrite","depthTest","colorWrite","side","forceSide","force","transparent","polite","enableClipPlanes","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","overridable","iterative","name"];for(r=0;r<n.length;r++)void 0!==t[n[r]]&&(e[n[r]]=t[n[r]])},convertShininessToIoRRoughness:function(e){return null==e?{ior:1.5,roughness:.34}:(e>1&&(e=Math.min(e/128,1)),{ior:1.5,roughness:1-e})},createShinyFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshPhongMaterial(e);var t={shininess:30};e&&this._addParameters(t,e,["color","map","shininess","opacity","alphaTest","vertexColors","useLighting"]);var r=this.convertShininessToIoRRoughness(t.shininess);return Object.assign(t,r),new i.DSPBR19xMaterial(t)},createMatteFaceMaterial:function(e){if(!i._visuFaceMaterialsAsPBR)return e&&e.color&&!e.ambient&&(e.ambient=e.color),new i.MeshLambertMaterial(e);var t={specularContrib:0};return e&&this._addParameters(t,e,["color","map","opacity","alphaTest","vertexColors","useLighting"]),new i.DSPBR19xMaterial(t)}},i.TangentToWorld=(g=new i.Vector3,m=new i.Vector3,function(e,t){var i=Math.abs(t.z)<.999?g.set(0,0,1):g.set(1,0,0);m.crossVectors(i,t);var r=m.normalize(),n=g.crossVectors(t,r);return r.multiplyScalar(e.x),n.multiplyScalar(e.y),r.add(n),n.copy(t),n.multiplyScalar(e.z),r.add(n),r}),i.RandomLib={_tmpVec2:new i.Vector2,_tmpVec3:new i.Vector3,HaltonSequence:function(e,t){for(var i=0,r=1/t,n=r;e>0;){i+=e%t*n,e=Math.floor(e/t),n*=r}return i},LowDiscrepancy2D:function(e,t,i,r){var n=this._tmpVec2;return n.x=this.HaltonSequence(e,2),n.y=this.HaltonSequence(e,5),n},computeHaltonSequence4D:function(e){for(var t=e*e,r=new Float32Array(4*t),n=0;n<t;n++)r[4*n]=this.HaltonSequence(n,2),r[4*n+1]=this.HaltonSequence(n,5),r[4*n+2]=this.HaltonSequence(n,7),r[4*n+3]=this.HaltonSequence(n,9);return new i.DataTexture(r,e,e,i.RGBAFormat,i.FloatType)}},i.LODTextureData=function(e,t,i,r,n){this.imageData=e,this.bufferData=t,this.loadCB=i,this.type=r,this.basisUsage=n};i.CSS2DNode=class extends u{constructor(e,t,r){super(),this.element=e||document.createElement("div"),this.element.renderable=this,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.position=t||(this.position?this.position:new i.Vector3),this.pickable=!0,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere,this.offset=r||(this.offset?this.offset:new i.Vector2)}},i.DisplayList=c.DisplayList,i.Ray=n,i.Raycaster=s,i.KDTree=null;i.CurvedPipeMesh=class extends p{constructor(e,t,i){super(e,t,i),this.isCurvedPipe=!0,this._capWorldRadius=0,this._nbLODsMinusOne=0,this.currentLOD=-1}clone(){var e=new i.CurvedPipeMesh(this.geometry,this.material);return super.clone(e),e}getMin(e){void 0===e&&(e="z");var t="x"===e?0:"y"===e?1:2,i=this.getNode();if(!i)return null;for(var r=null,n=0;n<i._pipes.length;n++){var s=i._pipes[n];if(!(s.curvePoints.length<2))for(var a=t;a<s.curvePoints.length;a+=3){var o=s.curvePoints[a]-s.radius;(o<r||null===r)&&(r=o)}}return r}_computeLOD(e,t){if(-1===this.currentLOD||!(e._renderingRole<i._CameraRoles._PRINCIPAL_START||e._renderingRole>=i._CameraRoles._NON_PRINCIPAL_START)){var r=this._nbLODsMinusOne;if(0===r)return t.currentLOD=0,void(this.currentLOD=0);var n=this._capWorldRadius/e._cstLOD;if(!e.isOrtho){var s=this.worldCenter,a=e.matrixWorldInverse.elements,o=Math.abs(a[2]*s.x+a[6]*s.y+a[10]*s.z+a[14])-this.worldRadius;if(o<=0)return r;n/=o}var l=Math.min(r,Math.floor((n+11)/27));(l=Math.max(l,0))!==t.currentLOD&&(t.invalidated=!0,t.currentLOD=l,this.currentLOD=l)}}};i.LensFlare=class extends u{constructor(e,t,r,n,s){super(),this.lensFlares=[],this.positionScreen=new i.Vector3,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,r,n,s)}add(e,t,r,n,s,a){void 0===t&&(t=-1),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=new i.Color(16777215)),void 0===n&&(n=i.NormalBlending),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:e,size:t,distance:r,x:0,y:0,z:0,scale:1,rotation:1,opacity:a,color:s,blending:n})}updateLensFlares(){var e,t,i=this.lensFlares.length,r=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<i;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+r*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}clone(e){void 0===e&&(e=new i.LensFlare),super.clone(e),e.positionScreen.copy(this.positionScreen),e.customUpdateCallback=this.customUpdateCallback;for(var t=0;t<this.lensFlares.length;t++){var r=this.lensFlares[t],n={texture:r.texture,size:r.size,distance:r.distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:r.opacity,color:r.color.clone(),blending:r.blending};e.lensFlares.push(n)}return e}};var v={vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 screenPositionFlare;","uniform sampler2D tNormalDepth;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","float visibility = 0.0;","float depth1 = texture2D( tNormalDepth, screenPositionFlare.xy ).w;","float depth2 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005,  0.005) ).w;","float depth3 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2( 0.005, -0.005) ).w;","float depth4 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005,  0.005) ).w;","float depth5 = texture2D( tNormalDepth, screenPositionFlare.xy + vec2(-0.005, -0.005) ).w;","if ((depth1 == 0.0) || (screenPositionFlare.z < depth1)) visibility += 0.2;","if ((depth2 == 0.0) || (screenPositionFlare.z < depth2)) visibility += 0.2;","if ((depth3 == 0.0) || (screenPositionFlare.z < depth3)) visibility += 0.2;","if ((depth4 == 0.0) || (screenPositionFlare.z < depth4)) visibility += 0.2;","if ((depth5 == 0.0) || (screenPositionFlare.z < depth5)) visibility += 0.2;","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}"].join("\n")};return i.LensFlarePlugin=function(){var e,t,r;this._lensFlare={},this.init=function(i){if(e=i.context){t=i;var n=this._lensFlare;r=i.getPrecision(),n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var s,a,o,l,h,c,d=0;n.vertices[d++]=-1,n.vertices[d++]=-1,n.vertices[d++]=0,n.vertices[d++]=0,n.vertices[d++]=1,n.vertices[d++]=-1,n.vertices[d++]=1,n.vertices[d++]=0,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=1,n.vertices[d++]=-1,n.vertices[d++]=1,n.vertices[d++]=0,n.vertices[d++]=1,d=0,n.faces[d++]=0,n.faces[d++]=1,n.faces[d++]=2,n.faces[d++]=0,n.faces[d++]=2,n.faces[d++]=3,n.vertexBuffer=e.createBuffer(),n.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,n.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n.faces,e.STATIC_DRAW),n.program=(s=v,a=r,o=e.createProgram(),l=e.createShader(e.FRAGMENT_SHADER),h=e.createShader(e.VERTEX_SHADER),c="precision "+a+" float;\n",e.shaderSource(l,c+s.fragmentShader),e.shaderSource(h,c+s.vertexShader),e.compileShader(l),e.compileShader(h),e.attachShader(o,l),e.attachShader(o,h),e.linkProgram(o),e.deleteShader(l),e.deleteShader(h),o),n.attributes={},n.uniforms={},n.attributes.vertex=e.getAttribLocation(n.program,"position"),n.attributes.uv=e.getAttribLocation(n.program,"uv"),n.uniforms.map=e.getUniformLocation(n.program,"map"),n.uniforms.tNormalDepth={location:null,value:null},n.uniforms.tNormalDepth.location=e.getUniformLocation(n.program,"tNormalDepth"),n.uniforms.opacity=e.getUniformLocation(n.program,"opacity"),n.uniforms.color=e.getUniformLocation(n.program,"color"),n.uniforms.scale=e.getUniformLocation(n.program,"scale"),n.uniforms.rotation=e.getUniformLocation(n.program,"rotation"),n.uniforms.screenPosition=e.getUniformLocation(n.program,"screenPosition"),n.uniforms.screenPositionFlare=e.getUniformLocation(n.program,"screenPositionFlare")}},this.dispose=function(){e&&(e.deleteBuffer(this._lensFlare.vertexBuffer),e.deleteBuffer(this._lensFlare.elementBuffer),e.deleteProgram(this._lensFlare.program))},this.render=function(r,n,s,a){var o=r.__webglFlares,l=o.length;if(l&&t.lensFlareEnabled){var h,c,d,u,p,f=this._lensFlare,g=new i.Vector3,m=a/s,v=.5*s,_=.5*a,y=16/a,S=new i.Vector2(y*m,y),x=new i.Vector3(1,1,0),b=new i.Vector2(1,1),w=f.uniforms,M=f.attributes;for(e.useProgram(f.program),e.enableVertexAttribArray(f.attributes.vertex),e.enableVertexAttribArray(f.attributes.uv),t.setTexture(w.tNormalDepth.value,0),e.uniform1i(w.tNormalDepth.location,0),e.uniform1i(w.map,1),e.bindBuffer(e.ARRAY_BUFFER,f.vertexBuffer),e.vertexAttribPointer(M.vertex,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(M.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.elementBuffer),e.disable(e.CULL_FACE),e.depthMask(!1),h=0;h<l;h++)if(y=16/a,S.set(y*m,y),u=o[h],g.set(u.matrixWorld.elements[12],u.matrixWorld.elements[13],u.matrixWorld.elements[14]),g.applyMatrix4(n.matrixWorldInverse),!(g.z>0)){g.applyProjection(n.projectionMatrix);var C=.5+.5*g.z;if(x.copy(g),b.x=x.x*v+v,b.y=x.y*_+_,b.x>0&&b.x<s&&b.y>0&&b.y<a)for(e.disable(e.DEPTH_TEST),e.uniform3f(w.screenPositionFlare,.5*(x.x+1),.5*(x.y+1),C),u.positionScreen.copy(x),u.customUpdateCallback?u.customUpdateCallback(u):u.updateLensFlares(),e.uniform1i(w.renderType,2),e.enable(e.BLEND),c=0,d=u.lensFlares.length;c<d;c++)(p=u.lensFlares[c]).opacity>.001&&p.scale>.001&&(x.x=p.x,x.y=p.y,x.z=p.z,y=p.size*p.scale/a,S.x=y*m,S.y=y,e.uniform3f(w.screenPosition,x.x,x.y,x.z),e.uniform2f(w.scale,S.x,S.y),e.uniform1f(w.rotation,p.rotation),e.uniform1f(w.opacity,p.opacity),e.uniform3f(w.color,p.color.r,p.color.g,p.color.b),t.setBlending(p.blending,p.blendEquation,p.blendSrc,p.blendDst),t.setTexture(p.texture,1),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}}},i.createPlaneGeometryDS=function(e,t,n){var s=new i.BufferGeometryDS;s.vertexIndexArray=new Uint16Array(6),s.vertexPositionArray=new Float32Array(12),s.vertexNormalArray=new Float32Array(12),s.vertexUvArray=new Float32Array(12);var a=new r.SGRep({solid:!1}),o=[],l=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,4,0,6,o,void 0,i.GeomTypeEnum.UNKNOWN,0);l.geometry=s,s.drawingGroups.push(l);var h=new r.SGPrimitive({start:0,count:6,cgmId:0,rep:a,group:l});o.push(h),a._primitives.push(h);var c=s.vertexIndexArray;c[0]=0,c[1]=1,c[2]=3,c[3]=1,c[4]=2,c[5]=3;var d=s.vertexPositionArray;d[0]=-.5*e,d[1]=.5*t,d[2]=0,d[3]=-.5*e,d[4]=-.5*t,d[5]=0,d[6]=.5*e,d[7]=-.5*t,d[8]=0,d[9]=.5*e,d[10]=.5*t,d[11]=0;for(var u=s.vertexNormalArray,p=0;p<4;p++)u[3*p]=0,u[3*p+1]=0,u[3*p+2]=1;var f=s.vertexUvArray;return f[0]=0,f[1]=n?0:1,f[2]=0,f[3]=0,f[4]=n?1:0,f[5]=0,f[6]=1,f[7]=n?1:0,f[8]=0,f[9]=1,f[10]=n?0:1,f[11]=0,s.computeBoundingBox(),s.computeBoundingSphere(),s},i.convertParticleSystemToBufferGeometryDS=function(e){if(e&&0===e._type&&e.vertices){var t=e.vertices.length,n=new i.BufferGeometryDS;n.vertexPositionArray=new Float32Array(3*t),n.vertexPositionArray.nonindexedPoints=!0,n.vertexIndexArray=new Uint16Array(1),n.vertexIndexArray[0]=0;var s=new r.SGRep({solid:!1}),a=[],o=new r.DrawingGroup(i.MaterialUtils.createShinyFaceMaterial({side:i.DoubleSide,color:new i.Color(16777215)}),null,0,0,t,a,void 0,i.GeomTypeEnum.UNKNOWN,0);o.geometry=n,n.drawingGroups.push(o);var l=new r.SGPrimitive({start:0,count:t,cgmId:0,rep:s,group:o});a.push(l),s._primitives.push(l);for(var h=n.vertexPositionArray,c=0;c<t;c++)h[3*c]=e.vertices[c].x,h[3*c+1]=e.vertices[c].y,h[3*c+2]=e.vertices[c].z;return n.computeBoundingBox(),n.computeBoundingSphere(),n}},i.DrawableInterval=d.DrawableInterval,i.LayerInterval=d.LayerInterval,i.BufferLayer=d.BufferLayer,i.EventTarget=function(){var e={};this.addEventListener=function(t,i){null==e[t]&&(e[t]=[]),-1===e[t].indexOf(i)&&e[t].push(i)},this.dispatchEvent=function(t){for(var i in e[t.type])e[t.type].hasOwnProperty(i)&&e[t.type][i](t)},this.removeEventListener=function(t,i){var r=e[t].indexOf(i);-1!==r&&e[t].splice(r,1)}},i.CSSSVGNode=class extends u{constructor(e){super(),this.element=e,this.element.renderable=this,this.geometry=new i.Geometry,this.geometry.boundingSphere=new i.Sphere}},UWA.namespace("THREEDS/Core",i)}),define("Visualization/ThreeJS_DS",["DS/Visualization/ThreeJS_DS","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ThreeJS_DS"),e}),define("DS/Visualization/IESUtils",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={nbTexturesBeingLoaded:0,crossOrigin:"anonymous",loadIESTexture:function(i,r,n,s,a,o){var l=new e.DataTexture(null,128,128,e.LuminanceFormat,e.FloatType);l.mapping=r,l.generateMipmaps=!1,l.loadEndStatus=e.AssetLoadingStatus.LOADING;var h=new XMLHttpRequest;return h.onload=function(){t.nbTexturesBeingLoaded--;var i,r=t.parserIES(h.response);for(l.image.data=r,l.loadEndStatus=e.AssetLoadingStatus.READY,l.generateMipmaps=!1,l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,l.needsUpdate=!0,n&&n(l),i=0;i<l.onLoadCallbacks.length;i++)l.onLoadCallbacks[i](l)},h.onerror=function(){s(),t.nbTexturesBeingLoaded--,l.loadEndStatus=e.AssetLoadingStatus.ERROR},o?(l.loadEndStatus=e.AssetLoadingStatus.PAUSED,l.onRequest=function(){l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="text",h.withCredentials=!!a,h.send(null),l.onRequest=null}):(l.loadEndStatus=e.AssetLoadingStatus.LOADING,t.nbTexturesBeingLoaded++,h.open("GET",i,!0),h.responseType="text",h.withCredentials=!!a,h.send(null)),l},parserIES:function(e){var t=e.lastIndexOf("TILT="),i=e.slice(t);t=i.indexOf("\n"),i=(i=(i=(i=i.slice(t+1)).replace(/\n|\s|\r/g,"_")).replace("__","_")).split("_");for(var r=[],n=0;n<i.length;n++)""!=i[n]&&(r[r.length]=parseFloat(i[n]));i=null;var s,a,o,l,h,c,d=-1,u=-1,p=-1;r[0],r[1],r[2],s=r[3],a=r[4],o=r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],c=13,l=[s],h=[a];for(var f=[],g=new Float32Array(16384),m=0;m<128;m++)for(var v=0;v<128;v++)g[128*m+v]=0;for(var _=0;_<s;_++)l[_]=r[_+c];c+=parseInt(s);for(var y=0;y<a;y++)h[y]=r[y+c];if(c+=parseInt(a),1==o){90==l[s-1]?u=1:180==l[s-1]&&(u=2),1==a&&0==h[0]?d=0:90==h[a-1]?d=1:180==h[a-1]&&(d=2);for(y=0;y<a;y++)for(_=0;_<s;_++){var S=r[_+y*s+c];p=p<S?S:p}if(0==d){a=2,h[1]=180;for(_=0;_<s;_++)r[_+s+c]=r[_+c]}if(1==d){if(1==u){for(y=0;y<a;y++){var x=90-(h[y]-90);f[h[y]]=[2*s],f[x]=[2*s];for(_=0;_<s;_++){var b=90-(l[_]-90);f[h[y]][l[_]]=f[x][l[_]]=f[h[y]][b]=f[x][b]=r[_+y*s+c]/p}}for(_=0;_<s-1;_++)l.push(90-(l[_]-90))}else if(2==u)for(y=0;y<a;y++){x=90-(h[y]-90);f[h[y]]=[2*s],f[x]=[2*s];for(_=0;_<s;_++)f[h[y]][l[_]]=f[x][l[_]]=r[_+y*s+c]/p}for(y=0;y<a-1;y++)h.push(90-(h[y]-90))}else if(0==d||2==d){if(1==u){for(y=0;y<a;y++){f[h[y]]=[2*s];for(_=0;_<s;_++){b=90-(l[_]-90);f[h[y]][l[_]]=f[h[y]][b]=r[_+y*s+c]/p}}for(_=0;_<s-1;_++)l.push(90-(l[_]-90))}else if(2==u)for(y=0;y<a;y++){f[h[y]]=[s];for(_=0;_<s;_++)f[h[y]][l[_]]=r[_+y*s+c]/p}}else console.log("Erreur symetricHType "+d);h=h.sort(function(e,t){return e-t}),l=l.sort(function(e,t){return e-t});var w=h[0],M=h[1],C=1;for(y=0;y<180;y+=1.40625){for(;y>M;)w=M,M=h[C+1],C++;var P=l[0],E=l[1],T=1,A=(y-w)/(M-w);for(_=0;_<180;_+=1.40625){for(;_>E;)P=E,E=l[T+1],T++;var D=(_-P)/(E-P),I=(1-D)*f[w][P]+D*f[w][E],R=(1-D)*f[M][P]+D*f[M][E];g[y/1.40625*128+_/1.40625]=(1-A)*I+A*R}}}else console.log("Mauvais Gonio Type");return g}};return t}),define("DS/Visualization/ColladaLoader",["DS/VisuLoaders/ColladaLoader","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return t}),define("DS/Visualization/CameraSystem",["UWA/Class","DS/Shaders/StereoShaders","DS/ShaderBuilders/PostPro/StereoShaderBuilders","DS/Plugins/ShaderPass_New","DS/Plugins/RenderPass","DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass"],function(e,t,i,r,n,s,a){"use strict";var o=e.extend({init:function(){this._computeCameraArrayCB=null,this._predefinedCombineShader=null,this._shaderParameters=null,this._extFrameBuffer=null},setComputeCameraArrayCB:function(e,t){this._computeCameraArrayCB=e,this.useExternalProjectionMatrix=!!t},setUsePredefinedCombineShader:function(e,t){this._predefinedCombineShader=e,this._shaderParameters=t;var i=l[this._predefinedCombineShader];i.warmup&&i.warmup()},getViewportSize:function(e,t){return l[this._predefinedCombineShader].getViewportSize.apply(this,arguments)},computeCameraArray:function(e,t,i){var r,n=this._computeCameraArrayCB(e,t,i);for(r=0;n&&r<n.length;r++)n[r].updateMatrix(),n[r].updateMatrixWorld(),n[r].updateProjectionMatrix(),n[r].projectionMatrixInverse.getInverse(n[r].projectionMatrix);return n},getUniformName:function(e){return l[this._predefinedCombineShader].uniformsName[e]},applyShaderParameters:function(e){var t;if(e&&this._shaderParameters)for(t in this._shaderParameters)e.setUniform(t,this._shaderParameters[t])},isReady:function(){var e=l[this._predefinedCombineShader];return"ShaderPass"===e.type||e.ready},createPasses:function(e){var t=l[this._predefinedCombineShader];"ShaderPass"===t.type?(this.stereoPass=new r(t.combineShader,"stereoPass"),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)):"RenderPass"===t.type&&(this.clearPass=new a("combineClearPass"),e.addPass(this.clearPass),e.composerContext.setPassRenderToCanvas(this.clearPass,!0),this.stereoPass=new n(null,null,null,null,null,null,"combineStereoPass"),this.stereoPass.setDepthFunc("ALWAYS"),this.stereoPass.setDisableBackFaceCulling(!0),this.stereoScene=new s.Scene,this.stereoScene.renderResultIndices={},t.fillScene(this.stereoScene),this.stereoPass.scene=this.stereoScene,e.composerContext.setPassClear(this.clearPass,!0,new s.Color(0),1),e.composerContext.setPassRenderToCanvas(this.stereoPass,!0)),e.addPass(this.stereoPass)},updatePasses:function(e,t,i){var r,n=l[this._predefinedCombineShader];if("ShaderPass"===n.type){for(r=0;r<e.length;r++){var s=this.getUniformName(r);this.stereoPass.material.setUniform(s,i[e[r]])}this.applyShaderParameters(this.stereoPass.material)}else if("RenderPass"===n.type){var a=this.stereoPass.scene;for(r=0;r<a.myMeshes.length;r++){var o;for(o in a.myMeshes[r].material.uniforms.tEye.value=i[e[a.renderResultIndices[a.myMeshes[r].id]]],n.parameters[r])a.myMeshes[r].material.uniforms[o].value=n.parameters[r][o];if(this._shaderParameters)for(o in this._shaderParameters[r])a.myMeshes[r].material.uniforms[o].value=this._shaderParameters[r][o]}}this.stereoPass.renderToScreen=t},isStereo:function(){return!0},setExternalFrameBuffer:function(e){this._extFrameBuffer=e},getExternalFrameBuffer:function(){return this._extFrameBuffer}}),l={leftRight:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:i.LeftRight,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK1:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},combineShader:i.OculusDK1,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},anaglyph:{getViewportSize:function(e,t){return{width:e,height:t}},combineShader:i.Anaglyph,uniformsName:["tLeftEye","tRightEye"],type:"ShaderPass"},oculusDK2:{getViewportSize:function(e,t){return{width:Math.floor(e/2),height:t}},ready:!1,warmup:function(){require(["DS/OculusDK2/OculusDK2DeformationMeshCreator"],function(e){l.oculusDK2.ready=!0,l.oculusDK2.OculusDK2DeformationMeshCreator=e})},fillScene:function(e){var i=l.oculusDK2;i.uniforms=s.CloneStructure(t.oculusDK2.uniforms);var r=new s.ShaderMaterial({uniforms:i.uniforms,vertexShader:t.oculusDK2.vertexShader,fragmentShader:t.oculusDK2.fragmentShader});i.OculusDK2DeformationMeshCreator.fillScene(e,r)},parameters:[{eyeToSourceUVScale:new s.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new s.Vector2(.492164134,.5)},{eyeToSourceUVScale:new s.Vector2(.464894474,.376141697),eyeToSourceUVOffset:new s.Vector2(.507835866,.5)}],type:"RenderPass"}};return o}),define("DS/Visualization/Filters/VisuFilter",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";return class{constructor(){}solveInherit(e,t,i){return this}}}),define("DS/Visualization/Filters/NoHighlightFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";class i extends t{constructor(e,t){super(),this.skipHL=e,this.skipPreHL=t}isEqual(e){return this.skipHL===e.skipHL&&this.skipPreHL===e.skipPreHL}solveInherit(e,t,r){if(!t)return this;var n=new i(this.skipHL||t.skipHL,this.skipPreHL||t.skipPreHL);return n.isEqual(t)?t:n.isEqual(this)?this:n}}return i}),define("DS/Visualization/Filters/SideFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.side=e}}}),define("DS/Visualization/Filters/LODNodeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t,i){"use strict";class r extends t{constructor(e,t){super(),this.rootFilter=e,this.occ=t;const i=t.parent.children.indexOf(t);this.isLastLOD=!1,this.lodIndex=i,t.parent.children.length>e.lods.length?this.isLastLOD=i>=e.lods.length:i>=0&&e.lods[0].index===i&&(this.isLastLOD=!0)}solveInherit(e,t){throw"LODOccurrenceFilter: not heritable"}canRender(){var e=this.rootFilter.getCurrrentLOD();return-1===e?this.isLastLOD:this.rootFilter.lods[e].index===this.lodIndex}}class n{constructor(e,t){this.filters=[],e&&t&&this.filters.push(new r(e,t))}_add(e,t){var i=new n;for(let e=0;e<this.filters.length;e++)i.filters.push(this.filters[e]);return i.filters.push(new r(e,t)),i}canRender(){for(let e=0;e<this.filters.length;e++)if(!this.filters[e].canRender())return!1;return!0}isLastLOD(){for(let e=0;e<this.filters.length;e++)if(!this.filters[e].isLastLOD)return!1;return!0}solveInherit(e,t){return this}}class s{constructor(){this.frameIndex=0,this.selectedLODIndex=-1}}const a={currentFrameIndex:-1};class o{constructor(e,t){this.occ=t,this.lods=e.lods,this._cache=new Map}_getSAG(t){if(!t)return 0;const i=this.occ,r=i.scene3js.viewer,n=r.renderer.renderer||a,s=i._getViewpoint()||r.currentViewpoint,o=s.camera,l=r._viewpointManager.getViewpointViewport(s)||{height:r.renderer.deviceHeight},h=o.position,c=(new e.Plane).setFromNormalAndCoplanarPoint(o.getLookAt(),h.clone().add(o.getLookAt().clone().multiplyScalar(o.near)));let d=o.getCameraConstant(n.devicePixelRatio,l.height/n.gpuStates.viewportScale);o.fullWidth&&(d*=o.height/o.fullHeight);const u=t.center,p=t.radius+t.pixelRadius/d,f=r._currentLOD;return f*d*(-c.normal.x*(h.x-u.x)+-c.normal.y*(h.y-u.y)+-c.normal.z*(h.z-u.z)+p*(.5*f-1))}getCurrrentLOD(){const t=this.occ,i=this.lods,r=t.scene3js.viewer;if(!r)return-1;const n=t._getViewpoint()||r.currentViewpoint;if(!n||!n.camera)return-1;const o=r.renderer.renderer||a;let l=this._cache.get(o);l||(l=new s,this._cache.set(o,l));const h=o.currentFrameIndex;if(l.frameIndex===h&&h>=0)return l.selectedLODIndex;l.frameIndex=h;let c=null;const d=t.getBoundingSphere("visibleSpace",!0),u=t.getBoundingSphere("invisibleSpace",!0);d&&!u?c=d:u&&!d?c=u:d&&u&&(c=new e.Sphere,d.mergeWithSphere(u,c));const p=l.selectedLODIndex;if(l.selectedLODIndex=-1,c){const e=this._getSAG(c);if(e<=0)l.selectedLODIndex=-1;else{l.selectedLODIndex=i.length-1;for(let t=0;t<i.length;t++)if(e<i[t].sag){l.selectedLODIndex=t-1;break}}}return p!==l.selectedLODIndex&&r._updateShadowMaps(),l.selectedLODIndex}_getContainer(e,t){return t?t._add(this,e):new n(this,e)}solveInherit(e,t){return null}}return class extends t{constructor(e){super(),this.lods=[];for(let t=0;t<e.length;t++)this.lods.push({sag:e[t],index:t});this.lods=this.lods.sort((e,t)=>e.sag-t.sag)}solveInherit(e,t){return new o(this,e)}}}),define("DS/Visualization/Filters/LookFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.material=e,this.shadowReceive=-1,this.shadowCast=-1}usingShadowReceive(e){return this.shadowReceive=!0===e?1:!1===e?0:-1,this}usingShadowCast(e){return this.shadowCast=!0===e?1:!1===e?0:-1,this}}}),define("DS/Visualization/Filters/DynamicModeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e,t){super(),this.draw=e,this.pick=t}}}),define("DS/Visualization/Filters/DoNotPickUnderFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this._doNotPickUnder=e}}}),define("DS/Visualization/Filters/FurtiveFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.state=e}}}),define("DS/Visualization/Filters/PolygonOffsetFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e,t){super(),this.factor=e,this.unit=t}enabled(){return 0!==this.factor&&0!==this.unit}}}),define("DS/Visualization/SubElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/VisuIdentification/Node","DS/VisuIdentification/Pattern"],function(e,t,i,r,n){"use strict";var s={},a=30,o=0,l=e.extend({init:function(e,t){if(t!==s&&a>0){var i=(new Error).stack;i=i&&i.substring(i.indexOf("\n")+1),console.warn("Use of deprecated constructor.\nUse SubElement.getFromSGNode() instead.\n"+i),a--}this.sgNode=e,this._internalGeometryData=null,this.id=o++},getDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return"point";case 1:case 2:case 3:return"line";case 4:case 5:case 6:return"surface";default:return""}}return""},getCellDimension:function(){if(this.sgNode){var e=this.sgNode;switch(e.getFirstPrimitive&&(e=e.getFirstPrimitive()),e.getGroup().glType){case 0:return 0;case 1:case 2:case 3:return 1;case 4:case 5:case 6:return 2;default:return-1}}return-1},getBodyDimension:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t=e.getRep?e.getRep():e.rep;return t&&t.solid?3:2}return-1},getType:function(){if(this.sgNode){var e=this.sgNode;if(e.getFirstPrimitive)return"selectionGroup";switch(e.getType?e.getType():e.type){case 0:return"node";case 1:return"bag";case 2:return"rep";case 3:return"primitive";default:return""}}return""},getGeometricType:function(){if(this.sgNode&&"primitive"===this.getType()){var e=this.sgNode.getGroup();if(e)return i.GeomTypeString[e._geomType]}return null},getParent:function(){if(this.sgNode){var e=this.sgNode;e.getFirstPrimitive&&(e=e.getFirstPrimitive());var t="primitive"===this.getType()?e.getRep():e.parents?e.parents[0]:null;if(t)return THREEDS.SubElement.getFromSGNode(t)}return null},getChildren:function(){var e,t=[];if(this.sgNode){var r=this.getType();if("rep"===r)for(e=0;e<this.sgNode.getPrimitivesCount();e++){var n=new i.SGPrimitiveHelper;n.set(this.sgNode,e),t.push(THREEDS.SubElement.getFromSGNode(n))}else if("selectionGroup"===r){var s=this.sgNode.getPrimitives();for(e=0;e<s.length;e++)t.push(THREEDS.SubElement.getFromSGNode(s[e]))}else for(e=0;e<this.sgNode.children.length;e++)t.push(THREEDS.SubElement.getFromSGNode(this.sgNode.children[e]))}return t},getPrimitives:function(e){var t=e||[],r=this.getType();if("primitive"===r)t.push(this.sgNode);else if("rep"===r)for(var n=0;n<this.sgNode.getPrimitivesCount();n++){var s=new i.SGPrimitiveHelper;s.set(this.sgNode,n),t.push(s)}else for(n=0;n<this.sgNode.children.length;n++)THREEDS.SubElement.getFromSGNode(this.sgNode.children[n]).getPrimitives(t);return t},getCGMID:function(){return this.sgNode&&!this.sgNode.getFirstPrimitive?this.sgNode.getCgmId?this.sgNode.getCgmId():this.sgNode.cgmId:""},getModelIdentification:function(){return this.getIdentificationObject()},getIdentificationObject:function(){var e,t=this.sgNode;return t&&(t.getFirstPrimitive&&(t=t.getFirstPrimitive()),t.getIdentificationObject&&(e=t.getIdentificationObject())),e},getMeshes:function(){var e=[],t=[];if(this.sgNode&&"primitive"===this.getType()){var i=this.sgNode.getGroup();if(i&&i.geometry)for(var r=i.geometry.meshList,n=0;n<r.length;n++){var s=r[n];t.push(s._occurrence.node)}}var a=-1,o=null;t.length&&(t.sort(function(e,t){return e.id-t.id}),a=t[0].id,e.push(t[0]));for(var l=1;l<t.length;l++)a!==(o=t[l]).id&&(a=o.id,e.push(o));return e},getReps:function(){var e,t=[];if("rep"===this.getType())t.push(this);else for(e=0;e<this.children.length;e++)t=t.concat(this.children[e].getReps());return t}});return l.getFromSGNode=function(e){if(e instanceof i.SGPrimitive){var t=e.group,r=t._primitives.indexOf(e);(e=new i.SGPrimitiveHelper).set(t,r)}return e._setInternalNode?(e._getInternalNode()||e._setInternalNode(new THREEDS.SubElement(e,s)),e._getInternalNode()):(e.internalNode||(e.internalNode=new THREEDS.SubElement(e,s)),e.internalNode)},UWA.namespace("THREEDS/SubElement",l)}),define("Visualization/SubElement",["DS/Visualization/SubElement","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SubElement"),e}),define("DS/Visualization/PathElement",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/Visualization/SubElement"],function(e,t,i,r,n){"use strict";var s=0,a=t.__visibleInCurrentSpace,o=e.extend({init:function(e){this._uid=s++,this.externalPath=[],this.internalPath=[],this._key=null,this.setFromArray(e)},getUID:function(){return this._uid},getLength:function(){return this.externalPath.length+this.internalPath.length},getLastElement:function(e,t){return!e&&this.internalPath.length?this.internalPath[this.internalPath.length-1]:!t&&this.externalPath.length?this.externalPath[this.externalPath.length-1]:null},getElement:function(e,t){return e<this.externalPath.length?this.externalPath[e]:!t&&e<this.getLength()?this.internalPath[e-this.externalPath.length]:null},isEqual:function(e){var t;if(!e)return!1;if(this.externalPath.length!==e.externalPath.length)return!1;if(this.internalPath.length!==e.internalPath.length)return!1;if(this.instanceId!==e.instanceId)return!1;for(t=0;t<this.externalPath.length;t++)if(this.externalPath[t]!==e.externalPath[t])return!1;for(t=0;t<this.internalPath.length;t++){var i=this.internalPath[t].sgNode,n=e.internalPath[t].sgNode;if(i instanceof r.SGPrimitive||i instanceof r.SGPrimitiveHelper){if(!(n instanceof r.SGPrimitive||n instanceof r.SGPrimitiveHelper))return!1;if(!i.isEqual(n))return!1}else if(i!==n)return!1}return!0},empty:function(){this.externalPath=[],this.internalPath=[]},clone:function(){for(var e=new THREEDS.PathElement(this.externalPath),t=0;t<this.internalPath.length;t++){var i=this.internalPath[t];i&&e.internalPath.push(i)}return this._key&&(e._key=this._key),this.instanceId&&(e.instanceId=this.instanceId),e},copy:function(e){this.externalPath=e.externalPath.slice(),this.internalPath=e.internalPath.slice()},addElement:function(e){return e&&(e.getNotAllowedInPathElement?e.getNotAllowedInPathElement()&&l():e.notAllowedInPathElement&&l()),this._key&&delete this._key,e instanceof THREEDS.Nodes.Node3D?(this.externalPath.push(e),!0):e instanceof THREEDS.SubElement&&(this.internalPath.push(e),!0)},setFromArray:function(e,t){var i;if(this._key=null,void 0===e||!(e instanceof Array))return!1;var r=[];for(i=0;i<e.length;i++){var n=e[i];if(n.getNotAllowedInPathElement&&n.getNotAllowedInPathElement()||n.notAllowedInPathElement)l();else{if(null===n)return!1;r.push(n)}}var s=[];if(t&&t instanceof Array)for(i=0;i<t.length;i++){var a=t[i];if(null===a)return!1;s.push(a)}return this.getLength()&&this.empty(),this.externalPath=r,this.internalPath=s,!0},setFromOccurrence:function(e,t,i,r){if(null==e)return!1;var n=e.node,s=n&&n._getDisablePrimPicking(),a=e.parent;this.externalPath=[n];for(var o=!1;null!==a&&!o&&(n=a.node,a=a.parent,!n.getNotAllowedInPathElement());)this.externalPath.unshift(n),i&&n===i&&(o=!0);var l=i&&o||!i;if(null==t||s&&r)return l;a=t.getParent();for(this.internalPath=[t];null!==a;)this.internalPath.unshift(a),a=a.getParent();return l},setFromOccurrencePath:function(e,t){if(null==e)return!1;var i=e.getSize();if(!i)return!1;for(var r=[],n=0;n<i;n++){var s=e.getNodeName(n);if(null===s)return!1;var a=t.getChildByName(s);if(null===a)return!1;a.getNotAllowedInPathElement()?l():r.push(a)}return this.getLength()&&this.empty(),this.externalPath=r,!0},addSubstituteMaterial:function(e,t,i){this._getOccurrences(e).forEach((e,r,n)=>e._addSubstituteMaterial(t,i))},removeSubstituteMaterial:function(e,t){this._getOccurrences(e).forEach((e,i,r)=>e._removeSubstituteMaterial(t))},_getOccurrences:function(e){var t,i,r,n,s,a,o,l;if(!this.externalPath.length)return[];if(null===(t=this.externalPath[0]))return[];if(!(n=t._occurrences))return[];for(e&&(n=n.filter(function(t){return t.scene3js&&t.scene3js.viewer===e})),s=[],l=1;l<this.externalPath.length;l++){for(t=this.externalPath[l],a=0;a<n.length;a++)for(i=n[a].children,o=0;o<i.length;o++)(r=i[o]).node===t&&s.push(r);n=s,s=[]}return n},_getOccurrenceFromRootOccurrence:function(e){if(e.node!==this.externalPath[0])return null;var t,i,r,n,s,a=e;for(t=1;t<this.externalPath.length;t++){for(r=this.externalPath[t],s=null,i=0;i<a.children.length&&null==s;i++)(n=a.children[i]).node===r&&(s=n);if(null===s)return null;a=s}return a},_getRenderableOccurrences:function(e,t){var i,r,n,s,a;if(r=[],i=this._getOccurrences(e))for(s=0;s<i.length;s++)for(n=i[s]._getRenderableOccurrences(t),a=0;a<n.length;a++)r.push(n[a]);return r},_getUniqueOccurrence:function(e){var t=this._getOccurrences(e);if(t&&1===t.length)return t[0];var i,r,n=[];for(i=0;i<t.length;i++){if(r=t[i],n.indexOf(r.scene3js)>=0)return null;n.push(r.scene3js)}return t[0]||null},getKey:function(){if(!this._key){var e=0,t="";for(e=0;e<this.externalPath.length;e++)t+=(0===e?"":"/")+this.externalPath[e].id;for(t+="//",e=0;e<this.internalPath.length;e++)t+=(0===e?"":"/")+this.internalPath[e].id;this._key=t}return this._key},hash:function(){if(!this._hash){var e,t=0,i="";if(this.internalPath.length){if(!((e=this.internalPath[this.internalPath.length-1])instanceof n))throw new Error("Unknown node");var r=e.sgNode;r&&(r.getStart?i+=r.getStart()+"/":r.start&&(i+=r.start+"/"))}for(t=this.externalPath.length-1;t>=0;t--)i+=this.externalPath[t].id+"/";this._hash=i}return this._hash},getParentPath:function(){var e=this.externalPath.concat(this.internalPath);if(e.length<=1)return null;var t,i=new THREEDS.PathElement;for(t=0;t<e.length-1;t++)i.addElement(e[t]),e[t]._instancingInfos&&(i.instanceId=this.instanceId);return i},getChildrenPathes:function(e){var t,i,r=[],n=this.getLastElement(),s=e?e.getKey():null;if(null===n)return!1;if(n.children)for(t=0;t<n.children.length;t++)(i=this.clone()).addElement(n.children[t]),i.getKey()!==s&&r.push(i);return r},getSiblingsPathes:function(){var e=this.getParentPath();return e?e.getChildrenPathes(this):[]},getAncestorsPathes:function(){for(var e=this,t=[];e;)t.unshift(e),e=e.getParentPath();return t},getSubPath:function(e){if(this.internalPath.length>0)return null;var t,i=null,r=null;for(t=this.externalPath.length-2;t>=0&&null===i;t--)e(this.externalPath[t])&&(i=t);if(null!==i)for(r=new o,t=0;t<=i;t++)r.addElement(this.externalPath[t]);return r},getPathesFromSelectionGroupPath:function(){var e=this.getLastElement(!1);if(!(e&&e.sgNode&&e.sgNode instanceof r.SelectionGroup))return null;for(var t=[],i=e.sgNode.getPrimitives(),s=0;s<i.length;s++){var a=i[s],o=this.getParentPath();o.addElement(n.getFromSGNode(a)),t.push(o)}return t},toJSON:function(e){for(var t,i={},r=[],n=this.externalPath[0];n;)r=[n].concat(r),n=n.parents.length&&n!==e?n.parents[0]:null;function s(e){return e.getPersistentId?{persistent:!0,value:e.getPersistentId()}:{persistent:!1,value:e.parents[0].children.indexOf(e)}}for(i.firstElementPath=[],t=0;t<r.length;t++)((n=r[t]).parents.length||n!==e)&&i.firstElementPath.push(s(n));for(i.externalPathRest=[],t=1;t<this.externalPath.length;t++)i.externalPathRest.push(s(this.externalPath[t]));return i},setFromJSON:function(e,t){var i,r=t;function n(e,t){var i,r;if(!t.persistent)return e.children[t.value];for(i=0;i<e.children.length;i++)if((r=e.children[i]).getPersistentId&&r.getPersistentId()===t.value)return r;return null}for(i=0;i<e.firstElementPath.length;i++)r=n(r,e.firstElementPath[i]);var s=[r];for(i=0;i<e.externalPathRest.length;i++)s.push(n(s[s.length-1],e.externalPathRest[i]));for(i=0;i<s.length;i++)s[i].getNotAllowedInPathElement()||this.addElement(s[i])},_dbgPrint:function(){for(var e="ext:[",t=this.externalPath.length,i=0;i<t;i++){(r=this.externalPath[i])&&(e+=r.name),i<t-1&&(e+=", ")}e+="] int:[",t=this.internalPath.length;for(i=0;i<t;i++){var r;(r=this.internalPath[i])&&(e+=r.getCGMID()),i<t-1&&(e+=", ")}return e+="]"},getMatrix:function(e){var t=this._getUniqueOccurrence(e);if(!t)return null;if(t.originalOverrideSet){var i=t.originalOverrideSet.getSubstituteMatrix();if(i)return i.clone()}var r=this.getLastElement(!0);return null===r?null:r.getMatrix()},getWorldMatrix:function(e,t){var i=this._getUniqueOccurrence(e);if(i&&i.matrix){i._tryOverridesUpdateWithAncestors(e);let r=i.matrix;if(this.instanceId&&i._instancingInfos&&i._instancingInfos.useDefaultInstancing){let e=i;for(;e&&!e.node._instancingInfos;)e=e.parent;e&&(r=e.node._getInstanceWorldMatrixFromInstanceId(this.instanceId,e,i))}return t?(t.copy(r),t):r.clone()}return null},getMatrixInAxisSystem:function(e,i){var r=this.getWorldMatrix(i);if(!r)return null;var n=new t.Matrix4,s=new t.Matrix4;return s.getInverse(e),n.multiplyMatrices(s,r),n},getBoundingSphere:function(e,t,i){"show"===t&&(console.warn("DEPRECATED: use visibleSpace instead of show"),t="visibleSpace"),"noShow"===t&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),t="invisibleSpace");var r=this.getWorldMatrix(e);if(!r)return null;var n=this._getUniqueOccurrence(e);if(!n)return null;e=e||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(e);var s=null;i&&0!==this.internalPath.length?s=this.getLastElement().sgNode.computeBoundingSphere().clone():s=n.getBoundingSphere(t).clone();return s.center.applyMatrix4(r),s},getBoundingBox:function(e,t,i){if(t){"show"===i&&(console.warn("DEPRECATED: use visibleSpace instead of show"),i="visibleSpace"),"noShow"===i&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),i="invisibleSpace");var r=this.getWorldMatrix(t);if(!r)return null;e&&e.copy(r);var n=this._getUniqueOccurrence(t);return n?(t=t||n.scene3js.viewer,n._tryOverridesUpdateWithAncestors(t),n.getBoundingBox(i).clone()):null}},getFilterGeomType:function(e){if(!e)return 0;var t=this._getUniqueOccurrence(e);if(!t)return 0;var i=t.renderable;return i?i.getFilterGeomType():0},getOrientedBoundingBox:function(e,i,r,n,s,o){if(!i)return null;var l=n||(1===i.visibleSpace?"visibleSpace":"invisibleSpace"),h=this._getUniqueOccurrence(i);if(o=!!o,!h)return null;r=r||t.FixedSizeFiltering.Include,s=s||[];for(var c=0,d=0;d<s.length;d++){c|=s[d]}if(h._tryOverridesUpdateWithAncestors(i),o&&0!==this.internalPath.length){var u=h.renderable;if(!u)return h.computeAccurateBoundingBox(l,e,r,c);if(!a(u.visible,u.visibilityFree,"visibleSpace"===l,h))return new t.Box3;var p=h._isFixedSize();if(p&&r===t.FixedSizeFiltering.Exclude)return new t.Box3;var f=new t.Matrix4;null!==e?f.multiplyMatrices((new t.Matrix4).getInverse(e),u._getMMMatrix()):f=u._getMMMatrix();var g=h._getRenderModes(),m=u.getFilterGeomType();return this.getLastElement().sgNode._computeOrientedBoundingBox(f,g&~c,r,p,m?m._geomType:0)}return h.computeAccurateBoundingBox(l,e,r,c)},checkExternalPath:function(){var e,t,i,r=!0;for(e=0;e<this.externalPath.length-1&&r;e++)t=this.externalPath[e],i=this.externalPath[e+1],t.children.indexOf(i)<0&&(r=!1);return r},isAParentOf:function(e){function t(e,t){var i=[],r=(e[0],e[0]);if(1===r.parents.length&&r!==t){for(r=r.parents[0];1===r.parents.length&&r!==t;)i.unshift(r),r=r.parents[0];i.unshift(r)}return i=i.concat(e)}var i,r,n,s=this.externalPath[0],a=e.externalPath[0];if(s===a?(i=this.externalPath,r=e.externalPath):this.externalPath.indexOf(a)>0?(i=this.externalPath,r=t(e.externalPath,s)):(i=t(this.externalPath,a),r=e.externalPath),r[0]===i[0]){if(i.length<=r.length){for(n=0;n<i.length&&i[n]===r[n];)n++;return n===i.length}return!1}return!1},concatenatePathes:function(e,t){var i=e.externalPath.concat(t.externalPath);this.setFromArray(i)},substractPath:function(e,t){var i,r=t.externalPath.concat([]),n=e.externalPath;r.indexOf(n[n.length-1]);for(i=0;i<n.length;i++)if(n[i]!==r[i])return!1;return r.splice(0,n.length-1),this.setFromArray(r),!0},setRenderPasses:function(e){for(var t=this._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].setVisibleInPasses(e)},getParentOccurrencePath:function(){return this.getParentPath.apply(this,arguments)},getChildrenOccurrencePathes:function(){return this.getChildrenPathes.apply(this,arguments)},getSiblingsOccurrencePathes:function(){return this.getSiblingsPathes.apply(this,arguments)},getAncestorsOccurrencePathes:function(){return this.getAncestorsPathes.apply(this,arguments)},_getIndexFromNode:function(e){return this.externalPath.indexOf(e)},_findSGNodeByLocalId:function(e,t){var i,r=e.getIdentificationObject?e.getIdentificationObject():null;r&&(r.getLocalId()===t&&(i=e));if(!i&&e.children)for(var n=e.children,s=0;s<n.length&&void 0===(i=this._findSGNodeByLocalId(n[s],t));s++);return i},findAssociatedSGNode:function(e,t){var i;if(e.parents)for(var r=e.parents,n=0;n<r.length;n++)if(r[n]instanceof THREEDS.Nodes.CGRNode)i=this._findSGNodeByLocalId(r[n].internalSceneGraph,t);else if(void 0!==(i=this.findAssociatedSGNode(r[n],t)))break;return i}});function l(){console.warn("An attempt to add an unauthorized node to a PathElement has been countered.\nPlease remove the node from your PathElement creation.\nNode returned by viewer.getRootNode() and any of its parents may not be part of a PathElement")}return UWA.namespace("THREEDS/PathElement",o)}),define("Visualization/PathElement",["DS/Visualization/PathElement","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/PathElement"),e}),define("DS/Visualization/MaterialManager",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Mesh/Mesh","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events"],function(e,t,i,r,n,s){"use strict";function a(e,t){return i.ImageUtils.loadTextureCube(e,t)}function o(e,t){return i.ImageUtils.loadTexture(e,void 0,null,null,t)}i.ParticleBasicMaterial,i.LineBasicMaterial,i.DSPBR22xMaterial,i.MeshBasicMaterial;var l=["Generic","Metal","Glass","Plastic","Textile","Leather","Car Paint","Emissive","Basic","Wood"],h=["CATCrDBallPointShader","CATCrDFeltPenShader","CATCrDImageTextureShader"],c=[1,1,2,3,4,5,6,7,8],d=["NO_TRANSCODE","RGB","RGBA","RGBHQ","NORMAL_MAP","GRAYSCALE"],u=null,p=function(e){return 3&e},f=new i.Matrix3,g=null,m=null,v=e.extend({init:function(e,t,r,s,a){if(null!==g){if(this.maxTextureSize=g.maxTextureSize,this.viewerList=g.viewerList,s&&this.viewerList.set(s.id,s),a||g.multiViewer||!t){if(this.ODTMode=g.ODTMode,this.offscreenAPI=g.offscreenAPI,this.multiViewer=g.multiViewer,this.multiViewerAuto=g.multiViewerAuto,this.canvas=g.canvas,this.context=g.context,this.materials=g.materials,this.gasMaterialsMap=g.gasMaterialsMap,this.gasSGOrederMaterialsMap=g.gasSGOrederMaterialsMap,this.threeDXSharedGas=g.threeDXSharedGas,this.CGRSharedMaterials=g.CGRSharedMaterials,this.textures=g.textures,this.texturesPoint=g.texturesPoint,this.resources=[],this.PointSymbolEnum=g.PointSymbolEnum,this._modelEvent=g._modelEvent,this.foregroundColorInit=g.backgroundColorInit,this.foregroundColorMaterials=g.foregroundColorMaterials,this.foregroundColor=g.foregroundColor,this.backgroundColor=g.backgroundColor,this.backgroundColorMaterial=g.backgroundColorMaterial,this.backgroundColorMaterials=g.backgroundColorMaterials,this.backgroundColorInit=g.backgroundColorInit,this.blankingRepMaterials=g.blankingRepMaterials,!this.backgroundColorInit&&s&&this.initBackgroundColor(s),!this.foregroundColorInit&&s&&this.initForegroundColor(s),this.displayBlanking=g.displayBlanking,this.lineTypes=g.lineTypes,this.precomputedTexture=g.precomputedTexture,this.noiseTexture3D=g.noiseTexture3D,this.precomputedAreaTexture=g.precomputedAreaTexture,a&&this.hasMultipleViewers()){let e=this.viewerList[Symbol.iterator]();for(let t of e){let e=t[1],i=e.canvas;if(this.canvas===i){var o=e.createCanvas();e.attachCanvas(o),e.create2DContext()}}}return this}g.precomputedTexture&&g.precomputedTexture.dispose(),g.noiseTexture3D&&g.noiseTexture3D.dispose(),g.precomputedAreaTexture&&g.precomputedAreaTexture.dispose()}else this.viewerList=new Map,s&&this.viewerList.set(s.id,s);return this.ODTMode=e,this.offscreenAPI=s&&s.offscreenAPI,this.gasMaterialsMap=new Map,this.gasSGOrederMaterialsMap=new Map,this.materials=[],this.threeDXSharedGas=new Map,this.CGRSharedMaterials=new Map,this.textures=[],this.texturesPoint=new Array(10),this.resources=[],this._currentMatHasTexture=!1,this._modelEvent=new n,m=null,this.backgroundColorMaterial=null,this.backgroundColorMaterials=[],this.blankingRepMaterials=[],this.displayBlanking=!1,this.blankingInit=!1,this.foregroundColorInit=!1,this.foregroundColorMaterials=[],this.foregroundColor=new i.Color,this.backgroundColor=new i.Color,this.backgroundColorInit=!1,this.lineTypes={shapes:[],shapesOffset:0,patterns:[],patternsOffset:0,widths:[],lineTypes:[]},g=this,v.singleton=g,this.debugWebgl2=s&&s.debugWebgl2,this.initResources(e,t,r,a),this.maxTextureSize=16384,s&&(this.initBackgroundColor(s),this.initForegroundColor(s),s.renderer&&s.renderer.gl&&s.renderer.gl.getParameter(s.renderer.gl.MAX_TEXTURE_SIZE)),this.PointSymbolEnum={NOSPRITE:0,CROSS:1,PLUS:2,CONCENTRIC:3,COINCIDENT:4,FULLCIRCLE:5,FULLSQUARE:6,STAR:7,DOT:8,SMALLDOT:9},this},removeViewer:function(e){if(this.viewerList.delete(e.id),this.cleanAll(),this.multiViewerAuto&&!this.hasMultipleViewers()){const e=this.viewerList[Symbol.iterator]().next().value;if(!e)return;const t=e[1];t.attachCanvas(this.canvas),t.context2D=null}},cleanAll:function(){g.materials.splice(0),g.gasMaterialsMap.clear(),g.gasSGOrederMaterialsMap.clear(),g.threeDXSharedGas.clear(),g.CGRSharedMaterials.clear(),g.backgroundColorMaterial=null,g.backgroundColorMaterials.splice(0),g.blankingRepMaterials.splice(0),g.precomputedTexture&&g.precomputedTexture.dispose(),g.noiseTexture3D&&g.noiseTexture3D.dispose(),g.precomputedAreaTexture&&g.precomputedAreaTexture.dispose(),u&&u.dispose(),this.deallocateSharedMaterials()},clearLineTypes:function(){for(var e=0;e<this.lineTypes.shapes.length;e++)this.lineTypes.shapes[e].geometry.dispose();function t(e){var t=[],i=[];e.forEach((e,i)=>{var r=[];t.push({map:e,keys:r}),e.forEach((e,t)=>{1===p(t)&&r.push(t)})});for(var r=0;r<t.length;r++){var n=t[r].map;i=t[r].keys;for(var s=0;s<i.length;s++){var a=i[s],o=n.get(a);n.delete(a),o&&o.forEach((e,t)=>{e&&(e.forEach?e.forEach((e,t)=>{e.dispose()}):e.dispose())})}}}this.lineTypes.shapes=[],this.lineTypes.shapesOffset=0,this.lineTypes.patterns=[],this.lineTypes.patternsOffset=0,this.lineTypes.widths=[],this.lineTypes.lineTypes=[],t(this.gasMaterialsMap),t(this.gasSGOrederMaterialsMap)},hasLineTypes:function(){return this.lineTypes.widths.length>0},getPDSFX:function(e){require(["DS/"+e.name+"/"+e.name],function(t){t(e.material,e.parameters)})},setLineTypes:function(e){if(this.clearLineTypes(),null==e)return;if(1!==e.version)throw new Error(`Unsupported custom lines specifications (version ${e.version}, expected 1)`);function t(e,t){return!!e||(console.error(t),!1)}e.shapes||(e.shapes=[]),e.patterns||(e.patterns=[]),e.widths||(e.widths=[]),e.lineTypes||(e.lineTypes=[]),e.patternsVisu||(e.patternsVisu=[]),e.shapesVisu||(e.shapesVisu=[]);const n=(e,i)=>t(void 0!==e,`Missing ${i}`),s=(e,i)=>t(Number.isFinite(e),`Invalid ${i}, expected a finite number, got '${e}'`);let a=[];function o(e,n){let s=null,o=null;if(e instanceof i.BufferGeometryDS)o=(s=e).drawingGroups[0];else{if(s=new i.BufferGeometryDS,e.triangles){if(!t(e.triangles.length%3==0,`Invalid shape ${n}, indices do not form a set of triangles`))return;s.vertexPositionArray=new Float32Array(e.vertices),s.vertexPositionArray.length>=196608?s.vertexIndexArray=new Uint32Array(e.triangles):s.vertexIndexArray=new Uint16Array(e.triangles),o=new r.DrawingGroup(void 0,void 0,4,0,s.vertexIndexArray.length)}else if(e.polylines){for(let i=0;i<e.polylines.length;i++)if(!t(e.polylines[i].length%3==0,`Invalid shape ${n}, polyline nÂ°${i} does not form a set of 3D vertices`))return;const{vertices:i,indices:a}=function(e){let t=0,i=0;for(let r=0;r<e.length;r++)t+=e[r].length,i+=2*(e[r].length/3-1);const r=new Float32Array(t),n=t>196608?new Uint32Array(i):new Uint16Array(i);let s=0,a=0;for(let t=0;t<e.length;t++){const i=e[t].length/3,o=s/3;for(let e=0;e+1<i;e++)n[a++]=o+e,n[a++]=o+e+1;r.set(e[t],s),s+=e[t].length}return{vertices:r,indices:n}}(e.polylines);s.vertexPositionArray=i,s.vertexIndexArray=a,o=new r.DrawingGroup(null,null,1,0,s.vertexIndexArray.length)}if(!t(0!==s.vertexPositionArray.length,`Invalid shape ${n}, missing vertices`))return;if(!t(0!==s.vertexIndexArray.length,`Invalid shape ${n}, missing indices`))return;o&&(o._primitives=[{group:o,start:o.start,count:o.count}],o.geometry=s,s.drawingGroups.push(o))}a.push(o)}for(let t=0;t<e.shapes.length;t++){o(e.shapes[t],t)}const l=a.length;for(let t=0;t<e.shapesVisu.length;t++){o(e.shapesVisu[t],t+l)}let h=[];function c(e,t,r){let o={zoomable:void 0===e.zoomable||e.zoomable,description:[]};for(let l=0;l<e.description.length;l++){const h=e.description[l];if(!s(h.length,`length of segment ${l} of pattern ${r}`))return;const c=void 0!==h.shape&&null!==h.shape;if(c&&!n(a[h.shape+t],`shape of segment ${l} of pattern ${r}`))return;let d=void 0;try{16===h.matrix.length?d=new i.Matrix4(h.matrix[0],h.matrix[4],h.matrix[8],h.matrix[12],h.matrix[1],h.matrix[5],h.matrix[9],h.matrix[13],h.matrix[2],h.matrix[6],h.matrix[10],h.matrix[14],h.matrix[3],h.matrix[7],h.matrix[11],h.matrix[15]):9===h.matrix.length&&(d=new i.Matrix3(h.matrix[0],h.matrix[3],h.matrix[6],h.matrix[1],h.matrix[4],h.matrix[7],h.matrix[2],h.matrix[5],h.matrix[8]))}catch(e){}o.description.push({length:h.length,shape:c?h.shape+t:null,matrix:d&&c?d:null,upright:c&&!!h.upright,onSolidLine:c&&!!h.onSolidLine})}h.push(o)}for(let t=0;t<e.patterns.length;t++)c(e.patterns[t],0,t);const d=h.length;for(let t=0;t<e.patternsVisu.length;t++)c(e.patternsVisu[t],l,t+d);let u=[];for(let t=0;t<e.widths.length;t++){let i=e.widths[t];if(!s(i.pixelWidth,`pixel width of type ${t}`))return;if(!s(i.printWidth,`print width of type ${t}`))return;u.push({pixelWidth:i.pixelWidth,printWidth:i.printWidth})}let p=[];for(let t=0;t<e.lineTypes.length;t++){let i=e.lineTypes[t];if(null!==i.pattern&&void 0!==i.pattern&&!n(h[i.pattern],`pattern of type ${t}`))return;if(null!==i.patternVisu&&void 0!==i.patternVisu&&!n(h[i.patternVisu+d],`pattern visu of type ${t}`))return;p.push({pattern:i.pattern,patternVisu:i.patternVisu})}this.lineTypes.shapes=a,this.lineTypes.shapesOffset=l,this.lineTypes.patterns=h,this.lineTypes.patternsOffset=d,this.lineTypes.widths=u,this.lineTypes.lineTypes=p},_createLineFromAdvancedInheritnace:function(e,t,r){var n=t.getDisplayedColor();n[0]=n[0]/255,n[1]=n[1]/255,n[2]=n[2]/255,n[3]=n[3]/255;let s={color:(new i.Color).setRGB(n[0],n[1],n[2]).getHex(),opacity:n[3],transparent:n[3]<1,_sceneGraphOrderMode:r&&r.sceneGraphOrderMode?r.sceneGraphOrderMode:0};const a=e.lineType,o=e.lineWeight,l=e.lineTypeScale;let h=this._createLineTypeMaterial(o,a,l,s);return h||new i.LineBasicMaterial(s)},_createLineTypeMaterial:function(e,t,r,n){if(!this.hasLineTypes())return console.error(`Cannot create material for width '${e}' and pattern ${t}: no line types defined`),null;if(!this.lineTypes.widths[e])return console.warn(`Cannot create material for width '${e}' material: unknown width`),null;const s=this.lineTypes.widths[e].pixelWidth;if(!this.lineTypes.lineTypes[t])return console.warn(`Cannot create material for patterns '${t}' material: unknown pattern`),null;n||(n={});const a=this.lineTypes.lineTypes[t];let o=a.pattern;null!==a.patternVisu&&void 0!==a.patternVisu&&(o=a.patternVisu+this.lineTypes.patternsOffset);const l=this.lineTypes.patterns[o];return n._wholePatternsOnly=!1,n._worldSizePattern=l.zoomable||!this.ODTMode&&l.description.filter(e=>null!==e.shape).length>0,n.force=!0,n.lineWidth=Math.max(Math.round(s),1),n.pattern=l.description,n.patternShapes=this.lineTypes.shapes,n.scale=r||1,new i.LineBasicMaterial(n)},deallocateSharedMaterials:function(){for(var e=["Invisible","Normal","Depth","NormalDepth","ShadowMapDepth","Picking","Highlight","PreHighlight","HighlightMobile"],t=["Face","Line","Point"],r=["0","1","2"],n=["true","false"],s=[1],a=0;a<e.length;a++){var o=i.DefaultMaterials[e[a]];if(o)for(var l=0;l<t.length;l++){var h=o[t[l]];if(h)for(var c=0;c<r.length;c++){var d=h[r[c]];if(d)for(var u=0;u<n.length;u++){var p=d[n[u]];if(p){var f=p[s[0]];f&&(f.needsUpdate=!0)}}}}}},initForegroundColor:function(e){var t=this;this.foregroundColorInit=!0,s.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE"},function(e){e.parameters.viewer.getRenderer()&&(t.foregroundColor=i._getColorMap(e.parameters.viewer.getRenderer())[i.COLORMAP_INDEX.FOREGROUND],t.updateForegroundColorMaterial())}),e&&e.renderer&&e.renderer.renderer&&(this.foregroundColor=i._getColorMap(e.renderer.renderer)[i.COLORMAP_INDEX.FOREGROUND],this.updateForegroundColorMaterial())},initBackgroundColor:function(e){this.backgroundColorInit=!0;var t=this;this.backgroundColor=e.ambience.getBackgroundColor(),e.onBackgroundModify(function(e){t.backgroundColor=new i.Color(e),t.updateBackgroundColorMaterial()})},updateForegroundColorMaterial:function(){for(var e=0;e<this.foregroundColorMaterials.length;e++)this.foregroundColorMaterials[e].color=this.foregroundColor},updateBackgroundColorMaterial:function(){for(var e=0;e<this.blankingRepMaterials.length;e++)this.blankingRepMaterials[e].color=this.backgroundColor;for(e=0;e<this.backgroundColorMaterials.length;e++)this.backgroundColorMaterials[e].color=this.backgroundColor;this.backgroundColorMaterial&&(this.backgroundColorMaterial.color=this.backgroundColor)},initResources:function(e,r,n,s){if(this.multiViewer=r,this.multiViewerAuto=s,r||s){if(s&&!this.hasMultipleViewers()){let e=this.viewerList[Symbol.iterator]().next().value[1].canvas;this.canvas=e}else this.offscreenAPI?this.canvas=new OffscreenCanvas(256,256):this.canvas=document.createElement("canvas");var a=null;if(this.debugWebgl2&&(a=this.canvas.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,antialias:n,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()}),i.WebGLVersion=2),!a){var o={alpha:!0,premultipliedAlpha:!1,antialias:n,stencil:!0,preserveDrawingBuffer:e||!1,powerPreference:i._webglPerformanceProfile()};a=this.canvas.getContext("webgl",o)||this.canvas.getContext("experimental-webgl",o),i.WebGLVersion=1}this.context=a}var l=t.getWebappsAssetUrl("Effects",""),h=i.ImageUtils.loadTGATexture(l+"precomputedTexture.bin",new i.UVMapping,null,null,!0,!0);h.minFilter=i.NearestFilter,h.magFilter=i.NearestFilter,this.precomputedTexture=h,this.noiseTexture3D=new i.DataTexture(new Uint8Array(16),2,2,i.RGBAFormat,i.UnsignedByteType,new i.LatLongReflectionMapping,i.ClampToEdgeWrapping,i.ClampToEdgeWrapping,i.LinearFilter,i.LinearFilter),this.noiseTexture3D.generateMipmaps=!1,this.noiseTexture3D.needsUpdate=!0,this.noiseTexture3D.onRequest=function(){this.loadEndStatus=i.AssetLoadingStatus.READY;for(var e=new Uint8Array(1048576),t=0;t<262144;t++){var r=255*Math.random();e[4*t]=r,e[4*t+1]=r,e[4*t+2]=r,e[4*t+3]=255}this.image.data=e,this.image.width=512,this.image.height=512,this.needsUpdate=!0,this.onRequest=null};var c=i.ImageUtils.loadCompressedTexture(l+"AreaLight.dds",new i.UVMapping,null,null,!1,!0);c.minFilter=i.LinearFilter,c.magFilter=i.LinearFilter,this.precomputedAreaTexture=c},setCanvasSize:function(e,t,i){if(this.multiViewer||this.multiViewerAuto){var r=t,n=i;for(var s of this.viewerList.values())if(e!==s){var a=s.getCanvasSize();r=Math.max(a.width,r),n=Math.max(a.height,n)}this.canvas.width=r,this.canvas.height=n}},getCanvas:function(){return this.canvas},getContext:function(){return this.context},hasMultipleViewers:function(){return this.viewerList.size>1},onPDSFXMaterial:function(e){return this._modelEvent.subscribe({event:"PDSFXMaterial"},e)},cleanResources:function(){g.textures=[],this.textures=[],this.materials=this.materials.filter(function(e){return!e.hasTexture})},getMaterialById:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.id===e)return this.materials[t].threejs_mat;return null},getMaterialByName:function(e){var t;for(t=0;t<this.materials.length;t++)if(this.materials[t].threejs_mat.name===e)return this.materials[t].threejs_mat;return null},getBackgroundColorMaterial:function(){return this.backgroundColorMaterial?this.backgroundColorMaterial:(this.backgroundColorMaterial=new i.MeshBasicMaterial({side:i.DoubleSide,color:this.backgroundColor}),this.backgroundColorMaterial)},displayBlankingPolygon:function(e,t){this.displayBlanking=e;for(var i=0;i<this.blankingRepMaterials.length;i++)this.blankingRepMaterials[i].opacity=e?1:0},getBlankingRepMaterial:function(){var e=new i.MeshBasicMaterial({color:this.backgroundColor,overridable:!1,side:i.DoubleSide,opacity:this.displayBlanking?1:0,depthTest:!1,shading:i.FlatShading});return this.blankingRepMaterials.push(e),e},_getDashPattern:function(e){var t;switch(console.error("Error: accessing private method on MaterialManager"),e){case r.LinePatternEnum.DOTTED:(t=new Float32Array(2))[0]=2,t[1]=2;break;case r.LinePatternEnum.DASHED:(t=new Float32Array(2))[0]=3,t[1]=1;break;case r.LinePatternEnum.DOTDASHED:(t=new Float32Array(4))[0]=3,t[1]=2,t[2]=1,t[3]=2;break;case r.LinePatternEnum.PHANTOM:(t=new Float32Array(6))[0]=6,t[1]=2,t[2]=2,t[3]=2,t[4]=2,t[5]=2;break;case r.LinePatternEnum.SMALLDOTTED:(t=new Float32Array(2))[0]=1,t[1]=1;break;case r.LinePatternEnum.JISAXIS:(t=new Float32Array(4))[0]=2,t[1]=1,t[2]=12,t[3]=2;break;default:(t=new Float32Array(1))[0]=-1}return t},extractMaterialApplicationMappingInfos(e,t,r){if(e)if(t.isPhysicalMaterial&&"CATGraphicalMaterial"!=t.getType()){var n=t.__physicalMode>=1,s=!!e.type,a=!e.UvTransfoInfos||e.type||!!e.UvTransformation,o=null;e.ObjectTransformation&&((o=new i.Matrix4).elements=e.ObjectTransformation);var l=!1,h=!1;n?(h=!0,s||(l=!0)):(l=!0,s&&(h=!0));var c=null;h&&e.UvTransformation&&((c=new i.Matrix3).elements=e.UvTransformation);var d=null;if(l&&e.UvTransfoInfos){d=new i.Matrix3;var u=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],g=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];d.set(f*u,-f*p,g[0],f*p,f*u,g[1],0,0,1)}c&&d?c.multiplyMatrices(c,d):d&&(c=d);var m=e.type;n||("SPHERICAL_NORMALIZED"===m&&(m="SPHERICAL"),"INFINITE_CYLINDRICAL_NORMALIZED"===m&&(m="INFINITE_CYLINDRICAL")),a||-1==t.mappingType?t.setMappingOperator(m,o,c,!0):t.mappingUVTransformation.multiplyMatrices(c,t.mappingUVTransformation),t.mappingTransformSemantic=null!=e.transformSemantic?e.transformSemantic:1}else{c=null;if(e.UvTransfoInfos){c=new i.Matrix3;u=Math.cos(e.UvTransfoInfos[2]),p=Math.sin(e.UvTransfoInfos[2]),f=e.UvTransfoInfos[3],g=[e.UvTransfoInfos[0],e.UvTransfoInfos[1]];c.set(f*u,-f*p,g[0],f*p,f*u,g[1],0,0,1),r&&c.multiplyMatrices(uvTransfo,r),t.setMappingOperator(0,null,c,!0)}else r&&t.setMappingOperator(0,null,r,!0)}},getMaterialCgr:function(e,t,r,n,s){var a,o,l;if("true"===localStorage.getItem("NoCGRMaterials"))return null;if(void 0!==e.backgoundColor)return this.getBackgroundColorMaterial();if(void 0!==e.blankingRep)return this.getBlankingRepMaterial();if(void 0!==e.external3DXid){var h=this.getCGRSharedMaterial(e.external3DXid,!0);return h&&this.extractMaterialApplicationMappingInfos(e.mapping,h),h}var c=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material"===(l=(a=this.materials[o]).params).type&&!l.shaderMaterial&&l.ambientCoef===e.ambientCoef&&l.diffuseCoef===e.diffuseCoef&&l.specularCoef===e.specularCoef&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2]&&(void 0===l.url||-1!==e.textureId)&&(void 0!==l.url||-1===e.textureId)&&-1===e.textureId&&l.transparent===e.transparent&&l.shininess===e.shininess&&l.textureImageNumberComposante===e.textureImageNumberComposante&&l.textureBlending===e.textureBlending&&l.magFilter===e.magFilter&&l.minFilter===e.minFilter&&l.mappingFunction===e.mappingFunction&&l.textureWrapS===e.textureWrapS&&l.textureWrapT===e.textureWrapT&&l.addedComposantInTexEnv===e.addedComposantInTexEnv&&(!1!==l._pbr||!c)&&(!0!==l._pbr||c)&&(!l.mapping||e.mapping&&l.mapping.type===e.mapping.type&&l.mapping.ObjectTransformation===e.mapping.ObjectTransformation&&l.mapping.UvTransformation===e.mapping.UvTransformation))return a.threejs_mat;return(a=this.createMaterial(e,t,r,n,null,s))&&(a._source=i.AssetSource.MATERIAL_MANAGER),a},getMaterial3DXML:function(e,t,r,n,s){var a,o,l,h=!!i._CATGraphicalAsPBR;for(o=0;o<this.materials.length;o++)if("material3DXML"===(l=(a=this.materials[o]).params).type&&l.shading===e.shading&&l.reflectivityCoef===e.reflectivityCoef&&l.shininess===e.shininess&&l.specularCoef===e.specularCoef&&l.WrappingModeU===e.WrappingModeU&&l.WrappingModeV===e.WrappingModeV&&l.FlipU===e.FlipU&&l.FlipV===e.FlipV&&l.transparency===e.transparency&&l.transparent===e.transparent&&l.alphaTest===e.alphaTest&&l.mappingFunction===e.mappingFunction&&l.MappingType===e.MappingType&&l.TextureDimension===e.TextureDimension&&l.TextureFunction===e.TextureFunction&&l.DiffuseMap===e.DiffuseMap&&l.DiffuseMapRepeat[0]===e.DiffuseMapRepeat[0]&&l.DiffuseMapRepeat[1]===e.DiffuseMapRepeat[1]&&l.DiffuseMapWrap[0]===e.DiffuseMapWrap[0]&&l.DiffuseMapWrap[1]===e.DiffuseMapWrap[1]&&l.colorAmbient[0]===e.colorAmbient[0]&&l.colorAmbient[1]===e.colorAmbient[1]&&l.colorAmbient[2]===e.colorAmbient[2]&&l.colorDiffuse[0]===e.colorDiffuse[0]&&l.colorDiffuse[1]===e.colorDiffuse[1]&&l.colorDiffuse[2]===e.colorDiffuse[2]&&!(!l.colorSpecular&&e.colorSpecular||l.colorSpecular&&!e.colorSpecular)&&(!l.colorSpecular||!e.colorSpecular||l.colorSpecular[0]===e.colorSpecular[0]&&l.colorSpecular[1]===e.colorSpecular[1]&&l.colorSpecular[2]===e.colorSpecular[2])&&(!1!==l._pbr||!h)&&(!0!==l._pbr||h))return s&&(0===l.__nbTexturesToLoad?s(a.threejs_mat):(l.__cbLoadedImages||(l.__cbLoadedImages=[]),l.__cbLoadedImages.push(s))),a.threejs_mat;return(a=this.createMaterial(e,t,r,null,s))._source=i.AssetSource.MATERIAL_MANAGER,a},getTexture:function(e){this._currentMatHasTexture=!0;var t,r,n,s,a=[];if(e.offset||(e.offset=[0,0]),e.repeat||(e.repeat=[1,1]),e.wrap&&!e.overrideWrap||(e.resources&&e.resources.wrap?e.wrap=e.resources.wrap:e.wrap||(e.wrap=[1,1])),e.filter||(e.resources&&e.resources.filter?e.filter=e.resources.filter:e.filter=[5,1]),void 0!==e.resourceId&&this.textures[e.resourceId]&&(a=this.textures[e.resourceId]),a.length){for(n=0;n<a.length;n++)if(s=t=a[n],r=t.params,e.texturePoint===r.texturePoint)return e.offset[0]!==r.offset[0]||e.offset[1]!==r.offset[1]||e.repeat[0]!==r.repeat[0]||e.repeat[1]!==r.repeat[1]||e.wrap[0]!==r.wrap[0]||e.wrap[1]!==r.wrap[1]||e.filter[0]!==r.filter[0]||(e.filter[1],r.filter[1]),t.threejs_texture;switch((t=s.threejs_texture.clone()).offset.set(e.offset[0],e.offset[1]),t.repeat.set(e.repeat[0],e.repeat[1]),1===e.wrap[0]||"repeat"==e.wrap[0]?t.wrapS=i.RepeatWrapping:t.wrapS=i.ClampToEdgeWrapping,1===e.wrap[1]||"repeat"==e.wrap[0]?t.wrapT=i.RepeatWrapping:t.wrapT=i.ClampToEdgeWrapping,e.filter[0]){case 0:t.min=i.NearestFilter;break;case 1:t.min=i.LinearFilter;break;case 2:t.min=i.NearestMipMapNearestFilter;break;case 3:t.min=i.NearestMipMapLinearFilter;break;case 4:t.min=i.LinearMipMapNearestFilter;break;case 5:t.min=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:t.mag=i.NearestFilter;break;case 1:t.mag=i.LinearFilter;break;case 2:t.mag=i.NearestMipMapNearestFilter;break;case 3:t.mag=i.NearestMipMapLinearFilter;break;case 4:t.mag=i.LinearMipMapNearestFilter;break;case 5:t.mag=i.LinearMipMapLinearFilter}var o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};return this.textures[e.resourceId]=[{params:o,threejs_texture:t}],t._source=i.AssetSource.MATERIAL_MANAGER,t}if(t=this.createTexture(e),void 0!==e.resourceId){o={offset:e.offset,repeat:e.repeat,wrap:e.wrap,filter:e.filter,texturePoint:e.texturePoint};this.textures[e.resourceId]=[{params:o,threejs_texture:t}]}return t._source=i.AssetSource.MATERIAL_MANAGER,t},createMaterial:function(e,r,n,s,c,d){function p(){return Y}function g(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}this._currentMatHasTexture=!1,e.__nbTexturesToLoad=0,e.__cbLoadedImages=[],c&&e.__cbLoadedImages.push(c);var v="MeshPhongMaterial",_={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,blending:i.NormalBlending,side:i.DoubleSide};if(e.physicalMaterial){var y={},S=e.physicalMaterial.PhysicalMaterial,x=i.PhysicalMaterial;if(S.isVisDescription){var b=this,w="Visu.DSPBR@21x"===S.type,M="Visu.EVisuPBR"===S.type,C="Visu.DSPBR@22x"===S.type,P="Visu.DSPBR@25x"===S.type,E="Visu.SpecularGlossiness@21x"===S.type||M||w||C||P,T=e.mapping&&e.mapping.type||E,A=function(e,t,r){var n=null;r&&(n=r);var s=S[t];if(s&&(n=s),n){var a=new i.Matrix3;a.set(n[0],n[2],n[4],n[1],n[3],n[5],0,0,1),y[e]=a.isIdentity()?f:a}},D=function(e,t,r,n){var a=S[t];if(void 0!==a){if(a.length)return y[e]=new i.Color,void y[e].setRGB(a[0],a[1],a[2]);if(void 0!==a.MADCoefficients){var o=a.MADCoefficients;y[e+"MulCoef"]=new i.Vector3(o[0],o[1],o[2]),y[e+"AddCoef"]=new i.Vector3(o[3],o[4],o[5])}void 0!==a.value?(y[e]=new i.Color,y[e].setRGB(a.value[0],a.value[1],a.value[2])):void 0!==a.texture&&n?(y[e+"Map"]=b.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[a.texture],resourceId:a.texture}),null!==r&&y[e+"Map"].withSubstituteTexture(r.x,r.y,r.z),T&&A(e+"UvTransform",t+"UvTransform",s[a.texture].uvTransform)):null!==r&&(y[e]=new i.Color,y[e].setRGB(r.x,r.y,r.z))}else null!==r&&(y[e]=new i.Color,y[e].setRGB(r.x,r.y,r.z))},I=function(e,t,i,r){var n=S[t];if(void 0!==n){if("object"!=typeof n)return void(y[e]=n);if(void 0!==n.MADCoefficients){var a=n.MADCoefficients;y[e+"MulCoef"]=a[0],y[e+"AddCoef"]=a[1]}void 0!==n.value?y[e]=n.value:void 0!==n.texture&&r?(y[e+"Map"]=b.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[n.texture],resourceId:n.texture}),y.transparent=y.transparent||"opacity"===e||"transparency"===e,null!==i&&y[e+"Map"].withSubstituteTexture(i),T&&A(e+"UvTransform",t+"UvTransform",s[n.texture].uvTransform)):null!==i&&(y[e]=i)}else null!==i&&(y[e]=i)};if("Visu.SpecularGlossiness"===S.type||"Visu.SpecularGlossiness@21x"===S.type){var R=[0,0];S.RepeatU&&(R[0]=1),S.RepeatV&&(R[1]=1)}else R=null;if(M||w||C||P){D("diffuse","albedo",new i.Vector3(1,1,1),!0),x=i.DSPBR19xMaterial;var O=function(e,t,r){var n=S[t];if(void 0!==n){if(void 0!==n.MADCoefficients){var a=n.MADCoefficients;y[e+"MulCoef"]=new i.Vector3(a[0],a[1],a[2]),y[e+"AddCoef"]=new i.Vector3(a[3],a[4],a[5])}void 0!==n.texture&&(y[e+"Map"]=b.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[n.texture],resourceId:n.texture}),null!==r&&y[e+"Map"].withSubstituteTexture(r.x,r.y,r.z),A(e+"UvTransform",e+"UvTransform",s[n.texture].uvTransform))}};I("metalness","metallic",0,!0),I("roughness","roughness",0,!0),I("anisotropyAngle","anisotropyRotation",0,!0),O("normal","normal",new i.Vector3(.5,.5,1)),I("opacity","cutoutOpacity",1,!0),I("thickness","thickness",0,!0),M||(I("translucency","translucency",0,!0),O("displacement","displacement",new i.Vector3(0,0,0)),I("subsurfaceAnisotropy","subsurfaceAnisotropy",0,!1),w?(x=i.DSPBR21xMaterial,D("sheenColor","sheenColor",new i.Vector3(1,1,1),!0),I("sheenRoughness","sheenRoughness",.3,!0)):(x=i.DSPBR22xMaterial,D("sheenColor","sheenColor",new i.Vector3(0,0,0),!0),I("sheenRoughness","sheenRoughness",.5,!0),D("flipFlopColor","flipFlopColor",new i.Vector3(1,1,1),!0),I("flipFlop","flipFlop",0,!0),void 0!==S.subtype&&(y._subtype=i.DSPBRSubTypes[l[S.subtype]]),P&&(x=i.DSPBR25xMaterial,D("translucencyColor","translucencyColor",new i.Vector3(1,1,1),!0),I("iridescence","iridescence",0,!0),I("iridescenceThickness","iridescenceThickness",.4,!0),I("iridescenceIoR","iridescenceIoR",1.3,!1)))),(M||w)&&I("sheen","sheen",0,!0),I("specularContribution","specular",1,!0),D("specular","specularTint",new i.Vector3(1,1,1),!0),D("flakesColor","flakeColor",new i.Vector3(1,1,1),!0),I("flakesCoverage","flakeCoverage",0,!0),I("flakesCoverage","flakeDensity",null,!0),I("flakesSize","flakeSize",.5,!0),I("flakesRoughness","flakeRoughness",0,!0),I("clearCoat","clearcoat",0,!0),O("clearCoatNormal","clearcoatNormal",null),I("clearCoatRoughness","clearcoatRoughness",0,!0),I("orangePeel","orangePeel",!1,!1),I("orangePeelScale","orangePeelScale",0,!1),D("emissionColor","emissionColor",new i.Vector3(1,1,1),!0),I("emissionValue","emissionValue",0,!1),I("emissionNormalized","emissionEnergyNormalization",!1,!1),I("thinWalled","thinWalled",!1,!1),I("ior","ior",1.5,!1),D("attenuationColor","attenuationColor",new i.Vector3(1,1,1),!1),D("subsurfaceColor","subsurfaceColor",new i.Vector3(0,0,0),!1),I("attenuationDistance","attenuationDistance",1e8,!1),S.cutoutFromAlbedoAlpha||S.UseAlphaDiffuseChannel?(y.transparent=y.transparent||!!y.diffuseMap,y.useAlphaFromDiffuseMap=!0):y.useAlphaFromDiffuseMap=!1}else{D("diffuse","diffuse",new i.Vector3(0,0,0),!0),y.specGlossNRE=!0;O=function(e,t,i){var r=S[t+"Map"];void 0!==r&&(y[e+"Map"]=b.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[r.texture],resourceId:r.texture}),null!==i&&y[e+"Map"].withSubstituteTexture(i.x,i.y,i.z),T&&A(e+"UvTransform",t+"MapUvTransform",s[r.texture].uvTransform))};D("specular","fresnelCoefficient",new i.Vector3(.04,.04,.04),!0),D("emissionColor","emissive",new i.Vector3(0,0,0),!0),y.emissionValue=1,D("flakesColor","flakesColor",new i.Vector3(0,0,0),!1),y.flakesColorMulCoef=new i.Vector3(.12,.12,.12),y.flakesColorAddCoef=new i.Vector3(0,0,0),D("pearlFlakesColor","pearlFlakesColor",new i.Vector3(0,0,0),!1),y.pearlFlakesColorMulCoef=new i.Vector3(.08,.08,.08),y.pearlFlakesColorAddCoef=new i.Vector3(0,0,0),D("clearCoatColor","coatingFresnelCoefficient",new i.Vector3(.04,.04,.04),!0),I("glossiness","glossiness",1,!0),I("opacity","opacity",1,!0),I("anisotropyAngle","anisotropyAngle",0,!0),I("clearCoat","Coating",0,!1),function(e,t,r,n){var a=S[t];if(void 0!==a){if(void 0!==a.MADCoefficients){var o=a.MADCoefficients;y[e+"MulCoef"]=o[0],y[e+"AddCoef"]=o[1]}void 0!==a.value?y[e]=new i.Vector2(a.value,a.value):void 0!==a.texture&&n?(y[e+"Map"]=b.getTexture({wrap:R,overrideWrap:!0,type:"data",resources:s[a.texture],resourceId:a.texture}),null!==r&&y[e+"Map"].withSubstituteTexture(r.x,r.y),T&&A(e+"UvTransform",t+"UvTransform",s[a.texture].uvTransform)):null!==r&&(y[e]=r)}else null!==r&&(y[e]=r)}("normalScale","bumpScale",new i.Vector2(1,1),!0),I("coatingGlossiness","coatingGlossiness",1,!1),I("clearCoatNormalScale","coatingBump",0,!1),I("orangePeel","ProceduralCoating",!1,!1),I("orangePeelScale","coatingScale",1,!1),I("flakes","Flakes",!1,!1),I("flakesDensity","flakesDensity",0,!0),I("flakesBump","flakesBump",1,!1),I("flakesScale","flakesScale",.5,!1),I("flakesRoughness","flakesRoughness",.25,!1),I("pearlFlakesBump","pearlFlakesBump",1,!1),I("pearlFlakesDensity","pearlFlakesDensity",1,!1),O("normal","normal",new i.Vector3(.5,.5,1)),S.NormalMapConventionPositiveY?y.normalMapFlipY=!0:y.normalMapFlipY=!1,O("clearCoatNormal","coatingNormal",new i.Vector3(.5,.5,1)),S.CoatingNormalMapConventionPositiveY?y.clearCoatNormalMapFlipY=!0:y.clearCoatNormalMapFlipY=!1,I("displacement","displacement",0,!0);var L=S.displacement;if(void 0!==L&&void 0!==L.MADCoefficients){var V=L.MADCoefficients;y.displacementScale=V[0],y.displacementBias=V[1]}S.UseAlphaDiffuseChannel?(y.transparent=y.transparent||!!y.diffuseMap,y.useAlphaFromDiffuseMap=!0):y.useAlphaFromDiffuseMap=!1}I("anisotropy","anisotropy",0,!0),I("anisotropyAngle","anisotropyAngle",0,!0),I("transparency","transparency",0,!0),(1==y.opacity&&y.transparency>0||y.opacityMap)&&(y.transparent=!0),S.IsAlphaTestEnabled&&(y.transparent=!1,y.alphaTest=.5)}else{y.specGlossNRE=!0;var F=S.MappingOperator.Type;if("None"!=F&&(y.mappingUseFragment=!0,y.mappingObjTransformation=new i.Matrix4,y.mappingObjTransformation.elements=S.MappingOperator.ObjectTransformation,"Planar"==F?y.mappingType=1:"Spherical"==F?y.mappingType=2:"Spherical Normalized"==F?y.mappingType=2:"Cubic"==F?y.mappingType=3:"FiniteCylindrical"==F?y.mappingType=4:"InfiniteCylindrical"==F?y.mappingType=5:"InfiniteCylindrical Normalized"==F&&(y.mappingType=5)),y.mappingUVTransformation=new i.Matrix3,y.mappingUVTransformation.elements=S.MappingOperator.UvTransformation,S.Float3Parameter){var B=S.Float3Parameter;if(B.diffuse){V=B.diffuse.MADCoefficients;if(0==B.diffuse.AsTexture)y.color=new i.Color,y.color.setRGB(B.diffuse.Value[0],B.diffuse.Value[1],B.diffuse.Value[2]),y.diffuseMulCoef=new i.Vector3(V[0],V[1],V[2]),y.diffuseAddCoef=new i.Vector3(V[3],V[4],V[5]);else{R=[0,0];if("eRepeat"==B.diffuse.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==B.diffuse.Sampling.TexCoordVWrap&&(R[1]=1),B.diffuse.UvTransform&&"None"!=F){var N=B.diffuse.UvTransform;y.diffuseUvTransform=new i.Matrix3(N[0],N[4],N[8],N[1],N[5],N[9],N[2],N[6],N[10])}y.diffuseMulCoef=new i.Vector3(V[0],V[1],V[2]),y.diffuseAddCoef=new i.Vector3(V[3],V[4],V[5]),y.map=this.getTexture({wrap:R,type:"data",resources:s[B.diffuse.Texture],resourceId:B.diffuse.Texture})}}if(B.fresnelCoefficient){V=B.fresnelCoefficient.MADCoefficients;if(0==B.fresnelCoefficient.AsTexture)y.specular=new i.Color,y.specular.setRGB(B.fresnelCoefficient.Value[0],B.fresnelCoefficient.Value[1],B.fresnelCoefficient.Value[2]),y.specularMulCoef=new i.Vector3(V[0],V[1],V[2]),y.specularAddCoef=new i.Vector3(V[3],V[4],V[5]);else{R=[0,0];if("eRepeat"==B.fresnelCoefficient.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==B.fresnelCoefficient.Sampling.TexCoordVWrap&&(R[1]=1),B.fresnelCoefficient.UvTransform&&"None"!=F){var G=B.fresnelCoefficient.UvTransform;y.specularUvTransform=new i.Matrix3(G[0],G[4],G[8],G[1],G[5],G[9],G[2],G[6],G[10])}y.specularMulCoef=new i.Vector3(V[0],V[1],V[2]),y.specularAddCoef=new i.Vector3(V[3],V[4],V[5]),y.specularMap=this.getTexture({wrap:R,type:"data",resources:s[B.fresnelCoefficient.Texture],resourceId:B.fresnelCoefficient.Texture})}}if(B.emissive){V=B.emissive.MADCoefficients;if(0==B.emissive.AsTexture)y.emissive=new i.Color,y.emissive.setRGB(B.emissive.Value[0],B.emissive.Value[1],B.emissive.Value[2]),y.emissiveMulCoef=new i.Vector3(V[0],V[1],V[2]),y.emissiveAddCoef=new i.Vector3(V[3],V[4],V[5]);else{y.emissive=new i.Color,y.emissive.setRGB(1,1,1);R=[0,0];if("eRepeat"==B.emissive.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==B.emissive.Sampling.TexCoordVWrap&&(R[1]=1),B.emissive.UvTransform&&"None"!=F){var k=B.emissive.UvTransform;y.emissiveUvTransform=new i.Matrix3(k[0],k[4],k[8],k[1],k[5],k[9],k[2],k[6],k[10])}y.emissiveMulCoef=new i.Vector3(V[0],V[1],V[2]),y.emissiveAddCoef=new i.Vector3(V[3],V[4],V[5]),y.emissiveMap=this.getTexture({wrap:R,type:"data",resources:s[B.emissive.Texture],resourceId:B.emissive.Texture})}}if(B.coatingFresnelCoefficient&&!1===B.coatingFresnelCoefficient.AsTexture&&(y.coatingSpecularColor=new i.Color,y.coatingSpecularColor.setRGB(B.coatingFresnelCoefficient.Value[0],B.coatingFresnelCoefficient.Value[1],B.coatingFresnelCoefficient.Value[2])),B.flakesColor){V=B.flakesColor.MADCoefficients;!1===B.flakesColor.AsTexture&&(y.flakesColor=new i.Color,y.flakesColor.setRGB(B.flakesColor.Value[0],B.flakesColor.Value[1],B.flakesColor.Value[2]),y.flakesColorMulCoef=new i.Vector3(V[0],V[1],V[2]),y.flakesColorAddCoef=new i.Vector3(V[3],V[4],V[5]))}if(B.pearlFlakesColor){V=B.pearlFlakesColor.MADCoefficients;!1===B.pearlFlakesColor.AsTexture&&(y.pearlFlakesColor=new i.Color,y.pearlFlakesColor.setRGB(B.pearlFlakesColor.Value[0],B.pearlFlakesColor.Value[1],B.pearlFlakesColor.Value[2]),y.pearlFlakesColorMulCoef=new i.Vector3(V[0],V[1],V[2]),y.pearlFlakesColorAddCoef=new i.Vector3(V[3],V[4],V[5]))}}if(S.FloatParameter){var U=S.FloatParameter;if(U.glossiness){V=U.glossiness.MADCoefficients;if(0==U.glossiness.AsTexture)y.glossiness=U.glossiness.Value,y.glossinessMulCoef=V[0],y.glossinessAddCoef=V[1];else{R=[0,0];if("eRepeat"==U.glossiness.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==U.glossiness.Sampling.TexCoordVWrap&&(R[1]=1),U.glossiness.UvTransform&&"None"!=F){var z=U.glossiness.UvTransform;y.glossinessUvTransform=new i.Matrix3(z[0],z[4],z[8],z[1],z[5],z[9],z[2],z[6],z[10])}y.glossinessMulCoef=V[0],y.glossinessAddCoef=V[1],y.glossinessMap=this.getTexture({wrap:R,type:"data",resources:s[U.glossiness.Texture],resourceId:U.glossiness.Texture})}}if(U.bumpScale){V=U.bumpScale.MADCoefficients;if(0==U.bumpScale.AsTexture){var H=U.bumpScale.Value;y.normalScale=new i.Vector2(H,H),y.normalScaleMulCoef=V[0],y.normalScaleAddCoef=V[1]}}if(U.opacity){V=U.opacity.MADCoefficients;if(0==U.opacity.AsTexture)y.opacity=U.opacity.Value,y.opacityMulCoef=V[0],y.opacityAddCoef=V[1];else{R=[0,0];if("eRepeat"==U.opacity.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==U.opacity.Sampling.TexCoordVWrap&&(R[1]=1),U.opacity.UvTransform&&"None"!=F){var W=U.opacity.UvTransform;y.opacityUvTransform=new i.Matrix3(W[0],W[4],W[8],W[1],W[5],W[9],W[2],W[6],W[10])}y.opacityMulCoef=V[0],y.opacityAddCoef=V[1],y.opacityMap=this.getTexture({wrap:R,type:"data",resources:s[U.opacity.Texture],resourceId:S.MapParameter.normalMap.Texture})}}if(U.transparency){V=U.transparency.MADCoefficients;0==U.transparency.AsTexture&&(y.transparency=U.transparency.Value,y.transparencyMulCoef=V[0],y.transparencyAddCoef=V[1])}if(U.anisotropy){V=U.anisotropy.MADCoefficients;if(0==U.anisotropy.AsTexture)y.anisotropy=U.anisotropy.Value,y.anisotropyMulCoef=V[0],y.anisotropyAddCoef=V[1];else{R=[0,0];if("eRepeat"==U.anisotropy.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==U.anisotropy.Sampling.TexCoordVWrap&&(R[1]=1),U.anisotropy.UvTransform&&"None"!=F){var j=U.anisotropy.UvTransform;y.anisotropyUvTransform=new i.Matrix3(j[0],j[4],j[8],j[1],j[5],j[9],j[2],j[6],j[10])}y.anisotropyMulCoef=V[0],y.anisotropyAddCoef=V[1],y.anisotropyMap=this.getTexture({wrap:R,type:"data",resources:s[U.anisotropy.Texture],resourceId:U.anisotropy.Texture})}}if(U.anisotropyAngle)if(0==U.anisotropyAngle.AsTexture){V=U.anisotropyAngle.MADCoefficients;y.anisotropyAngle=U.anisotropyAngle.Value,y.anisotropyAngleMulCoef=V[0],y.anisotropyAngleAddCoef=V[1]}else{R=[0,0];if("eRepeat"==U.anisotropyAngle.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==U.anisotropyAngle.Sampling.TexCoordVWrap&&(R[1]=1),U.anisotropyAngle.UvTransform&&"None"!=F){var X=U.anisotropyAngle.UvTransform;y.anisotropyAngleUvTransform=new i.Matrix3(X[0],X[4],X[8],X[1],X[5],X[9],X[2],X[6],X[10])}y.anisotropyAngleMulCoef=V[0],y.anisotropyAngleAddCoef=V[1],y.anisotropyAngleMap=this.getTexture({wrap:R,type:"data",resources:s[U.anisotropyAngle.Texture],resourceId:U.anisotropyAngle.Texture})}if(U.coatingGlossiness){V=U.coatingGlossiness.MADCoefficients;if(!1===U.coatingGlossiness.AsTexture){H=V[1]+U.coatingGlossiness.Value*V[0];y.coatingGlossiness=H}else{R=[0,0];if("eRepeat"==U.coatingGlossiness.Sampling.TexCoordUWrap&&(R[0]=1),"eRepeat"==U.coatingGlossiness.Sampling.TexCoordVWrap&&(R[1]=1),U.coatingGlossiness.UvTransform&&"None"!=F){var q=U.coatingGlossiness.UvTransform;y.coatingGlossinessUvTransform=new i.Matrix3(q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10])}y.coatingGlossinessMulCoef=V[0],y.coatingGlossinessAddCoef=V[1],y.coatingGlossinessMap=this.getTexture({wrap:R,type:"data",resources:s[U.coatingGlossiness.Texture],resourceId:U.coatingGlossiness.Texture})}}if(U.coatingBump){V=U.coatingBump.MADCoefficients;if(!1===U.coatingBump.AsTexture){H=V[1]+U.coatingBump.Value*V[0];y.clearCoatNormalScale=H}}if(U.coatingScale){V=U.coatingScale.MADCoefficients;if(!1===U.coatingScale.AsTexture){H=V[1]+U.coatingScale.Value*V[0];y.orangePeelScale=H}}if(U.flakesBump){V=U.flakesBump.MADCoefficients;if(!1===U.flakesBump.AsTexture){H=V[1]+U.flakesBump.Value*V[0];y.flakesBump=H}}if(U.flakesDensity){V=U.flakesDensity.MADCoefficients;if(!1===U.flakesDensity.AsTexture){H=V[1]+U.flakesDensity.Value*V[0];y.flakesDensity=H}}if(U.flakesScale){V=U.flakesScale.MADCoefficients;if(!1===U.flakesScale.AsTexture){H=V[1]+U.flakesScale.Value*V[0];y.flakesScale=H}}if(U.flakesRoughness){V=U.flakesRoughness.MADCoefficients;if(!1===U.flakesRoughness.AsTexture){H=V[1]+U.flakesRoughness.Value*V[0];y.flakesRoughness=H}}if(U.pearlFlakesBump){V=U.pearlFlakesBump.MADCoefficients;if(!1===U.pearlFlakesBump.AsTexture){H=V[1]+U.pearlFlakesBump.Value*V[0];y.pearlFlakesBump=H}}if(U.pearlFlakesDensity){V=U.pearlFlakesDensity.MADCoefficients;if(!1===U.pearlFlakesDensity.AsTexture){H=V[1]+U.pearlFlakesDensity.Value*V[0];y.pearlFlakesDensity=H}}}if(y.useAlphaFromDiffuseMap=!1,"eDiffuseChannel"==S.AlphaMode?(y.transparent=y.transparent||!!y.map,y.useAlphaFromDiffuseMap=!0):(1==y.opacity&&y.transparency>0||y.opacityMap)&&(y.transparent=!0),1==S.AlphaTest&&(y.transparent=!1,y.alphaTest=.5),!0===S.Coating&&(y.coating=1),!0===S.ProceduralCoating&&(y.orangePeel=!0),!0===S.Flakes&&(y.flakes=!0),S.NormalMap&&1==S.NormalMap.UseNormalMap&&(y.normalMap=this.getTexture({type:"data",resources:s[S.NormalMap.Texture],resourceId:S.NormalMap.Texture})),S.MapParameter&&S.MapParameter.normalMap&&1==S.MapParameter.normalMap.Enabled){if(y.normalMap=this.getTexture({type:"data",resources:s[S.MapParameter.normalMap.Texture],resourceId:S.MapParameter.normalMap.Texture}),S.MapParameter.normalMap.UvTransform&&"None"!=F){var Z=S.MapParameter.normalMap.UvTransform;y.normalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=S.NormalMapConvention?y.normalMapFlipY=!1:y.normalMapFlipY=!0}if(S.MapParameter&&S.MapParameter.coatingBumpMap&&1==S.MapParameter.coatingBumpMap.Enabled){if(y.clearCoatNormalMap=this.getTexture({type:"data",resources:s[S.MapParameter.coatingBumpMap.Texture],resourceId:S.MapParameter.coatingBumpMap.Texture}),S.MapParameter.coatingBumpMap.UvTransform&&"None"!=F){Z=S.MapParameter.coatingBumpMap.UvTransform;y.clearCoatNormalUvTransform=new i.Matrix3(Z[0],Z[4],Z[8],Z[1],Z[5],Z[9],Z[2],Z[6],Z[10])}"PositiveY"!=S.CoatingBumpMapConvention?y.clearCoatNormalMapFlipY=!1:y.clearCoatNormalMapFlipY=!0}}y.NRECompatibility=!0;var Y=new x(y);return this.extractMaterialApplicationMappingInfos(e.mapping,Y),Y}if(e.shaderMaterial)return e.shaderMaterial.PDSFX?(Y=function(e,t,r,n,s){var a=0,o=e.param;for(a in o){var l=o[a].imgId;void 0!==l&&(t[l]&&t[l].url&&(o[a].url=t[l].url),o[a].map=r.getTexture({type:"data",resources:t[l],resourceId:l}),r.resources[l]=o[a].map)}var c={name:e.name,parameters:e.param,material:null},d=localStorage.getItem("A2XPDSFXConvention");-1==h.indexOf(e.name)&&(d=!0);var u="DS/Shaders/"+e.name;return d&&(u="DS/"+e.name+"/"+e.name),require([u],function(t){if(s.material=i.MaterialUtils.createShinyFaceMaterial(),t(s.material,e.param),s.material&&(s.material.needsUpdate=!0),s.geometry&&s.geometry.meshList)for(var r=0;r<s.geometry.meshList.length;r++)s.geometry.meshList[r]._flagAsGSSOInvalidated()}),r._modelEvent.publish({event:"PDSFXMaterial",data:c}),c.material?c.material:null}(e.shaderMaterial,s,this,e.transparent,d))||null:Y=function(e,r,n,s){if(null!=e){var l=e.param,h=0;null!=l.transparency_multiply_blend&&(h=l.transparency_multiply_blend);var c,d=t.getWebappsAssetUrl("Visualization","");switch(null==m&&(m=a(u=[d+"studio_pure_white_Specular_Map/posx.jpg",d+"studio_pure_white_Specular_Map/negx.jpg",d+"studio_pure_white_Specular_Map/posy.jpg",d+"studio_pure_white_Specular_Map/negy.jpg",d+"studio_pure_white_Specular_Map/posz.jpg",d+"studio_pure_white_Specular_Map/negz.jpg"])),e.name){case"MPM_basic":case"MPM_material":case"MPM_colored_glass":case"MPM_diffuse":case"MPM_soft_plastic":case"MPM_polished_plastic":case"MPM_clear_glass":case"MPM_frosted_glass":case"MPM_diamond":case"MPM_satinated_metal":case"MPM_anisotropic_metal":case"MPM_polished_metal":case"MPM_emissive":var u=[(d=t.getWebappsAssetUrl("Visualization",""))+"studio_pure_white_Diffuse_Map/posx.jpg",d+"studio_pure_white_Diffuse_Map/negx.jpg",d+"studio_pure_white_Diffuse_Map/posy.jpg",d+"studio_pure_white_Diffuse_Map/negy.jpg",d+"studio_pure_white_Diffuse_Map/posz.jpg",d+"studio_pure_white_Diffuse_Map/negz.jpg"],p=l.mapping_world_to_object_position_1st_column,f=l.mapping_world_to_object_position_2nd_column,g=l.mapping_world_to_object_position_3rd_column,v=l.mapping_world_to_object_position_4th_column,_=new i.Matrix4(p[0],p[1],p[2],p[3],f[0],f[1],f[2],f[3],g[0],g[1],g[2],g[3],v[0],v[1],v[2],v[3]);(new i.Matrix4).getInverse(_),a(u);var y={};!function(e,i,r,n){var s=t.getWebappsAssetUrl("Visualization",""),a=o(s+"default_white_color.png"),l=o(s+"slot_normal_default.jpg"),h=o(s+"slot_specular_anisotropy_direction_default.jpg");e.AmbientOcclusion2D&&"slot_ambient_occlusion_default.tif"==e.AmbientOcclusion2D.url?r.AmbientOcclusion2D=a:r.AmbientOcclusion2D=n.getTexture({type:"data",resources:i[e.AmbientOcclusion2D.imgId],resourceId:e.AmbientOcclusion2D.imgId}),e.Clarity2D&&"slot_clarity_default.tif"==e.Clarity2D.url?r.Clarity2D=a:r.Clarity2D=n.getTexture({type:"data",resources:i[e.Clarity2D.imgId],resourceId:e.Clarity2D.imgId}),e.Diffuse2D&&"slot_diffuse_default.tif"==e.Diffuse2D.url?r.Diffuse2D=a:r.Diffuse2D=n.getTexture({type:"data",resources:i[e.Diffuse2D.imgId],resourceId:e.Diffuse2D.imgId,checkTransparency:!0}),e.Emissive2D&&"slot_emissive_default.tif"==e.Emissive2D.url?r.Emissive2D=a:r.Emissive2D=n.getTexture({type:"data",resources:i[e.Emissive2D.imgId],resourceId:e.Emissive2D.imgId}),e.Height2D&&"slot_displacement_default.tif"==e.Height2D.url?r.Height2D=a:r.Height2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Normal2D&&"slot_normal_default.tif"==e.Normal2D.url?r.Normal2D=l:r.Normal2D=n.getTexture({type:"data",resources:i[e.Height2D.imgId],resourceId:e.Height2D.imgId}),e.Specular2D&&"slot_specular_default.tif"==e.Specular2D.url?r.Specular2D=a:r.Specular2D=n.getTexture({type:"data",resources:i[e.Specular2D.imgId],resourceId:e.Specular2D.imgId}),e.SpecularAnisotropyDirection2D&&"slot_specular_anisotropy_direction_default.tif"==e.SpecularAnisotropyDirection2D.url?r.SpecularAnisotropyDirection2D=h:r.SpecularAnisotropyDirection2D=n.getTexture({type:"data",resources:i[e.SpecularAnisotropyDirection2D.imgId],resourceId:e.SpecularAnisotropyDirection2D.imgId}),e.SpecularGlossiness2D&&"slot_specular_glossiness_default.tif"==e.SpecularGlossiness2D.url?r.SpecularGlossiness2D=a:r.SpecularGlossiness2D=n.getTexture({type:"data",resources:i[e.SpecularGlossiness2D.imgId],resourceId:e.SpecularGlossiness2D.imgId}),e.Transparency2D&&"slot_transparency_default.tif"==e.Transparency2D.url?r.Transparency2D=a:r.Transparency2D=n.getTexture({type:"data",resources:i[e.Transparency2D.imgId],resourceId:e.Transparency2D.imgId})}(l,r,y,n),(E=new Array(3))[0]=l.default_generic_brdf_diffuse_color[0]*l.default_generic_brdf_diffuse_weight,E[1]=l.default_generic_brdf_diffuse_color[1]*l.default_generic_brdf_diffuse_weight,E[2]=l.default_generic_brdf_diffuse_color[2]*l.default_generic_brdf_diffuse_weight,E[0]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[0],E[1]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[1],E[2]+=l.default_generic_btdf_transparency_weight*l.default_vp_color[2],c=new i.DSPBR22xMaterial({needTangentBinormal:!0,diffuseMulCoef:(new i.Vector3).setFromArray(E),diffuseAddCoef:new i.Vector3(0,0,0),specularMulCoef:(new i.Vector3).setFromArray(l.default_generic_brdf_specular_color),specularAddCoef:new i.Vector3(0,0,0),emissionColorMulCoef:(new i.Vector3).setFromArray(l.default_generic_edf_diffuse_color),emissionColorAddCoef:new i.Vector3(0,0,0),opacity:l.default_sp_opacity,ior:l.default_generic_brdf_ior,roughness:1-l.default_generic_brdf_specular_glossiness,specularContribution:l.default_generic_brdf_specular_weight,anisotropy:l.default_generic_brdf_specular_anisotropy/Math.PI,anisotropyAngle:l.default_generic_brdf_specular_anisotropy_rotation/Math.PI,emissionValue:l.default_generic_edf_diffuse_weight,transparency:l.default_generic_btdf_transparency_weight,metalness:0,normalUvSlot:l.default_slot_normal,opacityUvSlot:l.default_slot_opacity,diffuseUvSlot:l.default_slot_diffuse_color,specularUvSlot:l.default_slot_specular_color,roughnessUvSlot:l.default_slot_specular_glossiness,anisotropyAngleUvSlot:l.default_slot_specular_anisotropy_direction,transparencyUvSlot:l.default_slot_transparency,emissionColorUvSlot:l.default_slot_emissive_color,thinWalled:!!l.thin_walled,map:y.Diffuse2D,emissionColorMap:y.Emissive2D,specularMap:y.Specular2D,roughnessMap:y.SpecularGlossiness2D,roughnessAddCoef:y.SpecularGlossiness2D?1:null,roughnessMulCoef:y.SpecularGlossiness2D?-1:null,anisotropyAngleMap:y.SpecularAnisotropyDirection2D,opacityMap:y.Opacity2D,transparent:y.Opacity2D||y.Transparency2D,mappingType:l.mapping_type,mappingUVTransformation:new i.Matrix3(l.mapping_scale_u,0,l.mapping_offset_u,0,l.mapping_scale_v,l.mapping_offset_v,0,0,1)});break;case"mia_phen_polished_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,T[1]=l.diffuse?l.diffuse[1]:1,T[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:l.reflectivity,specular:new i.Color(T),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h});break;case"mia_phen_satinated_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,T[1]=l.diffuse?l.diffuse[1]:1,T[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:l.reflectivity,specular:new i.Color(T),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_anisotropic_metal":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:0,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,T[1]=l.diffuse?l.diffuse[1]:1,T[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),ior:null!=l.refr_ior?l.refr_ior:8,opacity:1-h,needTangentBinormal:!0,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:.1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:0});break;case"mia_phen_soft_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.7,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refl_gloss?l.refl_gloss:.25),metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_polished_plastic":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:.75,(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,ior:null!=l.refr_ior?l.refr_ior:2,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_diffuse":(E=new Array(3))[0]=l.diffuse?l.diffuse[0]:1,E[1]=l.diffuse?l.diffuse[1]:1,E[2]=l.diffuse?l.diffuse[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:0,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_frosted_glass":(E=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,E[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,E[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_clear_glass":c=new i.DSPBR22xMaterial({color:new i.Color(8947848),emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:0,transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_colored_glass":l.reflectivity=null!=l.reflectivity?l.reflectivity:.66,(E=new Array(3))[0]=l.refr_falloff_color?l.refr_falloff_color[0]:1,E[1]=l.refr_falloff_color?l.refr_falloff_color[1]:1,E[2]=l.refr_falloff_color?l.refr_falloff_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:1-(null!=l.refr_gloss?l.refr_gloss:1),transparency:1,ior:null!=l.refr_ior?l.refr_ior:1.45,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"diamond":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:1,(E=new Array(3))[0]=l.refr_color?l.refr_color[0]:1,E[1]=l.refr_color?l.refr_color[1]:1,E[2]=l.refr_color?l.refr_color[2]:1,E[0]*=l.diffuse_weight,E[1]*=l.diffuse_weight,E[2]*=l.diffuse_weight,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:.34,metalness:0,transparency:.5,ior:null!=l.refr_ior?l.refr_ior:2.4,opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_emissive":c=new i.DSPBR22xMaterial({color:new i.Color(0),specularContribution:0,emissionColor:new i.Color(null!=l.color?l.color:[1,1,1,1]),emissionValue:null!=l.intensity?l.intensity:1e3,opacity:1-h,needTangentBinormal:!0});break;case"CATIATemplateUseMapCubic":case"CATIATemplateUseMapSpheric":var S;S=n.getTexture({type:"data",resources:r[l.KdText.imgId],resourceId:l.KdText.imgId,checkTransparency:!0}),l.Kd=null!=l.Kd?l.Kd:1,l.KsShi=null!=l.KsShi?l.KsShi:.75,l.Ks=null!=l.Ks?l.Ks:.75,(E=new Array(3))[0]=l.KdColor?l.KdColor[0]:1,E[1]=l.KdColor?l.KdColor[1]:1,E[2]=l.KdColor?l.KdColor[2]:1,E[0]*=l.Kd,E[1]*=l.Kd,E[2]*=l.Kd,(T=new Array(3))[0]=l.KsColor?l.KsColor[0]:1,T[1]=l.KsColor?l.KsColor[1]:1,T[2]=l.KsColor?l.KsColor[2]:1,c=new i.DSPBR22xMaterial({diffuseMulCoef:(new i.Vector3).setFromArray(E),diffuseAddCoef:new i.Vector3,map:S,specular:new i.Color(T),specularContribution:l.Ks,roughness:l.KsShi,metalness:0,transparency:null!=l.Kt?l.Kt:0,ior:2+(null!=l.Kr?l.Kr:1),opacity:1-h,needTangentBinormal:!0});break;case"mia_phen_material":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:.77,l.reflectivity=null!=l.reflectivity?l.reflectivity:0;var x=null!=l.transparency?l.transparency:0;(E=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight*(1-x),E[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight*(1-x),E[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight*(1-x),E[0]+=(l.refr_color?l.refr_color[0]:1)*x,E[1]+=(l.refr_color?l.refr_color[1]:1)*x,E[2]+=(l.refr_color?l.refr_color[2]:1)*x,(T=new Array(3))[0]=l.refl_color?l.refl_color[0]:1,T[1]=l.refl_color?l.refl_color[1]:1,T[2]=l.refl_color?l.refl_color[2]:1;var b=1-(null!=l.refl_gloss?l.refl_gloss:0),w=x*(1-(null!=l.refl_gloss?l.refr_gloss:1))+(1-x)*b;c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:w,metalness:0,transparency:x,ior:null!=l.refr_ior?l.refr_ior:1.5,opacity:1-h,alphaTest:null!=l.cutout_opacity?l.cutout_opacity:1,anisotropy:null!=l.anisotropy?l.anisotropy/Math.PI:1,anisotropyAngle:null!=l.anisotropy_rotation?l.anisotropy_rotation/Math.PI:1,needTangentBinormal:!0});break;case"mia_phen_reflective_translucent":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.reflectivity=null!=l.reflectivity?l.reflectivity:0,x=null!=l.transparency?l.transparency:.8,(E=new Array(3))[0]=(l.diffuse?l.diffuse[0]:1)*l.diffuse_weight,E[1]=(l.diffuse?l.diffuse[1]:1)*l.diffuse_weight,E[2]=(l.diffuse?l.diffuse[2]:1)*l.diffuse_weight;var M=new Array(3);M[0]=l.refr_trans_color?l.refr_trans_color[0]:1,M[1]=l.refr_trans_color?l.refr_trans_color[1]:1,M[2]=l.refr_trans_color?l.refr_trans_color[2]:1,w=1-(null!=l.refl_gloss?l.refr_gloss:1),c=new i.DSPBR25xMaterial({color:new i.Color(E),translucency:null!=l.refr_trans_weight?l.refr_trans_weight:1,translucencyColor:new i.Color(M),specularContribution:l.reflectivity,emissionColor:new i.Color(null!=l.emissive_color?l.emissive_color:[1,1,1,1]),emissionValue:null!=l.emissive_intensity?l.emissive_intensity:0,roughness:w,metalness:0,transparency:x,ior:null!=l.refr_ior?l.refr_ior:1.3,opacity:1-h,needTangentBinormal:!0});break;case"mip_metallic_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,w=(null!=l.spec_exp?l.spec_exp:60)/150;var C=null!=l.spec_sec_weight?l.spec_sec_weight:.25,P=(null!=l.spec_sec_exp?l.spec_sec_exp:25)/150;(E=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,E[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,E[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(T=new Array(3))[0]=l.spec?l.spec[0]:1,T[1]=l.spec?l.spec[1]:1,T[2]=l.spec?l.spec[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),specularContribution:l.spec_weight,clearCoat:C,clearCoatRoughness:P,roughness:w,metalness:0,opacity:1-h,needTangentBinormal:!0});break;case"mip_car_paint":l.diffuse_weight=null!=l.diffuse_weight?l.diffuse_weight:1,l.spec_weight=null!=l.spec_weight?l.spec_weight:.2,w=(null!=l.spec_exp?l.spec_exp:60)/150;var E,T,A=(null!=l.flake_exp?l.flake_exp:45)/150;(E=new Array(3))[0]=(l.base_color?l.base_color[0]:0)*l.diffuse_weight,E[1]=(l.base_color?l.base_color[1]:1)*l.diffuse_weight,E[2]=(l.base_color?l.base_color[2]:0)*l.diffuse_weight,(T=new Array(3))[0]=l.spec?l.spec[0]:1,T[1]=l.spec?l.spec[1]:1,T[2]=l.spec?l.spec[2]:1;var D=new Array(3);D[0]=l.flake_color?l.spec[0]:1,D[1]=l.flake_color?l.spec[1]:1,D[2]=l.flake_color?l.spec[2]:1,c=new i.DSPBR22xMaterial({color:new i.Color(E),specular:new i.Color(T),flakesColor:new i.Color(T),specularContribution:l.spec_weight,clearCoat:1,clearCoatRoughness:.05,roughness:w,flakesRoughness:A,flakesCoverage:null!=l.flake_density?l.flake_density:.5,flakesSize:null!=l.flake_scale?l.flake_scale:5,metalness:0,opacity:1-h,ior:null!=l.__incident_ior?l.__incident_ior:1,needTangentBinormal:!0});break;default:return i.MaterialUtils.createShinyFaceMaterial()}return c.force=!0,c.lights=!0,c._usePhongLighting=!0,c.uniforms&&c.uniforms.ReflectionCUBEMap&&(c.uniforms.ReflectionCUBEMap.value=m),void 0!==s&&0!==s&&(c.transparent=!0),c}return i.MaterialUtils.createShinyFaceMaterial()}(e.shaderMaterial,s,this,e.transparent);if(null===e)return i.MaterialUtils.createShinyFaceMaterial();void 0!==e.wireframe&&(_.wireframe=e.wireframe),void 0!==e.transparent&&(_.opacity=1-e.transparent,1!==_.opacity&&(_.transparent=!0));var Q,K=i._CATGraphicalAsPBR;if(e.shading&&("Phong"===e.shading?v="MeshPhongMaterial":"Basic"===e.shading&&(K=!1,v="MeshBasicMaterial")),e.blending&&("Additive"===e.blending?_.blending=i.AdditiveBlending:"Subtractive"===e.blending?_.blending=i.SubtractiveBlending:"Multiply"===e.blending&&(_.blending=i.MultiplyBlending)),void 0!==e.depthTest&&(_.depthTest=e.depthTest),void 0!==e.vertexColors&&("face"===e.vertexColors?_.vertexColors=i.VertexColorType.Face:e.vertexColors&&(_.vertexColors=i.VertexColorType.RGBA)),e.colorDiffuse?void 0!==e.diffuseCoef?(Q=[e.colorDiffuse[0]*e.diffuseCoef,e.colorDiffuse[1]*e.diffuseCoef,e.colorDiffuse[2]*e.diffuseCoef],_.color=g(Q)):_.color=g(e.colorDiffuse):e.DbgColor&&(_.color=e.DbgColor),e.colorSpecular&&(void 0!==e.specularCoef?(Q=[e.colorSpecular[0]*e.specularCoef,e.colorSpecular[1]*e.specularCoef,e.colorSpecular[2]*e.specularCoef],_.specular=g(Q)):_.specular=g(e.colorSpecular)),e.colorAmbient&&(void 0!==e.ambientCoef?(Q=[e.colorAmbient[0]*e.ambientCoef,e.colorAmbient[1]*e.ambientCoef,e.colorAmbient[2]*e.ambientCoef],_.ambient=g(Q)):_.ambient=g(e.colorAmbient)),e.transparency&&(_.opacity=e.transparency,1!==_.opacity&&(_.transparent=!0)),e.shininess&&(_.shininess=e.shininess,K&&(_.shininess/="material3DXML"===e.type?128:255)),e.reflectivityCoef&&(_.reflectivity=e.reflectivityCoef),e.alphaTest&&(_.alphaTest=e.alphaTest),e.reflectivityCoef>.1&&void 0===e.ReflectionMap){if(null===u){var $=o(t.getWebappsAssetUrl("Visualization","")+"defaultEnvMap.png",i.ImageUtils.crossOriginPolicy);$.flipY=!0,$.mapping=new i.SphericalReflectionMapping,u=$}_.envMap=u,_.combine=i.MixOperation}var J=null;if(_.textureBlending=i.TextureBlendOperations.MODULATE,void 0!==e.textureId&&-1!==e.textureId)if(void 0!==e.textureBlending&&(_.textureBlending=e.textureBlending),"SPHERICAL_ENV_MAP"===e.mappingFunction)_.sphereMap=!0;else{_.map=this.getTexture({type:"data",resources:s[e.textureId],filter:[e.minFilter,e.magFilter],wrap:[e.textureWrapS,e.textureWrapT],resourceId:e.textureId,checkTransparency:!0}),_.map.transparent&&(_.transparent=!0,_.alphaTest=1e-4);var ee=s[e.textureId].uvTransform;ee&&(J=new i.Matrix3).set(ee[0],ee[1],ee[4],ee[2],ee[3],ee[5],0,0,1)}if(e.DiffuseMap&&r&&(_.map=this.getTexture({type:"url",sourceFile:e.DiffuseMap,texturePath:r,material:e,cb:p,repeat:e.DiffuseMapRepeat,offset:e.DiffuseMapOffset,wrap:e.DiffuseMapWrap,checkTransparency:!0,format:n})),e.mapLight&&r&&(_.lightMap=this.getTexture({type:"url",sourceFile:e.mapLight,material:e,cb:p,texturePath:r,repeat:e.mapLightRepeat,offset:e.mapLightOffset,wrap:e.mapLightWrap})),e.mapNormal&&r&&(_.normalMap=this.getTexture({type:"url",sourceFile:e.mapNormal,material:e,cb:p,texturePath:r,repeat:e.mapNormalRepeat,offset:e.mapNormalOffset,wrap:e.mapNormalWrap})),e.mapSpecular&&r&&(_.specularMap=this.getTexture({type:"url",sourceFile:e.mapSpecular,material:e,cb:p,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e.ReflectionMap&&r&&(_.envMap=this.getTexture({type:"url_envMap",sourceFile:e.mapSpecular,material:e,cb:p,texturePath:r,repeat:e.mapSpecularRepeat,offset:e.mapSpecularOffset,wrap:e.mapSpecularWrap})),e._pbr=!1,_.envMap&&_.envMap.withSubstituteTexture(1,1,1),_.map&&_.map.withSubstituteTexture(1,1,1),_.specularMap&&_.specularMap.withSubstituteTexture(1,1,1),_.normalMap&&_.normalMap.withSubstituteTexture(.5,.5,1),K){var te=i.MaterialUtils.convertShininessToIoRRoughness(_.shininess?_.shininess:0);_.roughness=te.roughness,_.reflectivityEnvMap=_.envMap,_.envMap=null,_.ior=te.ior,v="_CATGraphicalMaterial",e._pbr=!0,_.diffuseUvTransform=J,J=null}if(Y=new i[v](_),this.extractMaterialApplicationMappingInfos(e.mapping,Y,J),void 0!==e.DbgName&&(Y.name=e.DbgName),void 0!==e.textureId&&-1!==e.textureId&&(e.url=s[e.textureId].url),this.materials.push({params:e,threejs_mat:Y,hasTexture:this._currentMatHasTexture}),0===e.__nbTexturesToLoad)for(var ie=0;ie<e.__cbLoadedImages.length;ie++)e.__cbLoadedImages[ie](Y);return Y.map&&Y.map.needToCheckTransparency&&(Y.map.transparentCb=function(e){Y.transparent=e}),Y},_getPointMaterial:function(e){var r=this,n=function(e,t){return r.texturesPoint[e]?r.texturesPoint[e]:(r.texturesPoint[e]=o(t,i.ImageUtils.crossOriginPolicy),r.texturesPoint[e])},s=9,a=(e.symbol&&e.symbol,e.color),l=null,h=!1,c=t.getWebappsAssetUrl("Visualization","");switch(e.symbol){case this.PointSymbolEnum.NOSPRITE:l=null;break;case this.PointSymbolEnum.CROSS:l=n(1,c+"textures/point/cross.png"),h=!0;break;case this.PointSymbolEnum.PLUS:l=n(2,c+"textures/point/plus.png"),h=!0;break;case this.PointSymbolEnum.COINCIDENT:l=n(3,c+"textures/point/concentric.png"),h=!0;break;case this.PointSymbolEnum.CONCENTRIC:l=n(4,c+"textures/point/coincident.png"),h=!0;break;case this.PointSymbolEnum.FULLCIRCLE:l=n(5,c+"textures/point/fullCircle.png"),h=!0,s=5;break;case this.PointSymbolEnum.FULLSQUARE:l=n(6,c+"textures/point/fullSquare.png"),s=7;break;case this.PointSymbolEnum.STAR:l=n(7,c+"textures/point/star.png"),h=!0;break;case this.PointSymbolEnum.DOT:l=n(8,c+"textures/point/dot.png"),s=3;break;case this.PointSymbolEnum.SMALLDOT:l=n(9,c+"textures/point/smallDot.png"),s=2;break;default:l=null}return e.size&&(s=e.size),e.withoutDPR||(s=Math.round(s*(i.getDevicePixelRatio()||1))),e.scale&&(s=e.scale*s),new i.ParticleBasicMaterial({size:s,color:a,map:l,sizeAttenuation:!1,blending:i.NormalBlending,depthTest:!1,transparent:h,alphaTest:.01})},createPointMaterial:function(e){var r=this;if(!e._cgr)return this._getPointMaterial(e);var n,s=function(e,t){return r.texturesPoint[e]?r.texturesPoint[e]:(r.texturesPoint[e]=o(t,i.ImageUtils.crossOriginPolicy),r.texturesPoint[e])},a=null,l=9,h=e.color,c=e.opacity,d=!1,u=!!e.isNoz,p=t.getWebappsAssetUrl("Visualization","");if(void 0!==e.symbol){switch(e.symbol){case 0:n=null,e.size&&(l=e.size);break;case 1:n=s(1,p+"textures/point/cross.png"),d=!0;break;case 2:n=s(2,p+"textures/point/plus.png"),d=!0;break;case 3:n=s(3,p+"textures/point/concentric.png"),d=!0;break;case 4:n=s(4,p+"textures/point/coincident.png"),d=!0;break;case 5:n=s(5,p+"textures/point/fullCircle.png"),d=!0,l=5;break;case 6:n=s(6,p+"textures/point/fullSquare.png"),l=7;break;case 7:n=s(7,p+"textures/point/star.png"),d=!0;break;case 8:n=s(8,p+"textures/point/dot.png"),l=3;break;case 9:n=s(9,p+"textures/point/smallDot.png"),l=2;break;default:n=s(1,p+"textures/point/cross.png"),d=!0}l=Math.round(l*(i.getDevicePixelRatio()||1))}else l=e.size;return a=new i.ParticleBasicMaterial({size:l,color:h,map:n,blending:i.NormalBlending,depthTest:!u,sizeAttenuation:!1,transparent:d,alphaTest:.01}),c&&(a.opacity=c),a},createTexture:function(e){function t(t,r){var n,s,a=new Image;i.ImageUtils.nbTexturesBeingLoaded++,e.material.__nbTexturesToLoad++,t.loadEndStatus=i.AssetLoadingStatus.LOADING,a.onload=function(){t.loadEndStatus=i.AssetLoadingStatus.READY,i.ImageUtils.is_pow2(a.width)&&i.ImageUtils.is_pow2(a.height)?t.image=a:(n=i.ImageUtils.nearest_pow2(a.width),s=i.ImageUtils.nearest_pow2(a.height),t.image.width=n,t.image.height=s,t.image.getContext("2d").drawImage(a,0,0,n,s)),t.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--;for(var r=0;r<t.onLoadCallbacks.length;r++)t.onLoadCallbacks[r](t);if(0===e.material.__nbTexturesToLoad)for(r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},a.onerror=function(){if(i.ImageUtils.nbTexturesBeingLoaded--,e.material.__nbTexturesToLoad--,t.loadEndStatus=i.AssetLoadingStatus.ERROR,0===e.material.__nbTexturesToLoad)for(var r=0;r<e.material.__cbLoadedImages.length;r++)e.material.__cbLoadedImages[r](e.cb())},a.crossOrigin="anonymous",a.src=r}function r(e,t,i,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_=t/r,y=new Float32Array(i*r*s);if(1!==_)for(d=_/2,u=0;u<r;u++,d+=_)for(o=(a=Math.floor(d))>=i-1?0:s,l=d-a,h=u*s,c=a*s,p=0;p<i;p++,h+=r*s,c+=t*s)for(f=0;f<s;f++)y[h+f]=e[c+f]*(1-l)+e[c+o+f]*l;else for(g=0;g<i*r*s;g++)y[g]=e[g];if(m=i/n,v=new Uint8Array(n*r*s),1!==m)for(d=m/2,p=0;p<n;p++,d+=m)for(o=(a=Math.floor(d))>=i-1?0:s*r,l=d-a,h=p*r*s,c=a*r*s,u=0;u<r;u++,h+=s,c+=s)for(f=0;f<s;f++)v[h+f]=y[c+f]*(1-l)+y[c+o+f]*l;else for(g=0;g<n*r*s;g++)v[g]=y[g];return v}function n(e){var t;for(t=3;t<e.length;t+=4)if(255!=e[t])return!0;return!1}var s,a,o,l,h;switch(s=1===e.wrap[0]||"repeat"==e.wrap[0]?i.RepeatWrapping:i.ClampToEdgeWrapping,a=1===e.wrap[1]||"repeat"==e.wrap[0]?i.RepeatWrapping:i.ClampToEdgeWrapping,e.filter[0]){case 0:l=i.NearestFilter;break;case 1:l=i.LinearFilter;break;case 2:l=i.NearestMipMapNearestFilter;break;case 3:l=i.NearestMipMapLinearFilter;break;case 4:l=i.LinearMipMapNearestFilter;break;case 5:l=i.LinearMipMapLinearFilter}switch(e.filter[1]){case 0:o=i.NearestFilter;break;case 1:o=i.LinearFilter;break;case 2:o=i.NearestMipMapNearestFilter;break;case 3:o=i.NearestMipMapLinearFilter;break;case 4:o=i.LinearMipMapNearestFilter;break;case 5:o=i.LinearMipMapLinearFilter}switch(e.type){case"url":if("dds"===(c=/(?:\.([^.]+))?$/.exec(e.sourceFile.filename)[1])?h=i.ImageUtils.loadCompressedTextureFromBuffer(e.sourceFile.buffer):(u=document.createElement("canvas"),h=new i.Texture(u),"XMLV6"===e.format?h.sourceFile=e.sourceFile:h.sourceFile=window.URL.createObjectURL(e.sourceFile.buffer)),h.wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,e.offset&&h.offset.set(e.offset[0],e.offset[1]),"dds"===c){h&&h.mipmaps&&(1==(p=h.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(l=o=i.LinearFilter)),h.flipY=!0;break}"XMLV6"===e.format?t(h,e.texturePath+"/"+e.sourceFile):t(h,h.sourceFile),h&&(h.flipY=!0);break;case"url_envMap":var c,u,p;if("dds"===(c=/(?:\.([^.]+))?$/.exec(sourceFile.filename)[1])?h=i.ImageUtils.loadCompressedTextureFromBuffer(sourceFile.buffer):(u=document.createElement("canvas"),h=new i.Texture(u),"XMLV6"===e.format?h.sourceFile=sourceFile:h.sourceFile=window.URL.createObjectURL(sourceFile.buffer)),h.wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,e.offset&&h.offset.set(e.offset[0],e.offset[1]),"dds"===c){h&&h.mipmaps&&(1==(p=h.mipmaps)[p.length-1].height&&1==p[p.length-1].width||(h.minFilter=h.magFilter=i.LinearFilter)),h.flipY=!0;break}!function(e,t){var r;for(e.image=[],i.ImageUtils.nbTexturesBeingLoaded++,e.image.loadCount=0,r=0;r<6;++r)e.image[r]=new Image,e.image[r].onload=function(){if(e.image.loadCount+=1,6===e.image.loadCount){e.needsUpdate=!0,i.ImageUtils.nbTexturesBeingLoaded--;for(var t=0;t<e.onLoadCallbacks.length;t++)e.onLoadCallbacks[t](e)}},e.image[r].onerror=function(){e.image.loadCount+=1,6===e.image.loadCount&&i.ImageUtils.nbTexturesBeingLoaded--},e.image[r].crossOrigin="anonymous",e.image[r].src=t}(h,e.texturePath+"/"+sourceFile),h&&(h.flipY=!0);break;case"data":var f=!1,g=!1,m=e.resources.img,v=e.resources.format,_=!1;switch((e.filter[0]>1||e.filter[1]>1)&&(_=!0),s!=i.RepeatWrapping&&a!=i.RepeatWrapping||(_=!0),e.resources.imgType){case 1:var y=e.resources.width,S=e.resources.height;switch(v){case 0:v=i.LuminanceFormat;break;case 1:v=i.LuminanceAlphaFormat;break;case 2:v=i.RGBFormat;break;case 3:v=i.RGBAFormat,e.checkTransparency&&(f=n(m))}if((!i.ImageUtils.is_pow2(y)||!i.ImageUtils.is_pow2(S))&&_||y>this.maxTextureSize||S>this.maxTextureSize){var x=y,b=S;if(_&&(x=i.ImageUtils.nearest_pow2(y),b=i.ImageUtils.nearest_pow2(S)),x>this.maxTextureSize||b>this.maxTextureSize)for(;x>this.maxTextureSize||b>this.maxTextureSize;)x/=2,b/=2;v===i.RGBAFormat?m=r(m,y,S,x,b,4):v===i.RGBFormat?m=r(m,y,S,x,b,3):v===i.LuminanceFormat&&(m=r(m,y,S,x,b,1)),y=x,S=b}if(h=new i.DataTexture(m,y,S,v,void 0,void 0,s,a,o,l)){if(h.size=y,h.flipY=!1,f&&(h.transparent=!0),v==i.RGBFormat){var w=3*y;w%4&&(h.unpackAlignment=2,w%2&&(h.unpackAlignment=1))}v==i.LuminanceFormat&&(h.unpackAlignment=1)}h.needsUpdate=!0;break;case 2:var M=e.resources,C=0;switch(M.format){case 3:C=i.RGBAFormat;break;case 6:C=i.RGB_S3TC_DXT1_Format,g=!0;break;case 7:C=i.RGBA_S3TC_DXT1_Format,g=!0;break;case 8:C=i.RGBA_S3TC_DXT3_Format,g=!0;break;case 9:C=i.RGBA_S3TC_DXT5_Format,g=!0}g&&function(e,t,r,n,s){var a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P;function E(e){x=e[4],e[4]=e[7],e[7]=x,x=e[5],e[5]=e[6],e[6]=x}function T(e,t){var i;for(i=0;i<e.length;i++)e[i]=t[i]}switch(n){case i.RGB_S3TC_DXT1_Format:l=8,a=E,o=function(e){x=e[4],e[4]=e[5],e[5]=x};break;case i.RGBA_S3TC_DXT3_Format:l=16,a=function(e){x=e[0],e[0]=e[6],e[6]=x,x=e[1],e[1]=e[7],e[7]=x,x=e[2],e[2]=e[4],e[4]=x,x=e[3],e[3]=e[5],e[5]=x,E(e.subarray(8,16))},o=function(e){x=e[0],e[0]=e[2],e[2]=x,x=e[1],e[1]=e[3],e[3]=x,E(e.subarray(8,16))};break;case i.RGBA_S3TC_DXT5_Format:l=16,a=function(e){w=e[2]+256*(e[3]+256*e[4]),C=e[5]+256*(e[6]+256*e[7]),M=(4095&w)<<12|(16773120&w)>>12,P=(4095&C)<<12|(16773120&C)>>12,e[2]=255&P,e[3]=(65280&P)>>8,e[4]=(16711680&P)>>8,e[5]=255&M,e[6]=(65280&M)>>8,e[7]=(16711680&M)>>8,E(e.subarray(8,16))},o=function(e){w=e[2]+256*(e[3]+256*e[4]),M=(4095&w)<<12,e[2]=255&M,e[3]=(65280&M)>>8,e[4]=(16711680&M)>>8,E(e.subarray(8,16))};break;default:return console.error("flip dds error"),s}for(h=e,c=t,f=0;f<r&&(v=s[f].data,p=(d=Math.floor((h+3)/4))*(u=Math.floor((c+3)/4)),1!=c);++f){if(2==c)for(g=0;g<d;g++)o(v.subarray(m,g*l)),m=+l;else{for(m=0,g=1;g<=p;g++)a(v.subarray(m,g*l)),m+=l;b=l*d,S=new Uint8Array(b);for(var A=0;A<u/2;++A)_=v.subarray(A*b,(A+1)*b),y=v.subarray((u-A-1)*b,(u-A)*b),T(S,_),T(_,y),T(y,S)}(h/=2)<1&&(e=1),(c/=2)<1&&(t=1)}}(M.width,M.height,M.mipmapCount,C,M.mipmaps),(h=new i.CompressedTexture(M.mipmaps,M.width,M.height,C,void 0,new i.UVMapping,s,a,o,l)).flipY=!1,h.generateMipmaps=!1,h.needsUpdate=!0;break;case 3:var P=new Blob([m],{type:"image/png"}),E=URL.createObjectURL(P);return(h=i.ImageUtils.loadTexture(E,void 0,function(e){var t=e.image;if((h=e).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,h.needsUpdate=!0,h.transparentCb){var i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0,t.width,t.height);var r=i.getContext("2d").getImageData(0,0,t.width,t.height);h.transparent=n(r.data),h.transparent&&h.transparentCb(h.transparent)}},null,i.ImageUtils.crossOriginPolicy,_,null,null,this.maxTextureSize)).needToCheckTransparency=!!e.checkTransparency,h;case 4:var T=new Uint32Array(m.buffer);return(h=i.ImageUtils.loadCompressedTextureFromBuffer(T)).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l,h;case 5:(h=i.ImageUtils.loadBasisTexture(e.resources.img,null,null,null,null,i.BasisUsage[d[e.resources.format]])).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l;break;case 6:(h=i.ImageUtils.loadKTX2Texture(e.resources.img,null,null,null,null,i.BasisUsage[d[e.resources.format]])).wrapS=s,h.wrapT=a,h.magFilter=o,h.minFilter=l;break;default:h=null}break;default:h=null}return h},set3DXSharedGas:function(e,t){this.threeDXSharedGas.set(e,t)},get3DXSharedGas:function(e){return this.threeDXSharedGas.has(e)?this.threeDXSharedGas.get(e):null},getDashPatternArrayMaterial:function(e){var t,n,s;for(null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1),s=0;s<this.materials.length;s++)if("color"===(n=(t=this.materials[s]).params).type&&!(void 0!==e.pattern&&n.pattern!==e.pattern||n.color.r!==e.color.r||n.color.g!==e.color.g||n.color.b!==e.color.b||n.opacity!==e.opacity||void 0!==e.lineWidth&&n.lineWidth!==e.lineWidth))return t.threejs_mat;return void 0!==e.lineWidth?(n={type:"color",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},t=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(t.setDashPatternArray(e.pattern),t.setScale(1)):(t.setDashPatternType(e.pattern),t.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4)),this.materials.push({params:n,threejs_mat:t,hasTexture:!1}),t._source=i.AssetSource.MATERIAL_MANAGER,t):(console.warn("getMaterialFromGAS"),new i.LineBasicMaterial)},getMaterialFromGAS:function(e){if(this._currentMatHasTexture=!1,void 0!==e.pattern&&e.pattern instanceof Array)return this.getDashPatternArrayMaterial(e);var t=new r.GraphicAttributeSet(4278456352,-1,2),i=255,n=[255,255,255];void 0!==e.solid&&e.solid?t.setType(3):t.setType(2),void 0!==e.color&&null!==e.color&&(n[0]=255*e.color.r,n[1]=255*e.color.g,n[2]=255*e.color.b),void 0!==e.symbol&&(t._setConnectivity(0),t.setType(0),t.setSymbol(e.symbol),void 0!==e.size&&t.setPointSize(e.size)),void 0!==e.lineWidth&&(t._setConnectivity(1),t.setType(1),t.setLineThickness(e.lineWidth),void 0!==e.pattern&&t.setLineType(e.pattern)),e.basic&&t.setBasic(!0),void 0!==e.opacity&&(i=255*e.opacity);var s=n[0]<<24^n[1]<<16^n[2]<<8^i<<0;t.setRGBAColor(s);var a={};return e.depthPriority&&(a.depthPriority=e.depthPriority),e.originalMaterial&&(a.originalMaterial=e.originalMaterial),this._getMaterialFromGAS(t,a)},setCGRSharedMaterial:function(e,t){this.CGRSharedMaterials.set(e,t)},getCGRSharedMaterial:function(e,t){return this.CGRSharedMaterials.has(e)?t?this.CGRSharedMaterials.get(e).clone():this.CGRSharedMaterials.get(e):null},getMaterialFromGAS2:function(e){var t,n;this._currentMatHasTexture=!1,null==e.color&&(e.color=new i.Color),void 0===e.opacity&&(e.opacity=1);var s=!!i._GASFaceMaterialsAsPBR;for(n=0;n<this.materials.length;n++)if("color"===(t=(a=this.materials[n]).params).type&&(void 0===e.symbol||"point"===t.style)&&(void 0===e.lineWidth||"line"===t.style)&&(void 0!==e.lineWidth||void 0!==e.symbol||"fill"===t.style)&&(void 0===e.pattern||t.pattern===e.pattern)&&t.color.r===e.color.r&&t.color.g===e.color.g&&t.color.b===e.color.b&&t.opacity===e.opacity&&(void 0===e.lineWidth||t.lineWidth===e.lineWidth)&&(void 0===e.symbol||t.symbol===e.symbol)&&(void 0===e.size||t.size===e.size)&&(void 0===e.solid||t.solid===e.solid)&&(!e.basic||t.basic===e.basic)&&(!1!==t._pbr||!s)&&(!0!==t._pbr||s))return a.threejs_mat;if(void 0!==e.symbol){t={type:"color",style:"point",color:e.color,opacity:e.opacity,symbol:e.symbol,size:e.size};var a=this.createPointMaterial({symbol:e.symbol,color:e.color,opacity:e.opacity,resource:e.resource,size:e.size,_cgr:!0})}else if(void 0!==e.lineWidth)t={type:"color",style:"line",color:e.color,opacity:e.opacity,lineWidth:e.lineWidth,pattern:e.pattern},a=new i.LineBasicMaterial({color:e.color.getHex(),lineWidth:e.lineWidth,opacity:e.opacity,transparent:e.opacity<1}),e.pattern instanceof Array?(a.setDashPatternArray(e.pattern),a.setScale(1)):(a.setDashPatternType(e.pattern),a.setScale(e.pattern===r.LinePatternEnum.SMALLDOTTED?2:4));else if(e.basic){t={type:"color",style:"fill",color:e.color,opacity:e.opacity,basic:e.basic,solid:e.solid};var o={color:e.color.getHex(),side:1===e.solid?i.FrontSide:i.DoubleSide,opacity:e.opacity,transparent:e.opacity<1};a=new i.MeshBasicMaterial(o)}else{t={type:"color",style:"fill",color:e.color,opacity:e.opacity,solid:e.solid,_pbr:!1};o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,specular:16777215,shininess:76};if(a=new i.MeshPhongMaterial(o),s){var l=a;t._pbr=!0;var h=i.MaterialUtils.convertShininessToIoRRoughness(null);o={color:e.color.getHex(),opacity:e.opacity,transparent:e.opacity<1,side:1===e.solid?i.FrontSide:i.DoubleSide,ior:h.ior,specular:16777215,roughness:h.roughness},a=new i._GASPBRMaterial(o,l)}}return this.materials.push({params:t,threejs_mat:a,hasTexture:this._currentMatHasTexture}),a._source=i.AssetSource.MATERIAL_MANAGER,a},_getLineWidth:function(e){var t=e.getThickness();return t=t>c.length?1:c[t]},_gasAllowNMIR:function(e){return!(e.getLineType()>1||this._getLineWidth(e)>1)},_getNbGasMaterial:function(){var e=0;return this.gasMaterialsMap.forEach(function(t,i){t.forEach(function(t,i){t.forEach(function(t,i){e++})})}),this.gasSGOrederMaterialsMap.forEach(function(t,i){t.forEach(function(t,i){t.forEach(function(t,i){e++})})}),e},_getMaterialFromGAS:function(e,t){var n=this,s=function(e){var t=e.getDisplayedColor();return t[0]=t[0]/255,t[1]=t[1]/255,t[2]=t[2]/255,t[3]=t[3]/255,t},a=t&&t.depthPriority,o=t&&t.sceneGraphOrderMode||a?this.gasSGOrederMaterialsMap:this.gasMaterialsMap,l=null,h=null,c=null,d=null,u=!!i._GASFaceMaterialsAsPBR;e.setCacheValue();var p=e.getConnectivity(),f=e.isBasic(),g=e.getType(),m=e.isBlankingRep();if(p>1&&!f&&u&&e.setPBR(),o.has(e.set))if((l=o.get(e.set)).has(e.webOverride)){if((h=l.get(e.webOverride)).has(e.rgba)){if(!a)return h.get(e.rgba);if(t.originalMaterial&&t.originalMaterial.defines&&0==t.originalMaterial.defines.DEPTH_PRIORITY&&(t.originalMaterial.defines.DEPTH_PRIORITY=!0,t.originalMaterial.updatePDSFXUniform("depthPriority",t.depthPriority.depthPriority.value),t.originalMaterial.needsUpdate=!0),(c=h.get(e.rgba)).has(t.depthPriority.depthPriority.value))return c.get(t.depthPriority.depthPriority.value)}}else h=new Map,l.set(e.webOverride,h);else l=new Map,h=new Map,o.set(e.set,l),l.set(e.webOverride,h);switch(p){case 0:d=function(e,t){var r=s(e),a=(new i.Color).setRGB(r[0],r[1],r[2]),o=e.getSymbol(),l=e.getPointSize(),h=e.getVertexColor(),c=e.getType(),d=e.isNoZ(),u=(3==c?i.FrontSide:i.DoubleSide,n.createPointMaterial({symbol:o,color:a,opacity:r[3],size:l,_cgr:!0,isNoz:d,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0}));return h&&(u.vertexColors=i.VertexColorType.RGB),u}(e,t);break;case 1:d=function(e,t){var a=s(e);let o={lineWidth:1,color:(new i.Color).setRGB(a[0],a[1],a[2]).getHex(),opacity:a[3],transparent:a[3]<1,linecap:"butt",_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0};if(n.hasLineTypes()){const t=e.getLineType(),r=e.getLineThicknessID();let s=n._createLineTypeMaterial(r,t,1,o);return s||new i.LineBasicMaterial(o)}{const t=e.getLineType(),n=e.getLineThickness();o.lineWidth=n;let s=new i.LineBasicMaterial(o);return s.setDashPatternType(t),s.setScale(t===r.LinePatternEnum.SMALLDOTTED?2:4),s}}(e,t);break;case 2:case 3:d=m?this.getBlankingRepMaterial():f||g<2?function(e,t){var r=s(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),a=3==e.getType()?i.FrontSide:i.DoubleSide,o={color:n.getHex(),side:a,opacity:r[3],transparent:r[3]<1,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0};return d=new i.MeshBasicMaterial(o)}(e,t):function(e,t){var r=s(e),n=(new i.Color).setRGB(r[0],r[1],r[2]),a=3==e.getType()?i.FrontSide:i.DoubleSide,o=e.isPBR(),l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:a,specular:16777215,shininess:76,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},h=new i.MeshPhongMaterial(l);if(o){var c=h,d=i.MaterialUtils.convertShininessToIoRRoughness(null);l={color:n.getHex(),opacity:r[3],transparent:r[3]<1,side:a,specular:16777215,ior:d.ior,roughness:d.roughness,_sceneGraphOrderMode:t&&t.sceneGraphOrderMode?t.sceneGraphOrderMode:0},h=new i._GASPBRMaterial(l,c)}return h}(e,t)}return a?c?c.set(t.depthPriority.depthPriority.value,d):((c=new Map).set(t.depthPriority.depthPriority.value,d),h.set(e.rgba,c)):h.set(e.rgba,d),d._source=i.AssetSource.MATERIAL_MANAGER,e.isBackgroundColor()&&(d.color=this.backgroundColor,this.backgroundColorMaterials.push(d)),e.isForegroundColor()&&(d.color=this.foregroundColor,this.foregroundColorMaterials.push(d)),t&&t.depthPriority&&(this._setPDSFXDepthPriority(d,t.depthPriority.depthPriority.value,!0),t.originalMaterial&&t.originalMaterial.defines&&0==t.originalMaterial.defines.DEPTH_PRIORITY&&(t.originalMaterial.defines.DEPTH_PRIORITY=!0,t.originalMaterial.updatePDSFXUniform("depthPriority",t.depthPriority.depthPriority.value),t.originalMaterial.needsUpdate=!0)),t&&2==t.sceneGraphOrderMode&&function(e){e.activatePDSFX();e.setPDSFXVaryings({depthSGOrder:{type:"f"}});var t={ComputeVaryingValues:["void ComputeVaryingValues() {","depthSGOrder = vGetAttribPosition().z;","}"].join("\n"),ComputeObjectPosition:["vec3 ComputeObjectPosition() {","return vec3(vGetAttribPosition().xy,0.0);","}"].join("\n"),ComputeObjectFollowingPosition:["vec3 ComputeObjectFollowingPosition() {","return vec3(vGetAttribFollowingPosition().xy,0.0);","}"].join("\n"),ComputeObjectPreviousPosition:["vec3 ComputeObjectPreviousPosition() {","return vec3(vGetAttribPreviousPosition().xy,0.0);","}"].join("\n")},i={ComputeCommonValues:["void ComputeCommonValues() {","vSetFragDepth((16777216.0 -depthSGOrder)/16777216.0);","}"].join("\n")};e.setPDSFXOverridableFunctions(t,i)}(d),d._isFromGAS=!0,d},_setPDSFXDepthPriority:function(e,t,i){e.activatePDSFX();var r={depthPriority:{type:"f",value:t}};e.setPDSFXUniforms(r);var n={ComputeCommonValues:["void ComputeCommonValues() {","#ifdef DEPTH_PRIORITY","vSetFragDepth((16777000.0 -depthPriority)/16777216.0);","#endif","}"].join("\n")};e.setPDSFXOverridableFunctions({},n),e.defines||(e.defines={}),e.defines.DEPTH_PRIORITY=!!i},recompileShaders:function(){for(var e=0;e<this.materials.length;e++){var t=this.materials[e];t&&t.threejs_mat&&t.threejs_mat.recompileShaders(!1)}}});return UWA.namespace("THREEDS/MaterialManager",v)}),define("Visualization/MaterialManager",["DS/Visualization/MaterialManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/MaterialManager"),e}),define("DS/Visualization/GraphicAttributeSet",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/CoreEvents/Events"],function(e,t,i,r){"use strict";e.GASEnum={NO_INHERIT:0,RESET_INHERITANCE:0,HIGHLIGHT_INHERITANCE_ON:1,HIGHLIGHT_INHERITANCE_OFF:2,COLOR_INHERITANCE_ON:4,COLOR_INHERITANCE_OFF:8,LINEWIDTH_INHERITANCE_ON:16,LINEWIDTH_INHERITANCE_OFF:32,LINETYPE_INHERITANCE_ON:64,LINETYPE_INHERITANCE_OFF:128,BACKGROUND3DVIEWMODE_ON:256,BACKGROUND3DVIEWMODE_OFF:512,ASMCOLOR_INHERITANCE_ON:1024,ASMCOLOR_INHERITANCE_OFF:2048,ALPHA_INHERITANCE_ON:4096,ALPHA_INHERITANCE_OFF:8192,DEFAULTLOOK_INHERITANCE_ON:16384,DEFAULTLOOK_INHERITANCE_OFF:32768,TOP_PRIORITY_ON:65536,TOP_PRIORITY_OFF:1<<17,_2DMODE_INHERITANCE_ON:1<<18,_2DMODE_INHERITANCE_OFF:1<<19};const n=e.GASEnum;e.GASEnumCustom={TRANSITION:1,_FORCE_EDGE_OPACITY:2,_TYPE_FROM_PARENT:8,_COLOR_INDEX_WITH_OPACITY:16};const s=e.GASEnumCustom;n.COLOR_INHERIT=n.COLOR_INHERITANCE_ON,n.ALPHA_INHERIT=n.ALPHA_INHERITANCE_ON,n.LINEWIDTH_INHERIT=n.LINEWIDTH_INHERITANCE_ON,n.LINETYPE_INHERIT=n.LINETYPE_INHERITANCE_ON,n.ASMCOLOR_INHERIT=n.ASMCOLOR_INHERITANCE_ON,n.RGBA_INHERITANCE_ON=n.COLOR_INHERITANCE_ON|n.ALPHA_INHERITANCE_ON,n.RGBA_INHERIT=n.RGBA_INHERITANCE_ON,n.RGBA_INHERITANCE_OFF=n.COLOR_INHERITANCE_OFF|n.ALPHA_INHERITANCE_OFF,e.GASTypeEnum={NOZ:0,EDGE:1,SKIN:2,VOLUME:3,_SKIN:255};const a=e.GASTypeEnum;e.COLORMAP_INDEX={EDGE_HIGHLIGHT:239,UPDATENEEDED:240,HANDLECOLOR:241,CYAN:242,MAGENTA:243,YELLOW:244,BLUE:245,GREEN:246,RED:247,WHITE:248,BLACK:249,PREHIGHLIGHT:250,HIGHLIGHT:251,LOWLIGHT:252,FOREGROUND:253,BACKGROUND:254,TRUECOLOR:255};const o=e.COLORMAP_INDEX,l=new e.Color(0);new e.Color(16448250);var h=[0,0,0,.25999999046325684,.4000000059604645,.33000001311302185,1,.46000000834465027,0,1,1,1,1,0,0,0,1,0,0,.4000000059604645,1,.8600000143051147,.8600000143051147,0,.05999999865889549,.05999999865889549,.05999999865889549,.12999999523162842,.12999999523162842,.12999999523162842,.20000000298023224,.20000000298023224,.20000000298023224,.25999999046325684,.25999999046325684,.25999999046325684,.33000001311302185,.25999999046325684,.25999999046325684,.4000000059604645,.4000000059604645,.4000000059604645,.46000000834465027,.46000000834465027,.46000000834465027,.5299999713897705,.5299999713897705,.5299999713897705,.6000000238418579,.6000000238418579,.6000000238418579,.6600000262260437,.6600000262260437,.6600000262260437,.7300000190734863,.7300000190734863,.7300000190734863,.800000011920929,.800000011920929,.800000011920929,.8600000143051147,.8600000143051147,.8600000143051147,.9300000071525574,.9300000071525574,.9300000071525574,1,1,1,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,0,0,0,.05999999865889549,0,0,.12999999523162842,0,0,.20000000298023224,0,0,.25999999046325684,0,0,.25999999046325684,0,0,.4000000059604645,0,0,.46000000834465027,0,0,.5299999713897705,0,0,.6000000238418579,0,0,.6600000262260437,0,0,.7300000190734863,0,0,.800000011920929,0,0,.8600000143051147,0,0,.9300000071525574,0,0,1,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,0,.05999999865889549,0,.05999999865889549,.12999999523162842,0,.12999999523162842,.20000000298023224,0,.20000000298023224,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.4000000059604645,0,.4000000059604645,.46000000834465027,0,.46000000834465027,.5299999713897705,0,.5299999713897705,.6000000238418579,0,.6000000238418579,.6600000262260437,0,.6600000262260437,.7300000190734863,0,.7300000190734863,.800000011920929,0,.800000011920929,.8600000143051147,0,.8600000143051147,.9300000071525574,0,.9300000071525574,1,0,1,0,.05999999865889549,.05999999865889549,0,.12999999523162842,.12999999523162842,0,.20000000298023224,.20000000298023224,0,.25999999046325684,.25999999046325684,0,.25999999046325684,.25999999046325684,0,.4000000059604645,.4000000059604645,0,.46000000834465027,.46000000834465027,0,.5299999713897705,.5299999713897705,0,.6000000238418579,.6000000238418579,0,.6600000262260437,.6600000262260437,0,.7300000190734863,.7300000190734863,0,.800000011920929,.800000011920929,0,.8600000143051147,.8600000143051147,0,.9300000071525574,.9300000071525574,0,1,1,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.05999999865889549,.5,.5,.12999999523162842,.5,.5,.20000000298023224,.5,.5,.25999999046325684,.5,.5,.33000001311302185,.5,.5,.4000000059604645,.5,.5,.46000000834465027,.5,.5,.5299999713897705,.5,.5,.6000000238418579,.5,.5,.6600000262260437,.5,.5,.7300000190734863,.5,.5,.800000011920929,.5,.5,.8600000143051147,.5,.5,.9300000071525574,.5,.5,1,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,1,0,0,1,0,0,0,1,0,0,.8999999761581421,.8999999761581421,.8999999761581421,0,.8999999761581421,.8600000143051147,.8600000143051147,0,0,.4000000059604645,1,0,1,0,1,0,0,1,1,1,0,0,0,.8235294818878174,.8235294818878174,1,0,.7843137383460999,.7843137383460999,.26274511218070984,.4000000059604645,.3333333432674408,1,1,1,.2352941334247589,.40000003576278687,.501960813999176,0,0,0];const c=new Map;e._getColorMap=function(t){if(c.has(t))return c.get(t);for(var i=new Array(256),r=0;r<i.length;r++){var n=h[3*r],s=h[3*r+1],a=h[3*r+2];i[r]=(new e.Color).setRGB(n,s,a)}return i[o.FOREGROUND]=(new e.Color).setRGB(0,0,0),i[o.HIGHLIGHT]=(new e.Color).setRGB(0,.784313738,.784313738),i[o.LOWLIGHT]=(new e.Color).setRGB(.262745112,.400000006,.333333343),i[o.BACKGROUND]=(new e.Color).setRGB(.92549026,.92549026,.92549026),c.set(t,i),i};const d=e._getColorMap;r.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE"},function(e){var t=e.parameters,i=t.viewer.renderer.renderer,n=d(i);if(!(t.slot<0||t.slot>255)){if(t.slot>=0)n[t.slot]=t.color;else for(var s=0;s<t.colorMap.length;s++)n[s]=t.colorMap[s];r.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE",eventType:"@AFTER_COLOR_MAP_UPDATE",parameters:{viewer:t.viewer}}})}}),r.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer.renderer.renderer;c.delete(t)});var u=[1,2,3,4,5,6,7,8,9],p=[9,9,9,9,5,7,9,3,2],f=new Float64Array(1),g=new Uint8Array(f.buffer),m=new Uint32Array(f.buffer),v=function(e){this._attr=0,this._rgba=0,this._inheritanceInternal=0,this._color=null,this._colorSet=!1,this._colorIndex=o.TRUECOLOR,this._alpha=1,this._lineWidth=1,this._lineType=i.LinePatternEnum.SOLID,this._symbolType=i.PointSymbolEnum.UNKNOWN,this._basic=!1,this._lowlight=!1,this._highlight=!1,this._show=!0,this._showFree=!1,this._noPick=!1,this._transparent=!0,this._inheritance=n.RGBA_INHERITANCE_ON,this._type=a._SKIN,this._priority=4,e&&e.NREInit&&(this._type=a.NOZ,this._transparent=!1,this._inheritance=n.NO_INHERIT,this._colorIndex=o.FOREGROUND,this._lineWidth=0,this._color=l),e&&this.setParameters(e)};Object.defineProperty(v.prototype,"_colorIndex",{get:function(){return f[0]=this._attr,g[0]},set:function(e){f[0]=this._attr,g[0]=e,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_lineWidth",{get:function(){return f[0]=this._attr,g[1]},set:function(e){f[0]=this._attr,g[1]=e,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_lineType",{get:function(){return f[0]=this._attr,g[2]},set:function(e){f[0]=this._attr,g[2]=e,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_basic",{get:function(){return f[0]=this._attr,(1&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=1:g[3]&=-2,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_lowlight",{get:function(){return f[0]=this._attr,(2&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=2:g[3]&=-3,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_highlight",{get:function(){return f[0]=this._attr,(4&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=4:g[3]&=-5,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_noPick",{get:function(){return f[0]=this._attr,(8&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=8:g[3]&=-9,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_show",{get:function(){return f[0]=this._attr,(16&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=16:g[3]&=-17,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_showFree",{get:function(){return f[0]=this._attr,(32&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=32:g[3]&=-33,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_transparent",{get:function(){return f[0]=this._attr,(64&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=64:g[3]&=-65,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_colorSet",{get:function(){return f[0]=this._attr,(128&g[3])>0},set:function(e){f[0]=this._attr,e?g[3]|=128:g[3]&=-129,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_type",{get:function(){return f[0]=this._attr,g[4]},set:function(e){f[0]=this._attr,g[4]=e,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_priority",{get:function(){return f[0]=this._attr,g[5]},set:function(e){f[0]=this._attr,g[5]=e,this._attr=f[0]}}),Object.defineProperty(v.prototype,"_symbolType",{get:function(){return f[0]=this._attr,g[6]},set:function(e){f[0]=this._attr,g[6]=e,this._attr=f[0]}});var _=new e.Color;Object.defineProperty(v.prototype,"_color",{get:function(){return this._colorSet?(f[0]=this._rgba,_.setRGB(g[0]/255,g[1]/255,g[2]/255),_):null},set:function(e){this._colorSet=!!e,f[0]=this._rgba,g[0]=e?255*e.r:0,g[1]=e?255*e.g:0,g[2]=e?255*e.b:0,this._rgba=f[0]}}),Object.defineProperty(v.prototype,"_alpha",{get:function(){return f[0]=this._rgba,g[3]/255},set:function(e){f[0]=this._rgba,g[3]=255*e,this._rgba=f[0]}}),Object.defineProperty(v.prototype,"_inheritance",{get:function(){return f[0]=this._inheritanceInternal,m[0]},set:function(e){f[0]=this._inheritanceInternal,m[0]=e,this._inheritanceInternal=f[0]}}),Object.defineProperty(v.prototype,"_inheritanceCustom",{get:function(){return f[0]=this._inheritanceInternal,m[1]},set:function(e){f[0]=this._inheritanceInternal,m[1]=e,this._inheritanceInternal=f[0]}}),Object.defineProperty(v.prototype,"side",{get:function(){return this._type===a.VOLUME?e.FrontSide:e.DoubleSide},set:function(t){this._type=t===e.FrontSide?a.VOLUME:a._SKIN}}),v._createFromGASAttributes=function(t){var i={colorRGB:t.color,colorA:t.opacity,side:1===t.solid?e.FrontSide:e.DoubleSide,inheritance:n.RGBA_INHERITANCE_ON,inheritanceCustom:0};return t.lineWidth&&(i.lineWidth=t.lineWidth,i.inheritance|=n.LINEWIDTH_INHERITANCE_ON),t.linewidth&&(i.lineWidth=t.linewidth,i.inheritance|=n.LINEWIDTH_INHERITANCE_ON),t.pattern&&(i.lineType=t.pattern,i.inheritance|=n.LINETYPE_INHERITANCE_ON),void 0!==t.symbol&&(i.symbolType=t.symbol),new v(i)},v.prototype.isGAS=!0,v.prototype.setParameters=function(e){return void 0!==e.colorRGB&&(this._color=e.colorRGB),void 0!==e.colorIndex&&(this._colorIndex=e.colorIndex),void 0!==e.colorA&&(this._alpha=e.colorA),void 0!==e.lineWidth&&(this._lineWidth=e.lineWidth),void 0!==e.lineType&&(this._lineType=e.lineType),void 0!==e.symbolType&&(this._symbolType=e.symbolType),void 0!==e.side&&(this.side=e.side),void 0!==e.inheritance&&(this._inheritance=e.inheritance),void 0!==e.inheritanceCustom&&(this._inheritanceCustom=e.inheritanceCustom),void 0!==e.lowlight&&(this._lowlight=e.lowlight),void 0!==e.highlight&&(this._highlight=e.highlight),void 0!==e.noPick&&(this._noPick=e.noPick),void 0!==e.show&&(this._show=e.show),void 0!==e.showFree&&(this._showFree=e.showFree),void 0!==e.transparent&&(this._transparent=e.transparent),void 0!==e.type&&(this._type=e.type),void 0!==e.basic&&(this._basic=e.basic),void 0!==e.priority&&(this._priority=e.priority),this},v.prototype.merge=function(e,t){var r=!!t&&t.canBeUsed(),a=this;function o(){(t.getInheritance()&n.COLOR_INHERITANCE_ON)>0?(a._color=e._color,a._colorIndex=e._colorIndex,a._inheritance|=n.COLOR_INHERITANCE_ON,e._doesInherit(n.COLOR_INHERITANCE_ON)||(a._color=t._GAS._color,a._colorIndex=t._GAS._colorIndex)):(t.getInheritance()&n.ASMCOLOR_INHERITANCE_ON)>0&&(a._color=e._color,a._colorIndex=e._colorIndex,a._inheritance|=n.ASMCOLOR_INHERITANCE_ON,e._doesInherit(n.ASMCOLOR_INHERITANCE_ON)||(a._color=t._asmGAS._color,a._colorIndex=t._asmGAS._colorIndex))}var l=this._symbolType!==i.PointSymbolEnum.UNKNOWN?this._symbolType:e._symbolType;return this._doesInheritCustom(s.TRANSITION)?(this.copy(e),r&&(this._inheritance&=~n.COLOR_INHERITANCE_ON,this._inheritance&=~n.ASMCOLOR_INHERITANCE_ON,o())):(r?o():(e._doesInherit(n.COLOR_INHERITANCE_ON)&&(this._color=e._color,this._colorIndex=e._colorIndex,this._inheritance|=n.COLOR_INHERITANCE_ON),e._doesInherit(n.ASMCOLOR_INHERITANCE_ON)&&(this._color=e._color,this._colorIndex=e._colorIndex,this._inheritance|=n.ASMCOLOR_INHERITANCE_ON)),e._doesInherit(n.ALPHA_INHERITANCE_ON)&&(this._alpha=e._alpha,this._transparent=e._transparent,this._inheritance|=n.ALPHA_INHERITANCE_ON),e._doesInherit(n.LINEWIDTH_INHERITANCE_ON)&&(this._lineWidth=e._lineWidth,this._inheritance|=n.LINEWIDTH_INHERITANCE_ON),e._doesInherit(n.LINETYPE_INHERITANCE_ON)&&(this._lineType=e._lineType,this._inheritance|=n.LINETYPE_INHERITANCE_ON),e._doesInherit(n.DEFAULTLOOK_INHERITANCE_ON)&&(this._inheritance|=n.DEFAULTLOOK_INHERITANCE_ON),e._doesInheritCustom(s._FORCE_EDGE_OPACITY)&&(this._inheritanceCustom|=s._FORCE_EDGE_OPACITY),this._doesInheritCustom(s._TYPE_FROM_PARENT)&&(this._inheritanceCustom|=s._TYPE_FROM_PARENT,this._type=e._type,this._priority=e._priority),this._doesInheritCustom(s._COLOR_INDEX_WITH_OPACITY)&&(this._inheritanceCustom|=s._COLOR_INDEX_WITH_OPACITY),this._lowlight=this._lowlight||e._lowlight,this._highlight=this._highlight||e._highlight),this._symbolType=l,this},v.prototype.copy=function(e){this._inheritanceInternal=e._inheritanceInternal,this._rgba=e._rgba,this._attr=e._attr};var y=e.__visibleInCurrentSpaceSimple;return v.prototype.visibleInCurrentSpace=function(e,t){return y(e.visible&&this._show,e.visibilityFree||this._showFree,t,null)},v.prototype.clone=function(){var e=new v;return e.copy(this),e},v.prototype._dump=function(){var e=this.getJSON();return e.type="StructGAS",e},v.prototype.getPointSize=function(){if(this._symbolType===i.PointSymbolEnum.UNKNOWN)return 1;var t=this._symbolType;return Math.round(p[t]*(e.getDevicePixelRatio()||1))},v.prototype.getLinetype=function(){return this._lineType},v.prototype.getLineThicknessID=function(){return this._lineWidth},v.prototype.getLineThickness=function(){let e=this.getLineThicknessID();var r=new t,n=r.hasLineTypes()?r.lineTypes.widths.map(e=>e.pixelRadius):i.ThicknessTable;return e>n.length?1:n[e]},v.prototype.getMaterial=function(r,h,c,p,f,g){var m=new t,v={},_=r&&r.isGAS,y=_&&r._symbolType!==i.PointSymbolEnum.UNKNOWN?r._symbolType:this._symbolType;if(_&&r._doesInheritCustom(s.TRANSITION)&&(r=this,_=!0),v.opacity=1,this._doesInherit(n.ALPHA_INHERITANCE_ON)?v.opacity=this._transparent?this._alpha:1:r&&(v.opacity=_?r._transparent?r._alpha:1:r.opacity),this._doesInherit(n.COLOR_INHERITANCE_ON|n.ASMCOLOR_INHERITANCE_ON)?(v.color=this._color,this._colorIndex!==o.TRUECOLOR&&(v.color=d(p)[this._colorIndex],this._doesInheritCustom(s._COLOR_INDEX_WITH_OPACITY)||(v.opacity=1))):r&&(v.color=_?r._color:r.color,_&&r._colorIndex!==o.TRUECOLOR&&(v.color=d(p)[r._colorIndex],r._doesInheritCustom(s._COLOR_INDEX_WITH_OPACITY)||(v.opacity=1))),r?_||"Basic"!==r.getType()?_&&(v.basic=r._basic):(v.basic=!0,0===r.opacity&&(v.opacity=0)):v.basic=this._basic,c&&c._basic&&(v.basic=!0),h>1)if(r)if(_){var S=r._doesInheritCustom(s._TYPE_FROM_PARENT)?this._type:r._type;v.solid=S===a.VOLUME?1:0,S===a.NOZ&&(v.basic=!0)}else v.solid=r.side===e.FrontSide?1:0;else v.solid=this._type===a.VOLUME?1:0,this._type===a.NOZ&&(v.basic=!0);if(1===h&&(v.lineWidth=1,this._doesInheritCustom(s._FORCE_EDGE_OPACITY)||(v.opacity=1),this._doesInherit(n.ASMCOLOR_INHERITANCE_ON)&&(v.color=l),this._doesInherit(n.LINEWIDTH_INHERITANCE_ON)?v.lineWidth=this._lineWidth:r&&(v.lineWidth=_?r._lineWidth:r.lineWidth),v.lineWidth||(v.lineWidth=1),this._doesInherit(n.LINETYPE_INHERITANCE_ON)?v.pattern=this._lineType:r&&(v.pattern=_?r._lineType:r.dashPattern),v.pattern||(v.pattern=i.LinePatternEnum.SOLID)),0===h){var x=y!==i.PointSymbolEnum.UNKNOWN?y:i.PointSymbolEnum.DOT;v.symbol=u[x]}return(this._highlight||_&&r._highlight)&&(v.color=d(p)[o.HIGHLIGHT],v.opacity=1),(this._lowlight||_&&r._lowlight)&&(v.color=d(p)[o.LOWLIGHT],v.opacity=1),f&&(v.depthPriority=f),g&&(v.originalMaterial=g),m.getMaterialFromGAS(v)},v.prototype.hasASMInherit=function(){return(this._inheritance&n.ASMCOLOR_INHERITANCE_ON)>0},v.prototype._doesInherit=function(e){return(this._inheritance&e)>0},v.prototype._doesInheritCustom=function(e){return(this._inheritanceCustom&e)>0},v.prototype.__updateGAS=function(e){return e&&e.isGAS?(e.copy(this),e):this.__getGAS(e).clone()},v.prototype.__getGAS=function(e){return this},v.prototype._isEqual=function(e){return!!e&&(e._attr===this._attr&&e._rgba===this._rgba&&e._inheritanceInternal===this._inheritanceInternal)},v.prototype.getJSON=function(){return{attr:this._attr,rgba:this._rgba}},(v.IncrementalGraphicAttributeSet=function(e){e=e||{},this.NREInit=!1,this.colorRGB=e.colorRGB,this.colorIndex=e.colorIndex,this.colorA=e.colorA,this.lineWidth=e.lineWidth,this.lineType=e.lineType,this.symbolType=e.symbolType,this.inheritance=e.inheritance,this.inheritanceCustom=e.inheritanceCustom,this.lowlight=e.lowlight,this.highlight=e.highlight,this.noPick=e.noPick,this.type=e.type,this.basic=e.basic,this.priority=e.priority,this.show=e.show,this.showFree=e.showFree,this.transparent=e.transparent}).prototype.usingNREInit=function(e){return this.NREInit=!!e,this},v.IncrementalGraphicAttributeSet.prototype.__getGAS=function(e){var t;return e&&e.isGAS?(t=e.clone()).setParameters(this):t=new v(this),t},v.IncrementalGraphicAttributeSet.prototype.__updateGAS=function(e){return e&&e.isGAS?(e.setParameters(this),e):this.__getGAS(e)},v.getLowLightColor=function(e){return d(e)[o.LOWLIGHT]},v.DefaultGASs={volume:new v({NREInit:!0,type:a.VOLUME}),skin:new v({NREInit:!0,type:a.SKIN}),edge:new v({NREInit:!0,type:a.EDGE}),defaultGAS:new v({NREInit:!0}),transition:new v({inheritanceCustom:s.TRANSITION})},e.GraphicAttributeSet=v,v}),define("DS/Visualization/Filters/GASInheritFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter","DS/Visualization/GraphicAttributeSet"],function(e,t,i){"use strict";var r=i.DefaultGASs.defaultGAS;return class extends t{constructor(){super(),this._inheritance=e.GASEnum.NO_INHERIT,this._GAS=r,this._asmGAS=r}usingColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.COLOR_INHERITANCE_ON:e.GASEnum.COLOR_INHERITANCE_OFF),this._GAS=t||r,this}usingASMColorInherit(t,i){return null!==i&&(this._inheritance|=i?e.GASEnum.ASMCOLOR_INHERITANCE_ON:e.GASEnum.ASMCOLOR_INHERITANCE_OFF),this._asmGAS=t||r,this}getInheritance(){return this._inheritance}canBeUsed(){return this._inheritance!==e.GASEnum.NO_INHERIT}solveInherit(e,t,i){return null}}}),define("DS/Visualization/RenderMode",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){this._mask=0,this._maskWithDefault=0,this._replaceMask=-1,this._setFromMasks(0,0,t.GeomTypeEnum.FACE),this._useRenderLineMask=!0,this._useRenderFaceMask=!0,this._useRenderPointMask=!0,this._repViewNothing=!1,this._halfVisibleSmoothEdges=-1,this._hiddenEdges=-1,this._outlineWidth=1,e&&void 0!==e.renderLineMode&&this._setRenderLineMode(e.renderLineMode)},clone:function(){var e=new i;return e._mask=this._mask,e._maskWithDefault=this._maskWithDefault,e._replaceMask=this._replaceMask,e._useRenderLineMask=this._useRenderLineMask,e._useRenderPointMask=this._useRenderPointMask,e._useRenderFaceMask=this._useRenderFaceMask,e._outlineWidth=this._outlineWidth,e._halfVisibleSmoothEdges=this._halfVisibleSmoothEdges,e._hiddenEdges=this._hiddenEdges,e._repViewNothing=this._repViewNothing,e},combine:function(e){e&&(this._mask=e._mask)},setOutlineWidth:function(e){this._outlineWidth=e},setHalfVisibleSmoothEdges:function(e){this._halfVisibleSmoothEdges=e},setHiddenEdges:function(e){this._hiddenEdges=e},setRenderMode:function(e,i){if("@InternalEdge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i),this.setRenderMode("_HighCurvatureEdge",i);else if("@Edge"===e)this.setRenderMode("InternalSharpEdge",i),this.setRenderMode("InternalSmoothEdge",i),this.setRenderMode("_HighCurvatureEdge",i),this.setRenderMode("BoundaryEdge",i),this.setRenderMode("WireEdge",i),this.setRenderMode("Edge",i);else if("@Point"===e)this.setRenderMode("BoundaryPoint",i),this.setRenderMode("SharpPoint",i),this.setRenderMode("SmoothPoint",i),this.setRenderMode("SurfacicPoint",i),this.setRenderMode("FreePoint",i);else{var r={Edge:"EDGE",InternalSharpEdge:"SHARP_EDGE",InternalSmoothEdge:"SMOOTH_EDGE",BoundaryEdge:"BOUNDARY_EDGE",_HighCurvatureEdge:"_HIGH_CURVATURE_EDGE",WireEdge:"WIRE_EDGE",Outline:"_OUTLINE",SectionLine:"_SECTION_LINE",Face:"FACE",BoundaryPoint:"BOUNDARY_POINT",SharpPoint:"SHARP_POINT",SurfacicPoint:"SURFACIC_POINT",SmoothPoint:"SMOOTH_POINT",FreePoint:"FREE_POINT",AxisSystem:"AXIS_SYSTEM",InfiniteFace:"INFINITE_FACE"}[e];if(r){var n,s,a=t.GeomTypeEnum[r];n=this._mask||0,s=i?n|a:n&~a,this._setMask(s)}else console.warn(e+"unknown category")}},setRepViewNothing:function(e){this._repViewNothing=e},_setRenderLineMode:function(e){e=e||0;var t,r=this._mask,n=i.linesMask;t=e&n|(r&=~n),this._setMask(t)},_setFromMasks:function(e,t,i){this._setMask(e&r|t&n|i&a)},getMask:function(){return this._mask},getMasks:function(){return[this._mask&a,this._mask&n,this._mask&r]},areFacesVisible:function(){return!!(this._mask&t.GeomTypeEnum.FACE)},_displayNothing:function(){this._setMask(0)},_setMask:function(e){this._mask=e,this._maskWithDefault=e|i.defaultMask},setReplaceMask:function(e){this._replaceMask=e},_hasReplaceMask:function(){return-1!==this._replaceMask},_setReplace:function(e,t){var i,r,n;i=t.getMask(),r=e.getMask(),n=t._replaceMask,this._setMask(r&~n|i&n),this._replaceMask=e._replaceMask|n}});i.createChild=function(e,t){var i=null;return(e||t)&&(e?(i=e.clone()).combine(t):i=t),i},i.defaultMask=t.GeomTypeEnum.UNKNOWN|t.GeomTypeEnum.UNKNOWN_1D|t.GeomTypeEnum.UNKNOWN_2D;var r=t.GeomTypeEnum.BOUNDARY_POINT|t.GeomTypeEnum.SHARP_POINT|t.GeomTypeEnum.SMOOTH_POINT|t.GeomTypeEnum.SURFACIC_POINT|t.GeomTypeEnum.FREE_POINT|t.GeomTypeEnum.HIDDEN_SEAM_POINT;i.pointsMask=r;var n=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE|t.GeomTypeEnum._OUTLINE|t.GeomTypeEnum._SECTION_LINE;i.linesMask=n;var s=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.WIRE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE|t.GeomTypeEnum.HIDDEN_SEAM_EDGE;i.linesPickingMask=s;var a=t.GeomTypeEnum.INFINITE_FACE|t.GeomTypeEnum.FACE|t.GeomTypeEnum.AXIS_SYSTEM;return i.facesMask=a,i.unknownMask=t.GeomTypeEnum.UNKNOWN|t.GeomTypeEnum.UNKNOWN_1D|t.GeomTypeEnum.UNKNOWN_2D|t.GeomTypeEnum.UNKNOWN_0D,t.RenderMode=i,i}),define("DS/Visualization/WorldOrientation",["DS/Visualization/ThreeJS_DS","DS/Visualization/JSONSettings"],function(e,t){var i=function(i){this._woName=i.name,this.upVector=i.upVector,this.rightVector=i.rightVector,this.frontVector=(new e.Vector3).crossVectors(this.rightVector,this.upVector),this.fromZUpMatrix=i.fromZUpMatrix,this.upAttribute=i.upAttribute,this.rightAttribute=i.rightAttribute,this.frontAttribute=i.frontAttribute,this._anglesOrderForLockedRotation=i.anglesOrderForLockedRotation,this._eulerOrderForReframe=i.eulerOrderForReframe,this._defaultViewsSettings=t.getDefaultViewSettings()};return i.prototype.getOrientationForLockedRotation=function(t,i,r){var n=this.upAttribute,s=this.rightAttribute,a=this.frontAttribute,o=this._anglesOrderForLockedRotation,l=(new e.Matrix4).makeRotationFromQuaternion(r),h=(new e.Vector3).setEulerFromRotationMatrix(l,o);return h[n]-=t,"y"===n?(h[s]-=i,h[a]=0):"z"===n&&(h[a]-=i,h[s]=0),(new e.Quaternion).setFromEuler(h,o)},i.prototype.getAxisForSideRotation=function(t){var i=new e.Vector3,r=this._eulerOrderForReframe;if("ZXY"!==r&&"YZX"!==r)throw"Unsupported euler order";return"right"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,Math.PI):"YZX"===r&&(i=new e.Vector3(0,.5*Math.PI,0)):"left"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,0):"YZX"===r&&(i=new e.Vector3(0,-.5*Math.PI,0)):"top"===t?"ZXY"===r?i=new e.Vector3(0,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(-.5*Math.PI,0,0)):"bottom"===t?"ZXY"===r?i=new e.Vector3(Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(.5*Math.PI,0,0)):"front"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,0,0)):"back"===t?"ZXY"===r?i=new e.Vector3(.5*Math.PI,0,-.5*Math.PI):"YZX"===r&&(i=new e.Vector3(0,-Math.PI,0)):"iso"===t&&("ZXY"===r?i=new e.Vector3(.35*Math.PI,0,.75*Math.PI):"YZX"===r&&(i=new e.Vector3(-.15*Math.PI,.25*Math.PI,0))),i},i.prototype.getMatrixForSideRotation=function(t){var i=new e.Vector3,r=new e.Vector3,n=new e.Vector3(0,0,1),s=new e.Matrix4,a=new e.Vector3(0,0,0),o=this._eulerOrderForReframe;if("ZXY"!==o&&"YZX"!==o)throw"Unsupported euler order";if(null==this._defaultViewsSettings||null==this._defaultViewsSettings.right||null==this._defaultViewsSettings.left||null==this._defaultViewsSettings.top||null==this._defaultViewsSettings.bottom||null==this._defaultViewsSettings.front||null==this._defaultViewsSettings.back||null==this._defaultViewsSettings.iso)return null;try{"right"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.right.right),r=(new e.Vector3).copy(this._defaultViewsSettings.right.sight)),n=(new e.Vector3).crossVectors(i,r)):"left"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.left.right),r=(new e.Vector3).copy(this._defaultViewsSettings.left.sight)),n=(new e.Vector3).crossVectors(i,r)):"top"===t?this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.top.right),r=(new e.Vector3).copy(this._defaultViewsSettings.top.sight),n=(new e.Vector3).crossVectors(i,r)):"bottom"===t?this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.bottom.right),r=(new e.Vector3).copy(this._defaultViewsSettings.bottom.sight),n=(new e.Vector3).crossVectors(i,r)):"front"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.front.right),r=(new e.Vector3).copy(this._defaultViewsSettings.front.sight)),n=(new e.Vector3).crossVectors(i,r)):"back"===t?(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.back.right),r=(new e.Vector3).copy(this._defaultViewsSettings.back.sight)),n=(new e.Vector3).crossVectors(i,r)):"iso"===t&&(this._defaultViewsSettings&&(i=(new e.Vector3).copy(this._defaultViewsSettings.iso.right),r=(new e.Vector3).copy(this._defaultViewsSettings.iso.sight)),n=(new e.Vector3).crossVectors(i,r))}catch(e){return console.warn("Error while parsing view json"),null}s.lookAt(a,r,n);var l=(new e.Matrix4).copy(s);return"YZX"===o&&(l=(new e.Matrix4).copy(this.fromZUpMatrix)).multiply(s),l},i.prototype.setCustomViewSettings=function(e){this._defaultViewsSettings=e},i.prototype.buildSnapRobotMatrix=function(e){return"zup"===this._woName?this.buildSnapRobotMatrix_zup(e):"yup"===this._woName?this.buildSnapRobotMatrix_yup(e):void 0},i.prototype.buildSnapRobotMatrix_zup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(1,0,0).projectOnPlane(r),s=n.length(),a=new e.Vector3(0,1,0).projectOnPlane(r),o=a.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,0,1),r),h=new e.Vector3(0,0,1).dot(r);return Math.abs(h)>.999?Math.abs(s-o)<5e-4?(n.normalize(),a.normalize()):s<o?((a=new e.Vector3(0,1,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(a,r).normalize()):((n=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(n.x,a.x,r.x,0,n.y,a.y,r.y,0,n.z,a.z,r.z,0,0,0,0,1)).setPosition(t.position),i},i.prototype.buildSnapRobotMatrix_yup=function(t){var i,r=t.normal;r.normalize();var n=new e.Vector3(0,0,1).projectOnPlane(r),s=n.length(),a=new e.Vector3(1,0,0).projectOnPlane(r),o=a.length(),l=(new e.Vector3).crossVectors(new e.Vector3(0,1,0),r),h=new e.Vector3(0,1,0).dot(r);return Math.abs(h)>.999?Math.abs(s-o)<5e-4?(n.normalize(),a.normalize()):s<o?((a=new e.Vector3(1,0,0).projectOnPlane(r)).normalize(),n=(new e.Vector3).crossVectors(a,r).normalize()):((n=new e.Vector3(0,0,1).projectOnPlane(r)).normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()):(n=l.normalize(),a=(new e.Vector3).crossVectors(r,n).normalize()),(i=new e.Matrix4(a.x,r.x,n.x,0,a.y,r.y,n.y,0,a.z,r.z,n.z,0,0,0,0,1)).setPosition(t.position),i},{YUpXRight:new i({name:"yup",upVector:new e.Vector3(0,1,0),rightVector:new e.Vector3(1,0,0),fromZUpMatrix:(new e.Matrix4).setRotationFromEuler(new e.Vector3(-Math.PI/2,0,-Math.PI/2),"XYZ"),upAttribute:"y",rightAttribute:"x",frontAttribute:"z",anglesOrderForLockedRotation:"YZX",eulerOrderForReframe:"YZX"}),ZUpYRight:new i({name:"zup",upVector:new e.Vector3(0,0,1),rightVector:new e.Vector3(0,1,0),fromZUpMatrix:new e.Matrix4,upAttribute:"z",rightAttribute:"y",frontAttribute:"x",anglesOrderForLockedRotation:"ZYX",eulerOrderForReframe:"ZXY"})}}),define("DS/Visualization/MaterialApplication",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";e.MaterialLayerUndefined=4294967295,e.MaterialLayerMax=e.MaterialLayerUndefined-1,e.__DefaultUVTransform__=e.__DefaultUVTransform__||new e.Matrix3;var t=e.__DefaultUVTransform__,i=new e.Matrix4,r=function(e){e=e||{},this.mappingType=-1,this.mappingObjTransformation=i,this.mappingUVTransformation=t,this.mappingNormTransformation=t,this.textureUVTransforms={normalUvTransform:t,bumpUvTransform:t,bumpScaleUvTransform:t,normalScaleUvTransform:t,displacementUvTransform:t,thicknessUvTransform:t,diffuseUvTransform:t,specularUvTransform:t,metalnessUvTransform:t,emissionColorUvTransform:t,specularContribUvTransform:t,transparencyUvTransform:t,opacityUvTransform:t,translucencyUvTransform:t,translucencyColorUvTransform:t,roughnessUvTransform:t,anisotropyUvTransform:t,anisotropyAngleUvTransform:t,sheenUvTransform:t,sheenRoughnessUvTransform:t,sheenColorUvTransform:t,clearCoatRoughnessUvTransform:t,clearCoatUvTransform:t,clearCoatNormalUvTransform:t,clearCoatColorUvTransform:t,flakesRoughnessUvTransform:t,flakesSizeUvTransform:t,flakesCoverageUvTransform:t,flakesColorUvTransform:t,flipFlopUvTransform:t,flipFlopColorUvTransform:t,iridescenceUvTransform:t,iridescenceThicknessUvTransform:t},this.textureUVSlots={normalUvSlot:1,bumpUvSlot:1,bumpScaleUvSlot:1,normalScaleUvSlot:1,displacementUvSlot:1,thicknessUvSlot:1,diffuseUvSlot:1,specularUvSlot:1,metalnessUvSlot:1,emissionColorUvSlot:1,specularContribUvSlot:1,transparencyUvSlot:1,opacityUvSlot:1,translucencyUvSlot:1,translucencyColorUvSlot:1,roughnessUvSlot:1,anisotropyUvSlot:1,anisotropyAngleUvSlot:1,sheenUvSlot:1,sheenRoughnessUvSlot:1,sheenColorUvSlot:1,clearCoatRoughnessUvSlot:1,clearCoatUvSlot:1,clearCoatNormalUvSlot:1,clearCoatColorUvSlot:1,flakesRoughnessUvSlot:1,flakesSizeUvSlot:1,flakesCoverageUvSlot:1,flakesColorUvSlot:1,flipFlopUvSlot:1,flipFlopColorUvSlot:1,iridescenceUvSlot:1,iridescenceThicknessUvSlot:1},this.mappingTransformSemantic=1,this._set(e)};r.prototype._set=function(r){if(void 0!==r.mappingType&&(this.mappingType=r.mappingType),void 0!==r.mappingObjTransformation&&(this.mappingObjTransformation=r.mappingObjTransformation,(null===this.mappingObjTransformation||this.mappingObjTransformation.isIdentity())&&(this.mappingObjTransformation=i)),void 0!==r.mappingUVTransformation&&(this.mappingUVTransformation=r.mappingUVTransformation,(null===this.mappingUVTransformation||this.mappingUVTransformation.isIdentity())&&(this.mappingUVTransformation=t)),void 0!==r.textureUVTransforms)for(var n in Object.assign(this.textureUVTransforms,r.textureUVTransforms),this.textureUVTransforms)(null===this.textureUVTransforms[n]||this.textureUVTransforms[n].isIdentity())&&(this.textureUVTransforms[n]=t);void 0!==r.textureUVSlots&&Object.assign(this.textureUVSlots,r.textureUVSlots),void 0!==r.mappingTransformSemantic&&(this.mappingTransformSemantic=r.mappingTransformSemantic),this.mappingObjTransformation&&(this.mappingObjTransformation!==i?this.mappingNormTransformation=(new e.Matrix3).getInverse(this.mappingObjTransformation).transpose():this.mappingNormTransformation=t)};var n=function(e){this.uvSlot=1,this.mode=1,this.linear=!0,this.texture=null,this.uvTransform=t,this._set(e)};n.prototype._set=function(e){void 0!==e.uvSlot&&(this.uvSlot=e.uvSlot),void 0!==e.mode&&(this.mode=e.mode),void 0!==e.linear&&(this.linear=e.linear),void 0!==e.texture&&(this.texture=e.texture),void 0!==e.uvTransform&&(this.uvTransform=e.uvTransform),(null===this.uvTransform||this.uvTransform.isIdentity())&&(this.uvTransform=t)};var s=function(t){this.isMatApp=!0,this._checkForceFlag=!1,this._material=null,this._materialGeomFace=null,this._materialLine=null,this._materialPoint=null,this._lightMap=null,this._mappingOperator=null,this._programID=0,this._inheritance=1,this._layer=e.MaterialLayerMax,this._depth=-1,this._enableDepth=!1,this.setParameters(t)};return s.prototype._dump=function(){return{layer:this.layer,inheritance:this._inheritance,material:this._material?this._material._dump():null,materialGeomFace:this._materialGeomFace?this._materialGeomFace._dump():null,materialLine:this._materialLine?this._materialLine._dump():null,materialPoint:this._materialPoint?this._materialPoint._dump():null,lightMap:!!this._lightMap&&!!this._lightMap.texture,defaultMapping:!this._mappingOperator||this._mappingOperator.mappingType<=0}},s.prototype.copy=function(e){this._checkForceFlag=e._checkForceFlag,this._material=e._material,this._materialGeomFace=e._materialGeomFace,this._materialLine=e._materialLine,this._materialPoint=e._materialPoint,this._lightMap=e._lightMap,this._mappingOperator=e._mappingOperator,this._programID=e._programID,this._inheritance=e._inheritance,this._layer=e._layer,this._depth=e._depth,this._enableDepth=e._enableDepth},s.prototype.clone=function(){var e=new s({faceMaterial:this._material,geometricalFaceMaterial:this._materialGeomFace,lineMaterial:this._materialLine,pointMaterial:this._materialPoint,inheritance:this._inheritance,lightMap:this._lightMap,layer:this._layer,mappingOperator:this._mappingOperator});return e._checkForceFlag=this._checkForceFlag,e._depth=this._depth,e._enableDepth=this._enableDepth,e},s.prototype.setParameters=function(t){t.faceMaterial&&(this._material=t.faceMaterial),t.geometricalFaceMaterial&&(this._materialGeomFace=t.geometricalFaceMaterial),t.lineMaterial&&(this._materialLine=t.lineMaterial),t.pointMaterial&&(this._materialPoint=t.pointMaterial),void 0!==t.inheritance&&(this._inheritance=t.inheritance),void 0!==t.layer&&(this._layer=t.layer),t.lightMap&&(this._lightMap=new n(t.lightMap)),t.mappingOperator&&(this._mappingOperator=new r(t.mappingOperator)),void 0!==t.enableDepth&&(this._enableDepth=t.enableDepth),this._lightMap&&this._lightMap.texture&&(this._programID|=e.ProgramIDs.LIGHT_MAP),this._mappingOperator&&this._mappingOperator.mappingType>-1&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR)},s.prototype.updateMappingOperator=function(t){if(null!==this._mappingOperator){t=t||{};var i={};Object.assign(i,this._mappingOperator),Object.assign(i,t),this._mappingOperator._set(i),this._mappingOperator&&this._mappingOperator.mappingType>-1&&(this._programID|=e.ProgramIDs.MAPPING_OPERATOR)}},s.prototype._getMaterialFromGLType=function(t,i){var r=null;if(4===t?r=i===e.GeomTypeEnum.FACE&&this._materialGeomFace?this._materialGeomFace:this._material:1===t?r=this._materialLine:0===t&&(r=this._materialPoint),this._checkForceFlag){if(this._material||this._materialGeomFace)return this._material&&this._material.force||this._materialGeomFace&&this._materialGeomFace.force?r:null;if(r&&!r.force)return null}return r},s.prototype.isPrioritary=function(t,i){if(!t)return!0;var r=this.getLayer(i),n=t.getLayer(i);return 0!==this._inheritance&&(r<n||r===n&&(r<e.MaterialLayerMax||2===this._inheritance||1===this._inheritance&&0===t._inheritance))},s.prototype.getLayer=function(t){var i=32768*(this._enableDepth?this._depth<0?t:this._depth:0)+this._layer;return i>e.MaterialLayerMax?e.MaterialLayerMax:i},s.prototype.solveInheritance=function(e,t){return this.isPrioritary(e,t)?this:e},s.prototype.getMaterial=function(e,t,i){throw new Error("coucou")},s.prototype.recompileShaders=function(e){for(var t=[this._material,this._materialGeomFace,this._materialLine,this._materialPoint],i=0;i<t.length;i++){var r=t[i];if(r&&(e&&e.onlyDeferred||(e&&e.callback&&e.callback(r),r.needsUpdate=!0),r._deferredMaterialsInit)){var n=r._deferredMaterials,s=e?e.deferredChannels:null;if(s&&s.length>0)for(var a=0;a<s.length;a++){(o=n[s[a]])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}else for(a=0;a<n.length;a++){var o;(o=n[a])&&(e&&e.callback&&e.callback(o),o.needsUpdate=!0)}}}},s.prototype._loadMappingOperatorUniforms=function(e,t,i){var r=e.program.uniformLocations;e._loadTextureInfo(this._mappingOperator.textureUVTransforms,this._mappingOperator.textureUVSlots,t,i,r,!0),e._loadMappingInfo(this._mappingOperator,t,i,r)},e.MaterialApplication=s,s}),define("DS/Visualization/KDTree",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";var r=new t.Box3,n=function(e,t,i){return e.setValues(t[i],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5]),e},s=function(e,i){this.renderable=null,this.nodesUint8=null,this.nodesUint32=null,this.nodesFloat32=null,this.nbAllocatedNodes=0,this.nextFreeNode=0,this.aabb=new t.Box3,this.eltsAsBinary=!0,this.elts=this.eltsAsBinary?null:[],this.eltIndices=null,this.nextFreeIndex=0,this.nbAllocatedIndices=0,this.maxElts=void 0!==e?e:100,this.maxDepth=void 0!==i?i:8,this.intersectionCost=80,this.traversalCost=1,this.emptyBonus=.5,this.debugInfos={initTime:0,totalTime:0,computeCostTime:0,sortTime:0,nbLeafNodesBiggerThanMaxElts:0}};return s.prototype={constructor:s,resetDebugInfos:function(){this.debugInfos.initTime=0,this.debugInfos.totalTime=0,this.debugInfos.computeCostTime=0,this.debugInfos.sortTime=0,this.debugInfos.nbLeafNodesBiggerThanMaxElts=0},printDebugInfos:function(){console.log("init time: "+this.debugInfos.initTime+" ms"),console.log("total time: "+this.debugInfos.totalTime+" ms"),console.log("cost time: "+this.debugInfos.computeCostTime+" ms"),console.log("sort time: "+this.debugInfos.sortTime+" ms"),console.log("number of allocated nodes: "+this.nbAllocatedNodes),console.log("number of used nodes: "+this.nextFreeNode),console.log("number of leaf nodes above maxElts: "+this.debugInfos.nbLeafNodesBiggerThanMaxElts),console.log("number of stored indices: "+this.nbAllocatedIndices);var e=this.eltsAsBinary?this.elts?4*this.elts.length:0:8*this.elts.length,t=8*this.nbAllocatedNodes+e+4*this.nbAllocatedIndices;console.log("estimated kd-tree allocation = "+t/1048576+" MB")},reallocateTreeNodes:function(e){var t=new ArrayBuffer(8*e),i=new Uint8Array(t),r=new Uint32Array(t),n=new Float32Array(t);if(this.nbAllocatedNodes>0)for(var s=0;s<8*this.nbAllocatedNodes;s++)i[s]=this.nodesUint8[s];this.nbAllocatedNodes=e,this.nodesUint8=i,this.nodesUint32=r,this.nodesFloat32=n},reallocateIndices:function(e){var t=new Uint32Array(e);if(this.nbAllocatedIndices>0)for(var i=0;i<this.nbAllocatedIndices;i++)t[i]=this.eltIndices[i];this.nbAllocatedIndices=e,this.eltIndices=t},optimizeMemory:function(){this.nbAllocatedNodes>this.nextFreeNode&&this.reallocateTreeNodes(this.nextFreeNode),this.nbAllocatedIndices>this.nextFreeIndex&&this.reallocateIndices(this.nextFreeIndex)},buildFast:function(e,t){var i=this.eltsAsBinary?e.length/4:e.length;this.elts=e,this.resetDebugInfos();var s=performance.now();if(this.eltsAsBinary)for(var a=0;a<i;a++)n(r,t,6*a),this.aabb.union(r);else for(a=0;a<i;a++)this.aabb.union(t[a]);var o=new Uint32Array(i),l=new Uint32Array((this.maxDepth+1)*i),h=new Uint32Array(i);for(a=0;a<i;a++)h[a]=a;this.debugInfos.initTime=performance.now()-s,this._buildFast(0,this.aabb,t,{ptr:h,offset:0},i,this.maxDepth,{ptr:o,offset:0},{ptr:l,offset:0}),this.optimizeMemory(),this.debugInfos.totalTime=performance.now()-s},_buildFast:function(e,t,i,s,a,o,l,h){if(this.nextFreeNode===this.nbAllocatedNodes&&this.reallocateTreeNodes(Math.max(512,2*this.nbAllocatedNodes)),this.nextFreeNode++,a<=this.maxElts||0===o)this.initLeafNode(e,s,a);else{for(var c=t.size().getMaxAxis(),d=.5*(t.min.getComponent(c)+t.max.getComponent(c)),u=0,p=0,f=0;f<a;f++){var g,m=s.ptr[s.offset+f];(g=this.eltsAsBinary?n(r,i,6*m):i[m]).min.getComponent(c)<=d&&(l.ptr[l.offset+u++]=m),g.max.getComponent(c)>=d&&(h.ptr[h.offset+p++]=m)}var v=t.clone(),_=t.clone();v.max.setComponent(c,d),_.min.setComponent(c,d),this._buildFast(e+1,v,i,l,u,o-1,l,{ptr:h.ptr,offset:h.offset+a});var y=this.nextFreeNode;this.initInteriorNode(e,c,y,d),this._buildFast(y,_,i,h,p,o-1,l,{ptr:h.ptr,offset:h.offset+a})}},initInteriorNode:function(e,t,i,r){var n=i<<2;n|=t,this.nodesUint32[2*e]=n,this.nodesFloat32[2*e+1]=r},initLeafNode:function(e,t,i){var r=i<<2;r|=3,this.nodesUint32[2*e]=r,i>this.maxElts&&this.debugInfos.nbLeafNodesBiggerThanMaxElts++;var n=0;if(0===i)n=0;else if(1===i)n=t.ptr[t.offset];else{n=this.nextFreeIndex,this.nextFreeIndex+i>=this.nbAllocatedIndices&&this.reallocateIndices(Math.max(512,2*this.nbAllocatedIndices));for(var s=0;s<i;s++)this.eltIndices[this.nextFreeIndex+s]=t.ptr[t.offset+s];this.nextFreeIndex+=i}this.nodesUint32[2*e+1]=n},isLeafNode:function(e){return 3==(3&this.nodesUint32[2*e])},getSplitAxis:function(e){return 3&this.nodesUint32[2*e]},getSplitPosition:function(e){return this.nodesFloat32[2*e+1]},getNbElts:function(e){return this.nodesUint32[2*e]>>2},getNbTotalElts:function(){return this.eltsAsBinary?this.elts?this.elts.length/4:0:this.elts.length},getNbNodes:function(){return this.nbAllocatedNodes},getEltIndices:function(e){return this.nodesUint32[2*e+1]},getAboveChild:function(e){return this.nodesUint32[2*e]>>2},setBoundEdge:function(e,t,i,r,n){var s=r<<1;s|=n,e.float32View[2*t]=i,e.uint32View[2*t+1]=s},getBoundEdgeValue:function(e,t){return e.float32View[2*t]},getBoundEdgeEltNum:function(e,t){return e.uint32View[2*t+1]>>1},getBoundEdgeType:function(e,t){return 1&e.uint32View[2*t+1]},intersect:function(e,i,r,n){var s=new t.Vector2;if(!e.intersectBox(this.aabb,void 0,s))return!1;for(var a=new t.Vector3(1/e.direction.x,1/e.direction.y,1/e.direction.z),o=[],l=0,h=0,c=this.aabb.clone();h>=0&&!(n&&n<s.x);)if(r&&r({aabb:c,nodeId:h}),this.isLeafNode(h)){var d=this.getNbElts(h);if(1===d){var u,p=this.getEltIndices(h);if(this.eltsAsBinary){var f=this.renderable.geometry[this.elts[4*p]],g=this.elts[4*p+3];u={dg:f.drawingGroups[this.elts[4*p+1]],primitive:this.elts[4*p+2],offset:4294967295===g?-1:g}}else u=this.elts[p];i&&i(u,h,p)}else for(var m=0;m<d;m++){p=this.eltIndices[this.getEltIndices(h)+m];if(this.eltsAsBinary){f=this.renderable.geometry[this.elts[4*p]],g=this.elts[4*p+3];u={dg:f.drawingGroups[this.elts[4*p+1]],primitive:this.elts[4*p+2],offset:4294967295===g?-1:g}}else u=this.elts[p];i&&i(u,h,p)}if(!(l>0))break;h=o[--l].nodeId,s.copy(o[l].tMinMax),c=o[l].aabb}else{var v,_,y,S,x=this.getSplitAxis(h),b=this.getSplitPosition(h),w=e.origin.getComponent(x),M=(b-w)*a.getComponent(x),C=c.clone(),P=c.clone();C.max.setComponent(x,b),P.min.setComponent(x,b),w<b||w===b&&e.direction.getComponent(x)<=0?(v=h+1,_=this.getAboveChild(h),y=C,S=P):(v=this.getAboveChild(h),_=h+1,y=P,S=C),M>s.y||M<=0?(h=v,c=y):M<s.x?(h=_,c=S):(o[l]={nodeId:_,tMinMax:new t.Vector2(M,s.y),aabb:S},l++,h=v,c=y,s.y=M)}return!1},buildFromMesh:function(e,r,n,s,a,o){this.renderable=e;var l=!n||n.isIdentity(),h=null,c=0,d=new i.SGPrimitiveHelper;if(e.geometry.length>=0?(h=e.geometry[0],c=e.geometry.length):2===e.geometry._type&&(h=e.geometry,c=1),!h||h.vertexIndexArray){for(var u=0,p=1024,f=s||(this.eltsAsBinary?new Uint32Array(4096):[]),g=a||(this.eltsAsBinary?new Float32Array(6144):[]),m=new t.Vector3,v=new t.Vector3,_=new t.Vector3,y=new t.Box3,S=new t.Box3,x=0;x<c;x++){for(var b=h.drawingGroups,w=b.length,M=h.vertexIndexArray,C=0;C<w;C++)for(var P=b[C],E=P.getPrimitivesCount(),T=0;T<E;T++){d.set(P,T);var A=d.getStart(),D=A+d.getCount(),I=this.eltsAsBinary?y:new t.Box3;switch(this.eltsAsBinary&&I.makeEmpty(),P.glType){case 4:case 5:for(var R=A;R<D;R+=3){var O,L,V;if(P.nonIndexed?(O=R,L=R+1,V=R+2):(O=M[R],L=M[R+1],V=M[R+2]),h.getVertexPosition(O,m),h.getVertexPosition(L,v),h.getVertexPosition(V,_),l||(m.applyMatrix4(n),v.applyMatrix4(n),_.applyMatrix4(n)),r)I.expandByPoint(m),I.expandByPoint(v),I.expandByPoint(_);else{var F=this.eltsAsBinary?S:new t.Box3;if(F.setFromPoints([m,v,_]),this.eltsAsBinary){if(u>=p){var B=new Uint32Array(2*p*4),N=new Float32Array(2*p*6);B.set(f),N.set(g),p*=2,f=B,g=N}f[4*u]=x,f[4*u+1]=C,f[4*u+2]=T,f[4*u+3]=R,g[6*u]=F.min.x,g[6*u+1]=F.min.y,g[6*u+2]=F.min.z,g[6*u+3]=F.max.x,g[6*u+4]=F.max.y,g[6*u+5]=F.max.z,u++}else f.push({dg:P,primitive:T,offset:R}),g.push(F)}}}if(r)if(this.eltsAsBinary){if(u>=p){B=new Uint32Array(2*p*4),N=new Float32Array(2*p*6);B.set(f),N.set(g),p*=2,f=B,g=N}f[4*u]=x,f[4*u+1]=C,f[4*u+2]=T,f[4*u+3]=4294967295,g[6*u]=I.min.x,g[6*u+1]=I.min.y,g[6*u+2]=I.min.z,g[6*u+3]=I.max.x,g[6*u+4]=I.max.y,g[6*u+5]=I.max.z,u++}else f.push({dg:P,primitive:T,offset:-1}),g.push(I)}h=e.geometry[x+1]}if(!o){if(this.eltsAsBinary&&u<p){B=new Uint32Array(4*u),N=new Float32Array(6*u);for(var G=0;G<6*u;G++)N[G]=g[G];for(G=0;G<4*u;G++)B[G]=f[G];f=B,g=N}this.buildFast(f,g)}return this}console.warn("kdtree build impossible, make sure noMeshInRAM is inactive")}},t.KDTree=s,s}),define("DS/Visualization/RenderStyle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode"],function(e,t,i){"use strict";var r=e.extend({init:function(e){if(e=e||{},this._renderMode=new i,this._renderMode._setMask(t.ShowAllRenderLineMode|t.ShowAllFaces),e.hasOwnProperty("faceMode")){this._materialMode=!1;var n=e.faceMode;"MATERIAL"!==n&&"GAS"!==n||(this._materialMode="MATERIAL"===n,n="COLOR"),this._faceMode=n?r.FaceModes[n]:r.FaceModes.unset}else this._materialMode=!0,this._faceMode=r.FaceModes.COLOR;this._materialMode=e.hasOwnProperty("materialMode")?!!e.materialMode:this._materialMode,this._combineRenderModeValue=e.combineRenderMode?r.CombineRenderMode[e.combineRenderMode]:r.CombineRenderMode.REPLACE,this._locked=!1},setOutlineWidth:function(e){this._renderMode.setOutlineWidth(e)},setHalfVisibleSmoothEdges:function(e){this._renderMode.setHalfVisibleSmoothEdges(e)},setHiddenEdges:function(e){this._renderMode.setHiddenEdges(e)},setRenderMode:function(e,t){return!this._locked&&(this._renderMode.setRenderMode(e,t),!0)},setFaceMode:function(e){if(this._locked)return!1;var t=e;return"MATERIAL"!==t&&"GAS"!==t||(this._materialMode="MATERIAL"===e,t="COLOR"),this._faceMode=r.FaceModes[t],!0},setMaterialMode:function(e){return!this._locked&&(this._materialMode=!!e,!0)},clone:function(){var e=new r;return e._renderMode=this._renderMode.clone(),e._faceMode=this._faceMode,e._materialMode=this._materialMode,e._combineRenderModeValue=this._combineRenderModeValue,e},dumpToJSON:function(){return{version:1,renderModeMask:this._renderMode.getMask(),faceMode:this._faceMode,materialMode:this._materialMode,combineMode:this._combineRenderModeValue,outlineWidth:this._renderMode._outlineWidth}},setRepViewNothing:function(e){this._renderMode.setRepViewNothing(e)},_lock:function(){this._locked=!0},_combineFaceMode:function(e){return 0!==this._faceMode?{face:this._faceMode,material:this._faceMode===r.FaceModes.COLOR&&this._materialMode}:e},_combineRenderMode:function(e,t){var r,n;switch(this._combineRenderModeValue){case 0:return t||e;case 1:return this._renderMode&&e&&this._renderMode._hasReplaceMask()?((r=new i)._setReplace(e,this._renderMode),this._renderMode._repViewNothing&&(r._repViewNothing=!0),r):this._renderMode;case 2:return e?(n=(r=this._renderMode.clone()).getMask()|e.getMask(),r._setMask(n),r):this._renderMode;case 3:return e?(n=(r=this._renderMode.clone()).getMask()&e.getMask(),r._setMask(n),r):this._renderMode}return null},_displayNothingRenderMode:function(){this._renderMode._displayNothing()},setReplaceMask:function(e){this._renderMode.setReplaceMask(e)}});return r.FaceModes={unset:0,COLOR:1,ZONLY:2,BACKGROUND:3},r.CombineRenderMode={IGNORE:0,REPLACE:1,OR:2,AND:3},r.compareDumpJSON=function(e,t){return e.renderModeMask===t.renderModeMask&&e.faceMode===t.faceMode&&e.materialMode===t.materialMode&&e.combineMode===t.combineMode&&e.outlineWidth===t.outlineWidth},t.RenderStyle=r,r}),define("DS/Visualization/TrackballControls",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/AnimationPath","DS/Animation/PropertyAnimation","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent","DS/VisuEvents/MouseEvent","DS/WebRecordEnabler/Adapter"],function(e,t,i,r,n,s,a,o,l,h,c,d){"use strict";const u=t.IsFirefox;var p=0,f=function(e,i){void 0===o._isInit&&o.init(),this.manipulatedViewList=[i],t.EventTarget.call(this),this.viewpoint=e,this.viewer=e.viewer,this.domElement=void 0!==i?i:document,this.isMac=navigator.platform.toUpperCase().indexOf("MAC")>=0,this.camera=e.camera,this.id=p++,window.DSWebRecord&&o._record_registerObject(this,"TrackballControls"),this.viewer.forceRenderTargetSize?(this.radius=.5*Math.max(this.viewer._getDivClientWidth(),this.viewer._getDivClientHeight()),this.radiusZoom=.25*(this.viewer._getDivClientWidth()+this.viewer._getDivClientHeight())):(this.radius=.5*Math.max(this.domElement.clientWidth,this.domElement.clientHeight),this.radiusZoom=.25*(this.domElement.clientWidth+this.domElement.clientHeight)),this.panSpeed=1,this.rotateSpeed=1,this.zoomSpeed=5,this.lockZ=!1,this.rollingForTouchAvailable=!1,this.lockRotation=!1,this.lockMouseRotation=!1,this.lockTouchRotation=!1,this.lockMouseRotationForSimpleMode=!1,this.lockMouseZoomForCtrlKeyWheelMode=!1,this.lockNativeBehaviorOnMouseMiddleTriggers=!0,this.lockRotationOverTrapSelection=!0,this.lockMouseWheel=!1,this.lockZoom=!1,this.lockPan=!1,this.lockMouse=!1,this.lockReframe=!1,this.lockReframeOnDblTap=!1,this.lockPreventDefaultForCtrlKeyWheel=!0,this.mouseInertia=!1,this.touchInertia=!0,this.rotateDirection=1,this.lastLockZState=null,this.lockZRotationSpeed=.002,this._invertHeadRotation=!1,this.target=e.target,this.position=e.position,this.orientation=new t.Quaternion,this.distanceToTarget=700,this._state=f.State.NONE,this._clickTimer=null,this._leftClicking=!1,this._middleClicking=!1,this._rightClicking=!1,this._leftButtonPressed=!1,this._middleButtonPressed=!1,this._rightButtonPressed=!1,this._ctrlKeyPressed=!1,this._shiftKeyPressed=!1,this._clickTolerancy=10,this._blockVptOnHold=!0,this._showSpinnerOnHold=!1,this._pickingCB=!0,this._avatarDistance=0,this._forcePan=!1,this._forceRotate=!1,this._forceZoom=!1,this._forcePanCmd=null,this._forceRotateCmd=null,this._forceZoomCmd=null,this._rotationAroundPoint=!1,this._showRotationPointOnMove=!1,this._rotationAroundPointTarget={isSet:!1,isShown:!1,dim2:null,dim3:null},this._pivotRotateSpeed=1,this._deg2Rad=.01745,this._touchPos=null,this._2DMode=!1,this._lockUpDirection=null,this._lockUpMode=null,this.oldManipActive=!1,this._mode=f.Mode.COMBINED,this._zoomType=f.ZoomType.ZOOM_POS_CHANGE,this._FOVZoomMinAngle=.01;var r=this;this._panWithTrackPadSupport=function(e){let t=-1;if(e)if("string"==typeof e)switch(e.toLowerCase()){case"auto":t=0;break;case"forced":case"true":case"yes":t=1}else"number"==typeof e&&(0!=e&&1!=e||(t=e));return 0==t?console.log("Automatic trackpad support on."):1==t?console.log("Trackpad support is forced."):console.log("Trackpad is NOT supported."),t},this._trackPadData={isActive:!1,isOnOffAuto:-1,position:null,positionPrev:null,autoState:!1},this._isFromTrackPadAutoDetect=function(e){let t=!1;return this._trackPadData?(this.isMac?e.wheelDeltaY?e.wheelDeltaY===-3*e.deltaY&&(t=!0):0===e.deltaMode&&(t=!0):(e.wheelDeltaY&&120!==Math.abs(e.wheelDeltaY)&&(t=!0),e.wheelDeltaX&&120!==Math.abs(e.wheelDeltaX)&&(t=!0),t||(0===e.deltaMode&&(t=!0),e.ctrlKey&&(t=!0))),t):t},this._isFromTrackPad=function(e){return 0>this._trackPadData.isOnOffAuto?-1:0==this._trackPadData.isOnOffAuto?this._isFromTrackPadAutoDetect(e)?1:0:2},this._onWindowResize=function(e){r._resize(e)},this._onContextMenu=function(e){e.preventDefault()},this._onBlurCB=function(){r._ctrlKeyPressed=!1,r._shiftKeyPressed=!1},this._onDragEndCB=function(e){var t=o._getMouseButton(e.button);let i=new c(t,e);r._onLeftMouseUp({from:[i]})},this._dragX=0,this._dragY=0,this._onDragCB=function(e){if((e.screenX!=r._dragX||e.screenY!=r._dragY)&&(r._dragX=e.screenX,r._dragY=e.screenY,r._pickingCB&&r.viewer&&r.viewer.mouseMoveCB)){let t=new l(e),i=t.event.clientX,n=t.event.clientY;t._currentPosition.set(i,n),r.viewer.mouseMoveCB(t,r)}},this.basicEventID=0,this.editEventBeginID=0,this.editEventKOID=0,this.infiniteRender=!1,this._mouseDownPos=null,this._oldCursor="",this._modelEvent=new a,this.attachEvents(),this.setMode(f.Mode.COMBINED),this._createShortHoldSpinner(1,"#3da4e0"),this._createRotationPointElem(),this._customZoomTokens=[],this._customPanTokens=[],this._customRotateTokens=[],this.needsRotationFinalized=!1,this.deltaPosition=null,this.previousTime=0,this.deltaTime=0,this._isIE11=t.IsIE11,this._wheelMoving=!1,this._wheelTimer=null,this._flyWalkStateInfo={bActive:!1,forceStopRequests:0,oldControlState:f.State.NONE}};return Object.defineProperty(f.prototype,"_finalizeRotateLockZ",{set:function(e){this._finalizeRotateLockWorldUpVector=e}}),f.Mode={CATIA:0,SIMPLE:1,COMBINED:2,LOOKAROUND:3},f.State={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,FORCE_ROTATE:3,FORCE_ZOOM:4,FORCE_PAN:5,HOLD:6,ZOOM_PAN_ROTATE:7,STOP:8},f.changeEvent={type:"change"},f.prototype.setActive=function(e){e instanceof Object?(void 0!==e.viewpoint&&this._changeState(e.viewpoint?f.State.NONE:f.State.STOP),void 0!==e.picking&&(this._pickingCB=e.picking)):this._changeState(e?f.State.NONE:f.State.STOP)},f.prototype.setMouseActive=function(e){this.lockMouse=!e},f.prototype.setRotationActive=function(e){this.lockRotation=!e},f.prototype.setMouseRotationActive=function(e){this.lockMouseRotation=!e},f.prototype.setTouchRotationActive=function(e){this.lockTouchRotation=!e},f.prototype.setMouseRotationForSimpleModeActive=function(e){this.lockMouseRotationForSimpleMode=!e},f.prototype.setMouseZoomForCtrlKeyWheelActive=function(e){this.lockMouseZoomForCtrlKeyWheelMode=!e},f.prototype.setNativeBehaviorOnMouseMiddleTriggers=function(e){this.lockNativeBehaviorOnMouseMiddleTriggers=!e},f.prototype.isNativeBehaviorOnMouseMiddleTriggers=function(){return!this.lockNativeBehaviorOnMouseMiddleTriggers},f.prototype.setRotationOverTrapSelection=function(e){"boolean"==typeof e&&this.viewpoint&&this.viewpoint.viewer&&this.viewpoint.viewer.trapSelectionManipulator&&(this.lockRotationOverTrapSelection=!e,!1===this.lockRotationOverTrapSelection?this.viewpoint.viewer.trapSelectionManipulator.disable():this.viewpoint.viewer.trapSelectionManipulator.enable(),this._forceRotate=e)},f.prototype.isRotationOverTrapSelection=function(){return!this.lockRotationOverTrapSelection},f.prototype.setMouseWheelActive=function(e){this.lockMouseWheel=!e},f.prototype.getMouseWheelActive=function(){return!this.lockMouseWheel},f.prototype.getMouseRotationActive=function(){return this.lockMouseRotation},f.prototype.getTouchRotationActive=function(){return this.lockTouchRotation},f.prototype.setZoomActive=function(e){this.lockZoom=!e},f.prototype.setPanActive=function(e){this.lockPan=!e},f.prototype.setReframeActive=function(e){this.lockReframe=!e},f.prototype.setReframeOnDoubleTap=function(e){this.lockReframeOnDblTap=!e},f.prototype.setRotationRolling=function(e){this.lockZ=!e},f.prototype.setRotationAroundPoint=function(e){this._2DMode||(this._rotationAroundPoint=e)},f.prototype.setLockUpDirection=function(e,t){this._lockUpDirection=e,this._lockUpMode=t},f.prototype.setNativeGravity=function(e,t,i){0!=e?(this.setRotationRolling(!1),this.setLockUpDirection(t,e)):(this.setRotationRolling(!0),this.setLockUpDirection(null,null))},f.prototype.setRollingForTouchAvailable=function(e){this.rollingForTouchAvailable=e},f.prototype.setPreventDefaultForCtrlKeyWheelActive=function(e){this.lockPreventDefaultForCtrlKeyWheel=!e},f.prototype.setRotationInertia=function(e){void 0!==e.mouse&&(this.mouseInertia=e.mouse),void 0!==e.touch&&(this.touchInertia=e.touch)},f.prototype.setRotationSpeed=function(e){this.rotateSpeed=e,this.lockZRotationSpeed=.0015*e},f.ZoomType={ZOOM_POS_CHANGE:0,ZOOM_FOV_CHANGE:1},f.prototype.setZoomType=function(e){this._zoomType=e},f.prototype.setFOVZoomMinAngle=function(e){this._FOVZoomMinAngle=e},f.prototype.onPan=function(e){if(e){var t=this._modelEvent.subscribe({event:"Pan"},e);return this._customPanTokens.push(t),t}for(var i=0;i<this._customPanTokens.length;i++)this._modelEvent.unsubscribe(this._customPanTokens[i]);this._customPanTokens=[]},f.prototype.onRotate=function(e){if(e){var t=this._modelEvent.subscribe({event:"Rotate"},e);return this._customRotateTokens.push(t),t}for(var i=0;i<this._customRotateTokens.length;i++)this._modelEvent.unsubscribe(this._customRotateTokens[i]);this._customRotateTokens=[]},f.prototype.onZoom=function(e){if(e){var t=this._modelEvent.subscribe({event:"Zoom"},e);return this._customZoomTokens.push(t),t}for(var i=0;i<this._customZoomTokens.length;i++)this._modelEvent.unsubscribe(this._customZoomTokens[i]);this._customZoomTokens=[]},f.prototype.blockViewpointOnHold=function(e){this._blockVptOnHold=e},f.prototype.setSpinnerOnHold=function(e){this._showSpinnerOnHold=e},f.prototype.isCurrentViewpoint=function(){return this.viewpoint.viewer._viewpointManager.getManipulatedViewpoint()==this.viewpoint},f.prototype.isLeftButtonPressed=function(){return this._leftButtonPressed},f.prototype.isMiddleButtonPressed=function(){return this._middleButtonPressed},f.prototype.isRightButtonPressed=function(){return this._rightButtonPressed},f.prototype.isCtrlKeyPressed=function(){return this._ctrlKeyPressed},f.prototype.isShiftKeyPressed=function(){return this._shiftKeyPressed},f.prototype.isLeftClick=function(){return this._leftClicking},f.prototype.isMiddleClick=function(){return this._middleClicking},f.prototype.isRightClick=function(){return this._rightClicking},f.prototype.startLeftClick=function(){var e=this;this._leftClicking=!0,this._clickTimer&&clearTimeout(this._clickTimer),d.isReplaying()||(this._clickTimer=setTimeout(function(){o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(e.viewer,"TrackballControls","TrackballControlCancelLeftClick"),e.cancelLeftClick()},300))},f.prototype.cancelLeftClick=function(){this._leftClicking=!1},f.prototype.cancelMiddleClick=function(){this._middleClicking=!1},f.prototype.cancelRightClick=function(){this._rightClicking=!1},f.prototype.resetLeftClick=function(){this._leftClicking=!1,this._clickTimer&&clearTimeout(this._clickTimer),this._clickTimer=null},f.prototype.getManipulationState=function(){return this._state},f.prototype.isMoving=function(){return this._state!==f.State.NONE&&this._state!==f.State.STOP&&this._state!==f.State.HOLD&&!(this._targetAnim&&!this._targetAnim.isRunning())},f.prototype.updateEditGesture=function(){var e=o._getGesture(document,"onEdit");e&&e.setTimerMouse(this._mode>0?o.getHoldTime():0)},f.prototype.setMode=function(e){void 0!==e&&e!==this._mode&&(this._mode=e,this.updateEditGesture(),this.viewer.trapSelection&&this.viewer.trapSelection.updateMode(this,this._mode))},f.prototype.setDebugEvents=function(e){o.setDebugEvents(e)},f.prototype.attachEvents=function(){this.initGestureCB(),this.domElement.addEventListener("contextmenu",this._onContextMenu,!1),window.addEventListener("blur",this._onBlurCB),window.addEventListener("dragend",this._onDragEndCB),this.domElement.addEventListener("dragover",this._onDragCB)},f.prototype.detachEvents=function(){this.resetGestureCB(),this.domElement.removeEventListener("contextmenu",this._onContextMenu,!1),window.removeEventListener("blur",this._onBlurCB),window.removeEventListener("dragend",this._onDragEndCB),this.domElement.removeEventListener("dragover",this._onDragCB)},f.prototype.overrideRotationViaLongHold=function(e){1===e?(this.viewer&&this.viewer.setManipulators({activated:!0}),this._forceRotate=!1):(this._forceRotate=!0,this.viewer&&this.viewer.setManipulators({activated:!1}))},f.prototype._setCapture=function(){var e=this.viewer?this.viewer.div:null;e&&(!e.setCapture||!(this._isIE11||u&&!e.draggable)||e.tagName&&"input"===e.tagName.toLowerCase()||e.setCapture(!1))},f.prototype._releaseCapture=function(){(this._isIE11||u)&&document.releaseCapture&&document.releaseCapture()},f.prototype.initGestureCB=function(){if(!this.gestureCBReady){var e=this;this._onLeftMouseDownCB=function(t){e._onLeftMouseDown.call(e,t)},this._onMiddleMouseDownCB=function(t){e._onMiddleMouseDown.call(e,t)},this._onRightMouseDownCB=function(t){e._onRightMouseDown.call(e,t)},this._onLeftMouseUpCB=function(t){e._onLeftMouseUp.call(e,t)},this._onMiddleMouseUpCB=function(t){e._onMiddleMouseUp.call(e,t)},this._onRightMouseUpCB=function(t){e._onRightMouseUp.call(e,t)},this._onMouseMoveCB=function(t){e._onMouseMove.call(e,t)},this._onMouseOutCB=function(t){e._onMouseOut.call(e,t)},this._onSwipeCB=function(t){e._onSwipe.call(e,t)},this._onTapCB=function(t){e._onTap.call(e,t)},this._onPinchPanRotateCB=function(t){e._onPinchPanRotate.call(e,t)},this._onDoubleTapCB=function(t){e._onDoubleTap.call(e,t)},this._onDoublePinchTapCB=function(t){e._onDoublePinchTap.call(e,t)},this._onHoldCB=function(t){e._onHold.call(e,t)},this._onTouchCB=function(t){e._onTouch.call(e,t)},this._onReleaseCB=function(t){e._onRelease.call(e,t)},this._onEditCB=function(t){e._onStopManip.call(e,t)},o.addEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB),o.addEvent(document,"onRightMouseDown",this._onRightMouseDownCB),o.addEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB),o.addEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.addEvent(document,"onRightMouseUp",this._onRightMouseUpCB),o.addEvent(document,"onMouseMove",this._onMouseMoveCB),o.addEvent(document,"onMouseOut",this._onMouseOutCB),o.addEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.addEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(this.domElement,"onHold",this._onHoldCB),o.addEvent(document,"onRelease",this._onReleaseCB),o.addEvent(document,"onEdit",this._onEditCB),this.updateEditGesture(),this.addViewToGestures(this.domElement),this.viewer&&this.viewer.divCssElement&&this.addViewToManipulation(this.viewer.divCssElement),this.basicEventID=s.subscribe({event:"/VISU/onBasicEvent"},function(t){e._onBasicEvent.call(e,t)}),this.editEventBeginID=s.subscribe({event:"/VISU/onEditEventBegin"},function(t){e._showSpinnerOnHold&&e._onEditEventBegin.call(e,t)}),this.editEventKOID=s.subscribe({event:"/VISU/onEditEventKO"},function(t){e._onEditEventKO.call(e,t)}),this.gestureCBReady=!0}},f.prototype.resetGestureCB=function(){if(this.gestureCBReady){o.removeEvent(document,"onLeftMouseDown",this._onLeftMouseDownCB),o.removeEvent(document,"onRightMouseDown",this._onRightMouseDownCB),o.removeEvent(document,"onLeftMouseUp",this._onLeftMouseUpCB),o.removeEvent(document,"onMiddleMouseUp",this._onMiddleMouseUpCB),o.removeEvent(document,"onRightMouseUp",this._onRightMouseUpCB),o.removeEvent(document,"onMouseMove",this._onMouseMoveCB),o.removeEvent(document,"onMouseOut",this._onMouseOutCB),o.removeEvent(this.domElement,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(this.domElement,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(this.domElement,"onHold",this._onHoldCB),o.removeEvent(document,"onRelease",this._onReleaseCB),o.removeEvent(document,"onEdit",this._onEditCB);for(var e=0;e<this.manipulatedViewList.length;e++){var t=this.manipulatedViewList[e];this.removeViewFromGestures(t)}s.unsubscribe(this.basicEventID),s.unsubscribe(this.editEventBeginID),s.unsubscribe(this.editEventKOID),this.gestureCBReady=!1}},f.prototype.addViewToGestures=function(e){o.addEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.addEvent(e,"onTouch",this._onTouchCB),o.addEvent(e,"onSwipe",this._onSwipeCB),o.addEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.addEvent(e,"onTap",this._onTapCB)},f.prototype.removeViewFromGestures=function(e){o.removeEvent(e,"onMiddleMouseDown",this._onMiddleMouseDownCB),o.removeEvent(e,"onTouch",this._onTouchCB),o.removeEvent(e,"onSwipe",this._onSwipeCB),o.removeEvent(e,"onPinchPanRotate",this._onPinchPanRotateCB),o.removeEvent(e,"onTap",this._onTapCB)},f.prototype.addViewToManipulation=function(e){return-1===this.manipulatedViewList.indexOf(e)&&(this.manipulatedViewList.push(e),this.addViewToGestures(e),!0)},f.prototype.removeViewFromManipulation=function(e){var t=this.manipulatedViewList.indexOf(e);return-1!==t&&(this.manipulatedViewList.splice(t,1),this.removeViewFromGestures(e),!0)},f.prototype.setTarget=function(e){this.target.copy(e)},f.prototype.onMove=function(e){return this._modelEvent.subscribe({event:"ViewpointMove"},e)},f.prototype.unsubscribe=function(e){var t=this._customZoomTokens.indexOf(e);-1!==t?this._customZoomTokens.splice(t,1):-1!==(t=this._customPanTokens.indexOf(e))?this._customPanTokens.splice(t,1):-1!==(t=this._customRotateTokens.indexOf(e))&&this._customRotateTokens.splice(t,1),this._modelEvent.unsubscribe(e)},f.prototype.updateNativeZoom=function(e){if(this.camera.isOrtho&&null!=this.viewpoint._nativeZoomType){this.camera.setVisualizedHeight(e);let t=1/this.viewpoint.getMMInSupportUnit();switch(this.viewpoint._nativeZoomType){case this.viewpoint.NativeZoomTypes.MillimeterScreenBased:this.viewpoint._nativeZoom=this.viewer.SCREEN_HEIGHT*t/(this.camera.top-this.camera.bottom);break;case this.viewpoint.NativeZoomTypes.HalfWindowHeightBased:case this.viewpoint.NativeZoomTypes.HalfWindowWidthAndHeigthBased:this.viewpoint._nativeZoom=2/(this.camera.top-this.camera.bottom)}let i=!1;if(this.viewpoint._nativeMinZoom&&this.viewpoint._nativeZoom<this.viewpoint._nativeMinZoom&&(this.viewpoint._nativeZoom=this.viewpoint._nativeMinZoom,i=!0),this.viewpoint._nativeMaxZoom&&this.viewpoint._nativeZoom>this.viewpoint._nativeMaxZoom&&(this.viewpoint._nativeZoom=this.viewpoint._nativeMaxZoom,i=!0),i){let e=2/this.viewpoint._nativeZoom;this.viewpoint._nativeZoomType==this.viewpoint.NativeZoomTypes.MillimeterScreenBased&&(e=this.viewer.SCREEN_HEIGHT*t/this.viewpoint._nativeZoom);let i=e/(2*Math.tan(Math.PI*this.fov/360));this.camera.setVisualizedHeight(i)}this.update()}},f.prototype.update=function(){var e=this.camera.position.clone(),i=this.camera.quaternion.clone(),r=new t.Vector3(0,0,1),n=!1;if(this.camera.useQuaternion=!0,r.applyQuaternion(this.orientation),r.setLength(this.distanceToTarget),this.camera.position.addVectors(this.target,r),this.camera.isOrtho&&null==this.viewpoint._nativeZoomType&&(this.camera.setVisualizedHeight(this.distanceToTarget),this.camera.updateProjectionMatrix()),null!=this.viewpoint._nativeZoomType){let e=this.viewpoint.updateNative2D(),t=.5*(this.camera.top-this.camera.bottom)/Math.tan(this.camera.fov*Math.PI/360);this.distanceToTarget=t,r.setLength(t);var a=e.clone().sub(r);this.setTarget(a),this.camera.position.addVectors(this.target,r)}this.camera.quaternion.copy(this.orientation),this.camera.up=new t.Vector3(0,1,0),this.camera.up.applyQuaternion(this.orientation),e.sub(this.camera.position),i.sub(this.camera.quaternion),this.position.copy(this.camera.position),this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera.updateProjectionMatrix(),(this.infiniteRender||e.lengthSq()>1e-7||i.lengthSq()>1e-7||this.camera._hasChanged)&&(n=!0,this.dispatchEvent(f.changeEvent),this.viewpoint._updateFrustum(),this._modelEvent.publish({event:"ViewpointMove",context:this}),this._2DMode&&this.viewer.svgRoot&&this.viewer._updateSVGVisu(),this.viewer&&(this.viewer.renderIteration=0)),this.camera._hasChanged=!1;var o={eventChannel:n?"/VISU/":"/VISU/SpriteNodeInit",eventType:"@onViewpointChange",viewpoint:this.viewpoint,cameraEye:this.position,cameraTarget:this.target,cameraUp:this.camera.up};return s.publish({event:n?"/VISU/":"/VISU/SpriteNodeInit",data:o}),n},f.prototype.moveTo=function(e){console.log("TrackballControls.prototype.moveTo is DEPRECATED: use Viewpoint.moveTo instead.");var a,o,l,h={position:e.position,target:e.target||this.target.clone(),orientation:e.orientation||this.orientation.clone(),distanceToTarget:e.distanceToTarget||this.distanceToTarget,duration:e.duration||0};if(e instanceof t.Vector3&&(console.warn("TrackballControls.prototype.moveTo now uses options litteral object as argument."),h.target=arguments[0],arguments[1]&&(h.orientation=arguments[1]),void 0!==arguments[2]&&(h.distanceToTarget=arguments[2]),void 0!==arguments[3]&&(h.duration=arguments[3])),this._targetAnim&&this._targetAnim.stop(),this._orientationAnim&&this._orientationAnim.stop(),this._distanceToTargetAnim&&this._distanceToTargetAnim.stop(),h.position&&e.target){var c=(new t.Vector3).subVectors(e.target,h.position);if(h.distanceToTarget=c.length(),!e.orientation){var d=(new t.Matrix4).lookAt(h.position,e.target,new t.Vector3(0,0,1));h.orientation.setFromRotationMatrix(d)}}else if(h.position){var u=new t.Vector3(0,0,1);u.applyQuaternion(h.orientation),u.setLength(h.distanceToTarget);var p=(new t.Vector3).subVectors(h.position,u);h.target=p}if(0===h.duration)this.setTarget(h.target),this.orientation=h.orientation,this.distanceToTarget=h.distanceToTarget,this.update();else{(a=new r(this.target.clone(),h.target,h.duration)).setInterpolator(function(e,t,i){var r=t.clone();return r.lerp(i,e),r});var f=this;this._targetAnim=new n(this,"setTarget",a,function(e){if(e===i.State.STOPPED){var t={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:f.viewpoint,cameraEye:f.camera.position,cameraUp:f.camera.up};s.publish({event:"/VISU/",data:t})}}),(o=new r(this.orientation,h.orientation,h.duration)).setInterpolator(function(e,i,r){var n=new t.Quaternion;return t.Quaternion.slerp(i,r,n,e),n}),this._orientationAnim=new n(this,"orientation",o),l=new r(this.distanceToTarget,h.distanceToTarget,h.duration),this._distanceToTargetAnim=new n(this,"distanceToTarget",l),this._targetAnim.start(),this._orientationAnim.start(),this._distanceToTargetAnim.start()}},f.prototype.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},f.prototype.startPan=function(e){this.endRotate(),this.endZoom(),this._forcePan=!0,e&&(this._forcePanCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Pan",0))},f.prototype.startRotate=function(e){this.endPan(),this.endZoom(),this._forceRotate=!0,e&&(this._forceRotateCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Rotate",0))},f.prototype.startZoom=function(e){this.endPan(),this.endRotate(),this._forceZoom=!0,e&&(this._forceZoomCmd=e),this.viewer&&(this.oldManipActive=this.viewer.getManipulators(),this.viewer.setManipulators({activated:!1}),this.viewer.setCursor("Zoom",0))},f.prototype.endPan=function(e){this._forcePan&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forcePan=!1,this._forcePanCmd&&(this._forcePanCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(f.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},f.prototype.endRotate=function(e){this._forceRotate&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceRotate=!1,this._forceRotateCmd&&(this._forceRotateCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(f.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},f.prototype.endZoom=function(e){this._forceZoom&&this.viewer&&this.viewer.setManipulators({activated:this.oldManipActive}),this._forceZoom=!1,this._forceZoomCmd&&(this._forceZoomCmd.end(!0),this.viewer.setCursor("Auto",0),this._changeState(f.State.NONE),this.viewer.trapSelection&&(this.viewer.trapSelection.isInterrupted=!1))},f.prototype._getMouseProjectionOnBall=function(e){var i,r,n,s;let a=.5*this.domElement.clientWidth,o=.5*this.domElement.clientHeight,l=this.radius,h=this.viewer._viewpointManager.getViewpointViewport(this.viewpoint);return h&&(a=h.x+h.width/(2*this.viewer.devicePixelRatio),o=this.domElement.clientHeight-(h.y+h.height/(2*this.viewer.devicePixelRatio)),l=.5*Math.max(h.width,h.height)),(r=(i=new t.Vector3((e.x-a)/l,(o-e.y)/l,0)).length())>1?i.normalize():i.z=Math.sqrt(1-r*r),n=(new t.Vector3).subVectors(this.camera.position,this.target),(s=new t.Vector3).add(this.camera.up.clone().cross(n).setLength(i.x)),s.add(this.camera.up.clone().setLength(i.y)),s.add(n.clone().setLength(i.z)),s},f.prototype._pan=function(e,t){this.update(),this._doPan(e.x-t.x,e.y-t.y)},f.prototype._doPan=function(e,i){var r,n,s;0===e&&0===i||(r=(new t.Vector3).copy(this.camera.position).sub(this.target),this.camera.isOrtho?n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight():(n=2*this.distanceToTarget*Math.tan(.5*this.camera.fov*Math.PI/180)/this.viewer._getDivClientHeight(),this._mode===f.Mode.LOOKAROUND&&(n=-n)),(s=new t.Vector3).add(r.clone().cross(this.camera.up).setLength(n*e)),s.add(this.camera.up.clone().setLength(n*i)),this.target.add(s))},f.prototype._rotate=function(e,i){var r,n,s,a,o;this.update(),r=this._getMouseProjectionOnBall(i),n=this._getMouseProjectionOnBall(e),(s=Math.acos(r.dot(n)/(r.length()*n.length())))&&(a=(new t.Vector3).crossVectors(r,n).normalize(),s*=this.rotateSpeed,o=(new t.Quaternion).setFromAxisAngle(a,-s),this.orientation.multiplyQuaternions(o,this.orientation.clone()))},f.prototype._rotateLockZ=function(e,t){this._rotateLockWorldUpVector(e,t)},f.prototype._getAvatarPositionFromCamera=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.add(t.clone().multiplyScalar(this._avatarDistance))),i},f.prototype._getCameraFromAvatarPosition=function(e,t){var i=e.clone();return this._avatarDistance>0&&e&&(i=i.sub(t.clone().multiplyScalar(this._avatarDistance))),i},f.prototype._turnHeadLockWorldUpVector=function(e,i,r){this.update(),this._stopRotation();var n=this.distanceToTarget,s=this.camera.getLookAt(),a=this.camera.up,o=this.camera.position,l=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(l=new t.Vector3(0,1,0));var h=this.viewpoint.getAngle()*Math.PI/180,c=o.clone();this._getAvatarPositionFromCamera&&(c=this._getAvatarPositionFromCamera(o,s));var d=-e*h/this.viewer.SCREEN_HEIGHT,u=-i*h/this.viewer.SCREEN_HEIGHT;this._invertHeadRotation&&(d=-d,u=-u);var p=new t.Vector3(0,0,0);p.crossVectors(s,a);var f=l.angleTo(a),g=new t.Vector3(0,0,0);g.crossVectors(l,a),g.dot(p)<0&&(f=-f),f+u>Math.PI/2&&(u=Math.PI/2-f),f+u<-Math.PI/2&&(u=-Math.PI/2-f),p.applyAxisAngle(l,d),s.applyAxisAngle(l,d),0!==u&&s.applyAxisAngle(p,u),a.crossVectors(p,s);var m=new t.Vector3(0,0,0);if(m.crossVectors(s,l),m&&m.length()>.1){var v=a.dot(m);m.setLength(v),m.multiplyScalar(-1),a.add(m),a.normalize()}this._getCameraFromAvatarPosition&&(o=this._getCameraFromAvatarPosition(c,s));var _=o.clone().add(s.clone().multiplyScalar(n)),y=new t.Quaternion,S=new t.Matrix4;S.lookAt(o,_,a),y.setFromRotationMatrix(S),this.setTarget(_),this.orientation=y,this.needsRotationFinalized=!0,this.deltaPosition=r.deltaPosition.clone(),this.previousTime>0&&(this.deltaTime=r.currentTime-this.previousTime),this.previousTime=r.currentTime},f.prototype._finalizeTurnHeadLockWorldUpVector=function(e,s){if(this.update(),this._stopRotation(),this.needsRotationFinalized&&(this.needsRotationFinalized=!1,(!this.viewpoint._viewpointAnimation||this.viewpoint._viewpointAnimation.state()!==i.State.RUNNING)&&!this.lockRotation&&(!s||!this.lockTouchRotation)&&(s||!this.lockMouseRotation))){var a=new t.Vector2;a.copy(this.deltaPosition),a.multiplyScalar(1/this.deltaTime);if(!(a.length()<.3)){a.length()>6&&a.setLength(6);var o=this.distanceToTarget,l=this.camera.position,h=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(h=new t.Vector3(0,1,0));var c=this.viewpoint.getAngle()*Math.PI/180,d=this.viewer.SCREEN_HEIGHT,u=new r(0,0,800),p=this.camera.getLookAt(),f=this.camera.up,g=(new t.Quaternion).copy(this.orientation),m=l.clone(),v=l.clone().add(p.clone().multiplyScalar(o)),_=0,y=this;u.setInterpolator(function(e,i,r){var n=m.clone();y._getAvatarPositionFromCamera&&(n=y._getAvatarPositionFromCamera(m,p));var s=a.clone().multiplyScalar(1-e);e*=800;var l=s.x*(e-_),u=s.y*(e-_);_=e;var S=-l*c/d,x=-u*c/d;y._invertHeadRotation&&(S=-S,x=-x);var b=new t.Vector3(0,0,0);b.crossVectors(p,f);var w=h.angleTo(f),M=new t.Vector3(0,0,0);M.crossVectors(h,f),M.dot(b)<0&&(w=-w),w+x>Math.PI/2&&(x=Math.PI/2-w),w+x<-Math.PI/2&&(x=-Math.PI/2-w),b.applyAxisAngle(h,S),p.applyAxisAngle(h,S),0!==x&&p.applyAxisAngle(b,x),f.crossVectors(b,p);var C=new t.Vector3(0,0,0);if(C.crossVectors(p,h),C&&C.length()>.1){var P=f.dot(C);C.setLength(P),C.multiplyScalar(-1),f.add(C),f.normalize()}y._getCameraFromAvatarPosition&&(m=y._getCameraFromAvatarPosition(n,p)),v=m.clone().add(p.clone().multiplyScalar(o));var E=new t.Matrix4;E.lookAt(m,v,f),g.setFromRotationMatrix(E)});var S={me:this,setOrientation:function(e){this.me.setTarget(v),this.me.orientation=g}};this._orientationAnim=new n(S,"setOrientation",u),this._orientationAnim.start()}}},f.prototype._rotateLockWorldUpVector=function(e,t){this.update(),this._stopRotation();var i=this.viewpoint._worldOrientation.upAttribute;if(this._state===f.State.ZOOM_PAN_ROTATE){if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.getLookAt()[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(-this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}else{var r;if(!this.rotateDirection||this._state!==this.lastLockZState)0===(r=+(r=this.camera.up[i]))||isNaN(r)?this.rotateDirection=r:this.rotateDirection=r>0?1:-1;this.orientation=this.viewpoint._worldOrientation.getOrientationForLockedRotation(this.rotateDirection*e*this.lockZRotationSpeed,t*this.lockZRotationSpeed,this.orientation)}this.lastLockZState=this._state,this.needsRotationFinalized=!0},f.prototype._finalizeRotateLockZ=function(e,t){this._finalizeRotateLockWorldUpVector(e,t)},f.prototype._getSpaceSphereCenter=function(){let e=this.viewpoint.viewer.visibleSpace?"visibleSpace":"invisibleSpace";return this.viewpoint.getBoundingSphere(e,void 0).center},f.prototype._rotateAroundPoint=function(e,i){if(!this._rotationAroundPointTarget.isSet)return void(this.lockZ?this._rotateLockWorldUpVector(e.x-i.x,e.y-i.y):this._rotate(e,i));!0===this._showRotationPointOnMove&&this._setRotationPointElem(!0);let r=new t.Vector3,n=new t.Vector3(1,0,0),s=new t.Vector3(0,0,1),a=new t.Vector3;r.copy(this._rotationAroundPointTarget.dim3),n.applyQuaternion(this.camera.quaternion),a.copy(n);let o=(e.x-i.x)*(-1*this._pivotRotateSpeed),l=(e.y-i.y)*(-1*this._pivotRotateSpeed);this._pivot(r,s,o),this._pivot(r,a,l)},f.prototype._pivot=function(e,i,r){let n=new t.Vector3,s=new t.Quaternion,a=new t.Vector3,o=new t.Quaternion;n.copy(this.camera.position),o.copy(this.camera.quaternion),this.camera.useQuaternion=!0,s.setFromAxisAngle(i,r*this._deg2Rad),a.subVectors(n,e),a.copy(a.applyQuaternion(s)),n.addVectors(e,a),this.camera.position.copy(n),this.camera.up=new t.Vector3(0,1,0),this.camera.quaternion.multiplyQuaternions(s,o),this.position.copy(this.camera.position),this.orientation.copy(this.camera.quaternion),this.camera._hasChanged=!0,this.viewpoint.moveTo({eyePosition:this.position,orientation:this.orientation}),this.update()},f.prototype._finalizeRotateLockWorldUpVector=function(e,i){this._stopRotation();var s=this.viewpoint._worldOrientation,a=s.upAttribute;s.frontAttribute,s.rightAttribute;if(this.needsRotationFinalized&&!this.lockRotation&&(!i||!this.lockTouchRotation)&&(i||!this.lockMouseRotation)){var o=e.currentTime-e.startTime,l=new t.Vector2;if(l.copy(e.offsetPosition),l.multiplyScalar(.003/o),!(l.length()<1e-7)){l.length()>.01&&l.setLength(.01);var h=(new t.Quaternion).copy(this.orientation),c=l.clone().normalize().multiplyScalar(6e-6),d=l.length()/c.length(),u=new r(0,0,d),p=0,f=this.camera.up[a];p=0===(f=+f)||isNaN(f)?f:f>0?1:-1,u.setInterpolator(function(e,t,i){e*=d;var r=l.x*e-.5*c.x*e*e,n=l.y*e-.5*c.y*e*e;return s.getOrientationForLockedRotation(p*r,n,h)});var g={me:this,setOrientation:function(e){this.me.orientation=e}};this._orientationAnim=new n(g,"setOrientation",u),this._orientationAnim.start(),this.needsRotationFinalized=!1}}},f.prototype._zoom=function(e,i){var r,n;this.update(),r=e.y-i.y,1!==(n=1+(r*=.5/this.radiusZoom)*this.zoomSpeed)&&n>0&&(this._zoomType===f.ZoomType.ZOOM_FOV_CHANGE?this._zoomFOVChange(new t.Vector2(Math.floor(.5*this.viewer.SCREEN_WIDTH),Math.floor(.5*this.viewer.SCREEN_HEIGHT)),n<1,n):this.distanceToTarget*=n),this.updateNativeZoom(this.distanceToTarget)},f.prototype._zoomPanRotate=function(e,i){this.update(),this._stopRotation();var r=e.getEvents(),n=r[0],s=r[1];if(!(this.lockZoom||i&&1!==i)){var a;a=e.distance-e.lastDistance;var o={gesture:e,factor:h=1-(a*=.5/this.radiusZoom)*this.zoomSpeed,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:o,context:this}),o.defaultBehavior&&1!==h&&h>0){var l=(new t.Vector2).addVectors(n.lastPosition,s.lastPosition).multiplyScalar(.5);if(this._zoomType===f.ZoomType.ZOOM_FOV_CHANGE)this._zoomFOVChange(l,h<1,h);else if(this._mode===f.Mode.LOOKAROUND){var h=this._getZoomFOVOnCursorFactorForTwoPointers(n.currentPosition,s.currentPosition,n.lastPosition,s.lastPosition);this._zoomFOVOnCursor(l,h<0,180*h/Math.PI)}else this._zoomSimple(l,h<1,h)}}if(!(this.lockPan||i&&2!==i)){var c,d=n.getCurrentPosition(this.domElement),u=s.getCurrentPosition(this.domElement),p=n.getLastPosition(this.domElement),g=s.getLastPosition(this.domElement);c=.5*(d.x+u.x)-.5*(p.x+g.x),a=.5*(d.y+u.y)-.5*(p.y+g.y);var m={gesture:e,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:m,context:this}),m.defaultBehavior&&this._doPan(c,a)}if(!(this.lockRotation||this.lockTouchRotation||i&&3!==i||this._mode===f.Mode.LOOKAROUND)){var v={gesture:e,defaultBehavior:!0};if(this._modelEvent.publish({event:"Rotate",data:v,context:this}),v.defaultBehavior)if(this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable)this._rotateLockWorldUpVector(-200*e.getDeltaAngle(),0);else{d=n.getCurrentPosition(this.domElement),u=s.getCurrentPosition(this.domElement),n.getLastPosition(this.domElement),s.getLastPosition(this.domElement);for(var _=new t.Vector2,y=0;y<2;y++)_.add(r[y].getCurrentPosition(this.domElement)),_.add(r[y].getLastPosition(this.domElement));_.divideScalar(4);var S=e.getDeltaAngle();this._rotateTwoTouch(S,_)}}},f.prototype._intersectLines=function(e,i,r,n){var s=new t.Vector2;s.subVectors(i,e);var a=new t.Vector2;a.subVectors(r,n);var o=s.y,l=-s.x,h=s.x*e.y-s.y*e.x,c=a.y,d=-a.x,u=a.x*r.y-a.y*r.x,p=o*d-l*c;if(0===p)return null;var f=(l*u-h*d)/p,g=-(o*u-h*c)/p;return new t.Vector2(f,g)},f.prototype._rotateTwoTouch=function(e,i){this.update();var r=this.viewpoint.create3DRayFrom2DPoint(i).origin;if(Number.isFinite(e)){var n=this.camera.getLookAt();n.negate();var s=(new t.Quaternion).setFromAxisAngle(n,e),a=this.camera.position,o=(new t.Vector3).subVectors(a,r),l=(new t.Vector3).addVectors(r,o.applyQuaternion(s));this.viewpoint.moveTo({eyePosition:l,orientation:s.multiply(this.orientation.clone())})}},f.prototype._zoomSimpleOnCenter=function(e,t,i){var r;r=void 0!==i?i:t?.9:1.1;var n=this.distanceToTarget*r;this.distanceToTarget=n,this.updateNativeZoom(this.distanceToTarget)},f.prototype._zoomSimple=function(e,i,r){var n,s=new t.Projector,a=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1.1;a=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,h=this.target.clone().sub(o.clone().multiplyScalar(this.distanceToTarget*n));let c=a.x,d=a.y,u=this.viewer._viewpointManager.getViewpointViewport(this.viewpoint);if(u){c=(a.xPix-u.x)/u.width*2-1;let e=this.domElement.clientHeight*this.viewer.devicePixelRatio-(u.y+u.height);d=-(a.yPix-e)/u.height*2+1}var p=new t.Vector3(c,d,.5),g=new t.Vector3(c,d,.5);s.unprojectVector(p,this.camera);var m=null;if(this.camera instanceof t.OrthographicCamera)this.camera.setVisualizedHeight(this.distanceToTarget*n),this.updateNativeZoom(this.distanceToTarget*n),s.unprojectVector(g,this.camera),m=p.sub(g);else{var v,_;this.camera.matrixWorld.setPosition(h),s.unprojectVector(g,this.camera),this.camera.matrixWorld.setPosition(l),v=new t.Ray(l,p.clone().sub(l).normalize()),_=new t.Ray(h,g.clone().sub(h).normalize());var y=this.viewpoint.getBoundingSphere(),S=v.at(this.camera.near/v.direction.clone().dot(o)),x=v.direction.clone().dot(y.center.clone().sub(S)),b=Math.max(0,x-y.radius),w=Math.max(0,x+y.radius),M=S.add(v.direction.clone().multiplyScalar(.5*(b+w))),C=o.negate(),P=-C.clone().dot(M),E=new t.Plane(C,P),T=_.intersectPlane(E);m=M.clone().sub(T)}h.add(m);var A=this.distanceToTarget*n;if(this._state===f.State.ZOOM_PAN_ROTATE){var D=this.camera.getLookAt();this.setTarget((new t.Vector3).addVectors(h,D.clone().multiplyScalar(A))),this.distanceToTarget=A,this.update()}else this.viewpoint.moveTo({eyePosition:h,distanceToTarget:A});this.updateNativeZoom(A)},f.prototype._zoomSimpleOnCursor=function(e,i,r){var n;n=void 0!==r?r:i?.9:1.1;var s=this.distanceToTarget*n,a=this.viewer.getMousePosition(e),o=this.camera.getLookAt(),l=this.camera.position,h=new t.Vector3(a.x,a.y,.5),c=new t.Vector3(a.x,a.y,.5),d=new t.Projector;d.unprojectVector(h,this.camera);var u=null;if(this.camera instanceof t.OrthographicCamera){u=this.target.clone().sub(o.clone().multiplyScalar(s)),this.camera.setVisualizedHeight(s),d.unprojectVector(c,this.camera);var p=h.sub(c);u.add(p)}else{p=(new t.Vector3).subVectors(h,l).normalize().multiplyScalar(this.distanceToTarget-s);u=this.camera.position.clone().add(p)}this.viewpoint.moveTo({eyePosition:u,distanceToTarget:s}),this.updateNativeZoom(s)},f.prototype._getZoomFOVAngle=function(e,i){var r=this.viewer.getMousePosition(i),n=this.viewer.getMousePosition(e),s=new t.Vector3(r.x,r.y,.5),a=new t.Vector3(n.x,n.y,.5),o=new t.Projector;o.unprojectVector(s,this.camera),o.unprojectVector(a,this.camera);var l=this.camera.position,h=s.clone().sub(l),c=a.clone().sub(l);return h.angleTo(c)},f.prototype._getZoomFOVOnCursorFactorForOnePointer=function(e,t){var i=e,r=t;i.x=r.x;var n=this._getZoomFOVAngle(i,r);return r.y<i.y&&(n=-n),2*n},f.prototype._getZoomFOVOnCursorFactorForTwoPointers=function(e,t,i,r){var n=this._getZoomFOVAngle(r,i);return this._getZoomFOVAngle(t,e)-n},f.prototype._zoomFOVOnCursor=function(e,i,r){var n=4;n=void 0!==r?-r:i?-n:n;var s=null;e&&(s=this.viewer.getMousePosition(e));var a=this.distanceToTarget,o=this.camera.getLookAt(),l=this.camera.position,h=this.camera.up,c=new t.Vector3(0,0,1);"y"===this.viewpoint.getWorldOrientation().upAttribute&&(c=new t.Vector3(0,1,0));var d=this.viewer.SCREEN_WIDTH,u=this.viewer.SCREEN_HEIGHT,p=this.viewpoint.getAngle(),f=null;if(!(p>=100&&n>=0||p<=20&&n<=0)){if((f=p+n)>100?f=100:f<20&&(f=20),s){var g=.03*n,m=.03*n*u/d,v=s.x/2*g,_=-s.y/2*m,y=new t.Vector3(0,0,0);y.crossVectors(o,h);var S=c.angleTo(h),x=new t.Vector3(0,0,0);x.crossVectors(c,h),x.dot(y)<0&&(S=-S),S+_>Math.PI/2&&(_=Math.PI/2-S),S+_<-Math.PI/2&&(_=-Math.PI/2-S),y.applyAxisAngle(c,v),o.applyAxisAngle(c,v),0!==_&&o.applyAxisAngle(y,_),h.crossVectors(y,o)}var b=new t.Vector3(0,0,0);if(b.crossVectors(o,c),b&&b.length()>.1){var w=h.dot(b);b.setLength(w),b.multiplyScalar(-1),h.add(b),h.normalize()}var M=l.clone().add(o.clone().multiplyScalar(a)),C=new t.Quaternion,P=new t.Matrix4;P.lookAt(l,M,h),C.setFromRotationMatrix(P),s&&(this.setTarget(M),this.orientation=C),this.viewpoint.setAngle(f),this.camera.updateProjectionMatrix(),this.camera._hasChanged=!0}},f.prototype._zoomFOVChange=function(e,i,r){var n,s=new t.Projector,a=this.viewer.getMousePosition(e);n=void 0!==r?r:i?.9:1/.9;a=this.viewer.getMousePosition(e);var o=this.camera.getLookAt(),l=this.camera.position,h=l.clone(),c=new t.Vector3(a.x,a.y,.5),d=new t.Vector3(a.x,a.y,.5);s.unprojectVector(c,this.camera);var u,p,f,g,m=this.viewpoint.getBoundingSphere(),v=this.viewpoint.getAngle()/2,_=o.clone().dot(m.center.clone().sub(l)),y=2*m.radius;if(_<y){var S=y-_,x=o.clone().multiplyScalar(-S),b=Math.tan(t.Math.degToRad(.5*this.viewpoint.getAngle())),w=t.Math.radToDeg(Math.atan(b*Math.abs(_)/y));(w>22.5||w<0)&&(w=22.5),l.add(x),h=l.clone(),v=w,this.viewpoint.setAngle(2*w),this.camera.updateProjectionMatrix(),_=y}if(i){E=v*n;var M=n;if(_>y){var C=_-y,P=y/_;if(P<n)C=_-_*n,M=1;else M=E/(v*P);C>0&&h.add(o.clone().multiplyScalar(C))}if(1!=M){let e=M*v*2;this.viewpoint.setAngle(e),this.camera.updateProjectionMatrix()}}else{var E,T=1;if(v<22.5)(E=v*n)>22.5?(this.viewpoint.setAngle(45),T=E/22.5):this.viewpoint.setAngle(2*E),this.camera.updateProjectionMatrix();else T=n;if(1!=T){var A=T*_;x=o.clone().multiplyScalar(_-A);h.add(x)}}g=this.target.clone().sub(h).length(),this.camera.matrixWorld.setPosition(h),s.unprojectVector(d,this.camera),this.camera.matrixWorld.setPosition(l),p=new t.Ray(l,c.clone().sub(l).normalize()),f=new t.Ray(h,d.clone().sub(h).normalize());var D=p.at(this.camera.near/p.direction.clone().dot(o)),I=p.direction.clone().dot(m.center.clone().sub(D)),R=Math.max(0,I-m.radius),O=Math.max(0,I+m.radius),L=D.add(p.direction.clone().multiplyScalar(.5*(R+O))),V=o.negate(),F=-V.clone().dot(L),B=new t.Plane(V,F),N=f.intersectPlane(B);u=L.clone().sub(N),h.add(u),this.viewpoint.setAngle(Math.max(Math.min(this.viewpoint.getAngle(),45),this._FOVZoomMinAngle)),this.camera instanceof t.OrthographicCamera&&this.camera.setVisualizedHeight(g),this.camera._hasChanged=!0,this.viewpoint.moveTo({eyePosition:h,distanceToTarget:g})},f.prototype._mouseWheel=function(e){if(this.lockMouseWheel)return;e.event.preventDefault();var t=UWA.Event.wheelDelta(e.getJSEvent());this.isMac&&(t*=-1);var i={evt:e,factor:t,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:i,context:this}),!this.isCurrentViewpoint())return;var r=this;this._wheelMoving=!0,this._wheelTimer&&clearTimeout(this._wheelTimer),this._wheelTimer=setTimeout(function(){r._wheelMoving=!1,clearTimeout(r._wheelTimer),r._wheelTimer=null},300);let n=this._isFromTrackPad(e.getJSEvent());if(0<=n){if(!this._onTrackPadDragTwoFingers(e)){let e=2==n;return e||(e=1==n),void(this._trackPadData.autoState!=e&&(this._trackPadData.fAutoCb&&this._trackPadData.fAutoCb(e),this._trackPadData.autoState=e))}}else 0!=this._trackPadData.autoState&&(this._trackPadData.fAutoCb&&this._trackPadData.fAutoCb(!1),this._trackPadData.autoState=!1);if(i.defaultBehavior){var s=!1;if(this.lockMouseZoomForCtrlKeyWheelMode){var a=e.getJSEvent();a&&!0===a.ctrlKey&&(s=!0)}this._zoomType===f.ZoomType.ZOOM_FOV_CHANGE?!this.lockZoom&&!s&&this._zoomFOVChange(e.getCurrentPosition(this.domElement),t>0):this._mode===f.Mode.LOOKAROUND?!this.lockZoom&&!s&&this._zoomFOVOnCursor(e.getCurrentPosition(this.domElement),t>0):!this.lockZoom&&!s&&this._zoomSimple(e.getCurrentPosition(this.domElement),t>0)}},f.prototype._resize=function(e,t){this.radius=.5*Math.max(e,t),this.radiusZoom=.25*(e+t)},f.prototype._stopRotation=function(e){this._orientationAnim&&this._orientationAnim.stop()},f.prototype._changeState=function(e){var t=this._state;switch(this._state===f.State.NONE&&(this._oldCursor=this.viewer.getCursor()),this.rotateDirection=0,this._state=e,e){case f.State.ZOOM:case f.State.FORCE_ZOOM:!this.lockZoom&&this.viewer.setCursor("Zoom",100);break;case f.State.PAN:case f.State.FORCE_PAN:!this.lockPan&&this.viewer.setCursor("Pan",100);break;case f.State.ROTATE:case f.State.FORCE_ROTATE:if(!this.lockRotation&&!this.lockMouseRotation&&!this.lockTouchRotation){this.viewer.setCursor("Rotate",100),!0===this._rotationAroundPoint&&!1===this._rotationAroundPointTarget.isShown&&!0===this._retieveRotationPointTarget()&&(this._showRotationPointOnMove=!0);break}case f.State.HOLD:break;default:this.viewer.setCursor(this._oldCursor,0,!0),this._setRotationPointElem(!1)}if(this.viewpoint){var i=e!==f.State.NONE&&e!==f.State.HOLD&&e!==f.State.STOP;if(this.viewpoint._isMoving===i)return;this.viewpoint._isMoving=i;var r={eventChannel:"/VISU/",eventType:i?"@onViewpointBeginMove":"@onViewpointEndMove",viewpoint:this.viewpoint,cameraEye:this.viewpoint.camera.position,cameraUp:this.viewpoint.camera.up,from:"controller"};s.publish({event:"/VISU/",data:r})}!d.isRecording()||this._state!==f.State.NONE||this._state===t||this.isLeftClick()||this.isRightClick()||(window.WebVisuCurrentGesture.highLevelRecordJSON||(window.WebVisuCurrentGesture.highLevelRecordJSON={}),window.WebVisuCurrentGesture.highLevelRecordJSON.TrackBallControls={name:this._recordRegisterName,setViewPoint:this.positionToJSON()})},f.prototype._onBasicEvent=function(e){if(e.from)for(var t=0;t<e.from.length;t++){var i=e.from[t],r=i.getType(),n=i.getState();if("Keyboard"===r){var s=i.getKey();if(n===l.State.BEGIN){if(s===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!0),s===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!0,this._mode>0)(a=o._getGesture(document,"onEdit"))&&a.setTimerMouse(0);this._mode>0?this._ctrlKeyPressed&&this._state===f.State.ROTATE&&this._changeState(f.State.FORCE_PAN):this._middleButtonPressed&&this._ctrlKeyPressed&&!this.lockNativeBehaviorOnMouseMiddleTriggers&&setTimeout((e,t,i,r)=>{e._middleButtonPressed&&(e._ctrlKeyPressed?e._changeState(i):e._changeState(r))},150,this,i,f.State.ROTATE,f.State.ZOOM)}else if(n===l.State.END){var a;if(s===l.KeyboardKey.CTRL&&(this._ctrlKeyPressed=!1),s===l.KeyboardKey.SHIFT)if(this._shiftKeyPressed=!1,this._mode>0)(a=o._getGesture(document,"onEdit"))&&a.setTimerMouse(o.getHoldTime());this._mode>0?this._ctrlKeyPressed||this._state!==f.State.PAN||this.isCurrentViewpoint()&&this._changeState(f.State.ROTATE):this._middleButtonPressed&&s===l.KeyboardKey.CTRL&&!this.lockNativeBehaviorOnMouseMiddleTriggers&&this._changeState(f.State.ZOOM)}o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this,"TrackballControls","UpdateControlKeys",{ctrl:this._ctrlKeyPressed,shift:this._shiftKeyPressed})}else if("Mouse"===r){if(this.lockMouse)continue;var h=i.button;if(n===l.State.BEGIN){var c=!1;if(h!==l.MouseButton.MIDDLE&&h!==l.MouseButton.WHEEL||!i.isInView(this.manipulatedViewList)||(c=!0,i.getJSEvent().stopPropagation&&i.getJSEvent().stopPropagation()),h===l.MouseButton.WHEEL&&this._mode>0&&i.isInView(this.manipulatedViewList)&&this._state!==f.State.STOP&&this._mouseWheel(i),!c||h===l.MouseButton.WHEEL&&this._mode===f.Mode.CATIA){if(c&&!this.lockPreventDefaultForCtrlKeyWheel&&h===l.MouseButton.WHEEL){var d=i.getJSEvent();d&&!0===d.ctrlKey&&UWA.Event.preventDefault(i.getJSEvent())}}else UWA.Event.preventDefault(i.getJSEvent())}else n===l.State.MOVE&&i.offsetPosition.length()>this._clickTolerancy&&(h===l.MouseButton.LEFT&&this._leftButtonPressed&&(this._leftClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelLeftClick"),this.resetLeftClick()),h===l.MouseButton.MIDDLE&&this._middleButtonPressed&&(this._middleClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelMiddleClick"),this._middleClicking=!1),h===l.MouseButton.RIGHT&&this._rightButtonPressed&&(this._rightClicking&&o.RecordEventsManager&&o.RecordEventsManager.recordSpecialEvent(this.viewer,"TrackballControls","TrackballControlCancelRightClick"),this._rightClicking=!1))}}},f.prototype._onEditEventBegin=function(e){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){var i=t instanceof h;if(this._mode>0||i){var r=t.getCurrentPosition(this.domElement),n=i?80:40;this._setPositionSpinner(this.ShortHoldSpinner,r,n),this._shortHoldCircleAnim=this._showSpinner(this.ShortHoldSpinner,this.SVGCircle,n,6)}}},f.prototype._onEditEventKO=function(e){this._hideSpinner(this.ShortHoldSpinner,this._shortHoldCircleAnim)},f.prototype._onLeftMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}var r=t.isInView(this.manipulatedViewList);if(this._publishWUXEvent("PrimaryPointerDown",e,!1),this._leftButtonPressed=!0,this.startLeftClick(),this.isCurrentViewpoint()){this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas));var n=this._forcePan||this._forceRotate||this._forceZoom;this._state===f.State.STOP||this._state===f.State.HOLD&&!n?this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&this.viewer.leftMouseDownCB(t,this):(r&&n&&(this._state===f.State.NONE||this._state===f.State.HOLD)?(this._setCapture(),this._forcePan?this._changeState(f.State.FORCE_PAN):this._forceRotate?this._changeState(f.State.FORCE_ROTATE):this._forceZoom&&this._changeState(f.State.FORCE_ZOOM)):this._2DMode&&this._mode>0?r&&(this._setCapture(),this._changeState(f.State.PAN)):this._mode===f.Mode.SIMPLE?r&&!this.lockMouseRotationForSimpleMode&&(this._setCapture(),this._changeState(f.State.ROTATE)):this._mode===f.Mode.LOOKAROUND?r&&(this._setCapture(),this._changeState(f.State.ROTATE)):(this._state!==f.State.PAN&&this._state!==f.State.ZOOM||(r&&this._setCapture(),this._changeState(f.State.ROTATE)),this._mode===f.Mode.CATIA&&this.viewer.trapSelection&&this.viewer.trapSelection.interrupt(),this._mode!==f.Mode.COMBINED||!r||this.lockRotation||this.lockMouseRotationForSimpleMode||(this._setCapture(),this._changeState(f.State.ROTATE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseDownCB&&(this.viewer.leftMouseDownCB(t,this),this.viewer.trapSelection&&n&&this.viewer.trapSelection.softInterrupt()),this.tagEventIfModeNotNONE(e))}}}},f.prototype._onMiddleMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._middleButtonPressed=!0,this._middleClicking=!0,this.isCurrentViewpoint()&&(this._state!==f.State.STOP&&this._state!==f.State.HOLD?(this._mode>0?this._changeState(f.State.PAN):this._state===f.State.NONE&&(this._leftButtonPressed||this._rightButtonPressed||(this._ctrlKeyPressed&&!this.lockNativeBehaviorOnMouseMiddleTriggers?this._changeState(f.State.ZOOM):this._changeState(f.State.PAN))),this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.centerMouseDownCB&&this.viewer.centerMouseDownCB(t,this))}}},f.prototype._onRightMouseDown=function(e){if(!this.handleRecordData(e)&&!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}t.isInView(this.manipulatedViewList)&&this._setCapture(),this._rightClicking=!0,this._rightButtonPressed=!0,this.isCurrentViewpoint()&&(this._rotationAroundPoint&&this._middleButtonPressed&&(this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas))),this._state!==f.State.STOP&&this._state!==f.State.HOLD&&(this._mode===f.Mode.LOOKAROUND?this._changeState(f.State.ZOOM):this._mode>0&&this._state===f.State.NONE?t.isInView(this.manipulatedViewList)&&this._changeState(f.State.ZOOM):this._state!==f.State.PAN&&this._state!==f.State.ZOOM||this._changeState(f.State.ROTATE),this.tagEventIfModeNotNONE(e)))}}},f.prototype._onLeftMouseUp=function(e){if(this.handleRecordData(e))return this._leftButtonPressed=!1,void(this._mouseDownPos=null);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._publishWUXEvent("PrimaryPointerUp",e,!1),this._leftButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===f.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),void this.resetLeftClick();this._state===f.State.FORCE_PAN||this._state===f.State.FORCE_ROTATE||this._state===f.State.FORCE_ZOOM?this._changeState(f.State.NONE):this._mode===f.Mode.SIMPLE?this._changeState(f.State.NONE):this._2DMode&&this._mode===f.Mode.COMBINED?this._changeState(f.State.NONE):this._state===f.State.HOLD?this._changeState(f.State.NONE):this._state===f.State.ROTATE&&(this._mode===f.Mode.CATIA||this._mode===f.Mode.COMBINED&&this._middleButtonPressed?this._rightButtonPressed||this._changeState(f.State.ZOOM):(this._mode===f.Mode.LOOKAROUND?this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this._finalizeTurnHeadLockWorldUpVector&&this._finalizeTurnHeadLockWorldUpVector(t,!1):this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(f.State.NONE))),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this._mouseDownPos=null,this.tagEventIfModeNotNONE(e)}else this.resetLeftClick()}}},f.prototype._onMiddleMouseUp=function(e){if(this.handleRecordData(e))return this._middleButtonPressed=!1,void(this._middleClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}this._releaseCapture();var r=t.isInView(this.manipulatedViewList);if(this._middleButtonPressed=!1,this.isCurrentViewpoint()){if(t.currentTime-t.startTime>300&&(this._middleClicking=!1),this._state===f.State.STOP)return r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),void(this._middleClicking=!1);this._changeState(f.State.NONE),r&&this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e)}else this._middleClicking=!1}}},f.prototype._onRightMouseUp=function(e){if(this.handleRecordData(e))return this._rightButtonPressed=!1,void(this._rightClicking=!1);if(!this.lockMouse){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t){if(this._isIE11){var i=t.getJSEvent();i&&void 0!==i.ctrlKey&&(this._ctrlKeyPressed=i.ctrlKey)}if(this._releaseCapture(),this._rightButtonPressed=!1,this.isCurrentViewpoint()){if(this._state===f.State.STOP)return this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),void(this._rightClicking=!1);this._mode>0&&this._state===f.State.ZOOM?this._changeState(f.State.NONE):this._state===f.State.HOLD?this._changeState(f.State.NONE):this._state===f.State.ROTATE&&(this._mode===f.Mode.CATIA||this._mode===f.Mode.COMBINED&&this._middleButtonPressed?this._leftButtonPressed||this._changeState(f.State.ZOOM):(this.mouseInertia&&!this.lockMouseRotationForSimpleMode&&this.lockZ&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!1),this._changeState(f.State.NONE),this.endRotate())),this._pickingCB&&this.viewer&&this.viewer.rightMouseUpCB&&this.viewer.rightMouseUpCB(t,this),this._rightClicking=!1,this.tagEventIfModeNotNONE(e)}else this._rightClicking=!1}}},f.prototype._onMouseMove=function(e){if(this.handleRecordData(e))return;if(this.lockMouse)return;var t=e.from&&e.from.length?e.from[0]:null;if(null===t)return;let i=2==this._isFromTrackPad(t.getJSEvent());if(this._trackPadData.autoState!=i&&(this._trackPadData.fAutoCb&&this._trackPadData.fAutoCb(i),this._trackPadData.autoState=i),this._state===f.State.STOP||this._state===f.State.NONE||t.event._simul||0!==t.event.buttons||this._changeState(f.State.NONE),this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint()){if(this._state!==f.State.STOP&&this._state!==f.State.HOLD){for(var r=t.getCurrentPosition(this.domElement),n=t.getLastPosition(this.domElement),s=0;s<e.from.length;s++){var a=e.from[s];if(a.getButton&&a.getButton()!==l.MouseButton.NONE){r=a.getCurrentPosition(this.domElement),n=a.getLastPosition(this.domElement);break}}if(!d.isReplaying())if(this.lockPan||this._state!==f.State.PAN&&this._state!==f.State.FORCE_PAN)if(this.lockRotation||this.lockMouseRotation||this._state!==f.State.ROTATE&&this._state!==f.State.FORCE_ROTATE){if(!this.lockZoom&&(this._state===f.State.ZOOM||this._state===f.State.FORCE_ZOOM)){var o={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:o,context:this}),o.defaultBehavior)if(this._mode===f.Mode.LOOKAROUND){var h=this._getZoomFOVOnCursorFactorForOnePointer(r,n);this._zoomFOVOnCursor(null,h<0,180*h/Math.PI)}else this._zoom(r,n)}}else{var c={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:c,context:this}),c.defaultBehavior&&(this._mode===f.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(r.x-n.x,r.y-n.y,t):this._rotationAroundPoint?this._rotateAroundPoint(r,n):this.lockZ?this._rotateLockWorldUpVector(r.x-n.x,r.y-n.y):this._rotate(r,n))}else{var u={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:u,context:this}),u.defaultBehavior&&this._pan(r,n)}this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this.tagEventIfModeNotNONE(e)}else this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this)}},f.prototype._onMouseOut=function(e){if(!this.handleRecordData(e)&&!this.lockMouse&&(this._leftButtonPressed=!1,this._rightButtonPressed=!1,this._middleButtonPressed=!1,this.isCurrentViewpoint())){var t=e.from&&e.from.length?e.from[0]:null;if(t){var i=t.getJSEvent(),r=i.target;if(r||(r=i.srcElement),r!==this.viewer.canvas)return;for(var n=i.toElement;n;){if(n===this.viewer.divCssElement)return;n=n.parentNode}}this._state!==f.State.STOP&&this._changeState(f.State.NONE),this.tagEventIfModeNotNONE(e)}},f.prototype._onTrackPadDragTwoFingers=function(e){var i=e?e.getJSEvent():null;if(!i)return!1;if(i.ctrlKey)return!0;var r=this;let n=0,s=0,a=1;return r._trackPadData&&r._trackPadData.scrollDir?a=r._trackPadData.scrollDir:this.isMac&&(a=-1),"DOMMouseScroll"==i.type||("mousewheel"!=i.type&&"wheel"!=i.type||(n=i.deltaX*a,s=i.deltaY*a),i.shiftKey&&0===n&&([n,s]=[s,n]),i.deltaMode===WheelEvent.DOM_DELTA_LINE?(n*=8,s*=8):i.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(n*=24,s*=24),r._trackPadData.isActive?(r._trackPadData.postion.x=r._trackPadData.positionPrev.x+n,r._trackPadData.postion.y=r._trackPadData.positionPrev.y+s,r._pan(r._trackPadData.postion,r._trackPadData.positionPrev),r._trackPadData.positionPrev.x=r._trackPadData.postion.x,r._trackPadData.positionPrev.y=r._trackPadData.postion.y,clearTimeout(this._DummyTimer),this._DummyTimer=setTimeout(function(){r.endPan(),r._trackPadData.isActive=!1},100)):(r._trackPadData.postion||(r._trackPadData.postion=new t.Vector2(0,0)),r._trackPadData.postion.x=i.x+n,r._trackPadData.postion.y=i.y+s,r._trackPadData.positionPrev||(r._trackPadData.positionPrev=new t.Vector2(0,0),r._trackPadData.positionPrev.x=r._trackPadData.postion.x,r._trackPadData.positionPrev.y=r._trackPadData.postion.y),r._trackPadData.dummycmd||(r._trackPadData.dummycmd={end:function(e){}}),r.startPan(r._trackPadData.dummycmd),r._trackPadData.isActive=!0),!1)},f.prototype.setTrackPadSupport=function(e,t=null,i=null){this.isCurrentViewpoint()&&this.viewpoint&&"COMBINED"==this.viewpoint.getDefaultController()&&(this._trackPadData.isOnOffAuto=this._panWithTrackPadSupport(e),t&&"number"==typeof t&&(this._trackPadData.scrollDir=t),(this._trackPadData.fAutoCb=i)&&this._trackPadData.fAutoCb(this._trackPadData.isActive))},f.prototype._onSwipe=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;if(null!==t&&(this._publishWUXEvent("PrimaryPointerMove",e,!0),this.isCurrentViewpoint()&&(this._pickingCB&&this.viewer&&this.viewer.mouseMoveCB&&this.viewer.mouseMoveCB(t,this),this._state!==f.State.STOP&&this._state!==f.State.HOLD))){var i=t.currentPosition,r=t.lastPosition;if(this.lockPan||this._state!==f.State.FORCE_PAN)if(this.lockRotation||this.lockTouchRotation||this._state!==f.State.ROTATE&&this._state!==f.State.FORCE_ROTATE){if(!this.lockZoom&&this._state===f.State.FORCE_ZOOM){var n={gesture:e.gesture,defaultBehavior:!0};if(this._modelEvent.publish({event:"Zoom",data:n,context:this}),n.defaultBehavior)if(this._mode===f.Mode.LOOKAROUND){var s=this._getZoomFOVOnCursorFactorForOnePointer(i,r);this._zoomFOVOnCursor(null,s<0,180*s/Math.PI)}else this._zoom(i,r)}}else{var a={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Rotate",data:a,context:this}),a.defaultBehavior&&(this._mode===f.Mode.LOOKAROUND?this._turnHeadLockWorldUpVector(i.x-r.x,i.y-r.y,t):this._rotationAroundPoint?this._rotateAroundPoint(i,r):this.rollingForTouchAvailable&&this.lockZ||!this.rollingForTouchAvailable?this._rotateLockWorldUpVector(i.x-r.x,i.y-r.y):this._rotate(i,r))}else{var o={gesture:e.gesture,defaultBehavior:!0};this._modelEvent.publish({event:"Pan",data:o,context:this}),o.defaultBehavior&&this._pan(i,r)}this.tagEventIfModeNotNONE(e)}}},f.prototype._onTap=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this.startLeftClick(),this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this.resetLeftClick(),this.tagEventIfModeNotNONE(e))}},f.prototype._onDoubleTap=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&this.isCurrentViewpoint()&&(this._middleClicking=!0,this._pickingCB&&this.viewer&&this.viewer.centerMouseUpCB&&this.viewer.centerMouseUpCB(t,this),this._middleClicking=!1,this.tagEventIfModeNotNONE(e))}},f.prototype._onDoublePinchTap=function(e){if(!this.handleRecordData(e)&&!this.lockReframe){var t=e.gesture.getEvents();if(t.length&&this.isCurrentViewpoint()&&this._state!==f.State.STOP){this._stopRotation();var i=this.viewer.getMousePosition(t[0].currentPosition),r=this.viewer.pick(i,"mesh",!1),n=null;if(r.length){var s=r.path[0]._getRenderableOccurrences();s.length&&(n=s[0])}this.viewpoint.reframe(null,void 0,n),this.tagEventIfModeNotNONE(e)}}},f.prototype._onHold=function(e){this.handleRecordData(e)||this.isCurrentViewpoint()&&((2===o.debugEvents||o.debugEvents>=4)&&console.log(data),this.tagEventIfModeNotNONE(e))},f.prototype._onStopManip=function(e){this.handleRecordData(e)||this._blockVptOnHold&&this.isCurrentViewpoint()&&(this._state!==f.State.STOP&&this._state!==f.State.FORCE_PAN&&this._state!==f.State.FORCE_ZOOM&&this._state!==f.State.FORCE_ROTATE&&this._changeState(f.State.HOLD),this.tagEventIfModeNotNONE(e))},f.prototype._onPinchPanRotate=function(e,t){if(!this.handleRecordData(e)){var i=e.gesture;this.isCurrentViewpoint()&&this._state!==f.State.HOLD&&this._state!==f.State.STOP&&"end"!==e.state&&(this._changeState(f.State.ZOOM_PAN_ROTATE),this._zoomPanRotate(i,t),this.tagEventIfModeNotNONE(e))}},f.prototype._onTouch=function(e){if(!this.handleRecordData(e)&&(this._publishWUXEvent("PrimaryPointerDown",e,!1),this.isCurrentViewpoint()&&this._state!==f.State.HOLD&&this._state!==f.State.STOP)){if(this._rotationAroundPoint){let t=e.from&&e.from.length?e.from[0]:null;t&&(this._mouseDownPos=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas)),this._touchPos={xPix:t.currentPosition.x,yPix:t.currentPosition.y})}this._forcePan?this._changeState(f.State.FORCE_PAN):this._forceRotate?this._changeState(f.State.FORCE_ROTATE):this._forceZoom?this._changeState(f.State.FORCE_ZOOM):this.lockRotation||this.lockTouchRotation||this._changeState(f.State.ROTATE),this.tagEventIfModeNotNONE(e)}},f.prototype._onRelease=function(e){if(!this.handleRecordData(e)){var t=e.from&&e.from.length?e.from[0]:null;null!==t&&(this._publishWUXEvent("PrimaryPointerUp",e,!1),this.isCurrentViewpoint()&&(this._state!==f.State.STOP?(this._state!==f.State.ROTATE&&this._state!==f.State.ZOOM_PAN_ROTATE||(this._mode===f.Mode.LOOKAROUND?this._finalizeTurnHeadLockWorldUpVector(t,!0):this.touchInertia&&this._finalizeRotateLockWorldUpVector&&this._finalizeRotateLockWorldUpVector(t,!0)),this._state===f.State.HOLD&&this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this),this._rotationAroundPoint&&(this._mouseDownPos=null,this._touchPos=null),this._changeState(f.State.NONE),this.tagEventIfModeNotNONE(e)):this._pickingCB&&this.viewer&&this.viewer.leftMouseUpCB&&this.viewer.leftMouseUpCB(t,this)))}},f.prototype._publishWUXEvent=function(e,t,i){var r={eventChannel:"/VISU/",eventType:"@on"+e,eventID:"",from:t.from};s.publish({event:"/VISU/on"+e,data:r}),(!i&&(2===o.debugEvents||o.debugEvents>=4)||i&&o.debugEvents>=3)&&console.log(r)},f.prototype._createShortHoldSpinner=function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("id","svgNode"),i.style.position="absolute",i.style.top=0,i.style.left=0,i.style.right=0,i.style.bottom=0,i.style.setProperty("pointer-events","none"),i.style.setProperty("z-index",1e4);var r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id","svgCircle"),r.setAttribute("fill","none"),r.style.fill="none",r.style.stroke=t,r.style.setProperty("stroke-linecap","square"),e?(this.SVGCircle=r,this.ShortHoldSpinner=i):(this.SVGCircleLarge=r,this.ShortHoldSpinnerLarge=i),i.appendChild(r),this.viewer.div.appendChild(i)},f.prototype._showSpinner=function(e,t,i,r){var s=i-.5*r;e.style.display="block",e.setAttribute("width",2*i+"px"),e.setAttribute("height",2*i+"px"),t.setAttribute("cx",i),t.setAttribute("cy",i),t.setAttribute("r",s),t.setAttribute("transform","rotate(-90, "+i+","+i+")"),t.style.setProperty("stroke-width",r),t.style.setProperty("stroke-dasharray",2*Math.PI*s+1),t.style.setProperty("stroke-dashoffset",2*Math.PI*s+1);var a=!0,l=2*Math.PI*s+1,h=new n({circle:t,setOffset:function(t){t===l?a&&(e.style.display="none",a=!1):(a||(e.style.display="block",a=!0),this.circle.style.setProperty("stroke-dashoffset",t))}},"setOffset",new function(e,t,i,r,n){this._nbLoops=1,this._duration=i,this.duration=function(){return this._duration},this.valueAt=function(i){var s=this._duration,a=i%s/s;if(a>=0&&a<r)return e;if(a<1-n){var o=(a-r)/(1-r-n);return e*(1-o)+t*o}return t}}(l,0,1.2*o.getHoldTime(),.6,0));return h.start(),h},f.prototype._hideSpinner=function(e,t){t&&t.stop(),e.style.display="none"},f.prototype._setPositionSpinner=function(e,t,i){e.style.left=t.x-i+"px",e.style.top=t.y-i+"px"},f.prototype._createRotationPointElem=function(){let e=document.createElement("div");e.setAttribute("id","rotationPoint"),e.setAttribute("style","background: #ff0000;  border-radius: 50%;  width: 6px;  height: 6px;  position: absolute;  left: 50%;  top: 50%;  opacity: 1;  box-shadow: 0 0 2px 2px #f8f8ff;"),e.style.setProperty("pointer-events","none"),this.rotationPointElem=e,this.viewer.div.appendChild(e),this._hideRotationPointElem()},f.prototype._showRotationPointElem=function(){this.rotationPointElem&&(this.rotationPointElem.style.display="block",this._rotationAroundPointTarget.isShown=!0,this._showRotationPointOnMove=!1)},f.prototype._hideRotationPointElem=function(){this.rotationPointElem&&(this.rotationPointElem.style.display="none",this._rotationAroundPointTarget.isShown=!1,this._showRotationPointOnMove=!1)},f.prototype._retieveRotationPointTarget=function(){if(!this.rotationPointElem||!this._mouseDownPos)return;this._rotationAroundPointTarget.dim2=this._mouseDownPos;let e=this.viewer.pick(this._rotationAroundPointTarget.dim2,"mesh",!0);if(e&&e.path.length>0&&e.position){this._rotationAroundPointTarget.dim3=e.position,this._rotationAroundPointTarget.isSet=!0;let t=this._touchPos?this._touchPos.xPix:this._rotationAroundPointTarget.dim2.xPix,i=this._touchPos?this._touchPos.yPix:this._rotationAroundPointTarget.dim2.yPix;this.rotationPointElem.style.left=t-parseInt(this.rotationPointElem.style.width)/2+"px",this.rotationPointElem.style.top=i-parseInt(this.rotationPointElem.style.height)/2+"px"}else this._rotationAroundPointTarget.isSet=!1,this._rotationAroundPointTarget.dim3=null;return this._rotationAroundPointTarget.isSet},f.prototype._setRotationPointElem=function(e){!0===e?this._showRotationPointElem():this._hideRotationPointElem()},f.prototype._setCursor=function(t){var i="auto";if("Auto"!==t){var r=e.getWebappsAssetUrl("Visualization","")+"icons/";i="url('"+r+"WebViewer"+t+".png'), url('"+r+"WebViewer"+t+".cur'), auto"}this.viewer.canvas.style.cursor=i},f.prototype.tagEventIfModeNotNONE=function(e){d.isRecording()&&this._state!==f.State.NONE&&e.gesture&&(e.gesture.highLevelRecordJSON||(e.gesture.highLevelRecordJSON={}),e.gesture.highLevelRecordJSON.TrackBallControls={ignore:!0})},f.prototype.handleRecordData=function(e){if(d.isReplaying()&&this.testRecordMoveViewpoint(e))return!0},f.prototype.getRecordData=function(e,t){var i=e.gesture&&e.gesture.highLevelRecordJSON&&e.gesture.highLevelRecordJSON.TrackBallControls;return i&&(!i.name||i.name===this._recordRegisterName)&&i[t]},f.prototype.testRecordMoveViewpoint=function(e){if(this.getRecordData(e,"setViewPoint")){var t=this.getRecordData(e,"setViewPoint");return this.setPositionFromJSON(t),this.viewer.render(),!0}return!1},f.prototype.positionToJSON=function(){return{target:this.target.createJSON(),orientation:this.orientation.createJSON(),distanceToTarget:this.distanceToTarget}},f.prototype.setPositionFromJSON=function(e){this.target.setFromJSON(e.target),this.orientation.setFromJSON(e.orientation),this.distanceToTarget=e.distanceToTarget},f.prototype.setFlyWalkState=function(e){e?(this._flyWalkStateInfo.oldControlState=this._state,this._flyWalkStateInfo.forceStopRequests||this._changeState(f.State.STOP)):this._flyWalkStateInfo.bActive&&this._changeState(this._flyWalkStateInfo.oldControlState),this._flyWalkStateInfo.bActive=!!e},f.prototype.setForceFlyWalkState=function(e){e?(this._flyWalkStateInfo.forceStopRequests++,this._flyWalkStateInfo.bActive&&1===this._flyWalkStateInfo.forceStopRequests&&this._changeState(this._flyWalkStateInfo.oldControlState)):(this._flyWalkStateInfo.forceStopRequests--,this._flyWalkStateInfo.bActive&&!this._flyWalkStateInfo.forceStopRequests&&(this._flyWalkStateInfo.oldControlState=this._state,this._changeState(f.State.STOP)))},f.prototype.isFlyWalkForcedStop=function(){return this._flyWalkStateInfo.forceStopRequests>0},f.prototype.getFlyWalkStateInfo=function(){return this._flyWalkStateInfo},f.prototype._switchCanvas=function(e){var t=this.domElement;t.removeEventListener("contextmenu",this._onContextMenu,!1),t.removeEventListener("dragover",this._onDragCB),this.removeViewFromManipulation(t),o.removeEvent(t,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(t,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(t,"onHold",this._onHoldCB),o.removeEvent(t,"onDoubleTap",this._onDoubleTapCB),o.removeEvent(t,"onDoublePinchTap",this._onDoublePinchTapCB),o.removeEvent(t,"onHold",this._onHoldCB),this.removeViewFromGestures(t),e.addEventListener("contextmenu",this._onContextMenu,!1),e.addEventListener("dragover",this._onDragCB),this.addViewToManipulation(e),o.addEvent(e,"onDoubleTap",this._onDoubleTapCB),o.addEvent(e,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(e,"onHold",this._onHoldCB),o.addEvent(e,"onDoubleTap",this._onDoubleTapCB),o.addEvent(e,"onDoublePinchTap",this._onDoublePinchTapCB),o.addEvent(e,"onHold",this._onHoldCB),this.addViewToGestures(e),this.domElement=e},f.prototype.setInvertHeadRotationActive=function(e){this._invertHeadRotation=!!e},f.prototype.getInvertHeadRotationActive=function(){return this._invertHeadRotation},f}),define("Visualization/TrackballControls",["DS/Visualization/TrackballControls","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/TrackballControls"),e}),define("DS/Visualization/Filters/MaterialToUseFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.materialToUse=e}}}),define("DS/Visualization/GeometryHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t,i){"use strict";var r=document.createElement("canvas");r.width=512,r.height=64;var n=e.extend({init:function(){return this},CreateVis3DCuboid:function(e,r,n,s,a,o,l){var h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.fill=void 0!==o?o:1,this.cornerPoint=void 0!==e?e:new t.Vector3(0,0,0),this.firstAxis=void 0!==r?r:new t.Vector3(1,0,0),this.secondAxis=void 0!==n?n:new t.Vector3(0,1,0),this.thirdAxis=void 0!==s?s:new t.Vector3(0,0,1),this.color=void 0!==a?a:new i.Color(.5,.5,.5,1),M=l||0):(this.fill=void 0!==e.fill?e.fill:1,this.cornerPoint=void 0!==e.cornerPoint?e.cornerPoint:new t.Vector3(0,0,0),this.firstAxis=void 0!==e.firstAxis?e.firstAxis:new t.Vector3(1,0,0),this.secondAxis=void 0!==e.secondAxis?e.secondAxis:new t.Vector3(0,1,0),this.thirdAxis=void 0!==e.thirdAxis?e.thirdAxis:new t.Vector3(0,0,1),this.color=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),M=e.layerNb?e.layerNb:0),(h=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,h.lineAttr=new i.LineAttributes,h.pointAttr=new i.PointAttributes,(c=new i.Buffer).size=24,c.component=i.VertexComponentEnum.POSITION,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(24),(d=new i.Buffer).size=18,d.component=i.VertexComponentEnum.NORMAL,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(18),(u=new i.Buffer).size=12,u.component=i.VertexComponentEnum.TEX_COORD_0,u.format=i.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(12),(p=new i.Buffer).indexBuffer=!0,p.size=24,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(24),(f=new i.Buffer).indexBuffer=!0,f.size=24,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(24),(g=new i.Buffer).indexBuffer=!0,g.size=24,g.format=i.DataTypeEnum.UINT,g.dimension=1,g.data=new Uint16Array(24),h.addBuffer(0,c),h.addBuffer(1,d),h.addBuffer(2,u),h.addBuffer(3,p),h.addBuffer(4,f),h.addBuffer(5,g),m=c.data,v=0,(y=new t.Vector3).addVectors(this.cornerPoint,this.thirdAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.add(this.firstAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.add(this.secondAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.addVectors(this.cornerPoint,this.thirdAxis),y.add(this.secondAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.addVectors(this.cornerPoint,this.secondAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.add(this.firstAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,y.addVectors(this.cornerPoint,this.firstAxis),m[v++]=y.x,m[v++]=y.y,m[v++]=y.z,m[v++]=this.cornerPoint.x,m[v++]=this.cornerPoint.y,m[v++]=this.cornerPoint.z,this.fill){for(v=0,_=0,(m=p.data)[v++]=0,m[v++]=1,m[v++]=3,m[v++]=2,m[v++]=4,m[v++]=5,m[v++]=7,m[v++]=6,m[v++]=0,m[v++]=3,m[v++]=7,m[v++]=4,m[v++]=6,m[v++]=5,m[v++]=1,m[v++]=2,m[v++]=5,m[v++]=4,m[v++]=2,m[v++]=3,m[v++]=7,m[v++]=6,m[v++]=0,m[v++]=1,m=f.data,v=0,_=0;_<6;_++)m[v++]=_,m[v++]=_,m[v++]=_,m[v++]=_;for(m=g.data,v=0,_=0;_<6;_++)m[v++]=2,m[v++]=3,m[v++]=0,m[v++]=1,m[v++]=1,m[v++]=0,m[v++]=3,m[v++]=2,m[v++]=3,m[v++]=1,m[v++]=2,m[v++]=0,m[v++]=3,m[v++]=1,m[v++]=2,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=3,m[v++]=2,m[v++]=2,m[v++]=3,m[v++]=0,m[v++]=1;v=0,(m=d.data)[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=-1,m[v++]=-1,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=-1,m[v++]=0,v=0,(m=u.data)[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=0,m[v++]=0,m[v++]=1,m[v++]=0,m[v++]=1,m[v++]=1,m[v++]=0}else v=0,_=0,(m=p.data)[v++]=0,m[v++]=3,m[v++]=3,m[v++]=2,m[v++]=2,m[v++]=1,m[v++]=1,m[v++]=0,m[v++]=7,m[v++]=4,m[v++]=4,m[v++]=5,m[v++]=5,m[v++]=6,m[v++]=6,m[v++]=7,m[v++]=0,m[v++]=7,m[v++]=3,m[v++]=4,m[v++]=2,m[v++]=5,m[v++]=1,m[v++]=6;for(_=0;_<6;_++)(S=new i.Primitive).nbIndices=4,S.connectivity=this.fill?i.ConnectivityTypeEnum.TRIANGLE_STRIP:i.ConnectivityTypeEnum.LINES,S.attr={fill:new i.FillAttributes(this.color,1),line:new i.LineAttributes,point:new i.PointAttributes},(x=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=i.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new i.IndexArray,x.indices.format=i.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=4*_,S.addVertexComponent(x),this.fill&&((b=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,b.nbVertices=4,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=4,b.indices.offset=4*_,(w=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,w.nbVertices=4,w.nbValuesPerVertex=3,w.format=i.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=2,w.indices=new i.IndexArray,w.indices.format=i.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=4*_,S.addVertexComponent(b),S.addVertexComponent(w)),h.addPrimitive(S);return h.noz=M>0,h},CreateVis3DSphere:function(e,r,n,s,a,o,l,h,c){var d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O,L,V,F,B,N,G,k=!1;for(e instanceof t.Matrix4||void 0===e?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.matrix=void 0!==e?e:null,this.radius=void 0!==r?r:1,this.meridianStart=void 0!==n?n:0,this.meridianEnd=void 0!==s?s:2*Math.PI,this.parallelStart=void 0!==a?a:0,this.parallelEnd=void 0!==o?o:2*Math.PI,this.sag=void 0!==l?l:80,L=void 0!==h?h:new i.Color(.5,.5,.5,1),G=c||0):(this.matrix=void 0!==e.matrix?e.matrix:null,this.radius=void 0!==e.radius?e.radius:1,this.meridianStart=void 0!==e.meridianStart?e.meridianStart:0,this.meridianEnd=void 0!==e.meridianEnd?e.meridianEnd:2*Math.PI,this.parallelStart=void 0!==e.parallelStart?e.parallelStart:0,this.parallelEnd=void 0!==e.parallelEnd?e.parallelEnd:2*Math.PI,this.sag=void 0!==e.sag?e.sag:80,L=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),G=e.layerNb?e.layerNb:0,k=!!e.tgtBinorm&&e.tgtBinorm),this.parallelStart<0&&(this.parallelStart=0),this.parallelStart>Math.PI&&(this.parallelStart=Math.PI),(d=this.parallelEnd-this.parallelStart)<0&&(d=0),this.parallelStart+d>Math.PI&&(d=Math.PI-this.parallelStart),this.meridianStart<0&&(this.meridianStart=0),this.meridianStart>2*Math.PI&&(this.meridianStart=2*Math.PI),(u=this.meridianEnd-this.meridianStart)<0&&(u=0),this.meridianStart+u>2*Math.PI&&(u=2*Math.PI-this.meridianStart),p=3*(this.sag+1)*this.sag,f=6*this.sag*(this.sag-1),(g=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,g.lineAttr=new i.LineAttributes,g.pointAttr=new i.PointAttributes,(m=new i.Buffer).size=3*p,m.component=i.VertexComponentEnum.POSITION,m.format=i.DataTypeEnum.FLOAT,m.dimension=3,m.data=new Float32Array(m.size),(v=new i.Buffer).size=3*p,v.component=i.VertexComponentEnum.NORMAL,v.format=i.DataTypeEnum.FLOAT,v.dimension=3,v.data=new Float32Array(v.size),(_=new i.Buffer).size=3*p,_.component=i.VertexComponentEnum.TEX_COORD_0,_.format=i.DataTypeEnum.FLOAT,_.dimension=3,_.data=new Float32Array(_.size),k&&((y=new i.Buffer).size=3*p,y.component=i.VertexComponentEnum.TEX_COORD_2,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),(S=new i.Buffer).size=3*p,S.component=i.VertexComponentEnum.TEX_COORD_3,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),g.addBuffer(5,y),g.addBuffer(6,S)),(x=new i.Buffer).indexBuffer=!0,x.size=f,x.format=i.DataTypeEnum.UINT,x.dimension=1,x.data=new Uint16Array(x.size),g.addBuffer(0,m),g.addBuffer(1,v),g.addBuffer(2,_),g.addBuffer(3,x),b=x.data,E=0,T=0;T<this.sag-1;T++)for(A=0;A<this.sag;A++)b[E++]=T*(this.sag+1)+A,b[E++]=(T+1)*(this.sag+1)+A,b[E++]=(T+1)*(this.sag+1)+A+1,b[E++]=T*(this.sag+1)+A,b[E++]=(T+1)*(this.sag+1)+A+1,b[E++]=T*(this.sag+1)+A+1;for(b=m.data,w=v.data,M=_.data,k&&(C=y.data,P=S.data),E=0,D=1/(this.sag-1),I=new t.Vector3,T=0;T<this.sag;T++)for(R=T*D,A=0;A<=this.sag;A++,E+=3)O=A/this.sag,w[E]=Math.sin(this.parallelStart+R*d)*Math.cos(this.meridianStart+O*u),I.x=this.radius*w[E],M[E]=A/this.sag,w[E+1]=Math.sin(this.parallelStart+R*d)*Math.sin(this.meridianStart+O*u),I.y=this.radius*w[E+1],M[E+1]=T/this.sag,w[E+2]=Math.cos(this.parallelStart+R*d),I.z=this.radius*w[E+2],M[E+2]=0,k&&(C[E]=w[E+1],C[E+1]=-w[E],C[E+2]=0,P[E]=w[E]*w[E+2],P[E+1]=w[E+1]*w[E+2],P[E+2]=-w[E]*w[E]-w[E+1]*w[E+1]),this.matrix&&I.applyMatrix4(this.matrix),b[E]=I.x,b[E+1]=I.y,b[E+2]=I.z;if((V=new i.Primitive).nbIndices=f,V.connectivity=i.ConnectivityTypeEnum.TRIANGLES,V.attr={fill:new i.FillAttributes(L,1),line:new i.LineAttributes,point:new i.PointAttributes},(F=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,F.nbVertices=p,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=0,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,(B=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,B.nbVertices=p,B.nbValuesPerVertex=3,B.format=i.DataTypeEnum.FLOAT,B.cardinality=0,B.bufferId=1,B.indices=new i.IndexArray,B.indices.format=i.DataTypeEnum.UINT,B.indices.bufferId=3,B.indices.offset=0,(N=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,N.nbVertices=p,N.nbValuesPerVertex=3,N.format=i.DataTypeEnum.FLOAT,N.cardinality=0,N.bufferId=2,N.indices=new i.IndexArray,N.indices.format=i.DataTypeEnum.UINT,N.indices.bufferId=3,N.indices.offset=0,V.addVertexComponent(F),V.addVertexComponent(B),V.addVertexComponent(N),k){var U=new i.VertexComponent;U.component=i.VertexComponentEnum.TEX_COORD_2,U.nbVertices=p,U.nbValuesPerVertex=3,U.format=i.DataTypeEnum.FLOAT,U.cardinality=0,U.bufferId=5,U.indices=new i.IndexArray,U.indices.format=i.DataTypeEnum.UINT,U.indices.bufferId=3,U.indices.offset=0;var z=new i.VertexComponent;z.component=i.VertexComponentEnum.TEX_COORD_3,z.nbVertices=p,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=6,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,V.addVertexComponent(U),V.addVertexComponent(z)}return g.addPrimitive(V),g.noz=G>0,g},CreateVis3DTube:function(e,r,n,s,a,o,l){var h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O,L,V,F,B;if(e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),h=e,(c=new t.Vector3(0,0,0)).addVectors(e,r),d=s||1,u=n||1,D=void 0!==o?o:new i.Color(.2,.8,.2,1),F=l||0,B=a):(h=e.bottomCenterPoint,(c=new t.Vector3(0,0,0)).addVectors(e.bottomCenterPoint,e.extrusionVector),d=e.externalRadius?e.externalRadius:1,u=e.internalRadius?e.internalRadius:1,B=e.sag?e.sag:0,D=void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),F=e.layerNb?e.layerNb:0),u===d)return this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:d,topRadius:d,sag:B,bottomCap:!1,topCap:!1,internal:!1,layerNb:F});p=this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:d,topRadius:d,sag:B,bottomCap:!1,topCap:!1,internal:!1,layerNb:F}),f=this.CreateVis3DCylinderCustom({bottomCenterPoint:h,topCenterPoint:c,bottomRadius:u,topRadius:u,sag:B,bottomCap:!1,topCap:!1,internal:!0,layerNb:F}),g=3*(B+1)*8,m=3*(B+1)*8,v=24*B,(_=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,_.lineAttr=new i.LineAttributes,_.pointAttr=new i.PointAttributes,(y=new i.Buffer).size=g,y.component=i.VertexComponentEnum.POSITION,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(y.size),(S=new i.Buffer).size=m,S.component=i.VertexComponentEnum.NORMAL,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(S.size),(x=new i.Buffer).size=g,x.component=i.VertexComponentEnum.TEX_COORD_0,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(x.size),(b=new i.Buffer).indexBuffer=!0,b.size=v,b.format=i.DataTypeEnum.UINT,b.dimension=1,b.data=new Uint16Array(b.size),y.data.set(p.buffers[0].data.subarray(0,6*(B+1)),0),y.data.set(f.buffers[0].data.subarray(0,6*(B+1)),6*(B+1)),y.data.set(p.buffers[0].data.subarray(0,3*(B+1)),12*(B+1)),y.data.set(f.buffers[0].data.subarray(0,3*(B+1)),15*(B+1)),y.data.set(p.buffers[0].data.subarray(3*(B+1),6*(B+1)),18*(B+1)),y.data.set(f.buffers[0].data.subarray(3*(B+1),6*(B+1)),21*(B+1)),x.data.set(p.buffers[2].data.subarray(0,6*(B+1)),0),x.data.set(f.buffers[2].data.subarray(0,6*(B+1)),6*(B+1)),x.data.set(p.buffers[2].data.subarray(0,3*(B+1)),12*(B+1)),x.data.set(f.buffers[2].data.subarray(0,3*(B+1)),15*(B+1)),x.data.set(p.buffers[2].data.subarray(3*(B+1),6*(B+1)),18*(B+1)),x.data.set(f.buffers[2].data.subarray(3*(B+1),6*(B+1)),21*(B+1)),S.data.set(p.buffers[1].data.subarray(0,3*(B+1)*2),0),S.data.set(f.buffers[1].data.subarray(0,3*(B+1)*2),3*(B+1)*2),w=3*(B+1)*4;for(var N=0;N<2*(B+1);N++)S.data[w++]=0,S.data[w++]=0,S.data[w++]=-1;for(N=0;N<2*(B+1);N++)S.data[w++]=0,S.data[w++]=0,S.data[w++]=1;for(b.data.set(p.buffers[3].data,0),C=p.buffers[3].size,P=p.buffers[0].size/3,p.buffers[1].size/3,M=0;M<C;M++)b.data[M+C]=f.buffers[3].data[M]+P;for(w=p.buffers[3].size+f.buffers[3].size,P*=2,(p.buffers[1].size+f.buffers[1].size)/3,E=0;E<B;++E)T=E+1,b.data[w++]=E+P,b.data[w++]=B+1+E+P,b.data[w++]=T+P,b.data[w++]=B+1+E+P,b.data[w++]=B+1+T+P,b.data[w++]=T+P;for(1,P+=2*(B+1),E=0;E<B;++E)T=E+1,b.data[w++]=B+1+E+P,b.data[w++]=E+P,b.data[w++]=T+P,b.data[w++]=T+P,b.data[w++]=B+1+T+P,b.data[w++]=B+1+E+P;for(_.addBuffer(0,y),_.addBuffer(1,S),_.addBuffer(2,x),_.addBuffer(3,b),_.addPrimitive(p.primitives[0]),_.addPrimitive(f.primitives[0]),A=f.primitives[0].vertexComponents,M=0;M<A.length;M++)A[M].indices.offset+=C;return(I=new i.Primitive).nbIndices=6*this.sag,I.connectivity=i.ConnectivityTypeEnum.TRIANGLES,I.attr={fill:new i.FillAttributes(D,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size,(O=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=1,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size,(L=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=2,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size,I.addVertexComponent(R),I.addVertexComponent(O),I.addVertexComponent(L),_.addPrimitive(I),(V=new i.Primitive).nbIndices=6*this.sag,V.connectivity=i.ConnectivityTypeEnum.TRIANGLES,V.attr={fill:new i.FillAttributes(D,1),line:new i.LineAttributes,point:new i.PointAttributes},(R=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,R.nbVertices=2*(this.sag+1),R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=0,R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=p.buffers[3].size+f.buffers[3].size+6*B,(O=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,O.nbVertices=2*(this.sag+1),O.nbValuesPerVertex=3,O.format=i.DataTypeEnum.FLOAT,O.cardinality=0,O.bufferId=1,O.indices=new i.IndexArray,O.indices.format=i.DataTypeEnum.UINT,O.indices.bufferId=3,O.indices.offset=p.buffers[3].size+f.buffers[3].size+6*B,(L=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,L.nbVertices=2*(this.sag+1),L.nbValuesPerVertex=3,L.format=i.DataTypeEnum.FLOAT,L.cardinality=0,L.bufferId=2,L.indices=new i.IndexArray,L.indices.format=i.DataTypeEnum.UINT,L.indices.bufferId=3,L.indices.offset=p.buffers[3].size+f.buffers[3].size+6*B,V.addVertexComponent(R),V.addVertexComponent(O),V.addVertexComponent(L),_.addPrimitive(V),_.noz=F>0,_},CreateVis3DCylinder:function(e,i,r,n,s){var a;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),a={bottomCenterPoint:e,topCenterPoint:i,bottomRadius:r,topRadius:r,sag:n,bottomCap:!0,topCap:!0,internal:!1,layerNb:s}):a={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:e.radius,topRadius:e.radius,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:e.color,layerNb:e.layerNb},this.CreateVis3DCylinderCustom(a)},CreateVis3DCone:function(e,r,n,s,a,o,l){var h;return e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),h={bottomCenterPoint:e,topCenterPoint:r,bottomRadius:void 0!==n?n:1,topRadius:void 0!==s?s:1,sag:a,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==o?o:new i.Color(.2,.8,.2,1),layerNb:l||0}):h={bottomCenterPoint:e.bottomCenterPoint,topCenterPoint:e.topCenterPoint,bottomRadius:void 0!==e.bottomRadius?e.bottomRadius:1,topRadius:void 0!==e.topRadius?e.topRadius:1,sag:e.sag,bottomCap:!0,topCap:!0,internal:!1,color:void 0!==e.color?e.color:new i.Color(.2,.8,.2,1),layerNb:e.layerNb||0},h.topRadius<=0&&(h.topCap=!1),h.bottomRadius<=0&&(h.bottomCap=!1),this.CreateVis3DCylinderCustom(h)},CreateVis3DCylinderCustom:function(e,r,n,s,a,o,l,h,c,d){var u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O,L,V,F,B,N,G,k,U,z,H,W,j,X,q,Z;e instanceof t.Vector3?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.bottomCenterPoint=void 0!==e?e:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==r?r:new t.Vector3(0,5,0),this.bottomRadius=void 0!==n?n:1,this.topRadius=void 0!==s?s:1,this.sag=void 0!==a?a:80,u=void 0===l||l,p=void 0===o||o,f=void 0!==h&&h,Z=d||0,k=c||new i.Color(.2,.8,.2,1)):(this.bottomCenterPoint=void 0!==e.bottomCenterPoint?e.bottomCenterPoint:new t.Vector3(0,0,0),this.topCenterPoint=void 0!==e.topCenterPoint?e.topCenterPoint:new t.Vector3(0,5,0),this.bottomRadius=void 0!==e.bottomRadius?e.bottomRadius:1,this.topRadius=void 0!==e.topRadius?e.topRadius:1,this.sag=void 0!==e.sag?e.sag:80,u=void 0===e.topCap||e.topCap,p=void 0===e.bottomCap||e.bottomCap,f=void 0!==e.internal&&e.internal,Z=e.layerNb?e.layerNb:0,k=e.color?e.color:new i.Color(.2,.8,.2,1)),(g=new t.Vector4(0,0,0,0)).subVectors(this.topCenterPoint,this.bottomCenterPoint),g.w=0,g.normalize(),m=new t.Matrix4,0===g.x&&0===g.y?m.identity():m.set(g.x/Math.sqrt(g.x*g.x+g.y*g.y),g.y/Math.sqrt(g.x*g.x+g.y*g.y),0,0,-g.y/Math.sqrt(g.x*g.x+g.y*g.y),g.x/Math.sqrt(g.x*g.x+g.y*g.y),0,0,0,0,1,0,0,0,0,1),v=new t.Matrix4,0===g.x&&0===g.y&&0===g.z?v.identity():v.set(g.z/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,-Math.sqrt(g.x*g.x+g.y*g.y)/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,0,1,0,0,Math.sqrt(g.x*g.x+g.y*g.y)/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,g.z/Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z),0,0,0,0,1),(_=new t.Matrix4).multiplyMatrices(v,m),_.transpose(),_.clone(),S=new t.Vector3(this.bottomCenterPoint.x,this.bottomCenterPoint.y,this.bottomCenterPoint.z),y=_.clone(),_.elements[12]=S.x,_.elements[13]=S.y,_.elements[14]=S.z,x=Math.sqrt((this.bottomCenterPoint.x-this.topCenterPoint.x)*(this.bottomCenterPoint.x-this.topCenterPoint.x)+(this.bottomCenterPoint.y-this.topCenterPoint.y)*(this.bottomCenterPoint.y-this.topCenterPoint.y)+(this.bottomCenterPoint.z-this.topCenterPoint.z)*(this.bottomCenterPoint.z-this.topCenterPoint.z)),b=(this.bottomRadius-this.topRadius)/x,w=6*this.sag,M=2*(this.sag+1),C=2*(this.sag+1);var Y=M;if(u&&(w+=3*(this.sag-2),Y+=this.sag,C+=this.sag,M+=this.sag),p&&(w+=3*(this.sag-2),Y+=this.sag,C+=this.sag,M+=this.sag),(P=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,P.lineAttr=new i.LineAttributes,P.pointAttr=new i.PointAttributes,(E=new i.Buffer).size=3*M,E.component=i.VertexComponentEnum.POSITION,E.format=i.DataTypeEnum.FLOAT,E.dimension=3,E.data=new Float32Array(E.size),(T=new i.Buffer).size=3*C,T.component=i.VertexComponentEnum.NORMAL,T.format=i.DataTypeEnum.FLOAT,T.dimension=3,T.data=new Float32Array(T.size),(A=new i.Buffer).size=3*Y,A.component=i.VertexComponentEnum.TEX_COORD_0,A.format=i.DataTypeEnum.FLOAT,A.dimension=3,A.data=new Float32Array(A.size),(D=new i.Buffer).indexBuffer=!0,D.size=w,D.format=i.DataTypeEnum.UINT,D.dimension=1,D.data=new Uint16Array(D.size),P.addBuffer(0,E),P.addBuffer(1,T),P.addBuffer(2,A),P.addBuffer(3,D),I=D.data,R=0,f)for(L=0;L<this.sag;++L)V=L+1,I[R++]=V,I[R++]=L,I[R++]=this.sag+1+L,I[R++]=V,I[R++]=this.sag+1+L,I[R++]=this.sag+1+V;else for(L=0;L<this.sag;++L)V=L+1,I[R++]=L,I[R++]=V,I[R++]=this.sag+1+L,I[R++]=this.sag+1+L,I[R++]=V,I[R++]=this.sag+1+V;if(u)for(L=0;L<this.sag-2;L++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+L+1,I[R++]=2*this.sag+2+L+2;if(p)if(u)for(L=0;L<this.sag-2;L++)I[R++]=3*this.sag+2,I[R++]=3*this.sag+2+L+1,I[R++]=3*this.sag+2+L+2;else for(L=0;L<this.sag-2;L++)I[R++]=2*this.sag+2,I[R++]=2*this.sag+2+L+1,I[R++]=2*this.sag+2+L+2;F=E.data,B=A.data;var Q=0;for(L=0;L<this.sag+1;L++,Q+=3)N=L/this.sag*2*Math.PI,F[Q]=this.bottomRadius*Math.cos(N),F[Q+1]=this.bottomRadius*Math.sin(N),F[Q+2]=0,B[Q]=L/this.sag,B[Q+1]=1,B[Q+2]=0;for(Q=3*(this.sag+1),L=0;L<this.sag+1;L++,Q+=3)N=L/this.sag*2*Math.PI,F[Q]=this.topRadius*Math.cos(N),F[Q+1]=this.topRadius*Math.sin(N),F[Q+2]=x,B[Q]=L/this.sag,B[Q+1]=0,B[Q+2]=0;if(u)for(N=0,O=0;O<this.sag;O++)N=O/this.sag*2*Math.PI,F[Q]=F[3*(this.sag+O+1)],B[Q++]=(Math.cos(N)+1)/2,F[Q]=F[3*(this.sag+O+1)+1],B[Q++]=1-(Math.sin(N)+1)/2,F[Q]=F[3*(this.sag+O+1)+2],B[Q++]=0;if(p)for(N=0,O=0;O<this.sag;O++)N=O/this.sag*2*Math.PI,F[Q]=F[3*(this.sag-1-O)],B[Q++]=(Math.cos(N)+1)/2,F[Q]=F[3*(this.sag-1-O)+1],B[Q++]=1-(Math.sin(N)+1)/2,F[Q]=F[3*(this.sag-1-O)+2],B[Q++]=0;F=T.data,Q=0;for(var K=0;K<2;K++)for(L=0;L<this.sag+1;L++)N=L/this.sag*2*Math.PI,(G=new t.Vector3).x=E.data[3*L],G.y=E.data[3*L+1],G.z=E.data[3*L+2],G.z=Math.sqrt(G.x*G.x+G.y*G.y)*b,G.normalize(),f?(F[Q++]=-G.x,F[Q++]=-G.y,F[Q++]=-G.z):(F[Q++]=G.x,F[Q++]=G.y,F[Q++]=G.z);if(u)for(K=0;K<this.sag;K++)F[Q++]=0,F[Q++]=0,F[Q++]=1;if(p)for(K=0;K<this.sag;K++)F[Q++]=0,F[Q++]=0,F[Q++]=-1;for(O=0;O<M;O++)(G=new t.Vector3).x=E.data[3*O],G.y=E.data[3*O+1],G.z=E.data[3*O+2],G.applyMatrix4(_),E.data[3*O]=G.x,E.data[3*O+1]=G.y,E.data[3*O+2]=G.z;for(O=0;O<C;O++)(G=new t.Vector3).x=T.data[3*O],G.y=T.data[3*O+1],G.z=T.data[3*O+2],G.applyMatrix4(y),T.data[3*O]=G.x,T.data[3*O+1]=G.y,T.data[3*O+2]=G.z;return(U=new i.Primitive).nbIndices=6*this.sag,U.connectivity=i.ConnectivityTypeEnum.TRIANGLES,U.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=2*this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=0,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=2*this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=0,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=2*this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.indices=new i.IndexArray,W.indices.format=i.DataTypeEnum.UINT,W.indices.bufferId=3,W.indices.offset=0,U.addVertexComponent(z),U.addVertexComponent(H),U.addVertexComponent(W),P.addPrimitive(U),u&&((j=new i.Primitive).nbIndices=3*(this.sag-2),j.connectivity=i.ConnectivityTypeEnum.TRIANGLES,j.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=6*this.sag,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=6*this.sag,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=2*(this.sag+1),j.addVertexComponent(z),j.addVertexComponent(H),j.addVertexComponent(W),P.addPrimitive(j)),p&&(X=6*this.sag,u&&(X+=3*(this.sag-2)),(q=new i.Primitive).nbIndices=3*(this.sag-2),q.connectivity=i.ConnectivityTypeEnum.TRIANGLES,q.attr={fill:new i.FillAttributes(k,1),line:new i.LineAttributes,point:new i.PointAttributes},(z=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,z.nbVertices=this.sag,z.nbValuesPerVertex=3,z.format=i.DataTypeEnum.FLOAT,z.cardinality=0,z.bufferId=0,z.indices=new i.IndexArray,z.indices.format=i.DataTypeEnum.UINT,z.indices.bufferId=3,z.indices.offset=X,(H=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,H.nbVertices=this.sag,H.nbValuesPerVertex=3,H.format=i.DataTypeEnum.FLOAT,H.cardinality=0,H.bufferId=1,H.indices=new i.IndexArray,H.indices.format=i.DataTypeEnum.UINT,H.indices.bufferId=3,H.indices.offset=X,(W=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,W.nbVertices=this.sag+2,W.nbValuesPerVertex=3,W.format=i.DataTypeEnum.FLOAT,W.cardinality=0,W.bufferId=2,W.offset=u?this.sag:0,W.offset+=2*(this.sag+1),q.addVertexComponent(z),q.addVertexComponent(H),q.addVertexComponent(W),P.addPrimitive(q)),P.noz=Z>0,P},createLine:function(e,t,r,n){var s,a,o,l,h,c,d,u,p=i.ConnectivityTypeEnum.LINE_STRIP,f=!1,g=!1,m=!1;if(e instanceof Array)console.warn("DEPRECATED: Please use a litteral object to define your primitive."),s=e,h=r,a=[],o=[],d=void 0!==t?t:new i.Color(.5,.5,.5,1),u=n||0;else if(e instanceof Object){if(s=e.points,a=e.colors?e.colors:[],o=e.idx?e.idx:[],p=e.drawMode?e.drawMode:p,f=!!e.editable&&e.editable,l=e.patternOffsets?e.patternOffsets:[],p!==i.ConnectivityTypeEnum.LINES&&p!==i.ConnectivityTypeEnum.LINE_STRIP&&(console.warn("Invalid draw mode for the line, passing to strip mode"),p=i.ConnectivityTypeEnum.LINE_STRIP),p===i.ConnectivityTypeEnum.LINES&&0===o.length)for(var v=0;v<s.length-1;v++)o.push(v),o.push(v+1);if(e.hasOwnProperty("material")){h=e.material.lineWidth,g=function(){if(0===o.length)return!1;if(e.material.is2DLine)return e.material.isDashedLine;for(var t=new Set,i=0,r=0;r<o.length;r++){var n=o[r];if(t.has(n)&&n!==i)return!0;i=n,t.add(n)}return!1}(),d=void 0!==e.material.color?e.material.color:new i.Color(.5,.5,.5,1),l.length&&l.length===o.length&&(m=!0)}else h=e.width,d=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1);u=e.layerNb?e.layerNb:0}if(g){var _=[],y=[],S=[];for(v=0;v<o.length;v++){var x=o[v];_.push(s[x]),a.length&&y.push(a[x]),m&&S.push(l[x]),o[v]=v}s=_,a=y,l=S}var b=s.length,w=a.length,M=o.length;if(!b)return null;var C=function(e,t,r,n,s){var a=new i.Buffer;return a.size=e*t,a.component=r,a.format=n,a.dimension=e,a.data=new Float32Array(a.size),a},P=new i.PrimitiveGroup;P.fillAttr=new i.FillAttributes,P.lineAttr=new i.LineAttributes(d,h),P.pointAttr=new i.PointAttributes;var E=0,T=C(3,b,i.VertexComponentEnum.POSITION,i.DataTypeEnum.FLOAT),A=E++;P.addBuffer(A,T),c=T.data;for(v=0;v<b;v++){var D=s[v];c[3*v]=D.x,c[3*v+1]=D.y,c[3*v+2]=D.z}var I=!1,R=0;if(w===b){I=C(4,w,i.VertexComponentEnum.DIFFUSE_COLOR,i.DataTypeEnum.FLOAT),R=E++,P.addBuffer(R,I),c=I.data;for(v=0;v<w;v++){var O=a[v];c[4*v]=O.x,c[4*v+1]=O.y,c[4*v+2]=O.z,c[4*v+3]=O.w}}var L,V,F=!1,B=0;if(M){B=E++,L=o.length,(V=new i.Buffer).indexBuffer=!0,V.size=L,V.format=i.DataTypeEnum.UINT,V.dimension=1,V.data=L>65535?new Uint32Array(V.size):new Uint16Array(V.size),F=V,P.addBuffer(B,F),c=F.data;for(v=0;v<M;v++)c[v]=o[v]}m&&(P.patternOffsets=l);var N=new i.Primitive;N.nbIndices=M||b,N.connectivity=p,N.attr={fill:new i.FillAttributes(d),line:new i.LineAttributes(d,h),point:new i.PointAttributes};var G,k=function(e,t,r,n,s,a){var o=new i.VertexComponent;return o.component=e.component,o.nbValuesPerVertex=e.dim,o.format=e.format,o.nbVertices=r,o.cardinality=0,o.bufferId=t,n&&(o.indices=new i.IndexArray,o.indices.format=n.format,o.indices.bufferId=s,o.indices.offset=a),o},U=k(T,A,b,F,B,0);return N.addVertexComponent(U),w&&(G=k(I,R,w,F,B,0),N.addVertexComponent(G)),P.addPrimitive(N),P.noz=u>0,P.editable=f,P},createRectangle:function(e,r,n,s,a,o){var l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A;e instanceof Object?(w=e.width?e.width:1,M=e.height?e.height:1,C=!!e.fill&&e.fill,v=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),P=!!e.noEdge&&e.noEdge,E=e.layerNb?e.layerNb:0,T=!!e.sharing&&e.sharing,A=e.cornerPoint?e.cornerPoint:new t.Vector2(0,0)):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),w=e||1,M=r||1,C=n||!1,v=void 0!==s?s:new i.Color(.5,.5,.5,1),P=a||!1,E=o||0,A=new t.Vector2(0,0),T=!1),(l=new i.PrimitiveGroup).sharing=T,l.fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=15,h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(c=new i.Buffer).size=3,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(d=new i.Buffer).size=12,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new i.Buffer).indexBuffer=!0,u.size=C?9:5,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(u.size),(p=new i.Buffer).indexBuffer=!0,p.size=5,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=C?4:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,h),l.addBuffer(1,c),l.addBuffer(2,u),l.addBuffer(3,p),l.addBuffer(4,d),l.addBuffer(5,f),m=0,(g=u.data)[m++]=0,g[m++]=1,g[m++]=2,g[m++]=3,g[m++]=4,C&&(g[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2),m=0,(g=p.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=0,g[m++]=0,g=f.data,m=0,C&&(g[m++]=0,g[m++]=1,g[m++]=3,g[m++]=2),g=h.data,m=0;var D=e.delta&&e.delta.x?e.delta.x:0,I=e.delta&&e.delta.y?e.delta.y:0;return g[m++]=A.x+D,g[m++]=A.y+I,g[m++]=0,g[m++]=w+A.x+D,g[m++]=A.y+I,g[m++]=0,g[m++]=w+A.x+D,g[m++]=M+A.y+I,g[m++]=0,g[m++]=A.x+D,g[m++]=M+A.y+I,g[m++]=0,g[m++]=A.x+D,g[m++]=A.y+I,g[m++]=0,m=0,(g=c.data)[m++]=0,g[m++]=0,g[m++]=1,m=0,(g=d.data)[m++]=0,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=1,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=0,P||((_=new i.Primitive).nbIndices=5,_.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,_.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes(v),point:new i.PointAttributes},(y=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,y.nbVertices=5,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=0,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=2,y.indices.offset=0,(b=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,b.nbVertices=1,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,_.addVertexComponent(y),_.addVertexComponent(b),l.addPrimitive(_)),C&&((x=new i.Primitive).nbIndices=4,x.connectivity=i.ConnectivityTypeEnum.TRIANGLE_STRIP,x.attr={fill:new i.FillAttributes(v),line:new i.LineAttributes,point:new i.PointAttributes},(y=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,y.nbVertices=4,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=0,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=2,y.indices.offset=5,(b=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,b.nbVertices=1,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=1,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,(S=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,S.nbVertices=4,S.nbValuesPerVertex=3,S.format=i.DataTypeEnum.FLOAT,S.cardinality=0,S.bufferId=4,S.indices=new i.IndexArray,S.indices.format=i.DataTypeEnum.UINT,S.indices.bufferId=5,S.indices.offset=0,x.addVertexComponent(y),x.addVertexComponent(b),x.addVertexComponent(S),l.addPrimitive(x)),l.noz=E>0,l},createCircle:function(e,t,r,n,s,a,o){var l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O;for(e instanceof Object?(D=e.radius?e.radius:1,I=e.segments?e.segments:24,E=void 0!==e.startAngle?e.startAngle:0,T=void 0!==e.endAngle?e.endAngle:2*Math.PI,R=!!e.fill&&e.fill,S=void 0!==e.color?e.color:new i.Color(.5,.5,.5,1),A=!!e.noEdge&&e.noEdge,O=e.layerNb?e.layerNb:0):(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),D=e||1,I=t||24,E=void 0!==n?n:0,T=void 0!==s?s:2*Math.PI,R=r||!1,A=!1,S=void 0!==a?a:new i.Color(.5,.5,.5,1),O=o||0),P=T-E,(l=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,l.lineAttr=new i.LineAttributes,l.pointAttr=new i.PointAttributes,(h=new i.Buffer).size=3*(I+2),h.component=i.VertexComponentEnum.POSITION,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),(c=new i.Buffer).size=3,c.component=i.VertexComponentEnum.NORMAL,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size),(d=new i.Buffer).size=6,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),(u=new i.Buffer).indexBuffer=!0,u.size=R?2*(I+1)+1:I+1,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(u.size),(p=new i.Buffer).indexBuffer=!0,p.size=I+2,p.format=i.DataTypeEnum.UINT,p.dimension=1,p.data=new Uint16Array(p.size),(f=new i.Buffer).indexBuffer=!0,f.size=R?I+2:0,f.format=i.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),l.addBuffer(0,h),l.addBuffer(1,c),l.addBuffer(2,d),l.addBuffer(3,u),l.addBuffer(4,p),l.addBuffer(5,f),g=u.data,m=0,v=1;v<I+2;v++)g[m++]=v;if(R)for(m=I+1,g[m++]=0,v=1;v<I+2;v++)g[m++]=v;for(g=p.data,m=0,m=0;m<=I+2;m++)g[m++]=0;if(R)for((g=f.data)[0]=0,m=1;m<=I+2;m++)g[m]=1;for(m=0,(g=h.data)[m++]=0,g[m++]=0,g[m++]=0,v=0;v<I+2;v++)y=v/I*P+E,g[m++]=D*Math.cos(y),g[m++]=D*Math.sin(y),g[m++]=0;return _=0,(g=c.data)[_++]=0,g[_++]=0,g[_++]=1,_=0,(g=d.data)[_++]=0,g[_++]=0,g[_++]=0,g[_++]=1,g[_++]=0,g[_++]=0,A||((x=new i.Primitive).nbIndices=I+1,x.connectivity=i.ConnectivityTypeEnum.LINE_STRIP,x.attr={fill:new i.FillAttributes(S),line:new i.LineAttributes,point:new i.PointAttributes},(b=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,b.nbVertices=I+2,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=0,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=0,(M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=1,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=4,M.indices.offset=0,x.addVertexComponent(b),x.addVertexComponent(M),l.addPrimitive(x)),R&&((w=new i.Primitive).nbIndices=I+2,w.connectivity=i.ConnectivityTypeEnum.TRIANGLE_FAN,w.attr={fill:new i.FillAttributes(S),line:new i.LineAttributes,point:new i.PointAttributes},(b=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,b.nbVertices=I+2,b.nbValuesPerVertex=3,b.format=i.DataTypeEnum.FLOAT,b.cardinality=0,b.bufferId=0,b.indices=new i.IndexArray,b.indices.format=i.DataTypeEnum.UINT,b.indices.bufferId=3,b.indices.offset=I+1,(M=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,M.nbVertices=1,M.nbValuesPerVertex=3,M.format=i.DataTypeEnum.FLOAT,M.cardinality=0,M.bufferId=1,M.indices=new i.IndexArray,M.indices.format=i.DataTypeEnum.UINT,M.indices.bufferId=4,M.indices.offset=0,(C=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,C.nbVertices=2,C.nbValuesPerVertex=3,C.format=i.DataTypeEnum.FLOAT,C.cardinality=0,C.bufferId=2,C.indices=new i.IndexArray,C.indices.format=i.DataTypeEnum.UINT,C.indices.bufferId=5,C.indices.offset=0,w.addVertexComponent(b),w.addVertexComponent(M),w.addVertexComponent(C),l.addPrimitive(w)),l.noz=O>0,l},createTorus:function(e,r,n,s,a,o,l,h){var c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O,L,V,F,B,N;for(e instanceof t.Matrix4?(console.warn("DEPRECATED: Please use a litteral object to define your primitive."),this.axis=e||null,this.majorRadius=r||100,this.minorRadius=n||40,this.majorStartAngle=s||0,this.majorEndAngle=a||2*Math.PI,this.sag=o||8,O=void 0!==l?l:new i.Color(.5,.5,.5,1),N=h||0):e instanceof Object&&(this.axis=e.axis||null,this.majorRadius=e.majorRadius||100,this.minorRadius=e.minorRadius||40,this.majorStartAngle=e.majorStartAngle||0,this.majorEndAngle=e.majorEndAngle||2*Math.PI,this.sag=e.sag||8,O=e.color||(void 0!==l?l:new i.Color(.5,.5,.5,1)),N=h||0),c=(this.majorEndAngle-this.majorStartAngle)/this.sag,d=(this.sag+1)*(this.sag+1),u=6*this.sag*this.sag,(p=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,p.lineAttr=new i.LineAttributes,p.pointAttr=new i.PointAttributes,(f=new i.Buffer).size=3*d,f.component=i.VertexComponentEnum.POSITION,f.format=i.DataTypeEnum.FLOAT,f.dimension=3,f.data=new Float32Array(f.size),(I=new i.Buffer).size=3*d,I.component=i.VertexComponentEnum.NORMAL,I.format=i.DataTypeEnum.FLOAT,I.dimension=3,I.data=new Float32Array(I.size),(g=new i.Buffer).size=3*d,g.component=i.VertexComponentEnum.TEX_COORD_0,g.format=i.DataTypeEnum.FLOAT,g.dimension=3,g.data=new Float32Array(g.size),(m=new i.Buffer).indexBuffer=!0,m.size=u,m.format=i.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),p.addBuffer(0,f),p.addBuffer(1,I),p.addBuffer(2,g),p.addBuffer(3,m),v=m.data,S=0,w=0;w<this.sag;++w)for(A=w+1,M=0;M<this.sag;++M)D=M+1,v[S]=w*(this.sag+1)+M,v[S+1]=A*(this.sag+1)+M,v[S+2]=w*(this.sag+1)+D,v[S+3]=A*(this.sag+1)+D,v[S+4]=w*(this.sag+1)+D,v[S+5]=A*(this.sag+1)+M,S+=6;for(v=f.data,_=I.data,y=g.data,x=0,b=new t.Vector3,w=0;w<this.sag+1;w++)for(C=this.majorStartAngle+w*c,M=0;M<this.sag+1;M++,x+=3)P=M/this.sag*2*Math.PI,b.x=this.majorRadius*Math.cos(C),b.y=this.majorRadius*Math.sin(C),(E=new t.Vector3).x=(this.majorRadius+this.minorRadius*Math.cos(P))*Math.cos(C),E.y=(this.majorRadius+this.minorRadius*Math.cos(P))*Math.sin(C),E.z=this.minorRadius*Math.sin(P),T=E.clone(),this.axis&&E.applyMatrix4(this.axis),v[x]=E.x,v[x+1]=E.y,v[x+2]=E.z,(R=new t.Vector3).subVectors(T,b).normalize(),this.axis&&R.applyMatrix4(this.axis),R.normalize(),_[x]=R.x,_[x+1]=R.y,_[x+2]=R.z,y[x]=w/this.sag,y[x+1]=1-M/this.sag,y[x+2]=0;return(L=new i.Primitive).nbIndices=u,L.connectivity=i.ConnectivityTypeEnum.TRIANGLES,L.attr={fill:new i.FillAttributes(O,1),line:new i.LineAttributes,point:new i.PointAttributes},(V=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,V.nbVertices=d,V.nbValuesPerVertex=3,V.format=i.DataTypeEnum.FLOAT,V.cardinality=0,V.bufferId=0,V.indices=new i.IndexArray,V.indices.format=i.DataTypeEnum.UINT,V.indices.bufferId=3,V.indices.offset=0,(B=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,B.nbVertices=d,B.nbValuesPerVertex=3,B.format=i.DataTypeEnum.FLOAT,B.cardinality=0,B.bufferId=1,B.indices=new i.IndexArray,B.indices.format=i.DataTypeEnum.UINT,B.indices.bufferId=3,B.indices.offset=0,(F=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,F.nbVertices=d,F.nbValuesPerVertex=3,F.format=i.DataTypeEnum.FLOAT,F.cardinality=0,F.bufferId=2,F.indices=new i.IndexArray,F.indices.format=i.DataTypeEnum.UINT,F.indices.bufferId=3,F.indices.offset=0,L.addVertexComponent(V),L.addVertexComponent(B),L.addVertexComponent(F),p.addPrimitive(L),p.noz=N>0,p},createPoints:function(e,t,r,n){var s=this.createMesh(e,void 0,void 0,void 0,i.ConnectivityTypeEnum.POINTS,t,n,void 0,void 0,void 0,r);return s.pointAttr.size=r,s.noz=n>0,s},createMesh:function(e,r,n,s,a,o,l,h,c,d,u){var p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R;if(C=new t.Vector3,P=new t.Vector3,this.bufferPosition=void 0!==e?e:[],this.bufferNormal=void 0!==r?r:[],this.bufferUV=void 0!==n?n:[],this.bufferColor=void 0!==d?d:[],this.bufferIndex=void 0!==s?s:[],this.glType=void 0!==a?a:i.ConnectivityTypeEnum.TRIANGLES,p=this.bufferPosition.length,f=this.bufferNormal.length,g=this.bufferUV.length,m=this.bufferColor.length,v=this.bufferIndex.length,(_=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,_.lineAttr=new i.LineAttributes,_.pointAttr=new i.PointAttributes,S=null,x=null,b=null,(y=new i.Buffer).size=p,y.component=i.VertexComponentEnum.POSITION,y.format=i.DataTypeEnum.FLOAT,y.dimension=3,y.data=new Float32Array(this.bufferPosition),_.addBuffer(0,y),f&&((S=new i.Buffer).size=f,S.component=i.VertexComponentEnum.NORMAL,S.format=i.DataTypeEnum.FLOAT,S.dimension=3,S.data=new Float32Array(this.bufferNormal),_.addBuffer(1,S)),g&&((x=new i.Buffer).size=g,x.component=i.VertexComponentEnum.TEX_COORD_0,x.format=i.DataTypeEnum.FLOAT,x.dimension=3,x.data=new Float32Array(this.bufferUV),_.addBuffer(2,x)),m&&((b=new i.Buffer).size=m,b.component=i.VertexComponentEnum.DIFFUSE_COLOR,b.format=i.DataTypeEnum.FLOAT,b.dimension=3,b.data=new Float32Array(this.bufferColor),_.addBuffer(4,b)),v&&((w=new i.Buffer).indexBuffer=!0,w.size=v,w.format=i.DataTypeEnum.UINT,w.dimension=1,w.data=v>65535?new Uint32Array(this.bufferIndex):new Uint16Array(this.bufferIndex),_.addBuffer(3,w)),h){for(M=0;M<p/3;M++)C.x=y.data[3*M],C.y=y.data[3*M+1],C.z=y.data[3*M+2],h.multiplyVector3(C),y.data[3*M]=C.x,y.data[3*M+1]=C.y,y.data[3*M+2]=C.z;for(M=0;M<f/3;M++)P.x=S.data[3*M],P.y=S.data[3*M+1],P.z=S.data[3*M+2],h.multiplyVector3(P),S.data[3*M]=P.x,S.data[3*M+1]=P.y,S.data[3*M+2]=P.z}E="undefined"!==o?o:new i.Color(.5,.5,.5,1);var O=u||1;return(T=new i.Primitive).nbIndices=v||p/3,T.connectivity=this.glType,T.attr={fill:new i.FillAttributes(E),line:new i.LineAttributes(E),point:new i.PointAttributes(E,O)},(A=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,A.nbVertices=p/3,A.nbValuesPerVertex=3,A.format=i.DataTypeEnum.FLOAT,A.cardinality=0,A.bufferId=0,A.indices=null,v&&(A.indices=new i.IndexArray,A.indices.format=i.DataTypeEnum.UINT,A.indices.bufferId=3,A.indices.offset=0),T.addVertexComponent(A),f&&((D=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,D.nbVertices=f/3,D.nbValuesPerVertex=3,D.format=i.DataTypeEnum.FLOAT,D.cardinality=0,D.bufferId=1,D.indices=null,v&&(D.indices=new i.IndexArray,D.indices.format=i.DataTypeEnum.UINT,D.indices.bufferId=3,D.indices.offset=0),T.addVertexComponent(D)),g&&((I=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,I.nbVertices=g/3,I.nbValuesPerVertex=3,I.format=i.DataTypeEnum.FLOAT,I.cardinality=0,I.bufferId=2,I.indices=null,v&&(I.indices=new i.IndexArray,I.indices.format=i.DataTypeEnum.UINT,I.indices.bufferId=3,I.indices.offset=0),T.addVertexComponent(I)),m&&((R=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,R.nbVertices=m/3,R.nbValuesPerVertex=3,R.format=i.DataTypeEnum.FLOAT,R.cardinality=0,R.bufferId=4,R.indices=null,v&&(R.indices=new i.IndexArray,R.indices.format=i.DataTypeEnum.UINT,R.indices.bufferId=3,R.indices.offset=0),T.addVertexComponent(R)),_.addPrimitive(T),l&&(l.force=!0,_.material=l),_.noz=c>0,_},createText:function(e,i,n,s,a,o){var l,h,c,d,u,p,f,g,m;void 0===a&&(a=32),l="font-family: "+i+"; font-size: "+a+"px;",u=(c=(h=this._determineTextSize(e,l)).width)/(d=h.height),(p=r).width=c,p.height=d,(f=p.getContext("2d")).fillStyle="#"+s.getHexString(),f.lineWidth=0,f.strokeStyle="#"+s.getHexString(),f.font=a+"px "+i,f.textAlign="left",f.textBaseline="top",f.fillText(e,0,0),f.restore(),g=c/a,m=this.createRectangle(n*g,n*g/u,!0,void 0,void 0,o);var v=void 0;if(0!=p.width||0!=p.height){for(var _=f.getImageData(0,0,p.width,p.height),y=new ArrayBuffer(_.data.length),S=new Uint8Array(y),x=0;x<4*p.width*p.height;++x)S[x]=_.data[x];(v=new t.DataTexture(S,p.width,p.height,t.RGBAFormat,t.UnsignedByteType,new t.UVMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearMipMapLinearFilter)).needsUpdate=!0}return m.material=new t.MeshBasicMaterial({map:v,transparent:!0}),m.material.force=!0,m.noz=o>0,m},convertFromTHREEMesh:function(e){if(e instanceof t.Mesh){var r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O=function(e,t,i,r){return Math.abs(e.x-t[i])<1e-5&&Math.abs(e.y-t[i+1])<1e-5&&(2===r||Math.abs(e.z-t[i+2])<1e-5)},L={x:0,y:0};if(0===(R=e.geometry)._type){D=[],I=[],T=!1;var V=R.faces,F=R.faceVertexUvs[0];for(r=0;r<V.length;r++)I[r]={face:V[r],uv:F?F[r]:null};for(e.material instanceof t.MeshFaceMaterial&&(T=!0,I.sort(function(e,t){return e.face.materialIndex-t.face.materialIndex})),o=0,l=0,C=0,M=[],P=0,A=I.length&&void 0!==I[0].face.materialIndex?I[0].face.materialIndex:-1,r=0;r<I.length;r++){var B=I[r].face;T&&A!==B.materialIndex&&(M[C]={nbIndices:o,nbVertices:l,start:P,end:r,material:T?e.material.materials[A]:e.material},C+=1,P=r,o=0,l=0,A=B.materialIndex),B instanceof t.Face3?(o+=3,l+=3):(o+=6,l+=4)}0!=o&&(M[C]={nbIndices:o,nbVertices:l,start:P,end:r,material:T?e.material.materials[A]:e.material}),f=R.vertices;var N=new Int32Array(f.length),G=["a","b","c","d"];for(a=0;a<M.length;a++){var k=M[a],U=!1;l=k.nbVertices,o=k.nbIndices,h=new Float32Array(3*l),c=new Float32Array(3*l),d=new Float32Array(3*l),u=new Float32Array(3*l),p=new Uint32Array(o);var z=0;for(r=0;r<N.length;r++)N[r]=-1;for(P=k.start,E=k.end,s=0,r=P;r<E;r++){g=I[r].face,b=I[r].uv,v=g.vertexNormals&&g.vertexNormals.length?g.vertexNormals:null,_=g.vertexColors&&g.vertexColors.length?g.vertexColors:null,y=g.normal,null,v&&v.length||(v=null),_&&_.length||(_=null);var H=g instanceof t.Face4?4:3;for(n=0;n<H;n++){var W;S=v?v[n]:y,x=_?_[n]:null,w=b?b[n]:L,-1===(W=N[g[G[n]]])||!O(S,c,3*W,3)||!O(w,u,3*W,2)||x&&!O(x,d,3*W,3)?(N[g[G[n]]]=z,m=f[g[G[n]]],h[3*z]=m.x,h[3*z+1]=m.y,h[3*z+2]=m.z,c[3*z]=S.x,c[3*z+1]=S.y,c[3*z+2]=S.z,x&&(U=!0,d[3*z]=x.r,d[3*z+1]=x.g,d[3*z+2]=x.b),u[3*z]=w.x,u[3*z+1]=w.y,u[3*z+2]=0,3===n&&(p[s++]=p[s-4],p[s++]=p[s-3]),p[s++]=z++):(3===n&&(p[s++]=p[s-4],p[s++]=p[s-3]),p[s++]=W)}}var j=new Float32Array(3*z),X=new Float32Array(3*z),q=new Float32Array(3*z),Z=new Float32Array(3*z);for(r=0;r<3*z;r++)j[r]=h[r],X[r]=c[r],q[r]=d[r],Z[r]=u[r];h=j,c=X,d=U?q:null,u=Z,U&&(k.material.vertexColors=t.VertexColorType.RGBA),D[D.length]={bufPos:h,bufNorm:c,bufCol:d,bufUV:u,bufInd:p,connectivity:i.ConnectivityTypeEnum.TRIANGLES,material:k.material}}return this.createPrimGroup(D)}}},createPrimGroup:function(e){var t,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y;for((o=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,o.lineAttr=new i.LineAttributes,o.pointAttr=new i.PointAttributes,p=0;p<e.length;p++){var S=(x=!!e[p].bufCol)?5:4;t=e[p].bufPos.length,r=e[p].bufNorm.length,x&&(n=e[p].bufCol.length),s=e[p].bufUV.length,a=e[p].bufInd.length,(l=new i.Buffer).size=t,l.component=i.VertexComponentEnum.POSITION,l.format=i.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(e[p].bufPos),(h=new i.Buffer).size=r,h.component=i.VertexComponentEnum.NORMAL,h.format=i.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(e[p].bufNorm),x&&((c=new i.Buffer).size=n,c.component=i.VertexComponentEnum.DIFFUSE_COLOR,c.format=i.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(e[p].bufCol)),(d=new i.Buffer).size=s,d.component=i.VertexComponentEnum.TEX_COORD_0,d.format=i.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(e[p].bufUV),(u=new i.Buffer).indexBuffer=!0,u.size=a,u.format=i.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint32Array(e[p].bufInd),o.addBuffer(p*S,l),o.addBuffer(1+p*S,h),o.addBuffer(2+p*S,d),o.addBuffer(3+p*S,u),x&&o.addBuffer(4+p*S,c)}for(f=new i.Color(.5,.5,.5,1),p=0;p<e.length;p++){var x;S=(x=!!e[p].bufCol)?5:4;switch(t=e[p].bufPos.length,r=e[p].bufNorm.length,x&&(n=e[p].bufCol.length),s=e[p].bufUV.length,a=e[p].bufInd.length,(g=new i.Primitive).nbIndices=a,g.connectivity=e[p].connectivity,g.connectivity){case i.ConnectivityTypeEnum.TRIANGLES:case i.ConnectivityTypeEnum.TRIANGLE_FAN:case i.ConnectivityTypeEnum.TRIANGLE_STRIP:g.geomType="FACE";break;case i.ConnectivityTypeEnum.LINES:case i.ConnectivityTypeEnum.LINE_STRIP:case i.ConnectivityTypeEnum.LINE_LOOP:g.geomType="WIRE_EDGE";break;case i.ConnectivityTypeEnum.POINTS:g.geomType="FREE_POINT";break;default:g.geomType=null}g.attr={fill:new i.FillAttributes(f),line:new i.LineAttributes,point:new i.PointAttributes},(m=new i.VertexComponent).component=i.VertexComponentEnum.POSITION,m.nbVertices=t/3,m.nbValuesPerVertex=3,m.format=i.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=p*S,m.indices=new i.IndexArray,m.indices.format=i.DataTypeEnum.UINT,m.indices.bufferId=3+p*S,m.indices.offset=0,(v=new i.VertexComponent).component=i.VertexComponentEnum.NORMAL,v.nbVertices=r/3,v.nbValuesPerVertex=3,v.format=i.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=1+p*S,v.indices=new i.IndexArray,v.indices.format=i.DataTypeEnum.UINT,v.indices.bufferId=3+p*S,v.indices.offset=0,x&&((_=new i.VertexComponent).component=i.VertexComponentEnum.DIFFUSE_COLOR,_.nbVertices=n/3,_.nbValuesPerVertex=3,_.format=i.DataTypeEnum.FLOAT,_.cardinality=0,_.bufferId=4+p*S,_.indices=new i.IndexArray,_.indices.format=i.DataTypeEnum.UINT,_.indices.bufferId=3+p*S,_.indices.offset=0),(y=new i.VertexComponent).component=i.VertexComponentEnum.TEX_COORD_0,y.nbVertices=s/3,y.nbValuesPerVertex=3,y.format=i.DataTypeEnum.FLOAT,y.cardinality=0,y.bufferId=2+p*S,y.indices=new i.IndexArray,y.indices.format=i.DataTypeEnum.UINT,y.indices.bufferId=3+p*S,y.indices.offset=0,g.addVertexComponent(m),g.addVertexComponent(v),x&&g.addVertexComponent(_),g.addVertexComponent(y),g.material=e[p].material,o.addPrimitive(g)}return e[0]&&e[0].material&&(o.material=e[0].material),o},CreateVis3DCuboidFromBox3:function(e,t){var r,n,s,a,o,l,h,c,d,u,p=void 0!==t.color?t.color:new i.Color(.5,.5,.5,1);for((r=new i.PrimitiveGroup).fillAttr=new i.FillAttributes,r.lineAttr=new i.LineAttributes,r.pointAttr=new i.PointAttributes,(n=new i.Buffer).size=72,n.component=i.VertexComponentEnum.POSITION,n.format=i.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(s=new i.Buffer).size=72,s.component=i.VertexComponentEnum.NORMAL,s.format=i.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size),(a=new i.Buffer).indexBuffer=!0,a.size=36,a.format=i.DataTypeEnum.UINT,a.dimension=1,a.data=new Uint16Array(36),r.addBuffer(0,n),r.addBuffer(1,s),r.addBuffer(2,a),o=a.data,l=0,h=0;h<6;h++)o[l++]=4*h,o[l++]=4*h+1,o[l++]=4*h+2,o[l++]=4*h,o[l++]=4*h+2,o[l++]=4*h+3;var f=e.min.x,g=e.max.x,m=e.min.y,v=e.max.y,_=e.min.z,y=e.max.z;for(l=0,(o=n.data)[l++]=g,o[l++]=m,o[l++]=_,o[l++]=g,o[l++]=v,o[l++]=_,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=g,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=_,o[l++]=g,o[l++]=m,o[l++]=_,o[l++]=g,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=f,o[l++]=m,o[l++]=_,o[l++]=f,o[l++]=m,o[l++]=y,o[l++]=f,o[l++]=v,o[l++]=y,o[l++]=g,o[l++]=m,o[l++]=_,o[l++]=f,o[l++]=m,o[l++]=_,o[l++]=f,o[l++]=v,o[l++]=_,o[l++]=g,o[l++]=v,o[l++]=_,o=s.data,l=0,h=0;h<4;h++)o[l++]=1,o[l++]=0,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=1,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=0,o[l++]=1;for(h=0;h<4;h++)o[l++]=0,o[l++]=-1,o[l++]=0;for(h=0;h<4;h++)o[l++]=-1,o[l++]=0,o[l++]=0;for(h=0;h<4;h++)o[l++]=0,o[l++]=0,o[l++]=-1;for(h=0;h<6;h++)c=new i.Primitive({nbIndices:6,connectivity:i.ConnectivityTypeEnum.TRIANGLES,fillGAS:new i.FillAttributes(p,1),lineGAS:new i.LineAttributes,pointGAS:new i.PointAttributes}),d=new i.VertexComponent({nbVertices:4,bufferId:0,indices:new i.IndexArray({bufferId:2,offset:6*h})}),u=new i.VertexComponent({nbVertices:4,bufferId:1,indices:new i.IndexArray({bufferId:2,offset:6*h})}),c.addVertexComponent(d),c.addVertexComponent(u),r.addPrimitive(c);return r},_determineTextSize:function(e,t,i){var r,n,s,a,o;r=document.getElementsByTagName("body")[0],(n=document.createElement("div")).setAttribute("style",t);var l=i||"nowrap";return(s=document.createElement("span")).setAttribute("style","white-space: "+l),a=document.createTextNode(e),s.appendChild(a),n.appendChild(s),r.appendChild(n),(o={width:0,height:0}).width=s.offsetWidth,o.height=s.offsetHeight,r.removeChild(n),o}});return UWA.namespace("THREEDS/GeometryHelper",n)}),define("Visualization/GeometryHelper",["DS/Visualization/GeometryHelper","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/GeometryHelper"),e}),define("DS/Visualization/ClippingPolyLineData",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/PolyLineSectionUtils"],function(e,t){"use strict";function i(e){this.polyLines=null,this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.hasTransform=!1,this.lastFrameIndex=-1,this.lastCamera=null,e&&this.setParams(e)}function r(){this.transform=!1,this.planeU=null,this.planeV=null,this.points2d=null,this.closedPoints2d=null,this.isOpen=!1,this.viewPlaneU=null,this.viewPlaneV=null,this.viewPoints2d=null,this.matrix=null}return i.prototype.setParams=function(e){this.polyLines=[],this.clippingPolygonTexture=null,this.boundingSphere=null,this.hasOpenPolyLine=!1,this.lastFrameIndex=-1,this.lastCamera=null,this.hasTransform=e.csiParams&&e.csiParams.transform||!1,e.csiParams?this.setCSI(e.csiParams):this.setSingle(e)},i.prototype.getForOccurrenceOverride=function(e){if(this.hasTransform){var t,r=new i(null,e);for(r.hasOpenPolyLine=this.hasOpenPolyLine,r.polyLines=[],t=0;t<this.polyLines.length;t++)r.polyLines.push(this.polyLines[t].getForOccurrenceOverride(e));return r.hasTransform=this.hasTransform,r}return this},i.prototype.setCSI=function(e){this.polyLinePoints=[];var t,i=[];for(t=0;t<e.vertexCounts.length;t++)i.push(e.vertexCounts[t]);var r,n=0;e.vertices.length;for(t=0;t<e.curveCount;t++)r=this.createPolyLineFromCSI(e,t,n,i[t]),this.polyLines.push(r),n+=i[t]},i.prototype.createPolyLineFromCSI=function(t,i,n,s){var a,o,l=new e.Vector3(t.normals[3*i],t.normals[3*i+1],t.normals[3*i+2]);l.normalize(),a=new e.Vector3(1,0,0),(o=new e.Vector3(0,0,0)).crossVectors(l,a),o.norm<.001&&(a=new e.Vector3(0,1,0),o.crossVectors(l,a)),o.normalize();var h,c,d=[],u=new e.Vector3;for(h=0;h<s;h++)c=3*(n+h),u.x=t.vertices[c],u.y=t.vertices[c+1],u.z=t.vertices[c+2],d.push(new e.Vector2(u.dot(a),u.dot(o)));var p=!1;d[0].distanceTo(d[d.length-1])<1e-9?d.splice(d.length-1,1):(this.hasOpenPolyLine=!0,p=!0);var f=new r;return f.set(a,o,new e.Vector3,d,p,t.transform),f},i.prototype.createTexture=function(){this.clippingPolygonTexture&&(this.clippingPolygonTexture.dispose(),this.clippingPolygonTexture=null);var t,i,r=0;for(t=0;t<this.polyLines.length;t++)r+=(i=this.polyLines[t]).viewPoints2d.length;var n,s,a=new Float32Array(4*r),o=0;for(t=0;t<this.polyLines.length;t++)for(s=(i=this.polyLines[t]).viewPoints2d.length,n=0;n<s;n++)a[o]=i.viewPoints2d[n].x,a[o+1]=i.viewPoints2d[n].y,a[o+2]=0,a[o+3]=1,o+=4;this.clippingPolygonTexture=new e.DataTexture(a,r,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this.clippingPolygonTexture.needsUpdate=!0},i.prototype.setSingle=function(t){var i=t.planeOrigin?t.planeOrigin.clone():new e.Vector3,n=t.planeU.clone();n.normalize();var s=t.planeV.clone();s.normalize();var a=new r;a.set(n,s,i,t.polyLinePoints,!1,!1),this.polyLines.push(a)},i.prototype.getMaxSize=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e].getClosedSize();i>t&&(t=i)}return t},i.prototype.updateCamera=function(t,i){if(t!==this.lastCamera||this.lastFrameIndex!==i||!this.clippingPolygonTexture){var r,n=t.matrixWorldInverse,s=null,a=null,o=null;for(r=0;r<this.polyLines.length;r++)(o=this.polyLines[r]).transform?(o.matrix!==a&&((s=new e.Matrix4).multiplyMatrices(t.matrixWorldInverse,o.matrix),a=o.matrix),o.applyViewMatrix(s)):o.applyViewMatrix(n);this.lastCamera=t,this.lastFrameIndex=i,this.clippingPolygonTexture=null}},i.prototype.getTexture=function(e,t){return this.clippingPolygonTexture||this.createTexture(),this.clippingPolygonTexture},i.prototype.updateBoundingSphere=function(e){var t,i;if(e&&this.hasOpenPolyLine&&(!this.boundingSphere||!e.equals(this.boundingSphere)))for(this.boundingSphere=e.clone(),i=0;i<this.polyLines.length;i++)(t=this.polyLines[i]).isOpen&&(t.applyBoundingSphere(e),this.clippingPolygonTexture=null)},i.prototype.dbgDump=function(){var e,t={count:this.polyLines.length,planeU:[],planeV:[],polyLineSize:[]};for(e=0;e<this.polyLines.length;e++){var i=this.polyLines[e];t.planeU.push(i.planeU),t.planeV.push(i.planeV),t.polyLineSize.push(i.points2d.length)}return t},i.prototype.getCount=function(){return this.polyLines.length},i.merge=function(e,t){var r=null;return e&&t?((r=new i(null,null)).polyLines=e.polyLines.concat(t.polyLines),r.hasOpenPolyLine=e.hasOpenPolyLine||t.hasOpenPolyLine,r.hasTransform=e.hasTransform||t.hasTransform):r=e||t,r},r.prototype.set=function(t,i,r,n,s,a){var o;for(this.transform=!!a,this.planeU=t,this.planeV=i,this.points2d=[],o=0;o<n.length;o++)this.points2d.push(new e.Vector2(n[o].x+t.dot(r),n[o].y+i.dot(r)));this.closedPoints2d=s?null:this.points2d,this.isOpen=s,this.viewPlaneU=new e.Vector3,this.viewPlaneV=new e.Vector3,this.viewPoints2d=[]},r.prototype.getClosedSize=function(){return this.closedPoints2d.length},r.prototype.applyViewMatrix=function(t){this.viewPlaneU.copy(this.planeU),this.viewPlaneV.copy(this.planeV),this.viewPlaneU.applyRotation(t),this.viewPlaneV.applyRotation(t);var i=new e.Vector3;i.applyMatrix4(t),this.viewPoints2d=[];var r,n=new e.Vector2,s=new e.Vector2(i.dot(this.viewPlaneU),i.dot(this.viewPlaneV));for(r=0;r<this.closedPoints2d.length;r++)n=this.closedPoints2d[r],this.viewPoints2d.push(new e.Vector2(s.x+n.x,s.y+n.y))},r.prototype.applyBoundingSphere=function(i){if(this.isOpen){var r=t.makeClosedPolyLine({planeOrigin:new e.Vector3,planeU:this.planeU,planeV:this.planeV,polyLinePoints:this.points2d},i,!1);this.closedPoints2d=r.polyLinePoints}},r.prototype.getForOccurrenceOverride=function(e){if(e){var t=new r;return t.transform=this.transform,t.planeU=this.planeU,t.planeV=this.planeV,t.points2d=this.points2d,t.closedPoints2d=this.closedPoints2d,t.isOpen=this.isOpen,t.viewPlaneU=this.viewPlaneU,t.viewPlaneV=this.viewPlaneV,t.viewPoints2d=this.viewPoints2d,t.matrix=this.matrix||e,t}return this},i}),define("DS/Visualization/RenderTargetPool",["DS/Visualization/ThreeJS_DS","DS/GPURenderer/WebGPURenderTarget"],function(e,t){"use strict";class i{constructor(){}}class r{constructor(){this.renderTargetPool=[],this.rtpStats={nbCreation:0},this.renderTargetClass=null,this.renderTargetCubeClass=null}areRenderTargetOptionsEqual(e,t){return e&&t?e.height===t.height&&e.width===t.width&&e.options===t.options:e===t}dumpPool(){var e,t="dumpPool: [";for(e=0;e<this.renderTargetPool.length;e++)e>0&&(t+=", "),t+=this.renderTargetPool[e].uniqueID;t+="]",console.log(t)}resetRenderTargetPool(){var e=0;for(e=0;e<this.renderTargetPool.length;e++)this.renderTargetPool[e].dispose();this.renderTargetPool=[]}pushRenderTarget(e,t){if(e){for(var i=!1,r=0;r<this.renderTargetPool.length;r++)this.renderTargetPool[r].uniqueID==e.uniqueID&&(i=!0);i||this.renderTargetPool.push(e)}}buildRenderTarget(e,t,i,r,n){var s,a,o=this.rtOptionsMap[i],l=null,h=-1,c=r||1;for(n=!!n,a=0;a<this.renderTargetPool.length&&h<0;a++)(s=this.rtOptionsMap[this.renderTargetPool[a].optionsId])&&s.type===o.type&&i===this.renderTargetPool[a].optionsId&&this.renderTargetPool[a].width===e&&this.renderTargetPool[a].height===t&&this.renderTargetPool[a].multisample===n&&this.renderTargetPool[a].colorCount===c&&((l=this.renderTargetPool[a]).reset(o),h=a);return h>=0&&this.renderTargetPool.splice(h,1),l||(l="cubelinear"===i?new this.renderTargetCubeClass(e,t,o,1,n):new this.renderTargetClass(e,t,o,c,n),e>0&&t>0&&this.rtpStats.nbCreation++),l.optionsId=i,l}}class n extends r{constructor(r){super(),this.renderTargetClass=t,this.renderTargetCubeClass=i,this._screenRenderTarget=null,this._formats=new Map;let n=new Map,s=new Map,a=new Map;this._formats.set("float",n),this._formats.set("float16",s),this._formats.set("int8",a),n.set("RGBA","rgba32float"),s.set("RGBA","rgba16float"),a.set("RGBA","rgba8unorm"),a.set("BGRA","bgra8unorm"),a.set("RGB","rgba8unorm");var o=e._mobileDevice?"float16":"float";this.rtOptionsMap={linear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("float16").get("RGBA"),type:"float"},nearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("float").get("RGBA"),type:"float"},maxPrecisionLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("float").get("RGBA"),type:"float"},maxPrecisionNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("float").get("RGBA"),type:"float"},halfLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("float16").get("RGBA"),type:"float16"},halfNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("float16").get("RGBA"),type:"float16"},uint:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGBA"),type:"int8"},uintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGBA"),type:"int8"},uintRGBLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGB"),type:"int8"},uintRGBLinearNoStencil:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGB"),type:"int8"},uintRGBNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGB"),type:"int8"},uintRGBNearestNoStencil:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGB"),type:"int8"},cubelinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("float").get("RGBA"),type:"float"},decal:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get(o).get("RGBA"),type:o},decalTex:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get(o).get("RGBA"),type:o},maxPrecisionLinearNoStencilHFMobile:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get(o).get("RGBA"),type:o},iblUintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGBA"),type:"int8"},iblUintLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:this._formats.get("int8").get("RGBA"),type:"int8"},oitAccumLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("float16").get("RGBA"),type:"float16"},oitRevealLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:this._formats.get("int8").get("RGB"),type:"int8"}}}}class s extends r{constructor(t){super(),this.renderTargetClass=e.WebGLRenderTarget,this.renderTargetCubeClass=e.WebGLRenderTargetCube;var i=e.FloatType,r=e.HalfFloatType,n=e.FloatType,s=e._mobileDevice?e.HalfFloatType:e.FloatType;t.supportsFloatTextures()||(i=e.UnsignedByteType,n=e.HalfFloatType,s=e.HalfFloatType),t.supportsHalfFloatTextures()||(n=e.UnsignedByteType,s=e.UnsignedByteType,r=e.UnsignedByteType),t.supportsFloatTextures()&&!t.supportsHalfFloatTextures()&&(n=e.FloatType,s=e.FloatType,r=e.FloatType),e.IsIE11&&(r=i,n=i,s=i),this.rtOptionsMap={linear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:i},nearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:i},maxPrecisionLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:n},maxPrecisionNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:n},halfLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:r},halfNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:r},uint:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:e.UnsignedByteType},uintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBAFormat,type:e.UnsignedByteType},uintRGBLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBFormat,type:e.UnsignedByteType},uintRGBLinearNoStencil:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:e.RGBFormat,type:e.UnsignedByteType},uintRGBNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!0,format:e.RGBFormat,type:e.UnsignedByteType},uintRGBNearestNoStencil:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBFormat,type:e.UnsignedByteType},cubelinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:i},decal:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBAFormat,type:s},decalTex:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBAFormat,type:s},maxPrecisionLinearNoStencilHFMobile:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:e.RGBAFormat,type:s},iblUintNearest:{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1,format:e.RGBAFormat,type:e.UnsignedByteType},iblUintLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1,format:e.RGBAFormat,type:e.UnsignedByteType},oitAccumLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBAFormat,type:r},oitRevealLinear:{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!0,format:e.RGBFormat,type:e.UnsignedByteType}}}}return{get:function(e){return e.use_webgpu?new n(e):new s(e)}}}),define("Visualization/RenderTargetPool",["DS/Visualization/RenderTargetPool","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/RenderTargetPool"),e}),define("DS/Visualization/Measurable",["UWA/Class","DS/Visualization/ThreeJS_R57"],function(e,t){"use strict";var i=[0,8,8,2,2],r=new Uint8Array(4),n=new DataView(r.buffer,0,4),s=new Uint8Array(8),a=new DataView(s.buffer,0,8),o=e.extend({init:function(e){this.sgNode=e,this.size=-1;var t,i=e.getDecoration();if(i){if(i instanceof Array)this.string=i,this.size=this.string[0];else if(e&&(t=e.getGroup())&&t.geometry)if(t.geometry.decorations&&t.geometry.decorations.length){var r=t.geometry.decorations,n=i-1;this.size=r[n]+1,this.string=new Array(this.size);for(var s=0;s<this.size;s++)this.string[s]=r[n++]}else this.string=[]}else this.string=[];this.type=null,this.version=0,this.conversion=!0},getType:function(){return 0==this.size?this.type=o.TYPEUNKNOWN:this.size>0?this.readHeader():this.type=null,this.type},readHeader:function(){var e=0;if(this.size>=i[3]){if(0==this.string[1]){if(this.size>=i[1]){var t=this.readInt(1,2);return this.version=t[0],void(this.type=t[1])}}else this.string[1]=="2".charCodeAt(0)?this.version=2:this.string[1]=="3".charCodeAt(0)?this.version=3:this.string[1]=="4".charCodeAt(0)?this.version=4:this.string[1]=="5".charCodeAt(0)&&(this.version=5),e=this.string[2];switch(e){case 49:this.type=o.TYPEUNKNOWN;break;case 50:this.type=o.TYPEPLANE;break;case 51:this.type=o.TYPECYLINDER;break;case 52:this.type=o.TYPECONE;break;case 53:this.type=o.TYPESPHERE;break;case 54:this.type=o.TYPELINE;break;case 55:this.type=o.TYPECIRCLE;break;case 56:this.type=o.TYPETORUS}}},getPlane:function(){return this.type==o.TYPEPLANE?this.readPlane():null},getCone:function(){return this.type==o.TYPECONE?this.readCone():null},getSphere:function(){return this.type==o.TYPESPHERE?this.readSphere():null},getCircle:function(){return this.type==o.TYPECIRCLE?this.readCircle():null},getCylinder:function(){return this.type==o.TYPECYLINDER?this.readCylinder():null},getLine:function(){return this.type==o.TYPELINE?this.readLine():null},getTorus:function(){return this.type==o.TYPETORUS?this.readTorus():null},readTorus:function(){var e=[0,0,0],t=[0,0,1],r=0,n=0,s=[];if(3==this.version){var a=(s=this.readFloat(i[this.version]+1,8))[0],o=s[1],l=s[2],h=s[3],c=s[4],d=s[5],u=s[6],p=1-h*h-c*c,f=p>=0?Math.sqrt(p):0;d<0&&(f=-f,d=-d),e=[a,o,l],t=[h,c,f],r=u,n=d}else 1==this.version||2==this.version||4==this.version?(e=[(s=this.readDouble(i[this.version]+1,8))[0],s[1],s[2]],t=[s[3],s[4],s[5]],r=s[7],n=s[6]):this.version;return{center:e,axis:t,maxRadius:n,minRadius:r}},readCone:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var s=(n=this.readFloat(i[this.version]+1,7))[0],a=n[1],o=n[2],l=n[3],h=n[4],c=n[5],d=1-l*l-h*h,u=d>=0?Math.sqrt(d):0;c<0&&(u=-u,c=-c);e=[s,a,o],t=[l,h,u],r=c}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,semiAngle:r}},readCircle:function(){var e=[0,0,0],r=[0,0,1],n=0,s=[];if(3==this.version){e=[(s=this.readFloat(i[this.version]+1,7))[0],s[1],s[2]],n=s[3];var a=this.sgNode.getStart(),o=this.sgNode.getGroup().geometry,l=o.vertexIndexArray[a],h=[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]],c=(l=o.vertexIndexArray[a+1],[o.vertexPositionArray[3*l],o.vertexPositionArray[3*l+1],o.vertexPositionArray[3*l+2]]),d=new t.Vector3(h[0],h[1],h[2]),u=new t.Vector3(c[0],c[1],c[2]),p=new t.Vector3(e[0],e[1],e[2]);u.sub(d),p.sub(d),u.cross(p),u.normalize(),r=[u.x,u.y,u.z]}else 1==this.version||2==this.version||4==this.version?(e=[(s=this.readDouble(i[this.version]+1,7))[0],s[1],s[2]],r=[s[3],s[4],s[5]],n=s[6]):this.version;return{center:e,axis:r,radius:n}},readCylinder:function(){var e=[0,0,0],t=[0,0,1],r=0,n=[];if(3==this.version){var s=(n=this.readFloat(i[this.version]+1,7))[0],a=n[1],o=n[2],l=n[3],h=n[4];r=n[5];var c=1-l*l-h*h,d=c>=0?Math.sqrt(c):0;r<0&&(d=-d,r=-r),e=[s,a,o],t=[l,h,d]}else 1==this.version||2==this.version||4==this.version?(e=[(n=this.readDouble(i[this.version]+1,7))[0],n[1],n[2]],t=[n[3],n[4],n[5]],r=n[6]):this.version;return{center:e,axis:t,radius:r}},readSphere:function(){var e=[0,0,0],t=0,r=[];if(3==this.version){var n=(r=this.readFloat(i[this.version]+1,4))[0],s=r[1],a=r[2];t=r[3],e=[n,s,a]}else 1==this.version||2==this.version||4==this.version?(e=[(r=this.readDouble(i[this.version]+1,4))[0],r[1],r[2]],t=r[3]):this.version;return{center:e,radius:t}},readLine:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),s=this.sgNode.getGroup().geometry,a=s.vertexIndexArray[n];e=[s.vertexPositionArray[3*a],s.vertexPositionArray[3*a+1],s.vertexPositionArray[3*a+2]];a=s.vertexIndexArray[n+1];t=[s.vertexPositionArray[3*a],s.vertexPositionArray[3*a+1],s.vertexPositionArray[3*a+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{startPosition:e,endPosition:t}},readPlane:function(){var e=[0,0,0],t=[1,0,0],r=[];if(3==this.version||5==this.version){var n=this.sgNode.getStart(),s=this.sgNode.getGroup().geometry,a=s.vertexIndexArray[n];e=[s.vertexPositionArray[3*a],s.vertexPositionArray[3*a+1],s.vertexPositionArray[3*a+2]],t=[s.vertexNormalArray[3*a],s.vertexNormalArray[3*a+1],s.vertexNormalArray[3*a+2]]}else 1!=this.version&&2!=this.version&&4!=this.version||(e=[(r=this.readDouble(i[this.version]+1,6))[0],r[1],r[2]],t=[r[3],r[4],r[5]]);return{normal:t,position:e}},readFloat:function(e,t){for(var i=new Array(t),s=0;s<t;s++)r[3]=this.string[e+4*s],r[2]=this.string[e+4*s+1],r[1]=this.string[e+4*s+2],r[0]=this.string[e+4*s+3],i[s]=n.getFloat32(0,this.conversion);return i},readInt:function(e,t){for(var i=new Array(t),s=0;s<t;s++)r[3]=this.string[e+4*s],r[2]=this.string[e+4*s+1],r[1]=this.string[e+4*s+2],r[0]=this.string[e+4*s+3],i[s]=n.getUint32(0,this.conversion);return i},readDouble:function(e,t){for(var i=new Array(t),r=0;r<t;r++)s[7]=this.string[e+8*r],s[6]=this.string[e+8*r+1],s[5]=this.string[e+8*r+2],s[4]=this.string[e+8*r+3],s[3]=this.string[e+8*r+4],s[2]=this.string[e+8*r+5],s[1]=this.string[e+8*r+6],s[0]=this.string[e+8*r+7],i[r]=a.getFloat64(0,this.conversion);return i}});return o.TYPEUNKNOWN=1,o.TYPEPLANE=2,o.TYPECYLINDER=3,o.TYPECONE=4,o.TYPESPHERE=5,o.TYPELINE=7,o.TYPECIRCLE=8,o.TYPETORUS=9,UWA.namespace("THREEDS/Measurable",o)}),define("Visualization/Measurable",["DS/Visualization/Measurable","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Measurable"),e}),define("DS/Visualization/BudgetedRenderManager",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){return this.viewer=e,this._frameTime=0,this._isActive=!1,this._isSimpleActive=!0,this._lastRefreshStamp=performance.now(),this._objectivePercentage=-1,this._shiftToObjective=0,this._shiftStart=0,this._renderTimeStart=0,this._lastRenderTime=16.7,this._lastRenderFrameTime=16.7,this._maxTime=0,this._simpleMaxTime=2e3,this._renderCallbackId=-1,this._startStamp=performance.now(),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1,this},_setAsRenderFrame:function(){this._isRenderFrame=!0},_askForRender:function(e){if(this._isActive||this._isSimpleActive)if(this._isSimpleActive){(i=(t=performance.now())-this._lastRefreshStamp)>this._simpleMaxTime&&(e.budgeted=!1,this._lastRefreshStamp=t,this.viewer.render(e))}else{var t,i=(t=performance.now())-this._lastRefreshStamp,r=(this._startStamp,this._objectivePercentage),n=(performance.now()-this._shiftStart)/this._shiftToObjective;r=1-(n=(n=Math.min(Math.max(0,n),1))*n*(3-2*n))+r*n;var s=this._lastRenderTime*(1-r)/r-i;if(s<=0||this._maxTime>0&&i>this._maxTime)e.budgeted=!1,this._lastRefreshStamp=t,this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1),this.viewer.render(e);else if(this._renderCallbackId<0){var a=this;this._renderCallbackId=setTimeout(function(){a.viewer.render(e)},s)}}else e.budgeted=!1,this.viewer.render(e)},_resetShift:function(){this._shiftStart=performance.now(),this._renderCallbackId>=0&&(clearTimeout(this._renderCallbackId),this._renderCallbackId=-1)},resetMeasures:function(){this._startStamp=performance.now(),this._lastRefreshStamp=performance.now(),this._lastrenderTime=16.7},setBudget:function(e){this._objectivePercentage=Math.max(0,Math.min(1,e)),this._isActive=!0,this._isSimpleActive=!1;var t=this;if(-1===this._preRenderCallBackId){this._preRenderCallBackId=this.viewer.onPreRender(function(){t._renderTimeStart=performance.now()});this._postRenderCallBackId=this.viewer.onPostRender(function(){t._lastRenderTime=performance.now()-t._renderTimeStart})}this.resetMeasures()},setSimpleBudget:function(e){this._isSimpleActive=e,e&&this._isActive&&(this._isActive=!1)},disableBudget:function(){this._isActive=!1,this._objectivePercentage=-1,this._preRenderCallBackId>=0&&(this.viewer.unsubscribe(this._preRenderCallBackId),this.viewer.unsubscribe(this._postRenderCallBackId),this._preRenderCallBackId=-1,this._postRenderCallBackId=-1)},setSimpleMaxTime:function(e){this._simpleMaxTime=e},setMaxTime:function(e){this._maxTime=e},setShiftingObjective:function(e){this._shiftToObjective=e}});return UWA.namespace("THREEDS/BudgetedRenderManager",i)}),define("DS/Visualization/Filters/FilteredFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.state=e}}}),define("DS/Visualization/Filters/ZModeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this.enableZ=e}}}),define("DS/Visualization/IdPath",["DS/Visualization/PathElement"],function(e){"use strict";var t=function(e){this.ids=e,this._key=null};return t.prototype.removeLastId=function(){this.ids.length>0&&this.ids.length--,this._key=null},t.prototype.clone=function(){var e,i=[];for(e=0;e<this.ids.length;e++)i.push(this.ids[e]);var r=new t(i);return r._key=this._key,r},t.prototype.buildPathElement=function(t){var i,r,n=[];for(r=0;r<this.ids.length;r++){if(!(i=t.idToNode(this.ids[r])))return null;n.push(i)}return new e(n)},t.prototype.getElement=function(e){return this.ids[e]},t.prototype.getLength=function(){return this.ids.length},t.prototype.getFirstElement=function(e){return this.ids[0]},t.prototype.getKey=function(){return null===this._key&&(this._key=t.buildIdPathKey(this.ids)),this._key},t.prototype.getLastId=function(){return this.ids[this.ids.length-1]},t.buildIdPathKey=function(e){var t,i="";for(t=e.length-1;t>=0;t--)i+=e[t],0!==t&&(i+="/");return i},t}),define("DS/Visualization/PickingMode",["DS/Visualization/ThreeJS_DS","DS/Visualization/RenderMode","DS/Mesh/Mesh"],function(e,t,i){"use strict";const r=new t;class n{constructor(){this.pickingModeMSB=e.ShowAllFaces|e.AllPointsButSurfacicPointsRenderPointMask|e.WireEdgeRenderLineModeMask,this.pickingModeLSB=e.BodyLinesMask|e.SurfacicPointRenderPointMask}clone(){var e=new n;return e.pickingModeMSB=this.pickingModeMSB,e.pickingModeLSB=this.pickingModeLSB,e}applyToAll(e){this.setPickingMode("Face",e),this.setPickingMode("InternalSharpEdge",e),this.setPickingMode("Edge",e),this.setPickingMode("InternalSmoothEdge",e),this.setPickingMode("_HighCurvatureEdge",e),this.setPickingMode("BoundaryEdge",e),this.setPickingMode("WireEdge",e),this.setPickingMode("BoundaryPoint",e),this.setPickingMode("SharpPoint",e),this.setPickingMode("SmoothPoint",e),this.setPickingMode("FreePoint",e),this.setPickingMode("AxisSystem",e),this.setPickingMode("InfiniteFace",e)}_fromRenderer(e){this.pickingModeLSB=e.pickingModeLSB,this.pickingModeMSB=e.pickingModeMSB}_getPickingMasks(e){var i=this.pickingModeLSB,r=this.pickingModeMSB,n=~r&i|r&i&~e|e&(r^i),s=n&t.pointsMask;return[n&t.facesMask,n&t.linesPickingMask,s]}getPickingMasks(e){var t=e.getMask();return this._getPickingMasks(t)}_setPickingMode(e,t){var r=this.pickingModeLSB,n=this.pickingModeMSB;switch(t){case i.PICK_NEVER:this.pickingModeMSB=n&~e,this.pickingModeLSB=r&~e;break;case i.PICK_ALWAYS:this.pickingModeMSB=n&~e,this.pickingModeLSB=r|e;break;case i.PICK_VISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r&~e;break;case i.PICK_INVISIBLE:this.pickingModeMSB=n|e,this.pickingModeLSB=r|e}}setPickingMode(e,t){r._mask=0,r.setRenderMode(e,!0),this._setPickingMode(r.getMask(),t)}}return e.PickingMode=n,n}),define("DS/Visualization/WebGLRenderer",["DS/Visualization/ThreeJS_DS","DS/GPUFormats/GPUFormats","DS/Visualization/BufferGPUManager","DS/Visualization/OutlineBuilder","DS/Visualization/SectionBuilder","DS/ShaderBuilders/Commons/DefaultShaders","DS/ShaderBuilders/ShaderUtils/TypeUtils","DS/Visualization/ShaderChunk","DS/Object3D/Light"],function(e,t,i,r,n,s,a,o,l){"use strict";var h=e._toFastProperties,c=l.DirectionalIBLLight.prototype._sortKey,d=new e.Color,u="";const p=e.BlockPoints;e.AutomatedTests()||localStorage.getItem("__WEBVISU_DEBUGGER_ON_COMPIL_FAIL__");var f={modelMatrix:1,modelViewMatrix:2,modelViewInvTranspMatrix:4,modelInvTranspMatrix:8,normalMatrix:32,quantizedVector:64,fixedSizeCenterRatio:128,lightMap:256,billboardType:512,decalStencilValue:1024,displacementRadius:2048,backgroundViewModeControl:4096,objectColorBufferType:8192,skinningMap:16384,skinningInstancingMaps:32768,backgroundViewModeNearFar:65536,belowInstancingModelMatrix:1<<17};e.__DefaultUVTransform__=e.__DefaultUVTransform__||new e.Matrix3;e.__DefaultUVTransform__;var g=function(){this.modelMatrix=null,this.modelViewMatrix=null,this.modelViewInvTranspMatrix=null,this.modelInvTranspMatrix=null,this.normalMatrix=null,this.quantizedVector=null,this.offsetVector=null,this.fixedSizeCenterRatio=null,this.lightMap=null,this.lightMapUvSlot=null,this.lightMapUvTransform=null,this.lightMapMappingType=null,this.billboardType=null,this.billboardRotationEnabled=null,this.billboardAxis=null,this.billboardRotation=null,this.modelInvRotMatrix=null,this.modelViewInvMatrix=null,this.decalStencilValue=null,this.decalExplicitUv=null,this.displacementRadius=null,this.objectColorBufferType=null,this.skinningMap=null,this.skinningInstancingMaps=null,this.backgroundViewModeControl=null,this.backgroundViewModeNearFar=null,this.belowInstancingModelMatrix=null,this.funcName="loadObjectUniforms"};g.prototype.computeFuncName=function(){var e=0;for(var t in f)null!==this[t]&&(e|=f[t]);switch(e){case f.modelMatrix:this.funcName="_load_MM";break;case f.modelMatrix|f.normalMatrix:this.funcName="_load_MM_NM";break;case f.modelViewMatrix:this.funcName="_load_MVM";break;case f.modelViewMatrix|f.normalMatrix:this.funcName="_load_MVM_NM";break;case f.modelMatrix|f.modelViewMatrix:this.funcName="_load_MM_MVM";break;case f.modelMatrix|f.modelViewMatrix|f.normalMatrix:this.funcName="_load_MM_MVM_NM";break;default:this.funcName="loadObjectUniforms"}};return class extends e.WebRenderer{constructor(t){super(t),this.__glResources__={renderTarget:{},geometry:[],geometryNullCount:0,texture:[],textureLODPool:new e.TextureLODPool,removeGeometryList:function(e){var t=new Set;e.forEach(function(e,i,r){t.add(e.id)});for(var i=0,r=0;r<this.geometry.length;r++){var n=this.geometry[r];if(n&&t.has(n.id)&&(i++,t.delete(n.id),this.geometry[r]=null,this.geometryNullCount++,i===e.size))break}this.tryClean()},tryClean:function(){this.geometryNullCount>=100&&(this.geometry=this.geometry.filter(function(e){return null!==e}),this.geometryNullCount=0)}},this.gl=null,this.glSupports={glExtensionTextureFloat:!1,glExtensionTextureHalfFloat:!1,glExtensionColorBufferFloat:!1,glExtensionColorBufferHalfFloat:!1,glExtensionTextureFloatLinear:!1,glExtensionTextureHalfFloatLinear:!1,glExtensionStandardDerivatives:!1,glExtensionKHRParallelShaderCompile:!1,completionStatusValue:!1,glExtensionTextureFilterAnisotropic:!1,glExtensionCompressedTextureS3TC:!1,glExtensionCompressedTextureRGTC:!1,glExtensionCompressedTextureBPTC:!1,glExtensionCompressedTextureASTC:!1,glExtensionCompressedTextureETC1:!1,glExtensionCompressedTextureETC:!1,glExtensionCompressedTexturePVRTC:!1,glExtensionFloatBlend:!1,renderToFloatTexture:!1,renderToHalfFloatTexture:!1,glExtensionInstancedArrays:!1,DSInstancedArrays:null,glExtensionElementIndexUint:!1,glExtensionFragDepth:!1,glExtensionBlendMinMax:!1,glExtensionDrawBuffers:!1,maxTextures:0,maxVertexTextures:0,maxTextureSize:0,maxCubemapSize:0,maxAnisotropy:0,supportsVertexTextures:!1,supportsBoneTextures:!1,compressedTextureFormats:[],vertexShaderPrecisionHighpFloat:null,vertexShaderPrecisionMediumpFloat:null,vertexShaderPrecisionLowpFloat:null,fragmentShaderPrecisionHighpFloat:null,fragmentShaderPrecisionMediumpFloat:null,fragmentShaderPrecisionLowpFloat:null,vertexShaderPrecisionHighpInt:null,vertexShaderPrecisionMediumpInt:null,vertexShaderPrecisionLowpInt:null,fragmentShaderPrecisionHighpInt:null,fragmentShaderPrecisionMediumpInt:null,fragmentShaderPrecisionLowpInt:null,highpAvailable:!1,mediumpAvailable:!1,highpIntAvailable:!1,mediumpIntAvailable:!1},this.initGL(t.context,t.debugContext,t.debugWebgl2);let s=this.gl,a=this.glSupports;a.maxTextures=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),a.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS),a.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),a.maxCubemapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE),a.vertexShaderPrecisionHighpFloat=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.HIGH_FLOAT),a.vertexShaderPrecisionMediumpFloat=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.MEDIUM_FLOAT),a.vertexShaderPrecisionLowpFloat=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.LOW_FLOAT),a.fragmentShaderPrecisionHighpFloat=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.HIGH_FLOAT),a.fragmentShaderPrecisionMediumpFloat=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.MEDIUM_FLOAT),a.fragmentShaderPrecisionLowpFloat=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.LOW_FLOAT),a.vertexShaderPrecisionHighpInt=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.HIGH_INT),a.vertexShaderPrecisionMediumpInt=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.MEDIUM_INT),a.vertexShaderPrecisionLowpInt=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.LOW_INT),a.fragmentShaderPrecisionHighpInt=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.HIGH_INT),a.fragmentShaderPrecisionMediumpInt=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.MEDIUM_INT),a.fragmentShaderPrecisionLowpInt=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.LOW_INT),(this.bufferGPUManager._device||this.bufferGPUManager._gl&&this.bufferGPUManager._gl!==s)&&(e.VisualizationTraces.info("WebGLRenderer: creating BufferGPUManager for"+s.contextId),this.bufferGPUManager=new i.__builder__),this.bufferGPUManager.setGLContext(this.id,s,this.info),this._inheritanceSolver.setContext(s,r,n),this.bufferUtils.setContext(s),this.buildDepthFunctionValues(),this.setDefaultGLState(),this.context=this.gl,a.maxAnisotropy=a.glExtensionTextureFilterAnisotropic?s.getParameter(a.glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,a.supportsVertexTextures=a.maxVertexTextures>0,a.supportsBoneTextures=a.supportsVertexTextures&&a.glExtensionTextureFloat,a.compressedTextureFormats=a.glExtensionCompressedTextureS3TC?s.getParameter(s.COMPRESSED_TEXTURE_FORMATS):[],a.highpAvailable=a.vertexShaderPrecisionHighpFloat.precision>0&&a.fragmentShaderPrecisionHighpFloat.precision>0,a.mediumpAvailable=a.vertexShaderPrecisionMediumpFloat.precision>0&&a.fragmentShaderPrecisionMediumpFloat.precision>0,"highp"!==this.precision||a.highpAvailable||(a.mediumpAvailable?(this.precision="mediump",e.VisualizationTraces.info("WebGLRenderer: highp not supported, using mediump")):(this.precision="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==this.precision||a.mediumpAvailable||(this.precision="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump not supported, using lowp")),a.highpIntAvailable=0===a.vertexShaderPrecisionHighpInt.precision&&0===a.fragmentShaderPrecisionHighpInt.precision,a.mediumpIntAvailable=0===a.vertexShaderPrecisionMediumpInt.precision&&0===a.fragmentShaderPrecisionMediumpInt.precision,"highp"!==this.precisionInt||a.highpIntAvailable||(a.mediumpIntAvailable?(this.precisionInt="mediump",e.VisualizationTraces.info("WebGLRenderer: highp int not supported, using mediump")):(this.precisionInt="lowp",e.VisualizationTraces.info("WebGLRenderer: highp and mediump int not supported, using lowp"))),"mediump"!==this.precisionInt||a.mediumpIntAvailable||(this.precisionInt="lowp",e.VisualizationTraces.info("WebGLRenderer: mediump int not supported, using lowp")),this._dummyMat3=new e.Matrix3,this._dummyMat4=new e.Matrix4}initGL(i,r,n){try{if(i)this.gl=i;else{if(n&&(this.gl=this.canvas.getContext("webgl2",{alpha:this.alpha,premultipliedAlpha:this.premultipliedAlpha,antialias:this.antialias,stencil:this.stencil,preserveDrawingBuffer:this.preserveDrawingBuffer,powerPreference:e._webglPerformanceProfile()})),!this.gl){var s={alpha:this.alpha,premultipliedAlpha:this.premultipliedAlpha,antialias:this.antialias,stencil:this.stencil,preserveDrawingBuffer:this.preserveDrawingBuffer,powerPreference:e._webglPerformanceProfile()};this.gl=this.canvas.getContext("webgl",s)||this.canvas.getContext("experimental-webgl",s),e.WebGLVersion=1}if(!this.gl)throw"Error creating WebGL context."}}catch(e){console.error(e)}!i&&r&&(this.gl=WebGLDebugUtils.makeDebugContext(this.gl,function(e,t,i){throw window.WebVisuTestsWebGLError=!0,"##WEBGLERROR## "+WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t}));let a=this.gl;this.gpuStates,a._enabledAttributes||(a._enabledAttributes={}),a.hasOwnProperty("contextId")||(e.lastContextId++,a.contextId=e.lastContextId),a._currentProgram||(a._currentProgram=null),a._oldBlending||(a._oldBlending=-1),e.enableWebGLStats&&(e.webGLStats={reset:function(){this.useProgram_nb=0,this.bindBuffer_nb=0,this.drawElements_nb=0},dump:function(){console.log({useProgram_nb:this.useProgram_nb,bindBuffer_nb:this.bindBuffer_nb,drawElements_nb:this.drawElements_nb})},useProgram_nb:0,bindBuffer_nb:0,drawElements_nb:0},a.useProgram_save=a.useProgram,a.useProgram=function(){e.webGLStats.useProgram_nb++,a.useProgram_save.apply(a,arguments)},a.bindBuffer_save=a.bindBuffer,a.bindBuffer=function(){e.webGLStats.bindBuffer_nb++,a.bindBuffer_save.apply(a,arguments)},a.drawElements_save=a.drawElements,a.drawElements=function(){e.webGLStats.drawElements_nb++,a.drawElements_save.apply(a,arguments)}),this.supportedExt=a.getSupportedExtensions(),this.getExtension=function(e){return this.supportedExt.indexOf(e)>=0?a.getExtension(e):null};let o=this.glSupports;o.glExtensionColorBufferFloat=!e._mobileDevice&&this.getExtension("WEBGL_color_buffer_float")||this.getExtension("EXT_color_buffer_float"),o.glExtensionColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")||this.getExtension("EXT_color_buffer_float"),o.glExtensionTextureHalfFloat=2===e.WebGLVersion||this.getExtension("OES_texture_half_float"),o.glExtensionTextureFloat=2===e.WebGLVersion||this.getExtension("OES_texture_float"),o.glExtensionTextureFloatLinear=this.getExtension("OES_texture_float_linear"),o.glExtensionFloatBlend=this.getExtension("EXT_float_blend"),o.glExtensionTextureHalfFloatLinear=this.getExtension("OES_texture_half_float_linear"),o.glExtensionStandardDerivatives=this.getExtension("OES_standard_derivatives"),o.glExtensionKHRParallelShaderCompile?o.completionStatusValue=o.glExtensionKHRParallelShaderCompile.COMPLETION_STATUS_KHR:o.completionStatusValue=a.LINK_STATUS;var l=this.getExtension("WEBGL_debug_renderer_info");if(null!==l&&(this.rendererInfo.gpu=a.getParameter(l.UNMASKED_RENDERER_WEBGL),this.rendererInfo.vendor=a.getParameter(l.UNMASKED_VENDOR_WEBGL)),o.glExtensionTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic")||this.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),o.glExtensionCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc")||this.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),o.glExtensionCompressedTextureRGTC=this.getExtension("EXT_texture_compression_rgtc")||this.getExtension("WEBGL_compressed_texture_rgtc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_rgtc")||this.getExtension("MOZ_WEBGL_compressed_texture_rgtc"),o.glExtensionCompressedTextureBPTC=this.getExtension("EXT_texture_compression_bptc")||this.getExtension("WEBGL_compressed_texture_bptc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_bptc")||this.getExtension("MOZ_WEBGL_compressed_texture_bptc"),o.glExtensionCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),o.glExtensionCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),o.glExtensionCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),o.glExtensionCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc")||this.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),o.glExtensionInstancedArrays=this.getExtension("ANGLE_instanced_arrays"),o.glExtensionElementIndexUint=this.getExtension("OES_element_index_uint"),o.glExtensionFragDepth=this.getExtension("EXT_frag_depth"),o.glExtensionBlendMinMax=this.getExtension("EXT_blend_minmax"),o.glExtensionDrawBuffers=this.getExtension("WEBGL_draw_buffers"),!e._mobileDevice&&(o.renderToFloatTexture=!!o.glExtensionColorBufferFloat,o.glExtensionTextureFloat&&!o.renderToFloatTexture)){var h=2===e.WebGLVersion?a.RGBA32F:a.RGBA,c=a.createTexture(),d=a.createFramebuffer(),u=a.createRenderbuffer();a.bindTexture(a.TEXTURE_2D,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texImage2D(a.TEXTURE_2D,0,h,100,100,0,a.RGBA,a.FLOAT,null),a.bindFramebuffer(a.FRAMEBUFFER,d),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0),a.bindRenderbuffer(a.RENDERBUFFER,u),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,100,100),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,u);var p=a.checkFramebufferStatus(a.FRAMEBUFFER);o.renderToFloatTexture=!0,p!=a.FRAMEBUFFER_COMPLETE&&(o.renderToFloatTexture=!1),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.deleteTexture(c),a.deleteFramebuffer(d),a.deleteRenderbuffer(u)}o.renderToHalfFloatTexture=!!o.glExtensionColorBufferHalfFloat,o.glExtensionTextureHalfFloat&&!o.renderToHalfFloatTexture&&(h=2===e.WebGLVersion?a.RGBA16F:a.RGBA,c=a.createTexture(),d=a.createFramebuffer(),u=a.createRenderbuffer(),a.bindTexture(a.TEXTURE_2D,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texImage2D(a.TEXTURE_2D,0,h,100,100,0,a.RGBA,2===e.WebGLVersion?this.gl.HALF_FLOAT:o.glExtensionTextureHalfFloat.HALF_FLOAT_OES,null),a.bindFramebuffer(a.FRAMEBUFFER,d),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0),a.bindRenderbuffer(a.RENDERBUFFER,u),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,100,100),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,u),p=a.checkFramebufferStatus(a.FRAMEBUFFER),o.renderToHalfFloatTexture=!0,p!=a.FRAMEBUFFER_COMPLETE&&(o.renderToHalfFloatTexture=!1),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.deleteTexture(c),a.deleteFramebuffer(d),a.deleteRenderbuffer(u)),e.supportedExtensions={colorBufferFloat:o.glExtensionColorBufferFloat,colorBufferHalfFloat:o.glExtensionColorBufferHalfFloat,textureHalfFloat:o.glExtensionTextureHalfFloat,textureFloat:o.glExtensionTextureFloat,textureFloatLinear:o.glExtensionTextureFloatLinear,textureHalfFloatLinear:o.glExtensionTextureHalfFloatLinear,standardDerivatives:o.glExtensionStandardDerivatives,textureFilterAnisotropic:o.glExtensionTextureFilterAnisotropic,compressedTexturesS3TC:o.glExtensionCompressedTextureS3TC,compressedTexturesRGTC:o.glExtensionCompressedTextureRGTC,compressedTexturesBPTC:o.glExtensionCompressedTextureBPTC,compressedTexturesASTC:o.glExtensionCompressedTextureASTC,compressedTexturesETC1:o.glExtensionCompressedTextureETC1,compressedTexturesETC:o.glExtensionCompressedTextureETC,compressedTexturesPVRTC:o.glExtensionCompressedTexturePVRTC,instancedArrays:o.glExtensionInstancedArrays,elementIndexUint:o.glExtensionElementIndexUint||2===e.WebGLVersion,renderToFloatTexture:o.renderToFloatTexture,renderToHalfFloatTexture:o.renderToHalfFloatTexture,fragDepth:o.glExtensionFragDepth,minMaxBlending:o.glExtensionBlendMinMax,fragmentTextureUnits:a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),vertexTextureUnits:a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),depthBits:Math.pow(2,-a.getParameter(a.DEPTH_BITS))},e._AmbianceGenerators.init(0),e._SSSGenerator.init(),o.glExtensionTextureFloat||e.VisualizationTraces.info("THREE.WebGLRenderer: Float textures not supported."),o.glExtensionTextureHalfFloat||e.VisualizationTraces.info("THREE.WebGLRenderer: Half Float textures not supported."),o.glExtensionStandardDerivatives||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: Standard derivatives not supported."),o.glExtensionTextureFilterAnisotropic||e.VisualizationTraces.info("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),o.glExtensionCompressedTextureS3TC||e.VisualizationTraces.info("THREE.WebGLRenderer: S3TC compressed textures not supported."),o.glExtensionCompressedTextureRGTC||e.VisualizationTraces.info("THREE.WebGLRenderer: RGTC compressed textures not supported."),o.glExtensionCompressedTextureBPTC||e.VisualizationTraces.info("THREE.WebGLRenderer: BPTC compressed textures not supported."),o.glExtensionCompressedTextureETC1||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC1 compressed textures not supported."),o.glExtensionCompressedTextureETC||e.VisualizationTraces.info("THREE.WebGLRenderer: ETC compressed textures not supported."),o.glExtensionCompressedTextureASTC||e.VisualizationTraces.info("THREE.WebGLRenderer: ASTC compressed textures not supported."),o.glExtensionCompressedTexturePVRTC||e.VisualizationTraces.info("THREE.WebGLRenderer: PVRTC compressed textures not supported."),o.glExtensionInstancedArrays?o.DSInstancedArrays={vertexAttribDivisor:function(e,t){o.glExtensionInstancedArrays.vertexAttribDivisorANGLE(e,t)},drawElementsInstanced:function(e,t,i,r,n){o.glExtensionInstancedArrays.drawElementsInstancedANGLE(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)"id"!==r&&i[r]>=0&&t[r].array&&(t[r].isMat4?(o.glExtensionInstancedArrays.vertexAttribDivisorANGLE(i[r],e),o.glExtensionInstancedArrays.vertexAttribDivisorANGLE(i[r]+1,e),o.glExtensionInstancedArrays.vertexAttribDivisorANGLE(i[r]+2,e),o.glExtensionInstancedArrays.vertexAttribDivisorANGLE(i[r]+3,e)):o.glExtensionInstancedArrays.vertexAttribDivisorANGLE(i[r],e))}}:2===e.WebGLVersion?o.DSInstancedArrays={vertexAttribDivisor:function(e,t){a.vertexAttribDivisor(e,t)},drawElementsInstanced:function(e,t,i,r,n){a.drawElementsInstanced(e,t,i,r,n)},_setVertexAttribDivisors:function(e,t,i){for(var r in t)"id"!==r&&i[r]>=0&&t[r].array&&(t[r].isMat4?(a.vertexAttribDivisor(i[r],e),a.vertexAttribDivisor(i[r]+1,e),a.vertexAttribDivisor(i[r]+2,e),a.vertexAttribDivisor(i[r]+3,e)):a.vertexAttribDivisor(i[r],e))}}:e.VisualizationTraces.info("THREE.WebGLRenderer: angle instanced arrays not supported."),o.glExtensionElementIndexUint||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: UInt Element Index not supported."),o.glExtensionFragDepth||2!==e.WebGLVersion&&e.VisualizationTraces.info("THREE.WebGLRenderer: Fragment Depth Writing not supported."),o.glExtensionBlendMinMax||e.VisualizationTraces.info("THREE.WebGLRenderer: min/max blending not supported."),void 0===a.getShaderPrecisionFormat&&(a.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}});const f={float16:2===e.WebGLVersion?a.HALF_FLOAT:void 0,float32:a.FLOAT,sint8:a.BYTE,sint16:a.SHORT,sint32:2===e.WebGLVersion?a.INT:void 0,uint8:a.UNSIGNED_BYTE,uint16:a.UNSIGNED_SHORT,uint32:2===e.WebGLVersion?a.UNSIGNED_INT:void 0};for(let e in t.VertexAttribute)t.VertexAttribute[e].native=f[t.VertexAttribute[e].base]}restoreGLContext(){console.log("restore context"),this.initGL(null,null,2===e.WebGLVersion),_programs=[],_tryCleanPrograms=!1,_programs_counter=0,this.gl._currentProgram=null,memoryInfo.programs,memoryInfo.programs=0,memoryInfo.sharedbuffers=0,memoryInfo.geometries=0;var t=this.__glResources__.geometry;console.log("restore "+t.length+" geometries");for(var i=[],r=0;r<t.length;r++)if(t[r]){var n=t[r].geometry;if(n){if(n.length)for(var s=0;s<n.length;s++)n[s].vertexBufferGPU=null;else if(t[r].__webglInit=!1,n.__webglVertexBuffer=null,n.geometryGroups)for(var a in n.geometryGroups)n.geometryGroups[a].__webglVertexBuffer=null;_this.initObject(t[r])&&i.push(t[r])}}this.initSharedBuffersDS(i,!0),memoryInfo.textures=0,memoryInfo.renderTargets=0;var o=this.__glResources__.texture;for(console.log("restore "+o.length+" textures"),r=0;r<o.length;r++){var l=o[r];l.needsUpdate=!0,l.__webglInit=!1,l.__webglTexture&&(l.__webglTexture=null)}var h=this.__glResources__.renderTarget,c=0;for(var r in h){var d=h[r];d&&(d.__webglFramebuffer=null,d.__webglRenderbuffer=null,d.__webglTexture=null,c++)}console.log("restore "+c+" render targets")}buildDepthFunctionValues(){this.depthFuncs={NEVER:this.gl.NEVER,LESS:this.gl.LESS,EQUAL:this.gl.EQUAL,LEQUAL:this.gl.LEQUAL,GREATER:this.gl.GREATER,NOTEQUAL:this.gl.NOTEQUAL,GEQUAL:this.gl.GEQUAL,ALWAYS:this.gl.ALWAYS}}setDefaultGLState(){let t=this.gl,i=this.gpuStates;t.lineWidth(1),t.clearColor(0,0,0,1),t.clearDepth(1),t.clearStencil(0),this.setDepthTest(!0),this.setDepthFunc(this.depthFuncs.LEQUAL),t.frontFace(t.CCW),t.cullFace(t.BACK),t.enable(t.CULL_FACE),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t._oldBlending=e.AlphaBlending,t.clearColor(i.clearColor.r,i.clearColor.g,i.clearColor.b,i.clearAlpha)}paramThreeToGL(t){let i=this.gl,r=this.glSupports;if(t===e.RepeatWrapping)return i.REPEAT;if(t===e.ClampToEdgeWrapping)return i.CLAMP_TO_EDGE;if(t===e._ClampToBorderWrapping)return i.CLAMP_TO_EDGE;if(t===e.MirroredRepeatWrapping)return i.MIRRORED_REPEAT;if(t===e.NearestFilter)return i.NEAREST;if(t===e.NearestMipMapNearestFilter)return i.NEAREST_MIPMAP_NEAREST;if(t===e.NearestMipMapLinearFilter)return i.NEAREST_MIPMAP_LINEAR;if(t===e.LinearFilter)return i.LINEAR;if(t===e.LinearMipMapNearestFilter)return i.LINEAR_MIPMAP_NEAREST;if(t===e.LinearMipMapLinearFilter)return i.LINEAR_MIPMAP_LINEAR;if(t===e.UnsignedByteType)return i.UNSIGNED_BYTE;if(t===e.UnsignedShort4444Type)return i.UNSIGNED_SHORT_4_4_4_4;if(t===e.UnsignedShort5551Type)return i.UNSIGNED_SHORT_5_5_5_1;if(t===e.UnsignedShort565Type)return i.UNSIGNED_SHORT_5_6_5;if(t===e.ByteType)return i.BYTE;if(t===e.ShortType)return i.SHORT;if(t===e.UnsignedShortType)return i.UNSIGNED_SHORT;if(t===e.IntType)return i.INT;if(t===e.UnsignedIntType)return th.gl.UNSIGNED_INT;if(t===e.FloatType)return i.FLOAT;if(t===e.HalfFloatType){if(i.HALF_FLOAT)return i.HALF_FLOAT;if(r.glExtensionTextureHalfFloat)return r.glExtensionTextureHalfFloat.HALF_FLOAT_OES}if(t===e.AlphaFormat)return i.ALPHA;if(t===e.RGBFormat)return i.RGB;if(t===e.RGBAFormat)return i.RGBA;if(t===e.LuminanceFormat)return 2===e.WebGLVersion?i.RED:i.LUMINANCE;if(t===e.LuminanceAlphaFormat)return i.LUMINANCE_ALPHA;if(t===e.AddEquation)return i.FUNC_ADD;if(t===e.SubtractEquation)return i.FUNC_SUBTRACT;if(t===e.ReverseSubtractEquation)return i.FUNC_REVERSE_SUBTRACT;if(t===e.ZeroFactor)return i.ZERO;if(t===e.OneFactor)return i.ONE;if(t===e.SrcColorFactor)return i.SRC_COLOR;if(t===e.OneMinusSrcColorFactor)return i.ONE_MINUS_SRC_COLOR;if(t===e.SrcAlphaFactor)return i.SRC_ALPHA;if(t===e.OneMinusSrcAlphaFactor)return i.ONE_MINUS_SRC_ALPHA;if(t===e.DstAlphaFactor)return i.DST_ALPHA;if(t===e.OneMinusDstAlphaFactor)return i.ONE_MINUS_DST_ALPHA;if(t===e.DstColorFactor)return i.DST_COLOR;if(t===e.OneMinusDstColorFactor)return i.ONE_MINUS_DST_COLOR;if(t===e.SrcAlphaSaturateFactor)return i.SRC_ALPHA_SATURATE;if(r.glExtensionCompressedTextureS3TC){if(t===e.RGB_S3TC_DXT1_Format)return r.glExtensionCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT1_Format)return r.glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===e.RGBA_S3TC_DXT3_Format)return r.glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===e.RGBA_S3TC_DXT5_Format)return r.glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(void 0!==r.glExtensionCompressedTextureRGTC){if(t===e.RED_RGTC1_Format)return r.glExtensionCompressedTextureRGTC.COMPRESSED_RED_RGTC1_EXT;if(t===e.RED_RGTC1_S_Format)return r.glExtensionCompressedTextureRGTC.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(t===e.REDGREEN_RGTC2_Format)return r.glExtensionCompressedTextureRGTC.COMPRESSED_RED_GREEN_RGTC2_EXT;if(t===e.REDGREEN_RGTC2_S_Format)return r.glExtensionCompressedTextureRGTC.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}if(void 0!==r.glExtensionCompressedTextureBPTC){if(t===e.RGBA_BPTC_UNORM_Format)return r.glExtensionCompressedTextureBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(t===e.SRGB_ALPHA_BPTC_UNORM_Format)return r.glExtensionCompressedTextureBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;if(t===e.RGB_BPTC_SIGNED_FLOAT_Format)return r.glExtensionCompressedTextureBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(t===e.RGB_BPTC_UNSIGNED_FLOAT_Format)return r.glExtensionCompressedTextureBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(void 0!==r.glExtensionCompressedTextureASTC&&t===e.RGBA_ASTC_4x4_Format)return r.glExtensionCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;if(void 0!==r.glExtensionCompressedTextureETC1&&t===e.RGB_ETC1_Format)return r.glExtensionCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;if(void 0!==r.glExtensionCompressedTextureETC&&t===e.RGBA8_ETC2_EAC_Format)return r.glExtensionCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;if(void 0!==r.glExtensionCompressedTexturePVRTC){if(t===e.RGB_PVRTC_2BPPV1_Format)return r.glExtensionCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===e.RGB_PVRTC_4BPPV1_Format)return r.glExtensionCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===e.RGBA_PVRTC_2BPPV1_Format)return r.glExtensionCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;if(t===e.RGBA_PVRTC_4BPPV1_Format)return r.glExtensionCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG}if(void 0!==r.glExtensionBlendMinMax){if(t===e.MinEquation)return r.glExtensionBlendMinMax.MIN_EXT;if(t===e.MaxEquation)return r.glExtensionBlendMinMax.MAX_EXT}return 0}initFrameUBO(){if(this.frameUBOArray)return;if(2!==e.WebGLVersion)return;let t=this.gl;this.frameUBOArray=new Float32Array(36),this.frameUBOBuffer=t.createBuffer(),t.bindBuffer(t.UNIFORM_BUFFER,this.frameUBOBuffer),t.bufferData(t.UNIFORM_BUFFER,this.frameUBOArray,t.DYNAMIC_DRAW),t.bufferSubData(t.UNIFORM_BUFFER,0,this.frameUBOArray),t.bindBufferBase(t.UNIFORM_BUFFER,p.FRAME,this.frameUBOBuffer),t.bindBuffer(t.UNIFORM_BUFFER,null)}updateFrameUBO(t){if(2!==e.WebGLVersion)return;super.updateFrameUBO(t);let i=this.gl;i.bindBuffer(i.UNIFORM_BUFFER,this.frameUBOBuffer),i.bufferSubData(i.UNIFORM_BUFFER,0,this.frameUBOArray)}buildShader(t,i,r,n,l,c,d,p,f,m,v,_,y){let S=this.gl,x=this.glSupports,b=this.materialToUseList,w=y.__attributes__,M=y.__uniforms__,C=S.createProgram();n.program=C;const P=`\n        \n            ${o.Default_uniforms_declaration(r)}\n            ${o.normalMatrix_uniforms_declaration(r)}\n            ${o.double_emulation_utilities(r)}\n            ${o.double_emulation(r)}\n      \n            ${o.math_utils_pars(r)}\n\n            ${o.sRGB_conversion(r)}\n            ${o.gpu_scenegraph_nodes(r)}\n            \n            ${s.model_view_transformation_pars(r)}\n            ${s.model_view_unit_transformation_pars(r)}\n            \n            ${o.rgba_packing_pars(r)}\n            ${o.decompress_vertices_pars(r)}\n            ${o.decompress_normals_pars(r)}\n            ${o.decompress_uvs_pars(r)}\n            ${o.decompress_colors_pars(r)}\n        `;var E=`\n\n            ${r.deferrable||!r._definePickingInstancing&&!r.specialPickingInstancing?u:ShaderInOutUtils.addVarying({varyingName:"vInstancePickingColor",varyingType:"v3",parameters:r})}\n\n            ${o.attribute_pars_vertex(r)}\n\n            ${P}\n\n            ${r.PDSFX?`\n                ${o.PDSFX_header_vertex(r)}\n                `:u}\n        `,T=`\n\n            ${P}\n            \n            ${r.deferrable||!r._definePickingInstancing&&!r.specialPickingInstancing?u:ShaderInOutUtils.addVarying({varyingName:"vInstancePickingColor",varyingType:"v3",parameters:r})}\n            \n                ${a.vec3({name:"tangent"})} ;\n                ${a.vec3({name:"binormal"})} ;\n\n            ${2===r.WebGLVersion?"layout(location = 0) out vec4 outFragColor;":u}\n        `;"custom"===i?[l,c]=this.setMaterialShaders(t.postProBuilder,b.lightedMaterial,r):null!==i&&([l,c]=this.setMaterialShaders(e.ShaderLib[i],b.lightedMaterial,r));var A=/(void(\s+)main(\s*)\((\s*)\)(\s*){(\s*))/,D=l.replace(A,"$&"+o.attribute_vertex(r)+"\n"+o.large_scale_VS(r)),I=p+"\n"+T+"\n"+m+"\n"+c.replace(A,"$&"+o.large_scale_FS(r)),R=d+"\n"+E+"\n"+f+"\n"+D;if(2===e.WebGLVersion){I=I.replace(/varying /g,"in "),R=(R=R.replace(/varying /g,"out ")).replace(/attribute /g,"in "),I=I.replace(/gl_FragColor/g,"outFragColor");var O=/\s*texture2D\s*\(/g,L=/\s*textureCube\s*\(/g;R=R.replace(O," texture("),I=(I=I.replace(O," texture(")).replace(L," texture("),R=R.replace(L," texture("),I=I.replace(/#extension\s+GL_OES_standard_derivatives\s*:\s*enable/g,"")}else I=x.glExtensionDrawBuffers?I.replace(/gl_FragColor/g,"gl_FragData[0]"):I.replace(/gl_FragData\[.+\]/g,"gl_FragColor");I=e.SplitTrimStickString(I),R=e.SplitTrimStickString(R);var V=S.createShader(S.FRAGMENT_SHADER);S.shaderSource(V,I),S.compileShader(V);var F=S.createShader(S.VERTEX_SHADER);if(S.shaderSource(F,R),S.compileShader(F),S.attachShader(C,F),S.attachShader(C,V),S.linkProgram(C),!S.getProgramParameter(C,x.completionStatusValue)){var B=S.getProgramInfoLog(C);console.error("Could not initialise shader\nVALIDATE_STATUS: "+S.getProgramParameter(C,S.VALIDATE_STATUS)+", gl error: "+B),B.includes("Vertex shader")?(console.error(S.getShaderInfoLog(F)),console.error(this.addLineNumbers(R))):(console.error(S.getShaderInfoLog(V)),console.error(this.addLineNumbers(I)))}S.deleteShader(V),S.deleteShader(F),n.objectUniformLocations=new g,n.uniformLocations={},n.globalUniformLocations={},n.postProUniformLocations={},n.lightUniformLocations={},n.shadowUniformLocations={},n.clippingUniformLocations={},n.pdsfxUniformLocations={},t._setUniformLocations(S,n,C,M),n.objectUniformLocations.computeFuncName(),h(n.uniformLocations),h(n.globalUniformLocations),h(n.postProUniformLocations),h(n.lightUniformLocations),h(n.shadowUniformLocations),h(n.clippingUniformLocations),h(n.pdsfxUniformLocations);var N=n.attributes,G=n.instanceAttributes;for(var k in w){var U=w[k];const e=S.getAttribLocation(C,k);if(e>-1)if(U.dynamic){var z=U.locationName?U.locationName:k;U.coreAttribute?N[z]=e:U.instancingAttribute?G[z]=e:console.warn("Unknown attribute category "+k+" "+U)}else G[k]=e}if(_){const e=S.getProgramParameter(C,S.ACTIVE_ATTRIBUTES);for(let t=0;t<e;t++){const e=S.getActiveAttrib(C,t);w[e.name]||(console.warn("Detected custom attribute declaration for "+e.name+" , please use material.setPDSFXAttributes instead"),N[e.name]=S.getAttribLocation(C,e.name))}}n.uvOrBinOrTan=(N.uv>=0||N.binormal>=0||N.tangent>=0)&&r.mappingType<1}loadUniformsGeneric(t,i){var r,n,s,a,o,l=this;let h=this.gl;i.forEach(function(i,c,d){var u=i,p=t[c];if(p){var f=u.type;switch(i=u.value,f){case"b":case"i":h.uniform1i(p,i);break;case"i2":h.uniform2i(p,i.x,i.y);break;case"i3":h.uniform3i(p,i.x,i.y,i.z);break;case"i4":h.uniform4i(p,i.x,i.y,i.z,i.w);break;case"f":h.uniform1f(p,i);break;case"v2":h.uniform2f(p,i.x,i.y);break;case"v3":h.uniform3f(p,i.x,i.y,i.z);break;case"v4":h.uniform4f(p,i.x,i.y,i.z,i.w);break;case"c":h.uniform3f(p,i.r,i.g,i.b);break;case"iv1":i.length>0&&h.uniform1iv(p,i);break;case"iv":i.length>0&&h.uniform3iv(p,i);break;case"fv1":i.length>0&&h.uniform1fv(p,i);break;case"fv2":i.length>0&&h.uniform2fv(p,i);break;case"fv3":case"fv":i.length>0&&h.uniform3fv(p,i);break;case"fv4":i.length>0&&h.uniform4fv(p,i);break;case"v2v":for(void 0===u._array&&(u._array=new Float32Array(2*i.length)),a=0,o=i.length;a<o;a++)s=2*a,u._array[s]=i[a].x,u._array[s+1]=i[a].y;h.uniform2fv(p,u._array);break;case"v3v":for(void 0===u._array&&(u._array=new Float32Array(3*i.length)),a=0,o=i.length;a<o;a++)s=3*a,u._array[s]=i[a].x,u._array[s+1]=i[a].y,u._array[s+2]=i[a].z;h.uniform3fv(p,u._array);break;case"v4v":for(void 0===u._array&&(u._array=new Float32Array(4*i.length)),a=0,o=i.length;a<o;a++)s=4*a,u._array[s]=i[a].x,u._array[s+1]=i[a].y,u._array[s+2]=i[a].z,u._array[s+3]=i[a].w;h.uniform4fv(p,u._array);break;case"m3":i&&l.loadMatrix3(h,p,i);break;case"m4":i&&l.loadMatrix4(h,p,i);break;case"m4v":for(void 0===u._array&&(u._array=new Float32Array(16*i.length)),a=0,o=i.length;a<o;a++)i[a]&&i[a].flattenToArrayOffset(u._array,16*a);h.uniformMatrix4fv(p,!1,u._array);break;case"t":case"t2":case"tc":r=i,n=l.getTextureUnit(),h.uniform1i(p,n),r||(r=l._dummyTexture),r instanceof e.WebGLRenderTargetCube?l.setCubeTextureDynamic(r,n):l.setTexture(r,n);break;case"tv":case"t2v":case"tcv":for(void 0===u._array&&(u._array=[]),a=0,o=u.value.length;a<o;a++)u._array[a]=l.getTextureUnit();for(h.uniform1iv(p,u._array),a=0,o=u.value.length;a<o;a++)r=u.value[a],n=u._array[a],r||(r=l._dummyTexture),l.setTexture(r,n)}}})}loadObjectUniforms(t,i,r,n,s,a,o){if(i.isCurvedPipe)return;let l=this.gl;if(t.quantizedVector&&l.uniform3f(t.quantizedVector,r.quantizedVector.x,r.quantizedVector.y,r.quantizedVector.z),t.offsetVector&&l.uniform3f(t.offsetVector,r.offsetVector.x,r.offsetVector.y,r.offsetVector.z),t.lightMap&&(o&&o._lightMap?(this.loadTexture(l,t.lightMap,o._lightMap.texture),l.uniformMatrix3fv(t.lightMapUvTransform,!1,this.float32Matrix3x3Temp.setDoubles(o._lightMap.uvTransform.elements)),l.uniform1i(t.lightMapUvSlot,o._lightMap.uvSlot?o._lightMap.uvSlot:1)):(this.loadTexture(l,t.lightMap,r.lightMap),l.uniformMatrix3fv(t.lightMapUvTransform,!1,this.float32Matrix3x3Temp.setDoubles((i.lightMapData.lightMapUvTransform?i.lightMapData.lightMapUvTransform:this._dummyMat3).elements)),l.uniform1i(t.lightMapUvSlot,i.lightMapData.lightMapUvSlot?i.lightMapData.lightMapUvSlot:1))),t.displacementRadius&&l.uniform1f(t.displacementRadius,i.boundingSphere.radius),t.billboardType){var h=i._billboardData;l.uniform1i(t.billboardType,h.type),h.type>1&&(h.axis?l.uniform3f(t.billboardAxis,h.axis.x,h.axis.y,h.axis.z):l.uniform3f(t.billboardAxis,0,0,1)),h.rotation?(l.uniform1i(t.billboardRotationEnabled,1),l.uniformMatrix4fv(t.billboardRotation,!1,this.float32Matrix4x3Temp.setDoubles(h.rotation.elements))):l.uniform1i(t.billboardRotationEnabled,0)}let c=i.matrixWorld,d=i._mElements;if(t.belowInstancingModelMatrix){let r=i._occurrence;for(;r&&!r.node._instancingInfos;)r=r.parent;if(r){c=r.matrix;let n=new e._Float32Matrix4;n._fromMatrix4WithLowPartTranslation(c),d=n.elements,l.uniformMatrix4fv(t.belowInstancingModelMatrix,!1,i.matrixWorld.elements)}else console.warn("No InstancingNode found for this instanced object"),l.uniformMatrix4fv(t.belowInstancingModelMatrix,!1,(new e.Matrix4).identity())}if(t.skinningMap?this.loadTexture(l,t.skinningMap,i._skinning.skinningMap):t.skinningInstancingMaps&&this.loadTextureArray(l,n.program,t.skinningInstancingMaps,"skinningInstancingMaps",i._skinningInstancing.skinningInstancingMaps),t.fixedSizeCenterRatio&&l.uniform4f(t.fixedSizeCenterRatio,i._ratioData.center.x,i._ratioData.center.y,i._ratioData.center.z,i._ratioData.ratio),t.decalStencilValue&&i._decalData&&(l.uniform1f(t.decalStencilValue,i._decalData.stencilID),l.uniform1f(t.decalExplicitUv,i._decalData.explicitUv)),t.objectColorBufferType&&l.uniform1f(t.objectColorBufferType,i._vertexColors),this.currentModelMatrix!==c){if(t.modelViewMatrix&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(s.matrixWorldInverse,c)),l.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements)),t.modelMatrix&&l.uniformMatrix4fv(t.modelMatrix,!1,d),t.modelInvRotMatrix){if(!i._modelInvRotMatrix){var u=(new e.Matrix4).getInverse(c);i._modelInvRotMatrix=(new e.Matrix4).extractRotation(u)}l.uniformMatrix4fv(t.modelInvRotMatrix,!1,this.float32Matrix4x3Temp.setDoubles(i._modelInvRotMatrix.elements))}n._PDSFXData&&n._PDSFXData.PDSFX&&(t.modelInvTranspMatrix&&(null===i.modelInvTranspMatrix&&(i.modelInvTranspMatrix=(new e.Matrix4).getInverse(c).transpose()),l.uniformMatrix4fv(t.modelInvTranspMatrix,!1,this.float32Matrix4x3Temp.setDoubles(i.modelInvTranspMatrix.elements))),t.modelViewInvTranspMatrix&&(null===i.modelViewInvTranspMatrix&&(i.modelViewInvTranspMatrix=(new e._Float32Matrix4).multiplyMatricesAndInverse(s.matrixWorldInverse,c).transpose()),l.uniformMatrix4fv(t.modelViewInvTranspMatrix,!1,i.modelViewInvTranspMatrix.elements))),t.modelViewInvMatrix&&(null===i.modelViewInvMatrix&&(i.modelViewInvMatrix=(new e._Float32Matrix4).multiplyMatricesAndInverse(s.matrixWorldInverse,c)),l.uniformMatrix4fv(t.modelViewInvMatrix,!1,i.modelViewInvMatrix.elements)),t.normalMatrix&&l.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),this.currentModelMatrix=c}if(t.backgroundViewModeControl){const e=this._backgroundColor?this._backgroundColor.r:0,r=this._backgroundColor?this._backgroundColor.g:0,n=this._backgroundColor?this._backgroundColor.b:0;l.uniform4f(t.backgroundViewModeControl,e,r,n,i.applyBackgroundViewMode?1:0)}t.backgroundViewModeNearFar&&l.uniform2f(t.backgroundViewModeNearFar,s.near,s.far),this.currentRenderInfo.objectUniformCalls++}_load_MM(e,t,i,r,n,s,a){this.currentModelMatrix!==t.matrixWorld&&(this.gl.uniformMatrix4fv(e.modelMatrix,!1,t._mElements),this.currentModelMatrix=t.matrixWorld,this.currentRenderInfo.objectUniformCalls++)}_load_MM_NM(e,t,i,r,n,s,a){this.currentModelMatrix!==t.matrixWorld&&(this.gl.uniformMatrix4fv(e.modelMatrix,!1,t._mElements),this.gl.uniformMatrix3fv(e.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(t._normalMatrix.elements)),this.currentModelMatrix=t.matrixWorld,this.currentRenderInfo.objectUniformCalls++)}_load_MVM(t,i,r,n,s,a,o){this.currentModelMatrix!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(s.matrixWorldInverse,i.matrixWorld)),this.gl.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),this.currentModelMatrix=i.matrixWorld,this.currentRenderInfo.objectUniformCalls++)}_load_MVM_NM(t,i,r,n,s,a,o){this.currentModelMatrix!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(s.matrixWorldInverse,i.matrixWorld)),this.gl.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),this.gl.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),this.currentModelMatrix=i.matrixWorld,this.currentRenderInfo.objectUniformCalls++)}_load_MM_MVM(t,i,r,n,s,a,o){this.currentModelMatrix!==i.matrixWorld&&(i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(s.matrixWorldInverse,i.matrixWorld)),this.gl.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),this.gl.uniformMatrix4fv(t.modelMatrix,!1,i._matrixWorldForDoubleGPU.elements),this.currentModelMatrix=i.matrixWorld,this.currentRenderInfo.objectUniformCalls++)}_load_MM_MVM_NM(t,i,r,n,s,a,o){if(this.currentModelMatrix!==i.matrixWorld){i._modelViewMatrix||(i._modelViewMatrix=new e._Float32Matrix4,i._modelViewMatrix._multiplyMatricesMV(s.matrixWorldInverse,i.matrixWorld));let r=this.gl;r.uniformMatrix4fv(t.modelViewMatrix,!1,i._modelViewMatrix.elements),r.uniformMatrix4fv(t.modelMatrix,!1,i._matrixWorldForDoubleGPU.elements),r.uniformMatrix3fv(t.normalMatrix,!1,this.float32Matrix3x3Temp.setDoubles(i._normalMatrix.elements)),this.currentModelMatrix=i.matrixWorld,this.currentRenderInfo.objectUniformCalls++}}loadMatrix3(e,t,i){e.uniformMatrix3fv(t,!1,this.float32Matrix3x3Temp.setDoubles(i.elements))}loadMatrix4(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x4Temp.setDoubles(i.elements))}loadMatrix4x3(e,t,i){e.uniformMatrix4fv(t,!1,this.float32Matrix4x3Temp.setDoubles(i.elements))}loadMatrixFloat4(e,t,i){e.uniformMatrix4fv(t,!1,i.elements)}loadMatrix4Array(e,t,i,r,n){var s=t.flattenedUniformArrays;void 0!==s[r]&&s[r].length===16*n.length||(s[r]=new Float32Array(16*n.length));for(var a=0,o=n.length;a<o;a++)n[a]&&n[a].flattenToArrayOffset(s[r],16*a);var l=s[r];l.length>0&&this.gl.uniformMatrix4fv(i,!1,l)}loadVector2Array(e,t,i,r,n){var s,a=t.flattenedUniformArrays;void 0===a[r]&&(a[r]=new Float32Array(2*n.length));for(var o=0,l=n.length;o<l;o++)s=2*o,a[r][s]=n[o].x,a[r][s+1]=n[o].y;this.gl.uniform2fv(i,a[r])}loadTexture(t,i,r){var n=r,s=this.getTextureUnit();this.gl.uniform1i(i,s),n&&(n instanceof e.WebGLRenderTargetCube?this.setCubeTextureDynamic(n,s):this.setTexture(n,s))}loadTextureArray(e,t,i,r,n){var s,a,o,l,h=t.flattenedUniformArrays;for(void 0===h[r]&&(h[r]=[]),s=0,a=n.length;s<a;s++)h[r][s]=this.getTextureUnit();for(this.gl.uniform1iv(i,h[r]),s=0,a=n.length;s<a;s++)o=n[s],l=h[r][s],o&&this.setTexture(o,l)}loadTextureCubeArray(e,t,i,r,n){var s,a,o,l,h=t.flattenedUniformArrays;for(void 0===h[r]&&(h[r]=[]),s=0,a=n.length;s<a;s++)h[r][s]=this.getTextureUnit();for(this.gl.uniform1iv(i,h[r]),s=0,a=n.length;s<a;s++)o=n[s],l=h[r][s],o&&this.setCubeTextureDynamic(o,l)}loadGASUniforms(e,t,i,r,n){if(i.diffuse){var s=n?n.color:t.color,a=r&&r.getColor();a&&(s=d.set(r.getColor())),this.gammaInput&&(s=d.copyToLinear(s,this.simpleGamma)),e.uniform3f(i.diffuse,s.r,s.g,s.b),i._colorOverride&&e.uniform1i(i._colorOverride,a?1:0)}if(i.opacity){var o=n?n.opacity:t.opacity,l=r&&r.getOpacity(t.__dimension);(l||0===l)&&(o=l),this.useRenderPriorityOpacity&&(o=this.computeRenderPriorityOpacity(o,r)),e.uniform1f(i.opacity,o)}}loadUniformsCommon(t,i,r,n,s,a){if(this.loadGASUniforms(t,i,r,n,s),r.colorBufferType&&this.gl.uniform1f(r.colorBufferType,i.vertexColors),r.envMapExposureSpecular&&t.uniform1f(r.envMapExposureSpecular,i.envMapExposureSpecular||0==i.envMapExposureSpecular?i.envMapExposureSpecular:1),r.envMapExposureDiffuse&&t.uniform1f(r.envMapExposureDiffuse,i.envMapExposureDiffuse||0==i.envMapExposureDiffuse?i.envMapExposureDiffuse:1),r.ambienceMatrix){var o=i.ambienceMatrix?i.ambienceMatrix:this._dummyMat4;this.gl.uniformMatrix4fv(r.ambienceMatrix,!1,this.float32Matrix4x4Temp.setDoubles(o.elements))}var l;if(r.flipEnvMap&&t.uniform1f(r.flipEnvMap,i.flipEnvMap||0==i.flipEnvMap?i.flipEnvMap:1),r.reflectivity&&t.uniform1f(r.reflectivity,i.reflectivity||0==i.reflectivity?i.reflectivity:1),r.refractionRatio&&t.uniform1f(r.refractionRatio,i.refractionRatio||0==i.refractionRatio?i.refractionRatio:.98),r.morphTargetInfluences&&t.uniform1f(r.morphTargetInfluences,i.morphTargetInfluences?i.morphTargetInfluences:0),r.combine&&t.uniform1i(r.combine,i.combine?i.combine:0),r.renderIteration&&t.uniform1i(r.renderIteration,this.renderIteration?this.renderIteration:0),i.map?l=i.map:i.specularMap?l=i.specularMap:i.normalMap?l=i.normalMap:i.bumpMap&&(l=i.bumpMap),void 0!==l){var h=l.offset||{x:0,y:0},c=l.repeat||{x:1,y:1};r.offsetBumpMap&&t.uniform2f(r.offsetBumpMap,h.x,h.y),r.repeatBumpMap&&t.uniform2f(r.repeatBumpMap,c.x,c.y)}else r.offsetBumpMap&&t.uniform2f(r.offsetBumpMap,0,0),r.repeatBumpMap&&t.uniform2f(r.repeatBumpMap,1,1);if(r.map&&this.loadTexture(t,r.map,i.map),r.specularMap&&this.loadTexture(t,r.specularMap,i.specularMap),r.reflectivityEnvMap&&this.loadTexture(t,r.reflectivityEnvMap,i.reflectivityEnvMap),r.envMap&&this.loadTexture(t,r.envMap,i.envMap),r.refractionRatioMap&&this.loadTexture(t,r.refractionRatioMap,i.refractionRatioMap),a&&a._mappingOperator||i._loadMappingInfo(i,this,t,r),i.map&&i.map.hdr&&i.map.image?r.mapHDRSize&&t.uniform2f(r.mapHDRSize,parseInt(i.map.image.width),parseInt(i.map.image.height)):r.mapHDRSize&&t.uniform2f(r.mapHDRSize,2048,1024),i.envMap&&i.envMap.hdr&&i.envMap.image?(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,parseInt(i.envMap.image.width),parseInt(i.envMap.image.height)),r.useRefract&&t.uniform1i(r.useRefract,i.envMap&&i.envMap.mapping instanceof e.CubeRefractionMapping)):(r.envMapHDRSize&&t.uniform2f(r.envMapHDRSize,2048,1024),r.useRefract&&t.uniform1i(r.useRefract,0)),r.invScreenSize){let e=this.gpuStates;t.uniform2f(r.invScreenSize,e.viewportInvWidth/e.viewportScale,e.viewportInvHeight/e.viewportScale)}r.aoTexture&&(t.uniform2f(r.aoParams,this.ssaoParams.contrast,this.ssaoParams.power),this.loadTexture(t,r.aoTexture,this._getAOBufferResult()))}loadUniformsBump(e,t,i){t.bumpMap&&(i.bumpScale&&e.uniform1f(i.bumpScale,t.bumpScale?t.bumpScale:1),i.bumpMap&&this.loadTexture(e,i.bumpMap,t.bumpMap))}loadUniformsDepthLayer(e,t,i){}loadUniformsNormalMap(e,t,i){t.normalMap&&(i.normalScale&&(t.normalScale?e.uniform2f(i.normalScale,t.normalScale.x,t.normalScale.y):e.uniform2f(i.normalScale,1,1)),i.normalMap&&this.loadTexture(e,i.normalMap,t.normalMap))}loadUniformsLights(e,t,i,r,n){t.ambientLightColor&&i.ambient.length>0&&e.uniform4fv(t.ambientLightColor,i.ambient),n?t.directionalLightColor&&i.directional.colorsPhong.length>0&&e.uniform4fv(t.directionalLightColor,i.directional.colorsPhong):t.directionalLightColor&&i.directional.colors.length>0&&e.uniform4fv(t.directionalLightColor,i.directional.colors),t.directionalLightDirection&&i.directional.positions.length>0&&e.uniform4fv(t.directionalLightDirection,i.directional.positions),t.directionalIBLLightColor&&i.directionalIBL.colors.length>0&&e.uniform4fv(t.directionalIBLLightColor,i.directionalIBL.colors),t.directionalIBLLightDirection&&i.directionalIBL.positions.length>0&&e.uniform4fv(t.directionalIBLLightDirection,i.directionalIBL.positions),t.directionalPhongLightColor&&i.directionalPhong.colors.length>0&&e.uniform4fv(t.directionalPhongLightColor,i.directionalPhong.colors),t.directionalPhongLightDirection&&i.directionalPhong.positions.length>0&&e.uniform4fv(t.directionalPhongLightDirection,i.directionalPhong.positions),n?t.pointLightColor&&i.point.colorsPhong.length>0&&e.uniform4fv(t.pointLightColor,i.point.colorsPhong):t.pointLightColor&&i.point.colors.length>0&&e.uniform4fv(t.pointLightColor,i.point.colors),t.pointLightPosition&&i.point.positions.length>0&&e.uniform4fv(t.pointLightPosition,i.point.positions),t.pointLightPhysicalAttenuation&&i.point.physicalAttenuations.length>0&&e.uniform1iv(t.pointLightPhysicalAttenuation,i.point.physicalAttenuations),n?t.spotLightColor&&i.spot.colorsPhong.length>0&&e.uniform4fv(t.spotLightColor,i.spot.colorsPhong):t.spotLightColor&&i.spot.colors.length>0&&e.uniform4fv(t.spotLightColor,i.spot.colors),t.spotLightPosition&&i.spot.positions.length>0&&e.uniform4fv(t.spotLightPosition,i.spot.positions),t.spotLightDirection&&i.spot.directions.length>0&&e.uniform4fv(t.spotLightDirection,i.spot.directions),t.spotLightPhysicalAttenuation&&i.spot.physicalAttenuations.length>0&&e.uniform1iv(t.spotLightPhysicalAttenuation,i.spot.physicalAttenuations),t.iesLightColor&&i.ies.colors.length>0&&e.uniform4fv(t.iesLightColor,i.ies.colors),t.iesLightPosition&&i.ies.positions.length>0&&e.uniform4fv(t.iesLightPosition,i.ies.positions),t.iesLightPhysicalAttenuation&&i.ies.physicalAttenuations.length>0&&e.uniform1iv(t.iesLightPhysicalAttenuation,i.ies.physicalAttenuations),t.iesLightTexture&&i.ies.iesLightTexture.length>0&&this.loadTextureArray(e,r,t.iesLightTexture,"iesLightTexture",i.ies.iesLightTexture),t.matrixWorldInv&&this.loadMatrix4Array(e,r,t.matrixWorldInv,"matrixWorldInv",i.ies.matrixWorldInv),t.sphereLightColor&&i.sphere.colors.length>0&&e.uniform4fv(t.sphereLightColor,i.sphere.colors),t.sphereLightPosition&&i.sphere.positions.length>0&&e.uniform4fv(t.sphereLightPosition,i.sphere.positions),t.diskLightColor&&i.disk.colors.length>0&&e.uniform4fv(t.diskLightColor,i.disk.colors),t.diskLightNormal&&i.disk.normals.length>0&&e.uniform4fv(t.diskLightNormal,i.disk.normals),t.diskLightUp&&i.disk.ups.length>0&&e.uniform4fv(t.diskLightUp,i.disk.ups),t.diskLightPosition&&i.disk.positions.length>0&&e.uniform4fv(t.diskLightPosition,i.disk.positions),t.tubeLightColor&&i.tube.colors.length>0&&e.uniform4fv(t.tubeLightColor,i.tube.colors),t.tubeLightRight&&i.tube.rights.length>0&&e.uniform4fv(t.tubeLightRight,i.tube.rights),t.tubeLightPosition&&i.tube.positions.length>0&&e.uniform4fv(t.tubeLightPosition,i.tube.positions),t.rectangleLightColor&&i.rectangle.colors.length>0&&e.uniform4fv(t.rectangleLightColor,i.rectangle.colors),t.rectangleLightPosition&&i.rectangle.positions.length>0&&e.uniform4fv(t.rectangleLightPosition,i.rectangle.positions),t.rectangleLightNormal&&i.rectangle.normals.length>0&&e.uniform4fv(t.rectangleLightNormal,i.rectangle.normals),t.rectangleLightUp&&i.rectangle.ups.length>0&&e.uniform4fv(t.rectangleLightUp,i.rectangle.ups),(i.rectangle.colors.length>0||i.tube.colors.length>0||i.disk.colors.length>0||i.sphere.colors.length>0)&&t.precomputedAreaTexture&&this.loadTexture(e,t.precomputedAreaTexture,this.precomputedAreaTexture)}loadUniformsShadow(t,i,r,n,s){var a=i.shadowUniformLocations;if(a.shadowMatrix){var o=0,l=[],h=[],d=[],u=[],p=[],f=[],g=[],m=[],v=[],_=[];this.shadowMapType===e.PCFPoissonShadowMap&&this.loadVector2Array(t,i,a.poissonDisk,"poissonDisk",e._poissonDisk);for(var y=0,S=r.length;y<S;y++)if((O=r[y])instanceof e.SpotLight||O instanceof e.DirectionalLight&&!O.shadowCascade&&(!O.isVirtual||this.shadowMapCascade)){if(!O.castShadow)continue;if(O._sortKey===c&&!s._needsIBLLightExtraction())continue;l[o]=O.shadowMap,h[o]=O.transparentShadowMap,d[o]=O.shadowMapSize,f[o]=O.shadowDarkness,p[o]=O.shadowCamera.far,u[o]=O.shadowCamera.near,g[o]=O.shadowBias,m[o]=O.shadowMatrix;var x=(new e.Vector3).getPositionFromMatrix(O.shadowCamera.matrixWorld);if(O.isVirtual){var b=e._SplitFloat32PositiveError(x.x),w=e._SplitFloat32PositiveError(x.y),M=e._SplitFloat32PositiveError(x.z);v[4*o]=b.high,v[4*o+1]=w.high,v[4*o+2]=M.high,_[4*o]=b.low,_[4*o+1]=w.low,_[4*o+2]=M.low}else v[4*o]=x.x,v[4*o+1]=x.y,v[4*o+2]=x.z,_[4*o]=e.SplitFloat32(x.x).low,_[4*o+1]=e.SplitFloat32(x.y).low,_[4*o+2]=e.SplitFloat32(x.z).low;v[4*o+3]=0,_[4*o+3]=0,o++}a.shadowMap&&this.loadTextureArray(t,i,a.shadowMap,"shadowMap",l),a.transparentShadowMap&&(this.loadTextureArray(t,i,a.transparentShadowMap,"transparentShadowMap",h),a.directionalLightColorNoIntensity&&n.directional.colorsNoIntensity.length>0&&t.uniform4fv(a.directionalLightColorNoIntensity,n.directional.colorsNoIntensity),a.spotLightColorNoIntensity&&n.spot.colorsNoIntensity.length>0&&t.uniform4fv(a.spotLightColorNoIntensity,n.spot.colorsNoIntensity)),a.shadowMapSize&&this.loadVector2Array(t,i,a.shadowMapSize,"shadowMapSize",d),a.shadowDarkness&&t.uniform1fv(a.shadowDarkness,f),a.shadowBias&&t.uniform1fv(a.shadowBias,g),a.shadowMapNear&&t.uniform1fv(a.shadowMapNear,u),a.shadowMapFar&&t.uniform1fv(a.shadowMapFar,p),a.shadowCameraPosition&&t.uniform4fv(a.shadowCameraPosition,v),a.lowPartShadowCameraPosition&&t.uniform4fv(a.lowPartShadowCameraPosition,_),this.loadMatrix4Array(t,i,a.shadowMatrix,"shadowMatrix",m)}if(a.shadowMapCube){var C=0,P=[],E=[],T=[],A=[],D=[],I=[],R=[];for(y=0,S=r.length;y<S;y++){var O;if((O=r[y])instanceof e.PointLight){if(!O.castShadow)continue;P[C]=O.shadowMap,E[C]=O.transparentShadowMap,T[C]=O.shadowDarkness,A[C]=O.shadowBias,I[C]=O.shadowCameraNear,R[C]=O.shadowCameraFar,O.setupShadowPositions(D),D.push(O.shadowMapWidth),C++}}this.loadTextureCubeArray(t,i,a.shadowMapCube,"shadowMapCube",P),a.transparentShadowMapCube&&(this.loadTextureCubeArray(t,i,a.transparentShadowMapCube,"",E),a.pointLightColorNoIntensity&&n.point.colorsNoIntensity.length>0&&t.uniform4fv(a.pointLightColorNoIntensity,n.point.colorsNoIntensity)),a.shadowDarknessCube&&t.uniform1fv(a.shadowDarknessCube,T),a.shadowFarCube&&t.uniform1fv(a.shadowFarCube,R),a.shadowNearCube&&t.uniform1fv(a.shadowNearCube,I),a.shadowBiasCube&&t.uniform1fv(a.shadowBiasCube,A),a.shadowPointPosition&&t.uniform4fv(a.shadowPointPosition,D)}}loadUniformsPostProcess(e,t){var i=t.postProUniformLocations;this.inlinedPostProcess.activated&&(i.brightness&&e.uniform1f(i.brightness,this.inlinedPostProcess.brightness),i.crushblacks&&e.uniform1f(i.crushblacks,this.inlinedPostProcess.crushblacks),i.burnhighlights&&e.uniform1f(i.burnhighlights,this.inlinedPostProcess.burnhighlights),i.saturation&&e.uniform1f(i.saturation,this.inlinedPostProcess.saturation),i.colorCorrection&&e.uniform3f(i.colorCorrection,this.inlinedPostProcess.colorCorrection.x,this.inlinedPostProcess.colorCorrection.y,this.inlinedPostProcess.colorCorrection.z))}loadClippingUniforms(e,t){var i=this._clipPlanesState.uniforms;t.nbClipPlanes&&e.uniform1i(t.nbClipPlanes,i.nbClipPlanes.value);let r=!1;if(0!==i.nbClipPlanes.value&&(r=!0,t.clipPlaneEquations&&i.clipPlaneEquations.value.length>0&&e.uniform4fv(t.clipPlaneEquations,i.clipPlaneEquations.value),t.clipPlaneActive&&i.clipPlaneActive.value.length>0&&e.uniform1iv(t.clipPlaneActive,i.clipPlaneActive.value),t.clipFrontOpacity&&e.uniform1f(t.clipFrontOpacity,i.clipFrontOpacity.value),t.clipBackOpacity&&e.uniform1f(t.clipBackOpacity,i.clipBackOpacity.value)),t.polygonSize&&e.uniform1iv(t.polygonSize,i.polygonSize.value),i.polygonSize.value&&0!==i.polygonSize.value[0]?(t.polygonPoints&&this.loadTexture(e,t.polygonPoints,i.polygonPoints.value),t.extrusionPlaneU&&e.uniform3fv(t.extrusionPlaneU,i.extrusionPlaneU.value),t.extrusionPlaneV&&e.uniform3fv(t.extrusionPlaneV,i.extrusionPlaneV.value),!r&&t.clipBackOpacity&&e.uniform1f(t.clipBackOpacity,i.clipBackOpacity.value)):t.polygonPoints&&this.loadTexture(e,t.polygonPoints,this._dummyTexture),t.scissorSize){var n=i.scissorSize.value;n&&0===n.length&&(n=[0]),e.uniform1iv(t.scissorSize,n)}t.scissorPoints&&(0!==i.scissorSize.value?this.loadTexture(e,t.scissorPoints,i.scissorPoints.value):this.loadTexture(e,t.scissorPoints,this._dummyTexture)),t.cylinderClipZone&&e.uniform1i(t.cylinderClipZone,i.cylinderClipZone.value),0!==i.cylinderClipZone.value&&(t.cylinderCenter&&e.uniform3f(t.cylinderCenter,i.cylinderCenter.value.x,i.cylinderCenter.value.y,i.cylinderCenter.value.z),t.cylinderAxisU&&e.uniform3f(t.cylinderAxisU,i.cylinderAxisU.value.x,i.cylinderAxisU.value.y,i.cylinderAxisU.value.z),t.cylinderAxisV&&e.uniform3f(t.cylinderAxisV,i.cylinderAxisV.value.x,i.cylinderAxisV.value.y,i.cylinderAxisV.value.z))}setRenderTarget(t){super.setRenderTarget(t);let i=this.gl,r=this.supportsDrawBuffers();var n,s=t instanceof e.WebGLRenderTargetCube;if(t&&!t.__webglFramebuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.addEventListener("dispose",this.onRenderTargetDispose),t.__webglTexture=[],t.__webglTexture[0]=i.createTexture(),t.colorCount>1&&(t.__webglMRTFramebuffers=[]),this.memoryInfo.renderTargets++,this.__glResources__.renderTarget[t.uniqueID]=t;var a=this.isPowerOfTwo(t.width)&&this.isPowerOfTwo(t.height),o=this.paramThreeToGL(t.format),l=this.paramThreeToGL(t.type),h=this.getInternalFormatFromFormatAndType(o,l,!0);if(s){t.__webglFramebuffer=[],t.__webglRenderbuffer=[];for(let e=0;e<t.__webglTexture.length;e++){i.bindTexture(i.TEXTURE_CUBE_MAP,t.__webglTexture[e]),this.setTextureParameters(i.TEXTURE_CUBE_MAP,t,a);for(var c=0;c<6;c++)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,h,t.width,t.height,0,o,l,null)}for(var d=0;d<6;d++)t.__webglFramebuffer[d]=i.createFramebuffer(),t.__webglRenderbuffer[d]=i.createRenderbuffer(),this.setupFrameBuffer(t.__webglFramebuffer[d],t,i.TEXTURE_CUBE_MAP_POSITIVE_X+d),this.setupRenderBuffer(t.__webglRenderbuffer[d],t);a&&i.generateMipmap(i.TEXTURE_CUBE_MAP)}else{t.__webglFramebuffer=i.createFramebuffer(),t.__webglRenderbuffer=i.createRenderbuffer();for(let e=0;e<t.colorCount;e++)if(e>0&&(t.__webglTexture[e]=i.createTexture()),i.bindTexture(i.TEXTURE_2D,t.__webglTexture[e]),this.setTextureParameters(i.TEXTURE_2D,t,a),i.texImage2D(i.TEXTURE_2D,0,h,t.width,t.height,0,o,l,null),e>0){let r=i.createFramebuffer();t.__webglMRTFramebuffers[e-1]=r,i.bindFramebuffer(i.FRAMEBUFFER,r),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t.__webglTexture[e],0)}this.setupFrameBuffer(t.__webglFramebuffer,t,i.TEXTURE_2D),this.setupRenderBuffer(t.__webglRenderbuffer,t),a&&i.generateMipmap(i.TEXTURE_2D)}s?i.bindTexture(i.TEXTURE_CUBE_MAP,null):i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null)}else if(t&&(t.minFilter!==t.originalMinFilter||t.magFilter!==t.originalMagFilter)){if(a=this.isPowerOfTwo(t.width)&&this.isPowerOfTwo(t.height),s){for(let e=0;e<t.__webglTexture.length;e++)i.bindTexture(i.TEXTURE_CUBE_MAP,t.__webglTexture[e]),this.setTextureParameters(i.TEXTURE_CUBE_MAP,t,a);i.bindTexture(i.TEXTURE_CUBE_MAP,null)}else{for(let e=0;e<t.__webglTexture.length;e++)i.bindTexture(i.TEXTURE_2D,t.__webglTexture[e]),this.setTextureParameters(i.TEXTURE_2D,t,a);i.bindTexture(i.TEXTURE_2D,null)}t.originalMinFilter=t.minFilter,t.originalMagFilter=t.magFilter}if(t){n=s?t.__webglFramebuffer[t.activeCubeFace]:t.__webglFramebuffer;let r=!0,a=t.shareDepthFrom;if(a){let o=!0;if(a.__webglRenderbuffer||(console.warn("sharedDepth from an unused renderTarget"),o=!1),a.width==t.width&&a.height==t.height||(console.warn("sharedDepth from a renderTarget of different size"),o=!1),a instanceof e.WebGLRenderTargetCube!=s&&(console.warn("sharedDepth renderTarget or current renderTarget is cube and not the other"),o=!1),a.depthBuffer==t.depthBuffer&&a.stencilBuffer==t.stencilBuffer||(console.warn("sharedDepth renderTarget has a different format from current renderTarget"),o=!1),o){let e=s?a.__webglRenderbuffer[t.activeCubeFace]:a.__webglRenderbuffer;i.bindFramebuffer(i.FRAMEBUFFER,n),t.depthBuffer&&!t.stencilBuffer?i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e):t.depthBuffer&&t.stencilBuffer&&i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e),i.bindFramebuffer(i.FRAMEBUFFER,null),t.__currentFrameBuffer=a.__webglRenderbuffer,r=!1}}if(r&&t.__currentFrameBuffer){let e=s?t.__webglRenderbuffer[t.activeCubeFace]:t.__webglRenderbuffer;i.bindFramebuffer(i.FRAMEBUFFER,n),t.depthBuffer&&!t.stencilBuffer?i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e):t.depthBuffer&&t.stencilBuffer&&i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e),i.bindFramebuffer(i.FRAMEBUFFER,null),t.__currentFrameBuffer=null}}else n=this._VRFrameBuffer?this._VRFrameBuffer:null;if(i&&i.bindFramebuffer(i.FRAMEBUFFER,n),e.glStates.currentFramebuffer=n,t&&r&&t.__webglTexture.length>1){let e=[];for(let i=0;i<t.__webglTexture.length;i++)e.push(r.COLOR_ATTACHMENT0_WEBGL+i);r.drawBuffersWEBGL(e)}}setDepthFunc(e){this.gpuStates.depthFunc!==e&&this.gl.depthFunc(e),super.setDepthFunc(e)}setDepthTest(e){this.gpuStates.depthTest!==e&&(e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST)),super.setDepthTest(e)}clear(e,t,i){let r=this.gl;var n=0;(void 0===e||e)&&(n|=r.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=r.DEPTH_BUFFER_BIT);var s=!1;(void 0===i||i)&&(s=!0,n|=r.STENCIL_BUFFER_BIT,this.setStencilWrite(!0)),n&&r.clear(n),s&&!this.enableStencilWrite&&this.setStencilWrite(!1)}setColorWrite(e){if(this.disableSetColorWrite)return;let t=this.gpuStates;t.colorWrite!==e&&(e?this.gl&&this.gl.colorMask(!0,!0,!0,!0):this.gl&&this.gl.colorMask(!1,!1,!1,!1),t.colorWrite=e)}setStencilWrite(e){let t=this.gpuStates;e!==t.stencilWrite&&(e?this.gl&&this.gl.stencilMask(255):this.gl&&this.gl.stencilMask(0),t.stencilWrite=e)}setDepthWrite(e){let t=this.gpuStates;t.depthWrite!==e&&(this.gl&&this.gl.depthMask(e),t.depthWrite=e)}}}),define("DS/Visualization/OccurrenceInterface",["UWA/Class","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";function r(e){if(!e._occurrenceExplorer._occurrenceInterfaceList){var t=new Error("Use of expired OccurrenceInterface (= outside of callback function given to OccurrenceExplorer.explore())");throw t.expiredOccurrenceInterfaceError=!0,t}return e._occurrenceExplorer._occurrenceList[e._node][e._index].occurrence}return e.extend({init:function(e,t,i){this._node=e,this._index=t,this._occurrenceExplorer=i},getNbChildren:function(){return r(this).children.length},getParent:function(){var e=r(this);return this._occurrenceExplorer.getOccurrenceInterface(e.parent)},getChild:function(e){var t=r(this);return this._occurrenceExplorer.getOccurrenceInterface(t.children[e])},getChildren:function(){var e,t=r(this),i=[];for(e=0;e<t.children.length;e++)i.push(this._occurrenceExplorer.getOccurrenceInterface(t.children[e]));return i},traverse:function(e,t){var i=r(this);if(!e(this,t)){var n=0;for(n=0;n<i.children.length;n++)this._occurrenceExplorer.getOccurrenceInterface(i.children[n]).traverse(e,t)}},getNode:function(){return r(this).node},getMesh3D:function(){var e=r(this);return"Mesh3D"===e.node.getNodeType()?e.node:null},getColor:function(e){var t=r(this);if(this._tryOverridesUpdate(t),t.renderable){var n=t.occurrenceRenderingOverride&&t.occurrenceRenderingOverride.materialOverride,s=n&&n.getColor()||null,a=n&&n.getFullMaterial(),o=t.renderable.matApp&&t.renderable.matApp._getMaterialFromGLType(4,i.GeomTypeEnum.FACE),l=!1;!o&&t.renderable.material?(l=!0,!(o=t.renderable.material)||!e&&o.force||(o=null)):o&&e&&(o=null);var h=null;null===s&&!a||o&&o.color&&!o.overridable?h=o&&o.color&&(!l||o.force)&&o.color.clone():(h=a&&a.color&&a.color.clone(),null===s||h&&!a.overridable||(h=new i.Color(s)))}return h},getWorldMatrix:function(e){var t=r(this);return this._tryOverridesUpdate(t),e?(e.copy(t.matrix),e):t.matrix.clone()},getMatrix:function(e){var t=r(this);this._tryOverridesUpdate(t);var i=t.getLocalMatrix();return e?(e.copy(i),e):i.clone()},getMatrixInAxisSystem:function(e,t){var r=this.getWorldMatrix();if(!r)return null;var n=t||new i.Matrix4,s=new i.Matrix4;return s.getInverse(e),n.multiplyMatrices(s,r),n},getRenderableDescendants:function(){var e=r(this),t=[],i=this;return e.traverse(function(e){e.renderable&&t.push(i._occurrenceExplorer.getOccurrenceInterface(e))}),t},buildPathElement:function(e){var i=new t,n=r(this);return i.setFromOccurrence(n,null,e)?i:null},getVisibility:function(){var e=r(this);return this._tryOverridesUpdate(e),e._getVisible()},getBoundingSphere:function(e){return r(this).getBoundingSphere(e,!1)},getBoundingBox:function(e){return r(this).getBoundingBox(e)},isAParentOf:function(e){for(var t=e;t&&this!==t;)t=t.getParent();return t===this},findAncestor:function(e){for(var t=this.getParent(),i=null;t&&!i;)e(t)&&(i=t),t=t.getParent();return i},_tryOverridesUpdate:function(e){var t,i=this._occurrenceExplorer.viewer;if(e._getNeedOverridesUpdate()){for(t=e;t.parent;)t=t.parent;i=i||e.scene3js&&e.scene3js.viewer,t.node._tryOverridesUpdate(i)}}})}),define("DS/Visualization/MaterialConnection",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=-1,i=1,r=2,n=function(e){e=e||{},this.setParams(e)};return n.prototype.setParams=function(e){this.appearanceId=e.appearanceId||null,this.pathElement=e.pathElement||null,this.type=e.type||n._UNKNOWN,this.status=null!==this.pathElement?i:t,this.vLayer=e.vLayer||0},n.prototype.isComplete=function(){return this.status===i},n.prototype.isIncomplete=function(){return this.status===t},n.prototype.isError=function(){return this.status===r},n.prototype.computeLayer=function(t){var i=this.pathElement.externalPath.length,r=this.vLayer;return this.type===n.CORE_MATERIAL?e.MaterialLayerMax:0+16*i+r},n._UNKNOWN=0,n.COVERAGE_MATERIAL=1,n.CORE_MATERIAL=2,n}),define("DS/Visualization/Filters/PlaneViewModeFilter",["DS/Visualization/Filters/VisuFilter","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";return class extends e{constructor(e,i){if(super(),this.planeFilters=[],!(i instanceof t.Plane)||null==e)return;this.localMode=e;let r={mode:e,plane:i};this.planeFilters.push(r)}mergeLocalFilter(e){null!==this.localMode&&void 0!==this.localMode?e.mode===t.PlaneViewMode.NO_PICK&&this.localMode===t.PlaneViewMode.LOWLIGHT||e.mode===t.PlaneViewMode.LOWLIGHT&&this.localMode===t.PlaneViewMode.NO_PICK?this.planeFilters[0].mode=t.PlaneViewMode.LOWLIGHT_NO_PICK:e.mode>this.localMode?this.planeFilters[0].mode=e.mode:this.localMode>=e.mode&&(this.planeFilters[0].mode=this.localMode):this.planeFilters[0].mode=e.mode}solveInherit(e,t,i){let r=this.planeFilters[0];if(!t)return i&&(this.planeFilters=[],r.mode=this.localMode,this.planeFilters.push(r)),this;this.planeFilters=[],this.planeFilters.push(r);let n=!1;for(let e of t.planeFilters)e.plane.equals(r.plane)?(this.mergeLocalFilter(e),n=!0):this.planeFilters.push(e);return n||(this.planeFilters[0].mode=this.localMode),this}}}),define("DS/Visualization/PLMMaterialConnectionFactory",["DS/Visualization/MaterialConnection","DS/Visualization/PathElement","DS/Visualization/IdPathWatcher","DS/Visualization/IdPath"],function(e,t,i,r){"use strict";var n=function(){this.loadAppearanceCB=null,this.getNodeFromIdCB=null,this.computePathElementCB=null,this.idPathWatcher=null,this.appearanceIdMap=new Map,this.internalPathIds=new Map,this.legacyUVIds=new Map,this.oocManager=null};return n.prototype.setParams=function(e){e.loadAppearanceCB&&(this.loadAppearanceCB=e.loadAppearanceCB),e.getNodeFromIdCB&&(this.getNodeFromIdCB=e.getNodeFromIdCB),e.useIdPathMatcher&&e.viewer&&(this.idPathWatcher=new i({viewer:e.viewer,onIdPathActiveCB:this._onIdPathActive.bind(this),onIdPathInactiveCB:this._onIdPathInactive.bind(this)})),e.oocManager&&(this.oocManager=e.oocManager)},n.prototype.addMaterialConnection=function(e,t){if(this.idPathWatcher){if(t.legacyUV){var i=(n=t.idPath)[n.length-1];this._addLegacyUVId(i)}if(t.internalPath){var n,s="##REP##"+(i=(n=t.idPath)[n.length-1]);t.idPath=n.concat([s]),this._addInternalIdPathId(i)}var a=t.appearanceId,o=this.appearanceIdMap.get(a);o?o[1]=t:(o=[e,t],this.appearanceIdMap.set(a,o),this.idPathWatcher.addIdPath(new r(t.idPath),o))}else this._addMaterialConnectionOnMaterializedIdPath.apply(this,arguments)},n.prototype.removeMaterialConnection=function(e){var t=this.appearanceIdMap.get(e);if(t){var i=t[1];if(i&&i.internalPath){var r=i.idPath[i.idPath.length-2];r&&this._removeInternalIdPath(r),r&&this._removeLegacyUVId(r)}this.idPathWatcher.removeIdObject(t),this.appearanceIdMap.delete(e)}},n.prototype._addMaterialConnectionOnMaterializedIdPath=function(t,i){var r=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher(),n=r?r.idToNode(t):this.getNodeFromIdCB(t);if(n){var s=n.getPLMMaterialData(),a=i.pathElement,o=a?[a]:[];if(!a){var l=i.idPath;if((a=this.getPathElementFromIdPath(l))&&o.push(a),a&&(i.internalUUIDPath||i.internalPath)){var h=a.externalPath.length,c=h>0?a.externalPath[h-1]:a.externalPath[0];if(i.internalUUIDPath)o=c.getPathElementsFromUUIDs(a,i.internalUUIDPath,i.cgmIdRep,i.cgmIdPrimitive?[i.cgmIdPrimitive]:null);else{var d=[];null!==i.internalPath&&void 0!==i.internalPath&&d.push(i.internalPath),null!==i.cgmIdRep&&void 0!==i.cgmIdRep&&d.push(i.cgmIdRep),null!==i.cgmIdPrimitive&&void 0!==i.cgmIdPrimitive&&d.push(i.cgmIdPrimitive);var u=i.cgmIdPrimitives?i.cgmIdPrimitives:i.cgmIdPrimitive?[i.cgmIdPrimitive]:null;o=c.getPathElementsFromDiezeEle(a,i.internalPath?[i.internalPath]:null,i.cgmIdRep,u)}}}if(o)for(var p=0;p<o.length;p++){var f=new e({pathElement:o[p],appearanceId:i.appearanceId,type:i.type,depth:i.depth,vLayer:i.vLayer});s.addMaterialConnection(f)}}},n.prototype.getPathElementFromIdPath=function(e){var i,r,n=[],s=this.idPathWatcher&&this.idPathWatcher.getIdPathMatcher();for(i=0;i<e.length;i++){var a=e[i];if(!(r=s?s.idToNode(a):this.getNodeFromIdCB(a)))return null;n.push(r)}return new t(n)},n.prototype.hasInternalPath=function(e){return(this.internalPathIds.get(e)||0)>0},n.prototype.hasLegacyUV=function(e){return(this.legacyUVIds.get(e)||0)>0},n.prototype._onIdPathActive=function(e){this._addMaterialConnectionOnMaterializedIdPath.apply(this,e)},n.prototype._onIdPathInactive=function(e){},n.prototype._addInternalIdPathId=function(e){var t=this.internalPathIds.get(e)||0;t++,this.internalPathIds.set(e,t)},n.prototype._removeInternalIdPath=function(e){var t=this.internalPathIds.get(e)||0;t>0&&(0===--t?this.internalPathIds.delete(e):this.internalPathIds.set(e,t))},n.prototype._addLegacyUVId=function(e){var t=this.legacyUVIds.get(e)||0;if(t++,this.legacyUVIds.set(e,t),1===t&&this.oocManager){var i=this.oocManager._getLDHReference(e,!0);i&&i.setLegacyUV()}},n.prototype._removeLegacyUVId=function(e){var t=this.legacyUVIds.get(e)||0;t>0&&(0===--t?this.legacyUVIds.delete(e):this.legacyUVIds.set(e,t))},n.prototype.COVERAGE_MATERIAL=e.COVERAGE_MATERIAL,n.prototype.CORE_MATERIAL=e.CORE_MATERIAL,new n}),define("DS/Visualization/WebGLViewerEffectSettings",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/QualityManager/QMController","DS/Effects/ESMEffect"],function(e,t,i,r){"use strict";const n="true"===localStorage.getItem("__WEBVISU_NEW_TRANSPARDL_SORTING__");var s={AntiAliasing:{static:"NoAA",dynamic:"NoAA",override:"NoAA",contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:5,dynamic:6,override:5},LOD:{static:.5,dynamic:3,override:.5},Transparency:{static:"AlphaBlending",dynamic:"AlphaBlending",override:"AlphaBlending"},GroundShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:"PCF",dynamic:"PCF",override:"PCF"},ShadowFilter:{static:"Low",dynamic:"Low",override:"Low"},FlakesQuality:{static:"Low",dynamic:"Low",override:"Low"},DefaultMaterialQuality:{static:"Low",dynamic:"Low",override:"Low"},DownsamplingFactor:{static:1,dynamic:1,override:1},GroundReflection:{static:!1,dynamic:!1,override:!1},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},SSAO:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSAO:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSAONbSamples:{static:8,dynamic:8,override:8},Bloom:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ZPrePass:{static:!1,dynamic:!1,override:!1,contentChecker:!1},SSR:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSR:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSRefraction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSRefraction:{static:!0,dynamic:!0,override:!0,contentChecker:!1}};class a{constructor(e,t){this.viewer=e,this.settings={},t.useQM?(Object.assign(this.settings,s),Object.assign(this.settings.AllowGroundShadows,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowInterObjectShadows,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowTransparentObjectShadows,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowGroundReflection,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowSSAO,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowSSR,{static:!1,dynamic:!1,override:!1}),Object.assign(this.settings.AllowSSRefraction,{static:!1,dynamic:!1,override:!1})):this.settings={AntiAliasing:{static:e.antiAliasing,dynamic:"MSAA"!==e.antiAliasing?e.antiAliasing:"SMAA",override:e.antiAliasing,contentChecker:!1},Outline:{static:!0,dynamic:!1,override:!0},PixelCulling:{static:4.5,dynamic:4.5,override:4.5},LOD:{static:.5,dynamic:3,override:.5},Transparency:{static:t.enableOIT?"WeightedAverage":"AlphaBlending",dynamic:t.enableOIT?"WeightedAverage":"AlphaBlending",override:t.enableOIT?"WeightedAverage":"AlphaBlending"},GroundShadows:{static:e.useGroundShadow,dynamic:e.useGroundShadow,override:e.useGroundShadow,contentChecker:!1},AllowGroundShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},InterObjectShadows:{static:e.useShadowMap,dynamic:e.useShadowMap,override:e.useShadowMap,contentChecker:!1},AllowInterObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},TransparentObjectShadows:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowTransparentObjectShadows:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ShadowQuality:{static:e.shadowQuality,dynamic:e.shadowQuality,override:e.shadowQuality},ShadowFilter:{static:e.shadowFilter,dynamic:e.shadowFilter,override:e.shadowFilter},FlakesQuality:e.ODTMode?{static:"Ultra",dynamic:"Ultra",override:"Ultra"}:{static:"High",dynamic:"High",override:"High"},DefaultMaterialQuality:{static:"High",dynamic:"High",override:"High"},DownsamplingFactor:{static:1,dynamic:1,override:1},GroundReflection:{static:e.useMirror,dynamic:e.useMirror,override:e.useMirror},AllowGroundReflection:{static:!0,dynamic:!0,override:!0},SSAO:{static:e.useSSAO,dynamic:e.useSSAO,override:e.useSSAO,contentChecker:!1},AllowSSAO:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSAONbSamples:{static:16,dynamic:16,override:16},Bloom:{static:e.useBloom,dynamic:e.useBloom,override:e.useBloom,contentChecker:!1},AllowBloom:{static:!0,dynamic:!0,override:!0,contentChecker:!1},DepthOfField:{static:e.useDOF,dynamic:e.useDOF,override:e.useDOF,contentChecker:!1},AllowDepthOfField:{static:!0,dynamic:!0,override:!0,contentChecker:!1},ZPrePass:{static:!1,dynamic:!1,override:!1,contentChecker:!1},SSR:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSR:{static:!0,dynamic:!0,override:!0,contentChecker:!1},SSRefraction:{static:!1,dynamic:!1,override:!1,contentChecker:!1},AllowSSRefraction:{static:!0,dynamic:!0,override:!0,contentChecker:!1}},this._lqFallback=!1,this._blackListedEffects=new Set,this._lockedSettings=new Map,this._infPlaneVisibilityBackUp=!1}_lockSettings(e){const t=Object.keys(e);for(let i=0;i<t.length;i++){let r=t[i];switch(r){case"DefaultMaterialQuality":const t=e[r];null==t?this._lockedSettings.delete(r):"High"===t||"Low"===t?this._lockedSettings.set(r,e[r]):console.warn("Lock Settings: Invalid value "+t+" for DefaultMaterialQuality");break;default:console.warn("Lock Settings: Unknown key "+r)}}this.viewer.render()}_checkCompatibility(){this.viewer.renderer.isDeviceCompatibleWithSSR()||(this._blackListedEffects.add("SSRefraction"),this._blackListedEffects.add("SSR")),this.viewer.renderer.isDeviceCompatibleWithOIT()||this._blackListedEffects.add("Transparency"),this.viewer.renderer.isDeviceCompatibleWithSSAO()||this._blackListedEffects.add("SSAO")}updateViewerSettings(e,r){var n=!1;this.viewer._QMInit&&i.getLinkedPresetStatus()&&("dynamic"===e&&(e="static"),"dynamic"===r&&(r="static",n=!0));var s=this.viewer;this._setPixelCulling(e),this._setLOD(e),this._setAntiAliasing(r,n),this._setShadow(e),this._setTransparentShadow(e),this._setShadowFilter(e),this._setShadowQuality(e),this._setGroundShadow(e),this._setOIT(e),this._setFlakesQuality(e),s.renderer.renderer._defaultAppearanceType!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._setDefaultMaterialQuality(e),this._enableZPrePass(e),this._setMirror(e),this._setSSAO(e),this._setBloom(e),this._setDOF(e),this._setSSLR(e),this._setSSLRefraction(e),s.renderer.renderer.currentRendererMode=t.RendererMode[e];var a=s.renderer.SSAOEffect,o=s.renderer.SSAOIterativeEffect,l=this,h=function(t){t.setDynamicRadius(s.ssaoParams.dynamicRadius),t.setAdaptativeRadius(s.ssaoParams.adaptativeRadius),t.setRadius(s.ssaoParams.radius),t.setRadiusRange(s.ssaoParams.radiusMin,s.ssaoParams.radiusMax),t.setMinPixelRadius(s.ssaoParams.minPixelRadius),t.setAttenuation(s.ssaoParams.attenuation),t.setThresholdAngle(s.ssaoParams.thresholdAngle),t.setNbSamples(l.getSSAONbSamples(e))};a&&h(a),o&&h(o),s.infPlaneSmall&&s.infPlaneSmall.visible&&(this._infPlaneVisibilityBackUp=!0,s.infPlaneSmall.visible=this.getShadow(e)&&this.getAllowShadow(e)||this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e)||this.getGroundShadow(e)&&this.getAllowGroundShadow(e)||this.getSSAO(e)&&this.getAllowSSAO(e))}updateViewerSettingsPostRender(e,t){this._infPlaneVisibilityBackUp&&(this._infPlaneVisibilityBackUp=!1,this.viewer.infPlaneSmall&&(this.viewer.infPlaneSmall.visible=!0)),this._setDownsamplingFactor(e)}_isBlackListed(e){return this._blackListedEffects.has(e)}getSetting(e,t){return this._blackListedEffects.has(e)?s[e][t]:this.settings[e][t]}setSetting(e,t,i){if(!this._blackListedEffects.has(e)){var r=this.settings[e][t];this.settings[e][t]=i,r!==i&&this.viewer.render()}}updateAmbienceBackScale(e){var t=this.viewer;"FSAA"===this.getAntiAliasing(e)?t.ambience.getBackground().setBackplateScale(2):t.ambience.getBackground().setBackplateScale(1),t.ambience.update()}copySettings(e,t){var i=this;Object.entries(this.settings).forEach(r=>{i.settings[r[0]][e]=r[1][t]})}_setFromJson(e,t){var i=this;Object.entries(t).forEach(t=>{i.settings[t[0]]&&(i.settings[t[0]][e]=t[1])})}_updateState(e,i,r){var n=this.viewer,s=this.getSetting(e,i);this.setSetting(e,i,r),s!==this.getSetting(e,i)&&n.renderer&&n.renderer.recompileAllShaders([t.RendererMode[i]])}_updateQM(e,t,i){var r=this.viewer;r[e]&&r[e](i,t)}setShadow(t,i,r){var n=this.viewer._directionalLight;if(null!==n){n.light3js.LiSPSM=i;for(let e=0;e<n._occurrences.length;e++)n._occurrences[e].renderable.LiSPSM=i}for(var s=this.getShadow("static"),a=r?[r]:["static","dynamic"],o=0;o<a.length;o++){var l=a[o];this._updateState("InterObjectShadows",l,t)}var h=this.getShadow("static");h!==s&&e.publish({event:"/WUX/AFR/CMD/VisuToggleShadow/"+(h?"BEGIN":"END")})}getShadow(e){return e=e||"static",this.getSetting("InterObjectShadows",e)}setAllowShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowShadow",n,e),this._updateState("AllowInterObjectShadows",n,e)}}getAllowShadow(e){return e=e||"static",this.getSetting("AllowInterObjectShadows",e)}_setShadow(e){this.viewer.useShadowMap=this.getShadow(e)&&this.getAllowShadow(e)}setShadowFilter(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetShadowFilter",n,e),this._updateState("ShadowFilter",n,e)}}_setShadowFilter(e){var i=this.viewer;if(this.getShadowFilter(e)!==i.shadowFilter){switch(i.shadowFilter=this.getShadowFilter(e),i.shadowFilter){case"PCF":i.renderer.renderer.shadowMapType=t.PCFShadowMap;break;case"PCFInterpol":i.renderer.renderer.shadowMapType=t.PCFInterpolShadowMap;break;case"PCFPoisson":case"poisson":i.renderer.renderer.shadowMapType=t.PCFPoissonShadowMap;break;case"PCFOptimized":i.renderer.renderer.shadowMapType=t.PCFOptimizedShadowMap;break;case"ESM":i.renderer.renderer.shadowMapType=t.ESMShadowMap,i.renderer.renderer.esmEffect||(i.renderer.renderer.esmEffect=new r(i.renderer.renderer,i.renderer.renderTargetPool));break;default:i.renderer.renderer.shadowMapType=t.BasicShadowMap}i._updateShadowMaps()}}getShadowFilter(e){return e=e||"static",this.getSetting("ShadowFilter",e)}setShadowQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetShadowQuality",n,e),this._updateState("ShadowQuality",n,e)}}_setShadowQuality(e){var i=this.viewer;this.getShadowQuality(e)!==i.shadowQuality&&(i.shadowQuality=this.getShadowQuality(e),"Medium"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.MediumQuality:"High"===i.shadowQuality?i.renderer.renderer.shadowMapQuality=t.HighQuality:i.renderer.renderer.shadowMapQuality=t.LowQuality,i._updateShadowMaps())}getShadowQuality(e){return e=e||"static",this.getSetting("ShadowQuality",e)}setGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("GroundShadows",n,e)}}getGroundShadow(e){return e=e||"static",this.getSetting("GroundShadows",e)}_setGroundShadow(e){var t=this.getGroundShadow(e)&&this.getAllowGroundShadow(e),i=this.viewer;i.useGroundShadow!==t&&(i.useGroundShadow=t,i.renderer.resetGSSOCache(),i._dirLightGroundShadow.light3js.groundMaterial&&(i.useGroundShadow?i._dirLightGroundShadow.light3js.groundMaterial.defines.GROUND_SHADOW=1:i._dirLightGroundShadow.light3js.groundMaterial.defines.GROUND_SHADOW=0,i._dirLightGroundShadow.light3js.groundMaterial.needsUpdate=!0))}setAllowGroundShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowGroundShadow",n,e),this._updateState("AllowGroundShadows",n,e)}}getAllowGroundShadow(e){return e=e||"static",this.getSetting("AllowGroundShadows",e)}setTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("TransparentObjectShadows",n,e)}}getTransparentShadow(e){return e=e||"static",this.getSetting("TransparentObjectShadows",e)}setAllowTransparentShadow(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowTransparentShadow",n,e),this._updateState("AllowTransparentObjectShadows",n,e)}}getAllowTransparentShadow(e){return e=e||"static",this.getSetting("AllowTransparentObjectShadows",e)}_setTransparentShadow(e){var t=this.viewer,i=this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e);t.renderer.renderer.transparentShadowEnabled!==i&&(t._updateShadowMaps(),t.renderer.renderer.transparentShadowEnabled=i)}setOIT(e,t){var i=this.viewer;i.renderer&&!i.renderer.isDeviceCompatibleWithOIT()&&(console.warn("Warning: OIT is not compatible with this device"),e=!1,t=null);for(var r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var s=r[n],a=e?"WeightedAverage":"AlphaBlending";this._updateQM("_qmSetTransparency",s,a),this._updateState("Transparency",s,a)}}_setOIT(e){var t=this.getOIT(e),i=this.viewer;t&&i.getRenderPriority()?console.warn("Warning: OIT is not compatible with render priority"):i.renderer.renderer.useOIT!==t&&(n&&i.renderer.resetGSSOCache(),i.renderer.setEffect("OIT",t),i.renderer.setEffect("OITnoZ",t))}getOIT(e){return e=e||"static","WeightedAverage"===this.getSetting("Transparency",e)}setFlakesQuality(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetFlakesQuality",n,e),this._updateState("FlakesQuality",n,e)}}_setFlakesQuality(e){this.viewer.renderer.renderer.flakesMode={Low:3,Medium:2,High:1,Ultra:0}[this.getFlakesQuality(e)]}getFlakesQuality(e){return e=e||"static",this.getSetting("FlakesQuality",e)}setDownsamplingFactor(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this._updateQM("_qmSetDownsamplingFactor",r,e),this.setSetting("DownsamplingFactor",r,e)}}_setDownsamplingFactor(e){this.viewer.renderer.renderer._renderScale=this.getDownsamplingFactor()}getDownsamplingFactor(){return this.getSetting("DownsamplingFactor","static")}setDefaultMaterialQuality(e){for(var t=["static","dynamic"],i=0;i<t.length;i++){var r=t[i];this._updateQM("_qmSetDefaultMaterialQuality",r,e),this._updateState("DefaultMaterialQuality",r,e)}}_setDefaultMaterialQuality(e){var t=this.viewer,i={Low:!0,Medium:!0,High:!1,Ultra:!1}[this.getDefaultMaterialQuality()];t.renderer.renderer.gasAsPhong!=i&&(t.renderer.renderer.gasAsPhong=i,t.renderer.resetGSSOCache())}getDefaultMaterialQuality(){return this._lockedSettings.has("DefaultMaterialQuality")?this._lockedSettings.get("DefaultMaterialQuality"):this.getSetting("DefaultMaterialQuality","static")}enableZPrePass(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmEnableZPrePass",n,e),this.setSetting("ZPrePass",n,e)}}_enableZPrePass(e){this.viewer.renderer._enableZPrePass(this.zPrePassEnabled(e))}zPrePassEnabled(e){return e=e||"static",this.getSetting("ZPrePass",e)}setMirror(t,i,r,n,s){var a=this.viewer;n=void 0!==n?n:.3,s=void 0!==s?s:.85,i=void 0!==i?i:a.blurryMirror,a.renderer&&a.renderer.mirrorBlendPass&&a.renderer.mirrorBlendPass.material.setUniform("reflectivity",n),a.blurryMirror=i,a.blurryMirror&&a.ambience.setGroundGlossiness(s);for(var o=this.getMirror("static"),l=r?[r]:["static","dynamic"],h=0;h<l.length;h++){var c=l[h];this.setSetting("GroundReflection",c,t)}var d=this.getMirror("static");d!==o&&e.publish({event:"/WUX/AFR/CMD/VisuToggleMirror/"+(d?"BEGIN":"END")})}getMirror(e){return e=e||"static",this.getSetting("GroundReflection",e)}setAllowMirror(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowMirror",n,e),this.setSetting("AllowGroundReflection",n,e)}}getAllowMirror(e){return e=e||"static",this.getSetting("AllowGroundReflection",e)}_setMirror(e){var t=this.getMirror(e)&&this.getAllowMirror(e),i=this.viewer;!i.useHDR&&i.cameraSystem&&(t=!1),i.useMirror!==t&&(i.renderer.resetGSSOCache(),i.useMirror=t)}setPixelCulling(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetPixelCulling",n,e),this.setSetting("PixelCulling",n,e)}}getPixelCulling(e){return e=e||"static",this.getSetting("PixelCulling",e)}_setPixelCulling(e){var t=this.viewer;t.currentViewpoint&&t.currentViewpoint._setPixelCulling(this.getPixelCulling(e))}setLOD(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetLOG",n,e),this.setSetting("LOD",n,e)}}getLOD(e){return e=e||"static",this.getSetting("LOD",e)}_setLOD(e){this.viewer._currentLOD=this.getLOD(e)}setBloom(e,t){for(var i=this.viewer,r=t?[t]:["static","dynamic"],n=0;n<r.length;n++){var s=r[n];this.setSetting("Bloom",s,e)}e&&!i.getEffect("Bloom")&&(i.renderer.setEffect("Bloom",!0),i.renderer.setEffect("Bloom",!1))}getBloom(e){return e=e||"static",this.getSetting("Bloom",e)}_setBloom(e){var t=this.viewer,i=this.getBloom(e)&&this.getAllowBloom(e);t.useBloom!==i&&(t.useBloom=i,t.renderer.setEffect("Bloom",t.useBloom))}setAllowBloom(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("qmSetAllowBloom",n,e),this.setSetting("AllowBloom",n,e)}}getAllowBloom(e){return e=e||"static",this.getSetting("AllowBloom",e)}setSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSRefraction",n,e)}}getSSLRefraction(e){return e=e||"static",this.getSetting("SSRefraction",e)}setAllowSSLRefraction(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSRefraction",n,e),this._updateState("AllowSSRefraction",n,e)}}getAllowSSLRefraction(e){return e=e||"static",this.getSetting("AllowSSRefraction",e)}_setSSLRefraction(e){var t=this.viewer,i=this.getSSLRefraction(e)&&this.getAllowSSLRefraction(e);t.useSSLRefraction!==i&&(t.useSSLRefraction=i,this.getTransparentShadow(e)&&this.getAllowTransparentShadow(e)&&(t._updateShadowMaps(),t.renderer.resetGSSOCache()),t.renderer.setEffect("SSLRefraction",t.useSSLRefraction))}setSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSR",n,e)}}getSSLR(e){return e=e||"static",this.getSetting("SSR",e)}setAllowSSLR(e,t){this.viewer;for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSR",n,e),this._updateState("AllowSSR",n,e)}}getAllowSSLR(e){return e=e||"static",this.getSetting("AllowSSR",e)}_setSSLR(e){var t=this.viewer,i=this.getSSLR(e)&&this.getAllowSSLR(e);t.useSSLRDirect!==i&&(t.useSSLRDirect=i,t.renderer.setEffect("SSLRDirect",i),t.renderer.renderer.useSSLR=i)}setDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this.setSetting("DepthOfField",n,e)}var s=this.viewer;e&&!s.getEffect("DOF")&&(s.renderer.setEffect("DOF",!0),s.renderer.setEffect("DOF",!1))}getDOF(e){return e=e||"static",this.getSetting("DepthOfField",e)}setAllowDOF(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowDOF",n,e),this.setSetting("AllowDepthOfField",n,e)}}getAllowDOF(e){return e=e||"static",this.getSetting("AllowDepthOfField",e)}_setDOF(e){var t=this.viewer,i=this.getDOF(e)&&this.getAllowDOF(e);if(t.useDOF!==i&&(t.useDOF=i,t.renderer.setEffect("DOF",t.useDOF)),"static"===e){var r="MSAA"===this.getAntiAliasing(e),n=t.getEffect("DOF");n&&n.setIterative(t.useDOFIterative&&r)}}setSSAONbSamples(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetSSAONbSamples",n,e),this.setSetting("SSAONbSamples",n,e)}}getSSAONbSamples(e){return e=e||"static",this.getSetting("SSAONbSamples",e)}setSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateState("SSAO",n,e)}}getSSAO(e){return e=e||"static",this.getSetting("SSAO",e)}setAllowSSAO(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r];this._updateQM("_qmSetAllowSSAO",n,e),this._updateState("AllowSSAO",n,e)}}getAllowSSAO(e){return e=e||"static",this.getSetting("AllowSSAO",e)}_setSSAO(e){var t=this.viewer,i=this.getSSAO(e)&&this.getAllowSSAO(e),r="MSAA"===this.getAntiAliasing(e);t.useSSAO=i;var n=t.useSSAOIterative&&r&&t.renderIteration>0;t.renderer.setEffect("SSAO",t.useSSAO&&!n),t.renderer.setEffect("SSAOIterative",t.useSSAO&&n)}setAntiAliasing(e,t){for(var i=t?[t]:["static","dynamic"],r=0;r<i.length;r++){var n=i[r],s=null;"SMAA"===e||"MLAA"===e||"FXAA"===e||"FSAA"===e||"MSAA"===e||"SSAA"===e||"TAA"===e?s="dynamic"===n&&"MSAA"===e?"SMAA":e:"NoAA"===e||!1===e?s="NoAA":!0===e?s="SMAA":"MSMAA"===e&&(console.warn("MSMAA is deprecated"),s="dynamic"===n?"SMAA":"MSAA"),s&&(this._updateQM("_qmSetAntiAliasing",n,s),this.setSetting("AntiAliasing",n,s))}}getAntiAliasing(e){return this.getSetting("AntiAliasing",e)}_setAntiAliasing(e,t){var r=this.viewer,n=this.getAntiAliasing(e),s=this.getAntiAliasing("dynamic");t&&"MSAA"===n&&(n="NoAA"===s?i.currentUser.includes("SWYM")?"TAA":"SMAA":s),"TAA"===n&&"static"===e&&"TAA"!==s&&(n="MSAA"),r.antiAliasing!==n&&(r.renderer.setEffect(r.antiAliasing,!1),r.antiAliasing=n,r.renderer.setEffect(r.antiAliasing,!0))}}class o extends a{constructor(e,t){super(e,t),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing")}}return{Desktop:a,NoHDR:o,Mobile:class extends o{constructor(e,t){super(e,t),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("SSAO"),this._blackListedEffects.add("SSR"),this._blackListedEffects.add("SSRefraction"),this._blackListedEffects.delete("GroundShadows"),this._blackListedEffects.delete("InterObjectShadows"),this._blackListedEffects.delete("TransparentObjectShadows"),this._blackListedEffects.delete("GroundReflection"),this._blackListedEffects.delete("SSAO")}},None:class extends a{constructor(e,t){super(e,t),this._blackListedEffects.add("Bloom"),this._blackListedEffects.add("Transparency"),this._blackListedEffects.add("DepthOfField"),this._blackListedEffects.add("AntiAliasing"),this._blackListedEffects.add("GroundShadows"),this._blackListedEffects.add("InterObjectShadows"),this._blackListedEffects.add("TransparentObjectShadows"),this._blackListedEffects.add("GroundReflection"),this._blackListedEffects.add("SSAO"),this._blackListedEffects.add("SSR"),this._blackListedEffects.add("SSRefraction"),this._lqFallback=!0}}}}),define("DS/Visualization/PLMMaterialLoader",["DS/Visualization/PLMMaterialConnectionFactory"],function(e){"use strict";var t=function(){this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null,this.materialConnectionToPLMMaterialDataMap=new Map};return t.prototype.loadMaterials=function(e,t){var i,r,n=this.toLoadMaterialConnectionArray;for(i=0;i<e.length;i++)r=e[i],this.materialConnectionToPLMMaterialDataMap.set(r,t),r.isComplete()&&n.push(r);n.length>0&&null===this.token_toLoadMaterialConnectionArray&&(this.token_toLoadMaterialConnectionArray=setTimeout(this.loadMaterials_internal.bind(this),0))},t.prototype.getPathElementFromIdPath=function(t){var i,r,n=[];for(i=0;i<t.length;i++)r=e.loadAppearanceCB(t[i]),n.push(r);return new PathElement(n)},t.prototype.loadMaterials_internal=function(){var t;if(null!==this.token_toLoadMaterialConnectionArray){for(t=0;t<this.toLoadMaterialConnectionArray.length;t++)e.loadAppearanceCB(this.toLoadMaterialConnectionArray[t],this.onMaterialLoadedCB.bind(this),this.onMaterialErrorCB.bind(this));this.toLoadMaterialConnectionArray=[],this.token_toLoadMaterialConnectionArray=null}},t.prototype.onMaterialLoadedCB=function(e,t){this.materialConnectionToPLMMaterialDataMap.get(e)._applyMaterialApplication(e,t)},t.prototype.onMaterialErrorCB=function(e,t){},t}),define("DS/Visualization/Filters/GeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/VisuFilter"],function(e,t){"use strict";return class extends t{constructor(e){super(),this._geomType=e}}}),define("DS/Visualization/Filters/StaticGeomTypeFilter",["DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/GeomTypeFilter"],function(e,t){"use strict";return class extends t{constructor(e){throw super(e),"Unsupported class"}}}),define("DS/Visualization/PLMMaterialData",["DS/Visualization/StaticOverrideSet","DS/Visualization/PLMMaterialLoader"],function(e,t){"use strict";var i=new t,r=function(e){this._node=e,this._materialConnections=[],this._staticOverrideSet=null};return r.prototype._getStaticOverrideSet=function(){var t=this._staticOverrideSet;return null===t&&(t=new e(this._node),this._staticOverrideSet=t),t},r.prototype.addMaterialConnection=function(e){this._materialConnections.push(e),i.loadMaterials([e],this)},r.prototype._applyMaterialApplication=function(e,t){t=t.clone();var i=this._getStaticOverrideSet(),r=e.computeLayer(this);t._layer=r,i.addStaticOverride(e.pathElement,t),this._node._requestStaticOverridesUpdate()},r.prototype.getNbConnections=function(){return this._materialConnections.length},r}),define("DS/Visualization/TrapSelection",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/VisuEvents/TouchEvent"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){this.extremities={xPix:0,x:0,yPix:0,y:0},this.originPoint=null,this.isActive=!1,this.isInterrupted=!1,this.advancedSelection=!1,this.userTransformationCB=null,this.createCallbacks(),e&&(this.viewer=e),this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap);var t=this.viewer.currentViewpoint?this.viewer.currentViewpoint.getControl():null;this.mode=t?t._mode:1,this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown"};return o.prototype.set=function(e){switch(e){case!0:this.activate(!1);break;case"advanced":this.activate(!0);break;case!1:this.disable()}},o.prototype.setUserTransformation=function(e){this.userTransformationCB=e},o.prototype.updateMode=function(e,t){var i=this.viewer.picking.trapSelection;e.setSpinnerOnHold(!(0===this.mode||!i)),t!==this.mode&&(this.mode=t,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",i&&n.addEvent(this.viewer.canvas,this.downEvent,this.downCB))},o.prototype.setDiv=function(e){this.divTrap=e,this.divTrap.setStyles({position:"absolute",opacity:"0.8",pointerEvents:"none",border:"1px dashed black"}),this.divTrap.hide()},o.prototype.activate=function(e){this.downEvent=0===this.mode?"onLeftMouseDown":"onHoldLeftMouseDown",this.forwardSelect=null,this.advancedSelection=e,!this.divTrap&&this.viewer&&this.viewer.divTrap&&this.setDiv(this.viewer.divTrap),n.addEvent(this.viewer.canvas,this.downEvent,this.downCB),n.addEvent(this.viewer.canvas,"onHold",this.downCB),n.addEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.disable=function(){this.userTransformationCB=null,n.removeEvent(this.viewer.canvas,this.downEvent,this.downCB),n.removeEvent(this.viewer.canvas,"onHold",this.downCB),n.removeEvent(this.viewer.canvas,"onLongHold",this.interrupt)},o.prototype.getExtremities=function(){return this.extremities},o.prototype.setExtremities=function(e,t){if(t){var i,r={},n={},s=!0;if(e.xPix<t.xPix?(s=!0,r.xPix=e.xPix,r.x=e.x,n.xPix=t.xPix,n.x=t.x):(s=!1,r.xPix=t.xPix,r.x=t.x,n.xPix=e.xPix,n.x=e.x),e.yPix<t.yPix?(r.yPix=e.yPix,r.y=e.y,n.yPix=t.yPix,n.y=t.y):(r.yPix=t.yPix,r.y=t.y,n.yPix=e.yPix,n.y=e.y),this.extremities=r,this.extremities.pt=n,this.advancedSelection&&this.divTrap&&this.forwardSelect!==s)i=s?{border:"2px solid #f5c77e",backgroundColor:"rgba(245, 200, 125, 0.5)"}:{border:"2px dashed #75cdf0",backgroundColor:"rgba(117, 205, 240, 0.5)"},this.divTrap.setStyles(i),this.forwardSelect=s}else this.extremities=e},o.prototype.createCallbacks=function(){var e=this;this.interrupt=function(){e.softInterrupt(),e.viewer.setCursor("Auto")},this.softInterrupt=function(){e.isActive=!1,e.isInterrupted=!0,n.removeEvent(document,"onMouseMove",e.moveCB),n.removeEvent(document,"onLeftMouseUp",e.upCB),n.removeEvent(document,"onSwipe",e.moveCB),n.removeEvent(document,"onRelease",e.upCB),e.setExtremities({x:-1,y:-1})},this.downCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i)),e.originPoint=e.viewer.getMousePosition(i),e.setExtremities(e.originPoint),e.startTime=Date.now(),e.isActive=!0,e.isInterrupted||(e.viewer.setCursor("TrapSelection",100),n.addEvent(document,"onMouseMove",e.moveCB),n.addEvent(document,"onLeftMouseUp",e.upCB),n.addEvent(document,"onSwipe",e.moveCB),n.addEvent(document,"onRelease",e.upCB)),e.isInterrupted=!1},this.moveCB=function(t){var i=t.from[0].getCurrentPosition(e.viewer.canvas);e.userTransformationCB&&(i=e.userTransformationCB(i));var r=e.viewer.getMousePosition(i);e.setExtremities(e.originPoint,r);var n=e.viewer.devicePixelRatio;e.divTrap&&(e.divTrap.show(),e.divTrap.setStyles({width:(e.extremities.pt.xPix-e.extremities.xPix)/n,height:(e.extremities.pt.yPix-e.extremities.yPix)/n,left:e.extremities.xPix/n,top:e.extremities.yPix/n,pointerEvents:"none"}))},this.upCB=function(t){e.divTrap&&(e.divTrap.hide(),e.divTrap.setStyles({width:"0px",height:"0px",left:"0px",top:"0px",pointerEvents:"none"})),e.interrupt(),e.isInterrupted=!1}},o}),define("DS/Visualization/ScissorPolyLineData",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";function t(e){this.type="polyline",this.polyLines=[],this.lastFrameIndex=-1,this.lastCamera=null,this.texture=null,e&&this.polyLines.push(new r(e))}function r(t,r){for(this.nbPolygon=t.nbPolygon,this.nbVertices=t.nbVertices,this.vertices=t.vertices,this.point=t.point,this.dirX=t.dirX,this.dirY=t.dirY,this.matrix=r,this.points3D=[],this.clippedPoints3D=null,i=0;i<this.vertices.length;i+=2){var n=this.vertices[i],s=this.vertices[i+1],a=this.dirX,o=this.dirY,l=this.point,h=new e.Vector3(l.x+n*a.x+s*o.x,l.y+n*a.y+s*o.y,l.z+n*a.z+s*o.z);r&&h.applyMatrix4(r),this.points3D.push(h)}}return t.prototype.getNbVertices=function(){var e,t,i,r=[];for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r.push(i.nbVertices[t]);return r},t.prototype.getVerticesCount=function(){var e,t,i,r=0;for(e=0;e<this.polyLines.length;e++)for(i=this.polyLines[e],t=0;t<i.nbVertices.length;t++)r+=i.nbVertices[t];return r},t.prototype.getForOccurrenceOverride=function(e){if(e){var i,r,n=new t;for(i=0;i<this.polyLines.length;i++)r=this.polyLines[i].matrix||e,n.polyLines.push(this.polyLines[i].getForOccurrenceOverride(r));return n}return this},t.prototype.updateTexture=function(t,i){if(t===this.lastCamera&&this.lastFrameIndex===i&&this.texture)return;this.lastCamera=t,this.frameIndex=i;var r,n=0;let s=t instanceof e.PerspectiveCamera;for(r=0;r<this.polyLines.length;r++){let e=this.polyLines[r];e.clippedPoints3D=s?this.clipPoints(e.points3D,t):null,n+=e.clippedPoints3D?e.clippedPoints3D.length:e.points3D.length}var a=new Float32Array(4*n),o=new e.Matrix4;new e.Vector3;o.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var l,h=0;for(r=0;r<this.polyLines.length;r++){let e=(l=this.polyLines[r]).clippedPoints3D||l.points3D;l.fillBuffer(o,h,a,e),h+=4*e.length}var c=new e.DataTexture(a,n,1,e.RGBAFormat,e.FloatType,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);c.needsUpdate=!0,this.texture&&this.texture.dispose(),this.texture=c},t.prototype.getNbPolygon=function(){var e,t=0;for(e=0;e<this.polyLines.length;e++)t+=this.polyLines[e].nbPolygon;return t},t.prototype.clipPoints=function(t,i){let r,n=i.near,s=[],a=[],o=new e.Vector3,l=-1,h=i.position,c=i.getLookAt();for(r=0;r<t.length;r++){o.subVectors(t[r],h);let e=o.dot(c);a.push(e),e>=n&&l<0&&(l=r)}if(l<0)s=[t[0],t[0],t[0]];else{s=[t[l]];let i,d,u=!1,p=null,f=null;for(r=1;r<t.length;r++){i=(l+r)%t.length,d=(l+r-1)%t.length;let g=a[i]<n;g!==u&&(null===p&&(p=new e.Plane,o.set(h.x+n*c.x,h.y+n*c.y,h.z+n*c.z),p.setFromNormalAndCoplanarPoint(c,o),f=new e.Line3),f.set(t[i],t[d]),s.push(p.intersectLine(f))),g||s.push(t[i]),u=g}u&&(f.set(t[i],t[l]),s.push(p.intersectLine(f)))}return s},t.merge=function(e,i){var r=null;return e&&i&&"polyline"===e.type&&"polyline"===i.type?(r=new t(null)).polyLines=e.polyLines.concat(i.polyLines):r=e||i,r},r.prototype.getForOccurrenceOverride=function(e){return e?new r({nbPolygon:this.nbPolygon,nbVertices:this.nbVertices,vertices:this.vertices,point:this.point,dirX:this.dirX,dirY:this.dirY},e):this},r.prototype.fillBuffer=function(t,i,r,n){var s,a,o=new e.Vector4;let l=debugWebGLV6Viewer.currentViewpoint.getEyePosition(),h=debugWebGLV6Viewer.currentViewpoint.getSightDirection(),c=[];for(s=0;s<n.length;s++){a=n[s],o.set(a.x,a.y,a.z,1);let d=new e.Vector3;d.subVectors(o,l),c.push(d.dot(h)),o.applyMatrix4(t),r[i+4*s]=o.x/o.w,r[i+4*s+1]=o.y/o.w,r[i+4*s+2]=0,r[i+4*s+3]=1}},t}),define("DS/Visualization/ClippingContext",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ScissorPolyLineData","DS/Visualization/ClippingPolyLineData"],function(e,t,i,r,n){"use strict";var s=0,a=e.extend({init:function(e){this.id=s++,this.planes=e||[],this.planesParams=null,this.cylinder=null,this._localCylinder=null,this.excludeFromClippingPlanes=[],this.clippingSettings=null,this.sectionCappingMaterials=null,this.sectionLinesProperties=null,this._scissor=null,this._enableClippingProfile=0,this._clipPolyLine=null,this._uncut=!1,this._localCoordinates=!1,this._localPlanes=null,window.sealWebVisuObjects&&Object.seal(this)},setPlanes:function(e,t){var i;if(this.planes=e||[],this._planesParams=null,t)if(1===t.length&&"all"===t[0])this.planes=[];else for(i=this.planes.length-1;i>=0;i--)t.indexOf(this.planes[i])>=0&&this.planes.splice(i,1)},setExcludeFromClippingPlanes:function(e){this.excludeFromClippingPlanes=e||[]},setUncut:function(e){this._uncut=!!e},setFrontAndBackOpacity:function(e,t){this.clippingSettings=null===e||null===t?null:{frontOpacity:e,backOpacity:t}},getFrontOpacity:function(){return this.frontOpacity},getBackOpacity:function(){return this.backOpacity},setSectionCappingMaterial:function(e,t){this.sectionCappingMaterials||(this.sectionCappingMaterials=[],this.sectionCappingMaterials.defaultMaterial=null);var i=t||null;if(i){var r=0,n=-1;for(r=0;-1===n&&r<this.sectionCappingMaterials.length;r++)this.sectionCappingMaterials[r].clippingPlane===i&&(n=r);n>=0?this.sectionCappingMaterials[n].material=e:this.sectionCappingMaterials.push({clippingPlane:i,material:e})}else this.sectionCappingMaterials.defaultMaterial=e},setSectionLinesProperties:function(e){this.sectionLinesProperties=e?{color:void 0===e.color?null:e.color,width:e.width}:null},getSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){if(!e)return this.sectionCappingMaterials.defaultMaterial;var t;for(t=0;t<this.sectionCappingMaterials.length;t++)if(this.sectionCappingMaterials[t].clippingPlane===e)return this.sectionCappingMaterials[t].material}return null},removeSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},clone:function(){var e,t,i=new a(this.planes);if(i._planesParams=this._planesParams,i.cylinder=this.cylinder,i._scissor=this._scissor,i._clipPolyLine=this._clipPolyLine,i._enableClippingProfile=this._enableClippingProfile,i._uncut=this._uncut,i.excludeFromClippingPlanes=[].concat(this.excludeFromClippingPlanes),i._localCoordinates=this._localCoordinates,this._localPlanes){let e;for(i._localPlanes=[],e=0;e<this._localPlanes.length;e++)i._localPlanes.push(this._localPlanes[e].clone())}if(this.clippingSettings&&(i.clippingSettings={frontOpacity:this.clippingSettings.frontOpacity,backOpacity:this.clippingSettings.backOpacity}),this.sectionCappingMaterials)for(i.sectionCappingMaterials=[],i.sectionCappingMaterials.defaultMaterial=this.sectionCappingMaterials.defaultMaterial,e=0;e<this.sectionCappingMaterials.length;e++)t=this.sectionCappingMaterials[e],i.sectionCappingMaterials.push({clippingPlane:t.clippingPlane,material:t.material});return i.sectionLinesProperties=this.sectionLinesProperties,i},addPlane:function(e){return this.planes.indexOf(e)<0&&(this.planes.push(e),!0)},removePlane:function(e){var t=this.planes.indexOf(e);return t>=0&&(this.planes.splice(t,1),this._planesParams&&t<=this._planesParams.length-1&&this._planesParams.splice(t,1),!0)},isPointVisible:function(e){var t,i,r=this.clippingSettings&&this.clippingSettings.frontOpacity<.5;for(t=0;t<this.planes.length;t++)if(i=this.planes[t],this.excludeFromClippingPlanes.indexOf(i)<0&&i.distanceToPoint(e)<0)return!!r;return!r},setClippingProfile:function(e){this._clipPolyLine=e?new n(e):null},setEnableClippingProfile:function(e){this._enableClippingProfile="on"===e?1:"off"===e?-1:0},isClippingProfileEnabled:function(){return this._enableClippingProfile>=0},setScissorBox:function(e,t){this._scissor=e?{type:"box",data:new o(t)}:null},setScissorPolyLine:function(e,t){this._scissor=e?new r(t):null},_isCappingUsingPlaneMaterial:function(){let e,i=0;for(e=0;e<this.planes.length;e++){let r=this.getSectionCappingMaterial(this.planes[e]);r||(i=i<1?1:i),r instanceof t.HatchingMeshMaterial&&(r.autoSpaceColor||r.autoStripesColor)&&(i=i<2?2:i)}return i},_getScissorPolyLineSize:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getVerticesCount():0},_getScissorNbPolygons:function(){return this._scissor&&"polyline"===this._scissor.type?this._scissor.getNbPolygon():0},setScissorCircle:function(e,t){this._scissor=e?{type:"circle",x:t.x,y:t.y,radius:t.radius}:null},setPlaneParams:function(e,t){var i=this.planes.indexOf(e);i>=0&&(!this._planesParams&&t&&(this._planesParams=[]),this._planesParams&&(this._planesParams[i]=t?new l(t):null))},_setUseLocalCoordinates:function(){this._localCoordinates=!0},_mergeWithParent:function(e){if(!e)return this;var t=new a;t._enableClippingProfile=0!==this._enableClippingProfile?this._enableClippingProfile:e._enableClippingProfile,this._uncut||(t._clipPolyLine=n.merge(e._clipPolyLine,this._clipPolyLine)),t.cylinder=this._uncut?null:this.cylinder||e.cylinder,this._uncut||(t._scissor=r.merge(e._scissor,this._scissor));var i,s,o,l,h=[].concat(this.planes);if(!this._uncut)for(i=0;i<e.planes.length;i++)h.indexOf(e.planes[i])<0&&h.push(e.planes[i]);if(t.setPlanes(h,this.excludeFromClippingPlanes),this._planesParams||e._planesParams)for(i=0;i<h.length;i++)s=null,o=h[i],(l=this.planes.indexOf(o))>=0?s=this._getPlaneParams(l):(l=e.planes.indexOf(o))>=0&&(s=this._getPlaneParams(l)),this.setPlaneParams(o,s);t.clippingSettings=this.clippingSettings||e.clippingSettings;var c=null;if(this.sectionCappingMaterials&&e.sectionCappingMaterials){(c=[].concat(this.sectionCappingMaterials||[])).defaultMaterials=this.sectionCappingMaterials.defaultMaterial||e.sectionCappingMaterials.defaultMaterial;var d,u,p=e.sectionCappingMaterials||[];for(i=0;i<p.length;i++){for(u=!1,d=0;d<c.length&&!u;d++)c[d].clippingPlane===p[i].clippingPlane&&(u=!0);u||c.push(p[i])}}else c=this.sectionCappingMaterials||e.sectionCappingMaterials;return t.sectionCappingMaterials=c,t},_getPlaneParams:function(e){return this._planesParams&&this._planesParams[e]||null},_getPlaneParamsFromPlane:function(e){if(this._planesParams){var t=this.planes.indexOf(e);if(t>=0)return this._planesParams[t]||null;console.warn("unknown plane!")}return null},_hasPlaneCapping:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.capping},_hasPlaneSectionLine:function(e){var t=this._getPlaneParamsFromPlane(e);return!t||t.sectionLines},_getSectionLinesArray:function(){if(this._planesParams){var e,t=[];for(e=0;e<this.planes.length;e++)!this._planesParams[e]||this._planesParams[e].sectionLines?t.push(!0):t.push(!1);return t}return null},_updatePosition:function(e){if(this._localCoordinates){var t;if(!this._localPlanes)for(this._localPlanes=[],t=0;t<this.planes.length;t++)this._localPlanes[t]=this.planes[t].clone();for(t=0;t<this.planes.length;t++)this.planes[t].copy(this._localPlanes[t]),e&&(this.planes[t].applyMatrix4(e),this.planes[t].normalize());if(this.cylinder){this._localCylinder||(this._localCylinder=this.cylinder);let t=this._localCylinder;this.cylinder={center:t.center.clone(),axisU:t.axisU.clone(),axisV:t.axisV.clone(),clipOutside:t.clipOutside},e&&(this.cylinder.center.applyMatrix4(e),this.cylinder.axisU.applyRotation(e),this.cylinder.axisV.applyRotation(e))}}},dbgDumpClippingContext:function(){return{planes:this.planes,excludeFromClippingPlanes:this.excludeFromClippingPlanes,clipPolyLine:this._clipPolyLine?this._clipPolyLine.dbgDump():null,enableClippingProfile:this._enableClippingProfile}},setAntiPlanes:function(){this.setExcludeFromClippingPlanes.apply(this,arguments)},_getInvertStatus:function(){return this.clippingSettings?this.clippingSettings.frontOpacity<.5&&this.clippingSettings.backOpacity>=.5?-1:0:1},_isBoundingSphereVisible:function(e,i,r){let n,s=!0,o=!1,l=this._getInvertStatus();if(0===l||0===this.planes.length||!e||!i)return!0;null===a.tmpSphere&&(a.tmpSphere=new t.Sphere);let h=a.tmpSphere;for(h.copy(e),h.applyMatrix4(i),n=0;n<this.planes.length;n++){let e=this.planes[n].distanceToPoint(h.center);Math.abs(e)<h.radius&&(o=!0),e<0&&(s=!1)}return-1===l&&(s=!s),r?o:s||o}});function o(e){this.box=new t.Box3(new t.Vector3(e.box.min.x,e.box.min.y,0),new t.Vector3(e.box.max.x,e.box.max.y,0)),this.clipX=0,this.clipY=0,this.clipWidth=0,this.clipHeight=0,this.frame=-1}function l(e){this.capping=void 0===e.capping||!!e.capping,this.sectionLines=void 0===e.sectionLines||!!e.sectionLines}return a.tmpSphere=null,o.prototype.projectPoint=function(e,t,i,r,n){var s=i.clone();return e.projectVector(s,t),s.x=.5*r*(s.x+1),s.y=.5*n*(s.y+1),s},o.prototype.updateClipRect=function(e,i,r,n){if(i!==this.frame){this.frame=i;var s=new t.Projector,a=this.projectPoint(s,e,this.box.min,r,n),o=this.projectPoint(s,e,this.box.max,r,n);this.clipX0=Math.round(a.x),this.clipY0=Math.round(o.y),this.clipX1=Math.round(o.x),this.clipY1=Math.round(a.y)}},a}),define("DS/Visualization/Node3D",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/OccurrencePath","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/Visualization/OccurrenceRenderingOverride","DS/Visualization/SessionNodesWithSectionProfile","DS/Visualization/ClippingContext","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/MaterialApplication","DS/Visualization/PLMMaterialData","DS/Visualization/KDTree","DS/Visualization/ClippingPolyLineData","DS/Visualization/Filters/VisuFilter","DS/Visualization/Filters/FilteredFilter","DS/Visualization/Filters/PlaneViewModeFilter"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_){"use strict";var y=i.NoOccurrences,S=5,x=0,b=new i.Matrix4,w=i.__visibleInCurrentSpace;const M=i._VisuFilterType;var C=function(e,t){return this.node=void 0!==e?e:null,this.parent=null,this.depth=0,this.children=[],this.occBooleanAttr=0,this.matrix=null,this.material=null,this.matApp=null,this.matAppOverride=null,this.gas=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setDepthMode(!0),this._setAdvancedPriority(!1),this._setPickable(!0),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this.setNoPickThrough(!0),this.scene3js=void 0!==t?t:null,this.renderable=null,this.renderMode=null,this.layerFilter=null,this.faceMode=null,this._setNeedBEUpdate(!0),this.passes=null,this.next=null,this.prev=null,this.forcePasses=null,this.forceGAS=null,this.pickingPriorityID=null,this.clippingContext=null,this.__rdo_visited=0,this._filters=null,this.__overrideData=null,this._manipulators={},this._setNeedOverridesUpdate(!1),this._setDescendantNeedsOverridesUpdate(!1),this._substituteMaterials=null,this.__solvedSubstituteMaterials=null,this._instancingInfos=null,this},P=function(){this.renderPriority=null,this.localMatrixOverride=null,this._relativeMatrix=null,this._relativeVisibility=null,this._bsShow=void 0,this._bsNoShow=void 0,this._bbShow=void 0,this._bbNoShow=void 0,this.occurrenceRenderingOverride=null,this.originalOverrideSet=null,this.overrideLink=null};Object.defineProperty(C.prototype,"renderPriority",{get:function(){return this.__overrideData?this.__overrideData.renderPriority:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.renderPriority=e)}}),Object.defineProperty(C.prototype,"occurrenceRenderingOverride",{get:function(){return this.__overrideData?this.__overrideData.occurrenceRenderingOverride:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.occurrenceRenderingOverride=e)}}),Object.defineProperty(C.prototype,"originalOverrideSet",{get:function(){return this.__overrideData?this.__overrideData.originalOverrideSet:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.originalOverrideSet=e)}}),Object.defineProperty(C.prototype,"overrideLink",{get:function(){return this.__overrideData?this.__overrideData.overrideLink:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.overrideLink=e)}}),Object.defineProperty(C.prototype,"localMatrixOverride",{get:function(){return this.__overrideData?this.__overrideData.localMatrixOverride:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData.localMatrixOverride=e)}}),Object.defineProperty(C.prototype,"_relativeMatrix",{get:function(){return this.__overrideData?this.__overrideData._relativeMatrix:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._relativeMatrix=e)}}),Object.defineProperty(C.prototype,"_relativeVisibility",{get:function(){return this.__overrideData?this.__overrideData._relativeVisibility:null},set:function(e){null===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._relativeVisibility=e)}}),Object.defineProperty(C.prototype,"_bsShow",{get:function(){return this.__overrideData?this.__overrideData._bsShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bsShow=e)}}),Object.defineProperty(C.prototype,"_bsNoShow",{get:function(){return this.__overrideData?this.__overrideData._bsNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bsNoShow=e)}}),Object.defineProperty(C.prototype,"_bbShow",{get:function(){return this.__overrideData?this.__overrideData._bbShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bbShow=e)}}),Object.defineProperty(C.prototype,"_bbNoShow",{get:function(){return this.__overrideData?this.__overrideData._bbNoShow:void 0},set:function(e){void 0===e&&null===this.__overrideData||(this._createOverrideData(),this.__overrideData._bbNoShow=e)}}),C.prototype._createOverrideData=function(){this.__overrideData||(this.__overrideData=new P)},C.prototype._getMaterialApplication=function(){return this.matAppOverride?this.matAppOverride:this.node._getMaterialApplication()},C.prototype._getFilter=function(e){return this._filters?this._filters.get(e):null},C.prototype._isFurtiveFiltered=function(){let e=this._getFilter(M.FURTIVE);return!!(e&&e.state&&this.isFurtive())},C.prototype._getShadow=function(){var e=null,t=null;if(this.renderable&&this._filters&&this._filters.has(M.LOOK)){var i=this._filters.get(M.LOOK);1===i.shadowReceive?e=!0:0===i.shadowReceive&&(e=!1),1===i.shadowCast?t=!0:0===i.shadowCast&&(t=!1)}return[t,e]},C.prototype._addSubstituteMaterial=function(e,t){this._substituteMaterials||(this._substituteMaterials=new Map),this._substituteMaterials.set(e,t),this.parent&&this.parent.node._updateOccurrences(this.parent,this,!1,!0,!1)},C.prototype._removeSubstituteMaterial=function(e){this._substituteMaterials&&(this._substituteMaterials.delete(e),0===this._substituteMaterials.size&&(this._substituteMaterials=null),this.parent&&this.parent.node._updateOccurrences(this.parent,this,!1,!0,!1))},C.prototype._propagateSubstituteMaterials=function(e){if(this.__solvedSubstituteMaterials=null,e||this._substituteMaterials){var t=new Map;this._substituteMaterials&&this._substituteMaterials.forEach((e,i,r)=>t.set(i,e)),e&&e.forEach((e,i,r)=>t.set(i,e)),t.size>0&&(this.__solvedSubstituteMaterials=t)}},C.prototype.updateMatrix=function(e,t){t?e?this.localMatrixOverride?this.localMatrixOverride.copy(e):this.localMatrixOverride=e.clone():this.localMatrixOverride.identity():this.localMatrixOverride=null;var r=this.parent;if(this.node._isDecal&&this.node._decalAttachedTo.size>0&&r){for(var n=r;n&&!this.node._decalAttachedTo.has(n.node);)n=n.parent;n?r=n:console.warn("Inconsistent decal attachement, the attachement is not a parent of the application, the decal is attached to its application")}r?e&&!e.isIdentity()?r.matrix?r.matrix.isIdentity()||r.node._instancingInfos?this.matrix=e.clone():(this.matrix=new i.Matrix4,this.matrix.multiplyMatrices(r.matrix,e)):this.matrix=e.clone():!r.matrix||r.matrix.isIdentity()||r.node._instancingInfos?this.matrix=b:this.matrix=r.matrix:e&&!e.isIdentity()?this.matrix=e.clone():this.matrix=b},C.prototype.getViewer=function(){return this.scene3js&&this.scene3js.viewer},C.prototype.getLocalMatrix=function(){return this.localMatrixOverride||this.node._matrix||b},C.prototype.requestOverridesUpdate=function(){for(var e=this.parent;e&&!e._getDescendantNeedsOverridesUpdate();)e._setDescendantNeedsOverridesUpdate(!0),e=e.parent;this.traverseWithCondition(function(e){return e._getNeedOverridesUpdate()?null:(e.parent&&e.parent._setDescendantNeedsOverridesUpdate(!0),e._setNeedOverridesUpdate(!0),!0)})},C.prototype.doesADescendantNeedOverrideUpdate=function(){return this._getDescendantNeedsOverridesUpdate()},C.prototype.isOverridesUpdateRequested=function(){return this._getNeedOverridesUpdate()},C.prototype.clearOverridesUpdateRequest=function(){this.traverseWithCondition(function(e){var t=!!e._getDescendantNeedsOverridesUpdate()||null;return e._setNeedOverridesUpdate(!1),e._setDescendantNeedsOverridesUpdate(!1),t})},C.prototype.updateOverrideStatus=function(e){if(e?this.traverse(function(e){!function(e){var t=e.originalOverrideSet;t&&t.lib&&(t.lib.length=0);var i=null,r=null;e.parent&&(i=e.parent.overrideLink,r=e.parent.originalOverrideSet),i&&i.lib&&(i.lib.length=0);var n,s=e.overrideLink,a=t||i;s||a&&(n=t&&t.visibilityFix||i&&i.visibilityFix,s=a.createOverrideLink(n),e.overrideLink=s),s&&s.combine(t,i,r)}(e)}):this.traverse(function(e){e.overrideLink&&e.overrideLink.reset()}),this.parent)this.parent.node._updateOccurrences(this.parent,this,!1);else{var t=this.children,i=0;for(i=0;i<t.length;i++)this.node._updateOccurrences(this,t[i],!e)}},C.prototype._tryOverridesUpdateWithAncestors=function(e){if(this._needOverridesUpdate||this._descendantNeedsOverridesUpdate){for(var t=this;t.parent;)t=t.parent;t.node._tryOverridesUpdate(e||this.scene3js&&this.scene3js.viewer)}},C.prototype._compactChildrenArray=function(e){var t=this.children;this.children=new Array(t.length);for(var i=0;i<t.length;i++)this.children[i]=t[i];this.renderable&&this.renderable._compactArrays&&this.renderable._compactArrays(e)},C.prototype.lightCopy=function(){var e,t=this.node,i=new C(t,this.scene3js);if(null!==this.renderable&&((e=t.createRenderable()).name=t.name,e._occurrence=i,i.renderable=e,t._occurrences[0]&&t._occurrences[0]._manipulators)){var r,n=t._occurrences[0]._manipulators;for(r in n){var s=n[r];i._manipulators||(i._manipulators={}),i._manipulators[r]=s}}return i},C.prototype.traverse=function(e,t){var i,r,n=this.children.length;for(r=e(this,t),i=0;i<n;i++)this.children[i].traverse(e,r)},C.prototype.traverseWithCondition=function(e,t){var i,r,n=this.children.length;if(r=e(this,t))for(i=0;i<n;i++)this.children[i].traverseWithCondition(e,r)},C.prototype._getRenderableOccurrences=function(e){var t,i,r,n,s,a;for(t=[],i=this.children,null!==this.renderable&&t.push(this.renderable),n=0;n<i.length;n++)if(a=i[n],!e||!a.node.getExcludeFromBounding())for(r=a._getRenderableOccurrences(),s=0;s<r.length;s++)t.push(r[s]);return t},C.prototype.getBoundingSphere=function(e,t){var i=this._getBoundingSphere(e,t);return i?i.clone():null},C.prototype.getBoundingBox=function(e){return this._getBoundingBox(e)},C.prototype._getRenderModes=function(){var e=this.scene3js&&this.scene3js.viewer;return e&&null!==this.renderable?e.renderer.renderer.getRenderMode(this.renderable)._maskWithDefault:0},C.prototype._getAccurateRenderableOccurrences=function(e,t,r,n){var s=n||this.node.getRatio()>0;if(r.fixedSizeNodesStatus===i.FixedSizeFiltering.Exclude&&s)return e;if(!t||!this.node._isDecal&&!this.node.getExcludeFromBounding()){var a=this.children,o=r.mask||0;if(null!==this.renderable&&this.renderable.geometry){var l=this.renderable;if(!l.filtered&&w(l.visible,l.visibilityFree,r.space,l.layer,this)){var h=[],c=this._getRenderModes(),d=this._getFilter(M._STATIC_GEOM_TYPE)||this._getFilter(M.GEOM_TYPE);if(l.layer){var u=l.layer.layers;for(m=0;m<u.length;m++){var p=u[m];p.drawableInterval.skip(l,r.space)||(p.drawableGroup.isFiltered(c&~o,d?d._geomType:0)||h.push(p))}}else for(var f=0;f<l.geometry.length;f++)for(var g=l.geometry[f],m=0;m<g.drawingGroups.length;m++){var v=g.drawingGroups[m];v.isFiltered(c&~o,d?d._geomType:0)||h.push(v)}if(h.length>0){var _=new i.Matrix4;null!==r.handleMatrix?_.multiplyMatrices((new i.Matrix4).getInverse(r.handleMatrix),l._getMMMatrix()):_=l._getMMMatrix();var y=r.fixedSizeNodesStatus===i.FixedSizeFiltering.CenterOnly&&s?new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0)):l.boundingBox.clone(),S=new i.DGBoundingBoxArray({fastBBox:y.applyMatrix4(_),matrix:_,renderable:l});S.setDGs(h),e.push(S)}}}for(f=0;f<a.length;f++)a[f]._getAccurateRenderableOccurrences(e,t,r,s);return e}},C.prototype._isFixedSize=function(){for(var e=!1,t=this;null!=t&&(e=e||t.node.getRatio()>0,t=t.parent,!e););return e},C.prototype.computeAccurateBoundingBox=function(e,t,r,n){var s="visibleSpace"===e,a=[],o=this._isFixedSize();this._getAccurateRenderableOccurrences(a,!0,{space:s,handleMatrix:t,fixedSizeNodesStatus:r||i.FixedSizeFiltering.Include,mask:n||0},o);for(var l=[],h=a.length-1;h>=0;h--)a[h].renderable.geometry[0].vertexPositionArray||(l.push(a[h]),a.splice(h,1));var c=new i.Box3;if(c.fromDGBoundingBoxArray(a),l.length){var d=this.getViewer();c.union(d.renderer.boundingBoxGPUCompute.computeBoundingBoxGPU(d,l,t))}return c},C.prototype.needsBoundingElement=function(){var e,t=this.children.length;for(e=0;e<t;e++){var i=this.children[e];if(i.localMatrixOverride||void 0!==i._bsShow||void 0!==i._bsNoShow||void 0!==i._bbShow||void 0!==i._bbNoShow||i.overrideLink&&i.overrideLink.hasVisibilityOverride())return!0}return!1},C.prototype._isFiltered=function(){if(this.layerFilter&&this.node._layer<this.layerFilter.length&&!this.layerFilter[this.node._layer])return!0;let e=this._getFilter(M.FILTERED);return!!e&&e.state},C.prototype._getBoundingSphere=function(e,t){e=e||"visibleSpace",this._updateBoundingElements();var r=null,n=void 0!==this._bsShow?this._bsShow:this.node._bsShow,s=void 0!==this._bsNoShow?this._bsNoShow:this.node._bsNoShow;return(r=this._getVisibilityFree()?this._getVisible()?n:null:this._getVisible()?"visibleSpace"===e?n:s:"visibleSpace"===e?null:i.mergeBoundingSphereInto(n&&n.clone(),s,this.node.getRatio()))||t||(r=new i.Sphere),r},C.prototype._getBoundingBox=function(e){e=e||"visibleSpace",this._updateBoundingElements();var t=null,r=void 0!==this._bbShow?this._bbShow:this.node._bbShow,n=void 0!==this._bbNoShow?this._bbNoShow:this.node._bbNoShow;return(t=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingBoxInto(r&&r.clone(),n))||(t=new i.Box3),t},C.prototype.updateVisibilityFlag=function(){this._invalidateBoundingElements(!1)},C.prototype.updateVisibilityFreeFlag=function(){this._invalidateBoundingElements(!1)},C.prototype._invalidateBoundingElements=function(e){this._getNeedBEUpdate()||(this._setNeedBEUpdate(!0),!this.parent||this.node.getExcludeFromBounding()&&!e||this.parent._invalidateBoundingElements(!1))},C.prototype._updateBoundingElements=function(e,t){if(e||this.node._updateBoundingElements(),this._getNeedBEUpdate()){if(!this.node._getForceBoundingElements()){t=this.node._updateShadowMapsIfNeeded(t);var r=0;for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this._updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"explicitBSphere"),this._updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"explicitBBox")}if(this.node.getExcludeFromBounding()){let e=this._getSceneGraph();e&&e.addBEExcludedNode(this.node)}this._setNeedBEUpdate(!1),this.parent||this.scene3js&&(this.scene3js.boundingSphere=this._getBoundingSphere("visibleSpace").clone(),this.scene3js.boundingSphere.radius=100,this.scene3js.boundingBox=this._getBoundingBox("visibleSpace").clone())}},C.prototype._updateBoundingElements_internal=function(e,t,i,r){if(!this.node._getForceBoundingElements())if(this.needsBoundingElement()){var n=null,s=null;if(this.children.length){var a,o,l,h,c=0;for(c=0;c<this.children.length;c++)(a=this.children[c]).node.getExcludeFromBounding()||(o=void 0!==a[e]?a[e]:a.node[e],l=void 0!==a[t]?a[t]:a.node[t],h=a.localMatrixOverride||a.node._matrix,a._getVisibilityFree()?(a._getVisible()||a.needsBoundingElement()&&!a.isMesh())&&(n=i(n,o,h,a.node.getRatio()),s=i(s,o,h,a.node.getRatio())):a._getVisible()||a.needsBoundingElement()&&!a.isMesh()?(n=i(n,o,h,a.node.getRatio()),s=i(s,l,h,a.node.getRatio())):(s=i(s,o,h,a.node.getRatio()),s=i(s,l,h,a.node.getRatio())))}if(n=this.node._modifyBE(n,i),s=this.node._modifyBE(s,i),this.node.getHasExplicitBE()){var d=void 0!==this[e]?this[e]:this.node[r];n=n&&d?i(n,d,null,0):d}this[e]=n,this[t]=s}else this[e]=void 0,this[t]=void 0},C.prototype._getViewpoint=function(){return this.scene3js&&this.scene3js.viewer?this.scene3js.viewer._viewpointManager.getViewpointFromRoot3js(this.scene3js):null},C.prototype._getSceneGraph=function(){if(this.scene3js&&this.scene3js.viewer){let e=this.scene3js.viewer._viewpointManager.getViewpointFromRoot3js(this.scene3js);return this.scene3js.viewer._viewpointManager.getViewpointScenegraph(e)}return null},C.prototype.isInCanvas2DPass=function(){var e=this.passes;return!!(e&&e.indexOf("canvas2D")>=0)},C.prototype.isInNozPass=function(){var e=this.passes;return!!(e&&e.indexOf("noz")>=0)||(!!(e&&e.indexOf("NoZ")>=0)||(!!(e&&e.indexOf("Noz")>=0)||(!!(e&&e.indexOf("robot")>=0)||(!!(e&&e.indexOf("canvas2D")>=0)||!!(e&&e.indexOf("-noPoliteHL")>=0)))))},C.prototype.isFurtive=function(){var e=this.passes;return!!(e&&e.indexOf("furtive")>=0)},C.prototype.isMesh=function(){return this.node._isMesh3D};var E=e.extend({init:function(e,t){if(this.id=x,x++,this.node3DBooleanAttr=0,this.node3DBooleanAttr2=0,this.modelIdentification=null,this.name=void 0!==e?e:"",this.parents=[],this.children=[],this.setLinkedToSceneGraph(!1),this._bsShow=null,this._bsNoShow=null,this._bbShow=null,this._bbNoShow=null,this._setForceBoundingElements(!1),this.setIsInBackground(!0),this._setIsAlwaysInForeground(!1),this._matrix=null,this.setExcludeFromBounding(!1),this.userData=null,this._setNeedBEUpdate(!0),this._material=null,this._matApp=null,this._gas=window.newMaterialInheritance?i._NREGASOnNodeInit?new i.GraphicAttributeSet({NREInit:!0}):new i.GraphicAttributeSet({NREInit:!0,type:i.GASTypeEnum._SKIN}):null,this._filters=null,this._setVisible(!0),this._setVisibilityFree(!1),this._setPickable(!0),this.setNoPickThrough(!0),this.setPrimitivePicking(!0),this._occurrences=[],!y||t){var r=new C(this,this.scene3js);this._occurrences.push(r)}return this._setPickParent(!1),this.__setTreeModified(!1),this.passes=null,this.clippingContext=null,this._renderMode=null,this._pickingMode=null,this._layer=0,this._layerFilter=null,this._depthMode=!1,this._depthPriority=0,this._priority=4,this.setNotAllowedInPathElement(!1),this.modelEvents=void 0,this.productType="",this.persistentId=0,this._setVisibilityInTree(!0),this._iconInTree="",this.pickingPriorityID=null,this.clipPolyLine=null,this.setIsManipulator(!1),this._PLMMaterialData=null,this._setExcludeFromCSO(!1),this._setExcludeFromHSO(!1),this._setExcludeFromPSO(!1),this._setExcludeFromHL(!1),this._setExcludeFromPreHL(!1),this._setPropagateXSOExclusion(!1),this._setForbidHierarchyUpdate(!1),this.decalCount=0,this._overrideSetManager=null,this},_linkingClone:function(e){return(e=e||new E(this.name)).node3DBooleanAttr=this.node3DBooleanAttr,e.node3DBooleanAttr2=this.node3DBooleanAttr2,e._matrix=this._matrix,e._setNeedBEUpdate(!0),e._material=this._material,e._matApp=this._matApp,e._gas=this._gas,this._filters&&(e._filters=new Map,this._filters.forEach((t,i,r)=>e._filters.set(i,t))),e.passes=this.passes,e.clippingContext=this.clippingContext,e._renderMode=this._renderMode,e._pickingMode=this._pickingMode,e._layer=this._layer,e._layerFilter=this._layerFilter,e._depthPriority=this._depthPriority,e._priority=this._priority,e.modelEvents=this.modelEvents,e.productType=this.productType,e.persistentId=this.persistentId,e._iconInTree=this._iconInTree,e.pickingPriorityID=this.pickingPriorityID,e.clipPolyLine=this.clipPolyLine,e._PLMMaterialData=this._PLMMaterialData,e._overrideSetManager=this._overrideSetManager,e},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var s=n[r];this._occurrences[r]=s,s._compactChildrenArray(t)}var a=this.children;this.children=new Array(a.length);for(r=0;r<a.length;r++){var o=a[r];this.children[r]=o,o._compactHierarchy(e,t)}}},_getPickingCameraName:function(){var e=this._occurrences[0].passes;if(e&&1===e.length){if("robot"===e[0])return"connectedRobotCamera";if("robotOrtho"===e[0])return"robotCameraOrtho"}return""},_setTreeModified:function(){if(!this._getTreeModified()){this.__setTreeModified(!0);var e=0;for(e=0;e<this.parents.length;e++)this.parents[e]._setTreeModified()}},getModelIdentification:function(){return this.modelIdentification},setModelIdentification:function(e){this.modelIdentification=e},getIdentificationObject:function(){return this.modelIdentification},setIdentificationObject:function(e){this.modelIdentification=e},setNodeUsage:function(e){this.persistentId=e},getNodeUsage:function(){return this.persistentId},isOOCPLMNode:function(){var e=this.getNodeUsage();return null!==this.modelIdentification&&void 0!==this.modelIdentification&&e!==E.TILESET_NODE},isOOCRepReference:function(){return this.getNodeUsage()===E.REPRESENTATION_NODE},isOOCReference:function(){return this.getNodeUsage()===E.REFERENCE_NODE},isOOCInstance:function(){return this.getNodeUsage()===E.INSTANCE_NODE&&!this.isOOCRepInstance()},isOOCRepInstance:function(){var e;if(this.getNodeUsage()===E.INSTANCE_NODE)for(e=0;e<this.children.length;e++)if(this.children[e].isOOCRepReference())return!0;return!1},isOOCTileSetNode:function(){return this.getNodeUsage()===E.TILESET_NODE},addChild:function(e){try{return this._addChild(e)}catch(e){throw e}},insertChildAtIndex:function(e,t){if(null!=t&&(t<0||t>this.children.length))return console.log("Index isn't in the right range. Node will be inserted at the end"),this._addChild(e);try{return this._addChild(e,t)}catch(e){throw e}},_addChild:function(e,r){if(!e)return!1;if(T>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate())return!1;var n,s,a,o;if(this._setTreeModified(),e instanceof i.Object3D&&console.warn("THREE.Object3D can not be a child of Node3D. This is probably due to a migration problem."),-1!==(e.parents.length<this.children.length?e.parents.indexOf(this):this.children.indexOf(e)))return!1;e._invalidateBoundingElements(!1,!1),r||0===r?this.children.splice(r,0,e):this.children.push(e),e.parents.push(this),e._isDecal&&this.decalCount++;var l=null,h=this;if(e.traverse(function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(l||(l=h._getAllOwningViewers()),t=0;t<l.length;t++){for(i=0;i<r.length;i++)l[t]._addClippingPlane(r[i]);l[t]._requestClippingUpdate()}}),n=this._occurrences.length,s=e._occurrences.length,!n||!s)return!1;var c=!1;for((e._getOverrideExists()||this._getOverrideExists())&&(this._setOverrideExistsTraverse(),c=!0),e._getOverrideSetManagerUnder()&&this._setOverrideSetManagerUnder(),p=0;p<n;p++){if(a=this._occurrences[p],o=e._occurrences[0],a&&a.originalOverrideSet&&a.originalOverrideSet.onAddChild){var d=a.scene3js&&a.scene3js.viewer;a.originalOverrideSet.onAddChild(d)}(s>1||null!==o.parent)&&(o=this._copyTree(o));let t=null,i=a.scene3js;i&&i.isSGOrdered()&&(r||0===r?r>0&&(t=a.children[r-1]._getLastRenderableOcc()):t=a._getLastRenderableOcc(),t||(t=a._getPreviousRenderableOcc()),t||(t={next:a._getNextRenderableOcc()})),r||0===r?a.children.splice(r,0,o):a.children.push(o),o.parent=a,this._updateOccurrences(a,o,!0,null,null,t),c&&o.requestOverridesUpdate()}this._getNeedBEUpdate()||e._areBoundingElementsIncludedInParent(this)||this._invalidateBoundingElements(!1,!1),e.traverseUnique(function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()}),this.onLinkToSceneGraph(e);for(var u={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"ADD",fromNode:this,toNode:e},p=(l=this._getAllOwningViewers(),0);p<l.length;p++)i.DecalManager.updateDecalsData(l[p],!1);return t.publish({event:"/VISU/onSceneGraphUpdate",data:u}),!0},removeChild:function(e){if(!e)return!1;if(T>0)throw new Error("Attempt to modify locked node hierarchy.");if(this._getForbidHierarchyUpdate()||e._getForbidHierarchyUpdate&&e._getForbidHierarchyUpdate())return!1;var r,n,s,a,o,l,h;if(this._setTreeModified(),-1===(r=this.children.indexOf(e)))return!1;if(this.children.splice(r,1),-1===(n=e.parents.indexOf(this)))return!1;e.parents.splice(n,1),e._isDecal&&this.decalCount--,this.onLinkToSceneGraph(e);var c=this._getAllOwningViewers();if(e.traverse(function(e){var t,i,r=e.clippingContext&&e.clippingContext.planes;if(r)for(t=0;t<c.length;t++){for(i=0;i<r.length;i++)c[t]._removeClippingPlane(r[i]);c[t]._requestClippingUpdate()}}),s=this._occurrences.length,a=e._occurrences.length,!s||!a)return!1;for(p=0;p<s;p++)if(o=this._occurrences[p],a=e._occurrences.length,l=e._occurrences[0],1===a){-1!==(r=o.children.indexOf(l))&&o.children.splice(r,1),l.parent=null;let t=o.scene3js;t&&t.isSGOrdered()&&l._unlinkRenderableOccs(),l.material=e._material,e._matrix?l.matrix=e._matrix.clone():l.matrix=null,null!==l.renderable&&(l.renderable.setMatrix(l.matrix,!1),"Mesh3D"===l.node.getNodeType()||"ParticlesNode3D"===l.node.getNodeType()?(null!==l.material&&(l.renderable.material=l.material),null!==l.matApp&&(l.renderable.matApp=l.matApp),null!==l.gas&&(l.renderable.gas=l.gas),null!==l.scene3js&&l.scene3js.containsObject(l.renderable)&&(this._removeFromVisuSelection(l.renderable),l.scene3js.remove(l.renderable),"Mesh3D"===l.node.getNodeType()&&l.renderable.releaseVBO(!1))):"LightNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLight(l.renderable)&&l.scene3js.remove(l.renderable):"LensFlareNode3D"===l.node.getNodeType()?null!==l.scene3js&&l.scene3js.containsLensFlare(l.renderable)&&l.scene3js.remove(l.renderable):"CSS2DNode"!==l.node.getNodeType()&&"CSS3DNode"!==l.node.getNodeType()||(l.renderable.element.parentNode&&l.renderable.element.parentNode.removeChild(l.renderable.element),null!==l.scene3js&&l.scene3js.remove(l.renderable)));var d=l.scene3js&&l.scene3js.viewer;for(d&&2===d._sceneGraphStateVersion&&l.traverse(function(e){e.originalOverrideSet&&(e.originalOverrideSet.onDetach(d,e),e.originalOverrideSet=null),e.overrideLink=null}),l.scene3js=null,h=0;h<l.children.length;h++)this._updateOccurrences(l,l.children[h],!0)}else{for(h=0;h<o.children.length&&(l=o.children[h]).node!==e;h++);o.children.splice(h,1),l._unlinkRenderableOccs(),this._deleteTree(l)}this._removeInvalidElementsInXSO(e),e.getExcludeFromBounding()||this._invalidateBoundingElements(!1,!1),e.traverseUnique(function(e){e._getStaticOverrideSet()&&e._requestStaticOverridesUpdate()});for(var u={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"REMOVE",fromNode:this,toNode:e},p=0;p<c.length;p++)i.DecalManager.updateDecalsData(c[p],!0);return t.publish({event:"/VISU/onSceneGraphUpdate",data:u}),e._cleanTemp(),!0},_cleanTemp:function(){},removeChildren:function(){if(this._getForbidHierarchyUpdate())return!1;for(;this.children.length;)this.removeChild(this.children[0],!1);return this._invalidateBoundingElements(!1,!1),!0},traverse:function(e,t,i){var r,n,s=!1;s=e(this,t);var a=i?this.parents:this.children;if(n=a.length,!s)for(r=0;r<n&&!(s=a[r].traverse(e,t,i));r++);return s},traverseUnique:function(e,t,i,r){if(!y){var n=new Set;this._traverse_internal(e,t,i,r,n);var s=[];return n.forEach(e=>{s.push(e)}),s}},_traverse_internal:function(e,t,i,r,n){if(!y&&!n.has(this)){n.add(this);var s,a,o;o=e(this,t);var l=i?this.parents:this.children;if(a=l.length,!o)for(s=0;s<a;s++)l[s]._traverse_internal(e,t,i,r,n)}},getChildrenByName:function(e,t){var i={root:this,nodes:[]};return this.traverse(function(t,i){return t.name===e&&i.nodes.push(t),!1},i,t),i.nodes},_forceGeomType:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._forceGeomType(e)},_setRatio:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setRatio(e)},_setFixedSizeCameraName:function(e){for(var t=0;t<this.children.length;t++)this.children[t]._setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){for(var r=0;r<this.children.length;r++)this.children[r]._setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setFixedSizeCenter(e,t)},getChildByName:function(e,t){var i={root:this,node:null};return this.traverse(function(t,i){return t.name===e&&(i.node=t,!0)},i,t),i.node},getDirectChildByName:function(e){for(let t=0;t<this.children.length;t++){const i=this.children[t];if(i.name===e)return i}return null},getChildById:function(e,t){var i={root:this,node:null};return this.traverse(function(t,i){return t.persistentId===e&&(i.node=t,!0)},i,t),i.node},_reduceMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].releaseVBO(!0)},_incrementMaterial:function(){if(this.getLinkedToSceneGraph())for(var e=0;e<this._occurrences.length;e++)for(var t=this._occurrences[e]._getRenderableOccurrences(),i=0;i<t.length;i++)t[i].addRefVBO(!0)},oldSetMaterial:function(e){var t,r,n,s,a,o;for(this._reduceMaterial(),this._material=e,t=this._occurrences.length,a=0;a<t;a++)(n=this._occurrences[a]).material=e,null!==n.renderable&&(n.renderable._flagAsGSSOInvalidated(),i.disableJHGDev&&null===n.material||(n.renderable.material=n.material));for(a=0;a<t;a++)for(r=(n=this._occurrences[a]).children.length,o=0;o<r;o++)s=n.children[o],this._updateOccurrences(n,s,!1);this._incrementMaterial()},_setMaterialOnGeomTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setMaterialOnGeomTypes(e,t)},_setMaterialOnGLTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setMaterialOnGLTypes(e,t)},_setGASOnGeomTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setGASOnGeomTypes(e,t)},_setGASOnGLTypes:function(e,t){for(var i=0;i<this.children.length;i++)this.children[i]._setGASOnGLTypes(e,t)},setMaterial:function(e){if(window.newMaterialInheritance){var t=null;if(this._matApp&&this._matApp._material===e&&(t=this._matApp),this._reduceMaterial(),t)this._matApp=t,this._updateMaterial();else{this._matApp=null;var r={layer:0};e&&(e.line||e.point?(e.line&&(r.lineMaterial=e.line),e.point&&(r.pointMaterial=e.point),"forceGeomTypeFACE"===e.force?r.geometricalFaceMaterial=e:r.faceMaterial=e):"forceGeomTypeFACE"===e.force?r.geometricalFaceMaterial=e:e instanceof i.LineBasicMaterial?r.lineMaterial=e:e instanceof i.ParticleBasicMaterial?r.pointMaterial=e:e instanceof i.ShaderMaterialDS?(r.faceMaterial=e,r.lineMaterial=e,r.pointMaterial=e):r.faceMaterial=e),(t=new u(r))._checkForceFlag=!0,this.__setMaterialApplication(t)}this._incrementMaterial()}else this.oldSetMaterial(e)},getMaterialApplication:function(){return this._matApp},setMaterialApplication:function(e){this._reduceMaterial(),this.__setMaterialApplication(e),this._incrementMaterial()},removeMaterialApplication:function(){this._reduceMaterial(),this.__removeMaterialApplication(),this._incrementMaterial()},_getMaterialApplication:function(){return this._matApp},_setMaterialApplication:function(e){console.error("Do not use private internal APIs: please use setMaterialApplication(iMatApp) instead"),this.setMaterialApplication(e)},__setMaterialApplication:function(e){var t=this._getMaterialApplication();t?(e._layer<t._layer||e._layer===t._layer&&e._inheritance>=t._inheritance)&&(this._matApp=e):this._matApp=e,this._updateMaterial()},_removeMaterialApplication:function(){console.error("Do not use private internal APIs: please use removeMaterialApplication() instead"),this.removeMaterialApplication()},__removeMaterialApplication:function(){this._matApp=null,this._updateMaterial()},_updateMaterial:function(){var e,t,i,r;e=this._occurrences.length;var n=this._getMaterialApplication();for(r=0;r<e;r++)!(i=(t=this._occurrences[r]).parent)&&n?t.matApp=n:this._updateOccurrences(i,t,!1),null!==t.renderable&&(t.renderable.matApp=t.matApp)},setGAS:function(e){this._reduceMaterial(),this._setGAS(e),this._incrementMaterial()},getGAS:function(){return this._gas},_setGAS:function(e){if(e){var t,i,r,n,s=this._gas;if(this._gas=e.__getGAS(this._gas),!this._gas._isEqual(s))for(t=this._occurrences.length,n=0;n<t;n++)(r=(i=this._occurrences[n]).parent)?this._updateOccurrences(r,i,!1):i.gas=this._gas?this._gas.clone():null,null!==i.renderable&&(i.renderable.gas=i.gas)}},_getGAS:function(){return this._gas},setVisibility:function(e,r){if(this._getVisible()!==e){var n,s,a,o,l,h,c;if(this._setVisible(e),r)(u=this._getViewer())&&(c=u.getRobot()),c&&c.isTargetGone(u.visibleSpace)&&c.setConnectionState(!1);for(n=this._occurrences.length,l=0;l<n;l++){if((a=this._occurrences[l]).parent?a._setVisible(a.parent._getVisible()&&this._getVisible()):a._setVisible(this._getVisible()),null!==a.renderable){a.renderable.visible=a._getVisible();var d,u=null;if(void 0!==a.renderable.highlightMeshes&&null!==a.renderable.highlightMeshes)if(!(u=a.scene3js&&a.scene3js.viewer)||!u.picking.forceVisibility)for(d=0;d<a.renderable.highlightMeshes.length;d++)a.renderable.highlightMeshes[d].renderable.visible=a._getVisible();if(void 0!==a.renderable.preHighlight&&null!==a.renderable.preHighlight&&(u||(u=a.scene3js&&a.scene3js.viewer),u&&u.pPicking.forceVisibility||(a.renderable.preHighlight.visible=a._getVisible())),a.renderable instanceof i.CSS2DNode||a.renderable instanceof i.CSS3DNode){var p=!0;this._getViewer()&&(p=this._getViewer().visibleSpace);(a._getVisibilityFree()?a._getVisible():p?a._getVisible():!a._getVisible())||(a.renderable.element.style.display="none")}}a.updateVisibilityFlag()}for(l=0;l<n;l++)for(s=(a=this._occurrences[l]).children.length,h=0;h<s;h++)o=a.children[h],this._updateOccurrences(a,o,!0);this._updateVisibilityFlag();var f={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"SHOWTREE":"HIDETREE",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:f})}},setVisibilityFree:function(e){if(this._getVisibilityFree()!==e){var r,n,s,a,o,l,h;for(this._setVisibilityFree(e),(d=this._getViewer())&&(h=d.getRobot()),h&&h.isTargetGone(d.visibleSpace)&&h.setConnectionState(!1),r=this._occurrences.length,o=0;o<r;o++){if((s=this._occurrences[o]).parent?s._setVisibilityFree(s.parent._getVisibilityFree()||this._getVisibilityFree()):s._setVisibilityFree(this._getVisibilityFree()),null!==s.renderable){s.renderable.visibilityFree=s._getVisibilityFree();var c,d=null;if(void 0!==s.renderable.highlightMeshes&&null!==s.renderable.highlightMeshes)if(!(d=s.scene3js&&s.scene3js.viewer)||!d.picking.forceVisibility)for(c=0;c<s.renderable.highlightMeshes.length;c++)s.renderable.highlightMeshes[c].renderable.visibilityFree=s._getVisibilityFree();if(void 0!==s.renderable.preHighlight&&null!==s.renderable.preHighlight&&(d||(d=s.scene3js&&s.scene3js.viewer),d&&d.pPicking.forceVisibility||(s.renderable.preHighlight.visibilityFree=s._getVisibilityFree())),s.renderable instanceof i.CSS2DNode||s.renderable instanceof i.CSS3DNode){var u=!0;this._getViewer()&&(u=this._getViewer().visibleSpace);(s._getVisibilityFree()?s._getVisible():u?s._getVisible():!s._getVisible())||(s.renderable.element.style.display="none")}}s.updateVisibilityFreeFlag()}for(o=0;o<r;o++)for(n=(s=this._occurrences[o]).children.length,l=0;l<n;l++)a=s.children[l],this._updateOccurrences(s,a,!1);this._updateVisibilityFreeFlag();var p={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"VISIBILITYFREE":"VISIBILITYDEPENDENT",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:p})}},setMatrix:function(e,t){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var r=new Error;console.error(r.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}!e||e.isIdentity()?this._matrix=null:this._matrix?this._matrix.copy(e):this._matrix=(new i.Matrix4).copy(e),this._updateMatrix(t)},applyMatrix:function(e){if(e&&!e.isIdentity){e=(new i.Matrix4).copy(e);var t=new Error;console.error(t.stack),console.error("ERROR: setMatrix requires a THREE.Matrix4!")}e&&!e.isIdentity()&&(this._matrix?(this._matrix.multiplyMatrices(e,this._matrix),this._matrix.isIdentity()&&(this._matrix=null)):(this._matrix=new i.Matrix4,this._matrix.copy(e))),this._updateMatrix()},setVisibilityInTree:function(e){if(this._getVisibilityInTree()!==e){this._setVisibilityInTree(e);for(var i=0;i<this.parents.length;i++){var r={eventChannel:"/VISU/onSceneGraphUpdate",eventType:e?"ADDTREE":"REMOVETREE",fromNode:this.parents[i],toNode:this};t.publish({event:"/VISU/onSceneGraphUpdate",data:r})}}},getVisibilityInTree:function(){return void 0===this._getVisibilityInTree()||this._getVisibilityInTree()},setIcon:function(e){this._iconInTree=""===e?"":e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGEICON",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getIcon:function(){return void 0!==this._iconInTree?this._iconInTree:""},setName:function(e){this.name=e;var i={eventChannel:"/VISU/onSceneGraphUpdate",eventType:"CHANGENAME",fromNode:this,toNode:null};t.publish({event:"/VISU/onSceneGraphUpdate",data:i})},getName:function(){return this.name},getPickable:function(){return this.getNoPickThrough()?this._getPickable()?s.PICKABLE:s.NOPICKABLE:s.PICKTHROUGH},setPickable:function(e){var t,i,r,n,a,o;for("boolean"==typeof e&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),this._setPickable(e===s.PICKABLE),this.setNoPickThrough(e!==s.PICKTHROUGH),t=this._occurrences.length,a=0;a<t;a++)(r=this._occurrences[a]).parent?(r._setPickable(r.parent._getPickable()&&this._getPickable()),r.setNoPickThrough(r.parent.getNoPickThrough()&&this.getNoPickThrough())):(r._setPickable(this._getPickable()),r.setNoPickThrough(this.getNoPickThrough())),null!==r.renderable&&(r.renderable.pickable=r._getPickable(),r.renderable.noPickThrough=r.getNoPickThrough(),r.renderable._flagAsGSSOInvalidated());for(a=0;a<t;a++)for(i=(r=this._occurrences[a]).children.length,o=0;o<i;o++)n=r.children[o],this._updateOccurrences(r,n,!1)},isPickable:function(){return this._getPickable()},getNoZPriority:function(){return this._getNoZPriority()},setNoZPriority:function(e){var t,i,r,n,s,a;for(this._setNoZPriority(e),t=this._occurrences.length,s=0;s<t;s++){var o=(r=this._occurrences[s]).parent;if(o)this._updateOccurrences(o,r,!1);else for(i=r.children.length,a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,!1)}},setPickParent:function(e){this._setPickParent(e)},getPickParent:function(){return!!this._getPickParent()},setPickingPriorityId:function(e){var t,i,r,n,s,a;for(this.pickingPriorityID||(this.pickingPriorityID={faces:null,edges:null,points:null}),"string"==typeof e&&(this.pickingPriorityID.faces=e,this.pickingPriorityID.edges=e,this.pickingPriorityID.points=e),(e.faces||null===e.faces)&&(this.pickingPriorityID.faces=e.faces),(e.edges||null===e.edges)&&(this.pickingPriorityID.edges=e.edges),(e.points||null===e.points)&&(this.pickingPriorityID.points=e.points),t=this._occurrences.length,s=0;s<t;s++)(r=this._occurrences[s]).pickingPriorityID=this.pickingPriorityID,null!==r.renderable&&(r.renderable.pickingPriorityID=r.pickingPriorityID);for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,!1)},getPickingPriorityId:function(){return this.pickingPriorityID},exludeFromBounding:function(e){this.setExcludeFromBounding(e),this._invalidateBoundingElements(!1,!0)},translate:function(e,t){var r=new i.Vector3;this._matrix&&(t.transformDirection(this._matrix),r.getPositionFromMatrix(this._matrix)),r.add(t.multiplyScalar(e)),this._matrix||(this._matrix=new i.Matrix4),this._matrix.setPosition(r),this._updateMatrix()},translateX:function(e){var t=new i.Vector3(1,0,0);this.translate(e,t)},translateY:function(e){var t=new i.Vector3(0,1,0);this.translate(e,t)},translateZ:function(e){var t=new i.Vector3(0,0,1);this.translate(e,t)},getMaterial:function(e){var t=this._filters?this._filters.get(M.LOOK):null,i=this._getMaterialApplication();if(!i||t){var r=t?t.material:this._material;if(r)switch(e){case"Face":case"GeomFace":return r;case"Line":return r.line;case"Point":return r.point}return r}switch(e){case"Face":return i._material;case"GeomFace":return i._materialGeomFace;case"Line":return i._materialLine;case"Point":return i._materialPoint}return i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null},isVisible:function(){return this._getVisible()},getMatrix:function(){return this._matrix?this._matrix.clone():new i.Matrix4},getChildren:function(){return[].concat(this.children)},getParents:function(){return[].concat(this.parents)},getNodeType:function(){return"Node3D"},whiteVectorInBlack:function(){this.modifyColor(new i.Color(0),new i.Color(16777215))},modifyColor:function(e,t,r){if(!y){if("Mesh3D"===this.getNodeType()){var n=this._occurrences[0].renderable.geometry;if(!(n instanceof Array))return;for(var s=0;s<n.length;s++)for(var a=n[s].drawingGroups,o=0;o<a.length;o++){var l=a[o];if(l.gas&&l.gas.color){if(l.gas instanceof i.ParticleBasicMaterial)continue;var h=l.gas.color;if(r&&r!==l.glType)continue;if(h.equals(t)){var c=l.gas.clone();c.color=e,l.gas=c}}if(l.material&&l.material.color){if(l.material instanceof i.ParticleBasicMaterial)continue;h=l.material.color;if(r&&r!==l.glType)continue;if(h.equals(t)){var d=l.material.clone();d.color=e,l.material=d}}}}for(o=0;o<this.children.length;o++)this.children[o].modifyColor(e,t,r)}},getBoundingSphere:function(e,t){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");var i=this._getBoundingSphere(e,t);return i?i.clone():null},createOverrideSetManager:function(){return!this._overrideSetManager&&E.SceneGraphOverrideSetManager&&this._setOverrideSetManager(new E.SceneGraphOverrideSetManager({node:this})),this._overrideSetManager},getOverrideSetManager:function(){return this._overrideSetManager},removeOverrideSetManager:function(){this._overrideSetManager&&(this._overrideSetManager.clear(),this._overrideSetManager=null)},_setOverrideSetManager:function(e){this._overrideSetManager=e,this._setOverrideSetManagerUnder(!0)},_getViewer:function(){return this._occurrences.length>0&&this._occurrences[0].scene3js?this._occurrences[0].scene3js.viewer:null},_getAllOwningViewers:function(){var e,t,i=[];for(e=0;e<this._occurrences.length;e++)this._occurrences[e].scene3js&&(t=this._occurrences[e].scene3js.viewer)&&i.indexOf(t)<0&&i.push(t);return i},_hasOccurrenceInViewer:function(e){var t;for(t=0;t<this._occurrences.length;t++)if(this._occurrences[t].scene3js&&e===this._occurrences[t].scene3js.viewer)return!0;return!1},_tryOverridesUpdate:function(e){var t=e.getSceneGraphOverrideSetManager();t&&t._fullOccurrencesUpdate();var i,r,n=e?e.hasSceneGraphOverrideSet():null,s=this._occurrences,a=!1;if(this._getOverrideSetManagerUnder())for(i=0;i<s.length;i++)((r=s[i]).isOverridesUpdateRequested()||r.doesADescendantNeedOverrideUpdate())&&(a=!0);for(a&&this.traverseUnique(function(e){e._overrideSetManager&&(e._overrideSetManager._refresh(!0),n=!0)}),i=0;i<s.length;i++)s[i].traverseWithCondition(function(e){return e.isOverridesUpdateRequested()?(e.updateOverrideStatus(n),null):!!e.doesADescendantNeedOverrideUpdate()||null}),s[i].clearOverridesUpdateRequest()},forceBoundingElements:function(e,t,r){function n(e){var t=null;return void 0===e.sphere&&void 0===e.box||(t={sphere:e.sphere||function(e){if(!e)return null;var t=new i.Vector3(.5*(e.min.x+e.max.x),.5*(e.min.y+e.max.y),.5*(e.min.z+e.max.z)),r=t.distanceTo(e.max),n=new i.Sphere;return n.center=t,n.radius=r,n}(e.box),box:e.box||function(e){if(!e)return null;var t=new i.Vector3(2*e.radius,2*e.radius,2*e.radius),r=new i.Box3;return r.setFromCenterAndSize(e.center,t),r}(e.sphere)}),t}if(e){r=r||{};var s=n(t=t||{}),a=n(r);this.__forceBoundingElements(s,a)}else this._getForceBoundingElements()&&(this._setForceBoundingElements(!1),this._invalidateBoundingElements(!1,!1))},__forceBoundingElements:function(e,t){this._setForceBoundingElements(!0),this._bsShow=e&&e.sphere,this._bsNoShow=t&&t.sphere,this._bbShow=e&&e.box,this._bbNoShow=t&&t.box,this._invalidateBoundingElements(!1,!1)},getBoundingBox:function(e){return"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace"),this._getBoundingBox(e).clone()},_getBoundingSphere:function(e,t){e=e||"visibleSpace";var r,n,s=null;return this.getHasExplicitBE()&&0===this.children.length?(r=this.explicitBSphere,n=null):(this._updateBoundingElements(),r=this._bsShow,n=this._bsNoShow),(s=this._getVisibilityFree()?this._getVisible()?r:null:this._getVisible()?"visibleSpace"===e?r:n:"visibleSpace"===e?null:i.mergeBoundingSphereInto(r&&r.clone(),n,this.getRatio()))||t||(s=new i.Sphere),s},_getBoundingBox:function(e){e=e||"visibleSpace";var t,r,n=null;return this.getHasExplicitBE()&&0===this.children.length?(t=this.explicitBBox,r=null):(this._updateBoundingElements(),t=this._bbShow,r=this._bbNoShow),(n=this._getVisibilityFree()?this._getVisible()?t:null:this._getVisible()?"visibleSpace"===e?t:r:"visibleSpace"===e?null:i.mergeBoundingBoxInto(t&&t.clone(),r))||(n=new i.Box3),n},_invalidateBoundingElements:function(e,t){if(!e){var i=0;for(i=0;i<this._occurrences.length;i++)this._occurrences[i]._invalidateBoundingElements(t)}if(!this._getNeedBEUpdate()&&(this._setNeedBEUpdate(!0),!this.getExcludeFromBounding()||t)){var r=0;for(r=0;r<this.parents.length;r++)this.parents[r]._invalidateBoundingElements(!0,!1)}},_updateVisibilityFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateVisibilityFreeFlag:function(){this._invalidateBoundingElements(!1,!1)},_updateShadowMapsIfNeeded:function(e){var t=this._getViewer(),i=e;return t&&t.useShadowMap&&!t._shadowUpdated&&(void 0===i&&(i=!0,this.traverse(function(e){return!!e.getExcludeFromBounding()&&(i=!1,!0)},void 0,!0)),(i=i&&!this.getExcludeFromBounding())&&t._updateShadowMaps()),i},_updateBoundingElements:function(e,t){var r;if(this._getNeedBEUpdate()){if(t=this._updateShadowMapsIfNeeded(t),!this._getForceBoundingElements()){for(r=0;r<this.children.length;r++)this.children[r]._updateBoundingElements(!0,t);this.updateBoundingElements_internal("_bsShow","_bsNoShow",i.mergeBoundingSphereInto,"explicitBSphere"),this.updateBoundingElements_internal("_bbShow","_bbNoShow",i.mergeBoundingBoxInto,"explicitBBox")}if(!e)for(r=0;r<this._occurrences.length;r++)this._occurrences[r]._updateBoundingElements(!0);this._setNeedBEUpdate(!1)}},_areBoundingElementsIncludedInParent:function(e){var t=new i.Sphere,r=new i.Box3,n=this._matrix;function s(e,i){return!(e&&!i)&&(!e||(t.copy(e),n&&t.applyMatrix4(n),!!i.containsSphere(t)))}function a(e,t){return!(e&&!t)&&(!e||(r.copy(e),n&&r.applyMatrix4(n),!!t.containsBox(r)))}return this._updateBoundingElements(),s(this._bsShow,e._bsShow)&&a(this._bbShow,e._bbShow)&&s(this._bsNoShow,e._bsNoShow)&&a(this._bbNoShow,e._bbNoShow)},updateBoundingElements_internal:function(e,t,i,r){if(!this._getForceBoundingElements()){var n=null,s=null;if(this.children.length){var a,o,l,h=0;for(h=0;h<this.children.length;h++)(a=this.children[h]).getExcludeFromBounding()||(o=a[e],l=a[t],a._getVisibilityFree()?a._getVisible()&&(n=i(n,o,a._matrix,a.getRatio()),s=i(s,o,a._matrix,a.getRatio())):a._getVisible()?(n=i(n,o,a._matrix,a.getRatio()),s=i(s,l,a._matrix,a.getRatio())):(s=i(s,o,a._matrix,a.getRatio()),s=i(s,l,a._matrix,a.getRatio())))}if(n=this._modifyBE(n,i),s=this._modifyBE(s,i),this.getHasExplicitBE()){var c=this[r];n=n&&c?i(n,c,null,0):c}this[e]=n,this[t]=s}},getRatio:function(){return 0},updateBoundingSphere:function(){this._invalidateBoundingElements(!1,!1)},updateBoundingSphereFromParentToChildren:function(){E.DEPRECATED_Method(new Error)},updateBoundingBox:function(){this._invalidateBoundingElements(!1,!1)},isIncludedIn:function(e){if(!this.bSphere.radius)return!0;var t=this.bSphere.clone();return this._matrix&&t.applyMatrix4(this._matrix),t.center.distanceTo(e.bSphere.center)+t.radius<=e.bSphere.radius},getMatrixWorld:function(e){if(y)return null;var t,s;if(1===this._occurrences.length)return this._occurrences[0].matrix?this._occurrences[0].matrix.clone():new i.Matrix4;if(void 0===e)return console.warn("This node is an instance. An occurrence path has to be specified."),null;if(e instanceof r){var a=new n;a.setFromOccurrencePath(e),e=a}if((s=e._getOccurrences()).length>1)return console.warn("More than one occurrence satisfies this occurrence path. Unable to return a unique matrixWorld."),null;if(!s.length)return console.warn("No occurrence satisfies this occurrence path. Unable to return a matrixWorld."),null;for(t=0;t<this._occurrences.length;t++)if(s[0]===this._occurrences[t])return s[0].matrix?s[0].matrix.clone():new i.Matrix4;return console.warn("The occurrence path has to terminate with the current node name. Unable to return a matrixWorld."),null},isInstance:function(){return this._occurrences.length>1},buildAccelerationStructure:function(e){for(var t=this._occurrences.length,i=0;i<t;i++)for(var r=this._occurrences[i]._getRenderableOccurrences(),n=0;n<r.length;n++){r[n].computeKDTree(e)}},setScene:function(e){var t,i,r,n,s,a;for(t=this._occurrences.length,s=0;s<t;s++)(r=this._occurrences[s]).scene3js=e;for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,!0)},subscribe:function(e,t){void 0===this.modelEvents&&(this.modelEvents=new a),this.modelEvents.subscribe(e,t)},isReady:function(){return!0},_updateMatrix:function(e){var t,i,r,n,s,a,o;for(t=this._occurrences.length,s=0;s<t;s++)if((r=this._occurrences[s]).updateMatrix(this._matrix),null!==r.renderable){var l;if(r.renderable.setMatrix(r.matrix,!1),r.renderable.orientation=!r.matrix||r.matrix.determinant()>0?1:-1,void 0!==r.renderable.highlightMeshes&&null!==r.renderable.highlightMeshes)for(l=0;l<r.renderable.highlightMeshes.length;l++)r.renderable.highlightMeshes[l].renderable.setMatrix(r.matrix,!1);if(void 0!==r.renderable.preHighlight&&null!==r.renderable.preHighlight&&r.renderable.preHighlight.setMatrix(r.matrix,!1),r.scene3js&&r.scene3js.viewer)if(void 0!==r.renderable.updateShadowMap)r.renderable.updateShadowMap=!0;else if(r.renderable.castShadow)for(var h=0;h<r.scene3js.parent.__lights.length;h++){var c=r.scene3js.parent.__lights[h];c.blockUpdate||(c.updateShadowMap=!0)}}for(s=0;s<t;s++)for(i=(r=this._occurrences[s]).children.length,r.overrideLink&&(r.overrideLink.setMatrixUpdate(),r.requestOverridesUpdate()),a=0;a<i;a++)n=r.children[a],this._updateOccurrences(r,n,!0,e,!0);if(!e)for(s=0,o=this.parents.length;s<o;s++)this.getExcludeFromBounding()||this.parents[s]._invalidateBoundingElements(!1,!1)},_copyTree:function(e){var t,i,r,n,s;for(t=e.lightCopy(),"InstancingNode3D"==e.node.getNodeType()&&e.node._propagateInstancingParameters(t,e._instancingInfos),e.node._occurrences.push(t),e._invalidateBoundingElements(!1),r=e.children.length,s=0;s<r;s++)n=e.children[s],(i=this._copyTree(n)).parent=t,t.children.push(i),t._invalidateBoundingElements(!1);return t},_deleteTree:function(e){var t,i,r,n,s;-1!==(i=(t=e.node)._occurrences.indexOf(e))&&t._occurrences.splice(i,1),null!==e.renderable&&null!==e.scene3js&&("Mesh3D"===e.node.getNodeType()||"ParticlesNode3D"===e.node.getNodeType()?e.scene3js.containsObject(e.renderable)&&(this._removeFromVisuSelection(e.renderable),e.scene3js.remove(e.renderable),"Mesh3D"===e.node.getNodeType()&&e.renderable.releaseVBO(!1)):"LightNode3D"===e.node.getNodeType()?e.scene3js.containsLight(e.renderable)&&e.scene3js.remove(e.renderable):"LensFlareNode3D"===e.node.getNodeType()?e.scene3js.containsLensFlare(e.renderable)&&e.scene3js.remove(e.renderable):"CSS2DNode"!==e.node.getNodeType()&&"CSS3DNode"!==e.node.getNodeType()||e.scene3js.containsObject(e.renderable)&&(e.scene3js.remove(e.renderable),e.renderable.element.parentNode&&e.renderable.element.parentNode.removeChild(e.renderable.element)));var a=e.scene3js&&e.scene3js.viewer;for(a&&2===a._sceneGraphStateVersion&&(e.originalOverrideSet&&(e.originalOverrideSet.onDetach(a,e),e.originalOverrideSet=null),e.overrideLink=null),e.scene3js=null,n=e.children.length,r=0;r<n;r++)s=e.children[r],this._deleteTree(s)},forceUpdate:function(){this._forceUpdate()},_forceUpdate:function(){var e,t,i=this._getAllOwningViewers();for(e=0;e<i.length;e++)i[e]&&this._tryOverridesUpdate(i[e]);if(this.parents.length>0)for(e=0;e<this._occurrences.length;e++)t=this._occurrences[e],this._updateOccurrences(t.parent,t,!0);else for(e=0;e<this.children.length;e++)this.children[e]._forceUpdate()},onLinkToSceneGraph:function(e){if(!y){var t,i,r=e.traverseUnique(function(e){}),n=[],s=[];for(t=0;t<r.length;t++)(i=r[t])._occurrences[0].__rdo_visited=0;for(t=0;t<r.length;t++){for(i=r[t],a=0;a<i.children.length;a++)i.children[a]._occurrences[0].__rdo_visited++}for(e._onLinkToSceneGraph_internal(!0,n,s),t=0;t<r.length;t++){var a;(i=r[t])._occurrences[0].__rdo_visited=0}for(t=n.length-1;t>=0;t--)(i=n[t])._onLinkedToSceneGraph(),i._requestClippingUpdate();for(t=s.length-1;t>=0;t--)(i=s[t])._onUnlinkedToSceneGraph(),i._requestClippingUpdate();null!==E._onLinkToSceneGraph_DEBUG&&E._onLinkToSceneGraph_DEBUG(r,n,s)}},_onLinkToSceneGraph_internal:function(e,t,i){var r,n=!1;if(!y){var s,a=e;for(r=0;!a&&r<this.parents.length;r++)(s=this.parents[r])._occurrences.length>0&&-1===s._occurrences[0].__rdo_visited&&(a=!0);if(a){for(r=0;r<this.parents.length;r++)if(this.parents[r].getLinkedToSceneGraph()){n=!0;break}var o;for(this.getLinkedToSceneGraph()!==n&&(this.setLinkedToSceneGraph(n),this._occurrences[0].__rdo_visited=-1,n?t.push(this):i.push(this)),r=0;r<this.children.length;r++)(o=this.children[r])._occurrences[0].__rdo_visited--,0===o._occurrences[0].__rdo_visited&&o._onLinkToSceneGraph_internal(!1,t,i)}}},_propagateGAS:function(e,t){t?e.gas?e.gas.copy(t):e.gas=t.clone():e.gas=null},_propagateMatApp:function(e,t){t?(e.matApp?e.matApp.copy(t):e.matApp=t.clone(),-1===e.matApp._depth&&(e.matApp._depth=e.depth)):e.matApp=null},_propagateInstancingParameters:function(e,t){if(e._instancingInfos=t?{isInstanceNode3D:t.isInstanceNode3D,nbInstances:t.nbInstances,instancingSelectionMode:t.instancingSelectionMode,instanceAttribArrays:t.instanceAttribArrays,pickedInstanceId:[],useDefaultInstancing:t.useDefaultInstancing}:null,e.renderable&&(!e.renderable._instancingInfos||e.renderable._instancingInfos.useDefaultInstancing)){var r;if(e.renderable._instancingInfos=e._instancingInfos,e.renderable._instancingInfos&&e.renderable.highlightMeshes)for(r=0;r<e.renderable.highlightMeshes.length;r++){let t=e.renderable.highlightMeshes[r].renderable._instancingInfos.instanceAttribArrays;for(let i in t)"id"!==i&&(t[i].isDynamic=e._instancingInfos.instanceAttribArrays[i].isDynamic)}e.renderable._instancingInfos?e.renderable._programID|=i.ProgramIDs.DEFAULT_INSTANCING:e.renderable._programID&=~i.ProgramIDs.DEFAULT_INSTANCING}},_updateOccurrences:function(e,t,r,s,a,l){if(!y){var h,c,u,p;h=e.node,c=t.node,e.parent||(e.depth=0),t.depth=e.depth+1,t._copyForceShowStatusFromOcc(e),u=t.scene3js;var f=null,g=null,m=null,v=null,_=null,S=null,x=null,b=null,w=!1,P=!1,T=!1;if(t.overrideLink){if(t.renderable&&(t.overrideLink.internalMaterialOverrideReset&&(t.overrideLink.internalMaterialOverrideReset=!1,t.renderable.layer=null),t.overrideLink.internalMaterialOverride&&t.originalOverrideSet)){var A=t.overrideLink.internalMaterialOverride;A.material&&((p=new n).setFromArray(t.originalOverrideSet.pathElement.externalPath,A.internalPath),E._applyMaterialToPath(p,A.material)),t.overrideLink.internalMaterialOverrideReset=!0}f=t.overrideLink.getSubstituteMatrix(),g=t.overrideLink.getVisibility(),S=t.overrideLink.getVisibilityFree(),m=t.overrideLink.getPickability(),v=t.overrideLink.getPickingPriorityID(),_=t.overrideLink.getClipping(),x=t.overrideLink.getRenderStyle(),P=t.overrideLink.visibilityFix,t.originalOverrideSet&&t.originalOverrideSet.invalidateBE&&(t.originalOverrideSet.unsetInvalidateBE(),w=!0),t.overrideLink.getMatrixUpdate()&&(t.overrideLink.clearMatrixUpdate(),T=!0),g&&t.overrideLink.getForceShowVisibility()&&!g.visibility&&t._setForceShowHide(!0),m&&t.overrideLink.getForceShowPickability()&&("NOT_PICKABLE"===m?t._setForceShowNoPickability(!0):"IGNORED"===m&&(t._setForceShowNoPickability(!0),t._setForceShowNoDrawHL(!0)))}t.setIsInBackground(e.isInBackground()&&c.isInBackground()),t._setIsAlwaysInForeground(e._isAlwaysInForeground()||c._isAlwaysInForeground());var I=null;if(t&&t.originalOverrideSet&&(t.originalOverrideSet.hasMaterialOverride()||t.originalOverrideSet.internalMaterialOverride)&&(I=t.overrideLink),2===e._relativeVisibility&&(t._relativeVisibility=e._relativeVisibility),null!==t._relativeVisibility&&(P=2!==t._relativeVisibility,g={visibility:t._relativeVisibility}),null!==t){if(t.scene3js=e.scene3js,r||c._isDynamic||T)if(f)t.updateMatrix(f,!0);else{if(f=c._matrix,c._isDynamic&&t.scene3js){var R=t._getViewpoint()||t.scene3js.viewer.currentViewpoint;if(R){var O=c._getDynamicMatrix(e.matrix,null,R);O&&(f=O,c._matrix||(c._matrix=new i.Matrix4),c._matrix.copy(f),s||c._invalidateBoundingElements(!1,!1))}}t.localMatrixOverride&&(w=!0);let r=!1;t._relativeMatrix&&(f=t._relativeMatrix,t._getFrom3dxml()&&(r=!0)),t.updateMatrix(f,r)}b=e.getViewer(),t.renderMode=x?x._combineRenderMode(e.renderMode,c._renderMode):c._renderMode||e.renderMode,t.pickingMode=c._pickingMode||e.pickingMode,t.layerFilter=c._layerFilter?c._layerFilter:e.layerFilter,t._setAdvancedPriority(c._getAdvancedPriority()?c._getAdvancedPriority():e._getAdvancedPriority()),t._setDepthMode(c._getDepthMode()?c._getDepthMode():e._getDepthMode()),b&&b.currentViewpoint&&b.currentViewpoint.isNative2D()&&b.currentViewpoint._depthMode&&(c._gas?c._depthPriority=c._gas._priority-4+h._depthPriority:c._depthPriority=h._depthPriority);var L=x;t.faceMode=L&&L._combineFaceMode(e.faceMode)||e.faceMode;var V=c.passes?c.passes:e.passes;t.forcePasses&&(V=t.forcePasses);var F=t.scene3js&&t.scene3js.parent instanceof i.Scene?t.scene3js.parent:null;if(t.renderable&&t.renderable.fromLoadedModel){var B=b&&b._renderStyle,N=t.faceMode&&t.faceMode.face||B&&B._faceMode;N===d.FaceModes.ZONLY?V=["ZOnly"]:N===d.FaceModes.BACKGROUND&&(V=["background"])}var G=V,k=null;(t.renderPriority||e.renderPriority)&&(k=function(e,t){if(!t)return e&&(e.userPriority||e.userOpacity)?{userPriority:!1,priority:e.priority,userOpacity:!1,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority}:{userPriority:e.userPriority,priority:e.priority,userOpacity:e.userOpacity,opacity:e.opacity,lastRenderPriority:e.lastRenderPriority};if(!e)return{userPriority:t.userPriority,priority:t.priority,userOpacity:t.userOpacity,opacity:t.opacity,lastRenderPriority:t.lastRenderPriority};return{userPriority:t.userPriority,priority:t.userPriority?t.priority:e.priority,userOpacity:t.userOpacity,opacity:t.userOpacity?t.opacity:e.opacity,lastRenderPriority:t.lastRenderPriority}}(e.renderPriority,t.renderPriority));var U=b&&b._renderPriorityManager&&b._renderPriorityManager.enabled;t.renderPriority=k;var z=-1;U&&(k||(k={userPriority:!1,priority:0,userOpacity:!1,opacity:-1,lastRenderPriority:-1},t.renderPriority=k),G=function(e,t){if(!e||1===e.length&&"main"===e[0])return D[t];var i,r,n=[];for(i=0;i<e.length;i++)"main"===(r=e[i])?n=n.concat(D[t]):n.push(r);return n}(V,z=k&&k.priority||0));var H,W=G!==t.passes||t.renderPriority&&z!==t.renderPriority.lastRenderPriority;if(t.renderPriority&&(t.renderPriority.lastRenderPriority=z),t.renderable&&F&&W&&F.updateObjectPasses(t.renderable,G),t.passes=V,c._isDecal)t.material=c._material,(H=t._getMaterialApplication())&&this._propagateMatApp(t,H);else e.material&&"forceGeomTypeFACE"===e.material.force?t.material=c._material||e.material:t.material=null!==e.material?e.material:c._material,t.forceGAS?t.gas=t.forceGAS:(e.gas&&!c._gas?this._propagateGAS(t,e.gas):this._propagateGAS(t,c._gas),e.gas&&c._gas&&t.gas.merge(e.gas,h._filters&&h._filters.get(M.GAS_INHERIT))),(H=t._getMaterialApplication())&&e.matApp?H.isPrioritary(e.matApp,t.depth)?this._propagateMatApp(t,H):this._propagateMatApp(t,e.matApp):H?this._propagateMatApp(t,H):this._propagateMatApp(t,e.matApp);t._setInvertMode(!g&&(e._getInvertMode()||c._getInvertMode())),t._setInvertPickMode(!m&&(e._getInvertPickMode()||c._getInvertPickMode()));var j=t._getVisible(),X=t._getVisibilityFree();P?(t._setVisible(Fe(e._getVisible(),g,g&&g.visibility,c._getVisible(),t.overrideLink&&t.overrideLink.getForceShowVisibility(),t._getForceShowHide())),t._setPickable(Fe(e._getPickable(),m,"PICKABLE"===m,c._getPickable(),t.overrideLink&&t.overrideLink.getForceShowPickability(),t._getForceShowNoPickability())),t.setNoPickThrough(Fe(e.getNoPickThrough(),m,"IGNORED"!==m,c.getNoPickThrough(),t.overrideLink&&t.overrideLink.getForceShowPickability(),t._getForceShowNoDrawHL())),t._setVisibilityFree(e._getVisibilityFree()||(S?S.visibilityFree:c._getVisibilityFree()))):(t._setVisible(g?g.visibility:e._getVisible()&&c._getVisible()),t._setVisibilityFree(e._getVisibilityFree()||c._getVisibilityFree()),t._setPickable(m?"PICKABLE"===m:e._getPickable()&&c._getPickable()),t.setNoPickThrough(m?"IGNORED"!==m:e.getNoPickThrough()&&c.getNoPickThrough())),t._setNoZPriority(e._getNoZPriority()||c._getNoZPriority()),c._propagateVisuFilters(t,e._filters),t._propagateSubstituteMaterials(e.__solvedSubstituteMaterials),e._filters&&e._filters.has(M.DO_NOT_PICK_UNDER)&&c.setPickParent(e._filters.get(M.DO_NOT_PICK_UNDER)._doNotPickUnder),t._getVisible()!==j&&t.updateVisibilityFlag(),t._getVisibilityFree()!==X&&t.updateVisibilityFreeFlag(),e.pickingPriorityID&&e.pickingPriorityID._override?t.pickingPriorityID=e.pickingPriorityID:t.pickingPriorityID=v||(c.pickingPriorityID?c.pickingPriorityID:e.pickingPriorityID),h._getPropagateXSOExclusion()&&(c._setPropagateXSOExclusion(!0),c._setExcludeFromCSO(h._getExcludeFromCSO()),c._setExcludeFromHSO(h._getExcludeFromHSO()),c._setExcludeFromPSO(h._getExcludeFromPSO()),c._setExcludeFromHL(h._getExcludeFromHL()),c._setExcludeFromPreHL(h._getExcludeFromPreHL())),t.node._instancingInfos||this._propagateInstancingParameters(t,e._instancingInfos)}if(null!==t.renderable){if(!a&&t.renderable._flagAsGSSOInvalidated(),b||(b=t.getViewer()),t.renderable.filtered=t._isFiltered(),t.renderable.setMatrix(t.matrix,!1),t.renderable._ratioData=c._ratioData,t.renderable._billboardData=c._billboardData,t.renderable.orientation=!t.matrix||t.matrix.determinant()>0?1:-1,t.renderable._noZPriority=t._getNoZPriority(),b&&b.currentViewpoint&&b.currentViewpoint.isNative2D()?b.currentViewpoint._depthMode?(t.renderable._priorityMode=i.PriorityMode.DepthPriority,t.renderable._depthPriority=c._depthPriority):t.renderable._priorityMode=i.PriorityMode.ClassicPriority2D:t._getDepthMode()?t._getAdvancedPriority()?t.renderable._priorityMode=i.PriorityMode.Advanced:t.renderable._priorityMode=i.PriorityMode.ClassicPriority:t.renderable._priorityMode=i.PriorityMode.SceneGraphOrder,t.renderable._advancedPriority=t.advancedPriority,t.renderable._noZPriority||t.passes){var q=!!t._filters&&t._filters.has(M.LOOK)&&!!t._filters.get(M.LOOK).material,Z="_refplaneitem_"===c.name;if(q||Z){if(t.passes){var Y=t.passes.indexOf("noz");-1!==Y&&(t.passes=t.passes.slice(),t.passes[Y]="main",F&&F.updateObjectPasses(t.renderable,t.passes))}t.renderable._noZPriority=!1}}c._isDecal?t.renderable._programID|=i.ProgramIDs.DECALS:t.renderable._programID&=~i.ProgramIDs.DECALS;var Q=t.renderable.highlightMeshes;if(null!=Q){var K,$=t._getVisible()&&!t._getInvertMode(),J=t._getVisibilityFree();for(ne=0;ne<Q.length;ne++)(K=Q[ne].renderable).setMatrix(t.matrix,!1),b&&b.picking.forceVisibility||(K.visible=$,K.visibilityFree=J),K._ratioData=c._ratioData,K._billboardData=c._billboardData}if(void 0!==t.renderable.preHighlight&&null!==t.renderable.preHighlight&&(t.renderable.preHighlight.setMatrix(t.matrix,!1),b&&b.pPicking.forceVisibility||(t.renderable.preHighlight.visible=t._getVisible()&&!t._getInvertMode(),t.renderable.preHighlight.visibilityFree=t._getVisibilityFree()),t.renderable.preHighlight._ratioData=c._ratioData,t.renderable.preHighlight._billboardData=c._billboardData),t.renderable instanceof i.CSS2DNode||t.renderable instanceof i.CSS3DNode){var ee=!0;this._getViewer()&&(ee=this._getViewer().visibleSpace);(t._getVisibilityFree()?t._getVisible()&&!t._getInvertMode():ee?t._getVisible()&&!t._getInvertMode():!(t._getVisible()&&!t._getInvertMode()))||(t.renderable.element.style.display="none")}if(i.disableJHGDev)null!==t.material&&(t.renderable.material=t.material);else if(!t.material&&t.renderable._3dxmlMaterial)t.renderable.material=t.renderable._3dxmlMaterial;else{var te=t.renderable.material;te&&te.canvasNodeTextureSize||(t.renderable.material=t.material)}if(t.renderable.matApp=t.matApp,t.renderable.gas=t.gas,t.renderable.visible=t._getVisible()&&!t._getInvertMode(),t.renderable.visibilityFree=t._getVisibilityFree(),t.renderable.pickable=t._getPickable()&&!t._getInvertPickMode(),t.renderable.noPickThrough=t.getNoPickThrough()&&!t._getInvertPickMode(),t.renderable.pickingPriorityID=t.pickingPriorityID,null!==t.scene3js){if("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()||"CSS3DNode"===t.node.getNodeType()||"CSS2DNode"===t.node.getNodeType()?t.scene3js.containsObject(t.renderable)||(t.scene3js.add(t.renderable,t.passes),"Mesh3D"===t.node.getNodeType()&&t.renderable.addRefVBO(!1)):"LightNode3D"===t.node.getNodeType()?t.scene3js.containsLight(t.renderable)||t.scene3js.add(t.renderable):"LensFlareNode3D"===t.node.getNodeType()&&(t.scene3js.containsLensFlare(t.renderable)||t.scene3js.add(t.renderable)),t.scene3js.viewer)if(t.scene3js.viewer._lockRenderIteration||(t.scene3js.viewer.renderIteration=0),void 0!==t.renderable.updateShadowMap)t.renderable.updateShadowMap=!0;else if(t.renderable.castShadow)for(var ie=0;ie<t.scene3js.parent.__lights.length;ie++){var re=t.scene3js.parent.__lights[ie];re.blockUpdate||(re.updateShadowMap=!0)}}else null!==u&&("Mesh3D"===t.node.getNodeType()||"ParticlesNode3D"===t.node.getNodeType()?u.containsObject(t.renderable)&&(this._removeFromVisuSelection(t.renderable),u.remove(t.renderable),"Mesh3D"===t.node.getNodeType()&&t.renderable.releaseVBO(!1)):"LightNode3D"===t.node.getNodeType()?u.containsLight(t.renderable)&&u.remove(t.renderable):"LensFlareNode3D"===t.node.getNodeType()?u.containsLensFlare(t.renderable)&&u.remove(t.renderable):"CSS2DNode"!==t.node.getNodeType()&&"CSS3DNode"!==t.node.getNodeType()||u.containsObject(t.renderable)&&(u.remove(t.renderable),t.renderable.element.parentNode&&t.renderable.element.parentNode.removeChild(t.renderable.element)))}var ne,se=!!t.clippingContext,ae=!1,oe=_||c.clippingContext;if(oe&&oe._localCoordinates&&oe._updatePosition(t.matrix),t.clippingContext=oe?oe._mergeWithParent(e.clippingContext):e.clippingContext,t.clippingContext!==e.clippingContext&&(ae=!0),t.renderPriority!==e.renderPriority&&(ae=!0),t.clippingContext&&(t.renderable&&t.renderable._flagAsGSSOInvalidated(),se=!0),se&&(b||(b=e.getViewer()),b&&b._requestClippingUpdate()),I&&(e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride&&e.occurrenceRenderingOverride.materialOverride===I||(ae=!0)),ae){t.occurrenceRenderingOverride=new o,t.occurrenceRenderingOverride.clipPlanes=t.clippingContext&&t.clippingContext.planes,t.occurrenceRenderingOverride.sectionLinesProperties=t.clippingContext&&t.clippingContext.sectionLinesProperties,t.occurrenceRenderingOverride.sectionCappingMaterials=t.clippingContext&&t.clippingContext.sectionCappingMaterials,t.occurrenceRenderingOverride.clippingContext=t.clippingContext;var le=t.clippingContext&&t.clippingContext._scissor;t.occurrenceRenderingOverride.scissor=le&&(le.getForOccurrenceOverride?le.getForOccurrenceOverride(t.matrix):le),t.occurrenceRenderingOverride.materialOverride=I||e.occurrenceRenderingOverride&&e.occurrenceRenderingOverride.materialOverride,t.occurrenceRenderingOverride.setRenderPriority(t.renderPriority),t.clippingContext&&t.clippingContext._clipPolyLine&&t.clippingContext.isClippingProfileEnabled()&&(t.occurrenceRenderingOverride.clipPolyLine=t.clippingContext._clipPolyLine.getForOccurrenceOverride(t.matrix))}else t.occurrenceRenderingOverride=e.occurrenceRenderingOverride;if(t.renderable)if(t.renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride,Q=t.renderable.highlightMeshes)for(ne=0;ne<Q.length;ne++)Q[ne].renderable.occurrenceRenderingOverride=t.occurrenceRenderingOverride;for(t.renderable&&l&&(t.next=l.next,l instanceof C&&(l.next=t),t.next&&(t.next.prev=t),l instanceof C&&(t.prev=l),l=t),ne=0;ne<t.children.length;ne++)l=this._updateOccurrences(t,t.children[ne],r||c._isDynamic||T,s,a,l);return w&&e._invalidateBoundingElements(!1),l}},_getOccurrencesFromOccurrencePath:function(e){var t,i,r,n,s,a,o,l,h;if(!e.path.length)return[];if(null===(t=this.getChildByName(e.path[0]))&&(t=this.getChildByName(e.path[0],1)),null===t)return[];for(s=t._occurrences,a=[],h=1;h<e.path.length;h++){for(i=e.path[h],o=0;o<s.length;o++)for(r=s[o].children,l=0;l<r.length;l++)(n=r[l]).node.name===i&&a.push(n);s=a,a=[]}return s},_getRenderableOccurrencesFromOccurrencePath:function(e){var t,i,r,n,s,a;for(t=this._getOccurrencesFromOccurrencePath(e),i=[],s=0;s<t.length;s++)for(n=t[s],r=this._getRenderableOccurrencesFromOccurrence(n),a=0;a<r.length;a++)i.push(r[a]);return i},_getRenderableOccurrencesFromOccurrence:function(e){var t,i,r,n,s;for(t=[],i=e.children,null!==e.renderable&&t.push(e.renderable),n=0;n<i.length;n++)for(r=this._getRenderableOccurrencesFromOccurrence(i[n]),s=0;s<r.length;s++)t.push(r[s]);return t},_removeFromVisuSelection:function(e){t.publish({event:"/VISU/SELECTION/REMOVE",data:e})},_removeInvalidElementsInXSO:function(e){var t,i,r=[WUX.Selection.CSOManager,WUX.Selection.HSOManager,WUX.Selection.PSOManager];for(t=0;t<r.length;t++){var n=r[t],s=[],a=n.get();for(i=0;i<a.length;i++){var o=a[i],l=o.pathElement;if(!l&&o.options&&(l=o.options.pathElement),l){var h=l._getIndexFromNode(this);if(-1===h)l.getElement(0,!0);else l.getElement(h+1,!0)===e&&s.push(o)}}for(i=0;i<s.length;i++)n.remove(s[i])}},addAsyncDependancies:function(e){console.warn("The addAsyncDependancies function doesn't do anything anymore: it shouldn't be called anymore.")},onAsyncDependancyCompleted:function(){this._onAllAsyncDependanciesCompleted()},_onAllAsyncDependanciesCompleted:function(){void 0!==this.modelEvents&&this.modelEvents.publish("onReady")},_onLinkedToSceneGraph:function(){},_onUnlinkedToSceneGraph:function(){},setNoZ:function(e){this.setRenderPasses(e?["noz"]:["main"])},setNoEffectNoZ:function(e){this.setRenderPasses(e?["noEffectNoz"]:["main"])},setNoHighlightNoZ:function(e){this.setRenderPasses(e?["afterHighlightNoZ"]:["main"])},setAsNativeIsoBag:function(e){switch(e){case 0:this.setRenderPasses(["iso_0"]);break;case 2:this.setRenderPasses(["iso_2"]);break;case 3:this.setRenderPasses(["iso_3"]);break;case 1:default:this.setRenderPasses(["main"])}},getNativeIsoLevel:function(){if(!this.passes||!this.passes.length)return 1;switch(this.passes[0]){case"iso_0":return 0;case"main":return 1;case"iso_2":return 2;case"iso_3":return 3}},setAsNativeDialog:function(e){if(this.setRenderPasses(e?["dialog"]:["main"]),e){this.propagateXSOExclusion(!0),this.exludeFromBounding(!0),this.excludeFromHSO(!0),this.excludeFromHighlight(!0),this.excludeFromPSO(!0);var t=this.createOverrideSetManager(),i=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(i);var r=i.createOverride(new n([this])),s=new h([]);s.setUncut(!0),r.setClippingContext(s);var a=new d;a.setRenderMode("Face",!0),a.setRenderMode("@Edge",!1),a.setRenderMode("@Point",!1),a.setRenderMode("Outline",!1),a.setFaceMode("MATERIAL"),r.setRenderStyle(a)}else this.exludeFromBounding(!1),this.excludeFromHSO(!1),this.excludeFromHighlight(!1),this.excludeFromPSO(!1),this.enableLocalRenderEdgeMode(!1),this.removeOverrideSetManager();this._forceUpdate()},setAsNativeOnTop:function(e){this.setRenderPasses(e?["onTop"]:["main"]);let t=this._getViewer();t&&t.renderer.renderer.requestPoliteDepthBuffer()},setAsNativeFurtive:function(e){if(this.setRenderPasses(e?["furtive"]:["main"]),e){var t=this.createOverrideSetManager(),r=t.createSceneGraphOverrideSet();t.pushSceneGraphOverrideSet(r);var s=r.createOverride(new n([this])),a=new u({lineMaterial:new i.LineBasicMaterial({color:16760604,lineWidth:1}),faceMaterial:new i.MeshBasicMaterial({color:16760604}),pointMaterial:new i.ParticleBasicMaterial({color:16760604,size:1,opacity:1})});s.setMaterial(a,!0)}else this.removeOverrideSetManager()},setRenderPasses:function(e){var t,i=e.concat([]);for(t=0;t<e.length;t++)e[t]&&e[t]._getIdString&&(i[t]=e[t]._getIdString());var r=e=i;4===e.length&&e.indexOf("colorOld")>=0&&e.indexOf("depthOld")>=0&&e.indexOf("colorOldCapping")>=0&&e.indexOf("depthOldCapping")>=0&&(r=["compareOld"]),2===e.length&&e.indexOf("depthNew")>=0&&e.indexOf("depthNewCapping")>=0&&(r=["compareNew"]),this.passes=r,this._forceUpdate()},setRenderLineMode:function(e){var t=this._renderMode;t||((t=new c)._useRenderPointMask=!1,t._useRenderFaceMask=!1,this._renderMode=t),t._setRenderLineMode(e),this._requestOverridesUpdate()},enableLocalRenderEdgeMode:function(e){var t=null;e&&((t=new c({renderLineMode:i.HideAllRenderLineMode}))._useRenderFaceMask=!1,t._useRenderPointMask=!1),this._renderMode=t,this._requestOverridesUpdate()},setRenderMode:function(e,t){!e||e.indexOf("Edge")<0||this._renderMode&&(this._renderMode.setRenderMode(e,t),this._requestOverridesUpdate())},setAdvancedPriority:function(e){this._setAdvancedPriority(e)},setZDepthMode:function(e){this._setDepthMode(e)},setLayerFilter:function(e,t){if(this._layerFilter){switch(t){case i.FilterMode.Cumulative:for(r=0;r<e.length;r++)this._layerFilter[r]=this._layerFilter[r]&&(e[r]?1:0);break;case i.FilterMode.None:case i.FilterMode.Replace:case i.FilterMode.V4Master:default:if(1024!==e.length){this._layerFilter=new Array(1024);for(r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e}this._forceUpdate()}else{if(1024!==e.length){this._layerFilter=new Array(1024);for(var r=0;r<e.length;r++)this._layerFilter[r]=e[r]}else this._layerFilter=e;this._forceUpdate()}},setFiltered:function(e){e?this.setVisuFilters({filtered:new v(!0)}):this.setVisuFilters({filtered:null})},setPvmFilter:function(e){let t,i;if(e&&(t=e.mode,i=e.plane),null!=t&&null!=i){let e=new _(t,i);this.setVisuFilters({planeViewModeFilter:e})}else this.setVisuFilters({planeViewModeFilter:null})},setLayerNumber:function(e){this._layer=e,this._forceUpdate()},_propagateVisuFilters:function(e,t){if(t?(e._filters=new Map,t.forEach(function(t,i,r){var n=t&&t.solveInherit(e,null);n&&e._filters.set(i,n)})):e._filters=null,this._filters&&(e._filters=e._filters||new Map,this._filters.forEach(function(t,i,r){var n=t&&t.solveInherit(e,e._filters.get(i),!0);n&&e._filters.set(i,n)})),t&&t.has(M.LOD)){let i=t.get(M.LOD);e._filters=e._filters||new Map,e._filters.set(M._LOD_BRANCH,i._getContainer(e,e._filters.get(M._LOD_BRANCH)))}},setVisuFilters:function(e){this._filters||(this._filters=new Map);var t=!1;if(void 0!==e.gasInheritFilter&&(this._filters.set(M.GAS_INHERIT,e.gasInheritFilter),e.gasInheritFilter||this._filters.delete(M.GAS_INHERIT),t=!0),void 0!==e.polygonOffsetFilter&&(this._filters.set(M.POLYGON_OFFSET,e.polygonOffsetFilter),e.polygonOffsetFilter||this._filters.delete(M.POLYGON_OFFSET),t=!0),void 0!==e.zModeFilter&&(this._filters.set(M.ZMODE,e.zModeFilter),e.zModeFilter||this._filters.delete(M.ZMODE),t=!0),void 0!==e.noHighlightFilter&&(this._filters.set(M.NO_HIGHLIGHT,e.noHighlightFilter),e.noHighlightFilter||this._filters.delete(M.NO_HIGHLIGHT),t=!0),void 0!==e.lookFilter&&(this._filters.set(M.LOOK,e.lookFilter),e.lookFilter||this._filters.delete(M.LOOK),t=!0),void 0!==e.geomTypeFilter&&(this._filters.set(M.GEOM_TYPE,e.geomTypeFilter),(!e.geomTypeFilter||e.geomTypeFilter._geomType<0)&&this._filters.delete(M.GEOM_TYPE),t=!0),void 0!==e._staticGeomTypeFilter&&(this._filters.set(M._STATIC_GEOM_TYPE,e._staticGeomTypeFilter),(!e._staticGeomTypeFilter||e._staticGeomTypeFilter._geomType<0)&&this._filters.delete(M._STATIC_GEOM_TYPE),t=!0),void 0!==e._sideFilter&&(this._filters.set(M._SIDE,e._sideFilter),e._sideFilter||this._filters.delete(M._SIDE),t=!0),void 0!==e.dynamicModeFilter&&(this._filters.set(M.DYNAMIC_MODE,e.dynamicModeFilter),e.dynamicModeFilter||this._filters.delete(M.DYNAMIC_MODE),t=!0),void 0!==e.furtiveFilter&&(this._filters.set(M.FURTIVE,e.furtiveFilter),e.furtiveFilter||this._filters.delete(M.FURTIVE),t=!0),void 0!==e._materialToUseFilter&&(this._filters.set(M._MATERIAL_TO_USE,e._materialToUseFilter),(!e._materialToUseFilter||e._materialToUseFilter.materialToUse<0)&&this._filters.delete(M._MATERIAL_TO_USE),t=!0),void 0!==e.LOD&&(this._filters.set(M.LOD,e.LOD),e.LOD&&0!==e.LOD.lods.length||this._filters.delete(M.LOD),t=!0),void 0!==e.planeViewModeFilter&&(this._filters.set(M.PLANE_VIEW_MODE,e.planeViewModeFilter),e.planeViewModeFilter||this._filters.delete(M.PLANE_VIEW_MODE),t=!0),e.doNotPickUnderFilter&&(this._filters.set(M.DO_NOT_PICK_UNDER,e.doNotPickUnderFilter),t=!0),void 0!==e.filtered&&(this._filters.set(M.FILTERED,e.filtered),e.filtered||this._filters.delete(M.FILTERED),t=!0),t){var i=this._filters.has(M.DO_NOT_PICK_UNDER)&&!this._filters.get(M.DO_NOT_PICK_UNDER)._doNotPickUnder;i&&this._forceUpdate(),i&&this._filters.delete(M.DO_NOT_PICK_UNDER),this._filters.forEach((e,t)=>{if(e&&!(e instanceof m))throw"Invalid Data operation, filters must inherit from VisuFilter"}),0===this._filters.size&&(this._filters=null),this._forceUpdate()}},setPickingMode:function(e){this._pickingMode=e,this._requestOverridesUpdate()},getLocalBoundingBox:function(){if(y)return new i.Box3(new i.Vector3(0,0,0),new i.Vector3(0,0,0));var e=new i.Matrix4,t=new i.Matrix4,r=new i.Vector3,n=null,s=null,a=this._occurrences[0],o=a.matrix;e.getInverse(o);for(var l=a._getRenderableOccurrences(),h=0;h<l.length;h++){var c=l[h];t.multiplyMatrices(e,c.matrix);for(var d=0;d<c.geometry.length;d++){var u=c.geometry[d].vertexPositionArray;if(u){var p=u.length;if(p>=3){n||(r.set(u[0],u[1],u[2]),r.applyMatrix4(t),n=(new i.Vector3).copy(r),s=(new i.Vector3).copy(r));for(var f=0;f<p;f+=3)r.set(u[f],u[f+1],u[f+2]),r.applyMatrix4(t),r.x<n.x&&(n.x=r.x),r.y<n.y&&(n.y=r.y),r.z<n.z&&(n.z=r.z),r.x>s.x&&(s.x=r.x),r.y>s.y&&(s.y=r.y),r.z>s.z&&(s.z=r.z)}}}}return new i.Box3(n,s)},enableClippingPlane:function(e,t){var i,r;if(t){if(this.clippingContext||(this.clippingContext=new h),this.clippingContext.addPlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._addClippingPlane(e)}else if(this.clippingContext&&this.clippingContext.removePlane(e))for(this._forceUpdate(),r=this._getAllOwningViewers(),i=0;i<r.length;i++)r[i]._removeClippingPlane(e)},disableClipping:function(e){this.clippingContext||(this.clippingContext=new h),this.clippingContext.setExcludeFromClippingPlanes(e?["all"]:[]),this._forceUpdate()},setSectionCappingMaterial:function(e,t){this.clippingContext||(this.clippingContext=new h),this.clippingContext.setSectionCappingMaterial(e,t),this.requestOverridesUpdate()},deleteSectionCappingMaterial:function(e){if(this.sectionCappingMaterials){var t=e||null,i=0;for(i=0;i<this.sectionCappingMaterials.length;i++)this.sectionCappingMaterials[i].clippingPlane===t&&this.sectionCappingMaterials.splice(i,1);this.sectionCappingMaterials.length||(this.sectionCappingMaterials=null)}},getSectionCappingMaterial:function(e){return this.clippingContext&&this.clippingContext.getSectionCappingMaterial(e)},removeSectionCappingMaterial:function(e){this.clippingContext&&this.clippingContext.removeSectionCappingMaterial(e)},requestOverridesUpdate:function(){var e=0;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},excludeFromCSO:function(e){this._setExcludeFromCSO(e)},excludeFromHSO:function(e){this._setExcludeFromHSO(e)},excludeFromPSO:function(e){this._setExcludeFromPSO(e)},excludeFromHighlight:function(e,t){this._setExcludeFromHL(e),this._setExcludeFromPreHL(t)},propagateXSOExclusion:function(e){this._setPropagateXSOExclusion(e)},createRenderable:function(){return null},add:function(){this.addChild.apply(this,arguments)},remove:function(){this.removeChild.apply(this,arguments)},_requestOverridesUpdate:function(){var e;for(e=0;e<this._occurrences.length;e++)this._occurrences[e].requestOverridesUpdate()},_requestClippingUpdate:function(){var e,t=this._getAllOwningViewers();for(e=0;e<t.length;e++)t[e]._requestClippingUpdate()},setClippingCylinder:function(e,t){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}t&&(this.clippingContext._localCoordinates=!0),this.clippingContext.cylinder=e?{center:e.center,axisU:e.axisU.clone(),axisV:e.axisV.clone(),clipOutside:null===e.clipOutside||void 0===e.clipOutside||e.clipOutside}:null,this._requestClippingUpdate(),this._requestOverridesUpdate()},setScissoringPolyLine:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}e?this.clippingContext.setScissorPolyLine(!0,e):this.clippingContext.setScissorPolyLine(!1),this._requestClippingUpdate(),this._requestOverridesUpdate()},__applyOnOccurrences:function(e){for(var t=0;t<this._occurrences.length;t++)e(this._occurrences[t])},setClippingProfile:function(e){if(!this.clippingContext){if(!e)return;this.clippingContext=new h}e?this.clippingContext.setClippingProfile(e):this.clippingContext.setClippingProfile(null),this._requestClippingUpdate(),this._requestOverridesUpdate()},isPointOfViewDependant:function(){return!1},_setOverrideExistsTraverse:function(){!function e(t){var i;if(!t._getOverrideExists())for(t._setOverrideExists(!0),i=0;i<t.parents.length;i++)e(t.parents[i])}(this)},getPLMMaterialData:function(e){var t=this._PLMMaterialData;return e||null!==t||(this._PLMMaterialData=new p(this),t=this._PLMMaterialData),t},_getStaticOverrideSet:function(e){var t=this.getPLMMaterialData(!e);return t&&t._getStaticOverrideSet(e)},addStaticMaterialApplicationOverride:function(e,t){this._getStaticOverrideSet(!0).addStaticOverride(e,t),this._requestStaticOverridesUpdate()},clearStaticMaterialApplicationOverrides:function(){var e=this._getStaticOverrideSet();e&&(e.clear(),this._requestStaticOverridesUpdate())},_requestStaticOverridesUpdate:function(){var e,t;for(e=0;e<this._occurrences.length;e++)(t=this._occurrences[e].getViewer())&&(t._updateStaticOverrides=!0)},setLocalRenderEdgeMode:function(){this.setRenderMode.apply(this,arguments)},setUserData:function(e){this.userData=e},getUserData:function(e){return this.userData},_getTrianglesCount:function(e){let t=0;for(let i=0;i<this._occurrences.length;++i)t+=this._occurrences[i]._getTrianglesCount(e);return t},_modifyBE:function(e,t){return e}});E.prototype._isMesh3D=!1,E.prototype._isDecal=!1,E.prototype.__isProxy__=!1;var T=0;E._LockNodeHierarchy=function(){T++},E._UnlockNodeHierarchy=function(){T--},E._applyMaterialToPath=function(e,t){if(null===e)return!1;var i=e._getRenderableOccurrences(),r=i.length;for(s=0;s<r;s++)(a=i[s])&&a._flagAsGSSOInvalidated();var n=e.getLastElement();if(null===n)return!1;if(n instanceof E)for(var s=0;s<r;s++){var a=i[s];null!==t?(a.userData.oldMaterial||(a.userData.oldMaterial=a.material),a.material=t):a.userData.oldMaterial&&(a.material=a.userData.oldMaterial)}else{if(1!==r)return!1;var o=[];if("rep"===n.getType()){var l=n.getChildren();for(s=0;s<l.length;s++)o.push(l[s].sgNode)}else"primitive"===n.getType()&&o.push(n.sgNode);null===i[0].layer&&i[0].initLayers(1),i[0].layer.addPrimitivesToLayers(o,1,t)}return!0},E.DEPRECATED_SceneGraph=function(e,t){if(0!==S&&(console.log("[SceneGraph] DEPRECATED API USE\n"+e.stack),S--),!window.I_solemnly_swear_I_am_up_to_no_good&&!t)throw e},E.DEPRECATED_Method=function(e,t){0!==S&&(console.log("[Node3D] DEPRECATED API USE\n"+e.stack),S--)},E.DEPRECATED_matrix=function(e){0!==S&&(console.warn("Node3D API : use getMatrix() accessor instead of .matrix  "+e.stack),--S||console.warn("Node3D API : too many errors, no more errors will be reported."))},Object.defineProperty(E.prototype,"root",{get:function(){return E.DEPRECATED_SceneGraph(new Error),this}}),Object.defineProperty(E.prototype,"bSphere",{get:function(){return this.getHasExplicitBE()&&0===this.children.length?this.explicitBSphere:this.getBoundingSphere()},set:function(e){if(!this.getHasExplicitBE())throw new Error("bSphere is read-only");this.explicitBSphere=e}}),Object.defineProperty(E.prototype,"bBox",{get:function(){return(this.getHasExplicitBE()||this.hasExplicitBE)&&0===this.children.length?this.explicitBBox:this.getBoundingBox()},set:function(e){if(!this.getHasExplicitBE()&&!this.hasExplicitBE)throw new Error("bBox is read-only");this.explicitBBox=e}}),Object.defineProperty(E.prototype,"matrix",{get:function(){return E.DEPRECATED_matrix(new Error),this._matrix},set:function(e){E.DEPRECATED_matrix(new Error),this._matrix=e}});var A=30;E.FORBIDDEN_ACCESS_occurrences=function(e){0!==A&&(console.log("[Node3D] INTERNAL PROPERTY ACCESS\nAccess to 'occurrences' member is strictly forbidden.\nYou must use authorized APIs.\nIf you are trying to create a pathElement using setFromOccurrence, please consider using ?new PathElement([node3d])? instead.\n"+e.stack),A--)},Object.defineProperty(E.prototype,"occurrences",{get:function(){return E.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences},set:function(e){E.FORBIDDEN_ACCESS_occurrences(new Error),this._occurrences=e}}),Object.defineProperty(E.prototype,"clippingPlanes",{get:function(){return this.clippingContext&&this.clippingContext.planes},set:function(){}});var D=[["renderPriority","p0"],["renderPriority","p1"],["renderPriority","p2"],["renderPriority","p3"],["renderPriority","p4"]];E.REFERENCE_NODE=-1,E.INSTANCE_NODE=-2,E.REPRESENTATION_NODE=-3,E.TILESET_NODE=-4,E._onLinkToSceneGraph_DEBUG=null;var I=1,R=2,O=4,L=8,V=16,F=32,B=64,N=128,G=256,k=512,U=1024,z=2048,H=4096,W=8192,j=16384,X=32768,q=65536,Z=1<<17;function Y(e){return function(){return(this.occBooleanAttr&e)>0}}function Q(e){return function(t){this.occBooleanAttr=t?this.occBooleanAttr|e:this.occBooleanAttr&~e}}C.prototype._getVisible=Y(I),C.prototype._setVisible=Q(I),C.prototype._getVisibilityFree=Y(R),C.prototype._setVisibilityFree=Q(R),C.prototype._getPickable=Y(O),C.prototype._setPickable=Q(O),C.prototype._getNoZPriority=Y(N),C.prototype._setNoZPriority=Q(N),C.prototype.getNoPickThrough=Y(L),C.prototype.setNoPickThrough=Q(L),C.prototype._getNeedBEUpdate=Y(V),C.prototype._setNeedBEUpdate=Q(V),C.prototype._getNeedOverridesUpdate=Y(F),C.prototype._setNeedOverridesUpdate=Q(F),C.prototype._getDescendantNeedsOverridesUpdate=Y(B),C.prototype._setDescendantNeedsOverridesUpdate=Q(B),C.prototype._getForceShowHide=Y(G),C.prototype._setForceShowHide=Q(G),C.prototype._getForceShowNoPickability=Y(k),C.prototype._setForceShowNoPickability=Q(k),C.prototype._getForceShowNoDrawHL=Y(U),C.prototype._setForceShowNoDrawHL=Q(U),C.prototype.isInBackground=Y(z),C.prototype.setIsInBackground=Q(z),C.prototype._isAlwaysInForeground=Y(H),C.prototype._setIsAlwaysInForeground=Q(H),C.prototype._getAdvancedPriority=Y(j),C.prototype._setAdvancedPriority=Q(j),C.prototype._getDepthMode=Y(W),C.prototype._setDepthMode=Q(W),C.prototype._getInvertMode=Y(X),C.prototype._setInvertMode=Q(X),C.prototype._getInvertPickMode=Y(q),C.prototype._setInvertPickMode=Q(q),C.prototype._getFrom3dxml=Y(Z),C.prototype._setFrom3dxml=Q(Z),C.prototype._copyForceShowStatusFromOcc=function(e){var t=G|k|U;this.occBooleanAttr=this.occBooleanAttr&~t|e.occBooleanAttr&t},C.prototype._getTrianglesCount=function(e){let t=0;if(this._getVisible()===e||!e){if(this.renderable)if(this.renderable.layer){var i=this.renderable.layer.layers;if(i)for(var r=0;r<i.length;r++){var n=i[r].drawableGroup;n&&4===n.glType&&(t+=n.count/3)}}else if(this.renderable.geometry)for(let e=0;e<this.renderable.geometry.length;++e)for(var s=this.renderable.geometry[e],a=0;a<s.drawingGroups.length;++a){let e=s.drawingGroups[a];e&&4===e.glType&&(t+=e.count/3)}for(let i=0;i<this.children.length;++i)t+=this.children[i]._getTrianglesCount(e)}return t},C.prototype._getPreviousRenderableOcc=function(e){let t=null,i=this;for(;!t;){let r=i.parent;if(!r||i===e)return null;let n=r.children.length,s=null;for(let e=0;e<n-1;++e)if(r.children[e+1]===i){s=r.children[e];break}if(s)t=s._getLastRenderableOcc(),i=s;else{if(r.renderable)return r;i=r}}return t},C.prototype._getNextRenderableOcc=function(e){let t=this,i=null;for(;!i;){let r=t.parent;if(!r||t===e)return null;let n=r.children.length,s=null;for(let e=0;e<n-1;++e)if(r.children[e]===t){s=r.children[e+1];break}s?(i=s._getFirstRenderableOcc())||(t=s):t=r}return i},C.prototype._getFirstRenderableOcc=function(){let e=this;for(;!e.renderable;){if(0===e.children.length)return e._getNextRenderableOcc(this);e=e.children[0]}return e},C.prototype._getLastRenderableOcc=function(){let e=this,t=e.children.length;for(;t>0;)t=(e=e.children[t-1]).children.length;return e.renderable?e:e._getPreviousRenderableOcc(this)},C.prototype._unlinkRenderableOccs=function(){let e=this._getFirstRenderableOcc();if(!e)return;let t=this._getLastRenderableOcc(),i=null;e.prev&&(e.prev.next=t.next,i=e.prev,e.prev=null),t.next&&(t.next.prev=i,t.next=null)},Object.defineProperty(C.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(C.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(C.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(C.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(C.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(C.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(C.prototype,"_needOverridesUpdate",{get:function(){return this._getNeedOverridesUpdate()},set:function(e){this._setNeedOverridesUpdate(e)}}),Object.defineProperty(C.prototype,"_descendantNeedsOverridesUpdate",{get:function(){return this._getDescendantNeedsOverridesUpdate()},set:function(e){this._setDescendantNeedsOverridesUpdate(e)}}),E.SceneGraphOverrideSetManager=null;var K=1,$=2,J=4,ee=8,te=16,ie=32,re=64,ne=128,se=256,ae=512,oe=1024,le=2048,he=4096,ce=8192,de=16384,ue=32768,pe=65536,fe=1<<17,ge=1<<18,me=1<<19,ve=1<<20,_e=1<<21,ye=1<<22,Se=1<<23,xe=1<<24,be=1<<25,we=1<<26,Me=1<<27,Ce=1<<28,Pe=1<<29,Ee=1<<30,Te=1,Ae=2,De=4,Ie=8;function Re(e){return function(){return(this.node3DBooleanAttr&e)>0}}function Oe(e){return function(t){this.node3DBooleanAttr=t?this.node3DBooleanAttr|e:this.node3DBooleanAttr&~e}}function Le(e){return function(){return(this.node3DBooleanAttr2&e)>0}}function Ve(e){return function(t){this.node3DBooleanAttr2=t?this.node3DBooleanAttr2|e:this.node3DBooleanAttr2&~e}}function Fe(e,t,i,r,n,s,a){return!s&&!a&&(!(!n||!t)||e&&(t?i:r))}return E.prototype.getLinkedToSceneGraph=Re(K),E.prototype.setLinkedToSceneGraph=Oe(K),E.prototype._getForceBoundingElements=Re($),E.prototype._setForceBoundingElements=Oe($),E.prototype.getExcludeFromBounding=Re(J),E.prototype.setExcludeFromBounding=Oe(J),E.prototype._getNeedBEUpdate=Re(ee),E.prototype._setNeedBEUpdate=Oe(ee),E.prototype._getVisible=Re(te),E.prototype._setVisible=Oe(te),E.prototype._getVisibilityFree=Re(ie),E.prototype._setVisibilityFree=Oe(ie),E.prototype._getPickable=Re(re),E.prototype._setPickable=Oe(re),E.prototype._getNoZPriority=Re(ge),E.prototype._setNoZPriority=Oe(ge),E.prototype.getNoPickThrough=Re(ne),E.prototype.setNoPickThrough=Oe(ne),E.prototype._getPickParent=Re(se),E.prototype._setPickParent=Oe(se),E.prototype._getTreeModified=Re(ae),E.prototype.__setTreeModified=Oe(ae),E.prototype.getNotAllowedInPathElement=Re(oe),E.prototype.setNotAllowedInPathElement=Oe(oe),E.prototype._getVisibilityInTree=Re(le),E.prototype._setVisibilityInTree=Oe(le),E.prototype.getIsManipulator=Re(he),E.prototype.setIsManipulator=Oe(he),E.prototype._getExcludeFromCSO=Re(fe),E.prototype._setExcludeFromCSO=Oe(fe),E.prototype._getExcludeFromHSO=Re(ce),E.prototype._setExcludeFromHSO=Oe(ce),E.prototype._getExcludeFromPSO=Re(de),E.prototype._setExcludeFromPSO=Oe(de),E.prototype._getExcludeFromHL=Re(pe),E.prototype._setExcludeFromHL=Oe(pe),E.prototype._getExcludeFromPreHL=Re(ue),E.prototype._setExcludeFromPreHL=Oe(ue),E.prototype._getPropagateXSOExclusion=Re(Se),E.prototype._setPropagateXSOExclusion=Oe(Se),E.prototype._getOverrideExists=Re(ve),E.prototype._setOverrideExists=Oe(ve),E.prototype._getDisablePrimPicking=Re(me),E.prototype._setDisablePrimPicking=Oe(me),E.prototype._getDepthMode=Re(we),E.prototype._setDepthMode=Oe(we),E.prototype._getAdvancedPriority=Re(Me),E.prototype._setAdvancedPriority=Oe(Me),E.prototype._getInvertMode=Re(Ce),E.prototype._setInvertMode=Oe(Ce),E.prototype._getInvertPickMode=Re(Pe),E.prototype._setInvertPickMode=Oe(Pe),E.prototype._getForbidHierarchyUpdate=Re(Ee),E.prototype._setForbidHierarchyUpdate=Oe(Ee),E.prototype.isInBackground=Re(xe),E.prototype.setIsInBackground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|xe:this.node3DBooleanAttr&~xe,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];if(i.parent)this._updateOccurrences(i.parent,i);else{i.setIsInBackground(e);for(let e=0;e<i.children.length;e++)this._updateOccurrences(i,i.children[e])}}},E.prototype._isAlwaysInForeground=Re(be),E.prototype._setIsAlwaysInForeground=function(e){if(this.node3DBooleanAttr=e?this.node3DBooleanAttr|be:this.node3DBooleanAttr&~be,this._occurrences)for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t];i.parent?this._updateOccurrences(i.parent,i):i._setIsAlwaysInForeground(e)}},E.prototype._getOverrideSetManagerUnder=function(){return(this.node3DBooleanAttr&_e)>0},E.prototype._setOverrideSetManagerUnder=function(){var e;for(this.node3DBooleanAttr=this.node3DBooleanAttr|_e,e=0;e<this.parents.length;e++)this.parents[e]._setOverrideSetManagerUnder()},E.prototype.getHasExplicitBE=function(){return!1},E.prototype._getForceShowMode=function(){return(this.node3DBooleanAttr&ye)>0},E.prototype._setForceShowMode=function(e){var t=e;e?t||this.traverse(e=>{e.node3DBooleanAttr=e.node3DBooleanAttr|ye}):t&&this.traverse(e=>{e.node3DBooleanAttr=e.node3DBooleanAttr&~ye})},E.prototype._getNoGASOnPrimitives=Le(Te),E.prototype._setNoGASOnPrimitives=Ve(Te),E.prototype._getPixelCullingFromParent=Le(Ae),E.prototype._setPixelCullingFromParent=function(e){this.node3DBooleanAttr2=e?this.node3DBooleanAttr2|Ae:this.node3DBooleanAttr2&~Ae;for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable._updateWorldCenterAndRadius()}},E.prototype._getNoCullingBE=Le(De),E.prototype._setNoCullingBE=Ve(De),E.prototype.getPrimitivePicking=Le(Ie),E.prototype.setPrimitivePicking=Ve(Ie),Object.defineProperty(E.prototype,"material",{get:function(){return this.getMaterial()},set:function(e){console.warn("do not use node.material=myMaterial but node.setMaterial(myMaterial)"),this.setMaterial(e)}}),Object.defineProperty(E.prototype,"linkedToSceneGraph",{get:function(){return this.getLinkedToSceneGraph()},set:function(e){this.setLinkedToSceneGraph(e)}}),Object.defineProperty(E.prototype,"_forceBoundingElements",{get:function(){return this._getForceBoundingElements()},set:function(e){this._setForceBoundingElements(e)}}),Object.defineProperty(E.prototype,"excludeFromBounding",{get:function(){return this.getExcludeFromBounding()},set:function(e){this.setExcludeFromBounding(e)}}),Object.defineProperty(E.prototype,"_needBEUpdate",{get:function(){return this._getNeedBEUpdate()},set:function(e){this._setNeedBEUpdate(e)}}),Object.defineProperty(E.prototype,"visible",{get:function(){return this._getVisible()},set:function(e){this._setVisible(e)}}),Object.defineProperty(E.prototype,"visibilityFree",{get:function(){return this._getVisibilityFree()},set:function(e){this._setVisibilityFree(e)}}),Object.defineProperty(E.prototype,"pickable",{get:function(){return this._getPickable()},set:function(e){this._setPickable(e)}}),Object.defineProperty(E.prototype,"drawInHLRender",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(E.prototype,"noPickThrough",{get:function(){return this.getNoPickThrough()},set:function(e){this.setNoPickThrough(e)}}),Object.defineProperty(E.prototype,"pickParent",{get:function(){return this._getPickParent()},set:function(e){this._setPickParent(e)}}),Object.defineProperty(E.prototype,"_treeModified",{get:function(){return this._getTreeModified()},set:function(e){this.__setTreeModified(e)}}),Object.defineProperty(E.prototype,"notAllowedInPathElement",{get:function(){return this.getNotAllowedInPathElement()},set:function(e){this.setNotAllowedInPathElement(e)}}),Object.defineProperty(E.prototype,"_visibilityInTree",{get:function(){return this._getVisibilityInTree()},set:function(e){this._setVisibilityInTree(e)}}),Object.defineProperty(E.prototype,"isManipulator",{get:function(){return this.getIsManipulator()},set:function(e){this.setIsManipulator(e)}}),Object.defineProperty(E.prototype,"_excludeFromCSO",{get:function(){return this._getExcludeFromCSO()},set:function(e){this._setExcludeFromCSO(e)}}),Object.defineProperty(E.prototype,"_excludeFromHSO",{get:function(){return this._getExcludeFromHSO()},set:function(e){this._setExcludeFromHSO(e)}}),Object.defineProperty(E.prototype,"_excludeFromPSO",{get:function(){return this._getExcludeFromPSO()},set:function(e){this._setExcludeFromPSO(e)}}),Object.defineProperty(E.prototype,"_excludeFromHL",{get:function(){return this._getExcludeFromHL()},set:function(e){this._setExcludeFromHL(e)}}),Object.defineProperty(E.prototype,"_excludeFromPreHL",{get:function(){return this._getExcludeFromPreHL()},set:function(e){this._setExcludeFromPreHL(e)}}),UWA.namespace("THREEDS/Nodes/Node3D",E)}),define("Visualization/Node3D",["DS/Visualization/Node3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Node3D"),e}),define("DS/Visualization/VolumeRenderingManagerSimple",["UWA/Class","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Node3D"],function(e,t,i,r){"use strict";for(var n=null,s=function(e,t){for(var i=t||1;i<e;)i*=2;return i},a=[],o={},l={},h=0;h<7;h++){var c=Math.pow(2,h+2);a[h]=c*s(Math.ceil(Math.sqrt(c))),o[a[h]]=h,l[c]=h}var d=[16384,4096,1024,512,512,128,128],u=[0,0,0,0,0,0,0];window.nbTextures=[0,0,0,0,0,0,0];var p=[];window.nbCallsToFreeTexture=0;var f=function(e){nbCallsToFreeTexture++;var t=l[e];return p[t].length?p[t].pop():nbTextures[t]<d[t]?m(!0,a[t],a[t]):null},g=function(e,t){var i=Math.log2(t)-2;p[i].push(e)},m=function(e,i,r,s){var a,l=!s;if(l){a=new Uint8Array(i*r*(e?1:4));for(var h=0;h<i*r;h++)e?a[h]=0:(a[4*h]=0,a[4*h+1]=0,a[4*h+2]=0,a[4*h+3]=255)}else{a=new Float32Array(i*r);for(h=0;h<i*r;h++)a[h]=0}var c=new t.DataTexture(a,i,r,l?e?t.AlphaFormat:t.RGBAFormat:t.LuminanceFormat,l?t.UnsignedByteType:t.FloatType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter);return c.generateMipmaps=!1,c.needsUpdate=!0,e&&void 0!==o[i]&&nbTextures[o[i]]++,n.setTexture(c,0),c};return e.extend({init:function(e){n=e.renderer.renderer,this.viewer=e,this.camera=null,function(){for(var e=0;e<7;e++){p[e]=[];for(var t=Math.pow(2,e+2),i=t*s(Math.ceil(Math.sqrt(t))),r=0;r<u[e];r++){var n=m(!0,i,i);p[e].push(n)}}}(),this.maxAllowedSize=4294967296,this.loadedSize=0,this.debugMemoryMap=null,this.pathToModel="",this.modelLoader=null,this.rootNode=new r,this.volumeChunks=[],this.overrideRange=!1,this.minValue=0,this.maxValue=1,this.tileSetRange=[0,1],this.invisibleRanges=[],this.clipPlane=null,this.colorMap=m(!1,2,1),this.colorData=null,this.transferFunctionMap=m(!1,1024,1,!0);for(var t=0;t<1024;t++)this.transferFunctionMap.image.data[t]=.5;return this.transferFunctionMap.needsUpdate=!0,this.binnedMap=m(!1,1024,512,!1),this.binnedValues=new Uint32Array(256),this.binnedMaxValue=0,this.needsRender=!0,this},sortChunks:function(e){var i=new t.Vector3,r=e.position;this.volumeChunks.sort(function(e,t){return i.subVectors(e.data.position,r).length()-i.subVectors(t.data.position,r).length()})},update:function(e){var t=e._renderedCamera;t&&(this.camera=t,t.matrixWorldInverse.getInverse(t.matrixWorld),this.sortChunks(t))},updateTransferFunction:function(e){for(var t=this.transferFunctionMap.image.data,i=1;i<e.length;i++)for(var r=e[i-1],n=Math.floor(1024*r.position),s=r.value,a=e[i],o=1024*a.position,l=a.value,h=(l-s)/(o-n),c=l-h*o,d=n;d<o;d++)t[d]=h*d+c;this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateTransferFunctionRaw:function(e){var t=this.transferFunctionMap.image.data,i=1023/(e.length-1);if(i>=1)for(var r=1;r<e.length;r++)for(var n=e[r],s=e[r-1],a=Math.floor(i*r),o=Math.floor(i*(r-1)),l=(n-s)/(a-o),h=n-l*a,c=o;c<=a;c++)t[c]=l*c+h;else for(r=0;r<1024;r++)t[r]=e[Math.floor(r/i)];this.updateInvisibleRanges(),this.transferFunctionMap.needsUpdate=!0},updateInvisibleRanges:function(){this.invisibleRanges=[];for(var e=this.transferFunctionMap.image.data,t=null,i=0;i<e.length;i++)0===e[i]?t||(t=[i,i],this.invisibleRanges.push(t)):t&&(t[1]=i,t=null);t&&(t[1]=1023);for(i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];r[0]=this.minValue+r[0]/1023*(this.maxValue-this.minValue),r[1]=this.minValue+r[1]/1023*(this.maxValue-this.minValue)}},updateBinnedValues:function(e){if(e&&e.data){var t=e.data.voxelRepartition;if(t)for(var i=255*this.minValue/(this.tileSetRange[1]-this.tileSetRange[0]),r=255*this.maxValue/(this.tileSetRange[1]-this.tileSetRange[0]),n=0;n<256;n++)this.binnedValues[n]+=t[Math.floor(i+(r-i)*n/255)],this.binnedValues[n]>this.binnedMaxValue&&(this.binnedMaxValue=this.binnedValues[n])}},updateBinnedMap:function(){for(var e,t,i,r=this.binnedMap.image.data,n=this.colorMap.image.width,s=0;s<1024;s++){var a=Math.round((n-1)*s/1023);this.colorData?(e=this.colorData[4*a],t=this.colorData[4*a+1],i=this.colorData[4*a+2]):(e=255,t=255,i=255);for(var o=this.transferFunctionMap.image.data[s],l=this.binnedValues[Math.round(.25*s)]/this.binnedMaxValue,h=0;h<512;h++){var c=1024*h+s,d=512*o>512-h,u=512*l>512-h,p=u?e:255;p*=d?.8:1;var f=u?t:255;f*=d?.8:1;var g=u?i:255;g*=d?.8:1,r[4*c]=p,r[4*c+1]=f,r[4*c+2]=g,r[4*c+3]=255}}this.binnedMap.needsUpdate=!0},setTileSetRange:function(e){this.tileSetRange=[e[0],e[1]]},setMinValue:function(e){this.overrideRange=!0,this.minValue=e},setMaxValue:function(e){this.overrideRange=!0,this.maxValue=e},setColorMap:function(e){var i=this;this.colorMap=t.ImageUtils.loadTexture(e,new t.UVMapping),this.colorMap.onLoadCallbacks.push(function(e){var t=e.image,r=document.createElement("canvas");r.width=t.width,r.height=t.height;var n=r.getContext("2d");n.drawImage(t,0,0),i.colorData=n.getImageData(0,0,t.width,1).data})},setColorMapRaw:function(e){for(var i=new Uint8Array(4*e.length),r=new t.Color,s=0;s<e.length;s++)r.set(e[s]),i[4*s]=255*r.r,i[4*s+1]=255*r.g,i[4*s+2]=255*r.b,i[4*s+3]=255;this.colorMap=new t.DataTexture(i,e.length,1,t.RGBAFormat,t.UnsignedByteType,new t.LatLongReflectionMapping,t.ClampToEdgeWrapping,t.ClampToEdgeWrapping,t.LinearFilter,t.LinearFilter),this.colorMap.generateMipmaps=!1,this.colorMap.needsUpdate=!0,n.setTexture(this.colorMap,0),this.colorData=this.colorMap.image.data},computeChunkVoxelDensity:function(e,t){var i=t.data.position,r=e.pixelCullingCst/e.pixelCulling;if(!e.isOrtho){var n=e.matrixWorldInverse.elements;r*=Math.abs(n[2]*i.x+n[6]*i.y+n[10]*i.z+n[14])}var s=t.data.radius/r,a=t.data.mapDim,o=Math.pow(a.x*a.y*a.z,1/3);return t.data._voxelDensity=s/o,s},freeChunk:function(e){var t=e.data;if(null!==t&&0!==e.lastTimeLoaded){var i=t.mapData.data?t.mapData.data.byteLength:t.buffer.byteLength;this.loadedSize-=i,t.map&&g(t.map,t.chunkSize),e.data=null,e.isLoaded=!1,e.isLoading=!1,e.lastTimeLoaded=0}},getTexturePool:function(){return p},getFreeTexture:function(e){var t=f(e.data.chunkSize);if(t)return t;for(var i=0;i<this.volumeChunks.length;i++){var r=this.volumeChunks[i];if(r!==e&&(r.data&&r.data.map&&r.data.chunkSize===e.data.chunkSize)){var n=r.data.map;return r.data.map=null,n}}return null},isRangeVisible:function(e){var t=this.maxValue-this.minValue;if((e.max-e.min)/t<.005)return!1;if(e.min>this.maxValue||e.max<this.minValue)return!1;for(var i=0;i<this.invisibleRanges.length;i++){var r=this.invisibleRanges[i];if(e.min>r[0]&&e.max<r[1])return!1}return!0},getVolumeData:function(e,i){var r=e.targetSGNode;if(i){for(var n=0;n<r.children.length;n++)if("VoxelVolumeNode"===r.children[n].getNodeType()){r=r.children[n];break}}else for(;r.children[0];)r=r.children[0];var s=r.volumeData;if(s){var a=s.mapData.data?s.mapData.data.byteLength:s.buffer.byteLength;this.loadedSize+=a;var o=e.node._boundingBox,l=new t.Vector3(o.max.x-o.min.x,o.max.y-o.min.y,o.max.z-o.min.z),h=new t.Vector3(.5*(o.max.x+o.min.x),.5*(o.max.y+o.min.y),.5*(o.max.z+o.min.z));s.position=h;var c=new t.Vector3;s.radius=.5*o.size(c).length(),s.gridSize=new t.Vector3(l.x,l.y,l.z),s.modelMatrix=(new t.Matrix4).makeTranslation(h.x,h.y,h.z),s.tileSetRange.min=this.tileSetRange[0],s.tileSetRange.max=this.tileSetRange[1];var d=this.tileSetRange[1]-this.tileSetRange[0];s.valueRange.min=this.tileSetRange[0]+d*s.valueRange.min,s.valueRange.max=this.tileSetRange[0]+d*s.valueRange.max,e.data=s,r.volumeData=null}},addChunk:function(e){return!(!e||!e.data)&&(this.volumeChunks.push(e),!0)},removeChunk:function(e){if(!e||!e.data)return!1;var t=this.volumeChunks.indexOf(e);return-1!==t&&(this.volumeChunks.splice(t,1),e.data.map&&g(e.data.map,e.data.chunkSize),e.data.map=null,!0)},loadChunk:function(e,i,s){if(this.modelLoader&&!i.isLoaded){i.isLoading=!0;var a=this,o=new r(e);this.rootNode.addChild(o),this.modelLoader.setOnErrorCallback(function(){0,0,i.isLoading=!1,i.isLoaded=!0,a.needsRender=!0}),this.modelLoader.setOnLoadedCallback(function(e){0,0,i.isLoading=!1,i.isLoaded=!0,a.needsRender=!0;for(var r=o;r.children[0];)r=r.children[0];var l=r.volumeData;if(l){var h=l.mapData.data?l.mapData.data.byteLength:l.buffer.byteLength;a.loadedSize+=h;var c=i.extent,d=new t.Vector3(c[1][0]-c[0][0],c[1][1]-c[0][1],c[1][2]-c[0][2]),u=new t.Vector3(c[1][0]+c[0][0],c[1][1]+c[0][1],c[1][2]+c[0][2]);l.gridSize=new t.Vector3(d.x,d.y,d.z),l.modelMatrix=(new t.Matrix4).makeTranslation(.5*u.x,.5*u.y,.5*u.z),i.data=l,i.data.map=f(l.chunkSize),i.data.map&&(i.data.map.image=i.data.mapData,i.data.map.needsUpdate=!0,n.setTexture(i.data.map,0)),r.volumeData=null,s&&s(i)}}),0,this.modelLoader.loadModel({provider:"FILE",serverurl:"",filename:this.pathToModel+e,requiredAuth:null,proxyurl:"none",loaderSettings:{volumeChunkType:"uint8"}},o)}}})}),define("DS/Visualization/OccurrenceExplorer",["UWA/Class","DS/Visualization/OccurrenceInterface","DS/Visualization/Node3D","DS/Visualization/OccurrenceInterfaceFactory"],function(e,t,i,r){"use strict";var n=e.extend({init:function(e){this.viewer=e},explore:function(e){e&&this._exploreInternal(null,e)},exploreQuick:function(e,t){e&&t&&this._exploreInternal(e,t)},_exploreInternal:function(e,t){var n=new s,a=new r(n,this.viewer);i._LockNodeHierarchy();try{if(e)t(a.getOccurrenceItf(e),a);else t(a);i._UnlockNodeHierarchy(),n.cleanUp()}catch(e){throw i._UnlockNodeHierarchy(),n.cleanUp(),e}}}),s=function(){this._occurrenceList=[],this._occurrenceInterfaceList=[]};return s.prototype.cleanUp=function(){this._occurrenceList=null,this._occurrenceInterfaceList=null},s.prototype.getOccurrenceInterface=function(e){if(!e||!this._occurrenceList)return null;this._occurrenceList[e.node.id]||(this._occurrenceList[e.node.id]=[]);var i,r,n=this._occurrenceList[e.node.id],s=-1;for(r=0;s<0&&r<n.length;r++)n[r].occurrence===e&&(s=n[r].index);return s<0?(i=new t(e.node.id,n.length,this),n.push({occurrence:e,index:this._occurrenceInterfaceList.length}),this._occurrenceInterfaceList.push(i)):i=this._occurrenceInterfaceList[s],i},n}),define("DS/Visualization/Mesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n){"use strict";var s=0,a=e.NoOccurrences;const o=new e.Vector3(0,0,0);var l=t.extend({init:function(t,i){this._parent(i),this.mesh3DBooleanAttr=0,this.setHasExplicitBE(!0),this.explicitBSphere=new e.Sphere,this.explicitBBox=new e.Box3,this.mesh3js=void 0!==t?t:new e.Mesh,this.setIsInstanceNode3D(!1),this.nbInstances=0,this._bodyDim=0,this._ratioData={ratio:0,center:o,cameraName:null},this._billboardData={type:0,axis:null,rotation:null},this.mesh3js.matrixAutoUpdate=!1,this.mesh3js.matrixWorldNeedsUpdate=!1;var r=this._occurrences[0];if(a||(r.renderable=this.mesh3js,r.renderable.name=this.name,r.renderable._occurrence=r),this.mesh3js.geometry.boundingSphere&&this.explicitBSphere.copy(this.mesh3js.geometry.boundingSphere),this.mesh3js.geometry.boundingBox)this.explicitBBox.copy(this.mesh3js.geometry.boundingBox);else{var n=new e.Vector3(2*this.explicitBSphere.radius,2*this.explicitBSphere.radius,2*this.explicitBSphere.radius);this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,n)}if(!e.disableJHGDev){var s=t.geometry;(1===s._type||s.length>0&&1===s[0]._type)&&t.material&&this.setMaterial(t.material)}return this._updateBEInternal(),this},_linkingClone:function(i,r){return i=i||new l(e.Mesh.DuplicateMesh(this.mesh3js,{ignoreVisibility:!!r}),this.name),t.prototype._linkingClone.call(this,i),i.mesh3DBooleanAttr=this.mesh3DBooleanAttr,i._bodyDim=this._bodyDim,i._ratioData=this._ratioData,i._billboardData=this._billboardData,i.nbInstances=this.nbInstances,i._updateBEInternal(),i},getRatio:function(){return this._ratioData.ratio},getFixedSizeCenter:function(){return this._ratioData.center.clone()},setRatio:function(e){if(e!==this._ratioData.ratio&&(r=this._occurrences[0])){var t=r.renderable;if(t){this._ratioData.ratio=e,this.explicitBBox.copy(t.geometry.boundingBox),this.explicitBSphere.copy(t.geometry.boundingSphere),this._updateBEInternal();for(var i=0;i<this._occurrences.length;i++){var r;null!==(r=this._occurrences[i]).renderable&&r.renderable._updateWorldCenterAndRadius()}this._flagAsGSSOInvalidated()}}},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var s=n[r];this._occurrences[r]=s,s._compactChildrenArray(t)}this.mesh3js&&this.mesh3js._compactArrays(t)}},setBillboardData:function(e,t,i){if(s=this._occurrences[0]){var r=s.renderable;if(r){this._billboardData.type=e,this._billboardData.axis=t,this._billboardData.rotation=i,this.explicitBBox.copy(r.geometry.boundingBox),this.explicitBSphere.copy(r.geometry.boundingSphere),this._updateBEInternal();for(var n=0;n<this._occurrences.length;n++){var s;null!==(s=this._occurrences[n]).renderable&&s.renderable._updateWorldCenterAndRadius()}this._flagAsGSSOInvalidated()}}},setFixedSizeCenter:function(e,t){if(n=this._occurrences[0]){var i=n.renderable;if(i){this._ratioData.center=e?e.clone():o,e&&t&&this._ratioData.center.multiplyScalar(t),this.explicitBBox.copy(i.geometry.boundingBox),this.explicitBSphere.copy(i.geometry.boundingSphere),this._updateBEInternal();for(var r=0;r<this._occurrences.length;r++){var n;null!==(n=this._occurrences[r]).renderable&&n.renderable._updateWorldCenterAndRadius()}this._flagAsGSSOInvalidated()}}},setFixedSizeCameraName:function(e){this._ratioData.cameraName=e||"camera",this._flagAsGSSOInvalidated()},_setRatio:function(e){this.setRatio(e)},_setFixedSizeCameraName:function(e){this.setFixedSizeCameraName(e)},_setBillboardData:function(e,t,i){this.setBillboardData(e,t,i)},_setFixedSizeCenter:function(e,t){this.setFixedSizeCenter(e,t)},_updateBEInternal:function(){if(0!==this._billboardData.type&&(this.explicitBSphere&&(this.explicitBSphere.radius+=this.explicitBSphere.center.length(),this.explicitBSphere.center.set(0,0,0),this.explicitBBox&&this.explicitBBox.setFromCenterAndSize(this.explicitBSphere.center,this.explicitBSphere.radius)),!this.explicitBSphere&&this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0))),this._ratioData.ratio>0&&(this.explicitBBox&&(this.explicitBBox.max=new e.Vector3(0,0,0),this.explicitBBox.min=new e.Vector3(0,0,0)),this.explicitBSphere)){var t=this._ratioData.center.clone();t.multiplyScalar(1/this._ratioData.ratio),this.explicitBSphere.center.add(t),this.explicitBSphere._updateRatio(this._ratioData.ratio)}for(var i=0;i<this._occurrences.length;i++){var r=this._occurrences[i];null!==r.renderable&&r.renderable._updateWorldCenterAndRadius()}this._invalidateBoundingElements(!1,!1)},computeBoundingElements:function(){var t=this._occurrences[0];if(t&&(s=t.renderable)){for(var i=s.geometry.boundingBox,r=s.geometry.boundingSphere,n=0;n<s.geometry.length;n++){(a=s.geometry[n]).computeBoundingBox(),a.computeBoundingSphere(),n?(i.expandByPoint(a.boundingBox.min),i.expandByPoint(a.boundingBox.max),r.clone().mergeWithSphere(a.boundingSphere,r)):(i.copy(a.boundingBox),r.copy(a.boundingSphere))}for(n=0;n<this._occurrences.length;n++){var s,a;(a=(s=this._occurrences[n].renderable).geometry).boundingBox.copy(i),a.boundingSphere.copy(r),s.boundingBox||(s.boundingBox=new e.Box3),s.boundingSphere||(s.boundingSphere=new e.Sphere),s.boundingBox.copy(i),s.boundingSphere.copy(r),s._updateWorldCenterAndRadius()}this.explicitBBox.copy(i),this.explicitBSphere.copy(r),this._updateBEInternal()}},forceBoundingSphere:function(e){this.forceBoundingElements(!0,{sphere:e}),this._updateBEInternal()},_forceBoundingSphere:function(t){this.mesh3js&&this.mesh3js.geometry?(this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingSphere||(this.mesh3js.geometry.boundingSphere=new e.Sphere),this.mesh3js.geometry.boundingSphere.copy(t),this.explicitBSphere.copy(t)):console.log("Couldn't force bounding sphere.")},forceBoundingBox:function(e){this.forceBoundingElements(!0,{box:e}),this._updateBEInternal()},_forceBoundingBox:function(t){this.mesh3js&&this.mesh3js.geometry?(this.mesh3js.geometry.boundingBox||(this.mesh3js.geometry.boundingBox=new e.Box3),this.setHasExplicitBE(!0),this.mesh3js.geometry.boundingBox.copy(t),this.explicitBBox.copy(t)):console.log("Couldn't force bounding box.")},__forceBoundingElements:function(e,t){if(e){var i;e.sphere&&this._forceBoundingSphere(e.sphere),e.box&&this._forceBoundingBox(e.box);for(var r=0;r<this._occurrences.length;r++)null!==(i=this._occurrences[r]).renderable&&i.renderable._updateWorldCenterAndRadius()}},_forceGeomType:function(e){this.mesh3js&&this.mesh3js._forceGeomType(e)},createRenderable:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.visible=this.mesh3js.visible,t.pickable=this.mesh3js.pickable,t.noPickThrough=this.mesh3js.noPickThrough,t.renderDepth=this.mesh3js.renderDepth,t.frustumCulled=this.mesh3js.frustumCulled,t.enableNormalDepth=this.mesh3js.enableNormalDepth,t.castShadow=this.mesh3js.castShadow,t.receiveShadow=this.mesh3js.receiveShadow,t.beforeRenderCB=this.mesh3js.beforeRenderCB,t.fromLoadedModel=this.mesh3js.fromLoadedModel,t.lightMapData=this.mesh3js.lightMapData,t._ratioData=this.mesh3js._ratioData,t._programID=this.mesh3js._programID?this.mesh3js._programID:t._programID,t._vertexColors=this.mesh3js._vertexColors,t._skinning=this.mesh3js._skinning,t._skinningInstancing=this.mesh3js._skinningInstancing,t._billboardData=this.mesh3js._billboardData,t.materialMode=this.mesh3js.materialMode,t._bodyDim=this._bodyDim,t.kdTree=this.mesh3js.kdTree,t.hasPoint=this.mesh3js.hasPoint,this.mesh3js.disableMirror&&(t.disableMirror=this.mesh3js.disableMirror);var i=a?null:this._occurrences[0].renderable;if(i){i.layer&&(t.layer=i.layer.clone());var r=i.selectionGroups;if(r)for(var n=0;n<r.length;n++)t.addSelectionGroup(r[n].clone())}return this.mesh3js.copyInstancingInfos(t),t},add:function(){return!1},setRenderDepth:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.renderDepth=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.renderDepth=e,i.renderable._flagAsGSSOInvalidated())},setFrustumCulled:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.frustumCulled=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.frustumCulled=e)},_setNoCullingBE:function(e){this.setFrustumCulled(!e)},_getNoCullingBE:function(){return null!==this.mesh3js&&!this.mesh3js.frustumCulled},setVertexColors:function(e){null!==this.mesh3js&&this.mesh3js.setVertexColors(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setVertexColors(e)}},setSkinningTransformations:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformations(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformations(e)}},setSkinningTransformationsInstancing:function(e){null!==this.mesh3js&&this.mesh3js.setSkinningTransformationsInstancing(e);for(var t=0;t<this._occurrences.length;t++){var i=this._occurrences[t];null!==i.renderable&&i.renderable.setSkinningTransformationsInstancing(e)}},setSSAO:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.enableNormalDepth=e,this.mesh3js._flagAsGSSOInvalidated()),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.enableNormalDepth=e,i.renderable._flagAsGSSOInvalidated())},setShadow:function(e,t){var i,r;for(null!==this.mesh3js&&(this.mesh3js.castShadow=e,this.mesh3js.receiveShadow=t),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.castShadow=e,r.renderable.receiveShadow=t)},setMirror:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.disableMirror=e?0:1),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.disableMirror=e?0:1)},clone:function(t){var i=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);!!t&&(this.mesh3js.geometry.boundingSphere&&(i.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()),this.mesh3js.geometry.boundingBox&&(i.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone())),this.mesh3js.copyInstancingInfos(i),i.castShadow=this.mesh3js.castShadow,i.receiveShadow=this.mesh3js.receiveShadow;var r=new THREEDS.Nodes.Mesh(i,this.name);return this.getIsInstanceNode3D()&&r.setIsInstanceNode3D(!0),r},getPrimitive:function(e,t){var i=this._getPrimitives(e,t);return i.length?i[0]:null},getPrimitives:function(e,t){return this._getPrimitives(void 0,e,t)},show:function(e){e?this._setLayer(e,1):this._initLayer(1)},hide:function(e){e?this._setLayer(e,0):this._initLayer(0)},setMaterial:function(t,i){!t||t instanceof e.Material?this._parent(t):t&&(this._initLayer(1),this._setLayer(t,1,i))},setNoZPriority:function(e,t){e&&e instanceof Object?e&&(this._initLayer(1),this._setLayer(e,1,void 0,void 0,t?4:-1)):this._parent(e)},_setGAS:function(e,t){e instanceof Array?e&&(this._initLayer(1),this._setLayer(e,1,void 0,t)):this._parent(e)},setVisuFilters:function(e){e&&(e.LOD=null),this._parent(e)},_setNoZOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,void 0,t?4:-1)},_setNoZOnGLTypes:function(e,t){this._initLayer(1),this._setLayerOnGLTypes(e,void 0,void 0,void 0,t?4:-1)},_setMaterialOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,t)},_setMaterialOnGLTypes:function(e,t){this._initLayer(1),this._setLayerOnGLTypes(e,void 0,t)},_setGASOnGeomTypes:function(e,t){this._initLayer(1),this._setLayerOnGeomTypes(e,void 0,void 0,t)},_setGASOnGLTypes:function(e,t){this._initLayer(1),this._setLayerOnGLTypes(e,void 0,void 0,t)},_getGas:function(e){return this._getMaterials(e,!0)},_getMaterials:function(e,t){var r=this._getPrimitivesFromElts(e);if(!r.length)return!1;var n=r[0].container instanceof i.DrawingGroup,s=[],a=this._occurrences[0].renderable;if(!a)return!1;var o=new i.SGPrimitiveHelper;if(a.layer)for(var l=0;l<r.length;l++)for(var h=r[l],c=0;c<a.layer.layers.length;c++){var d=a.layer.layers[c].drawableGroup,u=a.layer.layers[c].drawableInterval;if(-1!==u.layerNum&&((t||u.material)&&(!t||u.gas))){if(n){if(h.container!==d)continue;if(h.index<u.primitiveStart||h.index>=u.primitiveStart+u.primitiveCount)continue;return t?s.push(u.gas):s.push(u.material),s}for(var p=u.primitiveStart;p<u.primitiveStart+u.primitiveCount;p++)if(o.set(d,p),o.isEqual(h))return t?s.push(u.gas):s.push(u.material),s}}return s},setMaterialMode:function(e){var t=e?1:null===e?2:0;null!==this.mesh3js&&(this.mesh3js.materialMode=t);for(var i=0;i<this._occurrences.length;i++){var r=this._occurrences[i];null!==r.renderable&&(r.renderable.materialMode=t)}},getNodeType:function(){return"Mesh3D"},getBodyDimension:function(){return this._bodyDim?this._bodyDim:-1},isEditable:function(){return!1},setInstancingParameters:function(t,i,r){var n,a;if(void 0!==this.mesh3js)if(n=this.mesh3js,this._matApp&&((a=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(a=this._matApp._getMaterialFromGLType(1)),a||(a=this._matApp._getMaterialFromGLType(0))),a||(a=this.material),a){this.setIsInstanceNode3D(!0),this.nbInstances=t,n._instancingInfos={isInstanceNode3D:!0,nbInstances:t,instancingSelectionMode:r||"instance",instanceAttribArrays:null,pickedInstanceId:-1,useDefaulInstancing:!1};for(var o=new Float32Array(t),l=0;l<t;l++)o[l]=5+5*l;var h={};h.id=s,s++,h.instanceId={},h.instanceId.array=o,h.instanceId.buffer=null,h.instanceId.itemSize=1,h.instanceId.type="f";for(var c=0;c<i.length;c++){switch(h[i[c].attribName]={},i[c].type){case"f":h[i[c].attribName].array=new Float32Array(i[c].data),h[i[c].attribName].type="f",h[i[c].attribName].itemSize=1;break;case"v2":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(2*t);for(var d=0;d<t;d++)h[i[c].attribName].array[2*d]=i[c].data[d].x,h[i[c].attribName].array[2*d+1]=i[c].data[d].y}h[i[c].attribName].type="v2",h[i[c].attribName].itemSize=2;break;case"v3":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(3*t);for(d=0;d<t;d++)h[i[c].attribName].array[3*d]=i[c].data[d].x,h[i[c].attribName].array[3*d+1]=i[c].data[d].y,h[i[c].attribName].array[3*d+2]=i[c].data[d].z}h[i[c].attribName].type="v3",h[i[c].attribName].itemSize=3;break;case"v4":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(4*t);for(d=0;d<t;d++)h[i[c].attribName].array[4*d]=i[c].data[d].x,h[i[c].attribName].array[4*d+1]=i[c].data[d].y,h[i[c].attribName].array[4*d+2]=i[c].data[d].z,h[i[c].attribName].array[4*d+3]=i[c].data[d].w}h[i[c].attribName].type="v4",h[i[c].attribName].itemSize=4;break;case"m4":if(i[c].isFlattened)h[i[c].attribName].array=new Float32Array(i[c].data);else{h[i[c].attribName].array=new Float32Array(16*i[c].data.length);for(var u=0;u<i[c].data.length;u++){var p=new Float32Array(16);p=i[c].data[u].elements;for(l=0;l<16;l++)h[i[c].attribName].array[16*u+l]=p[l]}}h[i[c].attribName].type="m4",h[i[c].attribName].itemSize=4,h[i[c].attribName].isMat4=!0}h[i[c].attribName].buffer=null}if(n._instancingInfos.instanceAttribArrays=h,a._PDSFXData&&a._PDSFXData.PDSFX){a._PDSFXData.pdsfxAttributesInternal={};for(let e=0;e<i.length;e++)a._PDSFXData.pdsfxAttributesInternal[i[e].attribName]={type:i[e].type,instancing:!0}}for(var f=0;f<this._occurrences.length;f++)n.copyInstancingInfos(this._occurrences[f].renderable)}else console.error("Error: An instancing material wasn't set to the Mesh3D.")},updateInstanceAttribValue:function(t){if(t.instanceId&&t.attribName&&void 0!==t.value){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(t.instanceId%5!=0||t.instanceId<5||t.instanceId>5*r._instancingInfos.nbInstances)console.error("Error: the instance id is incorrect or out of range.");else if(r._instancingInfos.instanceAttribArrays[t.attribName]){var n=r._instancingInfos.instanceAttribArrays,s=t.instanceId/5-1,a=!0;switch(n[t.attribName].type){case"f":"number"!=typeof t.value||isNaN(t.value)?a=!1:n[t.attribName].array[s]=t.value;break;case"v2":t.value instanceof e.Vector2?(n[t.attribName].array[2*s]=t.value.x,n[t.attribName].array[2*s+1]=t.value.y):a=!1;break;case"v3":t.value instanceof e.Vector3?(n[t.attribName].array[3*s]=t.value.x,n[t.attribName].array[3*s+1]=t.value.y,n[t.attribName].array[3*s+2]=t.value.z):a=!1;break;case"v4":t.value instanceof e.Vector4?(n[t.attribName].array[4*s]=t.value.x,n[t.attribName].array[4*s+1]=t.value.y,n[t.attribName].array[4*s+2]=t.value.z,n[t.attribName].array[4*s+3]=t.value.w):a=!1;break;case"m4":if(t.value instanceof e.Matrix4){var o=new Float32Array(16);o=t.value.elements;for(var l=0;l<16;l++)n[t.attribName].array[16*s+l]=o[l]}else a=!1;break;default:a=!0}if(a){var h;n[t.attribName].isDynamic=!0;for(var c=0;c<this._occurrences.length;c++){var d;if((h=this._occurrences[c].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,h.highlightMeshes)for(d=0;d<h.highlightMeshes.length;d++)h.highlightMeshes[d].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new value doesn't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}else console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.")},updateInstanceAttribArray:function(t){if(t.attribName&&t.array){var i;this._matApp&&((i=this._matApp._getMaterialFromGLType(4,e.GeomTypeEnum.FACE))||(i=this._matApp._getMaterialFromGLType(1)),i||(i=this._matApp._getMaterialFromGLType(0))),i||(i=this.material);var r=this.mesh3js;if(r._instancingInfos)if(r._instancingInfos.instanceAttribArrays[t.attribName]){var n=!0,s=r._instancingInfos.instanceAttribArrays;if(t.isFlattened)t.array instanceof Array&&(t.array=new Float32Array(t.array)),s[t.attribName].array=t.array;else{var a=s[t.attribName].type,o=t.array[0];switch(a){case"f":"number"!=typeof o||isNaN(o)?n=!1:s[t.attribName].array.set(new Float32Array(t.array));break;case"v2":if(o instanceof e.Vector2)for(var l=0;l<r._instancingInfos.nbInstances;l++)s[t.attribName].array[2*l]=t.array[l].x,s[t.attribName].array[2*l+1]=t.array[l].y;else n=!1;break;case"v3":if(o instanceof e.Vector3)for(l=0;l<r._instancingInfos.nbInstances;l++)s[t.attribName].array[3*l]=t.array[l].x,s[t.attribName].array[3*l+1]=t.array[l].y,s[t.attribName].array[3*l+2]=t.array[l].z;else n=!1;break;case"v4":if(o instanceof e.Vector4)for(l=0;l<r._instancingInfos.nbInstances;l++)s[t.attribName].array[4*l]=t.array[l].x,s[t.attribName].array[4*l+1]=t.array[l].y,s[t.attribName].array[4*l+2]=t.array[l].z,s[t.attribName].array[4*l+3]=t.array[l].w;else n=!1;break;case"m4":if(o instanceof e.Matrix4){var h;for(l=0;l<r._instancingInfos.nbInstances;l++){h=t.array[l].elements;for(var c=0;c<16;c++)s[t.attribName].array[16*l+c]=h[c]}}else n=!1;break;default:n=!0}}if(n){var d;s[t.attribName].isDynamic=!0;for(var u=0;u<this._occurrences.length;u++){var p;if((d=this._occurrences[u].renderable)._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0,d.highlightMeshes)for(p=0;p<d.highlightMeshes.length;p++)d.highlightMeshes[p].renderable._instancingInfos.instanceAttribArrays[t.attribName].isDynamic=!0}}else console.error("Error: the type of the new values don't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")}},setInstancingSelectionMode:function(e){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=e;for(var t=this._occurrences,i=t.length,r=0;r<i;r++)t[r].renderable._instancingInfos.instancingSelectionMode=e}},_getPrimitivesFromElts:function(e){var t=[];if(e.length)if(e[0]instanceof r)for(var n=0;n<e.length;n++)if("rep"===e[n].getType())for(var s=0;s<e[n].sgNode.getPrimitivesCount();s++){var a=new i.SGPrimitiveHelper;a.set(e[n].sgNode,s),t.push(a)}else t.push(e[n].sgNode);else t=e.slice();return t},_setLayer:function(e,t,i,r,n){var s,a,o=[];if(a=this._getPrimitivesFromElts(e),-1===t){var l;if(!(l=this._occurrences[0].renderable))return;o=l.getRenderablesFromGeometries()}else for(s=0;s<this._occurrences.length;s++)o.push(this._occurrences[s].renderable);for(s=0;s<o.length;s++)if(l=o[s]){var h;if(l._flagAsGSSOInvalidated(),null===l.layer)if(l.initLayers(1),l.highlightMeshes)for(h=0;h<l.highlightMeshes.length;h++)l.highlightMeshes[h].renderable.layer=l.layer.clone();l.layer.addPrimitivesToLayers(a,t,i,r,null,n)}},_setLayerByFilteredDG:function(e,t,i,r,n){var s=[];if(-1===t){if(!(o=this._occurrences[0].renderable))return;s=o.getRenderablesFromGeometries()}else for(a=0;a<this._occurrences.length;a++)s.push(this._occurrences[a].renderable);for(var a=0;a<s.length;a++){var o;if(o=s[a]){var l;if(o._flagAsGSSOInvalidated(),null===o.layer)if(o.initLayers(1),o.highlightMeshes)for(l=0;l<o.highlightMeshes.length;l++)o.highlightMeshes[l].renderable.layer=o.layer.clone();for(var h=0;h<o.geometry.length;h++)for(var c=o.geometry[h],d=0;d<c.drawingGroups.length;d++){var u=c.drawingGroups[d];e(u)&&o.layer.setDGToLayer(c,u,t,i,r,void 0,n)}}}},_setLayerOnGeomTypes:function(e,t,i,r,n){this._setLayerByFilteredDG(function(t){var i=void 0!==t._initialGeomType?t._initialGeomType:t._geomType;return-1!==e.indexOf(i)},t,i,r,n)},_setLayerOnGLTypes:function(e,t,i,r,n){this._setLayerByFilteredDG(function(t){return-1!==e.indexOf(t.glType)},t,i,r,n)},_flagAsGSSOInvalidated:function(){for(var e=0;e<this._occurrences.length;e++){var t=this._occurrences[e];null!==t.renderable&&t.renderable._flagAsGSSOInvalidated()}},_initLayer:function(e){var t,i;for(t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable._flagAsGSSOInvalidated(),null===i.renderable.layer&&i.renderable.initLayers(e))},_removePrimitives:function(e){e&&this._setLayer(e,-1)},_addDynamicGeometry:function(e,t,i){var r=null,n=this._occurrences[0].renderable;if(!n)return!1;for(var s=0;s<n.geometry.length;s++)if(n.geometry[s].dynamic){r=n.geometry[s];break}if(r)r.merge(e,t,i);else{e.dynamic=!0;for(s=0;s<this._occurrences.length;s++)(n=this._occurrences[s].renderable)&&n.addGeometry(e)}},_optimizeBuffers:function(e){var t={invalidRatio:e&&void 0!==e.invalidRatio?e.invalidRatio:.5};if(l=this._occurrences[0].renderable){var r=l.geometry;if(r instanceof Array){var n=l.layer?l.layer.layers:null;if(n){var s=new Map,a=i.mergeGeometries({geometries:r,layers:n,invalidRatio:t.invalidRatio,force:!1},s);if(a)for(var o=0;o<this._occurrences.length;o++){var l;if(l=this._occurrences[o].renderable){l.releaseVBO(!1),l.geometry.length=0;for(var h=0;h<a.length;h++)l.geometry.push(a[h]);for(h=0;h<a.length;h++)a[h].addRefVBO(l,!1);a.boundingBox&&(l.geometry.boundingBox=a.boundingBox.clone()),a.boundingSphere&&(l.geometry.boundingSphere=a.boundingSphere.clone());var c=l.layer.layers,d=!1,u=[];for(h=0;h<c.length;h++){var p=[],f=c[h].drawableGroup,g=c[h].drawableInterval;if(g.layerNum>0&&g.material){d=!0;for(var m=g.primitiveStart;m<g.primitiveStart+g.primitiveCount;m++)if(s.has(f)){var v=s.get(f);v.has(m)&&p.push(v.get(m))}u.push({layerInterval:g,primitives:p})}}if(l.layer=null,d){l.initLayers(1);for(h=0;h<u.length;h++)l.layer.addPrimitivesToLayers(u[h].primitives,u[h].layerInterval.layerNum,u[h].layerInterval.material)}}}}}}},_getPrimitives:function(e,t,n){""===e&&(e=null);var s=[],a=this._occurrences[0].renderable;if(!a)return!1;var o=new i.SGPrimitiveHelper;if(a.layer)for(var l=0;l<a.layer.layers.length;l++){var h=a.layer.layers[l].drawableGroup,c=a.layer.layers[l].drawableInterval;if(void 0!==n)if((void 0!==h._initialGeomType?h._initialGeomType:h._geomType)!==n)continue;if(-1!==c.layerNum&&(!t||c.layerNum))for(var d=c.primitiveStart;d<c.primitiveStart+c.primitiveCount;d++)if(o.set(h,d),void 0!==e){if(o.getCgmId()===e)return s.push(r.getFromSGNode(o.clone())),s}else s.push(r.getFromSGNode(o.clone()))}else{var u=a.geometry;if(!(u instanceof Array))return s;for(d=0;d<u.length;d++){var p=u[d].drawingGroups;for(l=0;l<p.length;l++){h=p[l];if(void 0!==n)if((void 0!==h._initialGeomType?h._initialGeomType:h._geomType)!==n)continue;for(var f=0;f<h.getPrimitivesCount();f++)if(o.set(h,f),void 0!==e){if(o.getCgmId()===e)return s.push(r.getFromSGNode(o.clone())),s}else s.push(r.getFromSGNode(o.clone()))}}}return s},_setBeforeRenderCB:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.beforeRenderCB=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.beforeRenderCB=e)}});l.prototype._isMesh3D=!0;var h=1,c=2;return l.prototype.getHasExplicitBE=function(){return(this.mesh3DBooleanAttr&h)>0},l.prototype.setHasExplicitBE=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|h:this.mesh3DBooleanAttr&~h},l.prototype.getIsInstanceNode3D=function(){return(this.mesh3DBooleanAttr&c)>0},l.prototype.setIsInstanceNode3D=function(e){this.mesh3DBooleanAttr=e?this.mesh3DBooleanAttr|c:this.mesh3DBooleanAttr&~c},l.prototype.forceNoMeshInRAM=function(){var e,t,i=this.mesh3js.geometry;for(e=0;e<i.length;e++){if((t=i[e]).sharedBuffers)throw new Error("Cannot force no mesh in RAM on geometry with sharedBuffers");t.noMeshInRAM||(t.noMeshInRAM=!0,t.vertexBufferGPU&&t.clearMeshInRAM(!1))}},Object.defineProperty(l.prototype,"hasExplicitBE",{get:function(){return this.getHasExplicitBE()},set:function(e){this.setHasExplicitBE(e)}}),Object.defineProperty(l.prototype,"isInstanceNode3D",{get:function(){return this.getIsInstanceNode3D()},set:function(e){this.setIsInstanceNode3D(e)}}),UWA.namespace("THREEDS/Nodes/Mesh",l)}),define("Visualization/Mesh3D",["DS/Visualization/Mesh3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Mesh3D"),e}),define("DS/Visualization/CompareModelsServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Effects/CompareModelsEffect","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,s,a){"use strict";var o=e.extend({init:function(e){return this.viewer=e,this._oldMatInherit=!1,this.compareEffect=null,this.effectID=-1,this._tmpNodes=[],this._occurrences=[],this},startCompare:function(e){this._oldMatInherit=this.viewer.renderer.renderer.newMaterialInheritance,this.viewer.renderer.renderer.newMaterialInheritance=!0;for(var r=new t.Color(e.first.color),n=new t.Color(e.second.color),s=new t.Color(e.common.color),o=new a({colorRGB:r,colorA:e.first.opacity,inheritanceCustom:t.GASEnumCustom._FORCE_EDGE_OPACITY}),l=new a({colorRGB:n,colorA:e.second.opacity,inheritanceCustom:t.GASEnumCustom._FORCE_EDGE_OPACITY}),h=new a({colorRGB:s,colorA:e.common.opacity,inheritanceCustom:t.GASEnumCustom._FORCE_EDGE_OPACITY}),c=e.first.pathElements,d=e.second.pathElements,u=[],p=[],f=0;f<c.length;f++){var g=this._createTemporaryNode(c[f]);u.push(g)}for(f=0;f<d.length;f++){g=this._createTemporaryNode(d[f]);p.push(g)}for(f=0;f<u.length;f++)u[f].setVisibility(!1);for(f=0;f<p.length;f++)p[f].setVisibility(!1);for(f=0;f<c.length;f++)this._applyColorsAndPasses(0,c[f],u[f],o,h);for(f=0;f<d.length;f++)this._applyColorsAndPasses(1,d[f],p[f],l);if(!this.compareEffect){var m=new i(this.viewer.renderer.renderer,this.viewer.renderer.renderTargetPool);this.effectID=this.viewer.renderer.addCustomEffect(m),this.compareEffect=this.viewer.renderer.getCustomEffect(this.effectID)}this.compareEffect.set2DMode(e.compareMode&&"2D"===e.compareMode),this.viewer.renderer.setCustomEffect(this.effectID,!0)},stopCompare:function(){this.viewer.renderer.setCustomEffect(this.effectID,!1),this._cleanTemporaryNodes(),this.viewer.renderer.renderer.newMaterialInheritance=this._oldMatInherit},_createTemporaryNode:function(e){var t=e.externalPath[e.externalPath.length-2],i=new r;return this._tmpNodes.push(i),t.addChild(i),i.addChild(e.getLastElement()),i},_hideOccurrences:function(e){for(var t=0;t<e._occurrences.length;t++){e._occurrences[t].setVisibility(!1)}},_applyColorsAndPasses:function(e,t,i,r,n){var a=t.externalPath.slice();a.splice(t.externalPath.length-1,0,i);for(var o=new s(a),l=t._getOccurrences(this.viewer),h=o._getOccurrences(this.viewer),c=0;c<l.length;c++){var d=l[c];this._updateGASOccurrence(d,r)}for(c=0;c<h.length;c++){(d=h[c])._relativeVisibility=2,1===e?this._updateRenderPassesOccurrence(d,["compareNew"]):(this._updateRenderPassesOccurrence(d,["compareOld"]),this._updateGASOccurrence(d,n))}},_cleanTemporaryNodes:function(){for(var e=0;e<this._occurrences.length;e++){var t=this._occurrences[e];this._resetOccurrence(t)}this._occurrences=[];for(e=0;e<this._tmpNodes.length;e++){var i=this._tmpNodes[e];i.removeChildren();for(var r=0;r<i.parents.length;r++)i.parents[r].removeChild(i)}this._tmpNodes=[]},_updateGASOccurrence:function(e,t){this._occurrences.push(e),e.forceGAS=t,e.gas=t,e.node._updateOccurrences(e.parent,e,!1)},_updateRenderPassesOccurrence:function(e,t){this._occurrences.push(e),e.forcePasses=t,e.node._updateOccurrences(e.parent,e,!1)},_resetOccurrence:function(e){e.forceGAS=null,e.gas=null,e.forcePasses=null,e._relativeVisibility=null,e.traverse(function(e){e._relativeVisibility=null});for(var t=0;t<e.children.length;t++){var i=e.children[t];i.node._updateOccurrences(e,i,!1)}}});return UWA.namespace("THREEDS/CompareModelsServices",o)}),define("DS/Visualization/PrimitiveIterator",["UWA/Class","DS/Mesh/MeshUtils","DS/Visualization/Mesh3D","DS/Visualization/PathElement"],function(e,t,i,r){"use strict";var n={},s=e.extend({init:function(e,t){if(t===n){var s=e;if(this._primitives=null,this._sgRep=null,this._sgPrimitive=null,e instanceof r&&(s=e.getLastElement()),s instanceof i)this._primitives=s.getPrimitives();else if(s.sgNode)switch(s.sgNode.getType?s.sgNode.getType():s.sgNode.type){case 2:this._sgRep=s.sgNode;break;case 3:this._sgPrimitive=s.sgNode;break;default:console.log("PrimitiveIterator: unsupported SubElement type")}}},getNbPrimitives:function(){if(this._primitives)return this._primitives.length;if(this._sgPrimitive)return 1;if(this._sgRep)return this._sgRep.getPrimitivesCount();throw new Error("Internal error")},getConnectivityType:function(e){return this._getSGNode(e).getGroup().glType},getLength:function(e){return this._getSGNode(e).getCount()},getOffset:function(e){return this._getSGNode(e).getStart()},getIndexArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexIndexArray},getPositionArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexPositionArray},getNormalArray:function(e){return this._getSGNode(e).getGroup().geometry.vertexNormalArray},getMaterial:function(e){return this._getSGNode(e).getGroup().material},getGas:function(e){return this._getSGNode(e).getGroup().gas},getGeomType:function(e){var i=this._getSGNode(e);return t.GeomTypeString[i.getGroup()._geomType]},_getSGNode:function(e){if(this._primitives)return this._primitives[e].sgNode;if(this._sgPrimitive&&0===e)return this._sgPrimitive;if(this._sgRep){var i=new t.SGPrimitiveHelper;return i.set(this._sgRep,e),i}}});return s.POINTS=0,s.LINES=1,s.LINE_LOOP=2,s.LINE_STRIP=3,s.TRIANGLES=4,s.TRIANGLE_STRIP=5,s.TRIANGLE_FAN=6,s._authorizedTeamsOnly_getKey=function(){return n},s}),define("DS/Visualization/EditableMesh3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Intersection/IntersectionUtils"],function(e,t,i,r){"use strict";var n=t.extend({init:function(e,t){return this._parent(e,t),this},clone:function(){let t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return this.mesh3js.copyInstancingInfos(t),new THREEDS.Nodes.EditableMesh(t,this.name)},getNodeType:function(){return"Mesh3D"},isEditable:function(){return!0},getBuffer:function(e,t){let i=t||this.mesh3js.geometry[0],r=this._getDataArray(e);return r?i[r]:null},getIndexBuffer:function(e){let t=e||this.mesh3js.geometry[0];return this._getIndexArray(t)},updateIndexBuffer:function(e,t,i,r){let n=void 0===r||r;(n=(i||this.mesh3js.geometry[0]).markIndexStale(e,e+t)||n)&&this._clearGSSOCache()},updateBuffer:function(e,t,i,n,s){let a=void 0===s||s,o=n||this.mesh3js.geometry[0];const l=this._getDataArray(e);a=o.markAttributeStale({vertexPositionArray:"position",vertexNormalArray:"normal",vertexUvArray:"uv",vertexUv2Array:"uv2",vertexTangentArray:"tangent",vertexBinormalArray:"binormal",vertexColorArray:"color",vertexLineDistancesArray:"lineDistance",vertexLinePixelDistancesArray:"linePixelDistance",vertexPatternStartEndArray:"patternStartEnd",vertexPreviousPositionArray:"previousPos",vertexNextPositionArray:"followingPos",vertexSideExtrusionArray:"sideExtrusion",vertexSkinIndexArray:"skinIndex",vertexSkinWeightArray:"skinWeight"}[l],t,t+i)||a,o.vertexBufferGPU&&(o.vertexBufferGPU.needsUpdate=!0),o.wideLinesLinker&&o.wideLinesLinker.linkedGeometry.vertexBufferGPU&&(o.wideLinesLinker.linkedGeometry.vertexBufferGPU.needsUpdate=!0),a&&this._clearGSSOCache(),r.clearDGBSCache()},addBuffer:function(e,t,r){this._clearGSSOCache();let n=r||this.mesh3js.geometry[0];const s=this._getDataArray(e);if(!(s?n[s]:null))switch(n.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:n.vertexPositionArray=t;break;case i.VertexComponentEnum.NORMAL:n.vertexNormalArray=t;break;case i.VertexComponentEnum.DIFFUSE_COLOR:n.vertexColorArray=t;break;case i.VertexComponentEnum.TEX_COORD_0:n.vertexUvArray=t;break;case i.VertexComponentEnum.TEX_COORD_1:n.vertexUv2Array=t;break;case i.VertexComponentEnum.TEX_COORD_2:n.vertexTangentArray=t;break;case i.VertexComponentEnum.TEX_COORD_3:n.vertexBinormalArray=t}},removeBuffer:function(e,t){this._clearGSSOCache();let r=t||this.mesh3js.geometry[0];const n=this._getDataArray(e);if(n?r[n]:null)switch(r.needsUpdate=!0,e){case i.VertexComponentEnum.POSITION:r.vertexPositionArray=null;break;case i.VertexComponentEnum.NORMAL:r.vertexNormalArray=null;break;case i.VertexComponentEnum.DIFFUSE_COLOR:r.vertexColorArray=null;break;case i.VertexComponentEnum.TEX_COORD_0:r.vertexUvArray=null;break;case i.VertexComponentEnum.TEX_COORD_1:r.vertexUv2Array=null;break;case i.VertexComponentEnum.TEX_COORD_2:r.vertexTangentArray=null;break;case i.VertexComponentEnum.TEX_COORD_3:r.vertexBinormalArray=null}},_getIndexArray:function(e){return e.vertexIndexArray},_getDataArray:function(e){switch(e){case i.VertexComponentEnum.POSITION:return"vertexPositionArray";case i.VertexComponentEnum.NORMAL:return"vertexNormalArray";case i.VertexComponentEnum.DIFFUSE_COLOR:return"vertexColorArray";case i.VertexComponentEnum.TEX_COORD_0:return"vertexUvArray";case i.VertexComponentEnum.TEX_COORD_1:return"vertexUv2Array";case i.VertexComponentEnum.TEX_COORD_2:return"vertexTangentArray";case i.VertexComponentEnum.TEX_COORD_3:return"vertexBinormalArray"}return null},_clearGSSOCache:function(){let e,t=null,i=null;for(e=0;e<this._occurrences.length;e++)(t=(i=this._occurrences[e]).renderable)&&(t._flagAsGSSOInvalidated(),t.outlinesGeometry&&(t.outlinesGeometry.upToDate=!1))}});return UWA.namespace("THREEDS/Nodes/EditableMesh",n)}),define("Visualization/EditableMesh3D",["DS/Visualization/EditableMesh3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/EditableMesh3D"),e}),define("DS/Visualization/DecalNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){if(!e.DecalManager._creatingDecal)throw"Use Decal Manager to create decals";return this._parent(t,i),this.decalNode3DBooleanAttr=0,this._setHasExplicitUv(!1),this._decalAttachedTo=new Set,this.setVisibilityFree(!0),this.setMaterialMode(1),this._layer=0,e.DecalManager.activated=!0,this},setExplicitUv:function(t){this._setHasExplicitUv(t);for(var i=this._getAllOwningViewers(),r=0;r<i.length;r++)e.DecalManager.updateDecalsData(i[r],!0)},isExplicitUv:function(){return this._getHasExplicitUv()},setLegacyLayer:function(t){if(!window.newMaterialInheritance){this._layer=t;for(var i=this._getAllOwningViewers(),r=0;r<i.length;r++)e.DecalManager.updateDecalsData(i[r],!0)}},__shareAttachementFrom:function(e){this._decalAttachedTo=e},attachTo:function(e){return!e._isDecal&&(this._decalAttachedTo.add(e),this._updateMatrix(),!0)},getAttachedTo:function(){return Array.from(decalNode._decalAttachedTo)},applyOn:function(e){return e.addChild(this)},getAppliedOn:function(){return this.parents.slice()},applyAndAttach:function(e){return this.attachTo(e)&&this.applyOn(e)},unapply:function(e){if(!this.parents.length)return!1;if(e)return e.removeChild(this);for(var t=0;t<this.parents.length;t++)this.parents[t].removeChild(this);return!0},detach:function(e){return e?this._decalAttachedTo.delete(e):this._decalAttachedTo.clear(),this._updateMatrix(),!0},unapplyAndDetach:function(){return this.unapply(null)&&this.detach(null)},addChild:function(e){return!1},removeChild:function(e){return!1},setMaterialMode:function(i){e.DecalManager._creatingDecal&&t.prototype.setMaterialMode.call(this,i)},_propagateVisuFilters:function(e,t){},setVisuFilters:function(e){}});i.prototype._isDecal=!0;var r=1;return i.prototype._getHasExplicitUv=function(){return(this.decalNode3DBooleanAttr&r)>0},i.prototype._setHasExplicitUv=function(e){this.decalNode3DBooleanAttr=e?this.decalNode3DBooleanAttr|r:this.decalNode3DBooleanAttr&~r},UWA.namespace("THREEDS/Nodes/DecalNode3D",i)}),define("Visualization/DecalNode3D",["DS/Visualization/DecalNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/DecalNode3D"),e}),define("DS/Visualization/SceneGraphFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/DecalNode3D","DS/Visualization/EditableMesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/CoreEvents/ModelEvents","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/Canvas2DNode","DS/SceneGraphNodes/Canvas2DInstancingNode","DS/Effects/ComputeSDFFontIterative","DS/Effects/DownSamplingEffect","DS/Effects/ComputeSDFFontMergeTiles","DS/Visualization/MaterialApplication","DS/Visualization/ImageUtils"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y){"use strict";var S=new h,x={textCanvas:null,iterativeCompute:null,downSampling:null,mergeTiles:null},b=["left","center","right"],w=[0,.5,1],M=["top","bottom","middle","alphabetic","hanging"],C=[0,1,.5,1,0];const P={left:0,center:.5,right:1},E={top:0,bottom:1,middle:.5,alphabetic:1,hanging:0};var T,A,D,I,R,O,L,V,F,B,N,G,k,U={createMeshNode:function(t,s,o,l,h,c){var d,u,p,f,g,m,v,_,y=void 0!==o?o:0,S=void 0!==s?s:t.material;e.disableJHGDev&&null==S&&(d=new e.Color,u=new e.Color(6710886),p=new e.Color,(S=e.MaterialUtils.createShinyFaceMaterial({color:d.getHex(),opacity:1})).line=new e.LineBasicMaterial({color:u.getHex(),lineWidth:1,opacity:1}),S.point=new e.ParticleBasicMaterial({color:p.getHex(),size:1,opacity:1})),f=new a.SGBag,g=new a.SGRep({cgmId:y,parent:f}),a.validatePrimitiveGroup(t);var x,b=a.checkMeshOptimizable(t),w=b&&t.editable,M=b&&(t.editable||t.optimized),C=!w&&t.sharing;if(M)v=[a.createGeometryOptimized(t,g)],w&&(v[0].editable=!0);else{t.editable?console.warn("Could not make the mesh editable since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer."):t.optimized&&console.warn("Could not optimize the mesh build since it does not satisfy the editability rules : no strips and fans, no multi-indexation, 1 buffer per vertex component, 1 index buffer.");for(var P=0;P<t.buffers.length;P++){var E=t.buffers[P];if(E&&E.component===a.VertexComponentEnum.DIFFUSE_COLOR){if(3===E.dimension){E.dimension=4,E.size*=4/3;for(var T=E.data,A=T.length/3,D=new Float32Array(4*A),I=0,R=0;R<A;R++)D[I]=T[3*R],D[I+1]=T[3*R+1],D[I+2]=T[3*R+2],D[I+3]=1,I+=4;E.data=D}else 4!==E.dimension&&console.error("ERROR : Your Color Buffer should have 4 values per vertex (RGBA)");break}}(m=a.convertToGeometry3js(t,void 0,void 0,void 0,l,!1,h)).rep=g,(v=a.divideRep(m)).sceneGraph=f,t.patternOffsets&&(v.patternOffsets=t.patternOffsets)}return _=a.convertTo3jsMesh(v,S,!0,C),x=c?new r(_):w?new n(_):new i(_),!e.disableJHGDev&&S&&x.setMaterial(S),t.noz&&x.setRenderPasses(["noz"]),x},isReady:function(){return this.root.isReady()},applyMaterialOpacityOverrideToPath:function(){return!1},applyMaterialOverrideToPath:function(){return!1},removeAnyMaterialOverride:function(){return!1},createCuboidNode:function(e){var t=S.CreateVis3DCuboid(e);return this.createMeshNode(t,e.material,void 0,void 0,void 0,!!e._decal)},createCuboidNodeFromBox3:function(e,t){var i=S.CreateVis3DCuboidFromBox3(e,{});return this.createMeshNode(i,t,void 0,"mono")},createSphereNode:function(e){var t=S.CreateVis3DSphere(e);return this.createMeshNode(t,e.material,void 0,"mono")},createTubeNode:function(e){var t=S.CreateVis3DTube(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderNode:function(e){var t=S.CreateVis3DCylinder(e);return this.createMeshNode(t,e.material,void 0,"mono")},createConeNode:function(e){var t=S.CreateVis3DCone(e);return this.createMeshNode(t,e.material,void 0,"mono")},createCylinderCustomNode:function(e){var t=S.CreateVis3DCylinderCustom(e);return this.createMeshNode(t,e.material,void 0,"mono")},createLineNode:function(e){var t=S.createLine(e);return this.createMeshNode(t,e.material)},createRectangleNode:function(e){var t=S.createRectangle(e);return this.createMeshNode(t,e.material)},createCircleNode:function(e){var t=S.createCircle(e);return this.createMeshNode(t,e.material)},createTorusNode:function(e){var t=S.createTorus(e);return this.createMeshNode(t,e.material)},createPointsNode:function(e){var t=S.createPoints(e.positions,e.color,e.size,e.layerNb);return this.createMeshNode(t,e.material)},createSimpleMeshNode:function(e){var t=S.createMesh(e.bufferPosition,e.bufferNormal,e.bufferUV,e.bufferIndex,e.glType,e.color,void 0,e.axis,e.layerNb);return this.createMeshNode(t,e.material)},createTessellatedCurvedPipe:(T=new e.Vector3,A=new e.Vector3,D=new e.Vector3,I=new e.Vector3,R=new e.Vector3,O=new e.Vector3,L=new e.Vector3,V=new e.Vector3,F=new e.Vector3,B=new e.Vector3,N=new e.Vector3,G=new e.Vector3,k=new e.Vector3,function(t,r,n,s,o,l,h,c,d){var u=new e.BufferGeometryDS;u.sharedBuffers=!0;var p=n.length/3;T.set(n[0]+s.x,n[1]+s.y,n[2]+s.z),A.set(n[3*(p-1)]+o.x,n[3*(p-1)+1]+o.y,n[3*(p-1)+2]+o.z),u.drawingGroups=[];var f=6*t*(p-1)+6*(t-2),g=new a.DrawingGroup(c,d,4,0,f);g.geometry=u,u.drawingGroups.push(g);for(var m=(p+2)*t,v=new Float32Array(3*m),_=new Float32Array(3*m),y=0,S=new Array(t),x=new Array(t),b=0;b<t;b++){var w=2*Math.PI*(b/t);S[b]=Math.cos(w),x[b]=Math.sin(w)}V.copy(l);for(var M=[],C=[],P=0;P<p;P++){I.set(n[3*P],n[3*P+1],n[3*P+2]),0===P?D.copy(T):D.set(n[3*(P-1)],n[3*(P-1)+1],n[3*(P-1)+2]),P===p-1?R.copy(A):R.set(n[3*(P+1)],n[3*(P+1)+1],n[3*(P+1)+2]),O.subVectors(I,D).normalize(),L.subVectors(R,I).normalize(),N.addVectors(O,L).normalize();var E=V.dot(N);for(G.copy(N).multiplyScalar(E),k.subVectors(V,G),F.crossVectors(N,k),b=0;b<t;b++){B.set(S[b]*k.x+x[b]*F.x,S[b]*k.y+x[b]*F.y,S[b]*k.z+x[b]*F.z).normalize();var U=r*B.x,z=r*B.y,H=r*B.z;0===P&&(M.push(-N.x),M.push(I.x+U),M.push(-N.y),M.push(I.y+z),M.push(-N.z),M.push(I.z+H)),P===p-1&&(C.push(N.x),C.push(I.x+U),C.push(N.y),C.push(I.y+z),C.push(N.z),C.push(I.z+H)),_[y]=U,v[y++]=I.x+U,_[y]=z,v[y++]=I.y+z,_[y]=H,v[y++]=I.z+H}V=k}for(b=0;b<M.length/2;b++)_[y]=M[2*b],v[y++]=M[2*b+1];for(b=0;b<C.length/2;b++)_[y]=C[2*b],v[y++]=C[2*b+1];u.vertexPositionArray=v,u.vertexNormalArray=_;var W=new Uint16Array(f),j=0,X=0,q=0,Z=0,Y=0,Q=0;for(P=0;P<p-1;P++)for(b=0;b<t;b++)X=(Q=P*t)+b,q=Q+(b+1)%t,Z=Q+b+t,Y=b===t-1?Q+t:(Q+b+t+1)%m,W[j++]=X,W[j++]=q,W[j++]=Z,W[j++]=q,W[j++]=Y,W[j++]=Z;for(Q=p*t,b=0;b<t-2;b++)W[j++]=Q,W[j++]=Q+b+2,W[j++]=Q+b+1,W[j++]=Q+t,W[j++]=Q+t+b+1,W[j++]=Q+t+b+2;u.vertexIndexArray=W;var K=[];K.push(u);var $=new e.Mesh(K,d);$.matrixAutoUpdate=!1;var J=function(t,i){for(var r=new e.Vector3(1/0,1/0,1/0),n=new e.Vector3(-1/0,-1/0,-1/0),s=new e.Vector3,a=new e.Vector3,o=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new e.Vector3,u=new e.Vector3,p=null,f=i.length/3-1,g=0;g<f;g++){a.set(i[3*g],i[3*g+1],i[3*g+2]),o.set(i[3*g+3],i[3*g+4],i[3*g+5]),s.subVectors(o,a);var m=s.dot(s);l.set(t*Math.sqrt(1-s.x*s.x/m),t*Math.sqrt(1-s.y*s.y/m),t*Math.sqrt(1-s.z*s.z/m)),h.subVectors(a,l),d.subVectors(o,l),h.min(d),c.addVectors(a,l),u.addVectors(o,l),c.max(u),p=new e.Box3(h,c),r.min(p.min),n.max(p.max)}var v=(new e.Vector3).addVectors(r,n).multiplyScalar(.5),_=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(r,v).multiplyScalar(1.05)),y=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(n,v).multiplyScalar(1.05));return new e.Box3(_,y)}(r,n),ee=new i($,"");return ee.forceBoundingBox(J),ee}),createTextNode:function(e){return e.sdf?this.createSDFTextNode.apply(this,arguments):this.createTextNodeZoomable.apply(this,arguments)},createSDFTextNode:function(t){var i,r,n,s,a,o,l,h,c;t.resolutionCoef=256,t.color||(t.color=new e.Color("white")),i="font-family: "+t.font+"; font-size: "+t.resolutionCoef+"px;",a=(n=(r=t.precomputedTextSize||S._determineTextSize(t.text,i,"pre")).width)/(s=r.height),x.textCanvas||(x.textCanvas=document.createElement("canvas")),(o=x.textCanvas).width=n,o.height=s,(l=o.getContext("2d")).fillStyle="#ffffff",l.fillRect(0,0,n,s),l.fillStyle="#000000",l.lineWidth=0,l.strokeStyle="#000000",l.font=t.resolutionCoef+"px "+t.font,l.textAlign="left",l.textBaseline="top",l.fillText(t.text,0,0),l.restore(),h=n/t.resolutionCoef,(c=S.createRectangle(t.fontSize*h,t.fontSize*h/a,!0,void 0,void 0,t.layerNb)).noz=t.layerNb>0;var d=null;if(0!==o.width||0!==o.height){x.iterativeCompute||(x.iterativeCompute=new g(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)),x.downSampling||(x.downSampling=new m(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool)),x.mergeTiles||(x.mergeTiles=new v(debugWebGLV6Viewer.renderer.renderer,debugWebGLV6Viewer.renderer.renderTargetPool));for(var u=x.iterativeCompute.gl,p=performance.now(),f=p,_=l.getImageData(0,0,o.width,o.height),y=(new ArrayBuffer(_.data.length),Math.floor(o.width/8)),b=Math.floor(o.height/8),w=1+Math.ceil((o.width-512)/448),M=1+Math.ceil((o.height-512)/448),C=new Uint8Array(1048576),P=(new Uint8Array(16384),new Uint8Array(4*y*b)),E=null,T=(performance.now(),0);T<M;T++)for(var A=448*T,D=A/8,I=0;I<w;I++){var R=448*I,O=R/8,L=I===w-1?o.width-448*I:512,V=T===M-1?o.height-448*T:512,F=Math.floor(L/8),B=Math.floor(V/8),N=A*o.width+R,G=0;p=performance.now();for(var k=0;k<512;k++)for(var U=0;U<512;U++)if(U<L&&k<V){var z=N+k*o.width+U;C[G++]=_.data[4*z],C[G++]=_.data[4*z+1],C[G++]=_.data[4*z+2],C[G++]=_.data[4*z+3]}else C[G++]=255,C[G++]=255,C[G++]=255,C[G++]=255;E||(E=new e.DataTexture(C,512,512,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),x.iterativeCompute.setMap(E,50),x.downSampling.setSize(512,512),x.downSampling.setInput(x.iterativeCompute.composers[1]),x.mergeTiles.setSize(y,b),x.mergeTiles.setInput(x.downSampling.composers[2])),E.needsUpdate=!0,p=performance.now();for(var H=0;H<50;H++)x.iterativeCompute.executeStep(H,49===H);x.downSampling.execute(),x.mergeTiles.setTileInfos(O,D,64,64,F,B),x.mergeTiles.execute()}p=performance.now(),u.readPixels(0,0,y,b,u.RGBA,u.UNSIGNED_BYTE,P),(d=new e.DataTexture(P,y,b,e.RGBAFormat,e.UnsignedByteType,new e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter)).needsUpdate=!0,d.flipY=!0,console.log(">>>>> generated SDF from bitmap in "+(performance.now()-f)+"ms")}c.material=new e.MeshBasicMaterial({force:!0,side:t.side?t.side:e.FrontSide,transparent:!0}),c.material._activatePDSFXMigrated(),c.material._PDSFXData._uniqueID="SDFTextNodePDSFX";var W={fontMap:{type:"t2",value:d},_color:{type:"v3",value:new e.Vector3(t.color.r,t.color.g,t.color.b)},ratio:{type:"f",value:b/y}};c.material.setPDSFXUniforms(W);c.material.setPDSFXVaryings({_uv:{type:"v2"}}),c.material.setPDSFXGlobalShaderCode(null,e=>`\n                    ${e.variableHandler.float("alpha")};\n                `);return c.material.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                        ${(t=>e.getVarying(t))("_uv")} = ${e.vGetAttribTexCoord0()}.xy;\n                    `}},{ComputeCommonValues:function(e,t){const i=e.variableHandler,r=e.functionHandler,n=e.pdsfxDefines,s=e=>i.float(e),a=(t=>e.getTextureUniform(t))("fontMap");return`\n                    \n                        ${s("epsilon")}  = 0.003;\n                        ${s("texel")}  = ${r.sample2DTexture(a,(t=>e.getVarying(t))("_uv"))}.r;\n                        ${n.extDerivatives?`\n                            ${s("w")} = clamp(200.0 * epsilon * (abs(dFdx(texel)) + abs(dFdy(texel))), 0.0, 0.5);\n                            `:`\n                            ${s("w")} = epsilon;\n                            `}\n\n                        alpha = smoothstep(0.5 - w, 0.5 + w, 1.0 - texel);\n                        alpha = pow(alpha, 1.0/2.2);\n                    `},ComputeDiscard:function(e,t){const i=e.variableHandler;return`\n                        ${(e=>i.float(e))("alphaTest")} = 0.01;\n                        // IR 797819\n                        return (alpha < alphaTest);\n                    `},ComputeAlbedo:function(e,t){return e.variableHandler,`\n                        return ${(t=>e.getUniform(t))("_color")};\n                    `},ComputeOpacity:function(e,t){return"\n                        return alpha;\n                    "}}),this.createMeshNode(c)},createTextNodeZoomable:function(t){var i=t.resolutionCoef||32,r="";t.bold&&(r+="font-weight : bold; "),t.italic&&(r+="font-style: italic;");var n=r+"font-family: '"+t.font+"'; font-size: "+i+"px;",s=t.precomputedTextSize||S._determineTextSize(t.text,n),a=s.width,o=s.height,l=a/o,h=t.side?t.side:e.FrontSide,u=t.textAlign?b[t.textAlign]:"left",p=t.textBaseline?M[t.textBaseline]:"top",f=t.textAlign?w[t.textAlign]:0,g=t.textBaseline?C[t.textBaseline]:0,m=t.zoom||1,v=a/i,_=t.fontSize*v*m,y=t.fontSize*v/l*m,x=!!t.stroke&&t.stroke,P=a,E=o;if(t._fix&&(!P||!E||!isFinite(E)||!isFinite(P)))return null;var T=new c({width:P,height:E,drawCB:function(e,r,n){var s=f*P,a=g*E;try{r.globalAlpha=void 0!==t.opacity?t.opacity:1,r.fillStyle="#"+t.color.getHexString(),r.lineWidth=0,r.strokeStyle="#"+t.color.getHexString();var o=(t.bold?"bold ":"")+(t.italic?"italic ":"");if(r.font=o+i+"px '"+t.font+"',Arra",r.textAlign=u,r.textBaseline=p,x?r.strokeText(t.text,s,a):r.fillText(t.text,s,a),t._debug&&(r.strokeStyle="red",r.moveTo(0,a),r.lineTo(P,a),r.stroke(),r.moveTo(0,0),r.moveTo(s,0),r.lineTo(s,E),r.stroke(),r.moveTo(0,0)),window.WUXDisableTextNodes)return void r.clearRect(0,0,P,E)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,depthWrite:t.depthWrite}),A=t.hotspot||{x:0,y:0};return t.bbox?new d({name:t.name,bottomLeftcorner:new e.Vector3(t.bbox[0],t.bbox[2],0),widthVector:new e.Vector3(t.bbox[1]-t.bbox[0],0,0),heightVector:new e.Vector3(0,t.bbox[3]-t.bbox[2],0),canvasNodeTexture:T,side:h},U):new d({name:t.name,bottomLeftcorner:new e.Vector3(-A.x*_,-A.y*y,0),widthVector:new e.Vector3(_,0,0),heightVector:new e.Vector3(0,y,0),canvasNodeTexture:T,side:h},U)},_createTextTexture:function({text:e,fontFamily:t,fill:i=!0,bold:r=!1,italic:n=!1,textAlign:s="left",textBaseline:a="top",color:o,opacity:l=1,resolutionCoef:h=32,precomputedTextSize:c}){const d=`${r?"font-weight : bold;":""} ${n?"font-style: italic;":""} font-family: '${t}'; font-size: ${h}px;`,u=c||S._determineTextSize(e,d),p=u.width,f=u.height;if(!(p&&f&&isFinite(f)&&isFinite(p)))return null;const g="#"+o.getHexString(),m=P[s],v=E[a];if(void 0===m)throw new Error(`Unknown text alignment: ${s}`);if(void 0===v)throw new Error(`Unknown text baseline: ${a}`);const _=m*p,x=v*f;return y.Utils.loadFromCanvas({width:p,height:f,draw:function(o){o.globalAlpha=l,o.lineWidth=0,o.fillStyle=g,o.strokeStyle=g,o.font=`${r?"bold":""} ${n?"italic":""} ${h}px '${t}',Arra`,o.textAlign=s,o.textBaseline=a,i?o.fillText(e,_,x):o.strokeText(e,_,x),window.WUXDisableTextNodes&&o.clearRect(0,0,p,f)}})},createCanvasNode:function(e){return new d(e,U)},createCanvas2DNode:function(e){return new p(e,U)},createCanvas2DInstancingNode:function(e){return new f(e,U)},createNodeFromTHREEMesh:function(e){var t=S.convertFromTHREEMesh(e);return this.createMeshNode(t)},createFixedSizeNode:function(e){return new u({name:(e=e||{}).name,ratio:e.ratio||1})}};return U}),define("Visualization/SceneGraphFactory",["DS/Visualization/SceneGraphFactory","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraphFactory"),e}),define("DS/Visualization/PolygonTessellator",["UWA/Class","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Mesh/MeshUtils","libtess/libtess.min"],function(e,t,i,r,n){"use strict";var s=0,a=e.extend({init:function(){this.polygons=[],this.polygonGroupEnd=[],this.currentPolygon=this._createEmptyPolygon()},addPointToCurrentPolygonLoop:function(e,t,i){var r;0===this.currentPolygon.points.length&&(this.currentPolygon.userData=i),this.currentPolygon.points.length>0&&(r=this.currentPolygon.points.length-2,this.currentPolygon.points[r]===e&&this.currentPolygon.points[r+1]===t)||(this.currentPolygon.points.push(e),this.currentPolygon.points.push(t))},closeCurrentPolygonLoop:function(){this.currentPolygon.points.length>2&&(this.currentPolygon.closed=!0,this.polygons.push(this.currentPolygon)),this.currentPolygon=this._createEmptyPolygon()},endCurrentPolygon:function(){this._startNewPolygon(),this.polygonGroupEnd.push(this.polygons.length)},createNode3D:function(e,n){var s,a,o,h,c,d,u,p,f=new i,g=[],m=this.polygonGroupEnd.length;for(u=0;u<m;u++){for(p=!0,h=[],s=0===u?0:this.polygonGroupEnd[u-1];s<this.polygonGroupEnd[u]&&p;s++)if(this.polygons[s].closed){for(c=[],a=this.polygons[s].points,o=0;o<a.length;o+=2)c.push(a[o],-a[o+1]);c.push(a[0],-a[1]),h.push(c)}else p=!1;if(h.length&&p)d=l(h,n),g=g.concat(d);else if(h.length)throw new Error("fill open polygon")}if(0===g.length)return null;for(var v=new Uint32Array(g.length/3),_=0;_<v.length;++_)v[_]=_;var y=[];for(_=0;_<g.length;_+=3)y.push(0,0,1);var S=t.createSimpleMeshNode({bufferPosition:g,bufferIndex:v,glType:r.ConnectivityTypeEnum.TRIANGLES,material:e,bufferNormal:y});return f.addChild(S),f},_startNewPolygon:function(){this.currentPolygon.points.length>2&&this.polygons.push(this.currentPolygon),this.currentPolygon=this._createEmptyPolygon()},_createEmptyPolygon:function(){return{points:[],closed:!1,userData:null,id:s++}}}),o=function(){var e=new n.GluTesselator;return e.gluTessCallback(n.gluEnum.GLU_TESS_VERTEX_DATA,function(e,t){t[t.length]=e[0],t[t.length]=e[1],t[t.length]=e[2]}),e.gluTessCallback(n.gluEnum.GLU_TESS_BEGIN,function(e){e!==n.primitiveType.GL_TRIANGLES&&console.log("expected TRIANGLES but got type: "+e)}),e.gluTessCallback(n.gluEnum.GLU_TESS_ERROR,function(e){console.log("error callback"),console.log("error number: "+e)}),e.gluTessCallback(n.gluEnum.GLU_TESS_COMBINE,function(e,t,i){return[e[0],e[1],e[2]]}),e.gluTessCallback(n.gluEnum.GLU_TESS_EDGE_FLAG,function(e){}),e}();function l(e,t){o.gluTessNormal(0,0,1);var i=[];o.gluTessBeginPolygon(i);for(var r=0;r<e.length;r++){o.gluTessBeginContour();for(var n=e[r],s=0;s<n.length;s+=2){var a=[n[s],n[s+1],t];o.gluTessVertex(a,a)}o.gluTessEndContour()}return o.gluTessEndPolygon(),i}return a}),define("DS/Visualization/Selection",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Visualization/PathElement","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/BufferGPUManager"],function(e,t,i,r,n,s,a,o,l,h,c){"use strict";const d=i._VisuFilterType;function u(e,t,i){if(t(e,i),"bag"===e.getType())for(var r=e.getChildren(),n=0;n<r.length;n++)u(r[n],t,i)}function p(e){for(var t=0;t<e.externalPath.length;t++){var i=e.externalPath[t];if(i instanceof THREEDS.Nodes.CGRNode&&"3DSyncBatch"===i.productType)return i}return null}function f(e,t,i){var a,l=[],h=[];if(e.sgNode instanceof r.SGPrimitiveHelper){(f=i.children[1]instanceof s?i.children[1]:i.children[0]).mesh3js&&h.push({mesh:f.mesh3js,element:e})}else{var c=function(e){var t=new Map;return u(e,function(e,t){if("rep"===e.getType()){var i=e.getIdentificationObject?e.getIdentificationObject():null,r=i?i.getLocalId():0;r&&t.set(r,e)}},t),t}(e),d=t.getLastElement(!0),p=i.children[1]instanceof n?i.children[1]:i.children[0],f=i.children[1]instanceof s?i.children[1]:i.children[0],g=p.children,m=(a=p,d.traverse(function(e,t){return e===t.parent},{parent:a},!0));m&&(g=[d]);for(var v=0;v<g.length;v++){var _=g[v],y=_.persistentId;if(y)if(c.get(y)){var S=new o;S.externalPath=t.externalPath.slice(),m||(S.addElement(p),S.addElement(_));for(var x=S._getRenderableOccurrences(),b=0;b<x.length;b++){var w=x[b];l.push(w)}c.delete(y)}}if(c.size>0){var M=new o;M.externalPath=t.externalPath.slice(),M.addElement(f);var C=M._getRenderableOccurrences();if(1===C.length){var P=c[Symbol.iterator]();for(var E of P)h.push({mesh:C[0],element:E[1]})}}}return{meshes:l,sgNodes:h}}const g={_findHLIndexOrAdd:function(e,t){var i,r=-1,n=e.highLight;n.map.has(t.container)?(i=n.map.get(t.container)).has(t.index)?r=i.get(t.index):i.set(t.index,n.primitives.length):((i=new Map).set(t.index,n.primitives.length),n.map.set(t.container,i));return r},_removeHLIndex:function(e,t){var i=e.highLight;if(i.map.has(t.container)){var r=i.map.get(t.container);r.has(t.index)&&(r.delete(t.index),0===r.size&&i.map.delete(t.container))}},_findHLIndex:function(e,t){var i=-1,r=e.highLight;if(r.map.has(t.container)){var n=r.map.get(t.container);n.has(t.index)&&(i=n.get(t.index))}return i},addHighLightPrimitive:function(e,t){if(e.highLight){var i=e.highLight,r=this._findHLIndexOrAdd(e,t);if(-1===r){var n=t.clone();i.primitives.push(n),i.nbSelected.push(1),null===e.layer&&e.initLayers(),e.layer.addPrimitivesToLayers([n],1)}else i.nbSelected[r]++}},addHighLightRep:function(e,t){if(e.highLight){for(var i=e.highLight,n=[],s=new r.SGPrimitiveHelper,a=0;a<t.getPrimitivesCount();a++){s.set(t,a);var o=this._findHLIndexOrAdd(e,s);if(-1===o){var l=s.clone();i.primitives.push(l),i.nbSelected.push(1),n.push(l)}else i.nbSelected[o]++}null===e.layer&&e.initLayers(),e.layer.addPrimitivesToLayers(n,1)}},removeHighLightPrimitive:function(e,t){if(e.highLight){var i=this._findHLIndex(e,t);if(-1!==i&&null!==e.layer){var r=e.highLight;r.nbSelected[i]--,r.nbSelected[i]||(this._removeHLIndex(e,t),r.primitives.splice(i,1),r.nbSelected.splice(i,1),e.layer.addPrimitivesToLayers([t.clone()],0))}}},removeHighLightRep:function(e,t){if(e.highLight){for(var n=[],s=e.highLight,a=new r.SGPrimitiveHelper,o=new Set,l=0;l<t.getPrimitivesCount();l++){a.set(t,l);var h=this._findHLIndex(e,a);-1!==h&&(s.nbSelected[h]--,s.nbSelected[h]||(this._removeHLIndex(e,a),o.add(h),n.push(a.clone())))}if(o.size>0){var c=new Array(s.primitives.length-o.size),d=new Array(s.nbSelected.length-o.size),u=0;for(l=0;l<s.primitives.length;l++)o.has(l)||(c[u]=s.primitives[l],d[u++]=s.nbSelected[l]);s.primitives=c,s.nbSelected=d}null===e.layer&&(e.layer=new i.BufferLayer(e)),e.layer.addPrimitivesToLayers(n,0)}},removeHighLight:function(e){e.highLight&&(e.layer=null,e.highLight.map.clear(),e.highLight.primitives=[],e.highLight.nbSelected=[])}};var m=0;return e.extend({init:function(e,t){this.id=m++,this.viewer=e,this.eventType=t,this.scene=e.internalSceneGraph.scene,this._defaultScene=this.scene,this._sceneHLMap=new Map,this.sceneHL=new i.Scene,this._sceneHLMap.set(this.scene,this.sceneHL),this.selectedMeshes=new Map,this.selectedMeshesFromPrim=new Map,this.selectedMeshesFromAdjacence=new Map,this.doubleSideHighlight=!0,this.matHL=null,this.node3DMap=new Map;var r={HSO:l,PSO:h};return this._xsoManager=r[this.eventType],this.toUnsubscribe=[],this._attachEvents(),this},_attachEvents:function(){this._detachEvents(!1,!1);var e=this,i=this._xsoManager;this.onSceneGraphUpdate=t.subscribe({event:"/VISU/onSceneGraphUpdate"},function(t){if(e.node3DMap.has(t.fromNode)){if("ADD"==t.eventType){var i=e.node3DMap.get(t.fromNode);e.addNodeToMap(t.toNode,e.node3DMap,i);for(var r=0;r<i.length;r++){var n=i[r].getLastElement(),s=t.toNode,a=[];e._getPaths(n,s,[],a);for(var l=0;l<a.length;l++){var h=new o(i[r].externalPath.slice());h.externalPath=h.externalPath.concat(a[l]),e._add(t.toNode,h)}}}"REMOVE"==t.eventType&&e.removeNodeToMap(t.toNode,e.node3DMap)}}),this.toUnsubscribe.push(i.onPostAdd(function(t){if(!("PSO"==e.eventType&&e.viewer&&e.viewer.pPicking&&e.viewer.pPicking.preferenceHideHL)&&null!==t){var i=t.pathElement,r=!!t.forceVisibility;!i&&t.options&&(i=t.options.pathElement,r=!!t.options.forceVisibility),i&&(e.add(i,t.parameters,r),e.viewer&&e.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach(function(t){e.add(t.pathElement,t.parameters,!!t.forceVisibility)}),e.viewer&&e.viewer.render({onlyPostProcess:!0}))}})),this.toUnsubscribe.push(i.onPostRemove(function(t){if(null!==t){var i=t.pathElement;!i&&t.options&&(i=t.options.pathElement),i&&(e.remove(i,t.parameters),e.viewer&&e.viewer.render({onlyPostProcess:!0})),t instanceof Array&&(t.forEach(function(t){e.remove(t.pathElement,t.parameters)}),e.viewer&&e.viewer.render({onlyPostProcess:!0}))}})),this.toUnsubscribe.push(i.onEmpty(function(){e.viewer&&e.viewer.render({onlyPostProcess:!0})}))},_detachEvents:function(e,i){var r;for(r=0;r<this.toUnsubscribe.length;r++)this._xsoManager.unsubscribe(this.toUnsubscribe[r]);this.toUnsubscribe=[],e||(t.unsubscribe(this.onSceneGraphUpdate),this.onSceneGraphUpdate=null)},_updateScene:function(e){(e=e||this._defaultScene)!==this.scene&&(this.scene=e,this._sceneHLMap.has(e)||this._sceneHLMap.set(e,new i.Scene),this.sceneHL=this._sceneHLMap.get(e))},setDoubleSideHighlight:function(e){this.doubleSideHighlight=e},_getPaths:function(e,t,i,r){var n,s;if(t!=e){i.unshift(t);var a=t.parents;for(s=a.length,n=0;n<s;n++)this._getPaths(e,a[n],i,r);i.shift(t)}else r.push(i.slice(0))},addNodeToMap:function(e,t,i){e.traverse(function(e){var r;if(e instanceof n)if((r=t.get(e))&&r.length){var s,a,o,l,h=r.concat([]);for(s=0;s<i.length;s++){for(o=i[s],l=!0,h.indexOf(o)>=0&&(l=!1),a=0;a<h.length&&l;a++)h[a].hash()===o.hash()&&(l=!1);l&&h.push(o)}t.set(e,h)}else t.set(e,i)})},removeNodeToMap:function(e,t){e.traverse(function(e){e instanceof n&&t.delete(e)})},add:function(e,t,i){var r;if(null!=e){for(var s=null,a=e&&e.getLastElement(!0),o=e&&e._getUniqueOccurrence(this.viewer),l=o&&o._getFilter(d._LOD_BRANCH)&&!o._getFilter(d.LOD);a&&a instanceof n&&(a.getPickParent()||l);)s=e,a=(e=e.getParentPath())&&e.getLastElement(!0),l=(o=e&&e._getUniqueOccurrence(this.viewer))&&o._getFilter(d._LOD_BRANCH)&&!o._getFilter(d.LOD);if(e||(e=s),null===(r=e.getLastElement()))return!1;r instanceof n&&this.addNodeToMap(r,this.node3DMap,[e]),this._add(r,e,i)}return!0},_add:function(e,t,i){var s=null;if(THREEDS.Nodes.CGRNode&&(s=p(t))&&e instanceof THREEDS.Nodes.CGRNode){var o=a.getFromSGNode(e.internalSceneGraph);t.internalPath.push(o),e=o}var l=t._getRenderableOccurrences(this.viewer),h=l.length;if(e instanceof n){if(h)for(var c=0;c<h;c++){var d=l[c];void 0!==t.instanceId&&d._instancingInfos&&(d._instancingInfos.pickedInstanceId=[t.instanceId]),this.addMesh(d,i)}}else if(s&&(e.sgNode instanceof r.SGRep||e.sgNode instanceof r.SGBag||h>1&&e.sgNode instanceof r.SGPrimitiveHelper)){var u=f(e,t,s);for(c=0;c<u.meshes.length;c++)this.addMesh(u.meshes[c],i);for(c=0;c<u.sgNodes.length;c++)this.addPrimitive(u.sgNodes[c].mesh,u.sgNodes[c].element,i,!1)}else{if(1!==h)return!1;this.addPrimitive(l[0],e,i,!1)}},remove:function(e){var t;if(e){for(var i=null,s=e&&e.getLastElement(!0),o=e&&e._getUniqueOccurrence(this.viewer),l=o&&o._getFilter(d._LOD_BRANCH)&&!o._getFilter(d.LOD);s&&s instanceof n&&(s.getPickParent()||l);)i=e,s=(e=e.getParentPath())&&e.getLastElement(!0),l=(o=e&&e._getUniqueOccurrence(this.viewer))&&o._getFilter(d._LOD_BRANCH)&&!o._getFilter(d.LOD);if(e||(e=i),null===(t=e.getLastElement()))return;var h=null;if(THREEDS.Nodes.CGRNode&&(h=p(e))&&t instanceof THREEDS.Nodes.CGRNode){var c=a.getFromSGNode(t.internalSceneGraph);e.internalPath.push(c),t=c}var u=e._getRenderableOccurrences(this.viewer),g=u.length;if(t instanceof n){if(this.node3DMap.has(t)&&this.removeNodeToMap(t,this.node3DMap),g)for(var m=0;m<g;m++){var v=u[m];void 0!==e.instanceId&&v._instancingInfos&&(v._instancingInfos.pickedInstanceId=[e.instanceId]),this.removeMesh(v)}}else if(h&&(t.sgNode instanceof r.SGRep||t.sgNode instanceof r.SGBag||g>1&&t.sgNode instanceof r.SGPrimitiveHelper)){var _=f(t,e,h);for(m=0;m<_.meshes.length;m++)this.removeMesh(_.meshes[m]);for(m=0;m<_.sgNodes.length;m++)this.removePrimitive(_.sgNodes[m].mesh,_.sgNodes[m].element,!1)}else{if(1!==g)return!1;this.removePrimitive(u[0],t,!1)}}},addPrimitive:function(e,t,i,r){var n=null,s=r?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(this._updateScene(e&&e.getScene()),!this.scene.containsMesh(e))return null;if(s.has(e)){var a=s.get(e);a.nbSelections++,a.hlMeshPrimScene||(a.hlMeshPrimScene=this.duplicateMeshForHighlight(e,!0,i,s===this.selectedMeshesFromPrim,s===this.selectedMeshesFromAdjacence),this.sceneHL.add(a.hlMeshPrimScene)),n=a.hlMeshPrimScene}else n=this.duplicateMeshForHighlight(e,!0,i,s===this.selectedMeshesFromPrim,s===this.selectedMeshesFromAdjacence),s.set(e,{hlMeshScene:null,hlMeshPrimScene:n,nbSelections:1}),this.sceneHL.add(n),e.addRefVBO(!1);if("rep"===t.getType()||"selectionGroup"===t.getType()){for(var o=!1,l=[],h=t.getChildren(),c=0;c<h.length;c++){var d=h[c];-1===g._findHLIndex(n,d.sgNode)?l.push(d):o=!0}if(o||"selectionGroup"===t.getType())for(c=0;c<l.length;c++)g.addHighLightPrimitive(n,l[c].sgNode);else g.addHighLightRep(n,t.sgNode)}else if("bag"===t.getType()){u(t,function(e,t){if("rep"===e.getType())for(var i=e.getChildren(),r=0;r<i.length;r++){var s=i[r];-1===g._findHLIndex(n,s.sgNode)&&t.push(s)}},h=[]);for(c=0;c<h.length;c++)g.addHighLightPrimitive(n,h[c].sgNode)}else if("primitive"===t.getType()){-1===g._findHLIndex(n,t.sgNode)&&g.addHighLightPrimitive(n,t.sgNode)}return n},addMesh:function(e,t){var i=null,r=e._occurrence,n=r&&r.isInCanvas2DPass()?["canvas2D"]:null;if(this._updateScene(e&&e.getScene()),!this.scene.containsMesh(e))return null;if(this.selectedMeshes.has(e)){var s=this.selectedMeshes.get(e);s.nbSelections++,s.hlMeshScene||(s.hlMeshScene=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.sceneHL.add(s.hlMeshScene,n)),i=s.hlMeshScene}else i=this.duplicateMeshForHighlight(e,!1,t,!1,!1),this.selectedMeshes.set(e,{hlMeshScene:i,hlMeshPrimScene:null,nbSelections:1}),this.sceneHL.add(i,n),e.addRefVBO(!1);if(i._instancingInfos&&"instance"===i._instancingInfos.instancingSelectionMode&&e._instancingInfos.pickedInstanceId.length){for(var a=!1,o=e._instancingInfos.pickedInstanceId[0],l=i._instancingInfos.pickedInstanceId,h=0;h<l.length;h++)if(l[h]==o){a=!0;break}a||(i._instancingInfos.pickedInstanceId.push(o),i._instancingInfos.nbInstances++,this.updateInstancedHighLightMesh(i,e))}return i},removeMesh:function(e){var t=null;if(e&&this.selectedMeshes.has(e)){var i=this.selectedMeshes.get(e);if(!(t=i.hlMeshScene))return null;if(i.nbSelections--,i.nbSelections){if(t._instancingInfos&&e._instancingInfos.pickedInstanceId.length){for(var r=-1,n=e._instancingInfos.pickedInstanceId[0],s=t._instancingInfos.pickedInstanceId,a=0;a<s.length;a++)if(s[a]==n){r=a;break}-1!=r&&(t._instancingInfos.pickedInstanceId.splice(r,1),t._instancingInfos.nbInstances--,this.updateInstancedHighLightMesh(t,e))}}else{i.hlMeshScene=null;var o=t.getScene();o&&o.remove(t),this.cleanHLMesh(t),i.hlMeshPrimScene||(this.selectedMeshes.delete(e),e.releaseVBO(!1),t=null)}}return t},getHighlightMeshIndex:function(e){var t;if(e.highlightMeshes)for(t=0;t<e.highlightMeshes.length;t++)if(e.highlightMeshes[t].selectionId===this.id)return t;return-1},setHighlightMesh:function(e,t){if("highlight"===this.attr){!e.highlightMeshes&&t&&(e.highlightMeshes=[]);var i=this.getHighlightMeshIndex(e),r=i>=0?e.highlightMeshes[i]:null;r?t?r.renderable=t:e.highlightMeshes.length>1?e.highlightMeshes.splice(i,1):e.highlightMeshes=null:t&&e.highlightMeshes.push(new HighlightMeshData(this.id,t))}else e[this.attr]=t},removeMeshAndPrimitives:function(e){if(e){var t=this,i=function(i){if(i.has(e)){var r,n=i.get(e),s=n.hlMeshScene,a=n.hlMeshPrimScene;if(s)(r=s.getScene())&&r.remove(s),t.cleanHLMesh(s);if(a)(r=a.getScene())&&r.remove(a),t.cleanHLMesh(a);i.delete(e),e.releaseVBO(!1)}};i(this.selectedMeshesFromPrim),i(this.selectedMeshesFromAdjacence),i(this.selectedMeshes)}},removePrimitive:function(e,t,i){var r=null;if(e){var n=i?this.selectedMeshesFromAdjacence:"rep"===t.getType()?this.selectedMeshes:this.selectedMeshesFromPrim;if(n.has(e)){var s=n.get(e);if(!(r=s.hlMeshPrimScene))return null;if(s.nbSelections--,"rep"===t.getType())g.removeHighLightRep(r,t.sgNode);else if("selectionGroup"===t.getType())for(var a=t.getChildren(),o=0;o<a.length;o++)g.removeHighLightPrimitive(r,a[o].sgNode);else"primitive"===t.getType()&&g.removeHighLightPrimitive(r,t.sgNode);if(r.isMeshHiddenByLayer()){s.hlMeshPrimScene=null;var l=r.getScene();l&&l.remove(r),this.cleanHLMesh(r)}s.nbSelections||s.hlMeshPrimScene||(n.delete(e),e.releaseVBO(!1),r=null)}}return r},updateHighlight:function(e){},_needsDepth:function(){return!1},duplicateMeshForHighlight:function(e,t,r,n,s){var a=i.Mesh.DuplicateMesh(e,{ignoreVisibility:t});return a.highLight={map:new Map,primitives:[],nbSelected:[]},a.occurrenceRenderingOverride=e.occurrenceRenderingOverride,a._occurrence=e._occurrence,a.matrixAutoUpdate=!1,a.visible=r||e.visible,a.visibilityFree=r||e.visibilityFree,a.castShadow=!1,a.receiveShadow=!1,n&&(a._programID|=i.ProgramIDs.PRIMITIVE_HIGHLIGHT),this._needsDepth()&&(a._programID|=i.ProgramIDs.POLITE_HIGHLIGHT),a},cleanHLMesh:function(e){if(e._instancingInfos){let i=[];var t=e._instancingInfos.instanceAttribArrays;for(let r in t)"id"!==r&&e._instancingInfos.instanceAttribArrays[r].buffer&&(i.push(e._instancingInfos.instanceAttribArrays[r].buffer),e._instancingInfos.instanceAttribArrays[r].buffer=null);c.deallocate(i)}},updateInstancedHighLightMesh:function(e,t){var i,r,n,s,a,o,l,h=t._instancingInfos.instanceAttribArrays;for(i in this.cleanHLMesh(e),e._instancingInfos.instanceAttribArrays={id:h.id},h)if("id"!==i){s=h[i].itemSize,e._instancingInfos.instanceAttribArrays[i]={itemSize:s},16===(a=h[i].isMat4?16:s)&&(e._instancingInfos.instanceAttribArrays[i].isMat4=!0),o=new Float32Array(e._instancingInfos.nbInstances*a),l=0;for(var c=0;c<e._instancingInfos.nbInstances;c++){n=(r=(e._instancingInfos.pickedInstanceId[c]/5-1)*a)+a;for(var d=r;d<n;d++)o[l++]=h[i].array[d]}e._instancingInfos.instanceAttribArrays[i].array=o,e._instancingInfos.instanceAttribArrays[i].buffer=null}},clearAll:function(e){var t,i=this;e?(t=function(t){var r=[];t.forEach(function(t,n,s){var a=t.hlMeshScene,o=t.hlMeshPrimScene;if(n.getScene()===e){var l;if(a)(l=a.getScene())&&l.remove(a),i.cleanHLMesh(a);if(o)(l=o.getScene())&&l.remove(o),i.cleanHLMesh(o);n.releaseVBO(!1),r.push(n)}});for(var n=0;n<r.length;n++)t.delete(r),r._occurrence&&r._occurrence.node&&i.removeNodeToMap(r._occurrence.node)},this._sceneHLMap.delete(e)):(t=function(e){e.forEach(function(e,t,r){var n,s=e.hlMeshScene,a=e.hlMeshPrimScene;s&&((n=s.getScene())&&n.remove(s),i.cleanHLMesh(s));a&&((n=a.getScene())&&n.remove(a),i.cleanHLMesh(a));t.releaseVBO(!1)}),e.clear()},this.node3DMap.clear(),this._sceneHLMap.clear()),t(this.selectedMeshes),t(this.selectedMeshesFromPrim),t(this.selectedMeshesFromAdjacence)}})}),define("Visualization/Selection",["DS/Visualization/Selection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Selection"),e}),define("DS/Visualization/AbstractHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/Selection"],function(e,t,i,r){"use strict";return r.extend({init:function(e,i){return this._parent(e,i),this.attr="",this.nodeMethod="",this.defaultSetting=null,this.highlightData=new t.HaloHighlightData,this.advanced=this.highlightData instanceof t.AdvancedPoliteHighlightData,this.sceneHL.highlightData=this.highlightData,this.onSelectionRemove=null,this.enabled=!0,this},getHighlightData:function(){this.advanced;var e=null;Object.assign(e,this.highlightData)},_updateScene:function(e){if(this._parent(e),this.sceneHL.highlightData!==this.highlightData){if(this.sceneHL.__webglObjectsAll)for(var i=this.sceneHL.getAllWebGLObjects(),r=0;r<i.length;r++){var n=i[r].object;this.advanced?n._programID|=t.ProgramIDs.POLITE_HIGHLIGHT:n._programID&=~t.ProgramIDs.POLITE_HIGHLIGHT,this.sceneHL.flagAsGSSOInvalidated(n)}this.sceneHL.highlightData=this.highlightData}},_detachEvents:function(t,i){i||(e.unsubscribe(this.onSelectionRemove),this.onSelectionRemove=null),this._parent(t,i)},enable:function(e){this.enabled=e},addMesh:function(e,i){if(e instanceof t.CSS2DNode)return e.element.classList.add("wux-css2dnode-highlighted"),null;if(!e||!e._occurrence)return null;var r=e._occurrence.node;if(r&&r[this.nodeMethod]())return null;var n=this._parent(e,i);return n&&this.setHighlightMesh(e,n),n},removeMesh:function(e){if(e instanceof t.CSS2DNode)return e.element.classList.remove("wux-css2dnode-highlighted"),null;var i=this._parent(e);this.setHighlightMesh(e,i)},addPrimitive:function(e,t,i){if(!e||!e._occurrence)return null;var r=e._occurrence.node;if(r&&r[this.nodeMethod]())return null;var n=this._parent(e,t,i);return n&&this.setHighlightMesh(e,n),n},removePrimitive:function(e,t){var i=this._parent(e,t);this.setHighlightMesh(e,i)},getColorHighlight:function(){return console.warn("Warning: deprecated, use getHighlightData instead"),this.highlightData},getHighlightData:function(){return this.highlightData},isEqualColor:function(e){return!!e&&this.highlightData.isEqual(e)},setColorHighlight:function(e){console.warn("Warning: deprecated, use setHighlightData instead"),this.setHighlightData(this.advanced,e)},setHighlightData:function(e,i){var r=0===this.highlightData.priority;e!==this.advanced&&(this.advanced=e,this.highlightData=e?new t.AdvancedPoliteHighlightData(this.defaultSetting.advancedpolite):new t.HaloHighlightData(this.defaultSetting.halo),this._updateScene(this.scene)),i?this.highlightData._setData(i):this.highlightData._setData(this.advanced?this.defaultSetting.advancedpolite:this.defaultSetting.halo),r&&(this.highlightData.priority=0)},_needsDepth:function(){return this.advanced}})}),define("Visualization/AbstractHighlightSelection",["DS/Visualization/AbstractHighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/AbstractHighlightSelection"),e}),define("DS/Visualization/HighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"HSO"),this.attr="highlight",this.nodeMethod="_getExcludeFromHL",this.defaultSetting=t.DefaultHighlightData,this.isMultiColorSet=!1,this.linkToHSO=!0,this.passes=[],this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},function(e){t.removeMeshAndPrimitives(e),t.setHighlightMesh(e,null)}),this.onCSIAddHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_ADD"},function(e){t.add(e.path,e.parameters)}),this.onCSIRemoveHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_REMOVE"},function(e){t.remove(e.path,e.parameters)}),this.onCSIHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE"},function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)})},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddHighlight),this.onCSIAddHighlight=null,e.unsubscribe(this.onCSIRemoveHighlight),this.onCSIRemoveHighlight=null,e.unsubscribe(this.onCSIHighlightUpdate),this.onCSIHighlightUpdate=null),this._parent(t,i)},__matches:function(e){var t=this.viewer;if(this.isMultiColorSet){if(e&&e.highlightColor&&this.highlightData.isEqual(e.highlightColor))return!e.viewer||e.viewer===t}else if(e&&!e.highlightColor||!e)return!e||!e.viewer||e.viewer===t;return!1},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},detachToHSO:function(){this.linkToHSO&&(this.linkToHSO=!1,this._detachEvents(!0,!0))},attachToHSO:function(){this.linkToHSO||(this.linkToHSO=!0,this._attachEvents())},setMultiColorMode:function(e){this.isMultiColorSet=e}})}),define("Visualization/HighlightSelection",["DS/Visualization/HighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/HighlightSelection"),e}),define("DS/Visualization/PreHighlightSelection",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/AbstractHighlightSelection"],function(e,t,i,r){"use strict";return r.extend({init:function(e){return this._parent(e,"PSO"),this.attr="preHighlight",this.linkToPSO=!0,this.nodeMethod="_getExcludeFromPreHL",this.defaultSetting=t.DefaultPreHighlightData,this.highlightData._setData(this.highlightData._needsDepth?this.defaultSetting.advancedpolite:this.defaultSetting.halo),this},_attachEvents:function(){this._parent();var t=this;this.onSelectionRemove=e.subscribe({event:"/VISU/SELECTION/REMOVE"},function(e){t.removeMeshAndPrimitives(e),e.preHighlight=null}),this.onCSIAddPreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_ADD"},function(e){t.add(e.path,e.parameters)}),this.onCSIRemovePreHighlight=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_REMOVE"},function(e){t.remove(e.path,e.parameters)}),this.onCSIPreHighlightUpdate=e.subscribe({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE"},function(e){t.__matches(e.parameters)&&t.setHighlightData(e.parameters.advanced,e.parameters.newColor)})},__matches:function(e){var t=this.viewer;return!e||!e.viewer||e.viewer===t},remove:function(e,t){return!!this.__matches(t)&&this._parent(e)},add:function(e,t,i){return!!this.__matches(t)&&this._parent(e,t,i)},_detachEvents:function(t,i){i||(e.unsubscribe(this.onCSIAddPreHighlight),this.onCSIAddPreHighlight=null,e.unsubscribe(this.onCSIRemovePreHighlight),this.onCSIRemovePreHighlight=null,e.unsubscribe(this.onCSIPreHighlightUpdate),this.onCSIPreHighlightUpdate=null),this._parent(t,i)},detachToPSO:function(){this.linkToPSO&&(this.linkToPSO=!1,this._detachEvents(!0,!0))},attachToPSO:function(){this.linkToPSO||(this.linkToPSO=!0,this._attachEvents())}})}),define("Visualization/PreHighlightSelection",["DS/Visualization/PreHighlightSelection","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/PreHighlightSelection"),e}),define("DS/Visualization/InternalSceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Object3D/Root3D","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents"],function(e,t,r,n,s,a,o,l,h,c,d,u){"use strict";var p,f,g,m=t.__visibleInCurrentSpace,v=e.extend({init:function(e,t,i,r){return this.parentSceneGraph=null,this.bShowReferenceAxisSystem=!0,this.lockShowReferenceAxisSystem=i,this.viewer=e,this.drivesTheRobot=!1,this.viewpointAdded=!1,this.userRoot=new n,this.userRoot.setLinkedToSceneGraph(!0),(t||window.userRootOutOfPathElements)&&this.userRoot.setNotAllowedInPathElement(!0),this.viewer._svgMode&&(this.svgRoot=new n,this.svgRoot._isSVGRoot=!0,this.svgRoot._setIsAlwaysInForeground(!0)),this.robotRoot=new n,this.robotRoot.exludeFromBounding(!0),this.robotRoot._setVisibilityFree(!0),this.robotRoot._setIsAlwaysInForeground(!0),r&&e._safeInternalSceneGraph?this.lightRoot=e._safeInternalSceneGraph.lightRoot:(this.lightRoot=new n,this.lightRoot.exludeFromBounding(!0),this.lightRoot._setVisibilityFree(!0)),this._robot=null,this._customReferenceAxisSystem=null,this._sceneInstances=[],this.addSceneInstance(!0),this.modelEvents=new u,this._needClippingUpdate=!1,this.selectionHL=e.__selectionHL,this.selectionPreHL=e.__selectionPreHL,this._subscribedEvents=[],this._onViewpointChangedEvent=null,this.excludedFromBoundingNodes=new Map,this._savedSceneMin=null,this},addSceneInstance:function(e){let s=null;for(let e=0;e<this._sceneInstances.length;e++)if(null==this._sceneInstances[e])s=e;else if(!this._sceneInstances[e].used)return this._sceneInstances[e].used=!0,e;let a=new n("",!0);a.setLinkedToSceneGraph(!0),a.setNotAllowedInPathElement(!0);var o=this;a.subscribe("onready",function(){o.modelEvents.publish("onready")}),a.addChild(this.userRoot),a.addChild(this.lightRoot),e&&a.addChild(this.robotRoot),this.svgRoot&&a.addChild(this.svgRoot);let l=new t.Scene;this._sceneInstances.length&&(l.__lights=this._sceneInstances[0].scene.__lights),l.matrixWorldNeedsUpdate=!1;let h=new r;return h.setViewer(this.viewer),h.setInternalSceneGraph(this),l.add(h),a.setScene(h),h.setNode(this.root),null!=s?this._sceneInstances[i]={used:!0,root:a,scene:l,root3js:h}:(this._sceneInstances.push({used:!0,root:a,scene:l,root3js:h}),s=this._sceneInstances.length-1),1==this._sceneInstances.length&&(this._sceneInstances[0].used=!1,this.selectSceneInstance(0)),s},freeSceneInstance:function(e){if(0==e)this._sceneInstances[e].used=!1;else if(null!=this._sceneInstances[e])for(this._sceneInstances[e].root.removeChild(this.userRoot),this._sceneInstances[e].root.removeChild(this.robotRoot),this.svgRoot&&this._sceneInstances[e].root.removeChild(this.svgRoot),this._sceneInstances[e].scene.dispose(!0),this._sceneInstances[e]=null;null==this._sceneInstances[this._sceneInstances.length-1];)this._sceneInstances.splice(e,1)},selectSceneInstance:function(e){this.scene=this._sceneInstances[e].scene,this.root3js=this._sceneInstances[e].root3js,this.root=this._sceneInstances[e].root},onSelectViewpoint:function(){this.subscribeToOnViewpointChanged()},subscribeToOnViewpointChanged:function(){var e=this.viewer.currentViewpoint,t=this._onViewpointChangedEvent,i=!1;if(t){if(e===t.object)return;t.object.unsubscribe(t.token),this._onViewpointChangedEvent=null,i=!0}var r=this.viewer.currentViewpoint.onMove(this.onViewpointChange.bind(this));this._onViewpointChangedEvent={object:this.viewer.currentViewpoint,token:r},i&&this.onViewpointChange()},onAddViewpoint:function(){if(this.subscribeToOnViewpointChanged(),!this.viewpointAdded){var e=this.viewer.onViewerResize(this.onViewpointChange.bind(this));this._subscribedEvents.push({object:this.viewer,token:e})}this.viewpointAdded=!0,this.lockShowReferenceAxisSystem||this.showReferenceAxisSystem(this.bShowReferenceAxisSystem,!0)},onViewpointChange:function(){var e=this.viewer.currentViewpoint;e&&(e._updateRobotCamera(this),this._robot&&this._robot.onViewpointChange(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode.onViewpointChange())},_detachEvents:function(){var e,t;for(e=0;e<this._subscribedEvents.length;e++)(t=this._subscribedEvents[e]).object.unsubscribe(t.token);this._subscribedEvents=[]},getChildByName:function(e){return this.root.getChildByName(e)},getMeshMin:function(e,i){var r,n,s,a,o,l=void 0!==i?i:"z",h=null,c=new t.Vector3;for(n=null,s=0,e.geometry.length>=0?(n=e.geometry[0],s=e.geometry.length):2===e.geometry._type&&(n=e.geometry,s=1),a=0;a<s;a++){if(null===n.vertexPositionArray){n=e.geometry[a+1];continue}r=e._getMMMatrix();const t=n.getVertexCount();for(o=0;o<t;o++)n.getVertexPosition(o,c),c.applyMatrix4(r),(c[l]<h||null===h)&&(h=c[l]);n=e.geometry[a+1]}return h},getSceneMin:function(e,i){if(this._savedSceneMin=0,!this.root3js)return 0;var r="z";if(i&&i.upVector.y>0&&(r="y"),e){if(this.root){var n=this.root.getBoundingBox("show");if(n)return this._savedSceneMin=n.min[r],n.min[r]}return 0}var s,a,o,l,h,c=this.root3js.children,d=null,u=null,p=new t.Vector3;for(s=0,a=c.length;s<a;s++)if(!(o=c[s])._isDecal()&&m(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&(o.geometry.length&&o.geometry[0].drawingGroups.length||o.isCurvedPipe)){if(o._instancingInfos&&o._instancingInfos.useDefaultInstancing){let e=o._occurrence;for(;e&&!e.node._instancingInfos;)e=e.parent;h=e?e.node.getTopZ(o,e,r):d}else{var f=o._getMMMatrix();p.copy(o.geometry.boundingSphere.center),p.applyMatrix4(f);let e=p[r];l=f?f.getMaxScaleOnAxis():1,h=e+o.geometry.boundingSphere.radius*l,o._BEbottomZ=e-o.geometry.boundingSphere.radius*l}(null===d||h<d)&&(d=h)}var g=[];for(s=0,a=c.length;s<a;s++){if(!(o=c[s])._isDecal())if(m(o.visible,o.visibilityFree,this.viewer.visibleSpace,o.layer,o._occurrence)&&o.frustumCulled&&o.geometry&&null!==o.geometry.boundingSphere&&o.geometry.boundingSphere.radius&&(o.geometry.length&&o.geometry[0].drawingGroups.length||o.isCurvedPipe))if(l=(f=o._getMMMatrix())?f.getMaxScaleOnAxis():1,o._BEbottomZ<d)if(o.isCurvedPipe||o.geometry[0].vertexPositionArray){var v=o.getMin(r,d);(null===u||v<u)&&(u=v)}else g.push(o)}if(g.length){var _=this.viewer.renderer.boundingBoxGPUCompute.computeZMinGPU(this.viewer,g);u=null===u?_:Math.min(_,u)}return this._savedSceneMin=u,u},getSavedSceneMin:function(){return this._savedSceneMin},updateShaders:function(){this.viewer.renderer.recompileAllShaders(null)},getBoundingSphere:function(e,i,r){var n=this.root._occurrences[0]?this.root._occurrences[0].getBoundingSphere(e,!0):null;return i||n&&!(n.radius<=0&&n.pixelRadius<=0)||(n=new t.Sphere(new t.Vector3,100)),n},clearSelection:function(){this.selectionHL.clearAll(this.scene),this.selectionPreHL.clearAll(this.scene)},addLightNode:function(e){this.lightRoot.addChild(e)},removeLightNode:function(e){this.lightRoot.removeChild(e,!0)},addRobotNode:function(e){this.robotRoot.addChild(e)},addUserNode:function(e,t){t?this.userRoot.children[0].addChild(e):this.userRoot.addChild(e)},removeUserNode:function(e,t){t?this.userRoot.children[0].removeChild(e,!0):e instanceof n||!e?this.userRoot.removeChild(e,!0):this.userRoot.removeChild(e._private_root,!0)},setRobot:function(e,t,i,r){return e&&!r&&(this.lockShowReferenceAxisSystem=!1),t=t||{},this.drivesTheRobot=!0,this.createAxisSystem(),this._robot&&e&&(this.robotRoot.remove(this._robot,!0),this._robot._dispose(),this._robot=null,this.robot=null),this._robot||this.createRobot(i,t,p),e?this._robot.setHiddenMode(!1):this._robot.setHiddenMode(!0),r||(this.robot=e?this._robot:void 0),!0},getRobot:function(){return this.drivesTheRobot?this.robot:this.getChildByName("robot")},setCustomReferenceAxisSystem:function(e){this._customReferenceAxisSystem&&(this.robotRoot.removeChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem._dispose(),this._customReferenceAxisSystem=null),e&&(this._customReferenceAxisSystem=new g(this.viewer,e),this._customReferenceAxisSystem.setRenderPasses(["robotOrtho"]),this.robotRoot.addChild(this._customReferenceAxisSystem),this._customReferenceAxisSystem.onViewpointChange())},clearScene:function(e,t,i){this.clearSelection();var r,n=this.userRoot.children.length;if("deprecated"===i)for(var s=this.userRoot.children[0];s.children.length;)s.remove(s.children[0]);else for(r=0;r<n;r++)this.userRoot.remove(this.userRoot.children[0])},getUserNodes:function(e){var t,i=[],r=this.getUserRoot(e);for(t=0;t<r.children.length;t++)i.push(r.children[t]);return i},getUserRoot:function(e){return e?this.userRoot.children[0]:this.userRoot},addDebugNode:function(e){this.debugRoot||(this.debugRoot=new n,this.debugRoot.excludeFromBounding=!0,this.root.addChild(this.debugRoot)),this.debugRoot.addChild(e)},removeDebugNode:function(e){this.debugRoot.removeChild(e)},showReferenceAxisSystem:function(e,t){t||(this.lockShowReferenceAxisSystem=!1),this.bShowReferenceAxisSystem=e,this.viewpointAdded&&(this.createAxisSystem(),this.updateReferenceAxisSystemVisibility())},createAxisSystem:function(){this.referenceAxisSystemNode||(this.referenceAxisSystemNode=new f("referenceAxisSystem",this.viewer),this.robotRoot.addChild(this.referenceAxisSystemNode),this.referenceAxisSystemNode.setCameraName("robotCameraOrtho"),this.referenceAxisSystemNode.setRenderPasses(["robotOrtho"]))},createRobot:function(e,t,i){this._robot=new i(this,"robot",e,t.snapOnFace,t.showOnlyManipulated,"I solemnly swear that I am up to no good.",t.touchMode);var r=e.getWorldOrientation();"zup"!==r._woName&&this._robot._setWorldOrientation(r),this.onViewpointChange(),this.updateReferenceAxisSystemVisibility()},updateReferenceAxisSystemVisibility:function(){this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(this.bShowReferenceAxisSystem)},setRobotAndRefAxisSystemEnabled:function(e){this._robot&&this._robot._setEnabled(e),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._setEnabled(e)},dispose:function(e){this._robot&&this._robot._dispose(),this.referenceAxisSystemNode&&this.referenceAxisSystemNode._dispose(),this._customReferenceAxisSystem&&this._customReferenceAxisSystem._dispose();for(let e=this._sceneInstances.length-1;e>=0;e--)this.freeSceneInstance(e);for(this._robot=null,this.robot=null,this.referenceAxisSystemNode=null,this._detachEvents(),this.clearScene();this.root.children.length;)this.root.removeChild(this.root.children[0]);var t;for(t in this.scene.dispose(e),this.selectionHL=null,this.selectionPreHL=null,this)this[t]=null},setWorldOrientation:function(e){this._robot&&this._robot._setWorldOrientation(e)},forceHighlightVisibility:function(e){if(this.selectionHL&&(this.selectionHL._updateScene(this.scene),this.selectionHL.sceneHL)){var t=this.selectionHL.sceneHL.children;this.forceHLVisibility(t,e)}},forcePreHighlightVisibility:function(e){if(this.selectionPreHL&&(this.selectionPreHL._updateScene(this.scene),this.selectionPreHL.sceneHL)){var t=this.selectionPreHL.sceneHL.children;this.forceHLVisibility(t,e)}},forceHLVisibility:function(e,t){if(t)for(var i=0;i<e.length;i++){(r=e[i]).visible=!0,r.visibilityFree=!0}else for(i=0;i<e.length;i++){var r,n=(r=e[i])._occurrence;n&&n.renderable&&(r.visible=n.renderable.visible,r.visibilityFree=n.renderable.visibilityFree)}},updateStaticOverrides:function(){v._enableStaticOverrides&&(this.root.traverseUnique(function(e){var t=e._getStaticOverrideSet();null!==t&&t._deactivateStaticOverrides()}),this.root.traverseUnique(function(e){var t=e._getStaticOverrideSet();null!==t&&t.applyStaticOverrides()}),this.root.forceUpdate())},addBEExcludedNode:function(e){e.id!=this.robotRoot.id&&this.excludedFromBoundingNodes.set(e.id,e)},removeBEExcludedNode:function(e){this.excludedFromBoundingNodes.delete(e.id)},getBEExcluded:function(e){let t=null,i=this._getBEExcludedNodeOccurences();for(let r=0;r<i.length;r++){let n=i[r].getBoundingSphere(e,!0);n&&(n.applyMatrix4(i[r].matrix),t?t.mergeWithSphere(n,t):t=n)}return t},_getBEExcludedNodeOccurences:function(){let e=[];for(let[t,i]of this.excludedFromBoundingNodes)if(i.getExcludeFromBounding())for(let t=0;t<i._occurrences.length;t++){let r=i._occurrences[t];r.scene3js==this.root3js&&e.push(r)}else this.removeBEExcludedNode(i);return e}});return v.setRobotClasses=function(e,t,i){p=e,f=t,g=i},v._enableStaticOverrides=!0,UWA.namespace("THREEDS/InternalSceneGraph",v)}),define("Visualization/InternalSceneGraph",["DS/Visualization/InternalSceneGraph","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/InternalSceneGraph"),e}),define("DS/Visualization/SceneGraphUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/SceneGraphNodes/AxisSystemNode"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p){"use strict";var f=null,g={_getUniqueOccurrence(e){if(!e)return null;var t=e._getOccurrences();return 1!==t.length?null:t[0]},getSagFromPathElement:function(e){if(!e)return 0;for(var t=0;t<e.externalPath.length;t++){if(e.externalPath[t].sag)return sag}return 0},getCurrentVisibility:function(e){if(!e)return!1;for(var t=0;t<e.externalPath.length;t++){if(!e.externalPath[t].isVisible())return!1}return!0},_getDGorLayers:function(e,t){var i=[],r=e.layer;if(r)for(var n=r.layers.length,s=0;s<n;s++){var a=r.layers[s];a.drawableInterval.layerNum<=0||(t&&4!==a.drawableGroup.glType||i.push(a))}else{var o=e.geometry.length;for(s=0;s<o;s++)for(var l=e.geometry[s].drawingGroups,h=l.length,c=0;c<h;c++)t&&4!==l[c].glType||i.push(l[c])}return i},_getCurrentGraphicProperties:function(t,i,r,n,s){for(var a=[],o=t.getLastElement(!0),l=t._getRenderableOccurrences(i),h=0;h<l.length;h++){var c=l[h],d=c.visible,p=c.layer,f=c.matApp,g=c.meshMaterial,m=c.gas,v=new u(t.externalPath),_={path:v,materials:[],gas:[],visible:d};a.push(_);for(var y=[],S=c._occurrence;S.node!==o;)y.unshift(S.node),S=S.parent;for(var x=0;x<y.length;x++)v.addElement(y[x]);var b=this._getDGorLayers(c,!0);for(x=0;x<b.length;x++){var w=b[x],M=null;p&&(M=w.drawableInterval,w=w.drawableGroup);var C=w.glType,P=null,E=null,T=f&&f._getMaterialFromGLType(C,w._geomType),A=M&&M.material?M.material:w.material,D=M&&M.gas?M.gas:w.gas;A&&(A.isMatApp&&(P=A.solveInheritance(f,c._occurrence.depth)===f?T:A._getMaterialFromGLType(C,w._geomType)),P||A.isMatApp||(T?f:null,(P=T)||(P=A instanceof e.Material?A:null))),P||(f,P=T),!P&&g&&g.force&&(P=g),E=m?m.getMaterial(D,C,null,null):D.isGAS?D.getMaterial(null,C,null,null):D,r||(P=null),n||(E=null);for(var I=!1,R=0;R<_.materials.length;R++){var O=_.materials[R],L=_.gas[R];if(O===P&&L===E){I=!0;break}}I||(_.materials.push(P),_.gas.push(E))}}return a},getCurrentGraphicProperties:function(e){for(var t=[],i=this._getCurrentGraphicProperties(e.pathElement,e.viewer,e.getMaterial,e.getColor||e.getOpacity,e.getVisibility),r=0;r<i.length;r++)for(var n=i[r],s=0;s<n.materials.length;s++){var a={pathElement:n.path};e.getMaterial&&(a.material=n.materials[s]);var o=n.gas[s];e.getOpacity&&(a.opacity=o?o.isGAS?o._alpha:o.opacity:1),e.getColor&&(a.color=o?o.isGAS?o._color:o.color:null),e.getVisibility&&(a.visibility=n.visible),t.push(a)}return t},getTrianglesCount:function(e,t){return e._getTrianglesCount(t)},_getCurrentMaterialOrGAS:function(e,t){var i="matApp"===t?"material":t,r=g._getUniqueOccurrence(e);if(!r)return null;for(var n=null;!n&&r;){if(r[t])return r[t];if(n=r.renderable){if(n[t])return n[t];var s=null;if(n.layer)for(var a=0;a<n.layer.layers.length;a++){var o=n.layer.layers[a];if(!(o.drawableInterval.layerNum<=0)&&(s=o.drawableInterval[i],4===o.drawableGroup.glType&&o.drawableInterval[i]))return s}else for(a=0;a<n.geometry.length;a++)for(var l=n.geometry[a],h=0;h<l.drawingGroups.length;h++){var c=l.drawingGroups[h];if(s=c[i],4===c.glType&&c[i])return s}return s}if(1!==r.children.length)break;r=r.children[0]}return null},getCurrentOpacity:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._alpha:t.opacity:1},getCurrentColor:function(e){var t=this._getCurrentMaterialOrGAS(e,"gas");return t?t.isGAS?t._color:t.color:null},getCurrentMaterial:function(e,t){var i=this._getCurrentMaterialOrGAS(e,"matApp");return i?"Face"===t?i._material:"GeomFace"===t?i._materialGeomFace:"Line"===t?i._materialLine:"Point"===t?i._materialPoint:i._material?i._material:i._materialGeomFace?i._materialGeomFace:i._materialLine?i._materialLine:i._materialPoint?i._materialPoint:null:null},applyMaterialToOccurrencePath:function(e,t,i){var r,n=e._getRenderableOccurrencesFromOccurrencePath(t);for(r=0;r<n.length;r++)n[r].material=i},applyMaterialToPath:function(e,t){return i._applyMaterialToPath(e,t)},applyVisibilityToPaths:function(t,r){for(var n=new Map,s=new e.Box3,a=0;a<t.length;a++){for(var o=t[a],l=o._getRenderableOccurrences(),h=l.length,c=0;c<h;c++)(g=l[c])&&g._flagAsGSSOInvalidated();var d=o.getLastElement();if(null===d)return!1;if(d instanceof i)2===r?d.setVisibility(!d.visible,!0):d.setVisibility(r,!0);else if(1===h)if((m=n.get(l[0]))||(m=[],n.set(l[0],m)),"rep"===d.getType()){var u=d.getChildren();for(c=0;c<u.length;c++)m.push(u[c].sgNode)}else"primitive"===d.getType()&&m.push(d.sgNode)}const p=n[Symbol.iterator]();var f=new e.Matrix4;for(const e of p){var g=e[0],m=e[1];null===g.layer&&g.initLayers(1),g.layer.addPrimitivesToLayers(m,r);for(c=0;c<g.geometry.length;c++){var v=g.geometry[c]._computeOrientedBoundingBox(f,g.layer.getIntervals(g.geometry[c]));s.union(v)}g._occurrence.node.forceBoundingBox(s)}},applyVisibilityToPath:function(e,t,r){if(null===e)return!1;var n=e._getRenderableOccurrences(),s=n.length;for(h=0;h<s;h++)(o=n[h])&&o._flagAsGSSOInvalidated();var a=e.getLastElement();if(null===a)return!1;if(r){if(1!==s)return!1;var o;null===(o=n[0]).layer&&o.initLayers(1),o.layer.addPrimitivesToLayers(r,t)}else if(a instanceof i)2===t?a.setVisibility(!a.visible,!0):a.setVisibility(t,!0);else{if(1!==s)return!1;r=[];if("rep"===a.getType())for(var l=a.getChildren(),h=0;h<l.length;h++)r.push(l[h].sgNode);else"primitive"===a.getType()&&r.push(a.sgNode);null===n[0].layer&&n[0].initLayers(1),n[0].layer.addPrimitivesToLayers(r,t)}return!0},getVisibilityFromPath:function(e,t){if(!e)return!1;var r=e._getRenderableOccurrences(t),n=r.length,s=e.getLastElement();if(!s)return!1;if(s instanceof i)return s.isVisible();if(1!==n)return!1;var a,o=r[0];if(null===o.layer)return!0;if("rep"===s.getType()){var l=s.getChildren();l[0]&&(a=l[0].sgNode)}else"primitive"===s.getType()&&(a=s.sgNode);for(var h=a.getGroup(),c=a.getStart(),d=o.layer.layers,u=0;u<d.length;u++){var p=d[u];if(h===p.drawableGroup){var f=p.drawableInterval;if(!(c<f.start||c>=f.start+f.count))return 1===f.layerNum}}return!1},getOrientedBoundingBoxFromPathElements:function(t,i,r,n){for(var s=new e.Box3,a=(new e.Matrix4).extractRotation(i),o=0;o<t.length;++o){var l=t[o].getOrientedBoundingBox(i,r,null,null,null,!!n);l&&(s=s.union(l))}return{cornerPoint:(new e.Vector3).copy(s.min).applyMatrix4(i),firstAxis:new e.Vector3(s.max.x-s.min.x,0,0).applyMatrix4(a),secondAxis:new e.Vector3(0,s.max.y-s.min.y,0).applyMatrix4(a),thirdAxis:new e.Vector3(0,0,s.max.z-s.min.z).applyMatrix4(a),localBBox:s}},getMaterialsFromPath:function(e,t,i){e.getRootNode()._tryOverridesUpdate(e);var r=t._getUniqueOccurrence(),n=null,s=null,a=null;return r&&r.renderable&&(s=[],this._traversePathMaterials(r,function(e){s.indexOf(e)<0&&s.push(e)},function(){},null,!1),r.overrideLink&&(a={color:r.overrideLink.getColor(),opacity:r.overrideLink.getOpacity(3),material:r.overrideLink.getFullMaterial()}),n={materials:s,overrides:a}),n},buildModelIdPath:function(e){var t,i,r,n={elements:[],subElements:[]},s=e.getLastElement();if(s instanceof p&&s._sgRep)t={id:s._sgRep.cgmId,namingContext:s._sgRep.namingContext},n.elements.push(t);else for(i=0;i<e.internalPath.length;i++)(r=e.internalPath[i].sgNode).getType&&3===r.getType()?n.subElements.push(r.getCgmId()):1!==r.type&&2!==r.type||(t={id:r.cgmId,namingContext:r.namingContext},n.elements.push(t));return n},buildPathElementFromModelIdPath:function(e,t){var i=e.getLastElement(!0);if(!(i instanceof r))return null;var a,o,l,h,c,d,p,f,g=null,m=t.elements,v=null,_=new s.SGPrimitiveHelper,y=!1;if(t.subElements.length>0&&(g=t.subElements[0])>0)for(a=0;a<i.mesh3js.geometry.length&&!y;a++)for(d=i.mesh3js.geometry[a],o=0;o<d.drawingGroups.length&&!y;o++)for(p=d.drawingGroups[o],l=0;l<p.getPrimitivesCount()&&!y;l++)if(_.set(p,l),_.getCgmId()===g){for(h=m.length-1,c=_.getRep();c&&h>=0&&c.cgmId===m[h].id;)c=c.parents[0],h--;!c&&h<0&&(y=!0)}if(y)(f=e._getUniqueOccurrence())&&(v=new u).setFromOccurrence(f,n.getFromSGNode(_));else if(1===m.length){var S=i.parents[0],x=S&&S.getChildByName("AxisSystems");if(x){for(a=0;a<x.children.length&&!y;a++){var b=x.children[a]._sgRep;b&&b.cgmId===m[0].id&&(y=x.children[a])}if(y){for(v=new u,a=0;a<e.externalPath.length&&e.externalPath[a]!==i;a++)v.addElement(e.externalPath[a]);v.addElement(x),v.addElement(y)}}}return v},buildPathesLeadingToNode:function(e,t){var i,r,n,s=[];for(i=0;i<e._occurrences.length;i++)r=e._occurrences[i],(n=new u).setFromOccurrence(r,null,t)&&s.push(n);return s},setRenderPriority:function(e,t,i){if(m.indexOf(t)<0)return console.warn("SceneGraphUtils.setRenderPriority invalid input priority value"),!1;var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,s={userPriority:null!==t,priority:t,userOpacity:!(!n||!n.userOpacity),opacity:n?n.opacity:null,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=s,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},setRenderPriorityOpacity:function(e,t,i){t||0===t||(t=null);var r=e._getUniqueOccurrence(i);if(r){var n=r.renderPriority,s={userPriority:!(!n||!n.userPriority),priority:n?n.priority:null,userOpacity:null!==t,opacity:t,lastRenderPriority:n?n.lastRenderPriority:-1};return r.renderPriority=s,r.node._forceUpdate(),!0}return console.warn("SceneGraphUtils.setRenderPriority error: invalid pathElement"),!1},_traversePathMaterials:function(t,i,r,n,s,a){if(null===t)return null;var o={};function l(e){var t=[],i=0;for(i=0;i<e.geometry.length;i++){var r=0,n=e.geometry[i];for(r=0;r<n.drawingGroups.length;r++){var s=n.drawingGroups[r];if(t[o[s.glType]]){if(t[o[s.glType]]!==s.gas)return null}else t[o[s.glType]]=s.gas}}return t}o[0]=0,o[3]=1,o[2]=1,o[1]=1,o[5]=2,o[6]=2,o[4]=2;var h=[];t.renderable&&h.push(t.renderable);for(var c=h.length,d=0;d<c;d++){var u=h[d],p=!a&&l(u);if(u.material&&u.material.force){var f=u.userData&&u.userData.oldMaterial?u.userData.oldMaterial:u.material;i(f,f,function(e){u.material=e},u)}else if(p){var g=p[2];g||(g=new e.MeshBasicMaterial),p[0]&&(g.point=p[0]),p[1]&&(g.line=p[1]),i(p[2],g,function(e){e.force=!0,u.material=e},u)}else if(s||u.layer){var m=0;for(m=0;m<u.layer.layers.length;m++){var v=u.layer.layers[m];a&&v.drawableGroup._geomType!==a||(v.drawableInterval.material?i(v.drawableInterval.material,v.drawableInterval.material,function(e){v.drawableInterval.material=e}):i(v.drawableGroup.gas,v.drawableGroup.gas,function(e){v.drawableInterval.material=e}))}}else{n&&n(u);var _=0;for(_=0;_<u.geometry.length;_++){var y=0,S=u.geometry[_];for(y=0;y<S.drawingGroups.length;y++){var x=S.drawingGroups[y];!x||a&&x._geomType!==a||i(x.gas,x.gas,function(e){u.layer.addPrimitivesToLayers(x.primitives,1,e)})}}}r()}},streamVisu:function(i){var r=["vertexIndexArray","vertexPositionArray","vertexNormalArray","vertexUvArray","vertexUv2Array","vertexTangentArray","vertexBinormalArray","vertexColorArray"],n=i.layers||!1,a=i.node?i.node:i,o=(i.nodejsContext,i.nodeCallback),l=i.imageCallback,h=i.loadedTexturesCallback,c=null,d=i.embeddedTextures||!1,u=0,p={textures:{},materials:{},geometries:{},nodes:{}},g=1e8,m=0,v=[{size:0,buffers:[],data:null}],_={json:p,chunks:v};function y(e){v[m].size+e.byteLength>g&&(v[++m]={size:0,buffers:[],data:null});var t=v[m],i=t.size;return t.buffers.push({buffer:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),offset:i}),t.size+=e.byteLength,t.size%4&&(t.buffers.push({buffer:new Uint8Array(4-t.size%4),offset:t.size}),t.size+=4-t.size%4),i}function S(){u--,console.log("nb textures loading: "+u),c&&!u&&c(_)}function x(t,i){if(t.image)if(t.image.getContext||t.image.tagName&&"img"===t.image.tagName.toLowerCase()){if(t.sourceFile&&"blob:"===t.sourceFile.substring(0,5)){var r=new XMLHttpRequest;r.open("GET",t.sourceFile,!0),r.responseType="blob",r.onload=function(e){if(200===this.status){var t=this.response.type;i.format="image/jpeg"===t?"jpeg":"png",i.data=this.response,i.path="texture_"+i.id+"."+i.format,console.log("canvas blob"),S()}},r.send()}else if(t.image.getContext){var n=(l=t.image.getContext("2d")).getImageData(0,0,t.image.width,t.image.height);i.format="png",i.data=n,i.path="texture_"+i.id+"."+i.format,console.log("png"),S()}}else if(t.mipmaps&&t.mipmaps.length){var s=t.image.width,a=t.image.height;i.format="dds",i.data=new Blob([e.ImageUtils.streamDDS(t)],{type:"arraybuffer"}),i.path="texture_"+i.id+"."+i.format,console.log("dds"),S()}else{s=t.image.width,a=t.image.height;var o=f||document.createElement("canvas");o.width=s,o.height=a;for(var l,h=(n=(l=o.getContext("2d")).getImageData(0,0,s,a)).data,c=0;c<a;c++)for(var d=0;d<4*s;d++)h[4*(a-c-1)*s+d]=t.image.data[4*c*s+d];l.putImageData(n,0,0,0,0,s,a);var u=atob(o.toDataURL("image/png").split(",")[1]),p=new Array(u.length);for(c=0;c<u.length;c++)p[c]=u.charCodeAt(c);var g=new Uint8Array(p);i.format="png",i.data=new Blob([g],{type:"image/png"}),i.path="texture_"+i.id+"."+i.format,console.log("uncompressed"),S()}}function b(i,r){if(!r.textures[i.id]){var n={id:i.id,anisotropy:i.anisotropy,magFilter:i.magFilter,minFilter:i.minFilter,wrapS:i.wrapS,wrapT:i.wrapT,repeat:i.repeat};if(l)l(i,n);else if(d)if(i.loadEndStatus&&i.loadEndStatus!==e.AssetLoadingStatus.READY){if(i.loadEndStatus===e.AssetLoadingStatus.ERROR)return void console.log("texture was not loaded: impossible to embed it in streamvisu.");u++,console.log("nb textures loading: "+u),i.onLoadCallbacks.push(function(e){x(e,n)})}else u++,console.log("nb textures loading: "+u),x(i,n);else if(i.sourceFile){n.format=t.getExtension(i.sourceFile);var s=function(e){var t="";if("blob:"===e.substring(0,5))return null;if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else{if("file://"===e.substring(0,7))return null;var i=location.href,r=i.indexOf("?");-1!==r&&(i=i.substring(0,r));var n=i.lastIndexOf("/");-1!==n&&(i=i.substring(0,n+1)),t=i+e}return t}(i.sourceFile);s&&(n.path=s)}r.textures[i.id]=n}return i.id}function w(t,i){var r="MeshPhong";t instanceof e.LineBasicMaterial?r="LineBasic":t instanceof e.PhysicalMaterial?r="Physical":t instanceof e.MeshLambertMaterial&&(r="MeshLambert");var n={id:t.id,type:r,visible:t.visible,force:t.force,side:t.side,enableClipPlanes:t.enableClipPlanes,transparent:t.transparent,opacity:t.opacity,alphaTest:t.alphaTest,depthTest:t.depthTest,depthWrite:t.depthWrite};return t.color&&(n.color=t.color),(t instanceof e.MeshPhongMaterial||t instanceof e.MeshLambertMaterial||t instanceof e.PhysicalMaterial)&&(n.ambient=t.ambient,n.emissive=t.emissive,n.specular=t.specular,n.shininess=t.shininess,n.vertexColors=t.vertexColors,void 0!==t.glossiness&&(n.glossiness=t.glossiness),void 0!==t.metalness&&(n.metalness=t.metalness),t.map&&(n.diffuseMap=b(t.map,i)),t.bumpMap&&(n.bumpMap=b(t.bumpMap,i)),t.normalMap&&(n.normalMap=b(t.normalMap,i)),t.specularMap&&(n.specularMap=b(t.specularMap,i)),t.emissiveMap&&(n.emissiveMap=b(t.emissiveMap,i)),t.metalnessMap&&(n.metalnessMap=b(t.metalnessMap,i)),t.glossinessMap&&(n.glossinessMap=b(t.glossinessMap,i)),t.bumpMap&&void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),t.coating&&(n.coating=t.coating),t.coating&&void 0!==t.coatingGlossiness&&(n.coatingGlossiness=t.coatingGlossiness)),n}return a.traverse(function(t,i){var a=i.nodes[t.id];if(!a){var l=t.getNodeType();if(a={id:t.id,type:l},t._matrix&&!t._matrix.isIdentity()){var h=[];t._matrix.flattenToArray(h),a.matrix=h}if(t.material&&((j=i.materials[t.material.id])||(j=t.material,i.materials[t.material.id]=w(j,i)),a.material=t.material.id),i.nodes[t.id]=a,"Node3D"===l){for(var c=[],d=0;d<t.children.length;d++)c.push(t.children[d].id);a.children=c}else{var u=t._occurrences[0].renderable,p=u.boundingSphere,f=u.boundingBox;f||(f=p.getBoundingBox());var g=!1;if(n)for(d=0;d<t._occurrences.length;d++)if(t._occurrences[d].renderable.layer){g=!0;break}var v=[];for(d=0;d<u.geometry.length;d++){var _=u.geometry[d].id;v.push(_);var S=i.geometries[_];if(!S){S=u.geometry[d];var x={};x.id=S.id;for(var b=0;b<r.length;b++){var M=S[r[b]];if(M){var C=y(M),P={chunk:m,offset:C,byteLength:M.byteLength,bpe:M.BYTES_PER_ELEMENT,itemSize:M.itemSize};x[r[b]]=P}}for(x.dgs=[],b=0;b<S.drawingGroups.length;b++){var E=S.drawingGroups[b];n&&g&&(E.__id__=b);for(var T=E.getPrimitivesCount(),A=0,D=0;D<T;D++)(L=E.getPrimitiveDecoration(D))&&L.length&&(A+=L.length);var I=new Uint32Array(4*T),R=new Uint8Array(A),O=0;for(D=0;D<T;D++){var L,V=E.getPrimitiveCgmId(D),F=E.getPrimitiveRep(D),B=E.getPrimitiveStart(D),N=E.getPrimitiveCount(D);if(I[4*D]=V,I[4*D+1]=F?F.cgmId:0,I[4*D+2]=B,I[4*D+3]=N,(L=E.getPrimitiveDecoration(D))&&L.length){console.log(L.length),L.length>255&&console.log("panic"),R[O++]=L.length;for(var G=0;G<L.length;++G)R[O++]=L[G]}else R[O++]=0}C=y(I);var k={chunk:m,offset:C,byteLength:I.byteLength,bpe:I.BYTES_PER_ELEMENT,itemSize:I.itemSize},U=void 0;if(A){var z=y(R);U={chunk:m,offset:z,byteLength:R.byteLength,bpe:R.BYTES_PER_ELEMENT,itemSize:R.itemSize}}x.dgs[b]={start:E.start,count:E.count,geomType:s.GeomTypeString[E._geomType],glType:E.glType,primitives:k,canonicals:U},E.material instanceof e.Material?(i.materials[E.material.id]||(i.materials[E.material.id]=w(E.material,i)),x.dgs[b].material=E.material.id):E.gas&&(i.materials[E.gas.id]||(i.materials[E.gas.id]=w(E.gas,i)),x.dgs[b].gas=E.gas.id)}i.geometries[_]=x}}if(a.mesh3js={bs:{c:[p.center.x,p.center.y,p.center.z],r:p.radius},bbox:{min:[f.min.x,f.min.y,f.min.z],max:[f.max.x,f.max.y,f.max.z]},geometries:v},n&&g)for(a.occurrences={},d=0;d<t._occurrences.length;d++){var H=t._occurrences[d].renderable;if(H.layer){var W=[];for(a.occurrences[d]={index:d,layers:W},b=0;b<H.layer.layers.length;b++){var j,X=H.layer.layers[b],q={start:X.drawableInterval.start,count:X.drawableInterval.count,primitiveStart:X.drawableInterval.primitiveStart,primitiveCount:X.drawableInterval.primitiveCount,layerNum:X.drawableInterval.layerNum};X.drawableInterval.material&&(q.material=X.drawableInterval.material.id,(j=i.materials[q.material])||(j=X.drawableInterval.material,i.materials[q.material]=w(j,i))),W.push({geometry:X.geometry.id,drawableGroup:X.drawableGroup.__id__,drawableInterval:q})}}}u.material&&((j=i.materials[u.material.id])||(j=u.material,i.materials[u.material.id]=w(j,i)),a.mesh3js.material=u.material.id)}o&&o(t,a)}},p),p.nbChunks=v.length,h&&(c=h),_.chunks=function(){for(var e=0;e<v.length;e++){var t=v[e];t.data=new Uint8Array(t.size);for(var i=0;i<t.buffers.length;i++)for(var r=t.buffers[i],n=r.buffer,s=r.offset,a=0;a<n.byteLength;a++)t.data[s+a]=n[a]}return v}(),!u&&c&&c(_),_}},m=[0,1,2,3,4];return g}),define("DS/Visualization/SceneGraph",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/SubElement","DS/Mesh/MeshUtils","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/Events","DS/Selection/HSOManager","DS/CoreEvents/ModelEvents","DS/Visualization/SceneGraphFactory","DS/Visualization/SceneGraphUtils"],function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";if(!window.undoSceneGraphMigrationStep2)return function(){}}),define("Visualization/SceneGraph",["DS/Visualization/SceneGraph","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SceneGraph"),e}),define("DS/Visualization/Viewpoint",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Animation/ANIM","DS/Animation/PropertyAnimation","DS/Animation/AnimationPath","DS/Visualization/TrackballControls","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Visualization/WorldOrientation","DS/VisuMePreferences/MePreferences","DS/WAFData/WAFData"],function(e,t,i,r,n,s,a,o,l,h,c,d,u){"use strict";var p=new i.Projector,f=new i.Matrix4,g=0,m=e.extend({init:function(e,t,r,n,s){var a,o,l;e.hasOwnProperty("viewer")?(this.viewer=e.viewer,this.projectionType=void 0!==e.projectionType?e.projectionType:m.PERSPECTIVE,a=void 0!==e.angle?e.angle:void 0!==e.fov?e.fov:45,e.fov&&console.warn("Deprecated. Use options.angle instead."),o=void 0!==e.near?e.near:10,l=void 0!==e.far?e.far:2500,h=void 0===e.defaultController||e.defaultController):(console.warn("Deprecated. You must use a litteral object to define your viewpoint."),this.viewer=e,a=void 0!==t?t:45,o=void 0!==r?r:10,l=void 0!==n?n:2500,this.projectionType=m.PERSPECTIVE,h=void 0===s||s),this.id=g++,this._isMain=!1,this.viewer._viewpointManager&&this.viewer._viewpointManager.registerViewpoint(this),this.useWebGPU=!!this.viewer.renderer&&this.viewer.renderer.renderer.use_webgpu,this._worldOrientation=c.ZUpYRight,e.inactive||this.createDivCSS();var h,d=(this.viewer.canvas.offsetWidth?this.viewer._getCanvasOffsetWidth():1)/(this.viewer.canvas.offsetHeight?this.viewer._getCanvasOffsetHeight():1);return this.projectionType===m.PERSPECTIVE?this.camera=new i.PerspectiveCamera(a,d,o,l,this.useWebGPU):(this.camera=new i.OrthographicCamera(0,0,0,0,o,l,this.useWebGPU),this.camera.setVisualizedHeight(null,d,a)),this.camera._renderingRole=i._CameraRoles.PRINCIPAL+(e._roleShift?e._roleShift:0),this._renderedCamera=this.camera,this.camera._viewpoint=this,this.robotCameraOrtho=new i.OrthographicCamera(0,0,0,0,o,l,this.useWebGPU),this.camera.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(400,d,a),this.robotCameraOrtho._viewpoint=this,this.robotCameraOrtho._setRobotRenderingRoleFromPrincipal(this.camera),this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._viewpoint=this,this.connectedRobotCamera._setRobotConnectedRenderingRoleFromPrincipal(this.camera),this.target=new i.Vector3,this.position=new i.Vector3,this.defaultReframeTime=400,this.sceneGraphRoot=null,this._internalSceneGraph=null,this.control=null,this._mePreferenceSetting=null,this._forcedController=null,this._2DModePreviousController=null,this._currentDefaultController="COMBINED",this._isMoving=!1,this.updateAnimation=function(e){},this._viewpointAnimation=null,this._frustum=new i.Frustum,this.setDefaultController(h),h||this.resetCameraOrientation(),this.viewer.internalSceneGraph&&this._updateRobotCamera(this.viewer.internalSceneGraph),this._customReframeCB=null,this._customCenterCameraCB=null,this._2DMode=!1,this._nativeTranslationOffset=null,this._nativeZoomType=null,this._nativeZoomRatio=null,this._nativeZoom=1,this._clip=0,this._bottomleftClip=null,this._toprightClip=null,this._anchor=0,this._XMaxTranslationBound=1e10,this._XMinTranslationBound=-1e10,this._YMaxTranslationBound=1e10,this._YMinTranslationBound=-1e10,this._depthMode=0,this._unlockMoveIn360Mode=!1,this._focusMode=m._FOCUS_MODE.TRANSLATION,this._SWXCoreViewManipulation=null,this._csiUID=null,this},createDivCSS:function(){this.divCameraCSSElement=UWA.createElement("div"),this.divCameraCSSElement.style.WebkitTransformStyle="preserve-3d",this.divCameraCSSElement.style.MozTransformStyle="preserve-3d",this.divCameraCSSElement.style.oTransformStyle="preserve-3d",this.divCameraCSSElement.style.transformStyle="preserve-3d",this.divCameraCSSElement.id="camera",this.viewer.divCss3DElement.appendChild(this.divCameraCSSElement),this.viewer.divCss3DElement.style.overflow="hidden",this.divCameraCSSElement.style.width=this.viewer.divCss3DElement.style.width,this.divCameraCSSElement.style.height=this.viewer.divCss3DElement.style.height},isMain:function(){return this._isMain},setCsiUID:function(e){this._csiUID=e},getCsiUID:function(){return this._csiUID},getWorldOrientation:function(){return this._worldOrientation},getCamera:function(){return this.camera},setUnlockMoveIn360Mode:function(e){this._unlockMoveIn360Mode=e},getUnlockMoveIn360Mode:function(){return this._unlockMoveIn360Mode},getCameraTarget:function(){return console.warn("DEPRECATED"),this.target},getCameraPosition:function(){return console.warn("DEPRECATED"),this.position},getControl:function(){return this.control},setEyePosition:function(e){var t=e.clone().add(this.getSightDirection().multiplyScalar(this.getTargetDistance()));this.control.setTarget(t),this.control.update()},getEyePosition:function(){return this.camera.position.clone()},setSightDirection:function(e){e.normalize();var t=this.camera.getLookAt();t.normalize();var r=Math.acos(e.clone().dot(t));if(r){var n=e.clone().cross(t);n.normalize();var s=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(s,this.control.orientation.clone());var a=this.getEyePosition().add(e.clone().multiplyScalar(this.getTargetDistance()));this.control.setTarget(a)}this.control.update()},getSightDirection:function(){return this.camera.getLookAt()},setUpDirection:function(e){e.normalize();var t=this.camera.up.clone(),r=Math.acos(e.dot(t));if(r){var n=e.clone().cross(t);n.normalize();var s=(new i.Quaternion).setFromAxisAngle(n,-r);this.control.orientation.multiplyQuaternions(s,this.control.orientation.clone())}this.control.update()},getUpDirection:function(){return this.camera.up.clone()},setAngle:function(e){this.camera.fov=(360+e)%360,this.control.update()},getAngle:function(){return this.camera.fov},setTarget:function(e){var t=this.getEyePosition(),r=e.clone().sub(t).normalize(),n=Math.acos(r.dot(this.getSightDirection()));if(n){var s=r.clone().cross(this.getSightDirection()).normalize(),a=(new i.Quaternion).setFromAxisAngle(s,-n);this.getControl().orientation.multiplyQuaternions(a,this.control.orientation.clone())}this.getControl().setTarget(e),this.getControl().distanceToTarget=e.distanceTo(t),this.control.update()},getTarget:function(){return this.target.clone()},setTargetDistance:function(e){var t=this.getEyePosition().add(this.getSightDirection().multiplyScalar(e));this.control.setTarget(t),this.control.distanceToTarget=e,this.projectionType===m.ORTHOGRAPHIC&&this.camera.setVisualizedHeight(e),this.control.update()},getTargetDistance:function(){return this.getControl().distanceToTarget},setProjectionType:function(e){if((!this._2DMode||1===e)&&e!==this.projectionType){if(this.projectionType=e,!this.cameraOther){var t=this.camera.near,r=this.camera.far;e===m.PERSPECTIVE?this.cameraOther=new i.PerspectiveCamera(this.camera.fov,this.camera.aspect,t,r,this.useWebGPU):this.cameraOther=new i.OrthographicCamera(0,0,0,0,t,r,this.useWebGPU),this.cameraOther._renderingRole=this.camera._renderingRole,this.cameraOther._viewpoint=this}this.cameraOther.position=this.camera.position,this.cameraOther.fov=this.camera.fov,this.cameraOther.aspect=this.camera.aspect,this.cameraOther.pixelCulling=this.camera.pixelCulling,this.camera.fullWidth&&this.cameraOther.setViewOffsetInternal(this.camera.fullWidth,this.camera.fullHeight,this.camera.x,this.camera.y,this.camera.width,this.camera.height);var n=this.camera;this.camera=this.cameraOther,this.connectedRobotCamera=this.camera.clone(),this.connectedRobotCamera._setRobotConnectedRenderingRoleFromPrincipal(this.camera),this.connectedRobotCamera._viewpoint=this,this.cameraOther=n,this.camera.updateMatrix(),this.camera.matrixWorld.copy(this.camera.matrix),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera._hasChanged=!0,this.control.camera=this.camera,this.control.update(),this.viewer.render()}},getProjectionType:function(){return this.projectionType},_setIntraOccularDistance:function(e){},setPixelCulling:function(e,t){this.viewer&&this.viewer.setPixelCulling(e,t)},_setPixelCulling:function(e){this.camera.pixelCulling=e},_setApplicationDefaultController:function(){if(null===this.control)return;let e="3dexperience",t="catia",i="solidworks",r="COMBINED",n="CATIA",s="SWX";this._mePreferenceSetting=null;let a=this;this._mePreferenceToken&&d.unsubscribe(this._mePreferenceToken),this._mePreferenceToken=d.subscribe(d.PREFERENCES.NAVIGATIONMODE,function(o){o&&o.toLowerCase&&((o=o.toLowerCase())==e?(a._mePreferenceSetting=r,a._2DMode||a.setDefaultController(!0,r)):o==t?(a._mePreferenceSetting=n,a._2DMode||a.setDefaultController(!0,n)):o==i&&(a._mePreferenceSetting=s,a._2DMode||a.setDefaultController(!0,s)))})},_setApplicationDefaultController_old:function(e){if(null===this.control)return;var t=this,i=function(){};let r="3dexperience",n="catia",s="solidworks",a="COMBINED",o="CATIA",l="SWX";if(this._mePreferenceSetting=null,window.widget&&window.widget.getValue("x3dPlatformId")){var h=function(e){e&&e.toLowerCase&&((e=e.toLowerCase())==r?(t._mePreferenceSetting=a,t._2DMode||t.setDefaultController(!0,a)):e==n?(t._mePreferenceSetting=o,t._2DMode||t.setDefaultController(!0,o)):e==s&&(t._mePreferenceSetting=l,t._2DMode||t.setDefaultController(!0,l)))};if(require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices"],function(e){var t=window.widget,r=function(e){if(e&&e.repositories){var t=e.repositories[0].preferences[0].value;h(t)}};e.getServiceUrl({serviceName:"mepreferences",platformId:t.getValue("x3dPlatformId"),onComplete:function(e){if(void 0!==e){e[0].url&&(e=e[0].url);var t=e+"/api/v1/preferences";u.authenticatedRequest(t,{method:"POST",type:"json",data:JSON.stringify({repositories:[{name:"VisualizationRepository",preferenceNames:["SWNavigationMode"]}]}),headers:{"Content-Type":"application/json"},onComplete:r,onFailure:i})}},onFailure:i})}),!e){require(["DS/PlatformAPI/PlatformAPI"],function(e){e.subscribe("com.ds.mep:onPrefUpdate",function(e,t){if(e){let t=e[2].tenantId,i=JSON.parse(e[1].preferences).repositories;if(t&&t!=window.widget.getValue("x3dPlatformId"))return;let r=null,n=null;if(i){for(let e=0;e<i.length;e++)if("VisualizationRepository"==i[e].name){i[e].preferences.length&&(r=i[e].preferences);break}if(r)for(let e=0;e<r.length;e++)if("SWNavigationMode"==r[e].name){n=r[e].value;break}h(n)}}})})}}},getDefaultController:function(){return this.control?this._currentDefaultController:null},setDefaultController:function(e,t,i){if(!this._forcedController||t==this._forcedController){var r={SIMPLE:a.Mode.SIMPLE,CATIA:a.Mode.CATIA,COMBINED:a.Mode.COMBINED,LOOKAROUND:a.Mode.LOOKAROUND};if(e||null!==this.control)if("FLY_WALK"===t&&this.control)this.control.setForceFlyWalkState(!e);else{if(e){let e=null;var n=!1;if(null==this.control&&(this.control=new a(this,this.viewer.canvas),e="COMBINED",n=!0),"SWX"==t||localStorage.getItem("forceSWXControls")&&"true"===localStorage.getItem("forceSWXControls")){if(null==this._SWXCoreViewManipulation){var s=this;require(["DS/SWXCoreManipulation/SWXCoreViewManipulation"],function(e){if(null==s._SWXCoreViewManipulation){let t={viewer:s.viewer};s._SWXCoreViewManipulation=new e,s._SWXCoreViewManipulation.setup(t),s._SWXCoreViewManipulation.enable(),s._SWXCoreViewManipulation.enableViewerCallbacks=!0}else s._SWXCoreViewManipulation.enable();i&&i()})}else this._SWXCoreViewManipulation.enable(),i&&i();e="SWX"}else void 0!==t&&(null!=r[t]&&(e=t),this._SWXCoreViewManipulation&&this._SWXCoreViewManipulation.disable(),this.control.setMode(r[t]));if(null!=e&&(this._currentDefaultController=e),!n)return;this.control.rotateSpeed=1,this.control.lockZRotationSpeed=.002,this.control.zoomSpeed=5,this.control.panSpeed=1.1}else null!==this.control&&this.control.detachEvents(),this.control=null;this.resetCameraOrientation()}}},setControlActive:function(e){null!==this.control&&this.control.setActive(e)},addDivToManipulation:function(e){return!!this.control&&this.control.addViewToManipulation(e)},removeDivToManipulation:function(e){return!!this.control&&this.control.removeViewFromManipulation(e)},onReframe:function(e){this._customReframeCB=e},onCenterCamera:function(e){this._customCenterCameraCB=e},_setFocusMode:function(e){this._focusMode=e},__rotatedFocusMoveTo:function(e){e.sight=e.sightDirection,e.position=e.eyePosition;var a,o,l,h;if(l=e.distanceToTarget,e.orientation)h=e.orientation,(m=new i.Vector3(0,0,-1)).applyQuaternion(h),m.normalize(),a=m;else if(e.sight){a=e.sight.clone().normalize();var c=this.camera.getLookAt().clone().normalize(),d=Math.acos(a.dot(c));if(d){var u=a.clone().cross(c).normalize(),p=(new i.Quaternion).setFromAxisAngle(u,-d);h=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else h=this.control.orientation.clone(),a=c}var f={position:o=e.position,target:v=(new i.Vector3).addVectors(o,a.clone().multiplyScalar(l)),distanceToTarget:l,orientation:h,duration:e.duration||0};this._viewpointAnimation&&this._viewpointAnimation.stop();var g={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===f.duration){var m;t.publish({event:"/VISU/",data:g}),(m=new i.Vector3(0,0,-1)).applyQuaternion(f.orientation),m.normalize();var v=(new i.Vector3).addVectors(this.control.position,m.multiplyScalar(f.distanceToTarget));this.control.setTarget(v),this.control.orientation=f.orientation.clone(),this.control.distanceToTarget=f.distanceToTarget,this.control.update();var _={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:_})}else{var y=new s({orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget},{orientation:f.orientation,distanceToTarget:f.distanceToTarget},f.duration);y.setInterpolator(function(e,t,r){var n={},s=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,s,e),n.orientation=s,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n}),this.updateAnimation=function(e){if(this.control){var t=new i.Vector3(0,0,-1);t.applyQuaternion(e.orientation),t.normalize();var r=(new i.Vector3).addVectors(this.control.position,t.multiplyScalar(e.distanceToTarget));this.control.setTarget(r),this.control.orientation=e.orientation.clone(),this.control.distanceToTarget=e.distanceToTarget,this.control.update()}};var S=this;this._viewpointAnimation=new n(this,"updateAnimation",y,function(e){if(e===r.State.STOPPED){var i={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:S,cameraEye:S.camera.position,cameraUp:S.camera.up};t.publish({event:"/VISU/",data:i})}}),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:g})}},NativeZoomTypes:{MillimeterScreenBased:"MillimeterScreenBased",HalfWindowHeightBased:"HalfWindowHeightBased",HalfWindowWidthAndHeightBased:"HalfWindowWidthAndHeightBased"},setNative2DZoomType:function(e,t){this._nativeZoomType=e,this._nativeZoomRatio=t},setNative2DClip:function(e,t,r){this._clip=e,this._bottomleftClip=new i.Vector2(t[0],t[1]),this._toprightClip=new i.Vector2(r[0],r[1])},setNative2DTranslationBounds:function(e,t){this._XMaxTranslationBound=e[1],this._XMinTranslationBound=e[0],this._YMaxTranslationBound=t[1],this._YMinTranslationBound=t[0]},setNative2DAnchor:function(e){this._anchor=e},setNative2DDepthMode:function(e){let t=this._depthMode!==e;return this._depthMode=e,t},setNative2DZoomLimits:function(e,t){this._nativeMinZoom=e,this._nativeMaxZoom=t},isNative2D:function(){return null!=this._nativeZoomType},getScaleFactor:function(){if(this.isNative2D()){let e=1/this.getMMInSupportUnit(),t=1;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:t=e/this._nativeZoom;break;case this.NativeZoomTypes.HalfWindowHeightBased:case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:t=2/(this._nativeZoom*this.viewer.SCREEN_HEIGHT)}return t}return Math.tan(this.camera.fov/2*(Math.PI/180))/(this.viewer.SCREEN_HEIGHT/2)/this._nativeZoom},getPixelFromModelRatio:function(){return this.isNative2D()?this.getScaleFactor():1},_native2DModelFromPixel:function(e,t,i,r,n,s){let a,o,l=1*s,h=1/n,c=this._nativeZoom*this._nativeZoomRatio/l,d=this._nativeZoom;if(this._clip<=1){switch(3&this._anchor){case 0:a=i/2;break;case 1:a=0;break;case 2:a=i}switch(12&this._anchor){case 0:o=r/2;break;case 4:o=0;break;case 8:o=r}}else{switch(3&this._anchor){case 0:a=.5*(this._bottomleftClip.x+this._toprightClip.x);break;case 1:a=this._bottomleftClip.x;break;case 2:a=this._toprightClip.x}switch(12&this._anchor){case 0:o=.5*(this._bottomleftClip.y+this._toprightClip.y);break;case 4:o=this._toprightClip.y;break;case 8:o=this._bottomleftClip.y}}let u=0,p=0;switch(this._nativeZoomType){case this.NativeZoomTypes.MillimeterScreenBased:u=this.camera.position.x+h/c*(e-a),p=this.camera.position.y+h/d*(o-t);break;case this.NativeZoomTypes.HalfWindowHeightBased:u=this.camera.position.x+1/c*(e-a)/(r/2),p=this.camera.position.y+1/d*(o-t)/(r/2);break;case this.NativeZoomTypes.HalfWindowWidthAndHeightBased:u=this.camera.position.x+1/c*(e-a)/(i/2),p=this.camera.position.y+1/d*(o-t)/(r/2)}return[u,p]},_native2DViewportBounds:function(e,t,i,r){let[n,s]=this._native2DModelFromPixel(0,0,e,t,i,r),[a,o]=this._native2DModelFromPixel(e,t,e,t,i,r),l=this.getEyePosition();if(a-n>this._XMaxTranslationBound-this._XMinTranslationBound){let e=l.x;switch(3&this._anchor){case 0:l.x=(this._XMinTranslationBound+this._XMaxTranslationBound)/2;break;case 1:l.x=this._XMinTranslationBound;break;case 2:l.x=this._XMaxTranslationBound}n+=l.x-e,a+=l.x-e}else this._XMinTranslationBound>n?(l.x+=this._XMinTranslationBound-n,a+=this._XMinTranslationBound-n,n+=this._XMinTranslationBound-n):this._XMaxTranslationBound<a&&(l.x+=this._XMaxTranslationBound-a,n+=this._XMaxTranslationBound-a,a+=this._XMaxTranslationBound-a);if(s-o>this._YMaxTranslationBound-this._YMinTranslationBound){let e=l.y;switch(12&this._anchor){case 0:l.y=(this._YMinTranslationBound+this._YMaxTranslationBound)/2;break;case 4:l.y=this._YMaxTranslationBound;break;case 8:l.y=this._YMinTranslationBound}o+=l.y-e,s+=l.y-e}else this._YMinTranslationBound>o?(l.y+=this._YMinTranslationBound-o,s+=this._YMinTranslationBound-o,o+=this._YMinTranslationBound-o):this._YMaxTranslationBound<s&&(l.y+=this._YMaxTranslationBound-s,o+=this._YMaxTranslationBound-s,s+=this._YMaxTranslationBound-s);return n-=l.x,a-=l.x,o-=l.y,[n,a,s-=l.y,o,l]},getMMInSupportUnit:function(){return i.getPixelsPerMM()},updateNative2D(){let e=this.getMMInSupportUnit(),[t,i,r,n,s]=this._native2DViewportBounds(this.viewer.SCREEN_WIDTH,this.viewer.SCREEN_HEIGHT,e,1);return this.camera.setViewportInfos(r,n,t,i),s},moveTo:function(e){var a,o,l,h,c,d;if(e.up||e.sight||e.position?console.log("DEPRECATED Naming: options.up => options.upDirection, options.sight => options.sightDirection, options.position => options.eyePosition."):(e.up=e.upDirection,e.sight=e.sightDirection,e.position=e.eyePosition),h=e.distanceToTarget||this.control.distanceToTarget,e.orientation)d=e.orientation,(v=new i.Vector3(0,1,0)).applyQuaternion(d),v.normalize(),a=v,(_=new i.Vector3(0,0,-1)).applyQuaternion(d),_.normalize(),o=_;else if(e.up&&e.sight)a=e.up.clone().normalize(),o=e.sight.clone().normalize();else if(e.up){a=e.up.clone().normalize();var u=this.camera.up.clone().normalize();if(g=Math.acos(a.dot(u))){var p=a.clone().cross(u).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-g);o=this.camera.getLookAt().clone().applyQuaternion(f).normalize(),d=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else d=this.control.orientation.clone(),a=u,o=this.camera.getLookAt().clone().normalize()}else if(e.sight){o=e.sight.clone().normalize();var g,m=this.camera.getLookAt().clone().normalize();if(g=Math.acos(o.dot(m))){p=o.clone().cross(m).normalize(),f=(new i.Quaternion).setFromAxisAngle(p,-g);a=this.camera.up.clone().applyQuaternion(f).normalize(),d=(new i.Quaternion).multiplyQuaternions(f,this.control.orientation.clone())}else d=this.control.orientation.clone(),o=m,a=this.camera.up.clone().normalize()}else{var v,_;d=this.control.orientation.clone(),(v=new i.Vector3(0,1,0)).applyQuaternion(this.control.orientation),v.normalize(),a=v,(_=new i.Vector3(0,0,-1)).applyQuaternion(this.control.orientation),_.normalize(),o=_}if(e.position?(l=e.position,c=(new i.Vector3).addVectors(l,o.clone().multiplyScalar(h))):(l=(new i.Vector3).subVectors(this.control.target,o.clone().multiplyScalar(h)),c=this.control.target.clone()),!(Math.abs(l.x-this.camera.position.x)>1e-4||Math.abs(l.y-this.camera.position.y)>1e-4||Math.abs(l.z-this.camera.position.z)>1e-4)||!this.viewer.get360Mode()||this.getUnlockMoveIn360Mode()){if(!d){d=new i.Quaternion;var y=new i.Matrix4;y.lookAt(l,c,a),d.setFromRotationMatrix(y)}if(e.ratioOffset||e.ratioSize){h/=Math.max(.01,Math.min(e.ratioSize.x,e.ratioSize.y));var S=Math.tan(i.Math.degToRad(.5*this.camera.fov))*h,x=S*this.camera.aspect,b=new i.Vector2(x,S);b.x*=-(1-Math.max(.01,e.ratioSize.x)),b.y*=-(1-Math.max(.01,e.ratioSize.y));var w=new i.Vector2(2*x,2*S);w.x*=e.ratioOffset.x,w.y*=e.ratioOffset.y,w.add(b);var M=(new i.Vector3).crossVectors(a,o);c.add(a.multiplyScalar(w.y)),c.add(M.multiplyScalar(w.x)),e.interpolationType&&(l=(new i.Vector3).subVectors(c,o.clone().multiplyScalar(h)))}var C=e.fov||null,P={position:l,target:c,distanceToTarget:h,orientation:d,duration:e.duration||0,fov:C};this._viewpointAnimation&&this._viewpointAnimation.stop();var E={eventChannel:"/VISU/",eventType:"@onViewpointBeginMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};if(0===P.duration){t.publish({event:"/VISU/",data:E}),P.fov&&this.setAngle(P.fov),this.control.setTarget(P.target),this.control.orientation=P.orientation,this.control.distanceToTarget=P.distanceToTarget,this.control.update();var T={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:this,cameraEye:this.camera.position,cameraUp:this.camera.up};t.publish({event:"/VISU/",data:T}),e.onEndCB&&e.onEndCB(this)}else{var A=new s({position:this.control.position.clone(),target:this.control.target.clone(),orientation:this.control.orientation.clone(),distanceToTarget:this.control.distanceToTarget,fov:P.fov?this.getAngle():P.fov},{position:P.position,target:P.target,orientation:P.orientation,distanceToTarget:P.distanceToTarget,fov:P.fov},P.duration);A.setInterpolator(function(e,t,r){var n={},s=t.position.clone();s.lerp(r.position,e),n.position=s;var a=t.target.clone();a.lerp(r.target,e),n.target=a;var o=new i.Quaternion;return i.Quaternion.slerp(t.orientation,r.orientation,o,e),n.orientation=o,n.distanceToTarget=t.distanceToTarget+(r.distanceToTarget-t.distanceToTarget)*e,n.fov=t.fov!=r.fov?t.fov+(r.fov-t.fov)*e:t.fov,n}),e.interpolationType?this.updateAnimation=function(t){if(this.control){t.fov&&this.setAngle(t.fov),this.control.position=t.position.clone();var r=new i.Vector3(0,0,-1);r.applyQuaternion(t.orientation),r.normalize();var n=(new i.Vector3).addVectors(t.position,r.multiplyScalar(t.distanceToTarget));this.control.setTarget(n),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(D)}}:this.updateAnimation=function(t){this.control&&(t.fov&&this.setAngle(t.fov),this.control.setTarget(t.target),this.control.orientation=t.orientation.clone(),this.control.distanceToTarget=t.distanceToTarget,this.control.update(),e.onUpdateCB&&e.onUpdateCB(D))};var D=this;this._viewpointAnimation=new n(this,"updateAnimation",A,function(i){if(i===r.State.STOPPED){var n={eventChannel:"/VISU/",eventType:"@onViewpointEndMove",viewpoint:D,cameraEye:D.camera.position,cameraUp:D.camera.up};t.publish({event:"/VISU/",data:n}),e.onEndCB&&e.onEndCB(D)}}),this._viewpointAnimation.start(),t.publish({event:"/VISU/",data:E})}}},contextAwareMoveTo:function(e,t){t&&t.allow360&&this.viewer.get360Mode()&&this.viewer._viewer360Manager?this.viewer._viewer360Manager.moveTo(e,t):this.moveTo(e)},onMove:function(e){if(this.control)return this.control.onMove(e)},unsubscribe:function(e){this.control&&this.control.unsubscribe(e)},isMoving:function(){return this._isMoving},_isAnimated:function(){var e=!!this._viewpointAnimation&&this._viewpointAnimation.state()===r.State.RUNNING;return e=e||this.control&&this.control._wheelMoving},resize:function(e,t){this.robotCameraOrtho&&this.camera&&this.robotCameraOrtho.setVisualizedHeight(400,void 0,this.camera.fov),null!==this.control&&this.control._resize(e,t)},setSceneGraph:function(e){h.DEPRECATED_SceneGraph(new Error),e instanceof o&&(this.sceneGraph=e)},_setInternalSceneGraph(e){e?(this._setNode(e.root),this._internalSceneGraph=e):(this._internalSceneGraph=null,this._setNode(null))},_setNode:function(e){this.sceneGraphRoot=e},_lockController:function(e){this._forcedController=e?this._currentDefaultController:null},_set2DMode:function(e,t){var r=this._2DMode!=e;if(this._2DMode=e,e){if(this.setSightDirection(new i.Vector3(0,0,-1)),this.setUpDirection(new i.Vector3(0,1,0)),this.setProjectionType(1),this.control){var n=null,s=!1;"CATIA"!=t&&"COMBINED"!=t&&"SWX"!=t||(n=t,this._forcedController?this._lockController(!1):this._2DModePreviousController=this._currentDefaultController,s=!0),"SWX"!=this._currentDefaultController||n||(n="COMBINED"),n&&this.setDefaultController(!0,n),this._lockController(s),this.control._2DMode=!0,this.control.setMouseRotationActive(!1),this.control.setTouchRotationActive(!1)}}else this._lockController(!1),r&&(this._mePreferenceSetting||this._2DModePreviousController)&&this.setDefaultController(!0,this._mePreferenceSetting||this._2DModePreviousController),this._2DModePreviousController=null,this.control._2DMode=!1,this.control.setMouseRotationActive(!0),this.control.setTouchRotationActive(!0)},resetCameraOrientation:function(){var e,t,r,n;if(!this._2DMode)if(t=new i.Quaternion,(n=this._worldOrientation.getMatrixForSideRotation("iso"))?t.setFromRotationMatrix(n):this._worldOrientation===c.ZUpYRight?(e=new i.Vector3(.35*Math.PI,0,.75*Math.PI),t.setFromEuler(e,this._worldOrientation._eulerOrderForReframe)):t.set(-.21567539362612123,.37210985866635193,.08933567311009524,.8983526674850427),r=1.1*100/Math.tan(22.5*Math.PI/180),null!==this.sceneGraphRoot&&(r=1.1*this.getBoundingSphere().radius/Math.tan(22.5*Math.PI/180)),this.camera.position=new i.Vector3(r,r,r).multiplyScalar(1/Math.sqrt(3)),null===this.control)this.camera.quaternion=t,this.camera.useQuaternion=!0,this.camera.updateMatrix();else{this.control.orientation=t;var s=new i.Vector3(0,0,-1);s.applyQuaternion(t),s.normalize(),this.moveTo({orientation:t,eyePosition:s.clone().multiplyScalar(-r),distanceToTarget:r,duration:0})}},_complyWithZoom:function(e){if(e.distanceToTarget&&e.target&&e.orientation){if(this.projectionType==m.PERSPECTIVE&&this.control._zoomType==a.ZoomType.ZOOM_FOV_CHANGE){var t=this.getBoundingSphere(),r=new i.Vector3(0,0,-1);r.applyQuaternion(e.orientation),r.normalize();let a=(new i.Vector3).addVectors(e.target,r.clone().multiplyScalar(-e.distanceToTarget));var n=r.dot(t.center.clone().sub(a)),s=2*t.radius;if(n<s){var o=s-n,l=Math.tan(i.Math.degToRad(.5*this.getAngle())),h=i.Math.radToDeg(Math.atan(l*Math.abs(n)/s));h<=22.5&&h>0&&(e.fov=h),e.distanceToTarget+=o}}}else console.warn("_complyWith zoom not implemented for exotic cases")},reframe:function(e,t,r,n,s){if(this.sceneGraphRoot&&null!==this.control){var a=null,o=null,l=null,h=null;if(n&&("string"==typeof n?o=n:(o=n.reframeSpace,s=n.radiusIfEmpty,l=n.targetBoundingBox,a=n.use360Reframe,h=n.useZoomLimitations)),!o&&this.viewer&&(o=this.viewer.visibleSpace?"visibleSpace":"invisibleSpace"),this.viewer.get360Mode())this.viewer._viewer360Manager&&this.viewer._viewer360Manager.reframeIn360(e,t,r,o,a);else if(this._customReframeCB)this._customReframeCB(e,t,r,o);else{var c,d,u;if(d=void 0!==t?t:this.defaultReframeTime,l)if(this._2DMode){var p=new i.Box2(new i.Vector2(l.min.x,l.min.y),new i.Vector2(l.max.x,l.max.y));u=this._buildReframeTarget2DFromBBox(p)}else u=this._buildReframeTargetFromBBox(l);else r||!this._2DMode?(void 0!==r&&r instanceof i.Mesh?(c=r.boundingSphere.clone()).applyMatrix4(r.matrixWorld):c=void 0!==r&&r instanceof i.Sphere&&!r.isNaN()?r.clone():this.getBoundingSphere(o,s),u=this._buildReframeTarget(c,e)):u=this._buildReframeTarget2D(o);if(u){var f=new i.Vector3(0,0,-1);f.applyQuaternion(u.orientation),f.normalize(),h&&this._complyWithZoom(u),this.moveTo({orientation:u.orientation,eyePosition:(new i.Vector3).addVectors(u.target,f.clone().multiplyScalar(-u.distanceToTarget)),distanceToTarget:u.distanceToTarget,fov:u.fov,duration:d})}}}},reframeOn:function(e,t,r){r=r||{};var n=new i.Matrix4,s=l.getOrientedBoundingBoxFromPathElements(t,n,this.viewer,!!r.withInternalSceneGraph),a=s.localBBox,o=Math.sqrt(Math.pow(a.min.x-a.max.x,2)+Math.pow(a.min.z-a.max.z,2)+Math.pow(a.min.y-a.max.y,2))/2,h=s.cornerPoint,c=(new i.Vector3).add(h).add(s.firstAxis).add(s.secondAxis).add(s.thirdAxis),d=(new i.Vector3).add(h).add(c);d.divideScalar(2),isNaN(o)||isNaN(d.x)||isNaN(d.y)||isNaN(d.z)?this._reframeOnWarningCount<10&&(console.warn("reframeOn: no usable path for reframe"),this._reframeOnWarningCount++):this.reframe(void 0,e,new i.Sphere(d,o),r)},_reframeOnWarningCount:0,_buildReframeTargetFromBBox:function(e){e.empty()&&e.set(new i.Vector2(-100,-100,-100),new i.Vector2(100,100,100));var t=new i.Vector3((e.min.x+e.max.x)/2,(e.min.y+e.max.y)/2,(e.min.z+e.max.z)/2);let r=0;this.projectionType===m.PERSPECTIVE&&(r=(e.max.z-e.min.z)/2),t.applyMatrix4(this.camera.matrixWorld);var n=this.camera.aspect,s=.5/Math.tan(this.camera.fov*Math.PI/360),a=s*(e.max.x-e.min.x)/n,o=s*(e.max.y-e.min.y),l=Math.max(a,o)+r;return{target:t,orientation:this.control.orientation.clone(),distanceToTarget:l}},_buildReframeTarget2DFromBBox:function(e){var t,r,n,s;e.empty()&&e.set(new i.Vector2(-100,-100),new i.Vector2(100,100)),t=new i.Vector3((e.min.x+e.max.x)/2,(e.min.y+e.max.y)/2,0);var a=this.camera.aspect,o=.5/Math.tan(this.camera.fov*Math.PI/360);return n=o*(e.max.x-e.min.x)/a,s=o*(e.max.y-e.min.y),r=Math.max(n,s),{target:t,orientation:new i.Quaternion,distanceToTarget:r}},_buildReframeTarget2D:function(e){var t=this.getBoundingBox2D(e);return this._buildReframeTarget2DFromBBox(t)},_buildReframeTarget:function(e,t){var r,n,s,a,o=null,l=null;if(e||boundingBox2D){if(n=this.target.clone(),r=this.control.orientation.clone(),s=this.control.distanceToTarget,null==t||this._2DMode){var h=Math.max(this.viewer._getDivClientHeight()/this.viewer._getDivClientWidth(),1);s=1.1*e.radius*h/Math.tan(this.camera.fov*Math.PI/360),n=e.center.clone()}else a=this._worldOrientation.getAxisForSideRotation(t),l=this._worldOrientation.getMatrixForSideRotation(t);if(l)(r=new i.Quaternion).setFromRotationMatrix(l);else if(a){var c=this._worldOrientation._eulerOrderForReframe;(r=new i.Quaternion).setFromEuler(a,c)}o={target:n,orientation:r,distanceToTarget:s}}return o},centerCamera:function(e){if(null!==this.control)if(this._customCenterCameraCB)this._customCenterCameraCB(e);else if(null!==e){var t=e.clone(),r=this.control.orientation.clone(),n=this.control.distanceToTarget;if(this.viewer.__useNewCenterCameraBehaviour&&this.projectionType!==m.PERSPECTIVE||(n=t.distanceTo(this.camera.position)),this._focusMode===m._FOCUS_MODE.TRANSLATION){var s=new i.Vector3(0,0,-1);s.applyQuaternion(r),s.normalize();var a=this.viewer.ODTMode,o=(new i.Vector3).addVectors(t.clone(),s.clone().multiplyScalar(-n));this.moveTo({eyePosition:o,distanceToTarget:n,duration:a?0:200})}else if(this._focusMode===m._FOCUS_MODE.ROTATION){var l=(new i.Vector3).subVectors(t,this.control.position).normalize();a=this.viewer.ODTMode;if(this.control.lockZ||i.mobileVersion){var h=this.camera.getLookAt().clone().normalize(),c=null,d=Math.acos(l.dot(h));if(d){var u=l.clone().cross(h).normalize(),p=(new i.Quaternion).setFromAxisAngle(u,-d);c=(new i.Quaternion).multiplyQuaternions(p,this.control.orientation.clone())}else c=this.control.orientation.clone(),l=h;var f=c.toEuler();f.y=0,c=(new i.Quaternion).setFromEuler(f,"ZYX"),this.__rotatedFocusMoveTo({eyePosition:this.control.position,orientation:c,distanceToTarget:n,duration:a?0:200})}else this.__rotatedFocusMoveTo({eyePosition:this.control.position,sightDirection:l,distanceToTarget:n,duration:a?0:200})}}},centerCameraSVG:function(e,t){this.control.update();var r,n,s,a=e.x-t.x,o=e.y-t.y;if(0!==a||0!==o){r=(new i.Vector3).copy(this.camera.position).sub(this.target),n=(this.camera.top-this.camera.bottom)/this.viewer._getDivClientHeight(),(s=new i.Vector3).add(r.clone().cross(this.camera.up).setLength(n*a)),s.add(this.camera.up.clone().setLength(n*o));var l=this.viewer.ODTMode,h=this.camera.position.clone().add(s);this.moveTo({eyePosition:h,duration:l?0:200})}},pan:function(e){if(null!==this.control){var t,r,n=new i.Vector3;switch(e){case"left":n.x=-1;break;case"right":n.x=1;break;case"top":n.y=1;break;case"bottom":n.y=-1;break;default:n.x=1}n.applyQuaternion(this.control.orientation),n.setLength(.05*this.control.distanceToTarget),t=this.target.clone().add(n),this.control.orientation.clone(),r=this.control.distanceToTarget;var s=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),duration:s?0:100})}},zoom:function(e){if(null!==this.control){var t,r,n=.9;"out"===e&&(n=1.1),t=this.target.clone(),this.control.orientation.clone(),r=this.control.distanceToTarget*n;var s=this.viewer.ODTMode;this.moveTo({eyePosition:(new i.Vector3).addVectors(t,this.getCamera().getLookAt().clone().normalize().multiplyScalar(-r)),distanceToTarget:r,duration:s?0:100})}},rotateCameraForPerfos:function(e,t,r){if(null!==this.control){var s=new function(){var r=new i.Vector3(.35*Math.PI,0,.75*Math.PI);this._orientation=(new i.Quaternion).setFromEuler(r,"ZXY"),this._key1=new i.Quaternion,this._key2=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI/2),this._key3=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),Math.PI),this._key4=(new i.Quaternion).setFromAxisAngle(new i.Vector3(0,0,1),3*Math.PI/2),this._nbLoops=void 0!==e?e:5,this._duration=void 0!==t?t:1e4,this.duration=function(){return this._duration},this.valueAt=function(e){var t,r,n,s,a=this._duration/this._nbLoops,o=e%a/a;return o>=0&&o<.25?(t=this._key1,r=this._key2,s=o/.25):o>=.25&&o<.5?(t=this._key2,r=this._key3,s=(o-.25)/.25):o>=.5&&o<.75?(t=this._key3,r=this._key4,s=(o-.5)/.25):(t=this._key4,r=this._key1,s=(o-.75)/.25),n=new i.Quaternion,i.Quaternion.slerp(t,r,n,s),n.multiply(this._orientation)}},a=new n(this.control,"orientation",s);r&&a.setLoop(1),a.start()}},zoomCameraInAndOutForPerfos:function(e,t){if(null!==this.control){this.resetCameraOrientation(),this.reframe(void 0,0);var i=1.2*this.getTargetDistance(),r=new function(){this._duration=void 0!==e?e:3e3,this.duration=function(){return this._duration},this.valueAt=function(t){var r=t%e/e;return(r>=0&&r<.5?r/.5:1-(r-.5)/.5)*i}},s=new n(this.control,"distanceToTarget",r);t&&s.setLoop(1),s.start()}},getBoundingBox2D:function(e){if(!this._2DMode)return null;var t,r=this.viewer||this.sceneGraphRoot._getViewer();if(r.svgRoot){var n=this.viewer.svgRoot.getBBox();t=new i.Box2(new i.Vector2(n.x,-n.y-n.height),new i.Vector2(n.x+n.width,-n.y))}let s=this._internalSceneGraph?this._internalSceneGraph:r?r._safeInternalSceneGraph:null;var a=r?r.getSceneBoundingBox(e,s):this.sceneGraphRoot.getBoundingBox(e),o=new i.Box2(new i.Vector2(a.min.x,a.min.y),new i.Vector2(a.max.x,a.max.y));return t&&o.union(t),o},getBoundingSphere:function(e,t){var r=this.viewer||this.sceneGraphRoot._getViewer();let n=this._internalSceneGraph?this._internalSceneGraph:r?r._safeInternalSceneGraph:null;var s=r?r.getSceneBoundingSphere(e,!0,n):this.sceneGraphRoot.getBoundingSphere(e,!0);return s?0===s.radius&&s.pixelRadius>0?s.radius=void 0!==t?t:s.pixelRadius:0===s.radius&&(s.radius=void 0!==t?t:100):s=new i.Sphere(new i.Vector3,100),s},setViewOffset:function(e,t){var i=this.camera;!function(i,r){if(e){e.camera&&(i=e.camera);var n=e.fullWidth?e.fullWidth:r.SCREEN_WIDTH,s=e.fullHeight?e.fullHeight:r.SCREEN_HEIGHT,a=e.x?e.x:0,o=e.y?e.y:0,l=e.width?e.width:r.SCREEN_WIDTH,h=e.height?e.height:r.SCREEN_HEIGHT;i.setViewOffsetInternal(n,s,a,o,l,h,null,t)}else i.setViewOffsetInternal(0,0,0,0,r.SCREEN_WIDTH,r.SCREEN_HEIGHT,null,t)}(i,this.viewer),i.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(400,void 0,i.fov),this.robotCameraOrtho._setRobotRenderingRoleFromPrincipal(i)},project:function(e,t){var i=t||this.camera,r=e.clone();return p.projectVector(r,i),r.x=.5*this.viewer._getCanvasOffsetWidth()*(r.x+1),r.y=.5*this.viewer._getCanvasOffsetHeight()*(1-r.y),r},unProject:function(e,t){var r=t||this.camera,n=e.x/this.viewer._getCanvasOffsetWidth()*2-1,s=-e.y/this.viewer._getCanvasOffsetHeight()*2+1,a=new i.Vector3(n,s,e.z);return p.unprojectVector(a,r),a},_convertViewportToNDC:function(e){let t=e.x,r=e.y,n=this.viewer.canvas.offsetWidth,s=this.viewer.canvas.offsetHeight;if(this.viewer._viewpointManager){let e=this.viewer._viewpointManager.getViewpointViewport(this);if(e){t-=e.x,r-=this.viewer.canvas.offsetHeight-(e.height+e.y),n=e.width,s=e.height}}return t=t/n*2-1,r=-r/s*2+1,new i.Vector2(t,r)},create3DRayFrom2DPoint:function(e,t){let r=this._convertViewportToNDC(e);var n=new i.Vector3(r.x,r.y,-1);p.unprojectVector(n,t||this.camera);var s=new i.Vector3(r.x,r.y,1);p.unprojectVector(s,t||this.camera);var a=(new i.Vector3).copy(s).sub(n);return a.normalize(),new i.Ray(n,a)},dump:function(){var e="viewpoint.control.target = new THREE.Vector3("+this.control.target.x+", "+this.control.target.y+", "+this.control.target.z+");\nviewpoint.control.orientation = new THREE.Quaternion("+this.control.orientation.x+", "+this.control.orientation.y+", "+this.control.orientation.z+", "+this.control.orientation.w+");\nviewpoint.control.distanceToTarget = "+this.control.distanceToTarget+";";console.log(e)},setFromJSON:function(e){},_setPickingViewOffset:function(e){function t(t,i){if(e.reset)t.setViewOffsetInternal(0,0,0,0,i.SCREEN_WIDTH,i.SCREEN_HEIGHT,{},!0);else{var r=e.fullWidth?e.fullWidth:i.SCREEN_WIDTH,n=e.fullHeight?e.fullHeight:i.SCREEN_HEIGHT,s=e.x?e.x:0,a=e.y?e.y:0,o=e.width?e.width:i.SCREEN_WIDTH,l=e.height?e.height:i.SCREEN_HEIGHT;t.setViewOffsetInternal(r,n,s,a,o,l,{ratioW:e.pickingRatioW,ratioH:e.pickingRatioH},!0)}}e&&e.cameraSet&&(t(e.cameraSet.main,this.viewer),t(e.cameraSet.robotCameraOrtho,this.viewer),t(e.cameraSet.connectedRobotCamera,this.viewer))},_updateRobotCamera:function(e){function t(e,t){var r=(new i.Vector3).subVectors(e.center,t.position),n=t.getLookAt(),s=r.dot(n),a=s+e.radius,o=s-e.radius;return t.isOrtho||(o=Math.max(o,.001*a)),{near:o,far:a}}var r=this.camera;r.clone(this.robotCameraOrtho),this.robotCameraOrtho.setVisualizedHeight(400,void 0,this.camera.fov),this.robotCameraOrtho.position.set(0,0,0),this.robotCameraOrtho.updateMatrix(),this.robotCameraOrtho.updateMatrixWorld(),this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix),this.robotCameraOrtho._setRobotRenderingRoleFromPrincipal(r),r.clone(this.connectedRobotCamera),this.connectedRobotCamera._setRobotConnectedRenderingRoleFromPrincipal(r);var n,s,a,o,l,h=e.robotRoot;if(h.getMatrixWorld(),(s=h.getBoundingSphere()).pixelRadius>0){var c=this.robotCameraOrtho.getWorldSizeFromPixelSize(1,s.center,this.viewer._getDivClientHeight(),2);s.radius+=c*s.pixelRadius}if(0===s.radius&&(s.radius=10),s){o=t(s,this.robotCameraOrtho),this.robotCameraOrtho.near=o.near,this.robotCameraOrtho.far=o.far,this.robotCameraOrtho.updateProjectionMatrix(),this.robotCameraOrtho.projectionMatrixInverse.getInverse(this.robotCameraOrtho.projectionMatrix);var d=e._robot;if(d)if(!(!d.isConnected||d.isManipulatedInPlane)){if(n=d.getMatrixWorld(),(a=d.getBoundingSphere()).applyMatrix4(n),a.pixelRadius>0){c=this.connectedRobotCamera.getWorldSizeFromPixelSize(1,a.center,this.viewer._getDivClientHeight(),2);a.radius+=c*a.pixelRadius}l=t(a,this.camera),this.connectedRobotCamera.near=Math.min(l.near,r.near),this.connectedRobotCamera.far=Math.max(l.far,r.far),this.connectedRobotCamera.updateProjectionMatrix(),this.connectedRobotCamera.projectionMatrixInverse.getInverse(this.connectedRobotCamera.projectionMatrix)}}},_updateFrustum:function(){var e=this.camera;f.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromMatrix(f)},_setWorldOrientation:function(e){if(e!==this._worldOrientation){var t=this._worldOrientation.upAttribute,r=this._worldOrientation.rightAttribute,n=this._worldOrientation.frontAttribute;this._worldOrientation=e;var s=this._worldOrientation.upAttribute,a=this._worldOrientation.rightAttribute,o=this._worldOrientation.frontAttribute,l=new i.Vector3,h=this.getEyePosition();l[s]=h[t],l[a]=h[r],l[o]=h[n];var c=new i.Vector3,d=this.getUpDirection();c[s]=d[t],c[a]=d[r],c[o]=d[n];var u=new i.Vector3,p=this.getSightDirection();u[s]=p[t],u[a]=p[r],u[o]=p[n],this.moveTo({eyePosition:l,upDirection:c,sightDirection:u})}},getFrustum:function(){return(new i.Frustum).copy(this._frustum)},dispose:function(){this.viewer._viewpointManager&&this.viewer._viewpointManager.unregisterViewpoint(this),this.viewer=null,this._lockController(!1),this._mePreferenceToken&&d.unsubscribe(this._mePreferenceToken),this.control&&(this.control.detachEvents(),this.control=null),this._setNode(null)}});return m._FOCUS_MODE={TRANSLATION:0,ROTATION:1},m.PERSPECTIVE=0,m.ORTHOGRAPHIC=1,UWA.namespace("THREEDS/Viewpoint",m)}),define("Visualization/Viewpoint",["DS/Visualization/Viewpoint","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/Viewpoint"),e}),define("DS/Visualization/CollisionServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/ComposerContext","DS/Visualization/Viewpoint","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/GraphicAttributeSet","DS/Visualization/InternalSceneGraph"],function(e,t,i,r,n,s,a,o){"use strict";var l=e.singleton({init:function(){return this.collisionDepthComposers=new Map,this.collisionNormalComposers=new Map,this._clearCurrentData(),this.useDebug=!1,this.renderNormals=!1,this.disableBackFaceCulling=!0,this.skipTransparentItems=!1,this.readPixelPerfs=0,this.readPixelCount=0,this.currentCollision=null,window.__collisionService=this,this._bufferPool=new Map,this},_getBuffer(e,t){let i=e;"float32"==t&&(i*=4),this._bufferPool.has(i)||this._bufferPool.set(i,[]);let r,n=this._bufferPool.get(i);return r=n.length?n.splice(0,1)[0]:new Uint8Array(i),"float32"==t?r=new Float32Array(r.buffer):"uint8"==t&&(r=new Uint8Array(r.buffer)),r},_releaseBuffer(e){let t=e.BYTES_PER_ELEMENT*e.length;this._bufferPool.get(t).push(e)},setViewer:function(e){this.viewer=e,this.gl=this.viewer.getWebGLContext();let t={viewer:this.viewer,defaultController:!1};return this.vp=new r(t),this.vp.camera.pixelCulling=0,t.projectionType=r.ORTHOGRAPHIC,this.vpOrtho=new r(t),this.vpOrtho.camera.pixelCulling=0,this},_clearCurrentData:function(e){if(e){let t=this.data.get(e);t?(t.camera=null,t.frustumInfos=null,t.width=null,t.height=null,t.normalData&&this._releaseBuffer(t.normalData),t.normalData=null,t.depthData&&this._releaseBuffer(t.depthData),t.depthData=null,t.positionData&&this._releaseBuffer(t.positionData),t.positionData=null,t.cameraPositionData=null,t.farthest=null,t.nearest=null,t.depthComposer=null,t.normalComposer=null,t.colliderInfos=null):(t={camera:null,frustumInfos:null,width:null,height:null,normalData:null,depthData:null,positionData:null,farthest:null,nearest:null,depthComposer:null,normalComposer:null,colliderInfos:null},this.data.set(e,t))}else this.data=new Map},setCurrentData:function(e){this.currentData=this.data.get(e)},_setDebugInfos:function(e){this.debugInfos=e},_debug:function(){let e=this.currentData.width,t=this.currentData.height,i=this,r=document.getElementById("normal"),n=null,s=null;if(r){r.width=e,r.height=t,s=(n=r.getContext("2d")).createImageData(e,t);let a=i.getNormalData();for(let r=0;r<e*t;r++){let n=a[3*r],o=a[3*r+1],l=a[3*r+2],h=i.convertIndexToXY(r),c=h[0]+(t-1-h[1])*e;s.data[4*c+0]=255*n,s.data[4*c+1]=255*o,s.data[4*c+2]=255*l,s.data[4*c+3]=255}n.putImageData(s,0,0)}if(r=document.getElementById("depth")){r.width=e,r.height=t,s=(n=r.getContext("2d")).createImageData(e,t);let a=i.getDepthData();for(let r=0;r<e*t;r++){let n=255*(a[r]+1)/2,o=n,l=n,h=n;if(r==Math.floor(e/2)*t+Math.floor(e/2)&&(l=0,h=0),this.debugInfos)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right,t.near,t.far)){o*=t.color[0],l*=t.color[1],h*=t.color[2];break}if(this.isDirectAsymetricCollider(r,t.up,t.down,t.left,t.right)){o*=.5*t.color[0],l*=.5*t.color[1],h*=.5*t.color[2];break}}let c=i.convertIndexToXY(r),d=c[0]+(t-1-c[1])*e;s.data[4*d+0]=o,s.data[4*d+1]=l,s.data[4*d+2]=h,s.data[4*d+3]=255}n.putImageData(s,0,0)}if(r=document.getElementById("position")){r.width=e,r.height=t,s=(n=r.getContext("2d")).createImageData(e,t);let a=i.getPositionData();for(let r=0;r<e*t;r++){let n=a[3*r],o=a[3*r+1],l=a[3*r+2],h=i.convertIndexToXY(r),c=h[0]+(t-1-h[1])*e;s.data[4*c+0]=255*n,s.data[4*c+1]=255*o,s.data[4*c+2]=255*l,s.data[4*c+3]=255}n.putImageData(s,0,0)}},_dlDepthTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let s=n.getContext("2d"),a=s.createImageData(t,i),o=r.getDepthData();for(let n=0;n<t*i;n++){let s=255*o[n],l=s,h=s,c=s;if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){l*=t.color[0],h*=t.color[1],c*=t.color[2];break}}let d=r.convertIndexToXY(n),u=d[0]+(i-1-d[1])*t;a.data[4*u+0]=l,a.data[4*u+1]=h,a.data[4*u+2]=c,a.data[4*u+3]=255}s.putImageData(a,0,0);var l=document.createElement("a");l.download="depth.png",s.canvas.toBlob(function(e){l.href=URL.createObjectURL(e),l.click()})},_dlPositionTexture:function(e){let t=this.currentData.width,i=this.currentData.height,r=this;var n=document.createElement("canvas");n.width=t,n.height=i;let s=n.getContext("2d"),a=s.createImageData(t,i),o=r.getPositionData();for(let n=0;n<t*i;n++){let s=o[3*n],l=o[3*n+1],h=o[3*n+2];if(this.debugInfos&&e)for(let e=0;e<this.debugInfos.length;e++){let t=this.debugInfos[e];if(this.isDirectAsymetricCollider(n,t.up,t.down,t.left,t.right)){s*=t.color[0],l*=t.color[1],h*=t.color[2];break}}let c=r.convertIndexToXY(n),d=c[0]+(i-1-c[1])*t;a.data[4*d+0]=s,a.data[4*d+1]=l,a.data[4*d+2]=h,a.data[4*d+3]=255}s.putImageData(a,0,0);var l=document.createElement("a");l.download="depth.png",s.canvas.toBlob(function(e){l.href=URL.createObjectURL(e),l.click()})},_getViewpointFromCameraInfos:function(e){if(!e)return this.viewer.currentViewpoint;let i,r=e.near?e.near:this.viewer.currentViewpoint.camera.near,n=e.far?e.far:this.viewer.currentViewpoint.camera.far;if(e.camera)(i=this.vp).camera=e.camera,this.currentData.frustumInfos={near:r,far:n};else{let s,a,o,l,h,c;if(e.useOrtho){i=this.vpOrtho,c=e.top?e.top:1,h=e.bottom?e.bottom:1,l=e.right?e.right:1,o=e.left?e.left:1,i.camera.makeProjectionMatrix(o,l,c,h,r,n),s=l-o,a=c-h}else{i=this.vp;let d=e.hfov?e.hfov:this.viewer.currentViewpoint.camera.fov,u=e.vfov?e.vfov:this.viewer.currentViewpoint.camera.fov;h=-(c=Math.tan(t.Math.degToRad(.5*u))*r),o=-(l=Math.tan(t.Math.degToRad(.5*d))*r),i.camera.projectionMatrix.makeFrustum(o,l,h,c,r,n),s=(l-o)*n/r,a=(c-h)*n/r}this.currentData.frustumInfos={left:o,right:l,bottom:h,top:c,near:r,far:n},this.currentData.colliderInfos={farH:s,farV:a},i.camera._renderingRole=t._CameraRoles.NONE;let d=e.position?e.position:this.viewer.currentViewpoint.getEyePosition(),u=e.sight?e.sight:this.viewer.currentViewpoint.getSightDirection(),p=e.up?e.up:this.viewer.currentViewpoint.getUpDirection(),f=i.camera.quaternion,g=i.camera.position,m=new t.Vector3;i.camera.matrix.lookAt(d,(new t.Vector3).addVectors(d,u),p),i.camera.matrix.setPosition(d),i.camera.matrix.decompose(g,f,m)}return i.camera.matrixWorld.copy(i.camera.matrix),i.camera.matrixWorldInverse.getInverse(i.camera.matrixWorld),i.camera.projectionMatrixInverse.getInverse(i.camera.projectionMatrix),i},_buildNormalArray:function(){let e=this.currentData.normalComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let t=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8");this.currentData.normalData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.normalData;this.gl.readPixels(0,0,this.currentData.width,this.currentData.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);for(let e=0;e<this.currentData.width*this.currentData.height;e++){var r=t[4*e+0]/255*2-1,n=t[4*e+1]/255*2-1,s=t[4*e+2]/255*2-1,a=this.currentData.camera.matrixWorld.elements,o=1/(a[3]*r+a[7]*n+a[11]*s+a[15]);i[3*e]=(a[0]*r+a[4]*n+a[8]*s)*o,i[3*e+1]=(a[1]*r+a[5]*n+a[9]*s)*o,i[3*e+2]=(a[2]*r+a[6]*n+a[10]*s)*o}this._releaseBuffer(t)},_buildDepthArray:function(){let e=this.currentData.depthComposer.getResult(this.currentData.name);this.viewer.renderer.renderer.setRenderTarget(e);let t=this._getBuffer(4*this.currentData.width*this.currentData.height,"uint8"),i=performance.now();this.gl.readPixels(0,0,this.currentData.width,this.currentData.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);let r=performance.now()-i;this.readPixelPerfs+=r,this.readPixelCount++,this.currentData.depthData=new Float32Array(t.buffer);let n=this.currentData.depthData,s=1,a=null,o=0,l=null;for(let e=0;e<this.currentData.width*this.currentData.height;e++)n[e]||(n[e]=1),n[e]<s&&(s=n[e],a=e),n[e]>o&&(o=n[e],l=e);this.currentData.farthest={index:l,depth:o},this.currentData.nearest={index:a,depth:s}},_buildPositionArray:function(){let e=this.getDepthData();this.currentData.positionData=this._getBuffer(3*this.currentData.width*this.currentData.height,"float32");let i=this.currentData.positionData;for(let r=0;r<this.currentData.width*this.currentData.height;r++){let n=this.convertIndexToXY(r);n[0]=n[0]/this.currentData.width*2-1,n[1]=n[1]/this.currentData.height*2-1;let s=2*e[r]-1,a=new t.Vector4(n[0],n[1],s,1);a.applyMatrix4(this.currentData.camera.projectionMatrixInverse),a.multiplyScalar(1/a.w),a.applyMatrix4(this.currentData.camera.matrixWorld),i[3*r]=a.x,i[3*r+1]=a.y,i[3*r+2]=a.z}},convertIndexToXY:function(e){let t=Math.floor(e/this.currentData.width);return[e-t*this.currentData.width,t]},convertXYToIndex:function(e,t){return t*this.currentData.width+e},computeCollision:function(e){let r=e||{};if(null!=e.near&&null!=e.far&&e.near>=e.far)return void console.warn("CollisionService: incoherent input infos, collision not computed");r.name||(r.name="default"),this._clearCurrentData(r.name),this.setCurrentData(r.name),this.currentData.name=r.name;let n=r.width?r.width:100,s=r.height?r.height:100;this.currentData.cameraPositionData=[];for(let e=0;e<n*s;e++)this.currentData.cameraPositionData[e]=null;let a=this.viewer.renderer;a.renderer.increaseFrameCount(t._FrameTypes.COLLISION);let l=this.collisionDepthComposers.get(r.name);if(!l){var h=new t.WebGLRenderTargetProperties(n,s,"uintNearest");h.generateMipmaps=!1,(l=new i(h,a.mainComposer,"depthCollisionComposerContext")).setPassClear(a.initClearPass,!0,new t.Color(0),0),a.setupOneMaterialComposerContext(l,0,0,!1),l.enablePass(a.initClearPass,!0),this.collisionDepthComposers.set(r.name,l)}this.currentData.depthComposer=l;let c=this.collisionNormalComposers.get(r.name);if(!c){var d=new t.WebGLRenderTargetProperties(n,s,"uintNearest");d.generateMipmaps=!1,(c=new i(d,a.mainComposer,"normalCollisionComposerContext")).setPassClear(a.initClearPass,!0,new t.Color(0),1),a.setupOneMaterialComposerContext(c,0,1,!1),c.enablePass(a.initClearPass,!0),this.collisionNormalComposers.set(r.name,c)}this.currentData.normalComposer=c;var u=!!a.compForwardComposerContext.getPassState(a.zPostPass).enabled;l.enablePass(a.zPostPass,u),c.enablePass(a.zPostPass,u),l.setSize(n,s,r.name),c.setSize(n,s,r.name),l.writeBuffer=null,c.writeBuffer=null,l.readBuffer=null,c.readBuffer=null,l.needsUpdate=!0,c.needsUpdate=!0,this.currentData.width=n,this.currentData.height=s;var p=this._getViewpointFromCameraInfos(e);this.currentData.camera=p.camera;let f=this.viewer.internalSceneGraph,g=!1;if(r.renderedNodes){g=!0;let e=(f=new o(this.viewer)).getUserRoot();for(let t=0;t<r.renderedNodes.length;t++)e.addChild(r.renderedNodes[t])}var m=f.scene,v=p.camera,_={main:v,mainNoJittering:v,connectedRobotCamera:p.connectedRobotCamera,robotCameraOrtho:p.robotCameraOrtho};if(this.disableBackFaceCulling){var y=this.viewer.renderer.renderer.disableBackFaceCulling;this.viewer.renderer.renderer.setDisableBackFaceCulling(!0)}this.skipTransparentItems?(l._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,c._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE):(l._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,c._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE),a.renderer._fixedPointSize=1,this.renderNormals&&(a.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),a.mainComposer.updateScene(m),a._updateOITScene(m),a.renderer.materialToUse=t.MaterialToUse.normalMaterial,a.renderer.autoClearDepth=!0,a.renderer.autoClearStencil=!0,a.mainComposer.setComposerContext(c),a.mainComposer.render(void 0,void 0,_,r.name),c.needsUpdate=!1),a.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),a.mainComposer.updateScene(m),a._updateOITScene(m),a.renderer.materialToUse=t.MaterialToUse.depthMaterial,a.renderer.autoClearDepth=!0,a.renderer.autoClearStencil=!0,a.mainComposer.setComposerContext(l),a.mainComposer.render(void 0,void 0,_,r.name),l.needsUpdate=!1,this.disableBackFaceCulling&&this.viewer.renderer.renderer.setDisableBackFaceCulling(y),a.renderer._fixedPointSize=null,g&&(f.dispose(),f=null),this.useDebug&&this._debug()},getDepthData:function(){return this.currentData.depthData||this._buildDepthArray(),this.currentData.depthData},getNormalData:function(){return this.currentData.normalData||this._buildNormalArray(),this.currentData.normalData},getPositionData:function(){return this.currentData.positionData||this._buildPositionArray(),this.currentData.positionData},get3DpositionAtIndex:function(e){let i=2*this.getDepthData()[e]-1,r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),n.applyMatrix4(this.currentData.camera.matrixWorld),new t.Vector3(n.x,n.y,n.z)},get3DCameraPositionAtIndex:function(e){let i=2*this.getDepthData()[e]-1,r=this.convertIndexToXY(e);r[0]=r[0]/this.currentData.width*2-1,r[1]=r[1]/this.currentData.height*2-1;let n=new t.Vector4(r[0],r[1],i,1);return n.applyMatrix4(this.currentData.camera.projectionMatrixInverse),n.multiplyScalar(1/n.w),new t.Vector3(n.x,n.y,n.z)},getOptimized3DCameraPositionAtIndex:function(e){if(null==this.currentData.cameraPositionData[e]){let i=this.getDepthData()[e],r=this.convertIndexToXY(e),n=this.currentData.colliderInfos.farH,s=this.currentData.colliderInfos.farV,a=r[0]/this.currentData.width-.5;a*=n;let o=r[1]/this.currentData.height-.5;o*=s;let l=Math.min(this.getCameraDepth(i),this.currentData.frustumInfos.far),h=l/this.currentData.frustumInfos.far,c=a*h,d=o*h;this.currentData.cameraPositionData[e]=new t.Vector3(c,d,l)}return this.currentData.cameraPositionData[e]},getFarthest:function(){return this.currentData.farthest||this._buildDepthArray(),this.currentData.farthest},getNearest:function(){return this.currentData.nearest||this._buildDepthArray(),this.currentData.nearest},getCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return t*i/(e*(t-i)+i)},getNoLinearCameraDepth:function(e){let t=this.currentData.frustumInfos.near,i=this.currentData.frustumInfos.far;return(t*i/e-i)/(t-i)},isDirectCollider:function(e,t,i,r,n){let s=void 0!==r?r:this.currentData.frustumInfos.near,a=void 0!==n?n:this.currentData.frustumInfos.far;return this.isDirectAsymetricCollider(e,t,-t,-i,i,s,a)},isDirectAsymetricCollider:function(e,t,i,r,n,s,a){let o=void 0!==s?s:this.currentData.frustumInfos.near,l=void 0!==a?a:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let s=e.x,a=e.y,h=e.z;return s<=n&&s>=r&&a<=t&&a>=i&&h>=o&&h<=l})},isEdgingCollider:function(e,t,i,r,n,s,a,o){let l=void 0!==s?s:this.currentData.frustumInfos.near;return this.isGenericCollider(e,function(e){let s=e.x,h=e.y,c=e.z,d=(s-r)/(n-r);return s<=n&&s>=r&&h<=t&&h>=i&&c>=l&&c<=a*(1-d)+o*d})},isArcingDepthFromTopCollider:function(e,t,i,r,n,s,a){let o=void 0!==s?s:this.currentData.frustumInfos.near,l=void 0!==a?a:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let s=e.x,a=e.y,h=e.z;if(s<=n&&s>=r&&a<=t&&a>=i){let e=1-a/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return h>=o&&h<=r}return!1})},isArcingDepthFromBottomCollider:function(e,t,i,r,n,s,a){let o=void 0!==s?s:this.currentData.frustumInfos.near,l=void 0!==a?a:this.currentData.frustumInfos.far;return this.isGenericCollider(e,function(e){let s=e.x,a=e.y,h=e.z;if(s<=n&&s>=r&&a<=t&&a>=i){let e=a/(t-i),r=o+(l-o)*Math.sqrt(1-e*e);return h>=o&&h<=r}return!1})},isInsideCylinder:function(e,t){let i=this.currentData.frustumInfos.near;return this.isGenericCollider(e,function(e){let r=e.x,n=(e.y,e.z);return(n-t-i)*(n-t-i)+r*r<t*t})},isGenericCollider:function(e,t){return t(this.getOptimized3DCameraPositionAtIndex(e))},getPrecisePositionAtPick_firstImpl(e){var t=this.viewer.currentViewpoint.camera.clone(this.vp.camera),i=null;t.fullWidth&&(i={fullWidth:t.fullWidth,fullHeight:t.fullHeight,x:t.x,y:t.y,width:t.width,height:t.height}),t.useRealSize=!0;var r=Math.round(e.xPix),n=Math.round(e.yPix),s=this.viewer.renderer.renderer.getViewportSize(),a=s.width,o=s.height;if(i){var l,h;l=i.width/i.fullWidth,h=i.height/i.fullHeight;var c=i.fullWidth/a,d=i.fullHeight/o;a=i.fullWidth,o=i.fullHeight,n*=d,r=(r*=c)*l+i.x,n=n*h+i.y,currentPickingToleranceX*=l,currentPickingToleranceY*=h,trapXdist*=l,trapYdist*=h}t.setViewOffsetInternal(a,o,r,n,1,1,{ratioW:1/s.width,ratioH:1/s.height},!0);let u=this.currentData?this.currentData.name:null,p=t.far,f=t.near,g={name:"PreciseDepth",camera:t,near:f,far:p,width:1,height:1};this._setDebugInfos([]),this.computeCollision(g);let m=this.getDepthData()[0],v=this.getCameraDepth(m),_=(this.get3DpositionAtIndex(0),v-f);if(f=v-.001*_,p=v+.001*(_=p-v),t.near=f,t.far=p,t.updateProjectionMatrix(),g.near=f,g.far=p,this.computeCollision(g),this.getDepthData()[0]==m){this.computeCollision(g);this.getDepthData()[0]}let y=this.get3DpositionAtIndex(0);return u&&this.setCurrentData(u),y},getPrecisePositionAtPick(e,i){var r=Math.round(e.xPix),n=Math.round(e.yPix);let s=this.viewer.renderer.renderer.getViewportSize();var a=this.viewer.currentViewpoint,o=a.camera,l=a.getEyePosition(),h=a.getSightDirection().normalize(),c=a.getUpDirection().normalize(),d=(new t.Vector3).crossVectors(h,c).normalize(),u=a.getAngle()/2;h.multiplyScalar(1/Math.tan(u*Math.PI/180));let p=2*(r/s.width-.5),f=2*(n/s.height-.5);c.multiplyScalar(-f),d.multiplyScalar(p*s.width/s.height),h.addVectors(h,c),h.addVectors(h,d),h.normalize(),c.set(-h.z,h.x,-h.y),d.crossVectors(h,c),c.crossVectors(d,h);let g,m=o.far,v=o.near,_={name:"PreciseDepth2",near:v,far:m,useOrtho:!0,top:.5,bottom:-.5,left:-.5,right:.5,position:l,sight:h,up:c,width:1,height:1},y=this.currentData?this.currentData.name:null;this._setDebugInfos([]),i&&(g=this.renderNormals,this.renderNormals=!0),this.computeCollision(_),i&&(this.renderNormals=g);let S=1*Math.floor(.5)+Math.floor(.5),x=this.getDepthData()[S],b=null;if(1!=x){i&&(i.x=this.getNormalData()[3*S],i.y=this.getNormalData()[3*S+1],i.z=this.getNormalData()[3*S+2]);b=this.get3DpositionAtIndex(S)}return y&&this.setCurrentData(y),b}});return UWA.namespace("THREEDS/Collision",l)}),define("DS/Visualization/CGRNode",["UWA/Class","DS/Visualization/SceneGraphUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/PathElement"],function(e,t,i,r,n,s,a){"use strict";var o=function(e,t,i){var r,s=e.children?e.children.length:0,a=e._primitives?e.getPrimitivesCount():0;for(t(e,i),r=0;r<s;r++)o(e.children[r],t,i);if(a)for(r=0;r<a;r++){var l=new n.SGPrimitiveHelper;l.set(e,r),t(l,i)}},l=function(e,t,i){var r,s,a=e.children?e.children.length:0,o=e._primitives?e.getPrimitivesCount():0;if((s=t(e,i)).stop)s.stop=!1;else{for(r=0;r<a;r++)l(e.children[r],t,s);if(o){for(r=0;r<o;r++){var h=new n.SGPrimitiveHelper;h.set(e,r),s=t(h,s),i.index&&i.index--}return}}i.index&&i.index--},h=function(e,t,i){var r=t(e,i);if(!r&&e.type<=i.nodeType)for(var n=e.children,s=n?n.length:0,a=0;a<s;a++)r=h(n[a],t,i);return r},c=function(e,t){(e.getCgmId?e.getCgmId():e.cgmId)==t.cgmId&&t.results.nodes.push(e)},d=function(e,t){var i=!1,r=!0,s=e.getCgmId?e.getCgmId():e.cgmId;if(s==t.path[t.index]?(t.index==t.path.length-1&&t.results.nodes.push(e),r=!1):0==s&&(i=!0,r=!1),!r){var a=e.children;e._primitives&&(a=function(e){for(var t=[],i=0;i<e.getPrimitivesCount();i++){var r=new n.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}(e)),i||t.index++;for(var o=a?a.length:0,l=0;l<o;l++)d(a[l],t);i||t.index--}},u=r.extend({init:function(e,t,i){return this._parent(t),this.internalSceneGraph=e,this.sag=i,this},setInternalSceneGraph:function(e){this.internalSceneGraph=e},getSag:function(){return this.sag},setHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var s=WUX.Selection.HSOManager,o=n[t].mesh._occurrence,l=new a,h=n[t].primitives;for(i=0;i<h.length;i++){(l=new a).setFromOccurrence(o,h[i]);var c={pathElement:l};c.pathElement.getLastElement(!0)._getExcludeFromHL()||s.add(c)}}return r},removeHighlight:function(e){var t=0,i=0,r=!1,n=this._getPrimitives(e);for(t in n){r=!0;var s=WUX.Selection.HSOManager,o=n[t].mesh._occurrence,l=n[t].primitives;for(i=0;i<l.length;i++){(d=new a).setFromOccurrence(o,l[i]);var h={pathElement:d},c=s.get();for(t=0;t<c.length;t++){var d,u=c[t];if(!(d=u.pathElement)&&u.options&&(d=u.options.pathElement),d&&d.isEqual(h.pathElement)){s.remove(u),!0;break}}}}return r},show:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,s=r[t].primitives;n.show(s)}return i},hide:function(e){var t=0,i=!1,r=this._getPrimitives(e);for(t in r){i=!0;var n=r[t].mesh._occurrence.node,s=r[t].primitives;n.hide(s)}return i},getHideShowPathElement:function(e,t,i){var r=this._getPathElements(e,t,i);return{visiblePath:r.pathElementsToShow,hiddenPath:r.pathElementsToHide}},getPathElement:function(e,t){var i=this._getPrimitivesNew4(e);return this.buildPathElementsFromNodes(i,t)},getPathElementsFromIDs:function(e,t,i,r,s){for(var a=new n.UUID,o=function(e,t){return a.setFromUint32(e.uuid_1,e.uuid_2,e.uuid_3,e.uuid_4),!!t.id.isEqual(a)&&(t.res.nodes.push(e),!0)},l=function(e,t){return t.id===e.cgmId&&(t.res.nodes.push(e),!0)},c=function(e,t){t.id===e.cgmId&&t.res.nodes.push(e)},d=function(e,t){for(var i=[],r=e.getPrimitivesCount(),s=0;s<r;s++)for(var a=0;a<t.length;a++)if(e.getPrimitiveCgmId(s)===t[a]){var o=new n.SGPrimitiveHelper;o.set(e,s),i.push(o);break}return i},u=[this.internalSceneGraph],p=[],f=0;f<t.length;f++){for(var g=[],m=0;m<u.length;m++){var v={nodes:[]};h(u[m],0===s?o:l,{id:t[f],nodeType:1,res:v}),v.nodes.length&&(g=g.concat(v.nodes))}if(!g.length)return null;u=g}if(0!==i&&null!=i){for(g=[],m=0;m<u.length;m++){v={nodes:[]};h(u[m],c,{id:i,nodeType:2,res:v}),v.nodes.length&&(g=g.concat(v.nodes))}if(!g.length)return null;if(u=g,null!=r)for(m=0;m<u.length;m++){v={nodes:[]};for(var _=d(u[m],r),y=0;y<_.length;y++)p.push(_[y])}}return this.buildPathElementsFromNodes(p.length>0?p:u,e)},getPathElementsFromUUIDs:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,0)},getPathElementsFromDiezeEle:function(e,t,i,r){return this.getPathElementsFromIDs(e,t,i,r,1)},_getPrimitives:function(e){var t={};if(!(e instanceof Array))return t;var i=function(e,t){if(e.getType&&3===e.getType()){var i=new s(e),r=e.getGroup();if(r&&r.geometry){var n=r.geometry.meshList[0],a=n.id;t.res[a]?function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1}(t.res[a].primitives,i.id)||t.res[a].primitives.push(i):t.res[a]={mesh:n,primitives:[i]}}}return t},r=function(e,t){l(e,function(e,t){return e.cgmId==t.path[t.index]?(t.index++,t.path.length==t.index?(t.res.push(e),t.stop=!0,t):t):(t.stop=!0,t)},t)};return l(this.internalSceneGraph,function(e,t){e.children&&e.children.length;var n,s=t.idArray.length;for(n=0;n<s;n++)if(e.getCgmId&&e.getCgmId()==t.idArray[n][0]||!e.getCgmId&&e.cgmId==t.idArray[n][0]){var a=[];r(e,{path:t.idArray[n],index:0,res:a,stop:!1}),a.length&&l(a[0],i,t)}return t},{idArray:e,res:t,stop:!1}),t},_getPrimitiveWithMesh:function(e,t){var i=function(e,t){var i,r=e.length;for(i=0;i<r;i++)if(e[i].id==t)return!0;return!1};if(e)if(e.getType){var r=THREEDS.SubElement.getFromSGNode(e),n=e.getGroup();if(n&&n.geometry&&n.geometry.meshList.length>0){var s=n.geometry.meshList[0],a=s.id;t.res[a]?i(t.res[a].reps,r.id)||t.res[a].reps.push(r):t.res[a]={mesh:s,reps:[r]}}}else l(e,function(e,t){if(2==e.type&&(t.stop=!0,e.getPrimitivesCount())){var r=e.getPrimitiveGroup(0),n=THREEDS.SubElement.getFromSGNode(e);if(r&&r.geometry){var s=r.geometry.meshList[0],a=s.id;t.res[a]?i(t.res[a].reps,n.id)||t.res[a].reps.push(n):t.res[a]={mesh:s,reps:[n]}}}return t},t);return t.res},_buildPaths:function(e,t){var i=e,r=[];for(var n in i){for(var s=i[n].mesh._occurrence.node,o=[];s.id!==this.id&&s.parents&&s.parents[0];)o.unshift(s),s=s.parents[0];t&&t.externalPath&&(o=t.externalPath.concat(o));for(var l=i[n].reps,h=0;h<l.length;h++){var c=[l[h]];s=l[h];for("primitive"==l[h].getType()&&(s=THREEDS.SubElement.getFromSGNode(l[h].sgNode.getRep()),c.unshift(s));s&&s.sgNode&&s.sgNode.parents[0];){var d=THREEDS.SubElement.getFromSGNode(s.sgNode.parents[0]);c.unshift(d),s=d}var u=new a;u.setFromArray(o,c),r.push(u)}}return r},buildPathElementsFromNodes:function(e,t){for(var i=[],r=0;r<e.length;r++)this._getPrimitiveWithMesh(e[r],{stop:!1,res:i});return this._buildPaths(i,t)},_getPathElements:function(e,t,i){var r={pathElementsToHide:[],pathElementsToShow:[]};if(!(e instanceof Array))return r;if(!(t instanceof Array))return r;for(var n=[],s=[],a=this._getPrimitivesNew4(e),o=0;o<a.length;o++){(h=a[o]).getCgmId||1!=h.type||h.noShow||(h.noShow=!0,n.push(h))}r.pathElementsToHide=this.buildPathElementsFromNodes(a,i);var l=this._getPrimitivesNew4(t);for(o=0;o<l.length;o++){var h;(h=l[o]).getCgmId||1!=h.type||h.noShow&&(h.noShow=!1,s.push(h))}var c,d=[],u=[];for(o=0;o<l.length;o++)this._getPrimitiveWithMesh(l[o],{stop:!1,res:d});for(c in d)for(var p=d[c].reps,f=0;f<p.length;f++){var g=!0,m=p[f];for("primitive"==m.getType()&&(m=THREEDS.SubElement.getFromSGNode(m.sgNode.getRep()));m&&m.sgNode&&m.sgNode.parents[0];){if("rep"!=m.getType()&&m.sgNode.noShow){g=!1;break}m=THREEDS.SubElement.getFromSGNode(m.sgNode.parents[0])}g&&(u[c]?u[c].reps.push(p[f]):u[c]={mesh:d[c].mesh,reps:[p[f]]})}r.pathElementsToShow=this._buildPaths(u,i);for(o=0;o<n.length;o++)n[o].noShow=!1;for(o=0;o<s.length;o++)s[o].noShow=!0;return r},_getPrimitivesNew2:function(e){for(var t={nodes:[]},i=0;i<e.length;i++)o(this.internalSceneGraph,d,{index:0,results:t,path:e[i]});return t.nodes},getNodeFromIdPath:function(e,t,i,r){var s=i._primitives?i.getPrimitivesCount():0,a=i.getCgmId?i.getCgmId():i.cgmId;if(a>0){if(a!=e[t])return!1;if(++t===e.length)return r.push(i),!0}else if(0==a&&0==e[t]&&++t===e.length)return r.push(i),!0;var o=i.children;if(o)for(var l=0;l<o.length;++l)this.getNodeFromIdPath(e,t,o[l],r);else if(s)for(l=0;l<s;l++){var h=new n.SGPrimitiveHelper;if(h.set(i,l),h.getCgmId()===e[t])return r.push(h),!0}},_getPrimitivesNew4:function(e){for(var t=[],i=0;i<e.length;++i)this.getNodeFromIdPath(e[i],0,this.internalSceneGraph,t);return t},_getPrimitivesNew3:function(e){for(var t=[],i={nodes:[]},r=0;r<e.length;r++){var n=e[r],s=n.length;o(this.internalSceneGraph,c,{results:i,cgmId:n[s-1]});for(var a=0;a<i.nodes.length;a++)for(var l=i.nodes[a],h=0,d=l.getCgmId?l.getCgmId():l.cgmId;d==n[s-1-h]||0==d;){if(d==n[s-1-h]&&h++,h==s){t.push(i.nodes[a]);break}if(l.getType&&3==l.getType())l=l.getRep();else{if(!l.parents||!l.parents[0])break;l=l.parents[0]}d=l.getCgmId?l.getCgmId():l.cgmId}}return t},_buildSGBagNodes:function(){var e=this.internalSceneGraph;e&&1===e.type&&(this.internalSceneGraph=this._buildSGBag(e))},_buildSGBag:function(e){var t,i,r,s=new n.SGBag;for(s.copyNoChildren(e),t=0;t<e.children.length;t++)(r=1===(i=e.children[t]).type?this._buildSGBag(i):i).parents[0]=s,s.children.push(r);return s}});return UWA.namespace("THREEDS/Nodes/CGRNode",u)}),define("Visualization/CGRNode",["DS/Visualization/CGRNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/CGRNode"),e}),define("DS/Visualization/ModelLoader",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Utils","DS/Visualization/SceneGraph","DS/VisuEvents/EventsManager","DS/Visualization/WorldOrientation","DS/Visualization/MaterialManager"],function(e,t,i,r,n,s,a){"use strict";var o=e.extend({init:function(e,i){return this._viewer=null,this.fileType="xmlv43",this.geometryMode="3dxmlgeometry",this.smartLoading=!1,this.filterNavReps=!1,this.modelName="",this._internalTarget=null,this.Ox4MQLV6Loader=null,this.cgrLoader=null,this.uvrLoader=null,this.xmlv43Loader=null,this.xmlv6Loader=null,this.xmlv6SmartLoader=null,this.colladaLoader=null,this.jsonLoader=null,this.objLoader=null,this.xcadLoader=null,this.particlesLoader=null,this.streamVisuLoader=null,this.threeDXLoader=null,this.multipartMode=!1,this.CGRNewInfra=!0,this.keepLoaderMode=!1,this.expandMode=!1,this.readDecoration=!1,this.primitiveWithBS=!1,this.forceGPUCurvedPipes=localStorage.getItem("curvedPipesInstancing")?"true"===localStorage.getItem("curvedPipesInstancing"):null,this.repWithBS=!1,this.withSAG=!1,this.useDefaultTCSet=!1,this.accuracyInfo={sag2D:0,sag3D:0},this.withBagUUID=!1,this.useUvrWorker=!0,this.withSceneGraph=!1,this.udlMode=!1,this.withBlanking=!1,this.sceneGraphOrderMode=0,this.smartStaticBatching=!0,this.edgeTransparency=!0,this.sharedBuffers=!0,this.noMeshInRAM=!1,this.processText=!1,this.accelStruct=!1,this.materialManager=null,this.targetNode=null,this.glContext=e,this.renderer=null,this.renderCB=null,this.onLoadedCB=function(){n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),window.webVisuPerfo.endPerfo("load"),t.loadingModels=!1},this.onLoadedPrdCB=null,this.onProgressCB=null,this.onErrorCB=null,this.refreshTime=2e3,this.debugBBox=void 0!==i&&i,this.forceNoWorkerForSTEP=localStorage.getItem("NoWorkerForSTEP")?"true"===localStorage.getItem("NoWorkerForSTEP"):null,this.poolOfModels={xmlv43:{loading:!1,models:[]},xmlv6:{loading:!1,models:[]},Ox4MQLV6:{loading:!1,models:[]},OxMQLV5:{loading:!1,models:[]},cgr:{loading:!1,models:[]},streamvisu:{loading:!1,models:[]},"3dx":{loading:!1,models:[]},step:{loading:!1,models:[]}},this._Ox4ProxyAbstraction=null,this},setSceneGraph:function(e){this.targetNode=e},setSceneGraphOrderMode:function(e){this.sceneGraphOrderMode=e},getSceneGraphOrderMode:function(){return this.sceneGraphOrderMode},setViewer:function(e){this._viewer=e},setTargetNode:function(e){this.targetNode=e},setWebGLContext:function(e){this.glContext=e},getCGROptions:function(){return{readDeco:this.readDecoration,optimizeCurvedPipes:this.forceGPUCurvedPipes,primWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG()||this.getUDLMode(),sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),withSAG:this.withSAG,withBagUUID:this.withBagUUID,sagInfo:this.accuracyInfo,withSceneGraph:this.getCGRWithSG()||this.getUDLMode(),udlMode:this.getUDLMode(),withBlanking:this.getCGRWithBlanking(),uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),processText:this.processText}},setRenderCallback:function(e,t){this.renderCB=e,this.refreshTime=t||2e3},setOnLoadedCallback:function(e){var i=this;this.onLoadedCB=function(r){if(window.webVisuPerfo.endPerfo("load"),n.RecordEventsManager&&n.RecordEventsManager.sendSynchroPoint("ModelLoaded"),t.loadingModels=!1,i._internalTarget){var s=new Set,a=new Set;i._internalTarget._compactHierarchy(s,a)}i._internalTarget=null,e&&e.call(this,r)}},setOnLoadedProductStructureCallback:function(e){this.onLoadedPrdCB=e},setOnProgressCallback:function(e){this.onProgressCB=e},setOnErrorCallback:function(e){this.onErrorCB=e},activateSmartLoading:function(e){null!==e&&(this.renderer=e,this.smartLoading=!0)},deactivateSmartLoading:function(){this.smartLoading=!1},setFilterNavReps:function(e){this.filterNavReps=e},getFileType:function(){return this.fileType},setFileType:function(e){this.fileType=e},getGeometryMode:function(){return this.geometryMode},setGeometryMode:function(e){this.geometryMode=e,null!==this.xmlv6Loader&&this.xmlv6Loader.setGeometryMode(e)},getMultipartMode:function(){return this.multipartMode},setMultipartMode:function(e){this.multipartMode=e},getCGRNewInfra:function(){return this.CGRNewInfra},setKeepLoaderMode:function(e){this.cgrLoader&&this.cgrLoader.setKeepLoaderMode(e),this.keepLoaderMode=e},getKeepLoaderMode:function(){return this.keepLoaderMode},setCGRNewInfra:function(e){this.CGRNewInfra=e},setPrimitivesWithBoundingSphere:function(e){t._BinaryPrimitives||!e?this.primitiveWithBS=!!e:console.warn("Primitives must be in binary form for primitive bounding spheres")},getPrimitivesWithBoundingSphere:function(){return this.primitiveWithBS&&t._BinaryPrimitives},setRepsWithBoundingSphere:function(e){this.repWithBS=!!e},getRepsWithBoundingSphere:function(){return this.repWithBS},getCGRWithSG:function(){return this.withSceneGraph},getUDLMode:function(){return this.udlMode},getCGRWithBlanking:function(){return this.withBlanking},setCGRWithBlanking:function(e){this.withBlanking=e},setCGRWithSG:function(e){this.withSceneGraph=e},setUDLMode:function(e){this.udlMode=e},getCGRWithUUID:function(){return this.withBagUUID},set3DAccuracy:function(e){this.accuracyInfo.sag3D=e},setCGRWithUUID:function(e){this.withBagUUID=e},getOptimizeCurvedPipes:function(){return this.forceGPUCurvedPipes},setOptimizeCurvedPipes:function(e){this.forceGPUCurvedPipes=e},set2DAccuracy:function(e){this.accuracyInfo.sag2D=e},getEdgeTransparency:function(){return this.edgeTransparency},setEdgeTransparency:function(e){this.edgeTransparency=e},getSharedBuffers:function(){return this.sharedBuffers},setSharedBuffers:function(e){this.sharedBuffers=e},getNoMeshInRAM:function(){return this.noMeshInRAM},setNoMeshInRAM:function(e){this.noMeshInRAM=e},getExpandMode:function(){return this.expandMode},setExpandMode:function(e){this.expandMode=e},setAccelerationStructure:function(e){this.accelStruct=e},enableLDH:function(e,t,i,r,n,s){var a=this;require(["DS/SelectiveLoading/SelectiveLoadingAsync"],function(o){a.LDH=o,a.LDH.Helpers._enableLDH(a,e,t,i,n,s),void 0!==a.LDHAsyncDestruction?a.destructLDH():r&&r()},function(e){var t=e.requireModules&&e.requireModules[0];console.error("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB()})},getLDHInterface:function(){return this._ldhInterface},destructLDH:function(){void 0===this.LDH?this.LDHAsyncDestruction=!0:(this.LDH.Helpers._ldhCleanup(this),delete this.LDHAsyncDestruction,delete this.LDH)},_onModuleError:function(e,t){return function(i){var r=i.requireModules&&i.requireModules[0];console.log("Module "+r+" is missing."),e&&e({url:t,type:"FORMAT"})}},_xmlv43LoaderCB:function(e){var t=this;this.xmlv43Loader.load(e.jsonSettings,function(i,r){t._viewer&&(1===r?t._viewer.setWorldOrientation(s.YUpXRight):t._viewer.setWorldOrientation(s.ZUpYRight)),e.destination.addChild(i),null!==e.loadedProductCB&&e.loadedProductCB(i),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},e.loadedProductCB,e.progressCB,e.loadedCB,e.errorCB,e.filterNavReps,e.refreshTime,e.readDecoration,e.cgrNewInfra,e.primitiveWithBS,e.edgeTransparency,e.cgrWithSG,e.cgrWithBlanking,e.sharedBuffers,e.noMeshInRAM,e.smartStaticBatching,e.cgrWithSAG,e.accuracyInfo,e.uvrWorker,e.applicativeContainers,e.processText,e.cgrWithBagUUID,e.repWithBS,e.optimizeCurvedPipes,e.udlMode)},_xmlv6LoaderCB:function(e){this.xmlv6Loader.load(e.modelName,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!0}),e.destination=null},e.progressCB,e.loadedCB)},_Ox4MQLV6LoaderCB:function(e){this.Ox4MQLV6Loader.load(e.jsonSettings,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1}),e.destination=null},e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_OxMQLV5LoaderCB:function(e){this.OxMQLV5Loader.load(e.jsonSettings,function(t){e.destination.addChild(t),null!==e.loadedProductCB&&e.loadedProductCB(t),null!==e.renderCB&&e.renderCB({needReframe:!1})},e.progressCB,e.loadedCB,e.errorCB,{edgeTransparency:e.edgeTransparency})},_cgrLoaderCB:function(e){var t={isBuffer:e.isBuffer,destination:e.destination,isMultipartMode:e.cgrMultipartMode,isExpandMode:e.cgrExpandMode,isCGRNewInfra:e.cgrNewInfra,readDeco:e.readDecoration,optimizeCurvedPipes:e.optimizeCurvedPipes,primWithBS:e.primitiveWithBS,repWithBS:e.repWithBS,smartStaticBatching:e.smartStaticBatching,sceneGraphOrderMode:e.sceneGraphOrderMode,withSAG:e.cgrWithSAG,withSAG:e.cgrWithSAG,useDefaultTCSet:e.useDefaultTCSet,withBagUUID:e.cgrWithBagUUID,sagInfo:e.accuracyInfo,edgeTransparency:e.edgeTransparency,sharedBuffers:e.sharedBuffers,noMeshInRAM:e.noMeshInRAM,withSceneGraph:e.cgrWithSG,udlMode:e.udlMode,cgrWithBlanking:e.cgrWithBlanking,applicativeContainers:e.applicativeContainers,mode2D:e.mode2D,processText:e.processText,accelStruct:e.accelStruct},i={readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB};this.cgrLoader.load(e.jsonSettings,i,t),e.destination=null},_streamVisuLoaderCB:function(e){this.streamVisuLoader.load(e.modelName,function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},null,e.loadedCB,e.destination)},_xcadLoaderCB:function(e){var t={isBuffer:e.isBuffer,destination:e.destination},i={readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,progressCallback:e.progressCB};this.xcadLoader.load(e.jsonSettings,i,t),e.destination=null},_threeDXLoaderCB:function(e){this.threeDXLoader.setMode("3dxc"===e.fileType?"concat":"zipped"),this.threeDXLoader.setSharedBuffers(e.sharedBuffers),this.threeDXLoader.setNoMeshInRAM(e.noMeshInRAM);var t=!0,i=!1,r=!1,n=this.accelStruct,s=e.jsonSettings&&e.jsonSettings.loaderSettings;s&&(t=s.primitives,i=s.reps,r=s.ssb,n=s.accelerationStructure),this.threeDXLoader.load({url:e.modelName,primitives:t,reps:i,ssb:r,accelStruct:n,lightMapAsIrradiance:s&&s.lightMapAsIrradiance,destinationNode:e.destination,readyCallback:function(t){null!==e.loadedProductCB&&e.loadedProductCB(t)},doneCallback:e.loadedCB,errorCallback:e.errorCB,gasSharing:!(!s||!s.gasSharing)})},_buildFileInfos:function(e){var t=this.buildPath(e);return this.modelName=t.serverurl?t.serverurl:"",this.modelName+=t.filename?t.filename:"",this.setFileTypeFromSpec(t),t},loadModelFromBuffer:function(e,t,i){return this.loadModel(e,t,!0,i)},loadModel:function(e,r,n,s){if(window.webVisuPerfo.startPerfo("load",-1),t.loadingModels=!0,void 0!==this.LDH&&void 0!==e.localAABox)return this.LDH.Helpers._onLoadModel(this,e,r,n);var a=this,o=null,l=void 0!==r?r:a.targetNode;if(null===l)return!1;(n=void 0!==n&&n)||(o=this._buildFileInfos(e)),this._internalTarget=l;var h={modelName:this.modelName,fileType:this.fileType,jsonSettings:o,destination:l,isBuffer:n,geometryMode:this.geometryMode,renderCB:this.renderCB,loadedProductCB:this.onLoadedPrdCB,progressCB:this.onProgressCB,loadedCB:this.onLoadedCB,errorCB:this.onErrorCB,filterNavReps:this.filterNavReps,refreshTime:this.refreshTime,readDecoration:this.readDecoration,cgrNewInfra:this.getCGRNewInfra(),optimizeCurvedPipes:this.forceGPUCurvedPipes,primitiveWithBS:this.getPrimitivesWithBoundingSphere(),repWithBS:this.getRepsWithBoundingSphere(),edgeTransparency:this.getEdgeTransparency(),cgrWithSG:this.getCGRWithSG()||this.getUDLMode(),udlMode:this.getUDLMode(),withBlanking:this.getCGRWithBlanking(),useDefaultTCSet:this.useDefaultTCSet,sharedBuffers:this.getSharedBuffers(),noMeshInRAM:this.getNoMeshInRAM(),smartStaticBatching:this.smartStaticBatching,sceneGraphOrderMode:this.getSceneGraphOrderMode(),cgrWithSAG:this.withSAG,cgrWithBagUUID:this.withBagUUID,accuracyInfo:this.accuracyInfo,uvrWorker:this.useUvrWorker,cgrMultipartMode:this.getMultipartMode(),cgrExpandMode:this.getExpandMode(),waitMaterial:this.waitMaterial,processText:this.processText,accelStruct:this.accelStruct};if("xmlv43"===this.fileType){if(n)return!1;if(s&&s.applicativeContainers&&(h.applicativeContainers=s.applicativeContainers),this.xmlv43Loader)this._xmlv43LoaderCB(h);else if(this.poolOfModels.xmlv43.models.push(h),!this.poolOfModels.xmlv43.loading){this.poolOfModels.xmlv43.loading=!0;var c=["DS/VisuLoaders/XMLV43Loader"];require(c,function(e){a.poolOfModels.xmlv43.loading=!1,a.xmlv43Loader=new e(a.glContext,a.renderCB);for(var t=a.poolOfModels.xmlv43.models,i=0;i<t.length;i++)a._xmlv43LoaderCB(t[i]);a.poolOfModels.xmlv43.models=[]},this._onModuleError(h.errorCB,h.modelName))}}else if("xmlv6"===this.fileType){if(n)return!1;this.xmlv6Loader?this._xmlv6LoaderCB(h):(this.poolOfModels.xmlv6.models.push(h),this.poolOfModels.xmlv6.loading||(this.poolOfModels.xmlv6.loading=!0,require(["DS/VisuLoaders/XMLV6Loader","DS/VisuLoaders/XMLV6SmartLoaderPassPlugin"],function(e,t){a.poolOfModels.xmlv6.loading=!1,a.xmlv6Loader=new e(a.glContext,a.renderCB,a.debugBBox,a.geometryMode),a.smartLoading&&null===a.xmlv6SmartLoader?(a.xmlv6SmartLoader=new t(a.xmlv6Loader),a.xmlv6SmartLoader.enabled=!0,a.xmlv6SmartLoader.renderTarget=null,a.renderer.addPrePlugin(a.xmlv6SmartLoader)):a.smartLoading||null===a.xmlv6SmartLoader?null!==a.xmlv6SmartLoader&&(a.xmlv6SmartLoader.enabled=!0):a.xmlv6SmartLoader.enabled=!1;for(var i=a.poolOfModels.xmlv6.models,r=0;r<i.length;r++)a._xmlv6LoaderCB(i[r]);a.poolOfModels.xmlv6.models=[]},this._onModuleError(h.errorCB,h.modelName))))}else if("Ox4MQLV6"==this.fileType)this.Ox4MQLV6Loader?(i.setProxyFromSpec(h.jsonSettings,this._Ox4ProxyAbstraction),this._Ox4MQLV6LoaderCB(h)):(this.poolOfModels.Ox4MQLV6.models.push(h),this.poolOfModels.Ox4MQLV6.loading||(this.poolOfModels.Ox4MQLV6.loading=!0,require(["DS/VisuDataAccess/Ox4MQLV6Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"],function(e,t){a.poolOfModels.Ox4MQLV6.loading=!1,a._Ox4ProxyAbstraction=t,a.Ox4MQLV6Loader=new e(a.glContext,a.renderCB,a.debugBBox,a.geometryMode);for(var r=a.poolOfModels.Ox4MQLV6.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),a._Ox4MQLV6LoaderCB(r[n]);a.poolOfModels.Ox4MQLV6.models=[]},this._onModuleError(h.errorCB,h.modelName))));else if("svg"==this.fileType)require(["DS/SVGLoader/SVGLoader"],function(e){new e({renderCB:a.renderCB,onProgressCB:a.onProgressCB,onLoadedCB:a.onLoadedCB,onErrorCB:a.onErrorCB}).load(o,l)});else if("OxMQLV5"==this.fileType){if(this.OxMQLV5Loader)i.setProxyFromSpec(h.jsonSettings,a._Ox4ProxyAbstraction),this._OxMQLV5LoaderCB(h);else if(this.poolOfModels.OxMQLV5.models.push(h),!this.poolOfModels.OxMQLV5.loading){this.poolOfModels.OxMQLV5.loading=!0;c=["DS/EV53DPlay/OxMQLV5Loader","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction"];require(c,function(e,t){a.poolOfModels.OxMQLV5.loading=!1,a._Ox4ProxyAbstraction=t,a.OxMQLV5Loader=new e(a.glContext,a.renderCB);for(var r=a.poolOfModels.OxMQLV5.models,n=0;n<r.length;n++)i.setProxyFromSpec(r[n].jsonSettings,t),a._OxMQLV5LoaderCB(r[n]);a.poolOfModels.OxMQLV5.models=[]},this._onModuleError(h.errorCB,h.modelName))}}else if("cgr"===this.fileType||"uvr"===this.fileType)s&&s.applicativeContainers&&(h.applicativeContainers=s.applicativeContainers),s&&s.mode2D&&(h.mode2D=s.mode2D),this.cgrLoader?(n&&(h.jsonSettings=e),this._cgrLoaderCB(h)):(n&&(h.jsonSettings=e),this.poolOfModels.cgr.models.push(h),this.poolOfModels.cgr.loading||(this.poolOfModels.cgr.loading=!0,require(["DS/VisuLoaders/CGRReader"],function(e){a.poolOfModels.cgr.loading=!1,a.cgrLoader=new e(a.glContext,a.renderCB,{keepLoader:a.getKeepLoaderMode()});for(var t=a.poolOfModels.cgr.models,i=0;i<t.length;i++)a._cgrLoaderCB(t[i]);a.poolOfModels.cgr.models=[]},this._onModuleError(h.errorCB,h.modelName))));else if("dae"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/DAEReader"],function(e){null===a.colladaLoader&&(a.colladaLoader=new e(a.glContext,a.renderCB)),a.waitMaterial&&a.colladaLoader.setWaitMaterial(a.waitMaterial),a.colladaLoader.loadFromSpec(o,function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null},null,a.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})})}else if("json"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/JSONReader"],function(e){null===a.jsonLoader&&(a.jsonLoader=new e(a.glContext,a.renderCB)),a.jsonLoader.load(a.modelName,function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null},null,a.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})})}else if("obj"===this.fileType){if(n)return!1;require(["DS/VisuLoaders/OBJReader"],function(e){null===a.objLoader&&(a.objLoader=new e(a.glContext,a.renderCB,s)),a.objLoader.load(o,function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null},null,a.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})})}else if("streamvisu"===this.fileType){if(n)return!1;this.streamVisuLoader?this._streamVisuLoaderCB(h):(this.poolOfModels.streamvisu.models.push(h),this.poolOfModels.streamvisu.loading||(this.poolOfModels.streamvisu.loading=!0,require(["DS/VisuLoaders/StreamVisuLoader"],function(e){a.poolOfModels.streamvisu.loading=!1,a.streamVisuLoader=new e(a.renderCB);for(var t=a.poolOfModels.streamvisu.models,i=0;i<t.length;i++)a._streamVisuLoaderCB(t[i]);a.poolOfModels.streamvisu.models=[]},this._onModuleError(h.errorCB,h.modelName))))}else if("3dx"===this.fileType||"3dxc"===this.fileType||"3dxm"===this.fileType){if(n)return!1;this.threeDXLoader?this._threeDXLoaderCB(h):(this.poolOfModels["3dx"].models.push(h),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],function(e){a.poolOfModels["3dx"].loading=!1,a.threeDXLoader=new e;for(var t=a.poolOfModels["3dx"].models,i=0;i<t.length;i++)a._threeDXLoaderCB(t[i]);a.poolOfModels["3dx"].models=[]},this._onModuleError(h.errorCB,h.modelName))))}else if("stp"===this.fileType||"step"===this.fileType||"stl"===this.fileType||"ifc"===this.fileType){if(1!=n||1==this.forceNoWorkerForSTEP){c=["DS/XCADLoader/XCADModelLoaderPlug"];require(c,function(t){for(var i=[new t],r=function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1})},s=0;s<i.length;s++)if(i[s].isManagedType(a.fileType)){var h=null;n&&(h=e),i[s].loadModel(a.fileType,a.glContext,a.renderCB,a.modelName,r,a.onProgressCB,a.onLoadedCB,a.onErrorCB,a.filterNavReps,a.refreshTime,l,o,h)}},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})})}else if("string"==typeof e&&(e=(new TextEncoder).encode(e)),this.xcadLoader)h.jsonSettings=e,this._xcadLoaderCB(h);else if(h.jsonSettings=e,this.poolOfModels.step.models.push(h),!this.poolOfModels.step.loading){this.poolOfModels.step.loading=!0;c=["DS/XCADLoader/XCADReader"];require(c,function(e){a.poolOfModels.step.loading=!1,a.xcadLoader=new e(a.glContext,a.renderCB,{keepLoader:!0});for(var t=a.poolOfModels.step.models,i=0;i<t.length;i++)a._xcadLoaderCB(t[i]);a.poolOfModels.step.models=[]},this._onModuleError(h.errorCB,h.modelName))}}else"particles"===this.fileType?require(["DS/VisuLoaders/ParticlesLoader"],function(t){null===a.particlesLoader&&(a.particlesLoader=new t(a.sceneGraph,a.renderCB));var i=o;n&&(i=e),a.particlesLoader.load(i,function(e){l.add(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),null!==a.renderCB&&a.renderCB({needReframe:!1}),l=null},null,a.onLoadedCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})}):require(["DS/ModelLoader_"+this.fileType.toLowerCase()+"/loader"],function(t){var i=new t,r=o;n&&(r=e),i.load(r,function(e){l.addChild(e),null!==a.onLoadedPrdCB&&a.onLoadedPrdCB(e),l=null},a.onProgressCB,a.onLoadedCB,a.onErrorCB,a.renderCB)},function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing."),a.onErrorCB&&a.onErrorCB({url:a.modelName,type:"FORMAT"})});return!0},addRessourceLibrary(e,t,i){this.materialManager||(this.materialManager=new a),i||this.clearRessourceLibrary();var r=this,n=this._buildFileInfos(e),s={modelName:this.modelName,fileType:this.fileType,jsonSettings:n,destination:null,isBuffer:!1,geometryMode:!1,renderCB:null,loadedProductCB:null,progressCB:null,loadedCB:function(e){for(var i=e.materials,n=0;n<i.length;n++)r.materialManager.setCGRSharedMaterial(n,i[n]);t&&t()},errorCB:this.onErrorCB};this.threeDXLoader?this._threeDXLoaderCB(s):(this.poolOfModels["3dx"].models.push(s),this.poolOfModels["3dx"].loading||(this.poolOfModels["3dx"].loading=!0,require(["DS/VisuLoaders/ThreeDXLoader"],function(e){r.poolOfModels["3dx"].loading=!1,r.threeDXLoader=new e;for(var t=r.poolOfModels["3dx"].models,i=0;i<t.length;i++)r._threeDXLoaderCB(t[i]);r.poolOfModels["3dx"].models=[]},this._onModuleError(s.errorCB,s.modelName))))},clearRessourceLibrary(){this.materialManager||(this.materialManager=new a),this.materialManager.CGRSharedMaterials.clear()},getRessourceLibraryItem(e,t){return this.materialManager?this.materialManager.getCGRSharedMaterial(e,t):null},getLoader:function(e,t){var i=this;switch(e){case"3dx":require(["DS/VisuLoaders/ThreeDXLoader"],function(e){null===i.threeDXLoader&&(i.threeDXLoader=new e),t&&t(i.threeDXLoader)})}return this.threeDXLoader},setLineTypes:function(e){this.materialManager||(this.materialManager=new a),this.materialManager.setLineTypes(e)},clearLineTypes:function(){this.materialManager&&this.materialManager.clearLineTypes()},buildPath:function(e){if("string"==typeof e){var t="",r="";if("blob:"===e.substring(0,5))return{provider:"FILE",serverurl:"",filename:e,requiredAuth:null,proxyurl:"none"};if("http://"===e.substring(0,7))t=e;else if("https://"===e.substring(0,8))t=e;else if("/"===e.substring(0,1))t=e;else if("ms-appx://"===e.substring(0,10))t=e;else if("file://"===e.substring(0,7))t=e;else{var n=location.href,s=n.indexOf("?");-1!==s&&(n=n.substring(0,s));var a=n.lastIndexOf("/");-1!==a&&(n=n.substring(0,a+1)),t=n+e}r=(t=i.parseUrl(t)).protocol,""!==t.protocol&&(r+="://"),r+=t.authority+t.path.substring(0,t.path.lastIndexOf("/"))+"/";var o=t.path.substring(t.path.lastIndexOf("/")+1,t.path.length);return""!==t.query&&(o=o+"?"+t.query),e={provider:"FILE",serverurl:r,filename:o,requiredAuth:null,proxyurl:"none"}}return"EV6"===e.provider&&(t=i.parseUrl(e.serverurl),e.serverdefinition={},e.serverdefinition.protocol=t.protocol,e.serverdefinition.hostname=""!==t.user?t.user+"@"+t.domain:t.domain,e.serverdefinition.port=t.port,e.serverdefinition.rooturi=t.path,"/"===e.serverdefinition.rooturi.slice(0,1)&&(e.serverdefinition.rooturi=e.serverdefinition.rooturi.slice(1,e.serverdefinition.rooturi.length))),e},setFileTypeFromSpec:function(e){var t="";if("string"==typeof e)t=i.getExtension(e);else if(e.provider&&"FILE"!==e.provider)"EV6"===e.provider?this.fileType="Ox4MQLV6":"EV5"===e.provider?this.fileType="OxMQLV5":this.fileType=e.provider;else if(e.format&&""!==e.format)t=e.format;else{var r=e.serverurl?e.serverurl:"";r+=e.filename?e.filename:"",t=i.getExtension(r)}""!==t&&(t.toLowerCase&&(t=t.toLowerCase()),this.fileType="3dxml"===t?"xmlv43":t)},reloadUVR:function(e,t,r,n){var s=this;require(["DS/VisuUnstreamers/UnstreamTaskDriver","DS/VisuUnstreamers/FileInZipStreamObject","DS/Visualization/ProxyAbstraction"],function(a,o,l){var h=s.buildPath(e),c=new l;i.setProxyFromSpec(h,c);var d=h.serverurl?h.serverurl:"";d+=h.filename?h.filename:"";for(var u=[],p=0;p<t.length;p++)u.push(t[p].name);c.executeGetHttpRequest(d,"blob",null,function(e){for(var i=0;i<u.length;i++){var l=new o(e,u[i]);!function(e){a.getTask("CGR",l,t[e],function(i){var a=s.getCGROptions();n&&n.applicativeContainers&&(a.applicativeContainers=n.applicativeContainers),a.unlinkToSG=!0,a.destination=[];for(var o=0;o<t[e].parents.length;o++)a.destination.push(t[e].parents[o]);i.run(function(i){var r=i.nodes;if(t&&t[e]&&t[e].parents)for(var n=t[e].parents.length,s=0;s<n;s++){var a=t[e].parents[s];a.removeChildren();for(var o=0;o<r.length;o++)a.addChild(r[o])}},r?r.onLoadedCB:null,r?r.onErrorCB:null,a)})}(i)}},s.onErrorCB)})},setWaitMaterial:function(e){this.waitMaterial=e.clone()},abort:function(){null!==this.cgrLoader&&this.cgrLoader.abort(),null!==this.xmlv43Loader&&this.xmlv43Loader.abort()}});return UWA.namespace("THREEDS/ModelLoader",o)}),define("Visualization/ModelLoader",["DS/Visualization/ModelLoader","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ModelLoader"),e}),define("DS/Visualization/FontUtils",["DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/SceneGraphNodes/CanvasNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ProxyAbstraction","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/ModelLoader"],function(e,t,i,r,n,s,a,o,l){"use strict";var h=null,c=null,d=null,u=new Set,p=new Set,f=[],g=!1,m=function(e,t){var i=function(e,t){return e.font="64px "+t,e.measureText("cwmli64dr").width},r=function(e,t,i){return e.font="64px '"+t+"','"+i,e.measureText("cwmli64dr").width};return i(t,"monospace")!=r(t,e,"monospace")||(i(t,"serif")!=r(t,e,"serif")||i(t,"sans-serif")!=r(t,e,"sans-serif"))},v=function(e){d=c.getContext("2d"),u.has(e.fn)||(m(e.fn,d)?u.add(e.fn):p.add(e.fn))},_=function(e,t){c||((c=document.createElement("canvas")).height=128),d||(d=c.getContext("2d")),d.font=e;var i=d.measureText(t);c.height=128,c.width=i.width,d.font=e,d.textAlign="left",d.textBaseline="middle",d.clearRect(0,0,c.width,c.height),d.fillStyle="#FFFFFF",d.fillText(t,0,63);for(var r=d.getImageData(0,0,c.width,c.height).data,n=0,s=c.height-1,a=0;a<c.height-1;a++)for(var o=0;o<c.width-1;o++)if(r[a*c.width*4+4*o]){n=a,a=c.height;break}for(a=c.height-1;a>=0;a--)for(o=0;o<c.width-1;o++)if(r[a*c.width*4+4*o]){s=a,a=-1;break}return{width:c.width,height:s-n,topLine:n}},y=function(t){var s,a,o,l,h,c,d,u=new i({width:t.width,height:t.height,drawCB:function(i,r,n,s,a){var o=t.topOffset;try{var l=t.color;if(a&&t.colorIndex&&(l=e._getColorMap(a)[t.colorIndex]),r.fillStyle="#"+l.getHexString(),r.font=t.fontOption,r.textAlign="left",r.textBaseline="middle",r.fillText(t.text,0,o),window.WUXDisableTextNodes)return void r.clearRect(0,0,t.width,t.height)}catch(e){console.log(failed)}},rectangleTexture:!0,maxZoom:8,alphaTest:.01,webGLV6Viewer:t.viewer}),p=(t.hotspot,t.bbox[0]),f=t.bbox[1],g=t.bbox[2],m=t.bbox[3],v=t.orientationAngle,_=f-p,y=m-g,S=v%90;switch(d=v/90,isNaN(d)?NaN:d>0?Math.floor(d):Math.ceil(d)){case 1:s=new e.Vector3(f,g,0),a=new e.Vector3(f,m,0),h=new e.Vector3(0,1,0),c=new e.Vector3(-1,0,0),o=y,l=_;break;case 2:s=new e.Vector3(f,m,0),a=new e.Vector3(p,m,0),h=new e.Vector3(-1,0,0),c=new e.Vector3(0,-1,0),o=_,l=y;break;case 3:s=new e.Vector3(p,m,0),a=new e.Vector3(p,g,0),h=new e.Vector3(0,-1,0),c=new e.Vector3(1,0,0),o=y,l=_;break;default:s=new e.Vector3(p,g,0),a=new e.Vector3(f,g,0),h=new e.Vector3(1,0,0),c=new e.Vector3(0,1,0),o=_,l=y}var x=l,b=0;(S=S*(Math.PI/180))>0&&(b=o-Math.cos(S)*t.widthRigth,x=Math.tan(Math.PI/2-S)*b);var w=l-x;h.multiplyScalar(b);var M=(new e.Vector3).copy(c).multiplyScalar(w);c.multiplyScalar(x);var C=(new e.Vector3).addVectors(s,h),P=(new e.Vector3).addVectors(s,c).sub(C),E=M.add(a).sub(C);return new r({name:"test",bottomLeftcorner:C,widthVector:E,heightVector:P,canvasNodeTexture:u,side:e.DoubleSide,_noZPriority:t._noZPriority},n)},S=function(i,r,n){var s=[];c||((c=document.createElement("canvas")).height=128);for(var a=i.length,o=0;o<a;o++){(l=h[i[o].fontName])&&v(l)}p.forEach(function(e,t,i){var r;r=e,d=c.getContext("2d"),u.has(r)||m(r,d)&&u.add(r)}),p.clear();for(o=0;o<a;o++){var l;(l=h[i[o].fontName])||(l={fn:"nofont"});var f=(l.B?"bold ":"")+(l.I?"italic ":"")+"64px '"+l.fn,g=_(f,i[o].text),S=63-g.topLine,x=(i[o].colorIndex&&i[o].colorIndex,i[o].viewer&&i[o].viewer,new e.Color({r:i[o].color.r,g:i[o].color.g,b:i[o].color.b}));r.textureInBlack&&1==i[o].color.r&&1==i[o].color.g&&1==i[o].color.b&&(x.r=x.g=x.b=0);var b=y({text:i[o].text,width:g.width,height:g.height+1,color:x,fontOption:f,topOffset:S,bbox:i[o].bbox,widthRigth:i[o].width,orientationAngle:i[o].orientationAngle,_noZPriority:i[o]._noZPriority});if(i[o].matrix&&b.setMatrix((new e.Matrix4).setFromArray(i[o].matrix.elements)),i[o].attachedPoint){var w=new t({type:"Spherical"});w.setMatrix((new e.Matrix4).setFromArray(i[o].attachedPoint.elements)),w.addChild(b),s.push(w)}else s.push(b)}n(s)},x={table:h,createTexts:function(e,t,i){h?S(e,t,i):(f.push({cgrTexts:e,options:t,doneCallback:i}),g||(g=!0,require(["text!Visualization/assets/fonts/fontTable.json"],function(e){h=JSON.parse(e),function(){for(var e=0;e<f.length;e++)S(f[e].cgrTexts,f[e].options,f[e].doneCallback);f=[]}()})))},measureText:_};return UWA.namespace("THREEDS/FontUtils",x)}),define("DS/Visualization/ParticlesNode3D",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t,i){"use strict";var r=i.extend({init:function(e,i){this._parent(i);var r=e.material?e.material:null;t.disableJHGDev||(this.material=r),this.particles3js=void 0!==e?e:new t.ParticleSystem;var n=t.convertParticleSystemToBufferGeometryDS(this.particles3js.geometry);this.particles3js=new t.Mesh(n,r),this.particles3js.frustumCulled=!1,e=this.createRenderable();var s=this._occurrences[0];return s.renderable=e,s.renderable.name=this.name,s.renderable._occurrence=s,this.hasExplicitBE=!0,this.explicitBSphere=null,this.explicitBBox=null,void 0!==this.particles3js.geometry.boundingSphere&&(this.explicitBSphere=this.particles3js.geometry.boundingSphere.clone()),this},createRenderable:function(){var e=this.particles3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.particles3js.visible,e.pickable=this.particles3js.pickable,e.noPickThrough=this.particles3js.noPickThrough,e.renderDepth=this.particles3js.renderDepth,e.frustumCulled=this.particles3js.frustumCulled,e.enableNormalDepth=!1,e},add:function(){return!1},setPickable:function(t){var i,r;for("boolean"==typeof t&&console.log("boolean is DEPRECATED in setPickable() method.\n Use ENUM Mesh"),null!==this.particles3js&&(this.particles3js.pickable=t===e.PICKABLE,this.particles3js.noPickThrough=t!==e.PICKTHROUGH),i=0;i<this._occurrences.length;i++)null!==(r=this._occurrences[i]).renderable&&(r.renderable.pickable=this.particles3js.pickable,r.renderable.noPickThrough=this.particles3js.noPickThrough,r.renderable._flagAsGSSOInvalidated())},getNodeType:function(){return"ParticlesNode3D"}});return UWA.namespace("THREEDS/Nodes/Particles",r)}),define("Visualization/ParticlesNode3D",["DS/Visualization/ParticlesNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/ParticlesNode3D"),e}),define("DS/Visualization/AnnotationServices",["UWA/Class","DS/Visualization/Utils","DS/Formats/CGRFile","DS/Visualization/ModelLoader","DS/Visualization/ProxyAbstraction","DS/ZipJS2/LoaderInflate"],function(e,t,i,r,n,s){"use strict";var a=null,o=e.extend({init:function(){return null!==a?(this.loader=a.loader,this.modelLoader=a.modelLoader,this):(this.loader=new i,this.modelLoader=new r,a=this,this)},cleanAll:function(){this.loader=null,this.modelLoader=null},getApplicativeContainerNew:function(e,i,r,s){var a=this.modelLoader.buildPath(e),o=new n;t.setProxyFromSpec(a,o);var l=a.serverurl?a.serverurl:"";l+=a.filename?a.filename:"";var h,c=this,d=(h=i,function(e){c.loader.setFileBuffer(new Uint8Array(e));var t=c.loader.getApplicativeContainer(h);r(t)});o.executeGetHttpRequest(l,"arraybuffer",null,d,s)},processFTABuffer:function(e){if(!e)return null;var t=e.buffer.subarray(e.options.offset,e.options.compressed+e.options.offset);if(t.length<=2)return null;if(120!==t[0])return null;if(218!==t[1])return null;var i=t.subarray(2,e.options.compressed);return function(e){var t,i,r,n,s,a;for(t="",r=e.length,i=0;i<r;)switch((n=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(n);break;case 12:case 13:s=e[i++],t+=String.fromCharCode((31&n)<<6|63&s);break;case 14:s=e[i++],a=e[i++],t+=String.fromCharCode((15&n)<<12|(63&s)<<6|(63&a)<<0)}return t}((new s).Inflate(i))},getFTAContainer:function(e,t,i,r){var n=this;this.getApplicativeContainerNew(e,t,function(e){var t=n.processFTABuffer(e);t?i({xml:t}):i()},r)},openSceneGraph:function(e){return this.loader.openSceneGraph(e)}});return UWA.namespace("THREEDS/AnnotationServices",o)}),define("Visualization/AnnotationServices",["DS/Visualization/AnnotationServices","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/AnnotationServices"),e}),define("DS/Visualization/LightNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var r=t.extend({init:function(t,i,r){this._parent(i),this.light3js=void 0!==t?t:new e.AmbientLight,t=this.createRenderable(),this._matrix=(new e.Matrix4).setPosition(new e.Vector3(0,0,1)),this._intensity=t.intensity,this._color=t.color,this._attachedToVpt=!!r;var n=this._occurrences[0];return n.renderable=t,n.renderable.name=this.name,n.renderable._occurrence=n,this},createRenderable:function(){var e=this.light3js.clone();return e.matrixAutoUpdate=!1,e.visible=this.light3js.visible,e.matrixWorldNeedsUpdate=!1,e.castShadow=this.light3js.castShadow,e.shadowCameraLeft=this.light3js.shadowCameraLeft,e.shadowCameraRight=this.light3js.shadowCameraRight,e.shadowCameraTop=this.light3js.shadowCameraTop,e.shadowCameraBottom=this.light3js.shadowCameraBottom,e.shadowCameraNear=this.light3js.shadowCameraNear,e.shadowCameraFar=this.light3js.shadowCameraFar,e.shadowBias=this.light3js.shadowBias,e.shadowDarkness=this.light3js.shadowDarkness,e.shadowMapWidth=this.light3js.shadowMapWidth,e.shadowMapHeight=this.light3js.shadowMapHeight,e.shadowCameraVisible=this.light3js.shadowCameraVisible,e},add:function(){return!1},updateShadowMap:function(){var e,t;for(null!==this.light3js&&(this.light3js.updateShadowMap=!0),e=0;e<this._occurrences.length;e++)null!==(t=this._occurrences[e]).renderable&&(t.renderable.updateShadowMap=!0)},blockShadowUpdates:function(e){var t,i;for(null!==this.light3js&&(this.light3js.blockUpdate=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.blockUpdate=e)},attachToViewpoint:function(e){this._attachedToVpt=e},setIntensity:function(e){this._intensity=void 0===e?1:e,this._updateIntensity()},_updateIntensity:function(){var e,t;for(this.light3js.intensity=this._intensity,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.intensity=this._intensity},setColor:function(t){t instanceof e.Color?this._color=t:this._color=new e.Color(t),this._updateColor()},setPhysical:function(e){let t=this._occurrences.length;for(this.light3js._phongReduction=!!e,i=0;i<t;i++){this._occurrences[i].renderable._phongReduction=!!e}},_updateColor:function(){var e,t;for(this.light3js.color=this._color,e=this._occurrences.length,t=0;t<e;t++)this._occurrences[t].renderable.color=this._color},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"LightNode3D"},_setShadowCameraVisible:function(e){this.light3js.shadowCameraVisible=e;let t=this._occurrences.length;for(let i=0;i<t;i++){this._occurrences[i].renderable.shadowCameraVisible=e}},dispose:function(){for(i=0;i<this._occurrences.length;i++){this._occurrences[i].renderable.dispose()}}});return UWA.namespace("THREEDS/Nodes/Light",r)}),define("Visualization/LightNode3D",["DS/Visualization/LightNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/LightNode3D"),e}),define("DS/Visualization/Ambience",["DS/Visualization/ThreeJS_DS","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/SceneGraphFactory","DS/Visualization/Utils","DS/Visualization/WorldOrientation","DS/CoreEvents/Events","DS/Effects/ExtractLightFromIBL","DS/Effects/MergeMainMipsEffect","WebappsUtils/WebappsUtils","DS/SceneGraphNodes/DirectionalLightNode"],function(e,t,i,r,n,s,a,o,l,h){"use strict";var c=e._AmbianceGenerators,d=c._dummyRoughnessTexture;const u="true"===localStorage.getItem("__WebVisu_LinearFilter_IBL__")?e.LinearFilter:e.NearestFilter;var p=function(t,i){var r=void 0!==(t=t||{}).image?t.image:null,n=void 0!==t.format?t.format:null,s=void 0!==t.sRGB?t.sRGB:"hdr"!=n,a=void 0!==t.type?t.type:"url",o=void 0!==t.texture?t.texture:null,l=void 0!==i?i:null,h=function(){console.log("loading image error")};this.stream=function(){return o?{texture:o,format:n}:null},this.getTexture=function(){return o},this.getImage=function(){return r},this.getFormat=function(){return n},this.isSRGB=function(){return s},this.isTextureHDRFloat=function(){return!(!o||o.type!=e.FloatType||o.format!=e.RGBFormat)},this.getType=function(){return a},this.setTexture=function(e){s=(o=e).sRGB},this.setFormat=function(e){n=e,"hdr"==e&&(s=!1)},this.setSRGB=function(e){s=e},this.setType=function(e){a=e},this.loadImage=function(t){var i=this.getImage(),r=this;if("url"==this.getType())if("hdr"==this.getFormat())(o=e.ImageUtils.loadHDRTexture(i,t,l,h,!1,!1)).minFilter=u,o.magFilter=u;else if("dds"==this.getFormat()){o=e.ImageUtils.loadCompressedTexture(i,t,function(e){r.isTextureHDRFloat()&&(r.setFormat("hdr"),e.hdr=!0,e.rgbHdr=!0),r.setSRGB(e.sRGB),l(e)})}else o=new e.ImageUtils.loadTexture(i,t,l,null,e.ImageUtils.crossOriginPolicy);"urlCube"==this.getType()?o=e.ImageUtils.loadTextureCube(i,t,l):i&&i instanceof e.Texture&&((o=i).loadEndStatus===e.AssetLoadingStatus.READY?l():o.onLoadCallbacks.push(l))}},f=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i="latlong",r=[],n=0,s=new p,a="bestFit",o=1,l=1,h=null,c=1,d={transition:0,image:new p,ambienceMatrix:new e.Matrix4,inverseMatrix:new e.Matrix4,radius:0},u=this,f=function(e){u.needUpdate=!0};this.setFromJson=function(h){if(t=!0,this.needUpdate=!0,h.type&&(i=h.type),h.sizeScaling&&(a=h.sizeScaling),h.intensity&&(o=h.intensity),h.ratio&&(l=h.ratio),h.horizonHeight&&(n=h.horizonHeight),h.image&&h.image.texture&&(s.setTexture(h.image.texture),s.setFormat(h.image.format)),h.colors)for(var c=0;c<h.colors.length;c++)r.push((new e.Color).setRGB(h.colors[c][0],h.colors[c][1],h.colors[c][2]))},this.stream=function(){if(t){var e={};if(e.type=i,r.length){for(var h=[],c=0;c<r.length;c++)h.push([r[c].r,r[c].g,r[c].b]);e.colors=h}return e.horizonHeight=n,e.sizeScaling=a,e.intensity=o,e.ratio=l,e.image=s.stream(),e}return null},this.isActivated=function(){return t},this.getType=function(){return i},this.initDefaultColors=function(t){r=[];for(var i=0;i<t;i++)r.push(new e.Color)},this.getColors=function(){switch(this.getType()){case"gradient":2!=r.length&&this.initDefaultColors(2);break;case"gradient3":3!=r.length&&this.initDefaultColors(3);break;case"gradientWithHorizon":4!=r.length&&this.initDefaultColors(4)}return r},this.getHorizonHeight=function(){return n},this.getBackplateScale=function(){return c},this.setBackplateScale=function(e){e!==c&&(c=e,"backplate"==i&&(this.needUpdateParameters=!0))},this.getImage=function(){return s},this.getSizeScaling=function(){return a},this.getIntensity=function(){return o},this.getBlur=function(){return 0},this.getRatio=function(){return l},this.getBackplateCB=function(){return h},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){i!=e&&(i=e,this.needUpdate=!0),t||this.setActivated(!0)},this.setColors=function(e){var t;switch((r=e).length){case 2:t="gradient";break;case 3:t="gradient3";break;case 4:t="gradientWithHorizon";break;default:return!1}this.setType(t),this.needUpdateParameters=!0},this.setHorizonHeight=function(e){n=e,this.needUpdateParameters=!0},this.setSizeScaling=function(e){a=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setBlur=function(e){},this.setRatio=function(e){l=e,this.needUpdateParameters=!0},this.setBackplateCB=function(e){h=e,this.needUpdateParameters=!0},this.hasGradient=function(){return t&&("gradient"==i||"gradientWithHorizon"==i)},this.loadImage=function(t){t.doneCallback&&(f=function(){t.doneCallback(),u.needUpdate=!0}),t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),(s=new p(t,f)).loadImage(function(t,i){switch(t){case"cubemap":return new e.CubeEnvMapping;case"environment":return new e.LatLongReflectionMapping;case"latlong":return new e.LatLongEnvMapping;case"backplate":return new e.SimpleEnvMapping}}(this.getType(),this.getSizeScaling()))},this.withImage=function(){if(!s.getTexture())return!1;var e=this.getType();return"cubemap"==e||"latlong"==e||"backplate"==e||"transition"==e||"transitionCube"==e},this.getTransitionInfos=function(){return d},this.setTransitionInfos=function(e){d=e}},g=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var i=!1,r="sphere",n=5e3,s=new e.Vector3(0,0,.5),a=!1;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(r=e.type),e.size&&(n=e.size),e.shootPosition&&s.set(e.shootPosition[0]/n,e.shootPosition[1]/n,e.shootPosition[2]/n)},this.setYUp=function(e){i=e},this.stream=function(){if(t){var e={};return e.type=r,e.size=n,e.shootPosition=s.toArray(),e}return null},this.isActivated=function(){return t},this.getType=function(){return r},this.getSize=function(){return n},this.isAutoUpdateSize=function(){return a},this.getShootPosition=function(){return i?new e.Vector3(s.x,s.z,s.y):s},this.getWorldShootPosition=function(t){var i=(new e.Matrix4).extractRotation(t);return this.getShootPosition().clone().applyMatrix4(i)},this.setActivated=function(e){e!=t&&(this.needUpdate=!0),t=e},this.setType=function(e){r=e,this.needUpdate=!0},this.setSize=function(e){n>0&&(n=e),this.needUpdateParameters=!0},this.setAutoUpdateSize=function(e){a=e},this.setShootPosition=function(e){s=e,this.needUpdateParameters=!0}},m=function(){var t=!1;this.needUpdate=!1,this.needUpdateParameters=!1,this.needsUpdateShadowIntensity=!1;var i="transparent",r=0,n=0,s=1,a=0,o=new e.Color;this.disableDefaultGroundShadow=!1;var h=null,c=!0;this.setFromJson=function(e){t=!0,this.needUpdate=!0,e.type&&(i=e.type),e.planeColor&&this.setPlaneColor(e.planeColor),void 0!==e.height&&(r=e.height),void 0!==e.reflectivity&&(n=e.reflectivity),void 0!==e.glossiness&&(s=e.glossiness),void 0!==e.shadowIntensity&&(a=e.shadowIntensity),e.material},this.stream=function(){if(t){var e={};return e.type=i,e.height=r,e.autoHeight=c,e.reflectivity=n,e.glossiness=s,e.shadowIntensity=a,e.material=h,e}return null},this.isActivated=function(){return t},this.getPlaneColor=function(){return o},this.isPhysical=function(){return!!h&&"physical"==this.getType()},this.getType=function(){return i},this.getHeight=function(){return r},this.getAutoHeight=function(){return c},this.getReflectivity=function(){return n},this.getGlossiness=function(){return s},this.getShadowIntensity=function(){return a},this.getMaterial=function(){return h},this.setActivated=function(e){e!=t&&(this.needUpdate=!0,this.needUpdateParameters=!0),t=e},this.setGroundOutDoor=function(){this.needUpdate=!0,i="physical",function(){h=new e.DSPBR19xMaterial({side:0,opacity:.99,roughness:.9});var t=l.getWebappsAssetUrl("Visualization","")+"OCA/",i=e.ImageUtils.loadTexture(t+"Outdoor_Ground_Diffuse.jpg");i.generateMipmap=!0,i.minFilter=e.LinearMipMapLinearFilter,i.magFilter=e.LinearFilter,i.repeat=new e.Vector2(10,10),i.wrapS=1e3,i.wrapT=1e3;var r=e.ImageUtils.loadTexture(t+"Outdoor_Ground_MainMap.jpg");r.generateMipmap=!0,r.minFilter=e.LinearMipMapLinearFilter,r.magFilter=e.LinearFilter,r.repeat=new e.Vector2(1,1),r.wrapS=1e3,r.wrapT=1e3,h.side=0,h.forceSide=!0,h.force=!0,h.needsUpdate=!0,h.depthWrite=!1,h.activatePDSFX();var n={fadingStrenght:{type:"f",value:5},fadingRatio:{type:"f",value:1},s_MaterialMap:{type:"t2",value:r},s_BaseColorMap:{type:"t2",value:i}};h.setPDSFXUniforms(n);h.setPDSFXVaryings({_vUv:{type:"v2"}});var s=["float ratio = 1.0;","vec2 uv[2];","float dUV = 1.0;","vec4 groundColor = vec4(290.0/255.0, 214.0/255.0, 164.0/255.0, 1.0) ;","mat3 MainMatrix_UVTransfo = mat3(10, 0.0, 0.0,","                                 0.0, 10, 0.0,","                                 0.0, 0.0, 1.0);","mat3 Matrix1_UVTransfo = mat3(1.0024, 0.9758, 0.0,","                              -0.9758, 1.0024, 0.0,","                              0.0, 0.0, 1.0);","mat3 Matrix2_UVTransfo = mat3(1.7, 0.0, 0.0,","                              0.0, 1.6, 0.0,","                              0.01, 0.78, 1.0);","vec2 TransformUV(vec2 iUV, mat3 iMatrix) {","    vec3 uv = iMatrix*vec3(iUV, 1.0);","    return uv.xy;","}"].join("\n");h.setPDSFXGlobalShaderCode("",s);var a={ComputeVaryingValues:["void ComputeVaryingValues() {","_vUv = vGetAttribTexCoord0().xy;","}"].join("\n")},o={ComputeAlbedo:["vec3 ComputeAlbedo() {","return mix(texture2D(s_BaseColorMap, uv[0]).xyz, texture2D(s_BaseColorMap, uv[1]).xyz, ratio);","}"].join("\n"),ComputeCommonValues:["void ComputeCommonValues() {","dUV = smoothstep(0.0,0.8,(length(2.0 * _vUv - 1.0)));","vec2  p_vUv = TransformUV(_vUv, MainMatrix_UVTransfo);","uv[0] =  TransformUV(p_vUv, Matrix1_UVTransfo);","uv[1] =  TransformUV(p_vUv, Matrix2_UVTransfo);","float ratio  = texture2D(s_MaterialMap, TransformUV(p_vUv, MainMatrix_UVTransfo)).r;","}"].join("\n"),ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","  ioFinalColor.a = 1.0 - dUV;","}"].join("\n")};h.setPDSFXOverridableFunctions(a,o)}()},this.setPlaneColor=function(e){o=e,this.needUpdateParameters=!0},this.setType=function(e){t&&i!=e&&(this.needUpdate=!0),i=e},this.setHeight=function(e){r=e,this.needUpdateParameters=!0},this.setAutoHeight=function(e){c=e,this.needUpdateParameters=!0},this.setReflectivity=function(e){0!==n&&0!==e||!(n>0||e>0)||(this.needUpdate=!0),n=e,this.needUpdateParameters=!0},this.setGlossiness=function(e){s=e,this.needUpdateParameters=!0},this.setShadowIntensity=function(e){a!==e&&(this.needsUpdateShadowIntensity=!0),0!==a&&0!==e||!(a>0||e>0)||(this.needUpdate=!0,this.needUpdateParameters=!0),a=e},this.setMaterial=function(e){h=e,this.needUpdateParameters=!0}},v=function(t){var i=!1;this.needUpdate=!1,this.needUpdateParameters=!1;var r=t,n=new p,s="latlong",a=new e.Color(16777215),o=1,l=1,h=new e.Matrix4,c=new e.Matrix4,d=!1,u=this,f=function(){u.needUpdate=!0};this.setFromJson=function(t,c,d){if(c&&(r=!0,d&&h.multiplyMatrices(h,(new e.Matrix4).extractRotation(d))),i=!0,t.projection&&(s=t.projection),t.emissionColor&&(a=a.setRGB(t.emissionColor[0],t.emissionColor[1],t.emissionColor[2])),t.emissionValue&&(o=t.emissionValue,l=t.emissionValue),r){if(t.matrix){var u=(new e.Matrix4).setFromArray(t.matrix);h.multiplyMatrices(h,u)}this.updateMatrix()}else if(h.rotateZ(-Math.PI/2),t.matrix){u=(new e.Matrix4).setFromArray(t.matrix);var p=(new e.Matrix4).getInverse(u);h.multiplyMatrices(h,p)}t.image&&t.image.texture&&(n.setTexture(t.image.texture),n.setFormat(t.image.format),this.needUpdate=!0)},this.updateMatrix=function(){c.identity(),c.rotateZ(-Math.PI/2),d&&c.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(h);c.multiplyMatrices(c,t)},this.stream=function(){if(i){var e={};return e.projection=s,e.emissionColor=[a.r,a.g,a.b],e.emissionValue=o,e.matrix=h.elements.slice(0),e.image=n.stream(),e}return null},this.isActivated=function(){return i},this.setYUp=function(e){d=e,this.updateMatrix()},this.getImage=function(){return n},this.getProjection=function(){return scale},this.getValue=function(){return value},this.getMatrix=function(){return h},this.getInverseMatrix=function(){return c},this.getIntensity=function(){return o},this.getDiffuseIntensity=function(){return l},this.setActivated=function(e){e!=i&&(this.needUpdate=!0,i=e)},this.setValue=function(e){value=e,this.needUpdateParameters=!0},this.setIntensity=function(e){o=e,l=e,this.needUpdateParameters=!0},this.setSpecularIntensity=function(e){o=e,this.needUpdateParameters=!0},this.setDiffuseIntensity=function(e){l=e,this.needUpdateParameters=!0},this.setMatrix=function(e){h=e,r&&this.updateMatrix(),this.needUpdateParameters=!0},this.loadImage=function(t){var i;t.type="url",t&&t.image&&t.image instanceof e.Texture&&(t.type="THREETexture"),t&&t.image&&t.image instanceof Array&&(t.type="urlCube"),i=t.cb?function(e){t.cb(e),f()}:f,(n=new p(t,i)).loadImage(new e.LatLongReflectionMapping)},this.updateMatrix()},_=function(){var t=new e.Vector3(0,0,0),i=new e.Vector3(0,0,1),r=(new e.Vector3(0,0,1),new e.Vector3(0,0,0)),n=1,s=!0,a=!1;this.needUpdateParameters=!1,this.setFromJson=function(e){e.groundPosition&&(t=e.groundPosition),e.groundNormal&&(i=e.groundNormal),e.sceneHeight&&(r=e.sceneHeight),e.groundScale&&(n=e.groundScale),e.withGround&&(s=e.withGround)},this.updateMatrix=function(){i.set(0,0,1),a&&i.set(0,1,0)},this.updateFromMatrix=function(i){t.getPositionFromMatrix(i),i=(new e.Matrix4).extractRotation(i),this.updateMatrix()},this.setYUp=function(e){a=e,this.setSceneHeight(r),this.updateMatrix()},this.stream=function(){var e={};return e.groundPosition=t,e.groundNormal=i,e.sceneHeight=r,e.groundScale=n,e.withGround=s,e},this.isWithGround=function(){return s},this.getGroundPosition=function(){return t},this.getGroundNormal=function(){return i},this.getSceneHeight=function(){return r},this.getGroundScale=function(){return n},this.setGroundPosition=function(e){e.x==t.x&&e.y==t.x&&e.z==t.z||(t.copy(e),this.needUpdateParameters=!0)},this.setWithGround=function(e){s=e},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal")},this.setSceneHeight=function(t){r=a?new e.Vector3(0,t.z,0):t.clone(),this.needUpdateParameters=!0},this.setGroundScale=function(e){n=e,this.needUpdateParameters=!0}},y=function(l){var p=this;l||(l={}),this.requestIBLLightExtraction=s.subscribe({event:"/VISU/requestIBLLightExtraction"},function(e){p._extractIBLLight(e.extraData.rendererID)});var S=void 0!==l.viewer?l.viewer:null,x=void 0!==l.roughnessMap?l.roughnessMap:d,b="",w=!0,M=new f,C=new g,P=new m,E=new v(w),T=new _,A=new e.Matrix4,D=new e.Matrix4,I={},R=!1,O=!1,L=[],V=[],F=!1,B=null,N=[],G=[],k=null,U=0,z=!1,H=null,W=0,j=0,X=0,q=0,Z=0,Y=0,Q=0,K=0,$=0,J=new e.Vector2(1,1),ee=new e.Vector2(0,0);l.finiteEnv&&C.setActivated(!0),this.usePlaneV2=!1,l.usePlaneV2&&(this.usePlaneV2=!0);var te=null,ie=!1;!1===l.autoGroundOffset&&P.setAutoHeight(!1);var re=new e.Color(0),ne=1,se=!1;S&&S.currentViewpoint&&S.currentViewpoint.camera&&S.currentViewpoint.camera.isOrtho&&(se=!0);var ae=!1,oe=null,le=1920,he=1080,ce=1,de=!1;this.needUpdateIBL=new Set;this.isOCA=!1,this.keepIBLTexture=!0,this.keepBackgroundTexture=!0,this.setCameraOrtho=function(e){se!=e&&(se=e,de=!0,this.update())},this.useRenderToTarget=function(e){e},this.setWorldOrientation=function(e){var t=e==n.YUpXRight;E.setYUp(t),T.setYUp(t),C.setYUp(t),z=t,this.updateMatrix(),this.update()},this.updateAmbience=function(){Ce(),pe(),this.needUpdateIBL=new Set},this.setGroundOptions=function(e){S&&(S.setGroundOptions(e),I=S._getGroundOptions())},this.setOnComputeRoughnessMapCb=function(e){B=e};this.isComputingRoughnessMap=function(){return F};var ue=function(){if(S){c.setCallBack(function(){F=!1,c.setCallBack(null),B&&B()})}};this.isTextureLoading=function(){return R||O},this.updateMatrix=function(){D.identity(),D.rotateZ(-Math.PI/2),z&&D.rotateX(Math.PI/2);var t=(new e.Matrix4).getInverse(A);t.elements[12]=A.elements[12],t.elements[13]=A.elements[13],t.elements[14]=A.elements[14],D.multiplyMatrices(D,t);var i=M.getTransitionInfos();i.inverseMatrix.identity(),i.inverseMatrix.rotateZ(-Math.PI/2),z&&i.inverseMatrix.rotateX(Math.PI/2),(t=(new e.Matrix4).getInverse(i.ambienceMatrix)).elements[12]=i.ambienceMatrix.elements[12],t.elements[13]=i.ambienceMatrix.elements[13],t.elements[14]=i.ambienceMatrix.elements[14],i.inverseMatrix.multiplyMatrices(i.inverseMatrix,t)},this.loadFrom3dx=function(t,i,r,n,s){var a=t;r&&(w=!0);var o=null;if(a.name&&(b=a.name),w)a.transform&&(o=(new e.Matrix4).setFromArray(a.transform),A.multiplyMatrices(A,o),T.updateFromMatrix(A)),this.updateMatrix();else if(A.rotateZ(-Math.PI/2),a.transform){o=(new e.Matrix4).setFromArray(a.transform);var l=(new e.Matrix4).getInverse(o);l.elements[12]=o.elements[12],l.elements[13]=o.elements[13],l.elements[14]=o.elements[14],A.multiplyMatrices(A,l)}a.backgroundGeometry&&C.setFromJson(a.backgroundGeometry),a.ground?P.setFromJson(a.ground):r&&this.setGroundGeometry(!1);var h={useSky:!1,background:!0,dir:null,intensity:1,height:null,groundHeight:P.getHeight()};if(a.environmentLight)if(a.environmentLight.sun_direction&&!1!==a.environmentLight.enabled){h.useSky=!0;var c=a.environmentLight.sun_direction;if(h.dir=new e.Vector3(-c[0],-c[1],-c[2]),o){var u=(new e.Matrix4).extractRotation(o);h.dir.applyMatrix4(u)}null!=a.environmentLight.altitude&&(h.height=a.environmentLight.altitude),null!=a.environmentLight.intensity&&(h.intensity=a.environmentLight.intensity)}else r?E.setFromJson(a.environmentLight,r,o):E.setFromJson(a.environmentLight,r);if(P.setAutoHeight(!1),a.background)if("color"==a.background.type&&"color"==a.background.type){var p=a.background.colors[0];re.setRGB(p[0],p[1],p[2]),ne=p[3],S&&S.setBackgroundColor(re.getHex(),ne)}else M.setFromJson(a.background);if(i?this.loadImageFrom3dx(i,n,s):x||(x=!r&&E.getImage().getTexture()?null:d,this.needUpdateIBL=new Set),h.useSky&&S){var f=null==h.height?S.currentViewpoint.camera.position.z-h.groundHeight:h.height;f*=a.unitScale/1e6,this.setSkyLighting(h.dir,Math.max(f,.001),h.intensity,h.background)}},this._extractIBLLight=function(e){if(!k){var t=this.getIblMap();if(t&&S&&S.renderer&&S.renderer.renderer&&S.renderer.renderer.id===e){var i=new a(S.renderer.renderer,S.renderer.renderTargetPool);i.setEnvMap(t),k=i.execute(N.filter(function(e){return e.light3js.castShadow&&e.light3js.intensity>0}).length>0),i.dispose(),s.publish({event:"/VISU/IBLLightExtracted",data:{eventChannel:"/VISU/IBLLightExtracted",eventType:"@IBLLightExtracted"}})}k&&U++}},this._solveSceneRoughnessMap=function(e,t){if(S){var i=this.getIblMap();if(i){var r=new o(S.renderer.renderer,S.renderer.renderTargetPool);r.setTextures(e.textures,i,e.ggx0,e.ggxMapping),this.setRoughnessMap({texture:r.execute()}),r.dispose(),s.publish({event:"/VISU/3DXMipsMerged",data:{eventChannel:"/VISU/3DXMipsMerged",eventType:"@3DXMipsMerged"}}),t&&t({ambiance:this})}}},this.addLightNode=function(e){U++,this.removeIBLLight(),N.push(e)},this.removeIBLLight=function(){if(k){k.light.dispose();for(let e=0;e<G.length;e++)G[e].scene.remove(k.light);k=null}},this.updateLights=function(t,i,r,n,s){if(i){if(U!=i.scene.ambienceLightState){for(var a=0;a<N.length;a++)i.addLightNode(N[a]);k&&i.scene.add(k.light),i.scene.ambienceLightState=U}-1==G.indexOf(i)&&G.push(i)}var o,l,h,c,d=t.getUpDirection(),u=t.getSightDirection();(new e.Vector3).crossVectors(u,d);k&&(o=k,l=this.getEnvironmentLightMatrix(!0),h=o.light,c=o.dirLight,h.target.position.copy(r.center),h.target.updateMatrixWorld(),h.position=(new e.Vector3).copy(c).multiplyScalar(2*r.radius).add(r.center),null!==l&&h.position.applyMatrix4(l),h.updateMatrix(),h.updateMatrixWorld())},this.removeLights=function(){for(var e=0;e<N.length;e++){for(let t=0;t<G.length;t++)G[t].removeLightNode(N[e]);N[e].dispose()}this.removeIBLLight();for(let e=0;e<G.length;e++)G[e].scene&&(G[e].scene.ambienceLightState=-1);G=[],U=0},this.loadImageFrom3dx=function(i,r,n){if(this.removeIBLLight(),l.images){var s=0,a=0;l.images.background&&s++,l.images.environmentLight&&s++;var o=this,h=function(){++a==s&&(R=!1,O=!1,de=!0,r&&r({ambiance:o}))};if(l.images.background&&(R=!0,M.loadImage({image:l.images.background.data,format:l.images.background.format,doneCallback:h})),l.images.environmentLight){if("hdr"==l.images.environmentLight.format)c=n?function(){o.needUpdateIBL=new Set,h()}:function(){o.needUpdateIBL=new Set;var t=o.getEnvironmentLight().getImage().getTexture();if(t&&t.image){var i=t.image,r=parseInt(i.width,10),n=parseInt(i.height,10);if(isNaN(r)||isNaN(n)||2*n!=r&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),r<8||n<4){for(var s=new Uint8Array(128),a=0;a<32;a++)s[4*a]=i.data[0],s[4*a+1]=i.data[1],s[4*a+2]=i.data[2],s[4*a+3]=i.data[3];i.height="4",i.width="8",i.data=s;var l=new Uint8Array(256);for(a=0;a<64;a++)l[4*a]=i.data[0],l[4*a+1]=i.data[1],l[4*a+2]=i.data[2],l[4*a+3]=i.data[3];return(x=new e.DataTexture(l,8,8,e.RGBAFormat,void 0,void 0)).hdr=t.hdr,x.sRGB=t.sRGB,x.minFilter=u,x.magFilter=u,x.wrapS=e.RepeatWrapping,x.wrapT=e.RepeatWrapping,x.mapping=t.mapping,void h()}}F=!0,ue(),o.needUpdateIBL=new Set,x=null,h()},O=!0,E.loadImage({cb:c,image:l.images.environmentLight.data,format:l.images.environmentLight.format});else if("dds"==l.images.environmentLight.format){c=n?function(e){var i=null;if(e.isCubeMap&&e.isCubeMap()){if(S){oe||(oe=new t(S.renderer.renderer,S.renderer.renderTargetPool));var r=E.getImage().getTexture();oe.setEnvMap(r,2),oe.execute(),i=oe.getResultRGBE(!0)}}else i=e;E.getImage().setTexture(i),o.needUpdateIBL=new Set,h()}:function(i){var r=null;if(i.isCubeMap&&i.isCubeMap()){if(S){oe||(oe=new t(S.renderer.renderer,S.renderer.renderTargetPool));var n=E.getImage().getTexture();oe.setEnvMap(n,2),oe.execute(),r=oe.getResultRGBE(!0)}}else if((r=i)&&r.mipmaps){var s=r.mipmaps[0],a=parseInt(s.width,10),l=parseInt(s.height,10);if(isNaN(a)||isNaN(l)||2*l!=a&&console.warn("##3DX LOADING## ibl width should be 2x ibl height"),a<8||l<4){var c,d;i.type==e.FloatType?(r.hdr=!0,r.rgbHdr=!0,r.sRGB=!1,c=new Float32Array(128)):c=new Uint8Array(128);for(var p=0;p<32;p++)c[4*p]=s.data[0],c[4*p+1]=s.data[1],c[4*p+2]=s.data[2],c[4*p+3]=s.data[3];s.height="4",s.width="8",s.data=c,d=i.type==e.FloatType?new Float32Array(256):new Uint8Array(256);for(p=0;p<64;p++)d[4*p]=s.data[0],d[4*p+1]=s.data[1],d[4*p+2]=s.data[2],d[4*p+3]=s.data[3];return(x=new e.DataTexture(d,8,8,e.RGBAFormat,void 0,void 0)).hdr=r.hdr,x.sRGB=r.sRGB,x.minFilter=u,x.magFilter=u,x.wrapS=e.RepeatWrapping,x.wrapT=e.RepeatWrapping,x.mapping=r.mapping,E.getImage().setTexture(r),o.needUpdateIBL=new Set,void h()}}E.getImage().setTexture(r),F=!0,ue(),o.needUpdateIBL=new Set,x=null,h()},O=!0,E.loadImage({cb:c,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}else if("png"==l.images.environmentLight.format){var c=function(){x=E.getImage().getTexture(),o.needUpdateIBL=new Set};h();c=function(){var e=E.getImage().getTexture();e.rgbHdr=!0,e.hdr=!0,e.sRGB=!0,F=!0,h(),ue(),o.needUpdateIBL=new Set,x=null};O=!0,E.loadImage({cb:c,image:l.images.environmentLight.data,format:l.images.environmentLight.format})}}else this.needUpdateIBL=new Set,x=d}},this.setRenderTargetSize=function(e,t,i,r){W=0,j=0,X=i,q=r,e&&(W=e),t&&(j=t)},this.isFiniteMode=function(){return C.isActivated()},this.getTransform=function(){return A},this.setTransform=function(e){A=e,w&&(this.updateMatrix(),T.updateFromMatrix(A)),de=!0},this.getEnvironmentLightMatrix=function(e){return e&&w?E.getInverseMatrix():E.getMatrix()},this._getEnvironmentLightMatrix=function(){var t=new e.Matrix4;return t.getInverse(E.getInverseMatrix()),t},this.getGroundOptions=function(){return I},this.setEnvironmentLightMatrix=function(e){E.setMatrix(e),de=!0},this.getBackgroundGeometryEditor=function(){return T},this.getBackgroundGeometry=function(){return C},this.getBackground=function(){return M},this.getGround=function(){return P},this.getEnvironmentLight=function(){return E},this.getBackgroundColor=function(){return re},this.getBackgroundAlpha=function(){return ne},this.setBackgroundAlpha=function(e){ne=e,de=!0},this.setBackgroundColor=function(t){re=new e.Color(t),de=!0},this.updateParameters=function(){de=!0,this.update()},this.update=function(){M.needUpdate&&(pe(),M.needUpdate=!1,M.needUpdateParameters=!1,E.needUpdateParameters=!1),C.needUpdate&&(pe(),C.needUpdate=!1,M.needUpdateParameters=!1,E.needUpdateParameters=!1,C.needUpdateParameters=!1),E.needUpdate&&(E.needUpdate=!1),P.needUpdate&&(P.needUpdate=!1,Ce()),(de||P.needUpdateParameters||M.needUpdateParameters||E.needUpdateParameters||C.needUpdateParameters||T.needUpdateParameters)&&(fe(),M.needUpdateParameters=!1,E.needUpdateParameters=!1,P.needUpdateParameters=!1,C.needUpdateParameters=!1,T.needUpdateParameters=!1,de=!1)};var pe=function(){if(M.isActivated())switch(M.getType()){case"gradient":case"gradient3":case"gradientWithHorizon":be();break;case"cubemap":C.isActivated()?"sphere"==C.getType()&&we():Ee();break;case"latlong":C.isActivated()?"sphere"==C.getType()&&we():Pe();break;case"transition":case"transitionCube":Me();break;case"backplate":Te();break;default:return!1}te&&(te.side=e.DoubleSide,te.depthTest=!1,te.force=!0,te.forceSide=!0,ie=!0),fe()},fe=function(){if(te&&M.isActivated()){if(M.withImage()){var e=M.getImage();e.getTexture()&&(te.tEnvMap=e.getTexture(),te.tEnvMap.envMapExposure&&(te.tEnvMap.envMapExposure=M.getIntensity()),te.envMapExposure=M.getIntensity(),te.setUseHDR("hdr"==e.getFormat()),te.setUseSRGB(e.isSRGB()),te.setUseHDRFloat(e.isTextureHDRFloat()))}C.isActivated()?"gradient"==M.getType()||"gradientWithHorizon"==M.getType()||"gradient3"==M.getType()?me("gradientWithHorizon"==M.getType()):"backplate"==M.getType()?ve():"transition"==M.getType()||"transitionCube"==M.getType()?xe():Se():("latlong"==M.getType()&&ye(),"cubemap"==M.getType()&&_e(),"backplate"==M.getType()&&ve(),"gradient"!=M.getType()&&"gradientWithHorizon"!=M.getType()&&"gradient3"!=M.getType()||me("gradientWithHorizon"==M.getType()))}if(E.isActivated()){var t=E.getImage().getTexture();t&&(t.envMapExposureSpecular=E.getIntensity(),t.envMapExposureDiffuse=E.getDiffuseIntensity())}P.isActivated()&&ge()},ge=function(){if(P.getReflectivity()>0){var e=function(){if(S&&S.renderer&&S.renderer.mirrorBlendPass)return S.renderer.mirrorBlendPass}();e&&e.material.setUniform("reflectivity",P.getReflectivity())}},me=function(e){te.colors=[];var t=te.colors,i=M.getColors();te.YUp=z?1:0,te.ratio=M.getRatio();for(var r=0;r<i.length;r++){var n=i[r];t.push(n.r),t.push(n.g),t.push(n.b)}e&&(te.horizonHeight=M.getHorizonHeight())},ve=function(){M.getImage().getTexture();te.backgroundColor.set(re),te.backgroundAlpha=ne,Ie()},_e=function(){M.getImage().getTexture()&&(te.ambienceMatrix=w?D:A)},ye=function(){var t=M.getImage().getTexture();t&&(t.minFilter=e.LinearFilter,te.ambienceMatrix=w?D:A,P.isPhysical()?(te.planeColor=P.getPlaneColor(),te.withPlane=1):te.withPlane=0)},Se=function(){var t=M.getImage().getTexture();if(te.side=se?e.BackSide:e.DoubleSide,t){t.minFilter=e.LinearFilter,te.tEnvMap=t,w?(te.ambienceMatrix=D,te.groundHeight=C.getWorldShootPosition(A)):(te.ambienceMatrix=A,te.groundHeight=C.getShootPosition()),te.groundPosition=T.getGroundPosition(),te.groundNormal=T.getGroundNormal(),te.groundOffset=P.getHeight(),te.sceneHeight=T.getSceneHeight(),te.groundRadius=C.getSize(),te.groundScale=T.getGroundScale(),te.withGround=T.isWithGround(),te.projectionConic=!se;var i="cubemap"==M.getType()||"transitionCube"==M.getType();te.setUseLatLongMap(!i)}},xe=function(){var t=M.getImage().getTexture();if(te.side=e.DoubleSide,t){t.minFilter=e.LinearFilter,te.tEnvMap=t,te.ambienceMatrix=D,te.groundPosition=T.getGroundPosition(),te.groundPositionLowPart=new e.Vector3(e.SplitFloat32(te.groundPosition.x).low,e.SplitFloat32(te.groundPosition.y).low,e.SplitFloat32(te.groundPosition.z).low),te.groundRadius=C.getSize(),te.groundScale=T.getGroundScale();var i="cubemap"==M.getType()||"transitionCube"==M.getType();te.setUseLatLongMap(!i)}var r=M.getTransitionInfos();te.transitionCoef=r.transition;var n=r.image.getTexture();n&&(n.minFilter=e.LinearFilter,te.tEnvMap2=n,te.groundPosition2.set(r.ambienceMatrix.elements[12],r.ambienceMatrix.elements[13],r.ambienceMatrix.elements[14]),te.groundPosition2LowPart=r.ambienceMatrix.getLowPartTranslation(),te.ambienceMatrix2=r.inverseMatrix,te.groundRadius2=r.radius,te.groundScale2=T.getGroundScale())},be=function(){var t;switch(M.getType()){case"gradient":t=e.GradientBackgroundMaterial2;break;case"gradient3":t=e.GradientBackgroundMaterial3;break;case"gradientWithHorizon":t=e.GradientBackgroundMaterial4;break;default:return!1}te=new t(null)},we=function(){var t=M.getImage(),i={useLatLongMap:"latlong"==M.getType()||"transition"==M.getType(),useAmbianceV2:!!w,useHDR:"hdr"==t.getFormat(),useSRGB:t.isSRGB()};te=new e.FiniteEnvMapMaterial(i)},Me=function(){te=new e.FiniteTransitionEnvMapMaterial(null)},Ce=function(){S&&(P.isActivated()&&P.getReflectivity()>0?S.setMirror(!0,void 0,null,P.getReflectivity(),P.getGlossiness()):S.setMirror(!1),P.isActivated()&&P.getShadowIntensity()>0?(S.setShadowPlane(!0),P.disableDefaultGroundShadow?S.setGroundShadow(!1):S.setGroundShadow(!0)):S.setGroundShadow(!1))},Pe=function(){var t=M.getImage(),i={useHDR:"hdr"==t.getFormat(),useHDRFloat:t.isTextureHDRFloat(),useSRGB:t.isSRGB()};te=new e.LatLongMapMaterial(i)},Ee=function(){te=new e.CubeMapMaterial},Te=function(){var t=M.getImage(),i={useHDR:"hdr"==t.getFormat(),useHDRFloat:t.isTextureHDRFloat(),useSRGB:t.isSRGB()};te=new e.SimpleMapMaterial(i),Ie()},Ae=function(i){var r;if(i.url){var n=i.onMapsLoaded,s=null;if(i.onlyOnRequest&&i.fallbackColor&&(n=null,s=function(t){r=function(t){var i=4;t[0]&&(i=8);for(var r=new Uint8Array(8*i*4),n=0;n<8*i;n++)r[4*n]=t[1],r[4*n+1]=t[2],r[4*n+2]=t[3],r[4*n+3]=t[4];var s=new e.DataTexture(r,8,i,e.RGBAFormat);return s.needsUpdate=!0,s.hdr=!0,s.sRGB=!1,s.minFilter=u,s.magFilter=u,s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping,s.loadEndStatus=e.AssetLoadingStatus.READY,s}(i.fallbackColor),i.fallbackColor[0]?p.setIblMap({texture:r}):p.setRoughnessMap({texture:r})}),i.url instanceof Array)r=e.ImageUtils.loadTextureCube(i.url,i.mapping,i.onMapsLoaded);else if(i.hdr)r=e.ImageUtils.loadHDRTexture(i.url,i.mapping,n,null,null,!1,!1,e.ImageUtils.crossOriginPolicy,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r);else{var a=i.url.split("."),o=(a[a.length-2],a[a.length-1]);"hdr"==(o=o.toLowerCase())||i.hdr?(r=e.ImageUtils.loadHDRTexture(i.url,i.mapping),i.hdr=!0,r.onLoadCallbacks.push(i.onMapsLoaded)):"dds"==o||i.dds?r=e.ImageUtils.loadCompressedTexture(i.url,new e.LatLongReflectionMapping,function(){S&&(oe||(oe=new t(S.renderer.renderer,S.renderer.renderTargetPool)),oe.setEnvMap(r,2),oe.execute(),r=oe.getResultRGBE(!0),i.onMapsLoaded(r))}):(r=new e.ImageUtils.loadTexture(i.url,i.mapping,n,s,e.ImageUtils.crossOriginPolicy,!1,i.onlyOnRequest),i.onlyOnRequest&&i.onMapsLoaded(r))}}return r},De=function(t,i,r){var n=M.getImage();n.setTexture(t);var s=r?"hdr":"png";n.setFormat(s);var a,o,l=t,h=!!r;i instanceof e.SimpleEnvMapping?(a="backplate",o="simple"):i instanceof e.SimpleEnvMappingCustom?(a="backplate",o="custom"):i instanceof e.SimpleEnvMappingFit?(a="backplate",o="fit"):i instanceof e.SimpleEnvMappingPreserveRatio?(a="backplate",o="bestFit"):i instanceof e.SimpleEnvMappingFitWidth?(a="backplate",o="fitWidth"):i instanceof e.SimpleEnvMappingFitHeight?(a="backplate",o="fitHeight"):i instanceof e.LatLongEnvMapping?a="latlong":i instanceof e.CubeEnvMapping&&(a="cubemap"),h&&(l.minFilter=u,l.magFilter=u,l.wrapS=e.RepeatWrapping,l.wrapT=e.RepeatWrapping),a!=M.getType()||!te||"backplate"==M.getType()&&M.getSizeScaling()!=o?(M.setType(a),o&&M.setSizeScaling(o),pe()):de=!0},Ie=function(e){var t=M.getImage().getTexture();if("backplate"==M.getType()&&t){var i=2048,r=1024;t.image?(i=t.image.width,r=t.image.height):t.width&&t.height&&(i=t.width,r=t.height);var n=i/r,s=le,a=he;W&&j&&(s=W,a=j),e&&(i*=2,r*=2,s*=2,a*=2);var o,l=(s*=M.getBackplateScale())/(a*=M.getBackplateScale()),h=X,c=q;if($)if(s=$,a=K,h=-Z,c=-(K-Q-Y),W&&j&&(s=W,a=j,h=X,c=q),l=s/a,"custom"==M.getSizeScaling())(o=M.getBackplateCB())&&o({textureWidth:i,textureHeight:r,viewportWidth:s,viewportHeight:a,devicePixelRatio:ce});else if("simple"==M.getSizeScaling())i=s,r=a,te.offset.set(ce*(h+ee.x*i),ce*(c-ee.y*r-(J.y-1)*r)),te.invSize.set(1/(ce*i*J.x),1/(ce*r*J.y));else if("fitHeight"==M.getSizeScaling()){i=a*n,r=a,h+=.5*(s-(d=(u=a*J.y)/n)),te.offset.set(ce*h,ce*(c-ee.y*r-(J.y-1)*r)),te.invSize.set(1/(ce*u),1/(ce*u))}else if("fitWidth"==M.getSizeScaling()){i=s,r=s/n,c+=.5*(a-(u=(d=s*J.x)/n)),te.offset.set(ce*(h+ee.x*i),ce*c),te.invSize.set(1/(ce*d),1/(ce*u))}else if("bestFit"==M.getSizeScaling()){if(n>l){i=(r=a)*n;var d=(u=r*J.y)/n}else{r=(i=s)/n;var u=(d=i*J.x)/n}te.offset.set(ce*(h+ee.x*i),ce*(c-ee.y*r-(J.y-1)*r)),te.invSize.set(1/(ce*i*J.x),1/(ce*u))}else"fit"==M.getSizeScaling()&&(n>l?(i=s,c+=.5*(a-(r=s/n))):(r=a,h+=.5*(s-(i=a*n))),te.offset.set(ce*(h+ee.x*i),ce*(c-ee.y*r-(J.y-1)*r)),te.invSize.set(1/(ce*i*J.x),1/(ce*r*J.y)));else if("custom"==M.getSizeScaling())(o=M.getBackplateCB())&&o({textureWidth:i,textureHeight:r,viewportWidth:s,viewportHeight:a,devicePixelRatio:ce});else"simple"==M.getSizeScaling()?(i=s,r=a,te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"fitHeight"==M.getSizeScaling()?(i=a*n,r=a,h=.5*(le*M.getBackplateScale()-i),te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"fitWidth"==M.getSizeScaling()?(i=s,r=s/n,c=.5*(he*M.getBackplateScale()-r),te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"bestFit"==M.getSizeScaling()?(n>l?i=(r=a)*n:r=(i=s)/n,te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r))):"fit"==M.getSizeScaling()&&(n>l?(i=s,c+=.5*(a-(r=s/n))):(r=a,h+=.5*(s-(i=a*n))),te.offset.set(ce*h,ce*c),te.invSize.set(1/(ce*i),1/(ce*r)))}};this.getIblMap=function(){if(E.isActivated()){var t=E.getImage().getTexture();if(t&&(t.loadEndStatus==e.AssetLoadingStatus.READY||t.loadEndStatus==e.AssetLoadingStatus.PAUSED||null==t.loadEndStatus))return t}return null},this.getRoughnessMap=function(){return E.isActivated()?x:null},this.getRadiusEnvMap=function(){return C.getSize()*T.getGroundScale()*2},this.getCenter=function(){var e,t;return w?((e=T.getSceneHeight().clone()).multiplyScalar(C.getSize()),e.add(T.getGroundPosition())):((e=T.getGroundNormal().clone().multiply(T.getSceneHeight())).multiplyScalar(C.getSize()),t=T.getGroundPosition().clone().applyMatrix4(A),e.add(t)),e},this.getRadius=function(){return C.getSize()*T.getGroundScale()},this.getProjectionCenter=function(){var e,t;return w?((e=C.getShootPosition().clone()).multiplyScalar(C.getSize()),e.add(T.getGroundPosition())):((e=T.getGroundNormal().clone().multiply(C.getShootPosition())).multiplyScalar(C.getSize()),t=T.getGroundPosition().clone().applyMatrix4(A),e.add(t),e.z+=P.getHeight()),e},this.updateCamera=function(t,i,r){if(t.camera&&this.setCameraOrtho(t.camera.isOrtho),te&&"latlong"==M.getType()){if(r.fullWidth)te.invScreenSize.x=1/r.width,te.invScreenSize.y=1/r.height,te.startOffset.x=r.x/r.fullWidth,te.endOffset.y=1-r.y/r.fullHeight,te.endOffset.x=(r.x+r.width)/r.fullWidth,te.startOffset.y=1-(r.y+r.height)/r.fullHeight;else{var n=i.renderer.getViewportSize();te.invScreenSize.x=1/n.width,te.invScreenSize.y=1/n.height,te.startOffset.x=0,te.startOffset.y=0,te.endOffset.x=1,te.endOffset.y=1}if(t.camera.isOrtho&&this.isFiniteMode()){var s=Math.tan(.5*e.Math.degToRad(t.camera.fov)),a=t.getSightDirection().normalize(),o=t.camera.up.normalize();te.cameraRight.crossVectors(t.getSightDirection(),t.camera.up).normalize(),te.cameraSight.copy(a),te.cameraUp.copy(o),te.invScreenSize.x=1/i.deviceWidth,te.invScreenSize.y=1/i.deviceHeight,te.near=t.camera.near,te.right=t.camera.right,te.up=t.camera.top}else{s=Math.tan(.5*e.Math.degToRad(t.camera.fov));te.cameraSight.copy(t.getSightDirection()),te.cameraUp.copy(t.camera.up).multiplyScalar(s),te.cameraRight.crossVectors(t.getSightDirection(),t.camera.up),te.cameraRight.multiplyScalar(t.camera.aspect*s),te.invScreenSize.x=1/i.deviceWidth,te.invScreenSize.y=1/i.deviceHeight}}if(te&&"backplate"==M.getType()){var l="SSAA"==i.antiAliasing;r.fullWidth?(Z=r.x,Y=r.y,r.width,Q=r.height,K=r.fullHeight,$=r.fullWidth,Ie(l)):(Z=0,Y=0,0,Q=0,K=0,$=0,Ie(l))}},this.resize=function(e,t,i,r){if(le=e,he=t,ce=i,"backplate"==M.getType()){var n="SSAA"==r.antiAliasing;Ie(n)}},this.getSphere=function(){return(e=i.createSphereNode({radius:1,sag:64,material:te})._occurrences[0].renderable).frustumCulled=!1,e.renderDepth=2,e.visible=!0,e.visibilityFree=!0,e;var e};this.getGroundGeometry=function(){return(t=i.createRectangleNode({width:1,noEdge:!0,height:1,cornerPoint:new e.Vector2(-.5,-.5),fill:!0,material:P.getMaterial()?P.getMaterial():new e.PhysicalMaterial})._occurrences[0].renderable).frustumCulled=!1,t.renderDepth=2,t.visible=!0,t.visibilityFree=!0,t;var t},this.updateSphere=function(e,t,i){var r,n;ae||(r=t,n=e,i.position.set(r.x,r.y,r.z),i.scale.set(n,n,n),i.updateMatrix(),te&&(i.material=te),i.visible=!0,ie&&(i._flagAsGSSOInvalidated(),ie=!1))},this.setNearValue=function(e){te&&(te.near=e)},this.updateGround=function(e){if(!ae){var t=5*this.getBackgroundGeometry().getSize(),i=this.getCenter();e.position.set(i.x,i.y,i.z),e.scale.set(t,t,t),e.rotation.x=z?-Math.PI/2:0,e.updateMatrix(),P.getMaterial()&&(e.material=P.getMaterial()),e.visible=!0}},this._removePhysicalGround=function(){P.setMaterial(null),P.setType("transparent")},this.setIblMap=function(t){var i=this,r=null;if(this.removeIBLLight(),t.mapping||(t.mapping=new e.LatLongReflectionMapping),t.onMapsLoaded=function(r){t.pngHdr&&(r.sRGB=!1,r.hdr=!0);var n=r;if(E.getImage().setTexture(n),E.setActivated(!0),n.minFilter=u,n.magFilter=u,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),(t.generateRougnessMap||t.generateRoughnessMap)&&S){O=!1;for(var s=0;s<V.length;s++)V[s].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});V=[],F=!0,t.doneCallback&&t.doneCallback(),ue(),i.needUpdateIBL=new Set,x=null}if(t.doneCallback&&(!t.generateRougnessMap||!t.generateRoughnessMap)){O=!1;for(s=0;s<V.length;s++)V[s].setIblMap({texture:n,mapping:t.mapping,hdr:t.hdr});V=[],t.doneCallback()}de=!0,i.needUpdateIBL=new Set},t.url)O=!0,r=Ae(t);else if(t.texture&&t.texture instanceof e.Texture)O=!0,(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded);else if(t.texture&&t.texture instanceof e.WebGLRenderTarget){var n=t.texture;E.getImage().setTexture(n),E.setActivated(!0),n.minFilter=u,n.magFilter=u,n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,t.mapping&&(n.mapping=t.mapping),t.hdr&&(n.hdr=t.hdr),t.generateRougnessMap&&S&&(F=!0,t.doneCallback&&t.doneCallback(n),i.needUpdateIBL=new Set,x=null,ue())}},this.setReflectionMap=function(i){var n=this,s=null,a=i.url,o=d;if(i.onMapsLoaded=function(){var t=s;E.getImage().setTexture(t),E.setActivated(!0),x=o,t.minFilter=x.minFilter=u,t.magFilter=x.magFilter=u,t.wrapS=x.wrapS=e.RepeatWrapping,t.wrapT=x.wrapT=e.RepeatWrapping,i.doneCallback&&i.doneCallback(),n.needUpdateIBL=new Set},"dds"===r.getExtension(a))var l=e.ImageUtils.loadCompressedTexture(a,new e.LatLongReflectionMapping,function(){S&&(oe||(oe=new t(S.renderer.renderer,S.renderer.renderTargetPool)),oe.setEnvMap(l,2),oe.execute(),o=null,s=oe.getResultRGBE(!0),i.onMapsLoaded())})},this.setRoughnessMap=function(t){var i=this,r=d;t.onMapsLoaded=function(n){x=n||r,t.pngHdr&&(x.sRGB=!1,x.hdr=!0),t.hasDiffuse&&(x.hasDiffuse=!0),x.minFilter=u,x.magFilter=u,x.wrapS=e.RepeatWrapping,x.wrapT=e.RepeatWrapping,t.mapping&&(x.mapping=t.mapping),t.hdr&&(x.hdr=t.hdr),t.doneCallback&&t.doneCallback(),i.needUpdateIBL=new Set},t.url?r=Ae(t):t.texture&&t.texture instanceof e.Texture?(r=t.texture).loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded(r):r.onLoadCallbacks.push(t.onMapsLoaded):t.texture&&t.texture instanceof e.WebGLRenderTarget&&(r=t.texture,t.onMapsLoaded(r))},this.setBackplateMap=function(t){var i=null,r=this;t.onMapsLoaded=function(){r.setFiniteMode(!1),De(i,t.mapping,t.hdr),t.doneCallback&&t.doneCallback()},t.url?i=Ae(t):t.texture&&t.texture instanceof e.Texture&&(i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded))},this.generateIBLFromColor=function(t){for(var i=new Uint8Array(128),r=0;r<32;r++)i[4*r]=t[0],i[4*r+1]=t[1],i[4*r+2]=t[2],i[4*r+3]=t[3];var n=new e.DataTexture(i,8,4,e.RGBAFormat,void 0,void 0);n.hdr=!0,n.sRGB=!1,n.mapping=new e.LatLongReflectionMapping,n.needsUpdate=!0;var s=new Uint8Array(256);for(r=0;r<64;r++)s[4*r]=t[0],s[4*r+1]=t[1],s[4*r+2]=t[2],s[4*r+3]=t[3];(x=new e.DataTexture(s,8,8,e.RGBAFormat,void 0,void 0)).hdr=!0,x.sRGB=!1,x.needsUpdate=!0,x.minFilter=u,x.magFilter=u,x.wrapS=e.RepeatWrapping,x.wrapT=e.RepeatWrapping,x.mapping=new e.LatLongReflectionMapping,E.getImage().setTexture(n),E.setActivated(!0),this.needUpdateIBL=new Set},this.setBackGroundMap=function(t){var i=null;t.onMapsLoaded=function(){t.pngHdr&&(i.sRGB=!1,i.hdr=!0,t.hdr=!0),De(i,t.mapping,t.hdr),R=!1;for(var e=0;e<L.length;e++)L[e].setBackGroundMap({texture:i,mapping:t.mapping,hdr:t.hdr});L=[],t.doneCallback&&t.doneCallback()},t.url?(R=!0,i=Ae(t)):t.texture&&t.texture instanceof e.Texture?(R=!0,i=t.texture,t.mapping||(t.mapping=i.mapping),t.hdr||(t.hdr=i.hdr),i.loadEndStatus===e.AssetLoadingStatus.READY?t.onMapsLoaded():i.onLoadCallbacks.push(t.onMapsLoaded)):t.texture&&t.texture instanceof e.WebGLRenderTarget&&De(t.texture,t.mapping,t.hdr)},this.setExposure=function(e){M.setIntensity(e),E.setIntensity(e)},this.getEnvMapExposure=function(){return M.getIntensity()},this.lockAmbiance=function(e){ae=e},this.setFiniteMode=function(e){C.isActivated()!=e&&C.setActivated(e)},this.setGroundGeometry=function(e){T.setWithGround(e)},this.getGroundPosition=function(){return T.getGroundPosition()},this.setGroundPosition=function(e){T.setGroundPosition(e)},this.setGroundNormal=function(e){console.warn("DEPRECATED: use setTransfrom instead of setGroundNormal"),T.setGroundNormal(e)},this.setSceneHeight=function(e){T.setSceneHeight(e)},this.setGroundHeight=function(e){C.setShootPosition(e)},this.setGroundRadius=function(e){C.setSize(e),S&&S.planeV2&&S.planeGrid&&(S.planeGrid.size=2*e)},this.displayGround=function(e){P.setActivated(e),S&&S.displayInfinitePlane(e)},this.setGroundScale=function(e){T.setGroundScale(e)},this.updateScene=function(e){T.setGroundPosition(e)},this.isAutoGroundOffset=function(){return P.getAutoHeight()},this.setAutoGroundOffset=function(e){P.setAutoHeight(e)},this.setGroundOffset=function(e){P.setHeight(e)},this.setEnvMapBlur=function(e){},this.getOffset=function(){return P.getHeight()},this.setEnvMapOffset=function(e){A.makeRotationZ(e),E.getMatrix().makeRotationZ(e),w&&(E.updateMatrix(),this.updateMatrix()),de=!0},this.setGroundReflectivitiy=function(e){P.setReflectivity(e),P.setActivated(!0)},this.setGroundReflectivity=function(e){P.setReflectivity(e),P.setActivated(!0)},this.setGroundShadowIntensity=function(e){P.setShadowIntensity(e),P.setActivated(!0)},this.isUsedMirror=function(){return P.isActivated()&&"transparent"==P.getType()&&P.getReflectivity()>0},this._setMirror=function(e){(e||"transparent"==P.getType())&&(P.setActivated(e),P.setType("transparent"),P.setReflectivity(.3))},this.getGroundGlossiness=function(){return P.getGlossiness()},this.setCustomBackplateCallback=function(e){M.setType("backplate"),M.setSizeScaling("custom"),M.setBackplateCB(e)},this.setBackplateOffset=function(e,t){te.offset.set(e,t)},this.setBackplateSize=function(e,t){te.invSize.set(e,t)},this.setGroundGlossiness=function(e){P.setGlossiness(e)},this.setTranslation=function(e){A.translate(e),w&&this.updateMatrix()},this.setSkyLighting=function(t,i,r,n){if(S){S.renderer.SkyScatteringEffect?S.renderer.SkyScatteringEffect.setEnabled(!0):S.renderer.initEffect("SkyScattering");var s=this;S.setShadow(!0),this.getGround().disableDefaultGroundShadow=!0,this.setExposure(r),H||((H=new h({color:16777215,intensity:5.5*Math.PI*r})).castShadows(!0,{mapWidth:S.shadowMapWidth,mapHeight:S.shadowMapHeight,bias:-.005}),this.addLightNode(H)),H.setDirection(t),S.renderer.SkyScatteringEffect.setGenerationInput({sunDirection:t,viewAltitude:i}),S.renderer.SkyScatteringEffect.execute(!0,function(t){s.setIblMap({texture:t,hdr:!0,mapping:new e.LatLongReflectionMapping,generateRougnessMap:!0}),s.keepIBLTexture=!0,n&&(s.setBackGroundMap({texture:t,hdr:!0,mapping:new e.LatLongEnvMapping}),s.keepBackgroundTexture=!0)})}},this.setTransitionBackground=function(t,i,r){this.setFiniteMode(!0),this.setAutoGroundOffset(!1),t.radius&&C.setSize(t.radius),this.setTransform(t.matrix),(h=M.getImage()).setTexture(t.map);var n=t.hdr?"hdr":"png";h.setFormat(n);var s=t.map,a=!!t.hdr,o=s.isCubeMap()?"transitionCube":"transition";a&&(s.minFilter=u,s.magFilter=u,s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping);var l=M.getTransitionInfos();if(i&&i.map&&i.map.loadEndStatus===e.AssetLoadingStatus.READY){var h;(h=l.image).setTexture(i.map);n=i.hdr?"hdr":"png";h.setFormat(n);s=i.map;(a=!!i.hdr)&&(s.minFilter=u,s.magFilter=u,s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping),l.ambienceMatrix=i.matrix,l.radius=i.radius,l.transition=r}else l.transition=0;M.setTransitionInfos(l),o==M.getType()&&te?de=!0:(M.setType(o),pe())},this.dispose=function(){x&&x!==d&&x.dispose(),this.getIblMap()&&!this.keepIBLTexture&&this.getIblMap().dispose();var e=M.getImage().getTexture();e&&!this.keepBackgroundTexture&&e.dispose(),M.setActivated(!1),E.setActivated(!1),C.setActivated(!1),te&&te.dispose(),this.needUpdateIBL=new Set,this.removeLights(),s.unsubscribe(this.requestIBLLightExtraction)},this.clone=function(e){e||(e={});var t=void 0!==e.viewer?e.viewer:null,i={viewer:t},r={};r.name=b,r.usePlaneV2=this.usePlaneV2,r.backgroundGeometryEditor=T.stream(),r.transform=A.elements.slice(0),r.background=M.stream(),r.backgroundGeometry=C.stream(),r.environmentLight=E.stream(),r.ground=P.stream(),i.v2=w,i.ambiance=r;var n=new y(i);return n.getGround().setAutoHeight(!0),n.setBackgroundColor(re.getHex()),n.setBackgroundAlpha(ne),t&&t.setBackgroundColor(re.getHex(),ne),R&&L.push(n),O&&V.push(n),x&&n.setRoughnessMap({texture:x}),n},S&&this.setWorldOrientation(S._worldOrientation),this.updateMatrix(),l.ambiance&&this.loadFrom3dx(l.ambiance,l.images,l.from3DX,l.doneCallback,!!l.roughnessMap),pe()};return y}),define("DS/Visualization/LensFlareNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){this._parent(i),this.lensflare3js=void 0!==t?t:new e.ParticleSystem,t=this.createRenderable();var r=this._occurrences[0];return r.renderable=t,r.renderable.name=this.name,r.renderable._occurrence=r,this},createRenderable:function(){var e=this.lensflare3js.clone();return e.matrixAutoUpdate=!1,e.matrixWorldNeedsUpdate=!1,e.visible=this.lensflare3js.visible,e.pickable=!1,e.noPickThrough=!1,e.enableNormalDepth=!1,e},add:function(){return!1},getNodeType:function(){return"LensFlareNode3D"}});return UWA.namespace("THREEDS/Nodes/LensFlare",i)}),define("Visualization/LensFlareNode3D",["DS/Visualization/LensFlareNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/LensFlareNode3D"),e}),define("DS/Visualization/TextNode",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/EditableMesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet","DS/Visualization/MaterialApplication","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],function(e,t,i,r,n,s,a,o){"use strict";var l={};var h={count:97,width:256,height:256,chars:{0:{yoffset:1.5,width:4,xadvance:0,y:238,x:223,height:4,xoffset:-1.5},13:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:250,height:4,xoffset:-1.5},32:{yoffset:1.5,width:4,xadvance:9.25,y:252,x:246,height:4,xoffset:-1.5},33:{yoffset:27.063,width:12,xadvance:9.5,y:0,x:186,height:30,xoffset:-.688},34:{yoffset:27.063,width:15,xadvance:18,y:15,x:210,height:14,xoffset:3},35:{yoffset:26.438,width:24,xadvance:19.5,y:125,x:48,height:28,xoffset:-1.875},36:{yoffset:32.125,width:24,xadvance:19.938,y:65,x:24,height:40,xoffset:-1.625},37:{yoffset:27.938,width:30,xadvance:31.813,y:94,x:48,height:31,xoffset:1.5},38:{yoffset:24.75,width:36,xadvance:33.25,y:38,x:0,height:27,xoffset:-.25},39:{yoffset:27.063,width:8,xadvance:10.875,y:238,x:246,height:14,xoffset:3},40:{yoffset:33,width:16,xadvance:12,y:105,x:24,height:41,xoffset:-.5},41:{yoffset:33,width:16,xadvance:12,y:211,x:48,height:41,xoffset:-2.188},42:{yoffset:28.938,width:19,xadvance:16.375,y:238,x:227,height:18,xoffset:.438},43:{yoffset:20.688,width:19,xadvance:18.875,y:237,x:135,height:19,xoffset:.25},44:{yoffset:6.938,width:11,xadvance:9.5,y:15,x:225,height:15,xoffset:-2.25},45:{yoffset:14.938,width:15,xadvance:15.063,y:247,x:181,height:7,xoffset:.25},46:{yoffset:6.938,width:10,xadvance:9.5,y:243,x:92,height:10,xoffset:-.875},47:{yoffset:31.875,width:22,xadvance:19.25,y:94,x:135,height:38,xoffset:-1},48:{yoffset:26.875,width:22,xadvance:21.25,y:65,x:81,height:29,xoffset:.188},49:{yoffset:26.375,width:16,xadvance:15.75,y:0,x:74,height:28,xoffset:0},50:{yoffset:26.875,width:21,xadvance:19,y:65,x:190,height:29,xoffset:-1.438},51:{yoffset:26.813,width:22,xadvance:18.938,y:65,x:147,height:29,xoffset:-2.188},52:{yoffset:27.063,width:22,xadvance:20.188,y:65,x:125,height:29,xoffset:-.938},53:{yoffset:26.375,width:23,xadvance:19.688,y:182,x:48,height:29,xoffset:-1.688},54:{yoffset:26.813,width:21,xadvance:20.375,y:65,x:211,height:29,xoffset:.125},55:{yoffset:26.438,width:20,xadvance:16.875,y:65,x:232,height:29,xoffset:.188},56:{yoffset:26.813,width:22,xadvance:21.125,y:65,x:103,height:29,xoffset:-.688},57:{yoffset:26.813,width:21,xadvance:20.375,y:222,x:24,height:30,xoffset:.438},58:{yoffset:20.188,width:11,xadvance:9.5,y:185,x:243,height:23,xoffset:-.875},59:{yoffset:20.25,width:13,xadvance:9.5,y:0,x:173,height:29,xoffset:-2.25},60:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:121,height:21,xoffset:.25},61:{yoffset:18.75,width:20,xadvance:18.875,y:0,x:210,height:15,xoffset:.688},62:{yoffset:22.563,width:20,xadvance:18.875,y:0,x:141,height:21,xoffset:-.563},63:{yoffset:27.625,width:19,xadvance:18.625,y:185,x:0,height:30,xoffset:.938},64:{yoffset:27.625,width:38,xadvance:37.75,y:0,x:0,height:38,xoffset:.188},65:{yoffset:27.125,width:26,xadvance:21.563,y:209,x:201,height:29,xoffset:-3.125},66:{yoffset:27.063,width:23,xadvance:22.875,y:123,x:233,height:29,xoffset:.188},67:{yoffset:27.625,width:24,xadvance:21.063,y:187,x:109,height:30,xoffset:.25},68:{yoffset:27.063,width:25,xadvance:24.188,y:123,x:183,height:29,xoffset:.188},69:{yoffset:27.063,width:22,xadvance:19.5,y:94,x:234,height:29,xoffset:.188},70:{yoffset:27.063,width:21,xadvance:18.188,y:65,x:169,height:29,xoffset:.188},71:{yoffset:27.625,width:25,xadvance:23.625,y:153,x:230,height:30,xoffset:.25},72:{yoffset:27.063,width:25,xadvance:24.625,y:94,x:184,height:29,xoffset:.188},73:{yoffset:27.063,width:12,xadvance:10.813,y:0,x:198,height:29,xoffset:.188},74:{yoffset:27.063,width:16,xadvance:11,y:215,x:0,height:35,xoffset:-3.75},75:{yoffset:27.063,width:26,xadvance:22.438,y:209,x:227,height:29,xoffset:.188},76:{yoffset:27.063,width:19,xadvance:18.563,y:0,x:38,height:29,xoffset:.188},77:{yoffset:27.063,width:31,xadvance:29.188,y:94,x:78,height:29,xoffset:-1.25},78:{yoffset:27.063,width:25,xadvance:24.75,y:123,x:208,height:29,xoffset:.188},79:{yoffset:27.625,width:26,xadvance:25.5,y:123,x:157,height:30,xoffset:.25},80:{yoffset:27.125,width:24,xadvance:21.875,y:123,x:78,height:29,xoffset:.188},81:{yoffset:27.625,width:26,xadvance:25.5,y:94,x:109,height:34,xoffset:.25},82:{yoffset:27.125,width:24,xadvance:22.375,y:217,x:109,height:29,xoffset:.188},83:{yoffset:27.625,width:24,xadvance:20.313,y:157,x:109,height:30,xoffset:-1.75},84:{yoffset:27.063,width:23,xadvance:19.375,y:153,x:48,height:29,xoffset:.125},85:{yoffset:27.063,width:25,xadvance:24.25,y:153,x:205,height:30,xoffset:.75},86:{yoffset:27.063,width:25,xadvance:21.625,y:94,x:209,height:29,xoffset:.438},87:{yoffset:27.125,width:33,xadvance:30.875,y:65,x:48,height:29,xoffset:.813},88:{yoffset:27.063,width:27,xadvance:21.063,y:94,x:157,height:29,xoffset:-3},89:{yoffset:27.063,width:25,xadvance:21,y:128,x:109,height:29,xoffset:.125},90:{yoffset:27.063,width:24,xadvance:19.438,y:152,x:78,height:29,xoffset:-2.125},91:{yoffset:31.813,width:17,xadvance:12,y:146,x:24,height:38,xoffset:-1.625},92:{yoffset:31.875,width:20,xadvance:19.375,y:209,x:181,height:38,xoffset:-.438},93:{yoffset:31.875,width:17,xadvance:12,y:184,x:24,height:38,xoffset:-1.938},94:{yoffset:32.688,width:22,xadvance:19.875,y:238,x:201,height:15,xoffset:.5},95:{yoffset:-.563,width:22,xadvance:19.25,y:248,x:157,height:7,xoffset:-3.313},96:{yoffset:31.875,width:14,xadvance:12.125,y:243,x:78,height:11,xoffset:-.438},97:{yoffset:21.625,width:22,xadvance:21.375,y:38,x:60,height:24,xoffset:-.375},98:{yoffset:29.438,width:22,xadvance:21.75,y:132,x:135,height:32,xoffset:-.125},99:{yoffset:21.625,width:20,xadvance:17.25,y:38,x:211,height:24,xoffset:-.375},100:{yoffset:29.438,width:24,xadvance:21.688,y:153,x:181,height:32,xoffset:-.375},101:{yoffset:21.625,width:21,xadvance:19.25,y:38,x:169,height:24,xoffset:-.375},102:{yoffset:29.5,width:24,xadvance:12.375,y:65,x:0,height:40,xoffset:-4.188},103:{yoffset:21.688,width:23,xadvance:21.625,y:216,x:157,height:32,xoffset:-1.125},104:{yoffset:29.438,width:22,xadvance:21.25,y:212,x:78,height:31,xoffset:-.25},105:{yoffset:30.938,width:13,xadvance:10,y:0,x:108,height:33,xoffset:-.375},106:{yoffset:30.938,width:17,xadvance:10,y:196,x:135,height:41,xoffset:-4.938},107:{yoffset:29.438,width:22,xadvance:20.813,y:181,x:78,height:31,xoffset:-.25},108:{yoffset:29.438,width:12,xadvance:10.438,y:0,x:161,height:32,xoffset:0},109:{yoffset:21.625,width:32,xadvance:31.375,y:185,x:181,height:24,xoffset:-.25},110:{yoffset:21.625,width:22,xadvance:21.25,y:38,x:104,height:24,xoffset:-.25},111:{yoffset:21.625,width:22,xadvance:21.313,y:38,x:82,height:24,xoffset:-.375},112:{yoffset:21.625,width:24,xadvance:21.75,y:153,x:157,height:32,xoffset:-1.375},113:{yoffset:21.625,width:22,xadvance:21.563,y:164,x:135,height:32,xoffset:-.375},114:{yoffset:21.625,width:18,xadvance:14.313,y:0,x:90,height:24,xoffset:-.25},115:{yoffset:21.563,width:20,xadvance:17.563,y:38,x:231,height:24,xoffset:-1.938},116:{yoffset:26,width:17,xadvance:13.75,y:0,x:57,height:29,xoffset:-.563},117:{yoffset:21.063,width:21,xadvance:21.063,y:38,x:148,height:24,xoffset:.313},118:{yoffset:21.125,width:22,xadvance:18.375,y:38,x:126,height:23,xoffset:-.375},119:{yoffset:21.125,width:30,xadvance:27.125,y:185,x:213,height:23,xoffset:0},120:{yoffset:21.063,width:24,xadvance:18,y:38,x:36,height:23,xoffset:-3.438},121:{yoffset:21.125,width:24,xadvance:18.313,y:185,x:157,height:31,xoffset:-2.25},122:{yoffset:21.063,width:21,xadvance:16.375,y:38,x:190,height:23,xoffset:-2.5},123:{yoffset:32.438,width:16,xadvance:12,y:145,x:0,height:40,xoffset:-.813},124:{yoffset:31.375,width:12,xadvance:14.375,y:211,x:64,height:37,xoffset:1.688},125:{yoffset:32.438,width:16,xadvance:12,y:105,x:0,height:40,xoffset:-2.313},126:{yoffset:16.125,width:21,xadvance:18.875,y:246,x:109,height:9,xoffset:-.438}},base:41},c=t.getWebappsAssetUrl("Visualization",""),d=new e.ImageUtils.loadTexture(c+"fonts/default.png",void 0,null,null,!0);d.flipY=!0,d.anisotropy=16;const u=(e,t,i)=>o.FunctionHandler.callFunction(e,t,i);var p=new e.Vector3,f=i.extend({init:function(t,i,r){this.lineHeight=1,this.nbChars=0,this.textArray={},this._paramsLocked=!!r,this.billboard=!(!r||void 0===r.billboard)&&!!r.billboard,this.billboardAxis=!(!r||void 0===r.billboardAxis)&&!!r.billboardAxis,this.fixedSize=!(!r||void 0===r.fixedSize)&&!!r.fixedSize,this.viewSpace=!(!r||void 0===r.viewSpace)&&!!r.viewSpace,this.projectionSpace=!(!r||void 0===r.projectionSpace)&&!!r.projectionSpace,this.textMaterial=null,this.textGas=new s({colorRGB:new e.Color(0),side:e.FrontSide}),this._initMaterialPDSFX(this._paramsLocked),this._setFont();var n=new e.Mesh(void 0,null);return this._token=0,this.mesh3js=null,this._parent(n,t),this.mesh3js=this._occurrences[0].renderable,this._reallocate(r&&r.allocSize?r.allocSize:512),this.setFrustumCulled(!0),this.matInherit=window.newMaterialInheritance,this.matInherit?(this.matApp=new a({faceMaterial:this.textMaterial,layer:0}),this.textMaterial.useGASColor=!0,this.setMaterialApplication(this.matApp)):this.setMaterial(this.textMaterial),this.setMaterialMode(!0),this},clone:function(){var t=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);return new f(t,this.name)},getNodeType:function(){return"Mesh3D"},setBillboard:function(e,t){this._paramsLocked||this.billboard===e&&this.billboardAxis===t||(this.billboard=e,this.billboardAxis=t,this._updateDefines())},setFixedSize:function(e){this._paramsLocked||this.fixedSize!==e&&(this.fixedSize=e,e&&(this.billboard=!0),this._updateDefines())},_setViewSpace:function(e){this._paramsLocked||this.viewSpace!==e&&(this.viewSpace=e,this.projectionSpace=!e,this._updateDefines())},_setProjectionSpace:function(e){this._paramsLocked||this.projectionSpace!==e&&(this.projectionSpace=e,this.viewSpace=!e,this._updateDefines())},_updateDefines:function(){var e={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=e,this.textMaterial.updateDeferredMaterials(),this.textMaterial.needsUpdate=!0},getBillboard:function(){return this.billboard},addText:function(e){var t=e.string.length;if(0==t)return-1;var i=this._addText(e);if(i){e.primitive=i;var r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}var n=this._reallocate(t),s=this._occurrences[0].renderable;if(i=this._addText(e,null!==n?s.layer.layers[n]:null,n)){e.primitive=i;r=i.getCgmId();return this.textArray[r]=e,this.nbChars+=t,r}return-1},removeText:function(e){var t=this.textArray[e];t&&(this.hide([n.getFromSGNode(t.primitive)]),this.nbChars-=t.string.length,delete this.textArray[e])},_setFont:function(){this.textMaterial&&this.textMaterial.updatePDSFXUniform("fontMap",d)},_reallocate:function(t){var i=this._occurrences[0].renderable,n=4*t,s=i.geometry.length,a=s?i.geometry[s-1]:null,o=a?a.vertexPositionArray.length/3:0,l=!s||65536===o,h=l?e.ImageUtils.nearest_greater_pow2(n):e.ImageUtils.nearest_greater_pow2(o+n),c=new e.BufferGeometryDS;c.editable=!0,c.vertexIndexArray=new Uint16Array(6*h/4),c.vertexPositionArray=new Float32Array(3*h),c.vertexColorArray=new Float32Array(4*h),c.vertexNormalArray=new Float32Array(3*h),c.vertexUvArray=new Float32Array(3*h),c.vertexUv2Array=new Float32Array(3*h),c.vertexTangentArray=new Float32Array(3*h),c.vertexBinormalArray=new Float32Array(3*h);for(var d=0;d<3*h;d+=3)c.vertexPositionArray[d]=NaN;var u=null;if(l){var p=new r.SGPrimitive({cgmId:this._token,rep:null,start:0,count:6*h/4});this._token++,(g=new r.DrawingGroup(this.textGas,null,4,0,6*h/4,[p])).geometry=c,c.drawingGroups.push(g),p.group=g;for(var f=0;f<this._occurrences.length;f++){(x=this._occurrences[f].renderable).geometry.push(c),c.addRefVBO(x,!1),x._initLayersForGeometry(0,c),u=(b=x.layer.getIntervals(c,null,!0)).length?x.layer.layers.indexOf(b[0]):-1}}else{for(d=0;d<4*o;d++)c.vertexColorArray[d]=a.vertexColorArray[d],d<3*o&&(c.vertexPositionArray[d]=a.vertexPositionArray[d],c.vertexNormalArray[d]=a.vertexNormalArray[d],c.vertexUvArray[d]=a.vertexUvArray[d],c.vertexUv2Array[d]=a.vertexUv2Array[d],c.vertexTangentArray[d]=a.vertexTangentArray[d],c.vertexBinormalArray[d]=a.vertexBinormalArray[d]);for(d=0;d<6*o/4;d++)c.vertexIndexArray[d]=a.vertexIndexArray[d];var g,m=a.drawingGroups[0]._primitives.slice(),v=m[m.length-1],_=v.start+v.count,y=6*h/4-_,S=new r.SGPrimitive({cgmId:this._token,rep:null,start:_,count:y});m.push(S),this._token++,(g=new r.DrawingGroup(this.textGas,null,4,0,6*h/4,m)).geometry=c,c.drawingGroups.push(g);for(f=0;f<m.length;f++)m[f].group=g;for(f=0;f<this._occurrences.length;f++){for(var x,b=(x=this._occurrences[f].renderable).layer.getIntervals(x.geometry[s-1],null,!0),w=0;w<b.length;w++)b[w].geometry=c,b[w].drawableGroup=c.drawingGroups[0];var M=b[b.length-1],C=x.layer.layers.indexOf(M);if(M.drawableInterval.layerNum){var P=new e.DrawableInterval(0,_,y);P.primitiveStart=m.length-1,P.primitiveCount=1;var E=new e.LayerInterval(c,c.drawingGroups[0],P);x.layer.layers.splice(C+1,0,E),u=C+1}else M.drawableInterval.count+=y,M.drawableInterval.primitiveCount++,u=C;c.addRefVBO(x,!1),x.geometry[s-1].releaseVBO(x,!1),x.geometry.splice(s-1,1),x.geometry.push(c)}}return u},_initMaterialPDSFX:function(t){var i="_";if(t&&(this.billboard&&(i+="bi_"),this.billboardAxis&&(i+="ax_"),this.fixedSize&&(i+="fi_"),this.viewSpace&&(i+="vi_"),this.projectionSpace&&(i+="pr_"),l[i]))this.textMaterial=l[i];else{if(this.textMaterial=new e.MeshBasicMaterial({force:!this.matInherit,side:e.FrontSide,needTangentBinormal:!0,transparent:!0}),t){var r={USE_BILLBOARD:this.billboard,USE_AXIS:this.billboardAxis,USE_FIXEDSIZE:this.fixedSize,USE_VIEWSPACE:this.viewSpace,USE_PROJSPACE:this.projectionSpace};this.textMaterial.defines=r}this.textMaterial._activatePDSFXMigrated(),this.textMaterial._PDSFXData._uniqueID="TextNodePDSFX";var n={fontMap:{type:"t2",value:null},quad:{type:"fv1",value:[-.5,-.5,.5,-.5,.5,.5,-.5,.5],length:8},invSize:{type:"v2",value:new e.Vector2(512,512)}};this.textMaterial.setPDSFXUniforms(n);this.textMaterial.setPDSFXVaryings({_color:{type:"v4"},_uv:{type:"v2"}}),this.textMaterial.setPDSFXGlobalShaderCode(null,e=>`\n                    ${e.variableHandler.float("alpha")};\n                `);var s={ComputeVaryingValues:function(e,t){const i=e.variableHandler,r=(e.functionHandler,e.pdsfxDefines,e.userDefines,t=>e.getVarying(t));return`\n                        ${r("_color")} = ${(e=>i.vec4(e))()}(${e.vGetAttribColor()}.rgb, 1.0);\n                        ${r("_uv")} = ${e.vGetAttribTexCoord0()}.xy;\n                    `},ProcessClipSpacePosition:function(t,i){const r=t.variableHandler,n=t.functionHandler,s=(t.pdsfxDefines,t.userDefines),a=e=>t.getUniform(e),o=e=>r.int(e),l=e=>r.vec2(e),h=e=>r.vec3(e),c=e=>r.vec4(e),d=r.dereference()+i[0],p=((e=>t.getTextureUniform(e))("fontMap"),a("quad")),f=a("invSize"),g=!!s.USE_BILLBOARD,m=!!s.USE_FIXEDSIZE,v=!!s.USE_VIEWSPACE,_=!!s.USE_PROJSPACE,y=!!s.USE_AXIS;return`\n                        ${h("mPos")}  = ${t.vGetAttribPosition()};\n                        ${h("mNormal")}  = ${t.vGetAttribNormal()};\n                        ${c("mUV2")}  = ${t.vGetAttribTexCoord1()};\n                        ${h("mTangent")}  = ${t.vGetAttribTangent()};\n                        ${h("mBinormal")}  = ${t.vGetAttribBinormal()};\n\n                        ${h("uncompressedUp")}  = mTangent;\n\n                        ${h("uncompressedRight")}  = mBinormal;\n\n                        ${h("corner")}  = ${h()}\n                            (\n                                ${p}[2*${o()}(${t._vGetAttribColorAlpha()})], \n                                ${p}[2*${o()}(${t._vGetAttribColorAlpha()}) + 1], \n                                0.0\n                            );\n\n                        ${g?m?`\n                                ${v?`\n                                    ${c("mvPosition")}  = ${u("getModelTransformation","v4",[n.prmV3("mPos")])};\n                                    `:_?`\n                                        ${c("projPosition")}  = ${c()}(mPos.xy, 0.0, 1.0);\n                                        `:`                        \n                                        ${c("mPosV4")} = ${c()}(mPos, 1.0);\n                                        ${e._DefaultShaderChunk.getModelViewTransformationChunk(c("mvPosition"),"mPosV4",t.__internalOptions__)}\n                                        `}\n                                ${y?v?`                                      \n                                            ${c("mvPosition2")}  = ${u("getModelTransformation","v4",[n.prmV3("mPos + uncompressedRight")])};\n                                            `:_?`\n                                                ${c("projPosition2")}  = ${c()}(uncompressedRight.xy, 0.0, 1.0);\n                                                `:`                                      \n                                                ${c("mPos2V4")} = ${c()}(mPos + uncompressedRight, 1.0);\n                                                ${e._DefaultShaderChunk.getModelViewTransformationChunk(c("mvPosition2"),"mPos2V4",t.__internalOptions__)}\n                                                `:""}\n                                `:`\n                                ${c("mPosV4")} = ${c()}(mPos, 1.0);\n                                ${e._DefaultShaderChunk.getModelViewTransformationChunk(c("_mvPos"),"mPosV4",t.__internalOptions__)}\n                                ${c("mvPosition")} = _mvPos + ${c()}(mNormal, 0.0) + ${c()}(corner * ${h()}(mUV2.xy, 1.0), 0.0);\n                                `:`\n                            ${c("newPosition")}  = ${c()}(mPos + ${(e=>r.mat3(e))()}(uncompressedRight, uncompressedUp, ${h()}(0.0, 0.0, 1.0)) * (mNormal + corner * ${h()}(mUV2.xy, 1.0)), 1.0);\n                            ${e._DefaultShaderChunk.getModelViewTransformationChunk(`${c("mvPosition")}`,"newPosition",t.__internalOptions__)}\n                            `}\n                        ${h("mvNormal")};\n\n                        ${_?`\n                            ${d} = projPosition;\n                            `:`\n                            ${d}  = ${t.vGetProjectionMatrix()} * mvPosition;\n                            `}\n                        ${m?y?`\n                                ${_?`                                      \n                                        ${l("toPixels")}  = 0.5 / ${f};\n                                        ${l("projPt1")}  = toPixels * projPosition.xy;\n                                        ${l("projPt2")}  = toPixels * projPosition2.xy;\n                                        `:`\n                                        ${c("glPosition2")}  = ${t.vGetProjectionMatrix()} * mvPosition2;\n                                        ${l("toPixels1")}  = 0.5 / (${f} * ${d} .w);\n                                        ${l("toPixels2")}  = 0.5 / (${f} * glPosition2.w);\n                                        ${l("projPt1")}  = toPixels1 * ${d} .xy;\n                                        ${l("projPt2")}  = toPixels2 * glPosition2.xy;\n                                        `}\n                                \n                                ${l("rightVecPx")}  = normalize(projPt2.xy - projPt1.xy);\n                                ${l("upVecPx")}  = ${l()}(-rightVecPx.y, rightVecPx.x);\n                                ${l("offsetVec")}  = (mNormal.xy + corner.xy * mUV2.xy);\n                                offsetVec = offsetVec.x * rightVecPx + offsetVec.y * upVecPx;\n                                ${_?`\n                                        ${d}.x += 2.0 * ${f}.x * offsetVec.x;\n                                        ${d}.y += 2.0 * ${f}.y * offsetVec.y;\n                                        `:`\n                                        ${d}.x += 2.0 * ${f}.x * offsetVec.x * ${d} .w;\n                                        ${d}.y += 2.0 * ${f}.y * offsetVec.y * ${d} .w;\n                                        `}\n                                `:`\n                                ${d}.x += 2.0 * ${f}.x * (mNormal.x + corner.x * mUV2.x) * ${d}.w;\n                                ${d}.y += 2.0 * ${f}.y * (mNormal.y + corner.y * mUV2.y) * ${d}.w;\n                                `:""}\n                    `}};this.textMaterial.setPDSFXOverridableFunctions(s,{ComputeCommonValues:function(e,t){const i=e.variableHandler,r=e.functionHandler,n=e.pdsfxDefines,s=(e.userDefines,e=>i.float(e)),a=(t=>e.getTextureUniform(t))("fontMap");return`\n                        ${s("epsilon")}  = 0.1;\n                        ${(e=>i.vec4(e))("texture")}  = ${r.sample2DTexture(a,(t=>e.getVarying(t))("_uv"))};\n\n                        ${n.extDerivatives?`\n                            ${s("w")} = clamp(200.0 * epsilon * (abs(dFdx(_uv.x)) + abs(dFdy(_uv.y))), 0.0, 0.5);\n                            `:`\n                            ${s("w")} = epsilon;\n                            `}\n\n                        alpha = smoothstep(0.5 - w, 0.5 + w, texture.r);\n                        alpha = pow(alpha, 1.0/2.2);\n                    `},ComputeDiscard:function(e,t){const i=e.variableHandler;return`\n                        ${(e=>i.float(e))("alphaTest")} = 0.01;\n                        // IR 797819\n                        return (alpha < alphaTest);\n                    `},ProcessFinalColor:function(e,t){const i=e.variableHandler;return`\n                        ${t[0]} = ${(e=>i.vec4(e))()}(${e.vGetAlbedo()} * ${(t=>e.getVarying(t))("_color")}.xyz, alpha * ${e.vGetOpacity()});\n                    `}}),this.textMaterial.enableClipPlanes=!0,t&&(l[i]=this.textMaterial)}},_addText:function(e,t,i){var r=e.string.length,n=this._occurrences[0].renderable;if(!t)for(var s=0;s<n.layer.layers.length;s++){var a=n.layer.layers[s],o=a.drawableInterval;if(!o.layerNum&&o.count>=6*r){t=a,i=s;break}}if(t){var l=this._updatePrimitives(t,i,r);return this._updateBuffers(l,e),l}return null},_encodeUnitVector:function(e){var t=Math.abs(e.x)+Math.abs(e.y)+Math.abs(e.z),i=e.x/t,r=e.y/t;if(e.z<0){var n=(1-Math.abs(r))*(i>=0?1:-1),s=(1-Math.abs(i))*(r>=0?1:-1);i=n,r=s}return 4096*(i=Math.round(4095*(.5*i+.5)))+(r=Math.round(4095*(.5*r+.5)))},_updateBuffers:function(t,i){for(var n=new e.Box2,s=t.getGroup().geometry,a=t.getStart(),o=4*(a/6),l=i,c=l.string.length,d=l.offset?l.offset:p,u=this.getBuffer(r.VertexComponentEnum.POSITION,s),f=this.getBuffer(r.VertexComponentEnum.NORMAL,s),g=this.getBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,s),m=this.getBuffer(r.VertexComponentEnum.TEX_COORD_0,s),v=this.getBuffer(r.VertexComponentEnum.TEX_COORD_1,s),_=this.getBuffer(r.VertexComponentEnum.TEX_COORD_2,s),y=this.getBuffer(r.VertexComponentEnum.TEX_COORD_3,s),S=this.getIndexBuffer(s),x=l.size/h.base,b=l.lineLength?l.lineLength:0,w=0,M=new e.Vector3,C=a,P=o,E=3*o,T=4*o,A=3*o,D=3*o,I=3*o,R=3*o,O=3*o,L=0,V=0;V<c;V++){var F=l.string[V];if("\n"===F)M.x=0,M.y-=x*this.lineHeight*h.base,w=0;else{if(b&&" "===F&&w>b){M.x=0,M.y-=x*this.lineHeight*h.base,w=0;continue}if(!(F=h.chars[F.charCodeAt(0)]))continue;L++,S[C++]=P,S[C++]=P+1,S[C++]=P+2,S[C++]=P,S[C++]=P+2,S[C++]=P+3,P+=4,m[I++]=F.x/h.width,m[I++]=(h.height-(F.y+F.height))/h.height,m[I++]=0,m[I++]=(F.x+F.width)/h.width,m[I++]=(h.height-(F.y+F.height))/h.height,m[I++]=0,m[I++]=(F.x+F.width)/h.width,m[I++]=(h.height-F.y)/h.height,m[I++]=0,m[I++]=F.x/h.width,m[I++]=(h.height-F.y)/h.height,m[I++]=0;var B=M.x+x*(.5*F.width+F.xoffset),N=M.y+x*(F.yoffset-.5*F.height);M.z;M.x+=x*F.xadvance,w+=x*F.xadvance,n&&(B-.5*x*F.width<n.min.x&&(n.min.x=B-.5*x*F.width),B+.5*x*F.width>n.max.x&&(n.max.x=B+.5*x*F.width),N-.5*x*F.height<n.min.y&&(n.min.y=N-.5*x*F.height),N+.5*x*F.height>n.max.y&&(n.max.y=N+.5*x*F.height));for(var G=0;G<4;G++)f[E++]=d.x+B,f[E++]=d.y+N,f[E++]=d.z,u[A++]=l.anchor.x,u[A++]=l.anchor.y,u[A++]=l.anchor.z,v[D++]=x*F.width,v[D++]=x*F.height,v[D++]=0,g[T++]=l.color.r,g[T++]=l.color.g,g[T++]=l.color.b,g[T++]=G,_[R++]=l.up.x,_[R++]=l.up.y,_[R++]=l.up.z,y[O++]=l.right.x,y[O++]=l.right.y,y[O++]=l.right.z}}for(V=0;V<6*(c-L);V++)S[C++]=0;this.updateBuffer(r.VertexComponentEnum.POSITION,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.NORMAL,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.DIFFUSE_COLOR,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_0,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_1,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_2,o,4*c,s),this.updateBuffer(r.VertexComponentEnum.TEX_COORD_3,o,4*c,s),this.updateIndexBuffer(a,6*c,s);var k=new e.Vector3(n.min.x,n.min.y,-.5),U=new e.Vector3(n.max.x,n.max.y,.5),z=this.getBoundingBox(),H=new e.Box3(k,U);this.forceBoundingBox(z.union(H)),i.labelExtent||(i.labelExtent=n)},getTextExtent:function(t){var i=new e.Box2;t.labelExtent=i;for(var r=t,n=r.string.length,s=r.size/h.base,a=r.lineLength?r.lineLength:0,o=0,l=new e.Vector2,c=0;c<n;c++){var d=r.string[c];if("\n"===d)l.x=0,l.y-=s*this.lineHeight*h.base,o=0;else{if(a&&" "===d&&o>a){l.x=0,l.y-=s*this.lineHeight*h.base,o=0;continue}if(!(d=h.chars[d.charCodeAt(0)]))continue;var u=l.x+s*(.5*d.width+d.xoffset),p=l.y+s*(d.yoffset-.5*d.height);l.x+=s*d.xadvance,o+=s*d.xadvance,u-.5*s*d.width<i.min.x&&(i.min.x=u-.5*s*d.width),u+.5*s*d.width>i.max.x&&(i.max.x=u+.5*s*d.width),p-.5*s*d.height<i.min.y&&(i.min.y=p-.5*s*d.height),p+.5*s*d.height>i.max.y&&(i.max.y=p+.5*s*d.height)}}return i},_updatePrimitives:function(e,t,i){this._mergePrimitives(e,t);var n=e.geometry,s=n.drawingGroups[0],a=e.drawableInterval,o=s.getPrimitiveCount(a.primitiveStart);s._setPrimitiveCount(6*i,a.primitiveStart);var l=new r.SGPrimitiveHelper;l.set(s,a.primitiveStart);var h=o-l.getCount();if(h>0){var c=new r.SGPrimitive({cgmId:this._token,rep:null,group:l.getGroup(),start:l.getStart()+l.getCount(),count:h});this._token++,s._primitives.splice(a.primitiveStart+1,0,c)}for(var d=0;d<this._occurrences.length;d++){var u=this._occurrences[d].renderable,p=u.layer.layers[t],f=t?u.layer.layers[t-1]:null,g=f&&f.geometry===p.geometry;if(f&&g&&1===f.drawableInterval.layerNum)f.drawableInterval.count+=l.getCount(),f.drawableInterval.primitiveCount++,h>0?(p.drawableInterval.start=l.getStart()+l.getCount(),p.drawableInterval.count=h,p.drawableInterval.primitiveStart++):u.layer.layers.splice(t,1);else if(p.drawableInterval.count=6*i,p.drawableInterval.layerNum=1,h>0){var m=p.clone();m.drawableInterval.layerNum=0,m.drawableInterval.start=l.getStart()+l.getCount(),m.drawableInterval.count=h,u.layer.layers.splice(t+1,0,m)}if(h>0)for(var v=t+1;v<u.layer.layers.length&&u.layer.layers[v].geometry===n;v++)u.layer.layers[v].drawableInterval.primitiveStart++}return l},_mergePrimitives:function(e,t){var i=e.geometry,r=i.drawingGroups[0]._primitives,n=e.drawableInterval;if(!(n.primitiveCount<=1)){var s=r[n.primitiveStart],a=r[n.primitiveStart+n.primitiveCount-1];s.count=a.start+a.count-s.start,r.splice(n.primitiveStart+1,n.primitiveCount-1);for(var o=0;o<this._occurrences.length;o++)for(var l=this._occurrences[o].renderable,h=t+1;h<l.layer.layers.length&&l.layer.layers[h].geometry===i;h++)l.layer.layers[h].drawableInterval.primitiveStart-=n.primitiveCount-1;n.primitiveCount=1}}});return UWA.namespace("THREEDS/Nodes/TextNode",f)}),define("DS/Visualization/DecalManager",["DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";var r=1,n=1,s=0,a=new Map,o=!1,l=function(e){e.setPickable(o?t.PICKABLE:t.PICKTHROUGH),o?e.excludeFromHighlight(!1,!1):e.excludeFromHighlight(!0,!0)},h=function(){this.activated=!1,this._creatingDecal=!1};h.prototype={_attachViewer:function(e){a.has(e)||a.set(e,new Set)},detachViewer:function(e){a.delete(e)},createDecal:function(t){if(!(!!i.supportedExtensions.textureHalfFloat&&!!i.supportedExtensions.renderToHalfFloatTexture&&!!i.supportedExtensions.textureHalfFloatLinear||!!i.supportedExtensions.textureFloat&&!!i.supportedExtensions.renderToFloatTexture&&!!i.supportedExtensions.textureFloatLinear))return console.error("Error: float/half float textures not supported, decals disabled"),null;if(!i.supportedExtensions.fragDepth)return console.error("Error: frag depth not supported, decals disabled"),null;if(!t.material&&!t.materialApplication)return console.error("Error: you need to give a material to a decal node"),null;if(t.material&&!t.material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;if(t.materialApplication&&!t.materialApplication._material&&!t.materialApplication._material.isPhysicalMaterial)return console.error("Error: unsupported decal material, expected PhysicalMaterial"),null;this._creatingDecal=!0;var r=new i.Matrix4,n=t.material,s=t.materialApplication;t.matrix&&(r=t.matrix);var a=e.createCuboidNode({cornerPoint:new i.Vector3(-.5,-.5,-.5),firstAxis:new i.Vector3(1,0,0),secondAxis:new i.Vector3(0,1,0),thirdAxis:new i.Vector3(0,0,1),_decal:!0});return a._setHasExplicitUv(!!t.explicitUv),s?a.setMaterialApplication(s):a.setMaterial(n),a.setMatrix(r),l(a),a.setVisibilityInTree(!1),this._creatingDecal=!1,a},updateDecalsPickable:function(e){o=e,a.forEach(function(e,t,i){e.forEach(function(e,t,i){l(e)})})},updateDecalsData:function(e,t){this._attachViewer(e),r=1,n=0,s=0;var i=this.activated;i&&t&&(i=a.get(e).size>0);if(i){var o=new Set;a.set(e,o),this._updateDecalsData(e.getRootNode()._occurrences[0],o,!1)}},_updateDecalsData:function(e,t,i){if(!e.node._isDecal){var a=e.node.decalCount>0;if(a){s++,n++;for(var o=0;o<e.children.length;o++){(l=e.children[o]).node._isDecal&&(l.renderable._decalData={key:0,internalSortKey:o,layer:l.node._layer,stencilID:n,explicitUv:l.node._getHasExplicitUv(),needDrawUvs:!1},i=i||l.renderable._decalData.explicitUv,t.add(l.node),l.renderable._flagAsGSSOInvalidated())}}for(o=0;o<e.children.length;o++)this._updateDecalsData(e.children[o],t,i);if(e.renderable&&(e.renderable._decalData=s>0?{key:4*r,stencilID:n,internalSortKey:0,layer:0,explicitUv:!1,needDrawUvs:i}:null,e.renderable._flagAsGSSOInvalidated()),a){s--;for(o=0;o<e.children.length;o++){var l;(l=e.children[o]).node._isDecal&&(l.renderable._decalData.key=4*r+1,l.renderable._flagAsGSSOInvalidated())}r++}}},displayDecalInfo:function(e){console.clear(),this._displayInfo(e.getRootNode()._occurrences[0],0)},_displayInfo:function(e,t){for(var i="",r=0;r<t;r++)i+=" ";if(e.renderable){var n=e.renderable;console.log(""),console.log(i+(e.node._isDecal?"decal:":"geometry:")),n._decalData&&(console.log(i+" key: "+n._decalData.key),console.log(i+" stencil: "+n._decalData.stencilID))}var s=2*t+2;for(r=0;r<e.children.length;r++)this._displayInfo(e.children[r],s)}};var c=new h;return i.DecalManager=c,c}),define("DS/Visualization/PlaneGrid",["UWA/Class","WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/TextNode"],function(e,t,i,r,n){"use strict";var s=(new i.Color).setRGB(1,1,1),a=(new i.Vector3(0,0,1),new i.Vector3(0,0,-1),new i.Vector3(1,0,0)),o=new i.Vector3(0,1,0),l=new i.Vector3(0,0,1),h=new i.Vector3(-1,0,0),c=new i.Vector3(0,-1,0),d=new i.Vector3(0,0,-1),u=new i.Vector3,p=new i.Vector2,f=new i.Vector2;return Math.round10||(Math.round10=function(e,t){return function(e,t,i){return void 0===i||0==+i?Math[e](t):(t=+t,i=+i,isNaN(t)||"number"!=typeof i||i%1!=0?NaN:(t=t.toString().split("e"),+((t=(t=Math[e](+(t[0]+"e"+(t[1]?+t[1]-i:-i)))).toString().split("e"))[0]+"e"+(t[1]?+t[1]+i:i))))}("round",e,t)}),e.extend({init:function(e){this.viewer=e,this.worldOrientation=null,this.position=new i.Vector3,this.size=100,this.displayLabels=!1,this.gridLabels=null,this.labelColor=s,this.labelCB=null,this.displayLabelCB=null,this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]},this.displayGrid=e.displayGrid,this.displayGridFromBelow=e.displayGridFromBelow,this.gridScreenSize=50,this.gridNbSteps=e.gridNbSteps,this.gridUnit=1,this.gridOffset=new i.Vector2,this.gridCoeff=0,this.gridFalloff=0,this.gridColor=e.gridColor,this.displayPlane=1,this.planeFalloff=0,this.planeColor=e.planeColor,this.planeOpacity=1,this.planeTexture=null,this.planeTextureScale=1,this._onlyDiffuse=!1,this.planeBorder=!1,this.edgeColor=new i.Color,this.mesh=null,this.matrix=new i.Matrix4,this.material=null,this.gridTextures={},this.viewProjMatrix=new i.Matrix4,this.tmpFrustum=new i.Frustum,this.tmpPoly1=new i.CGPolygon,this.tmpPoly2=new i.CGPolygon,this.tmpLine=new i.Line3(new i.Vector3,new i.Vector3)},setGridNbSteps:function(e){this.gridNbSteps=e,this.setGridTextures()},setLabels:function(e){if(e!==this.displayLabels){if(this.displayLabels=e,e&&!this.gridLabels){this.gridLabels=new n("gridLabels"),this.gridLabels.setBillboard(!0,!0),this.gridLabels.setFixedSize(!0),this.gridLabels._setProjectionSpace(!0);var t=this.gridLabels._occurrences[0].renderable;t.renderDepth=0,t.receiveShadow=!1,this.viewer.sceneBackground.add(t)}this.gridLabels&&(this.gridLabels.setVisibility(e),this.gridLabels.setVisibilityFree(e))}},setLabelColor:function(e){this.labelColor=new i.Color,this.labelColor.set(e)},setLabelCallback:function(e){this.labelCB=e},setDisplayLabelCallback:function(e){this.displayLabelCB=e},getUnitGridTexture:function(e){if(this.gridTextures[e])return this.gridTextures[e];for(var t=new Uint8Array(e*e),r=0;r<e;++r)t[r]=255,t[e*(e-1)+r]=255,t[e*r]=255,t[e*r+e-1]=255;var n=new i.DataTexture(t,e,e,i.AlphaFormat,i.UnsignedByteType,new i.UVMapping,i.RepeatWrapping,i.RepeatWrapping,i.LinearFilter,i.LinearMipMapLinearFilter,16);return n.needsUpdate=!0,this.gridTextures[e]=n,n},setGridTextures:function(){if(this.material){var e=this.gridNbSteps/2,t=i.ImageUtils.nearest_pow2(64*e),r=i.ImageUtils.nearest_pow2(64*e*e),n=Math.min(i.ImageUtils.nearest_pow2(64*e*e*e),4096);this.material.updatePDSFXUniform("gridTexture",this.getUnitGridTexture(64)),this.material.updatePDSFXUniform("gridTexture2",this.getUnitGridTexture(t)),this.material.updatePDSFXUniform("gridTexture3",this.getUnitGridTexture(r)),this.material.updatePDSFXUniform("gridTexture4",this.getUnitGridTexture(n))}},createPlaneGrid:function(e,t,n,s,a,o){this.size=e,this.position=t,this.worldOrientation=n.getWorldOrientation();var l=this.worldOrientation.upVector,h="zup"===this.worldOrientation._woName;this.computeGridUnit(n.camera,Math.abs(n.camera.position.dot(l)-this.position.dot(l)));var c=this.gridNbSteps*this.gridUnit;if(this.gridOffset.x=s?t.x-c*Math.floor(t.x/c):0,h?this.gridOffset.y=s?t.y-c*Math.floor(t.y/c):0:this.gridOffset.z=s?t.z-c*Math.floor(t.z/c):0,!this.mesh){this.material=new i.PlaneMaterial,this.material.setPlaneV2(!0),this.material.ambient.copy(new i.Color(328965)),this.setGridTextures();var d=r.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:this.material});d.setVisibilityFree(!0),this.mesh=d._occurrences[0].renderable,this.mesh.frustumCulled=!1,this.mesh.receiveShadow=!1,this.mesh.renderDepth=1,this.viewer.sceneBackground.add(this.mesh),this.mesh.pickable=!1}this.mesh.visible=!0;var u=new i.Vector3,p=new i.Vector3,f=(new i.Matrix4).copy(a);u.copy(this.worldOrientation.frontVector),u.multiplyScalar(t.x-.5*e),p.copy(this.worldOrientation.rightVector),p.multiplyScalar(t.y-.5*e),u.add(p),p.copy(this.worldOrientation.upVector),p.multiplyScalar(t.z),u.add(p),f.setPosition(u),f.scale(new i.Vector3(e,e,e)),this.mesh.setMatrix(f),this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow),this.material.color.copy(this.planeColor),this.material.updatePDSFXUniform("planeOpacity",this.planeOpacity),this.material.setPlaneTexture(this.planeTexture),this.material.updatePDSFXUniform("uvScale",this.planeTextureScale);var g=new i.Color;g.copyToLinear(this.edgeColor,o),this.material.updatePDSFXUniform("border",g),this.material.updatePDSFXUniform("attenuation",this.viewer.planeAttenuation?1:0),this.material.updatePDSFXUniform("planeBorder",this.planeBorder?1:0),this.material.updatePDSFXUniform("planeFalloff",this.planeFalloff),this.material.updatePDSFXUniform("gridFalloff",this.gridFalloff),this.material.updatePDSFXUniform("gridUnit",this.gridUnit),this.material.updatePDSFXUniform("gridOffset",this.gridOffset),this.material.updatePDSFXUniform("gridCoeff",this.gridCoeff);var m=new i.Color;m.copyToLinear(this.gridColor,o),this.material.updatePDSFXUniform("gridColor",m),this.material.updatePDSFXUniform("planeSize",e),this.material.updatePDSFXUniform("nbSteps",this.gridNbSteps),this.material.updatePDSFXUniform("onlyDiffuse",this._onlyDiffuse)},computeGridUnit:function(e,t){var r=1;e instanceof i.PerspectiveCamera?r=2*this.gridScreenSize*Math.tan(Math.PI*e.fov/360)*t/this.viewer._getDivClientHeight():e instanceof i.OrthographicCamera&&(r=this.gridScreenSize*(e.top-e.bottom)/this.viewer._getDivClientHeight());for(var n=1/(this.gridNbSteps*this.gridNbSteps);n<r;)1===this.gridNbSteps?n++:n*=this.gridNbSteps,0;this.gridUnit=n,1===this.gridNbSteps?this.gridCoeff=r-n-1:this.gridCoeff=(r-n/this.gridNbSteps)/(n-n/this.gridNbSteps)},updateLabels:function(e){if(this.displayLabels&&(this.cleanLabels(),this.computeLabelPositions(e.camera),this.displayLabelsFunc(),this.gridLabels)){var t=this.gridLabels.textMaterial;t.updatePDSFXUniform("invSize",new i.Vector2(1/this.viewer.renderer.deviceWidth,1/this.viewer.renderer.deviceHeight)),t.updatePDSFXUniform("screenRatio",this.viewer.renderer.deviceWidth/this.viewer.renderer.deviceHeight)}},addLabel:function(e,t,r,n,s,f,g){var m="x"===f?a:"y"===f?o:l,v={string:e,anchor:t,color:this.labelColor,size:20*i.getDevicePixelRatio(),lineLength:500,up:this.worldOrientation.upVector,right:m,isRight:!1},_=this.gridLabels.getTextExtent(v),y=Math.abs(_.max.x-_.min.x),S=Math.abs(_.max.y-_.min.y);_.min.x=-S,_.min.y=-S,_.max.x=S,_.max.y=S,_.translate(r),u.addVectors(t,m);var x=this.viewer.currentViewpoint.project(u,g);p.set(x.x-r.x,x.y-r.y),p.normalize(),p.x<0&&(v.right="x"===f?h:"y"===f?c:d);var b=!1;if(s?(b=!0,p.x>0&&p.negate()):((p.x<0&&p.y<0||p.x>0&&p.y>0)&&(b=!0),p.x>0&&p.y>0&&p.negate()),b&&(p.multiplyScalar(y),r.x+=p.x,r.y+=p.y),v.anchor=this.viewer.currentViewpoint.unProject(r,g),v.right=(new i.Vector3).addVectors(v.anchor,v.right),v.anchor.applyProjection(this.viewProjMatrix),v.right.applyProjection(this.viewProjMatrix),p.set(v.right.x-v.anchor.x,v.right.y-v.anchor.y),p.normalize(),v.right.copy(v.anchor),v.right.x+=p.x,v.right.y+=p.y,!this.displayLabelCB)for(var w=0;w<n.length;w++)if(_.isIntersectionBox(n[w]._text.labelExtent))return;var M={token:null,_text:v,isRight:s,display:!0};n.push(M),this.labels.all.push(M)},isBottomRightEdge:function(e){return!(e.x<2)&&!(e.y<2)},isRightEdgeFunc:function(e){return e.x>this.viewer.SCREEN_WIDTH-2},isInsideFrustum:function(e){return!(e.x<-1||e.x>this.viewer.SCREEN_WIDTH+1)&&(!(e.y<-1||e.y>this.viewer.SCREEN_HEIGHT+1)&&!(e.z<-1.001||e.z>1.001))},cleanLabels:function(){for(var e=0;e<this.labels.all.length;e++)null!==this.labels.all[e].token&&this.gridLabels.removeText(this.labels.all[e].token);this.labels={rightNS:[],rightWE:[],bottomNS:[],bottomWE:[],all:[]}},displayLabelsFunc:function(){this.displayLabelCB&&this.displayLabelCB(this.labels.all);for(var e=0;e<this.labels.all.length;e++){var t=this.labels.all[e];if(t.display){if(t.offset||t.offsetFromScreenEdge||t.offsetFromAxis){var r=t.offset?t.offset.x:0,n=t.offset?t.offset.y:0;p.set(.5*this.viewer.SCREEN_WIDTH*(t._text.right.x-t._text.anchor.x),.5*this.viewer.SCREEN_HEIGHT*(t._text.right.y-t._text.anchor.y)),p.normalize(),f.set(-p.y,p.x),(t.isRight||p.y<0)&&p.negate(),!t.isRight&&p.y<0&&f.negate(),f.multiplyScalar(t.offsetFromAxis||0),p.multiplyScalar(t.offsetFromScreenEdge||0),t._text.anchor.x+=2*(r+f.x+p.x)/this.viewer.SCREEN_WIDTH,t._text.anchor.y+=2*(n+f.y+p.y)/this.viewer.SCREEN_HEIGHT,t._text.right.x+=2*(r+f.x+p.x)/this.viewer.SCREEN_WIDTH,t._text.right.y+=2*(n+f.y+p.y)/this.viewer.SCREEN_HEIGHT}t.size&&(t._text.size=t.size*i.getDevicePixelRatio()),t.color&&(t._text.color=t.color);var s=this.gridLabels.addText(t._text);t.token=s}}},computeIntersectionsForLabels:function(e,t,i,r,n,s,a){var o="zup"===this.worldOrientation._woName,l=o?"y":"x",h=o?"z":"y",c=this.labels.rightWE,d=this.labels.bottomWE,u="E",p="W";o?"y"===e&&(l="x",u="N",p="S"):"x"===e&&(l="z",u="N",p="S");var f=Math.round((t.min[e]-this.position[e])/this.gridUnit),g=Math.round((t.max[e]-this.position[e])/this.gridUnit);i<0?g=Math.min(f+1e3,g):f=Math.max(g-1e3,f);for(var m=this.tmpLine,v=f;v<=g;v++){m.start[e]=v*this.gridUnit+this.position[e],m.start[l]=-.5*this.size+this.position[l],m.start[h]=this.position[h],m.end[e]=m.start[e],m.end[l]=.5*this.size+this.position[l],m.end[h]=this.position[h];var _=r.planes[n].intersectLine(m),y=_&&s.project(_,a),S=!!_&&this.isInsideFrustum(y)&&this.isBottomRightEdge(y),x=S&&this.isRightEdgeFunc(y);if(S){var b,w=v*this.gridUnit+this.position[e],M=Math.round10(w,-2),C=M>=0;b=this.labelCB?this.labelCB(w,C?u:p):Math.abs(M)+" "+(C?u:p),this.addLabel(b,_,y,x?c:d,x,l,a)}}},removeMesh:function(){this.mesh&&this.viewer.sceneBackground.remove(this.mesh)},updateVisibility:function(){this.material&&(this.material.updatePDSFXUniform("displayPlane",this.displayPlane),this.material.updatePDSFXUniform("displayGrid",this.displayGrid),this.material.updatePDSFXUniform("gridFromBelow",this.displayGridFromBelow))},computeLabelPositions:function(){var e=this.viewer.currentViewpoint,t="zup"===this.worldOrientation._woName,r=this.viewer.cameraBackground;this.viewProjMatrix.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);var n=this.tmpFrustum;n.setFromMatrix(this.viewProjMatrix);var s=n.getCorners(),a=this.tmpPoly1;a.addPoints([(new i.Vector3).copy(s[0]),(new i.Vector3).copy(s[1]),(new i.Vector3).copy(s[5]),(new i.Vector3).copy(s[4])]);var o=this.tmpPoly2;o.addPoints([(new i.Vector3).copy(s[1]),(new i.Vector3).copy(s[2]),(new i.Vector3).copy(s[6]),(new i.Vector3).copy(s[5])]);var l=new i.Plane,h=(new i.Vector3).copy(this.worldOrientation.upVector);h.multiplyScalar(-1),l.setFromNormalAndCoplanarPoint(h,this.position);var c,d,u,p,f=a.clipByPlane(l,new i.CGPolygon),g=o.clipByPlane(l,new i.CGPolygon),m=new i.Vector3,v=new i.Vector3,_=null,y=null;2===f.corner.length&&(m.subVectors(f.corner[1],f.corner[0]),m.normalize(),c=m.dot(this.worldOrientation.frontVector),d=m.dot(this.worldOrientation.rightVector),_=(new i.Box3).setFromPoints([f.corner[0],f.corner[1]])),2===g.corner.length&&(v.subVectors(g.corner[1],g.corner[0]),v.normalize(),u=v.dot(this.worldOrientation.frontVector),p=v.dot(this.worldOrientation.rightVector),y=(new i.Box3).setFromPoints([g.corner[0],g.corner[1]])),Math.abs(c)>.707?(_&&this.computeIntersectionsForLabels(t?"x":"z",_,c,n,2,e,r),y&&this.computeIntersectionsForLabels(t?"y":"x",y,p,n,0,e,r)):(_&&this.computeIntersectionsForLabels(t?"y":"x",_,d,n,2,e,r),y&&this.computeIntersectionsForLabels(t?"x":"z",y,u,n,0,e,r)),this.gridLabels.setFrustumCulled(!1)}})}),define("DS/Visualization/ViewpointManager",["DS/Mesh/ThreeJS_Base","DS/Visualization/InternalSceneGraph","DS/VisuEvents/EventsManager","DS/Visualization/TrackballControls","DS/CoreEvents/Events"],function(e,t,i,r,n){"use strict";var s=function(e){this.viewer=e,this.vpList=[],this.viewpointInfos=new Map,this._registeredViewpoints=new Map,this.defaultSceneGraph=null,this.manipulated=null,this.warnCount=0,this._multiViewCount=0;this._addMultiViewEvents()};return s.prototype.addViewpoint=function(e,i,r,n){e.control&&(e.isMain()&&null==this.manipulated?this.setManipulatedViewpoint(e):e.control.setActive&&e.control.setActive(!1)),null!=this.manipulated&&this.manipulated.control&&this.manipulated.control.updateEditGesture&&this.manipulated.control.updateEditGesture();let s=r?250:50;void 0!==n&&(s+=n),this.vpList.push(e);let a={viewport:null,scenegraph:null,sceneInstance:0,vpEditor:!0,locks:0,isMultiView:!1,order:s,activated:!0};if(i)a.sceneInstance=this.defaultSceneGraph.addSceneInstance(),a.scenegraph=this.defaultSceneGraph,e._setInternalSceneGraph(this.defaultSceneGraph);else{let i=new t(this.viewer,!0,!1,e._isMain);var o=this.defaultSceneGraph.selectionHL,l=this.defaultSceneGraph.selectionPreHL,h=i.selectionHL,c=i.selectionPreHL;h&&h.setHighlightData(o.advanced,o.highlightData),c&&c.setHighlightData(l.advanced,l.highlightData),e._setInternalSceneGraph(i),a.scenegraph=i,e._isMain&&i.scene.add(this.viewer.ambientLight)}this.viewpointInfos.set(e,a),this.orderViewpoints()},s.prototype.getViewpointInfos=function(e){return this.viewpointInfos.get(e)},s.prototype.setOrderCSIViewpoints=function(e){let t=100,i=this.getVpList(!1);for(let r=0;r<e.length;r++){let n=e[r].getUID();for(let e=0;e<i.length;e++){let r=i[e];if(n==r.getCsiUID()){this.viewpointInfos.get(r).order=t++;break}}}this.orderViewpoints()},s.prototype.orderViewpoints=function(){let e=this;this.vpList.sort(function(t,i){let r=e.viewpointInfos.get(t),n=e.viewpointInfos.get(i);return r.order-n.order})},s.prototype.clearNonCSIViewpoints=function(){let e=this.getVpList(!1);for(let t=e.length-1;t>=0;t--){let i=e[t];null===i.getCsiUID()&&this.removeViewpoint(i)}},s.prototype.removeViewpoint=function(e){this.manipulated&&this.manipulated.id==e.id&&this.setManipulatedViewpoint(null),this.viewer.currentViewpoint&&this.viewer.currentViewpoint.id==e.id&&(this.viewer.currentViewpoint=null);let t=this.vpList.indexOf(e);if(t>=0){this.vpList.splice(t,1),e._setInternalSceneGraph(null);let i=this.viewpointInfos.get(e);i&&(i.isMultiView&&this._multiViewCount--,i.scenegraph.freeSceneInstance(i.sceneInstance),i.scenegraph!=this.defaultSceneGraph&&i.scenegraph.dispose(!0)),this.viewpointInfos.delete(e)}},s.prototype.addMainViewpoint=function(e,t,i,r){e._isMain=!0,this.addViewpoint(e,t,i,r)},s.prototype.setManipulatedViewpoint=function(t){if(t&&!t.control)return;null===this.viewer.currentViewpoint&&(this.viewer.currentViewpoint=t);let i=t&&(!this.getViewpointInfos(t)||this.getViewpointInfos(t).vpEditor);this.manipulated==t&&i||(this.manipulated&&this.manipulated.control.setActive&&this.manipulated.control.setActive(!1),t&&i?(t.control.setActive&&t.control.setActive({viewpoint:!0}),this.manipulated=t,this._multiViewPreviousMatrix=(new e.Matrix4).getInverse(this.manipulated.camera.matrix),this._multiViewPreviousDistanceToTarget=this.manipulated.control&&this.manipulated.control.distanceToTarget):(this.manipulated=null,this._multiViewPreviousMatrix=null,this._multiViewPreviousDistanceToTarget=null))},s.prototype.getManipulatedViewpoint=function(){return this.manipulated},s.prototype.hasMovingViewpoint=function(){let e=this.getManipulatedViewpoint();return!(!e||!e.isMoving())},s.prototype.setViewpointActivation=function(e,t){let i=this.viewpointInfos.get(e);i&&(i.activated=t)},s.prototype.setViewpointViewport=function(e,t,i,r,n,s){let a=this.viewpointInfos.get(e);a&&(a.viewport={fixed:t,x:i,y:r,width:n,height:s},this.resizeViewpoint(e))},s.prototype.getViewpointViewport=function(e){let t=this.viewpointInfos.get(e);if(!t)return null;let i=t.viewport;if(i){if(i.fixed)return{x:i.x*this.viewer.devicePixelRatio,y:i.y*this.viewer.devicePixelRatio,width:i.width*this.viewer.devicePixelRatio,height:i.height*this.viewer.devicePixelRatio};{let e=Math.round(i.x*this.viewer.SCREEN_WIDTH*this.viewer.devicePixelRatio),t=Math.round(i.width*this.viewer.SCREEN_WIDTH*this.viewer.devicePixelRatio);return{x:e,y:Math.round(i.y*this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio),width:t,height:Math.round(i.height*this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio)}}}return null},s.prototype.resizeViewpoint=function(e,t,i){let r=this.getViewpointViewport(e),n=t||this.viewer.SCREEN_WIDTH,s=i||this.viewer.SCREEN_HEIGHT;r&&(n=r.width,s=r.height),e.camera.aspect=n/s,e.camera.updateProjectionMatrix(),e.connectedRobotCamera.aspect=n/s,e.connectedRobotCamera.updateProjectionMatrix(),e.robotCameraOrtho.aspect=n/s,e.robotCameraOrtho.setVisualizedHeight(400,e.robotCameraOrtho.aspect),e.robotCameraOrtho.updateProjectionMatrix(),e.control&&e.control.update(),e.resize(n,s)},s.prototype.resize=function(e,t){if(this.isViewpointManagerOverridenBadly())this.resizeViewpoint(this.viewer.currentViewpoint,e,t);else{let i=this.getVpList(!1);for(let r=0;r<i.length;r++){let n=i[r];this.resizeViewpoint(n,e,t)}}},s.prototype.setDefaultSceneGraph=function(e){this.defaultSceneGraph=e},s.prototype.getViewpointScenegraph=function(e){let t=this.viewpointInfos.get(e);return t?t.scenegraph:null},s.prototype.getViewpointRepresentation=function(e){let t=this.viewpointInfos.get(e);return t?t.sceneInstance:0},s.prototype.getViewpointFromRoot3js=function(e){let t=this.getVpList(!1);for(let i=0;i<t.length;i++){let r=this.getViewpointScenegraph(t[i]),n=this.getViewpointRepresentation(t[i]);if(r&&r._sceneInstances[n]&&r._sceneInstances[n].root3js==e)return t[i]}},s.prototype.isViewpointManagerOverridenBadly=function(){let e=this.viewer.currentViewpoint;if(e){for(let t=0;t<this.vpList.length;t++)if(this.vpList[t]==e)return!1;return this.warnCount<10&&(console.warn("viewer.currentViewpoint wasn't properly processed, you have to go through AddViewpoint/SelectViewpoint api to replace currentViewpoint"),this.warnCount++),!0}return!1},s.prototype.getVpList=function(e){if(this.isViewpointManagerOverridenBadly())return[this.viewer.currentViewpoint];if(e){let e=[];for(let t=0;t<this.vpList.length;t++){this.getViewpointInfos(this.vpList[t]).activated&&e.push(this.vpList[t])}return e}return this.vpList},s.prototype.addNodeToViewpoint=function(e,t){e.sceneGraphRoot?e.sceneGraphRoot.addChild(t):this.warnCount<10&&console.warn("addNodeToViewpoint : this viewpoint don't have an associated scenegraph")},s.prototype.getAuxiliaryScenegraphs=function(){let e=[],t=this.getVpList(!1);for(let i=0;i<t.length;i++){let r=t[i],n=this.viewpointInfos.get(r);n&&n.scenegraph!=this.defaultSceneGraph&&e.push(n.scenegraph)}return e},s.prototype.setCSIInfos=function(e,t){let i=this.getViewpointInfos(e);if(i.vpEditor=void 0!==t.hasEditor?t.hasEditor:i.vpEditor,void 0!==t.locks&&i.locks!=t.locks){if(e.control){let i=e.control;0==t.locks?(i.setMouseRotationActive(!0),i.setTouchRotationActive(!0),i.setZoomActive(!0),i.setPanActive(!0),i.setReframeActive(!0),i.setReframeOnDoubleTap(!0)):(i.setMouseRotationActive(!(4&t.locks)),i.setTouchRotationActive(!(2048&t.locks)),i.setZoomActive(!(1&t.locks||256&t.locks)),i.setPanActive(!(16&t.locks||4096&t.locks)),i.setReframeActive(!(64&t.locks)),i.setReframeOnDoubleTap(!(16384&t.locks)))}i.locks=t.locks}void 0!==t.isMultiView&&i.isMultiView!=t.isMultiView&&(t.isMultiView?this._multiViewCount++:(this._multiViewCount--,this.setManipulatedViewpoint(e)),i.isMultiView=t.isMultiView),e.control&&void 0!==t.useNativeBehaviorOnMouseMiddleTriggers&&e.control.setNativeBehaviorOnMouseMiddleTriggers(t.useNativeBehaviorOnMouseMiddleTriggers)},s.prototype._set2DMode=function(e,t){let i=this.getVpList(!1);for(let r=0;r<i.length;r++){let n=i[r];n._isMain&&n._set2DMode(e,t)}},s.prototype._needClear=function(e){let t=this.getVpList(!0),i=!1;for(let e=0;e<t.length;e++)if(t[e]._isMain){i=!0;break}return!i&&t[0].id===e.id},s.prototype.updateApplicationController=function(){let e=this.getVpList(!1);for(let t=0;t<e.length;t++)e[t]._setApplicationDefaultController()},s.prototype.setMultiViewSyncMode=function(t){this._multiViewSyncMode=t;let i=this.getManipulatedViewpoint();this._multiViewPreviousMatrix=i&&(new e.Matrix4).getInverse(i.camera.matrix),this._multiViewPreviousDistanceToTarget=i&&i.control&&i.control.distanceToTarget},s.prototype.checkMultiViewSync=function(t){if(!this._multiViewSyncMode)return;let i=this.getManipulatedViewpoint();if(i&&this.getViewpointInfos(i)&&this.getViewpointInfos(i).isMultiView&&t&&t.viewpoint&&t.viewpoint==i){if(this._multiViewPreviousMatrix){let t=this.getVpList(!0),r=(new e.Matrix4).multiplyMatrices(this._multiViewPreviousMatrix,i.camera.matrix),n=i.control.distanceToTarget/this._multiViewPreviousDistanceToTarget,s=1e-6,a=(1!=n&&Math.abs(r.elements[0]-1)<=s&&Math.abs(r.elements[5]-1)<=s&&Math.abs(r.elements[10]-1)<=s&&Math.abs(r.elements[1])<=s&&Math.abs(r.elements[2])<=s&&Math.abs(r.elements[4])<=s&&Math.abs(r.elements[6])<=s&&Math.abs(r.elements[8])<=s&&Math.abs(r.elements[9]),i.getProjectionType());for(let s=0;s<t.length;s++){let o=t[s];if(!this.getViewpointInfos(o).isMultiView||o==i||!o.control)continue;let l=o.control.distanceToTarget*n,h=(new e.Matrix4).multiplyMatrices(o.camera.matrix,r),c=new e.Vector3,d=new e.Quaternion,u=new e.Vector3;h.decompose(c,d,u),o.moveTo({eyePosition:c,orientation:d,distanceToTarget:l}),o.setProjectionType(a),1==a&&o.camera.fov!=i.fov&&(o.camera.fov=i.fov,o.camera.updateProjectionMatrix())}}this._multiViewPreviousMatrix=(new e.Matrix4).getInverse(i.camera.matrix),this._multiViewPreviousDistanceToTarget=i.control&&i.control.distanceToTarget}},s.prototype._addMultiViewEvents=function(){void 0===i._isInit&&i.init(),this._onPointerDown=this._onPointerDownCB.bind(this),i.addEvent(document,"onLeftMouseDown",this._onPointerDown),i.addEvent(document,"onRightMouseDown",this._onPointerDown),i.addEvent(document,"onMiddleMouseDown",this._onPointerDown),i.addEvent(document,"onTouch",this._onPointerDown),this._multiViewSyncMode=!1,this._multiViewPreviousMatrix=null,this._multiViewPreviousDistanceToTarget=null,this.tokenChange=n.subscribe({event:"/VISU/"},this.checkMultiViewSync.bind(this))},s.prototype._removeMultiViewEvents=function(){i.removeEvent(document,"onLeftMouseDown",this._onPointerDown),i.removeEvent(document,"onRightMouseDown",this._onPointerDown),i.removeEvent(document,"onMiddleMouseDown",this._onPointerDown),i.removeEvent(document,"onTouch",this._onPointerDown),n.unsubscribe(this.tokenChange)},s.prototype._onPointerDownCB=function(e){if(0==this._multiViewCount)return;if(this.manipulated&&this.manipulated.control){if(!this.manipulated.control.getManipulationState)return;let e=this.manipulated.control.getManipulationState();if(e!==r.State.NONE&&e!==r.State.STOP)return}var t=e.from&&e.from.length?e.from[0]:null;if(!t)return;let i=this.viewer.getMousePosition(t.getCurrentPosition(this.viewer.canvas));if(i.x<-1||i.x>1||i.y<-1||i.y>1)return;i.yPix=this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio-i.yPix;let n=this.getVpList(!0);for(let e=0;e<n.length;e++){let t=n[e];if(t.isMain()&&this.getViewpointInfos(t).isMultiView){let e=this.getViewpointViewport(t);if(!e||i.xPix>=e.x&&i.xPix<=e.x+e.width&&i.yPix>=e.y&&i.yPix<=e.y+e.height){this.setManipulatedViewpoint(t);break}}}},s.prototype.getViewpointsUnder=function(e){let t=this.getVpList(!0),i=[],r=this.viewer.SCREEN_HEIGHT*this.viewer.devicePixelRatio-e.yPix;for(let n=0;n<t.length;n++){let s=t[n],a=this.getViewpointViewport(s);(!a||e.xPix>=a.x&&e.xPix<=a.x+a.width&&r>=a.y&&r<=a.y+a.height)&&i.push(s)}return i},s.prototype.hasMultiView=function(){return this._multiViewCount>0},s.prototype.registerViewpoint=function(e){this._registeredViewpoints.set(e.id,e)},s.prototype.unregisterViewpoint=function(e){this._registeredViewpoints.delete(e.id)},s.prototype.dispose=function(){this._removeMultiViewEvents();for(let e=0;e<this.vpList.length;e++){let t=this.vpList[e];t.dispose();let i=this.viewpointInfos.get(t);i.scenegraph!=this.defaultSceneGraph&&i.scenegraph.dispose()}this.viewpointInfos=null,this.vpList=null,this.viewer=null;for(let[e,t]of this._registeredViewpoints)t.dispose()},UWA.namespace("THREEDS/ViewpointManager",s)}),define("DS/Visualization/SpriteNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=t.extend({init:function(t,i){this._parent(i),this.anchor=t;var r=this;return this.cbInit=function(t){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)},this.cbChange=function(t){if("@onViewpointChange"===t.eventType){var i=(new e.Matrix4).lookAt(t.cameraEye,t.cameraTarget,t.cameraUp);i.setPosition(r.anchor),r.setMatrix(i)}},this},_onLinkedToSceneGraph:function(){this.tokenInit=i.subscribe({event:"/VISU/SpriteNodeInit"},this.cbInit),this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange)},getNodeType:function(){return"SpriteNode3D"}});return UWA.namespace("THREEDS/Nodes/Sprite",r)}),define("Visualization/SpriteNode3D",["DS/Visualization/SpriteNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/SpriteNode3D"),e}),define("DS/Visualization/BoundingBoxGPUCompute",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=e.extend({init:function(e){return this.renderer=e,this.minMaxExtension=t.supportedExtensions&&t.supportedExtensions.minMaxBlending,this.useBackUpAlgorithm=!0,//!(this.renderer.renderer.supportsFloatTextures() && this.minMaxExtension);
this._pixels=this.useBackUpAlgorithm?1:32,this.renderTarget=null,this.zRenderTarget=null,this.zMaterial=null,this.material=null,this._useUnindexed=null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),this},setPixelCount:function(e){this._pixels=e,this.renderTarget&&_initRenderTarget()},_initBackUpMaterial:function(){var e=new t.ParticleBasicMaterial;e.sizeAttenuation=!1,e.activatePDSFX();var i={composante:{type:"v3",value:new t.Vector3},orientationMatrix:{type:"m4",value:new t.Matrix4},zMin:{type:"f",value:0},zMax:{type:"f",value:0}};e.setPDSFXUniforms(i);e.setPDSFXVaryings({vZ:{type:"f"}});var r={ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","\treturn vec4(0.0,0.0, 0.0, 0.0);","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","vZ=dot(composante,vec3(orientationMatrix * getModelTransformation(vertexLocalPosition)));","ioPosition=vec4(0.0,0.0,2.0*(vZ)/(zMax-zMin)-(zMin+zMax)/(zMax-zMin),1.0);","}"].join("\n"),ComputeObjectNormal:["vec3 ComputeObjectNormal() {","\treturn vec3(0.0,0.0,1.0);","}"].join("\n")},n={ProcessFinalColor:["float shift_right(float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left(float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last(float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits(float num, float from, float to) {","from = floor(from + 0.5);","to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float(float val) {","if (val == 0.0)","return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = encode_float(vZ);","}"].join("\n")};return e.setPDSFXOverridableFunctions(r,n),e},_initRenderTarget:function(){if(this.useBackUpAlgorithm){var e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.UnsignedByteType,format:t.RGBAFormat};this.renderTarget=new t.WebGLRenderTarget(6,this._pixels,e)}else{e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.FloatType,format:t.RGBAFormat};this.renderTarget=new t.WebGLRenderTarget(this._pixels,2,e)}},_initZRenderTarget:function(){var e={minFilter:t.NearestFilter,magFilter:t.NearestFilter,type:t.UnsignedByteType,format:t.RGBAFormat};this.zRenderTarget=new t.WebGLRenderTarget(1,1,e)},_drawBBDGsDepth:function(e,i,r,n,s){this.material||(this.material=this._initBackUpMaterial()),this.material.updatePDSFXUniform("orientationMatrix",i),this.material.updatePDSFXUniform("composante",s),this.material.updatePDSFXUniform("zMin",r),this.material.updatePDSFXUniform("zMax",n),this.material.id++;var a=!0,o=new t.OrthographicCamera;if(o.setWebGPU(this.renderer.renderer.use_webgpu),this._useUnindexed)for(c=0;c<e.length;c++){var l=e[c].renderable;for(u=0;u<l.geometry.length;u++){var h=l.geometry[u];p={glType:0,start:0,count:h.getVertexCount()||h.vertexCountGPU,nonIndexed:!0};this.renderer.renderer.renderInterval(o,[],l,this.material,null,h,p,p.start,p.count,null,null,a,null,null,null,0),a=!1}}else for(var c=0;c<e.length;c++)for(var d=e[c],u=0;u<d.obj.length;u++){var p,f=(p=d.obj[u]).glType;p.glType=0,this.renderer.renderer.renderInterval(o,[],d.renderable,this.material,null,p.geometry,p,p.start,p.count,null,null,a,null,null,null,0),p.glType=f,a=!1}},_drawZMinDGsDepth:function(e,i,r){this.zMaterial||(this.zMaterial=this._initBackUpMaterial()),this.zMaterial.updatePDSFXUniform("orientationMatrix",new t.Matrix4),this.zMaterial.updatePDSFXUniform("composante",new t.Vector3(0,0,1)),this.zMaterial.updatePDSFXUniform("zMin",i),this.zMaterial.updatePDSFXUniform("zMax",r),this.zMaterial.id++;var n=!0,s=new t.OrthographicCamera;s.setWebGPU(this.renderer.renderer.use_webgpu);for(var a=0;a<e.length;a++)for(var o=e[a],l=0;l<o.geometry.length;l++){var h=o.geometry[l];var c={glType:0,start:0,count:h.getVertexCount()||h.vertexCountGPU,nonIndexed:!0};this.renderer.renderer.renderInterval(s,[],o,this.zMaterial,null,h,c,c.start,c.count,null,null,n,null,null,null,0),n=!1}},_setRendererState:function(){var e,t,i=this.renderer.gl.getParameter(this.renderer.gl.SCISSOR_BOX);t=this.renderer.renderer.getViewport(),e=this.renderer.renderer.getScissorTest();var r=this.renderer.renderer.enablerenderPluginsPre;this.renderer.renderer.enableRenderPluginsPre=!1;var n=this.renderer.renderer.renderPointMode;return this.renderer.renderer.renderPointMode=!0,this.renderer.renderer.materialToUse=0,{scissor:e,scissorValue:i,viewport:t,enablerenderpluginsPre:r,renderPointMode:n,depthTest:this.renderer.renderer._oldDepthTest}},_resetRendererState:function(e){this.renderer.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height),this.renderer.renderer.enableScissorTest(e.scissor),this.renderer.renderer.setScissor(e.scissorValue[0],e.scissorValue[1],e.scissorValue[2],e.scissorValue[3]),this.renderer.renderer.renderPointMode=e.renderPointMode,this.renderer.renderer.setDepthTest(e.depthTest),this.renderer.renderer.enableRenderPluginsPre=e.enablerenderpluginsPre;var t=this.renderer.renderer.getClearColor(),i=this.renderer.renderer.getClearAlpha();this.renderer.gl.clearColor(t.r,t.g,t.b,i)},computeZMinGPU:function(e,t){this.zRenderTarget||this._initZRenderTarget(),this.renderer.renderer.setRenderTarget(this.zRenderTarget);var i=this._setRendererState(),r=e.getSceneBoundingSphere();if(r.pixelRadius>0){var n=e.currentViewpoint.camera.getWorldSizeFromPixelSize(1,r.center,e._getDivClientHeight(),2);r.radius+=n*r.pixelRadius}var s=this._computeZMin(t,r);return this._resetRendererState(i),s},computeBoundingBoxGPU:function(e,i,r){r||(r=new t.Matrix4);var n=(new t.Matrix4).getInverse(r);this.renderTarget||this._initRenderTarget(),this.renderer.renderer.setRenderTarget(this.renderTarget),this.renderer.renderer.clearCurrentBuffer();var s,a=this._setRendererState(),o=e.getSceneBoundingSphere();if(o.center.applyMatrix4(n),o.pixelRadius>0){var l=e.currentViewpoint.camera.getWorldSizeFromPixelSize(1,o.center,e._getDivClientHeight(),2);o.radius+=l*o.pixelRadius}return s=this.useBackUpAlgorithm?this._computeBoundingBoxBackUp(i,n,o):this._computeBoundingBoxMain(i,n,o),this._resetRendererState(a),s},_computeZMin:function(e,t){this.renderer.gl.clearColor(0,0,0,0),this.renderer.renderer.clear(),this.renderer.gl.disable(this.renderer.gl.BLEND),this.renderer.renderer.setDepthTest(!0);var i=this.renderer.renderer.getDepthFunc();this.renderer.renderer.setDepthFunc(this.renderer.renderer.depthFuncs.LESS);var r=t.center.z;this._drawZMinDGsDepth(e,r-t.radius,r+t.radius),this.renderer.renderer.setDepthFunc(i),this.renderer.renderer.setViewport(0,0,1,1);var n=new Uint8Array(4);return this.renderer.gl.readPixels(0,0,1,1,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,n),new Float32Array(n.buffer)[0]},_computeBoundingBoxBackUp:function(e,i,r){this.renderer.gl.clearColor(0,0,0,0),this.renderer.renderer.clear(),this.renderer.gl.disable(this.renderer.gl.BLEND),this.renderer.renderer.setDepthTest(!0);var n=this.renderer.renderer.getDepthFunc();this.renderer.renderer.setDepthFunc(this.renderer.renderer.depthFuncs.LEQUAL);for(var s=0;s<6;s++){this.renderer.renderer.setViewport(s,0,1,this._pixels);new t.Matrix4;var a=new t.Vector3(0,0,1),o=r.center.z;1==s?(a.set(1,0,0),o=r.center.x):2==s?(a.set(0,1,0),o=r.center.y):3==s?(this.renderer.renderer.setDepthFunc(this.renderer.renderer.depthFuncs.GEQUAL),this.renderer.gl.clearDepth(-1),this.renderer.renderer.clear(!1,!0,!1)):4==s?(a.set(1,0,0),o=r.center.x):5==s&&(a.set(0,1,0),o=r.center.y),this._drawBBDGsDepth(e,i,o-r.radius,o+r.radius,a)}this.renderer.gl.clearDepth(1),this.renderer.renderer.setDepthFunc(n);var l=new Uint8Array(24*this._pixels);this.renderer.gl.readPixels(0,0,6,this._pixels,this.renderer.gl.RGBA,this.renderer.gl.UNSIGNED_BYTE,l);var h=new Float32Array(l.buffer),c=h[0],d=h[1],u=h[2],p=h[3],f=h[4],g=h[5];for(s=1;s<this._pixels;s++)c=Math.min(c,h[6*s]),d=Math.min(d,h[6*s+1]),u=Math.min(u,h[6*s+2]),p=Math.max(p,h[6*s+3]),f=Math.max(f,h[6*s+4]),g=Math.max(g,h[6*s+5]);return new t.Box3(new t.Vector3(d,u,c),new t.Vector3(f,g,p))}});return UWA.namespace("THREEDS/BoundingBoxGPUCompute",i)}),define("DS/Visualization/WebGLV6Renderer",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/MirrorShaderBuilders","DS/ShaderBuilders/PostPro/BlurShaderBuilders","DS/Effects/FXAAEffect","DS/Effects/MSAAEffect","DS/Effects/TAAEffect","DS/Effects/SMAAEffect","DS/Effects/HighlightEffect","DS/Effects/HighlightMobileEffect","DS/Effects/SSAOEffect","DS/Effects/SSAOIterativeEffect","DS/Effects/NoPowerOfTwoEffect","DS/Effects/SSLReflectionEffect","DS/Effects/SSLRefractionEffect","DS/Effects/BokehDOFEffect","DS/Effects/ComputeSkyScattering","DS/Effects/BloomsEffect","DS/Effects/ToneMappingEffect","DS/Effects/FlareEffect","DS/Effects/VolumeRenderingEffect","DS/Effects/DebugPassEffect","DS/Effects/DebugShadowMapsEffect","DS/Effects/PreHighlightEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Visualization/RenderTargetPool","DS/Plugins/PluginPass","DS/CoreEvents/Events","DS/Effects/OITEffect","DS/Plugins/CSSNodesPass","DS/Visualization/BoundingBoxGPUCompute","DS/Visualization/RenderMode","DS/Usage/TrackerAPI","DS/Effects/XRevealStructureEffect","DS/Effects/HighlightMobileNonEffect","DS/Effects/PreHighlightMobileNonEffect","DS/Effects/NativeOnTopEffect","DS/Effects/AutoPerformanceSuiteEffect","DS/Visualization/WebGLRenderer","DS/GPURenderer/WebGPURenderer","DS/QualityManager/QMScoreHandler"],function(e,t,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O,L,V,F,B,N,G,k,U,z,H,W,j){"use strict";var X=0,q=new Set;q.add("compareModelPass"),q.add("oitPass"),q.add("oitnozPass"),q.add("remoteImage_0"),q.add("remoteImage_1"),q.add("remoteImage_2"),q.add("TexturePerformance"),q.add("PixelShaderPerformance");var Z=new Set;Z.add("OIT"),Z.add("OITnoZ"),Z.add("xRevealStructure"),Z.add("NativeOnTop"),Z.add("SSAO"),q.add("SSAOEffect"),q.add("SSAOEffectBlurH"),q.add("SSAOEffectBlurV"),q.add("GroundShadowEffect"),q.add("GroundShadowEffectBlurH"),q.add("GroundShadowEffectBlurV"),q.add("mirrorBlendPass"),Z.add("TexturePerformance"),Z.add("PixelShaderPerformance");var Y=new Set;let Q,K;Y.add("OIT"),Y.add("OITnoZ"),Y.add("xRevealStructure"),Y.add("Highlight"),Y.add("Canvas2DHighlight"),Y.add("PreHighlight"),Y.add("Canvas2DPreHighlight"),Y.add("SSAO"),Y.add("SSLRDirect"),Y.add("SSLReflection"),Y.add("SSLRefraction"),Y.add("NativeOnTop"),Y.add("TexturePerformance"),Y.add("PixelShaderPerformance");var $=e.extend({init:function(e){if(this.ODTMode=e.viewer.ODTMode,this.useCompositing=void 0===e.useCompositing||e.useCompositing,this.NoOperator=0,this.SimpleOperator=1,this.LinearOperator=2,this.ReinhardOperator=3,this.FilmicOperator=4,this.UnchartedOperator=5,this.needClippingUpdate=!1,void 0===e.canvas)return;this.canvas=e.canvas,this.divCSS=e.divCSS,this.useOffscreenCanvas=e.useOffscreenCanvas,this.antiAliasing=void 0!==e.antiAliasing?e.antiAliasing:"NoAA",this.useOffscreenCanvas?(this.cssWidth=Math.max(2,e.canvas.width),this.cssHeight=Math.max(2,e.canvas.height)):(this.cssWidth=Math.max(2,e.canvas.offsetWidth),this.cssHeight=Math.max(2,e.canvas.offsetHeight)),this.devicePixelRatio=t.getDevicePixelRatio()||1,this.deviceWidth=Math.floor(this.devicePixelRatio*this.cssWidth),this.deviceHeight=Math.floor(this.devicePixelRatio*this.cssHeight),this.viewportWidth=this.deviceWidth,this.viewportHeight=this.deviceHeight,this.brightness=void 0!==e.brightness?e.brightness:0,this.tonemapping=void 0!==e.tonemapping?e.tonemapping:1,this.disableBackFaceCulling=!1,this.visibleSpace=void 0!==e.visibleSpace?e.visibleSpace:1,this.compareSettings=e.compareSettings,this.mobile=t.mobileVersion,this._postProHighlight=!e.viewer._viewerEffectSettings._lqFallback&&(!this.mobile||!!e.forcePostProHighlight),this._postProHighlight?(Z.add("Highlight"),q.add("HighlightEffect"),Z.add("Canvas2DHighlight"),q.add("Canvas2DHighlightEffect"),Z.add("PreHighlight"),q.add("PreHighlightEffect"),Z.add("Canvas2DPreHighlight"),q.add("Canvas2DPreHighlightEffect"),t._mobileHighlight=!1):(Y.delete("Highlight"),Y.delete("Canvas2DHighlight"),Y.delete("PreHighlight"),Y.delete("Canvas2DPreHighlight")),this.useAuxiliaryAsForward=!1,this.multiView=!1,this.multiViewpoint=!1;let i=this.webgpu?W:H;if(this.renderer=new i({context:e.context,debugWebgl2:e.debugWebgl2||!1,alpha:!0,premultipliedAlpha:!1,antialias:!0===this.antiAliasing,canvas:this.canvas,divCSS:this.divCSS,visibleSpace:this.visibleSpace,preserveDrawingBuffer:e.preserveDrawingBuffer,debugContext:e.debugContext,sortRenderListByBuffer:!0,useCompositing:this.useCompositing}),this._needsPerformanceCheck=!1,!e.viewer.ODTMode){var n=this.renderer.getRendererInfo();t.IsFirefox&&(n.gpu="Unknown Firefox");var s=n.gpu;"true"!==localStorage.getItem("WebVisu_Renderer_Info")&&B&&(B.trackPageEvent({eventCategory:"WebVisualization",eventAction:"WebGL-GPU",eventLabel:s,appID:"WEBVISUALIZATION_FW",persDim:{pd1:e.viewer.getWidgetID()}}),localStorage.setItem("WebVisu_Renderer_Info",!0))}this.bgColor=void 0!==e.bgColor?e.bgColor:0,this.bgAlpha=void 0!==e.bgAlpha?e.bgAlpha:1,this.setBackgroundColor(this.bgColor,this.bgAlpha),this.renderTargetPool=D.get(this.renderer),this.renderer.renderTargetPool=this.renderTargetPool,this.useOffscreenCanvas?this.renderer.setGLSize(Math.max(2,this.canvas.width),Math.max(2,this.canvas.height),this.viewportWidth,this.viewportHeight,Math.max(2,this.canvas.width),Math.max(2,this.canvas.height)):this.renderer.setGLSize(this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight,this.cssWidth,this.cssHeight),this.renderer.setClearColor(new t.Color(0),0),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!this.useCompositing,this.renderer.autoClear=!1,this.renderer.shadowMapCascade=!1,this.renderer.packESM=!0,this.renderer._gpuPickingTolerance=2,this.renderer._smallTargetPicking=this.mobile,this.renderer._heuristicNormalRadius=15,this.gl=this.renderer.context,this.compPickingGPU=null,this.compDepth=null,this.compNormal=null,this.compNormalDepth=null,this.compMirror=null,this.compForward=null,this.composers=[],this.passPickingGPU=null,this.passDepth=null,this.passNormal=null,this.passColor=null,this.passNormalDepth=null,this.passMirrorBlur=null,this.passMirrorBlur1=null,this.passMirrorBlur2=null,this.passMirrorBlur3=null,this.clearScreenSpacePass=null,this.infPlanePass=null,this.mirrorBlendPass=null,this.zPostPass=null,this.forwardPass=null,this.ZOnlyPass=null,this.backgroundPass=null,this.passLightFullscreen=null,this.passLightProxy=null,this.XRevealStructureEffect=null,this.OITEffect=null,this.OITnoZEffect=null,this.PreHighlightEffect=null,this._PreHighlightMobileNonEffect=null,this.Canvas2DPreHighlightEffect=null,this.BokehDOFEffect=null,this.SkyScatteringEffect=null,this.BloomEffect=null,this.ToneMappingEffect=null,this.FlareEffect=null,this.HighlightEffect=null,this._HighlightMobileNonEffect=null,this.Canvas2DHighlightEffect=null,this.SSAOEffect=null,this.SSAOIterativeEffect=null,this.SSLReflectionEffect=null,this.SSLRefractionEffect=null,this.FXAAEffect=null,this.TexturePerformanceEffect=null,this.PixelShaderPerformanceEffect=null,this.SMAAEffect=null,this.MSAAEffect=null,this.TAAEffect=null,this.VolumeRenderingEffect=null,this.NoPowerOfTwoEffect=null,this.NativeOnTopEffect=null,this.DebugPassEffect=null,this.DebugShadowMapsEffect=null,this.customEffects=[],this.allEffects=[],this.effectStatusMap=new Map,this.renderer.sectionCappingEnabled=!1,this.meshesGPU={},this.positionsGPU={},this.normalsGPU={},this.positionsFloatGPU={},this.heuristicNormalsGPU={},this.currentGPUPickPosition={x:-1,y:-1};var a=t.FloatType,o=t.LinearFilter;this.renderer.supportsFloatTextures()||(a=t.UnsignedByteType),this.renderer.supportsFloatLinearTextures()||(o=t.NearestFilter),this.rtParamsFloatLinear={minFilter:o,magFilter:o,stencilBuffer:!0,format:t.RGBAFormat,type:a},this.rtParamsFloatNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:a},this.rtParamsFloatNearestStencilBuffer={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!0,format:t.RGBAFormat,type:a},this.rtParamsUByteNearest={minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByteWithStencilBuffer={minFilter:t.NearestFilter,magFilter:t.LinearFilter,stencilBuffer:!0,format:t.RGBAFormat,type:t.UnsignedByteType},this.rtParamsUByte2={minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBAFormat,type:t.UnsignedByteType},this.boundingBoxGPUCompute=new V(this);this.mainComposer=new r(this.renderer,void 0,this.renderTargetPool,["--\x3e(initClear)","initClearPass","--\x3einfPlane","infPlanePass","mirrorClearDepth","mirrorBlendPass","afterMirrorClearDepth","--\x3emain","backgroundPassCapping","backgroundPass","remoteImage_0","renderPriorityClear","renderPriorityStencilP4","renderPriorityStencilP3","renderPriorityStencilP2","renderPriorityStencilP1","renderPriorityStencilP0","renderPriorityDrawP3","renderPriorityDrawP2","renderPriorityDrawP1","renderPriorityDrawP0","passSectionCappingFrontFaces","cssPass","iso_0","forwardPass","iso_2","iso_3","zPostPass","ZOnlyPassCapping","ZOnlyPass","oitPass","--\x3edialog","dialogPass","fallBackOnTopPass","--\x3e(postEffects1)","passMirrorBlur","passMirrorBlur1","passMirrorBlur2","passMirrorBlur3","clearScreenSpacePass","compareModelPass","skyScatteringPass","BokehDOFEffect","--\x3enoz","nozClearPass","nozPass","oitnoZPass","--\x3e(postEffects2)","bloomPass","compositePass","VolumeRenderingEffect","FlareEffect","MSAAEffect","TAAEffect","--\x3enoEffectNoz","noEffectNozClearPass","noEffectNozPass","remoteImage_1","--\x3e(highlight)","HighlightEffect","PreHighlightEffect","highlightClearPass","highlightSinglePass","preHighlightSinglePass","DebugPassEffect","DebugShadowMapsEffect","--\x3eafterHighlightNoz","noEffectAfterHighlightNozClearPass","noEffectAfterHighlightNozPass","remoteImage_2","--\x3eonTop","onTopDepthSetPass","onTopPass","--\x3efurtive","furtiveClearPass","furtivePass","--\x3erobot","noEffectRobotClearPass","noEffectRobotPass","noEffectRobotOrthoPass","--\x3e(postEffects3)","FXAAEffect","SMAAEffect","--\x3ecanvas2D","noEffectCanvas2DClearPass","noEffectCanvas2DPass","Canvas2DHighlightEffect","Canvas2DPreHighlightEffect","Canvas2DhighlightClearPass","Canvas2DhighlightSinglePass","Canvas2DpreHighlightSinglePass","--\x3e(Graphics Optimizer)","TexturePerformance","PixelShaderPerformance"]),this.initForwardRender(),this.highlightPass=null,this.shadowComposerContext=null,this.pickingGPUComposerContext=null,this.pickingGPUInstancingComposerContext=null,this.normalComposerContext=null,this.depthComposerContext=null,this.normalDepthIoRRoughnessComposerContext=null,this.normalDepthComposerContext=null,this.outlineDepthComposerContext=null,this.mirrorOutlineDepthComposerContext=null,this.highlightDepthComposerContext=null,this.opaqueOnlyComposerContext=null,this.colorComposerContext=null,this.occlusionDepthComposerContext=null,this.clippingScene=null,this.clipPlaneInfos=null,this.superFinalComposer=null,this.customComposerContexts=null},_updateOITScene:function(e){this.OITEffect&&(this.OITEffect.revealPass.scene=e,this.OITEffect.accumPass.scene=e),this.OITnoZEffect&&(this.OITnoZEffect.revealPass.scene=e,this.OITnoZEffect.accumPass.scene=e)},initEffect:function(e){if(this.mobile&&!Z.has(e))return null;if(!this.useCompositing&&!Y.has(e))return null;var i=null;switch(e){case"xRevealStructure":this.XRevealStructureEffect=new N(this.renderer,this.renderTargetPool),i=this.XRevealStructureEffect;break;case"noPowerOfTwoEffect":this.NoPowerOfTwoEffect=new m(this.renderer,this.renderTargetPool),i=this.NoPowerOfTwoEffect;break;case"OIT":this.OITEffect=new O(this.renderer,this.renderTargetPool,this.forwardPass,"oitPass"),i=this.OITEffect;break;case"OITnoZ":this.OITnoZEffect=new O(this.renderer,this.renderTargetPool,this.nozPass,"oitnoZPass"),(i=this.OITnoZEffect).idString="noz";break;case"FXAA":this.FXAAEffect=new l(this.renderer,this.renderTargetPool),i=this.FXAAEffect;break;case"TexturePerformance":this.TexturePerformanceEffect=new z(this.renderer,this.renderTargetPool,z.MODE.TEXTURE),i=this.TexturePerformanceEffect;break;case"PixelShaderPerformance":this.PixelShaderPerformanceEffect=new z(this.renderer,this.renderTargetPool,z.MODE.PIXEL),i=this.PixelShaderPerformanceEffect;break;case"MSAA":this.MSAAEffect=new h(this.renderer,this.renderTargetPool),i=this.MSAAEffect;break;case"TAA":this.TAAEffect=new c(this.renderer,this.renderTargetPool),i=this.TAAEffect;break;case"SMAA":case"MLAA":this.SMAAEffect=new d(this.renderer,this.renderTargetPool),i=this.SMAAEffect;break;case"Highlight":this.HighlightEffect=t.__unrolledHighlight()?new p(this.renderer,this.renderTargetPool,null,""):new u(this.renderer,this.renderTargetPool,null,""),i=this.HighlightEffect;break;case"PreHighlight":this.PreHighlightEffect=new E(this.renderer,this.renderTargetPool,null,""),i=this.PreHighlightEffect;break;case"Canvas2DHighlight":this.Canvas2DHighlightEffect=t.__unrolledHighlight()?new p(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"):new u(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":this.Canvas2DPreHighlightEffect=new E(this.renderer,this.renderTargetPool,"canvas2D","Canvas2D"),i=this.Canvas2DPreHighlightEffect;break;case"SSAO":this.SSAOEffect=new f(this.renderer,this.renderTargetPool),i=this.SSAOEffect;break;case"SSAOIterative":this.SSAOIterativeEffect=new g(this.renderer,this.renderTargetPool),i=this.SSAOIterativeEffect;break;case"SSLRDirect":case"SSLReflection":this.SSLReflectionEffect=new v(this.renderer,this.renderTargetPool),i=this.SSLReflectionEffect;break;case"SSLRefraction":this.SSLRefractionEffect=new _(this.renderer,this.renderTargetPool),i=this.SSLRefractionEffect;break;case"VolumeRendering":this.VolumeRenderingEffect=new M(this.renderer,this.renderTargetPool,this.ODTMode),i=this.VolumeRenderingEffect;break;case"DOF":this.BokehDOFEffect=new y(this.renderer,this.renderTargetPool),i=this.BokehDOFEffect;break;case"Bloom":this.BloomEffect=new x(this.renderer,this.renderTargetPool,!1),i=this.BloomEffect;break;case"SkyScattering":this.SkyScatteringEffect=new S(this.renderer,this.renderTargetPool),i=this.SkyScatteringEffect;break;case"ToneMapping":this.ToneMappingEffect=new b(this.renderer,this.renderTargetPool),i=this.ToneMappingEffect;break;case"Flare":this.FlareEffect=new w(this.renderer,this.renderTargetPool),i=this.FlareEffect;break;case"DebugPass":this.DebugPassEffect=new C(this.renderer,this.renderTargetPool),i=this.DebugPassEffect;break;case"DebugShadowMaps":this.DebugShadowMapsEffect=new P(this.renderer,this.renderTargetPool),i=this.DebugShadowMapsEffect;break;case"NativeOnTop":this.NativeOnTopEffect=new U(this.renderer,this.renderTargetPool),i=this.NativeOnTopEffect}return null!==i&&(i.updateComposersName(e),i.setSize(this.viewportWidth,this.viewportHeight),i.initEffect(!this.useCompositing,this),this.allEffects.push(i)),i},setEffect:function(e,t){var i=null,r=!1;if((!this.mobile||Z.has(e))&&(this.useCompositing||Y.has(e))){switch(this.effectStatusMap.set(e,t),e){case"xRevealStructure":i=this.XRevealStructureEffect;break;case"OIT":i=this.OITEffect,r=!this.isDeviceCompatibleWithOIT();var n=t&&!r;this.zPostPass.isOITPass=n,this.forwardPass.isOITPass=n,this.renderer.useOIT=n;break;case"OITnoZ":i=this.OITnoZEffect,r=!this.isDeviceCompatibleWithOIT();n=t&&!r;this.nozPass.isOITPass=n,this.renderer.useOIT=n;break;case"FXAA":i=this.FXAAEffect,this.antiAliasing=t?e:"NoAA";break;case"TexturePerformance":i=this.TexturePerformanceEffect,t&&i&&i.resetScore();break;case"PixelShaderPerformance":i=this.PixelShaderPerformanceEffect,t&&i&&i.resetScore();break;case"MSAA":i=this.MSAAEffect,this.antiAliasing=t?e:"NoAA";break;case"TAA":i=this.TAAEffect,this.antiAliasing=t?e:"NoAA";break;case"SMAA":case"MLAA":i=this.SMAAEffect,this.antiAliasing=t?e:"NoAA";break;case"FSAA":case"SSAA":this.antiAliasing=t?e:"NoAA";break;case"Vignetting":i=this.ToneMappingEffect;break;case"Highlight":i=this.HighlightEffect;break;case"PreHighlight":i=this.PreHighlightEffect;break;case"Canvas2DHighlight":i=this.Canvas2DHighlightEffect;break;case"Canvas2DPreHighlight":i=this.Canvas2DPreHighlightEffect;break;case"SSAO":i=this.SSAOEffect,r=!this.isDeviceCompatibleWithSSAO(),this.renderer.useSSAO=t&&!r;break;case"SSAOIterative":i=this.SSAOIterativeEffect,r=!this.isDeviceCompatibleWithSSAO(),this.renderer.useSSAOIterative=t&&!r;break;case"SSLRDirect":case"SSLReflection":i=this.SSLReflectionEffect,r=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLR=t&&!r;break;case"SSLRefraction":i=this.SSLRefractionEffect,r=!this.isDeviceCompatibleWithSSR(),this.renderer.useSSLRefraction=t&&!r;break;case"VolumeRendering":i=this.VolumeRenderingEffect;break;case"DOF":i=this.BokehDOFEffect;break;case"Bloom":i=this.BloomEffect;break;case"ToneMapping":i=this.ToneMappingEffect;break;case"SkyScattering":i=this.SkyScatteringEffect;break;case"Flare":i=this.FlareEffect;break;case"DebugPass":i=this.DebugPassEffect;break;case"DebugShadowMaps":i=this.DebugShadowMapsEffect;break;case"NativeOnTop":i=this.NativeOnTopEffect}if(t&&!r&&(i||(i=this.initEffect(e))),null!==i){var s=t&&!r;"Vignetting"===e?i.setVignettingPower(s?10:0):i.setEnabled(s),this.compMirrorComposerContext&&"OIT"===e&&this.compMirrorComposerContext.enablePass(i.mixPass,this.renderer.useOIT)}this.setScale(!1),this.updateFinalComposer(!0)}},getCustomEffect:function(e){return this.customEffects[e]},addCustomEffect:function(e){if(!e)return-1;var t=this.customEffects.length;return this.customEffects.push(e),e.updateComposersName("customEffect_"+this.customEffects.length),e.setSize(this.viewportWidth,this.viewportHeight),e.initEffect(!this.useCompositing,this),t},setCustomEffect:function(e,t){var i=this.customEffects[e];null!==i&&(i.setEnabled(t),t&&i.setSize(this.viewportWidth,this.viewportHeight)),this.updateFinalComposer(!0)},updateEffects:function(e,t,i,r){this.XRevealStructureEffect&&this.XRevealStructureEffect.enabled&&this.XRevealStructureEffect.update("deferred",e,t),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.update("deferred",e,t,i),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.update("deferred",e,t,i),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.update("deferred",e,t,i),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.update("deferred",e,t,i),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.update("deferred",e,t,i),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.update("forward",e,t,i,r),this._HighlightMobileNonEffect&&this._HighlightMobileNonEffect.enabled&&this._HighlightMobileNonEffect.update(e),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.update("forward",e,t,i,r),this._PreHighlightMobileNonEffect&&this._PreHighlightMobileNonEffect.enabled&&this._PreHighlightMobileNonEffect.update(e),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.update("forward",e,t,i,r),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.update("forward",e,t,i,r),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.update("deferred",e,t),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.update("forward",e,t),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.update("forward",e,t,i),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.update("forward",e,t,i),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.update("deferred",e,t),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.update("deferred",e,t),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.update("deferred",e,t),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.update("forward",e,t);for(var n=0;n<this.customEffects.length;n++){var s=this.customEffects[n];s&&s.enabled&&s.update("forward",e,t)}},getMaxIterationEffects:function(){var e=0;return this.SSAOEffect&&this.SSAOEffect.enabled&&(e=Math.max(e,this.SSAOEffect.getMaxIteration())),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(e=Math.max(e,this.SSAOIterativeEffect.getMaxIteration())),this.MSAAEffect&&this.MSAAEffect.enabled&&(e=Math.max(e,this.MSAAEffect.getMaxIteration())),this.TAAEffect&&this.TAAEffect.enabled&&(e=Math.max(e,this.TAAEffect.getMaxIteration())),e},setRendererSize:function(e,t,i,r,n,s,a,o){if(this.cssWidth!==e||this.cssHeight!==t||this.devicePixelRatio!==s||i){this.devicePixelRatio=s,this.cssWidth=Math.max(2,e),this.cssHeight=Math.max(2,t),this.deviceWidth=Math.floor(s*this.cssWidth),this.deviceHeight=Math.floor(s*this.cssHeight),this.viewportWidth=Math.floor(s*Math.max(2,r)),this.viewportHeight=Math.floor(s*Math.max(2,n));var l=this.cssWidth,h=this.cssHeight;void 0!==a&&(l=Math.max(2,a)),void 0!==o&&(h=Math.max(2,o)),this.renderer.setGLSize(this.cssWidth,this.cssHeight,r,n,l,h),this.setScale(!0)}},setBackgroundColor:function(e,i){this.bgColor=e,this.bgAlpha=i;var r=new t.Color(this.bgColor);this.renderer._backgroundColor=r,this.useCompositing&&r.copyToLinear(r,this.renderer.simpleGamma),this.bgColor=r.getHex()},resetGSSOCache:function(){this.renderer.resetGSSOCache()},_createVirtualLight:function(e,i){var r=new t.DirectionalLight;return r.originalLight=e,r.target=e.target,r.isVirtual=!0,r.LiSPSM=e.LiSPSM,r.onlyShadow=!0,r.castShadow=!0,r.shadowCameraNear=e.shadowCameraNear,r.shadowCameraFar=e.shadowCameraFar,r.shadowCameraLeft=e.shadowCameraLeft,r.shadowCameraRight=e.shadowCameraRight,r.shadowCameraBottom=e.shadowCameraBottom,r.shadowCameraTop=e.shadowCameraTop,r.shadowCameraVisible=e.shadowCameraVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[i],r.shadowMapWidth=e.shadowCascadeWidth[i],r.shadowMapHeight=e.shadowCascadeHeight[i],r},_updateVirtualLight:function(e,t){var i=e.shadowCascadeArray[t];i.virtualLightIndex=t,i.position.copy(e.position),e.target?(i.target.position=e.target.position,i.lookAt(i.target.position)):i.rotation.setEulerFromRotationMatrix(e.matrixWorld,i.eulerOrder),i.shadowCameraVisible=e.shadowCameraVisible,i.shadowDarkness=e.shadowDarkness,i.shadowBias=e.shadowCascadeBias[t]},_computeNearFarFromConvexHull:function(e,i){for(var r=i.getPoints(),n=(r.length,1/0),s=-1/0,a=new t.Vector4,o=0;o<r.length;o++)a.copy(r[o]),a.applyMatrix4(e.matrixWorldInverse),-a.z<n&&(n=-a.z),-a.z>s&&(s=-a.z);return{near:n=Math.max(e.near,n),far:s}},_clipConvexHullFromNearFar:function(e,i,r,n,s){i.matrixWorld.elements;var a=e.matrixWorld.elements,o=new t.Vector3(a[8],a[9],a[10]),l=new t.Vector3(-a[8],-a[9],-a[10]),h=(new t.Vector3).copy(o).multiplyScalar(n).add(e.position),c=(new t.Vector3).copy(o).multiplyScalar(s).add(e.position),d=new t.Plane(o,-o.dot(h)),u=new t.Plane(l,-l.dot(c));return r.clipByPlanes([d,u])},_extrudeConvexHullAlongLightDir:function(e,i,r,n){var s=r.getPoints(),a=s.length,o=new t.CGPoly;o.setFromBox(i),o.applyMatrix4(n.matrixWorldInverse);for(var l=[],h=0;h<a;h++){var c=s[h].clone();c.applyMatrix4(n.matrixWorldInverse),l.push(c)}var d=(new t.Box3).setFromPoints(l).getPlanes();return o.clipByPlanes([d[0],d[1],d[2],d[3],d[4]])},_updateShadowCamera:function(e,i,r,n,s,a,o){var l=e.matrixWorld.elements,h=new t.Vector3(l[8],l[9],l[10]),c=i._getLightDirection(this.renderer.baseLightDirection);c.negate();var d=r.getPoints(),u=d.length,p=(new t.Box3).setFromPoints(d);if(i.LiSPSM){for(var f=h.dot(c),g=Math.sqrt(1-f*f),m=(n+Math.sqrt(n*s))/g,v=m+(T=Math.abs(p.max.y-p.min.y)),_=new t.Vector3(0,p.min.y-m,.5*(p.min.z+p.max.z)),y=0;y<u;y++){(b=d[y]).sub(_)}var S=0,x=0;for(y=0;y<u;y++){var b=d[y],w=Math.abs(m*b.x/b.y);(!S||w>S)&&(S=w);var M=Math.abs(m*b.z/b.y);(!x||M>x)&&(x=M)}_.applyMatrix4(o.matrixWorld),o.position.copy(_),o.matrix.elements[12]=o.position.x,o.matrix.elements[13]=o.position.y,o.matrix.elements[14]=o.position.z,o.matrixWorld.elements[12]=o.position.x,o.matrixWorld.elements[13]=o.position.y,o.matrixWorld.elements[14]=o.position.z,o.matrixWorldInverse.getInverse(o.matrixWorld);var C=(v+m)/(v-m),P=-2*v*m/(v-m),E=m/S,T=-m/x;o.projectionMatrix.set(E,0,0,0,0,C,0,P,0,0,T,0,0,1,0,0)}else o.left=p.min.x,o.right=p.max.x,o.top=p.max.y,o.bottom=p.min.y,o.near=-p.max.z,o.far=-p.min.z,o.updateProjectionMatrix()},computeShadows:function(e,i,r,n,s,a){var o,l,h,c,d,u,p,f,g=r,m=this.renderer,v=[],_=0;for(i.__lights.sort(i._lightSort),M=0,o=i.__lights.length;M<o;M++)if(((f=i.__lights[M]).castShadow||f.castGroundShadow)&&(!f.castShadow||a)&&!f.isVirtual)if(f instanceof t.DirectionalLight&&f.shadowCascade){for(l=f.shadowCascadeCount;l<f.shadowCascadeArray.length;l++){(y=f.shadowCascadeArray[l])&&(y.cameraHelper&&(y.cameraHelper.visible=!1),y.convexHullHelper&&(y.convexHullHelper.visible=!1))}for(l=0;l<f.shadowCascadeCount;l++){var y;f.shadowCascadeArray[l]?y=f.shadowCascadeArray[l]:((y=this._createVirtualLight(f,l)).originalCamera=S,f.shadowCascadeArray[l]=y,i.add(y)),this._updateVirtualLight(f,l),v[_]=y,_++}}else v[_]=f,_++;if(v.length){this.shadowComposerContext||this.initComposer("Shadow");var S=n[e];this.mainComposer.updateScene(i),this._updateOITScene(i),this.mainComposer.setComposerContext(this.shadowComposerContext);for(var x=new t.Frustum,b=(new t.Matrix4,new t.Vector3,new t.Vector3,new t.Vector3),w=[],M=0;M<129;M++){var C=t.RandomLib.LowDiscrepancy2D(M);w.push({x:C.x-.5,y:C.y-.5})}var P=m.materialToUse,E=this.disableBackFaceCulling,T=(g.isEnabled(g.BLEND),m.getScissorTest()),A=function(){m.materialToUse=t.MaterialToUse.shadowMapDepthMaterial,m.setDisableBackFaceCulling(!0),m.setDepthTest(!0),m.enableScissorTest(!1)},D=function(e){var i=m.getClearColor(),r=m.getClearAlpha();g.clearColor(i.r,i.g,i.b,r),m.setDisableBackFaceCulling(E),e?(m.enableScissorTest(T),m.materialToUse=P):m.materialToUse=t.MaterialToUse.originalMaterial};A();var I=null,R=null;if(i.boundingBox)I=i.boundingBox;else{for(var O=0;O<i.children.length;O++){var L=i.children[O];if(L.boundingSphere&&(R=L.boundingSphere),L.boundingBox){I=L.boundingBox;break}}!I&&R&&(I=R.getBoundingBox())}if(I){var V=new t.Matrix4;V.multiplyMatrices(S.projectionMatrix,S.matrixWorldInverse),x.setFromMatrix(V);var F=x.getCorners(),B=new t.CGPoly;B.setFromFrustumPoints(F);var N=I.getPlanes(),G=B.clipByPlanes(N),k=this,U=function(e){if(f.LiSPSM){var i=S.matrixWorld.elements,r=new t.Vector3(-i[8],-i[9],-i[10]),n=f._getLightDirection(k.renderer.baseLightDirection);n.negate();var s=new t.Vector3;s.crossVectors(n,r),(c=new t.Vector3).crossVectors(s,n),c.normalize();var a=new t.Vector3,o=new t.Vector3,l=new t.Vector3;l.crossVectors(n,c),l.normalize(),o.crossVectors(l,n),o.normalize(),a.copy(n),a.normalize(),e.position.getPositionFromMatrix(S.matrixWorld),e.up.copy(o),b.copy(e.position),b.add(a),e.lookAt(b)}else if(e.position.copy(f.position),f.target)e.lookAt(f.target.position);else if(f instanceof t.PointLight){var h,c;switch(ee){case 0:d=(new t.Vector3).set(1,0,0),h=(new t.Vector3).set(0,0,-1);break;case 1:d=(new t.Vector3).set(-1,0,0),h=(new t.Vector3).set(0,0,1);break;case 2:d=(new t.Vector3).set(0,1,0),h=(new t.Vector3).set(1,0,0);break;case 3:d=(new t.Vector3).set(0,-1,0),h=(new t.Vector3).set(1,0,0);break;case 4:d=(new t.Vector3).set(0,0,1),h=(new t.Vector3).set(1,0,0);break;case 5:d=(new t.Vector3).set(0,0,-1),h=(new t.Vector3).set(-1,0,0)}(c=new t.Vector3).crossVectors(h,d),c.normalize(),e.up.copy(c),e.lookAt((new t.Vector3).copy(f.position).add(d))}else{var d;(d=(new t.Vector3).copy(k.renderer.baseLightDirection).multiplyScalar(-1)).applyMatrix4((new t.Matrix4).extractRotation(f.matrixWorld)),e.lookAt((new t.Vector3).copy(f.position).add(d))}e.updateMatrix(),e.matrixWorld.copy(e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld),e.matrixWorldNeedsUpdate=!1,e.matrixAutoUpdate=!1},z=function(e){let t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))},H=function(e,t){let i=t.renderer.glSupports.maxTextureSize;t.mobile&&(i=1024);let r=Math.min(e.shadowMapWidth,i),n=Math.min(e.shadowMapHeight,i);if(e._occurrence&&e._occurrence.scene3js&&e._occurrence.scene3js.viewer){let t=e._occurrence.scene3js.viewer,i=e._occurrence._getViewpoint(),s=t._viewpointManager.getViewpointViewport(i);if(s){let e=s.width/(t.SCREEN_WIDTH*t.devicePixelRatio)*(s.height/(t.SCREEN_HEIGHT*t.devicePixelRatio));r=z(r*e),n=z(n*e)}}return[r,n]};for(M=0,o=v.length;M<o;M++){var W=!(f=v[M]).shadowMap,j=m.shadowMapType===t.ESMShadowMap||m.shadowMapType===t.ESMImprovedShadowMap,X=j&&!this.renderer.packESM,[q,Z]=H(f,this);if(f.shadowMap&&(W=X&&f.shadowMap.type===t.UnsignedByteType||!X&&f.shadowMap.type===t.FloatType),W){f.shadowMap&&f.shadowMap.dispose();var Y=t.LinearFilter;(m.shadowMapType===t.PCFSoftShadowMap||m.shadowMapType===t.ESMShadowMap&&!X)&&(Y=t.NearestFilter);var Q={minFilter:Y,magFilter:Y,type:X?t.FloatType:t.UnsignedByteType,format:t.RGBAFormat};f instanceof t.PointLight?(j&&(f.tempRT=new t.WebGLRenderTarget(q,Z,Q)),f.shadowMap=new t.WebGLRenderTargetCube(q,Z,Q)):f.shadowMap=new t.WebGLRenderTarget(q,Z,Q),f.shadowMapSize=new t.Vector2(q,Z),f.shadowMatrix=new t.Matrix4}if(m.transparentShadowEnabled&&!f.transparentShadowMap){Q={minFilter:Y=t.LinearFilter,magFilter:Y,type:t.UnsignedByteType,format:t.RGBAFormat};f instanceof t.PointLight?f.transparentShadowMap=new t.WebGLRenderTargetCube(q,Z,Q):f.transparentShadowMap=new t.WebGLRenderTarget(q,Z,Q),f.transparentShadowMap.shareDepthFrom=f.shadowMap}var K=[],$=[];if(f instanceof t.SpotLight)f.shadowCamera||(f.shadowCamera=new t.PerspectiveCamera(f.shadowCameraFov,q/Z,f.shadowCameraNear,f.shadowCameraFar,m.use_webgpu),f.transparentShadowCamera=new t.PerspectiveCamera,f.transparentShadowCamera.setWebGPU(m.use_webgpu),m.autoUpdateScene&&i.updateMatrixWorld()),K=[f.shadowCamera],$=[f.transparentShadowCamera];else if(f instanceof t.DirectionalLight)f.shadowCamera||(f.shadowCamera=new t.OrthographicCamera(f.shadowCameraLeft,f.shadowCameraRight,f.shadowCameraTop,f.shadowCameraBottom,f.shadowCameraNear,f.shadowCameraFar,m.use_webgpu),f.transparentShadowCamera=new t.OrthographicCamera,f.transparentShadowCamera.setWebGPU(m.use_webgpu),m.autoUpdateScene&&i.updateMatrixWorld()),K=[f.shadowCamera],$=[f.transparentShadowCamera];else{if(!(f instanceof t.PointLight)){console.error("Unsupported light type for shadow");continue}if(!f.shadowCameras){f.shadowCameras=[],f.transparentShadowCameras=[];for(M=0;M<6;M++){f.shadowCameras.push(new t.PerspectiveCamera(f.shadowCameraFov,q/Z,f.shadowCameraNear,f.shadowCameraFar,m.use_webgpu));let e=new t.PerspectiveCamera;e.setWebGPU(m.use_webgpu),f.transparentShadowCameras.push(e)}m.autoUpdateScene&&i.updateMatrixWorld()}K=f.shadowCameras,$=f.transparentShadowCameras}for(var J=f.updateShadowMap,ee=0;ee<K.length;ee++){if(A(),u=K[ee],p=$[ee],f instanceof t.PointLight&&(f.shadowMap.activeCubeFace=ee,f.transparentShadowMap&&(f.transparentShadowMap.activeCubeFace=ee),f.updateShadowMap=J),m.renderIteration>2){var te=f.offsetShadowCamera;te?u=K[ee].clone(te):(u=K[ee].clone(),f.offsetShadowCamera=u);var ie=Math.abs(K[ee].right-K[ee].left),re=Math.abs(K[ee].top-K[ee].bottom);u.left=K[ee].left+w[m.renderIteration].x*ie/q,u.right=K[ee].right+w[m.renderIteration].x*ie/q,u.bottom=K[ee].bottom+w[m.renderIteration].y*re/Z,u.top=K[ee].top+w[m.renderIteration].y*re/Z,u.updateProjectionMatrix()}if(f.shadowCameraVisible&&!f.cameraHelper&&(f.cameraHelper=new t.CameraHelper(K[ee]),f.cameraHelper.matrixAutoUpdate=!1,i.add(f.cameraHelper)),m.renderIteration<=2)if(f.isVirtual){if(!f.originalLight.updateShadowMap)continue}else if(!f.updateShadowMap)continue;if(!f.castGroundShadow||f.updateShadowMap){f.isVirtual?f.updateMatrix():f.updateShadowMap=!1,h=f.shadowMap,c=f.transparentShadowMap,d=f.shadowMatrix,U(u);var ne=G.clone(),se={near:S.near,far:S.far};if(f.isVirtual){se=this._computeNearFarFromConvexHull(S,ne);var ae=f.originalLight.shadowCascadeCount,oe=f.originalLight.shadowCascadeSubNear&&f.originalLight.shadowCascadeSubNear[M],le=f.originalLight.shadowCascadeSubFar&&f.originalLight.shadowCascadeSubFar[M];void 0===oe&&(oe=-Math.exp((1-f.virtualLightIndex/ae)*Math.log(se.near)+f.virtualLightIndex/ae*Math.log(se.far))),void 0===le&&(le=-Math.exp((1-(1+f.virtualLightIndex)/ae)*Math.log(se.near)+(1+f.virtualLightIndex)/ae*Math.log(se.far))),se.near=oe,se.far=le,ne=this._clipConvexHullFromNearFar(S,f,ne,se.near,se.far),ne=this._extrudeConvexHullAlongLightDir(f,I,ne,u)}else ne=this._extrudeConvexHullAlongLightDir(f,I,ne,u);if((f.isVirtual||f.LiSPSM)&&this._updateShadowCamera(S,f,ne,se.near,se.far,i,u),f.shadowCameraVisible)if(ne.applyMatrix4(u.matrixWorld),f.convexHullHelper){if(f.shadowCameraHelperToUpdate){var he=new t.Color(255),ce=[new t.Color(16711680),new t.Color(65280),new t.Color(255)];f.isVirtual&&(he=f.virtualLightIndex<3?ce[f.virtualLightIndex]:(new t.Color).setRGB(0,0,.1*f.virtualLightIndex)),f.convexHullHelper.update(ne,he)}}else f.convexHullHelper=new t.CGPolyHelper(ne),i.add(f.convexHullHelper);if(f.convexHullHelper&&(f.convexHullHelper.visible=f.shadowCameraVisible),f.cameraHelper&&(f.cameraHelper.visible=f.shadowCameraVisible),f.shadowCameraVisible&&(f.shadowCameraHelperToUpdate?(f.cameraHelper.update(),f.cameraHelper.matrixWorld=K[ee].matrixWorld,f.cameraHelper.toUpdate=!0):f.cameraHelper.toUpdate&&(f.cameraHelper.matrixWorld=(new t.Matrix4).copy(K[ee].matrixWorld),f.cameraHelper.matrixWorldNeedsUpdate=!1,f.cameraHelper.toUpdate=!1),f.cameraHelper.matrix.copy(f.cameraHelper.matrixWorld)),d.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),d.multiply(u.projectionMatrix),f.castGroundShadow)d.multiply(u.matrixWorldInverse),f._matrixWorldReceiver&&d.multiply(f._matrixWorldReceiver);else{var de=(new t.Matrix4).copy(u.matrixWorldInverse);de.setPosition(new t.Vector3(0,0,0)),d.multiply(de)}if(j&&f instanceof t.PointLight?m.setRenderTarget(f.tempRT):m.setRenderTarget(h),j&&f instanceof t.PointLight?this.shadowComposerContext.writeBuffer=f.tempRT:this.shadowComposerContext.writeBuffer=h,j?X?g.clearColor(Math.exp(80),1,1,1):g.clearColor(.1836426750336792,.28627450980392155,.5529411764705882,.13725490196078433):g.clearColor(1,1,1,1),m.clear(),this.mainComposer.render(void 0,void 0,{main:u,mainNoJittering:u},s),m.transparentShadowEnabled){u.clone(p);var ue=function(e){return!e.hasTranspar};this.zPostPass.setDLsToDisableFunc(ue),this.forwardPass.setDLsToDisableFunc(ue),this.ZOnlyPass.setDLsToDisableFunc(ue),this.backgroundPass.setDLsToDisableFunc(ue),m.materialToUse=t.MaterialToUse.transparentShadowMaterial,m.setDisableBackFaceCulling(!1),m.setDepthTest(!0),m.setDepthWrite(!1),m.enableScissorTest(!1),m.setRenderTarget(c),this.shadowComposerContext.writeBuffer=c,g.clearColor(1,1,1,1),m.clear(!0,!1,!1),this.mainComposer.render(void 0,void 0,{main:p,mainNoJittering:p},s),this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null)}(f.castGroundShadow||j)&&(D(),!f.castGroundShadow&&j?(m.esmEffect.setSize(f.shadowMap.width,f.shadowMap.height),f instanceof t.PointLight?m.esmEffect.setInput(f.tempRT):m.esmEffect.setInput(f.shadowMap),m.esmEffect.passBlurV.setForceRenderTarget(f.shadowMap),m.esmEffect.execute()):f.castGroundShadow&&f.blurShadowEffect&&(f.blurShadowEffect.setSize(512,512),f.blurShadowEffect.setInput(f.shadowMap,d),f.blurShadowEffect.execute(),f.groundMaterial&&f.groundMaterial.updatePDSFXUniform("groundShadow",f.blurShadowEffect.getResult())))}}}D(!0)}}},_applyPickingPriorityMappingToAllPasses:function(e,t,i,r,n){if(e)for(var s=0;s<r.length;s++){var a=r[s];if(a&&a.id&&a.id.startsWith("R")){var o=a._getStateSortingResult(n,this.renderer,i);o&&this.renderer.setPickingPriorityMapping(t,o)}}},computeIntersectionGPU_old:function(e,i,r,n,s,a,o,l,h,c,d){this.gl;var u,p=e.scene,f={},g=new Array,m=i.camera,v={main:m,mainNoJittering:m,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION,!1),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION),this.pickingGPUComposerContext||this.initComposer("PickingGPU"),this.renderer.gammaInput=!1;var _=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(p),this._updateOITScene(p),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var y=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var S=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(h,h,m,S,this.pickingGPUComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(h,null,m,S,this.pickingGPUComposerContext);var x,b,w=this.computeMeshPick(e,r,s,h,d),M=w.tab;for(u=0;u<M.length;++u){if((P=M[u])&&P._instancingInfos&&P._instancingInfos.isInstanceNode3D&&"instance"===P._instancingInfos.instancingSelectionMode){x=x||new t.Scene;var C=P.clone();P.copyInstancingInfos(C),x.add(C),C._occurrence=P._occurrence,C._ratioData=P._ratioData}}for(n=n||c&&x,x&&(null===this.pickingGPUInstancingComposerContext&&this.initComposer("PickingGPUInstancing"),this.renderer.autoUpdateScene=!0,x.updateMatrixWorld(),this.mainComposer.updateScene(x),this._updateOITScene(x),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,v,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,b=this.computeInstancePick(e,r,s),this.pickingGPUInstancingComposerContext.needsUpdate=!0,x.dispose(),x=null),u=0;u<M.length;++u){var P;if(P=M[u])if(b&&b.has(P))b.get(P).forEach(function(e){var t={};t.object=P,t.type=w.type,t.instanceId=e,g.push(t)});else(f={}).object=P,f.type=w.type,g.push(f)}if(g.length||g.push({object:null}),n){var E=p;this.normalComposerContext||this.initComposer("Normal"),this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,E.updateMatrixWorld(),this.mainComposer.updateScene(E),this._updateOITScene(E),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.normalComposerContext.needsUpdate=!1,this.computeNormalPick(g,m,w.outMouse),this.renderer.autoUpdateScene=!0,E.updateMatrixWorld(),this.mainComposer.updateScene(E),this._updateOITScene(E),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,v,"main"),this.depthComposerContext.needsUpdate=!1;var T=g[0].object&&g[0].object._occurrence?g[0].object._occurrence.node:null,A="";T&&""!==(A=T._getPickingCameraName())&&(m=i[A]),this.computePositionPick(g,m,w.outMouse,d)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=_,this.renderer.renderHiddenEdges=y,this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION),g},computeIntersectionGPU:function(e,i,r,n,s,a,o,l,h,c,d,u,p){this.gl;var f,g,m=e.scene,v={},_=new Array,y=this.renderer.getViewport(),S=y.width,x=y.height,b=Math.round(r.xPix),w=Math.round(r.yPix),M=i.camera,C={main:M,mainNoJittering:M,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};if(u){var P=null;let e=2*this.gpuPickingTolerance+1;this.renderer.setViewport(0,0,e,e),this.renderer.setScissor(0,0,e,e),M.fullWidth&&(P={fullWidth:M.fullWidth,fullHeight:M.fullHeight,x:M.x,y:M.y,width:M.width,height:M.height}),C.main.useRealSize=!0,C.connectedRobotCamera.useRealSize=!0,C.robotCameraOrtho.useRealSize=!0;var E=this.gpuPickingTolerance,T=this.gpuPickingTolerance,A=0,D=0;if(s&&r.pt&&(A=Math.round(Math.abs(r.xPix-r.pt.xPix)),D=Math.round(Math.abs(r.yPix-r.pt.yPix))),P){var I,R;I=P.width/P.fullWidth,R=P.height/P.fullHeight;var O=P.fullWidth/S,L=P.fullHeight/x;S=P.fullWidth,x=P.fullHeight,w*=L,b=(b*=O)*I+P.x,w=w*R+P.y,E*=I,T*=R,A*=I,D*=R}b-=y.x,w-=this.deviceHeight-(y.height+y.y);var V=s&&0!==A?A:2*E+1,F=s&&0!==D?D:2*T+1,B=s?b:b-E,N=s?w:w-T;i._setPickingViewOffset({cameraSet:C,fullHeight:x,fullWidth:S,x:B,y:N-1,width:V,height:F,pickingRatioW:V/y.width,pickingRatioH:F/y.height})}if(u?(this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION_SMALL,!1),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION_SMALL)):(this.renderer.increaseFrameCount(t._FrameTypes.GPU_INTERSECTION,!1),this.renderer.info.renderTime.pushRoot(t._FrameTypes.GPU_INTERSECTION)),3!==n){this.pickingGPUComposerContext||this.initComposer("PickingGPU",u),s&&u&&this.pickingGPUComposerContext.setSize(A,D);var G=!1;u&&(G=!!s,this.currentGPUPickPosition.x==b&&this.currentGPUPickPosition.y==w||(this.currentGPUPickPosition.x=b,this.currentGPUPickPosition.y=w,G=!0)),this.renderer.gammaInput=!1;var k=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.mainComposer.updateScene(m),this._updateOITScene(m),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.materialToUse=t.MaterialToUse.pickingMaterial;var U=this.renderer.renderHiddenEdges;this.renderer.renderHiddenEdges=!1,this.mainComposer.setComposerContext(this.pickingGPUComposerContext);var z=this.pickingGPUComposerContext.composer.getAllPasses();this._applyPickingPriorityMappingToAllPasses(h,h,M,z,this.pickingGPUComposerContext),this.pickingGPUComposerContext.needsUpdate=G||this.pickingGPUComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.pickingGPUComposerContext.needsUpdate=!1,this._applyPickingPriorityMappingToAllPasses(h,null,M,z,this.pickingGPUComposerContext);var H,W,j=(g=u?this.computeMeshPickSmallTarget(e,r,s,h,d):this.computeMeshPick(e,r,s,h,d)).tab;for(f=0;f<j.length;++f){if((q=j[f])&&q._instancingInfos&&q._instancingInfos.isInstanceNode3D&&"instance"===q._instancingInfos.instancingSelectionMode){H=H||new t.Scene;var X=q.clone();q.copyInstancingInfos(X),H.add(X),X._occurrence=q._occurrence,X._ratioData=q._ratioData}}for(n=n||c&&H,H&&(this.pickingGPUInstancingComposerContext||this.initComposer("PickingGPUInstancing",u),s&&u&&this.pickingGPUInstancingComposerContext.setSize(A,D),this.renderer.autoUpdateScene=!0,H.updateMatrixWorld(),this.mainComposer.updateScene(H),this._updateOITScene(H),this.renderer.materialToUse=t.MaterialToUse.pickingMaterialInstancing,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.pickingGPUInstancingComposerContext),this.pickingGPUInstancingComposerContext.needsUpdate=!0,this.mainComposer.render(void 0,void 0,C,"main"),this.pickingGPUInstancingComposerContext.needsUpdate=!1,W=u?this.computeInstancePickSmallTarget(e,r,s):this.computeInstancePick(e,r,s),this.pickingGPUInstancingComposerContext.needsUpdate=!0,H.dispose(),H=null),f=0;f<j.length;++f){var q;if(q=j[f])if(W&&W.has(q))W.get(q).forEach(function(e){var t={};t.object=q,t.type=g.type,t.instanceId=e,_.push(t)});else(v={}).object=q,v.type=g.type,_.push(v)}}if(_.length||_.push({object:null}),n&&n<2){this.normalComposerContext||this.initComposer("Normal",u),this.depthComposerContext||this.initComposer("Depth",u),s&&u&&i._setPickingViewOffset({cameraSet:C,fullHeight:y.height,fullWidth:y.width,x:b-E,y:w-T-1,width:2*E+1,height:2*T+1}),this.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),this.mainComposer.updateScene(m),this._updateOITScene(m),this.renderer.materialToUse=t.MaterialToUse.normalMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.normalComposerContext),this.normalComposerContext.needsUpdate=G||this.normalComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.normalComposerContext.needsUpdate=!1,u?this.computeNormalPickSmallTarget(_,M,g.outMouse):this.computeNormalPick(_,M,g.outMouse),this.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),this.mainComposer.updateScene(m),this._updateOITScene(m),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.depthComposerContext.needsUpdate=G||this.depthComposerContext.needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.depthComposerContext.needsUpdate=!1;var Z="";(Y=_[0].object&&_[0].object._occurrence?_[0].object._occurrence.node:null)&&""!==(Z=Y._getPickingCameraName())&&(M=i[Z]),u?this.computePositionPickSmallTarget(_,M,g.outMouse,d):this.computePositionPick(_,M,g.outMouse,d)}if(n>=2&&!s){this.gpuPositionComposerContext||this.initComposer("GPUPosition",u),this.renderer.autoUpdateScene=!0,m.updateMatrixWorld(),this.mainComposer.updateScene(m),this._updateOITScene(m),this.renderer.materialToUse=t.MaterialToUse.gpuPositionMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,g||(g={outMouse:r});let e=[],n=g.outMouse.xPix,s=g.outMouse.yPix,a=n-this.heuristicNormalRadius,o=s-this.heuristicNormalRadius,l=2*this.heuristicNormalRadius+1,h=2*this.heuristicNormalRadius+1,c=this.viewportHeight;if(this.renderer.supportsDrawBuffers()){this.mainComposer.setComposerContext(this.gpuPositionComposerContext[0]),this.gpuPositionComposerContext[0].needsUpdate=G||this.gpuPositionComposerContext[0].needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.gpuPositionComposerContext[0].needsUpdate=!1;let i=this.gpuPositionComposerContext[0].getResult("main");for(let t=0;t<3;t++){let r=new Uint8Array(4*l*h);t>0&&this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,i.__webglMRTFramebuffers[t-1]),u?this.gl.readPixels(0,0,l,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r):this.gl.readPixels(a,c-o-h+1,l,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r),e[t]=new Float32Array(r.buffer)}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t.glStates.currentFramebuffer)}else for(let i=0;i<3;i++){switch(this.mainComposer.setComposerContext(this.gpuPositionComposerContext[i]),i){case 0:this.renderer._positionComponent=new t.Vector3(1,0,0);break;case 1:this.renderer._positionComponent=new t.Vector3(0,1,0);break;case 2:this.renderer._positionComponent=new t.Vector3(0,0,1)}this.gpuPositionComposerContext[i].needsUpdate=G||this.gpuPositionComposerContext[i].needsUpdate,this.mainComposer.render(void 0,void 0,C,"main"),this.gpuPositionComposerContext[i].needsUpdate=!1;let r=new Uint8Array(4*l*h);u?this.gl.readPixels(0,0,l,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r):this.gl.readPixels(a,c-o-h+1,l,h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r),e[i]=new Float32Array(r.buffer)}var Y;Z="";(Y=_[0].object&&_[0].object._occurrence?_[0].object._occurrence.node:null)&&""!==(Z=Y._getPickingCameraName())&&(M=i[Z]),this.computeFloatPositionPick(_,M,g.outMouse,e,p)}return this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=k,this.renderer.renderHiddenEdges=U,u&&(i._setPickingViewOffset({cameraSet:C,reset:!0}),P&&i.setViewOffset(P,!0)),this.renderer.setViewport(y.x,y.y,y.width,y.height),C.main.useRealSize=!1,C.connectedRobotCamera.useRealSize=!1,C.robotCameraOrtho.useRealSize=!1,s&&u&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)),u?this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION_SMALL):this.renderer.info.renderTime.popRoot(t._FrameTypes.GPU_INTERSECTION),_},computeDepthBuffer:function(e,i,r){var n={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho},s=e.scene;this.depthComposerContext||this.initComposer("Depth"),r&&(this.depthComposerContext.needsUpdate=!0),this.renderer.gammaInput=!1;var a=this.renderer.gammaOutput;this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoUpdateScene=!0,s.updateMatrixWorld(),this.mainComposer.updateScene(s),this._updateOITScene(s),this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,n,"main"),this.depthComposerContext.needsUpdate=!1,this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=a},computePositionGPU:function(e,i,r){this.gl;var n=e.scene,s=[],a={main:i.camera,mainNoJittering:i.camera,connectedRobotCamera:i.connectedRobotCamera,robotCameraOrtho:i.robotCameraOrtho};this.renderer.gammaInput=!1;var o=this.renderer.gammaOutput;return this.renderer.gammaOutput=!1,this.renderer.autoClear=!1,this.renderer.lensFlareEnabled=!1,this.depthComposerContext||this.initComposer("Depth"),this.renderer.autoUpdateScene=!0,n.updateMatrixWorld(),this.mainComposer.updateScene(n),this._updateOITScene(n),this.renderer.materialToUse=t.MaterialToUse.depthMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.mainComposer.setComposerContext(this.depthComposerContext),this.mainComposer.render(void 0,void 0,a,"main"),this.depthComposerContext.needsUpdate=!1,s[0]={point:null},this.computePositionPick(s,camera,r,replayMode),this.renderer.lensFlareEnabled=!0,this.renderer.gammaOutput=o,s[0].point},overrideUpdate:function(e){var t=e.root._getViewer();if(e.root._getTreeModified()&&t.getCurrentSceneGraphState()&&function(){var t,i=e.root._occurrences;for(t=0;t<i.length;t++)i[t].requestOverridesUpdate()}(),e.root._getTreeModified()&&t._sceneGraphOverrideSetManager&&t._sceneGraphOverrideSetManager._updateOverridesWithMissingTarget(t),e.root._tryOverridesUpdate(t),e.root._getTreeModified()){var i=new Set;e.root.traverseUnique(function(e){if(!e._getTreeModified())return!0;i.add(e)}),i.forEach(function(e){e.__setTreeModified(!1)})}},renderRealDepth:function(e,t,i,r,n,s,a,o){this.outlineDepthComposerContext||(this.initComposer("OutlineDepth"),this.initComposer("MirrorOutlineDepth")),this.renderer.dBuffer=this.renderRealDepth_internal(e,t,i,r,n,s,a,o?this.mirrorOutlineDepthComposerContext:this.outlineDepthComposerContext,!1)},renderOcclusionRealDepth:function(e,t,i,r,n,s,a){return this.occlusionDepthComposerContext||this.initComposer("OcclusionDepth"),this.renderRealDepth_internal(e,t,i,r,n,s,a,this.occlusionDepthComposerContext,!0)},renderRealDepth_internal:function(e,i,r,n,s,a,o,l,h){l.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i);var c=this.renderer.supportsFloatTextures();this.renderer.materialToUse=c&&!h?t.MaterialToUse.normalDepthMaterial:t.MaterialToUse.depthRGBAMaterial,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),this.renderer.lensFlareEnabled=!1;var d=function(e){return!e.hasOcclusionDepth};return this.zPostPass.setDLsToDisableFunc(d),this.forwardPass.setDLsToDisableFunc(d),this.ZOnlyPass.setDLsToDisableFunc(d),this.backgroundPass.setDLsToDisableFunc(d),l.setPassClear(this.initClearPass,!0,new t.Color(0),0),l.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(l),this._disableScissorForPostPro(),this.renderer.initWebGLObjects(i),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),this.renderer.lensFlareEnabled=!0,this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null),this.mainComposer.getRenderResult("main")},renderOpaqueScene:function(e,i,r,n,s,a){this.opaqueOnlyComposerContext||this.initComposer("Opaque");var o=this.renderer;this.opaqueOnlyComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),o.materialToUse=t.MaterialToUse.originalMaterial,o.autoClearDepth=!0,o.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),o.lensFlareEnabled=!1;var l=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var h=this.renderer.renderLineMode;this.renderer.renderLineMode=0;var c=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.opaqueOnlyComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.opaqueOnlyComposerContext.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(this.opaqueOnlyComposerContext),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),o.lensFlareEnabled=!0,this.renderer.renderFaceMode=l,this.renderer.renderLineMode=h,this.renderer.renderPointMode=c},renderColorScene:function(e,i,r,n,s,a){this.colorComposerContext||this.initComposer("Color");var o=this.renderer;this.colorComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),o.materialToUse=t.MaterialToUse.originalMaterial,o.autoClearDepth=!0,o.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),o.lensFlareEnabled=!1;var l=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var h=this.renderer.renderLineMode;this.renderer.renderLineMode=0;var c=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.colorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.colorComposerContext.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(this.colorComposerContext),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),o.lensFlareEnabled=!0,this.renderer.renderFaceMode=l,this.renderer.renderLineMode=h,this.renderer.renderPointMode=c},renderPoliteDepth:function(e,i,r,n,s,a,o){this.highlightDepthComposerContext||this.initComposer("HighlightDepth");var l=this.renderer;this.highlightDepthComposerContext.setCameraName(e),this.mainComposer.updateScene(i),this._updateOITScene(i),l.materialToUse=t.MaterialToUse.depthRGBAMaterial,l.autoClearDepth=!0,l.autoClearStencil=!0,r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.stencilFunc(r.ALWAYS,1,4294967295),r.clearStencil(0),l.lensFlareEnabled=!1;var h=function(e){return!e.hasPoliteDepth};this.zPostPass.setDLsToDisableFunc(h),this.forwardPass.setDLsToDisableFunc(h),this.ZOnlyPass.setDLsToDisableFunc(h),this.backgroundPass.setDLsToDisableFunc(h),this.highlightDepthComposerContext.setPassClear(this.initClearPass,!0,new t.Color(16777215),1),this.highlightDepthComposerContext.enableRenderCuttingElementsPasses(a),this.mainComposer.setComposerContext(this.highlightDepthComposerContext),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,n,s),this._enableScissorPostPostPro(),l.politeDepthBuffer=this.mainComposer.getRenderResult("main"),l.lensFlareEnabled=!0,this.zPostPass.setDLsToDisableFunc(null),this.forwardPass.setDLsToDisableFunc(null),this.ZOnlyPass.setDLsToDisableFunc(null),this.backgroundPass.setDLsToDisableFunc(null)},_disableScissorForPostPro:function(){this.renderer.splitScreenMode&&(Q=this.renderer.getScissorTest(),this.renderer.enableScissorTest(!1),K=this.renderer.getViewport(),this.renderer.setViewport(0,0,K.width,K.height))},_enableScissorPostPostPro:function(){this.renderer.splitScreenMode&&(this.renderer.setViewport(K.x,K.y,K.width,K.height),this.renderer.enableScissorTest(Q))},renderPostEffectNormalDepth:function(e,i,r,n,s,a,o){this.mainComposer.updateScene(r),this._updateOITScene(r),this.renderer.materialToUse=i,this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.stencilFunc(n.ALWAYS,1,4294967295),n.clearStencil(0),this.renderer.lensFlareEnabled=!1,e.setPassClear(this.initClearPass,!0,new t.Color(0),0),e.enableRenderCuttingElementsPasses(o),this.mainComposer.setComposerContext(e),this._disableScissorForPostPro(),this.mainComposer.render(void 0,void 0,s,a),this._enableScissorPostPostPro(),this.renderer.lensFlareEnabled=!0},render:function(e,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x){this.renderer.renderIteration=m,this.renderer.increaseFrameCount(t._FrameTypes.MAIN,x),this.renderer.info.renderTime.pushRoot(t._FrameTypes.MAIN),s.mainNoJittering=s.main;var b=this.MSAAEffect&&this.MSAAEffect.enabled,w=this.TAAEffect&&this.TAAEffect.enabled,M=b||w,C=M?w?this.TAAEffect:this.MSAAEffect:null;if(this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.iterative){var P=null;M&&(P=C.computeJitterValues(s.main,m)),s.main=this.BokehDOFEffect.computeJitterCamera(s.main,m,P),s.cameraBackground=this.BokehDOFEffect.computeJitterCamera(s.cameraBackground,m,P)}else M&&(X++,X%=128,s.main=C.computeJitterCamera(s.main,m||X),s.cameraBackground=C.computeJitterCamera(s.cameraBackground,m||X),s.mirrorCamera&&(s.mirrorCamera=C.computeJitterCamera(s.mirrorCamera,m)));this.overrideUpdate(a,d);var E,T,A,D,I,R=this.gl;this.renderer.gammaInput=!0,this.renderer.materialToUse=t.MaterialToUse.originalMaterial,A=a.scene;!u&&(h||this.renderer.getViewportSize().width===this.viewportWidth&&(this.renderer.getViewportSize().height,this.viewportHeight)),WUX.Selection.HSOManager,WUX.Selection.PSOManager;D=(this.HighlightEffect||this.Canvas2DHighlightEffect)&&!y,I=this.PreHighlightEffect||this.Canvas2DPreHighlightEffect,this.HighlightEffect&&this.HighlightEffect.setEnabled(D),D&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.setEnabled(D),D&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),I&&this.PreHighlightEffect.setEnabled(I),I&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),I&&this.Canvas2DPreHighlightEffect.setEnabled(I),I&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,this.renderTargetPool),this.updateFinalComposer(h);var O=!1;if(!c||!this.useCompositing||!this.highlightPass||this.renderer._requestPoliteDepthBuffer&&null===this.renderer.politeDepthBuffer){if(this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.needsUpdate=!0,this.meshesGPU={}),this.normalComposerContext&&(this.normalComposerContext.needsUpdate=!0,this.normalsGPU={}),this.depthComposerContext&&(this.depthComposerContext.needsUpdate=!0,this.positionsGPU={}),this.gpuPositionComposerContext){for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].needsUpdate=!0;this.positionsFloatGPU={},this.heuristicNormalsGPU={}}if(this.currentGPUPickPosition={x:-1,y:-1},this.renderer.reflectionColorBuffer=null,this.renderer.refractionColorBuffer=null,this.renderer.aoBuffer=null,this.renderer.autoUpdateScene=!0,A.updateMatrixWorld(),this.renderer.initWebGLObjects(A),this.useAuxiliaryAsForward||(this.updateClippingGlobals(a,A,this,S),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(O=!0),O&&this.updateSectionCappingScene(a,A)),this.afterMirrorClearDepth&&this.afterMirrorClearDepth.setClearStencil(O),!this.useAuxiliaryAsForward){this.renderer.shadowMapEnabled=r,this.renderer.shadowMapSoft=r,this.computeShadows("main",A,R,s,_,r),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;let e=this.multiView||m<3||v;var L=!1,V=!1;e&&(this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled)&&(this.renderer._pbrCheck={has:!1,hasTransparent:!1},this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.renderPostEffectNormalDepth(this.normalDepthIoRRoughnessComposerContext,t.MaterialToUse.normalDepthIoRRoughnessMaterial,A,R,s,_,O),L=this.renderer._pbrCheck.has,V=this.renderer._pbrCheck.hasTransparent,this.renderer._pbrCheck=null);var F=e&&(this.SSAOEffect&&this.SSAOEffect.enabled||this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled||this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&!this.BokehDOFEffect.iterative||A.__webglFlares&&A.__webglFlares.length||this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&V);(F=F||this.TAAEffect&&this.TAAEffect.enabled||this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&(1===m||m>1&&this.MSAAEffect&&this.MSAAEffect.enabled))&&(this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.renderPostEffectNormalDepth(this.normalDepthComposerContext,t.MaterialToUse.normalDepthMaterial,A,R,s,_,O)),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled?(this._disableScissorForPostPro(),this.renderer.aoBuffer=this.SSAOIterativeEffect.execute(null),this._enableScissorPostPostPro()):this.SSAOEffect&&this.SSAOEffect.enabled&&(this._disableScissorForPostPro(),this.renderer.aoBuffer=this.SSAOEffect.execute(null),this._enableScissorPostPostPro()),e&&this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&V&&this.renderOpaqueScene("main",A,R,s,_,O),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&V&&(this._disableScissorForPostPro(),this.renderer.refractionColorBuffer=this.SSLRefractionEffect.execute(),this._enableScissorPostPostPro()),e&&this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&L&&this.renderColorScene("main",A,R,s,_,O),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&L&&(this._disableScissorForPostPro(),this.renderer.reflectionColorBuffer=this.SSLReflectionEffect.execute(),this._enableScissorPostPostPro())}this.renderer._requestPoliteDepthBuffer&&this.renderPoliteDepth(this.mobile?"main":"mainNoJittering",A,R,s,_,O,a),this.renderer.materialToUse=t.MaterialToUse.originalMaterial;var B=this.renderer.requestDBuffer||this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled||this.renderer.getRenderMode().getMask()&t.OutlineMask;if(i){B&&this.renderRealDepth("mirrorCamera",A,R,s,_,O,a,!0);var N=this.renderer.reflectionColorBuffer,G=this.renderer.refractionColorBuffer,k=this.renderer.aoBuffer;this.renderer.reflectionColorBuffer=null,this.renderer.refractionColorBuffer=null,this.renderer.aoBuffer=null,this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.compMirrorComposerContext.setPassClear(this.initClearPass,!0,new t.Color(0),0),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(O),this.mainComposer.updateScene(A),this._updateOITScene(A);var U=!1;null!==o&&(U=o.visible,o.visible=!1);var z=!1,H=20*(1-l);this.passMirrorBlur.material.setUniform("radius",this.renderer._renderScale*H),H>0&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur,z),z=!1,H>12&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur1,z),z=!1,H>16&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur2,z),z=!1,H>18&&(z=!0),this.compMirrorComposerContext.enablePass(this.passMirrorBlur3,z),this.compMirrorComposerContext.setRenderPlugins(this.forwardPass,!0);var W=this.renderer.renderFaceMode;this.renderer.renderFaceMode=this.renderer.renderFaceMode&~t.GeomTypeEnum.INFINITE_FACE&~t.GeomTypeEnum.AXIS_SYSTEM;var q=this.renderer.renderLineMode;this.renderer.renderLineMode=this.renderer.renderLineMode&~t.GeomTypeEnum.WIRE_EDGE;var Z=this.renderer.renderPointMode;this.renderer.renderPointMode=0,this.mainComposer.setComposerContext(this.compMirrorComposerContext),this.mainComposer.render(.1,void 0,s,_),this.renderer.renderFaceMode=W,this.renderer.renderLineMode=q,this.renderer.renderPointMode=Z,null!==o&&(o.visible=U),this.renderer.reflectionColorBuffer=N,this.renderer.refractionColorBuffer=G,this.renderer.aoBuffer=k}if(B&&this.renderRealDepth("main",A,R,s,_,O,a,!1),this.renderer.materialToUse=t.MaterialToUse.originalMaterial,this.renderer.autoClear=!1,this.compForwardComposerContext.enablePass(this.infPlanePass,e),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.infPlanePass.scene=n,this.compForwardComposerContext.enableRenderCuttingElementsPasses(O),this.compForwardComposerContext.enablePass(this.mirrorBlendPass,e&&i),this.compForwardComposerContext.enablePass(this.mirrorClearDepth,e&&i),this.compForwardComposerContext.enablePass(this.afterMirrorClearDepth,i),this.compForwardComposerContext.setPassClear(this.mirrorClearDepth,!0,new t.Color(0),1),this.compForwardComposerContext.setPassClear(this.afterMirrorClearDepth,!1,new t.Color(0),1),this.compForwardComposerContext.setPassClearDepth(this.afterMirrorClearDepth,!0),this.compForwardComposerContext.setPassClear(this.initClearPass,!0,new t.Color(this.bgColor).multiplyScalar(this.bgAlpha),this.bgAlpha),this.forwardPass.scene=A,this.zPostPass.scene=A,this.backgroundPass.scene=A,this.ZOnlyPass.scene=A,this.mainComposer.updateScene(A),this._updateOITScene(A),this._postProHighlight||this._HighlightMobileNonEffect.hide(y),this.customComposerContexts){var Y=this.mainComposer.getPostEffectPasses();for(T=0;T<Y.length;T++)for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(Y[T],!1);for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[E].enableRenderCuttingElementsPasses(O),this.mainComposer.setComposerContext(this.customComposerContexts[E]),this.mainComposer.render(void 0,void 0,s,_)}if(p){var Q=new t.WebGLRenderTargetProperties(f,f,"cubelinear"),K=this.compForwardComposerContext.originalRenderTargetProperties,$=this.compForwardComposerContext.keepResult,J=this.compForwardComposerContext.renderResults.main,ee=J.useCount;this.compForwardComposerContext.keepResult=!0,J.useCount=1,this.compForwardComposerContext.releaseRenderTargets(this.mainComposer.renderTargetPool),this.compForwardComposerContext.originalRenderTargetProperties=Q,this.mainComposer.setComposerContext(this.compForwardComposerContext),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!0),this.mainComposer.render(.1,g,s,_),this.ToneMappingEffect&&this.compForwardComposerContext.setAsLastPass(this.ToneMappingEffect.mixPass,!1),this.compForwardComposerContext.originalRenderTargetProperties=K,this.compForwardComposerContext.keepResult=$,J.useCount=ee}else this.useAuxiliaryAsForward?this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext):this.mainComposer.setComposerContext(this.compForwardComposerContext),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.execute(),this.mainComposer.render(.1,void 0,s,_);this.renderer.shadowMapEnabled=!1,this.renderer.shadowMapSoft=!1}else if(this.useAuxiliaryAsForward)this.mainComposer.updateScene(A),this._updateOITScene(A),this.mainComposer.setComposerContext(this.auxiliaryViewpointComposerContext),this.mainComposer.render(.1,void 0,s,_);else{if(this.customComposerContexts){this.renderer.initWebGLObjects(A),this.updateClippingGlobals(a,A,this,S),this.renderer.sectionCappingEnabled&&this.renderer.clipPlanes.length>0&&(O=!0),O&&this.updateSectionCappingScene(a,A);Y=this.mainComposer.getPostEffectPasses();for(T=0;T<Y.length;T++)for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(Y[T],!1);for(E=0;E<this.customComposerContexts.length;E++)this.customComposerContexts[E].enablePass(this.afterMirrorClearDepth,!1),this.customComposerContexts[E].enableRenderCuttingElementsPasses(O),this.mainComposer.setComposerContext(this.customComposerContexts[E]),this.mainComposer.render(void 0,void 0,s,_)}this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.updateLinks(_),this.mainComposer.setComposerContext(this.compForwardComposerContext),this.mainComposer.render(.1,void 0,s,_,this.highlightPass)}if(this.renderer.renderAssets(),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,this.renderer.setDepthFunc(this.renderer.depthFuncs.LEQUAL),this.renderer.info.renderTime.popRoot(t._FrameTypes.MAIN),j._iteratePerformance(this)){var te=a.root._getViewer();te&&te.render()}},_activatedPixelPerformanceSuite:function(){return this.PixelShaderPerformanceEffect&&this.PixelShaderPerformanceEffect.enabled},_activatedTexturePerformanceSuite:function(){return this.TexturePerformanceEffect&&this.TexturePerformanceEffect.enabled},_needPerformanceSuite:function(){return this._needsPerformanceCheck},combineResults:function(e,i,n){if(!n.isReady())return!1;if(!this.superFinalComposer){var s=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");s.generateMipmaps=!1,this.superFinalComposer=new r(this.renderer,s,this.renderTargetPool),this.superFinalComposer.composerContext.name="superFinalComposer",n.createPasses(this.superFinalComposer)}n.updatePasses(e,i,this.compForwardComposerContext.renderResults);var a=this.renderer.getViewportSize();return this.renderer.setViewport(0,0,this.deviceWidth,this.deviceHeight),this.superFinalComposer.render(.1,void 0,{},"superFinal"),this.renderer.setViewport(0,0,a.width,a.height),!0},computeMeshPick:function(e,t,i,r,n){var s,a;n&&void 0!==t.x&&void 0!==t.y?(s=Math.round(Math.round((t.x+1)*this.deviceWidth/2)),a=Math.round(this.deviceHeight-Math.round((t.y+1)*this.deviceHeight/2))):(s=Math.round(t.xPix),a=Math.round(t.yPix));var o,l,h,c,d=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,u=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,p=this.deviceHeight,f={},g=new Set,m=s,v=a,_=!0;if(0==i){for(_=this.pickingGPUComposerContext.needsUpdate,l=s-this.gpuPickingTolerance;l<=s+this.gpuPickingTolerance;++l)for(h=a-this.gpuPickingTolerance;h<=a+this.gpuPickingTolerance;++h)this.meshesGPU[h*this.deviceWidth+l+this._pickingVPid]||(_=!0);m=s-this.gpuPickingTolerance,v=a-this.gpuPickingTolerance,d=2*this.gpuPickingTolerance+1,u=2*this.gpuPickingTolerance+1}if(_){var y=new Uint8Array(4*d*u);for(this.gl.readPixels(m,p-v-u+1,d,u,this.gl.RGBA,this.gl.UNSIGNED_BYTE,y),l=0;l<d;++l)for(h=0;h<u;++h){o=(63&y[c=4*(h*d+l)])<<16|y[c+1]<<8|y[c+2];var S=y[c]>>6&3,x=f[o];void 0===x&&(x=this.getObjectById(e.scene,o),f[o]=x,x&&x.pickable&&g.add(x)),this.meshesGPU[(v+u-h-1)*this.deviceWidth+m+l+this._pickingVPid]={object:x,glType:S}}}return i?{tab:Array.from(g),outMouse:t}:this._computePixelMeshPick(m,s,d,v,a,u,t,r)},computeInstancePick:function(e,t,i){var r,n,s,a,o=Math.round(t.xPix),l=Math.round(t.yPix),h=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,c=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,d=this.deviceHeight,u=o,p=l;i||(u=o-this.gpuPickingTolerance,p=l-this.gpuPickingTolerance,h+=2*this.gpuPickingTolerance,c+=2*this.gpuPickingTolerance);var f=new Uint8Array(4*h*c);this.gl.readPixels(u,d-p-c+1,h,c,this.gl.RGBA,this.gl.UNSIGNED_BYTE,f);var g=new Map,m=i?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(n=0;n<h;++n)for(s=0;s<c;++s)if(!(0===(r=f[a=4*(s*h+n)]<<16|f[a+1]<<8|f[a+2])||r>16777215)){var v=r%5;if(0!==v&&(v>3?r=r+5-v:v<3?r-=v:r=void 0),0!==r&&void 0!==r)if(i){if(_=this.meshesGPU[(p+c-s-1)*this.deviceWidth+u+n+this._pickingVPid])if(g.has(_.object))g.get(_.object).add(r);else(y=new Set).add(r),g.set(_.object,y)}else{var _,y,S=n+u-o,x=s+p-l;if(S*S+x*x<m)if(_=this.meshesGPU[(p+c-s-1)*this.deviceWidth+u+n+this._pickingVPid])if(g.has(_.object))g.get(_.object).add(r);else(y=new Set).add(r),g.set(_.object,y)}}return g},computePositionPick:function(e,i,r,n){var s,a,o,l=r.xPix,h=r.yPix,c=this.deviceHeight,d=new Uint8Array(4);if(!this.depthComposerContext.needsUpdate&&this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid])s=this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid];else{if(this.gl.readPixels(l,c-h,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d),o=(a=new Float32Array(d.buffer))[0]?2*a[0]-1:1,i._viewpoint&&!n){let e=new t.Vector2(r.xPix,r.yPix);e.divideScalar(this.devicePixelRatio),e=i._viewpoint._convertViewportToNDC(e),s=new t.Vector4(e.x,e.y,o,1)}else s=new t.Vector4(r.x,r.y,o,1);s.applyMatrix4(i.projectionMatrixInverse),s.multiplyScalar(1/s.w),s.applyMatrix4(i.matrixWorld),this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid]=s.clone()}for(var u=0;u<e.length;++u)e[u].point=new t.Vector3(s.x,s.y,s.z)},computeNormalPick:function(e,i,r){var n,s=r.xPix,a=r.yPix,o=this.deviceHeight,l=new Uint8Array(4);if(!this.normalComposerContext.needsUpdate&&this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid])n=this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid];else{this.gl.readPixels(s,o-a,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,l);var h=(n=new t.Vector4(l[0]/255*2-1,l[1]/255*2-1,l[2]/255*2-1,0)).x,c=n.y,d=n.z,u=i.matrixWorld.elements,p=1/(u[3]*h+u[7]*c+u[11]*d+u[15]);n.x=(u[0]*h+u[4]*c+u[8]*d)*p,n.y=(u[1]*h+u[5]*c+u[9]*d)*p,n.z=(u[2]*h+u[6]*c+u[10]*d)*p,this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid]=n.clone()}for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},_computePixelMeshPick:function(e,t,i,r,n,s,a,o){for(var l=0,h=0,c=0,d=0,u=null,p=!1,f=2,g=this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance,m=null,v=-1/0,_=0,y=["points","edges","faces"],S=[g,g,0],x=[g,g,0],b=function(e){return e.id===this},w=e;w<e+i;++w)for(var M=w-t,C=r;C<r+s;++C){var P=C-n,E=M*M+P*P,T=this.meshesGPU[C*this.deviceWidth+w+this._pickingVPid];if(T){var A=T.object,D=T.glType,I=A&&A.hasPriorityManipulators&&A.hasPriorityManipulators();if(p&&!I)continue;_=0,A&&A.pickable&&(o&&A.pickingPriorityID&&(m=!!A.pickingPriorityID[y[D]]&&o.find(b,A.pickingPriorityID[y[D]]))&&(_=m.priority),(!p&&I||_>v&&E<=x[D]||_===v&&D<=f&&E<=S[D])&&(p=I,S[D]=E,u=A,f=D,v=_,l=w,h=C,c=w-e,d=C-r))}}return u?{tab:[u],outMouse:{xPix:l,yPix:h,xDev:c,yDev:d,x:(l-this.deviceWidth/2)/(this.deviceWidth/2),y:(this.deviceHeight/2-h)/(this.deviceHeight/2)},type:f}:{tab:[],outMouse:a}},computeMeshPickSmallTarget:function(e,t,i,r,n){var s,a;n&&void 0!==t.x&&void 0!==t.y?(s=Math.round(Math.round((t.x+1)*this.deviceWidth/2)),a=Math.round(this.deviceHeight-Math.round((t.y+1)*this.deviceHeight/2))):(s=Math.round(t.xPix),a=Math.round(t.yPix));var o,l,h,c,d=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,u=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,p=(this.deviceHeight,{}),f=new Set,g=s,m=a;0==i&&(g=s-this.gpuPickingTolerance,m=a-this.gpuPickingTolerance,d=2*this.gpuPickingTolerance+1,u=2*this.gpuPickingTolerance+1);var v=new Uint8Array(4*d*u);for(this.gl.readPixels(0,0,d,u,this.gl.RGBA,this.gl.UNSIGNED_BYTE,v),l=0;l<d;++l)for(h=0;h<u;++h){o=(63&v[c=4*(h*d+l)])<<16|v[c+1]<<8|v[c+2];var _=v[c]>>6&3,y=p[o];void 0===y&&(y=this.getObjectById(e.scene,o),p[o]=y,y&&y.pickable&&f.add(y)),this.meshesGPU[(m+u-h-1)*this.deviceWidth+g+l+this._pickingVPid]={object:y,glType:_}}return i?{tab:Array.from(f),outMouse:t}:this._computePixelMeshPick(g,s,d,m,a,u,t,r)},computeInstancePickSmallTarget:function(e,t,i){var r,n,s,a,o=Math.round(t.xPix),l=Math.round(t.yPix),h=i&&t.pt&&0!==Math.round(t.xPix-t.pt.xPix)?Math.round(Math.abs(t.xPix-t.pt.xPix)):1,c=i&&t.pt&&0!==Math.round(t.yPix-t.pt.yPix)?Math.round(Math.abs(t.yPix-t.pt.yPix)):1,d=(this.deviceHeight,o),u=l;i||(d=o-this.gpuPickingTolerance,u=l-this.gpuPickingTolerance,h=2*this.gpuPickingTolerance+1,c=2*this.gpuPickingTolerance+1);var p=new Uint8Array(4*h*c);this.gl.readPixels(0,0,h,c,this.gl.RGBA,this.gl.UNSIGNED_BYTE,p);var f=new Map,g=i?0:this.gpuPickingTolerance*this.gpuPickingTolerance+this.gpuPickingTolerance*this.gpuPickingTolerance;for(n=0;n<h;++n)for(s=0;s<c;++s)if(!(0===(r=p[a=4*(s*h+n)]<<16|p[a+1]<<8|p[a+2])||r>16777215)){var m=r%5;if(0!==m&&(m>3?r=r+5-m:m<3?r-=m:r=void 0),0!==r&&void 0!==r)if(i){if(v=this.meshesGPU[(u+c-s-1)*this.deviceWidth+d+n+this._pickingVPid])if(f.has(v.object))f.get(v.object).add(r);else(_=new Set).add(r),f.set(v.object,_)}else{var v,_,y=n+d-o,S=s+u-l;if(y*y+S*S<g)if(v=this.meshesGPU[(u+c-s-1)*this.deviceWidth+d+n+this._pickingVPid])if(f.has(v.object))f.get(v.object).add(r);else(_=new Set).add(r),f.set(v.object,_)}}return f},computePositionPickSmallTarget:function(e,i,r,n){var s,a,o,l=r.xPix,h=r.yPix,c=(this.deviceHeight,new Uint8Array(4)),d=2*this.gpuPickingTolerance+1;if(this.gl.readPixels(r.xDev,d-r.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,c),o=(a=new Float32Array(c.buffer))[0]?2*a[0]-1:1,i._viewpoint&&!n){let e=new t.Vector2(r.xPix,r.yPix);e.divideScalar(this.devicePixelRatio),e=i._viewpoint._convertViewportToNDC(e),s=new t.Vector4(e.x,e.y,o,1)}else s=new t.Vector4(r.x,r.y,o,1);s.applyMatrix4(i.realProjectionMatrixInverse),s.multiplyScalar(1/s.w),s.applyMatrix4(i.matrixWorld),this.positionsGPU[h*this.deviceWidth+l+this._pickingVPid]=s.clone();for(var u=0;u<e.length;++u)e[u].point=new t.Vector3(s.x,s.y,s.z)},computeNormalPickSmallTarget:function(e,i,r){var n,s=r.xPix,a=r.yPix,o=(this.deviceHeight,new Uint8Array(4)),l=2*this.gpuPickingTolerance+1;this.gl.readPixels(r.xDev,l-r.yDev-1,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o);var h=(n=new t.Vector4(o[0]/255*2-1,o[1]/255*2-1,o[2]/255*2-1,0)).x,c=n.y,d=n.z,u=i.matrixWorld.elements,p=1/(u[3]*h+u[7]*c+u[11]*d+u[15]);n.x=(u[0]*h+u[4]*c+u[8]*d)*p,n.y=(u[1]*h+u[5]*c+u[9]*d)*p,n.z=(u[2]*h+u[6]*c+u[10]*d)*p,this.normalsGPU[a*this.deviceWidth+s+this._pickingVPid]=n.clone();for(var f=0;f<e.length;++f)e[f].normal=new t.Vector3(n.x,n.y,n.z),e[f].tangent=null},computeFloatPositionPick:function(e,i,r,n,s){r.xPix,r.yPix;let a,o;{let e=[],i=new Map,r=0,l=0;for(let s=0;s<n[0].length;s++){if(!isNaN(n[0][s])){let a=new t.Vector3(n[0][s],n[1][s],n[2][s]),o=a.x+","+a.y+","+a.z;if(!i.has(o)){let t=(r-this.heuristicNormalRadius)*(r-this.heuristicNormalRadius)+(l-this.heuristicNormalRadius)*(l-this.heuristicNormalRadius),n=null;i.set(o,!0),e.push({pos:a,screensqdist:t,vec:n})}}0==(r=(r+1)%(2*this.heuristicNormalRadius+1))&&l++}let h=99999999999,c=null;for(let t=0;t<e.length;t++)e[t].screensqdist<h&&(h=e[t].screensqdist,c=t);if(a=new t.Vector4(0,0,0,1),o=new t.Vector3(0,0,0),null!=c){let i=e[c];if(e.splice(c,1),e.length>4){for(let r=0;r<e.length;r++)e[r].vec=(new t.Vector3).subVectors(i.pos,e[r].pos);let r=4*e[2].vec.lengthSq(),n=[];for(let t=1;t<e.length;t++)e[t].vec.lengthSq()<r&&n.push(e[t]);let a=new t.Vector3,l=new t.Vector3;for(let e=1;e<n.length;e++){let t,i;e==n.length-1?(t=n[e].vec,i=n[0].vec):(t=n[e-1].vec,i=n[e].vec),t.normalize(),i.normalize(),l.subVectors(i,t),l.length()<.1||(a.crossVectors(t,i),a.normalize(),a.dot(s.direction)>0&&a.negate(),o.add(a))}o.normalize()}a=new t.Vector4(i.pos.x,i.pos.y,i.pos.z,1),o=new t.Vector4(o.x,o.y,o.z,1)}this.positionsFloatGPU[l*this.deviceWidth+r+this._pickingVPid]=a.clone(),this.heuristicNormalsGPU[l*this.deviceWidth+r+this._pickingVPid]=o.clone()}for(var l=0;l<e.length;++l)e[l].point=new t.Vector3(a.x,a.y,a.z),e[l].normal=new t.Vector3(o.x,o.y,o.z)},getObjectById:function(e,t){var i,r,n;if(e.pickingID===t)return e;for(i=0,r=e.children.length;i<r;i++)if(null!==(n=this.getObjectById(e.children[i],t)))return n;return null},insertComposer:function(e,t){this.mobile&&!q.has(t.name)||(null!==e&&this.composers.push(e),t.disabledByDefault=!0,this.mainComposer.addPass(t),this.compForwardComposerContext.enablePass(t,!0),"HighlightEffect"===t.name?(this.highlightPass=t,this.auxiliaryViewpointComposerContext.enablePass(t,!0)):"Canvas2DHighlightEffect"!==t.name&&"PreHighlightEffect"!==t.name&&"Canvas2DPreHighlight"!==t.name||this.auxiliaryViewpointComposerContext.enablePass(t,!0),this.updateFinalComposer(!0))},updateFinalComposer:function(e){if(this.mobile)return;var t=this.mainComposer,i=[this.compForwardComposerContext,this.auxiliaryViewpointComposerContext];if(!t)return;let r=e?1:0;this.multiViewpoint&&(r=2);var a,o,l,h=t.getAllPasses(),c=h.length;for(let e=0;e<i.length;e++){let t=i[e];if(t){for(a=0;a<c;a++)t.setPassRenderToCanvas(h[a],0);for(a=c-1;a>=0;a--)if(l=h[a],t.passStates[a].enabled&&l instanceof s){t.setPassRenderToCanvas(l,r);break}for(o=c-1;o>=0&&(l=h[o],!(t.passStates[o].enabled&&l instanceof s));o--)t.passStates[o].enabled&&(l instanceof n||l instanceof A)&&t.setPassRenderToCanvas(l,r)}}},getComposer:function(e){if("normalDepthIoRRoughness"===e)return this.normalDepthIoRRoughnessComposerContext||this.initComposer("NormalDepthIoRRoughness"),this.normalDepthIoRRoughnessComposerContext;if("normalDepth"===e)return this.normalDepthComposerContext||this.initComposer("NormalDepth"),this.normalDepthComposerContext;if("HighlightDepth"===e)return this.highlightDepthComposerContext||this.initComposer("HighlightDepth"),this.highlightDepthComposerContext;if("Depth"===e)return this.depthComposerContext||this.initComposer("Depth"),this.depthComposerContext;if("result"===e)return this.compForwardComposerContext;if("previousColor"===e){if(this.TAAEffect&&this.TAAEffect.enabled)return this.TAAEffect.composers[0].composerContext;if(this.MSAAEffect&&this.MSAAEffect.enabled)return this.MSAAEffect.composers[0].composerContext}else{if("opaque"===e)return this.opaqueOnlyComposerContext||this.initComposer("Opaque"),this.opaqueOnlyComposerContext;if("color"===e)return this.colorComposerContext||this.initComposer("Color"),this.colorComposerContext}return null},getInfos:function(){var e={},i=this.renderer.info.renderMap.get(t._FrameTypes.MAIN);if(i){var r={};Object.assign(r,i.getCulling()),Object.assign(r,i.getRendering()),Object.assign(r,i.getGeometries()),Object.assign(e,{memory:this.renderer.info.memory,render:r})}return e},setScale:function(e){let i=this.renderTargetPool;e&&(this.renderTargetPool.resetRenderTargetPool(),i=null);var r="FSAA"===this.antiAliasing||"SSAA"===this.antiAliasing?2:1,n="true"===localStorage.getItem("__HALF_RES_SSAO__")?.707:1,s="true"===localStorage.getItem("__HALF_RES_RAYMARCHING__")?.707:1,a="true"===localStorage.getItem("__HALF_RES_MIRROR__")?.707:1;n="true"===localStorage.getItem("__QUARTER_RES_SSAO__")?.5:n,s="true"===localStorage.getItem("__QUARTER_RES_RAYMARCHING__")?.5:s,a="true"===localStorage.getItem("__QUARTER_RES_MIRROR__")?.5:a;var o=1;if(this.mobile){var l=this.renderer._renderScale*t.getDevicePixelRatio();l>1&&(n/=l,s/=l,a/=l,o/=l)}if(this.compForwardComposerContext&&(this.compForwardComposerContext.setSize(r*this.viewportWidth,r*this.viewportHeight,null,i),this.compForwardComposerContext._internalScaleForViewport=r),this.compMirrorComposerContext&&(this.compMirrorComposerContext.setSize(a*r*this.viewportWidth,a*r*this.viewportHeight,null,i),this.compMirrorComposerContext._internalScaleForViewport=a*r),this.normalDepthIoRRoughnessComposerContext&&(this.normalDepthIoRRoughnessComposerContext.setSize(o*this.viewportWidth,o*this.viewportHeight,null,i),this.normalDepthIoRRoughnessComposerContext._internalScaleForViewport=o),this.normalDepthComposerContext&&(this.normalDepthComposerContext.setSize(o*this.viewportWidth,o*this.viewportHeight,null,i),this.normalDepthComposerContext._internalScaleForViewport=o),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight,null,i),this.mirrorOutlineDepthComposerContext&&(this.mirrorOutlineDepthComposerContext.setSize(a*this.viewportWidth,a*this.viewportHeight,null,i),this.mirrorOutlineDepthComposerContext._internalScaleForViewport=a),this.occlusionDepthComposerContext&&(this.occlusionDepthComposerContext.setSize(this.getQuarterWidth(),this.getQuarterHeight(),null,i),this.occlusionDepthComposerContext._internalScaleForViewport=.25),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.setSize(this.viewportWidth,this.viewportHeight,null,i),this.opaqueOnlyComposerContext&&(this.opaqueOnlyComposerContext.setSize(o*this.viewportWidth,o*this.viewportHeight,null,i),this.opaqueOnlyComposerContext._internalScaleForViewport=o),this.colorComposerContext&&(this.colorComposerContext.setSize(o*this.viewportWidth,o*this.viewportHeight,null,i),this.colorComposerContext._internalScaleForViewport=o),!this.smallTargetPicking&&e&&(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight,null,i),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.setSize(this.viewportWidth,this.viewportHeight,null,i),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight,null,i),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight,null,i),this.gpuPositionComposerContext))for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(this.viewportWidth,this.viewportHeight,null,i);this.auxiliaryViewpointComposerContext&&(this.auxiliaryViewpointComposerContext.setSize(this.viewportWidth*r,this.viewportHeight*r,null,i),this.auxiliaryViewpointComposerContext._internalScaleForViewport=r),this.FXAAEffect&&this.FXAAEffect.enabled&&this.FXAAEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.TexturePerformanceEffect&&this.TexturePerformanceEffect.enabled&&this.TexturePerformanceEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.PixelShaderPerformanceEffect&&this.PixelShaderPerformanceEffect.enabled&&this.PixelShaderPerformanceEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.MSAAEffect&&this.MSAAEffect.enabled&&this.MSAAEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.TAAEffect&&this.TAAEffect.enabled&&this.TAAEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.SMAAEffect&&this.SMAAEffect.enabled&&this.SMAAEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.SSAOEffect&&this.SSAOEffect.enabled&&this.SSAOEffect.setSize(n*this.viewportWidth,n*this.viewportHeight,null,i),this.SSAOIterativeEffect&&this.SSAOIterativeEffect.enabled&&this.SSAOIterativeEffect.setSize(n*this.viewportWidth,n*this.viewportHeight,null,i),this.SSLReflectionEffect&&this.SSLReflectionEffect.enabled&&this.SSLReflectionEffect.setSize(s*this.viewportWidth,s*this.viewportHeight,i),this.SSLRefractionEffect&&this.SSLRefractionEffect.enabled&&this.SSLRefractionEffect.setSize(s*this.viewportWidth,s*this.viewportHeight,i),this.VolumeRenderingEffect&&this.VolumeRenderingEffect.enabled&&this.VolumeRenderingEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.BokehDOFEffect&&this.BokehDOFEffect.enabled&&this.BokehDOFEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.SkyScatteringEffect&&this.SkyScatteringEffect.enabled&&this.SkyScatteringEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.BloomEffect&&this.BloomEffect.enabled&&this.BloomEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.ToneMappingEffect&&this.ToneMappingEffect.enabled&&this.ToneMappingEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.FlareEffect&&this.FlareEffect.enabled&&this.FlareEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.HighlightEffect&&this.HighlightEffect.enabled&&this.HighlightEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.PreHighlightEffect&&this.PreHighlightEffect.enabled&&this.PreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.Canvas2DHighlightEffect&&this.Canvas2DHighlightEffect.enabled&&this.Canvas2DHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.Canvas2DPreHighlightEffect&&this.Canvas2DPreHighlightEffect.enabled&&this.Canvas2DPreHighlightEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.NativeOnTopEffect&&this.NativeOnTopEffect.enabled&&this.NativeOnTopEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.DebugPassEffect&&this.DebugPassEffect.enabled&&this.DebugPassEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.DebugShadowMapsEffect&&this.DebugShadowMapsEffect.enabled&&this.DebugShadowMapsEffect.setSize(this.viewportWidth,this.viewportHeight,i),this.OITEffect&&this.OITEffect.enabled&&this.OITEffect.setSize(r*this.viewportWidth,r*this.viewportHeight,i),this.OITnoZEffect&&this.OITnoZEffect.enabled&&this.OITnoZEffect.setSize(r*this.viewportWidth,r*this.viewportHeight,i),this.XRevealStructureEffect&&this.XRevealStructureEffect.enabled&&this.XRevealStructureEffect.setSize(this.viewportWidth,this.viewportHeight,i);for(var h=0;h<this.customEffects.length;h++){var c=this.customEffects[h];c&&c.enabled&&c.setSize(this.viewportWidth,this.viewportHeight,i)}if(null!==this.passMirrorBlur){const e=new t.Vector2(1/this.viewportWidth,1/this.viewportHeight);this.passMirrorBlur.material.setUniform("invSize",e),this.passMirrorBlur1.material.setUniform("invSize",e),this.passMirrorBlur2.material.setUniform("invSize",e),this.passMirrorBlur3.material.setUniform("invSize",e)}},initComposer:function(e,i){var r;switch(e){case"Shadow":this.shadowComposerContext=new T(null,this.mainComposer,"shadowComposerContext"),this.shadowComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.shadowComposerContext,null,null,!1),this.shadowComposerContext._checkCamera=!0,r=this.shadowComposerContext;break;case"Depth":var n;(n=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest")).generateMipmaps=!1,this.depthComposerContext=new T(n,this.mainComposer,"depthComposerContext"),this.setupOneMaterialComposerContext(this.depthComposerContext,0,0,!0),r=this.depthComposerContext;break;case"Normal":var s;s=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest"),this.normalComposerContext=new T(s,this.mainComposer,"normalComposerContext"),this.setupOneMaterialComposerContext(this.normalComposerContext,0,1,!0),r=this.normalComposerContext;break;case"NormalDepth":(a=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"maxPrecisionNearest")).generateMipmaps=!1,this.normalDepthComposerContext=new T(a,this.mainComposer,"normalDepthComposerContext"),this.normalDepthComposerContext.keepResult=!0,this.normalDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.ONLY_LIGHTED,this.normalDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.normalDepthComposerContext;break;case"NormalDepthIoRRoughness":var a;(a=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest")).generateMipmaps=!1,this.normalDepthIoRRoughnessComposerContext=new T(a,this.mainComposer,"normalDepthIoRRoughnessComposerContext"),this.normalDepthIoRRoughnessComposerContext._forbidRenderableState=t._ForbidRenderableStates.ONLY_LIGHTED,this.normalDepthIoRRoughnessComposerContext.keepResult=!0,this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorBlendPass,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.mirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.normalDepthIoRRoughnessComposerContext.enablePass(this.infPlanePass,!1),this.normalDepthIoRRoughnessComposerContext.setRenderPlugins(this.forwardPass,!1),this.normalDepthIoRRoughnessComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.normalDepthIoRRoughnessComposerContext;break;case"OutlineDepth":var o=this.renderer.supportsFloatTextures();(l=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,o?"nearest":"uintNearest")).generateMipmaps=!1,this.outlineDepthComposerContext=new T(l,this.mainComposer,"outlineDepthComposerContext"),this.outlineDepthComposerContext.keepResult=!0,this.outlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.outlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.outlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.outlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.outlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.outlineDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.outlineDepthComposerContext;break;case"MirrorOutlineDepth":var l;o=this.renderer.supportsFloatTextures();(l=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,o?"nearest":"uintNearest")).generateMipmaps=!1,this.mirrorOutlineDepthComposerContext=new T(l,this.mainComposer,"mirrorOutlineDepthComposerContext"),this.mirrorOutlineDepthComposerContext.keepResult=!0,this.mirrorOutlineDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.mirrorOutlineDepthComposerContext.enablePass(this.infPlanePass,!1),this.mirrorOutlineDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.mirrorOutlineDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.mirrorOutlineDepthComposerContext;break;case"OcclusionDepth":var h=new t.WebGLRenderTargetProperties(this.getQuarterWidth(),this.getQuarterHeight(),"uintNearest");h.generateMipmaps=!1,this.occlusionDepthComposerContext=new T(h,this.mainComposer,"occlusionDepthComposerContext"),this.occlusionDepthComposerContext.keepResult=!0,this.occlusionDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.occlusionDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.occlusionDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.occlusionDepthComposerContext.enablePass(this.infPlanePass,!1),this.occlusionDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.occlusionDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.occlusionDepthComposerContext;break;case"HighlightDepth":var c=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest");c.generateMipmaps=!1,this.highlightDepthComposerContext=new T(c,this.mainComposer,"highlightDepthComposerContext"),this.highlightDepthComposerContext.keepResult=!0,this.highlightDepthComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE|t._ForbidRenderableStates.NO_EDGES_IF_HAS_FACES,this.highlightDepthComposerContext.enablePass(this.mirrorBlendPass,!1),this.highlightDepthComposerContext.enablePass(this.mirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.highlightDepthComposerContext.enablePass(this.infPlanePass,!1),this.highlightDepthComposerContext.setRenderPlugins(this.forwardPass,!1),this.highlightDepthComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.highlightDepthComposerContext;break;case"Opaque":var d=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");d.generateMipmaps=!1,this.opaqueOnlyComposerContext=new T(d,this.mainComposer,"opaqueOnlyComposerContext"),this.opaqueOnlyComposerContext.keepResult=!0,this.opaqueOnlyComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_TRANSPARENT|t._ForbidRenderableStates.ONLY_LIGHTED,this.opaqueOnlyComposerContext.enablePass(this.mirrorBlendPass,!1),this.opaqueOnlyComposerContext.enablePass(this.mirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.opaqueOnlyComposerContext.enablePass(this.infPlanePass,!1),this.opaqueOnlyComposerContext.setRenderPlugins(this.forwardPass,!1),this.opaqueOnlyComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.opaqueOnlyComposerContext;break;case"Color":var u=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"nearest");u.generateMipmaps=!1,this.colorComposerContext=new T(u,this.mainComposer,"colorComposerContext"),this.colorComposerContext.keepResult=!0,this.colorComposerContext._forbidRenderableState=t._ForbidRenderableStates.ONLY_LIGHTED,this.colorComposerContext.enablePass(this.mirrorBlendPass,!1),this.colorComposerContext.enablePass(this.mirrorClearDepth,!1),this.colorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.colorComposerContext.enablePass(this.infPlanePass,!1),this.colorComposerContext.setRenderPlugins(this.forwardPass,!1),this.colorComposerContext.setOnEffectComposerChangeCallback(function(e){var t,i=e.composer.getPostEffectPasses();for(t=0;t<i.length;t++)e.enablePass(i[t],!1)}),r=this.colorComposerContext;break;case"PickingGPUInstancing":(p=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUInstancingComposerContext=new T(p,this.mainComposer,"pickingGPUInstancingComposerContext"),this.setupOneMaterialComposerContext(this.pickingGPUInstancingComposerContext,0,1,!0),this.pickingGPUInstancingComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,r=this.pickingGPUInstancingComposerContext;break;case"PickingGPU":var p;(p=i?new t.WebGLRenderTargetProperties(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1,"uintNearest"):new t.WebGLRenderTargetProperties(this.deviceWidth,this.deviceHeight,"uintNearest")).generateMipmaps=!1,this.pickingGPUComposerContext=new T(p,this.mainComposer,"pickingGPUComposerContext"),this.pickingGPUComposerContext._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.pickingGPUComposerContext,0,1,!0),r=this.pickingGPUComposerContext;break;case"auxiliaryViewpoint":let _=null;this.useCompositing&&(_=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")),this.auxiliaryViewpointComposerContext=new T(_,this.mainComposer,"auxiliaryViewpointComposerContext");for(var f,g=this.mainComposer.getAllPasses(),m=0;m<g.length;m++)f=g[m],this.auxiliaryViewpointComposerContext.enablePass(f,!1);this.auxiliaryViewpointComposerContext.enablePass(this.initClearPass,!0),this.useCompositing?this.auxiliaryViewpointComposerContext.setPassClear(this.initClearPass,!0,new t.Color(16777215),0):this.auxiliaryViewpointComposerContext.setPassClear(this.initClearPass,!1),this.auxiliaryViewpointComposerContext.setPassClearDepth(this.initClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.forwardPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.setPassClear(this.nozClearPass,!1),this.auxiliaryViewpointComposerContext.setPassClearDepth(this.nozClearPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.nozPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.noEffectAfterHighlightNozPass,!0),this.auxiliaryViewpointComposerContext.enablePass(this.furtivePass,!0);break;case"GPUPosition":var v;let y=1,S=3;this.renderer.supportsDrawBuffers()&&(y=3,S=1),(v=i?new t.WebGLRenderTargetProperties(2*this.heuristicNormalRadius+1,2*this.heuristicNormalRadius+1,"uintNearest",y):new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uintNearest",y)).generateMipmaps=!1,this.gpuPositionComposerContext=[];for(let e=0;e<S;e++)this.gpuPositionComposerContext[e]=new T(v,this.mainComposer,"GPUPositionComposerContext"),this.gpuPositionComposerContext[e]._forbidRenderableState=t._ForbidRenderableStates.NO_INVISIBLE_PLANE,this.setupOneMaterialComposerContext(this.gpuPositionComposerContext[e],16777215,1,!0);r=this.gpuPositionComposerContext}var _=this.compForwardComposerContext.getPassState(this.zPostPass);if(this.__enablePassOnAllComposerContexts(this.zPostPass,_.enabled),r&&!this._postProHighlight)if(r.length)for(let e=0;e<r.length;e++)this._HighlightMobileNonEffect.disableOnComposer(r[e]),this._PreHighlightMobileNonEffect.disableOnComposer(r[e]);else this._HighlightMobileNonEffect.disableOnComposer(r),this._PreHighlightMobileNonEffect.disableOnComposer(r)},setupOneMaterialComposerContext:function(e,i,r,n){if(e.keepResult=!0,n){e.setPassClear(this.initClearPass,!0,new t.Color(i),r);for(var s=this.mainComposer.getAllPasses(),a=0;a<s.length;a++)(o=s[a]).renderCuttingElements&&e.enablePass(o,!1)}else{var o;for(s=this.mainComposer.getAllPasses(),a=0;a<s.length;a++)o=s[a],e.enablePass(o,!1);e.enablePass(this.forwardPass,!0)}e.enablePass(this.iso_0pass,!0),e.enablePass(this.iso_2pass,!0),e.enablePass(this.iso_3pass,!0),e.enablePass(this.infPlanePass,!1),e.enablePass(this.mirrorBlendPass,!1),e.enablePass(this.mirrorClearDepth,!1),e.enablePass(this.afterMirrorClearDepth,!1),n&&(e.enablePass(this.noEffectRobotClearPass,!0),e.setPassClear(this.noEffectRobotClearPass,!1),e.setPassClearDepth(this.noEffectRobotClearPass,!0),e.enablePass(this.noEffectRobotPass,!0),e.enablePass(this.noEffectRobotOrthoPass,!0),e.enablePass(this.noEffectCanvas2DPass,!0)),n&&(e.enablePass(this.nozClearPass,!0),e.setPassClear(this.nozClearPass,!1),e.setPassClearDepth(this.nozClearPass,!0)),e.enablePass(this.nozPass,!0),n&&(e.enablePass(this.noEffectNozClearPass,!0),e.setPassClear(this.noEffectNozClearPass,!1),e.setPassClearDepth(this.noEffectNozClearPass,!0)),e.enablePass(this.noEffectNozPass,!0),n&&(e.enablePass(this.noEffectAfterHighlightNozClearPass,!0),e.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),e.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0)),e.enablePass(this.noEffectAfterHighlightNozPass,!0),e.enablePass(this.dialogPass,!0),n&&(e.enablePass(this.furtiveClearPass,!0),e.setPassClear(this.furtiveClearPass,!1),e.setPassClearDepth(this.furtiveClearPass,!0)),e.enablePass(this.furtivePass,!1),this.NativeOnTopEffect.disablePasses(e),n&&(e.enablePass(this.noEffectCanvas2DClearPass,!0),e.setPassClear(this.noEffectCanvas2DClearPass,!1),e.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)),e.setRenderPlugins(this.forwardPass,!1)},initForwardRender:function(){var e,i=null;this.initClearPass=new A("initClearPass"),this.infPlanePass=new n(null,null,null,F.facesMask,null,null,"infPlanePass"),this.infPlanePass.lockScene=!0,this.infPlanePass.setCameraName("cameraBackground"),this.zPostPass=new n(null,null,null,null,null,null,"zPostPass"),this.zPostPass.setDisableDepthWrite(!0),this.zPostPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DEFAULT,this.zPostPass.disabledByDefault=!0,this.forwardPass=new n(null,null,null,null,null,null,"forwardPass"),this.cssPass=new L(null,"cssPass"),this.backgroundPass=new n(null,null,null,F.facesMask,null,null,"backgroundPass"),this.backgroundPass.idString="background",this.backgroundPass.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.ZOnlyPass=new n(null,null,null,null,null,null,"ZOnlyPass"),this.ZOnlyPass.idString="ZOnly",this.ZOnlyPass.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setStateSortingResultFrom(this.forwardPass,!1),this.iso_0Pass=new n(null,null,null,void 0,void 0,void 0,"iso_0"),this.iso_0Pass.idString="iso_0",this.iso_2Pass=new n(null,null,null,void 0,void 0,void 0,"iso_2"),this.iso_2Pass.idString="iso_2",this.iso_3Pass=new n(null,null,null,void 0,void 0,void 0,"iso_3"),this.iso_3Pass.idString="iso_3",this.mirrorBlendPass=new s(a.Blend,"mirrorBlendPass"),e=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear"),this.useCompositing&&(i=new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear")),this.useCompositing||(this.mirrorBlendPass.disabledByDefault=!0,this.mirrorBlendPass.needsSwap=!1,this.mirrorBlendPass.material.defines.POSTPRO=0,this.mirrorBlendPass.material.transparent=!0,this.mirrorBlendPass.material.needsUpdate=!0),this.compForwardComposerContext=new T(i,this.mainComposer,"compForwardComposerContext"),this.compForwardComposerContext.keepResult=!0,this.mainComposer.addPass(this.initClearPass),this.mainComposer.addPass(this.infPlanePass),null!==this.mirrorBlendPass&&(this.mirrorClearDepth=new A("mirrorClearDepth"),this.mirrorClearDepth.clear=!1,this.mirrorClearDepth.setClearDepth(!1),this.afterMirrorClearDepth=new A("afterMirrorClearDepth"),this.mainComposer.addPass(this.mirrorBlendPass),this.mainComposer.addPass(this.afterMirrorClearDepth)),this.passSectionCappingFrontFaces=new n(null,null,null,void 0,!1,!1,"passSectionCappingFrontFaces"),this.passSectionCappingFrontFaces.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces.setEnableStencilTest(!0),this.passSectionCappingFrontFaces.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces.setDisableColorWrite(!0),this.passSectionCappingFrontFaces.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces.ignoreNoZ=!0,this.mainComposer.addPass(this.cssPass),this.mainComposer.addPass(this.iso_0Pass),this.mainComposer.addPass(this.forwardPass),this.mainComposer.addPass(this.iso_2Pass),this.mainComposer.addPass(this.iso_3Pass),this.mainComposer.addPass(this.zPostPass),this.mainComposer.addPass(this.backgroundPass),this.mainComposer.addPass(this.ZOnlyPass),this.mainComposer.addPass(this.passSectionCappingFrontFaces),this.ZOnlyPassCapping=new n(null,null,null,void 0,!1,!1,"ZOnlyPassCapping"),this.ZOnlyPassCapping.setRenderCuttingElements(!0),this.ZOnlyPassCapping.setEnableStencilTest(!0),this.ZOnlyPassCapping.setEnableStencilWrite(!0),this.ZOnlyPassCapping.setDisableColorWrite(!0),this.ZOnlyPassCapping.setDisableDepthWrite(!0),this.ZOnlyPassCapping.setStencilFunc("ALWAYS"),this.ZOnlyPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.ZOnlyPassCapping.setDisableBackFaceCulling(!0),this.ZOnlyPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.ZOnlyPassCapping.setDisableBackFaceClipPlanes(1),this.ZOnlyPassCapping.setRenderPluginsPre(!1),this.ZOnlyPassCapping.setRenderPluginsPost(!1),this.ZOnlyPassCapping.ignoreNoZ=!0,this.ZOnlyPassCapping.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.ZOnlyPassCapping.idString="ZOnly",this.mainComposer.addPass(this.ZOnlyPassCapping),this.backgroundPassCapping=new n(null,null,null,void 0,!1,!1,"backgroundPassCapping"),this.backgroundPassCapping.setRenderCuttingElements(!0),this.backgroundPassCapping.setEnableStencilTest(!0),this.backgroundPassCapping.setEnableStencilWrite(!0),this.backgroundPassCapping.setDisableColorWrite(!0),this.backgroundPassCapping.setDisableDepthWrite(!0),this.backgroundPassCapping.setStencilFunc("ALWAYS"),this.backgroundPassCapping.setStencilOps("INCR_WRAP","DECR_WRAP"),this.backgroundPassCapping.setDisableBackFaceCulling(!0),this.backgroundPassCapping.setHideSurfacesAndUnclippedMeshes(!0),this.backgroundPassCapping.setDisableBackFaceClipPlanes(1),this.backgroundPassCapping.setRenderPluginsPre(!1),this.backgroundPassCapping.setRenderPluginsPost(!1),this.backgroundPassCapping.ignoreNoZ=!0,this.backgroundPassCapping.setMaterialToUse(t.MaterialToUse.ZOnlyMaterial),this.backgroundPassCapping.idString="background",this.mainComposer.addPass(this.backgroundPassCapping),this.clearScreenSpacePass=new n(null,null,null,null,null,null,"clearScreenSpacePass"),this.clearScreenSpacePass.setDisableColorWrite(!0),this.clearScreenSpacePass.setDisableDepthWrite(!0),this.clearScreenSpacePass.idString="__clearScreenSpacePass__",this.clearScreenSpacePass.disabledByDefault=!0;var r=this;this.clearScreenSpacePass._postRenderCB=function(){r.renderer.aoBuffer=null,r.renderer.reflectionColorBuffer=null,r.renderer.refractionColorBuffer=null},this.mainComposer.addPass(this.clearScreenSpacePass),this.compForwardComposerContext.enablePass(this.zPostPass,!1),this.compForwardComposerContext.setRenderPlugins(this.forwardPass,!0),this.compForwardComposerContext.enablePass(this.clearScreenSpacePass,!0),this.compForwardComposerContext.enablePass(this.backgroundPass,!0),this.compForwardComposerContext.enablePass(this.ZOnlyPass,!0),this.compForwardComposerContext.enablePass(this.cssPass,!0),this.passMirrorBlur=new s(o.BlurPoisson,"passMirrorBlur"),this.passMirrorBlur.disabledByDefault=!0,this.passMirrorBlur1=new s(o.BlurPoisson,"passMirrorBlur1"),this.passMirrorBlur1.disabledByDefault=!0,this.passMirrorBlur2=new s(o.BlurPoisson,"passMirrorBlur2"),this.passMirrorBlur2.disabledByDefault=!0,this.passMirrorBlur3=new s(o.BlurPoisson,"passMirrorBlur3"),this.passMirrorBlur3.disabledByDefault=!0;const l=new t.Vector2(1/this.viewportWidth,1/this.viewportHeight);(this.passMirrorBlur.material.setUniform("invSize",l),this.passMirrorBlur1.material.setUniform("invSize",l),this.passMirrorBlur2.material.setUniform("invSize",l),this.passMirrorBlur3.material.setUniform("invSize",l),this.mainComposer.addPass(this.passMirrorBlur),this.mainComposer.addPass(this.passMirrorBlur1),this.mainComposer.addPass(this.passMirrorBlur2),this.mainComposer.addPass(this.passMirrorBlur3),this.nozClearPass=new A("nozClearPass"),this.nozClearPass.idString="noz",this.nozPass=new n(null,null,null,void 0,void 0,void 0,"nozPass"),this.nozPass.idString="noz",this.mainComposer.addPass(this.nozClearPass),this.mainComposer.addPass(this.nozPass),this.noEffectNozClearPass=new A("noEffectNozClearPass"),this.noEffectNozClearPass.idString="noEffectNoz",this.noEffectNozPass=new n(null,null,null,void 0,void 0,void 0,"noEffectNozPass"),this.noEffectNozPass.idString="noEffectNoz",this.mainComposer.addPass(this.noEffectNozClearPass),this.mainComposer.addPass(this.noEffectNozPass),this._postProHighlight||(this._HighlightMobileNonEffect=new G(this),this._PreHighlightMobileNonEffect=new k(this)),this.noEffectAfterHighlightNozClearPass=new A("noEffectAfterHighlightNozClearPass"),this.noEffectAfterHighlightNozClearPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozClearPass.order=60,this.noEffectAfterHighlightNozPass=new n(null,null,null,void 0,void 0,void 0,"noEffectAfterHighlightNozPass"),this.noEffectAfterHighlightNozPass.idString="afterHighlightNoZ",this.noEffectAfterHighlightNozPass.order=61,this.noEffectAfterHighlightNozPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectAfterHighlightNozClearPass),this.mainComposer.addPass(this.noEffectAfterHighlightNozPass),this.dialogPass=new n(null,null,null,void 0,void 0,void 0,"dialogPass"),this.dialogPass.idString="dialog",this.mainComposer.addPass(this.dialogPass),this.furtiveClearPass=new A("furtiveClearPass"),this.furtiveClearPass.idString="furtive",this.furtivePass=new n(null,null,null,void 0,void 0,void 0,"furtivePass"),this.furtivePass.idString="furtive",this.mainComposer.addPass(this.furtiveClearPass),this.mainComposer.addPass(this.furtivePass),this.noEffectRobotClearPass=new A("noEffectRobotClearPass"),this.noEffectRobotClearPass.order=70,this.noEffectRobotPass=new n(null,null,null,F.facesMask,void 0,void 0,"noEffectRobotPass"),this.noEffectRobotPass.idString="robot",this.noEffectRobotPass.setDisableClippingPlanes(!0),this.noEffectRobotPass.setDisableToneMapping(!0),this.noEffectRobotPass.isRobotPass=!0,this.noEffectRobotPass.setCameraName("connectedRobotCamera"),this.noEffectRobotPass.order=71,this.noEffectRobotPass.setForceMaterialMode(!0),this.noEffectRobotOrthoPass=new n(null,null,null,F.facesMask,void 0,void 0,"noEffectRobotOrthoPass"),this.noEffectRobotOrthoPass.idString="robotOrtho",this.noEffectRobotOrthoPass.setDisableClippingPlanes(!0),this.noEffectRobotOrthoPass.setCameraName("robotCameraOrtho"),this.noEffectRobotOrthoPass.order=72,this.noEffectRobotOrthoPass.isRobotPass=!0,this.noEffectRobotOrthoPass.setDisableToneMapping(!0),this.noEffectRobotOrthoPass.setForceMaterialMode(!0),this.noEffectCanvas2DClearPass=new A("noEffectCanvas2DClearPass"),this.noEffectCanvas2DClearPass.disabledByDefault=!0,this.noEffectCanvas2DClearPass.idString="canvas2D",this.noEffectCanvas2DPass=new n(null,null,null,void 0,void 0,void 0,"noEffectCanvas2DPass"),this.noEffectCanvas2DPass.idString="canvas2D",this.noEffectCanvas2DPass.disabledByDefault=!0,this.noEffectCanvas2DPass.setDisableClippingPlanes(!0),this.noEffectCanvas2DPass.order=1e5,this.noEffectCanvas2DPass.setDisableToneMapping(!0),this.noEffectCanvas2DPass.setCameraName("mainNoJittering"),this.mainComposer.addPass(this.noEffectRobotClearPass),this.mainComposer.addPass(this.noEffectRobotPass),this.mainComposer.addPass(this.noEffectRobotOrthoPass),this.mainComposer.addPass(this.noEffectCanvas2DClearPass),this.mainComposer.addPass(this.noEffectCanvas2DPass),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DPass,!0),this.compForwardComposerContext.enablePass(this.noEffectCanvas2DClearPass,!0),this.compMirrorComposerContext=new T(e,this.mainComposer,"compMirrorComposerContext"),this.compMirrorComposerContext.linkToShaderPassUniform(this.mirrorBlendPass,this.mirrorBlendPass.getInput(1)),this.compMirrorComposerContext.enablePass(this.mirrorBlendPass,!1),this.compMirrorComposerContext.enablePass(this.mirrorClearDepth,!1),this.compMirrorComposerContext.enablePass(this.afterMirrorClearDepth,!1),this.compMirrorComposerContext.enableRenderCuttingElementsPasses(!0),this.compMirrorComposerContext.enablePass(this.infPlanePass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.enablePass(this.noEffectRobotOrthoPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compMirrorComposerContext.enablePass(this.nozPass,!1),this.compMirrorComposerContext.setPassClear(this.nozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.noEffectAfterHighlightNozPass,!1),this.compMirrorComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compMirrorComposerContext.enablePass(this.dialogPass,!1),this.compMirrorComposerContext.enablePass(this.furtivePass,!1),this.compMirrorComposerContext.setPassClear(this.furtiveClearPass,!1),this.compMirrorComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compMirrorComposerContext.setCameraName("mirrorCamera"),this.compMirrorComposerContext.setBeforeRenderCB(function(e){e.composer.renderer.initWebGLObjects(e.composer.renderScene);var t,i,r=e.composer.renderScene.getAllWebGLObjects();for(i=0;i<r.length;i++)null!==r[i]&&(t=r[i].object).disableMirror&&t.visible&&(t.visible=!1,t.disableMirror=2)}),this.compMirrorComposerContext.setAfterRenderCB(function(e){var t,i,r=e.composer.renderScene.getAllWebGLObjects();for(i=0;i<r.length;i++)null!==r[i]&&2===(t=r[i].object).disableMirror&&(t.visible=!0,t.disableMirror=1)}),this.initComposer("auxiliaryViewpoint"),this.useCompositing)&&(new t.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint").generateMipmaps=!1,this.compositeClearPass=new A("compositeClearPass"),this.compositeClearPass.invertTarget=!0,this.canvas2DPass=new n(null,null,null,void 0,void 0,void 0,"canvas2DPass"),this.canvas2DPass.order=1100,this.canvas2DPass.idString="canvas2D",this.canvas2DPass.setDisableToneMapping(!0),this.canvas2DPass.setDisableClippingPlanes(!0),this.compositeClearPass.order=5,this.setEffect("ToneMapping",!0),this.ToneMappingEffect.setBrightness(this.brightness),this.ToneMappingEffect.setToneMapping(this.tonemapping));this.setEffect("NativeOnTop",!0),this.compForwardComposerContext.setPassClear(this.noEffectRobotClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectRobotClearPass,!0),this.compForwardComposerContext.setPassClear(this.nozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.nozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectAfterHighlightNozClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectAfterHighlightNozClearPass,!0),this.compForwardComposerContext.setPassClear(this.furtiveClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.furtiveClearPass,!0),this.compForwardComposerContext.setPassClear(this.noEffectCanvas2DClearPass,!1),this.compForwardComposerContext.setPassClearDepth(this.noEffectCanvas2DClearPass,!0)},resetClippingScene:function(){this.clippingScene=null},__enablePassOnAllComposerContexts:function(e,t){this.compForwardComposerContext&&this.compForwardComposerContext.enablePass(e,t),this.compMirrorComposerContext&&this.compMirrorComposerContext.enablePass(e,t),this.shadowComposerContext&&this.shadowComposerContext.enablePass(e,t),this.depthComposerContext&&this.depthComposerContext.enablePass(e,t),this.normalComposerContext&&this.normalComposerContext.enablePass(e,t),this.normalDepthIoRRoughnessComposerContext&&this.normalDepthIoRRoughnessComposerContext.enablePass(e,t),this.normalDepthComposerContext&&this.normalDepthComposerContext.enablePass(e,t),this.outlineDepthComposerContext&&this.outlineDepthComposerContext.enablePass(e,t),this.mirrorOutlineDepthComposerContext&&this.mirrorOutlineDepthComposerContext.enablePass(e,t),this.occlusionDepthComposerContext&&this.occlusionDepthComposerContext.enablePass(e,t),this.highlightDepthComposerContext&&this.highlightDepthComposerContext.enablePass(e,t),this.opaqueOnlyComposerContext&&this.opaqueOnlyComposerContext.enablePass(e,t),this.colorComposerContext&&this.colorComposerContext.enablePass(e,t),this.pickingGPUComposerContext&&this.pickingGPUComposerContext.enablePass(e,t),this.pickingGPUInstancingComposerContext&&this.pickingGPUInstancingComposerContext.enablePass(e,t),this.auxiliaryViewpointComposerContext&&this.auxiliaryViewpointComposerContext.enablePass(e,t)},_enableZPrePass:function(e){this.forwardPass&&(this.compForwardComposerContext.getPassState(this.zPostPass).enabled!==e&&(e?(this.forwardPass.setDisableColorWrite(!0),this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.ENABLED,this.__enablePassOnAllComposerContexts(this.zPostPass,!0)):(this.forwardPass.forcePolygonOffset=t.PolygonOffsetForceStatus.DEFAULT,this.forwardPass.setDisableColorWrite(!1),this.__enablePassOnAllComposerContexts(this.zPostPass,!1))))},dispose:function(){this.compForwardComposerContext&&(this.compForwardComposerContext.dispose(),this.compForwardComposerContext=null),this.compMirrorComposerContext&&(this.compMirrorComposerContext.dispose(),this.compMirrorComposerContext=null),this.shadowComposerContext&&(this.shadowComposerContext.dispose(),this.shadowComposerContext=null),this.depthComposerContext&&(this.depthComposerContext.dispose(),this.depthComposerContext=null),this.normalComposerContext&&(this.normalComposerContext.dispose(),this.normalComposerContext=null),this.normalDepthIoRRoughnessComposerContext&&(this.normalDepthIoRRoughnessComposerContext.dispose(),this.normalDepthIoRRoughnessComposerContext=null),this.normalDepthComposerContext&&(this.normalDepthComposerContext.dispose(),this.normalDepthComposerContext=null),this.outlineDepthComposerContext&&(this.outlineDepthComposerContext.dispose(),this.outlineDepthComposerContext=null),this.mirrorOutlineDepthComposerContext&&(this.mirrorOutlineDepthComposerContext.dispose(),this.mirrorOutlineDepthComposerContext=null),this.occlusionDepthComposerContext&&(this.occlusionDepthComposerContext.dispose(),this.occlusionDepthComposerContext=null),this.highlightDepthComposerContext&&(this.highlightDepthComposerContext.dispose(),this.highlightDepthComposerContext=null),this.opaqueOnlyComposerContext&&(this.opaqueOnlyComposerContext.dispose(),this.opaqueOnlyComposerContext=null),this.colorComposerContext&&(this.colorComposerContext.dispose(),this.colorComposerContext=null),this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.dispose(),this.pickingGPUComposerContext=null),this.pickingGPUInstancingComposerContext&&(this.pickingGPUInstancingComposerContext.dispose(),this.pickingGPUInstancingComposerContext=null),this.auxiliaryViewpointComposerContext&&(this.auxiliaryViewpointComposerContext.dispose(),this.auxiliaryViewpointComposerContext=null),this.lensFlarePass&&(this.lensFlarePass.dispose(),this.lensFlarePass=null);for(var e=0;e<this.allEffects.length;e++)this.allEffects[e]&&this.allEffects[e].dispose&&this.allEffects[e].dispose();for(e=0;e<this.customEffects.length;e++)this.customEffects[e]&&this.customEffects[e].dispose&&this.customEffects[e].dispose();for(var t in this.renderer.fixedSizeArrayPool.dispose(),this.allEffects=null,this.customEffects=null,this.mainComposer.dispose(),this.renderer.dispose(),this)this.hasOwnProperty(t)&&(this[t]=null)},isDeviceCompatibleWithSSR:function(){return this.renderer.supportsFloatTextures()},isDeviceCompatibleWithSSAO:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},isDeviceCompatibleWithOIT:function(){return this.renderer.supportsFloatTextures()||this.renderer.supportsHalfFloatTextures()},setDisableBackFaceCulling:function(e){this.disableBackFaceCulling=e,this.forwardPass&&(this.forwardPass.setDisableBackFaceCulling(this.disableBackFaceCulling),this.zPostPass.setDisableBackFaceCulling(this.disableBackFaceCulling))},clearCameraSystemData:function(){this.superFinalComposer=null},resizeNPOTTexture:function(){this.NoPowerOfTwoEffect||this.initEffect("noPowerOfTwoEffect");for(let i of this.renderer._texturesToResize){var e=new t.NonPowerOfTwoTexture(i,i.mipmaps);this.NoPowerOfTwoEffect.setTextures(e),this.NoPowerOfTwoEffect.copyToDataTexture(this.gl,i),i.format=1021,i.needsUpdate=!0}this.renderer._texturesToResize.clear(),this.NoPowerOfTwoEffect.dispose()},recompileAllShaders:function(e){this.renderer.recompileAllShaders(e)},updateClippingScene:function(e){var i,r=e.getBoundingSphere(),n=new t.Vector3;for(i=0;i<this.renderer.clipPlanes.length;i++){var s=this.renderer.clipPlanes[i].clone();s.constant+=this.renderer.clipPlanesTolerance,s.projectPoint(r.center,n);var a=this.clippingScene.children[i];a.matrixAutoUpdate=!1,a.matrixWorldNeedsUpdate=!1;var o=s.normal.clone().multiplyScalar(-1),l=(s.constant,new t.Vector3),h=new t.Vector3(1,0,0);Math.abs(o.y)<=.01&&Math.abs(o.z)<=.01&&(h=new t.Vector3(0,1,0)),l.crossVectors(o,h),l.normalize(),h.crossVectors(o,l),a.matrixWorld.set(1*l.x,1*h.x,1*o.x,n.x,1*l.y,1*h.y,1*o.y,n.y,1*l.z,1*h.z,1*o.z,n.z,0,0,0,1)}},setSectionCappingMaterial:function(e,i){this.resetGSSOCache();var r,n=this.renderer;e.clippingContext||(e.clippingContext={}),e.clippingContext[n.id]||(e.clippingContext[n.id]={useCount:0}),r=e.clippingContext[n.id],i||0===i?i instanceof t.Material?r.sectionCappingMaterial=i.clone():r.sectionCappingMaterial=new t.MeshBasicMaterial({color:new t.Color(i)}):(r.sectionCappingMaterial=t.MaterialUtils.createShinyFaceMaterial({color:new t.Color(0)}),r.sectionCappingMaterial.clipPlaneUseModelMaterial=!0),this.resetClippingScene()},requestClippingUpdate:function(){this.needClippingUpdate=!0},updateClippingGlobals:function(e,i,r,n,s){let a=!1;if(this.renderer.clippingSphereOptim&&this.clipPlaneInfos&&this.clipPlaneInfos.needGSSOUpdate()&&(a=!0),e._needClippingUpdate){this.clipPlaneInfos=null;var o=r.renderer,l=i.getAllWebGLObjects(o.currentFrameIndex);if(!l)return;e._needClippingUpdate=!1;var h,c,d,u,p,f,g=null,m=0,v=!1,_=0,y=0,S=0;if(n.length>0)for(g=new Set,h=0;h<n.length;h++){let e=n[h];g.add(e)}for(h=0;h<l.length;h++)if(l[h]&&(c=l[h].object._occurrence)){if(d=c.clippingContext){for(u=0;u<d.planes.length;u++){null===g&&(g=new Set);let e=d.planes[u];g.add(e)}d._clipPolyLine&&(d._clipPolyLine.updateBoundingSphere(e.getBoundingSphere()),(f=d._clipPolyLine.getMaxSize())>m&&(m=f),d._clipPolyLine.getCount()>S&&(S=d._clipPolyLine.getCount())),d._getScissorPolyLineSize()>_&&(_=d._getScissorPolyLineSize()),d._getScissorNbPolygons()>y&&(y=d._getScissorNbPolygons()),d.cylinder&&(v=!0)}c.occurrenceRenderingOverride&&((p=c.occurrenceRenderingOverride.clipPolyLine)&&(p.updateBoundingSphere(e.getBoundingSphere()),(f=p.getMaxSize())>m&&(m=f),p.getCount()>S&&(S=p.getCount())),c.occurrenceRenderingOverride.getClipCylinder()&&(v=!0))}var x=!1;o.maxPolyLineSize===m&&o.useClippingCylinder===v&&o.maxScissorSize===_&&o.maxNbScissor===y&&o.maxNbPolyLine===S||(o.maxPolyLineSize=m,o.maxScissorSize=_,o.maxNbScissor=y,o.maxNbPolyLine=S,o.useClippingCylinder=v,x=!0);var b=o.clipPlanes,w=g?g.size:0,M=!1;if(w!==b.length)M=!0;else if(w>0)for(h=0;h<w&&!M;h++)g.has(b[h])||(M=!0);if(M){a=!0;var C=o.clipPlanes,P=[];o.clipPlanes=P,g&&g.forEach(function(e){e.upVector||(e.upVector=new t.Vector3(0,0,1)),e.clippingContext||(e.clippingContext={}),e.clippingContext[o.id]||(e.clippingContext[o.id]={}),e.clippingContext[o.id].sectionCappingMaterial||r.setSectionCappingMaterial(e,null),e.clippingContext[o.id].clippingPlaneAdded=!0,P.push(e)}),0!==C.length&&0!==P.length||(x=!0),s&&(s.updateShadowMap=!0),r.resetClippingScene()}g&&(this.clipPlaneInfos=new J,this.clipPlaneInfos.setFromPlaneSet(g)),x&&(a=!0,o.recompileAllShaders(null))}a&&this.resetGSSOCache()},updateSectionCappingScene:function(e,r){if(!this.clippingScene){this.clippingScene=new t.Scene,this.clippingScene.autoUpdateScene=!1,this.clippingScene.matrixWorldNeedsUpdate=!1,this.clippingScene.matrixAutoUpdate=!1;var n,s=e.getBoundingSphere(),a=new t.PlaneGeometry(50*s.radius,50*s.radius);for(i=0;i<this.renderer.clipPlanes.length;i++){var o=(n=this.renderer.clipPlanes[i].clippingContext[this.renderer.id]).sectionCappingMaterial;o&&((o=o.clone()).clipPlaneIndex=i+1);var l=new t.Mesh(a,o||t.MaterialUtils.createShinyFaceMaterial({color:"purple"}));l.clippingPlane=this.renderer.clipPlanes[i],n.clippingMeshIndex=i+1,this.clippingScene.add(l)}for(i=0;i<r.children.length;i++){var h=r.children[i];h instanceof t.Light&&this.clippingScene.add(h.clone())}}var c,d=this.mainComposer.getAllPasses();for(i=0;i<d.length;i++)(c=d[i]).renderCuttingElements&&c.setCuttingScene(this.clippingScene);this.updateClippingScene(e)},getQuarterWidth:function(){return Math.ceil(.25*this.viewportWidth)},getQuarterHeight:function(){return Math.ceil(.25*this.viewportHeight)}});Object.defineProperty($.prototype,"gpuPickingTolerance",{get:function(){return this.renderer._gpuPickingTolerance},set:function(e){this.renderer._gpuPickingTolerance=e,this.smallTargetPicking&&(this.pickingGPUComposerContext&&(this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.pickingGPUComposerContext.needsUpdate=!0),this.normalComposerContext&&(this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext.needsUpdate=!0),this.depthComposerContext&&(this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext.needsUpdate=!0))}}),Object.defineProperty($.prototype,"heuristicNormalRadius",{get:function(){return this.renderer._heuristicNormalRadius},set:function(e){if(this.renderer._heuristicNormalRadius=e,this.smallTargetPicking&&this.gpuPositionComposerContext)for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(2*this.heuristicNormalRadius+1,2*this.heuristicNormalRadius+1),this.pickingGPUComposerContext[e].needsUpdate=!0}}),Object.defineProperty($.prototype,"smallTargetPicking",{get:function(){return this.renderer._smallTargetPicking},set:function(e){if(this.renderer._smallTargetPicking=e,e){if(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.normalComposerContext&&this.normalComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.depthComposerContext&&this.depthComposerContext.setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1),this.gpuPositionComposerContext)for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(2*this.gpuPickingTolerance+1,2*this.gpuPickingTolerance+1)}else if(this.pickingGPUComposerContext&&this.pickingGPUComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.normalComposerContext&&this.normalComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.depthComposerContext&&this.depthComposerContext.setSize(this.viewportWidth,this.viewportHeight),this.gpuPositionComposerContext)for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].setSize(this.viewportWidth,this.viewportHeight)}}),$.testMode=!1;class J{constructor(){this.array=[]}reset(){this.array.length=0}setFromPlaneSet(e){e.forEach(e=>{this.array.push(new ee(e))})}needGSSOUpdate(){let e,t=!1;for(e=0;e<this.array.length;e++){let i=this.array[e];i.hasMoved()&&(t=!0),i.update()}return t}}class ee{constructor(e){this.plane=e,this.previousPlane=new t.Plane}update(){this.previousPlane.copy(this.plane)}hasMoved(){return this.previousPlane.normal.x!==this.plane.normal.x||this.previousPlane.normal.y!==this.plane.normal.y||this.previousPlane.normal.z!==this.plane.normal.z||this.previousPlane.constant!==this.plane.constant}}return $}),define("Visualization/WebGLV6Renderer",["DS/Visualization/WebGLV6Renderer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/WebGLV6Renderer"),e}),define("DS/Visualization/ViewManager",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CoreEvents/Events","DS/CSICommandBinder/CSICommandBinder","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/Mesh","DS/Visualization/Filters/MaterialToUseFilter"],function(e,t,i,r,n,s,a,o){"use strict";var l={},h={},c={},d={},u=new Map,p={},f=null;function g(e,t){e.viewer=t.viewer,e.views=t.views,e._updatePlane=t._updatePlane,e._sceneEnvRootForLights=t._sceneEnvRootForLights,e._sceneEnvRootForAmbiance=t._sceneEnvRootForAmbiance,e._sceneEnvRootForTransientHighlight=t._sceneEnvRootForTransientHighlight,e._viewpointMap=t._viewpointMap}i.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;u.delete(t),f&&f.viewer===t&&(u.delete(p),f=null,u.forEach(function(e,t,i){null===f&&(f=e)}),f&&u.set(p,f))});var m=e.extend({init:function(e){if(e=e||p,f||(f=this),f.viewer!==p&&e===p)u.set(e,this),g(this,f);else if(f.viewer===p&&e!==p)f.viewer=e,u.set(e,this),g(this,f);else if(u.has(e)){g(this,u.get(e))}else u.set(e,this),this.viewer=e,this.views={},this._updatePlane=!0,this._sceneEnvRootForLights=new s("3DSyncSceneEnvRootForLights"),this._sceneEnvRootForAmbiance=new s("3DSyncSceneEnvRootForAmbiance"),this._sceneEnvRootForAmbiance._setIsAlwaysInForeground(!0),this._sceneEnvRootForTransientHighlight=new s("3DSyncSceneEnvRootForTransientHighlight"),this._sceneEnvRootForTransientHighlight.setPickable(a.PICKTHROUGH),this._sceneEnvRootForTransientHighlight.exludeFromBounding(!0),this._sceneEnvRootForTransientHighlight.setVisuFilters({_materialToUseFilter:new o(n.MaterialToUse.highlightMaterial)}),this._viewpointMap=new Map;return this},_executeParameter:function(e){e.setStaticMaterials(l),e.setDefaultMaterials(c),e.setTemporaryBodies(d),e.execute(this),this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane})},clear:function(){for(var e in this.views)delete this.views[e]},addView:function(e,t){var i=this.views[e];return i||(i=t,this.views[e]=i),i},removeView:function(e){var t=this.views[e];return t&&(t=null,this.views[e]=t),t},getView:function(e){var t=this.views[e];return t||(t=new s,this.viewer.addNode(t),this.views[e]=t),t},getKey:function(e){for(var t in this.views)if(e===this.views[t])return t;return null},onVisuAnswer:function(e){return this.viewer._modelEvent.subscribe({event:"VisuAnswer"},e)},unsubscribe:function(e){this.viewer._modelEvent.unsubscribe(e)},_publishVisuAnswer:function(e){e&&this.viewer._modelEvent.publish({event:"VisuAnswer",context:this}),this.viewer.render({updateInfinitePlane:this._updatePlane,ekTrace:!0})},setStaticMaterial:function(e,t){return!(""===e||!t)&&(l[e]=t,!0)},getStaticMaterial:function(e){return l[e]},setStaticLook:function(e,t){return!(""===e||!t)&&(h[e]=t,!0)},getStaticLook:function(e){return!h[e]&&this.viewer._onMissingStaticLookCB&&this.setStaticLook(e,this.viewer._onMissingStaticLookCB(e)),h[e]},setDefaultMaterials:function(e){c=e},getDefaultMaterials:function(){return c},setTemporaryBodies:function(e){d=e||{}},updatePlaneOnViewMessage:function(e){this._updatePlane=e,u.get(this.viewer).updatePlaneOnViewMessage(e)},dispose:function(){const e=Object.keys(h);for(let t=0;t<e.length;t++){let i=e[t];h[i]&&h[i].material&&h[i].material.dispose()}const t=Object.keys(l);for(let e=0;e<t.length;e++){let i=t[e];l[i]&&l[i].dispose()}}});return UWA.namespace("THREEDS/ViewManager",m)}),window.disposedViewers=[],define("DS/Visualization/WebGLViewer",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/Viewpoint","DS/Visualization/InternalSceneGraph","DS/Mesh/MeshUtils","DS/Animation/AnimationEngine","DS/Visualization/WebGLV6Renderer","DS/GPURenderer/BridgeV6Renderer","DS/Visualization/OccurrencePath","UWA/Controls/Abstract","DS/Magnifier/Magnifier","DS/Visualization/TrapSelection","DS/Visualization/MaterialManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SubElement","DS/VisuEvents/EventsManager","DS/Manipulators/ManipulatorManager","DS/Visualization/SceneGraph","DS/Visualization/SceneGraphUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/HighlightSelection","DS/Visualization/PreHighlightSelection","DS/CoreEvents/ModelEvents","DS/Plugins/UserPassManager","DS/Effects/BlurShadowEffect","DS/Visualization/PlaneGrid","DS/Manipulators/TrapSelectionManipulator","DS/Visualization/ClippingContext","DS/Visualization/GetSVGMode","DS/Visualization/RenderPriorityManager","DS/WebRecordEnabler/Adapter","DS/Effects/ConvertCubemapToLatlong","DS/Visualization/Ambience","DS/Visualization/RenderMode","DS/Visualization/RenderStyle","DS/Visualization/BudgetedRenderManager","DS/Visualization/WorldOrientation","DS/EKEventsWeb/EKEvents","DS/VisuEvents/MouseEvent","DS/Visualization/DecalManager","DS/Intersection/VolumeIntersection","DS/Visualization/WebGLViewerEffectSettings","DS/Visualization/ViewpointManager","DS/Visualization/PickingMode","DS/SceneGraphNodes/DirectionalLightNode","DS/VisuMePreferences/MePreferences","DS/QualityManager/QMScoreHandler","DS/Visualization/JSONSettings"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y,S,x,b,w,M,C,P,E,T,A,D,I,R,O,L,V,F,B,N,G,k,U,z,H,W,j,X,q,Z,Y,Q,K,$,J,ee){"use strict";var te=t.NoOccurrences,ie="true"===localStorage.getItem("WebVisuForceHaloHL"),re=0,ne=t.__visibleInCurrentSpace,se={Shaded:["Shading","ShadingEdges","ShadingEdgesHiddenEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],Illustration:["ShadingIllustration"],IllustrationTransparent:["ShadingIllustrationTransparent"],Wireframe:["Wireframe"]},ae={WithEdges:["ShadingEdges","ShadingIllustration","ShadingIllustrationTransparent","Wireframe","ShadingMaterialEdges"],NoEdges:["Shading","ShadingMaterial"],WithEdgesHiddenEdges:["ShadingEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges"],WithEdgesHalfSmoothEdges:["ShadingEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdges"],WithEdgesHalfSmoothEdgesHiddenEdges:["ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges"],WithEdgesNoSmoothEdges:["ShadingEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdges"],WithEdgesNoSmoothEdgesHiddenEdges:["ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"]},oe={true:["ShadingMaterial","ShadingMaterialEdges","ShadingMaterialEdgesHalfSmoothEdges","ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges","ShadingMaterialEdgesHiddenEdges","ShadingMaterialEdgesNoSmoothEdges","ShadingMaterialEdgesNoSmoothEdgesHiddenEdges"],false:["Shading","ShadingEdges","ShadingEdgesHalfSmoothEdges","ShadingEdgesHalfSmoothEdgesHiddenEdges","ShadingEdgesHiddenEdges","ShadingEdgesNoSmoothEdges","ShadingEdgesNoSmoothEdgesHiddenEdges","ShadingIllustration","ShadingIllustrationTransparent","Wireframe"]};let le=(new t.Color).setRGB(150/255,185/255,165/255);const he=t._AmbianceGenerators,ce=t._SSSGenerator;var de=!1;try{OffscreenCanvas&&(de=!0)}catch(e){de=!1}var ue=f.extend({init:function(i){this.id=re++,window.debugWebGLV6Viewer||(window.debugWebGLV6Viewer=this);var r,n=this;i.uniqueName&&(this.uniqueName=i.uniqueName),i.pageObjectName&&(this.pageObjectName=i.pageObjectName),this._executionContext=i.executionContext?i.executionContext:null,this.clearThis=function(){n=null},this.version="9.0",this._familyName=i.familyName?i.familyName:"",this.debugWebgl2=!!i.debugWebgl2,this.debugWebgl2&&!i.multiViewer&&(t.WebGLVersion=2),this._parent(),this._worldOrientation=H.ZUpYRight,this.idPathMatcher=null,this._refPlaneCounter=0,this._refPlaneMap=new Map,this._manipulators={},this.trapSelectionManipulator=null,this.disposed=!1,this._fillXSOMode=!0,this.lastViewerWidth=0,this.lastViewerHeight=0,i=i||{},this._svgMode=!!i.svgMode,this._2DMode=!1,this.div=null,this.divCssElement=null,this.materialManager=null,this.context2D=null,this._nearFarBigScale=!!window.nearFarBigScale,this._sceneGraph=null,this._sceneGraphOverrideSetManager=null,this._sceneGraphStateVersion=null,this._oocManager=null,this._userPassManager=new D(this),this._renderPriorityManager=null,this._modelEvent=new A,this.trapSelection=null,this._renderStyle=null,this._pickingMode=new Q,this._forceSceneMinValue=null,this._backgroundViewMode=t.BackgroundViewMode.NORMAL,this._invertBackgroundNodes=!1,this._pickBackgroundNodes=!0,this._sgOrder=i.sgOrder||!1,this._planeViewMode={mode:t.PlaneViewMode.NORMAL,plane:new t.Plane},i.capturer&&(this.capturer=i.capturer,this.capturer.setViewer(this),i.preserveDrawingBuffer=!0),void 0!==i.div&&(this.div=i.div),void 0!==i.divCssElement&&(this.divCssElement=i.divCssElement),this._useDefaultAmbiancesIBL=void 0===i.useDefaultAmbiancesIBL||i.useDefaultAmbiancesIBL,this.buildSkeleton(),this.buildSkeletonCss(),window.DSWebRecord&&(console.log("registering viewer#"+this.id),b._record_registerObject(this,"WebGLV6Viewer",[this.canvas,this.divTrap])),this.previousMaxSectionPolyLineSize=0,this.ODTMode=i.ODTMode||!1,this.ODTMode&&(t._BinaryPrimitives=!t.IsIE11),this.fetchMePreferenceControls=void 0===i.fetchMePreferenceControls||i.fetchMePreferenceControls,this.fetchMePreferenceSettings=void 0!==i.fetchMePreferenceSettings&&i.fetchMePreferenceSettings,this._configAmbiences=ee.configAmbiences,this._compareSettings=ee.compareSettings,this.ODTMode&&i.ODTAmbiences&&(this._configAmbiences=JSON.parse(i.ODTAmbiences)),this._use_webgpu=!!i.webgpu,this._use_webgpu&&(t.WebGPU=!0),this._use_forwardpass_only=!!i.forwardPassOnly;var s=!1;this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.FallbackForApple&&(s=!!this._configAmbiences.effects.FallbackForApple);var p=t.isMobile();this.mobile=p||!!i.shouldBeMobile||!!i._isVR,void 0===i.mobile||s||(this.mobile=i.mobile,console.warn("Warning: Detected mobile mode override. DO NOT USE IN PRODUCTION.")),t.mobileVersion=this.mobile,t._mobileDevice=this.mobile||p,t._vrDevice=!!i._isVR,t._appleDevice=t.isAppleDevice(),t._visuFaceMaterialsAsPBR||(t._visuFaceMaterialsAsPBR=void 0!==i.visuFaceMaterialsAsPBR&&i.visuFaceMaterialsAsPBR,t._GASFaceMaterialsAsPBR=void 0!==i.GASFaceMaterialsAsPBR&&i.GASFaceMaterialsAsPBR),t._visuFaceMaterialsAsPBR&&(t._GASFaceMaterialsAsPBR=!0),t._GASFaceMaterialsAsPBR&&(t._visuFaceMaterialsAsPBR=!0),this.useHDR=!s&&(void 0===i.hdr||i.hdr),this.multiViewer=void 0!==i.multiViewer&&i.multiViewer,this.multiViewerFix=!0,this.offscreenAPI=void 0!==i.offscreenAPI&&(i.offscreenAPI&&de),this.multiViewerAuto=!!i.multiViewerAuto||this.multiViewer&&localStorage.getItem("multiViewerAuto"),this.multiViewerAuto&&this.offscreenAPI&&(this.multiViewerAuto=!1,this.multiViewer=!0),this.defaultAnimationLoop=void 0===i.defaultAnimationLoop||i.defaultAnimationLoop,B.isReplaying()&&(this.defaultAnimationLoop=!1),this.autoUpdateFrustum=void 0===i.autoUpdateFrustum||i.autoUpdateFrustum,this.autoUpdateLights=!0,this.triLights=void 0!==i.triLights&&i.triLights,this.ambience=new G({viewer:this,v2:!0}),this.ambience.setBackgroundColor(void 0!==i.backgroundColor?i.backgroundColor:0),this.ambience.setBackgroundAlpha(void 0!==i.backgroundAlpha?i.backgroundAlpha:1),this.__tempBackgroundColorODT=void 0!==i.backgroundColor?i.backgroundColor:0,this.planeColor=new t.Color(15658734),this.gridColor=new t.Color(15658734),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.showBgColor=this.ambience.getBackgroundColor().getHex(),this.showPlaneColor=new t.Color(this.planeColor.getHex()),this.showGridColor=new t.Color(this.gridColor.getHex()),this.showGradientBackground=[],this.visibleSpace=void 0!==i.visibleSpace?i.visibleSpace:1,this._updateStaticOverrides=!1,this.visuShadingMode={preset:null,face:null,edge:null,point:null,before2DModeLinesFilter:null,before2DModePointsFilter:null,before2DModeVerticesFilter:null,outline:!1},this.axisFilterStatus=null,this.planesFilterStatus=null,this.pointsFilterStatus=null,this.linesFilterStatus=null,this.verticesFilterStatus=null,this.smallCurvatureEdgesFilterStatus=null,this.lockedRenderMode=new Map,this.sceneGraphState=null,this.cameraSystem=null,this.cameraSystemUpdated=!1,this.lastNbTexturesBeingLoaded=0,this._pageObjectData=null,this._immFrame=null,this.highlightColor=null,this.highlightSets=[],this.picking={activated:!0,trapSelection:!1,showDivTrap:!0,displayHL:!0,forceVisibility:!1,gpu:!0,trapGPU:!1,_trapPrimitiveUsed:!1,trapPrimitive:!1,computeNormalDepth:!0,primitive:!1,tolerance:2},Object.defineProperty(this.picking,"trapSelectionMesh",{set:function(e){console.warn("Invalid useage, please use setPicking API")},get:function(){return console.warn("DEPRECATED: please use .trapSelection and .trapPrimitive instead"),this.trapSelection&&!this.trapPrimitive}}),void 0!==i.highlight&&this.setPicking(i.highlight),this.pPicking={activated:!1,trapSelection:!1,displayHL:!0,forceVisibility:!1,gpu:!0,computeNormalDepth:!1,primitive:!1,disableWhileMoving:!0,preferenceHideHL:!1,tolerance:2},this._showHighlight=!0,void 0!==i.pHighlight&&this.setPrePicking(i.pHighlight),this.lastAddedToPSO=null,void 0===i.usePicking&&void 0===i.usePickingGPU||console.log("usePicking and usePickingGPU parameters are deprecated.\n Use highlight and pHighlight objects instead."),void 0!==i.usePicking&&(this.picking.activated=i.usePicking),void 0!==i.usePickingGPU&&(this.picking.gpu=i.usePickingGPU),void 0!==i.useTrapGPU&&(this.picking.trapGPU=i.useTrapGPU),this.infinitePlane=void 0===i.infinitePlane||i.infinitePlane,this._infinitePlane=this.infinitePlane,this.displayGrid=void 0!==i.displayGrid&&i.displayGrid,this._displayGrid=this.displayGrid,this.displayGridFromBelow=!1,this.autoUpdatePlane=void 0===i.autoUpdatePlane||i.autoUpdatePlane,this.useMirror=void 0!==i.mirror&&(!this.mobile&&i.mirror),this.blurryMirror=!1,this.planeAttenuation=!1,this.useShadowPlane=this._infinitePlane,this.useDefaultLights=void 0===i.defaultLights||i.defaultLights,this.useGroundShadow=void 0!==i.useGroundShadow&&i.useGroundShadow,this.useShadowMap=void 0===i.useShadowMap||i.useShadowMap,this.shadowFilter="PCF",this.shadowQuality="Low",this.shadowMapWidth=void 0!==i.shadowMapWidth?i.shadowMapWidth:4096,this.shadowMapHeight=void 0!==i.shadowMapHeight?i.shadowMapHeight:4096,this.deferred=void 0!==i.deferred&&i.deferred,this.antiAliasing=void 0!==i.antiAliasing?i.antiAliasing:"NoAA",!0===this.antiAliasing?this.antiAliasing="SMAA":!1===this.antiAliasing&&(this.antiAliasing="NoAA");var f=void 0!==i.useOIT&&i.useOIT;i.svgMode&&(f=!1),this.forceRender=!1,this._renderingToTarget=!1,this.visuEnv="None",void 0!==i.displayHighlight&&(this.displayHighlight=i.displayHighlight,this.setPicking({activated:this.displayHighlight,displayHL:this.displayHighlight})),this.useVignetting=void 0!==i.useVignetting&&i.useVignetting,this.useSSAO=void 0!==i.ssao&&i.ssao,this.useSSAOIterative=void 0!==i.ssaoIterative?i.ssaoIterative:!!i.useQualityManager,this.useSSLRDirect=!1,this.useSSLRefraction=!1,this.useBloom=void 0!==i.bloom&&i.bloom,this.useFlare=void 0!==i.flare&&i.flare,this.useDOF=void 0!==i.dof&&i.dof,s?this._viewerEffectSettings=new Z.None(this,{enableOIT:f,useQM:!!i.useQualityManager}):this.mobile?this._viewerEffectSettings=new Z.Mobile(this,{enableOIT:f,useQM:!!i.useQualityManager}):this.useHDR?this._viewerEffectSettings=new Z.Desktop(this,{enableOIT:f,useQM:!!i.useQualityManager}):this._viewerEffectSettings=new Z.NoHDR(this,{enableOIT:f,useQM:!!i.useQualityManager}),this.ssaoParams={dynamicRadius:!0,adaptativeRadius:!0,radius:.04,radiusMin:.01,radiusMax:.12,minPixelRadius:14,attenuation:1,contrast:2,power:1,thresholdAngle:1.35},this.magnifier=null,this.debugShadowLight=void 0!==i.debugShadowLight&&i.debugShadowLight,this.debugBSphere=void 0!==i.debugBSphere&&i.debugBSphere,this.debugPrimitiveBSphere=void 0!==i.debugPrimitiveBSphere&&i.debugPrimitiveBSphere,this.debugRepBBox=void 0!==i.debugRepBBox&&i.debugRepBBox,this.debugPicking=void 0!==i.debugPicking&&i.debugPicking,this.debugNormals=void 0!==i.debugNormals&&i.debugNormals,this.debugBackfaceCulling=void 0!==i.debugBackfaceCulling&&i.debugBackfaceCulling,this.debugPickHybrid=!1;if(this.debugPostProcessing=!1,this.debugShadowMaps=!1,this.debugEvents=0,this.debugFPS=!1,this.debugFPSInfos={fpsCounter:null,fpsArray:[],fpsIndex:0,fpsValue:30,fpsCumul:1200,fpsWindow:40,fpsLastTime:0},this._viewpointManager=new Y(this),this.viewpoints=[],this.currentViewpoint=null,this._currentLOD=.5,this.trackingViewpoint=null,this.internalSceneGraph=null,this._safeInternalSceneGraph=null,this.manipulatorManager=null,this.temporaryEmptyScene=new t.Scene,this.centerMouseDownCB=null,this.mouseMoveCB=null,this.centerMouseUpCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=null,this.rightMouseUpCB=null,this._defaultPicking=null,this.setDefaultPicking(!0),this.pickingPriorityMapping=null,this.forceMultiSel=!1,this.sceneBackground=new t.Scene,this.sceneBackground.isBackground=!0,this.cameraBackgroundNear=1e-4,this.cameraBackgroundFar=1,this.cameraBackground=new t.PerspectiveCamera,this.cameraBackground.setWebGPU(this._use_webgpu),this.sceneBackground.add(this.cameraBackground),this.cameraReflected=new t.PerspectiveCamera,this.cameraReflected.setWebGPU(this._use_webgpu),this.planeGridOrientation=new t.Matrix4,this.infPlane=null,this.infPlaneSmall=null,this.planeSize=200,this.grid=null,this.bigGrid=null,this.gridSize=200,this.gridUnit=1,this.gridStep=.005,this.gridNbSteps=5,this.offsetPlaneSmall=new t.Vector3,this.offsetPlaneBackground=new t.Vector3,this.planeV2=void 0!==i.planeV2&&i.planeV2,this._planeV2Appli=this.planeV2,this._requestedPlaneV2=this.planeV2,this.planeGrid=this.planeV2?new R(this):null,this.ground=null,this.envMap=null,this.envMap2=null,this.envMapExposure=1,this.envMapOffset=0,this.envMapBlur=0,this.sphereEnv=null,this.isRenderIteration=!0,this._lockRenderIteration=!1,this.renderIteration=0,this.timeIter0=0,this.delayBeforeIteration=500,this.devicePixelRatio=t.getDevicePixelRatio()||1,this.SCREEN_WIDTH=800,this.SCREEN_HEIGHT=600,this.lazyResize=void 0!==i.lazyResize&&i.lazyResize,this.lazyResizeTime=300,this.oldCanvasSize={width:this.SCREEN_WIDTH,height:this.SCREEN_HEIGHT,dpr:this.devicePixelRatio,time:(new Date).getTime()},this.initMousePos=null,this.currMousePos=null,this.bSphere=null,this.bBox=null,this.primitiveBSphere=null,this.debugPickingNode=null,this.debugNormalNode=new t.Object3D,this.renderer=null,this._requestRender=!1,this._onlyPostProcess=!0,this._renderParams=[],this.renderFrameCB=null,this.beginRenderFrameCB=null,this.ambientLight=new t.AmbientLight(new t.Color(0)),this._directionalLight=null,this._directionalLight2=null,this._directionalLight3=null,this._dirLightGroundShadow=null,this.groundShadowLatitude=0,this.groundShadowLongitude=0,this.dirLightLatitude=.25,this.dirLightLongitude=0,this.dirLightVector=new t.Vector3(2,1.5,2.5),this.dirLight2Vector=new t.Vector3(0,0,1),this.dirLight3Vector=new t.Vector3(0,0,1),this.lights=[],this.clipPlanes=[],t.intensityCorrection=!0,this._preferenceBackgroundColor=null,this.fetchMePreferenceSettings){this._mePreferencesTokens=[];let e=this;if(!0===this.fetchMePreferenceSettings||!0===this.fetchMePreferenceSettings.PreSelection){let t=function(t){e.pPicking.preferenceHideHL=!t};this._mePreferencesTokens.push($.subscribe($.PREFERENCES.PRESELECTION,t))}if(!0===this.fetchMePreferenceSettings||!0===this.fetchMePreferenceSettings.Background){let i=function(i){e._preferenceBackgroundColor=new t.Color(i),"BasicOCA"===e.visuEnv&&e.setVisuEnvOCA("Basic")};this._mePreferencesTokens.push($.subscribe($.PREFERENCES.BACKGROUNDCOLOR,i))}}this.budgetedRenderManager=new z(this),r=new Date,this._oldTime=r.getTime(),this.overrideCursors=!0,this._changeCursorDelay=null,this._temporaryCursorData=null,this._forcePRZ=!1,this._viewer360Manager=null,this._360ModeRequest=null,this._navigationParams={clickToNavigateIn360:!0,reframe360CB:null},this.startPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startPan(e),this._forcePRZ=!0},this.startRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startRotate(e),this._forcePRZ=!0},this.startZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&t.startZoom(e),this._forcePRZ=!0},this.endPan=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endPan(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endRotate=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endRotate(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this.endZoom=function(e){var t=this.currentViewpoint.getControl();null!==t&&(t.endZoom(e),this.setCursor("Auto",0)),this._forcePRZ=!1},this._getPaths=function(e,t,i,r){var n,s;if(t.count!=t.stop){t.count++,i.push(e);var a=e.children;for(s=a.length,n=0;n<s;n++)this._getPaths(a[n],t,i,r);i.pop(),t.count--}else r.push(i.slice(0))},this.addPathToHso=function(e){var t=[],i=y;this._getPaths(this.getRootNode().children[0],{count:0,stop:e},[],t);for(var r=0;r<t.length;r++)i.add({pathElement:new a(t[r])});return t},this.render=function(e){null!=n&&(void 0===e&&(e={}),e.budgeted?n.budgetedRenderManager._askForRender(e):(void 0===e.budgeted&&n.budgetedRenderManager._resetShift(),n._renderParams.push(e),n._requestRender=!0,e&&e.onlyPostProcess||(n._onlyPostProcess=!1)))},this._QMTimer=null,this._QMMode=!1,this._forcedDynamicModeFromServer=!1,this._getQMMode=function(e,t,i){if(this._QMMode=!!this._QMTimer&&!i||this._forcedDynamicModeFromServer||e.isMoving()||e._isAnimated()||!!t,this._QMTimer&&!i&&clearTimeout(this._QMTimer),this._QMMode){var r=this;this._QMTimer=setTimeout(function(){clearTimeout(r._QMTimer),r._QMTimer=null,r.render()},r.delayBeforeIteration||500)}return this._QMMode},this._viewpointState={set:!1,viewport:null,rendererViewportWidth:null,rendererViewportHeight:null,gammaOutput:null},this._setupViewpoint=function(e,i){if(e){this._viewpointState.set||(this._viewpointState.set=!0,this._viewpointState.viewport=this.renderer.renderer.getViewport(),this._viewpointState.rendererViewportWidth=this.renderer.viewportWidth,this._viewpointState.rendererViewportHeight=this.renderer.viewportHeight,this._viewpointState.gammaOutput=this.renderer.renderer.gammaOutput);let r=this._viewpointManager.getViewpointScenegraph(e)||this._safeInternalSceneGraph,n=this._viewpointManager.getViewpointRepresentation(e);r.selectSceneInstance(n),this.internalSceneGraph=r,i||(this.autoUpdateFrustum&&this._updateNearFar(e),e.camera.updateProjectionMatrix(),e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix)),e._isMain||(this.renderer.auxiliaryViewpointComposerContext||this.renderer.initComposer("auxiliaryViewpoint"),this.renderer.useAuxiliaryAsForward=!0,this.renderer.renderer.gammaOutput=!0,this.renderer.renderer._doBlendingOnCanvas=!0,this.renderer.useCompositing&&(this._viewpointManager._needClear(e)?this.renderer.auxiliaryViewpointComposerContext.setPassClear(this.renderer.initClearPass,!0,new t.Color(this.renderer.bgColor).multiplyScalar(this.renderer.bgAlpha),this.renderer.bgAlpha):this.renderer.auxiliaryViewpointComposerContext.setPassClear(this.renderer.initClearPass,!0,new t.Color(16777215),0)));let s=this._viewpointManager.getViewpointViewport(e);s&&(this.renderer.renderer.setViewport(s.x,s.y,s.width,s.height),this.renderer.renderer.setScissor(s.x,s.y,s.width,s.height),this.renderer.renderer.enableScissorTest(!0),this.renderer.renderer._enableClearScissor=!0,this.renderer.viewportWidth==s.width&&this.renderer.viewportHeight==s.height||(this.renderer.viewportWidth=s.width,this.renderer.viewportHeight=s.height,this.renderer.setScale(!1)))}else this._viewpointState.set&&(this._viewpointState.set=!1,this.internalSceneGraph=this._safeInternalSceneGraph,this.internalSceneGraph.selectSceneInstance(0),this.renderer.renderer.gammaOutput=this._viewpointState.gammaOutput,this.renderer.useAuxiliaryAsForward=!1,this.renderer.renderer._doBlendingOnCanvas=!1,this.renderer.renderer.setViewport(this._viewpointState.viewport.x,this._viewpointState.viewport.y,this._viewpointState.viewport.width,this._viewpointState.viewport.height),this.renderer.renderer.enableScissorTest(!1),this.renderer.renderer._enableClearScissor=!1,this.renderer.viewportWidth==this._viewpointState.rendererViewportWidth&&this.renderer.viewportHeight==this._viewpointState.rendererViewportHeight||(this.renderer.viewportWidth=this._viewpointState.rendererViewportWidth,this.renderer.viewportHeight=this._viewpointState.rendererViewportHeight,this.renderer.setScale(!1)))},this.glRenderMultiVP=function(e){this._shadowUpdated=!1,this.budgetedRenderManager._isActive&&this.budgetedRenderManager._setAsRenderFrame(),this.beginRenderFrameCB&&this.beginRenderFrameCB(),this.renderer.renderer._dBufferNextFrame&&(this.renderer.renderer.requestDBuffer=!0,this.renderer.renderer._dBufferNextFrame=!1),this.renderer.renderer._politeDBufferNextFrame&&(this.renderer.renderer._requestPoliteDepthBuffer=!0,this.renderer.renderer._politeDBufferNextFrame=!1);let i=!1;if(void 0!==e.viewpoint)i=this.glRender(e);else{let t=this._viewpointManager.getVpList(!0);this._viewpointManager.hasMultiView()&&(this.renderer.multiView=!0),t.length>1&&(this.renderer.multiViewpoint=!0);for(let r=0;r<t.length;r++){this._setupViewpoint(t[r]);let n=[...e,{viewpoint:t[r],skipRenderInfoReset:0!=r}];i=this.glRender(n)||i,this._setupViewpoint(null)}this.renderer.multiView=!1}return this.renderer.renderer.requestDBuffer=!1,this.renderer.renderer._requestPoliteDepthBuffer&&(this.renderer.politeDepthBuffer=null),this.renderer.renderer._requestPoliteDepthBuffer=!1,this.ODTMode&&t.ImageUtils.nbTexturesBeingLoaded>0?this.render():this.renderFrameCB&&this.renderFrameCB(),i},this.glRender=function(e){if(!this._initialized)return;var i,r,s,a,o,l,c,d,u,p,f,g,m;this.renderer.renderer.maxPolyLineSize!==this.previousMaxSectionPolyLineSize&&(this.previousMaxSectionPolyLineSize=this.renderer.renderer.maxPolyLineSize,this.renderer&&this.renderer.recompileAllShaders(null)),t.webGLStats&&t.webGLStats.reset();var v=!1,_=null,y=!1,S=!1,x=n.currentViewpoint,b=!0,w=!!e.length,M=!!e.length,E=!1,T=512,A=0,D=0,I=!1,R=!1,O=!1,L=!1,V=!1,F=!1;for(ee=0;ee<e.length;ee++)void 0!==e[ee].needReframe&&(v=e[ee].needReframe),void 0!==e[ee].reframeSpace&&(_=e[ee].reframeSpace),void 0!==e[ee].updateInfinitePlane&&(y=y||e[ee].updateInfinitePlane),void 0!==e[ee].updateInfinitePlaneFast&&(S=S||e[ee].updateInfinitePlaneFast),void 0!==e[ee].renderIteration&&(D=e[ee].renderIteration),void 0!==e[ee].isStillFrame&&(I=e[ee].isStillFrame),void 0!==e[ee].forceRender&&(R=e[ee].forceRender),void 0!==e[ee].viewpoint&&(x=e[ee].viewpoint),void 0!==e[ee].toScreen&&(b=e[ee].toScreen),e[ee].onlyPostProcess||(w=!1),e[ee].onlyForward||(M=!1),void 0!==e[ee].cubemap&&(E=e[ee].cubemap),void 0!==e[ee].cubemapResolution&&(T=e[ee].cubemapResolution),void 0!==e[ee].cubeFace&&(A=e[ee].cubeFace),O||!0!==e[ee].ekTrace||(O=!0),!0===e[ee].forceStaticMode&&(forceStaticMode=!0),!0===e[ee].forceDynamicMode&&(V=!0),!0===e[ee].overrideEffects&&(L=!0),!0===e[ee].skipRenderInfoReset&&(F=!0);O&&(O=W.Trace.traceStart("techno_webvisu","webgl_frame_display"));let B=null!==x&&x.isMain();var N=L?"override":this._getQMMode(x,V,R)?"dynamic":"static",G=L?"override":0===D?"dynamic":"static";if(this._viewerEffectSettings.updateViewerSettings(N,G),n._modelEvent.publish({event:"PreRender",data:{viewer:n,viewpoint:x,trackingViewpoint:n.trackingViewpoint,onlyPostProcess:w,frameType:N}}),B&&this._updateStaticOverrides&&(this._updateStaticOverrides=!1,this.internalSceneGraph.updateStaticOverrides()),f=x.camera,u=null===n.internalSceneGraph?n.temporaryEmptyScene:n.internalSceneGraph.scene,(p=null===n.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):n.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace")).pixelRadius>0){var k=f.getWorldSizeFromPixelSize(1,p.center,this._getDivClientHeight(),2);p.radius+=k*p.pixelRadius}if(null!==x&&(f.updateMatrix(),f.matrixWorld.copy(f.matrix),f.matrixWorldInverse.getInverse(f.matrixWorld),this._viewerEffectSettings.updateAmbienceBackScale(N),this.blurShadowEffect&&this._dirLightGroundShadow&&this.ambience.getGround().needsUpdateShadowIntensity&&(this.ambience.getGround().needsUpdateShadowIntensity=!1,this.blurShadowEffect.setIntensity(this.ambience.getGround().getShadowIntensity()),this._dirLightGroundShadow.updateShadowMap()),this.sphereEnv&&this.ambience.updateCamera(x,this.renderer,f)),n._directionalLight&&n._directionalLight._setShadowCameraVisible(n.debugShadowLight),B){if(n.debugBSphere){if(n.bSphere)n.bSphere.visibilityFree=!0,n.bSphere.visible=!0,n.bSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(p.radius,p.radius,p.radius),i.setPosition(p.center),n.bSphere.setMatrix(i);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.2,transparent:!0,force:!0,forceSide:!0}),(X=P.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.bSphere=X._occurrences[0].renderable,n.bSphere.frustumCulled=!1,n.bSphere.noPickThrough=!1,u.add(n.bSphere)}}else n.bSphere&&(n.bSphere.visibilityFree=!0,n.bSphere.visible=!1);if(n.debugNodeBSphere){var U=null,z=null;if(($=WUX.Selection.HSOManager.get())[0])U=(Z=(q=$[0].pathElement).getLastElement(!0)).getBoundingSphere(),z=q.getWorldMatrix(this);if(U){if(n.nodeBSphere)n.nodeBSphere.visible=!0,n.nodeBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(U.radius,U.radius,U.radius),i.setPosition(U.center),z.multiplyMatrices(z,i),n.nodeBSphere.setMatrix(z);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=P.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.nodeBSphere=X._occurrences[0].renderable,n.nodeBSphere.frustumCulled=!1,u.add(n.nodeBSphere)}}else n.nodeBSphere&&(n.nodeBSphere.visible=!1)}if(n.debugPrimitiveBSphere){var H=null;z=null;if(($=WUX.Selection.HSOManager.get())[0])(Z=(q=$[0].pathElement).getLastElement()).sgNode&&Z.sgNode.boundingSphere&&(H=Z.sgNode.boundingSphere,z=q.getWorldMatrix(this));if(H){if(n.primitiveBSphere)n.primitiveBSphere.visible=!0,n.primitiveBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(H.radius,H.radius,H.radius),i.setPosition({x:H.center[0],y:H.center[1],z:H.center[2]}),z.multiplyMatrices(z,i),n.primitiveBSphere.setMatrix(z);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=P.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.primitiveBSphere=X._occurrences[0].renderable,n.primitiveBSphere.frustumCulled=!1,u.add(n.primitiveBSphere)}}else n.primitiveBSphere&&(n.primitiveBSphere.visible=!1)}if(n.debugRepBSphere){var j=null;z=null;if(($=WUX.Selection.HSOManager.get())[0])(Z=(q=$[0].pathElement).getLastElement()).sgNode&&Z.sgNode.rep&&Z.sgNode.rep.boundingSphere&&(j=Z.sgNode.rep.boundingSphere,z=q.getWorldMatrix(this));if(j){if(n.repBSphere)n.repBSphere.visible=!0,n.repBSphere.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(j.radius,j.radius,j.radius),i.setPosition({x:j.center[0],y:j.center[1],z:j.center[2]}),z.multiplyMatrices(z,i),n.repBSphere.setMatrix(z);else if(null!==u){var X;r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(X=P.createSphereNode({radius:1,sag:32,material:r})).setPickable(2),n.repBSphere=X._occurrences[0].renderable,n.repBSphere.frustumCulled=!1,u.add(n.repBSphere)}}else n.repBSphere&&(n.repBSphere.visible=!1)}if(n.debugRepBBox){var q,Z,Y=null;z=null;if(($=WUX.Selection.HSOManager.get())[0])(Z=(q=$[0].pathElement).getLastElement()).getBoundingBox()&&(Y=Z.getBoundingBox(),z=q.getWorldMatrix(this));else Y=this.getSceneBoundingBox(),z=this.internalSceneGraph.root.getMatrix();if(Y)if(n.bBox)n.bBox.visible=!0,n.bBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(Y.max.x-Y.min.x,Y.max.y-Y.min.y,Y.max.z-Y.min.z),i.setPosition({x:Y.min.x+(Y.max.x-Y.min.x)/2,y:Y.min.y+(Y.max.y-Y.min.y)/2,z:Y.min.z+(Y.max.z-Y.min.z)/2}),z.multiplyMatrices(z,i),n.bBox.setMatrix(z);else if(null!==u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0});var Q=P.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r});n.bBox=Q._occurrences[0].renderable,n.bBox.frustumCulled=!1,n.bBox.pickable=!1,u.add(n.bBox)}}else n.bBox&&(n.bBox.visible=!1);if(n.debugLocalBBox){var K=(new t.Matrix4).identity();n.debugHandleMatrix&&K.copy(x.camera.matrix);for(var $=WUX.Selection.HSOManager.get(),J=[],ee=0;ee<$.length;ee++)J.push($[ee].pathElement);var te=C.getOrientedBoundingBoxFromPathElements(J,K,n).localBBox;if(te){if(n.localBBox)n.localBBox.visible=!0,n.localBBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(te.max.x-te.min.x,te.max.y-te.min.y,te.max.z-te.min.z),i.setPosition({x:te.min.x+.5*(te.max.x-te.min.x),y:te.min.y+.5*(te.max.y-te.min.y),z:te.min.z+.5*(te.max.z-te.min.z)}),K.multiplyMatrices(K,i),n.localBBox.setMatrix(K);else if(u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(Q=P.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.localBBox=Q._occurrences[0].renderable,n.localBBox.frustumCulled=!1,u.add(n.localBBox)}}else n.localBBox&&(n.localBBox.visible=!1)}if(n.debugBBox){K=(new t.Matrix4).identity();n.debugHandleMatrix&&K.copy(x.camera.matrix);var ie=this.computeSceneAccurateBoundingBox(n.visibleSpace?"visibleSpace":"invisibleSpace",n.debugHandleMatrix?K:null);if(ie){if(n.BBox)n.BBox.visible=!0,n.BBox.matrix=new t.Matrix4,(i=new t.Matrix4).makeScale(ie.max.x-ie.min.x,ie.max.y-ie.min.y,ie.max.z-ie.min.z),i.setPosition({x:ie.min.x+.5*(ie.max.x-ie.min.x),y:ie.min.y+.5*(ie.max.y-ie.min.y),z:ie.min.z+.5*(ie.max.z-ie.min.z)}),K.multiplyMatrices(K,i),n.BBox.setMatrix(K);else if(u){r=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.3,transparent:!0,force:!0,forceSide:!0}),(Q=P.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1),material:r})).setPickable(2),n.BBox=Q._occurrences[0].renderable,n.BBox.frustumCulled=!1,u.add(n.BBox)}}else n.BBox&&(n.BBox.visible=!1)}else n.BBox&&(n.BBox.visible=!1);var re=this.getRootNode();re&&!n.debugPicking&&null!==n.debugPickingNode&&(n.debugPickingNode.removeChildren(),re.removeChild(n.debugPickingNode),n.debugPickingNode=null),n.debugNormals?(n.debugNormalNode.children.length||function(){if(null===n.internalSceneGraph)return;var e,i,r,s,a,o,l,c,d,u,p,f,g,m,v,_,y,S,x=n.internalSceneGraph.scene.getMeshInstances();for(_=0;_<x.length;_++){for(e=x[_],i=.05*e.boundingSphere.radius,r=null,s=0,e.geometry.length>=0?(r=e.geometry[0],s=e.geometry.length):2===e.geometry._type&&(r=e.geometry,s=1),a=[],S=0;S<s;S++){if(o=r.vertexPositionArray,null!==(l=r.vertexNormalArray))for(y=0;y<o.length;y+=3)a.push({x:o[y],y:o[y+1],z:o[y+2]}),a.push({x:o[y]+i*l[y],y:o[y+1]+i*l[y+1],z:o[y+2]+i*l[y+2]});r=e.geometry[S+1]}if(a.length){for((c=new h.PrimitiveGroup).fillAttr=new h.FillAttributes,c.lineAttr=new h.LineAttributes,c.pointAttr=new h.PointAttributes,(d=new h.Buffer).size=3*a.length,d.component=h.VertexComponentEnum.POSITION,d.format=h.DataTypeEnum.FLOAT,d.dimension=3,d.data=new Float32Array(d.size),c.addBuffer(0,d),v=d.data,S=0,y=0;y<a.length;y++)v[S++]=a[y].x,v[S++]=a[y].y,v[S++]=a[y].z;for(u=Math.ceil(a.length/65534),p=0,y=0;y<u;y++)(f=new h.Primitive).nbIndices=Math.min(a.length-p,65534),f.connectivity=h.ConnectivityTypeEnum.LINES,f.attr={fill:new h.FillAttributes,line:new h.LineAttributes(new h.Color(0,0,1,1)),point:new h.PointAttributes},(g=new h.VertexComponent).component=h.VertexComponentEnum.POSITION,g.nbVertices=3*Math.min(a.length-p,65534),g.nbValuesPerVertex=3,g.format=h.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=0,g.offset=p,g.indices=null,f.addVertexComponent(g),c.addPrimitive(f),p+=65534;(m=P.createMeshNode(c)).mesh3js.setMatrix((new t.Matrix4).copy(e.matrixWorld)),m.setPickable(!1),m.mesh3js.castShadow=!1,m.mesh3js.receiveShadow=!1,n.debugNormalNode.add(m.mesh3js)}}}(),u.add(n.debugNormalNode)):(u.remove(n.debugNormalNode),n.debugNormalNode.children=[])}if(B&&this.ambience&&this.ambience.updateLights(x,this.internalSceneGraph,p,n.useShadowMap),B&&n.useDefaultLights){if(ve=n._directionalLight,s=n._directionalLight2,a=n._directionalLight3,null!==p)if(n.triLights){var ne=x.getUpDirection(),se=x.getSightDirection(),ae=(new t.Vector3).crossVectors(se,ne);n.autoUpdateLights&&(o=new t.Vector3(1,1,1).normalize(),ve.setDirection(o,n.renderer.renderer.baseLightDirection),l=(new t.Vector3).copy(ne).sub(se).sub(ae).normalize(),s.setDirection(l,n.renderer.renderer.baseLightDirection),c=(new t.Vector3).copy(ae).sub(se).normalize(),a.setDirection(c,n.renderer.renderer.baseLightDirection))}else if(n.autoUpdateLights){var oe=2;ae=1.5,ne=2.5;let e=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(oe).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(ae)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(ne));e.normalize(),ve.setDirection(e,n.renderer.renderer.baseLightDirection);oe=-2,ae=1.5,ne=2.5;(l=(new t.Vector3).copy(n._worldOrientation.frontVector).multiplyScalar(oe).add((new t.Vector3).copy(n._worldOrientation.rightVector).multiplyScalar(ae)).add((new t.Vector3).copy(n._worldOrientation.upVector).multiplyScalar(ne))).normalize(),s.setDirection(l,n.renderer.renderer.baseLightDirection)}n._directionalLight.castShadows(n.useShadowMap&&ve._intensity)}if(this._2DMode?(this.ground&&(this.ground.visible=!1),this.sphereEnv&&(this.sphereEnv.visible=!1)):this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()?(this.ground||this._setPhysicalGround(this.ambience.getGroundGeometry()),this.ambience.updateGround(this.ground)):this.ground&&(this.ground.visible=!1),!B||this.ambience.needUpdateIBL.has(this)||this.internalSceneGraph.scene.reflectionProbes)B&&this.renderer.multiView&&this.internalSceneGraph!=this._safeInternalSceneGraph&&(this.internalSceneGraph.scene.ambienceMatrix=this._safeInternalSceneGraph.scene.ambienceMatrix,this.internalSceneGraph.scene.envMipMap=this._safeInternalSceneGraph.scene.envMipMap);else{var le=this.ambience.getIblMap(),he=this.ambience.getRoughnessMap();le?(this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),n.internalSceneGraph.scene.envMipMap[0]=le,n.internalSceneGraph.scene.envMipMap[1]=he,this.sceneBackground.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0),this.sceneBackground.envMipMap[0]=le,this.sceneBackground.envMipMap[1]=he):(n.internalSceneGraph.scene.envMipMap=[],this.sceneBackground.envMipMap=[]),n.renderer.renderer.ambianceGenerators._decreaseSceneUseCount(n.internalSceneGraph.scene),n.renderer&&n.renderer.recompileAllShaders(null),this.ambience.needUpdateIBL.add(this)}if(!n._displayGrid&&(null!==n.grid&&n.grid.visible||null!==n.bigGrid&&n.bigGrid.visible)&&n._removeGrid(),!n._displayGrid&&n.planeGrid&&n.planeGrid.updateVisibility(),g=100,B&&null!==p&&(n._displayGrid||n._infinitePlane||n.useShadowPlane||n.ambience.getGround().isActivated()||n.ambience.isFiniteMode())){"yup"===this._worldOrientation._woName?(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.z=p.center.z):(n.offsetPlaneSmall.x=p.center.x,n.offsetPlaneSmall.y=p.center.y);var ce=2*p.radius;n._updateOffsetPlane(p,f,y,S);var de=n._getPlaneSize(p,f,n.gridUnit,n.gridStep);de!==n.planeSize&&(n.planeSize=de,n.autoUpdateFrustum&&n._updateNearFar(x)),d=-f.getLookAt().dot(this._worldOrientation.upVector);var ue=f.position.dot(this._worldOrientation.upVector)-n.offsetPlaneBackground.dot(this._worldOrientation.upVector);if((g=f.isOrtho?d:ue)>0&&n.useShadowPlane&&!n._2DMode){var pe=(new t.Vector3).copy(n.offsetPlaneSmall);pe.x-=.001*g*this._worldOrientation.upVector.x,pe.y-=.001*g*this._worldOrientation.upVector.y,pe.z-=.001*g*this._worldOrientation.upVector.z;var fe=Math.PI*Math.max(.1,.5-n.dirLightLatitude);ce*=Math.sin(fe)+(Math.cos(fe)+1)/Math.tan(fe),n.createInfinitePlane(n.infPlaneSmall,0,ce,pe)}else n._removeInfinitePlane(n.infPlaneSmall,!0);if(n.planeV2&&n.planeGrid||n.ambience.usePlaneV2?(n._removeGrid(),n.planeGrid.createPlaneGrid(n.planeSize,n.offsetPlaneBackground,x,n.ambience.isAutoGroundOffset(),n.planeGridOrientation,n.renderer.renderer.simpleGamma)):(n._infinitePlane&&n.createInfinitePlane(n.infPlane,1,n.planeSize,n.offsetPlaneBackground),n._displayGrid&&(g>0||this.displayGridFromBelow?n.createGrid(n.planeSize,n.offsetPlaneBackground,Math.abs(ue),Math.abs(d),y):n._removeGrid()),(m=(new t.Vector3).copy(n.offsetPlaneBackground)).applyMatrix4(f.matrixWorldInverse),null!==this.grid&&(this.grid.material.updatePDSFXUniform("gridCenter",m.clone()),null!==this.bigGrid&&this.bigGrid.material.updatePDSFXUniform("gridCenter",m.clone()))),n.useGroundShadow){var ge=n._dirLightGroundShadow,me=(oe=Math.sin(Math.PI*this.groundShadowLatitude)*Math.cos(2*Math.PI*this.groundShadowLongitude),ae=Math.sin(Math.PI*this.groundShadowLatitude)*Math.sin(2*Math.PI*this.groundShadowLongitude),ne=Math.cos(Math.PI*this.groundShadowLatitude),(new t.Vector3).copy(this._worldOrientation.frontVector).multiplyScalar(oe).add((new t.Vector3).copy(this._worldOrientation.rightVector).multiplyScalar(ae)).add((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(ne)));ge.setDirection(me,this.renderer.renderer.baseLightDirection),ge._castGroundShadows(!0);let e=new t.Matrix4;n.infPlaneSmall&&e.copy(n.infPlaneSmall.matrix),ge.light3js._matrixWorldReceiver=e;for(let t=0;t<ge._occurrences.length;t++)ge._occurrences[t].renderable._matrixWorldReceiver=e}else n._dirLightGroundShadow._castGroundShadows(!1)}for(ee=0;ee<u.__lights.length;ee++){var ve=u.__lights[ee];u.children.includes(ve)&&ve.updateMatrix();var _e=!1;ve._occurrence&&(_e=ve._occurrence.node._attachedToVpt),_e&&(ve._vptUp=x.getUpDirection(),ve._vptSight=x.getSightDirection(),ve._vptPosition=x.getEyePosition()),ve._sceneShadow&&ve.updateShadowParameters(p,n.renderer.renderer.baseLightDirection)}if(B&&n.updateBackgroundLights(),!this._2DMode)if(this.ambience.getBackground().isActivated()){var ye=this.trackingViewpoint?this.trackingViewpoint:x,Se=(new t.Vector3).copy(ye.camera.position);this.sphereEnv&&(this.sphereEnv.visible=!0),this.sphereEnv||this._setSphereEnv(this.ambience.getSphere()),this.internalSceneGraph.scene.ambienceMatrix=this.ambience.getEnvironmentLightMatrix(!0);var xe=.1*this.cameraBackgroundFar;if(f.isOrtho){var be=1;if(f.fullWidth){var we=f.height/f.fullHeight;we>1&&(be*=we),(we=f.width/f.fullWidth)>1&&(be*=we)}var Me=Math.sqrt(Math.pow(f.right,2)+Math.pow(f.top,2));Me*=be,this.ambience.getBackground().setRatio(be),(xe=Math.max(xe,Me))+this.cameraBackgroundNear>this.cameraBackgroundFar&&(this.cameraBackgroundFar=xe+this.cameraBackgroundNear);var Ce=x.getSightDirection().normalize();Se.addVectors(Se,Ce.multiplyScalar(this.cameraBackgroundNear))}this.ambience.updateSphere(xe,Se,this.sphereEnv)}else this.removeEnvMap();if(n.useGroundShadow&&n.useShadowPlane&&!n._2DMode&&n._setGroundShadow(),this.cameraSystem){this.renderer.renderer._VRFrameBuffer=this.cameraSystem._extFrameBuffer;var Pe,Ee,Te=this.trackingViewpoint||x;if(2===(Pe=this.cameraSystem.computeCameraArray(x,Te.camera.near,Te.camera.far)).length&&(Pe[0]._setStereoLeftRenderingRoleFromPrincipal(f),Pe[1]._setStereoRightRenderingRoleFromPrincipal(f)),this.cameraSystem.useExternalProjectionMatrix){var Ae=1e-4*this.cameraBackgroundFar;this._nearFarBigScale&&(Ae=Math.min(.001,Ae)),Ee=this.cameraSystem.computeCameraArray(x,Ae,this.cameraBackgroundFar)}var De=[],Ie=this.renderer.renderer.getViewportSize();for(ee=0;ee<Pe.length;ee++){if(this.renderer.renderer.cameraSystem_cameraIndex=ee,De.push("cameraSystem"+ee),this.mobile||!this.useHDR?this.renderer.renderer.setSplitScreenMode(ee*Ie.width,0):this.renderer.renderer.removeSplitScreenMode(),this.sphereEnv&&this.sphereEnv.material){var Re=Pe[ee],Oe=this.sphereEnv.material;Re.fullWidth?(Oe.invScreenSize.x=1/Re.width,Oe.invScreenSize.y=1/Re.height,Oe.startOffset.x=Re.x/Re.fullWidth,Oe.endOffset.y=1-Re.y/Re.fullHeight,Oe.endOffset.x=(Re.x+Re.width)/Re.fullWidth,Oe.startOffset.y=1-(Re.y+Re.height)/Re.fullHeight):(Oe.invScreenSize.x=1/Ie.width,Oe.invScreenSize.y=1/Ie.height,Oe.startOffset.x=0,Oe.startOffset.y=0,Oe.endOffset.x=1,Oe.endOffset.y=1)}this.renderCamera(Pe[ee],Ee&&Ee[ee],!1,w,M,E,T,A,D,I,De[ee],g,F)}!this.mobile&&this.useHDR?this.renderer.combineResults(De,b,this.cameraSystem)||this.render():this.renderer.renderer.enableScissorTest(!1)}else this.renderer.renderer._VRFrameBuffer=null,this.renderCamera(f,null,b,w,M,E,T,A,D,I,"main",g,F);return null!==x&&v&&null!==p&&(x.resetCameraOrientation(),x.reframe(void 0,void 0,void 0,_)),t.webGLStats&&t.webGLStats.dump(),O&&O.End(),n._viewerEffectSettings.updateViewerSettingsPostRender(N,G),!w},this._requestShadowMapUpdate=e.subscribe({event:"/VISU/requestShadowMapUpdate"},function(e){n._updateShadowMaps()}),this._requestVisuUpdate=e.subscribe({event:"/VISU/requestVisuUpdate"},function(e){n.render()}),this._updateBackgroundColor=e.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE"},function(e){var i=e.parameters.viewer;if(i&&i.renderer&&i.renderer.renderer&&i.renderer.renderer.__A2XMode){var r=t._getColorMap(i.renderer.renderer)[t.COLORMAP_INDEX.BACKGROUND];"BasicOCA"===i.visuEnv&&i.setBackgroundColor(r.getHex())}}),this.renderCamera=function(e,i,r,n,s,a,o,l,h,c,d,u,p){var f=this.cameraSystem?this.currentViewpoint:e._viewpoint||this.currentViewpoint;if(f._renderedCamera=e,this.internalSceneGraph&&f&&(this.internalSceneGraph.selectionHL.updateHighlight(f),this.internalSceneGraph.selectionPreHL.updateHighlight(f),this.renderer.updateEffects(this.internalSceneGraph,f,h,n)),i)this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=i,this.sceneBackground.add(this.cameraBackground);else{!this.cameraBackground.isOrtho&&!e.isOrtho||this.cameraBackground.isOrtho&&e.isOrtho?e.clone(this.cameraBackground):(this.sceneBackground.remove(this.cameraBackground),this.cameraBackground=e.clone(),this.sceneBackground.add(this.cameraBackground));var g=1e-4*this.cameraBackgroundFar;this._nearFarBigScale&&(g=Math.min(.001,g)),this.cameraBackground.near=g,this.cameraBackground.far=this.cameraBackgroundFar,this.cameraBackground.isOrtho&&(this.cameraBackground.near=this.cameraBackgroundNear),this.cameraBackground.updateProjectionMatrix(),this.cameraBackground.projectionMatrixInverse.getInverse(this.cameraBackground.projectionMatrix)}this.cameraBackground._setBackgroundRenderingRoleFromPrincipal(e),!this.cameraReflected.isOrtho&&!e.isOrtho||this.cameraReflected.isOrtho&&e.isOrtho?e.clone(this.cameraReflected):this.cameraReflected=e.clone(),this.cameraReflected.matrixAutoUpdate=!1;var m="zup"===this._worldOrientation._woName,v=new t.Matrix4(1,0,0,0,0,m?1:-1,0,0,0,0,m?-1:1,0,0,0,0,1),_=2*this._worldOrientation.upVector.dot(this.offsetPlaneBackground);v.setPosition((new t.Vector3).copy(this._worldOrientation.upVector).multiplyScalar(_));var y=(new t.Matrix4).copy(e.matrixWorld);if(v.multiply(y),this.cameraReflected.setMatrix(v),this.cameraReflected._setReflectedRenderingRoleFromPrincipal(e),this.infPlaneSmall&&this.infPlaneSmall.visible){var S=!this.planeV2&&this.infPlane&&this.infPlane.visible||this.planeV2&&!this._requestedPlaneV2&&this.planeGrid&&this.planeGrid.displayPlane?0:1;this.infPlaneSmall.material.updatePDSFXUniform("smallPlaneSSAO",S)}if(this.SCREEN_WIDTH&&this.SCREEN_HEIGHT){var x=u>0&&this.useMirror,b=this._infinitePlane||this._displayGrid||this.ambience.getBackground().isActivated()||x,w=this.useShadowMap&&(this.useDefaultLights||this.isShadowMap());f._updateRobotCamera(this.internalSceneGraph),this.planeV2&&this.planeGrid&&this.planeGrid.updateLabels(f);var M={main:e,cameraBackground:this.cameraBackground,connectedRobotCamera:f.connectedRobotCamera,robotCameraOrtho:f.robotCameraOrtho,mirrorCamera:this.cameraReflected};if(this.renderer.render(b,x,w,this.sceneBackground,M,this.internalSceneGraph,this.infPlaneSmall,this.ambience.getGroundGlossiness(),r,n,this.hasSceneGraphOverrideSet(),s,a,o,l,h,c,d,!this._showHighlight,this.clipPlanes,p),window.__debugLoop__)for(var C=performance.now(),P=0;P<600;)P=performance.now()-C}},this.renderToTarget=function(e,i,r,s,a,o){if(i||r){this._viewerEffectSettings.copySettings("override","static"),a&&Object.entries(this._QMSettings).forEach(e=>{void 0!==n._QMSettings[e[0]].value.override&&(n._QMSettings[e[0]].value.override=e[1].value.static)}),this.renderer.recompileAllShaders([t.RendererMode.override]);var l=n.useSSAOIterative;s?(this._viewerEffectSettings._setFromJson("override",s),void 0!==s.IterativeSSAO&&n.setIterativeSSAO(!!s.IterativeSSAO)):(n.setIterativeSSAO(!1),"MSAA"===n._viewerEffectSettings.getSetting("AntiAliasing","override")&&n._viewerEffectSettings.setSetting("AntiAliasing","override","SMAA"));var h=n._viewerEffectSettings.getSSAO("override"),c="MSAA"===n._viewerEffectSettings.getAntiAliasing("override"),d="FSAA"===n._viewerEffectSettings.getAntiAliasing("override"),u=h&&n.useSSAOIterative||c,p=s&&s.NbIterations?Math.min(s.NbIterations,128):32,f=!1;if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){n._renderingToTarget=!0;var g=this.devicePixelRatio||1;d&&(g*=2);var m=Math.floor(g*n.SCREEN_WIDTH),v=Math.floor(g*n.SCREEN_HEIGHT);if(e||(e={data:null,width:m,height:v,bufferWidth:0,bufferHeight:0,x:0,y:0}),(e.width>m||e.height>v)&&(f=!0),null===e.data||e.bufferWidth<e.width||e.bufferHeight<e.height?d?(e.data=new Uint8Array(4*e.width*e.height*4),e.bufferWidth=2*e.width,e.bufferHeight=2*e.height):(e.data=new Uint8Array(4*e.width*e.height),e.bufferWidth=e.width,e.bufferHeight=e.height):(e.bufferWidth=e.width,e.bufferHeight=e.height),e.x||(e.x=0),e.y||(e.y=0),n.autoUpdateFrustum&&n._updateNearFar(),i){var _=i.camera;_.updateProjectionMatrix(),_.projectionMatrixInverse.getInverse(_.projectionMatrix)}var y=n.getWebGLContext(),S=n.getRenderer();if(S.removeSplitScreenMode(),f){var x=0,b=-1;h&&(x=32,s&&s.MaxOverlap&&(x=s.MaxOverlap),n.renderer.SSAOEffect&&(b=n.renderer.SSAOEffect.maxPixelRadius,n.renderer.SSAOEffect.maxPixelRadius=x));var w=m-2*x,M=v-2*x,C=Math.ceil(e.width/w),P=Math.ceil(e.height/M),E=e.width,T=e.height,A=T-P*M,D=0,I=0,R=E,O=T,L=w,V=M,F=1,B=1;if(i.camera.fullWidth){var N={fullWidth:i.camera.fullWidth,fullHeight:i.camera.fullHeight,x:i.camera.x,y:i.camera.y,width:i.camera.width,height:i.camera.height};R=N.fullWidth,O=N.fullHeight,D=N.x,I=N.y,L*=F=N.width/E,V*=B=N.height/T}for(var G=i.camera,k=new Uint8Array(4*w*M),U=0;U<P;U++)for(var z=0;z<C;z++){var H=Math.min(w,e.width-z*w),W=Math.min(M,e.height-U*M),j=G.clone();if(j._renderingRole=G._renderingRole,j.setViewOffsetInternal(R,O,z*L+D-x*F,U*V+I-x*B,L+2*x*F,V+2*x*B),i.camera=j,u)for(var X=0;X<p;X++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:X}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);y.readPixels(x,x,w,M,y.RGBA,y.UNSIGNED_BYTE,k);var q=P-U-1,Z=0;q>0&&(Z=q*M+A);for(var Y=0;Y<W;Y++)for(var Q=0;Q<H;Q++){var K=E*(Z+Y)+z*w+Q,$=(M-W+Y)*w+Q;e.data[4*K]=k[4*$],e.data[4*K+1]=k[4*$+1],e.data[4*K+2]=k[4*$+2],e.data[4*K+3]=k[4*$+3]}}i.camera=G,b>0&&(n.renderer.SSAOEffect.maxPixelRadius=b)}else if(r){var J={xMin:Math.max(0,-e.x),xMax:Math.max(0,e.x+e.width-m),yMin:Math.max(0,-e.y),yMax:Math.max(0,e.y+e.height-v)},ee=J.xMin>0||J.xMax>0||J.yMin>0||J.yMax>0,te=e.x,ie=e.y;if(ee)(re=(G=i.camera).clone())._renderingRole=G._renderingRole,re.setViewOffsetInternal(m,v,J.xMin>0?-J.xMin:J.xMax>0?J.xMax:0,J.yMin>0?J.yMin:J.yMax>0?-J.yMax:0,m,v),i.camera=re,te=J.xMin>0?0:J.xMax>0?m-e.width:e.x,ie=J.yMin>0?0:J.yMax>0?v-e.height:e.y;if(S.setScissor(te,ie,e.width,e.height),S.enableScissorTest(!0),u)for(X=0;X<p;X++)i?n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:X}]):n.glRenderMultiVP([{toScreen:!1,overrideEffects:!0,renderIteration:X}]);else i?n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]):n.glRenderMultiVP([{toScreen:!1,overrideEffects:!0}]);S.enableScissorTest(!1),ee&&(i.camera=G),y.readPixels(te,ie,e.width,e.height,y.RGBA,y.UNSIGNED_BYTE,e.data)}else{var re;(re=(G=i.camera).clone())._renderingRole=G._renderingRole;te=.5*(m-e.bufferWidth),ie=.5*(v-e.bufferHeight);if(G.fullWidth){te=0,ie=v-e.bufferHeight;var ne=e.width/e.bufferHeight*G.height;re.x-=.5*(ne-re.width),re.width=ne;var se=m/e.bufferWidth,ae=v/e.bufferHeight;re.width*=se,re.height*=ae,this.ambience.setRenderTargetSize(e.width,e.bufferHeight,te,ie)}else this.ambience.setRenderTargetSize(e.width,e.bufferHeight,te,ie),re.setViewOffsetInternal(e.bufferWidth,e.bufferHeight,-.5*(m-e.bufferWidth),-.5*(v-e.bufferHeight),m,v);if(re.updateProjectionMatrix(),re.projectionMatrixInverse.getInverse(re.projectionMatrix),i.camera=re,S.setScissor(Math.max(0,te-8),Math.max(0,ie-8),Math.min(m,e.bufferWidth+16),Math.min(v,e.bufferHeight+16)),S.enableScissorTest(!0),this.ambience.updateParameters(),u)for(X=0;X<p;X++)n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0,renderIteration:X}]);else n.glRender([{viewpoint:i,toScreen:!1,overrideEffects:!0}]);this.ambience.setRenderTargetSize(0,0,0,0),this.ambience.updateParameters(),this.ambience.setRenderTargetSize(0,0,0,0),S.enableScissorTest(!1),i.camera=G,y.readPixels(te,ie,e.bufferWidth,e.bufferHeight,y.RGBA,y.UNSIGNED_BYTE,e.data)}this.ambience.updateParameters(),n.setIterativeSSAO(l),o&&o(),n.mobile?i?n.glRender([{viewpoint:i,onlyPostProcess:!1}]):n.glRenderMultiVP([{onlyPostProcess:!1}]):n.render({onlyPostProcess:!1}),n._renderingToTarget=!1}}else console.error("renderToTarget without specific viewpoint is only supported in subScreen mode")},this._renderToCanvas=function(e,t){var i,r;if(this.svgRootNode){var n;(n=this.svgRootNode.cloneNode(!0)).setAttributeNS(null,"width",this.canvas.width),n.setAttributeNS(null,"height",this.canvas.height),n.style.left=0,n.style.top=0,n.style.width=this.canvas.width+"px",n.style.height=this.canvas.height+"px";var s=n.outerHTML?n.outerHTML:(new XMLSerializer).serializeToString(n),a=new Blob([s],{type:"image/svg+xml;charset=utf-8"}),o=window.URL.createObjectURL(a),l=new Image,h=this;l.onload=function(){i=h.canvas.width,r=h.canvas.height,l.width=i,l.height=r;var t={width:i,height:r,data:null};h.renderToTarget(t,h.currentViewpoint);var n=document.createElement("canvas");n.width=i,n.height=r;for(var s=n.getContext("2d"),a=s.createImageData(i,r),c=a.data,d=0;d<a.height;d++)for(var u=0;u<a.width;u++){var p=u+d*i,f=u+(r-d-1)*i;c[4*p]=t.data[4*f],c[4*p+1]=t.data[4*f+1],c[4*p+2]=t.data[4*f+2],c[4*p+3]=t.data[4*f+3]}s.putImageData(a,0,0),setTimeout(function(){var t=document.createElement("canvas");t.width=i,t.height=r;var s=t.getContext("2d");s.drawImage(l,0,0),s.drawImage(n,0,0),window.URL.revokeObjectURL(o),e(t)},100)},l.onerror=function(){window.URL.revokeObjectURL(o),t()},l.src=o}else{i=this.canvas.width,r=this.canvas.height;var c={width:i,height:r,data:null};this.renderToTarget(c,this.currentViewpoint);var d=document.createElement("canvas");d.width=i,d.height=r;for(var u=d.getContext("2d"),p=u.createImageData(i,r),f=p.data,g=0;g<p.height;g++)for(var m=0;m<p.width;m++){var v=m+g*i,_=m+(r-g-1)*i;f[4*v]=c.data[4*_],f[4*v+1]=c.data[4*_+1],f[4*v+2]=c.data[4*_+2],f[4*v+3]=c.data[4*_+3]}u.putImageData(p,0,0),e(d)}},this.renderCubemap=function(e,i,r,s,a){if(e){if(!s)s={radius:1e6*this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace").radius};if(s.radius){var l=s.radius;s={minAABB:(new t.Vector3).subVectors(e,new t.Vector3(1,1,1).multiplyScalar(l)),maxAABB:(new t.Vector3).addVectors(e,new t.Vector3(1,1,1).multiplyScalar(l))}}var h=new o(this,90,void 0,void 0,!1),c=h.camera;c.aspect=1,c.position=e,c.useQuaternion=!0;for(var d=new t.Vector3,u=0;u<6;u++){switch(u){case 0:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(1,0,0)));break;case 1:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(-1,0,0)));break;case 2:c.up.set(0,0,1),c.lookAt(d.addVectors(e,new t.Vector3(0,1,0)));break;case 3:c.up.set(0,0,-1),c.lookAt(d.addVectors(e,new t.Vector3(0,-1,0)));break;case 4:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(0,0,1)));break;case 5:c.up.set(0,-1,0),c.lookAt(d.addVectors(e,new t.Vector3(0,0,-1)))}c.updateMatrix(),n.autoUpdateFrustum&&n._updateNearFar(),c.updateProjectionMatrix(),c.projectionMatrixInverse.getInverse(c.projectionMatrix),n.glRender([{viewpoint:h,toScreen:!1,onlyForward:!0,cubemap:!0,cubemapResolution:i,cubeFace:u}])}var p=this.renderer.compForwardComposerContext.renderResults.main;require(["DS/Effects/ConvertCubemapToLatlong","DS/Visualization/AmbianceGenerator"],function(i,o){n.renderer.compConvertCubeMapToLatLong||(n.renderer.compConvertCubeMapToLatLong=new i(n.renderer.renderer,n.renderer.renderTargetPool)),n.renderer.compConvertCubeMapToLatLong.setEnvMap(p),he.manager||(he.manager=new o(he.cb));var l=n.renderer.compConvertCubeMapToLatLong.composers[1],h=he.manager._getGenerator("shoot360",!1);h.setCallBack(function(){var i=n.renderer.compConvertCubeMapToLatLong.saveComposer.composerContext.getResult(void 0,!0);i.hdr=!0,i.mapping=new t.LatLongReflectionMapping;var o=h._getResult(),l={position:e,box:new t.Box3(s.minAABB,s.maxAABB)},c={hdr:i,mips:o};Object.assign(c,l),r&&(n.removeReflectionProbes(),n.internalSceneGraph.scene.reflectionProbes=l,n.internalSceneGraph.scene.envMipMap[0]=i,n.internalSceneGraph.scene.envMipMap[1]=o,he._decreaseSceneUseCount(n.internalSceneGraph.scene)),a&&a(c)}),h.setValues(l),n.renderer.compConvertCubeMapToLatLong.execute(),n.renderer.compConvertCubeMapToLatLong.encodeRGBE(),h.execute(),he.manager._disposeGenerator("shoot360",!1)})}else console.error("Missing mandatory paramenters")},this.grabDepthBuffer=function(e){if(n.SCREEN_WIDTH&&n.SCREEN_HEIGHT){var t=this.devicePixelRatio||1,i=Math.floor(t*n.SCREEN_WIDTH),r=Math.floor(t*n.SCREEN_HEIGHT);e||(e={data:null,_dataUint8:null,width:i,height:r,bufferWidth:0,bufferHeight:0}),(e.width>i||e.height>r)&&(e.width=i,e.height=r),(!e._dataUint8||e.bufferWidth<e.width||e.bufferHeight<e.height)&&(e._dataUint8=new Uint8Array(4*e.width*e.height),e.data=null,e.bufferWidth=e.width,e.bufferHeight=e.height);var s=n.getWebGLContext();return this.renderer.computeDepthBuffer(this.internalSceneGraph,this.currentViewpoint,!0),s.readPixels(0,0,e.width,e.height,s.RGBA,s.UNSIGNED_BYTE,e._dataUint8),e.data=new Float32Array(e._dataUint8.buffer),e}};var g=this._getForceRenderTargetSize();g?(this.SCREEN_WIDTH=g.width/this.devicePixelRatio,this.SCREEN_HEIGHT=g.height/this.devicePixelRatio):this.useOffscreenCanvas?(this.SCREEN_WIDTH=this.canvas.width,this.SCREEN_HEIGHT=this.canvas.height):(this.SCREEN_WIDTH=this.canvas.offsetWidth,this.SCREEN_HEIGHT=this.canvas.offsetHeight),this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),this.initResources(this.canvas),this.onWebGLContextLost=function(e){console.log("WebGL context Lost !"),e.preventDefault(),n.setQMGlobalProfile&&n.setQMGlobalProfile("Low")},this._contextMenu=function(e){e.preventDefault()},this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost,!1),this.onWebGLContextRestore=function(){window.__debugLoop__=!1,n.setQMGlobalProfile&&n.setQMGlobalProfile("Low"),n.renderer.renderer.restoreGLContext(),n.render()},this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestore,!1);let m=this._use_webgpu||this._use_forwardpass_only?u:d,v=!(this.useHDR&&!this.mobile||!this.antiAliasing||"NoAA"===this.antiAliasing)||"NoAA";switch(this._use_webgpu&&(v=this.antiAliasing&&"NoAA"!==this.antiAliasing),this.renderer=new m({canvas:this.canvas,context:this.materialManager.getContext(),debugWebgl2:this.debugWebgl2,webgpu:this._use_webgpu,divCSS:this.divCss3DElement,useOffscreenCanvas:this.useOffscreenCanvas,deferred:this.deferred,useCompositing:!this.mobile&&this.useHDR,tonemapping:1,bgColor:this.ambience.getBackgroundColor().getHex(),bgAlpha:this.ambience.getBackgroundAlpha(),viewer:this,visibleSpace:this.visibleSpace,compareSettings:this._compareSettings,antiAliasing:v,forcePostProHighlight:!!i.forcePostProHighlight,preserveDrawingBuffer:i.preserveDrawingBuffer,debugContext:i.debugContext}),this._initialized=!0,this.renderer.renderer._useRenderDepthDL=!!i._useRenderDepthDL,this.renderer.renderer.forceCPUTBCompute=!!i.forceCPUTBCompute,this._viewerEffectSettings._checkCompatibility(),this.renderer.renderer.ssaoParams=this.ssaoParams,this.renderer.renderer.precomputedTexture=this.materialManager.precomputedTexture,this.renderer.renderer.noiseTexture3D=this.materialManager.noiseTexture3D,this.renderer.renderer.precomputedAreaTexture=this.materialManager.precomputedAreaTexture,this.renderer.renderer.ambianceGenerators=he,he.viewers.push(this),this.renderer.renderer.sssGenerator=ce,ce.viewers.push(this),this.renderer.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.newMaterialInheritance=window.newMaterialInheritance,this.antiAliasing){case"NoAA":break;case"FXAA":this.renderer.setEffect("FXAA",!0);break;case"MLAA":this.renderer.setEffect("MLAA",!0);break;case"SMAA":this.renderer.setEffect("SMAA",!0);break;case"MSAA":this.renderer.setEffect("MSAA",!0);break;case"TAA":this.renderer.setEffect("TAA",!0);break;case"FSAA":case"SSAA":this.renderer.setEffect("FSAA",!0)}this.renderer.setEffect("Vignetting",this.useVignetting),this.renderer.setEffect("SSAO",this.useSSAO&&!this.useSSAOIterative),this.renderer.setEffect("SSAOIterative",this.useSSAO&&this.useSSAOIterative),this.renderer.setEffect("DOF",this.useDOF),this.renderer.setEffect("Bloom",this.useBloom),this.renderer.setEffect("Flare",this.useFlare),this.renderer.setEffect("OIT",f),this.renderer.setEffect("OITnoZ",f),this.setPicking({}),this.setPrePicking({}),this.useDefaultLights&&function(){n.setAmbientLight(2236962),n._directionalLight=new K({color:16777215,intensity:.81*Math.PI,sceneShadow:!0},"defaultLight1");let e=n.triLights?.3:.65;n._directionalLight.setShadowOptions({bias:-.001,darkness:e,mapWidth:n.shadowMapWidth,mapHeight:n.shadowMapHeight}),n._directionalLight.castShadows(n.useShadowMap),n._directionalLight.translate(40,new t.Vector3(1,1,1)),n._directionalLight.setDirection(new t.Vector3(2,1.5,2.5).normalize(),n.renderer.renderer.baseLightDirection),n.renderer.renderer.shadowMapAutoUpdate=!0,n.triLights?(n._directionalLight.setIntensity(.49*Math.PI),n._directionalLight2=new K({color:16777215,intensity:.49*Math.PI},"defaultLight2"),n._directionalLight3=new K({color:16777215,intensity:.49*Math.PI},"defaultLight3"),n._directionalLight3.translate(40,new t.Vector3(0,0,1)),n._directionalLight3.setDirection(new t.Vector3(0,0,1).normalize(),n.renderer.renderer.baseLightDirection),n._directionalLight2.setDirection(new t.Vector3(0,0,1).normalize(),n.renderer.renderer.baseLightDirection)):(n._directionalLight2=new K({color:3827071,intensity:1*Math.PI},"defaultLight2"),n._directionalLight2.setDirection(new t.Vector3(-2,1.5,2.5).normalize(),n.renderer.renderer.baseLightDirection));n._directionalLight2.translate(40,new t.Vector3(-1,1,1))}(),n._dirLightGroundShadow=new K({color:16777215,intensity:0,sceneShadow:!0},"groundShadow"),n._dirLightGroundShadow.setShadowOptions({bias:-.001,darkness:.65,mapWidth:n.shadowMapWidth,mapHeight:n.shadowMapHeight}),n._dirLightGroundShadow.translate(40,new t.Vector3(0,0,1)),n._dirLightGroundShadow.setDirection(new t.Vector3(0,0,1).normalize(),n.renderer.renderer.baseLightDirection),n._dirLightGroundShadow._castGroundShadows(n.useGroundShadow),function(e){this.div.appendChild(this.renderer.renderer.domElement),e||document.addEventListener("contextmenu",this._contextMenu,!0);void 0===b._isInit&&b.init();this.manipulatorManager=new w(this)}.apply(this,[i.enableDocumentContextMenu]),this.defaultAnimationLoop&&x(0,!1);let _=-1,S=0;function x(i,r){if(n){n.fpsCounter&&n.fpsCounter.onAnimate(),b.RecordEventsManager&&b.RecordEventsManager.pushRecordAnimateEvent(n),n._idPathOverrideWatcher&&n._idPathOverrideWatcher.update(),!r&&n.defaultAnimationLoop&&requestAnimationFrame(x),n.isRenderIteration||(n.renderIteration=0),n.capturer&&n.capturer.capture(n.canvas,n.renderIteration);var s,a,o,l,h,d,u,p,f=new c,g=new Date,m=g.getTime()-n._oldTime;n._oldTime=g.getTime(),f.step(m),l=!1,p=n.renderer.renderer._renderScale*(t.getDevicePixelRatio()||1);var v=n._getForceRenderTargetSize();v?(d=v.width,u=v.height,n.div.offsetWidth===n.lastViewerWidth&&n.div.offsetHeight===n.lastViewerHeight||(n.currentViewpoint.camera.aspect=n.SCREEN_WIDTH/n.SCREEN_HEIGHT,n.lastViewerWidth=n.div.offsetWidth,n.lastViewerHeight=n.div.offsetHeight,n.canvas.style.width=n.lastViewerWidth+"px",n.canvas.style.height=n.lastViewerHeight+"px")):n.useOffscreenCanvas?(d=n.canvas.width||1,u=n.canvas.height||1):(d=n.div.offsetWidth||1,u=n.div.offsetHeight||1);var y=!1;if(n.lazyResize?n.oldCanvasSize.width!==d||n.oldCanvasSize.height!==u||n.oldCanvasSize.dpr!==p?(n.oldCanvasSize.width=d,n.oldCanvasSize.height=u,n.oldCanvasSize.dpr=p,n.oldCanvasSize.time=(new Date).getTime(),l=!0):n.oldCanvasSize.time>=0&&(new Date).getTime()-n.oldCanvasSize.time>300&&(n.oldCanvasSize.time=-1,y=!0):n.SCREEN_WIDTH===d&&n.SCREEN_HEIGHT===u&&n.devicePixelRatio===p||(y=!0,l=!0),n.devicePixelRatio=p,l&&n.currentViewpoint&&(n.currentViewpoint.camera._hasChanged=!0),n.cameraSystemUpdated&&(n.cameraSystemUpdated=!1,y=2),y&&n.onResize(void 0,2===y),null===n.currentViewpoint){if(0==n._viewpointManager.getVpList(!0).length)return}else if(null!==(a=n.currentViewpoint.getControl())&&a.update(),s=n.currentViewpoint.camera){if(s.updateMatrix(),s.matrixWorld.copy(s.matrix),s.matrixWorldInverse.getInverse(s.matrixWorld),n.autoUpdateFrustum)n._updateNearFar()&&(n.renderIteration=0);s.updateProjectionMatrix(),s.projectionMatrixInverse.getInverse(s.projectionMatrix),(o=s.getLookAt()).add(s.position),l&&e.publish({event:"/VISU/onWindowResized",data:{eventChannel:"/VISU/onWindowResized",eventType:"@onWindowResized",viewpoint:n.currentViewpoint,cameraEye:s.position,cameraTarget:o,cameraUp:s.up}})}l&&n._modelEvent.publish({event:"Resize",data:{width:d,height:u}});var w=!1;if(!n._initialized&&(w=!0,n.renderer._needPerformanceSuite()&&J._locked())){var M=J._getGOFrame();M===_&&++S>3&&(J._unlock(),_=-1,S=0),_=M}n._remoteRenderInfos.videoRender&&n.render(),t.ImageUtils.nbTexturesBeingLoaded<n.lastNbTexturesBeingLoaded&&n.render(),n.lastNbTexturesBeingLoaded=t.ImageUtils.nbTexturesBeingLoaded;var C=n._requestRender;C&&!n._onlyPostProcess&&(n.renderIteration=0),n._onlyPostProcess=!0;var P=!1;n._viewerEffectSettings._setAntiAliasing(n.renderIteration>0?"static":"dynamic"),n.renderIteration<n.renderer.getMaxIterationEffects()&&(P=!0),P=P&&!n.forceRender;var E=!n._QMMode,T=E&&1===n.renderIteration,A=E&&n.renderIteration>0;if(!w&&(C||A&&P||n.forceRender||T)){if(n._requestRender=!1,h=n._renderParams,n._renderParams=[],h.length?(h[0].renderIteration=n.renderIteration,h[0].isStillFrame=A,h[0].forceRender=n.forceRender,h[0].onlyPostProcess=h[0].onlyPostProcess&&!P):h.push({renderIteration:n.renderIteration,isStillFrame:A,forceRender:n.forceRender}),n.forceRender=!1,n.debugFPS){var D=performance.now()-n.debugFPSInfos.fpsLastTime;n.debugFPSInfos.fpsLastTime=performance.now();var I=1e3/Math.max(D,.1);n.debugFPSInfos.fpsCumul+=I,n.debugFPSInfos.fpsCumul-=n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex],n.debugFPSInfos.fpsValue=n.debugFPSInfos.fpsCumul/n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsArray[n.debugFPSInfos.fpsIndex]=I,n.debugFPSInfos.fpsIndex=(n.debugFPSInfos.fpsIndex+1)%n.debugFPSInfos.fpsWindow,n.debugFPSInfos.fpsCounter.setHTML(Math.ceil(n.debugFPSInfos.fpsValue).toString())}var R=n.glRenderMultiVP(h);if(!n)return;if(0===n.renderIteration&&(n.timeIter0=g.getTime()),R&&(P||n.renderIteration<2)&&n.renderIteration++,n.renderer.renderer._texturesToResize.size&&n.renderer.resizeNPOTTexture(),n.context2D){var O=n.materialManager.getCanvas();n.context2D.globalCompositeOperation="copy",n.context2D.drawImage(O,0,O.height-n.canvas.height,n.canvas.width,n.canvas.height,0,0,n.canvas.width,n.canvas.height)}J.useNonBlockingGO&&(n.renderer._activatedTexturePerformanceSuite()?n.renderer.TexturePerformanceEffect.addFrame(i):n.renderer._activatedPixelPerformanceSuite()&&n.renderer.PixelShaderPerformanceEffect.addFrame(i)),n._modelEvent.publish({event:"PostRender",data:{viewer:n,viewpoint:n.currentViewpoint}})}}}return this.animate=x,this.addEvent("onPostInject",function(){x(0,!0)}),this.internalSceneGraph=new l(this,this.multiViewerFix,!i.showReferenceAxisSystem),this._safeInternalSceneGraph=this.internalSceneGraph,this.__selectionHL=new E(this),this.__selectionHL.highlightData.priority=0,this.__selectionPreHL=new T(this),this.__selectionPreHL.highlightData.priority=0,this.internalSceneGraph.selectionHL=this.__selectionHL,this.internalSceneGraph.selectionPreHL=this.__selectionPreHL,this._viewpointManager.setDefaultSceneGraph(this.internalSceneGraph),this.internalSceneGraph.scene.add(this.ambientLight),this.enableDefaultLights(!0),this.internalSceneGraph.addLightNode(this._dirLightGroundShadow),this._glCounters=null,this.fpsCounter=null,this.blurShadowEffect=null,this.displayHighlight=!1,this.name="",this.debugLocalBBox=!1,this.debugBBox=!1,this.debugHandleMatrix=!1,this.localBBox=null,this.BBox=null,(ie=ie||this.ODTMode)||this.setAdvancedPoliteHighlight(null,null),this},setExecutionContext(e){this._executionContext=e||null},setWorldOrientation:function(e){var t;for(this._worldOrientation=e,t=0;t<this.viewpoints.length;t++)this.viewpoints[t]._setWorldOrientation(e);this._setPlaneGridOrientation(),this.internalSceneGraph.setWorldOrientation(e),this.renderer.renderer._setWorldOrientation(e),this._updateDirectionalLightWorldOrientation(e),this.ambience.setWorldOrientation(e),this.render({updateInfinitePlane:!0})},getWorldOrientation:function(){return this._worldOrientation},createCanvas:function(){var e=UWA.createElement("canvas"),t={width:"100%",height:"100%"};return this._svgMode&&!V.getWebGLMode()&&(t.zIndex=10,t.position="absolute",t.left="0px"),e.setStyles(t),this.useOffscreenCanvas&&(e.width=this.div.width,e.height=this.div.height),e},attachCanvas:function(e){if(e.webGLViewer=this,B.isActive()&&(e.setAttribute("data-rec-id","FakeRecManager"),B.registerElement(e,"DS/WebVisuRecord/FakeRec",!0),e.isWebGLCanvas=function(){return!0}),this.canvas&&this.div.removeChild(this.canvas),this.canvas=e,this.div.appendChild(e),this.renderer){this.renderer.canvas=e,this.renderer.renderer.canvas=e,this.renderer.renderer.domElement=e;for(let t=0;t<this.viewpoints.length;t++){let i=this.viewpoints[t].control;i&&i._switchCanvas&&i._switchCanvas(e)}this.onResize(void 0,!0)}},buildSkeleton:function(){null===this.div?(this.elements.container=UWA.createElement("div"),this.div=this.elements.container,this.div.setStyles({width:"100%",height:"100%"})):this.elements.container=UWA.extendElement(this.div),this.div.style["-ms-touch-action"]="none";var e=this.createCanvas();if(this.attachCanvas(e),this._svgMode&&!V.getWebGLMode()){var t=document.createElementNS(this.getSvgNS(),"svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.left="0px",t.style.backgroundColor="white",t.style.zIndex=0,this.svgRootNode=t,this.svgRoot=document.createElementNS(this.getSvgNS(),"g"),this.svgRootNode.appendChild(this.svgRoot),this.div.appendChild(this.svgRootNode)}},getSvgNS:function(){return"http://www.w3.org/2000/svg"},addBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.addChild(e),this._updateSVGVisu())},removeBackgroundSVGNode:function(e){e&&e._cssSVGNode&&(this.renderer.resetGSSOCache(),this.internalSceneGraph.svgRoot.removeChild(e),this._updateSVGVisu())},getAllBackgroundSVGNodes:function(){return this.internalSceneGraph.svgRoot.children.concat([])},clearBackgroundSVGNodes:function(){this.renderer.resetGSSOCache();var e,t=this.getAllBackgroundSVGNodes();for(e=0;e<t.length;e++)this.removeBackgroundSVGNode(t[e])},buildSkeletonCss:function(){null===this.divCssElement?(this.divCssElement=UWA.createElement("div"),this.divCssElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.div.appendChild(this.divCssElement)):this.divCssElement=UWA.extendElement(this.divCssElement),this.divCssElement.style.WebkitTransformStyle="preserve-3d",this.divCssElement.style.MozTransformStyle="preserve-3d",this.divCssElement.style.oTransformStyle="preserve-3d",this.divCssElement.style.transformStyle="preserve-3d",this.divCssElement.id="divCssElement",this.divCss3DElement=UWA.createElement("div"),this.divCss3DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss3DElement.style.WebkitTransformStyle="preserve-3d",this.divCss3DElement.style.MozTransformStyle="preserve-3d",this.divCss3DElement.style.oTransformStyle="preserve-3d",this.divCss3DElement.style.transformStyle="preserve-3d",this.divCss3DElement.id="divCss3DElement",this.divCssElement.appendChild(this.divCss3DElement),this.divCss2DElement=UWA.createElement("div"),this.divCss2DElement.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),this.divCss2DElement.id="divCss2DElement",this.divCssElement.appendChild(this.divCss2DElement),this.divTrap=UWA.createElement("div",{id:"trapSelection"}),this.div.appendChild(this.divTrap)},create2DContext:function(){this.materialManager.setCanvasSize(this,this.canvas.offsetWidth,this.canvas.offsetHeight),this.context2D=this.canvas.getContext("2d")},initResources:function(){var e=(!this.useHDR||this.mobile)&&this.antiAliasing&&"NoAA"!==this.antiAliasing;this.materialManager=new v(d.testMode.testMode,this.multiViewer,e,this,this.multiViewerAuto),this.multiViewer=this.materialManager.multiViewer,(this.multiViewer||this.multiViewerAuto&&this.materialManager.hasMultipleViewers())&&this.create2DContext()},onResize:function(e,t){var i,r;if((o=this._getForceRenderTargetSize())?(this.SCREEN_WIDTH=o.width/this.devicePixelRatio,this.SCREEN_HEIGHT=o.height/this.devicePixelRatio):this.useOffscreenCanvas?(this.SCREEN_WIDTH=this.canvas.width||1,this.SCREEN_HEIGHT=this.canvas.height||1):(this.SCREEN_WIDTH=this.div.offsetWidth||1,this.SCREEN_HEIGHT=this.div.offsetHeight||1),this.svgRoot&&this._updateSVGVisu(),this.context2D){var n=Math.max(1,Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH)),s=Math.max(1,Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT));this.materialManager.setCanvasSize(this,n,s)}if(this.cameraSystem){var a=this.cameraSystem.getViewportSize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT);i=a.width,r=a.height}else i=this.SCREEN_WIDTH,r=this.SCREEN_HEIGHT;var o,l=void 0,h=void 0;(o=this._getForceRenderTargetSize())&&(l=this.div.offsetWidth,h=this.div.offsetHeight),this.renderer.setRendererSize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.useOffscreenCanvas||t,i,r,this.devicePixelRatio,l,h),this._viewpointManager.resize(i,r),this.ambience.resize(i,r,this.devicePixelRatio,this.renderer),this.renderIteration=0,this.render()},getCanvasSize:function(){return{width:Math.floor(this.devicePixelRatio*this.SCREEN_WIDTH),height:Math.floor(this.devicePixelRatio*this.SCREEN_HEIGHT)}},onBackgroundModify:function(e){return this._modelEvent.subscribe({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()},e)},onSwapVisibleSpace:function(e){return this._modelEvent.subscribe({event:"SwapVisibleSpace"},e)},onViewerResize:function(e){return this._modelEvent.subscribe({event:"Resize"},e)},onPreRender:function(e){return this._modelEvent.subscribe({event:"PreRender"},e)},onPostRender:function(e){return this._modelEvent.subscribe({event:"PostRender"},e)},onPreAddRemoveXSO:function(e){return this._modelEvent.subscribe({event:"PreAddRemoveXSO"},e)},onActivate:function(e){return this._modelEvent.subscribe({event:"Activate"},e)},onPreactivate:function(e){return this._modelEvent.subscribe({event:"Preactivate"},e)},onContext:function(e){return this._modelEvent.subscribe({event:"Context"},e)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},unsubscribeFromArray:function(e){if(e&&e.length)for(var t=0;t<e.length;t++)this.unsubscribe(e[t])},setMaterialMode:function(e){var t=this.renderer.renderer.materialMode!==e;this._renderStyle&&(this._renderStyle.setMaterialMode(e),this.internalSceneGraph.root.forceUpdate()),t&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.renderer.resetGSSOCache(),this.renderer.renderer.materialMode=!!e,this.render(),this._modelEvent.publish({event:"MaterialMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getMaterialMode:function(){return this.renderer.renderer.getMaterialMode()},onMaterialModeChange:function(e){return this._modelEvent.subscribe({event:"MaterialMode"},e)},setPlaneViewMode(e){let t,i;e&&(t=e.mode,i=e.plane),this.getRootNode().setPvmFilter({mode:t,plane:i})},setBackgroundViewMode(e){this._backgroundViewMode!==e&&(this._backgroundViewMode=e,this.renderer.renderer._backgroundViewMode=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},getBackgroundViewMode(){return this._backgroundViewMode},invertNodeBackgroundView(e){this._invertBackgroundNodes!==e&&(this._invertBackgroundNodes=e,this.renderer.renderer._invertBackgroundNodes=e,this.renderer.resetGSSOCache(),this.renderer.recompileAllShaders())},isNodeBackgroundViewInverted(){return this._invertBackgroundNodes},pickNodeBackgroundView(e){this._pickBackgroundNodes!==e&&(this._pickBackgroundNodes=e,this.renderer.renderer._pickBackgroundNodes=e,this.renderer.resetGSSOCache())},isNodeBackgroundViewPickable(){return this._pickBackgroundNodes},setGasLookMode:function(e){this.setVisuAppearanceMode(e?t.DefaultAppearanceMode._GASLOOK_OLD:t.DefaultAppearanceMode.BASIC)},setVisuAppearanceMode:function(e){var i=this.renderer.renderer._defaultAppearanceType;if(this.renderer.renderer._defaultAppearanceType=e,i!==this.renderer.renderer._defaultAppearanceType){if(this.renderer.resetGSSOCache(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&i!==t.DefaultAppearanceMode.__QA_AUTOMATION__)switch(i){case t.DefaultAppearanceMode.GASLOOK:case t.DefaultAppearanceMode._GASLOOK_OLD:case t.DefaultAppearanceMode.GENERIC_PLASTIC:case t.DefaultAppearanceMode.GENERIC_METAL:case t.DefaultAppearanceMode._TRANSPARENT:t.cleanPredefinedMaterialCache();break;case t.DefaultAppearanceMode.CAST_ALUMINUM:case t.DefaultAppearanceMode.MACHINED_ALUMINUM:case t.DefaultAppearanceMode.CAST_STEEL:case t.DefaultAppearanceMode.BRUSHED_STEEL:case t.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL:case t.DefaultAppearanceMode.COPPER:case t.DefaultAppearanceMode.BRASS:t.cleanPredefinedMaterialTextureCache()}this.render(),e!==t.DefaultAppearanceMode.__QA_AUTOMATION__&&this._modelEvent.publish({event:"VisuAppearanceMode",data:{viewer:this,value:this.getVisuAppearanceMode()}})}},getVisuAppearanceMode:function(){for(var e=Object.keys(t.DefaultAppearanceMode),i=0;i<e.length;i++)if(t.DefaultAppearanceMode[e[i]]===this.renderer.renderer._defaultAppearanceType)return e[i];return""},onVisuAppearanceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuAppearanceMode"},e)},_setDebugMaterial:function(e){this.renderer.renderer._debugMaterialMode!==e&&(this.renderer.renderer._debugMaterialMode=e,this.renderer.recompileAllShaders(null),this.renderer.resetGSSOCache(),this.render())},setCustomMaterialModeParameters:function(e){if(e&&this.renderer){var i=this.renderer.renderer._customMaterialModeParams,r=!1;if(void 0!==e.useColorFromGAS&&(e.useColorFromGAS!==i.colorFromGAS&&(t.cleanPredefinedMaterialCache(),r=!0),i.colorFromGAS=e.useColorFromGAS),void 0!==e.color){var n=new t.Color(e.color);r=r||i.color.getHex()!==n.getHex(),i.color.copy(n)}void 0!==e.shininess&&(r=r||i.shininess!==e.shininess,i.shininess=e.shininess),void 0!==e.opacity&&(r=r||i.opacity!==e.opacity,i.opacity=e.opacity),r&&(this.renderer.resetGSSOCache(),this.render(),this._modelEvent.publish({event:"CustomMaterialModeParameters",data:{viewer:this,value:i}}))}},getCustomMaterialModeParameters:function(){return this.renderer?this.renderer.renderer._customMaterialModeParams:null},onCustomMaterialModeParametersChange:function(e){return this._modelEvent.subscribe({event:"CustomMaterialModeParameters"},e)},setDefaultPicking:function(i){this._defaultPicking=!!i;if(i){var r=WUX.Selection.PSOManager;this.centerMouseDownCB=function(e,t){},this.mouseMoveCB=function(t,i){if(t.event&&"dragover"==t.event.type&&!this._supportDragPrehighlight)return;var n=t.view;if(b.RecordEventsManager&&!n)return;var o,l,h,c,d=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(n!==d&&!n.renderable){for(;n!==d&&n.parentElement&&!n.renderable;)n=n.parentElement;if(!n.renderable)return void(this.lastAddedToPSO&&!this.lastAddedToPSO.ownedByUser?(r.remove(this.lastAddedToPSO),this.lastAddedToPSO=null):this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,pickingResult:null,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}}))}if(!i||i.isMiddleButtonPressed())return;o=this.getMousePosition(t.getCurrentPosition(this.canvas));let u=this.manipulatorManager&&this.manipulatorManager.isInManipulation(!0,!0),p=this.pPicking.disableWhileMoving&&this.currentViewpoint&&this.currentViewpoint.isMoving();if(!this.pPicking.activated||u||p)this.pPicking.activated&&p&&r.empty();else{if(c="mesh",c=this.pPicking.gpu?2===this.pPicking.primitive?"repHybrid":this.pPicking.primitive?"primHybrid":"mesh":2===this.pPicking.primitive?"repCPU":this.pPicking.primitive?"primCPU":"mesh",l=this.pick(o,c,this.pPicking.computeNormalDepth),h=!1,r.isEmpty()&&!l.path.length||(h=!0),this._fillXSOMode)if(l.path.length){if(this.pPicking.displayHL){var f=null;if(l.path[0]&&(f=l.path[0].getLastElement(!0)),f instanceof s&&!f._getExcludeFromPreHL()&&!f._getExcludeFromPSO()){for(var g,m=l.path[0];m&&m.getLastElement(!0).getPickParent();)m=m.getParentPath();if(!this.multiViewerFix&&!window.userRootOutOfPathElements)if((g=m)&&g.externalPath.length>1){var v=g.externalPath.concat([]);v.shift(),m=new a,void 0!==g.instanceId&&(m.instanceId=g.instanceId),m.setFromArray(v,g.internalPath)}var _={pathElement:m,event:t};if(!r.isIn(_)||r.get().length>1){var y=r.get().slice();r.remove(y),r.add(_)}this.lastAddedToPSO=_}}}else r.isEmpty()||(this.lastAddedToPSO=null,r.empty());var S=null;this.manipulatorManager&&(S=this.manipulatorManager.hoveredManipulator||this.manipulatorManager._getManipulatedManipulator()),this._modelEvent.publish({event:"Preactivate",data:{viewer:this,event:t,manipulator:S,pickingResult:l,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed()}})}h&&this.render({onlyPostProcess:!0});var x,w="@pickNothing";if(l&&l.path.length){var M=l.path[0].getLastElement();M instanceof THREEDS.SubElement?"primitive"===M.getType()?w="@pickPrimitive":"rep"===M.getType()&&(w="@pickRep"):null!==M&&(w="@pickMesh")}x="@pickNothing"===w?{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:w,event:t}:{eventChannel:"/VISU/",eventType:"@onMoveEvent",eventID:w,event:t,from:l.path[0],point:l.position,normal:l.normal,tangent:l.tangent,uv:l.uv,ray:l.ray},e.publish({event:"/VISU/",data:x}),this.debugEvents>=6&&console.log(x)},this.centerMouseUpCB=function(i,r){if(r&&r.isMiddleClick()){var n,s;if(n=this.getMousePosition(i.getCurrentPosition(this.canvas)),!r.lockPan&&!r.lockReframeOnDblTap&&null!==this.currentViewpoint)if(null!==(s=this.pick(n,"mesh",!0)).position){if(s.viewpoint.isMain())if(s.path.length)s.viewpoint.centerCamera(s.position);else{let e=s.viewpoint.control.distanceToTarget,i=s.ray.direction.clone().normalize(),r=null;s.viewpoint.projectionType===o.PERSPECTIVE?(i.setLength(e),r=(new t.Vector3).addVectors(s.viewpoint.control.position,i)):(i.setLength(e-s.viewpoint.camera.near),r=(new t.Vector3).addVectors(s.ray.origin,i));let n="zup"===this._worldOrientation._woName?new t.Vector3(0,0,1):new t.Vector3(0,1,0),a=this._viewpointManager.getViewpointScenegraph(s.viewpoint).getSavedSceneMin(),l=null;if(null!==a){l=new t.Plane(n,-a);let i=s.ray.distanceToPlane(l);void 0!==i&&i>0&&i<e&&s.ray.at(i,r)}s.viewpoint.centerCamera(r)}}else r._2DMode&&this.currentViewpoint.centerCameraSVG(new t.Vector2(.5*this.div.clientWidth,.5*this.div.clientHeight),new t.Vector2(n.xPix,n.yPix));var a={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@middleClick",event:i};e.publish({event:"/VISU/",data:a}),this.debugEvents>=6&&console.log(a)}},this.leftMouseDownCB=function(t,i){var r=t.view;if(!b.RecordEventsManager||r){var n=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,s=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(r===n&&(r=s),r!==s&&!r.renderable){for(;r!==s&&r.parentElement&&!r.renderable;)r=r.parentElement;if(!r.renderable)return}if(i&&!i.isMiddleButtonPressed()&&i.isLeftClick()){if(this.picking.trapSelection&&this.trapSelection){var a=this.getMousePosition(t.getCurrentPosition(this.canvas)),o=this.pick(a,"mesh",!1);if(o&&o.path&&o.path.length)for(var l=o.path[0].externalPath,h=0;h<l.length;h++)if(l[h].getIsManipulator()){this.trapSelection.interrupt();break}}var c={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@leftClickDown",event:t};e.publish({event:"/VISU/",data:c}),this.debugEvents>=6&&console.log(c)}}},this.leftMouseUpCB=function(e,t){this._doPickingFromMouseEvent(e,t,null)},this._doPickingFromMouseEvent=function(t,i,r){if(this._defaultPicking){var n,s=r||this.trapSelection,o=t.view;if(!b.RecordEventsManager||o){var l=t.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,h=t.path&&this.canvas.impl?this.canvas.impl:this.canvas;o===l&&(o=h);var c=!1;if(this.picking.trapSelection&&s&&(c=void 0!==(n=s.getExtremities()).pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix)),!c&&o!==h&&!o.renderable){for(;o!==h&&o.parentElement&&!o.renderable;)o=o.parentElement;if(!o.renderable)return void null}if(i&&!i.isMiddleButtonPressed()){if(this.picking.activated){var d,u;null,null,null,null,c||(n=this.getMousePosition(t.getCurrentPosition(this.canvas)));var p=s&&s.isActive,f=this.magnifier&&this.magnifier.active&&"Touch"===t.getType(),g=t.contextButton?i.isRightClick():i.isLeftClick();if(!p&&(!f||window.magnifierCheckDistance&&!this.magnifier.displayed)&&!g)return;if(window.magnifierCheckDistance&&f&&this.magnifier.displayed){if(this.magnifier.displayed=!1,!this.magnifier.enableSelection)return;this.magnifier.enableSelection=!1}if(!r&&this.manipulatorManager&&this.manipulatorManager.isInManipulation())return;o!==h&&(n.event=t),u="mesh",u=c&&this.picking.trapSelection?this.picking.trapGPU?2===this.picking.trapPrimitive?"repHybrid":this.picking.trapPrimitive?"primHybrid":"mesh":2===this.picking.trapPrimitive?"repCPU":this.picking.trapPrimitive?"primCPU":"meshCPU":this.picking.gpu?2===this.picking.primitive?"repHybrid":this.picking.primitive?"primHybrid":"mesh":2===this.picking.primitive?"repCPU":this.picking.primitive?"primCPU":s&&n.pt?"meshCPU":"mesh",d=this.pick(n,u,this.picking.computeNormalDepth,void 0,r);var m,v,_=i.isShiftKeyPressed(),y=i.isCtrlKeyPressed()||this.forceMultiSel,S=(c=void 0!==n.pt&&(n.xPix!=n.pt.xPix||n.yPix!=n.pt.yPix),0);if(!this.multiViewerFix&&!window.userRootOutOfPathElements)for(S=0;S<d.path.length;S++)if((m=d.path[S])&&m.externalPath.length>1){var x=m.externalPath.concat([]);x.shift(),d.path[S]=new a,d.path[S].setFromArray(x,m.internalPath),void 0!==m.instanceId&&(d.path[S].instanceId=m.instanceId)}if(this._fillXSOMode&&(v=this.addToCSOHSO(d,{event:t,multiSel:y,additiveMode:_,trapSel:c})),null!==this.internalSceneGraph){if(this._fillXSOMode){var w="@pickNothing";if(d.path.length){var M=d.path[0].getLastElement();M instanceof THREEDS.SubElement?"primitive"===M.getType()?w="@pickPrimitive":"rep"===M.getType()&&(w="@pickRep"):null!==M&&(w="@pickMesh")}var C={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:w,event:t,from:d.path[0],addedToCSO:v.addedToCSO,removedFromCSO:v.removedFromCSO,point:d.position,normal:d.normal,tangent:d.tangent,uv:d.uv,ray:d.ray,trapSelection:c};e.publish({event:"/VISU/",data:C}),this.debugEvents>=6&&console.log(C)}var P=null;this.manipulatorManager&&(P=this.manipulatorManager.hoveredManipulator||this.manipulatorManager._getManipulatedManipulator()),this._modelEvent.publish({event:"Activate",data:{viewer:this,event:t,manipulator:P,pickingResult:d,ctrl:i.isCtrlKeyPressed(),shift:i.isShiftKeyPressed(),trapSelection:c,contextButton:!!t.contextButton}})}this.render({onlyPostProcess:!0})}else{var E;(E=WUX.Selection.HSOManager).isEmpty()||(E.empty(),this.render({onlyPostProcess:!0}))}null}else null}}},this.rightMouseUpCB=function(t,i){if(t.view===this.canvas&&i&&!i.isMiddleButtonPressed()&&!i.isLeftButtonPressed()&&i.isRightClick()){this.picking.contextPick&&(t.contextButton=!0,this.leftMouseUpCB(t,i));var r={eventChannel:"/VISU/",eventType:"@onClickEvent",eventID:"@rightClick",event:t};e.publish({event:"/VISU/",data:r}),this._modelEvent.publish({event:"Context",data:{viewer:this,event:t,ctrl:i.isCtrlKeyPressed()}}),this.debugEvents>=6&&console.log(r)}}}else this.centerMouseDownCB=null,this.mouseMoveCB=null,this.leftMouseDownCB=null,this.leftMouseUpCB=function(e,t){var i=e.view;if(!b.RecordEventsManager||i){var r=e.path&&this.divTrap.impl?this.divTrap.impl:this.divTrap,n=e.path&&this.canvas.impl?this.canvas.impl:this.canvas;if(i===r&&(i=n),i!==n&&!i.renderable){for(;i!==n&&i.parentElement&&!i.renderable;)i=i.parentElement;if(!i.renderable)return}if(t&&!t.isMiddleButtonPressed()&&(this.trapSelection&&(!this.trapSelection||this.trapSelection.isActive)||t.isLeftClick())&&(!this.manipulatorManager||!this.manipulatorManager.isInManipulation())){var s=null;this.manipulatorManager&&(s=this.manipulatorManager.hoveredManipulator||this.manipulatorManager._getManipulatedManipulator()),this._modelEvent.publish({event:"Activate",data:{viewer:this,event:e,manipulator:s,ctrl:t.isCtrlKeyPressed(),shift:t.isShiftKeyPressed()}})}}},this.rightMouseUpCB=null},getDefaultPicking:function(){return this._defaultPicking},setCurrentHighlightSet:function(e){this.renderer.resetGSSOCache(),this.highlightColor=e?e.highlightData:null},activatePreHighlightOnDrag:function(e){this._supportDragPrehighlight=e},setRenderSettings:function(e){!e||void 0!==e.type&&"rasterizer"!==e.type||(e.ambientOcclusion&&e.ambientOcclusion.activation&&(this.setSSAOParameters({dynamicRadius:!1,adaptativeRadius:!0,radius:e.ambientOcclusion.radius?e.ambientOcclusion.radius:100,radiusMin:.005,radiusMax:.12,minPixelRadius:14,attenuation:.984,contrast:e.ambientOcclusion.intensity?e.ambientOcclusion.intensity:1,power:1,thresholdAngle:1.32645023152}),viewer.setSSAO(!0)),e.reflection&&e.reflection.activation&&viewer.setSSLR(!0))},setAmbience:function(e,t){this.renderer.resetGSSOCache(),this.ambience.removeLights(this);"Custom"!==this.visuEnv&&(this.visuEnv="Custom",this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:"Custom"}})),this.ambience.isOCA&&this.ambience.dispose(),this.ambience=e,this.ambience.resize(this.SCREEN_WIDTH,this.SCREEN_HEIGHT,this.devicePixelRatio,this.renderer),t&&(this.setGroundOptions({groundSize:100,groundShadow:!1,displayPlane:!1,displayGrid:!1,displayGridFromBelow:!1,gridNbSteps:5,gridLabels:null,gridLabelCallback:null,gridDisplayLabelCallback:null,planeMirror:!1,blurryMirror:!1,planeColor:"#EEEEEE",planeOpacity:1,planeTexture:null,planeTextureScale:1,gridColor:"#EEEEEE",gridFalloff:0,planeFalloff:0,planeBorder:!1,planeBorderColor:"#FFFFFF"}),this.setGroundOptions(e.getGroundOptions())),this.ambience.updateAmbience(),this._modelEvent.publish({event:"_VisuEnvCalled",data:{viewer:this}})},onVisuAmbianceStateChange:function(e,i,r){var n=[],s=t._AmbianceGenerators,a=0,o=function(t){var n=s._needsUpdate();if(t)i&&i({initialization:!0,computing:n});else if(s.manager){for(var o=!1,l=0;l<s.viewers.length;l++)if(s.viewers[l].forceRender){o=!0;break}n||o?(i&&i({initialization:!1,computing:!0}),a=1):1===a?(r&&r(),a=2):(e&&e(),a=0)}else s.loading?i&&i({initialization:!0,computing:!1}):(e&&e(),a=0)};return n.push(this.onPostRender(function(){o(!1)})),n.push(this._modelEvent.subscribe({event:"_VisuEnvCalled"},function(){o(!0)})),o(!1),n},removeAmbience:function(){this.ambience.removeLights(this),this.removeEnvMap(),this.ambience.needUpdateIBL.delete(this),this.renderer.SkyScatteringEffect&&this.renderer.SkyScatteringEffect.setEnabled(!1),this.ambience.isOCA&&this.ambience.dispose();var e=new G({viewer:this,v2:!0});this.setAmbience(e,!0)},createHighlightSet:function(e,t,i,r){i=null==i?!ie:!!i;var n=null;if(!(!t&&r)&&(n=this._getHighlightSet(e,t,i)))return n;if((n=new E(this)).setHighlightData(i,e),n.setMultiColorMode(!0),this.renderer._postProHighlight){var s=this.getEffect("Highlight");s.addScene(n),(s=this.getEffect("Canvas2DHighlight")).addScene(n)}else this.renderer._HighlightMobileNonEffect.addScene(n);return t||n.detachToHSO(),this.highlightSets.push(n),n},removeHighlightSet:function(e){this.renderer.resetGSSOCache();this._removeHighlightSet(e.getHighlightData(),e.linkToHSO);if(this.renderer._postProHighlight){var t=this.getEffect("Highlight");t.removeScene(e),(t=this.getEffect("Canvas2DHighlight")).removeScene(e)}else this.renderer._HighlightMobileNonEffect.removeScene(e);e.detachToHSO(),e.clearAll()},_getHighlightSet:function(e,t,i){for(var r=this.highlightSets,n=0;n<r.length;n++){var s=r[n];if(s.linkToHSO==t&&s.getHighlightData().isEqual(e)&&s.getHighlightData()._needsDepth===i)return s}return null},_removeHighlightSet:function(e,t){for(var i=this.highlightSets,r=0;r<i.length;r++){var n=i[r];if(n.linkToHSO==t&&n.getHighlightData().isEqual(e))return i.splice(r,1),!0}return!1},addToCSOHSO:function(e,t){function i(i,n,s,a){var o,l,h={removed:[],added:[]};s&&(h.removed=function(e){for(var t=e.get(),i=[],r=0;r<t.length;r++){var n=t[r],s=n.pathElement;!s&&n.options&&(s=n.options.pathElement),s&&i.push(s)}return i}(n),n.empty());var c,d,u,p,f=[],g=[],m={highlightColor:r.highlightColor};for(c=n.get(),o=0;o<i.length;o++){for(d=i[o].pathElement,u=!1,l=0;l<c.length&&!u;l++)!(p=c[l]).pathElement&&p.options&&p.options.pathElement,d.isEqual(c[l].pathElement)&&(c[l].position&&(c[l].position=e.position),f.push(c[l]),u=!0);u||g.push({pathElement:d,event:t.event,position:e.position,parameters:m})}if(a)for(f.length>0&&n.remove(f),o=0;o<f.length;o++)h.removed.push(f[o].pathElement);for(g.length>0&&n.add(g),o=0;o<g.length;o++)h.added.push(g[o].pathElement);return h}var r=this,n=WUX.Selection.HSOManager,s=WUX.Selection.CSOManager,a=function(t){var i,r,n=[],s=!1;for(i=0;i<e.path.length&&!s;i++)(r=e.path[i]).getLastElement(!0)._getExcludeFromCSO()||(n.push(r),t||(s=!0));if(!n.length&&e.path.length)return null;var a,o,l,h,c={CSO:[],HSO:[]},d=[];for(i=0;i<n.length;i++){for(r=n[i],a=!1;r.getLastElement(!0).getPickParent();)r=r.getParentPath(),a=!0;if(l=!1,a){for(o=0;o<d.length;o++)d[o].isEqual(r)&&(l=!0);l||d.push(r)}l||(c.CSO.push({pathElement:r}),(h=r.getLastElement(!0))._getExcludeFromHL()||h._getExcludeFromHSO()||c.HSO.push({pathElement:r}))}return c}(t.trapSel);if(!a)return{addedToCSO:[],removedFromCSO:[]};r._modelEvent.publish({event:"PreAddRemoveXSO",data:a.CSO}),r._modelEvent.publish({event:"PreAddRemoveXSO",data:a.HSO});var o=!t.multiSel,l=!t.additiveMode,h=i(a.CSO,s,o,l);return this.picking.displayHL&&i(a.HSO,n,o,l),{addedToCSO:h.added,removedFromCSO:h.removed}},forceCPUTBCompute:function(e){this.renderer.renderer.forceCPUTBCompute=e},getVersion:function(){return this.version},getWebGLContext:function(){return this.renderer.renderer.getContext()},getRenderer:function(){return this.renderer.renderer},getInfos:function(){return this.renderer.getInfos()},isManipulatedViewpointMoving:function(){return this._viewpointManager.hasMovingViewpoint()},addViewpoint:function(e,t){null!==e&&(e._setWorldOrientation(this._worldOrientation),e._setNode(this.internalSceneGraph.root),this._2DMode&&e._set2DMode(!0,t),this.viewpoints.push(e)),1===this.viewpoints.length&&this.selectViewpoint(0),this.internalSceneGraph.onAddViewpoint(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},addMultiViewpoint:function(e,t,i,r,n){e._setWorldOrientation(this._worldOrientation),this.fetchMePreferenceControls&&e._setApplicationDefaultController(),i&&e._setNode(this.internalSceneGraph.root),t?this._viewpointManager.addMainViewpoint(e,!!i,r,n):this._viewpointManager.addViewpoint(e,!!i,r,n)},removeMultiViewpoint:function(e){e!==this.currentViewpoint&&this._viewpointManager.removeViewpoint(e)},addNodeToViewpoint:function(e,t){this._viewpointManager.addNodeToViewpoint(e,t)},setViewpointOptions:function(e,t){if(void 0!==(t=t||{}).activated&&this._viewpointManager.setViewpointActivation(e,t.activated),t.viewport){let i=t.viewport;this._viewpointManager.setViewpointViewport(e,i.fixed,i.x,i.y,i.width,i.height)}void 0!==t.isMain&&this._viewpointManager.setMainStatus(e,isMain),this._viewpointManager.setCSIInfos(e,t)},setManipulatedViewpoint:function(e){this._viewpointManager.setManipulatedViewpoint(e)},removeViewpoint:function(e){e<0||e>=this.viewpoints.length||(this.viewpoints[e]==this.currentViewpoint&&(null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint=null),this.viewpoints.splice(e,1),this.viewpoints.length>0&&this.selectViewpoint(0))},selectViewpoint:function(e,t){!t&&(e<0||e>=this.viewpoints.length)||(null!==this.currentViewpoint&&null!==this.internalSceneGraph&&this.internalSceneGraph.scene.remove(this.currentViewpoint.getCamera()),this.currentViewpoint&&this._viewpointManager.removeViewpoint(this.currentViewpoint),this.currentViewpoint=t||this.viewpoints[e],this._viewpointManager.addMainViewpoint(this.currentViewpoint,!0),this.fetchMePreferenceControls&&this.currentViewpoint._setApplicationDefaultController(),this.internalSceneGraph.onSelectViewpoint(),this.render({updateInfinitePlane:!0}))},getViewpoints:function(){return this.viewpoints},setTrackingViewpoint:function(e){this.trackingViewpoint=e},getTrackingViewpoint:function(){return this.trackingViewpoint},updatePlatformPreferences:function(){this.fetchMePreferenceControls&&this._viewpointManager.updateApplicationController()},attachScene:function(e){if(null!==e){"I solemnly swear that I am up to no good."!==e.passcode&&n.DEPRECATED_SceneGraph(new Error),e.parentSceneGraph=this.internalSceneGraph;var t=this._sceneGraph;this._sceneGraph=null,t&&this.removeNode(t),this.addNode(e._private_root),this._sceneGraph=e}},addNode:function(e,t){if(e instanceof M)throw new Error("addNode with SceneGraph");this.internalSceneGraph&&this.internalSceneGraph.addUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t})},removeNode:function(e,t){this.internalSceneGraph&&(this.internalSceneGraph.removeUserNode(e,null!==this._sceneGraph),this.render({updateInfinitePlane:!!t}))},getNodes:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserNodes(null!==this._sceneGraph):null},getRootNode:function(){return this.internalSceneGraph?this.internalSceneGraph.getUserRoot(null!==this._sceneGraph):null},setClippingPlanes:function(e){this.renderer.resetGSSOCache();var t=this.getRenderer();if(null===t)return!1;if(e&&!this.clipPlanes.length)return!1;var i=t.clipPlanesEnabled;return t.clipPlanesEnabled=e,i!==e&&null!==this.internalSceneGraph&&this.render(),!0},getClippingPlanes:function(){var e=this.getRenderer();return null===e?null:e.clipPlanes},addClippingPlane:function(e,t){return this.renderer.resetGSSOCache(),this._requestClippingUpdate(),this.clipPlanes.indexOf(e)<0&&this.clipPlanes.push(e),this._addClippingPlane(e),this.setSectionCappingMaterial(e,t),!0},setSectionCappingMaterial:function(e,t){this._requestClippingUpdate(),this.renderer.setSectionCappingMaterial(e,t)},removeClippingPlane:function(e){this._requestClippingUpdate(),this.renderer.resetGSSOCache();var t=this.clipPlanes.indexOf(e);t>=0&&this.clipPlanes.splice(t,1),this._removeClippingPlane(e)},setClippingPlaneUpVector:function(e,t){this._requestClippingUpdate(),e.upVector=t.clone(),e.upVector.normalize()},setSectionCapping:function(e){return this._requestClippingUpdate(),this.renderer.resetGSSOCache(),e&&this.getRenderPriority()?(console.warn("Section capping is not compatible with render priority mode"),!1):(this.renderer.renderer.sectionCappingEnabled=!!e,this.render(),!0)},getSectionCapping:function(){return this.renderer.renderer.sectionCappingEnabled},_updateShadowMaps:function(){this._shadowUpdated=!0;let e=this._getScenegraphs();this.renderer.resetGSSOCache();for(let r=0;r<e.length;r++){var t=e[r].root3js;if(null!==t&&void 0!==typeof t)for(var i=0;i<t.parent.__lights.length;i++)t.parent.__lights[i].updateShadowMap=!0}},getVisibleSpace:function(){return this.visibleSpace},swapVisibleSpace:function(){this.renderer.resetGSSOCache(),this.visibleSpace=(this.visibleSpace+1)%2,this.renderer.visibleSpace=this.visibleSpace,this.renderer.renderer.visibleSpace=this.visibleSpace;var e,i,r=new t.Color(this.showBgColor);if(this.ambience.setBackgroundAlpha(this.showBgAlpha),this.visibleSpace||r.desaturate(1).alphaBlend(le,.5),this.ambience.setBackgroundColor(r.getHex()),this._setBackgroundColor(),this._svgMode&&this.svgRootNode)for(i="#"+le.getHexString(),this.svgRootNode.style.backgroundColor=this.visibleSpace?"#ffffff":i,e=0;e<this.internalSceneGraph.svgRoot.children.length;e++)this.internalSceneGraph.svgRoot.children[e]._updateSVGVisibility();if(this.ambience.getBackground().hasGradient()){var n=this.ambience.getBackground().getColors(),s=[];for(e=0;e<n.length;e++)this.visibleSpace?s.push(new t.Color(this.showGradientBackground[e].getHex())):s.push(n[e].desaturate(1).alphaBlend(le,.5));this.ambience.getBackground().setColors(s)}this._displayGrid&&(this.visibleSpace?this.gridColor.copy(this.showGridColor):this.gridColor.desaturate(1).alphaBlend(le,.5)),this._infinitePlane&&(this.visibleSpace?this.planeColor.copy(this.showPlaneColor):this.planeColor.desaturate(1).alphaBlend(le,.5)),this.getRobot()&&this.getRobot().isTargetGone(this.visibleSpace)&&this.getRobot().setConnectionState(!1),this._updateShadowMaps(),this.render({updateInfinitePlane:!0}),this._modelEvent.publish({event:"SwapVisibleSpace",data:{viewer:this,visibleSpace:this.visibleSpace}})},getMousePosition:function(e){if(!(e instanceof t.Vector2)&&(console.warn("DEPRECATED: WebGLViewer.getMousePosition() now only accepts THREEDS.Core.Vector2 2D position on the screen as argument."),e.changedTouches)){var i=e.changedTouches.length?e.changedTouches[0]:e,r=this.canvas.getBoundingClientRect(),n=i.pageX-r.left,s=i.pageY-r.top;e=new t.Vector2(n,s)}var a=this.devicePixelRatio;return{x:e.x/this.canvas.offsetWidth*2-1,y:-e.y/this.canvas.offsetHeight*2+1,xPix:e.x*a,yPix:e.y*a}},computeDistanceFromCamera:function(e){return this.renderer.computePositionGPU(this.internalSceneGraph,this.currentViewpoint,e).distanceTo(this.currentViewpoint.camera.position)},invalidatePickingBuffer:function(e){if(this.renderer.pickingGPUComposerContext&&(this.renderer.pickingGPUComposerContext.needsUpdate=!0,this.renderer.meshesGPU={},e||this.renderer.resetGSSOCache()),this.renderer.normalComposerContext&&(this.renderer.normalComposerContext.needsUpdate=!0,this.renderer.normalsGPU={}),this.renderer.depthComposerContext&&(this.renderer.depthComposerContext.needsUpdate=!0,this.renderer.positionsGPU={}),this.gpuPositionComposerContext){for(let e=0;e<this.gpuPositionComposerContext.length;e++)this.gpuPositionComposerContext[e].needsUpdate=!0;this.positionsFloatGPU={},this.heuristicNormalsGPU={}}},setPickingPriority:function(e){this.pickingPriorityMapping=e,this.renderer.resetGSSOCache()},pick:function(e,i,r,n,s,o){null!==this._pageObjectData&&(void 0!==e.x&&void 0!==e.y||(e=this.getMousePosition(new t.Vector2(e.xPix,e.yPix))));var l,h,c,d={ray:null},u=n||this.pickingPriorityMapping,p=!1;this.infPlaneSmall&&u&&(p=this.infPlaneSmall.visible,this.infPlaneSmall.visible=!1),h={path:[],position:null,normal:null,tangent:null,uv:null,viewpoint:null,positions:[],normals:[],tangents:[],uvs:[],viewpoints:[],ray:null},this.renderer.overrideUpdate(this.internalSceneGraph,this.getCurrentSceneGraphState());var f=!1;switch(i){case"mesh":for(l=this.computeIntersection(e,!0,!1,r,d,u,s,o),c=0;c<l.length;++c)l[c].object?(l[c].path=new a,l[c].path.setFromOccurrence(l[c].object._occurrence)):l[c].path=null;break;case"meshCPU":for(l=this.computeIntersection(e,!1,!1,r,d,u,s,o),f=!0,c=0;c<l.length;++c)l[c].object?(l[c].path=new a,l[c].path.setFromOccurrence(l[c].object._occurrence)):l[c].path=null;break;case"primHybrid":for(l=this.computeIntersection(e,!0,!0,r,d,u,s,o),c=0;c<l.length;++c){var g=l[c].object?l[c].object._occurrence:null;if(l[c].primitive&&g){var m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive);l[c].path=new a,l[c].path.setFromOccurrence(g,m,void 0,!0)}else l[c].object&&l[c].object._instancingInfos&&l[c].object._instancingInfos.isInstanceNode3D?(l[c].path=new a,l[c].path.setFromOccurrence(g)):g&&g.node&&!g.node.getPrimitivePicking()?(l[c].path=new a,l[c].path.setFromOccurrence(g)):l[c].path=null}break;case"prim":case"primCPU":for(l=this.computeIntersection(e,!1,!0,r,d,u,s,o),f=!0,c=0;c<l.length;++c)if(l[c].primitive&&l[c].object._occurrence){m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive);l[c].path=new a,l[c].path.setFromOccurrence(l[c].object._occurrence,m,void 0,!0)}else l[c].path=null;break;case"rep":case"repCPU":for(l=this.computeIntersection(e,!1,!0,r,d,u,s,o),f=!0,c=0;c<l.length;++c)if(l[c].primitive&&l[c].object._occurrence){m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive.getRep());l[c].path=new a,l[c].path.setFromOccurrence(l[c].object._occurrence,m,void 0,!0)}else l[c].path=null;break;case"repHybrid":for(l=this.computeIntersection(e,!0,!0,!1,d,u,s,o),c=0;c<l.length;++c)if(l[c].primitive&&l[c].object._occurrence){m=!0===l[c].primitive?null:THREEDS.SubElement.getFromSGNode(l[c].primitive.getRep());l[c].path=new a,l[c].path.setFromOccurrence(l[c].object._occurrence,m,void 0,!0)}else l[c].object&&l[c].object._instancingInfos&&l[c].object._instancingInfos.isInstanceNode3D?(l[c].path=new a,l[c].path.setFromOccurrence(l[c].object._occurrence)):l[c].path=null}h.ray=d.ray;var v=!1;for(c=0;c<l.length;++c)if(null!==l[c].path)void 0!==l[c].instanceId&&(l[c].path.instanceId=l[c].instanceId),h.path.push(l[c].path),v||(v=!0,h.position=l[c].point,h.normal=l[c].normal,h.tangent=l[c].tangent,h.uv=l[c].uv,h.viewpoint=l[c].viewpoint),h.positions.push(l[c].point?l[c].point:null),h.normals.push(l[c].normal?l[c].normal:null),h.tangents.push(l[c].tangent?l[c].tangent:null),h.uvs.push(l[c].uv?l[c].uv:null),h.viewpoints.push(l[c].viewpoint?l[c].viewpoint:null);else if(!f)break;if(!v)if(l.length&&3==r)h.position=l[0].point,h.normal=l[0].normal,h.viewpoint=l[0].viewpoint;else if((this._displayGrid||this._infinitePlane)&&h.ray&&h.ray.direction.z<0){h.normal=new t.Vector3(0,0,1);var _=new t.Plane(h.normal,this.offsetPlaneSmall.z);h.position=h.ray.intersectPlane(_),h.viewpoint=this.currentViewpoint}else l.length&&(h.position=l[0].point,h.normal=l[0].normal,h.viewpoint=l[0].viewpoint);return this.infPlaneSmall&&u&&(this.infPlaneSmall.visible=p),h},pickInVolume:function(e,i,r){if(this.renderer._needPerformanceSuite())return{inside:[],outside:[],partial:[]};if(!e||!i)return{inside:[],partial:[],outside:[]};var n=this.internalSceneGraph.scene,s=[];if(r)s=s.concat(r._getRenderableOccurrences(this,!1));else if(n instanceof t.Mesh)s=[n];else{for(var o=this._getUserPassManager()._getActiveRenderLists(),l=[],h=0;h<o.length;h++)l=l.concat(n.getWebGLObjects(o[h]));for(h=0;h<l.length;h++)null!==l[h]&&s.push(l[h].object)}var[c,d,u]=this.getRenderMode().getMasks(),p=new t.Sphere;if(e instanceof t.Box3){var f=e.getPoints(i),g=[[0,2,1],[4,0,5],[6,4,7],[2,6,3],[5,1,7],[4,6,0]],m=[],v=new t.Vector3,_=new t.Vector3;for(h=0;h<g.length;h++){var y=g[h];v.copy(f[y[1]]).sub(f[y[0]]),_.copy(f[y[2]]).sub(f[y[0]]),v.cross(_).normalize(),m.push((new t.Plane).setFromNormalAndCoplanarPoint(v,f[y[0]]))}p=new t.Frustum(m[0],m[1],m[2],m[3],m[4],m[5])}else{if(!(e instanceof t.Sphere))return{inside:[],partial:[],outside:[]};(p=e.clone()).applyMatrix4(i)}var S=[{path:[]},{path:[]},{path:[]}],x=[],b=[],w=[],M=[x,b,w];for(h=0;h<s.length;h++){var C=s[h];ne(C.visible,C.visibilityFree,this.visibleSpace,C.layer,C._occurrence)&&!1!==C.noPickThrough&&((void 0===C.pickable||C.pickable)&&q._meshIntersectVolume(C,p,c,u,d,x,b,w,this.visibleSpace))}for(var P=0;P<M.length;P++){var E=M[P];for(h=0;h<E.length;++h)E[h].object?(E[h].path=new a,E[h].path.setFromOccurrence(E[h].object._occurrence)):E[h].path=null}for(P=0;P<M.length;P++)for(E=M[P],h=0;h<E.length;++h)null!==E[h].path&&(void 0!==E[h].instanceId&&(E[h].path.instanceId=E[h].instanceId),S[P].path.push(E[h].path));return{inside:S[0],outside:S[1],partial:S[2]}},computeIntersection:function(e,i,r,s,a,l,h,c){if(this.renderer._needPerformanceSuite())return[];var d,u,p,f,g,m,v,_,y,S,x,b=this.trapSelection||h,w=[];if(u=new t.Projector,v=void 0!==i&&i,m=void 0!==r&&r,_=void 0!==s&&s,this.debugPickHybrid&&(_=!0),x=!(!this.picking.trapSelection||!b||void 0===e.pt||e.pt.xPix===e.xPix&&e.pt.yPix===e.yPix),null===this.currentViewpoint||null===this.internalSceneGraph)return w;var M=this.devicePixelRatio;if(d=new t.Vector2(e.xPix/M,e.yPix/M),p=this.currentViewpoint.create3DRayFrom2DPoint(d),void 0!==a&&void 0!==a.ray&&(a.ray=p),!x&&e.event){var C=e.event.getView(),E=C.renderable;if(!E)for(;C!==this.canvas&&(C.parentElement||C.parentNode)&&!E;)E=(C=C.parentElement||C.parentNode).renderable;if(E&&E.noPickThrough){var T,A;if(E instanceof t.CSS3DNode){var D=(new t.Matrix4).multiplyMatrices(E.matrixWorld,E.scaleCSS),I=e.event.getCurrentPosition(C);(T=new t.Vector3(I.x,I.y,0)).applyMatrix4(D);var R=D.elements;A=new t.Vector3(R[8],R[9],R[10])}else{var O=E.position.clone(),L=(this.currentViewpoint.camera.getLookAt(),(new t.Plane).setFromNormalAndCoplanarPoint(this.currentViewpoint.camera.getLookAt(),O)),V=(E.element.getBoundingClientRect(),this.getMousePosition(new t.Vector2(e.xPix,e.yPix)));V=new t.Vector3(V.x,V.y,1),u.unprojectVector(V,this.currentViewpoint.camera),T=new t.Ray(this.currentViewpoint.camera.position,V.clone().sub(this.currentViewpoint.camera.position).normalize()).intersectPlane(L),A=L.normal}return w[0]={object:E,primitive:!(!E||!E.primitive),point:T,normal:A},w}}let F=this._viewpointManager.getVpList(!0),B=!this.renderer.pickingGPUComposerContext||this.renderer.pickingGPUComposerContext.needsUpdate,N=!this.renderer.normalComposerContext||this.renderer.normalComposerContext.needsUpdate,G=!this.renderer.depthComposerContext||this.renderer.depthComposerContext.needsUpdate,k=!this.renderer.gpuPositionComposerContext||this.renderer.gpuPositionComposerContext[0].needsUpdate,U=0,z=1,H=w;this.renderer.smallTargetPicking||(this.renderer.renderer.RTTmatchViewport=!0);let W=this,j=this.currentViewpoint,X=function(){if(W._setupViewpoint(null),W.currentViewpoint=j,W.renderer.pickingGPUComposerContext&&W.renderer.pickingGPUComposerContext.setPassClear(W.renderer.initClearPass,!0),W.renderer.normalComposerContext&&W.renderer.normalComposerContext.setPassClear(W.renderer.initClearPass,!0),W.renderer.depthComposerContext&&W.renderer.depthComposerContext.setPassClear(W.renderer.initClearPass,!0),W.renderer.gpuPositionComposerContext)for(let e=0;e<W.renderer.gpuPositionComposerContext.length;e++)W.renderer.gpuPositionComposerContext[e].setPassClear(W.renderer.initClearPass,!0)};for(let i=0;i<F.length;i++){let n=F[i];if(this._setupViewpoint(n,!0),this.renderer._pickingVPid=""+i,p=n.create3DRayFrom2DPoint(d),i>0&&!this.renderer.smallTargetPicking&&(this.renderer.pickingGPUComposerContext&&(this.renderer.pickingGPUComposerContext.needsUpdate=B,this.renderer.pickingGPUComposerContext.setPassClear(this.renderer.initClearPass,!1)),this.renderer.normalComposerContext&&(this.renderer.normalComposerContext.needsUpdate=N,this.renderer.normalComposerContext.setPassClear(this.renderer.initClearPass,!1)),this.renderer.depthComposerContext&&(this.renderer.depthComposerContext.needsUpdate=G,this.renderer.depthComposerContext.setPassClear(this.renderer.initClearPass,!1)),this.renderer.gpuPositionComposerContext))for(let e=0;e<W.renderer.gpuPositionComposerContext.length;e++)this.renderer.gpuPositionComposerContext[e].needsUpdate=k,this.renderer.gpuPositionComposerContext[e].setPassClear(this.renderer.initClearPass,!1);let s=this._viewpointManager.getViewpointViewport(n),a=s?s.width:this.renderer.deviceWidth,h=s?s.height:this.renderer.deviceHeight,c=new t.Vector2(e.xPix,e.yPix),f=new t.Vector2(e.pt?e.pt.xPix:0,e.pt?e.pt.yPix:0);if(c.divideScalar(this.devicePixelRatio),f.divideScalar(this.devicePixelRatio),c=n._convertViewportToNDC(c),f=n._convertViewportToNDC(f),x){if(_=!1,c.x===f.x||c.y===f.y)return X(),w;if(m||!v){var q,Z,Y,Q,K,$;S=new t.Vector3(c.x,f.y,1);var J=n.camera,ee=J.position,te=J.getLookAt();if(K=(new t.Plane).setFromNormalAndCoplanarPoint(te,ee.clone().add(te.clone().multiplyScalar(J.near))),$=(new t.Plane).setFromNormalAndCoplanarPoint(te.clone().multiplyScalar(-1),ee.clone().add(te.clone().multiplyScalar(J.far))),n.getProjectionType()===o.PERSPECTIVE){var ie=new t.Vector3(c.x,c.y,1);u.unprojectVector(ie,J),ie.sub(ee).normalize();var re=new t.Vector3(f.x,c.y,1);u.unprojectVector(re,J),re.sub(ee).normalize();var ne=new t.Vector3(f.x,f.y,1);u.unprojectVector(ne,J),ne.sub(ee).normalize();var se=new t.Vector3(c.x,f.y,1);u.unprojectVector(se,J),se.sub(ee).normalize();var ae=new t.Vector3;ae.copy(ie),Y=(new t.Plane).setFromNormalAndCoplanarPoint(ie.cross(re).normalize(),ee),Z=(new t.Plane).setFromNormalAndCoplanarPoint(re.cross(ne).normalize(),ee),Q=(new t.Plane).setFromNormalAndCoplanarPoint(ne.cross(se).normalize(),ee),q=(new t.Plane).setFromNormalAndCoplanarPoint(se.cross(ae).normalize(),ee)}else{var oe=J.up.clone(),le=new t.Vector3(1,0,0).applyQuaternion(J.quaternion),he=new t.Vector3(c.x,c.y,1);u.unprojectVector(he,J);var ce=new t.Vector3(f.x,f.y,1);u.unprojectVector(ce,J),Y=(new t.Plane).setFromNormalAndCoplanarPoint(oe.clone().negate(),he),Z=(new t.Plane).setFromNormalAndCoplanarPoint(le.clone().negate(),ce),Q=(new t.Plane).setFromNormalAndCoplanarPoint(oe,ce),q=(new t.Plane).setFromNormalAndCoplanarPoint(le,he)}y=new t.Frustum(q,Z,Y,Q,K,$)}}var de,[ue,pe,fe]=this.getRenderMode().getMasks(),ge=t.getDevicePixelRatio();if(v){if(n._updateRobotCamera(this.internalSceneGraph),w=this.renderer.computeIntersectionGPU(this.internalSceneGraph,n,e,_,x,null,null,null,l,v&&m&&!x,!!this._pageObjectData,this.renderer.smallTargetPicking,p),this.renderer.smallTargetPicking&&n.camera.fullWidth&&(this.lockRenderIteration(),this.internalSceneGraph.onViewpointChange(),this.unlockRenderIteration()),w.length&&m){for(var me=[],ve=0;ve<w.length;++ve){var _e=w[ve];_e.object&&_e.object._instancingInfos&&_e.object._instancingInfos.isInstanceNode3D?me.push(_e):_e.object instanceof t.Mesh&&(!_e.object._occurrence||!_e.object._occurrence.node||_e.object._occurrence.node.getPrimitivePicking())&&(de=this._getUserPassManager()._getActiveRenderLists(),me=x?me.concat(p.intersectMeshInstancesZones3D(_e.object,n.camera,new t.Vector3(c.x,c.y,1),S,y,r,ue,pe,fe,a,h,!b.forwardSelect,{renderLists:de,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):me.concat(p.intersectMeshInstances(_e,n.camera,new t.Vector3(c.x,c.y,1),ue,pe,fe,a,this.renderer.deviceHeight,this.picking.tolerance,{debugPickHybrid:this.debugPickHybrid,renderLists:de,inVisibleSpace:this.visibleSpace,devicePixelRatio:ge,candidatesOnly:!1,useViewerPickingRules:!0})))}me.length&&(w=me),p._cleanIntersectionsList(w,!x)}}else{if(de=this._getUserPassManager()._getActiveRenderLists(),w=x?w.concat(p.intersectMeshInstancesZones3D(this.internalSceneGraph.scene,n.camera,new t.Vector3(c.x,c.y,1),S,y,r,ue,pe,fe,a,h,!b.forwardSelect,{renderLists:de,inVisibleSpace:this.visibleSpace,useViewerPickingRules:!0})):p.intersectMeshInstances({object:this.internalSceneGraph.scene},n.camera,new t.Vector3(c.x,c.y,1),ue,pe,fe,a,h,this.picking.tolerance,{debugPickHybrid:!1,renderLists:de,inVisibleSpace:this.visibleSpace,devicePixelRatio:ge,candidatesOnly:!1,useViewerPickingRules:!0}),l){for(var ye=[],Se=0;Se<l.length;Se++)ye[l[Se].id]=l[Se].priority;w.sort(function(e,t){var i=0,r=0;if(e.object.pickingPriorityID){var n=e.object.pickingPriorityID.points;!e.primitive||!e.primitive.getGroup||e.primitive.getGroup().glType>=4?n=e.object.pickingPriorityID.faces:e.primitive.getGroup().glType>=1&&(n=e.object.pickingPriorityID.edges),n&&ye[n]&&(i=ye[n])}if(t.object.pickingPriorityID){var s=t.object.pickingPriorityID.points;!t.primitive||!t.primitive.getGroup||t.primitive.getGroup().glType>=4?s=t.object.pickingPriorityID.faces:t.primitive.getGroup().glType>=1&&(s=t.object.pickingPriorityID.edges),s&&ye[s]&&(r=ye[s])}return i>r?-1:i<r?1:e.distance-t.distance})}p._cleanIntersectionsList(w,!x)}X();for(let e=0;e<w.length;e++)w[e].viewpoint=n;z==U?H=w.concat(H):(!H.length||w.length&&null!=w[0].object)&&(H=w)}this.renderer.renderer.RTTmatchViewport=!1,w=H;var xe=this.getRootNode();if(xe&&this.debugPicking&&(null===this.debugPickingNode?(this.debugPickingNode=new n,this.debugPickingNode.exludeFromBounding(!0),xe.addChild(this.debugPickingNode)):0===this.debugPickingNode.parents.length&&xe.addChild(this.debugPickingNode)),this.debugPicking){if(this.debugPickingNode.removeChildren(),w.length>0&&w[0].object&&w[0].point){f=t.MaterialUtils.createMatteFaceMaterial({color:16729156,opacity:.8,transparent:!0,force:!0,forceSide:!0});var be=P.createSphereNode({radius:1,sag:32,material:f});be.setPickable(2),be._setRatio(4),be.setFrustumCulled(!1),be.setMatrix((new t.Matrix4).setPosition(w[0].point)),be.setSSAO(!1),be.setMirror(!1),be.setShadow(!1),this.debugPickingNode.addChild(be),g=t.MaterialUtils.createMatteFaceMaterial({color:4474111,opacity:1,transparent:!1,force:!0,forceSide:!0});var we=P.createSphereNode({radius:1,sag:32,material:g});if(we.setPickable(2),we._setRatio(8),we.setFrustumCulled(!1),we.setSSAO(!1),we.setMirror(!1),we.setShadow(!1),we.setMatrix((new t.Matrix4).setPosition(this.currentViewpoint.camera.position)),this.debugPickingNode.addChild(we),w[0]&&(w[0].point&&console.log(" x "+w[0].point.x+" y "+w[0].point.y+" z "+w[0].point.z),w[0].normal&&console.log(" nx "+w[0].normal.x+" ny "+w[0].normal.y+" nz "+w[0].normal.z)),w[0].normal){var Me=new t.LineBasicMaterial({color:4474111,opacity:1,force:!0,lineWidth:2}),Ce=new t.Vector3(w[0].normal.x,w[0].normal.y,w[0].normal.z);Ce.multiplyScalar(.2*w[0].object.boundingSphere.radius);var Pe=(new t.Vector3).addVectors(w[0].point,Ce);(Oe=P.createLineNode({points:[w[0].point,Pe],material:Me}))._occurrences[0].renderable,Oe.setPickable(2),Oe.setSSAO(!1),Oe.setMirror(!1),Oe.setShadow(!1),this.debugPickingNode.addChild(Oe)}var Ee=w[0].primitive,Te=Ee&&Ee.getBoundingSphere();if(Te){var Ae=t.MaterialUtils.createMatteFaceMaterial({color:4521796,opacity:.2,transparent:!1,force:!0,forceSide:!0}),De=P.createSphereNode({radius:1,sag:32,material:Ae});De.setPickable(2),De.setFrustumCulled(!1),De.setSSAO(!1),De.setMirror(!1),De.setShadow(!1);var Ie=new t.Sphere(new t.Vector3(Te.center.x,Te.center.y,Te.center.z),Te.radius);Ie.applyMatrix4(w[0].object.matrix);var Re=(new t.Matrix4).setPosition(Ie.center);Re.scale(new t.Vector3(Ie.radius,Ie.radius,Ie.radius)),De.setMatrix(Re),this.debugPickingNode.addChild(De)}var Oe;Me=new t.LineBasicMaterial({color:16729156,opacity:1,force:!0,lineWidth:1});(Oe=P.createLineNode({points:[p.origin,w[0].point],material:Me}))._occurrences[0].renderable,Oe.setPickable(2),Oe.setSSAO(!1),Oe.setMirror(!1),Oe.setShadow(!1),this.debugPickingNode.addChild(Oe)}this.render()}for(ve=w.length-1;ve>=0;ve--){var Le=w[ve];if(!Le.object&&Le.length>1)w.splice(ve,1);else if(Le.primitive){var Ve=Le.object.getSelectionGroup(Le.primitive);Ve&&(Le.primitive=Ve)}}return 0===w.length&&w.push({object:null,viewpoint:this.currentViewpoint}),v&&!r||(w=this._filterClippedIntersections(w)),w},_updateSVGVisu:function(){if(this._svgMode&&this.svgRoot&&this._2DMode){var e=this.currentViewpoint.camera,t=this.SCREEN_HEIGHT/e.visualizedHeight,i="matrix("+t+" 0 0 "+t+" "+0*(1-t)+" "+0*(1-t)+") ",r="translate ("+(.5*this.SCREEN_WIDTH-e.position.x*t+0*t-0)+" "+(.5*this.SCREEN_HEIGHT+e.position.y*t-0*t-0)+") ";this.svgRoot.setAttribute("transform",r+i)}},_updateOffsetPlane:function(e,i,r,n){var s,a="zup"===this._worldOrientation._woName;if((this.ambience.getGround().isActivated()&&"physical"==this.ambience.getGround().getType()||this.ambience.isFiniteMode())&&this.ambience.getBackgroundGeometry().isAutoUpdateSize()&&this.ambience.getBackgroundGeometry().setSize(4*e.radius),this.ambience.isAutoGroundOffset()&&null!==(s=null!==this._forceSceneMinValue?this._forceSceneMinValue:r?null===this.internalSceneGraph?0:this.internalSceneGraph.getSceneMin(n,this._worldOrientation):null===this.internalSceneGraph?0:this.internalSceneGraph.getSavedSceneMin())&&this.ambience.updateScene(new t.Vector3(e.center.x,a?e.center.y:s,a?s:e.center.z)),this.offsetPlaneBackground.copy(this.ambience.getGroundPosition()),this.ambience.isAutoGroundOffset()&&!this.ambience.isFiniteMode()&&"physical"!=this.ambience.getGround().getType()){var o=i.getLookAt();if(this.planeV2)this.offsetPlaneBackground.x=e.center.x,a?this.offsetPlaneBackground.y=e.center.y:this.offsetPlaneBackground.z=e.center.z;else if(a){var l=Math.abs(o.z)>1e-4?1/o.z:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.z-this.offsetPlaneBackground.z)*o.x*l),this.offsetPlaneBackground.y=.5*(e.center.y+i.position.y-(i.position.z-this.offsetPlaneBackground.z)*o.y*l)}else{l=Math.abs(o.y)>1e-4?1/o.y:0;this.offsetPlaneBackground.x=.5*(e.center.x+i.position.x-(i.position.y-this.offsetPlaneBackground.y)*o.x*l),this.offsetPlaneBackground.z=.5*(e.center.z+i.position.z-(i.position.y-this.offsetPlaneBackground.y)*o.z*l)}}a?(this.offsetPlaneBackground.z+=this.ambience.getOffset(),this.offsetPlaneSmall.z=this.offsetPlaneBackground.z):(this.offsetPlaneBackground.y+=this.ambience.getOffset(),this.offsetPlaneSmall.y=this.offsetPlaneBackground.y)},_getPlaneSize:function(e,t,i,r){return this.ambience.isAutoGroundOffset()?this.planeV2?20*e.radius:Math.max(20*(this.offsetPlaneBackground.distanceTo(e.center)+e.radius),5*this.offsetPlaneBackground.distanceTo(t.position)):this.planeV2&&this.planeGrid?this.planeGrid.size:this.gridUnit/this.gridStep},_castRayFunc:function(e,t,i,r){return this.renderer._needPerformanceSuite()?[]:(console.warning("Internal method: use castRay or castRayOnOccurrence instead"),e._cast(t,i,r,a))},castRay:function(e,t,i,r){if(this.renderer._needPerformanceSuite())return[];var n,s=0,o=0,l=(r=r||{}).iDoNotUseDefaultRenderPasses?[]:["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];if(r.iAdditionalRenderPasses)for(o=0;o<r.iAdditionalRenderPasses.length;o++)n=r.iAdditionalRenderPasses[o],l.push(n&&n._getIdString?n._getIdString():n);var h=[];if(t)for(s=0;s<t._occurrences.length;s++)h=h.concat(t._occurrences[s]._getRenderableOccurrences());else{var c=this.internalSceneGraph.scene;for(o=0;o<l.length;o++)h=h.concat(c.getWebGLObjects(l[o]))}return e._cast(h,i,r,a)},castRayOnOccurrence:function(e,t,i,r){var n=0,s=["main","noz","noEffectNoZ","afterHighlightNoZ"],o=[];if(t){o=t._getRenderableOccurrences(this,!1);var l=t._getUniqueOccurrence(this);null===l?console.log("castRayIntoOccurrences ERROR: the path element is either invalid or doesn't define a unique occurrence."):l.node._tryOverridesUpdate(this)}else{var h=this.internalSceneGraph.scene;for(n=0;n<s.length;n++)o=o.concat(h.getWebGLObjects(s[n]))}return e._cast(o,i,r,a)},displayFaces:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("Face",e),this.setRenderMode("AxisSystem",e),this.setRenderMode("InfiniteFace",e)},setBoundaryEdgeColor:function(e){this.renderer.renderer.boundaryEdgeMaterialInfo.color.copy(e),this.render()},displayBoundaryEdgeColor:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.boundaryEdgeMaterialInfo.enabled=e,this.render()},displayBlankingPolygon:function(e){this.renderer.resetGSSOCache(),this.materialManager&&this.materialManager.displayBlankingPolygon(e,this)},displayLines:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this.setRenderMode("@Edge",e)},displayHiddenEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.renderHiddenEdges=e,this.render()},displayHalVisibleSmoothEdges:function(e){this.renderer.resetGSSOCache(),this.renderer.renderer.halfVisibleSmoothEdges=e,this.render()},setRenderLineMode:function(e){switch(this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),e){case t.HideAllRenderLineMode:this.setRenderMode("@Edge",!1);break;case t.HideSmoothEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1),this.setRenderMode("_HighCurvatureEdge",!1);break;case t.HideWireEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("WireEdge",!1);break;case t.HideInternalEdgesRenderLineMode:this.setRenderMode("@Edge",!0),this.setRenderMode("InternalSmoothEdge",!1),this.setRenderMode("_HighCurvatureEdge",!1),this.setRenderMode("InternalSharpEdge",!1);break;case t.ShowAllRenderLineMode:this.setRenderMode("@Edge",!0);break;case t.SmoothEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSmoothEdge",!0),this.setRenderMode("_HighCurvatureEdge",!0);break;case t.SharpEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("InternalSharpEdge",!0);break;case t.WireEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("WireEdge",!0);break;case t.BoundaryEdgeRenderLineModeMask:this.setRenderMode("@Edge",!1),this.setRenderMode("BoundaryEdge",!0)}},addRenderModeLock:function(e,t){this._initRenderStyle(),this.lockedRenderMode.set(e,t),this.setRenderStyle(this._renderStyle)},removeRenderModeLock:function(e){this._initRenderStyle(),this.lockedRenderMode.has(e)&&(this.lockedRenderMode.delete(e),this.setRenderStyle(this._renderStyle))},clearRenderModeLock:function(){this._initRenderStyle(),this.lockedRenderMode.clear(),this.setRenderStyle(this._renderStyle)},applyRenderModeLock:function(){var e=this;this.lockedRenderMode.forEach(function(t,i,r){e._setRenderMode(i,t)})},getPlanesFilter:function(){return!!this.planesFilterStatus},onPlanesFilterChange:function(e){return this._modelEvent.subscribe({event:"RefPlaneFilterMode"},e)},getVerticesFilter:function(){return!!this.verticesFilterStatus},_setVerticesFilter:function(e){e=!!e,this.addRenderModeLock("BoundaryPoint",e),this.addRenderModeLock("SharpPoint",e),this.addRenderModeLock("SmoothPoint",e)},setVerticesFilter:function(e){this.verticesFilterStatus!==e&&(this.verticesFilterStatus=e,!1!==this.linesFilterStatus&&this._setVerticesFilter(e),this.render(),this._modelEvent.publish({event:"VerticesFilterMode",data:{viewer:this,state:this.verticesFilterStatus}}))},onVerticesFilterChange:function(e){return this._modelEvent.subscribe({event:"VerticesFilterMode"},e)},getAxisFilter:function(){return!!this.axisFilterStatus},setAxisFilter:function(e){var i=this.axisFilterStatus!==e;if(t.__NoShowForAxisAndPlanesBags()){var r=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(r){var n=r.getChildrenByName("AxisSystems");n&&n.length>0&&n.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)});var s=r.getChildrenByName("RefPlanes");s&&s.length>0&&s.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}}i&&(this.axisFilterStatus=e,this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}}),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},onAxisFilterChange:function(e){return this._modelEvent.subscribe({event:"AxisFilterMode"},e)},setSmallCurvatureEdgesFilter:function(e){this.smallCurvatureEdgesFilterStatus!==e&&(this.smallCurvatureEdgesFilterStatus=e,this._modelEvent.publish({event:"SmallCurvatureEdgesFilterMode",data:{viewer:this,state:this.smallCurvatureEdgesFilterStatus}}),e?this.removeRenderModeLock("InternalSmoothEdge"):this.addRenderModeLock("InternalSmoothEdge",!1)),this.render()},onSmallCurvatureEdgesFilterChange:function(e){return this._modelEvent.subscribe({event:"SmallCurvatureEdgesFilterMode"},e)},getSmallCurvatureEdgesFilter:function(){return!!this.renderer.renderer.smallCurvatureEdges},getLinesFilter:function(){return!!this.linesFilterStatus},setLinesFilter:function(e){this.linesFilterStatus!==e&&(this.linesFilterStatus=e,this.addRenderModeLock("WireEdge",e),this._setVerticesFilter(!!e&&(null===this.verticesFilterStatus||this.verticesFilterStatus)),this.render(),this._modelEvent.publish({event:"LinesFilterMode",data:{viewer:this,state:this.linesFilterStatus}}))},onLinesFilterChange:function(e){return this._modelEvent.subscribe({event:"LinesFilterMode"},e)},getPointsFilter:function(){return!!this.pointsFilterStatus},setPointsFilter:function(e){this.pointsFilterStatus!==e&&(this.pointsFilterStatus=e,this.addRenderModeLock("FreePoint",e),this.render(),this._modelEvent.publish({event:"PointsFilterMode",data:{viewer:this,state:this.pointsFilterStatus}}))},onPointsFilterChange:function(e){return this._modelEvent.subscribe({event:"PointsFilterMode"},e)},_setRenderMode:function(e,t){this.renderer.resetGSSOCache();var i=new k;i._setFromMasks(this.renderer.renderer.renderPointMode,this._getInternalRenderLineMode(),this._getInternalRenderFaceMode()),i.setRenderMode(e,t),this.renderer.renderer.renderPointMode=i.getMask()&k.pointsMask,this._setInternalRenderFaceMode(i.getMask()&k.facesMask),this._setInternalRenderLineMode(i.getMask()&k.linesMask)},setRenderMode:function(e,t){if(this._renderStyle)return this._renderStyle.setRenderMode(e,t),void this.setRenderStyle(this._renderStyle);this._setRenderMode(e,t),this.applyRenderModeLock()},setRenderStyle:function(e){this.renderer.resetGSSOCache(),this._renderStyle=e.clone(),this.setMaterialMode(e._materialMode);var t=this._renderStyle._renderMode;this.renderer.renderer.renderPointMode=t.getMask()&k.pointsMask,this.renderer.renderer.outlineWidth=t._outlineWidth,this._setInternalRenderFaceMode(t.getMask()&k.facesMask),this._setInternalRenderLineMode(t.getMask()&k.linesMask),this.applyRenderModeLock(),this.internalSceneGraph.root.forceUpdate()},requestViewPanelClose:function(){this._modelEvent.publish({event:"RequestViewPanelClose",data:{viewer:this}})},onRequestViewPanelClose:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelClose"},e)},setRenderFaceMode:function(e){this.renderer.resetGSSOCache(),this._DEPRECATED_setRenderFooMode(new Error),this._setInternalRenderFaceMode(e)},displayPoints:function(e){this.renderer.resetGSSOCache(),e?(this.setRenderMode("@Point",!0),this.setRenderMode("SurfacicPoint",!1),k.defaultMask=k.defaultMask|t.GeomTypeEnum.UNKNOWN_0D):(this.setRenderMode("@Point",!1),k.defaultMask=k.defaultMask&~t.GeomTypeEnum.UNKNOWN_0D)},displaySurfacicPoints:function(e){this.renderer.resetGSSOCache(),this.setRenderMode("SurfacicPoint",e)},_setGradientBackgroundShader:function(){var e;if(null!==this.sphereEnv){var i=this.ambience.getBackground().getColors();switch(i){case 2:e=t.GradientBackgroundMaterial2;break;case 3:e=t.GradientBackgroundMaterial3;break;case 4:e=t.GradientBackgroundMaterial4;break;default:return void this.removeEnvMap()}var r=new e({force:!0,side:t.DoubleSide,forceSide:!0,depthTest:!1});r.colors=[];for(var n=r.colors,s=0;s<i.length;s++){var a=i[s];n.push(a.r),n.push(a.g),n.push(a.b)}this.sphereEnv.material=r}},setGradientBackground:function(e){if(this.renderer.resetGSSOCache(),this.showGradientBackground=[],!e||e.length<2||e.length>4)this.removeEnvMap();else{for(var i=[],r=0;r<e.length;r++){var n=new t.Color(e[r]);this.visibleSpace||n.desaturate(1).alphaBlend(le,.5),this.showGradientBackground.push(new t.Color(e[r])),i.push(n)}this.ambience.getBackground().setColors(i)}},_setBackgroundColor:function(){this._svgMode&&this._2DMode&&!V.getWebGLMode()?this.renderer.setBackgroundColor(0,0):this.renderer.setBackgroundColor(this.ambience.getBackgroundColor().getHex(),this.ambience.getBackgroundAlpha()),this._modelEvent.publish({event:"VisuBackgroundColor",data:this.ambience.getBackgroundColor().getHex()})},setBackgroundColor:function(e,i){if(this.__tempBackgroundColorODT=e,this.renderer.resetGSSOCache(),this.ambience.setBackgroundAlpha(void 0!==i?i:1),this.showBgColor=new t.Color(e).getHex(),this.showBgAlpha=this.ambience.getBackgroundAlpha(),this.visibleSpace)this.ambience.setBackgroundColor(e);else{var r=new t.Color(e);r.desaturate(1).alphaBlend(le,.5),this.ambience.setBackgroundColor(r.getHex())}this._setBackgroundColor(),this.render()},setPlaneColor:function(e){this.renderer.resetGSSOCache(),this.planeColor.set(e),this.showPlaneColor.set(e),this.visibleSpace||this.planeColor.desaturate(1).alphaBlend(le,.5),this.render()},setGridColor:function(e){this.renderer.resetGSSOCache(),this.gridColor.set(e),this.showGridColor.set(e),this.visibleSpace||this.gridColor.desaturate(1).alphaBlend(le,.5),this.render()},setSecondaryLightColor:function(e){var i;this.renderer.resetGSSOCache(),"number"==typeof e||"string"==typeof e?i=new t.Color(e):e&&(i=(new t.Color).copy(e)),i.copyToLinear(i,this.renderer.renderer.simpleGamma),null!==this._directionalLight2&&this._directionalLight2.setColor(i),this.render()},setShadow:function(e,t,i){this._viewerEffectSettings.setShadow(e,t,i)},getShadow:function(e){return this._viewerEffectSettings.getShadow(e)},setAllowShadow(e,t){this._viewerEffectSettings.setAllowShadow(e,t)},getAllowShadow:function(e){return this._viewerEffectSettings.getAllowShadow(e)},setTransparentShadow:function(e,t){this._viewerEffectSettings.setTransparentShadow(e,t)},getTransparentShadow:function(e){return this._viewerEffectSettings.getTransparentShadow(e)},setAllowTransparentShadow(e,t){this._viewerEffectSettings.setAllowTransparentShadow(e,t)},getAllowTransparentShadow:function(e){return this._viewerEffectSettings.getAllowTransparentShadow(e)},setOIT:function(e,t){this._viewerEffectSettings.setOIT(e,t)},getOIT:function(e){return this._viewerEffectSettings.getOIT(e)},setFlakesQuality:function(e,t){this._viewerEffectSettings.setFlakesQuality(e,t)},getFlakesQuality:function(e){return this._viewerEffectSettings.getFlakesQuality(e)},setDownsamplingFactor:function(e){this._viewerEffectSettings.setDownsamplingFactor(e)},getDownsamplingFactor:function(){return this._viewerEffectSettings.getDownsamplingFactor()},setDefaultMaterialQuality:function(e){this._viewerEffectSettings.setDefaultMaterialQuality(e)},getDefaultMaterialQuality:function(){return this._viewerEffectSettings.getDefaultMaterialQuality()},enableZPrePass:function(e,t){this._viewerEffectSettings.enableZPrePass(e,t)},zPrePassEnabled:function(e){return this._viewerEffectSettings.zPrePassEnabled(iOnOff,e)},setShadowFilter:function(e,t){this._viewerEffectSettings.setShadowFilter(e,t)},getShadowFilter:function(e){return this._viewerEffectSettings.getShadowFilter(e)},setShadowQuality:function(e,t){this._viewerEffectSettings.setShadowQuality(e,t)},getShadowQuality:function(e){return this._viewerEffectSettings.getShadowQuality(e)},setShadowCascade:function(e,t,i){this.renderer.resetGSSOCache();var r=this._directionalLight._occurrences[0].renderable,n=t||1024,s=!1;if(null!==r){this.getRenderer()&&(this.getRenderer().shadowMapCascade=e),this.shadowMapWidth===n&&this.shadowMapHeight===n||(s=!0,this.shadowMapWidth=n,this.shadowMapHeight=n,e||(r.shadowMap=null,r.shadowMapWidth=n,r.shadowMapHeight=n)),r.shadowCascade=e,r.shadowCascadeCount=i||3,r.shadowCascadeWidth=[],r.shadowCascadeHeight=[],r.shadowCascadeBias=[],r.shadowCascadeNearZ=[],r.shadowCascadeFarZ=[];for(var a=0;a<r.shadowCascadeCount;a++)r.shadowCascadeWidth[a]=n,r.shadowCascadeHeight[a]=n,r.shadowCascadeBias[a]=-.005;if(r.shadowCascadeOffset.set(0,0,-10),s&&r.shadowCascadeArray)for(a=0;a<r.shadowCascadeArray.length;a++){var o=r.shadowCascadeArray[a];o.shadowMap=null,o.shadowMapWidth=n,o.shadowMapHeight=n,o.shadowBias=-.005}this.renderer&&this.renderer.recompileAllShaders(null)}},removePlaneV2:function(){this.ambience.usePlaneV2&&!this._planeV2Appli&&(this.setGroundOptions({displayPlane:!1,displayGrid:!1,planeFalloff:0}),this.planeGrid&&this.planeGrid.mesh&&(this.planeGrid.mesh.visible=!1),this.planeV2=!1),this._requestedPlaneV2=!1},setGroundShadow:function(e,t){this._viewerEffectSettings.setGroundShadow(e,t)},getGroundShadow:function(e){return this._viewerEffectSettings.getGroundShadow(e)},setAllowGroundShadow:function(e,t){this._viewerEffectSettings.setAllowGroundShadow(e,t)},getAllowGroundShadow:function(e){return this._viewerEffectSettings.getAllowGroundShadow(e)},setGroundShadowAutomaticUpdate:function(e){this._dirLightGroundShadow.blockShadowUpdates(!e),e&&this._dirLightGroundShadow.updateShadowMap()},setGroundShadowDirection:function(e,t){this.groundShadowLatitude=e,this.groundShadowLongitude=t,this._dirLightGroundShadow.updateShadowMap()},_setGroundShadow:function(){if(!this.blurShadowEffect){this.blurShadowEffect=new I(this.renderer.renderer,this.renderer.renderTargetPool),this._dirLightGroundShadow.light3js.blurShadowEffect=this.blurShadowEffect;for(var e=0;e<this._dirLightGroundShadow._occurrences.length;e++)this._dirLightGroundShadow._occurrences[e].renderable.blurShadowEffect=this.blurShadowEffect}var t=this._dirLightGroundShadow.light3js.groundMaterial;t&&(t.getPDSFXUniform("groundShadow").value||(t.defines.GROUND_SHADOW=1,t.needsUpdate=!0))},setGrid:function(e,t){this.renderer.resetGSSOCache(),this.displayGrid!==e&&(this.displayGrid=e,this._modelEvent.publish({event:"DisplayGrid",data:{viewer:this,value:e}})),this._updateGridDisplay(),void 0!==t&&(this.displayGridFromBelow=t,this.planeV2&&(this.planeGrid.displayGridFromBelow=t?1:0)),this.render()},getGrid:function(){return this.displayGrid},onGridChange:function(e){return this._modelEvent.subscribe({event:"DisplayGrid"},e)},_updateGridDisplay:function(){var t=!this._2DMode&&this.displayGrid;this._displayGrid!==t&&(this._displayGrid=t,this.planeV2&&(this.planeGrid.displayGrid=t?1:0),e.publish({event:"/WUX/AFR/CMD/VisuGrid/"+(t?"BEGIN":"END")}))},getGridUnit:function(){return this.planeV2&&this.planeGrid?this.planeGrid.gridUnit:this.gridUnit},onProjectionTypeChange:function(e){var t=0,i=this;return this.onPreRender(function(){i.currentViewpoint&&i.currentViewpoint.getProjectionType()!==t&&(t=i.currentViewpoint.getProjectionType(),e({viewer:i,state:t}))})},displayInfinitePlane:function(e,t){this.renderer.resetGSSOCache(),this.infinitePlane=e,this.planeAttenuation=void 0!==t&&t,this._updateInfinitePlaneDisplay()},_updateInfinitePlaneDisplay:function(){this._infinitePlane=!this._2DMode&&this.infinitePlane,this.planeV2&&(this.planeGrid.displayPlane=this._infinitePlane?1:0),this._infinitePlane?(this.render({updateInfinitePlane:!0}),this.useShadowPlane=!0):!this.planeV2&&this._removeInfinitePlane(this.infPlane)},setShadowPlane:function(e){this.renderer.resetGSSOCache(),this.useShadowPlane=e,this._updateShadowPlaneDisplay()},_updateShadowPlaneDisplay:function(e){!this._2DMode&&this.useShadowPlane?this.render({updateInfinitePlane:!0}):!this._infinitePlane&&this._removeInfinitePlane(this.infPlaneSmall)},setAutomaticPlaneUpdate:function(e){this.ambience.setAutoGroundOffset(e)},setPlanePositionAndScale:function(e,t){this.offsetPlaneBackground.copy(e),this.offsetPlaneSmall.z=e.z,this.ambience.updateScene(e),this.gridUnit=t},setGridNbSteps:function(e){if(this.renderer.resetGSSOCache(),this.gridNbSteps=Math.min(Math.max(e,1),10),this.planeV2)this.planeGrid.setGridNbSteps(this.gridNbSteps);else{if(!this.bigGrid)return;this._createBigGridGeometry()}},setGroundOptions:function(e){this.renderer.resetGSSOCache(),void 0!==e.groundCenter&&(this.offsetPlaneBackground.copy(e.groundCenter),this.offsetPlaneSmall.z=e.groundCenter.z,this.ambience.updateScene(e.groundCenter)),void 0!==e.groundSize&&this.planeV2&&(this.planeGrid.size=e.groundSize),void 0!==e.groundShadow&&this.setGroundShadow(!!e.groundShadow),void 0!==e.displayPlane&&this.displayInfinitePlane(!!e.displayPlane,e.planeAttenuation),void 0!==e.displayGrid?this.setGrid(!!e.displayGrid,e.displayGridFromBelow):void 0!==e.displayGridFromBelow&&this.setGrid(this.displayGrid,e.displayGridFromBelow),void 0!==e.gridNbSteps&&this.setGridNbSteps(e.gridNbSteps),void 0!==e.gridLabels&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabels(e.gridLabels),void 0!==e.gridLabelColor&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelColor(e.gridLabelColor),void 0!==e.gridLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setLabelCallback(e.gridLabelCallback),void 0!==e.gridDisplayLabelCallback&&this.planeV2&&this.planeGrid&&this.planeGrid.setDisplayLabelCallback(e.gridDisplayLabelCallback),void 0!==e._onlyDiffuse&&this.planeV2&&this.planeGrid&&(this.planeGrid._onlyDiffuse=e._onlyDiffuse),void 0!==e.planeMirror&&this.setMirror(!!e.planeMirror,e.blurryMirror),void 0!==e.planeColor&&this.setPlaneColor(e.planeColor),this.planeV2&&this.planeGrid&&(void 0!==e.planeOpacity&&(this.planeGrid.planeOpacity=e.planeOpacity),void 0!==e.planeTexture&&(this.planeGrid.planeTexture=e.planeTexture),void 0!==e.planeTextureScale&&(this.planeGrid.planeTextureScale=e.planeTextureScale),void 0!==e.planeFalloff&&(this.planeGrid.planeFalloff=e.planeFalloff),void 0!==e.gridFalloff&&(this.planeGrid.gridFalloff=e.gridFalloff),void 0!==e.planeBorder&&(this.planeGrid.planeBorder=e.planeBorder),void 0!==e.planeBorderColor&&this.planeGrid.edgeColor.set(e.planeBorderColor)),void 0!==e.gridColor&&this.setGridColor(e.gridColor)},getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:!!this.planeGrid&&this.planeGrid.displayLabels,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:this.planeColor.getHexString(),gridColor:this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?this.planeGrid.edgeColor.getHexString():void 0}},_getGroundOptions:function(){return{groundCenter:this.offsetPlaneBackground,groundSize:this.planeGrid?this.planeGrid.size:void 0,groundShadow:this.useGroundShadow,displayPlane:this.infinitePlane,onlyDiffuse:this.planeGrid?this.planeGrid._onlyDiffuse:0,displayGrid:this.displayGrid,displayGridFromBelow:this.displayGridFromBelow,gridNbSteps:this.gridNbSteps,gridLabels:this.planeGrid?this.planeGrid.displayLabels:null,gridLabelCallback:this.planeGrid?this.planeGrid.labelCB:null,gridDisplayLabelCallback:this.planeGrid?this.planeGrid.displayLabelCB:null,planeMirror:this.useMirror,blurryMirror:this.blurryMirror,planeColor:"#"+this.planeColor.getHexString(),planeOpacity:this.planeGrid?this.planeGrid.planeOpacity:1,planeTexture:this.planeGrid?this.planeGrid.planeTexture:null,planeTextureScale:this.planeGrid?this.planeGrid.planeTextureScale:1,gridColor:"#"+this.gridColor.getHexString(),gridFalloff:this.planeGrid?this.planeGrid.gridFalloff:void 0,planeFalloff:this.planeGrid?this.planeGrid.planeFalloff:void 0,planeBorder:!!this.planeGrid&&this.planeGrid.planeBorder,planeBorderColor:this.planeGrid?"#"+this.planeGrid.edgeColor.getHexString():void 0}},setMirror:function(e,t,i,r,n){this._viewerEffectSettings.setMirror(e,t,i,r,n)},getMirror:function(e){return this._viewerEffectSettings.getMirror(e)},setAllowMirror:function(e,t){this._viewerEffectSettings.setAllowMirror(e,t)},getAllowMirror:function(e){return this._viewerEffectSettings.getAllowMirror(e)},setVignetting:function(e){this.useVignetting!==e&&(this.renderer.setEffect("Vignetting",e),this.useVignetting=e,this.render())},setHighlight:function(e){this.displayHighlight!==e&&(this.displayHighlight=e,this.setPicking({activated:e,displayHL:e}),this.renderer.setEffect("Highlight",e),this.renderer.setEffect("Canvas2DHighlight",e),this.render())},showHighlight:function(e){this._showHighlight!==e&&(this._showHighlight=e,this.render())},setRenderIteration:function(e){this.isRenderIteration=e},lockRenderIteration:function(){this._lockRenderIteration=!0},unlockRenderIteration:function(){this._lockRenderIteration=!1},setAntiAliasing:function(e,t){this._viewerEffectSettings.setAntiAliasing(e,t)},getAntiAliasing:function(e){return this._viewerEffectSettings.getAntiAliasing(e)},setPixelCulling:function(e,t){this._viewerEffectSettings.setPixelCulling(e,t)},getPixelCulling:function(e){return this._viewerEffectSettings.getPixelCulling(e)},setLOD:function(e,t){this._viewerEffectSettings.setLOD(e,t)},getLOD:function(e){return this._viewerEffectSettings.getLOD(e)},setSSAO:function(e,t){this._viewerEffectSettings.setSSAO(e,t)},getSSAO:function(e){return this._viewerEffectSettings.getSSAO(e)},setAllowSSAO:function(e,t){this._viewerEffectSettings.setAllowSSAO(e,t)},getAllowSSAO:function(e){return this._viewerEffectSettings.getAllowSSAO(e)},setSSAOParameters:function(e,t){var i=this.ssaoParams;void 0!==e.dynamicRadius&&(i.dynamicRadius=e.dynamicRadius),void 0!==e.adaptativeRadius&&(i.adaptativeRadius=e.adaptativeRadius),void 0!==e.radius&&(i.radius=e.radius),void 0!==e.radiusMin&&(i.radiusMin=e.radiusMin),void 0!==e.radiusMax&&(i.radiusMax=e.radiusMax),void 0!==e.minPixelRadius&&(i.minPixelRadius=e.minPixelRadius),void 0!==e.attenuation&&(i.attenuation=e.attenuation),void 0!==e.contrast&&(i.contrast=e.contrast),void 0!==e.power&&(i.power=e.power),void 0!==e.thresholdAngle&&(i.thresholdAngle=e.thresholdAngle),8!==e.nbOfSamples&&16!==e.nbOfSamples&&32!==e.nbOfSamples||this._viewerEffectSettings.setSSAONbSamples(e.nbOfSamples,t)},setIterativeSSAO:function(e){this.useSSAOIterative=e},setDOF:function(e,t){return this._viewerEffectSettings.setDOF(e,t)},getDOF:function(e){return this._viewerEffectSettings.getDOF(e)},setAllowDOF:function(e,t){return this._viewerEffectSettings.setAllowDOF(e,t)},getAllowDOF:function(e){return this._viewerEffectSettings.getAllowDOF(e)},setIterativeDOF:function(e){this.useDOFIterative=e},setSSLR:function(e,t){this._viewerEffectSettings.setSSLR(e,t)},getSSLR:function(e){return this._viewerEffectSettings.getSSLR(e)},setAllowSSLR:function(e,t){this._viewerEffectSettings.setAllowSSLR(e,t)},getAllowSSLR:function(e){return this._viewerEffectSettings.getAllowSSLR(e)},setSSLRefraction:function(e,t){this._viewerEffectSettings.setSSLRefraction(e,t)},getSSLRefraction:function(e){return this._viewerEffectSettings.getSSLRefraction(e)},setAllowSSLRefraction:function(e,t){this._viewerEffectSettings.setAllowSSLRefraction(e,t)},getAllowSSLRefraction:function(e){return this._viewerEffectSettings.getAllowSSLRefraction(e)},setBloom:function(e,t){this._viewerEffectSettings.setBloom(e,t)},getBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAllowBloom:function(e,t){this._viewerEffectSettings.setAllowBloom(e,t)},getAllowBloom:function(e){return this._viewerEffectSettings.getBloom(e)},setAdvancedPoliteHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!0,e),r&&r.setHighlightData(!0,t),this.render()},setHaloHighlight:function(e,t){var i=this.internalSceneGraph.selectionHL,r=this.internalSceneGraph.selectionPreHL;i&&i.setHighlightData(!1,e),r&&r.setHighlightData(!1,t),this.render()},getHighlightData:function(){var e=this.internalSceneGraph.selectionHL,t=this.internalSceneGraph.selectionPreHL,i={highlightData:null,preHighlightData:null};return e&&(i.highlightData=e.getHighlightData()),t&&(i.preHighlightData=t.getHighlightData()),i},setPreHighlightColor:function(e,i){console.warn("Warning: Deprecated API, please use setAdvancedPoliteHighlight or setHaloHighlight instead"),this.internalSceneGraph.selectionPreHL&&(e instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:e,outlineThickness:1}):i instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{outlineColor:i,outlineThickness:1}),i instanceof t.Color?this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:i,haloIntensity:500,haloThickness:1}):e instanceof t.Color&&this.internalSceneGraph.selectionPreHL.setHighlightData(this.internalSceneGraph.selectionPreHL.advanced,{haloColor:e,haloIntensity:500,haloThickness:1}))},getEffect:function(e){var t=null;switch(e){case"xRevealStructure":t=this.renderer.XRevealStructureEffect;break;case"ToneMapping":case"Vignetting":t=this.renderer.ToneMappingEffect;break;case"Bloom":t=this.renderer.BloomEffect;break;case"DOF":t=this.renderer.BokehDOFEffect;break;case"SSLR":t=this.renderer.SSLREffect;break;case"SSLRDirect":t=this.renderer.SSLRDirectEffect;break;case"VolumeRendering":t=this.renderer.VolumeRenderingEffect;break;case"SSAO":t=this.renderer.SSAOEffect;break;case"SSAOIterative":t=this.renderer.SSAOIterativeEffect;break;case"PreHighlight":t=this.renderer.PreHighlightEffect;break;case"Canvas2DPreHighlight":t=this.renderer.Canvas2DPreHighlightEffect;break;case"Highlight":t=this.renderer.HighlightEffect;break;case"Canvas2DHighlight":t=this.renderer.Canvas2DHighlightEffect}return t},setFlare:function(e){this.useFlare!==e&&(this.renderer.setEffect("Flare",e),this.useFlare=e,this.render())},setMagnifier:function(e){e.viewer||(e.viewer=this),null===this.magnifier?this.magnifier=new g(e):this.magnifier.setOption(e),this.pPicking.activated||this.setPrePicking({activated:!0,displayHL:!1,gpu:!1,computeNormalDepth:!0})},setFillXSOMode:function(e){this._fillXSOMode=e},setPicking:function(e,t){"boolean"==typeof e&&console.log("boolean is DEPRECATED in setPicking() method.\n Use object instead."),void 0!==e.activated&&(this.picking.activated=e.activated);var i=e.divTrap,r=function(){var e=this.picking.trapSelection;!1!==window.enableNewTrapSelection?e?(this.trapSelectionManipulator||(this.trapSelectionManipulator=new O(this),this.trapSelectionManipulator._linkToViewer()),this.trapSelectionManipulator.enable(),this.trapSelectionManipulator.setAdvanced("advanced"===e),void 0!==i?this.trapSelectionManipulator.setShowDivTrap(!!i):this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)):this.trapSelectionManipulator&&this.trapSelectionManipulator.disable():(this.trapSelection||(this.trapSelection=new m(this)),this.trapSelection.set(e))};void 0!==e.contextPick&&(this.picking.contextPick=e.contextPick),void 0!==e.displayHL&&(this.picking.displayHL=e.displayHL),void 0!==e.gpu&&(this.picking.gpu=e.gpu),void 0!==e.trapGPU&&(this.picking.trapGPU=e.trapGPU),void 0!==e.computeNormalDepth&&(this.picking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.picking.primitive=e.primitive,this.picking._trapPrimitiveUsed||(this.picking.trapPrimitive=!!e.primitive)),void 0!==e.pickingTolerance&&(this.renderer.gpuPickingTolerance=e.pickingTolerance,this.picking.tolerance=e.pickingTolerance),void 0!==e.forceVisibility&&this.picking.forceVisibility!==e.forceVisibility&&(this.picking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forceHighlightVisibility(e.forceVisibility)),void 0!==e.trapSelection&&(this.picking.trapSelection=e.trapSelection,r.call(this)),void 0!==e.trapSelectionMesh&&(console.warn("DEPRECATED: please use trapPrimitive to control trap selection granularity instead"),this.picking.trapSelection=e.trapSelectionMesh,this.picking._trapPrimitiveUsed=!e.trapSelectionMesh,this.picking.trapPrimitive=!this.picking.trapSelection&&this.picking.trapPrimitive,r.call(this)),void 0!==e.trapPrimitive&&(this.picking.trapPrimitive=e.trapPrimitive,this.picking._trapPrimitiveUsed=!0),void 0!==e.showDivTrap&&(this.picking.showDivTrap=e.showDivTrap,this.trapSelectionManipulator&&this.trapSelectionManipulator.setShowDivTrap(this.picking.showDivTrap)),this.renderer&&(this.renderer.setEffect("Highlight",this.picking.activated&&this.picking.displayHL),this.renderer.setEffect("Canvas2DHighlight",this.picking.activated&&this.picking.displayHL));var n=!0;void 0!==t&&(n=t),this.setDefaultPicking(n)},setPrePicking:function(e,t){void 0!==e.activated&&(this.pPicking.activated=e.activated),void 0!==e.trapSelection&&(this.pPicking.trapSelection=e.trapSelection),void 0!==e.displayHL&&(this.pPicking.displayHL=e.displayHL),void 0!==e.gpu&&(this.pPicking.gpu=e.gpu),void 0!==e.computeNormalDepth&&(this.pPicking.computeNormalDepth=e.computeNormalDepth),void 0!==e.primitive&&(this.pPicking.primitive=e.primitive),void 0!==e.disableWhileMoving&&(this.pPicking.disableWhileMoving=e.disableWhileMoving),void 0!==e.forceVisibility&&this.pPicking.forceVisibility!==e.forceVisibility&&(this.pPicking.forceVisibility=e.forceVisibility,this.internalSceneGraph.forcePreHighlightVisibility(e.forceVisibility)),this.renderer&&(this.renderer.setEffect("PreHighlight",this.pPicking.activated&&this.pPicking.displayHL),this.renderer.setEffect("Canvas2DPreHighlight",this.pPicking.activated&&this.pPicking.displayHL));var i=!0;void 0!==t&&(i=t),this.setDefaultPicking(i)},setPickingGPU:function(e){this.picking.gpu!==e&&(this.picking.gpu=e)},setSmallRenderTargetPicking:function(e){this.renderer.smallTargetPicking!==e&&(this.renderer.smallTargetPicking=e)},setIntensityCorrection:function(e){},activateNoMeshInRAM:function(e){console.warn("DEPRECATED: noMeshInRAM should be activated on the modelLoader")},setManipulators:function(e){if(!this.manipulatorManager)return!1;void 0!==e.activated&&this.manipulatorManager.setActivate(e.activated),void 0!==e.preActivate&&this.manipulatorManager.setPreActivate(e.preActivate)},getManipulators:function(){return!!this.manipulatorManager&&this.manipulatorManager.getActivate()},setOverrideCursors:function(e){this.overrideCursors=e},getCursor:function(){return this.canvas.style.cursor},setCursor:function(e,t,r){if(this.overrideCursors){var n=this,s="auto";if(-1!==["auto","-webkit-grabbing","pointer"].indexOf(e))s=e;else if("Auto"!==e)if(r)s=e;else{var a=i.getWebappsAssetUrl("Visualization","")+"icons/";s="url('"+a+"WebViewer"+e+".png'), url('"+a+"WebViewer"+e+".cur'), auto"}this._changeCursorDelay&&(clearTimeout(this._changeCursorDelay),this._changeCursorDelay=null);var o=function(e){n.canvas.style.cursor=e};t>0?this._changeCursorDelay=setTimeout(function(){o(s)},t):o(s)}},setTemporaryCursor:function(e){var t=this._temporaryCursorData;t||(t={oldCursor:this.getCursor()||null},this._temporaryCursorData=t,this.setCursor(e))},unsetTemporaryCursor:function(){var e=this._temporaryCursorData;if(e){var t=e.oldCursor||"auto";this.setCursor(t,0,!0),this._temporaryCursorData=null}},setForceMultiSelection:function(e){this.forceMultiSel=e},setForcePickingFaces:function(e){this._pickingMode._setPickingMode(k.facesMask,e?1:2),this._setPickingMode()},setForcePickingLines:function(e){this._pickingMode._setPickingMode(k.linesPickingMask,e?1:2),this._setPickingMode()},setForcePickingPoints:function(e){this._pickingMode._setPickingMode(k.pointsMask,e?1:2),this._setPickingMode()},setFacePickingMode:function(e){this._pickingMode._setPickingMode(k.facesMask,e),this._setPickingMode()},setLinePickingMode:function(e){this._pickingMode._setPickingMode(k.linesPickingMask,e),this._setPickingMode()},setPointPickingMode:function(e){this._pickingMode._setPickingMode(k.pointsMask,e),this._setPickingMode()},setPickingMode:function(e,t){this._pickingMode.setPickingMode(e,t),this._setPickingMode()},_setPickingMode:function(){this.renderer.renderer.pickingModeLSB=this._pickingMode.pickingModeLSB,this.renderer.renderer.pickingModeMSB=this._pickingMode.pickingModeMSB,this.invalidatePickingBuffer(!1),this.renderer.resetGSSOCache()},getPickingMode:function(){return this._pickingMode.clone()},setFromPickingNode:function(e){this._pickingMode=e.clone(),this._setPickingMode()},getRenderMode:function(){return this.renderer.renderer.getRenderMode().clone()},setDebugPostProcessing:function(e){this.debugPostProcessing!==e&&(this.renderer.setEffect("DebugPass",e),this.debugPostProcessing=e,this.render())},_initGLCounters:function(){this._glCounters||(this._glCounters={_glFPSCounter:null,_glInfoCounter:null,_glNodeCounter:null,_glCustomCounter:null})},showPerfo:function(e,t,i,r,n,s){this._initGLCounters(),require(["DS/VisuTools/FPSCounter"],a=>{void 0!==n&&a.setAutoRefresh(!n),void 0!==s&&a.setHideOOC(s),e&&!this._glCounters._glFPSCounter?(this._glCounters._glFPSCounter=a,this._glCounters._glFPSCounter.setActivated(this,!0,i),window.webVisuPerfo.setEnabled(!!t),r&&r()):this._glCounters._glFPSCounter&&(this._glCounters._glFPSCounter.setActivated(this,e,i),window.webVisuPerfo.setEnabled(!!t)),this.render()})},_enableInfos:function(e){this.renderer.renderer.generateInfos=e},showInfos:function(e,t){if(this._enableInfos(e),this._initGLCounters(),e&&!this._glCounters._glInfoCounter){var i=this;require(["DS/VisuTools/InfoCounter"],function(e){i._glCounters._glInfoCounter=new e(i,t),i.render()})}else this._glCounters._glInfoCounter&&(this._glCounters._glInfoCounter.activate(e),this.render())},showNodeCounter:function(e,t){if(this._initGLCounters(),e&&!this._glCounters._glNodeCounter){var i=this;require(["DS/VisuTools/NodeCounter"],function(e){i._glCounters._glNodeCounter=new e(i,t),i.render()})}else this._glCounters._glNodeCounter&&(this._glCounters._glNodeCounter.activate(e),this.render())},showCustomCounter:function(e,t){if(this._initGLCounters(),e&&!this._glCounters._glCustomCounter){var i=this;require(["DS/VisuTools/CustomCounter"],function(e){i._glCounters._glCustomCounter=new e(i,t.color),i._glCounters._glCustomCounter.setParams(t),i.render()})}else this._glCounters._glCustomCounter&&(this._glCounters._glCustomCounter.setParams(t),this._glCounters._glCustomCounter.activate(e),this.render())},setHUD:function({fps:e,ooc:t,nodeCounter:i,infos:r,color:n}){this.showPerfo(e||t,"full"===e&&!t,n,void 0,!e,!t),this.showNodeCounter(i,n),this.showInfos(r,n)},setDebugFPS:function(e,t){this.debugFPS=e,this.debugFPSInfos.fpsLastTime=performance.now(),this.debugFPSInfos.fpsWindow=t||40,this.debugFPSInfos.fpsIndex=0,this.debugFPSInfos.fpsCumul=30*this.debugFPSInfos.fpsWindow,this.debugFPSInfos.fpsValue=30,this.debugFPSInfos.fpsArray=[];for(var i=0;i<this.debugFPSInfos.fpsWindow;i++)this.debugFPSInfos.fpsArray[i]=30;e?this.debugFPSInfos.fpsCounter?this.debugFPSInfos.fpsCounter.show():(this.debugFPSInfos.fpsCounter=new UWA.Element("div",{html:"FPS",styles:{fontFamily:"arial, sans-serif",fontSize:"20px",position:"absolute",top:"20px",right:"10px",textAlign:"left",verticalAlign:"middle",backgroundColor:"#333",color:"white"}}),this.div.appendChild(this.debugFPSInfos.fpsCounter)):this.debugFPSInfos.fpsCounter&&this.debugFPSInfos.fpsCounter.hide()},setDebugShadowMaps:function(e){this.debugShadowMaps!==e&&(this.renderer.setEffect("DebugShadowMaps",e),this.debugShadowMaps=e,this.render())},setDebugEvents:function(e){this.debugEvents=e,b.setDebugEvents(e)},getDisplayFaces:function(){return!!(this.renderer.renderer.renderFaceMode&t.GeomTypeEnum.FACE)},getDisplayLines:function(){return this.renderer.renderer.renderLineMode!==t.HideAllRenderLineMode},getDisplayPoints:function(){return this.renderer.renderer.renderPointMode>0},getInfinitePlane:function(){return this.infinitePlane},getMirror:function(){return this.useMirror},_setPlaneGridOrientation:function(e){e?this.planeGridOrientation.copy(e):this.planeGridOrientation.makeBasis(this._worldOrientation.frontVector,this._worldOrientation.rightVector,this._worldOrientation.upVector)},createInfinitePlane:function(e,i,r,n){if(!te){var s,a=null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene,o=new t.Vector3,l=new t.Vector3,h=(new t.Matrix4).copy(this.planeGridOrientation);if(o.copy(this._worldOrientation.frontVector),o.multiplyScalar(n.dot(this._worldOrientation.frontVector)-.5*r),l.copy(this._worldOrientation.rightVector),l.multiplyScalar(n.dot(this._worldOrientation.rightVector)-.5*r),o.add(l),l.copy(this._worldOrientation.upVector),l.multiplyScalar(n.dot(this._worldOrientation.upVector)),o.add(l),h.setPosition(o),h.scale(new t.Vector3(r,r,r)),null===e){if(1===i)(s=new t.PlaneMaterial)._firstDirOnly=this.triLights,s.ambient.copy(new t.Color(328965)),s.color.copy(this.planeColor),(u=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),s.updatePDSFXUniform("border",u),s.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),s.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0),(d=P.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:s}))._setIsAlwaysInForeground(!0),this.infPlane=d._occurrences[0].renderable,(e=this.infPlane).receiveShadow=!1,e.renderDepth=1,this.sceneBackground.add(e);else if(0===i){s=new t.SmallPlaneMaterial(void 0),this._dirLightGroundShadow.light3js.groundMaterial=s;for(var c=0;c<this._dirLightGroundShadow._occurrences.length;c++)this._dirLightGroundShadow._occurrences[c].renderable.groundMaterial=s;var d;(d=P.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:s}))._setIsAlwaysInForeground(!0),this.infPlaneSmall=d._occurrences[0].renderable,(e=this.infPlaneSmall).receiveShadow=!0,e.castShadow=!1,e.renderDepth=-Number.MAX_VALUE,a.add(e)}e.pickable=!1,e.frustumCulled=!1,e.visibilityFree=!0,e.setMatrix(h)}else{var u;if(e.visible=!0,e.visibilityFree=!0,1===i&&e.material&&(e.material.color.copy(this.planeColor),(u=new t.Color).copyToLinear(this.ambience.getBackgroundColor(),this.renderer.renderer.simpleGamma),e.material.updatePDSFXUniform("border",u),e.material.updatePDSFXUniform("borderAlpha",this.ambience.getBackgroundAlpha()),e.material.updatePDSFXUniform("attenuation",this.planeAttenuation?1:0)),e.setMatrix(h),0===i){-1==a.children.indexOf(e)&&a.add(e)}}}},_removeInfinitePlane:function(e,t){null!==e&&e.visible&&(e.visible=!1,!t&&this.render())},createGrid:function(e,r,n,s,a){if(!te){s=Math.pow(Math.max(0,s),.4);var o,l,c,d,u=this.mobile;o=function(t){var i=Math.tan(.125*Math.PI);return i*=t/e,Math.ceil(100*i)}(n),l=this.ambience.isAutoGroundOffset()?function(e){for(var t=.25*e,i=2e-4,r=0;i<t;){switch(r%3){case 0:i*=2;break;case 1:i*=2.5;break;case 2:i*=2}r++}return i}(e*o):e,null!==this.grid&&(this.grid.visibilityFree=!0,this.grid.material.color=this.gridColor),null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.material.color=this.gridColor);var p=new t.Vector3,f=new t.Vector3,g=(new t.Matrix4).copy(this.planeGridOrientation);g.scale(new t.Vector3(l,l,l)),this.gridSize=l,this.gridUnit=l*this.gridStep;var m,v=new t.Vector3(0,0,r.dot(this._worldOrientation.upVector));if(v.x=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.frontVector)/(this.gridNbSteps*this.gridUnit)),v.y=this.gridNbSteps*this.gridUnit*Math.floor(r.dot(this._worldOrientation.rightVector)/(this.gridNbSteps*this.gridUnit)),u?(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x-.5*l),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y-.5*l),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)):(p.copy(this._worldOrientation.frontVector),p.multiplyScalar(v.x),f.copy(this._worldOrientation.rightVector),f.multiplyScalar(v.y),p.add(f),f.copy(this._worldOrientation.upVector),f.multiplyScalar(v.z),p.add(f)),g.setPosition(p),null!==this.grid)return this.grid.visibilityFree=!0,this.grid.setMatrix(g),this.grid.material.updatePDSFXUniform("gridSize",e),this.grid.material.updatePDSFXUniform("attenuation",this.grid.map?.9*s:.6*s),this.grid.visible=!0,null!==this.bigGrid&&(this.bigGrid.visibilityFree=!0,this.bigGrid.setMatrix(g),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",s),this.bigGrid.visible=!0),!0;if(c=new t.GridMaterial,u&&((m=new t.ImageUtils.loadTexture(i.getWebappsAssetUrl("Visualization","grid512.png"),void 0,null,null,t.ImageUtils.crossOriginPolicy)).wrapS=t.RepeatWrapping,m.wrapT=t.RepeatWrapping,m.anisotropy=8,m.repeat=new t.Vector2(.2/this.gridStep,.2/this.gridStep),c.setGridTexture(m)),c.updatePDSFXUniform("gridSize",e),c.updatePDSFXUniform("attenuation",u?.9*s:.6*s),u){var _=P.createRectangleNode({width:1,height:1,fill:!0,noEdge:!0,material:c});this.grid=_._occurrences[0].renderable,this.grid.frustumCulled=!1}else{var y=new h.PrimitiveGroup,S=2/this.gridStep,x=6*S,b=8*S,w=new h.Buffer({component:h.VertexComponentEnum.POSITION,data:new Float32Array(3*x)}),M=new Uint16Array(b),C=new h.Buffer({indexBuffer:!0,data:M});y.addBuffer(0,w),y.addBuffer(1,C);var E=0,T=0,A=w.data,D=C.data;for(d=0;d<S;d++)A[E++]=d*this.gridStep-1,A[E++]=-1,A[E++]=0,A[E++]=d*this.gridStep-1,A[E++]=0,A[E++]=0,A[E++]=d*this.gridStep-1,A[E++]=1,A[E++]=0,A[E++]=-1,A[E++]=d*this.gridStep-1,A[E++]=0,A[E++]=0,A[E++]=d*this.gridStep-1,A[E++]=0,A[E++]=1,A[E++]=d*this.gridStep-1,A[E++]=0;for(d=0;d<4*S;d++)D[T++]=3*d,D[T++]=3*d+1,D[T++]=3*d+1,D[T++]=3*d+2;var I=new h.Primitive({nbIndices:b,connectivity:h.ConnectivityTypeEnum.LINES,fillGAS:new h.FillAttributes(new h.Color(.2,.2,.2,1))}),R=new h.VertexComponent({nbVertices:x,bufferId:0,indices:new h.IndexArray({bufferId:1,offset:0})});I.addVertexComponent(R),y.addPrimitive(I);var O=P.createMeshNode(y,c);O._setIsAlwaysInForeground(!0),this.grid=O._occurrences[0].renderable,this.grid.frustumCulled=!1}return this.grid.pickable=!1,this.grid.receiveShadow=!0,this.grid.renderDepth=0,this.grid.visibilityFree=!0,this.sceneBackground.add(this.grid),u||(this._createBigGridGeometry(),this.bigGrid.setMatrix(g),this.bigGrid.material.updatePDSFXUniform("gridSize",e),this.bigGrid.material.updatePDSFXUniform("attenuation",s),this.bigGrid.material.color=this.gridColor),this.grid.setMatrix(g),this.grid.material.color=this.gridColor,!0}},_createBigGridGeometry:function(){this.bigGrid&&this.sceneBackground.remove(this.bigGrid);var e=new t.GridMaterial,i=this.gridNbSteps*this.gridStep,r=.02*this.gridStep,n=new h.PrimitiveGroup,s=2/this.gridStep,a=12*s,o=24*s,l=new h.Buffer({component:h.VertexComponentEnum.POSITION,data:new Float32Array(3*a)}),c=new h.Buffer({component:h.VertexComponentEnum.NORMAL,data:new Float32Array(3)}),d=new h.Buffer({indexBuffer:!0,data:new Uint16Array(o)}),u=new h.Buffer({indexBuffer:!0,data:new Uint16Array(o)});n.addBuffer(0,l),n.addBuffer(1,c),n.addBuffer(2,d),n.addBuffer(3,u);var p=0,f=0,g=0,m=l.data,v=d.data,_=c.data,y=u.data;_[0]=0,_[1]=0,_[2]=1;for(var S=0;S<s;S++)m[p++]=S*i-1-r,m[p++]=-1,m[p++]=0,m[p++]=S*i-1-r,m[p++]=0,m[p++]=0,m[p++]=S*i-1-r,m[p++]=1,m[p++]=0,m[p++]=S*i-1+r,m[p++]=1,m[p++]=0,m[p++]=S*i-1+r,m[p++]=0,m[p++]=0,m[p++]=S*i-1+r,m[p++]=-1,m[p++]=0,m[p++]=-1,m[p++]=S*i-1-r,m[p++]=0,m[p++]=0,m[p++]=S*i-1-r,m[p++]=0,m[p++]=1,m[p++]=S*i-1-r,m[p++]=0,m[p++]=1,m[p++]=S*i-1+r,m[p++]=0,m[p++]=0,m[p++]=S*i-1+r,m[p++]=0,m[p++]=-1,m[p++]=S*i-1+r,m[p++]=0;for(S=0;S<24*s;S++)y[g++]=0;var x=0;for(S=0;S<s;S++)v[f++]=x,v[f++]=x+4,v[f++]=x+1,v[f++]=x,v[f++]=x+5,v[f++]=x+4,v[f++]=x+1,v[f++]=x+3,v[f++]=x+2,v[f++]=x+1,v[f++]=x+4,v[f++]=x+3,x+=6,v[f++]=x,v[f++]=x+1,v[f++]=x+4,v[f++]=x,v[f++]=x+4,v[f++]=x+5,v[f++]=x+1,v[f++]=x+2,v[f++]=x+3,v[f++]=x+1,v[f++]=x+3,v[f++]=x+4,x+=6;var b=new h.Primitive({nbIndices:o,connectivity:h.ConnectivityTypeEnum.TRIANGLES,fillGAS:new h.FillAttributes(new h.Color(.2,.2,.2,1))}),w=new h.VertexComponent({nbVertices:a,bufferId:0,indices:new h.IndexArray({bufferId:2,offset:0})}),M=new h.VertexComponent({nbVertices:1,bufferId:1,indices:new h.IndexArray({bufferId:3,offset:0})});b.addVertexComponent(w),b.addVertexComponent(M),n.addPrimitive(b);var C=P.createMeshNode(n,e);C._setIsAlwaysInForeground(!0),this.bigGrid=C._occurrences[0].renderable,this.bigGrid.frustumCulled=!1,this.bigGrid.visibilityFree=!0,this.bigGrid.pickable=!1,this.bigGrid.receiveShadow=!0,this.bigGrid.renderDepth=0,this.sceneBackground.add(this.bigGrid)},_removeGrid:function(){var e=!1;return null!==this.grid&&(this.grid.visible=!1,e=!0),null!==this.bigGrid&&(this.bigGrid.visible=!1,e=!0),e},setAmbientLight:function(e){"number"==typeof e||"string"==typeof e?this.ambientLight.color=new t.Color(e):e&&(this.ambientLight.color=e)},_updateDirectionalLightWorldOrientation:function(e){var i=this._directionalLight,r=(null===this.internalSceneGraph||this.internalSceneGraph.getBoundingSphere().radius,null===this.internalSceneGraph?new t.Vector3(0,0,0):this.internalSceneGraph.getBoundingSphere().center,Math.sin(Math.PI*this.dirLightLatitude)*Math.cos(2*Math.PI*this.dirLightLongitude)),n=Math.sin(Math.PI*this.dirLightLatitude)*Math.sin(2*Math.PI*this.dirLightLongitude),s=Math.cos(Math.PI*this.dirLightLatitude);if(this.useDefaultLights){let a=(new t.Vector3).copy(e.frontVector).multiplyScalar(r).add((new t.Vector3).copy(e.rightVector).multiplyScalar(n)).add((new t.Vector3).copy(e.upVector).multiplyScalar(s));a.normalize(),i.setDirection(a,this.renderer.renderer.baseLightDirection)}},setDirectionalLight:function(e,i,r,n){this.renderer.resetGSSOCache(),this.autoUpdateLights=!1,this.dirLightLatitude=e,this.dirLightLongitude=i;var s=this._directionalLight;if(this._updateDirectionalLightWorldOrientation(this._worldOrientation),this.useDefaultLights){let e=r;"number"!=typeof r&&"string"!=typeof r||(e=new t.Color(r)),s.setColor(e),s.setIntensity(n)}this.renderer.resetClippingScene(),this.render()},setLightParameters:function(e){var t=[this._directionalLight,this._directionalLight2,this._directionalLight3][e.lightIndex?e.lightIndex:0];return!!t&&(this.autoUpdateLights=!1,0==e.isPhysical?t.setPhysical(!1):t.setPhysical(!0),e.color&&t.setColor(e.color),void 0!==e.intensity&&t.setIntensity(e.intensity),e.direction&&t.setDirection(e.direction,this.renderer.renderer.baseLightDirection),e.directionType&&t.attachToViewpoint("camera"===e.directionType),this.renderer.resetClippingScene(),this.render(),!0)},setAutoUpdateLights:function(e){this.renderer.resetGSSOCache(),this.autoUpdateLights=e},setLightOnViewpoint:function(e){this.renderer.resetGSSOCache(),this._directionalLight&&this._directionalLight.attachToViewpoint(e)},setToneMapping:function(e){var t=this.renderer.ToneMappingEffect;if(t){var i=!0;void 0!==e.gamma&&(t.setGamma(e.gamma),i=!1),void 0!==e.enable&&(e.enable?t.setToneMapping(i?1:2):t.setToneMapping(0))}},setAutoExposure:function(e,t){var i=this.getEffect("ToneMapping");i&&(t||(t={}),i.setAutoExposure(e,t.weightTexture,t.clampMin,t.clampMax))},setV6Ambience:function(){var e=t.AutomatedTests()&&!this.ODTMode?"V6":"None";this.setVisuEnv(e)},_removeBackgroundLight:function(){this.renderer.resetGSSOCache()},enableDefaultLights:function(e){this.useDefaultLights&&(e?(this.internalSceneGraph.addLightNode(this._directionalLight),this.internalSceneGraph.addLightNode(this._directionalLight2),this.triLights&&this.internalSceneGraph.addLightNode(this._directionalLight3)):(this.internalSceneGraph.removeLightNode(this._directionalLight),this.internalSceneGraph.removeLightNode(this._directionalLight2),this.triLights&&this.internalSceneGraph.removeLightNode(this._directionalLight3)))},_cleanAmbience:function(){this.renderer.resetGSSOCache(),this.ambience._removePhysicalGround(),this.removePlaneV2(),this.setGradientBackground(),this.removeAmbience(),this.renderer.setEffect("ToneMapping",!0);var e=this.renderer.ToneMappingEffect;e&&(this.setBloom(!1),e.setBrightness(0),e.setToneMapping(2)),this.renderer.renderer.resetInlinedPostProcess(),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setGroundShadow(!1),this.setShadowPlane(!0),this.setSSLR(!1),this.setSSLRefraction(!1),this.setAmbientLight(3158064),this.setTriLights(!1),this.enableDefaultLights(!1)},setVisuEnvOCA:function(r,n,s){var a=null,o=new G({viewer:this,v2:!0}),l=this;function h(i,r){l.renderer.renderer.__A2XMode||(e.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{slot:t.COLORMAP_INDEX.BACKGROUND,color:i,viewer:l}}}),e.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{slot:t.COLORMAP_INDEX.FOREGROUND,color:r,viewer:l}}}),l.renderer.resetGSSOCache())}o.keepIBLTexture=!1,o.keepBackgroundTexture=!1,o.isOCA=!0;l=this;var c=0,d=function(){if(--c<=0){l._cleanAmbience();var e=l.renderer.ToneMappingEffect,i=l.renderer.renderer.inlinedPostProcess;if(l.setAmbience(o),a){if(void 0!==a.backgroundColor&&l.setBackgroundColor(a.backgroundColor),a.grid&&(l.setGrid(!0),l.setGridColor(a.gridColor)),a.shadowPlane&&l.setShadowPlane(!0),a.ssao){l.setSSAO(!0);var s=l.ssaoParams;s.minPixelRadius=a.ssao.minPixelRadius,s.dynamicRadius=a.ssao.dynamicRadius,s.adaptativeRadius=a.ssao.adaptativeRadius,s.attenuation=a.ssao.attenuation,s.contrast=a.ssao.contrast,s.power=a.ssao.power,s.radius=a.ssao.radius,s.radiusMin=a.ssao.radiusMin,s.radiusMax=a.ssao.radiusMax,s.thresholdAngle=a.ssao.thresholdAngle}a.ambientLight&&l.setAmbientLight(a.ambientLight),e?(a.toneMapping&&e.setToneMapping(a.toneMapping.type,a.toneMapping.params),a.brightness&&e.setBrightness(a.brightness),a.bloom&&(l.setBloom(!0),l.getEffect("Bloom")._setBloom(a.bloom))):a.inlinedPostProcess&&(i.activated=a.inlinedPostProcess.activated,i.brightness=a.inlinedPostProcess.brightness,i.tonemapping=a.inlinedPostProcess.tonemapping,i.crushblacks=a.inlinedPostProcess.crushblacks,i.burnhighlights=a.inlinedPostProcess.burnhighlights),a.planeV2&&(l.planeV2=!0,l._requestedPlaneV2=!0,l.planeGrid||(l.planeGrid=new R(l)),l.setGroundOptions({displayPlane:!0,planeColor:a.planeV2.planeColor,planeFalloff:a.planeV2.planeFalloff,_onlyDiffuse:a.planeV2._onlyDiffuse})),a.shadow&&(l.setShadow(!0),l.setTransparentShadow(!0)),a.sslr&&l._useQM&&(l.setSSLR(!0),l.setSSLRefraction(!0))}if(l.ambience.updateAmbience(),l.render({updateInfinitePlane:!0}),l.ambience.getBackground().hasGradient()){l.showGradientBackground=[];for(var h=l.ambience.getBackground().getColors(),d=[],u=0;u<h.length;u++)l.showGradientBackground.push(new t.Color(h[u])),l.visibleSpace||d.push(h[u].desaturate(1).alphaBlend(le,.5));d.length&&l.ambience.getBackground().setColors(d)}var p=r+"OCA";p!==l.visuEnv&&(l.visuEnv=p,l._modelEvent.publish({event:"VisuEnv",data:{viewer:l,value:p}})),n&&n({ambiance:l.ambience})}},u=function(e,i,r,n){var s=2*(e/r-.5)*Math.PI,a=-((n-i)/n-1)*Math.PI;return new t.Vector3(Math.cos(s)*Math.sin(a),Math.sin(s)*Math.sin(a),Math.cos(a))};switch(r){case"Basic":h((new t.Color).setRGB(.9215686321258545,.9215686321258545,.9215686321258545),(new t.Color).setRGB(0,0,0)),this._cleanAmbience(),ue.prototype.setVisuEnv.call(this,"No"),this.useDefaultLights&&(this._directionalLight.castShadows(!1),this._directionalLight2.castShadows(!1));var p=r+"OCA";return void(p!==this.visuEnv&&(this.visuEnv=p,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:p}})));case"WhiteDesign":h((new t.Color).setRGB(.9019608497619629,.9019608497619629,.9019608497619629),(new t.Color).setRGB(0,0,0)),a={backgroundColor:15132390,grid:!0,gridColor:8355711,shadowPlane:!1},o.getBackground().setFromJson({colors:[[.980392217636108,.980392217636108,.980392217636108,1],[.921568691730499,.921568691730499,.921568691730499,1],[.901960849761963,.901960849761963,.901960849761963,1],[.901960849761963,.901960849761963,.901960849761963,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),o.generateIBLFromColor([81,81,81,128]),(S=new K({color:16777215,intensity:.628318548202515})).setDirection(new t.Vector3(0,0,1)),o.addLightNode(S),(_=new K({color:16777215,intensity:1.884955644607544})).setDirection(new t.Vector3(-.5,.5,.707107)),_.attachToViewpoint(!0),o.addLightNode(_),(f=new K({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(.683012,.183015,.707107)),f.attachToViewpoint(!0),o.addLightNode(f),(g=new K({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(-.5,.5,-.707107)),g.attachToViewpoint(!0),o.addLightNode(g);break;case"BlueDesign":h((new t.Color).setRGB(.2352941334247589,.40000003576278687,.501960813999176),(new t.Color).setRGB(1,1,1)),a={backgroundColor:3958400,grid:!0,gridColor:16777215,shadowPlane:!1},o.getBackground().setFromJson({colors:[[.39607846736908,.549019634723663,.643137276172638,1],[.243137270212173,.415686309337616,.521568655967712,1],[.235294133424759,.400000035762787,.501960813999176,1],[.235294133424759,.400000035762787,.501960813999176,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),(S=new K({color:16777215,intensity:.628318548202515})).setDirection(new t.Vector3(0,0,1)),o.addLightNode(S),(_=new K({color:16777215,intensity:1.884955644607544})).setDirection(new t.Vector3(-.5,.5,.707107)),_.attachToViewpoint(!0),o.addLightNode(_),(f=new K({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(.683012,.183015,.707107)),f.attachToViewpoint(!0),o.addLightNode(f),(g=new K({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(-.5,.5,-.707107)),g.attachToViewpoint(!0),o.addLightNode(g),o.generateIBLFromColor([81,81,81,128]);break;case"DarkDesign":h((new t.Color).setRGB(.1764705926179886,.1764705926179886,.1764705926179886),(new t.Color).setRGB(1,1,1)),a={backgroundColor:2960685,grid:!0,gridColor:8355711,shadowPlane:!1},o.getBackground().setFromJson({colors:[[.274509817361832,.274509817361832,.274509817361832,1],[.196078449487686,.196078449487686,.196078449487686,1],[.176470592617989,.176470592617989,.176470592617989,1],[.176470592617989,.176470592617989,.176470592617989,1]],horizonHeight:0,intensity:1,type:"gradientWithHorizon"}),(S=new K({color:16777215,intensity:.628318548202515})).setDirection(new t.Vector3(0,0,1)),o.addLightNode(S),(_=new K({color:16777215,intensity:1.884955644607544})).setDirection(new t.Vector3(-.5,.5,.707107)),_.attachToViewpoint(!0),o.addLightNode(_),(f=new K({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(.683012,.183015,.707107)),f.attachToViewpoint(!0),o.addLightNode(f),(g=new K({color:16777215,intensity:.942477822303772})).setDirection(new t.Vector3(-.5,.5,-.707107)),g.attachToViewpoint(!0),o.addLightNode(g),o.generateIBLFromColor([81,81,81,128]);break;case"Studio":var f,g;h((new t.Color).setRGB(.9254902601242065,.9254902601242065,.9294118285179138),(new t.Color).setRGB(0,0,0)),a={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:1.22,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0},(S=new K({color:16777215,intensity:1.572345066070557})).setDirection(new t.Vector3(0,0,1)),o.addLightNode(S),(_=new K({color:15774860,intensity:1.884955644607544})).setDirection(new t.Vector3(-.883779,-.413691,.218621)),_.attachToViewpoint(!0),o.addLightNode(_),(f=new K({color:4214874,intensity:2.04})).setDirection(new t.Vector3(.865806,-.442989,-.232682)),f.attachToViewpoint(!0),o.addLightNode(f),(g=new K({color:7895160,intensity:.9424})).setDirection(new t.Vector3(0,0,1)),g.attachToViewpoint(!0),o.addLightNode(g),c=2,o.getBackground().setFromJson({colors:[[.921568691730499,.921568691730499,.9294117,1],[1,1,1,1]],intensity:1,type:"gradient"}),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});var m={url:i.getWebappsAssetUrl("Ambiances","OCA/ambianceStudio.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);var v={url:i.getWebappsAssetUrl("Ambiances","OCA/ambianceStudio_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.792156934738159,type:"transparent"});break;case"PureWhite":var _;h((new t.Color).setRGB(.9254902601242065,.9254902601242065,.9294118285179138),(new t.Color).setRGB(0,0,0)),a={backgroundColor:15527149,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},sslr:!0},(_=new K({color:7895160,intensity:.6911})).setDirection(new t.Vector3(0,0,1)),_.attachToViewpoint(!0),o.addLightNode(_);var y=o._getEnvironmentLightMatrix(),S=new t.DirectionalPhongLight(16777215,1),x=new K({light:S});x.setDirection(u(171,416,2048,1024).applyMatrix4(y)),o.addLightNode(x);var b=new t.DirectionalPhongLight(16777215,1);(E=new K({light:b})).setDirection(u(852,416,2048,1024).applyMatrix4(y)),o.addLightNode(E);var w=new t.DirectionalPhongLight(16777215,1);(T=new K({light:w})).setDirection(u(1536,416,2048,1024).applyMatrix4(y)),o.addLightNode(T);var M=new t.DirectionalPhongLight(16777215,1);(A=new K({light:M})).setDirection(u(1024,0,2048,1024).applyMatrix4(y)),o.addLightNode(A),o.getBackground().setFromJson({colors:[[.9254,.9254,.9294,1],[1,1,1,1]],intensity:1,type:"gradient"}),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1}),c=2;m={url:i.getWebappsAssetUrl("Ambiances","OCA/pureWhite.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Ambiances","OCA/pureWhite_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"NeoPureWhite":case"WhiteExperience":h((new t.Color).setRGB(.8705883026123047,.8901961445808411,.9019608497619629),(new t.Color).setRGB(0,0,0)),a={backgroundColor:14607334,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:2.125,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.22},ambientLight:10066329,sslr:!0,planeV2:{planeColor:"#FFFFFF",planeFalloff:.25,_onlyDiffuse:1}};y=o._getEnvironmentLightMatrix(),S=new t.DirectionalPhongLight(8956671,1);(P=new K({light:S})).setDirection(u(1957,651,2048,1024).applyMatrix4(y)),o.addLightNode(P);b=new t.DirectionalPhongLight(16755336,1);(E=new K({light:b})).setDirection(u(1151,511,2048,1024).applyMatrix4(y)),o.addLightNode(E);w=new t.DirectionalPhongLight(16777215,1);(T=new K({light:w})).setDirection(u(0,215,2048,1024).applyMatrix4(y)),o.addLightNode(T);M=new t.DirectionalPhongLight(16777215,1);(A=new K({light:M})).setDirection(u(1024,215,2048,1024).applyMatrix4(y)),o.addLightNode(A),o.getBackground().setIntensity(1),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),I.setSpecularIntensity(1),I.setDiffuseIntensity(1),c=3;var C={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhiteBackground.png"),mapping:new t.LatLongEnvMapping,doneCallback:d};o.setBackGroundMap(C);m={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhite.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Ambiances","OCA/neoPureWhite_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),s&&s.from3dx?o.getBackgroundGeometry().setAutoUpdateSize(!1):o.getBackgroundGeometry().setAutoUpdateSize(!0),(O=o.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.569,type:"transparent"}),o.usePlaneV2=!0;break;case"WhiteMirror":h((new t.Color).setRGB(1,1,1),(new t.Color).setRGB(0,0,0)),a={backgroundColor:16777215,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.932,contrast:3.088,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},o.getBackground().setFromJson({colors:[[1,1,1,1],[1,1,1,1]],intensity:1,type:"gradient"}),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});y=o._getEnvironmentLightMatrix(),S=new t.DirectionalPhongLight(16777215,1);(P=new K({light:S})).setDirection(u(171,416,2048,1024).applyMatrix4(y)),o.addLightNode(P);b=new t.DirectionalPhongLight(16777215,1.5);(E=new K({light:b})).setDirection(u(852,416,2048,1024).applyMatrix4(y)),o.addLightNode(E);w=new t.DirectionalPhongLight(16777215,1);(T=new K({light:w})).setDirection(u(1536,416,2048,1024).applyMatrix4(y)),o.addLightNode(T);M=new t.DirectionalPhongLight(16777215,1.5);(A=new K({light:M})).setDirection(u(1024,0,2048,1024).applyMatrix4(y)),o.addLightNode(A),c=2;m={url:i.getWebappsAssetUrl("Ambiances","OCA/whiteMirror.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Ambiances","OCA/whiteMirror_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.300000011920929,shadowIntensity:.69803923368454,type:"transparent"});break;case"WhiteReview":h((new t.Color).setRGB(.8627451658248901,.8627451658248901,.8627451658248901),(new t.Color).setRGB(0,0,0)),a={backgroundColor:14474460,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},o.getBackground().setFromJson({colors:[[.8627,.8627,.8627,1],[1,1,1,1]],intensity:1,type:"gradient"}),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});y=o._getEnvironmentLightMatrix(),S=new t.DirectionalPhongLight(16777215,1.1);(P=new K({light:S})).setDirection(u(171,416,2048,1024).applyMatrix4(y)),o.addLightNode(P);b=new t.DirectionalPhongLight(16777215,1.25);(E=new K({light:b})).setDirection(u(852,416,2048,1024).applyMatrix4(y)),o.addLightNode(E);w=new t.DirectionalPhongLight(16777215,1.1);(T=new K({light:w})).setDirection(u(1536,416,2048,1024).applyMatrix4(y)),o.addLightNode(T);M=new t.DirectionalPhongLight(16777215,1.25);(A=new K({light:M})).setDirection(u(1024,0,2048,1024).applyMatrix4(y)),o.addLightNode(A),c=2;m={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:0,height:0,reflectivity:0,shadowIntensity:.423529446125031,type:"transparent"});break;case"DarkMirror":h((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),a={backgroundColor:1118481,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},toneMapping:{type:6,params:{crushblacks:.75,burnhighlights:.12,saturation:1}},brightness:1,bloom:{nbIterations:6,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.75,burnhighlights:.12},shadow:!0,sslr:!0},(S=new K({color:16777215,intensity:1.633628129959106})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),S.setDirection(new t.Vector3(-.588439,0,.808542)),o.addLightNode(S),(b=new K({color:16777215,intensity:1.633628129959106})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),b.setDirection(new t.Vector3(.588439,0,.808542)),o.addLightNode(b),o.getBackground().setIntensity(1),c=3;C={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};o.setBackGroundMap(C),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});m={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:.949999988079071,height:0,reflectivity:.5,shadowIntensity:0,type:"transparent"});break;case"DarkReview":h((new t.Color).setRGB(.19607844948768616,.19607844948768616,.19607844948768616),(new t.Color).setRGB(1,1,1)),c=2,a={backgroundColor:3289650,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1.032,contrast:2.5,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.31},sslr:!0},o.getBackground().setFromJson({colors:[[.196,.196,.196,1],[.3529,.3529,.3529,1]],intensity:1,type:"gradient"}),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:1});var P;y=o._getEnvironmentLightMatrix(),S=new t.DirectionalPhongLight(16777215,1);(P=new K({light:S})).setDirection(u(171,416,2048,1024).applyMatrix4(y)),o.addLightNode(P);var E;b=new t.DirectionalPhongLight(16777215,1);(E=new K({light:b})).setDirection(u(852,416,2048,1024).applyMatrix4(y)),o.addLightNode(E);var T;w=new t.DirectionalPhongLight(16777215,1);(T=new K({light:w})).setDirection(u(1536,416,2048,1024).applyMatrix4(y)),o.addLightNode(T);var A;M=new t.DirectionalPhongLight(16777215,1);(A=new K({light:M})).setDirection(u(1024,0,2048,1024).applyMatrix4(y)),o.addLightNode(A);m={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:.447058856487274,type:"transparent"});break;case"Outdoor":h((new t.Color).setRGB(.9215686917304993,.9568628072738647,1),(new t.Color).setRGB(0,0,0)),a={backgroundColor:15463679,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:1,contrast:1.8,power:1,radius:.06,radiusMin:.001,radiusMax:.1,thresholdAngle:1.31},toneMapping:{type:6,params:{crushblacks:1,burnhighlights:.01,saturation:1}},bloom:{nbIterations:5,bloomFactor:.22,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:1,burnhighlights:.01},shadow:!0,sslr:!0},(S=new K({color:16704193,intensity:18.8})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),S.setDirection(new t.Vector3(-.182353,.741268,.645963)),o.addLightNode(S),o.getBackground().setIntensity(1),c=3;C={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoor.png"),pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};o.setBackGroundMap(C),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),I.setSpecularIntensity(.6),I.setDiffuseIntensity(.5);m={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoor.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Ambiances","OCA/outdoor_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"physical",planeColor:new t.Color(16768178)});var D=o.getBackgroundGeometry();s&&s.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),O.setGroundOutDoor();break;case"Indoor":h((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1,toneMapping:{type:6,params:{crushblacks:.5,burnhighlights:.01,saturation:1}},bloom:{nbIterations:4,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1,tonemapping:6,crushblacks:.5,burnhighlights:.01},shadow:!0,sslr:!0},(S=new K({color:16777215,intensity:1.256637096405029})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),S.setDirection(new t.Vector3(0,.516689,.856173)),o.addLightNode(S),(b=new K({color:16777215,intensity:2.513274192810059})).setDirection(new t.Vector3(0,.961181,.27592)),o.addLightNode(b),(w=new K({color:16777215,intensity:1.256637096405029})).setDirection(new t.Vector3(0,-.506721,.86211)),o.addLightNode(w),o.getBackground().setIntensity(1),c=3;C={url:i.getWebappsAssetUrl("Ambiances","OCA/indoor.png"),pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};o.setBackGroundMap(C),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.600000023841858});D=o.getBackgroundGeometry();s&&!s.from3dx&&D.setAutoUpdateSize(!0),s&&s.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),D.setFromJson({shootPosition:[0,0,0]});m={url:i.getWebappsAssetUrl("Ambiances","OCA/indoor.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Ambiances","OCA/indoor_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:0,height:0,reflectivity:.400000005960464,shadowIntensity:0,type:"transparent"}),o.setAutoGroundOffset(!0),o.setGroundHeight(new t.Vector3(0,0,.2)),o.setSceneHeight(new t.Vector3(0,0,.2)),this.render({updateInfinitePlane:!0});break;case"City":h((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:1.7,toneMapping:{type:6,params:{crushblacks:.24,burnhighlights:.08,saturation:1}},bloom:{nbIterations:6,bloomFactor:.1,threshold:0},inlinedPostProcess:{activated:!0,brightness:1.7,tonemapping:6,crushblacks:.24,burnhighlights:.08},shadow:!0,sslr:!0},(S=new K({color:16777215,intensity:1.25})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),S.setDirection(new t.Vector3(.727313,-.001712,.686304)),o.addLightNode(S),o.getBackground().setIntensity(1),c=3;C={url:i.getWebappsAssetUrl("Ambiances","OCA/city.png"),pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};o.setBackGroundMap(C),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1]}),I.setSpecularIntensity(1),I.setDiffuseIntensity(.6);D=o.getBackgroundGeometry();s&&s.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),D.setFromJson({shootPosition:[0,0,.5]});m={url:i.getWebappsAssetUrl("Ambiances","OCA/city.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);v={url:i.getWebappsAssetUrl("Ambiances","OCA/city_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:0,type:"transparent"}),o.setAutoGroundOffset(!0),o.setGroundHeight(new t.Vector3(0,0,.2)),o.setSceneHeight(new t.Vector3(0,0,.2));break;case"Road":h((new t.Color).setRGB(0,0,0),(new t.Color).setRGB(1,1,1)),a={backgroundColor:13421772,ssao:{minPixelRadius:14,dynamicRadius:!0,adaptativeRadius:!0,attenuation:.984,contrast:3,power:1,radius:.04,radiusMin:.005,radiusMax:.118,thresholdAngle:1.32},brightness:.8,toneMapping:{type:6,params:{crushblacks:.2,burnhighlights:.17,saturation:1}},bloom:{nbIterations:4,bloomFactor:.058,threshold:0},inlinedPostProcess:{activated:!0,brightness:.8,tonemapping:6,crushblacks:.2,burnhighlights:.17},shadow:!0,sslr:!0},(S=new K({color:16777215,intensity:2.51})).castShadows(!0,{mapHeight:this.shadowMapHeight,mapWidth:this.shadowMapWidth}),S.setDirection(new t.Vector3(.46785,-.847623,.250302)),o.addLightNode(S),o.getBackground().setIntensity(1),c=3;var I;C={url:i.getWebappsAssetUrl("Ambiances","OCA/road.png"),pngHdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:d};o.setBackGroundMap(C),(I=o.getEnvironmentLight()).setFromJson({emissionColor:[1,1,1],emissionValue:.8});D=o.getBackgroundGeometry();s&&s.from3dx?D.setAutoUpdateSize(!1):D.setAutoUpdateSize(!0),D.setFromJson({shootPosition:[0,0,0]});m={url:i.getWebappsAssetUrl("Ambiances","OCA/road.png"),pngHdr:!0,doneCallback:d};o.setIblMap(m);var O;v={url:i.getWebappsAssetUrl("Ambiances","OCA/road_rmips.png"),pngHdr:!0,doneCallback:d,hasDiffuse:!0};o.setRoughnessMap(v),(O=o.getGround()).setFromJson({glossiness:1,height:0,reflectivity:0,shadowIntensity:1,type:"transparent"}),o.setAutoGroundOffset(!0),o.setGroundHeight(new t.Vector3(0,0,.17)),o.setSceneHeight(new t.Vector3(0,0,.43)),this.render({updateInfinitePlane:!0});break;default:return a={backgroundColor:0},o.updateAmbience(),void d()}return 0==c&&(d(),!0)},setVisuEnv:function(e){this.renderer.resetGSSOCache(),this.ambience._removePhysicalGround(),this.setGradientBackground(),this.ambience.removeLights(this),this._useDefaultAmbiancesIBL&&this.ambience.dispose(),this.removePlaneV2(),this.renderer.setEffect("ToneMapping",!0);var r=this.renderer.ToneMappingEffect;r&&(this.setBloom(!1),r.setBrightness(0),r.setToneMapping(this.renderer.tonemapping)),this.renderer.renderer.resetInlinedPostProcess();var n="SMAA",s=!0,a=null;switch(this._configAmbiences&&this._configAmbiences.effects&&(a=this._configAmbiences.effects),this.setGroundShadow(!1),e){case"None":case"No":if(this.ODTMode&&a&&!a.force){this.setGrid(!1),this.displayInfinitePlane(!1),this.setShadowPlane(!1),this.setBackgroundColor(14414586),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),s=!1;break}var o=!1,l=!1,h=!1,c=!1,d=!1,u=new t.Color,p=new t.Color,f=new t.Color;if(a){var g=a.BackgroundColor;"false"===a.AntiAliasing&&(n="NoAA"),o="false"!==a.Plane,l="false"!==a.Grid,h="false"!==a.Mirror,c="false"!==a.Shadow,d="false"!==a.SSAO,g&&(u.r=void 0!==g.red?g.red:1,u.g=void 0!==g.green?g.green:1,u.b=void 0!==g.blue?g.blue:1)}this.setGrid(l),this.displayInfinitePlane(o),this.setShadowPlane(o),this._preferenceBackgroundColor&&(u=this._preferenceBackgroundColor);var m=Math.min(Math.max(0,.2126*u.r+.7152*u.g+.0722*u.b),1)>=.5?0:1;p.r=.4*m+.6*u.r,p.g=.4*m+.6*u.g,p.b=.4*m+.6*u.b,f.r=.05*m+.95*u.r,f.g=.05*m+.95*u.g,f.b=.05*m+.95*u.b,this.renderer.renderer.__A2XMode&&(u=t._getColorMap(this.renderer.renderer)[t.COLORMAP_INDEX.BACKGROUND]),this.setBackgroundColor(u.getHex()),this.setPlaneColor(f.getHex()),this.setGridColor(p.getHex()),this.setSSAO(d);var v=this.ssaoParams;d&&(v.dynamicRadius=!0,v.adaptativeRadius=!0,v.radius=.04,v.radiusMin=.01,v.radiusMax=.12,v.minPixelRadius=14,v.attenuation=1,v.contrast=2,v.power=1,v.thresholdAngle=1.35),this.setShadow(c),this.setTransparentShadow(c),this.setMirror(h,!0),this._useDefaultAmbiancesIBL&&this.ambience.generateIBLFromColor([81,81,81,128]),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"V6":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setGridColor(13421772),this.setSSAO(!0),(v=this.ssaoParams).dynamicRadius=!0,v.adaptativeRadius=!0,v.radius=.04,v.radiusMin=.01,v.radiusMax=.12,v.minPixelRadius=14,v.attenuation=1,v.contrast=2.5,v.power=1,v.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){var _={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(_);var y={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview_rmips.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(y)}break;case"CleanSpace":if(this.setGrid(!1),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(15527148),this.setPlaneColor(16514043),this.setSSAO(!0),(v=this.ssaoParams).dynamicRadius=!0,v.adaptativeRadius=!0,v.radius=.04,v.radiusMin=.01,v.radiusMax=.12,v.minPixelRadius=14,v.attenuation=1,v.contrast=2.5,v.power=1,v.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){_={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,127]};this.ambience.setIblMap(_);y={url:i.getWebappsAssetUrl("Visualization","OCA/whiteReview_rmips.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,127],hasDiffuse:!0};this.ambience.setRoughnessMap(y)}break;case"DarkBlue":this.setGrid(!0),this.displayInfinitePlane(!1),this.setBackgroundColor(3958400),this.setGradientBackground([6728399,3958400,1848912]),this.setGridColor(8362924),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this._useDefaultAmbiancesIBL&&this.ambience.generateIBLFromColor([81,81,81,128]),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;case"DarkGrey":if(this.setGrid(!0),this.displayInfinitePlane(!0,!1),this.setBackgroundColor(3881787),this.setPlaneColor(2960685),this.setGridColor(7303023),this.setSSAO(!1),this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!1,!1),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){_={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(_);y={url:i.getWebappsAssetUrl("Visualization","OCA/darkReview_rmips.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(y)}break;case"Shiny":if(this.setGrid(!1),this.displayInfinitePlane(!0,!0),this.setBackgroundColor(1118481),this.setGradientBackground([6710886,2105376,0]),this.setPlaneColor(6710886),this.setSSAO(!0),(v=this.ssaoParams).dynamicRadius=!0,v.adaptativeRadius=!0,v.radius=.04,v.radiusMin=.01,v.radiusMax=.12,v.minPixelRadius=14,v.attenuation=1,v.contrast=2.8,v.power=1,v.thresholdAngle=1.35,this.setShadow(!0),this.setTransparentShadow(!0),this.setMirror(!0,!0),this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15}),this._useDefaultAmbiancesIBL){_={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,125]};this.ambience.setIblMap(_);y={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror_rmips.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,125],hasDiffuse:!0};this.ambience.setRoughnessMap(y)}break;case"Studio":if(this.setGrid(!1),this.displayInfinitePlane(!1),this.setBackgroundColor(15527148),this.setGradientBackground([7497556,15131615,9668981]),this.setPlaneColor(16119027),this.setSSAO(!0),(v=this.ssaoParams).dynamicRadius=!0,v.adaptativeRadius=!0,v.radius=.04,v.radiusMin=.01,v.radiusMax=.12,v.minPixelRadius=14,v.attenuation=1,v.contrast=2.5,v.power=1,v.thresholdAngle=1.35,this.setShadow(!1),this.setTransparentShadow(!1),this.setMirror(!0,!0),this._useDefaultAmbiancesIBL){_={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[0,153,153,153,126]};this.ambience.setIblMap(_);y={url:i.getWebappsAssetUrl("Visualization","OCA/darkMirror_rmips.png"),pngHdr:!0,onlyOnRequest:!0,fallbackColor:[1,153,153,153,126],hasDiffuse:!0};this.ambience.setRoughnessMap(y)}this.ambience.getEnvironmentLight().setFromJson({emissionColor:[1,1,1],emissionValue:.15});break;default:return}var S=e;S!==this.visuEnv&&(this.visuEnv=S,this._modelEvent.publish({event:"VisuEnv",data:{viewer:this,value:S}})),this.ODTMode&&this.setAntiAliasing(n),this.setTriLights(s),this.triLights?this.dirLightLatitude=.34:(this.setSecondaryLightColor(15527148),this.setDirectionalLight(.34,.16,16777215,.95*Math.PI))},getVisuEnv:function(){return this.visuEnv},onVisuEnvChange:function(e){return this._modelEvent.subscribe({event:"VisuEnv"},e)},setTriLights:function(e){if(this.useDefaultLights&&(this.enableDefaultLights(!0),e!==this.triLights)){this.triLights=e;var i=this._directionalLight,r=this._directionalLight2,n=this._directionalLight3;if(e){i&&(i.setIntensity(.49*Math.PI),i.setShadowOptions({darkness:.3}));let e=new t.Vector3(0,0,1);r&&(r.setIntensity(.49*Math.PI),r.setColor(new t.Color(16777215)),r.setDirection(e,this.renderer.renderer.baseLightDirection)),n||(this._directionalLight3=new K({color:16777215,intensity:.49*Math.PI},"defaultLight3"),n=this._directionalLight3,this.internalSceneGraph.addLightNode(n),this.internalSceneGraph&&this.internalSceneGraph.scene.add(n)),n.setDirection(e,this.renderer.renderer.baseLightDirection)}else i&&(i.setIntensity(.81*Math.PI),i.setShadowOptions({darkness:.65})),r&&(r.setIntensity(1*Math.PI),r.setColor(new t.Color(3827071)),r.setDirection(new t.Vector3(-2,1.5,2.5),this.renderer.renderer.baseLightDirection)),n&&(this.internalSceneGraph.removeLightNode(n),this._directionalLight3.dispose(),this._directionalLight3=null);this.infPlane&&this.infPlane.material&&(this.infPlane.material._firstDirOnly=e,this.infPlane.material.needsUpdate=!0)}},setLightProbe:function(e){console.warn("Light probes are deprecated and won't work on PBR materials, please use an ambiance instead, phongs are deprecated"),console.warn("setLightProbe API disabled")},showEnvMap:function(e){this.renderer.resetGSSOCache();var t=this.ambience.getBackground();t.isActivated()!==e&&(e?(t.withImage()||t.hasGradient())&&t.setActivated(e):t.setActivated(e))},setEnvMap:function(e,i,r){if(this.renderer.resetGSSOCache(),2===i){console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.");var n=this,s=0,a=2===e.length?e[0]:null,o=2===e.length?e[1]:null;a||(a=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping)),a.minFilter=t.NearestFilter,a.magFilter=t.NearestFilter,a.wrapS=t.RepeatWrapping,a.wrapT=t.RepeatWrapping,o||(o=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping)),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=function(){2===++s&&(n.internalSceneGraph.scene.envMipMap[0]=a,n.internalSceneGraph.scene.envMipMap[1]=o,he._decreaseSceneUseCount(n.internalSceneGraph.scene),n.render(),r&&r())};return a&&a.onLoadCallbacks.push(l),o&&o.onLoadCallbacks.push(l),a}null!==e?e.length||e instanceof t.Texture?(console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation."),2===e.length?(this.ambience.setBackGroundMap({texture:e[0]}),this.ambience.setRoughnessMap({texture:e[1]})):this.ambience.setBackGroundMap({texture:e})):this._setEnvMap(e):console.warn("DEPRECATED: setEnvMap() now only accepts one argument. Please refer to the documentation.")},_setSphereEnv:function(e){e&&(this.sphereEnv=e,this.sceneBackground.add(e))},_setPhysicalGround:function(e){e&&(this.ground=e,this.sceneBackground.add(e))},_setEnvMap:function(e){var i=void 0,n=0,s=0,a=function(){++s===n&&e.doneCallback&&e.doneCallback()};e.roughnessMap instanceof t.Texture?(n++,this.ambience.setRoughnessMap({texture:e.roughnessMap,doneCallback:a}),i=!0):null===e.roughnessMap&&(i=null);if(e.IBLMap){if(e.IBLMap instanceof t.Texture)n++,this.ambience.setIblMap({texture:e.IBLMap,doneCallback:a});else if(""!==e.IBLMap){var o="dds"===r.getExtension(e.IBLMap);n++,o?this.ambience.setReflectionMap({url:e.IBLMap,doneCallback:a}):this.ambience.setIblMap({url:e.IBLMap+".hdr",mapping:new t.LatLongReflectionMapping,hdr:!0,doneCallback:a}),i||o||(n++,this.ambience.setRoughnessMap({url:e.IBLMap+"_rmips.hdr",doneCallback:a}))}}else null===e.IBLMap&&(null,i=null);if(e.envMap)if(e.envMap instanceof t.Texture)n++,this.ambience.setBackGroundMap({texture:e.envMap,doneCallback:a});else if(""!==e.envMap){(o="dds"===r.getExtension(e.envMap))?(n++,this.ambience.setBackGroundMap({url:e.envMap,hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:a})):(n++,this.ambience.setBackGroundMap({url:e.envMap+".hdr",hdr:!0,mapping:new t.LatLongEnvMapping,doneCallback:a}))}},setEnvMapBlur:function(e){console.warn("Warning: setEnvMapBlur is not handled")},setEnvMapOffset:function(e){},setEnvMapExposure:function(e){this.envMapExposure=e,this.ambience.setExposure(e),this.sphereEnv&&this.sphereEnv.material&&(this.sphereEnv.material.envMapExposure=e),this.internalSceneGraph.scene.envMipMap[0]&&(this.internalSceneGraph.scene.envMipMap[0].envMapExposureSpecular=e,this.internalSceneGraph.scene.envMipMap[0].envMapExposureDiffuse=e)},addReflectionProbe:function(e,i,r,n,s){this.removeReflectionProbes();var a=this,o=t.ImageUtils.loadHDRTexture(e+".hdr",new t.LatLongReflectionMapping,s);o.onLoadCallbacks.push(function(){a.render()}),o.minFilter=t.NearestFilter,o.magFilter=t.NearestFilter,o.wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping;var l=t.ImageUtils.loadHDRTexture(e+"_rmips.hdr",new t.LatLongReflectionMapping);l.onLoadCallbacks.push(function(){a.render()}),l.minFilter=t.NearestFilter,l.magFilter=t.NearestFilter,l.wrapS=t.RepeatWrapping,l.wrapT=t.RepeatWrapping;var h={position:i,box:new t.Box3(r,n)};he._decreaseSceneUseCount(this.internalSceneGraph.scene),this.internalSceneGraph.scene.envMipMap[0]=o,this.internalSceneGraph.scene.envMipMap[1]=l,this.internalSceneGraph.scene.reflectionProbes=h},removeReflectionProbes:function(){this.internalSceneGraph.scene.reflectionProbes&&(this.internalSceneGraph.scene.reflectionProbes=null,this.internalSceneGraph.scene.envMipMap[0].dispose(),this.internalSceneGraph.scene.envMipMap[1].dispose(),this.internalSceneGraph.scene.envMipMap=[],this.ambience&&this.ambience.needUpdateIBL.has(this)&&this.ambience.needUpdateIBL.delete(this))},setEnvMapAmbient:function(e){this.sphereEnv&&this.sphereEnv.material&&this.sphereEnv.material.ambient.copyToLinear(e,this.renderer.renderer.simpleGamma)},removeEnvMap:function(){var e=!1;return this.ambience.getBackground().isActivated()&&(e=!0,this.ambience.getBackground().setActivated(!1)),null!==this.sphereEnv&&(this.sphereEnv.visible=!1),e},updateBackgroundLights:function(){for(var e=(null===this._safeInternalSceneGraph?this.temporaryEmptyScene:this._safeInternalSceneGraph.scene).__lights,t=[],i=-1,r=[],n=0;n<this.lights.length;n++){i=-1;for(var s=0;s<e.length;s++)if(this.lights[n].fgLight===e[s]){i=n;break}-1===i&&(this.sceneBackground.remove(this.lights[n].bgLight),r.push(n))}for(n=r.length-1;n>=0;n--)this.lights.splice(r[n],1);for(n=0;n<e.length;n++){var a=e[n];if(i=-1,!a.isVirtual){for(s=0;s<this.lights.length;s++)if(this.lights[s].fgLight===a){i=s;break}if(-1===i){var o=a.clone();o.castShadow=!1,this.sceneBackground.add(o),a._occurrence&&(o._occurrence=a._occurrence),t.push({fgLight:a,bgLight:o})}else{var l=this.lights[i].bgLight;a.clone(l),l.castShadow=!1}}}for(n=0;n<t.length;n++){var h=t[n];this.lights.push(h)}for(let e=0;e<this.lights.length;e++){let t=this.lights[e];t.fgLight._vptUp&&(t.bgLight._vptUp=t.fgLight._vptUp,t.bgLight._vptSight=t.fgLight._vptSight,t.bgLight._vptPosition=t.fgLight._vptPosition)}},getSceneBoundingSphere:function(e,i,r,n){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let s=r||this.internalSceneGraph;return s?(s.root._tryOverridesUpdate(this),s.getBoundingSphere(e,i,n)):i?null:new t.Sphere},getSceneBoundingBox:function(e,i){"show"===e&&(console.warn("DEPRECATED: use visibleSpace instead of show"),e="visibleSpace"),"noShow"===e&&(console.warn("DEPRECATED: use invisibleSpace instead of noShow"),e="invisibleSpace");let r=i||this.internalSceneGraph;if(!r)return new t.Box3;var n=r.root;return n._tryOverridesUpdate(this),n._occurrences[0].getBoundingBox(e)},computeSceneAccurateBoundingBox:function(e,i,r,n,s){let a=s||this.internalSceneGraph;if(!a)return new t.Box3;var o=a.root;o._tryOverridesUpdate(this),r=r||t.FixedSizeFiltering.Include,n=n||[];for(var l=0,h=0;h<n.length;h++){l|=n[h]}return o._occurrences[0].computeAccurateBoundingBox(e,i,r,l)},_updateNearFar:function(e){var i=this.trackingViewpoint?this.trackingViewpoint:e||this.currentViewpoint,r=i.camera;if(!r)return!1;var n=r.near,s=r.far,a=null===this.internalSceneGraph?new t.Sphere(new t.Vector3(0,0,0),100):this.getSceneBoundingSphere(this.visibleSpace?"visibleSpace":"invisibleSpace",null,null,!0);if(!a)return!1;var o=0;a.pixelRadius>0&&(o=r.getWorldSizeFromPixelSize(1,a.center,this._getDivClientHeight(),2)*a.pixelRadius);this._updateOffsetPlane(a,r,!1);var l=this._getPlaneSize(a,r,this.gridUnit,this.gridStep);l!==this.planeSize&&(this.planeSize=l);var h,c=(new t.Vector3).subVectors(a.center,r.position),d=(new t.Vector3).subVectors(this.offsetPlaneBackground,r.position),u=r.getLookAt(),p=c.dot(u),f=d.dot(u),g=p,m=Math.PI*Math.max(.1,.5-this.dirLightLatitude),v=Math.sin(m)+(Math.cos(m)+1)/Math.tan(m),_=this._infinitePlane||this._displayGrid;if(_)if(this.cameraBackgroundFar=Math.max(f+this.planeSize,p+a.radius),this._nearFarBigScale){var y=(new t.Sphere).copy(a);y.center.z-=a.radius;var S=new t.Sphere;a.mergeWithSphere(y,S),c.subVectors(S.center,r.position),g=c.dot(u)}else c.z-=a.radius,g=c.dot(u);if(this.cameraBackgroundNear=f-this.planeSize,this._nearFarBigScale&&(this.cameraBackgroundNear=Math.max(this.cameraBackgroundNear,.001)),this.ambience.getBackground().isActivated()&&!this._2DMode)if(this.ambience.isFiniteMode()){if(!r.isOrtho){var x=v*this.ambience.getRadiusEnvMap();this.cameraBackgroundFar=f+x;var b=Math.max(f-x,.001*this.cameraBackgroundFar);b>this.cameraBackgroundNear&&(this.cameraBackgroundNear=b)}0==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!0,this.renderer&&this.renderer.recompileAllShaders(null)),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereCenter=this.ambience.getCenter(),this.internalSceneGraph.scene.parallaxCorrectionParameters.sphereRadius=this.ambience.getRadius(),this.internalSceneGraph.scene.parallaxCorrectionParameters.projectionCenter=this.ambience.getProjectionCenter()}else 1==this.internalSceneGraph.scene.useFiniteEnvMap&&(this.internalSceneGraph.scene.useFiniteEnvMap=!1,this.renderer&&this.renderer.recompileAllShaders(null)),this.cameraBackgroundFar=Math.max(f+this.planeSize,p+a.radius);if(h=this._nearFarBigScale?v*(_?S.radius+o:a.radius+o):v*(a.radius+o),r.far=g+h,r.near=Math.max(g-h,.001*r.far),this._nearFarBigScale){var w=i.control.distanceToTarget,M=Math.max(0,g-h);r.near=w>50?Math.min(Math.max(w/50,M),r.near):Math.min(Math.max(.1,M),r.near)}return r.isOrtho?r.near=g-h:r.far<0&&(r.near=5,r.far=50),n!==r.near||s!==r.far},isShadowMap:function(){for(var e=(null===this.internalSceneGraph?this.temporaryEmptyScene:this.internalSceneGraph.scene).__lights,t=0;t<e.length;t++)if(!e[t].isVirtual&&(e[t].castShadow||e[t].castGroundShadow))return!0;return!1},dispose:function(){e.publish({event:"/VISU/VIEWER/VIEWER_DISPOSED",data:{eventChannel:"/VISU/VIEWER/VIEWER_DISPOSED",eventType:"@VIEWER_DISPOSED",parameters:{viewer:this}}}),disposedViewers.push(this.id),this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestore),this.canvas.webGLViewer=null;for(var i=0;i<this.highlightSets.length;i++)this.highlightSets[i]&&this.highlightSets[i]._detachEvents(!1,!1);this.highlightSets=[],this._oocManager&&this._oocManager._dispose(),this._oocManager=null,this._sceneGraphOverrideSetManager&&(this._sceneGraphOverrideSetManager.dispose(),this._sceneGraphOverrideSetManager=null),this.disposed=!0,this.setDefaultPicking(!1),this.infPlane&&this.infPlane.dispose(),this.infPlaneSmall&&this.infPlaneSmall.dispose(),this.grid&&this.grid.dispose(),this.ambience&&this.ambience.needUpdateIBL.delete(this),he._decreaseSceneUseCount(this.internalSceneGraph.scene),this.bigGrid&&this.bigGrid.dispose(),this.internalSceneGraph&&(this.internalSceneGraph.dispose(),this.internalSceneGraph=null,this._safeInternalSceneGraph=null),this.__selectionHL._detachEvents(!1,!1),this.__selectionHL.clearAll(),this.__selectionPreHL._detachEvents(!1,!1),this.__selectionPreHL.clearAll(),e.unsubscribe(this._requestShadowMapUpdate),e.unsubscribe(this._requestVisuUpdate),e.unsubscribe(this._updateBackgroundColor),this.requestViewPanelClose(),t.cleanPredefinedMaterialCache(),t.cleanPredefinedMaterialTextureCache(),this.sceneBackground.dispose(),this.sceneBackground=null,this.manipulatorManager&&(this.manipulatorManager._detachEvents(),this.manipulatorManager=null),he.dispose(this),ce.dispose(this),this._viewpointManager.dispose(),this._viewpointManager=null;for(i=0;i<this.viewpoints.length;i++)this.viewpoints[i].setDefaultController(!1),this.viewpoints[i]._setNode(null);if(this._mePreferencesTokens)for(let e=0;e<this._mePreferencesTokens.length;e++)$.unsubscribe(this._mePreferencesTokens[e]);this.materialManager.removeViewer(this),this.materialManager=null,this._userPassManager._dispose(),this.renderer&&this.renderer.dispose(),this.renderer=null,b.disconnectFrom(this.canvas),b._dispose(this.canvas),document.removeEventListener("contextmenu",this._contextMenu,!0),window.debugWebGLV6Viewer===this&&(window.debugWebGLV6Viewer=null),this.div&&(this.canvas&&this.div===this.canvas.parentNode&&this.div.removeChild(this.canvas),this.divCssElement&&this.div===this.divCssElement.parentNode&&this.div.removeChild(this.divCssElement),this.divTrap&&this.div===this.divTrap.parentNode&&this.div.removeChild(this.divTrap),this.svgRootNode&&this.div===this.svgRootNode.parentNode&&this.div.removeChild(this.svgRootNode)),this.canvas.webGLV6Viewer&&delete this.canvas.webGLV6Viewer,this.canvas=null,this.infPlane=null,this.infPlaneSmall=null,this.grid=null,this.bigGrid=null,this.sceneBackground=null,this.cameraBackground=null,this.ambientLight=null,this._directionalLight=null,this._directionalLight2=null,this._directionalLight3=null,this._dirLightGroundShadow=null,this.lights=[],this.currentViewpoint=null,this.viewpoints=[],this.trackingViewpoint=null,this.materialManager=null,this.cameraReflected=null,this.renderer=null,this.debugPickingNode=null,this.debugNormalNode=null,this.temporaryEmptyScene=null,this._modelEvent.destroy(),this.trapSelectionManipulator=null,X.detachViewer(this),this.clearThis(),this._refPlaneMap.clear(),this._refPlaneCounter=0},setRenderFrameCB:function(e,t){this.renderFrameCB=e,this.beginRenderFrameCB=t},getCurrentSceneGraphState:function(){return this.sceneGraphState},getSceneGraphOverrideSetManager:function(){return this._sceneGraphOverrideSetManager},hasSceneGraphOverrideSet:function(){return!!(this.sceneGraphState||this._sceneGraphOverrideSetManager&&this._sceneGraphOverrideSetManager.hasSceneGraphOverrideSet())},getUserPassManager:function(){return this._getUserPassManager()},clearScene:function(e,t){this.empty(e,t)},empty:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.clearScene(e,t,this._sceneGraph?"deprecated":void 0),e&&this.render({updateInfinitePlane:t,needReframe:t}),this.divCss2DElement.empty()},isEmpty:function(){return this._sceneGraph?0===this._sceneGraph._private_root.children.length:this.internalSceneGraph?0===this.internalSceneGraph.userRoot.children.length:void 0},setDisableBackFaceCulling:function(e){this.renderer.setDisableBackFaceCulling(e)},setCameraSystem:function(e){e!==this.cameraSystem&&(this.cameraSystem=e,this.renderer.clearCameraSystemData(),this.cameraSystemUpdated=!0,this.renderer.resetGSSOCache()),e||this.renderer.renderer.removeSplitScreenMode()},set2DMode:function(e,t,i){this._2DMode=e,this._setBackgroundColor(),this._updateGridDisplay(),this._updateInfinitePlaneDisplay(),this._updateShadowPlaneDisplay(),this._viewpointManager._set2DMode(e,t),this._updateSVGVisu(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})},get2DMode:function(){return this._2DMode},getCameraSystem:function(){return this.cameraSystem},request360Mode:function(e,t,i){let r=null===this._360ModeRequest;r&&(this._360ModeRequest={enabled:!1,params:null,tileSetAdded:!1}),this._360ModeRequest.enabled=e,this._360ModeRequest.params=t,this._360ModeRequest.tileSetAdded=void 0!==i&&i,this._viewer360Manager?(this._viewer360Manager.request360Mode(e,t,this._360ModeRequest.tileSetAdded),this._360ModeRequest.tileSetAdded=!1,this._360ModeRequest.params=null):r&&require(["DS/WebVisu360/Viewer360Manager"],e=>{this._viewer360Manager=new e(this),this._viewer360Manager.request360Mode(this._360ModeRequest.enabled,this._360ModeRequest.params,this._360ModeRequest.tileSetAdded),this._360ModeRequest.tileSetAdded=!1,this._360ModeRequest.params=null})},on360TileSetAdded:function(){this.request360Mode(this.is360ModeRequested(),this._360ModeRequest&&this._360ModeRequest.params||null,!0)},is360ModeRequested:function(){return this._360ModeRequest&&this._360ModeRequest.enabled||!1},get360Mode:function(){return!!this._viewer360Manager&&this._viewer360Manager.get360Mode()},onStart360Mode:function(e){return this._modelEvent.subscribe({event:"Start360Mode"},e)},onEnd360Mode:function(e){return this._modelEvent.subscribe({event:"End360Mode"},e)},setNavigationParams:function(e){void 0!==this._navigationParams&&(void 0!==e.clickToNavigateIn360&&(this._navigationParams.clickToNavigateIn360=e.clickToNavigateIn360),void 0!==e.reframe360CB&&(this._navigationParams.reframe360CB=e.reframe360CB))},getNavigationParams:function(){return this._navigationParams},hasVirtualProduct:function(){return!!this._oocManager&&this._oocManager.hasVirtualProduct()},onVirtualProductAdded:function(e){return this._modelEvent.subscribe({event:"VirtualProductAdded"},e)},onVirtualProductRemoved:function(e){return this._modelEvent.subscribe({event:"VirtualProductRemoved"},e)},_publish360ModeEvent:function(e){this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}}),this._modelEvent.publish({event:e?"Start360Mode":"End360Mode",data:{viewer:this}})},_updateShaders:function(){this.internalSceneGraph&&this.internalSceneGraph.updateShaders()},_addRobot:function(e,t){t.addRobotNode(e)},addDebugPoint:function(e,i,r){var n=P.createSphereNode({radius:r||3,material:new t.MeshBasicMaterial({color:i,force:!0,enableClipPlanes:!1,forceSide:!0})});n.setNoHighlightNoZ(!0);var s=P.createFixedSizeNode();s.addChild(n),this.internalSceneGraph.addDebugNode(s),s.setPickable(h.PICKTHROUGH);var a=this;function o(e){var i=new t.Matrix4;e instanceof Array&&(e={x:e[0],y:e[1],z:e[2]}),i.setPosition(e),s.setMatrix(i)}return o(e),{setPosition:function(e){o(e)},remove:function(){a.internalSceneGraph.removeDebugNode(s)},add:function(){a.internalSceneGraph.addDebugNode(s)}}},_initRenderStyle:function(){if(!this._renderStyle){var e=new U;e.setFaceMode("COLOR"),e.setMaterialMode(!!this.renderer.renderer.materialMode),e._renderMode._setMask(this.renderer.renderer.renderPointMode|this.renderer.renderer.renderFaceMode|this.renderer.renderer.renderLineMode),e._renderMode._outlineWidth=this.renderer.renderer.outlineWidth,this.setRenderStyle(e)}},setVisuShadingMode:function(t){if(t&&(this._initRenderStyle(),this.visuShadingMode.preset!==t)){switch(this.visuShadingMode.preset=null,t){case"NoShadingEdges":case"Wireframe":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Wireframe"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Shading":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingIllustration":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("Illustration"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingIllustrationTransparent":this._renderStyle.setMaterialMode(!1),this.setVisuShadingFaceMode("IllustrationTransparent"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterial":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("NoEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHalfSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesHiddenEdges"),this.setVisuShadingPointMode("WithPoints");break;case"ShadingMaterialEdgesNoSmoothEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdges"),this.setVisuShadingPointMode("NoPoints");break;case"ShadingMaterialEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setMaterialMode(!0),this.setVisuShadingFaceMode("Shaded"),this.setVisuShadingEdgeMode("WithEdgesNoSmoothEdgesHiddenEdges"),this.setVisuShadingPointMode("NoPoints");break;case"Unknown":break;default:throw"Unknown mode in setVisuShadingMode"}this.visuShadingMode.preset=t,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:t}}),e.publish({event:"/VISU/onViewModeChanged",data:{eventChannel:"/VISU/onViewModeChanged",eventType:"@onViewModeChanged",viewer:this}}),this.setRenderStyle(this._renderStyle),this.render()}},_solveVisuShadingPreset:function(){if(null===this.visuShadingMode.preset&&null!==this.visuShadingMode.face&&null!==this.visuShadingMode.edge){for(var e=this.getMaterialMode().toString(),t=oe[e]||[],i=this.visuShadingMode.face,r=se[i]||[],n=this.visuShadingMode.edge,s=ae[n]||[],a=0;a<t.length;a++)for(var o=t[a],l=0;l<r.length;l++){var h=r[l];if(h===o)for(var c=0;c<s.length;c++){var d=s[c];if(d===h)return this.visuShadingMode.preset=d,void this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:d}})}}this.visuShadingMode.preset="Unknown",this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:"Unknown"}})}},getVisuShadingMode:function(){return this.visuShadingMode.preset},onVisuShadingModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingMode"},e)},_setVisuShadingFaceMode:function(e){if(e){switch(this._initRenderStyle(),e){case"Shaded":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode(this.visuShadingMode.edge),this._setVisuShadingPointMode(this.visuShadingMode.point);break;case"Illustration":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",!0),this._renderStyle.setFaceMode("BACKGROUND"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("NoPoints");break;case"IllustrationTransparent":this._renderStyle.setRenderMode("Face",!0),this._renderStyle.setRenderMode("Outline",!0),this._renderStyle.setFaceMode("ZONLY"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("NoPoints");break;case"Wireframe":this._renderStyle.setRenderMode("Face",!1),this._renderStyle.setRenderMode("Outline",this.visuShadingMode.outline),this._renderStyle.setFaceMode("COLOR"),this._setVisuShadingEdgeMode("WithEdges"),this._setVisuShadingPointMode("WithPoints");break;default:throw"Unknown mode in setVisuShadingFaceMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingFaceMode:function(e){e&&e!==this.visuShadingMode.face&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.face=e,this._setVisuShadingFaceMode(e),this._modelEvent.publish({event:"VisuShadingFaceMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingFaceMode:function(){return this.visuShadingMode.face},onVisuShadingFaceModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingFaceMode"},e)},_setVisuOutlineMode:function(e){if(this._initRenderStyle(),this.visuShadingMode.outline!==e){if(this.visuShadingMode.outline=e,this._modelEvent.publish({event:"VisuOutlineMode",data:{viewer:this,value:e}}),"Illustration"===this.visuShadingMode.face||"IllustrationTransparent"===this.visuShadingMode.face)return;this._renderStyle.setRenderMode("Outline",e),this.setRenderStyle(this._renderStyle),this.render()}},_getVisuOutlineMode:function(){return this.visuShadingMode.outline},_onVisuOutlineModeChange:function(e){return this._modelEvent.subscribe({event:"VisuOutlineMode"},e)},_setVisuShadingPointMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithPoints":this._renderStyle.setRenderMode("BoundaryPoint",!0),this._renderStyle.setRenderMode("SharpPoint",!0),this._renderStyle.setRenderMode("SmoothPoint",!0),this._renderStyle.setRenderMode("SurfacicPoint",!0);break;case"NoPoints":this._renderStyle.setRenderMode("BoundaryPoint",!1),this._renderStyle.setRenderMode("SharpPoint",!1),this._renderStyle.setRenderMode("SmoothPoint",!1),this._renderStyle.setRenderMode("SurfacicPoint",!1);break;default:throw"Unknown mode in setVisuShadingPointMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingPointMode:function(e){e&&e!==this.visuShadingMode.point&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.point=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&"IllustrationTransparent"!==this.visuShadingMode.face&&this._setVisuShadingPointMode(e),this._modelEvent.publish({event:"VisuShadingPointMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingPointMode:function(){return this.visuShadingMode.point},onVisuShadingPointModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingPointMode"},e)},_setVisuShadingEdgeMode:function(e){if(e){switch(this._initRenderStyle(),e){case"WithEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!0);break;case"WithEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesHalfSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!0),this._renderStyle.setRenderMode("_HighCurvatureEdge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!0);break;case"NoEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!1),this._renderStyle.setRenderMode("Edge",!1),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this._renderStyle.setRenderMode("BoundaryEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"NoEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!1),this._renderStyle.setRenderMode("Edge",!1),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this._renderStyle.setRenderMode("BoundaryEdge",!1),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesNoSmoothEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this.displayHiddenEdges(0),this.displayHalVisibleSmoothEdges(!1);break;case"WithEdgesNoSmoothEdgesHiddenEdges":this._renderStyle.setRenderMode("InternalSharpEdge",!0),this._renderStyle.setRenderMode("Edge",!0),this._renderStyle.setRenderMode("BoundaryEdge",!0),this._renderStyle.setRenderMode("InternalSmoothEdge",!1),this._renderStyle.setRenderMode("_HighCurvatureEdge",!1),this.displayHiddenEdges(1),this.displayHalVisibleSmoothEdges(!1);break;default:throw"Unknown mode in setVisuShadingEdgeMode"}this.setRenderStyle(this._renderStyle),this.render()}},setVisuShadingEdgeMode:function(e){e&&e!==this.visuShadingMode.edge&&(null!==this.visuShadingMode.preset&&(this.visuShadingMode.preset=null,this._modelEvent.publish({event:"VisuShadingMode",data:{viewer:this,value:null}})),this.visuShadingMode.edge=e,"Wireframe"!==this.visuShadingMode.face&&"Illustration"!==this.visuShadingMode.face&&"IllustrationTransparent"!==this.visuShadingMode.face&&this._setVisuShadingEdgeMode(e),this._modelEvent.publish({event:"VisuShadingEdgeMode",data:{viewer:this,value:e}}),this._solveVisuShadingPreset())},getVisuShadingEdgeMode:function(){return this.visuShadingMode.edge},onVisuShadingEdgeModeChange:function(e){return this._modelEvent.subscribe({event:"VisuShadingEdgeMode"},e)},restoreVisualizationMode:function(e){var i=[],r=0,n=t.ShowAllFaces,s=t.ShowAllRenderLineMode,a=0;e&&(void 0!==e.materialMode&&null!==e.materialMode&&(r=e.materialMode),void 0!==e.renderFaceMode&&null!==e.renderFaceMode&&(n=e.renderFaceMode),void 0!==e.renderLineMode&&null!==e.renderLineMode&&(s=e.renderLineMode),void 0!==e.displayHiddenEdges&&null!==e.displayHiddenEdges&&(a=e.displayHiddenEdges));var o=localStorage.getItem("visuShadingMode");if(o)localStorage.removeItem("renderFaceMode"),localStorage.removeItem("renderLineMode"),localStorage.removeItem("displayHiddenEdges"),localStorage.removeItem("materialMode"),this.setVisuShadingMode(o),i.push("Visu"+o+"Cmd"),i.push("Visu"+o);else{if(!localStorage.getItem("materialMode")||"BACKGROUND"!==localStorage.getItem("materialMode")&&"ZONLY"!==localStorage.getItem("materialMode")){var l=localStorage.getItem("materialMode")?parseInt(localStorage.getItem("materialMode"),10):r;this.setMaterialMode(l)}else{var h=new U;h.setFaceMode(localStorage.getItem("materialMode")),this.setRenderStyle(h)}var c=localStorage.getItem("renderFaceMode")?parseInt(localStorage.getItem("renderFaceMode"),10):n,d=localStorage.getItem("renderLineMode")?parseInt(localStorage.getItem("renderLineMode"),10):s;this._setInternalRenderFaceMode(c),this._setInternalRenderLineMode(d);var u=localStorage.getItem("displayHiddenEdges")?parseInt(localStorage.getItem("displayHiddenEdges"),10):a;this.displayHiddenEdges(u)}var p=localStorage.getItem("axisState");p&&(this.setAxisFilter("true"===p),this.getAxisFilter()&&(i.push("VisuFilterAxis"),i.push("VisuFilterAxisEnableCmd")));var f=localStorage.getItem("linesState");f&&(this.setLinesFilter("true"===f),this.getLinesFilter()&&(i.push("VisuFilterLines"),i.push("VisuFilterLinesEnableCmd")));var g=localStorage.getItem("pointsState");return g&&(this.setPointsFilter("true"===g),this.getPointsFilter()&&(i.push("VisuFilterPoints"),i.push("VisuFilterPointsEnableCmd"))),this.applyRenderModeLock(),i},restoreProjectionMode:function(){var e=[];return this.currentViewpoint&&localStorage.getItem("projectionMode")&&!this._2DMode&&(this.currentViewpoint.setProjectionType(parseInt(localStorage.getItem("projectionMode"),10)),1===this.currentViewpoint.getProjectionType()?(e.push("VisuOrthographicViewCmd"),e.push("VisuOrthographicView")):(e.push("VisuPerspectiveViewCmd"),e.push("VisuPerspectiveView"))),e},restoreAmbiance:function(){var e=[],t=localStorage.getItem("visuEnv");return t?t.includes("OCA")?(e.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t)):(e.push("Visu"+t+"Env"),e.push("Visu"+t+"EnvCmd"),this.setVisuEnv(t)):this.setV6Ambience(),e},getWidgetID:function(){var e=window.widget;return void 0!==e?e.getValue("x3DAppId"):"no-app"},setRobotAndRefAxisSystemEnabled:function(e){this.internalSceneGraph.setRobotAndRefAxisSystemEnabled(e)},getRobotAndRefAxisSystemEnabled:function(){var e=this.getRobot();return e&&e._isEnabled()},setRenderPriority:function(e){return this.renderer.resetGSSOCache(),e&&this.getSectionCapping()?(console.warn("Render priority mode is not compatible with section capping"),!1):(e&&this.setOIT(!1),this._renderPriorityManager||(this._renderPriorityManager=new F(this)),this._renderPriorityManager.setEnabled(e),!0)},getRenderPriority:function(){return!(!this._renderPriorityManager||!this._renderPriorityManager.enabled)},setRenderPriorityDefaultOpacity:function(e){this.getRenderer().renderPriorityDefaultOpacity=e},forceSceneMin:function(e){this._forceSceneMin(e),this.render({updateInfinitePlane:!0})},_getDivClientWidth:function(){return(this._pageObjectData?this._pageObjectData.version<2?this.canvas.width:this.canvas.width/this.devicePixelRatio:this.div.clientWidth)||1},_getDivClientHeight:function(){return(this._pageObjectData?this._pageObjectData.version<2?this.canvas.height:this.canvas.height/this.devicePixelRatio:this.div.clientHeight)||1},_getCanvasOffsetWidth:function(){return this._pageObjectData?this.canvas.width:this.canvas.offsetWidth},_getCanvasOffsetHeight:function(){return this._pageObjectData?this.canvas.height:this.canvas.offsetHeight},_getForceRenderTargetSize:function(){return this._pageObjectData&&this._pageObjectData.forceRenderTargetSize},_forceSceneMin:function(e){this._forceSceneMinValue=e},_addClippingPlane:function(e){},_removeClippingPlane:function(e){},_addManipulator:function(e,t){this._manipulators[t]=e},_removeManipulator:function(e){delete this._manipulators[e]},_filterClippedIntersections:function(e){var t,i,r=[],n=this.getRenderer();n.clipPlanesEnabled&&(t=new L(n.clipPlanes));var s,a=0;for(a=0;a<e.length;a++)(i=(s=e[a]).object&&(t||s.object._occurrence.clippingContext))&&s.point&&!i.isPointVisible(s.point)||r.push(s);return r},setIdPathMatcher:function(e){this.idPathMatcher=e},setImmersiveFrame:function(e){this._immFrame=e},getFreeZone:function(){var e=this._pageObjectData?this._pageObjectData.getFreeZone():null;return e||this._immFrame&&this._immFrame.getFreeZone()},getIdPathMatcher:function(){return this.idPathMatcher},_deprecated_useBackfaceCullingWithNoCapping:function(e){this.renderer.renderer.useBackfaceCullingWithNoCapping=e},useCustomCappingForClipPolyline:function(e){this.renderer.renderer.useCustomCappingForClipPolyline=!!e},_setPageObjectData:function(e){this._pageObjectData=e},_dbgQuickHighlight:function(e){if(e){var t=new a([e]);y.add({pathElement:t})}else y.empty()},_getScenegraphs:function(){let e=this._viewpointManager.getAuxiliaryScenegraphs();return this._safeInternalSceneGraph&&e.push(this._safeInternalSceneGraph),e},_requestClippingUpdate:function(){let e=this._getScenegraphs();for(let t=0;t<e.length;t++)e[t]._needClippingUpdate=!0;this._updateShadowMaps()},_getUserPassManager:function(){return this._userPassManager},_setOOCManager:function(e){this._oocManager=e},_getOOCManager:function(){return this._oocManager},_setInternalRenderFaceMode:function(e){this.renderer.renderer.renderFaceMode=e},_getInternalRenderFaceMode:function(){return this.renderer.renderer.renderFaceMode},_setInternalRenderLineMode:function(e){this.renderer.renderer.renderLineMode=e},_getInternalRenderLineMode:function(){return this.renderer.renderer.renderLineMode},_DEPRECATED_setRenderFooMode:function(e){console.warn("[WebGLViewer] Deprecated setRenderLineMode/setRenderFaceMode method.\nUse setRenderMode() instead\n"+e.stack)},_remoteRenderInfos:{eventToken:null,div:null,cvs:null,img:null,tex:null,useDiv:!1,videoRender:!1,videoElements:null},enableRemoteRender:function(e){this.renderer.setEffect("xRevealStructure",e)},setupRemoteRender:function(e){var t=this;if(this._remoteRenderInfos.eventToken&&(t.unsubscribe(t._remoteRenderInfos.eventToken),!e&&t._remoteRenderInfos.div&&t._remoteRenderInfos.div.destroy()),t._remoteRenderInfos.videoRender=!1,!e){let e=this.getEffect("xRevealStructure");if(e&&e.clearTextures(),t.renderer.setEffect("xRevealStructure",!1),this._remoteRenderInfos.videoElements){for(let[e,t]of this._remoteRenderInfos.videoElements)t&&t.dispose();this._remoteRenderInfos.videoElements=null}return}let i="function"!=typeof e;if(t._remoteRenderInfos.useDiv&&!t._remoteRenderInfos.div){t._remoteRenderInfos.div=UWA.createElement("div"),t._remoteRenderInfos.div.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"});let e=UWA.createElement("img"),i=UWA.createElement("canvas");i.setStyles({width:"100%",height:"100%",overflow:"hidden",display:null,position:"absolute",pointerEvents:"none"}),t.div.insertBefore(t._remoteRenderInfos.div,t.div.firstChild),t._remoteRenderInfos.div.append(e),t._remoteRenderInfos.div.append(i),t._remoteRenderInfos.img=e,t._remoteRenderInfos.cvs=i}if(t._remoteRenderInfos.useDiv||this.getEffect("xRevealStructure")||this.renderer.initEffect("xRevealStructure"),t.renderer.setEffect("xRevealStructure",!0),this.getEffect("xRevealStructure").setPosition(i?1:2),!i){t._remoteRenderInfos.eventToken=t.onPreRender(function(){var i=e(t.currentViewpoint,[t.SCREEN_WIDTH,t.SCREEN_HEIGHT]);i&&i.then(t._onRemoteImageReceived).catch(()=>{})})}},setRemoteVideo:function(e,i,r){let n=this.getEffect("xRevealStructure").getTexture(i);if(n&&n.image==e)return;let s=null;e&&(s=new t.ImageUtils.loadVideoTexture(e,null,r));if(this._remoteRenderInfos.videoRender=!0,this._remoteRenderInfos.videoElements||(this._remoteRenderInfos.videoElements=new Map),this._remoteRenderInfos.videoElements.has(i)){let e=this._remoteRenderInfos.videoElements.get(i);e&&e.dispose()}this._remoteRenderInfos.videoElements.set(i,s),this.getEffect("xRevealStructure").updateTexture(s,i)},_onRemoteImageReceived:function(e,i){let r=this;if(e.data)if(r._remoteRenderInfos.useDiv){if("blob"==e.format||"arrayBuffer"==e.format||"url"==e.format)URL.revokeObjectURL(r._remoteRenderInfos.img.src),"blob"==e.format?r._remoteRenderInfos.img.src=URL.createObjectURL(e.data):"arrayBuffer"==e.format?r._remoteRenderInfos.img.src=URL.createObjectURL(new Blob([e.data])):"url"==e.format&&(r._remoteRenderInfos.img.src=e.data),r._remoteRenderInfos.img.width=r.SCREEN_WIDTH,r._remoteRenderInfos.img.height=r.SCREEN_HEIGHT,r._remoteRenderInfos.cvs.width=0,r._remoteRenderInfos.cvs.height=0;else if("uint8Array"==e.format){r._remoteRenderInfos.img.width=0,r._remoteRenderInfos.img.height=0,r._remoteRenderInfos.cvs.width=e.width,r._remoteRenderInfos.cvs.height=e.height;var n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);r._remoteRenderInfos.cvs.getContext("2d").putImageData(n,0,0)}}else{var s=null,a=!0;"uint8Array"==e.format?((s=new t.DataTexture(e.data,e.width,e.height,t.RGBAFormat,t.UnsignedByteType)).flipY=!1,s.needsUpdate=!0,a=!1):"blob"==e.format?s=new t.ImageUtils.loadTexture(URL.createObjectURL(e.data)):"arrayBuffer"==e.format?s=new t.ImageUtils.loadTexture(URL.createObjectURL(new Blob([e.data]))):"url"==e.format&&(s=new t.ImageUtils.loadTexture(e.data)),a?s.onLoadCallbacks.push(function(e){r._remoteRenderInfos.tex&&r._remoteRenderInfos.tex.dispose(),r._remoteRenderInfos.tex=e,r.getEffect("xRevealStructure").updateTexture(e,i)}):(r._remoteRenderInfos.tex&&r._remoteRenderInfos.tex.dispose(),r._remoteRenderInfos.tex=s,r.getEffect("xRevealStructure").updateTexture(s,i)),r.render()}},getLightInfos:function(e){let i=(e&&e._internalSceneGraph?e._internalSceneGraph:this.internalSceneGraph).scene.__lights,r={totalCount:0,directionalLights:{totalCount:0,shadowing:0,hidden:0},spotLights:{totalCount:0,shadowing:0,hidden:0},pointLights:{totalCount:0,shadowing:0,hidden:0},rectangleLights:{totalCount:0,hidden:0},tubeLights:{totalCount:0,hidden:0},diskLights:{totalCount:0,hidden:0},sphereLights:{totalCount:0,hidden:0},iesLights:{totalCount:0,hidden:0},ambientLights:{totalCount:0,hidden:0},shadowing:0,hidden:0};for(let e=0;e<i.length;e++){let n=i[e],s=r.otherLights;n instanceof t.DirectionalLight?s=r.directionalLights:n instanceof t.DirectionalIBLLight?s=r.directionalLights:n instanceof t.DirectionalPhongLight?s=r.directionalLights:n instanceof t.SpotLight?s=r.spotLights:n instanceof t.PointLight?s=r.pointLights:n instanceof t.RectangleLight?s=r.rectangleLights:n instanceof t.TubeLight?s=r.tubeLights:n instanceof t.DiskLight?s=r.diskLights:n instanceof t.SphereLight?s=r.sphereLights:n instanceof t.IESLight?s=r.iesLights:n instanceof t.AmbientLight&&(s=r.ambientLights),r.totalCount++,s.totalCount++,n.isVirtual?(r.hidden++,s.hidden++):(0==n.intensity&&(r.hidden++,s.hidden++),(n.castShadow||n.castGroundShadow)&&(r.shadowing++,s.shadowing++))}return r}});return Object.defineProperty(ue.prototype,"backgroundColor",{get:function(){return this.__tempBackgroundColorODT}}),Object.defineProperty(ue.prototype,"sceneGraph",{get:function(){return n.DEPRECATED_SceneGraph(new Error,!0),this.getRootNode()}}),Object.defineProperty(ue.prototype,"directionalLight",{get:function(){return console.warn("deprecated property : directionalLight"),this._directionalLight&&this._directionalLight._occurrences[0].renderable},set:function(e){console.warn("deprecated property"),this._directionalLight=e}}),Object.defineProperty(ue.prototype,"directionalLight2",{get:function(){return console.warn("deprecated property : directionalLight2"),this._directionalLight2&&this._directionalLight2._occurrences[0].renderable},set:function(e){console.warn("deprecated property"),this._directionalLight2=e}}),Object.defineProperty(ue.prototype,"directionalLight3",{get:function(){return console.warn("deprecated property : directionalLight3"),this._directionalLight3&&this._directionalLight3._occurrences[0].renderable},set:function(e){console.warn("deprecated property"),this._directionalLight3=e}}),UWA.namespace("THREEDS/WebGLViewer",ue)}),define("DS/Visualization/WebGLV6Viewer",["DS/Visualization/WebGLViewer","DS/Robot/Robot","DS/Robot/ReferenceAxisSystemNode","DS/Robot/CustomReferenceAxisSystem","DS/Visualization/InternalSceneGraph","DS/SceneGraphOverrides/SceneGraphState","DS/SceneGraphOverrides/SceneGraphOverrideSetManager","DS/Visualization/OccurrenceRenderingOverride","DS/SceneGraphOverrides/OverrideLink2","DS/QualityManager/QMController","DS/QualityManager/QMScoreHandler","DS/QualityManager/QMViewerMixins","DS/Visualization/ThreeJS_DS","DS/ViewPanel/ViewPanelController","DS/WAFData/WAFData","DS/Visualization/Node3D","DS/SceneGraphOverrides/IdPathOverrideWatcherTree","DS/Visualization/Filters/MaterialToUseFilter","DS/Visualization/Viewpoint","DS/VisuMePreferences/MePreferences"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y){g.SceneGraphOverrideSetManager=a;var S=e.extend({init:function(e){if(this._useQM=!1,this._QMInit=!1,this._QMModif=!1,this._useViewPanel=!1,this._viewPanelInit=!1,this._QMSettings={AntiAliasing:{modified:!1,value:{static:"SMAA",dynamic:"SMAA"}},AllowOutline:{modified:!1,value:{static:!0,dynamic:!0}},PixelCulling:{modified:!1,value:{static:4.5,dynamic:4.5}},LOD:{modified:!1,value:{static:.5,dynamic:3}},Transparency:{modified:!1,value:{static:"AlphaBlending",dynamic:"AlphaBlending"}},AllowGroundShadows:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowInterObjectShadows:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowTransparentObjectShadows:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},ShadowQuality:{modified:!1,value:{static:"Medium",dynamic:"Medium"}},ShadowFilter:{modified:!1,value:{static:"PCFOptimized",dynamic:"PCFOptimized"}},FlakesQuality:{modified:!1,value:{static:"Ultra",dynamic:"Ultra"}},DefaultMaterialQuality:{modified:!1,value:{static:!1,dynamic:!1}},Downsampling:{modified:!1,value:{static:1,dynamic:1}},AllowGroundReflection:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowInterObjectReflections:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},AllowInterObjectRefractions:{modified:!1,value:{static:!1,dynamic:!1,override:!0}},AllowSSAO:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},NoOfSamples:{modified:!1,value:{static:16,dynamic:16}},AllowBloom:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},AllowDepthOfField:{modified:!1,value:{static:!0,dynamic:!0,override:!0}},DepthFlickeringReduction:{modified:!1,value:{static:!1,dynamic:!1}}},!h.isInitialized){var t=e.qualityManagerProfile?e.qualityManagerProfile:"true"===localStorage.getItem("__WEBVISU_SWYM_PROFILES__")?"SWYM":"Default";"SWYM"!==t&&"Default"!==t&&(console.error("Unknown QM profile "+t+". Switching back to Default."),t="true"===localStorage.getItem("__WEBVISU_SWYM_PROFILES__")?"SWYM":"Default"),h.init("QualityPresets",t),h.initPresetDB()}void 0!==e.useQualityManager&&e.useQualityManager&&(h.linkToViewer(this),this._useQM=!0),void 0!==e.useViewPanel&&e.useViewPanel&&(this._useViewPanel=!0),this._parent(e),this._initialized=!1,this._sceneGraphOverrideSetManager=new a({viewer:this}),this._idPathOverrideWatcher=null,this._viewPanelController=null;const i=this;c.handleViewer(i,e,()=>!h.computeDefaultPreset(i)&&(i.renderer._needsPerformanceCheck=!0,!0))},_initVisualization:function(e){this._initialized||(this._initialized=!0,e.lockQMSettings&&this.lockQMSettings(e.lockQMSettings),void 0!==e.useQualityManager&&e.useQualityManager&&this._initQMSettings(),void 0!==e.useViewPanel&&e.useViewPanel&&(this._viewPanelController=new p(this,e.viewPanelConfig),this._initViewPanelSettings(),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}})),this.renderer._needPerformanceSuite()&&(this.renderer._needsPerformanceCheck=!1,this.render()),this._configAmbiences&&this._configAmbiences.effects&&void 0!==this._configAmbiences.effects.OIT&&this.setOIT(this._configAmbiences.effects.OIT))},_initViewPanelSettings:function(){!this._viewPanelInit&&this._useViewPanel&&(this._viewPanelInit=!0,this._viewPanelController.init(),this._modelEvent.publish({event:"ViewPanelSettingsInitialized",data:{viewer:this}}))},restoreViewPanelSettings:function(){if(this._useViewPanel)if(this._viewPanelInit)this._viewPanelController.restore();else{var e=this;this._modelEvent.subscribe({event:"ViewPanelSettingsInitialized"},function(){e.unsubscribe(token),e.restoreViewPanelSettings()})}},dumpViewPanelSettings:function(){return this._useViewPanel?p.dumpSettings(this):null},applyViewPanelSettings:function(e){if(this._useViewPanel)if(this._viewPanelInit)this._viewPanelController.apply(e);else{var t=this;this._modelEvent.subscribe({event:"ViewPanelSettingsInitialized"},function(){t.unsubscribe(token),t.applyViewPanelSettings(e)})}},restoreVisualizationMode:function(t){return this._useViewPanel?[]:e.prototype.restoreVisualizationMode.call(this,t)},restoreProjectionMode:function(){return this._useViewPanel?[]:e.prototype.restoreProjectionMode.call(this)},restoreAmbiance:function(){if(this._useViewPanel)return[];var t=localStorage.getItem("visuEnv");if(!t&&this._useQM&&!u.AutomatedTests()){var i=[];return t="WhiteExperienceOCA",i.push("Visu"+t+"Cmd"),t=t.replace("OCA",""),this.setVisuEnvOCA(t),i}return e.prototype.restoreAmbiance.call(this)},setV6Ambience:function(){if(!this._useViewPanel)return e.prototype.setV6Ambience.call(this)},updateViewPanelUIConfiguration:function(e){if(this._useViewPanel)if(this._viewPanelInit)this._viewPanelController._updateViewPanelUIConfiguration(e),this._modelEvent.publish({event:"RequestViewPanelReconstruction",data:{viewer:this}});else{var t=this;this._modelEvent.subscribe({event:"ViewPanelSettingsInitialized"},function(){t.unsubscribe(token),t.updateViewPanelUIConfiguration(e)})}},_onRequestViewPanelReconstruction:function(e){return this._modelEvent.subscribe({event:"RequestViewPanelReconstruction"},e)},setPlanesFilter:function(e){var t=this.planesFilterStatus!==e;if(u.__NoShowForAxisAndPlanesBags()){var i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("RefPlanes");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}}t&&(this.planesFilterStatus=e,this.addRenderModeLock("InfiniteFace",e),this._modelEvent.publish({event:"RefPlaneFilterMode",data:{viewer:this,state:this.planesFilterStatus}})),this.render()},setAxisOnlyFilter:function(e){var t=this.axisFilterStatus!==e;if(u.__NoShowForAxisAndPlanesBags()){var i=this.getBagNode?this.getBagNode():this.getRootNode?this.getRootNode():null;if(i){var r=i.getChildrenByName("AxisSystems");r&&r.length>0&&r.forEach(function(t){t.setVisibility(e),t.setVisibilityFree(!e)})}}t&&(this.axisFilterStatus=e,this.addRenderModeLock("AxisSystem",e),this._modelEvent.publish({event:"AxisFilterMode",data:{viewer:this,state:this.axisFilterStatus}})),this.render()},setAxisAndPlanesFilter:function(e){this.setPlanesFilter(e),this.setAxisOnlyFilter(e)},lockQMSettings:function(e){this._useQM?this._viewerEffectSettings._lockSettings(e):console.warn("Lock QM Settings: Quality Manager not in use")},setQMGlobalProfile:function(e,t){if("Low"===e||"Medium"===e||"High"===e||"Ultra"===e||"Default"===e||"Custom"===e)if("Static"===t||"Dynamic"===t||null==t)if(this._useQM)if(this._QMInit)t?h.setGlobalPreset(t,e,!1):(h.setGlobalPreset("Static",e,!1),h.setGlobalPreset("Dynamic",e,!1)),h.commitToDB(),this.render();else{var i,r=this;i=this._modelEvent.subscribe({event:"QMSettingsInitialized"},function(){r.unsubscribe(i),r.setQMGlobalProfile(e,t)})}else console.warn("Quality Manager not currently in use");else console.warn(t+" unknown mode");else console.warn(e+" unknown preset")},getQMGlobalProfile:function(e){var t=this;return e=e||"Static",new Promise(function(i,r){var n;"Static"===e||"Dynamic"===e?t._useQM?t._QMInit?i(h.getCurrentGlobalPreset(e)):n=this._modelEvent.subscribe({event:"QMSettingsInitialized"},function(){t.unsubscribe(n),i(h.getCurrentGlobalPreset(e))}):r("Quality Manager not currently in use"):r(e+" unknown mode")})},onQMGlobalProfileChange:function(e){return this._modelEvent.subscribe({event:"QMGlobalProfileUpdated"},e)},getQMDefaultProfileEquivalent:function(){var e=this;return new Promise(function(t,i){var r;e._useQM?e._QMInit?t(h.defaultPreset):r=this._modelEvent.subscribe({event:"QMSettingsInitialized"},function(){e.unsubscribe(r),t(h.defaultPreset)}):i("Quality Manager not currently in use")})},getQMCouldBeLowEndHardware:function(){var e=this;return new Promise(function(t,i){var r;e._useQM?e._QMInit?t(h.unknownOrVeryLowGPU):r=this._modelEvent.subscribe({event:"QMSettingsInitialized"},function(){e.unsubscribe(r),t(h.unknownOrVeryLowGPU)}):i("Quality Manager not currently in use")})},_initQMSettings:function(){if(!this._QMInit&&(this._QMInit=!0,!this.ODTMode)){var e=this,t=function(t,i){var r=h.getCurrentGlobalPreset(t),n=h.getPresetValue(t,r);if(n){var s={AntiAliasing:n.AntiAliasing.IterativeAntiAliasing?"MSAA":n.AntiAliasing.AntiAliasing,PixelCulling:n.PixelCulling.PixelCulling,LOD:n.LOD.LOD,Transparency:n.Transparency.Transparency,AllowGroundShadows:n.Shadows.AllowGroundShadows,AllowInterObjectShadows:n.Shadows.AllowInterObjectShadows,AllowTransparentObjectShadows:n.Shadows.AllowTransparentObjectShadows,ShadowQuality:n.Shadows.ShadowQuality,ShadowFilter:n.Shadows.ShadowFilter,AllowGroundReflection:n.Reflections.AllowGroundReflection,AllowSSAO:n.AmbientOcclusion.AllowSSAO};void 0!==n.AmbientOcclusion.NoOfSamples&&(s.NoOfSamples=n.AmbientOcclusion.NoOfSamples),void 0!==n.DepthBufferOptions&&(s.DepthFlickeringReduction=n.DepthBufferOptions.DepthFlickeringReduction),void 0!==n.Reflections.AllowInterObjectReflections&&(s.AllowInterObjectReflections=n.Reflections.AllowInterObjectReflections),n.Refractions&&void 0!==n.Refractions.AllowInterObjectRefractions&&(s.AllowInterObjectRefractions=n.Refractions.AllowInterObjectRefractions),void 0!==n.Material&&(s.DefaultMaterialQuality=n.Material.DefaultMaterialQuality,s.FlakesQuality=n.Material.FlakesQuality),void 0!==n.Downsampling&&(s.Downsampling=n.Downsampling.Downsampling),e._setQMSettings(s,i)}};t("Static","static"),t("Dynamic","dynamic"),this._modelEvent.publish({event:"QMSettingsInitialized",data:{viewer:this}})}},_runPerformanceCheck:function(e){if(e._performanceViewer)return;const t=this;if(!c._locked()){c._lock();const e=document.createElement("div");e.style.width="2px",e.style.height="2px",e.style.position="absolute",document.body.appendChild(e);var i=new S({useQualityManager:!1,div:e,hdr:!1,antiAliasing:!1,_performanceViewer:!0});i.getRootNode()&&i.getRootNode().setVisuFilters({_materialToUseFilter:new v(u.MaterialToUse.totalMaterial)});var r=new _(i);i.addViewpoint(r),c._doPerformanceCheck(i,()=>{var t;t=i.onPostRender(()=>{c._unlock(),i.unsubscribe(t),i.dispose(),document.body.removeChild(e)})})}let n;n=c.onUnlock(function(){c.unsubscribe(n),h.computeDefaultPreset(t)?(t._initVisualization(e),t.render()):t._runPerformanceCheck(e)}),t.render()},setRobot:function(e,t){this.internalSceneGraph&&this.internalSceneGraph.setRobot(e,t,this)&&this.render()},getRobot:function(){return this.internalSceneGraph?this.internalSceneGraph.getRobot():null},setCustomReferenceAxisSystem:function(e){this.internalSceneGraph&&(this.internalSceneGraph.setCustomReferenceAxisSystem(e),this.render())},getCustomReferenceAxisSystem:function(){return this.internalSceneGraph&&this.internalSceneGraph._customReferenceAxisSystem},setReferenceAxisSystem:function(e){this.internalSceneGraph.showReferenceAxisSystem(e,void 0)},getReferenceAxisSystemNode:function(){return this.internalSceneGraph&&this.internalSceneGraph.referenceAxisSystemNode},createSceneGraphState:function(){if(this._sceneGraphStateVersion&&1!==this._sceneGraphStateVersion)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),this.getRootNode())return new s(this,this.getRootNode())},setCurrentSceneGraphState:function(e){if(this._sceneGraphStateMode&&1!==this._sceneGraphStateVersio)throw console.warn("Cannot use both v1 and v2 sceneGraphStates"),Error();if(this._sceneGraphStateVersion||(this._sceneGraphStateVersion=1),e instanceof s||this.sceneGraphState instanceof s&&!e){var t=this.getRootNode();(!e||e.viewer===this&&e.sceneGraph===t)&&e!==this.sceneGraphState&&(this.sceneGraphState&&this.sceneGraphState.onDeactivation(t),e&&e.onActivation(t),this.sceneGraphState=e,this.internalSceneGraph.root._occurrences[0].requestOverridesUpdate())}},setVisuEnv:function(e){this._useViewPanel&&"None"!==e&&"No"!==e?console.warn("Warning: deprecated API usage, please use setVisuEnvOCA instead. API disabled."):this._parent(e)},setVisuEnvOCA:function(e,t){return this._parent(e,t)},_setQMSettings:function(e,t){if(this._QMInit){this._QMModif=!0,"static"!==(t=t.toLowerCase())&&"dynamic"!==t&&(t="static"),this.renderer&&this.renderer.recompileAllShaders([u.RendererMode[t]]);var i=e.AntiAliasing;if(void 0!==i&&("Iterative"===i&&(i="MSAA"),this.setAntiAliasing(i,t)),void 0!==e.PixelCulling&&this.setPixelCulling(e.PixelCulling,t),void 0!==e.LOD&&this.setLOD(e.LOD,t),void 0!==e.Transparency&&(this._QMSettings.Transparency.modified||this.setOIT("WeightedAverage"===e.Transparency,t)),void 0!==e.FlakesQuality&&(this._QMSettings.FlakesQuality.modified||this.setFlakesQuality(e.FlakesQuality,t)),void 0!==e.DefaultMaterialQuality&&(this._QMSettings.DefaultMaterialQuality.modified||"dynamic"!==t&&this.setDefaultMaterialQuality(e.DefaultMaterialQuality)),void 0!==e.Downsampling&&(this._QMSettings.Downsampling.modified||"dynamic"!==t&&this.setDownsamplingFactor(e.Downsampling)),void 0!==e.AllowGroundShadows&&(this._QMSettings.AllowGroundShadows.modified||this.setAllowGroundShadow(e.AllowGroundShadows,t)),void 0!==e.AllowInterObjectShadows&&(this._QMSettings.AllowInterObjectShadows.modified||this.setAllowShadow(e.AllowInterObjectShadows,t)),void 0!==e.AllowTransparentObjectShadows&&(this._QMSettings.AllowTransparentObjectShadows.modified||this.setAllowTransparentShadow(e.AllowTransparentObjectShadows,t)),void 0!==e.ShadowQuality&&(this._QMSettings.ShadowQuality.modified||this.setShadowQuality(e.ShadowQuality,t)),void 0!==e.ShadowFilter&&!this._QMSettings.ShadowFilter.modified){var r="PCF"===e.ShadowFilter?"PCFOptimized":e.ShadowFilter;this.setShadowFilter(r,t)}if(void 0!==e.AllowGroundReflection&&(this._QMSettings.AllowGroundReflection.modified||this.setAllowMirror(e.AllowGroundReflection,t)),void 0!==e.AllowInterObjectReflections&&(this._QMSettings.AllowInterObjectReflections.modified||this.setAllowSSLR(e.AllowInterObjectReflections,t)),void 0!==e.AllowInterObjectRefractions&&(this._QMSettings.AllowInterObjectRefractions.modified||this.setAllowSSLRefraction(e.AllowInterObjectRefractions,t)),void 0!==e.NoOfSamples&&!this._QMSettings.NoOfSamples.modified){var n=parseInt(e.NoOfSamples);0===n?(this.setAllowSSAO(!1,t),this._QMSettings.NoOfSamples.value[t]=0):(this.setAllowSSAO(!0,t),this.setSSAOParameters({nbOfSamples:n},t))}void 0!==e.DepthFlickeringReduction&&(this._QMSettings.DepthFlickeringReduction.modified||this.enableZPrePass(e.DepthFlickeringReduction,t)),this._QMModif=!1,this.render()}},_getQMSetting:function(e){var t=this._QMSettings[e];return"IterativeAntiAliasing"===e?{modified:(t=this._QMSettings.AntiAliasing).modified,staticValue:"MSAA"===t.value.static,dynamicValue:!1}:t?{modified:t.modified,staticValue:t.value.static,dynamicValue:t.value.dynamic}:null},getQMSetting:function(e){return this._getQMSetting(e)},onQMSettingModified:function(e){return this._modelEvent.subscribe({event:"QMSettingModified"},e)},_isControlPanelActivated:!0,displayIntroductoryControlPreferencePanel:function(){if(this._isControlPanelActivated&&window.widget&&window.widget.getValue("x3dPlatformId")){let e=this,t=function(t,i,r){i||r||require(["DS/SWXCoreManipulation/xAppControlPreferencesPanel"],function(e){(new e).show().then(function(e){if(-1!=e){var t=0==e?"3DEXPERIENCE":1==e?"CATIA":"SOLIDWORKS";y.setPreference(y.PREFERENCES.NAVIGATIONMODE,t)}})}),y.unsubscribe(e._mePreferenceToken),e._mePreferenceToken=null};this._mePreferenceToken=y.subscribe(y.PREFERENCES.NAVIGATIONMODE,t)}},_getIdPathOverrideWatcher:function(){return!this._idPathOverrideWatcher&&this.idPathMatcher&&(this._idPathOverrideWatcher=new m({viewer:this})),this._idPathOverrideWatcher},dispose:function(){this._viewPanelInit&&this._viewPanelController.dispose(),h.dispose(this),this._parent()}});return Object.assign(S.prototype,d),n.setRobotClasses(t,i,r),o.setOverrideLink2Class(l),UWA.namespace("THREEDS/WebGLV6Viewer",S)}),define("Visualization/WebGLV6Viewer",["DS/Visualization/WebGLV6Viewer","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/WebGLV6Viewer"),e}),define("DS/Visualization/CSIViewer",["DS/Visualization/WebGLV6Viewer","DS/Visualization/ViewManager","DS/SceneGraphOverrides/CSIOverrideManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Filters/ZModeFilter"],function(e,t,i,r,n){"use strict";var s=e.extend({init:function(e){return localStorage.setItem("__WEBVISU_PDSFX_UV_CHECK__",!1),e=e||{},window.newMaterialInheritance=!0,e.GASFaceMaterialsAsPBR=!0,e.visuFaceMaterialsAsPBR=!0,this._parent(e),this.viewManager=new t(this),this._csiViewModelManager=e&&e.CSIViewModelManager?e.CSIViewModelManager:null,this._csiOverrideManager=new i(this),this._scissorOutlineNodes=null,this._onMissingStaticLookCB=null,this.renderer.renderer.__A2XMode=!!e.isA2X,this},setCSIViewModelManager:function(e){this._csiViewModelManager=e},setOnMissingStaticLookCB:function(e){this._onMissingStaticLookCB=e},swapVisibleSpace:function(){if(e.prototype.swapVisibleSpace.call(this),!this.visibleSpace&&this._csiViewModelManager){var t=this;this._csiViewModelManager.forceSend3DNoShowData({onAnswer:function(){t.render()}})}},forceZDisplay:function(e){e&&!this.renderer.renderer._GlobalZModeFilter?(this.renderer.renderer._GlobalZModeFilter=new n(!0),this.renderer.resetGSSOCache()):!e&&this.renderer.renderer._GlobalZModeFilter&&(this.renderer.renderer._GlobalZModeFilter=null,this.renderer.resetGSSOCache())},onVisuAnswer:function(e){return this.viewManager.onVisuAnswer(e)},setStaticMaterial:function(e,t){console.warn("setStaticMaterial method is deprecated. Use setStaticLook instead."),this.viewManager.setStaticMaterial(e,t)},setStaticLook:function(e,t){this.viewManager.setStaticLook(e,t)},setDefaultMaterials:function(e){this.viewManager.setDefaultMaterials(e)},setAlternativeEditDisplay:function(e){this.viewManager.setTemporaryBodies(e)},empty:function(e,t){this._parent(e,t),this.viewManager.clear()},updatePlaneOnViewMessage:function(e){this.viewManager.updatePlaneOnViewMessage(e)},_getCSIOverrideManager:function(){return this._csiOverrideManager},getVisuContextViewMode:function(){var e=this.getVisuShadingMode();if(!e||!r.__ViewModeType__||!r.__ViewAppearanceMap__)return null;for(var t=this.getCustomMaterialModeParameters(),i={mask:r.__ViewModeType__.VIEW_APPEARANCE,appearanceName:null,shininess:t.shininess,opacity:t.opacity,color:t.color.toArray(),useObjectColor:t.colorFromGAS},n=this.renderer.renderer._defaultAppearanceType,s=Object.keys(r.__ViewAppearanceMap__),a=0;a<s.length;a++)if(r.__ViewAppearanceMap__[s[a]]===n){i.appearanceName=s[a];break}return i.appearanceName?(e.includes("Wireframe")?i.mask|=r.__ViewModeType__.VIEW_EDGE:e.includes("Illustration")?i.mask|=r.__ViewModeType__.VIEW_HRD:(i.mask|=r.__ViewModeType__.VIEW_MESH,this.getMaterialMode()&&(i.mask|=r.__ViewModeType__.VIEW_MATERIAL),e.includes("Edges")&&(i.mask|=r.__ViewModeType__.VIEW_EDGE,e.includes("NoSmoothEdges")?i.mask|=r.__ViewModeType__.VIEW_WITHOUT_SMOOTH_EDGE:e.includes("HalfSmoothEdges")&&(i.mask|=r.__ViewModeType__.VIEW_WITH_HALF_SMOOTH_EDGE),e.includes("HiddenEdges")&&(i.mask|=r.__ViewModeType__.VIEW_HIDDEN_EDGE))),this.getAxisFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_AXIS),this.getPointsFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_POINTS),this.getLinesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_WIRES),this.getVerticesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_VERTEX),this._getVisuOutlineMode()&&(i.mask|=r.__ViewModeType__.VIEW_OUTLINE),this.getSmallCurvatureEdgesFilter()||(i.mask|=r.__ViewModeType__.VIEW_WITHOUT_SMALL_CURVATURE_STEP_EDGE),i):null},onVisuContextViewModeModified:function(e){if(e){var t=[];return t.push(this.onAxisFilterChange(e)),t.push(this.onPlanesFilterChange(e)),t.push(this.onLinesFilterChange(e)),t.push(this.onPointsFilterChange(e)),t.push(this.onVerticesFilterChange(e)),t.push(this.onVisuAppearanceModeChange(e)),t.push(this.onCustomMaterialModeParametersChange(e)),t.push(this._onVisuOutlineModeChange(e)),t.push(this.onVisuShadingModeChange(e)),t}},_refreshPLMViewMode:function(e){return this._csiOverrideManager.refreshPLMViewMode(e)},_updatePLMViewMode:function(e,t){return this._csiOverrideManager.updatePLMViewMode(e,t)},_setViewpointPLMViewMode:function(e,t){this._csiOverrideManager.setViewpointPLMViewMode(e,t)},_setNodePLMViewMode:function(e,t,i){this._csiOverrideManager.setNodePLMViewMode(e,t,i)},_setOutlineNode:function(e,t,i){if(t||this._scissorOutlineNodes){this._scissorOutlineNodes||(this._scissorOutlineNodes=new WeakMap);var r=this._scissorOutlineNodes.get(e);r&&e.removeChild(r),t?(i&&e.addChild(i),this._scissorOutlineNodes.set(e,i)):this._scissorOutlineNodes.delete(e)}},dispose:function(){this.viewManager.dispose(),this._parent()}});return UWA.namespace("THREEDS/CSIViewer",s)}),define("DS/Visualization/LoaderInfiniteUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/KDTree","DS/Visualization/FontUtils","DS/SceneGraphNodes/CurvedPipeBatchDummyNode","DS/SceneGraphNodes/RefPlaneNode","DS/SceneGraphNodes/VoxelVolumeNode","DS/SceneGraphNodes/FixedSizeArrowNode"],function(e,t,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v){"use strict";var _=function(t){for(var r=[],n=e.getDevicePixelRatio()/.264583333,s=0;s<t.length;s++){var o=t[s],l=null,h=o.length*n,c=new e.Vector3(o.direction[0],o.direction[1],o.direction[2]);c.normalize();var d=new e.Vector3(0,1,0),u=new e.Vector3(1,0,0),p=new e.Vector3(o.origin[0],o.origin[1],o.origin[2]);if(1!==c.z)(d=(new e.Vector3).crossVectors(new e.Vector3(0,0,1),c)).normalize(),(u=(new e.Vector3).crossVectors(d,c)).normalize();var f=(new e.Matrix4).makeBasis(u,d,c);f.setPosition(p);var g=new a.Color(o.color[0]/255,o.color[1]/255,o.color[2]/255,o.color[3]/255),m={name:"arrow"+i,pickable:!0,color:g,head:v.types.ARROW,arrowLength:h,arrowWidth:1};l=new v(m),o.noShow&&l.setVisibility(!1),l.setMatrix(f),o.infiniteFace&&l._forceGeomType("AXIS_SYSTEM"),r.push(l)}return r};return{createInfiniteGeometry:function(t,i,n){var s=null;switch(t){case e._InfiniteGeomertryType.VOXEL_REP:s=new m(i),n.flexibleBatching||(n.voxelNode||(n.voxelNode=[]),n.voxelNode.push(s));break;case e._InfiniteGeomertryType.REF_PLANE:var l=function(t,i){for(var r=[],n=1/e.getPixelsPerMM(),s=e.getDevicePixelRatio()/n,o=0;o<t.length;o++){var l=t[o],h=null,u=l.lengthX*s,p=l.lengthY*s,f=new e.Vector3(l.xAxis[0],l.xAxis[1],l.xAxis[2]),m=new e.Vector3(l.yAxis[0],l.yAxis[1],l.yAxis[2]),v=((new e.Vector3).crossVectors(f,m),new e.Vector3(l.origin[0],l.origin[1],l.origin[2])),_=new a.Color(l.color[0]/255,l.color[1]/255,l.color[2]/255,l.color[3]/255);if(new e.Color(_),"CAT3DReferencePlaneRep"===l.type){var y=l.mode;y?(l.lengthX*=1/n,l.lengthY*=1/n):l.autoSize&&(l.lengthX*=1.05,l.lengthY*=1.05);var S=l.refPlaneData,x=!S||!S._wireframeMode,b=(!!S&&S._orientationVisibility,!S||S._labelVisibility),w=S?S._opacity/255:.075,M=S?new e.Color(S._frontColor):new e.Color("#005686"),C=S?new e.Color(S._backColor):new e.Color("#a3c8dc"),P={name:"ref Plane "+o,fill:!0,newLook:x,fixedSize:y,size:new e.Vector2(l.lengthX,l.lengthY),planeAttributes:{front:{color:M,opacity:w},back:{color:C,opacity:w}},borderAttributes:{front:{color:M,opacity:.8,width:1},back:{color:C,opacity:.8,width:1}}};b&&(P.textAttributes={fixedSize:!0,front:{data:l.label,color:M,opacity:1,size:30},back:{data:l.label,color:C,opacity:1,size:30}}),h=new g(P)}else if(l.zoomable){(h=d.createRectangleNode({color:_,width:u,height:p,fill:!1})).setShadow(!1),h.setFrustumCulled(!1);var E=new e.Vector3(.7071068*-u/2,.7071068*-p/2,0),T=(new e.Matrix4).setPosition(E);h.setMatrix(T)}else{var A=null;i.sgRep&&(A=i.sgRep[l.rep]),P={sgRep:A,origin:v,direction2:new e.Vector3(l.xAxis[0]+l.yAxis[0],l.xAxis[1]+l.yAxis[1],l.xAxis[2]+l.yAxis[2]),direction1:new e.Vector3(l.xAxis[0]-l.yAxis[0],l.xAxis[1]-l.yAxis[1],l.xAxis[2]-l.yAxis[2]),color:_,length1:.7071068*u,length2:.7071068*p,name:"ref Plane "+o},h=new c(P)}r.push(h)}return r}(i,n);if(n.flexibleBatching){if(l.length){(s=new r)._forceGeomType("INFINITE_FACE");for(h=0;h<l.length;h++)e.__NoShowForAxisAndPlanesBags()&&(l[h].setVisibility(!1),l[h].setVisibilityInTree(!1)),l[h].setNoZ(!0),s.addChild(l[h])}}else if(n.refPlanesNode||(n.refPlanesNode=new r("RefPlanes"),n.refPlanesNode.setNoZ(!0),e.__NoShowForAxisAndPlanesBags()&&(n.refPlanesNode.setVisibility(!1),n.refPlanesNode.setVisibilityInTree(!1))),l.length)for(var h=0;h<l.length;h++)n.refPlanesNode.addChild(l[h]);break;case e._InfiniteGeomertryType.AXIS_SYSTEM:s=function(t,i){var n=t,s=new r,l=null,h=n.zoomable||!1;t={sgRep:i.sgRep&&i.sgRep[n.rep],headLength:10,arrowLength:h?n.length:50,arrowWidth:2,sceneGraph:s,colors:{colorX:new a.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255),colorY:new a.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255),colorZ:new a.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255)},name:"axis System 1",head:o.types.ARROW,zoomable:h};l=new o(t);var c=new e.Matrix4,u=[];if(u[0]=n.xAxis[0],u[1]=n.xAxis[1],u[2]=n.xAxis[2],u[3]=0,u[4]=n.yAxis[0],u[5]=n.yAxis[1],u[6]=n.yAxis[2],u[7]=0,u[8]=n.zAxis[0],u[9]=n.zAxis[1],u[10]=n.zAxis[2],u[11]=0,u[12]=n.origin[0],u[13]=n.origin[1],u[14]=n.origin[2],u[15]=1,c.setFromArray(u),l.setMatrix(c),void 0!==n.refPlanes){var p=null;if(h){p=new r;for(var f=null,g=0;g<n.refPlanes.length;g++){var m=new a.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255);f=n.refPlanes[g];var v=[new e.Vector3(f[0],f[1],f[2]),w=new e.Vector3(f[3],f[4],f[5]),new e.Vector3(f[6],f[7],f[8])];(y=d.createLineNode({points:v,color:m})).setShadow(!1),y.setFrustumCulled(!1),p.addChild(y)}}else{p=new r("fixedSizeHalfPlanes");var _=(new e.Matrix4).getInverse(c);for(n.xAxis,n.yAxis,n.zAxis,g=0;g<n.refPlanes.length&&1===n.refPlanes[g].mode;g++){var y,S=n.refPlanes[g].length*e.getDevicePixelRatio()/.264583333,x=(m=new a.Color(n.color[0]/255,n.color[1]/255,n.color[2]/255,n.color[3]/255),n.refPlanes[g].direction1),b=n.refPlanes[g].direction2,w=new e.Vector3(.5*S*x[0],.5*S*x[1],.5*S*x[2]);v=[new e.Vector3(w.x+.25*S*(x[0]+b[0]),w.y+.25*S*(x[1]+b[1]),w.z+.25*S*(x[2]+b[2])),w,new e.Vector3(w.x+.25*S*(x[0]-b[0]),w.y+.25*S*(x[1]-b[1]),w.z+.25*S*(x[2]-b[2]))],(y=d.createLineNode({points:v,color:m})).setShadow(!1),y.setFrustumCulled(!1),p.addChild(y)}var M=(new e.Matrix4).multiplyMatrices(_,(new e.Matrix4).setPosition(new e.Vector3(n.origin[0],n.origin[1],n.origin[2])));p.setMatrix(M),p._setRatio(1)}p.setNoZ(!0),l.addChild(p)}return l}(i,n),n.flexibleBatching||(n.axisSystemsNode||(n.axisSystemsNode=new r("AxisSystems"),e.__NoShowForAxisAndPlanesBags()&&(n.axisSystemsNode.setVisibility(!1),n.axisSystemsNode.setVisibilityFree(!0),n.axisSystemsNode.setVisibilityInTree(!1))),s&&n.axisSystemsNode.addChild(s));break;case e._InfiniteGeomertryType.CANONICAL:s=function(e){var t=0,i=1,r=2,n=3,s=4,a=5,o=6,l=7;switch(e.canonicalType){case t:console.log("Cone");break;case i:console.log("Cylinder");break;case r:console.log("Pipe");break;case n:console.log("Cuboid");break;case a:console.log("PartialSphere");break;case s:console.log("Sphere");break;case l:console.log("PartialTore");break;case o:console.log("Tore")}return null}(i);break;case e._InfiniteGeomertryType.ARROWS:l=_(i);if(n.flexibleBatching){if(l.length){s=new r;for(h=0;h<l.length;h++)s.addChild(l[h])}}else if(n.refArrowsNode||(n.refArrowsNode=new r("Arrows")),l.length)for(var h=0;h<l.length;h++)n.refArrowsNode.addChild(l[h])}return s}}}),define("DS/Visualization/LoaderUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/CGRNode","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/Mesh/Mesh","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/KDTree","DS/Visualization/FontUtils","DS/SceneGraphNodes/CurvedPipeBatchDummyNode","DS/SceneGraphNodes/RefPlaneNode","DS/SceneGraphNodes/VoxelVolumeNode","DS/SceneGraphNodes/FixedSizeArrowNode","DS/Visualization/LoaderInfiniteUtils","DS/Visualization/PathElement","DS/Visualization/RenderStyle"],function(e,t,i,r,n,s,a,o,l,h,c,d,u,p,f,g,m,v,_,y){"use strict";var S=null,x=function(t,i){var r=i.materialLibrary,s=i.baseUrl,a=new n,o=r[t];if(void 0===o)return null;var l=r[o.instance];if(void 0===l)return null;var h=r[l.instance];return void 0===h?null:(void 0===h.material&&void 0!==h.params?(h.material=a.getMaterial3DXML(h.params,s,"XMLV43"),h.material.force=!0):void 0===h.params&&(h.material=e.MaterialUtils.createMatteFaceMaterial(),h.material.force=!0),h.material)},b=function(e,t,i,r,n){for(var a=e.buffer?e:e.prims,o=e.buffer?null:e.bs,l=a.length/5,h=new s.BinarySGPrimitiveArray(a,i,t,o,5),c=[],d=null,u=null,p=new Set,f=0;f<l;f++){(d=t[a[5*f+1]])._binary=!0,p.has(d)&&d!==u&&console.error("Non contiguious primitive reps"),p.add(d);var g=d._primitives[d._primitives.length-1];g&&d===u?g.count++:d._primitives.push({binary:h,start:f,count:1}),u=d}if(r&&r.noShowPrim&&r.noShowPrim.length){var m=new s.SGPrimitiveHelper;for(f=0;f<r.noShowPrim.length;f++)m.set(i,r.noShowPrim[f]),c.push(m.clone())}return{primitives:h,noShowPrim:c}},w=function(e,t,i,r,n){for(var a=e.buffer?e:e.prims,o=(e.buffer||e.bs,a.length/5),l=new Array(o),h=[],c=-1,d=null,u=0,p=0,f=0,g=null,m=0,v=0;v<o;v++)c=a[m++]-1,d=t[a[m++]],u=a[m++],p=a[m++],f=a[m++],g=new s.SGPrimitive({cgmId:c,rep:d,start:u,count:p,decoration:f,group:i}),l[v]=g,d._primitives.push(g);if(r&&r.noShowPrim&&r.noShowPrim.length){var _=new s.SGPrimitiveHelper;for(v=0;v<r.noShowPrim.length;v++)_.set(i,r.noShowPrim[v]),h.push(_.clone())}return{primitives:l,noShowPrim:h}},M=function(t,i,a,o,l,h,c){for(var d,u,p=null,f=null,g=[],m=null,v=null,_=new e.Sphere,y=new e.Box3,S=[],M=c.sgRep,C=c.decorations,P=new n,E=0;E<t.length;E++){var T=t[E],A=c.noMeshInRAM,D=new e.BufferGeometryDS,I=new e.Vector3(T.AABB.min[0],T.AABB.min[1],T.AABB.min[2]),R=new e.Vector3(T.AABB.max[0],T.AABB.max[1],T.AABB.max[2]);D.boundingBox=new e.Box3(I,R),D.boundingSphere=D.boundingBox.getBoundingSphere(),null===m&&(m=I),null===v&&(v=R),I.x<m.x&&(m.x=I.x),I.y<m.y&&(m.y=I.y),I.z<m.z&&(m.z=I.z),R.x>v.x&&(v.x=R.x),R.y>v.y&&(v.y=R.y),R.z>v.z&&(v.z=R.z),y.set(m,v),_.radius=v.clone().sub(m).multiplyScalar(.5).length(),_.center=v.clone().add(m).multiplyScalar(.5);for(var O=0;O<T.drawingGroups.length;O++){if(p=T.drawingGroups[O],T.drawingGroups[O]=new s.DrawingGroup(p.gas,p.material,p.glType,p.start,p.count,p._primitives,null,p._geomType,p.gasIndex,-1,p._advancedInheritanceIndex),T.drawingGroups[O].cullingData=p.cullingData,c.fromCGR){var L;e._BinaryPrimitives?(L=b(p._primitives,M,T.drawingGroups[O],p),T.drawingGroups[O]._nonBinary=!1):L=w(p._primitives,M,T.drawingGroups[O],p),T.drawingGroups[O]._primitives=L.primitives,S=S.concat(L.noShowPrim)}else{u=(p=T.drawingGroups[O])._primitives;for(var V=0;V<u.length;V++)u[V]=new s.SGPrimitive(u[V]),u[V].group=p}(p=T.drawingGroups[O]).geometry=D;var F=p.gas,B=!1;F.set&&(B=(F=new s.GraphicAttributeSet(F.set,F.rgba,F.webOverride)).getType()>1);var N=p.material;if(p.gas=null,p.material=null,null!==N&&""!==N.file?p.material=x(N.id,h):null===N||-1===N.id||4!==p.glType&&!B||(l[N.id]?d=l[N.id]:(N.shading&&(a[N.id].shading=N.shading),(d=P.getMaterialCgr(a[N.id],void 0,"CGR",o,p))&&(d._sceneGraphOrderMode=c.sceneGraphOrderMode,l[N.id]=d,a[N.id]&&a[N.id].useAsGas&&(F=null,p.gas=d),void 0!==d.needTangentBinormal&&(d.needTangentBinormal&&T.vertexTangentArray&&T.vertexBinormalArray||(d.needTangentBinormal=!1)))),p.material=d),null!==F)if(F.set){c&&!c.edgeTransparency&&P._getLineWidth(F)>1&&(F.opacity=1),P._gasAllowNMIR(F)||(A=!1);var G=-1;0==F.getType()&&((G=F.getPriority())||(G=4),(p._geomType&e.BodyLinesMask)>0&&(G=-1));var k={sceneGraphOrderMode:c.sceneGraphOrderMode};if(F.isNopick()&&(p._noPick=!0),-1!==p._advancedInheritanceIndex&&c.advancedInheritance&&c.advancedInheritance.length&&P.hasLineTypes()&&p._advancedInheritanceIndex<=c.advancedInheritance.length){var U=c.advancedInheritance[p._advancedInheritanceIndex];p.gas=P._createLineFromAdvancedInheritnace(U,F,k),p.gas||(p.gas=new e.LineBasicMaterial)}else p.gas=P._getMaterialFromGAS(F,k);p._noZPriority=G}else{var z=new e.Color;z.setRGB(F.color.r,F.color.g,F.color.b),F.lineWidth&&c&&!c.edgeTransparency&&(F.opacity=1),(F.pattern>1||F.lineWidth>1)&&(A=!1),p.gas=P.getMaterialFromGAS({color:z,opacity:F.opacity,pattern:F.pattern,lineWidth:F.lineWidth,forceLineWidth:F.forceLineWidth,solid:F.solid,symbol:F.symbol,basic:F.basic,resource:o})}}for(O=0;O<T.drawingGroups.length;O++)(p=T.drawingGroups[O]).computeCompleteSolidStatus();D.drawingGroups=T.drawingGroups,D.decorations=C,D.vertexPositionArray=T.vertexPositionArray,null!==T.vertexNormalArray&&(D.vertexNormalArray=T.vertexNormalArray),null!==T.vertexUvArray&&(D.vertexUvArray=T.vertexUvArray),null!==T.vertexTangentArray&&(D.vertexTangentArray=T.vertexTangentArray),null!==T.vertexBinormalArray&&(D.vertexBinormalArray=T.vertexBinormalArray),null!==T.vertexColorArray&&(D.vertexColorArray=T.vertexColorArray),D.vertexIndexArray=T.vertexIndexArray,c&&c.sharedBuffers&&(D.sharedBuffers=!0),D.noMeshInRAM=A,g.push(D)}(N=P._getMaterialFromGAS(new s.GraphicAttributeSet(4278190112,-1,2))).line=P._getMaterialFromGAS(new s.GraphicAttributeSet(4278456337,-1,1)),g.boundingSphere=_,g.boundingBox=y,(f=new e.Mesh(g,N)).fromLoadedModel=!0;for(E=0;E<g.length;E++){s.unindexPoints(g[E])&&(g[E].sharedBuffers=!1)}f.matrixAutoUpdate=!1,f.castShadow=!0,f.receiveShadow=!0;var H=new r(f);(S.length&&H.hide(S),c.accelStruct)&&H._occurrences[0].renderable.computeKDTree(!1);return H},C={__storeCGRNames:1,getEmptyMesh:function(){return S||(S=this.createEmptyMesh()),S},createEmptyMesh:function(){var t=new e.BufferGeometryDS;t.boundingSphere=new e.Sphere(new e.Vector3,0),t.boundingBox=new e.Box3;var i=e.MaterialUtils.createShinyFaceMaterial(),n=new e.Mesh(t,i);return n.matrixAutoUpdate=!1,n.castShadow=!0,n.receiveShadow=!0,new r(n)},createMeshes:function(t,r,n,s,a,l){for(var h=null,c=!0,d=0;d<t.length;d++)if(t[d].length){if(1&d||8&d){if((h=new i).name=r.node+"_parallelToScreen",!(1&d)){for(u=0;u<t[d].length;++u){(f=M(t[d][u].tab,0,r.material,r.resource,s,a,l)).setRatio(1);g=t[d][u].globalMatrix;if((p=new o({type:"Spherical"})).addChild(f),g){m=(new e.Matrix4).setFromArray(g.elements),v=(new e.Vector3).getScaleFromMatrix(m),_=(new e.Matrix4).scale(v);p.setMatrix(m),f.setMatrix(_)}h.addChild(p)}0==h.children.length&&(h=null),h&&(n.push(h),c=!1);continue}for(var u=0;u<t[d].length;++u){var p,f=M(t[d][u].tab,0,r.material,r.resource,s,a,l),g=t[d][u].globalMatrix;if((p=new o({type:"Spherical"})).addChild(f),g){var m=(new e.Matrix4).setFromArray(g.elements),v=(new e.Vector3).getScaleFromMatrix(m),_=(new e.Matrix4).scale(v);p.setMatrix(m),f.setMatrix(_)}h.addChild(p)}0==h.children.length&&(h=null)}else h=M(t[d],0,r.material,r.resource,s,a,l),1===this.__storeCGRNames&&(h.name=r.node);2&d&&h.setExcludeFromBounding(!0),4&d&&h.setNoZ(!0),h&&(n.push(h),c=!1)}return c},processData:function(r,a,o,l,h,c){h||(h={});var d=h.udlMode,f=function(t,i){var r=1,n=2,s=3,a=4,o=5,l=6,h=7,c=9;if(i===0);else{var d=!1,u=e.GeomTypeEnum.EDGE|e.GeomTypeEnum.SHARP_EDGE|e.GeomTypeEnum.SMOOTH_EDGE|e.GeomTypeEnum._HIGH_CURVATURE_EDGE|e.GeomTypeEnum.BOUNDARY_EDGE|e.GeomTypeEnum.FACE|e.GeomTypeEnum.INFINITE_FACE|e.GeomTypeEnum._OUTLINE,p=new y({faceMode:null});switch(p._displayNothingRenderMode(),p.setReplaceMask(u),i){case r:p.setRenderMode("Face",!0),p.setRenderMode("InfiniteFace",!0);break;case n:p.setRenderMode("@Edge",!0);break;case s:p.setRenderMode("Face",!0),p.setRenderMode("InfiniteFace",!0),p.setRenderMode("@Edge",!0);break;case a:p.setRenderMode("Face",!0),p.setRenderMode("InfiniteFace",!0);break;case c:p.setRepViewNothing(!0);break;case o:p.setRenderMode("Face",!0),p.setRenderMode("@Edge",!0),p.setRenderMode("Outline",!0),p.setFaceMode("BACKGROUND");break;case l:p.setRenderMode("@Edge",!0),p.setRenderMode("Outline",!0);break;case h:p.setRenderMode("Face",!0),p.setRenderMode("@Edge",!0),p.setRenderMode("Outline",!0);break;default:d=!0}if(!d){let e=t.createOverrideSetManager(),i=e.createSceneGraphOverrideSet();e.pushSceneGraphOverrideSet(i),i.createOverride(new _([t])).setRenderStyle(p,!0)}}},g=function(t,r,n,s,a,o,l){if(t&&r){if(t.externalPath&&(t.alreadyCreated||(t.attributes&&t.attributes.length?t.nodeRef=function(t){for(var r=new i,n=0;n<t.length;n++){var s=t[n].typeAttribute,a=t[n].attribute;if(s==e._FilterType.SCISSORFILTER){var o=a[1],l=[];for(n=0;n<o;n++)l.push(a[2+2*n]),l.push(a[2+2*n+1]);r.setScissoringPolyLine({nbPolygon:1,nbVertices:[o],vertices:l,point:new e.Vector3(0,0,0),dirX:new e.Vector3(1,0,0),dirY:new e.Vector3(0,1,0)})}else if(s==e._FilterType.VIEWMODE){var h=a.viewMode;a.viewModeSensitivity,f(r,h)}}return r}(t.attributes):t.nodeRef=new i,t.externalMatrix&&t.nodeRef.setMatrix((new e.Matrix4).setFromArray(t.externalMatrix.elements)),t.alreadyCreated=!0),s&&s.addChild(t.nodeRef),s=t.nodeRef),t.textIndice)for(var h=l[t.textIndice-1],c=0;c<h.length;c++)s.addChild(h[c]);if(t.typeGeom){t.batchIndex;var d=[];switch(t.typeGeom){case e._InfiniteGeomertryType.REF_PLANE:case e._InfiniteGeomertryType.AXIS_SYSTEM:case e._InfiniteGeomertryType.ARROWS:case e._InfiniteGeomertryType.CANONICAL:case e._InfiniteGeomertryType.VOXEL_REP:d=a[t.batchIndex];break;case e._InfiniteGeomertryType.TESSELATION:d=n[t.batchIndex];break;case e._InfiniteGeomertryType.CURVED_PIPE:d=o[t.batchIndex]}if(d)if(Array.isArray(d))for(var u=0;u<d.length;u++)s.addChild(d[u]);else s.addChild(d)}if(t.children){var p=t.children,m=null,v=p.length;for(c=0;c<v;c++)if(p[c].children)g(p[c],r,n,s,a,o,l);else{if(p[c].typeGeom){p[c].batchIndex,d=[];switch(p[c].typeGeom){case e._InfiniteGeomertryType.REF_PLANE:case e._InfiniteGeomertryType.AXIS_SYSTEM:case e._InfiniteGeomertryType.ARROWS:case e._InfiniteGeomertryType.CANONICAL:case e._InfiniteGeomertryType.VOXEL_REP:d=a[p[c].batchIndex];break;case e._InfiniteGeomertryType.TESSELATION:d=n[p[c].batchIndex];break;case e._InfiniteGeomertryType.CURVED_PIPE:d=o[p[c].batchIndex]}if(d)if(Array.isArray(d))for(u=0;u<d.length;u++)s.addChild(d[u]);else s.addChild(d)}p[c].parents&&p[c].parents[0]||(p[c].added?(r[p[c].ind].parents[0]=t,m=r[p[c].ind],p[c]=m):(r[p[c]].parents[0]=t,m=r[p[c]],p[c]=m))}}}},m=function(){this.children=[]};m.prototype.addChild=function(e){this.children.push(e)};var S,x=null,b=[],w=[],M=[],P=[],E=[],T=[],A=!1,D=!1,I=!1,R=null,O=function(){if(!A&&D){if(r&&!h.unlinkToSG)if(a.sceneGraph&&(d&&R&&S.addChild(R),g(a.sceneGraph,B,M,S,T,P,E),S._buildSGBagNodes()),l){for(var e=0;e<r.length;e++)r[e]&&(V?((x=C.createEmptyMesh()).name=a.node,r[e].addChild(x)):(r[e].addChild(S),w=[S]));a.sceneGraph&&a.sceneGraph.noShow&&S.setVisibility(!1)}else for(e=0;e<r.length;e++)if(r[e])if(r[0].length&&(r=r[0]),V)(x=C.createEmptyMesh()).name=a.node,r[e].addChild(x);else for(var t=0;t<S.children.length;t++)r[e].addChild(S.children[t]);c&&c(w,{textHasBeenProcessed:I})}};h||(h={}),h&&h.textureInBlack&&a&&function(e){e.length;for(var t=0;t<e.length;t++){var i=e[t].img,r=e[t].format;if(2==r)for(var n=0;n<i.length;n+=3)255==i[n]&&255==i[n+1]&&255==i[n+2]&&(i[n]=0,i[n+1]=0,i[n+2]=0);if(3==r)for(n=0;n<i.length;n+=4)255==i[n]&&255==i[n+1]&&255==i[n+2]&&(i[n]=0,i[n+1]=0,i[n+2]=0)}}(a.resource),S=l?new t(a.sceneGraph,a.sag):new m;var L=new n;L.cleanResources();var V=!0;h.fromCGR=!0,h.flexibleBatching=d;var F=[];if(a.rep&&(F[0]=[a.rep],h.fromCGR=!1),a.reps&&(F=a.reps),h.fromCGR){var B=function(e,t){if(!e)return[];var i=3;t.withSAG&&(i+=1),t.repWithBS&&(i+=4),t.udlMode&&(i+=2);var r=e.length/i,n=new Array(r),a=0;if(t.withSAG)if(t.repWithBS)for(var o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++],sag:e[a++],boundingSphere:{radius:e[a++],center:[e[a++],e[a++],e[a++]]}});else for(o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++],sag:e[a++]});else if(t.repWithBS)for(o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++],boundingSphere:{radius:e[a++],center:[e[a++],e[a++],e[a++]]}});else for(o=0;o<r;o++)n[o]=new s.SGRep({cgmId:e[a++]-1,solid:e[a++],namingContext:e[a++]});return n}(a.sgRep,h);h.advancedInheritance=a.advancedInheritance,h.sgRep=B,h.decorations=a.decorations}if(F.length){M=new Array(F.length);for(var N=0;N<F.length;N++){M[N]=[],this.createMeshes(F[N],a,M[N],b,o,h)||(V=!1)}if(d){if(a.rootBatch){var G=M[a.rootBatch.indice];R=G[0]}}else for(N=0;N<M[0].length;N++)S.addChild(M[0][N]),w.push(M[0][N])}var k={refPlanesNode:null,refArrowsNode:null,axisSystemsNode:null,voxelNode:null,sgRep:B,flexibleBatching:d};if(a.infiniteGeometries){for(N=0;N<a.infiniteGeometries.length;++N){V=!1;var U=a.infiniteGeometries[N],z=v.createInfiniteGeometry(U.type,U.params,k);d&&T.push(z)}if(!d&&(k.refPlanesNode&&(k.refPlanesNode._forceGeomType("INFINITE_FACE"),w.push(k.refPlanesNode),S.addChild(k.refPlanesNode)),k.refArrowsNode&&(w.push(k.refArrowsNode),S.addChild(k.refArrowsNode)),k.axisSystemsNode&&(k.axisSystemsNode._forceGeomType("AXIS_SYSTEM"),w.push(k.axisSystemsNode),S.addChild(k.axisSystemsNode)),k.voxelNode))for(N=0;N<k.voxelNode.length;++N)w.push(k.voxelNode[N]),S.addChild(k.voxelNode[N])}if(h.processText&&a.texts&&a.texts.length>0){A=a.texts.length,V=!1,I=!0;for(var H=function(e){for(var t=0;t<e.length;++t)d?E.push(e[t]):(w.push(e[t]),S.addChild(e[t]));A--,O()},W=0;W<a.texts.length;++W)u.createTexts(a.texts[W],h,H)}if(a.curvedPipes&&a.curvedPipes.length>0){var j=null,X={curvedPipes:[]};for(N=0;N<a.curvedPipes.length;++N){var q=a.curvedPipes[N],Z=(q.matId,q.gas),Y={radius:q.radius,curvePoints:q.curveVertices,baseNormal:new e.Vector3(q.startNormal[0],q.startNormal[1],q.startNormal[2]),endNormal:new e.Vector3(q.endNormal[0],q.endNormal[1],q.endNormal[2]),baseSideVector:new e.Vector3(q.startSideVector[0],q.startSideVector[1],q.startSideVector[2])};if(X.curvedPipes.push(Y),null!==Z){var Q=new e.Color;Q.setRGB(Z.color.r,Z.color.g,Z.color.b),j=L.getMaterialFromGAS({color:Q,opacity:Z.opacity}),Y.gas=j,j._source=e.AssetSource.MANUAL}}var K=new p(X);d?P.push(K):(w.push(K),S.addChild(K)),V=!1}D=!0,O()},isProcessDataAsynchronous:!0};return C}),define("DS/Visualization/InstancingNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/Visualization/SubElement","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,s){"use strict";var a=0,o=(e.NoOccurrences,t.extend({init:function(e){return this._parent(e),this.instance3DBooleanAttr=0,this.setIsInstanceNode3D(!1),this.nbInstances=0,this._instancingInfos=null,this._instancingMatrices=null,this._pixelCullingMatrix=null,this},_propagateInstancingInfos:function(){for(let e=0;e<this._occurrences.length;e++){let t=this._occurrences[e];this._propagateInstancingParameters(t,this._instancingInfos);let i=t.children.length;for(let e=0;e<i;e++){let i=t.children[e];this._updateOccurrences(t,i,!1)}}},_updateMatrixInfos:function(){if(this._instancingMatrices){let e=null;for(let t=0;t<this._instancingMatrices.length;t++){let i=this._instancingMatrices[t].getMaxScaleOnAxis();(!e||i>e)&&(this._pixelCullingMatrix=this._instancingMatrices[t],e=i)}}else this._pixelCullingMatrix=null},removeInstancingParameters:function(){if(this._instancingInfos){let t=this._instancingInfos.instanceAttribArrays,i=this._getViewer(),r=i&&i.getWebGLContext();if(r)for(var e in t)t[e].buffer&&r.deleteBuffer(t[e].buffer)}for(let e=0;e<this._occurrences.length;e++){let t=this._occurrences[e]._getRenderableOccurrences();for(let e=0;e<t.length;e++)this._removeFromVisuSelection(t[e])}this._instancingInfos=null,this._instancingMatrices=null,this._invalidateBoundingElements(),this._propagateInstancingInfos()},setInstancingParameters:function(e,t,i){if(this.removeInstancingParameters(),!e)return;for(let e=0;e<this.parents.length;e++){let t=this.parents[e];for(let e=0;e<t._occurrences.length;e++){if(t._occurrences[e]._instancingInfos)return void console.error("there is already an instancingNode3D with instancing active higher in this node hierarchy")}}let r=!1;if(this.traverse(function(e){return e instanceof o&&e._instancingInfos&&(r=!0),r}),r)return void console.error("there is already an instancingNode3D with instancing active lower in this node hierarchy");this._instancingMatrices=[];for(let t=0;t<e.length;t++)this._instancingMatrices[t]=e[t].clone();this._updateMatrixInfos(),t||(t=[]),t.push({isFlattened:!1,type:"m4",data:e,attribName:"defaultInstancingMatrix"});let n=e.length;this.setIsInstanceNode3D(!0),this.nbInstances=n,this._instancingInfos={isInstanceNode3D:!0,nbInstances:n,instancingSelectionMode:i||"instance",instanceAttribArrays:null,pickedInstanceId:-1,useDefaultInstancing:!0};for(var s=new Float32Array(n),l=0;l<n;l++)s[l]=5+5*l;var h={};h.id=a,a++,h.instanceId={},h.instanceId.array=s,h.instanceId.buffer=null,h.instanceId.itemSize=1,h.instanceId.type="f";for(var c=0;c<t.length;c++){switch(h[t[c].attribName]={},t[c].type){case"f":h[t[c].attribName].array=new Float32Array(t[c].data),h[t[c].attribName].type="f",h[t[c].attribName].itemSize=1;break;case"v2":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(2*n);for(var d=0;d<n;d++)h[t[c].attribName].array[2*d]=t[c].data[d].x,h[t[c].attribName].array[2*d+1]=t[c].data[d].y}h[t[c].attribName].type="v2",h[t[c].attribName].itemSize=2;break;case"v3":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(3*n);for(d=0;d<n;d++)h[t[c].attribName].array[3*d]=t[c].data[d].x,h[t[c].attribName].array[3*d+1]=t[c].data[d].y,h[t[c].attribName].array[3*d+2]=t[c].data[d].z}h[t[c].attribName].type="v3",h[t[c].attribName].itemSize=3;break;case"v4":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(4*n);for(d=0;d<n;d++)h[t[c].attribName].array[4*d]=t[c].data[d].x,h[t[c].attribName].array[4*d+1]=t[c].data[d].y,h[t[c].attribName].array[4*d+2]=t[c].data[d].z,h[t[c].attribName].array[4*d+3]=t[c].data[d].w}h[t[c].attribName].type="v4",h[t[c].attribName].itemSize=4;break;case"m4":if(t[c].isFlattened)h[t[c].attribName].array=new Float32Array(t[c].data);else{h[t[c].attribName].array=new Float32Array(16*t[c].data.length);for(var u=0;u<t[c].data.length;u++){var p=new Float32Array(16);p=t[c].data[u].elements;for(l=0;l<16;l++)h[t[c].attribName].array[16*u+l]=p[l]}}h[t[c].attribName].type="m4",h[t[c].attribName].itemSize=4,h[t[c].attribName].isMat4=!0}h[t[c].attribName].buffer=null}this._instancingInfos.instanceAttribArrays=h,t.splice(t.length-1,1);let f={};for(c=0;c<t.length;c++)f[t[c].attribName]={type:t[c].type,instancing:!0};return this._invalidateBoundingElements(),this._propagateInstancingInfos(),f},getInstanceMatrixValue:function(e){return this._instancingMatrices[e].clone()},updateInstanceMatrixValue:function(e,t){this._instancingMatrices[e]=t.clone(),this.updateInstanceAttribValue({instanceId:5*(e+1),attribName:"defaultInstancingMatrix",value:this._instancingMatrices[e]}),this._updateMatrixInfos(),this._invalidateBoundingElements()},updateInstanceMatrixArray:function(e,t){t=t||0;for(let i=0;i<e.length;i++)this._instancingMatrices[i+t]=e[i].clone();this.updateInstanceAttribArray({attribName:"defaultInstancingMatrix",array:this._instancingMatrices,isFlattened:!1}),this._updateMatrixInfos(),this._invalidateBoundingElements()},updateInstanceAttribValue:function(t){if(t.instanceId&&t.attribName&&void 0!==t.value)if(this._instancingInfos)if(t.instanceId%5!=0||t.instanceId<5||t.instanceId>5*this._instancingInfos.nbInstances)console.error("Error: the instance id is incorrect or out of range.");else if(this._instancingInfos.instanceAttribArrays[t.attribName]){var i=this._instancingInfos.instanceAttribArrays,r=t.instanceId/5-1,n=!0;switch(i[t.attribName].type){case"f":"number"!=typeof t.value||isNaN(t.value)?n=!1:i[t.attribName].array[r]=t.value;break;case"v2":t.value instanceof e.Vector2?(i[t.attribName].array[2*r]=t.value.x,i[t.attribName].array[2*r+1]=t.value.y):n=!1;break;case"v3":t.value instanceof e.Vector3?(i[t.attribName].array[3*r]=t.value.x,i[t.attribName].array[3*r+1]=t.value.y,i[t.attribName].array[3*r+2]=t.value.z):n=!1;break;case"v4":t.value instanceof e.Vector4?(i[t.attribName].array[4*r]=t.value.x,i[t.attribName].array[4*r+1]=t.value.y,i[t.attribName].array[4*r+2]=t.value.z,i[t.attribName].array[4*r+3]=t.value.w):n=!1;break;case"m4":if(t.value instanceof e.Matrix4){var s=new Float32Array(16);s=t.value.elements;for(var a=0;a<16;a++)i[t.attribName].array[16*r+a]=s[a]}else n=!1;break;default:n=!0}n?(i[t.attribName].isDynamic=!0,this._propagateInstancingInfos()):console.error("Error: the type of the new value doesn't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this node is not multi-instanced (call setIntancingParameters first).");else console.error("Error: all parameters params.instanceId, params.attribName and params.value are needed.")},updateInstanceAttribArray:function(t){if(t.attribName&&t.array)if(this._instancingInfos)if(this._instancingInfos.instanceAttribArrays[t.attribName]){var i=!0,r=this._instancingInfos.instanceAttribArrays;if(t.isFlattened)t.array instanceof Array&&(t.array=new Float32Array(t.array)),r[t.attribName].array=t.array;else{var n=r[t.attribName].type,s=t.array[0];switch(n){case"f":"number"!=typeof s||isNaN(s)?i=!1:r[t.attribName].array.set(new Float32Array(t.array));break;case"v2":if(s instanceof e.Vector2)for(var a=0;a<this._instancingInfos.nbInstances;a++)r[t.attribName].array[2*a]=t.array[a].x,r[t.attribName].array[2*a+1]=t.array[a].y;else i=!1;break;case"v3":if(s instanceof e.Vector3)for(a=0;a<this._instancingInfos.nbInstances;a++)r[t.attribName].array[3*a]=t.array[a].x,r[t.attribName].array[3*a+1]=t.array[a].y,r[t.attribName].array[3*a+2]=t.array[a].z;else i=!1;break;case"v4":if(s instanceof e.Vector4)for(a=0;a<this._instancingInfos.nbInstances;a++)r[t.attribName].array[4*a]=t.array[a].x,r[t.attribName].array[4*a+1]=t.array[a].y,r[t.attribName].array[4*a+2]=t.array[a].z,r[t.attribName].array[4*a+3]=t.array[a].w;else i=!1;break;case"m4":if(s instanceof e.Matrix4){var o;for(a=0;a<this._instancingInfos.nbInstances;a++){o=t.array[a].elements;for(var l=0;l<16;l++)r[t.attribName].array[16*a+l]=o[l]}}else i=!1;break;default:i=!0}}i?(r[t.attribName].isDynamic=!0,this._propagateInstancingInfos()):console.error("Error: the type of the new values don't match the type of the attribute data.")}else console.error("Error: the attribute "+t.attribName+" doesn't exist for this mesh node.");else console.error("Error: this mesh node is not multi-instanced (call setIntancingParameters first).")},setInstancingSelectionMode:function(e){if(this.mesh3js._instancingInfos&&this.mesh3js._instancingInfos.isInstanceNode3D){this.mesh3js._instancingInfos.instancingSelectionMode=e;for(var t=this._occurrences,i=t.length,r=0;r<i;r++)t[r].renderable._instancingInfos.instancingSelectionMode=e}},_invalidateBoundingElements:function(e,t){this._parent(e,t)},_getInstanceWorldMatrixFromInstanceId(e,t,i){return this._getInstanceWorldMatrixFromIndex((e-5)/5,t,i)},_getInstanceWorldMatrixFromIndex(t,i,r){let n=i.matrix,s=r.matrix;if(t<this._instancingMatrices.length){let i=new e.Matrix4;return i.multiplyMatrices(this._instancingMatrices[t],s),i.multiplyMatrices(n,i),i}return console.error("incoherent index used for matrice instance"),s},_modifyBE:function(e,t){if(this._instancingMatrices){let i=null;for(let r=0;r<this._instancingMatrices.length;r++)i=t(i,e,this._instancingMatrices[r]);return i}return e},getTopZ(t,i,r){let n=t._getMMMatrix(),s=i.matrix,a=new e.Vector3,o=new e.Matrix4,l=null,h=null,c=null;for(let e=0;e<this._instancingMatrices.length;e++){let i=this._instancingMatrices[e].getMaxScaleOnAxis();o.multiplyMatrices(this._instancingMatrices[e],n),o.multiplyMatrices(s,o),a.copy(t.geometry.boundingSphere.center),a.applyMatrix4(o);let d=a[r],u=d+t.geometry.boundingSphere.radius*i;(!l||u<l)&&(l=u,h=(c=d)-t.geometry.boundingSphere.radius*i)}return t._BEbottomZ=h,l},getMin(t,i,r,n,s){let a=t._getMMMatrix(),o=i.matrix,l=new e.Matrix4,h=null,c=new e.Vector3;const d=n.getVertexCount();for(let e=0;e<this._instancingMatrices.length;e++){l.multiplyMatrices(this._instancingMatrices[e],a),l.multiplyMatrices(o,l);let i=t.geometry.boundingSphere.clone();if(i.applyMatrix4(l),i.center[r]-i.radius<s)for(let e=0;e<d;e++)n.getVertexPosition(e,c),c.applyMatrix4(l),(c[r]<h||null===h)&&(h=c[r])}return h},getMaxScaleOnAxis(t,i){let r=t.matrix?t.matrix.clone():new e.Matrix4;return this._pixelCullingMatrix&&r.multiplyMatrices(this._pixelCullingMatrix,r),i.matrix&&r.multiplyMatrices(i.matrix,r),r.getMaxScaleOnAxis()},getPixelCullingRadius(e,t){if(this._pixelCullingMatrix){let i=e.boundingSphere.clone();return i.applyMatrix4(e._occurrence.matrix),i.applyMatrix4(this._pixelCullingMatrix),i.applyMatrix4(t.matrix),i.radius}return e.worldRadius},getMesh3DChildren(){let e=[];return this.traverseUnique(function(t){t instanceof i&&e.push(t)}),e},_linkingClone:function(e,i){return t.prototype._linkingClone.call(this,e),e.instance3DBooleanAttr=this.instance3DBooleanAttr,e.nbInstances=this.nbInstances,e._instancingInfos=this._instancingInfos,e._instancingMatrices=this._instancingMatrices,e},_compactHierarchy:function(e,t){if(!e.has(this)){e.add(this);var i=this.parents;this.parents=new Array(i.length);for(var r=0;r<i.length;r++)this.parents[r]=i[r];var n=this._occurrences;this._occurrences=new Array(n.length);for(r=0;r<n.length;r++){var s=n[r];this._occurrences[r]=s,s._compactChildrenArray(t)}this.mesh3js&&this.mesh3js._compactArrays(t)}},setFrustumCulled:function(e){var t,i;for(null!==this.mesh3js&&(this.mesh3js.frustumCulled=e),t=0;t<this._occurrences.length;t++)null!==(i=this._occurrences[t]).renderable&&(i.renderable.frustumCulled=e)},_setNoCullingBE:function(e){this.setFrustumCulled(!e)},_getNoCullingBE:function(){return null!==this.mesh3js&&!this.mesh3js.frustumCulled},clone:function(t){var i=new e.Mesh(this.mesh3js.geometry,this.mesh3js.material);!!t&&(this.mesh3js.geometry.boundingSphere&&(i.geometry.boundingSphere=this.mesh3js.geometry.boundingSphere.clone()),this.mesh3js.geometry.boundingBox&&(i.geometry.boundingBox=this.mesh3js.geometry.boundingBox.clone())),this.mesh3js.copyInstancingInfos(i),i.castShadow=this.mesh3js.castShadow,i.receiveShadow=this.mesh3js.receiveShadow;var r=new THREEDS.Nodes.Mesh(i,this.name);return this.getIsInstanceNode3D()&&r.setIsInstanceNode3D(!0),r},getNodeType:function(){return"InstancingNode3D"}})),l=1,h=2;return o.prototype.getHasExplicitBE=function(){return(this.instance3DBooleanAttr&l)>0},o.prototype.setHasExplicitBE=function(e){this.instance3DBooleanAttr=e?this.instance3DBooleanAttr|l:this.instance3DBooleanAttr&~l},o.prototype.getIsInstanceNode3D=function(){return(this.instance3DBooleanAttr&h)>0},o.prototype.setIsInstanceNode3D=function(e){this.instance3DBooleanAttr=e?this.instance3DBooleanAttr|h:this.instance3DBooleanAttr&~h},o.prototype.forceNoMeshInRAM=function(){var e,t,i=this.mesh3js.geometry;for(e=0;e<i.length;e++){if((t=i[e]).sharedBuffers)throw new Error("Cannot force no mesh in RAM on geometry with sharedBuffers");t.noMeshInRAM||(t.noMeshInRAM=!0,t.vertexBufferGPU&&t.clearMeshInRAM(!1))}},Object.defineProperty(o.prototype,"hasExplicitBE",{get:function(){return this.getHasExplicitBE()},set:function(e){this.setHasExplicitBE(e)}}),Object.defineProperty(o.prototype,"isInstanceNode3D",{get:function(){return this.getIsInstanceNode3D()},set:function(e){this.setIsInstanceNode3D(e)}}),UWA.namespace("THREEDS/Nodes/InstancingNode",o)}),define("Visualization/InstancingNode3D",["DS/Visualization/InstancingNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("Visualization/InstancingNode3D"),e});