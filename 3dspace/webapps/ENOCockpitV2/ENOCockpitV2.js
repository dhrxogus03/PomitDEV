define("DS/ENOCockpitV2/ENOCockpitV2",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/ENOCockpitV2/assets/nls/ENOCockpitV2.json","DS/WAfrAppManager/App","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/PADServices/utils/GlobalModelEvents","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/UIKIT/Modal","DS/UIKIT/Mask"],function(e,t,i,o,n,s,r,a,l,c){"use strict";return class extends i{constructor(e){super(e),this._blockUX=null,this._isSwitchInitated=!1,this._r2vLoadedCB=[],this._eno3dviewTokens=[],this.blockWidgetUX(),this._events()}_events(){s.subscribe({event:"ENO3DView/UnblockUX"},()=>{this.unblockWidgetUX()})}setUp(t){return require(["DS/PADServices/utils/PADTrackerManager"],e=>{const t=e.getPADTracker({eventCategory:"usage",eventAction:"ENXDISC_AP_version"});t.setEventData({eventLabel:"WAFR"}),t.trackPageEvent()}),new Promise(i=>{if(this.widget=widget,this.addChangeCtx(),t.sourceApp){this.view=t.sourceApp.view;var l=o.getLayout_options("frmWindow_opts");l&&l.viewerOptions&&l.viewerOptions.viewPanelConfig&&l.viewerOptions.viewPanelConfig.uiConfig&&this.view.getViewer().updateViewPanelUIConfiguration(l);var c=t.sourceApp.appMainDiv;t.sourceApp.appMainDiv||(c=widget.body.firstChild),t.sourceApp.dispose(),o.setSetting("enopad_webapis",!1),this.restoreENOCockpitApp(c),this.view&&this.view.getController&&this.view.getController()._enableElasticLoadingForTransition();const e=this.getExecutionContext().getTargetApp();"ENXDISC_AP"===e.options.id?(this._switchInProgress=!1,this._eno3dviewTokens.push(this.view.subscribe({event:"onRealAssetLoaded"},e=>{if(this._switchInProgress)e.callback();else{var t=this.getExecutionContext().switchApp("ENXDISC_AP","ENXDISC_RealAssets");this._switchInProgress=!0,t?t.then(()=>{e.callback()}).catch(t=>{console.error(t),e.callback()}):e.callback()}}))):"ENXDISC_RealAssets"===e.options.id&&(this._eno3dviewTokens.push(this.view.subscribe({event:"onRealAssetLoaded"},e=>{e.callback()})),this._eno3dviewTokens.push(this.view.subscribe({event:"onEndRootRemoved"},e=>{if(!e.fromTimeline&&!e.fromRefresh&&!e.fromWidgetLink){const e=this.view.getRoots();let t=!1;for(let i=0;i<e.length;++i)if(r.isTileSetNode(e[i])){t=!0;break}t||this.getExecutionContext().switchApp("ENXDISC_AP")}}))),t.done(),s.publish({event:"ENO3DView/UnblockUX"}),i()}else{this.view=this._executionContext.getComponent("Viewer"),this.widget.addEvent("onChangeFlexibleAssembliesSupport",function(e,t){o.setSetting(e,t)}.bind(this)),this.view&&this.view.getController&&!n.isCloud()&&!this.view.getController()._elasticLoadingGranted?this.widget.getPreference("enopad3dviewer_flexibleAssemblySupportActivated")||(this.widget.addPreference({name:"enopad3dviewer_flexibleAssemblySupportActivated",type:"boolean",defaultValue:!1,label:e.flexibleAssemblySupport,onchange:"onChangeFlexibleAssembliesSupport",value:void 0!==this.widget.getValue("enopad3dviewer_flexibleAssemblySupportActivated")&&this.widget.getValue("enopad3dviewer_flexibleAssemblySupportActivated")}),o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",this.widget.getValue("enopad3dviewer_flexibleAssemblySupportActivated"))):(this.widget.addPreference({name:"enopad3dviewer_flexibleAssemblySupportActivated",type:"hidden",defaultValue:!1,label:e.flexibleAssemblySupport,onchange:"onChangeFlexibleAssembliesSupport",value:!1}),o.setSetting("enopad3dviewer_flexibleAssemblySupportActivated",!1));var d=this.widget.getValue("X3DContentId");-1===this.widget.id.indexOf("preview")?this.widget.deleteValue("X3DContentId"):d&&setTimeout(function(){this.view.addRootNodesFromContent({json3DXContent:JSON.parse(d),dispatch:!1})}.bind(this),0),t.sourceApp&&"ENXDISC_AP"!==t.sourceApp.appId?"ENXDISC_RealAssets"===t.sourceApp.appId&&(this._eno3dviewTokens.push(this.view.subscribe({event:"onRealAssetLoaded"},e=>{e.callback()})),this._eno3dviewTokens.push(this.view.subscribe({event:"onEndRootRemoved"},e=>{if(!e.fromTimeline&&!e.fromRefresh&&!e.fromWidgetLink){const e=this.view.getRoots();let t=!1;for(let i=0;i<e.length;++i)if(r.isTileSetNode(e[i])){t=!0;break}t||this.getExecutionContext().switchApp("ENXDISC_AP")}}))):(this._switchInProgress=!1,this._eno3dviewTokens.push(this.view.subscribe({event:"onRealAssetLoaded"},e=>{if(this._switchInProgress)e.callback();else{var t=this.getExecutionContext().switchApp("ENXDISC_AP","ENXDISC_RealAssets");this._switchInProgress=!0,t?t.then(()=>{e.callback()}).catch(t=>{console.error(t),e.callback()}):e.callback()}}))),"undefined"==typeof widget||widget.getValue("showWelcomePanel")||s.publish({event:"ENO3DView/UnblockUX"}),this.view._appReady(),t.done(),i()}!0===this._hasASPRole()&&this._enableHybriddatasetLoading(),require(["DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/WebUAUtils/WebUAUtils"],function(e,t){t.setPanelHelpMode({immersiveFrame:this._executionContext.getComponent("Viewer").getFrameWindow().getImmersiveFrame()}),this._prefManager=a.getPreferenceManager({context:this.view}),this._tokenPrefMgr=[],this._prefManager&&(this._prefManager.removeAllPreferences(),this._prefManager.setUnitsPreferencesDisplayFlag(!0),this._prefManager.setDisplayPreferencesDisplayFlag(!0),this._prefManager.setPreferredPreferenceContainersOrder(["MeasurePreferences","SectionPreferences"]),e.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]}]).then(function(e){if(e&&e.repositories&&e.repositories.length){if(e.repositories[0].preferences&&1===e.repositories[0].preferences.length){const t="true"===e.repositories[0].preferences[0].value;this.view.getViewer().currentViewpoint.control.lockZ=t}if(e.repositories[1]&&e.repositories[1].preferences&&1===e.repositories[1].preferences.length){const t="Parallel"===e.repositories[1].preferences[0].value?1:0;this.view.getViewer().currentViewpoint.setProjectionType(t)}}}.bind(this)),this._tokenPrefMgr.push(this._prefManager.subscribe("com.ds.mep:onPrefUpdate",function(e){if(3===e.length&&e[1].preferences){const t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;++e)if("VisualizationRepository"===t.repositories[e].name||"FrameGeneral"===t.repositories[e].name){const i=t.repositories[e].preferences;for(let e=0;e<i.length;++e){if("Gravity"===i[e].name&&this.view&&this.view.getViewer()&&this.view.getViewer().currentViewpoint){const t="true"===i[e].value;this.view.getViewer().currentViewpoint.control.lockZ=t}if("ProjectionType"===i[e].name){const t="Parallel"===i[e].value?1:0;this.view.getViewer().currentViewpoint.setProjectionType(t)}}}}}.bind(this))))}.bind(this))})}dispose(e){return new Promise(t=>{console.log(e),t()})}onWillEnter(e){return console.log("ENOCockpitV2.onWillEnter called with ",e),new Promise((i,o)=>{-1!==["ENXDISC_AP","ENXDISC_RealAssets"].indexOf(e.options.id)?(require(["DS/PADServices/utils/PADTrackerManager"],t=>{var i=t.getPADTracker({eventCategory:"usage",eventAction:"transition-from"});i.setEventData({eventLabel:e.options.id}),i.trackPageEvent()}),i()):o(new Error(` ${t.transitionRejectedInV2}`))})}onWillLeave(e){return console.log("ENOCockpit onWillLeave called with ",e),new Promise((i,o)=>{if(-1!==["ENXDISC_AP","ENXDISC_RealAssets"].indexOf(e.options.id)){require(["DS/PADServices/utils/PADTrackerManager"],t=>{var i=t.getPADTracker({eventCategory:"usage",eventAction:"transition-to"});i.setEventData({eventLabel:e.options.id}),i.trackPageEvent()});for(let e=0;e<this._eno3dviewTokens.length;++e)this.view.unsubscribe(this._eno3dviewTokens[e]);i()}else o(new Error(` ${t.transitionRejectedInV2}`))})}onDestroy(){}restoreENOCockpitApp(){this.resetCommands(),this._setupPreferences(),this._setupCallbacks()}resetCommands(){}_setupPreferences(){}_setupCallbacks(){}_declineTransition(){return!1}_hasASPRole(){const e=o.getSetting("enopad3dviewer_roles");if(e)for(let t=0;t<e.length;++t)if("ASP"===e[t].id&&(!e[t].platforms||e[t].platforms&&e[t].platforms.indexOf(n.getPlatformId())>-1))return!0;return!1}_enableHybriddatasetLoading(){const e=o.getWebAPI_Options("navigate3D");-1===e.select_bo.indexOf("bo.vpmpointcloudidentifierext.v_pointcloudidentifier")&&(e.select_bo.push("bo.vpmpointcloudidentifierext.v_pointcloudidentifier"),o.setWebAPI_Options("navigate3D",e),o.setWebAPI_Options("volumeQuery",e))}_disableHybriddatasetLoading(){const e=o.getWebAPI_Options("navigate3D");if(-1!==e.select_bo.indexOf("bo.vpmpointcloudidentifierext.v_pointcloudidentifier")){const t=e.select_bo.indexOf("bo.vpmpointcloudidentifierext.v_pointcloudidentifier");e.select_bo.splice(t,1),o.setWebAPI_Options("navigate3D",e),o.setWebAPI_Options("volumeQuery",e)}}addChangeCtx(){!0===o.getSetting("authorizeChangeControl")&&require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext","DS/PADUtils/PADCommandProxy"],function(e,t){var i=this.view.getDOMElement("triptych").getMainPanelContainer();e.initialize2(i,t.appId(),"hide",o.getSetting("changeControlPosition"),function(i){this.debouncePrefSynchro=!1,this._proxy=t.create({events:{onPreferenceModification:function(e){"changeControlActivation"===e.name&&(this.debouncePrefSynchro=!0,this.widget.setValue(e.name,e.value),o.setSetting(e.name,e.value))}.bind(this)}});var n=o.getSetting("changeControlActivation");n=void 0!==this.widget.getValue("changeControlActivation")?this.widget.getBool("changeControlActivation"):i.isAuthoringContextVisible;var s="top-right";s=sessionStorage.getItem("changeControlPosition3DNavigation")?sessionStorage.getItem("changeControlPosition3DNavigation"):o.getSetting("changeControlPosition"),e.setPosition(s),this.widget.addPreference({name:"changeControlActivation",defaultValue:n,type:"boolean",label:"changeControlActivation_label",onchange:"onChangeControlUpdate"}),!0===n?(e.show(),this.widget.addPreference({name:"changeControlPosition",defaultValue:s,type:"list",label:"changeControlPosition_label",options:[{label:"top-right_label",value:"top-right"},{label:"top-left_label",value:"top-left"},{label:"bottom-left_label",value:"bottom-left"},{label:"bottom-right_label",value:"bottom-right"}]})):(e.hide(),this.widget.addPreference({name:"changeControlPosition",type:"hidden",defaultValue:s})),o.setSetting("changeControlActivation",n,!0),o.addEvent("onChangeControlActivation",this._onChangeControlActivation.bind(this)),e.addEvent&&e.addEvent("onAuthoringCtxVisible",function(e){o.setSetting("changeControlActivation",e.showAuthoringContext,!0),this._onChangeControlActivation(e.showAuthoringContext)}.bind(this)),o.addEvent("onChangeControlPosition",function(t){e.setPosition(t),sessionStorage.setItem("changeControlPosition3DNavigation",t)}),this.widget.addEvent("onChangeControlUpdate",function(e,t){var i="top-right";i=sessionStorage.getItem("changeControlPosition3DNavigation")?sessionStorage.getItem("changeControlPosition3DNavigation"):o.getSetting("changeControlPosition");var n=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");!1===t?(n.hide(),this.widget.addPreference({name:"changeControlPosition",type:"hidden",defaultValue:i})):(n.show(),this.widget.addPreference({name:"changeControlPosition",defaultValue:i,type:"list",label:"changeControlPosition_label",options:[{label:"top-right_label",value:"top-right"},{label:"top-left_label",value:"top-left"},{label:"bottom-left_label",value:"bottom-left"},{label:"bottom-right_label",value:"bottom-right"}]})),this.widget.dispatchEvent("onEdit")}.bind(this))}.bind(this))}.bind(this))}_onChangeControlActivation(e){var t=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");this.debouncePrefSynchro?this.debouncePrefSynchro=!1:this._proxy.preferenceModification({name:"changeControlActivation",value:e});var i="top-right";i=sessionStorage.getItem("changeControlPosition3DNavigation")?sessionStorage.getItem("changeControlPosition3DNavigation"):o.getSetting("changeControlPosition"),!0===e?(t.show(),this.widget.addPreference({name:"changeControlPosition",defaultValue:i,type:"list",label:"changeControlPosition_label",options:[{label:"top-right_label",value:"top-right"},{label:"top-left_label",value:"top-left"},{label:"bottom-left_label",value:"bottom-left"},{label:"bottom-right_label",value:"bottom-right"}]})):(t.hide(),this.widget.addPreference({name:"changeControlPosition",type:"hidden",defaultValue:i}))}blockWidgetUX(){return this._DEBUG&&console.log("ENO3DNavigateAppDefinitionComponent.blockWidgetUX called"),new Promise((e,i)=>{try{c.mask(document.body,t.maskApplicationLoading),e()}catch(e){i(e)}})}unblockWidgetUX(){return this._DEBUG&&console.log("ENO3DNavigateAppDefinitionComponent.unblockWidgetUX called"),new Promise(e=>{c.unmask(document.body),e()})}}});