define("DS/CAT3DWText/CAT3DWTextCommonConstants",[],function(){"use strict";return{defaultTextPadding:{top:0,bottom:0,left:2,right:2},defaultTextWithBackgroundColorPadding:{top:5,bottom:5,left:10,right:10},defaultTextWidth:330,defaultStickyNoteWidth:180,defaultStickyNoteHeight:180,defaultStickyNoteScaleFactor:.4,defaultTextScaleFactor:1}}),define("DS/CAT3DWText/CAT3DWTextArea",["UWA/Core","DS/CAT3DWInfraUI/CAT3DWPointerEvents","css!DS/CAT3DWText/CAT3DWText"],function(t,e){"use strict";var i=t.Class.extend({init:function(){this._mainContainer=new t.Element("div",{class:"CAT3DWTextArea-Container"}),this._autoresizeFlag=!0,this._moveable=!1,this._scaleTextStep=.1,this._defaultFontSize=22,this._defaultLineHeight=30},createTextarea:function(){return this._textarea=document.createElement("textarea"),this._textarea.classList.add("CAT3DWTextArea"),this._textarea.autofocus=!0,this._onChangeCB=this._onChange.bind(this),this._onPasteCB=this._onPaste.bind(this),this._textarea.addEventListener("paste",this._onPasteCB),this._textarea.addEventListener("input",this._onChangeCB),this._mainContainer.appendChild(this._textarea),this._resizeManipulator=new t.Element("div",{class:"CAT3DWTextArea-ResizeManipulator CAT3DSKButton-container",html:[{tag:"span",class:"ResizeManipulator-icon  CAT3DSKButton-icon fonticon fonticon-double-arrow-horizontal "}]}).inject(this._mainContainer),this._moveManipulator=new t.Element("div",{class:"CAT3DWTextArea-MoveManipulator CAT3DSKButton-container",html:[{tag:"span",class:"MoveManipulator-icon CAT3DSKButton-icon fonticon fonticon-arrow-double-combo "}]}).inject(this._mainContainer),this._onManipulateCB=this._onManipulate.bind(this),this._onBeginManipulateCB=this._onBeginManipulate.bind(this),this._onEndManipulateCB=this._onEndManipulate.bind(this),this._onBeginMoveCB=this._onBeginMove.bind(this),document.addEventListener(e.POINTERMOVE,this._onManipulateCB),this._resizeManipulator.addEventListener(e.POINTERDOWN,this._onBeginManipulateCB),this._moveManipulator.addEventListener(e.POINTERDOWN,this._onBeginMoveCB),document.addEventListener(e.POINTERUP,this._onEndManipulateCB),this._mainContainer},setOnMoveCB:function(t){this._onMoveTextAreaCB=t},focus:function(){this._textarea.focus()},getContainer:function(){return this._mainContainer},getTextArea:function(){return this._textarea},getRawText:function(){return this._textarea.value},getDimensions:function(){return{width:this._textarea.offsetWidth,height:this._textarea.offsetHeight}},getFontSize:function(){let t=this._textarea.style.fontSize.replace("px","");return Number(t)},getLineHeight:function(){let t=this._textarea.style.lineHeight.replace("px","");return Number(t)},_getContainerPosition:function(){let t=this.getContainer().style.left.replace("px",""),e=this.getContainer().style.top.replace("px","");return{x:Number(t),y:Number(e)}},getTopLeftCorner:function(){let t=this._textarea.getBoundingClientRect(),e=this._mainContainer.style.transform,i=0,n=0;return e&&(e=(e=e.replace("rotate(","")).replace("deg)",""),(e=(e=parseFloat(e))*Math.PI/180)<0?i=Math.sin(-1*e)*this._textarea.offsetWidth:n=Math.sin(e)*this._textarea.offsetHeight),{x:t.x+n,y:t.y+i}},setProperties:function(t){t&&(void 0!==t.autoresize&&(this._autoresizeFlag=t.autoresize),this._autoresizeFlag||(this._resizeManipulator.style.display="none"),void 0!==t.moveable&&(this._moveable=t.moveable),this._moveable||(this._moveManipulator.style.visibility="hidden"),t.placeholder&&(this._textarea.placeholder=t.placeholder),t.cols&&(this._textarea.cols=t.cols),t.rows&&(this._textarea.rows=t.rows),t.text&&(this._textarea.value=t.text),t.fontSize&&(this._textarea.style.fontSize=t.fontSize+"px"),t.lineHeight&&(this._textarea.style.lineHeight=t.lineHeight+"px"),t.padding&&(this._textarea.style.paddingLeft=t.padding.left+"px",this._textarea.style.paddingRight=t.padding.right+"px",this._textarea.style.paddingBottom=t.padding.bottom+"px",this._textarea.style.paddingTop=t.padding.top+"px"),t.angle&&(this._mainContainer.style.transform="rotate("+t.angle+"deg)"),t.backgroundColor&&(this._textarea.style.backgroundColor=t.backgroundColor),t.clearBackgroundColor&&(this._textarea.style.backgroundColor=""),t.color&&(this._textarea.style.color=t.color),t.width&&(this._textarea.style.width=t.width+"px"),t.height&&(this._textarea.style.height=t.height+"px"),t.borderColor&&(this._textarea.style.borderColor=t.borderColor),t.fontStyle&&(this._textarea.style.fontStyle=t.fontStyle),t.fontWeight&&(this._textarea.style.fontWeight=t.fontWeight),t.textAlign&&(this._textarea.style.textAlign=t.textAlign),t.fontFamily&&(this._textarea.style.fontFamily=t.fontFamily),t.scale&&(this._mainContainer.style.scale=t.scale))},isEmpty:function(){return""===this.getRawText()},fitToContent:function(){this._autoResizeHeight=!0,this.autoResizeHeight()},fitToContainer:function(){this._textarea.scrollHeight>this._textarea.clientHeight?(this._scaleText(1-this._scaleTextStep),this.fitToContainer()):this._textarea.scrollHeight===this._textarea.clientHeight&&this.getFontSize()!==this._defaultFontSize&&(this._scaleText(1+this._scaleTextStep),this._textarea.scrollHeight>this._textarea.clientHeight?this._scaleText(1-this._scaleTextStep):this.fitToContainer())},_onChange:function(){this._autoresizeFlag?this.fitToContent():this.fitToContainer()},_onBeginManipulate:function(t){t.preventDefault(),this._autoresizeFlag&&(this._autoResizeHeight=!0,this._manipulate=!0,this._lastManipulatorPos={x:t.clientX,y:t.clientY},this._lastTextAreaDimensions=this.getDimensions())},_onBeginMove:function(t){t.preventDefault(),this._moveable&&(this._move=!0,this._lastMoveBtnPos={x:t.clientX,y:t.clientY},this._lastContainerPos=this._getContainerPosition())},_onManipulate:function(t){if(this._manipulate&&this._autoresizeFlag){this._textarea.disabled="disabled",this._textarea.blur();let e=t.clientX-this._lastManipulatorPos.x,i=t.clientY-this._lastManipulatorPos.y,n=parseFloat(this._mainContainer.style.scale),a=null,o=null;o=i,a=e;let s=this._lastTextAreaDimensions.width+a/n,r=this._lastTextAreaDimensions.height+o/n;this._textarea.style.height=r+"px",this._textarea.style.width=s+"px"}else if(this._move){this._textarea.disabled="disabled",this._textarea.blur();let e=t.clientX-this._lastMoveBtnPos.x,i=t.clientY-this._lastMoveBtnPos.y,n=this._lastContainerPos.x+e,a=this._lastContainerPos.y+i;this.getContainer().setStyle("left",n+"px"),this.getContainer().setStyle("top",a+"px")}},_onEndManipulate:function(){this._textarea.disabled="",this.focus(),this._manipulate&&this._autoresizeFlag?(this._manipulate=!1,this.autoResizeHeight()):this._move&&(this._move=!1,this._onMoveTextAreaCB&&this._onMoveTextAreaCB())},_onPaste:function(){this._autoresizeFlag&&setTimeout(function(){this.autoResizeWidth(),this.fitToContent()}.bind(this),10)},autoResizeWidth:function(){if(this._autoresizeFlag)for(;this._isNotInViewport(this._textarea);){let t=this._textarea.getBoundingClientRect();if(t.width>=window.innerWidth/2)break;this._textarea.style.width=1.5*t.width+"px",this.fitToContent()}},autoResizeHeight:function(){this._autoresizeFlag&&this._autoResizeHeight&&(this._textarea.style.height="auto",this._textarea.style.height=this._textarea.scrollHeight+"px",this._autoResizeHeight=!1)},_isNotInViewport:function(t){let e=t.getBoundingClientRect();return!(e.top>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight))},_scaleText:function(t){let e=this.getFontSize(),i=Math.round(e*t);i>this._defaultFontSize&&(i=this._defaultFontSize);let n=this.getLineHeight(),a=Math.round(n*t);a>this._defaultLineHeight&&(a=this._defaultLineHeight),this._textarea.style.fontSize=i+"px",this._textarea.style.lineHeight=a+"px"},unsubscribeAllTextInputEvents:function(){this._textarea.removeEventListener("input",this._onChangeCB),this._textarea.removeEventListener("paste",this._onPasteCB),this._onPasteCB=null,this._onChangeCB=null,this._resizeManipulator.removeEventListener(e.POINTERDOWN,this._onBeginManipulateCB),this._moveManipulator.removeEventListener(e.POINTERDOWN,this._onBeginMoveCB),document.removeEventListener(e.POINTERMOVE,this._onManipulateCB),document.removeEventListener(e.POINTERUP,this._onEndManipulateCB),this._onBeginManipulateCB=null,this._onManipulateCB=null,this._onEndManipulateCB=null,this._onMoveTextAreaCB=null},destroy:function(){this.unsubscribeAllTextInputEvents(),this._mainContainer&&this._mainContainer.destroy(),this._mainContainer=null}});return t.namespace("DS/CAT3DWText/CAT3DWTextArea",i)}),define("DS/CAT3DWText/CAT3DWTextRenderService",["UWA/Class","UWA/Core","DS/CAT3DWInfraUI/CAT3DWCanvasServices","WebappsUtils/WebappsUtils","DS/CAT3DWInfra/CAT3DWPreferenceManager"],function(t,e,i,n,a){"use strict";var o=t.extend({init:function(){this._parent()},loadTextboxFont:function(){return new Promise(function(t){var e=[{name:"GochiHand",src:"GochiHand-Regular.ttf"},{name:"Alphabet Caps Lined",src:"AlphabetCapsLined.woff2"},{name:"dsbold",src:"3dsBold.woff2"},{name:"dslight",src:"3dslight.woff2"},{name:"Alex Brush",src:"AlexBrush-Regular.woff2"},{name:"AmaticSC",src:"AmaticSC-Regular.ttf"},{name:"Archicoco",src:"Archicoco.woff2"},{name:"Archivo Narrow",src:"ArchivoNarrow-Regular.woff2"},{name:"Arimo",src:"Arimo-Regular.woff2"},{name:"Barrio",src:"Barrio-Regular.woff2"},{name:"Bebas Neue",src:"BebasNeue.woff2"},{name:"Beon",src:"Beon-Regular.woff2"},{name:"Carpathe",src:"CarpatheRegular.woff2"},{name:"Cooper Hewitt",src:"CooperHewitt-Light.woff2"},{name:"Crass Roots Ofl",src:"CRASS-ROOTS-OFL.woff2"},{name:"Datalegreya Gradient",src:"Datalegreya-Gradient.woff2"},{name:"Fantasque",src:"FantasqueSansMono-Regular.woff2"},{name:"Fira Mono",src:"FiraMono-Regular.woff2"},{name:"Genome",src:"Genome-Thin.woff2"},{name:"Gnu TypeWriter",src:"gtw.woff2"},{name:"Hussar Print",src:"HussarPrintA.woff2"},{name:"LedFont sharP",src:"ledfont-sharp-Regular.woff2"},{name:"Lindbergh Baby",src:"Lindbergh_Baby.woff2"},{name:"Marapfhont",src:"Marapfhont.woff2"},{name:"Monodeco",src:"Monodeco.woff2"},{name:"Montserrat",src:"Montserrat-Regular.woff2"},{name:"Now",src:"Now-Regular.woff2"},{name:"Pinyon Script",src:"PinyonScript-Regular.woff2"},{name:"Raleway",src:"Raleway-Regular.woff2"},{name:"Roundstyle",src:"RoundStyleBasic.woff2"},{name:"Some Time Later",src:"SomeTimeLater.woff2"},{name:"Unique",src:"Unique.woff2"},{name:"Xolonium",src:"Xolonium-Regular.woff2"}],i=[];for(let t=0;t<e.length;t++)i.push(this._loadFont(e[t]));Promise.all(i).then(function(){t()})}.bind(this))},_loadFont:function(t){return new Promise(function(i){var o=n.getWebappsAssetUrl("CAT3DWText","fonts/"+t.src),s=null;if(a.getPreferenceValue("M3DEMobile")){var r=e.Data.proxifyUrl(o,{proxy:"passport"});s=new FontFace(t.name,"url("+r+') format("woff2")')}else s=new FontFace(t.name,"url("+o+') format("woff2")');s.load().then(function(){document.fonts.add(s),i()}).catch(function(){console.error("failed to load font : "+t.name),i()})})},renderTextToCanvas:function(t){return new Promise(function(e){var n=(new i).createCanvas({width:t.width*t.scale,height:t.height*t.scale,tag:"textCanvas"});let a=n.getContext("2d");if(t.backgroundColor?(a.fillStyle=t.backgroundColor,a.strokeStyle=t.backgroundColor,a.roundRect(0,0,n.width,n.height,10),a.fill()):(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=1*window.devicePixelRatio,a.shadowColor="white"),t.borderColor){let e=5;a.beginPath(),a.strokeStyle=t.borderColor,a.lineWidth=e,a.roundRect(e/2,e/2,n.width-e,n.height-e,10),a.stroke()}a.textBaseline="top";let o=t.fontStyle+" ";o+=t.fontWeight+" ",o+=t.fontSize*t.scale+"px ",o+=t.fontFamily,a.font=o,a.fillStyle=t.color||"black",a.strokeStyle=t.color||"black",a.textAlign=t.textAlign;var s=n.width-t.padding.left*t.scale-t.padding.right*t.scale,r=t.lineHeight*t.scale,l=0;"left"===t.textAlign?l=t.padding.left*t.scale:"center"===t.textAlign?l=n.width/2:"right"===t.textAlign&&(l=n.width-t.padding.right*t.scale);var h=r/(6.5*window.devicePixelRatio)+t.padding.top*t.scale,d=t.text.split(" "),u="";for(let t=0;t<d.length;t++){let e=d[t];if(-1!==e.indexOf("\n")){let t=this._drawWordWithLineBreak(e,a,s,r,l,h,u);u=t.addtxt,h=t.y_pos}else{let t=this._drawWord(e,a,s,r,l,h,u);u=t.addtxt,h=t.y_pos}}a.fillText(u,l,h),e(n)}.bind(this))},_drawWord:function(t,e,i,n,a,o,s){var r=s,l=o;let h=r+t,d=e.measureText(h).width,u=e.measureText(t).width;if(d>i)if(-1!==t.indexOf("-")){let o=this._drawWordWidthSpecialChar("-",t,e,i,n,a,l,r);r=o.addtxt,l=o.y_pos}else if(u>i){let o=this._drawLongWord(t,e,i,n,a,l,r," ");r=o.addtxt,l=o.y_pos}else e.fillText(r,a,l),r=t+" ",l+=n;else r=h+" ";return{addtxt:r,y_pos:l}},_drawWordWidthSpecialChar:function(t,e,i,n,a,o,s,r){var l=r,h=s;let d=e.split(t);for(let e=0;e<d.length;e++){let s=e===d.length-1?" ":t,r=d[e],u=l+r+s,f=i.measureText(u).width,c=i.measureText(r).width;if(f>n)if(c>n){i.fillText(l,o,h),l="",h+=a;let t=this._drawLongWord(r,i,n,a,o,h,l,s);l=t.addtxt,h=t.y_pos}else i.fillText(l,o,h),l=r+s,h+=a;else l=u}return{addtxt:l,y_pos:h}},_drawLongWord:function(t,e,i,n,a,o,s,r){var l=s,h=o;let d=Array.from(t);for(let t=0;t<d.length;t++){let o=d[t],s=t===d.length-1?r:"",u=l+o;e.measureText(u).width>i?(e.fillText(l,a,h),l=o+s,h+=n):l=u+s}return{addtxt:l,y_pos:h}},_drawWordWithLineBreak:function(t,e,i,n,a,o,s){var r=s,l=o;let h=t.split("\n");for(let t=0;t<h.length;t++){let o=h[t],s=this._drawWord(o,e,i,n,a,l,r);r=s.addtxt,l=s.y_pos,t===h.length-1?r+="":(e.fillText(r,a,l),r="",l+=n)}return{addtxt:r,y_pos:l}}});return e.namespace("DS/CAT3DWText/CAT3DWTextRenderService",o)});