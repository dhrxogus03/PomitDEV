/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationCommands/CAT3DAnnotationOpenFavoriteCtxCmd",["DS/CATWebUXComponents/DMUStateCommand","DS/Visualization/PathElement","DS/StateCommandEngine/PathElementAgent","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CoreEvents/Events"],function(e,t,n,i,r,o,a,l,s){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0});var c,u,g,f=this,d=function(){u&&(i.empty(),r.empty())},A=function(){o.get().getViewer().setDefaultPicking(!0),g&&g()},p=function(e){if(!e||!e.externalPath||!e.externalPath.length||"RootBag"!==e.externalPath[0].name)return!1;for(var n=e.externalPath.length-1;n>=0;--n){var i=e.externalPath[n];if(l.isPLMNode(i))return!!l.is3DLeaf(i)&&new t(e.externalPath.slice(0,n+1))}},C=function(e){setTimeout(function(){if(c&&c.object3D&&1===c.object3D.length){r.empty();var t=a.giveFavoriteContextManager({context:o.get()});g=t.manageFavoriteContext({path:p(c.object3D[0].pathElement),onComplete:function(){g=null,A(),o.get().getExecutionContext&&s.publish({event:f.getId()+"/END",data:f}),e()}}).cancel}},0)};this.buildGraph=function(){var e=o.get();e.getViewer().setDefaultPicking(!1),u=!0,g=null,c=new n({agentId:"CATFavoriteContextSelAgt",frameWindow:this.options.executionContext?void 0:e.getFrameWindow(),viewer:this.options.executionContext?e.getFrameWindow().getViewer():void 0,engWithPSOHSO:!0,withPSO:!0,withHSO:!0,valuedFromCSO:!0,saveToCSO:!1,pickingMode:"rep",prePickingMode:"rep",pickingFilter:p,prePickingFilter:p});var t=this.createInitialState("InitState"),i=this.getFinalState();this.addTransition({iInitialState:t,iFinalState:i,iEvent:c,iAction:C}),this.addTransition({iInitialState:t,iFinalState:i,iCondition:function(){var t=l.getRoots(e);if(t&&1===t.length&&t[0]&&l.is3DLeaf(t[0])){var n=e.getRootBagPath();return n.addElement(t[0]),c.object3D.push({pathElement:n}),!0}},iAction:C}),setTimeout(d)},this.cancelExecute=function(){A(),this.cancel()}}})}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmdV2",["DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext"],function(e,t){"use strict";return class{constructor(){this.beginExecute=function(){var n=t.get(),i=e.getDataLauncherController({context:n});i&&i.setActiveState(!0)},this.destroy=function(){var n=t.get(),i=e.giveDataLauncherController({context:n});i&&i.setActiveState(!1)},this.pauseExecute=function(){var n=t.get(),i=e.giveDataLauncherController({context:n});i&&i.setActiveState(!1),this.done()},this.resumeExecute=function(){var n=t.get(),i=e.giveDataLauncherController({context:n});i&&i.setActiveState(!0),this.done()}}}}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationInitializerComponent",["DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/PADUtils/PADContext","DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/CATWebUXUtils"],function(e,t,n,i,r,o,a,l,s){"use strict";return class{constructor(c){var u,g,f;let d,A,p=null,C={},h=!1,D="Perspective",m=!1,v="selectParentReference",S=function(e,t){var i=[],o=[],a=[];if(u._defaultContextualMenuVisibility&&void 0!==e&&void 0!==e.XmousePositionWithDevPxRatio&&void 0!==e.YmousePositionWithDevPxRatio&&u.getViewer()){var l=r.get(),c=t?{x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio}:{x:e.XmousePositionWithDevPxRatio,y:e.YmousePositionWithDevPxRatio};if(0===u.getViewer().pick({xPix:c.x,yPix:c.y},"mesh",!0).path.length)a.push({category:"Display",hdrs:s.isMobile()?["ENO3DToggleStatusBarCmd"]:["VisuQMCommand","ENO3DToggleStatusBarCmd"]},{category:"Ambience",hdrs:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]});else if(l.length){let e=!1;for(let t=0;t<l.length;t++)for(var g=0;g<l[t].pathElement.externalPath.length;g++)l[t].pathElement.externalPath[g].getDMUType&&(e=!0);if(!e){o.push("ENO3DFocusOnCmd"),o.push("ENO3DReframeOnCmd");let e=!u.getController().isRootSupported||l.length>=1&&l[0].pathElement.externalPath.length>=2&&u.getController().isRootSupported(n.getNodeID(l[0].pathElement.externalPath[1]));o.push("ENO3DHideShowCmd"),o.push("ActionBar_Attributes"),e&&a.push({category:"Geometry Quality",hdrs:["OptimizedQualityCmd","HighQualityCmd"]})}}for(let e=0;e<o.length;e++)"ENO3DToggleStatusBarCmd"===o[e]?i.push({type:"WAfrCheckHandlerItem",handlerId:o[e]}):i.push({type:"WAfrDefaultHandlerItem",handlerId:o[e]});return a.forEach(e=>{let t={type:"PushItem",title:e.category,submenu:[]};for(let n=0;n<e.hdrs.length;n++)"ENO3DToggleStatusBarCmd"===e.hdrs[n]?t.submenu.push({type:"WAfrCheckHandlerItem",handlerId:e.hdrs[n]}):t.submenu.push({type:"WAfrDefaultHandlerItem",handlerId:e.hdrs[n]});i.push(t)}),i}return i};this.initialize=function(){return new Promise(n=>{u=i.get(),g=o.getPreferenceManager({context:u.getFrameWindow()});var r=a.getSelectionManager({context:u});r.setActiveState(!0),d={activated:u.getViewer().picking.activated,trapSelection:u.getViewer().picking.trapSelection,trapGPU:u.getViewer().picking.trapGPU},A={activated:u.getViewer().pPicking.activated},g.setUnitsPreferencesDisplayFlag(!0),g.setDisplayPreferencesDisplayFlag(!0),g.set3DSelectionPreferencesDisplayFlag(!0),g.setMeasurePreferencesDisplayFlag(!0),g.setClippingPreferencesDisplayFlag(!0),t.initPrefManager({context:u.getFrameWindow()}).then(()=>{u&&(g&&(p=g.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)for(let n=0;n<t.repositories[e].preferences.length;n++)"SelectParentReferenceOr3DShape"===t.repositories[e].preferences[n].name?(C.selectParentReferenceOr3DShape=t.repositories[e].preferences[n].value,v=C.selectParentReferenceOr3DShape):"Select3DGeometry"===t.repositories[e].preferences[n].name?(C.select3DGeometry="true"===t.repositories[e].preferences[n].value,m=C.select3DGeometry):"ProjectionType"===t.repositories[e].preferences[n].name?(C.projectionType=t.repositories[e].preferences[n].value,D=C.projectionType):"Gravity"===t.repositories[e].preferences[n].name&&(C.gravity="true"===t.repositories[e].preferences[n].value,h=C.gravity);if(u&&u.getViewer()&&u.getViewer().currentViewpoint&&u.getViewer().currentViewpoint.control){let e=C.gravity?C.gravity:h;u.getViewer().currentViewpoint.getControl().setRotationRolling(!e),u.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e)}if(u&&u.getViewer()&&u.getViewer().currentViewpoint&&u.getViewer().currentViewpoint.setProjectionType("Perspective"===(C.projectionType?C.projectionType:D)?0:1),r){let e=C.select3DGeometry?C.select3DGeometry:m;r.setPicking(e?0:1)}if(r){let e=C.selectParentReferenceOr3DShape?C.selectParentReferenceOr3DShape:v;r.selectParentReference("select3DShape"!==e)}})),l.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]}]).then(e=>{if(!u)return;let t=e.repositories;for(let e=0;e<t.length;e++)if("VisualizationRepository"===t[e].name)h="true"===t[e].preferences[0].value;else if("FrameGeneral"===t[e].name)D=t[e].preferences[0].value;else if("SelectionRepository"===t[e].name){let n=t[e].preferences;for(let e=0;e<n.length;e++)"Select3DGeometry"===n[e].name?m="true"===n[e].value:"SelectParentReferenceOr3DShape"===n[e].name&&(v=n[e].value)}"boolean"==typeof h&&(u.getViewer().currentViewpoint.getControl().setRotationRolling(!h),u.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!h)),"Perspective"!==D&&"Parallel"!==D||u.getViewer().currentViewpoint.setProjectionType("Perspective"===D?0:1),r&&r.setPicking(m?0:1),r&&r.selectParentReference("select3DShape"!==v)}).catch(e=>{"boolean"==typeof h&&(u.getViewer().currentViewpoint.getControl().setRotationRolling(!h),u.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!h)),"Perspective"!==D&&"Parallel"!==D||u.getViewer().currentViewpoint.setProjectionType("Perspective"===D?0:1),r&&r.setPicking(m?0:1),r&&r.selectParentReference("select3DShape"!==v),window.console.warn("Could not get server value, default value set instead.",e)}),require([c.controller||"DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"],function(n){var i=new n({ctxViewer:u});if(i.setActiveState(!0),e.registerAnnotationController({annotController:i,context:u}),g){var r=t.getPreferenceDefinitions({attributePrefs:void 0!==c.controller});f=r[0].id,g.addPreferences(r),g.setPreferredPreferenceContainersOrder([f,"MeasurePreferences"])}}),u.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"CATAnnotationsContextMenu",context:u.getCommandContext(),merge:!0,onContextualMenuReady:S}),u.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),u.getViewer().setPrePicking({activated:!0}),n())})})},this.clean=function(){return new Promise(n=>{u=i.get(),e.unreferenceAnnotationController({context:u}),g&&(g.removePreferences([f]),p&&(g.unsubscribe(p),p=null)),a.unreferenceSelectionManager({context:u}),u.getViewer().setPicking(d),u.getViewer().setPrePicking(A),f=g=null,t.cleanPrefManager(),o.unreferencePreferenceManager({context:u.getFrameWindow()}),u=null,n()})},this.destroy=function(){return new Promise(e=>{e()})},this.canBeParallelized=function(){return!1}}}}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd",["DS/CATWebUXComponents/DMUCommand","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,n,i,r,o,a,l){"use strict";return e.extend({init:function(e){var s=e||{};this._parent(s,{mode:"exclusive",isAsynchronous:!0});var c=r.get(),u=this,g=t.giveDataLauncherController({context:c}),f=a.getSelectionManager({context:c});f.setActiveState(!0);var d,A=o.getPreferenceManager({context:c.getFrameWindow()});let p=null,C={},h=!1,D="Perspective",m=!1,v="selectParentReference",S={activated:c.getViewer().picking.activated,trapSelection:c.getViewer().picking.trapSelection,trapGPU:c.getViewer().picking.trapGPU},P={activated:c.getViewer().pPicking.activated};A.setUnitsPreferencesDisplayFlag(!0),A.setDisplayPreferencesDisplayFlag(!0),A.set3DSelectionPreferencesDisplayFlag(!0),A.setMeasurePreferencesDisplayFlag(!0),A.setClippingPreferencesDisplayFlag(!0),i.initPrefManager({context:c.getFrameWindow()}).then(()=>{c&&(A&&(p=A.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)for(let n=0;n<t.repositories[e].preferences.length;n++)"SelectParentReferenceOr3DShape"===t.repositories[e].preferences[n].name?(C.selectParentReferenceOr3DShape=t.repositories[e].preferences[n].value,v=C.selectParentReferenceOr3DShape):"Select3DGeometry"===t.repositories[e].preferences[n].name?(C.select3DGeometry="true"===t.repositories[e].preferences[n].value,m=C.select3DGeometry):"ProjectionType"===t.repositories[e].preferences[n].name?(C.projectionType=t.repositories[e].preferences[n].value,D=C.projectionType):"Gravity"===t.repositories[e].preferences[n].name&&(C.gravity="true"===t.repositories[e].preferences[n].value,h=C.gravity);if(c&&c.getViewer()&&c.getViewer().currentViewpoint&&c.getViewer().currentViewpoint.control){let e=C.gravity?C.gravity:h;c.getViewer().currentViewpoint.getControl().setRotationRolling(!e),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!e)}if(c&&c.getViewer()&&c.getViewer().currentViewpoint&&c.getViewer().currentViewpoint.setProjectionType("Perspective"===(C.projectionType?C.projectionType:D)?0:1),f){let e=C.select3DGeometry?C.select3DGeometry:m;f.setPicking(e?0:1)}if(f){let e=C.selectParentReferenceOr3DShape?C.selectParentReferenceOr3DShape:v;f.selectParentReference("select3DShape"!==e)}})),l.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]}]).then(e=>{if(!c)return;let t=e.repositories;for(let e=0;e<t.length;e++)if("VisualizationRepository"===t[e].name)h="true"===t[e].preferences[0].value;else if("FrameGeneral"===t[e].name)D=t[e].preferences[0].value;else if("SelectionRepository"===t[e].name){let n=t[e].preferences;for(let e=0;e<n.length;e++)"Select3DGeometry"===n[e].name?m="true"===n[e].value:"SelectParentReferenceOr3DShape"===n[e].name&&(v=n[e].value)}"boolean"==typeof h&&(c.getViewer().currentViewpoint.getControl().setRotationRolling(!h),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!h)),"Perspective"!==D&&"Parallel"!==D||c.getViewer().currentViewpoint.setProjectionType("Perspective"===D?0:1),f&&f.setPicking(m?0:1),f&&f.selectParentReference("select3DShape"!==v)}).catch(e=>{"boolean"==typeof h&&(c.getViewer().currentViewpoint.getControl().setRotationRolling(!h),c.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!h)),"Perspective"!==D&&"Parallel"!==D||c.getViewer().currentViewpoint.setProjectionType("Perspective"===D?0:1),f&&f.setPicking(m?0:1),f&&f.selectParentReference("select3DShape"!==v),window.console.warn("Could not get server value, default value set instead.",e)}),require([s.annotControllerLib||"DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"],function(e){var t=new e({ctxViewer:c});if(t.setActiveState(!0),n.registerAnnotationController({annotController:t,context:c}),A){var r=i.getPreferenceDefinitions({attributePrefs:void 0!==s.annotControllerLib});d=r[0].id,A.addPreferences(r),A.setPreferredPreferenceContainersOrder([d,"MeasurePreferences"])}}),c.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),c.getViewer().setPrePicking({activated:!0}))}),this.beginExecute=function(){g&&g.setActiveState(!0)},this._endExecute=function(){g&&g.setActiveState(!1)},this.destroy=function(){this._endExecute()},this.pauseExecute=function(){g&&g.setActiveState(!1),this.done()},this.resumeExecute=function(){g&&g.setActiveState(!0),this.done()};var b=this._destroy;this._destroy=function(){b.call(u),n.unreferenceAnnotationController({context:c}),A&&(A.removePreferences([d]),p&&(A.unsubscribe(p),p=null)),a.unreferenceSelectionManager({context:c}),c.getViewer().setPicking(S),c.getViewer().setPrePicking(P),d=A=null,i.cleanPrefManager(),o.unreferencePreferenceManager({context:c.getFrameWindow()}),u=c=g=null}}})}),define("DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationPanels/CAT3DAnnotationFilterPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/DMUCommandsManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController"],function(e,t,n,i,r,o,a,l,s,c){"use strict";var u=e.extend({init:function(e){var u=e||{};this._parent(u);var g,f,d,A,p,C,h=l.getOption("CAT3DANN_FILTER_PANEL_VER1")?1:2,D=!1,m=!1,v=this,S=u.ctxViewer,P=200,b=!1,y=[],T=[],w=[],V={},F={},x={},R={},O=0,k=new t,W=!0,M=!1,E=0,U=0,L=150,I=0,_=!0,B=!1,G=!1,X=!1,N=function(e,t){return k.publish({event:e,data:t,context:this})},j=function(e){!B&&_&&D&&!G&&!X&&g.getActiveState()&&(e&&(M=e),E&&(clearTimeout(E),E=0),E=setTimeout(function(){v._internalRefresh(),L=150,E=0},L))},z=c.subscribe("onPreferenceModified",function(e){var t;if(-1!==e.preference.indexOf("CATWebUXMePreferences_SemanticAttribute_")){var n,i=e.preference.substring(e.preference.indexOf("e_")+2,e.preference.length),r=v.getAttributeTypesFiltered();for(t=0;t<T.length;t++)if(T[t].name===i){T[t].filteredByPref=!e.value,n=!0;break}n||T.push({name:i,filteredByPref:!e.value,filtered:!1});var o=v.getAttributeTypesFiltered();j();var a=o.length!==r.length;if(!a)for(t=0;t<o.length;t++)if(-1===r.indexOf(o[t])){a=!0;break}a&&N("onAttributesVisibilityModified",{attributesFiltered:o})}}),H=function(){for(var e=c.getPreference("3DAnnotAttributesOrderedList"),t=e.length-1;t>=0;t--)c.getPreference("CATWebUXMePreferences_SemanticAttribute_"+e[t])&&e.splice(t,1);return e},q=function(e){if(y&&y.length&&y[e[0]]){var t=y[e[0]];if(1===e.length)return t.path;if(t.children&&t.children[e[1]]){var n=t.children[e[1]];if(2===e.length)return n.path;if(n.path){var i=n.path.getChildrenPathes();if(i&&i.length&&i[e[2]]){var r=i[e[2]];if(3===e.length)return r;var o=i[e[2]].getChildrenPathes();if(o&&o.length&&o[e[3]])return o[e[3]]}}}}},J=function(e){D&&(U+=!0===e?1:-1,I&&(clearTimeout(I),I=0),A&&(A.setEnableFlag(U>=0),U<0&&(I=setTimeout(function(){D&&A&&A.setEnableFlag(!0),U=0},2e4))))},Q=function(e){E&&(clearTimeout(E),E=0),A&&(P=A.getWidth(),A.clean(),A=null),d&&d.cleanPanel(e)},Y=function(){if(sessionStorage)if("true"===sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id))sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"false"),A.setWidth(200);else{var e=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id));e&&200!==e&&(sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true"),A.setWidth(e))}},K=function(e){var t=q(e[0].idPath);w.push(o.getNodeID(t.getLastElement(!0))),f.loadFTAModel({path:t,loadChildren:!0}),A&&A.isSmallWidth()&&d&&"AnnotSetAll"===d.getCurrentAnnotationSetSection()&&A.collapsePanel()},Z=function(e){B=!0;for(var t=0;t<e.length;t++){var n=q(e[t].idPath);n&&n.getLastElement(!0).setVisibility(e[t].visuFlag)}A&&A.isSmallWidth()&&d&&"AnnotSetAll"===d.getCurrentAnnotationSetSection()&&A.collapsePanel(),S.getViewer().render(),B=!1},$=function(e){var t,n=!1,i=v.getAttributeTypesFiltered();for(t=0;t<e.length;t++){for(var r=null,o=0;o<T.length;o++)if(T[o].name===e[t].name){r=o;break}null!==r?T[r].filtered=!e[t].visuFlag:T.push({name:e[t].name,filtered:!e[t].visuFlag,filteredByPref:!1})}var a=v.getAttributeTypesFiltered();if(!(n=a.length!==i.length))for(t=0;t<a.length;t++)if(-1===i.indexOf(a[t])){n=!0;break}n&&N("onAttributesVisibilityModified",{attributesFiltered:a})};function ee(){if(d){var e=!1;S.getRootBagPath().getChildrenPathes().some(function(t){return S.getController().isLargeDataStructure(o.getNodeID(t.getLastElement(!0)))&&(e=!0),e}),d.setOptionsAvailableFlag({AnnotSetAll:!e})}}for(var te=function(e){if(d){if(e)for(var t=0;t<y.length;t++)for(var n=0;n<y[t].children.length;n++){var i=y[t].children[n].path.getLastElement(!0).toJSON();Object.assign(y[t].children[n],i)}d.updatePanel({model:y,attrTypesFilteredByPref:H(),attrTypesOrderedList:c.getPreference("3DAnnotAttributesOrderedList")})}},ne=H(),ie=0;ie<ne.length;ie++)T.push({name:ne[ie],filteredByPref:!0,filtered:!1});this._internalRefresh=function(){D&&v&&"function"==typeof p&&(M?(y.splice(0,y.length),A||function(){if(Q(),d||(d=new n({style:{version:h,semanticUI:"3DAnnotationInsight"===g.getAnnotationControllerType()}}),(R={}).onFilterPanelResized=d.subscribe("onFilterPanelResized",Y),R.onAnnotationSetsLoadingRequired=d.subscribe("onAnnotationSetsLoadingRequired",K),R.onAnnotationsVisibilityModified=d.subscribe("onAnnotationsVisibilityModified",Z),R.onAttributesVisibilityModified=d.subscribe("onAttributesVisibilityModified",$)),A)d.buildPanel(y);else{var e;"true"===sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id)&&(e=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id))),e||(e=void 0!==P?P:200),P=e;var t={id:"CAT3DAnnotFilterPanel",className:"CAT3DAnnotFilterSidePanel",showTitleFlag:!1,icon:"fonticon fonticon-annotationFilter CAT3DAnnotFilterIcon",frameWindow:S.getFrameWindow(),immersiveFrame:S.getFrameWindow().getImmersiveFrame(),closeButtonFlag:!1,viewerFrame:S.getFrameWindow().getViewerFrame(),content:d.buildPanel({model:y,attrTypesFilteredByPref:H(),attrTypesOrderedList:c.getPreference("3DAnnotAttributesOrderedList")}),minHeight:330,minWidth:200,width:e,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||(P=e.width,e.widthModifiedInteractively&&(sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true"),sessionStorage.setItem("CAT3DAnnotFilterWidth_"+widget.id,e.width)))}};A=new i(t)}ee(),A&&y&&A.setPanelVisibilityFlag(W&&0!==y.length),A.setEnableFlag(U>=0)}(),p(function(e){if(D){for(var t,n=(y=e).length-1;n>=0;n--)t=o.getNodeID(y[n].path.getLastElement(!0)),y[n].hasBeenEntirelyLoaded=-1!==w.indexOf(t),y[n].hasBeenEntirelyLoaded&&0===y[n].children.length&&y.splice(n,1);te(!1),A.setPanelVisibilityFlag(W&&0!==y.length),y.length&&A.setEnableFlag(U>=0)}})):(te(!0),A&&y&&A.setPanelVisibilityFlag(W&&0!==y.length)))},this.setActiveState=function(e){if(D=e,g&&f){var t;if(p||(p=g.onAdditionalInfosRequired({controller:"AnnotFilter"}).getJSONModel),U=0,D){if(!b){var n=function(){_=!0,j(!0)};G=!(g.getActiveState()&&f.getActiveState());var i=function(){g.getActiveState()&&f.getActiveState()?(G=!1,j(!0)):(Q(),G=!0)};V.onLoadingComplete=S.subscribe({event:"onLoadingComplete"},n),V.onLoadingFailure=S.subscribe({event:"onLoadingFailure"},n),V.onLoadingCanceled=S.subscribe({event:"onLoadingCanceled"},n),V.onRootAdded=S.subscribe({event:"onRootAdded"},ee),V.onRootRemoved=S.subscribe({event:"onRootRemoved"},function(){_=!0,L=0,j(!0)}),F.onAnnotControllerActiveStateChanged=g.subscribe("onAnnotControllerActiveStateChanged",i),F.onAnnotationsLinkedDataSolved=g.subscribe("onAnnotationsLinkedDataSolved",function(e){!0===e.succeeded&&j()}),x.onAnnotModelLoaderActiveStateChanged=f.subscribe("onAnnotModelLoaderActiveStateChanged",i),x.onAnnotationVisibilityModifiedToken=f.subscribe("onAnnotationVisibilityModified",function(e){j("tpsAnnotationSet"===e.node.getAnnotationClassType())}),x.onAnnotationSetLoadingFailedToken=f.subscribe("onAnnotationSetLoadingFailed",function(){_=!0,J(!0),j(!0)}),x.onAnnotationSetLoadedToken=f.subscribe("onAnnotationSetLoaded",function(){_=!0,J(!0),j(!0)}),x.onAnnotationSetPartiallyLoaded=f.subscribe("onAnnotationSetPartiallyLoaded",function(){_=!0,J(!0),j(!0)}),x.onAnnotationSetRemovedToken=f.subscribe("onAnnotationSetRemoved",function(){_=!0,j(!0)}),x.onAnnotationSetBeginLoadToken=f.subscribe("onAnnotationSetBeginLoad",function(){_=!1,J(!1)}),x.onAnnotationSetLoadingCanceledToken=f.subscribe("onAnnotationSetLoadingCanceled",function(){_=!0,J(!0),j(!0)}),x.onNoAnnotationSetLoadedToken=f.subscribe("onNoAnnotationSetLoaded",function(e){e&&e.loadingAlreadyStarted&&(_=!0,J(!0)),j(!0)}),F.onViewOrCaptureDisplayedToken=g.subscribe("onViewOrCaptureDisplayed",function(){_=!0,j()}),x.onVisuModificationToken=f.subscribe("onAnnotationParentVisibilityModified",function(){j(!0)}),O=S.getViewer().onSwapVisibleSpace?S.getViewer().onSwapVisibleSpace(function(){X=0===S.getViewer().getVisibleSpace(),1===S.getViewer().getVisibleSpace()?j(!0):Q()}):null,X=0===S.getViewer().getVisibleSpace(),ne=H();var r=!1;for(t=0;t<ne.length;t++){for(var o=!1,l=0;l<T.length;l++)if(T[l].name===ne[t]){o=!0,T[l].filteredByPref=!0;break}o||T.push({name:ne[t],filteredByPref:!0,filtered:!1})}for(var c=0;c<T.length;c++)T[c].filtered&&(T[c].filtered=!1,r=!0);r&&N("onAttributesVisibilityModified",{attributesFiltered:v.getAttributeTypesFiltered()}),b=!0}var u=_;_=!0,j(!0),_=u}else{var h;if(d){for(h=Object.keys(R),t=0;t<h.length;t++)d.unsubscribe(R[h[t]]);d.cleanPanel(),d=null}if(R={},A&&(A.clean(),A=null),b){for(h=Object.keys(V),t=0;t<h.length;t++)S.unsubscribe(V[h[t]]);for(h=Object.keys(F),t=0;t<h.length;t++)g.unsubscribe(F[h[t]]);for(h=Object.keys(x),t=0;t<h.length;t++)f.unsubscribe(x[h[t]]);O&&S.getViewer()&&S.getViewer().unsubscribe(O),O=0,V={},F={},x={},Q(!0),b=!1}E&&(clearTimeout(E),E=0),I&&(clearTimeout(I),I=0),y.splice(0,y.length),_=!0}N("onAnnotationFilterActiveStateModified",{state:D})}else C||(C=setInterval(function(){f=s.giveAnnotationModelLoader({context:S}),(g=a.giveAnnotationController({context:S}))&&f&&(clearInterval(C),C=null,v.setActiveState(D))},100))},this.getActiveState=function(){return D},this.setControllerEnableFlag=function(e){let t="true"===localStorage.getItem("WebAfr_v2_activated")?"AnnotationFilter":"CAT3DAnnotationFilterHdr";var n=r.getCommandCheckHeader(t,S.getCommandContext());n&&(e?n.enable():n.disable()),m?(v.setActiveState(!0),m=!1):e||D&&(v.setActiveState(!1),m=!0,p=g=f=null)},this.setPanelVisibilityFlag=function(e){W=e,A&&y&&A.setPanelVisibilityFlag(W&&0!==y.length)},this.getPanelVisibilityFlag=function(){return W},this.clearController=function(){v.setActiveState(!1),C&&clearInterval(C),z&&c.unsubscribe(z),z=0,g=f=y=w=null,C=null,p=null,k=S=v=T=null},this.getAttributeTypesFiltered=function(){for(var e=[],t=0;t<T.length;t++)(T[t].filteredByPref||T[t].filtered)&&e.push(T[t].name);return e},this.subscribe=function(e,t){if(e&&t)return k.subscribe({event:e},t)},this.unsubscribe=function(e){k&&e&&k.unsubscribe(e)}}}),g=[];return e.singleton({init:function(){},give3DAnnotFilterController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].filterController},get3DAnnotFilterController:function(e){var t;if(e&&e.context&&!(t=this.give3DAnnotFilterController(e))){var n=new u({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return n?n.getActiveState():null},clearController:function(){n&&(n.clearController(),n=null)},getAttributeTypesFiltered:function(){return n?n.getAttributeTypesFiltered():null},setControllerEnableFlag:function(e){if(n)return n.setControllerEnableFlag(e)},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return n?n.getPanelVisibilityFlag():null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){n&&n.unsubscribe(e)}}),g.push({context:e.context,filterController:t})}return t},unreference3DAnnotFilterController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context){g[t].filterController.clearController(),g.splice(t,1);break}}})}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationCommands",[],function(){}),define("DS/CAT3DAnnotationCommands/CAT3DAnnotationFilterCmd",["DS/CATWebUXComponents/DMUCommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],function(e,t,n){"use strict";let i,r;var o=e.extend({init:function(e){this._parent(e,{});var t=this;r=n.get3DAnnotFilterController({context:i});var a=this.onStateChange(function(){t.getState()?o.OpenAnnotationFilterBrowser():o.CloseAnnotationFilterBrowser()}),l=this._destroy;this._destroy=function(){i&&n.unreference3DAnnotFilterController({context:i}),t._modelEvents.unsubscribe(a),l.call(t)},this.setState("false"!==localStorage.getItem("CAT3DAnnotationFilterCmd"),!0)},_destroy:function(){this._parent()}});return o.OpenAnnotationFilterBrowser=function(e,o){!i&&o?i=o.executionContext.getComponent("Viewer"):i||o||(i=t.get()),(r=n.get3DAnnotFilterController({context:i})).setActiveState(!0),localStorage.setItem("CAT3DAnnotationFilterCmd","true"),e&&e()},o.CloseAnnotationFilterBrowser=function(e,o){!i&&o?i=o.executionContext.getComponent("Viewer"):i||o||(i=t.get()),r||(r=n.give3DAnnotFilterController({context:i})),r&&r.setActiveState(!1),localStorage.setItem("CAT3DAnnotationFilterCmd","false"),e&&e()},o});