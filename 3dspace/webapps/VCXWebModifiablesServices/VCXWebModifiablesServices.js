define("DS/VCXWebModifiablesServices/VCXModifiablesChangeServices",["DS/VCXWebVisu/VCXModifiablesAccess","DS/VCXWebComponents/VCXWebComponentOccurrence","DS/VCXWebKernelCommands/VCXCmdChangePropertiesAutokey","DS/VCXWebKernelCommands/VCXCmdChangeLinkedProperties","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueString","DS/VCXWebProperties/VCXPropertyValueMap","i18n!DS/VCXWebModifiables/assets/nls/VCXWebModifiables"],function(e,t,r,i,o,a,n,l,s){"use strict";return{Ghost:function(r,i,o,a){var n=e.GetModifiableFromPathElement(i,r);if(!n)return!1;var l=1;return o?(l=.1,n.GetObject().setOpacity(l,!0),n.GetObject().setMaterial(null,!0)):(n.GetObject().setOpacity(null,!0),n.GetObject().setMaterial(null,!0),n.GetObject().setDirtyFlag(t.FDirty.Alpha),n.GetObject().setDirtyFlag(t.FDirty.Material)),o?n.GetObject().setPickability("IGNORED"):n.GetObject().setPickability("PICKABLE"),!0},RemoveStyleFromCurrentSelection:function(e,t,r,i){}}}),define("DS/VCXWebModifiablesServices/VCXModifiablesServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebProperties/VCXProperty","DS/VCXWebProperties/VCXPropertyInfo","DS/VCXWebProperties/VCXPropertyValueLocation","DS/VCXWebProperties/VCXPropertyValueFrame","DS/VCXWebVisibility/VCXIVisibility"],function(e,t,r,i,o,a,n){"use strict";var l=e.singleton({init:function(){},isModifiable:function(e){var t=e.QueryInterface?e.QueryInterface("VCXIModifiable"):null;return e===t},buildPropertyLocationWithTranslationInWCS:function(e,r,i=null){if(this.isModifiable(e)&&r instanceof t.Vector3){var o,a=e.GetProperty("Actor.Position").GetPropertyValue(),n=e.QueryInterface("W3AISGNodeHolder").getPathElement().getParentPath().getWorldMatrix(e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer()),l=(new t.Matrix4).getInverse(n);if(null==i)o=a.GetPivot().GetValue();else if(i instanceof t.Vector3){var s=(new t.Matrix4).setPosition(i);o=(new t.Matrix4).copy(l).multiply(s)}else i instanceof t.Matrix4?o=(new t.Matrix4).copy(l).multiply(i):(console.warn("Pivot specified not compatible, using modifiable's pivot as rotation pivot"),o=a.GetPivot().GetValue());for(var u=a.GetFrame().GetValue(),c=a.GetPivot().GetValue(),p=0;p<=11;++p)u.elements[p]=parseFloat(u.elements[p]);null!=i&&(c=o.clone());var y=(new t.Matrix4).extractRotation(l),P=(new t.Vector3).copy(r).applyMatrix4(y),f=(new t.Vector3).getPositionFromMatrix(u).add(P),V=(new t.Matrix4).copy(u).setPosition(f),b=(new t.Vector3).getPositionFromMatrix(c).add(P),G=(new t.Matrix4).copy(c).setPosition(b);return this.buildPropertyLocationWithFramePivot(V,G)}console.error("A VCXModifiable and a THREE.Vector3 objects are needed !")},buildPropertyLocationWithRotationInWCS:function(e,r,i){if(this.isModifiable(e)&&r instanceof t.Matrix4){var o,a=e.GetProperty("Actor.Position").GetPropertyValue(),n=e.QueryInterface("W3AISGNodeHolder").getPathElement().getParentPath().getWorldMatrix(e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer()),l=(new t.Matrix4).getInverse(n);if(null==i)o=a.GetPivot().GetValue();else if(i instanceof t.Vector3){var s=(new t.Matrix4).setPosition(i);o=(new t.Matrix4).copy(l).multiply(s)}else i instanceof t.Matrix4?o=(new t.Matrix4).copy(l).multiply(i):(console.warn("Pivot specified not compatible, using modifiable's pivot as rotation pivot"),o=a.GetPivot().GetValue());var u=(new t.Matrix4).getInverse(o),c=(new t.Matrix4).copy(u).multiply(l),p=(new t.Matrix4).extractRotation(c),y=(new t.Matrix4).getInverse(p),P=a.GetFrame().GetValue(),f=a.GetPivot().GetValue();null!=i&&(f=o.clone());var V=(new t.Matrix4).copy(p).multiply(r).multiply(y),b=(new t.Matrix4).copy(o).multiply(V).multiply(u),G=(new t.Matrix4).copy(b).multiply(P),C=(new t.Matrix4).copy(b).multiply(f);return this.buildPropertyLocationWithFramePivot(G,C)}console.error("At least a VCXModifiableOccurrence and a THREE.Matrix4 objects are needed !")},buildPropertyLocationWithFramePivot:function(e,n){if(e instanceof t.Matrix4&&n instanceof t.Matrix4){var l=new a;l.SetValue(e);var s=new a;s.SetValue(n);var u=new o;return u.SetFrame(l),u.SetPivot(s),new r(new i("Actor.Position",0),u)}console.error("2 THREE.Matrix4 objects are needed as arguments..")},GetFrameInWCSAtTime:function(e,r,i,o,a){var n=r.GetObjectAnimation(i.GetHashing()),l=null,s=e.GetNeutrals(i.GetHashing());if(s)if(n&&n._Tracks&&n._Tracks["Actor.Position"]){var u=i.GetInterpolator("Actor.Position");null==u&&(u=e.GetDefaultInterpolator("Actor.Position")),l=u.GetInterpolatedValue(s,"Actor.Position",o,n._Tracks).GetFrame().GetValue()}else{var c=s.GetProperty("Actor.Position");l=c&&c.GetPropertyValue().GetFrame().GetValue()}l||(l=i.GetProperty("Actor.Position").GetPropertyValue().GetFrame().GetValue());var p=i.GetObject().QueryInterface("VCXIModelNavigable").getParent(),y=null;if(p&&(y=p.GetObject()),y){var P=y.QueryInterface("VCXIModifiable"),f=this.GetFrameInWCSAtTime(e,r,P,o);return(new t.Matrix4).copy(f).multiply(l)}return l},getDisplayPriority:function(e){var t=e.QueryInterface("VCXIVisibility");if(t&&t.GetVisibility()===n.EVisState.Hidden)return-10;if(e.GetObject().IsKindOf("VCXComponentHotspot")){var r=e.GetProperty("Actor.Enable");return r&&r.GetPropertyValue()&&r.GetPropertyValue().Value?10:-10}var i=e.GetProperty("Actor.Opacity");if(i&&i.GetPropertyValue()&&0===i.GetPropertyValue().Value)return-9;if(e.GetObject().IsDressup)return e.GetPropertyValue("Collab.3D.Paper.Positioning.Type")<=1e3?e.GetPropertyValue("Collab.3D.Paper.Is.Background")?1e-5*e.GetPropertyValue("Collab.3D.Paper.Depth")-5:7+1e-5*e.GetPropertyValue("Collab.3D.Paper.Depth"):e.GetPropertyValue("Actor.IsAlwaysOnTop")?5:0;var o=e.GetProperty("Actor.Priority");return o&&o.GetPropertyValue()?o.GetPropertyValue().Value:0},sortListDisplayPriority:function(e,t){return t.sort(function(t,r){var i=e.ComponentsMap.GetComponentFromID(t),o=e.ComponentsMap.GetComponentFromID(r);if(i&&o){var a=i.QueryInterface("VCXIModifiable"),n=o.QueryInterface("VCXIModifiable");if(a&&n){var s=l.getDisplayPriority(a);return l.getDisplayPriority(n)-s}}}),t},isModifiableUnderMouse:function(e,t){var r=e.GetObject()._experienceBase.getManager("VCXContextManager").getMainViewer(),i=e.GetProperty("Collab.3D.Paper.Positioning.Type");if(i&&i.GetPropertyValue().Value<=1e3){t.vcxPaperPos||(t.vcxPaperPos=e.GetObject()._experienceBase.getManager("VCXPaperManager").PixelToMM2(null,t.from[0].getCurrentPosition(r.div)));var o=e.GetObject().shapeInfo;if(o&&o.center&&Math.abs(e.GetPropertyValue("Collab.3D.Paper.Paper.Position.X")+o.center.x-t.vcxPaperPos.x)<.5*o.size.x&&Math.abs(e.GetPropertyValue("Collab.3D.Paper.Paper.Position.Y")+o.center.y-t.vcxPaperPos.y)<.5*o.size.y)return!0}return!1},hasVisibleProperties:function(e){var t=e.QueryInterface("VCXIModifiableView");if(t){var r=t.getPropertyGroups();for(var i in r||console.log("No propertyGroups found for component "+e.GetObject().GetType()+"."),r)if(r.hasOwnProperty(i))for(var o=r[i].getPropertiesIDsOrderedArray(),a=0;a<o.length;++a){var n=o[a];if(e.GetProperty(n).GetPropertyInfo().IsVisible())return!0}return!1}var l=e.GetObject().GetType();console.log("Component of type "+l+" doesn't have a modifiableView.")},filterChildrenOfModsFromArray:function(e){return Array.isArray(e)&&0!==e.length?e[0].QueryInterface("VCXIModifiable")!==e[0]?e:this.filterChildrenOfCompsFromArray(e):e},filterChildrenOfCompsFromArray:function(e){if(!Array.isArray(e)||0===e.length)return e;for(var t=e,r=t.map(function(e){var t=e.QueryInterface("W3AISGNodeHolder");return t&&t.getPathElement()}),i=0;i<r.length;++i){var o=r[i];if(o)for(var a=i+1;a<r.length;++a){var n=r[a];if(n)if(o.isAParentOf(n))r[a]=null,t[a]=null;else if(n.isAParentOf(o)){r[i]=null,t[i]=null;break}}}return t.filter(function(e){return null!==e})},getBBoxInWorldFromComponents:function(e){if(Array.isArray(e)&&0!==e.length){var r=e[0]._experienceBase.getManager("VCXContextManager"),i=r&&r.getMainViewer();if(i){for(var o=new t.Box3,a=0;a<e.length;++a){var n=e[a].QueryInterface("W3AISGNodeHolder"),l=n.getPathElement().getBoundingBox(null,i);l.isNaN()?console.log("VCXModifiablesServices#getBBoxInWorldFromComponents: The pathElement associated to component "+e[a].GetID()+" has an empty BoundingBox.\n It won't be considered in the requested union of bounding boxes."):(l.applyMatrix4(n.getWorldMatrix(i)),o.union(l))}return o}}}});return l});