define("DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionComponentExpressionGenerator",["DS/CfgDictionary/CfgDictionaryTypeEnum","DS/CfgDictionary/CfgDictionaryOperatorMapper","DS/CfgDictionary/CfgDictionaryOperatorEnum"],function(e,n,t){"use strict";var i={_getRawExpressionGenerationTreatmentByType:function(i,r,o,s,a,l,c){switch(r){case e.VALUE:o&&(s+=" (",o=!1),l?(s+=a.id,s+=") ",l=!1):s+=a.id+" OR ";break;case e.PARAMETER:case e.VARIANT:case e.OPTION:s+=" "+a.id;break;case e.NUMBER:case e.FRACTION:var p=!1;if(c>0&&i[c-1].type===t.arithmetic_operator)s+=a.value;else{for(p=!1,c=0;c<n[t.arithmetic_operator].operators.length;c++)if(a.value.startsWith(n[t.arithmetic_operator].operators[c].value)){p=!0;break}s+=p?" "+a.value:" +"+a.value}break;case t.arithmetic_operator:c<i.length-1&&(i[c+1].type===e.NUMBER||i[c+1].type===e.FRACTION?s+=" "+i[c].value:i[c+1].type===e.PARAMETER&&(s+=" "+i[c].value+"1"));break;case t.eval_function:case t.binary_operator:case t.unary_operator:case t.opening_separator:case t.closing_separator:case t.comparison_operator:s+=" "+a.value}return{firstValue:o,expression:s,lastValue:l}},generateRawExpression:function(n){var t="";if(n&&n&&0!==n.length){var i=0,r=!1,o=!1,s=null,a=null,l=null,c=!1;for(i=0;i<n.length;i+=1)if(c=!1,a=n[i].type,l=n[i+1]?n[i+1].type:null,s=n[i],a===e.VARIANT&&l===e.VALUE?(r=!0,c=!0):a===e.VALUE&&l===e.VALUE?(o=!1,c=!1):a===e.VALUE&&l!==e.VALUE&&(c=!1,o=!0),!c){var p=this._getRawExpressionGenerationTreatmentByType(n,a,r,t,s,o,i);r=p.firstValue,t=p.expression,o=p.lastValue}return t=" "===(t=t.replace(/  +/g," "))[0]?t.substr(1):t}},generateExpression:function(e){var n,t={version:"1.0.1"};return n=i.generateRawExpression(e),t.expression=n,"EREV1:"+JSON.stringify(t)},generateDependencies:function(n){var t=[],i=0,r=[];for(i=0;i<n.length;i+=1)if(n[i].type===e.VARIANT||n[i].type===e.VALUE||n[i].type===e.OPTION||n[i].type===e.PACK){var o=n[i].id;r.indexOf(o)<0&&r.push(o)}var s={};for(i=0;i<r.length;i+=1)(s={}).id=r[i],t.push(s);return t}};return i}),define("DS/CfgRuleExpressionComponent/Model/CfgRuleExpressionModel",["UWA/Class/Model"],function(e){"use strict";return e.extend({editable:null,fullDictionary:null,autoCompleteRuleModel:null,languageInformation:null,solverKey:null})}),define("DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionPresenter",["UWA/Core","DS/CfgAutoCompleteComponent/Presenter/CfgAutoCompletePresenter","DS/CfgLanguageInformationComponent/Presenter/CfgLanguageInformationPresenter","DS/CfgDictionary/CfgDictionaryMapperUtils","DS/CoreEvents/ModelEvents","DS/xModelEventManager/xModelEventManager","DS/UIKIT/Input/Button","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Spinner","DS/UIKIT/Iconbar","DS/UIKIT/SuperModal","DS/ENOXSplitViewVertical/js/ENOXSplitViewVertical","DS/UIKIT/Mask","DS/Handlebars/Handlebars","DS/CfgRuleExpressionComponent/Presenter/CfgRuleExpressionComponentExpressionGenerator","DS/CfgSolver/CfgSolverServices","DS/UIKIT/Alert","i18n!DS/CfgRuleExpressionComponent/assets/nls/CfgRuleExpressionComponent","text!DS/CfgRuleExpressionComponent/View/CfgRuleExpressionTemplate.html","css!DS/CfgRuleExpressionComponent/View/CfgRuleExpressionComponent.css"],function(e,n,t,i,r,o,s,a,l,c,p,u,_,h,f,d,v,g,C){"use strict";var y=function(e,n){this._ruleExpressionModel=e,this._fullDictionary=e.fullDictionary,this._mapDico=i.dicoMinifiedV3ToMap(this._fullDictionary),this._solverKey=e.solverKey,this._languageInformation=e.languageInformation,this._ruleExpressionExpression=e.autoCompleteRuleModel,this._ruleName=n.ruleName?n.ruleName:g._rule,this._ruleTitle=n.ruleTitle?n.ruleTitle:g._rule,this._isConflictPanelOpen=!1,this._isVariabilityPanelOpen=!1,this._editable=!0===n.editable,this._isInConflict=null,this._initialExpression=JSON.parse(JSON.stringify(e.autoCompleteRuleModel)),this._applicationChannel=n.applicationChannel,this._updateChannel=n.updateChannel,this._privateChannelForRules=n.privateChannelForRules,this._localModelEvents=n.localModelEvents?n.localModelEvents:new r,this._myEventManager=new o(this._applicationChannel,this._updateChannel),this.error_msg="",this._subscribeToEvents(),this._initLanguageInformation(),this._initAutoComplete(),this._initInternalActions(),this._createOKCancelActions(),this._initDiv()};return y.prototype._initAutoComplete=function(){this._cfgAutoCompleteRulePresenter=null;var e={};(e.currentExpression=this._ruleExpressionExpression,e.dictionary=this._fullDictionary,e._localModelEvent=this._localModelEvents,e.solverKey=this._solverKey,e.editable=this._editable,e.dictionary_mapped=this._mapDico,this._cfgAutoCompleteRulePresenter=new n(e),this._cfgAutoCompleteRulePresenter._errorDicoOrGrammar)&&(this._cfgAutoCompleteRulePresenter.updateExpression(),this.checkExpression()||(this.error_msg=g._error_missing_criteria))},y.prototype._initLanguageInformation=function(){this._cfgLanguageInformationPresenter=null;var e={};e._givenModel=this._languageInformation,e._localModelEvent=this._localModelEvents,this._cfgLanguageInformationPresenter=new t(e)},y.prototype._initDiv=function(){var n=h.compile(C)();this._container=document.createElement("div"),this._container.innerHTML=n,this._container=this._container.firstElementChild,e.extendElement(this._container),this._splitViewVertical=new u;this._splitViewVertical.init({originalTop:60,sizeType:"px",resizable:!0}),this._splitViewVertical.setMaxHeightOnTop(2500),this._splitViewVertical.setNumberTop(60),this._splitViewVertical.inject(this._container.querySelector(".ruleexpression-frame")),this._cfgAutoCompleteRulePresenter.inject(this._splitViewVertical.getTop()),this._cfgAutoCompleteRulePresenter.render(),this._cfgLanguageInformationPresenter.inject(this._splitViewVertical.getBot()),this._cfgLanguageInformationPresenter.render(),this._actionBar=new c({renderTo:this._container.querySelector(".ruleexpression-header-content"),items:this._actions}),this._alertContainer=this._container.querySelector(".expressionrule-alert-container"),this._alert=new v,this._alert.inject(this._alertContainer);var t=this;this._localModelEvents.subscribe({event:"onChangeExpression"},function(){t._checkSolverCompatibility(),t._localModelEvents.publish({event:"refreshDictionary"})}),this._localModelEvents.subscribe({event:"refreshDictionary"},function(){t._updateChannel.publish({event:"refresh-criteria-panel",data:"expression-rule"})}),this._localModelEvents.subscribe({event:"onCheckExpression"},this._checkSolverCompatibility.bind(this)),this._subResize(),this._OkCancel.inject(this._container.querySelector(".ruleexpression-footer-content"))},y.prototype._initInternalActions=function(){this._actions=[];var e=this,n={text:"Solver computing",title:"Solver computing",icon:"progress-0",fonticon:"progress-0",selected:!1,handler:function(){0}},t={text:g.conflict_with_existing_rules,title:g.conflict_with_existing_rules,icon:"attention",fonticon:"attention",selected:!1,handler:function(){e._updateChannel.publish({event:"triptych-hide-panel-if-opened-from-rule"});var n=e._getSolverObject(!0);var t=function(n){if(e._internalActionConflictContainer.setStyle("pointerEvents","auto"),e._internalActionLoaderContainer.classList.add("displaynone"),"string"==typeof n&&(n=JSON.parse(n)),void 0===n||"OK"!==n._rc&&"S_FALSE"!==n._rc&&"CONFLICTING_RULE"!==n._rc)0;else if(""===n)e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone");else{e._updateChannel.publish({event:"show-loading-right-panel"});var t={};t.privateChannelForRules=e._privateChannelForRules,t.conflictingRules=[];var i={};if(i.conflictingRules=n._data.conflictingRules,i.reasons=t,"CONFLICTING_RULE"===n._rc&&0===n._data.conflictingRules.length){let n=e._cfgAutoCompleteRulePresenter.getExpression();for(let t=1;t<n.length;t++)if("variant"===n[t].type&&e._mapDico[n[t].id].mandatory&&"not_id"===n[t-1].id){i.conflictingRules.push(n[t].label),i.reasons.type="conflictMandatory";break}}e._updateChannel.publish({event:"get-rule-details",data:i})}};e._internalActionConflictContainer.setStyle("pointerEvents","none"),e._internalActionLoaderContainer.classList.remove("displaynone"),e._solverKey&&n?d.computeAnswer(n,e._solverKey,null,!0).then(t,function(n){e._privateChannelForRules.publish({event:"solver-call-error",data:n})}):t("")}};this._actions.push(n),this._actions.push(t)},y.prototype._createOKCancelActions=function(){this._OkCancelIsDisplayed=!1;var e=this,n=function(n){e._privateChannelForRules.publish({event:"update-ready-to-navigation-flag",data:!0}),e._applicationChannel.publish({event:"update-ready-to-navigation-flag",data:!0}),_.unmask(e._container),e._container.querySelector(".ruleexpression-footer-content").classList.add("displaynone"),e._localModelEvents.publish({event:"onResize",data:null}),e._splitViewVertical._resize(e._splitViewVertical.getTop().clientHeight+40),e._OkCancelIsDisplayed=!1,n?e._initialExpression=JSON.parse(JSON.stringify(e.getExpression())):(e._cfgAutoCompleteRulePresenter.setExpression(JSON.parse(JSON.stringify(e._initialExpression))),e._cfgAutoCompleteRulePresenter.createInitialExpression(),e._localModelEvents.publish({event:"onCheckExpression",data:null}))};e._localModelEvents.subscribe({event:"onChangeExpression"},function(){e._applicationChannel&&e._privateChannelForRules&&(e._privateChannelForRules.publish({event:"update-ready-to-navigation-flag",data:!1}),e._applicationChannel.publish({event:"update-ready-to-navigation-flag",data:!1})),e._OkCancelIsDisplayed||(e._container.querySelector(".ruleexpression-footer-content").classList.remove("displaynone"),e._localModelEvents.publish({event:"onResize",data:null}),e._splitViewVertical._resize(e._splitViewVertical.getTop().clientHeight-40)),e._OkCancelIsDisplayed=!0}),e._localModelEvents.subscribe({event:"onDone"},n),e._localModelEvents.subscribe({event:"onFailSave"},function(){_.unmask(e._container)});var t=new s({value:g.save,className:"primary"});t.addEvent("onClick",function(){_.mask(e._container);var n=function(n){!0===n?e.checkExpression()?e._localModelEvents.publish({event:"onSave",data:{expression:e.getExpression()}}):(""===e.error_msg&&(e.error_msg=g._error_missing_criteria),e._localModelEvents.publish({event:"set-notification-message",data:{className:"error",message:e.error_msg}}),_.unmask(e._container)):e._localModelEvents.publish({event:"onFailSave"})};e.containsError()&&!0===e.isInConflict()||(e.containsError()?new p({renderTo:e._container}).confirm(g._confirmation_save_rule+" "+e._ruleTitle+"? "+g._error_confirmation_message,g._save_rule,n):e._cfgRuleExpressionPresenter&&!0===e._cfgRuleExpressionPresenter.isInConflict()?new p({renderTo:e._container}).confirm(g._confirmation_save_rule+" "+e._ruleTitle+"? "+g._conflict_confirmation_message,g._save_rule,n):n(!0))});var i=new s({value:g._undo,className:"default"});i.addEvent("onClick",function(){n(!1)});var r=new a({buttons:[t,i]});e._OkCancel=r},y.prototype.inject=function(e){e.appendChild(this._container),this._triggerResizeInit(),this._localModelEvents.publish({event:"onCheckExpression",data:null})},y.prototype._subResize=function(){var e=this;e._localModelEvents.subscribe({event:"onResize"},function(){var n=e._container.querySelector(".ruleexpression-frame"),t=e._container.querySelector(".ruleexpression-language-information").clientHeight+e._container.querySelector(".ruleexpression-header-content").clientHeight+e._container.querySelector(".ruleexpression-footer-content").clientHeight;n.style.height="calc(100% - "+t+"px)"}),e._localModelEvents.subscribe({event:"onResizeLIP"},function(n){var t=e._container.querySelector(".ruleexpression-frame").clientHeight;n?e._splitViewVertical._resize(t/2):(e._splitViewVertical._resize(t-60),e._cfgLanguageInformationPresenter._accordion.unselectAll())})},y.prototype._getSolverObject=function(e){var n=f.generateRawExpression(this._cfgAutoCompleteRulePresenter.getExpression()),t=e?"true":"false",i={},r={};if(r.expression=n,r.computeCause=t,""===n)return null;return i._data=r,i._from="CfgRuleExpressionPresenter",i._to="solverRule",i._request="checkExpressionValidity",i},y.prototype.getExpression=function(){return this._cfgAutoCompleteRulePresenter.getExpression()},y.prototype._checkSolverCompatibility=function(){var e=this;if(e._internalActionConflictContainer=e._container.querySelectorAll(".iconbar li")[1],e._internalActionLoaderContainer=e._container.querySelectorAll(".iconbar li")[0],!e._cfgAutoCompleteRulePresenter.isThereError()){var n=null;n=e._isConflictPanelOpen&&!e._isVariabilityPanelOpen?e._getSolverObject(!0):e._getSolverObject(!1);var t=function(n){if(n&&(n=JSON.parse(n)),e._internalActionConflictContainer.setStyle("pointerEvents","auto"),e._internalActionLoaderContainer.classList.add("displaynone"),e._isConflictPanelOpen&&!e._isVariabilityPanelOpen){e._updateChannel.publish({event:"show-loading-right-panel"});var t={};t.privateChannelForRules=e._privateChannelForRules,t.conflictingRules=[];var i={};i.conflictingRules=n._data.conflictingRules,i.reasons=t,e._updateChannel.publish({event:"get-rule-details",data:i})}void 0===n||"OK"!==n._rc&&"S_FALSE"!==n._rc&&"CONFLICTING_RULE"!==n._rc?(e._internalActionConflictContainer.classList.add("displaynone"),e._isInConflict=null):""===n?(e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone")):"OK"===n._rc||"S_FALSE"===n._rc?(e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone")):(e._isInConflict=!0,e._internalActionConflictContainer.classList.remove("displaynone"))};e._solverKey&&n&&n._data.expression?(e._internalActionConflictContainer.setStyle("pointerEvents","none"),e._internalActionLoaderContainer.classList.remove("displaynone"),d.computeAnswer(n,e._solverKey,null,!0).then(t,function(n){e._privateChannelForRules.publish({event:"solver-call-error",data:n})})):t("")}else e._isInConflict=!1,e._internalActionConflictContainer.classList.add("displaynone")},y.prototype._triggerResizeInit=function(){this._localModelEvents.publish({event:"onResize",data:null}),this._cfgLanguageInformationPresenter._isOpen?this._localModelEvents.publish({event:"onResizeLIP",data:!0}):this._localModelEvents.publish({event:"onResizeLIP",data:!1})},y.prototype.addToolBarAction=function(e){this._actions.push(e),this._container.querySelector(".ruleexpression-header-content").innerHTML="",this._actionBar=new c({renderTo:this._container.querySelector(".ruleexpression-header-content"),items:this._actions});this._internalActionConflictContainer=this._container.querySelectorAll(".iconbar li")[1],this._internalActionLoaderContainer=this._container.querySelectorAll(".iconbar li")[0],this._internalActionLoaderContainer.style.pointerEvents="none",this._internalActionLoaderContainer.style.color="white";var n=(new l).inject(this._internalActionLoaderContainer).show();n.elements.container.style.position="absolute",n.elements.container.style.left="8px",n.elements.container.style.top="4px"},y.prototype.isInConflict=function(){return this._isInConflict},y.prototype.containsError=function(){return this._cfgAutoCompleteRulePresenter.isThereError()},y.prototype._subscribeToEvents=function(){var e=this;this._myEventManager.subscribe(this._applicationChannel,{event:"triptych-panel-visible"},function(){e._isConflictPanelOpen=!0}),this._myEventManager.subscribe(this._applicationChannel,{event:"triptych-panel-hidden"},function(){e._isConflictPanelOpen=!1}),this._myEventManager.subscribe(e._applicationChannel.subscribe({event:"variability-panel-visible"},function(){e._isVariabilityPanelOpen=!0})),this._myEventManager.subscribe(e._applicationChannel.subscribe({event:"variability-panel-hidden"},function(){e._isVariabilityPanelOpen=!1})),this._localModelEvents.subscribe({event:"set-notification-message"},function(n){e._alert.add(n),e._alert.show()})},y.prototype.destroy=function(){this._myEventManager&&(this._myEventManager.cleanup("CfgRuleExpressionPresenter"),this._myEventManager=null)},y.prototype.checkExpression=function(){var e;if(e=this._cfgAutoCompleteRulePresenter.getExpression())for(var n=0;n<e.length;n++)if("dummy"===e[n].type)return!1;return!0},y.prototype.getCfgAutocompletePresenter=function(){return this._cfgAutoCompleteRulePresenter},y});