define("DS/WebApplication/WebApplication",["DS/WebUtils/FunctionDisposer","DS/WebSystem/Scripting","DS/WebSystem/Environment","DS/WebRunloop/Runloop","DS/WebUtils/Profiler","DS/WebApplicationBase/W3AManagerSet","DS/WebSystem/Context","DS/VCXWebExperienceBase/VCXExperienceBase","DS/WebUtils/Statistics","DS/Visualization/ModelLoader","DS/Visualization/Node3D","UWA/Promise"],function(e,i,t,s,a,n,o,p,r,h,l,c){"use strict";return i.extend({init:function(i){this._parent(),this.context=o.createContext(),this.options=UWA.extend({},i,!0),this._guidedTourMode=void 0!==i.guidedTour&&i.guidedTour,this.options.container?"string"==typeof this.options.container&&(this.options.container=document.getElementById(this.options.container)):this.options.options.frmWindow&&(this.options.container=this.options.options.frmWindow.getUIFrame()),this.disposeFunctions=new e;var s=e=>{this.app=new e(this.options),this.options.__ODT_onAppInitialize&&this.options.__ODT_onAppInitialize(this);var i=e=>(e.createDom(),t.isSet("3DPlay.Statistics")&&(e.stats=new r),e.stats&&e.stats.set({container:e.options.container}),e.viewer=e.frmWindow.getViewer?e.frmWindow.getViewer():null,this.app.supportWebApplicationBase?e.RequestNewWebApplicationBase():e.requestNewExperienceBaseAsync());void 0!==this.app.onPreCreate?this.app.onPreCreate(this,e=>{0===e&&i(this)}):i(this)},a=e=>{if("scripterror"==e.requireType){var i=e.requireModules.join(",");console.error("3DPlay ScripNotFoundError: ",i)}else console.error(e)};this.disposeFunctions.add(()=>{s=null,a=null}),void 0===this.options.application&&(this.options.application="DS/3DPlayApplication/3DPlayApplication"),window.extensionDictionaryApp||(window.extensionDictionaryApp={}),window.interfaceDictionaryApp||(window.interfaceDictionaryApp={}),window.componentDictionaryApp||(window.componentDictionaryApp={}),require([this.options.application],s,a)},RequestNewWebApplicationBase:async function(){if(this.webApplicationBase=new p,this.webApplicationBase.initialize&&await this.webApplicationBase.initialize(this.app),this.webApplicationBase.webApplication=this,this.viewer&&(this.webApplicationBase.modelLoader=this.getModelLoader()),this.app.onPostCreate){await this.app.onPostCreate(this.webApplicationBase)}this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.initialize&&await this.webApplicationBase._ManagerSet.initialize(!0,!0);const e=this.webApplicationBase.getManager("VCXContextManager");return e&&this.viewer&&(this._guidedTourMode&&e.setExperienceInGuidedTour(),e.setFrameWindow(this.frmWindow)),this.frmWindow._experienceBase=this.webApplicationBase,this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.postInitialize&&await this.webApplicationBase._ManagerSet.postInitialize(!0,!0),this.app.onFinished&&await this.app.onFinished(this.webApplicationBase),this.profileFrame=a.start("webApplication::frame"),this.runloop=new s({data:this,func:this.runloopFunc}),this.runloop.start(),this.webApplicationBase},RequestNewExperienceBase:async function(){if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.webApplicationBase){this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.unInitialize&&await this.webApplicationBase._ManagerSet.unInitialize(!0,!0,!0),this.webApplicationBase.InterClean&&this.webApplicationBase.InterClean(),this.experienceBase=new p,this.experienceBase._parentBase=this.webApplicationBase,this.experienceBase.SetFactoryFromParent(!0),this.webApplicationBase.AddExperienceBaseChild(this.experienceBase),this.webApplicationBase._childrenBase.active=this.experienceBase,this.experienceBase.initialize&&await this.experienceBase.initialize(this.app),this.experienceBase.webApplication=this,this.viewer&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate&&await this.app.onPostCreate(this.experienceBase),this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.initialize&&await this.experienceBase._ManagerSet.initialize(!0,!0);const e=this.experienceBase.getManager("VCXContextManager");return e&&this.viewer&&(this._guidedTourMode&&e.setExperienceInGuidedTour(),e.setFrameWindow(this.frmWindow)),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.postInitialize&&await this.experienceBase._ManagerSet.postInitialize(!0,!0),this.app.onFinished&&await this.app.onFinished(this.experienceBase),this.profileFrame=a.start("webApplication::frame"),this.runloop=new s({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase}return console.error("A webApplicationBase needs to be created."),null},RequestCloseExperienceBase:async function(){if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.app.disposeExperienceBase&&await this.app.disposeExperienceBase(),this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize&&await this.experienceBase._ManagerSet.unInitialize(!0,!0),this.experienceBase.Clean(),this.experienceBase.SetFactoryFromParent(!1),this.experienceBase.webApplication=null,this.experienceBase._parentBase=null,this.webApplicationBase.RemoveExperienceBaseChild(this.experienceBase),this.webApplicationBase._childrenBase.active=null,this.experienceBase=null),this.webApplicationBase.initialize&&await this.webApplicationBase.initialize(this.app),this.webApplicationBase.webApplication=this,this.viewer&&(this.webApplicationBase.modelLoader=this.getModelLoader()),this.app.onPostCreate){await this.app.onPostCreate(this.webApplicationBase)}this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.initialize&&await this.webApplicationBase._ManagerSet.initialize(!0,!0);const e=this.webApplicationBase.getManager("VCXContextManager");return e&&this.viewer&&(this._guidedTourMode&&e.setExperienceInGuidedTour(),e.setFrameWindow(this.frmWindow)),this.frmWindow._experienceBase=this.webApplicationBase,this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.postInitialize&&await this.webApplicationBase._ManagerSet.postInitialize(!0,!0),this.app.onFinished&&await this.app.onFinished(this.webApplicationBase),this.profileFrame=a.start("webApplication::frame"),this.runloop=new s({data:this,func:this.runloopFunc}),this.runloop.start(),this.webApplicationBase},requestNewExperienceBaseAsync_:async function(){if(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&(this.app.disposeExperienceBase&&await this.app.disposeExperienceBase(),this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize&&await this.experienceBase._ManagerSet.unInitialize(!0),this.experienceBase.Clean(),this.experienceBase.webApplication=null,this.experienceBase=null),this.experienceBase=new p(null),this.experienceBase.initialize&&await this.experienceBase.initialize(this.app),this.experienceBase.webApplication=this,this.viewer&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate){await this.app.onPostCreate(this.experienceBase)}this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.initialize&&await this.experienceBase._ManagerSet.initialize(!0);const e=this.experienceBase.getManager("VCXContextManager");return e&&this.viewer&&(this._guidedTourMode&&e.setExperienceInGuidedTour(),e.setFrameWindow(this.frmWindow)),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.postInitialize&&await this.experienceBase._ManagerSet.postInitialize(!0),this.app.onFinished&&await this.app.onFinished(this.experienceBase),this.profileFrame=a.start("webApplication::frame"),this.runloop=new s({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase},requestNewExperienceBaseAsync:function(){var e=UWA.Promise.resolve().then(()=>(this.runloop&&(this.runloop.stop(),this.runloop.dispose(),this.runloop=null),this.experienceBase&&this.app.disposeExperienceBase&&this.app.disposeExperienceBase())).then(()=>this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize(!0)).then(()=>(this.experienceBase&&(this.experienceBase.Clean(),this.experienceBase.webApplication=null,this.experienceBase=null),this.experienceBase=new p(null),this.experienceBase.requestPromise=e,this.experienceBase.initialize&&this.experienceBase.initialize(this.app))).then(()=>(this.experienceBase.webApplication=this,this.viewer&&(this.experienceBase.modelLoader=this.getModelLoader()),this.app.onPostCreate(this.experienceBase))).then(e=>this.experienceBase._ManagerSet.initialize(!0)).then(()=>{var e=this.experienceBase.getManager("VCXContextManager");return e&&this.viewer&&(this._guidedTourMode&&e.setExperienceInGuidedTour(),e.setFrameWindow(this.frmWindow)),this.frmWindow._experienceBase=this.experienceBase,this.experienceBase._ManagerSet.postInitialize(!0)}).then(()=>this.app.onFinished&&this.app.onFinished(this.experienceBase)).then(()=>(this.profileFrame=a.start("webApplication::frame"),this.runloop=new s({data:this,func:this.runloopFunc}),this.runloop.start(),this.experienceBase));return e},getModelLoader:function(){if(this.app&&this.app.getModelLoader)return this.app.getModelLoader();var e=this.frmWindow.getViewer(),i=new l("RootBag");return e.addNode(i),new h({node:i,viewer:e})},getContext:function(){return this.context},activateGuidedTourMode:function(){this._guidedTourMode=!0},deactivateGuidedTourMode:function(){this._guidedTourMode=!1},createDom:function(e){if(!this.frmWindow){if(e&&e.frmWindow)this.frmWindow=e.frmWindow;else if(this.options.frmWindow)this.frmWindow=this.options.frmWindow;else{var i;if(void 0===e?i=this.options.FrameWindow:(i=e.frameWindowCtor,t=e.options),void 0===t){(t={}).uiOptions=this.options.ui||{displayTree:!1};var t={context:this.getContext()};if(this.app.getOptions&&(t=UWA.extend(t,this.app.getOptions(),!0)),this.app.getWorkBench){var s=this.app.getWorkBench();Array.isArray(s)&&(s=s[0]),t.workbenchModule=s.module,t.workbench=s.name+".xml",void 0!==s.defaultCommand&&(t.defaultCommand=s.defaultCommand)}}t.viewerOptions||(t.viewerOptions={}),t.viewerOptions.defaultAnimationLoop=!1,this.frmWindow=new i(t).inject(this.options.container)}this.frmWindow.getActionBar()&&(this.callbackActionBar=this.frmWindow.getActionBar().onActionBarReady(()=>{this.app.onActionBarReady&&this.app.onActionBarReady()}))}return this.frmWindow},runloopFunc:function(e){this.useCallback=void 0===this.useCallback||this.useCallback,this.profileFrame.start();let i=null;i=this.webApplicationBase?this.webApplicationBase.getManager("VCXContextManager"):this.experienceBase.getManager("VCXContextManager");var t=UWA.extend(this.viewer?{viewer:i.getMainViewer()}:{viewer:null},e,!0);t.profiler=this.profileFrame.addProfile("managerSet::update"),this.experienceBase&&this.experienceBase._ManagerSet.update(t),this.webApplicationBase&&this.webApplicationBase._ManagerSet.update(t),this.skipFrame?this.skipFrame=!1:i.applyToViewers(e=>{e._modelEvent&&!e.registredCBs&&(e.registredCBs={preToken:e._modelEvent.subscribe({event:"PreRender"},e=>{e.profiler=this.profile_animate.addProfile("preRender"),this.experienceBase&&this.experienceBase._ManagerSet.preRender(e),this.webApplicationBase&&this.webApplicationBase._ManagerSet.preRender(e),this.profile_render=this.profile_animate.addProfile("render")}),postToken:e._modelEvent.subscribe({event:"PostRender"},e=>{e.renderingTime=this.profile_render.stop(),e.profiler=this.profile_animate.addProfile("postRender"),this.experienceBase&&this.experienceBase._ManagerSet.postRender(e),this.webApplicationBase&&this.webApplicationBase._ManagerSet.postRender(e)})},e.defaultAnimationLoop=!1,this.disposeFunctions.add(()=>{})),this.profile_animate=this.profileFrame.addProfile("viewer["+e.id+"]::animate"),e.animate(),this.profile_animate.stop()}),t.viewer=this.viewer?i.getMainViewer():null,t.profiler=this.profileFrame.addProfile("managerSet::postUpdate"),this.experienceBase&&this.experienceBase._ManagerSet.postUpdate(t),this.webApplicationBase&&this.webApplicationBase._ManagerSet.postUpdate(t),this.profileFrame.stop(),this.stats&&this.stats.postProcess()},dispose:function(e){this.experienceBase.getManager("VCXContextManager").applyToViewers(e=>{e.registredCBs&&(e.defaultAnimationLoop=!0,e.disposed||(e._modelEvent.unsubscribe(e.registredCBs.preToken),e._modelEvent.unsubscribe(e.registredCBs.postToken)),delete e.registredCBs,e.animate())});var i=this.frmWindow.getActionBar();i&&i.removeCallback(this.callbackActionBar),this.experienceBase&&(this.experienceBase.modelLoader=null),this.webApplicationBase&&(this.webApplicationBase.modelLoader=null),this.frmWindow._experienceBase=null,this.experienceBase&&(this.experienceBase.frmWindow=null,this.experienceBase.webApplication=null),this.webApplicationBase&&(this.webApplicationBase.frmWindow=null,this.webApplicationBase.webApplication=null);const t=this.options&&this.options.Async||window.useAsyncExperienceBase;let s=this.experienceBase&&this.experienceBase._ManagerSet&&this.experienceBase._ManagerSet.unInitialize(t),a=this.webApplicationBase&&this.webApplicationBase._ManagerSet&&this.webApplicationBase._ManagerSet.unInitialize(t);s||(s=new c(e=>{e()})),a||(a=new c(e=>{e()}));let n=this;return this._parent(),s.then(()=>a).then(()=>{n.experienceBase&&(n.experienceBase.Clean(),n.experienceBase=null),n.webApplicationBase&&(n.webApplicationBase.Clean(),n.webApplicationBase=null),n.disposeFunctions.dispose(),n.disposeFunctions=null,n.runloop.stop(),n.runloop.dispose(),n.runloop=null,n.options=null,n.viewer=null,n.app.dispose(),n.app=null,void 0!==!e.disposeFrameWindow&&!0!==e.disposeFrameWindow||n.frmWindow.dispose(),n.frmWindow=null,n.stats&&(n.stats.dispose(),n.stats=null),n=null})}})});