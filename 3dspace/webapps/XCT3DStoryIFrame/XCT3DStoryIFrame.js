define("DS/XCT3DStoryIFrame/XCT3DStoryIFrame",["require","exports","UWA/Class","UWA/Core","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/Usage/TrackerAPI"],function(e,t,s,r,n,o,i,a){"use strict";const l=e=>{};class d extends s{constructor(){super(...arguments),this.publishCallback=null,this.initParams=null,this.storyIframe=null,this.servicesUrl={},this.handleMessages=(e=>{var t,s;const r=e.data;switch(r.label){case"DS/3DStory/completed/storyBlob":this.publishCallback&&this.publishCallback(r.blob);break;case"DS/3DStory/completed/storyPublish":{const{mediaId:e,isDraft:n}=r;o.publish("My3DExPublishToSwym",{swymType:"media",cmdId:"PublishStoryToSwym",param:{contentId:e,isDraft:n}}),null===(s=null===(t=this.initParams)||void 0===t?void 0:t.onContentPublishedInSwym)||void 0===s||s.call(t,e,n);break}case"DS/3DStory/getConversationList":{const{platformId:t}=r;this.getConversationList(t).then(t=>{e.ports[0].postMessage({label:"DS/3DStory/postConversationList",convList:t})}).catch(e=>{console.warn("cannot get conversation list",e)});break}case"DS/3DStory/getServicesUrl":{let t={};const{servicesName:s}=r;s&&s.length>0?s.forEach(e=>t[e]=this.servicesUrl[e]):Object.assign(t,this.servicesUrl),e.ports[0].postMessage({label:"DS/3DStory/postServicesUrl",servicesUrl:t});break}case"DS/3DStory/completed/appExit":this.clean();break;case"DS/3DStory/ready":try{const e=window.top;if(e){const t=e.document.createEvent("CustomEvent");t.initCustomEvent("STORYREADY",!0,!1,{helper:""}),e.document.dispatchEvent(t)}}catch(e){console.warn("cannot notify 3DPlay",e)}break;case"DS/3DStory/trackEvent":r.trackEvents.forEach(this.trackEvent);break;default:l(r)}})}trackEvent(e){try{a.trackPageEvent(e)}catch(e){}}sendMessage(e,t){this.storyIframe&&this.storyIframe.contentWindow?this.storyIframe.contentWindow.postMessage(e,"*",null==t?void 0:t.channelPorts):console.error("cannot access iframe")}static shouldShowComingSoonInAuthoring(){return null===localStorage.getItem("SKIP_COMING_SOON_PAGE")&&/iphone|android/i.test(navigator.userAgent)}init(){this._parent()}getCurrentLanguage(){var e;let t="en";const s=document.cookie.match(/swymlang=(?<lang>\S+\b)/i);if(s&&s.groups){const{lang:e}=s.groups;t=e}else if(window.dsLang)t=window.dsLang;else{const s=navigator.language;t=["pt-BR","zh-TW"].includes(s)?s:null!==(e=s.split("-")[0])&&void 0!==e?e:"en"}return t}clean(){window.removeEventListener("message",this.handleMessages),this.storyIframe&&"function"==typeof this.storyIframe.destroy&&this.storyIframe.destroy(),this.storyIframe=null}destroy(){const e=new MessageChannel;return new Promise((t,s)=>{e.port1.onmessage=(()=>{this.clean(),t()}),this.sendMessage({label:"DS/3DStory/request/appExit"},{channelPorts:[e.port2]})})}startPublish(e,t=!1){this.publishCallback=e,this.sendMessage({label:"DS/3DStory/request/storyBlob",isDraft:t})}createIframe(e,t){this.storyIframe=r.createElement("iframe",{src:e,styles:{width:"100%",height:"100%",border:"0px"},allowFullScreen:!0,mozAllowFullScreen:!0,webkitAllowFullScreen:!0,allow:"autoplay; camera; microphone; clipboard-read; clipboard-write"}),this.storyIframe.inject(t)}getConversationList(e){return new Promise((t,s)=>{window.require(["DS/RTConvAPI/RTConvAPI"],s=>{s.listConv({platformId:e}).then(t)})})}async create(e,t){var s,a,l,c,h,p,u,m,y,v,S;const w=t;w&&(this.initParams=w);const g=new URLSearchParams;g.append("cacheBuster",Date.now().toString()),window.addEventListener("message",this.handleMessages);let D=w.fileUrl,f=w.mediaId;if(D){if(w.edit){const e=null!==(l=null===(a=null===(s=null==w?void 0:w.model)||void 0===s?void 0:s.toJSON)||void 0===a?void 0:a.call(s))&&void 0!==l?l:null,t=null===(p=null===(h=null===(c=null==e?void 0:e.play)||void 0===c?void 0:c["3d_streams"])||void 0===h?void 0:h[0])||void 0===p?void 0:p.transient_url;"string"==typeof t&&(D=t);const r=null==e?void 0:e.subject6wuri;r&&(f=r)}g.append("storyPath",D)}w["3dplay"]?g.append("3dplay","true"):d.shouldShowComingSoonInAuthoring()&&g.append("showComingSoon","true"),f&&g.append("mediaId",f),"undefined"!=typeof widget&&"X3DPLAW_AP"===(null===(u=widget.data)||void 0===u?void 0:u.appId)&&g.append("3dplayDashboard","true"),w.edit&&g.append("editMode","true"),void 0!==w.threadId&&g.append("currentCommunityId",w.threadId),void 0!==w.threadType&&g.append("currentCommunityType",w.threadType),g.append("lang",this.getCurrentLanguage()),w["3DDashboard"]&&g.append("3DDashboard","true");let I=null;try{"function"==typeof o.getTenant&&(I=o.getTenant()),I&&0!==I.length||(I=null!==(y=null===(m=window.ds)||void 0===m?void 0:m.swymTenant)&&void 0!==y?y:null===(v=window.parent.ds)||void 0===v?void 0:v.swymTenant)}catch(e){}const b="MOBILE"===(null===(S=window.ds)||void 0===S?void 0:S.env),E=w.platformId||I;!function(e,t="should not be null or undefined"){if(null==e)throw new Error(t)}(E),g.append("platformId",E);const C=new Promise((e,t)=>{i.getPlatformServices({public:!1,onComplete:s=>{if(Array.isArray(s)&&s.length>0){const t=s.find(e=>0===E.localeCompare(e.platformId,void 0,{sensitivity:"base"}));if(t){this.servicesUrl=t;const{"3DSwym":s}=t;if(s)return g.append("swymServiceURL",s),e(s)}}t()},onFailure:t})});w.wakeUpUrl&&await new Promise(e=>{n.authenticatedRequest(t.wakeUpUrl,{method:"GET",type:"json",onComplete:e,onFailure:e})});const P=await C,A=new URL(`${P}/webapps/XCT3DStory/index.html`);A.search=g.toString();let T=A.href;b&&(T=r.Data.proxifyUrl(T,{proxy:"passport"})),this.createIframe(T,e)}}return d}),define("DS/XCT3DStoryIFrame/3DStoryExperience",["require","exports","DS/WebUtils/ContextedSingleton","DS/CoreEvents/Events","UWA/Class","DS/XCT3DStoryIFrame/XCT3DStoryIFrame"],function(e,t,s,r,n,o){"use strict";return class extends n{constructor(e){super(),this.args={},this.init=(e=>{}),this.onStoryReady=(()=>{this.publish("EXPERIENCE/EXPERIENCEREADY",this)}),this.registerListener=(()=>{try{window.top.document.addEventListener("STORYREADY",this.onStoryReady,!1)}catch(e){}}),this.unregisterListener=(()=>{try{window.top.document.removeEventListener("STORYREADY",this.onStoryReady,!1)}catch(e){}}),this.publish=((e,t)=>{r.publish({event:"/"+this.ctx+"/"+e+"/",data:t})}),this._testBrowser=(()=>BrowserSupport.ok),this.testBrowser=(()=>BrowserSupport.ok),this.initExperience=(()=>{}),this.start=(()=>{}),this.dispose=(()=>{this.unregisterListener(),this.publish("EXPERIENCE/DISPOSE",void 0),this.container=null}),s.get(e.ctx,"helper").playerSplashScreen.hide(),this.registerListener();const t=new o,n=e.input.asset;let i={"3dplay":!0,fileUrl:n.filename};if(n.originalAsset){const{envId:e,objectId:t}=n.originalAsset;e&&(i.platformId=e),t&&(i.mediaId=t)}t.create(e.container,i),this.ctx=e.ctx,this.container=e.container}}});