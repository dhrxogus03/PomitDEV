define("DS/CAT3DAnnotationScenario/CAT3DAnnotationScenario",["DS/3DPlay/PlayScenario3D","DS/WebSystem/App","DS/WebappsUtils/WebappsUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CATWebUXComponents/DMUCommandsManager","i18n!DS/CAT3DAnnotationScenario/assets/nls/CAT3DAnnotationScenario"],function(e,t,n,o,a,i){"use strict";return e.extend({init:function(e){this._parent(e);var r,l,s,c,d,A,u,g,C,m,D,S=e.scenarioManager.getExperience(),f=S.pad3DViewer,h=this,b={},p=!1,x=!1,T=!1,v=!1,y=n.getWebappsAssetUrl("CAT3DAnnotationScenario","icons/I_A3E_3DPlayScenario.png");this.setScenarioResetActionBarPolicy&&this.setScenarioResetActionBarPolicy(!1),S.subscribe("ASSET/LOADINGSTARTED",function(){o.setLoadedAssetType(null),c=null,p=!1},!0),S.subscribe("ASSET/LOADINGFINISHED",function(e){p=!0,T=!1,m=e.loadAssetInfo,o.setLoadedAssetType(m&&"3dxml"===m.format?"3DXML":null),C&&C()},!0),S.subscribe("EXPERIENCE/STOP",function(){l&&h.stop()},!0),this.launch=function(){D=S.autoReframe,S.autoReframe=!1,s||((s={}).assetChanged=S.subscribe("ASSET/CHANGE",function(){f.publish({event:"on3DPlayAssetChanged",data:{}})}),s.transition=S.subscribe("EXPERIENCE/TRANSITION",function(e){l&&"ENOR3D_AP"===e.options.id&&(v=!0)})),require(["DS/CAT3DAnnotPlayServices/CAT3DAnnotPlayServices","DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/PADUtils/PADUtilsServices","DS/CoreEvents/Events","DS/3DPlayConnectors/3DPlayInputPreProcessor"],function(e,n,i,y,P,w,E,L,M){var I;C=function(){if(p&&c&&x){if(c&&c.length)for(var e=0;e<c.length;e++)c[e].node&&c[e].xml&&(c[e].node.xml=c[e].xml);!T&&l&&(l.setActiveState(1),I.setActiveState(!0))}},window.widget&&window.widget.setMetas({helpPath:"CAT3DAnnotationScenario/assets/help"});var R=S.getModelLoader&&S.getModelLoader()?S.getModelLoader().getCGRWithSG():"notAssigned";!function(){var e={lastCommand:[],currentCommand:null,defaultCommand:null},n=f.getCommandContext?f.getCommandContext():null;n?a._commandsState[n]=e:a._commandsState=e,a.resetDefaultCommand(n),a._isCommandEnding=!1,a._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){var t=n?a[e][n]:a[e];Object.keys(t).forEach(function(e){var n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})});var o=0,i=f.getFrameWindow().getActionBar().onActionBarReady(function(){0===o?(o=1,h.loadWorkbench({name:"3DPlay.xml",module:"3DPlay"},!0)):1===o?(o=2,S.lightbox?h.loadWorkbench({name:"3DPlayShare_LightboxMode.xml",module:"3DPlay"},!0):h.loadWorkbench({name:"3DPlayShare.xml",module:"3DPlay"},!0)):2===o?(o=3,S.lightbox?h.loadWorkbench({name:"EnopadRightPanel.xml",module:"3DPlay"},!0):h.loadWorkbench({name:"EnopadRightPanel_LightboxMode.xml",module:"3DPlay"},!0)):f.getFrameWindow().getActionBar().removeCallback(i)});h.loadWorkbench({name:t.is3DPlay()?"CAT3DAnnotationScenario.xml":"CAT3DAnnotationScenario_embed.xml",module:"CAT3DAnnotationScenario"},!1)}(),I=new n({ctxViewer:f}),r=I.subscribe("onSlideShowActiveStateModified",function(e){L.publish({event:e.state?"3DPLAY/SPECTREE/DISABLE":"3DPLAY/SPECTREE/ENABLE",data:{}}),S._enableCMenu=!e.state}),y.registerAnnotationController({annotController:I,context:f}),u=new M;var V=function(e){u.run(e,function(e){S.clearView(),S.load(e)})},W=w.getFavoriteContextManager({context:f,addRoots:function(e){T=!0;var t=m&&m.originalAsset?m.originalAsset:{provider:"EV6",tenant:E.getPlatformId()};t.physicalid=e[0].path[0],t.id=e[0].path[0],V(t)},addRootNodesFromContent:function(e){T=!0;var t=m&&m.originalAsset?m.originalAsset:{provider:"EV6",tenant:E.getPlatformId()};t.physicalid=e[0].objectId,t.id=e[0].objectId,t.displayName=e[0].displayName,t.type=e[0].objectType,t.dtype=e[0].objectType,V(t)}});let _;b.onAddRoot=f.subscribe({event:"onRootAdded"},function(){o.setLoadedAssetType(null)}),e.initSelAndPrefMgrs({ctxViewer:f}).then(t=>{l=i.getAnnotationModelLoader({context:f,favoriteCtxManager:W}),P.get3DAnnotBrowserController({context:f,defaultDockingSide:"left"}).setActiveState(!0),x=!0,f.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(){return d||(d=I.onAdditionalInfosRequired({controller:"AnnotScenario"}).getSelectedAnnotationsVisibilityFlag),e.getContextualCommandList({ctxViewer:f,getSelectedAnnotationsVisibilityFlag:d})},context:f.getCommandContext?f.getCommandContext():S.ctx,workbenchName:"CAT3DAnnotationScenario",module:"CAT3DAnnotationScenario",cmdPrefix:"",subscriberId:"CAT3DAnnotationScenario",merge:!0}),A=f.getViewer().currentViewpoint.control.lockZ,_=t,o.setLoadedAssetType(null),m&&"3dxml"===m.format?(o.setLoadedAssetType("3DXML"),u.run(m.originalAsset?m.originalAsset:m,function(e){S.getModelLoader().setCGRWithSG(!0),S.clearView(),S.load(e,{ConversionOpts:{PMI:1},"3DXMLLoadOpts":{V4V5_FDT:{doneCallback:function(e){c=e,C()},errorCallBack:function(){}}}})})):(l.setActiveState(1),I.setActiveState(!0));var n=0,a=setInterval(function(){if(l&&!l.isRunning()){clearInterval(a);var e=f.getRootBagPath().getChildrenPathes();1===e.length&&o.is3DLeaf(e[0].getLastElement())&&W.manageFavoriteContext({path:e[0]},!0)}++n>=100&&clearInterval(a)},500);g=function(){var t;if("notAssigned"!==R&&S.getModelLoader()&&S.getModelLoader().setCGRWithSG(R),R="notAssigned",S.autoReframe=D,_&&(_.ctxViewer=f,e.cleanSelAndPrefMgrs(_)),f.getViewer()&&f.getViewer().currentViewpoint&&(f.getViewer().currentViewpoint.control.lockZ=A),c&&c.length)for(t=0;t<c.length;t++)c[t].node.xml=null;c=null;var n=y.giveAnnotationController({context:f});r&&n&&n.unsubscribe(r),v&&n&&n.saveLastFTAViewOrCaptureDisplayed(!0),y.unreferenceAnnotationController({context:f}),v||i.unreferenceAnnotationModelLoader({context:f}),P.unreference3DAnnotBrowserController({context:f}),w.unreferenceFavoriteContextManager({context:f});var o=Object.keys(b);for(t=0;t<o.length;t++)f.unsubscribe(b[o[t]]);for(b={},o=Object.keys(s),t=0;t<o.length;t++)S.unsubscribe(s[o[t]]);s=null,f.getFrameWindow()&&f.getFrameWindow().getContextualUIManager().unregister("CAT3DAnnotationScenario"),l=u=null,g=C=d=null,v=!1}})})};var P=this.stop.bind(this);this.stop=function(){x=!1,window.widget&&window.widget.setMetas({helpPath:void 0}),g&&g(),P()},this.getTitle=function(){return i.A3EScenario_Title},this.getDescription=function(){return i.A3EScenario_Description},this.getIcon=function(){return y}}})});