/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/SPYLoader/SPYStreamLoader",["UWA/Core","UWA/Class","DS/VisuDataAccess/Ox4PLMDataHelper","DS/VisuDataAccess/Ox4TicketGeneratorTask","DS/VisuDataAccess/Ox4XHRWithProxyAbstraction","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI"],function(e,t,n,i,s,r,o){"use strict";var a=null,l=null,d=function(e,t,n,i){var s={name:"",store:""};return s.name=e+"_'"+t+"'."+n,s.name+="="+i,s.format=n,s.persistencyName=i,s};return t.singleton({load:function(e){var t,c,u,p;null!==a&&null!==l&&l.url===e.serverUrl&&l.contextid===e.contextid||(function(e){var t=e.url;e.xmqlServiceUri=function(){return t+"/i3dx/services/xmql"},e.threedexpServiceUri=function(){return t};var n=o.getUser().login;s.useUWAProxy({proxymode:"passport",login:n,contextid:e.contextid}),e.login=n}(l={rawmode:!1,url:e.serverUrl,contextid:encodeURIComponent(e.contextid)}),a=new n(l)),e.sd?(c=e.repId,u=e.sd,p=function(e){var t=/SDv2\((.*),'(.*)',(.*),.*,.*,'(.*)','(.*)'\)/.exec(e);return{format:t[1],role:t[2],lateType:t[3],persistencyType:t[4],persistencyName:t[5]}}(u),t=d(c,p.role,p.format,p.persistencyName)):t=d(e.repId,e.role,e.format,e.persistencyName),function(e,t,n,r){var o=a.transformSelectedFileIntoTicketRequest(e,t.format,t.store,t.name),d=new i(o,l);(new s).asyncTransformFCSUrlIntoRealUrl(d.generateRequest(),!1,function(e,t){n(t)})}(e.repId,t,function(n){!function(e,t,n,i,s,o,a){if("posthttp"==e.slice(0,8)){var l=e.indexOf(":postparams:"),d=e.slice(9,l),c=e.slice(l+12,e.length),u={cors:!0,timeout:isNaN(a)?0:a,method:"POST",data:c,responseType:n,async:!0,headers:{Accept:"text/plain",SecurityContext:encodeURIComponent(t)},onComplete:i,onFailure:s,onTimeout:o};r.authenticatedRequest(d,u)}}(n,e.contextid,e.streamType,function(n){e.onStreamLoaded(t.persistencyName,n)},e.onError,e.onTimeOut,e.timeout)},e.onError)}})}),define("DS/SPYLoader/SPYWSProxy",["UWA/Class","DS/WAFData/WAFData"],function(e,t){"use strict";let n,i=function(e){let t=12e4;return e>150&&(t*=e/150,t=Math.min(Math.round(t),24e4)),t},s=function(e,i,s,o){!function(e,n,i,s){let r=e.serverurl+"/cvservlet/progressiveexpand/v2";r+="?tenant="+e.tenant,r+="&SecurityContext="+encodeURIComponent(e.contextid),r+="&output_format=cvjson";let o={timeout:2e4,onComplete:n,onCancel:i,onFailure:i,onTimeout:s,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en"}},a={batch:{expands:[{label:"SimulationExperienceContent_ExpV2",root:{physical_id:e.physicalid},filter:{all:1},graph:{descending_condition:{uql:"availability:1"},descending_condition_object:{uql:'(flattenedtaxonomies:"types/dsc_Result_Category_Ref") OR (flattenedtaxonomies:"types/dsc_Result_rep")'}}}]},outputs:{select_object:["physicalid","bo.streamdescriptors","bo.designsight.simulationorigin","type","label","revision","islastrevision","current"]}};o.data=JSON.stringify(a),t.authenticatedRequest(r,o)}(e,function(e){let t=r.errorCodes.ERR_EXPANDCV_FAILED;if("string"==typeof e&&e.length>0){let t=JSON.parse(e).results;if(Array.isArray(t)&&t.length>=3){let e=t[0],s=t[2];if(s&&e){let t=e["bo.designsight.simulationorigin"];return n=t||void 0,void i(s,e)}}}s(t)},s,o)},r=e.singleton({errorCodes:{ERR_NOEXTDATA:"SPYWS_NOEXTDATA",ERR_UNEXPECTED:"SPYWS_UNEXPECTED",ERR_EXTDATA_PARSE:"SPYWS_EXTDATA_PARSE_FAILED",ERR_EXTDATA_NORUNS:"SPYWS_EXTDATA_NORUNS",ERR_EXTDATA_NOLW:"SPYWS_EXTDATA_NOLW",ERR_GETLWSTREAMS_NOLW:"SPYWS_GETLWSTREAMS_NOLW",ERR_EXPANDCV_FAILED:"SPYWS_EXPANDCV_FAILED"},getLatestSimulationOrigin:function(){return n},getThumbnails:(e,n,i,s)=>(function(e,n,i,s){let r=[];if(null!=e[0]){let o=e[0].serverurl+"/cvservlet/fetch/v2";o+="?tenant="+e[0].tenant,o+="&SecurityContext="+encodeURIComponent(e[0].contextid),e.forEach(function(e){r.push(e.physicalid)});let a={timeout:6e4,onComplete:n,onCancel:i,onFailure:i,onTimeout:s,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en"}},l={physicalid:r,label:"PhysicsSimulationResults_"+Date.now(),select_file:["icon","thumbnail_2d"],tenant:e[0].tenant};a.data=JSON.stringify(l),t.authenticatedRequest(o,a)}})(e,n,i,s),getResultExtendedData:function(e,t,n,i){Date.now();s(e,(e,i)=>{let s=e["bo.simobjsimulationv5repreferencegeneric.v_extendeddata"],r=this.errorCodes.ERR_UNEXPECTED;if(void 0===s||"string"!=typeof s||s.length<=0)r=this.errorCodes.ERR_NOEXTDATA,n(r);else try{let e=JSON.parse(s);t(e,simulationAttributes)}catch(e){r=this.errorCodes.ERR_EXTDATA_PARSE,n(r)}},n,i)},_postRequestToSMAServices:function(e,n,i,s,r){let o={timeout:6e4,onComplete:e=>{let t=this.errorCodes.ERR_UNEXPECTED;if(void 0===e||"string"!=typeof e||e.length<=0)t=this.errorCodes.ERR_NOEXTDATA,s(t);else try{let n=JSON.parse(e);i(n)}catch(e){t=this.errorCodes.ERR_EXTDATA_PARSE,s(t)}},onCancel:s,onFailure:s,onTimeout:r,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en",SecurityContext:e.contextid}},a={itemId:e.physicalid,clientContext:{}};a.clientContext[["e","k","a","r","i","p","m","u","i","l"].reverse().reduce(function(e,t){return e+t},"")]="7948163181467835",o.data=JSON.stringify(a),t.authenticatedRequest(n,o)},getAnalysisCases:function(e,t,n,i){let s=e.serverurl+"/resources/SMAPowerByServices/getAnalysisCases";this._postRequestToSMAServices(e,s,t,n,i)},getRuns:function(e,t,n,i){let s=e.serverurl+"/resources/SMAPowerByServices/getRuns";this._postRequestToSMAServices(e,s,t,n,i)},getLWDictionary:function(e,t,n,i,s){let r=s&&s.compareCVExpand;r&&this.getResultExtendedData(e,(e,t)=>{console.log(" ** sma getResultExtendedData onComplete => : ",e,t)},n,i);
//!!
//!!
let o=Date.now();this.getRuns(e,i=>{r&&console.log(" ** SPYLW - getRuns call took in ms: ",Date.now()-o);let s=this.errorCodes.ERR_UNEXPECTED,a=new Map,l={};if(i){l.boId=i.contentId,l.boCEstamp=i.cestamp,l.definitionProvider=e.serverurl,s=this.errorCodes.ERR_EXTDATA_NORUNS;let t=i.runs;if(t){this.errorCodes.ERR_EXTDATA_NOLW,Object.keys(t).forEach(function(e){let n=t[e];if(n&&n.lightweightViz){let t={name:n.name,lastRunID:e,lastUpdate:n.updateStamp,lw:n.lightweightViz};a.set(n.analysisCaseId,t)}})}}a.size>0?t(a,l):n(s)},n,i)},loadContentStream:function(e,t,n,i){},getLWstreamUrl:function(e,n,i,r){s(e,function(s){!function(e,n,i,s,r){let o=e.serverurl+"/cvservlet/fetch/v2";o+="?tenant="+e.tenant,o+="&SecurityContext="+encodeURIComponent(e.contextid);let a={timeout:6e4,onComplete:i,onCancel:s,onFailure:s,onTimeout:r,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":"en"}},l={physicalid:[n],fcs_url_mode:"REDIRECT",select_file:["xml"],select_predicate:["physicalid"],label:"SimulationExperienceContent_Fetch",tenant:e.tenant,locale:"en"};a.data=JSON.stringify(l),t.authenticatedRequest(o,a)}(e,s.id,n,i,r)},i,r)},getLWstreamsIds:function(e,t,r,o){n=void 0;let a=Date.now();s(e,(e,n)=>{let s=e["bo.streamdescriptors"];if(s){let n=s.split(":").filter(e=>e.contains("SimNavData_"));if(n.length>0){let s=Date.now()-a,r=i(s);t(e.resourceid,n,r)}else r(this.errorCodes.ERR_GETLWSTREAMS_NOLW)}else r()},n=>{let s=e.serverurl+"/resources/SMAPowerByServices/getAttachedStreams";this._postRequestToSMAServices(e,s,e=>{if(e&&Array.isArray(e.streams)){let n=e.streams.filter(function(e){return"xml"===e.filetype&&e.name.contains("SimNavData_")});if(n.length>0){n.forEach(function(e,t,n){let i=e.locator.split(":");n[t]="SDv2(2,'EXTENDED',CATNonCATIADocument,'-1181347442','-1181347444','xml','"+i[4]+"')"});let s=Date.now()-a,r=2*i(s);t(e.contentId,n,r)}else r(this.errorCodes.ERR_GETLWSTREAMS_NOLW)}},r,o)},o)}});return r}),define("DS/SPYLoader/AbstractLoader",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/WebUtils/ProbesManager","DS/SPYUtils/TrackingManager"],function(e,t,n,i,s){"use strict";return t.extend({_cleanCompleteCb:function(){this._sequenceCreatedCB&&(n.unsubscribe(this._sequenceCreatedCB),delete this._sequenceCreatedCB)},_cleanErrorCb:function(){this._sequenceErrorCB&&(n.unsubscribe(this._sequenceErrorCB),delete this._sequenceErrorCB)},_loadSequence:function(e,t){if(e&&this._listObjToLoad.push(e),!this._loading&&0!==this._listObjToLoad.length){var n=this._listObjToLoad.shift(),s=i.createProbe("SPY.SPYLoader.LOADSEQUENCE."+this._probesLoadSequence.length);this._probesLoadSequence.push(s),s.begin(),this._loading=!0,this._dmFactory.createSequence({src:n,spm:this._spm},t)}},_loadModel:function(){},init:function(){this._parent(),this._loading=!1,this._listObjToLoad=[],this._defaultAssetType=void 0,this._streamsInfo=[],this._typingInfo={},this._report={streamsInfo:[]},this._probesLoadSequence=[]},clean:function(){this._cleanCompleteCb(),this._cleanErrorCb(),this._spm=null,this._listObjToLoad=[],this._streamsInfo=[],delete this._dmFactory,this._report={streamsInfo:[]},this._probesLoadSequence.forEach(function(e){e&&e.end()})},onUnstreamComplete:function(e,t){this._cleanCompleteCb(),this._sequenceCreatedCB=n.subscribe({event:e+"/SPY/SEQUENCE/CREATED"},function(e){var n=this._probesLoadSequence[e.seqIdx];n&&n.end(),this._report&&e&&(this._report.filteredDDNb=e.filteredDDNb),t(e)}.bind(this))},onUnstreamError:function(e,t){this._cleanErrorCb(),this._sequenceErrorCB=n.subscribe({event:e+"/SPY/SEQUENCE/ERROR"},function(e){var n;(n=isNaN(e.seqIdx)?this._probesLoadSequence.pop():this._probesLoadSequence[e.seqIdx])&&n.end(),e&&"FILTEREDCONTENT"===e.errorCode?(this._report&&(this._report.filteredContent=!0),s.trackAllContentsFiltered(void 0,this._typingInfo)):(this._report&&(isNaN(this._report.invalidStreamNb)&&(this._report.invalidStreamNb=0),this._report.invalidStreamNb++),s.trackInvalidStreamContent(void 0,this._typingInfo)),this._loading=!1,t()}.bind(this))},onQueryStart:function(e,t){this._onQueryStart=t},onQueryProgress:function(e,t){this._onQueryProgress=t},onUnstreamStart:function(e,t){this._onUnstreamStart=t},onFileNotSupported:function(e,t){this._onFileNotSupported=t},onQueryError:function(e,t){this._onQueryError=t},onTimeOut:function(e,t){this._onTimeOut=t},load:function(e,t,n){this._spm=n,s.setTenant(e.tenant),this._spm.addAnalytics({providerType:e.provider,assetType:e.dtype||this._defaultAssetType,tenant:e.tenant,loadStart:Date.now()}),require([t],function(t){var n,r,o=function(){},a=this._onFileNotSupported?this._onFileNotSupported:o,l=this._onUnstreamStart?this._onUnstreamStart:o,d=this._onTimeOut?this._onTimeOut:o;this._dmFactory=new t;var c=this.getReport();if(c.streamNb=0,"FILE"===e.provider){var u="3dsim"===e.format||"simxml"===e.format,p=e.format===e.mimetype&&e.format===e.type;if(0===(r=e.filename&&e.filename.length>0?e.filename:e.serverurl).indexOf("https",0)&&r.indexOf(e.format,0)<0&&p){u?(c.streamNb=1,n={persistentId:r,index:0,provider:"FILE",filename:r,proxyurl:"none",withCredentials:!0},l(),this._loadSequence(n)):a()}else{var h=e.filename,f=new RegExp("[;]+","g"),m=h.split(f);c.streamNb=m.length;for(var _=0;_<m.length;_++)0!==(r=m[_]).indexOf("blob",0)&&r.indexOf("3dsim",0)<0&&r.indexOf("simxml",0)<0&&r.indexOf("nas",0)<0&&r.indexOf("inp",0)<0&&a(),n={persistentId:r,index:_,provider:"FILE",filename:r,serverurl:"",proxyurl:"none",requiredAuth:null,withCredentials:!0},l(),this._loadSequence(n)}}else if("BLOB"===e.provider)e.blob instanceof Blob&&(c.streamNb=1,n={provider:"BLOB",blob:e.blob,index:0,analytics:{dataSize:e.blob.size,streamingTime:0}},l(),this._loadSequence(n));else if("EV6"===e.provider||"3DSPACE"===e.provider){this._onQueryStart&&this._onQueryStart();var S=this._onQueryProgress?this._onQueryProgress:o,g=this._onQueryError?this._onQueryError:o,E=i.createProbe("SPY.SPYLoader.LOADMODEL");E.begin(),this._loadModel(e,S,function(e,t){E.end(),c&&(isNaN(c.streamTimeOut)||d()),t&&this._spm.setTypingInfo(t);var i=this;if(Array.isArray(e))e&&e.length>0&&(l(),e.forEach(function(e){n={persistentId:e.persistentId,index:e.index,provider:"BUFFER",buffer:e.data?e.data:e,analytics:{dataSize:e.dataSize,streamingTime:e.streamingTime}},i._loadSequence(n)}));else{var s=e;if(s.length>0){l();for(var r=new RegExp("[;]+","g"),o=s.split(r),u=0;u<o.length;u++){if(0!==(s=o[u]).indexOf("blob",0)&&s.indexOf("simxml",0)<0)return void a();n={provider:"FILE",filename:s,serverurl:"",proxyurl:"none",requiredAuth:null},this._loadSequence(n)}}}}.bind(this),function(e){switch(E.end(),e){case"NOACCESS":s.trackNoAccess(void 0,this._typingInfo);break;case"NOSTREAM":s.trackNoSimulationEC(void 0,this._typingInfo)}g(e)}.bind(this),function(e){s.trackECLoadingTimeOut(void 0,this._typingInfo,e)}.bind(this))}}.bind(this))},isLoadingComplete:function(){return 0===this._listObjToLoad.length&&!this._loading&&!this._spm.loading},continueLoading:function(){this._loading=!1,this._loadSequence()},getReport:function(){return this._report},resetReport:function(){this._report={streamsInfo:[]}},getDMFactory:function(){return this._dmFactory},extensionLoad:function(e,t,n,i){let s=function(){n&&n()},r=function(){i&&i()},o=this.getDMFactory();if(o&&o.setExtendedMode&&this._spm&&this._streamsInfo){o.setExtendedMode(!0);let n=-1;e&&(n=this._spm.findSequenceByPersistentId(e)),n<0&&(n=this._spm.findSequenceByName(t));let i=this._streamsInfo[n];i?this._loadSequence({provider:"BUFFER",buffer:i.data,analytics:{dataSize:i.dataSize,streamingTime:i.streamingTime}},{onComplete:s,onError:r}):r()}else r()},extensionLoadAll:function(){let e=this.getDMFactory();if(e&&e.setExtendedMode&&this._spm&&this._streamsInfo){this.resetReport&&this.resetReport(),e.setExtendedMode(!0);for(const e in this._streamsInfo){let t=this._streamsInfo[e];t&&this._loadSequence({provider:"BUFFER",buffer:t.data,analytics:{dataSize:t.dataSize,streamingTime:t.streamingTime}})}}}})}),define("DS/SPYLoader/SPYLoader",["UWA/Core","UWA/Class","DS/SPYLoader/AbstractLoader","DS/SPYLoader/SPYWSProxy","DS/SPYLoader/SPYStreamLoader"],function(e,t,n,i,s){"use strict";return n.singleton({_defaultAssetType:"DesignSight",_loadModel:function(e,t,n,r,o){e.contextid=e.contextid||e.contextId,this._typingInfo={assetType:e.dType||e.type,providerType:e.provider},this._streamsInfo=[],i.getAnalysisCases(e,e=>{if(e)for(var t in e.analysisCases){var n=e.analysisCases[t];this._typingInfo[t]={name:n.name,origin:n.origin,sequenceType:n.type,sequenceSubTypes:n.subType,featureId:n.featureId};var i=n.appData_NativeApp||n.appData_SimMgr;i&&(this._typingInfo[t].internalId=i.internalId,this._typingInfo[t].internalName=i.internalName)}},e=>{this._typingInfo.error=e},()=>{this._typingInfo.timeout=!0}),i.getRuns(e,e=>{if(e)for(var t in e.runs){var n=e.runs[t];if(n.analysisCaseId){var i=this._typingInfo[n.analysisCaseId];i&&(i.resultSequenceId=t)}}},()=>{},()=>{}),this._onFinish=n,i.getLWstreamsIds(e,(n,a,l)=>{if(this._typingInfo.simulationOrigin=i.getLatestSimulationOrigin(),s&&Array.isArray(a)){var d=0,c=a.length;this._report.streamNb=c,this._report.suggestedTimeout=l,t(0,{streamsLoaded:0,streamsTotal:c});for(let e=0;e<a.length;e++)a[e]={id:a[e],order:e};if(this._spm){let e=this._spm.getPreferredStreamId();if(e){let t=a.findIndex(t=>t.id.contains(e));t>0&&a.splice(0,0,a.splice(t,1)[0])}}a.forEach(i=>{var u=Date.now(),p={repId:n,serverUrl:e.serverurl,contextid:e.contextid,sd:i.id,streamType:"arraybuffer",onStreamLoaded:function(e,n){c--;var s=a.length-c;t(100*s/a.length,{streamsLoaded:s,streamsTotal:a.length}),this._streamsInfo.push({persistentId:e,index:i.order,data:n,dataSize:n.byteLength,streamingTime:Date.now()-u}),0===c&&this._onFinish(this._streamsInfo,this._typingInfo)}.bind(this),timeout:l,onTimeOut:()=>{d++,c--,this._report.streamTimeOut=d;var e=a.length-c;t(100*e/a.length),o&&o(Date.now()-u),0===c&&this._onFinish(this._streamsInfo,this._typingInfo)},onError:e=>{c--,r("NOACCESS")}};s.load(p)})}},e=>{this._typingInfo.simulationOrigin=i.getLatestSimulationOrigin(),e===i.errorCodes.ERR_GETLWSTREAMS_NOLW?r("NOSTREAM"):r("NOACCESS")},()=>{this._typingInfo.simulationOrigin=i.getLatestSimulationOrigin(),r("NOACCESS")})},declareToPAD:function(e,t,n){if(e&&e.loadJSON){var i=[{rootID:t,validForServerCall:!0,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":"DesignSight","ds6w:globaltype":"ds6w:Document","ds6w:label":n,boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:t,"ds6w:type":"DesignSight","ds6w:globaltype":"ds6w:Document",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}}]},refreshDelegationCB:()=>new Promise(e=>{e()})}];e.loadJSON({data:i})}},removeFromPAD:function(e,t){e&&t&&e.removeRoots({pids:[t]})}})});