define("DS/VCXMediaChooser/VCXMediaChooserLoadServices",["UWA/Class"],function(t){"use strict";var e=t.extend({init:function(t){e.prototype._onOpenFile=null,this._inputId="VCXMediaChooser-fileinput",document.getElementById(this._inputId)||this.createInputFile(),this._acceptAttributes="image/*",t&&t.acceptAttributes&&(this._acceptAttributes=t.acceptAttributes)},createInputFile:function(){var t=document.getElementsByClassName(this._inputId+"-class");if(t)for(var e=0;e<t.length;e++)t[e].parentElement.remove();new UWA.Element("div",{html:[{tag:"input",id:this._inputId,class:this._inputId+"-class",type:"file",styles:{visibility:"hidden",position:"absolute",left:"0px",top:"0px"},events:{change:this.openFile.bind(this)}}]}).inject(document.body)},openFileSelector:function(t){var i=document.getElementById(this._inputId);i.setAttribute("accept",this._acceptAttributes),e.prototype._onOpenFile=t,i.value=null,i.click()},openFile:function(t){if(t){var i=t.target.files;if(i&&i.length)for(var n=0;n<i.length;n++){var s=i[n];if(s.type.length){var o=window.URL.createObjectURL(s);e.prototype._onOpenFile(o,s)}}else e.prototype._onOpenFile(null)}}});return e}),define("DS/VCXMediaChooser/VCXImageGallery",["UWA/Core","UWA/Controls/Abstract","UWA/Json","DS/WebappsUtils/WebappsUtils","text!DS/VCXMediaChooser/assets/gallerySettings.json","i18n!DS/VCXMediaChooser/assets/nls/VCXImageGallery"],function(t,e,i,n,s,o){"use strict";var a="variable";return e.singleton({init:function(){this._currentSection={},this._maxLength=8,this._settingsURL=null,this._initialPath="",this._currentPath=""},initProperties:function(){var e=JSON.parse(s),o=i.path(e,"$");o[0].sections.map(function(t){return t.thumbnails.forEach(function(e){e.sectionName=t.name,e.url=e.url?n.getWebappsAssetUrl("VCXMediaChooser",e.url):e.url}),t}),this._initialPath+=t.Json.encode(o),this._currentPath+=this._initialPath},getIDs:function(t){var e=i.decode(this._currentPath);return i.path(e[0],'$.sections[?(@.name=="'+t+'")].thumbnails..id')},getThumbnails:function(t){var e=i.decode(this._currentPath);return i.path(e[0],'$.sections[?(@.name=="'+t+'")].thumbnails..url')},addThumbnail:function(t,e){var n=i.decode(this._currentPath);if(this._currentSection=i.path(n[0],'$.sections[?(@.name=="'+t+'")]')[0],this._currentSection&&this._currentSection.type===a){var s=this._genId();return this._currentSection.thumbnails||(this._currentSection.thumbnails=[]),this._currentSection.thumbnails.unshift({id:s,url:e}),this._currentSection.thumbnails.length>this._maxLength&&this._currentSection.thumbnails.pop(),this._currentPath=i.encode(n),s}return!1},getThumbnailPropertiesByID:function(t){var e=i.decode(this._currentPath);return i.path(e[0],'$..properties[?(@.id=="'+t+'")]')[0]},getSectionTitle:function(t){return o.get(t)},isSectionSelected:function(t){var e=i.decode(this._currentPath);return i.path(e[0],'$.sections[?(@.name=="'+t+'")].selected')[0]},setSectionVisible:function(t,e){var n=i.decode(this._currentPath);this._currentSection=i.path(n[0],'$.sections[?(@.name=="'+t+'")]')[0],this._currentSection&&(this._currentSection.visible=e,this._currentPath=i.encode(n))},countVisibleSections:function(){if(""!==this._currentPath){var t=i.decode(this._currentPath);return i.path(t[0],"$.sections[?(@.visible==true)]").length}return 0},isSectionVisible:function(t){var e=i.decode(this._currentPath);return i.path(e[0],'$.sections[?(@.name=="'+t+'")].visible')[0]},getOnClickCB:function(t){var e=i.decode(this._currentPath);return i.path(e[0],'$.sections[?(@.name=="'+t+'")].onClick')[0]},getSectionsNames:function(){var t=i.decode(this._currentPath);return i.path(t[0],"$.sections..name")},reset:function(){this._currentPath="",this._currentPath+=this._initialPath},_genId:function(){var t=Date.now();return t+=Math.floor(10*Math.random())}})}),define("DS/VCXMediaChooser/VCXChoosePicture",["UWA/Class","UWA/Controls/Scroller","DS/UIKIT/Accordion","DS/UIKIT/Modal","DS/UIKIT/SuperModal","DS/VCXWebPlatform/VCXPlatformServices","DS/VCXMediaChooser/VCXMediaChooserLoadServices","DS/VCXWebIO/VCXCanvasServices","DS/VCXMediaChooser/VCXImageGallery","DS/i3DXCompassServices/i3DXCompassPubSub","DS/WebappsUtils/WebappsUtils","DS/WAFData/WAFData","i18n!DS/VCXMediaChooser/assets/nls/VCXChoosePicture","css!DS/VCXMediaChooser/VCXMediaChooser"],function(t,e,i,n,s,o,a,r,l,c,h,u,d){"use strict";var _=UWA.Class.extend({init:function(t){this._onOpenFile=null,this._url=null,this._loadServices=new a,this._drivePanelAnchor="sidepanel:X3PDRIV_AP",this._widget=null,this._experienceBase=t},get3DDriveURL:async function(){if(this._experienceBase.getManager("VCXContextManager").isSupported("Cat3DXIntegration")){let t=await o.GetTenantId();return o.getServiceUrl("3DDrive",t)}return null},setWidget:function(t){this._widget=t},setODTMode:function(t){this._ODTMode=t},open:async function(t,e){this._onOpenFile=t,this._onHideCB=e;var i=new s({className:"choose-picture-modal"});i.onHide=this.onHide.bind(this,i),this._cacheUrl3DDrive=await this.get3DDriveURL(),this._chooseProviderContent(i)},dropImage:async function(t,e){this._onOpenFile=e;const i=await r.loadImage(t);let n=this._computeImageUrl(i,null);this._url=n&&n.blobUrl,this._onOpenFile(this._url)},onHide:function(t){this._ignoreHide||(this._onHideCB(),this._url=null),t.destroy(),c.unsubscribe("setX3DContent")},_chooseProviderContent:function(t){var e=[];if(this._ODTMode){var i=this._createProviderObject(d.get("odtBtnLabel"),this._onODTClick.bind(this,t),"fonticon-cog",null);e.push(i);new UWA.Element("input",{type:"hidden",id:"x3DPhoto-ODT-imageUrl"}).inject(document.body)}var n=this._createProviderObject(d.get("deviceBtnLabel"),this._onComputerClick.bind(this,t),"fonticon-install",null);if(e.push(n),this._cacheUrl3DDrive){var s=this._getDrivePanelUrl(),o=this._createProviderObject(d.get("driveBtnLabel"),this._on3DDriveClick.bind(this,t),"fonticon-component",s);e.push(o)}var a=null;l.countVisibleSections()>1?a=this._createAccordionContainer("divided",t):1==l.countVisibleSections()&&(a=this._createSectionContainer(t)),a&&e.push(a);var r=new UWA.Element("div",{html:e});t.dialog({body:r,title:d.get("title"),buttons:[{value:d.get("cancelBtnLabel"),action:t=>{t.hide()}}]});var c=document.getElementById("toScroll");c&&this._addToScroller(c)},_onComputerClick:function(t){this._loadServices.openFileSelector((e,i)=>{this._loadLocalImage(t,e,i)})},_onODTClick:function(t){var e=document.getElementById("x3DPhoto-ODT-imageUrl");this._loadLocalImage(t,e.value)},_loadLocalImage:async function(t,e,i){const n=await r.loadImage(e);let s=this._computeImageUrl(n,i&&i.type);if("image/svg+xml"!==i.type){if(this._url=s&&s.blobUrl,this._fileName=i&&i.name||"",i&&this._fileName&&i.type!==s.type){let t=s.type.split("/").pop();this._fileName+="."+t}}else this._url=e,this._fileName=i&&i.name||"";this._onOpenFile(this._url,this._fileName),t.next()},_on3DDriveClick:function(t){var e=this._selectPictureContent(t);this._ignoreHide=!0,t.next(),this._ignoreHide=!1,c.subscribe("setX3DContent",this._on3DXContentSelection.bind(this,e))},_onRecentContentClick:async function(t){const e=await r.getBlobUrlFromImg(this._url,this._type);this._url=e,this._onOpenFile(this._url),t.next()},_onRecentTextureClick:async function(t){const e=r.getBlobUrlFromImg(this._url,this._type);this._url=e,this._onOpenFile(this._url),t.next()},_onSampleClick:async function(t,e){if(this._url=l.getThumbnailPropertiesByID(e),!this._url.type)return this._onOpenFile(this._url),void t.next();if("side"==this._url.type){for(var i in this._url.set){var n=this._url.set[i];n&&"string"==typeof n&&(this._url.set[i]=n?n.match("http")?n:h.getWebappsAssetUrl("VCXMediaChooser",n):null)}this._url.set.front=await r.getBlobUrlFromImg(this._url.set.front,this._type),this._url.set.left=await r.getBlobUrlFromImg(this._url.set.left,this._type),this._url.set.top=await r.getBlobUrlFromImg(this._url.set.top,this._type),this._onOpenFile(this._url),t.next()}else"scene"==this._url.type?(this._url.background=h.getWebappsAssetUrl("VCXMediaChooser",this._url.background),this._onOpenFile(await r.getBlobUrlFromImg(this._url.background,this._type)),t.next()):(this._onOpenFile(this._url),t.next())},_selectPictureContent:function(t){var e=h.getWebappsAssetUrl("VCXMediaChooser","graphics/G_NXGAddImageWhite.png"),i=new UWA.Element("div",{html:[{tag:"div",class:"thumbnail",styles:{backgroundImage:"url("+e+")"},html:{tag:"img",src:e,class:"hide"}}]});return t.dialog({body:i,title:d.get("title"),buttons:[{className:"primary",value:d.get("validateBtnLabel"),action:t=>{this._url&&(this._onOpenFile(this._url),t.hide())}},{value:d.get("cancelBtnLabel"),action:t=>{t.hide()}}]}),i.getElementsByTagName("img")[0]},_on3DXContentSelection:function(t,e){if(e&&null!=e.data.items[0]){var i=this._cacheUrl3DDrive+"/resources/3ddrive/v1/bos/"+e.data.items[0].objectId+"/download";u.authenticatedRequest(i,{method:"GET",type:"json",onComplete:e=>{r.loadImage(e.url).then(e=>{let i=this._computeImageUrl(e,"image/png");this._url=i&&i.blobUrl,t.parentNode.setStyle("backgroundImage","url("+this._url+")")})},onFailure:t=>{console.error(t)}})}},_createProviderObject:function(t,e,i,n){return{tag:"a",href:n||"javascript:void(0)",target:"_parent",html:{tag:"div",class:"provider",html:[{tag:"span",class:"fonticon "+i+" fonticon-2x"},{tag:"span",class:"name",text:t}],events:{click:e}}}},_createPictureContainer:async function(t,e,i){var n=new UWA.Element("div",{class:"section-thumbnail",events:{click:()=>{this._url=t,e?i(e):i()}}});const s=await r.loadImage(t);return s.naturalWidth>s.naturalHeight?n.addClassName("landscape"):n.addClassName("portrait"),n.appendChild(s),n},_createSectionContent:function(t,e,i){if(n=null,t&&t.length>0){var n=new UWA.Element("div",{class:"section-thumbnail-container",id:"toScroll"});t.forEach((t,s)=>{this._createPictureContainer(t,e?e[s]:null,i).inject(n,"bottom")}),new UWA.Element("div",{class:"section-padding-trick"}).inject(n)}return n},_createAccordionContainer:function(t,e){var n=new UWA.Element("div",{class:"section-container"}),s=new i({className:t||"",exclusive:!1,items:[]});return l.getSectionsNames().forEach(t=>{l.isSectionVisible(t)&&(s.addItem({title:l.getSectionTitle(t),name:t,content:this._createSectionContent(l.getThumbnails(t),l.getIDs(t),this[l.getOnClickCB(t)].bind(this,e)),selected:l.isSectionSelected(t)}),s.inject(n))}),n},_createSectionContainer:function(t){var e=new UWA.Element("div",{class:"section-container"});return l.getSectionsNames().forEach(i=>{if(l.isSectionVisible(i)){var n=this._createSectionContent(l.getThumbnails(i),l.getIDs(i),this[l.getOnClickCB(i)].bind(this,t));if(n)new UWA.Element("div",{class:"section-title",text:l.getSectionTitle(i)}).inject(e),n.inject(e)}}),e},_addToScroller:function(t){new e(t,{scrollbarV:!1,scrollableY:!1})},_getDrivePanelUrl:function(){return parent.document.location.hash="","/#"+this._drivePanelAnchor},_computeImageUrl:function(t,e){var i=this._widget?this._widget.getValue("ImageOptimization"):"1";if("-1"!==i||!(t.width>r.maxCanvasWidth||t.height>r.maxCanvasHeight))return r.optimizeImage(t,i,e);this._openImageOtimizationModal(i=>r.optimizeImage(t,i,e))},_openImageOtimizationModal:function(t){var e=new n({className:"image-optimization",overlay:!0,closable:!1,header:"<h4>"+d.get("optimTitle")+"</h4>",body:"<p>"+d.get("optimMessage1")+"</p><p>"+d.get("optimMessage2")+'</p><br /><p><font size="2">'+d.get("optimTip")+"</font></p>",footer:'<button type="button" class="btn btn-primary" value="1">'+d.get("optimYesBtnLabel")+'</button> <button type="button" class="btn btn-default" value="0">'+d.get("optimNoBtnLabel")+"</button>"}).inject(document.body);e.onHide=this._onImageOptimizationHide.bind(this,e),e.getContent().getElements(".btn").forEach(i=>{i.addEvent("click",()=>{e.hide(),this._widget&&this._widget.setValue("ImageOptimization",i.value),t(i.value)})}),e.show()},_onImageOptimizationHide:function(t){t.destroy()}});return UWA.namespace("DS/VCXMediaChooser/VCXChoosePicture",_)});