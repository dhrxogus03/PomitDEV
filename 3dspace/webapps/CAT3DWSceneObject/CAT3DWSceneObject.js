define("DS/CAT3DWSceneObject/CAT3DWSceneObject",["DS/CAT3DWInfra/CAT3DWLogger","DS/Visualization/ThreeJS_DS","UWA/Class","UWA/Core"],function(t,e,i,r){"use strict";var s=i.extend({init:function(e){if(this._isLocked=!1,this._group=void 0,this._isInitialized=!1,e instanceof Object)if(this._lifecycleHistoryArray=[],this._transformationHistoryArray=[],this._propertiesHistoryArray=[],this._lockHistoryArray=[],this._groupHistoryArray=[],this._actionsHistoryMap=new Map,this._hyperlink=null,this._lifecycleHistoryArray.activeIndex=-1,this._transformationHistoryArray.activeIndex=-1,this._propertiesHistoryArray.activeIndex=-1,this._lockHistoryArray.activeIndex=-1,this._groupHistoryArray.activeIndex=-1,this._lifecycleHistoryArray.onChange=this._onChangeLifecycle.bind(this),this._transformationHistoryArray.onChange=this._onChangeTransformation.bind(this),this._propertiesHistoryArray.onChange=this._onChangePropertiesUpdate.bind(this),this._lockHistoryArray.onChange=this._onChangeLockUnlock.bind(this),this._groupHistoryArray.onChange=this._onChangeGroup.bind(this),e.hyperlink&&(this._hyperlink=e.hyperlink),e.history){let t,i=e.history,r=(e,i)=>{for(t=0;t<e.length;t++)i.push(e[t]),e[t].active&&(i.activeIndex=t)};r(i.lifecycleHistory,this._lifecycleHistoryArray),r(i.transformationHistory,this._transformationHistoryArray),r(i.propertiesHistory,this._propertiesHistoryArray),r(i.lockHistory,this._lockHistoryArray),r(i.groupHistory,this._groupHistoryArray);let s=null,o=[],n=[];for(let e=0;e<i.actionsHistory.length;e++){for(s=i.actionsHistory[e],t=0;t<s.stacks.length;t++)o.push(this._getStackFromNumber(s.stacks[t])),n.push(s.indexes[t]);this._actionsHistoryMap.set(s.timestamp,{stacks:o,indexes:n})}e.locked&&(this._isLocked=!0)}else{let i=null;i=e.state?e.state:this.getInititalState(),this._addToStack(0,this._transformationHistoryArray,i.transformation),this._addToStack(0,this._propertiesHistoryArray,i.properties),e.timestamp?(this._addToStack(0,this._lifecycleHistoryArray,{alive:!1}),this._logAction(e.timestamp,this._lifecycleHistoryArray,{alive:!0}),e.locked&&(this._needsToBeLocked=e.timestamp)):(t.error("SceneObject created without timestamp !",this.getID?this.getID():""),this._addToStack(0,this._lifecycleHistoryArray,{alive:!0}),e.locked&&(this._needsToBeLocked=!0))}},initialize:function(){this._isInitialized=!0,this._needsToBeLocked&&("number"==typeof this._needsToBeLocked?this.lock(this._needsToBeLocked):this.lock())},garbage:function(e){t.log("garbage",e,this.getID?this.getID():""),this._logAction(e,this._lifecycleHistoryArray,{alive:!1})},ungarbage:function(e){t.warn("ungarbage ?",this.getID?this.getID():""),this._logAction(e,this._lifecycleHistoryArray,{alive:!0})},isAlive:function(){return!this._lifecycleHistoryArray||!(this._lifecycleHistoryArray.activeIndex<0)&&this._lifecycleHistoryArray[this._lifecycleHistoryArray.activeIndex].data.alive},getID:function(){throw new Error("Must be implemented")},getType:function(){throw new Error("Must be implemented")},select:function(){t.error("select method has to be implemented !")},deselect:function(){t.error("deselect method has to be implemented !")},coselect:function(){t.error("coselect method has to be implemented !")},decoselect:function(){t.error("decoselect method has to be implemented !")},lock:function(t){this._isLocked||(this._isLocked=!0,t?this._duplicateCurrentState(t)&&this._logAction(t,this._lockHistoryArray,{lifecycleIndex:this._lifecycleHistoryArray.length-1,transformationIndex:this._transformationHistoryArray.length-1,propertiesIndex:this._propertiesHistoryArray.length-1}):this._addToStack(0,this._lockHistoryArray,{lifecycleIndex:this._lifecycleHistoryArray.length-1,transformationIndex:this._transformationHistoryArray.length-1,propertiesIndex:this._propertiesHistoryArray.length-1}))},unlock:function(t){if(this._isLocked&&(this._isLocked=!1,this._lifecycleHistoryArray&&t)){let e=this._lockHistoryArray[this._lockHistoryArray.activeIndex].timestamp;this._logAction(t,this._lockHistoryArray,{lockTimestamp:e})}},isLocked:function(){return this._isLocked&&this._isInitialized},group:function(t,e){this._group=e.getID(),this._duplicateCurrentState(t)&&this._logAction(t,this._groupHistoryArray,{group:this._group})},ungroup:function(t){if(this._group&&(this._group=void 0,t)){let e=this._groupHistoryArray[this._groupHistoryArray.activeIndex].timestamp;this._logAction(t,this._groupHistoryArray,{groupTimestamp:e})}},isGrouped:function(){return!!this._group},getGroupID:function(){return this._group},setHyperlink:function(t,e){this._hyperlink=e;var i=this.getCurrentProperties(),r=JSON.parse(JSON.stringify(i));r.hyperlink=this._hyperlink,this.setProperties(t,r)},getHyperlink:function(){return this._hyperlink},deleteHyperlink:function(t){this._hyperlink&&(this._hyperlink=null);var e=this.getCurrentProperties(),i=JSON.parse(JSON.stringify(e));i.hyperlink=null,this.setProperties(t,i)},undoAction:function(e){let i=this._actionsHistoryMap.get(e);if(i){let t=null,e=-1;for(let r=0;r<i.stacks.length;r++)t=i.stacks[r],e=i.indexes[r],this._changeStackActiveIndex(t,e,!1);return!0}return t.error("No action found !",this.getID?this.getID():""),!1},redoAction:function(e){let i=this._actionsHistoryMap.get(e);if(i){let t=null,e=-1;for(let r=0;r<i.stacks.length;r++)t=i.stacks[r],e=i.indexes[r],this._changeStackActiveIndex(t,e,!0);return!0}return t.error("No action found !",this.getID?this.getID():""),!1},setTransformation:function(t,e,i=!1){return!(this.isLocked()||!this._actionsHistoryMap)&&(this._logAction(t,this._transformationHistoryArray,{matrixArray:e.toArray()},i),!0)},getCurrentTransformation:function(){if(this._transformationHistoryArray){let t=this._transformationHistoryArray[this._transformationHistoryArray.activeIndex];return(new e.Matrix4).fromArray(t.data.matrixArray)}return null},setProperties:function(t,e,i=!1){return!(this.isLocked()||!this._actionsHistoryMap)&&(this._logAction(t,this._propertiesHistoryArray,e,i),!0)},getCurrentProperties:function(){if(this._propertiesHistoryArray){return this._propertiesHistoryArray[this._propertiesHistoryArray.activeIndex].data}return null},setTransientPermanent:function(){return!(!this._actionsHistoryMap||!this._actionsHistoryMap.transient)&&(this._actionsHistoryMap.transient=void 0,!0)},hasOngoingTransient:function(){return this._actionsHistoryMap&&this._actionsHistoryMap.transient},getInititalState:function(){return{transformation:{matrixArray:null},properties:{}}},_lifecycleUpdate:function(){},_transformationUpdate:function(){},_propertiesUpdate:function(t){"CAT3DWImage"!==this.getType()&&"CAT3DWText"!==this.getType()&&"CAT3DWVideo"!==this.getType()||void 0!==t.hyperlink&&(this._hyperlink=t.hyperlink)},_lockUpdate:function(){},_getCurrentState:function(){const t=this._transformationHistoryArray[this._transformationHistoryArray.activeIndex],e=this._propertiesHistoryArray[this._propertiesHistoryArray.activeIndex];return{transformation:t.data,properties:e.data}},stream:function(t){let e={locked:this._isLocked,hyperlink:this._hyperlink};if(t){let t=[];this._actionsHistoryMap.forEach((e,i)=>{let r=[],s=[];for(let t=0;t<e.stacks.length;t++)r.push(this._getStackNumber(e.stacks[t])),s.push(e.indexes[t]);t.push({timestamp:i,stacks:r,indexes:s})}),e.history={lifecycleHistory:this._lifecycleHistoryArray,transformationHistory:this._transformationHistoryArray,propertiesHistory:this._propertiesHistoryArray,lockHistory:this._lockHistoryArray,groupHistory:this._groupHistoryArray,actionsHistory:t}}else e.state=this._getCurrentState();return e},getAction:function(t){let e=this._actionsHistoryMap.get(t);if(!e)return null;if(this._isCreationAction(e))return this.stream(!0);let i={stacks:[],indexes:[],states:[],transient:this._actionsHistoryMap.transient===t};for(let t=0;t<e.stacks.length;t++)if(i.stacks.push(this._getStackNumber(e.stacks[t])),i.indexes.push(e.indexes[t]),e.stacks[t]===this._lockHistoryArray){let r=e.stacks[t][e.indexes[t]];if(r.data.lockTimestamp)i.states.push(e.stacks[t][e.indexes[t]]);else{let t={data:{lifecycleState:this._lifecycleHistoryArray[r.data.lifecycleIndex],transformationState:this._transformationHistoryArray[r.data.transformationIndex],propertiesState:this._propertiesHistoryArray[r.data.propertiesIndex]},active:!0};i.states.push(t)}}else i.states.push(e.stacks[t][e.indexes[t]]);return i},setAction:function(e,i){let r,s,o;if(this._actionsHistoryMap.get(e))throw new Error("There is already an exiting action with timestamp "+e);for(let n=0;n<i.stacks.length;n++)r=this._getStackFromNumber(i.stacks[n]),o=i.states[n],r&&o&&(r!==this._lockHistoryArray||o.data.lockTimestamp||(this._lifecycleHistoryArray.push(o.data.lifecycleState),this._lifecycleHistoryArray.activeIndex=this._lifecycleHistoryArray.length-1,this._transformationHistoryArray.push(o.data.transformationState),this._transformationHistoryArray.activeIndex=this._transformationHistoryArray.length-1,this._propertiesHistoryArray.push(o.data.propertiesState),this._propertiesHistoryArray.activeIndex=this._propertiesHistoryArray.length-1,o={data:{lifecycleIndex:this._lifecycleHistoryArray.activeIndex,transformationIndex:this._transformationHistoryArray.activeIndex,propertiesIndex:this._propertiesHistoryArray.activeIndex},active:!0}),(s=this._logAction(e,r,o.data,i.transient))!==i.indexes[n]&&t.warn("action created with a different index",this.getID?this.getID():""))},hasAction:function(t){return this._actionsHistoryMap.has(t)},_duplicateCurrentState:function(t){if(this._lifecycleHistoryArray.activeIndex<0)throw new Error("locking a deleted object !");return this._duplicateStateAtIndex(t,this._lifecycleHistoryArray,this._lifecycleHistoryArray.activeIndex),this._duplicateStateAtIndex(t,this._transformationHistoryArray,this._transformationHistoryArray.activeIndex),this._duplicateStateAtIndex(t,this._propertiesHistoryArray,this._propertiesHistoryArray.activeIndex),!0},_duplicateStateAtIndex:function(t,e,i){let r=e[i];this._logAction(t,e,r.data)},_logAction:function(e,i,r,s){let o=null;if(this._actionsHistoryMap.transient){let e=this._actionsHistoryMap.get(this._actionsHistoryMap.transient);if(!s||e.stacks[0]!==i)throw t.trace("BAM !",this.getID?this.getID():""),new Error("logging a new action while there is an existing transient action !");if(e.indexes[0]!==i.activeIndex)throw t.trace("REBAM !",this.getID?this.getID():""),new Error("the existing transient action is not the active one !");i.splice(e.indexes[0],1),this._actionsHistoryMap.delete(this._actionsHistoryMap.transient),this._actionsHistoryMap.transient=void 0}else{if(s&&this._actionsHistoryMap.has(e))throw new Error("can't create a transient action on an already existing action");i.activeIndex>-1&&(o=i[i.activeIndex])}let n=this._addToStack(e,i,r);return this._addToHistoryMap(e,i,n),s&&(this._actionsHistoryMap.transient=e),i.onChange(i[n],o),n},_addToStack:function(t,e,i){let r={timestamp:t,active:!0,data:i},s=-1;for(let i=e.length-1;i>-1;--i)if(e[i].timestamp<t){s=i+1,e.splice(i+1,0,r);break}return-1===s&&(s=0,e.splice(0,0,r)),s>e.activeIndex&&(e.activeIndex=s),s},_addToHistoryMap:function(t,e,i){let r=this._actionsHistoryMap.get(t);r?(r.stacks.push(e),r.indexes.push(i)):this._actionsHistoryMap.set(t,{stacks:[e],indexes:[i]})},_changeStackActiveIndex:function(t,e,i){let r=null;if(t.activeIndex>-1&&(r=t[t.activeIndex]),i)t[e].active=!0,e>t.activeIndex&&(t.activeIndex=e,t.onChange(t[t.activeIndex],r));else if(t[e].active=!1,e===t.activeIndex){let e,i=t.activeIndex,s=null;for(t.activeIndex=-1,e=i;e>-1;--e)if(t[e].active){t.activeIndex=e,s=t[t.activeIndex];break}t.onChange(s,r)}},_onChangeLifecycle:function(t,e){e&&e.data.alive===t.data.alive||this._lifecycleUpdate(t.data)},_onChangeTransformation:function(t){this._transformationUpdate((new e.Matrix4).fromArray(t.data.matrixArray))},_onChangePropertiesUpdate:function(t){this._propertiesUpdate(t.data)},_onChangeLockUnlock:function(t,e){if(t)if(t.data.lockTimestamp){let e=this._actionsHistoryMap.get(t.data.lockTimestamp),i=0;if(1===e.stacks.length)i=this._actionsHistoryMap.get(t.data.lockTimestamp).indexes[0];else for(let r=0;r<e.stacks.length;r++)if(e.stacks[r]===this._lockHistoryArray){i=this._actionsHistoryMap.get(t.data.lockTimestamp).indexes[r];break}let r=this._lockHistoryArray[i].data;this._isLocked=!1,this._changeStackActiveIndex(this._lifecycleHistoryArray,r.lifecycleIndex,!1),this._changeStackActiveIndex(this._transformationHistoryArray,r.transformationIndex,!1),this._changeStackActiveIndex(this._propertiesHistoryArray,r.propertiesIndex,!1)}else this._changeStackActiveIndex(this._lifecycleHistoryArray,t.data.lifecycleIndex,!0),this._changeStackActiveIndex(this._transformationHistoryArray,t.data.transformationIndex,!0),this._changeStackActiveIndex(this._propertiesHistoryArray,t.data.propertiesIndex,!0),this._isLocked=!0;else this._isLocked=!1,this._changeStackActiveIndex(this._lifecycleHistoryArray,e.data.lifecycleIndex,!1),this._changeStackActiveIndex(this._transformationHistoryArray,e.data.transformationIndex,!1),this._changeStackActiveIndex(this._propertiesHistoryArray,e.data.propertiesIndex,!1);this._lockUpdate(this._isLocked)},_onChangeGroup:function(t){t&&void 0===t.data.groupTimestamp?this._group=t.data.group:this._group=void 0},_isCreationAction:function(t){let e=!1;for(let i=0;i<t.stacks.length;i++)if(t.stacks[i]===this._lifecycleHistoryArray&&(0===t.indexes[i]||1===t.indexes[i]&&this._lifecycleHistoryArray[1].data.alive)){e=!0;break}return e},_getStackNumber:function(t){switch(t){case this._lifecycleHistoryArray:return 0;case this._transformationHistoryArray:return 1;case this._propertiesHistoryArray:return 2;case this._lockHistoryArray:return 3;case this._groupHistoryArray:return 4;default:return-1}},_getStackFromNumber:function(t){switch(t){case 0:return this._lifecycleHistoryArray;case 1:return this._transformationHistoryArray;case 2:return this._propertiesHistoryArray;case 3:return this._lockHistoryArray;case 4:return this._groupHistoryArray;default:return null}}});return r.namespace("DS/CAT3DWSceneObject/CAT3DWSceneObject",s)}),define("DS/CAT3DWSceneObject/CAT3DWConnectableObject",["DS/CAT3DWSceneObject/CAT3DWSceneObject","DS/CAT3DWVisu/CAT3DWTolerance","DS/Visualization/ThreeJS_DS"],function(t,e,i){"use strict";return t.extend({_propertiesUpdate:function(t){this._parent(t)},getCenter:function(){throw new Error("Must be implemented")},getCorners:function(){throw new Error("Must be implemented")},get2DPortPosition:function(){throw new Error("Must be implemented")},isIntersect:function(t,e){for(var i=[],r=0;r<t.length;r++)for(var s=0;s<e.length;s++)this._intersect(t[r],t[(r+1)%t.length],e[s],e[(s+1)%e.length])&&i.push(e[s]);return 0==i.length?void 0:i},_intersect:function(t,e,i,r){return(this._isLeft(t,i,r)?1:0)^(this._isLeft(e,i,r)?1:0)&&(this._isLeft(i,t,e)?1:0)^(this._isLeft(r,t,e)?1:0)},_isLeft:function(t,e,i){return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)>=0},get2DProjectedPosition:function(){let t=new i.Vector3,r=new i.Vector3,s=new i.Vector3,o=new i.Vector3,n=new i.Vector3,a=new i.Vector3,c=new i.Vector3,h=new i.Vector3,l=new i.Vector3,y=new i.Vector3,p=new i.Vector3,d=new i.Vector3,_=new i.Vector3,u=new i.Vector3;return function(f,g,A){A.projectPoint(this.getCenter(),t),A.projectPoint(f,r),s.copy(r).sub(t),o.copy(r).sub(t).normalize();let H=this.getCorners();h.copy(H.topLeft).sub(t),l.copy(H.topRight).sub(t),y.copy(h).normalize(),p.copy(l).normalize();let m=o.dot(y),k=o.dot(p),x=null;if(m>e.toleranceForUnitaryVectors?(x=h.clone(),u.copy(h)):m<-e.toleranceForUnitaryVectors&&(x=h.clone().multiplyScalar(-1),u.copy(h)),k>e.toleranceForUnitaryVectors?(x=l.clone(),u.copy(l)):k<-e.toleranceForUnitaryVectors&&(x=l.clone().multiplyScalar(-1),u.copy(l)),!x){if(n.copy(A.normal),d.crossVectors(p,y).dot(A.normal)<0&&n.multiplyScalar(-1),d.crossVectors(o,y),_.crossVectors(o,p),d.dot(n)<0)if(_.dot(n)<0){a.copy(H.topRight).sub(H.topLeft).multiplyScalar(.5),c.copy(a).normalize();let t=a.length()/Math.abs(s.dot(c));x=s.multiplyScalar(t)}else{a.copy(H.topLeft).sub(H.bottomLeft).multiplyScalar(.5),c.copy(a).normalize();let t=a.length()/Math.abs(s.dot(c));x=s.multiplyScalar(t)}else if(_.dot(n)<0){a.copy(H.topLeft).sub(H.bottomLeft).multiplyScalar(.5),c.copy(a).normalize();let t=a.length()/s.dot(c);x=s.multiplyScalar(t)}else{a.copy(H.topRight).sub(H.topLeft).multiplyScalar(.5),c.copy(a).normalize();let t=a.length()/s.dot(c);x=s.multiplyScalar(t)}u.copy(c)}o.dot(u.normalize())<0&&u.normalize().negate();let I=A.projectPoint(x.add(t).add(u.multiplyScalar(g)));if(this.points){let t=new i.Vector3(I.x-f.x,I.y-f.y,I.z-f.z),e=[I,(new i.Vector3).addVectors(I,t.clone().multiplyScalar(1e3))],r=this.isIntersect(e,this.points);if(r){if(1==r.length)return new i.Vector2(r[0].x,r[0].y);let e=1e10,s=0;for(let t=0;t<r.length;t++)r[t].distanceTo(I)<e&&(e=r[t].distanceTo(I),s=t);let o=this.getMatrix().getScaleOnAxisX(),n=this.drawSettings.getThickness()/2,a=r[s].clone().sub(t.clone().normalize().multiplyScalar(n*o+g));return new i.Vector2(a.x,a.y)}return new i.Vector2(I.x,I.y)}return new i.Vector2(I.x,I.y)}}()})});