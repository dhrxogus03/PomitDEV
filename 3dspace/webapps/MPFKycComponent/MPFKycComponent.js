define("DS/MPFKycComponent/ShopMigrationHelper",["DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFAddressModel/AddressFactory","DS/MPFKYCDocumentModel/UboDocumentModel","DS/MPFCompanyUboModel/CompanyUboModel"],function(e,t,n,o,s){"use strict";return class{constructor({stripeTokenHandler:e,psp:t,company:n,shop:o,bankAccount:s,companyUbos:i,kycDocuments:a,addressFactory:r,kycDocumentFactory:c,uboDocumentFactory:d}){this.stripeTokenHandler=e,this.psp=t,this.company=n,this.shop=o,this.bankAccount=s,this.companyUbos=i,this.kycDocuments=a,this.addressFactory=r,this.kycDocumentFactory=c,this.uboDocumentFactory=d}getUboData(){return this.uboData}fetchData(){return Promise.all([this.loadUboData(),this.kycDocuments.fetchPromise(),this.shop.fetchPromise({expand:[]})])}async loadUboData(){this.uboData=await Promise.all(this.companyUbos.map(async e=>{await e.fetchPromise();const t=this.uboDocumentFactory.createCollection();t.setParentResourceId(e.get("id"));const o=await this.addressFactory.createModel(n.Types.ADDRESS,{id:e.getPostalAddressId()});return await Promise.all([t.fetchPromise(),o.fetchPromise()]),{ubo:e,uboAddress:o,documents:t}}))}async migrateShop(){const t=await this.stripeTokenHandler.createCompanyAccountToken();await this.company.savePromise({[e.Fields.ACCOUNT_TOKEN]:t,launchSellerMigration:"true"},{patch:!0});const n=await this.stripeTokenHandler.createBankToken();this.bankAccount.setParentResourceId(this.shop.get("id"));const o=this.bankAccount.omit();Object.keys(o).forEach(e=>{o[e]||delete o[e]}),await this.bankAccount.savePromise({bankToken:n,launchSellerMigration:"true",...o}),await Promise.all(this.uboData.map(async({ubo:e,uboAddress:t})=>{const n=await this.stripeTokenHandler.createPersonToken({person:e,address:t});await e.savePromise({personToken:n,launchSellerMigration:"true"},{patch:!0})}))}areAllDocumentsUploaded(){for(let e=0;e<this.kycDocuments.size();e++){const t=this.kycDocuments.at(e).getStatus();if(this.kycDocuments.at(e).getKycType()&&t!==o.States.UPLOADED&&t!==o.States.VALIDATED)return!1}for(let e=0;e<this.uboData.length;e++){const{documents:t}=this.uboData[e];for(let e=0;e<t.size();e++){const n=t.at(e).getStatus();if(n!==o.States.UPLOADED&&n!==o.States.VALIDATED)return!1}}return!0}async patchPersonCompletion(){await Promise.all(this.uboData.map(({ubo:e})=>e.savePromise({[s.Fields.STATE]:s.States.COMPLETE},{patch:!0})));const n=await this.stripeTokenHandler.createCompanyAccountToken({attributes:{executives_provided:!0,directors_provided:!0,owners_provided:!0}});await this.company.savePromise({[e.Fields.EXECUTIVES_PROVIDED]:"TRUE",[e.Fields.DIRECTORS_PROVIDED]:"TRUE",[e.Fields.OWNERS_PROVIDED]:"TRUE",accountToken:n},{patch:!0}),await this.shop.savePromise({[t.Fields.MIGRATION_STATUS]:"PENDING_VALIDATION"},{patch:!0})}}}),define("DS/MPFKycComponent/KycCompanyRegistrationInformationStripeCAN",["UWA/Core","UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFView/FieldTextInputV2","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c){"use strict";const d=Object.freeze({ON_SAVE:"onSave"}),l=t.extend({className:"mpf-kyc-company-registration mpf-stripe mpf-horizontal",setup:function(e){i.requiredOfPrototype(e.company,a,"options.company must be a CompanyModel"),this.company=e.company,this.isReadOnly=this._isInfoComplete(),this.alert=this._createAlert(),this.registrationIdInput=this._createRegistrationIdInput(),this.saveButton=this._createSaveButton(),this.listenTo(this.registrationIdInput,"update",this._onChange.bind(this))},render:function(e){return this.container.setContent([this.alert,this.registrationIdInput.render(),this._createButtonContainer(this.saveButton)]),this},destroy:function(){this.stopListening(),this.registrationIdInput.destroy(),this.company=null,this._parent(),this.container=null},setReadOnly:function(e){e=!1!==e,this.registrationIdInput.setDisabled(e),this.saveButton.setDisabled(e)},_onChange:function(){this._isInfoComplete()?this.saveButton.enable():this.saveButton.disable()},_onSave:function(){if(this._isInfoComplete()&&this._validate()){const e={[a.Fields.REGISTRATION_ID]:this.registrationIdInput.getValue()};n.mask(this.container),this.company.savePromise(e,{patch:!0}).then(()=>{this.setReadOnly(!0),n.unmask(this.container),this.dispatchEvent(d.ON_SAVE)}).catch(e=>{n.unmask(this.container),console.error(e),this.alert.add({className:"error",message:c.get("errorOccured")}).show()})}},_validate:function(){return this.registrationIdInput.validate().isValid},_isInfoComplete:function(){return!!this.company.getRegistrationId()&&!this.company.validate(a.Fields.REGISTRATION_ID)},_createAlert:function(){return new s({visible:!1,autoHide:!0})},_createRegistrationIdInput:function(){return new r({model:this.company,fieldName:a.Fields.REGISTRATION_ID,fieldLabel:c.get("businessNumberTaxId"),required:!0,dynamicValidation:!0,saveOnChange:!1,readOnly:this.isReadOnly})},_createSaveButton:function(){return new o({className:"primary",value:c.get("save"),disabled:!0,events:{onClick:this._onSave.bind(this)}})},_createButtonContainer:function(t){return e.createElement("div",{class:"mpf-button-container",html:this.isReadOnly?[]:[t]})}});return l.Events=d,l}),define("DS/MPFKycComponent/KycCompanyUboPersonalInfoForm",["UWA/Core","UWA/Event","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressConstraintsModel/AddressConstraintsCollection","DS/MPFCountryModel/CountryCollection","DS/MPFPspModel/PspModel","DS/MPFView/FieldSelectInputV2","DS/MPFView/FieldTextInputV2","DS/MPFView/FieldDateInput","DS/MPFAddressFormComponent/AddressFormComponentV2","DS/MPFView/EmptyView","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m){"use strict";return n.extend({tagName:"form",className:"mpf-kyc-ubo-form-personal mpf-horizontal clearfix",setup:function(e={}){o.requiredOfPrototype(e.companyUbo,s,"options.companyUbo must be a CompanyUboModel"),o.requiredOfPrototype(e.address,i,"options.companyUbo must be a CompanyUboModel"),o.requiredOfPrototype(e.addressConstraints,a,"options.companyUbo must be a CompanyUboModel"),o.requiredOfPrototype(e.countries,r,"options.countries must be an CountryCollection"),this.companyUbo=e.companyUbo,this.address=e.address,this.addressConstraints=e.addressConstraints,this.countries=e.countries,this.psp=e.psp,this.company=e.company,this.formTitle=this._createFormTitle(),this.titleField=this._createTitleField(),this.firstNameField=this._createFirstNameField(),this.lastNameField=this._createLastNameField(),this.nationalityField=this._createNationalityField(),this.dateOfBirthField=this._createDateOfBirthField(),this.placeOfBirthField=this._createPlaceOfBirthField(),this.countryOfBirthField=this._createCountryOfBirthField(),this.addressForm=this._createAddressForm(),this.emailField=this._createEmailField(),this.phoneNumberField=this._createPhoneNumberField(),this.ssnField=this._createSsnField(),this.container.addEvent("submit",function(e){t.stop(e)})},render:function(){return this.container.setContent([this.formTitle,this.titleField.render(),this.firstNameField.render(),this.lastNameField.render(),this.nationalityField.render(),this.dateOfBirthField.render(),this.placeOfBirthField.render(),this.countryOfBirthField.render(),this.addressForm.render(),this.emailField.render(),this.phoneNumberField.render(),this.ssnField.render()]),this},validate:function(){const e=this.titleField.validate().isValid,t=this.firstNameField.validate().isValid,n=this.lastNameField.validate().isValid,o=this.dateOfBirthField.validate().isValid,s=this.placeOfBirthField.validate().isValid,i=this.nationalityField.validate().isValid,a=this.countryOfBirthField.validate().isValid,r=this.addressForm.validate();let d=e&&t&&n&&o&&s&&i&&a&&r;if(this.psp.getPsp()===c.Psp.STRIPE){const e=this.emailField.validate&&this.emailField.validate().isValid,t=this.phoneNumberField.validate&&this.phoneNumberField.validate().isValid;d=d&&e&&t}return d},canGoNext:function(){const e=this.titleField.validate().isValid,t=this.firstNameField.validate().isValid,n=this.lastNameField.validate().isValid,o=this.dateOfBirthField.validate().isValid,s=this.nationalityField.validate().isValid;let i=e&&t&&n&&o&&s;if(this.psp.getPsp()===c.Psp.STRIPE){const e=this.emailField.validate&&this.emailField.validate().isValid,t=this.phoneNumberField.validate&&this.phoneNumberField.validate().isValid,n=!this.ssnField.validate||this.ssnField.validate().isValid;i=i&&e&&t&&n}return i},_createFormTitle:function(){return e.createElement("h4",{class:"mpf-form-title",text:m.get("identity")})},_createTitleField:function(){var e=[{value:"Mr",label:m.get("Mr"),selected:"Mr"===this.companyUbo.getTitle()},{value:"Mrs",label:m.get("Mrs"),selected:"Mrs"===this.companyUbo.getTitle()}];return new d({model:this.companyUbo,fieldName:s.Fields.TITLE,fieldLabel:m.get("title"),selectableOptions:e,placeholder:m.get("selectTitle"),required:!0,dynamicValidation:!0})},_createFirstNameField:function(){return new l({model:this.companyUbo,fieldName:s.Fields.FIRST_NAME,fieldLabel:m.get("firstName"),required:!0,dynamicValidation:!0})},_createLastNameField:function(){return new l({model:this.companyUbo,fieldName:s.Fields.LAST_NAME,fieldLabel:m.get("lastName"),required:!0,dynamicValidation:!0})},_createNationalityField:function(){return new d({model:this.companyUbo,fieldName:s.Fields.NATIONALITY,fieldLabel:m.get("nationality"),placeholder:m.get("selectNationality"),required:!0,dynamicValidation:!0,selectableOptions:this.countries.map(e=>({value:e.getIso3(),label:e.getName(),selected:e.getIso3()===this.companyUbo.getNationality()}))})},_createDateOfBirthField:function(){const e=new Date;return e.setFullYear(e.getFullYear()-13),new p({className:"mpf-entry-v2 mpf-date",model:this.companyUbo,fieldName:s.Fields.DATE_OF_BIRTH,fieldLabel:m.get("dateOfBirth"),required:!0,max:e,renderDatePickerInside:!0})},_createPlaceOfBirthField:function(){return new l({model:this.companyUbo,fieldName:s.Fields.PLACE_OF_BIRTH,fieldLabel:m.get("placeOfBirth"),required:!0,dynamicValidation:!0})},_createCountryOfBirthField:function(){const e=new d({model:this.companyUbo,fieldName:s.Fields.COUNTRY_OF_BIRTH,fieldLabel:m.get("countryOfBirth"),required:!0,dynamicValidation:!0,placeholder:m.get("selectCountry"),selectableOptions:this.countries.map(function(e){return{value:e.getIso3(),label:e.getName()}})});return e.setValue(this.companyUbo.getCountryOfBirth(),{silent:!0}),e},_createAddressForm:function(){return new h({addressModel:this.address,addressConstraints:this.addressConstraints,countries:this.countries,keepErrorMessages:!0})},_createEmailField:function(){let e;return e=this.psp.getPsp()===c.Psp.STRIPE?new l({model:this.companyUbo,fieldName:s.Fields.EMAIL,fieldLabel:m.get("email"),required:!0,dynamicValidation:!0}):u.getInstance()},_createPhoneNumberField:function(){return this.psp.getPsp()===c.Psp.STRIPE?new l({model:this.companyUbo,fieldName:s.Fields.PHONE_NUMBER,fieldLabel:m.get("phoneNumber"),required:!0,dynamicValidation:!0,tooltip:m.get("phoneNumberTootlip")}):u.getInstance()},_createSsnField:function(){let e;return e=this.psp.isStripeUS()&&"USA"===this.company.getCountry()?new l({model:this.companyUbo,fieldName:s.Fields.SSN,fieldLabel:m.get("ssn4or9Digits"),required:!0,dynamicValidation:!0}):u.getInstance()}})}),define("DS/MPFKycComponent/KycCompanyUboDocumentsFormV2",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFKYCDocumentModel/UboDocumentModel","DS/MPFKYCDocumentModel/UboDocumentCollection","DS/MPFPspModel/PspModel","DS/MPFView/FieldTextInputV2","DS/MPFView/FieldFileInput","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d){"use strict";return t.extend({className:"mpf-kyc-company-ubo-document-form-v2",setup:function(e){n.requiredOfPrototype(e.ubo,o,"options.ubo must be a CompanyUboModel"),n.requiredOfPrototype(e.uboDocs,i,"options.uboDocs must be a UboDocumentCollection"),this.ubo=e.ubo,this.address=e.address,this.uboDocs=e.uboDocs,this.psp=e.psp,this.acceptedFileTypes=e.acceptedFileTypes,this.stripeTokenHandler=e.stripeTokenHandler,this.idNumberInput=this._createIdNumberInput(),this.idFileInput=this._createIdFileInput(),(this.psp.getPsp()===a.Psp.HIPAY||this.psp.isStripeEU()||this.psp.isStripeGB())&&(this.addressFileInput=this._createAddressFileInput(),this.listenTo(this.ubo,"onChange",this._handleAddressInputVisibility.bind(this)))},render:function(){return this.container.setContent([this.idNumberInput.render(),this.idFileInput.render()]),this.idFileInput.fileModel.getState()===s.States.REJECTED&&this.idFileInput.showErrorMessage(d.get("documentRejected")),e.is(this.addressFileInput,"object")&&(this.container.addContent(this.addressFileInput.render()),this.addressFileInput.fileModel.getState()===s.States.REJECTED&&this.addressFileInput.showErrorMessage(d.get("documentRejected"))),this._handleAddressInputVisibility(),this},destroy:function(){this.stopListening(this.ubo),this.idNumberInput.destroy(),this.idFileInput.destroy(),e.is(this.addressFileInput,"object")&&this.addressFileInput.destroy(),this.ubo=null,this.uboDocs=null,this.psp=null,this._parent(),this.container=null},async saveIdFile(){if(!this.uboDocs.hasDocument(s.DocumentTypes.KYC_PERSON_ID)&&this.idFileInput.validate()){const{stripeFileToken:e,stripePersonToken:t}=await this._createStripeTokens({file:this.idFileInput.getFile()});await this.idFileInput.save({stripePersonToken:t,stripeFileToken:e}),this.disableIdInput()}},async saveAddressFile(){if(e.is(this.addressFileInput,"object")&&!this.uboDocs.hasDocument(s.DocumentTypes.KYC_PERSON_ADDRESS)&&this.addressFileInput.validate()){const{stripeFileToken:e,stripePersonToken:t}=await this._createStripeTokens({file:this.addressFileInput.getFile(),isAddressFile:!0});await this.addressFileInput.save({stripeFileToken:e,stripePersonToken:t}),this.disableAddressInput()}},disableIdInput:function(){this.uboDocs.hasDocument(s.DocumentTypes.KYC_PERSON_ID)&&this.idFileInput.disable()},disableAddressInput:function(){this.uboDocs.hasDocument(s.DocumentTypes.ADDRESS)&&this.addressFileInput.disable()},async _createStripeTokens({file:e,isAddressFile:t=!1}){let n,o;if(this.psp.isStripeEU()){o=await this.stripeTokenHandler.uploadFileToStripe(e);const s={person:this.ubo,address:this.address};t?s.addressFileToken=o:s.idFileToken=o,n=await this.stripeTokenHandler.createPersonToken(s)}return{stripeFileToken:o,stripePersonToken:n}},_handleAddressInputVisibility:function(){this.addressFileInput&&this.psp.getPsp()!==a.Psp.HIPAY&&(this.ubo.isRepresentative()||this.ubo.isExecutive()||this.ubo.isOwner()?this.addressFileInput.container.show():this.addressFileInput.container.hide())},validate:function(){const e=this.idNumberInput.validate().isValid,t=this.idFileInput.isDisabled()||this.idFileInput.validate(),n=!this.addressFileInput||(this.addressFileInput.container.isHidden()||this.addressFileInput.isDisabled()||this.addressFileInput.validate());return e&&t&&n},_createIdNumberInput:function(){return new r({model:this.ubo,fieldName:o.Fields.IDENTITY_DOCUMENT_IDENTIFICATION_NUMBER,fieldLabel:d.get("indentityDocumentIdentificationNumber"),required:!0,dynamicValidation:!0,saveOnChange:!1,tooltip:d.get("uboIdNumberMustMatchDocument"),acceptedFileTypes:this.acceptedFileTypes})},_createIdFileInput:function(){return this._createFileInput(s.DocumentTypes.KYC_PERSON_ID,d.get("passportOrIdCard"),d.get("passportOrIdCardOrDrivingLicence"))},_createAddressFileInput:function(){return this._createFileInput(s.DocumentTypes.KYC_PERSON_ADDRESS,d.get("proofOfAddress"),d.get("uboDocMustContainAddress"))},_createFileInput:function(e,t,n){const o=this._getOrCreateModel(e),i=o.get(s.Fields.FILENAME)||d.get("noDocument"),a=this.uboDocs.hasDocument(o.getKycType()),r=a?d.get("fileUploaded"):d.get("selectFile");return new c({fileModel:o,fieldName:o.getKycType(),fieldLabel:t,placeholder:i,buttonText:r,readOnly:a,required:!0,saveOnChange:!1,tooltip:n,acceptedFileTypes:this.acceptedFileTypes,maxFileSize:2097152})},_getOrCreateModel:function(t){let n=this.uboDocs.get(t);return e.is(n,"object")||(n=this.uboDocs.push({[s.Fields.KYC_TYPE]:t},{dataProxy:this.uboDocs.dataProxy,parentResourceId:this.ubo.get("id")})),n}})}),define("DS/MPFKycComponent/KycSection",["UWA/Core","UWA/Class/View","DS/MPFTooltip/Tooltip"],function(e,t,n){"use strict";return t.extend({tagName:"section",className:"mpf-kyc-section",setup:function(o){if(!e.is(o))throw new Error("options is ");if(!t.prototype.isPrototypeOf(o.body))throw new Error("options.body must be a View");var s=[o.title];o.tooltip&&(this.tooltip=new n({body:o.tooltip}),s.push(this.tooltip)),this.body=o.body,o.customClass&&this.container.addClassName(o.customClass),this.title=e.createElement("h3",{class:"mpf-title",html:s})},render:function(){var e=[];return e.push(this.title),e.push(this.body.render()),this.container.setContent(e),this},getBody:function(){return this.body},setReadOnly:function(e){this.body.setReadOnly(e)}})}),define("DS/MPFKycComponent/KycPageCompletion",["UWA/Core","UWA/Class","DS/MPFCompanyModel/CompanyModel","DS/MPFKYCDocumentModel/KycDocumentCollection","DS/MPFKYCDocumentModel/KycDocumentModel","DS/MPFBankAccountModel/BankAccountModel","DS/MPFPspModel/PspModel","DS/MPFCompanyUboModel/CompanyUboCollection","DS/MPFServices/ObjectService","DS/MPFDataProxy/NoDataProxy"],function(e,t,n,o,s,i,a,r,c,d){"use strict";var l={isCompleted:function(e){var t,s,r,d,p;return c.requiredOfPrototype(e.psp,a,"options.psp must be a PspModel"),c.requiredOfPrototype(e.company,n,"options.company must be a CompanyModel"),c.requiredOfPrototype(e.kycDocuments,o,"options.kycDocuments must be a KycDocumentCollection"),c.requiredOfPrototype(e.bankAccount,i,"options.bankAccount must be a BankAccountModel"),t=e.psp,s=e.company,r=e.kycDocuments,d=e.bankAccount,p=e.companyUbos,t.getPsp()===a.Psp.STRIPE?t.getCountryPlatform()===a.Platform.STRIPE_EU?l._isCompletedStripeEU(s,r,d,p,t):l._isCompletedStripe(s,r,d,p,t):l._isCompletedHiPay(s,r,d,p,t)},_areUboComplete:function(e,t,n){var o,s;return t=t||e.getUboPersons(),s=(o=Object.prototype.isPrototypeOf.call(r.prototype,t)?t:new r(t,{dataProxy:d.getInstance()}))&&!o.isEmpty()&&o.isComplete()&&o.hasRequiredRoles(n).ok,e.getNoShareHolder()||s},_isCompletedHiPay:function(t,a,r,d,p){var h,u,m,y;return c.requiredOfPrototype(t,n,"company parameter must be a CompanyModel"),c.requiredOfPrototype(a,o,"kycDocuments parameter must be a KycDocumentCollection"),c.requiredOfPrototype(r,i,"bankAccount parameter must be a BankAccountModel"),h=t&&!t.isNew()&&!!t.getRegistrationId()&&!!t.getTaxRegistrationId(),u=r&&!r.isNew(),m=a&&!a.isEmpty()&&e.is(a.get(s.DocumentTypes.statutes))&&e.is(a.get(s.DocumentTypes.kbis))&&e.is(a.get(s.DocumentTypes.idPro))&&e.is(a.get(s.DocumentTypes.bank)),y=l._areUboComplete(t,d,p),h&&u&&m&&y},_isCompletedStripe:function(e,t,s,a,r){var d,p,h;return c.requiredOfPrototype(e,n,"company parameter must be a CompanyModel"),c.requiredOfPrototype(t,o,"kycDocuments parameter must be a KycDocumentCollection"),c.requiredOfPrototype(s,i,"bankAccount parameter must be a BankAccountModel"),p=s&&!s.isNew(),d=e&&!e.isNew()&&!!e.getCeoFirstName()&&!!e.getCeoLastName()&&(e.isNonProfit()||!!e.getRegistrationId())&&!!e.get(n.Fields.BUSINESS_TYPE)&&!!e.get(n.Fields.INDUSTRY)&&(!!e.get(n.Fields.BUSINESS_WEBSITE_URL)||!!e.get(n.Fields.DESCRIPTION))&&e.getOwnersProvided(),h=l._areUboComplete(e,a,r),p&&d&&h},_isCompletedStripeEU:function(e,t,s,a,r){var d,p,h;return c.requiredOfPrototype(e,n,"company parameter must be a CompanyModel"),c.requiredOfPrototype(t,o,"kycDocuments parameter must be a KycDocumentCollection"),c.requiredOfPrototype(s,i,"bankAccount parameter must be a BankAccountModel"),p=s&&!s.isNew(),d=e&&!e.isNew()&&!!e.getCeoFirstName()&&!!e.getCeoLastName()&&(e.isNonProfit()||!!e.getRegistrationId())&&(e.isNonProfit()||!!e.getTaxRegistrationId())&&!!e.get(n.Fields.BUSINESS_TYPE)&&!!e.get(n.Fields.INDUSTRY)&&(!!e.get(n.Fields.BUSINESS_WEBSITE_URL)||!!e.get(n.Fields.DESCRIPTION))&&e.getOwnersProvided(),h=l._areUboComplete(e,a,r),p&&d&&h}};return Object.freeze(l),l}),define("DS/MPFKycComponent/KycPageInformation",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFPspModel/PspModel","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s){"use strict";return e.extend({className:"mpf-kyc-section mpf-kyc-info-section",setup(e={}){t.requiredOfPrototype(e.company,n,"options.company must be a CompanyModel"),t.requiredOfPrototype(e.psp,o,"options.psp must be a PspModel"),this.company=e.company,this.psp=e.psp},render(){return this.container.setContent([{tag:"span",class:"fonticon fonticon-info"},{tag:"p",class:"mpf-kyc-info",text:s.get("kycInformation")},{tag:"p",class:"mpf-kyc-info",text:this.psp.getPsp()===o.Psp.STRIPE?s.get("kycSupportedFilesStripe"):s.get("kycSupportedFilesHiPay")}]),this},destroy(){this.company=null,this.psp=null,this._parent(),this.container=null}})}),define("DS/MPFKycComponent/KycStatus",[],function(){"use strict";function e(e){this.status=e}e.prototype.toString=function(){return this.status},e.EMPTY=new e("empty"),e.PENDING=new e("pending"),e.VALIDATED=new e("validated"),e.REJECTED=new e("rejected"),e.fromBackendStatus=function(t){var n;return n=e.EMPTY,"created"===t?n=e.PENDING:"uploaded"===t?n=e.PENDING:"validated"===t?n=e.VALIDATED:"nok"===t&&(n=e.REJECTED),n},e.fromHipayStatus=e.fromBackendStatus;return Object.freeze(e)}),define("DS/MPFKycComponent/KycModalButton",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Button"],function(e,t,n){"use strict";return t.extend({className:"mpf-entry",setup:function(e){var t=this;e||(e={}),this._parent(e),this.modal=e.modal,this.icon=e.icon||null,this.label=e.label||"",this.button=new n({className:"mpf-kyc-button default",icon:this.icon,value:this.label,events:{onClick:function(e){t.modal.show()}}})},render:function(){return this.container.setContent([this.button,this.modal]),this},setLabel:function(e){this.button.setValue(e)}})}),define("DS/MPFKycComponent/CompanyActivityInput",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Text","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","i18n!DS/MPFKycComponent/assets/nls/KycCompanyActivityForm"],function(e,t,n,o,s,i,a){"use strict";const r={WEBSITE:"website",DESCRIPTION:"description"};return t.extend({className:"mpf-company-activity-input",setup:function(e){s.requiredOfPrototype(e.company,i,"options.company must be a CompanyModel"),this.company=e.company,this.isReadOnly=!0===e.isReadOnly,this.state=this._getInitialState()},render:function(){return this.container.setContent([{tag:"span",class:"mpf-label",html:a.get("activity")+'&nbsp;<em class="mpf-required">*</em>'},{tag:"div",class:"mpf-input-column",html:[{tag:"div",class:"mpf-toggle-container",html:this._createToggleInputs()},this._createTextInput(),{tag:"p",class:"mpf-error"}]}]),this},destroy:function(){this.company=null,this._parent(),this.container=null},showError:function(e){this.container.addClassName("mpf-invalid"),this.container.getElement(".mpf-error").setText(e.message)},clearError:function(){this.container.removeClassName("mpf-invalid"),this.container.getElement(".mpf-error").empty()},setReadOnly:function(e){this.isReadOnly=!1!==e,this.render(),this.clearError()},validate:function({fieldName:t,value:n,silent:o=!1}={}){t=t||this._getFieldName();let s=!1;if(n=e.is(n)?n:this.company.get(t)){const e=this.company.validate({[t]:n});e&&e.length>0?!o&&this.showError(e[0]):(this.clearError(),s=!0)}else!o&&this.showError({message:a.get("fieldIsRequired")});return s},_getInitialState:function(){return this.company.get(i.Fields.DESCRIPTION)&&!this.company.get(i.Fields.BUSINESS_WEBSITE_URL)?r.DESCRIPTION:r.WEBSITE},_getFieldName:function(){return this.state===r.WEBSITE?i.Fields.BUSINESS_WEBSITE_URL:i.Fields.DESCRIPTION},_switchInput:function(e){e!==this.state&&(this.state=e,this.render(),this.clearError())},_onTextInputChange:function(e){const t=e.target.value,n=this._getFieldName();this.validate({fieldName:n,value:t,silent:!1})&&this.company.savePromise({[n]:t},{patch:!0})},_createToggleInputs:function(){return[new n({type:"radio",className:"primary",name:"mpf-profile-type-switch",value:r.WEBSITE,label:a.get("website"),checked:this.state===r.WEBSITE,disabled:this.isReadOnly,events:{onClick:this._switchInput.bind(this,r.WEBSITE)}}),new n({type:"radio",className:"primary",name:"mpf-profile-type-switch",value:r.DESCRIPTION,label:a.get("description"),checked:this.state===r.DESCRIPTION,disabled:this.isReadOnly,events:{onClick:this._switchInput.bind(this,r.DESCRIPTION)}})]},_createTextInput:function(){const e=this._getFieldName();return new o({value:this.company.get(e)||"",disabled:this.isReadOnly,name:e,maxlength:500,events:{onChange:this._onTextInputChange.bind(this)}})}})}),define("DS/MPFKycComponent/KycCompanyUboListEntry",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFShopModel/ShopModel","DS/MPFUtils/StorageUtils","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a){"use strict";return t.extend({tagName:"tr",className:"mpf-kyc-ubo-list-entry",setup:function(e={}){n.requiredOfPrototype(e.companyUbo,o,"options.companyUboModel must be a CompanyUboCollection"),n.requiredOfPrototype(e.shop,s,"options.shop must be a ShopModel"),this.companyUbo=e.companyUbo,this.shop=e.shop,this.readOnly=!0===e.readOnly,this.readOnly&&this.container.addClassName("disabled")},render:function(){return this.container.setContent([this._createStateCell(),this._createNameCell(),this._createRoleCell(),this._createEditCommandCell()]),this},onEdit:function(){this.readOnly||this.dispatchEvent("editCompanyUbo",{id:this.companyUbo.id,entry:this})},setReadOnly:function(e){this.readOnly=e,this.readOnly?this.container.addClassName("disabled"):this.container.removeClassName("disabled")},_createStateCell:function(){const t=this.companyUbo.getState(),n=e.createElement("td",{class:"mpf-kyc-ubo-status"});let s;return t===o.States.DRAFT?(n.addClassName("draft"),s="mpf-kyc-validation-icon fonticon fonticon-pencil"):t===o.States.COMPLETE||t===o.States.PENDING||t===o.States.VALIDATED?(n.addClassName("validated"),s="mpf-kyc-validation-icon fonticon fonticon-check"):t===o.States.REJECTED&&(n.addClassName("rejected"),s="mpf-kyc-validation-icon fonticon fonticon-wrong"),s&&e.createElement("div",{class:s}).inject(n),n},_createNameCell:function(){const t=this.companyUbo.getState(),n=this.companyUbo.getFirstName()+" "+this.companyUbo.getLastName().toUpperCase(),s=e.createElement("td",{text:n});let i,r;if(t===o.States.DRAFT?(i=" ("+a.get("toCompleteWarning")+")",r="mpf-kyc-ubo-warning"):t===o.States.PENDING?(i=" ("+a.get("pendingValidation")+")",r="mpf-kyc-ubo-warning"):t===o.States.VALIDATED?(i=" ("+a.get("validated")+")",r="mpf-kyc-ubo-success"):t===o.States.REJECTED&&(i=" ("+a.get("invalid")+")",r="mpf-kyc-ubo-error"),i&&r){const t=e.createElement("span",{class:r,text:i});s.addContent(t)}return s},_createShareCell:function(){return e.createElement("td",{text:this.companyUbo.getSharePercentage()+"%"})},_createRoleCell:function(){const t=[],n=i.getLanguageCookie()||"en";return this.companyUbo.isRepresentative()&&t.push(a.get("representative")),this.companyUbo.isExecutive()&&t.push(a.get("executive")),this.companyUbo.isDirector()&&t.push(this.companyUbo.getJobTitle()),this.companyUbo.isOwner()&&t.push([a.get("owner")," (",parseFloat(this.companyUbo.getSharePercentage()).toLocaleString(n),"%)"].join("")),e.createElement("td",{text:t.join(", ")})},_createEditCommandCell:function(){const t=e.createElement("span",{class:"fonticon fonticon-pencil",events:{click:this.onEdit.bind(this)}});return t.setData("id",this.companyUbo.id),e.createElement("td",{html:t})}})}),define("DS/MPFKycComponent/DocumentMigrationLine",["UWA/Class/View","DS/WAFData/WAFData","DS/UIKIT/Input/Button","DS/UIKIT/Input/File","DS/MPFServices/ObjectService","DS/MPFKYCDocumentModel/KycDocumentModel","DS/MPFKYCDocumentModel/UboDocumentModel","i18n!DS/MPFKycComponent/assets/nls/ShopMigrationSection","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c){"use strict";const d=new Map;d.set(i.DocumentTypes.bank,c.get("bankAccountDocument")),d.set(i.DocumentTypes.kbis,c.get("companyRegistrationDocument")),d.set(i.DocumentTypes.idPro,c.get("identificationDocument")),d.set(a.DocumentTypes.KYC_PERSON_ID,c.get("passportOrIdCard")),d.set(a.DocumentTypes.KYC_PERSON_ADDRESS,c.get("proofOfAddress"));const l=["image/jpeg","image/png"],p=Object.freeze({ON_ERROR:"onError",ON_FILE_UPLOAD:"onFileUpload",LOAD:"load"}),h=e.extend({className:"mpf-document-migration-line",setup({oldDocument:e,newDocument:t,ubo:n,uboAddress:o,stripeTokenHandler:r}={}){s.requiredAsOneOf(e,[i,a],"options.oldDocument must be a KycDocumentModel or UboDocumentModel"),s.requiredAsOneOf(t,[i,a],"options.newDocument must be a KycDocumentModel or UboDocumentModel"),this.oldDocument=e,this.newDocument=t,this.ubo=n,this.uboAddress=o,this.stripeTokenHandler=r,this.downloadButton=this._createDownloadButton(),this.uploadButton=this._createUploadButton()},render(){const e=d.get(this.oldDocument.getKycType()),t=this.oldDocument.getStatus();return this.container.setContent([{tag:"div",class:"mpf-doc-title",text:this.ubo&&this.oldDocument instanceof a?`${this.ubo.getFirstName()} ${this.ubo.getLastName()} - `+e:e},this.downloadButton,this.uploadButton,{tag:"div",class:"mpf-status-cell "+this._getIconClass(t),attributes:{title:r.get("kycSatusIs",{status:t})}}]),this.uploadButton.setDisabled(t===a.States.UPLOADED||t===a.States.VALIDATED),this},destroy(){this._parent(),this.container=null},_fetch:(e,{method:n="GET",type:o="json"}={})=>new Promise((s,i)=>{t.authenticatedRequest(e,{onComplete:s,onFailure:i,method:n,type:o,timeout:18e4})}),async _downloadFile(){const e=this.oldDocument.getDriveUrl();this.dispatchEvent(p.LOAD,!0);try{const{url:t}=await this._fetch(e);window.open(t,"blank")}catch(e){console.error("Failed to fetch file!"),console.error(e),this.dispatchEvent(p.ON_ERROR,r.get("failedToDownloadFile"))}this.dispatchEvent(p.LOAD,!1)},async _uploadFile(e){this.dispatchEvent(p.LOAD,!0);try{const t=await this.stripeTokenHandler.uploadFileToStripe(e);let n,o;if(this.newDocument instanceof i)n=await this.stripeTokenHandler.createCompanyAccountToken({stripeFileToken:t});else{const e={person:this.ubo,address:this.uboAddress};this.newDocument.getKycType()===a.DocumentTypes.KYC_PERSON_ADDRESS?e.addressFileToken=t:e.idFileToken=t,o=await this.stripeTokenHandler.createPersonToken(e)}const s=new window.FormData;s.append("file",e),await new Promise((e,i)=>{this.newDocument.save(null,{data:s,onComplete:e,onFailure:i,method:"POST",stripeFileToken:t,stripeAccountToken:n,stripePersonToken:o})}),this.dispatchEvent(p.LOAD,!1),this.dispatchEvent(p.ON_FILE_UPLOAD)}catch(e){this.dispatchEvent(p.ON_ERROR,r.get("failedToUploadFile")),this.dispatchEvent(p.LOAD,!1)}},_getIconClass(e){switch(e){case"to_migrate":return"fonticon fonticon-status-trending-good";case"pending_migration":return"fonticon fonticon-status-clock";case"uploaded":return"fonticon fonticon-clock";case"migrated":case"validated":return"fonticon fonticon-status-ok";default:return"fonticon fonticon-help"}},_createDownloadButton(){return new n({value:r.get("downloadFile"),events:{onClick:this._downloadFile.bind(this)}})},_createUploadButton(){return new o({buttonText:r.get("uploadFile"),input:!1,events:{onChange:e=>{if(e.target&&e.target.files&&e.target.files.length>0){const t=e.target.files[0];l.includes(t.type)?t.size>2e6?this.dispatchEvent(p.ON_ERROR,r.get("fileTooBig")):this._uploadFile(t):this.dispatchEvent(p.ON_ERROR,r.get("invalidFileTypeMessage"))}}}})}});return h.Events=p,h}),define("DS/MPFKycComponent/KycCompanyRegistrationInformationStripeUS",["UWA/Core","UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFView/FieldTextInputV2","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c){"use strict";const d=Object.freeze({ON_SAVE:"onSave"}),l=t.extend({className:"mpf-kyc-company-registration mpf-stripe mpf-horizontal",setup:function(e){i.requiredOfPrototype(e.company,a,"options.company must be a CompanyModel"),this.company=e.company,this.isReadOnly=this._isInfoComplete(),this.alert=this._createAlert(),this.registrationIdInput=this._createRegistrationIdInput(),this.saveButton=this._createSaveButton(),this.listenTo(this.registrationIdInput,"update",this._onChange.bind(this))},render:function(e){return this.container.setContent([this.alert,this.registrationIdInput.render(),this._createButtonContainer(this.saveButton)]),this},destroy:function(){this.stopListening(),this.registrationIdInput.destroy(),this.company=null,this._parent(),this.container=null},setReadOnly:function(e){e=!1!==e,this.registrationIdInput.setDisabled(e),this.saveButton.setDisabled(e)},_onChange:function(){this._isInfoComplete()?this.saveButton.enable():this.saveButton.disable()},_onSave:function(){if(this._isInfoComplete()&&this._validate()){const e={[a.Fields.REGISTRATION_ID]:this.registrationIdInput.getValue()};n.mask(this.container),this.company.savePromise(e,{patch:!0}).then(()=>{this.setReadOnly(!0),n.unmask(this.container),this.dispatchEvent(d.ON_SAVE)}).catch(e=>{n.unmask(this.container),console.error(e),this.alert.add({className:"error",message:c.get("errorOccured")}).show()})}},_validate:function(){return this.registrationIdInput.validate().isValid},_isInfoComplete:function(){return!!this.company.getRegistrationId()&&!this.company.validate(a.Fields.REGISTRATION_ID)},_createAlert:function(){return new s({visible:!1,autoHide:!0})},_createRegistrationIdInput:function(){return new r({model:this.company,fieldName:a.Fields.REGISTRATION_ID,fieldLabel:c.get("employerIdNumber"),required:!0,dynamicValidation:!0,saveOnChange:!1,readOnly:this.isReadOnly})},_createSaveButton:function(){return new o({className:"primary",value:c.get("save"),disabled:!0,events:{onClick:this._onSave.bind(this)}})},_createButtonContainer:function(t){return e.createElement("div",{class:"mpf-button-container",html:this.isReadOnly?[]:[t]})}});return l.Events=d,l}),define("DS/MPFKycComponent/KycStripeTokenHandler",["DS/MPFConnector/MarketplaceConnector","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFBankAccountModel/BankAccountModel","DS/MPFStripeComponent/StripePaymentHelper"],function(e,t,n,o,s){"use strict";return class{constructor({psp:e,company:t,shop:n,bankAccount:o,countries:s}){this.psp=e,this.company=t,this.shop=n,this.bankAccount=o,this.countries=s}isUsingStripeTokens(){return this.psp.isStripeEU()}doesCompanyExistInMpo(){return!!this.company.getDrupalId()}isStripeInDom(){return s.isStripeLoadedInDocument()}getClientIp(){return this.clientIp}createStripeTag(){return s.createStripeScriptTag({onLoad(){},onError(){console.log("Failed to load Stripe tag")}})}async createCompanyAccountToken({attributes:e={},stripeFileToken:t}={}){this.stripe=this.stripe||Stripe(this.psp.getPublicKey());const n={...this._getCompanyAccountInfo(),...e};t&&(n.verification={document:{front:t}});const o=await this.stripe.createToken("account",{business_type:"company",company:n,tos_shown_and_accepted:!0});return this._handleResponse(o)}async uploadFileToStripe(e){const t=new window.FormData;t.append("file",e),t.append("purpose","identity_document");const n=await fetch("https://uploads.stripe.com/v1/files",{method:"POST",headers:{Authorization:`Bearer ${this.psp.getPublicKey()}`},body:t}),o=await n.json();return o&&o.id}async createPersonToken({person:e,address:o,idFileToken:s,addressFileToken:i}){t.requiredOfPrototype(e,n,"options.person must be a CompanyUboModel"),this.stripe=this.stripe||Stripe(this.psp.getPublicKey());const a=new Date(e.getDateOfBirth()),r=await this._getMpoUrl(),c={first_name:e.getFirstName(),last_name:e.getLastName(),email:e.getEmail(),phone:e.getPhoneNumber(),dob:{day:a.getDate(),month:a.getMonth()+1,year:a.getFullYear()},address:{line1:o.getLine1(),city:o.getCity(),state:o.getCountry(),postal_code:o.getPostalCode()},relationship:{representative:e.isRepresentative(),director:e.isDirector(),executive:e.isExecutive(),owner:e.isOwner(),percent_ownership:parseFloat(e.getSharePercentage()),title:e.getJobTitle()||"CEO"},metadata:{base_url:r}};s&&(c.verification={document:{front:s}}),i&&(c.verification={additional_document:{front:i}});const d=await this.stripe.createToken("person",{person:c});return this._handleResponse(d)}async createBankToken(){this.stripe=this.stripe||Stripe(this.psp.getPublicKey());const e=this.countries.getCountryWithIso3(this.company.getCountry()),t=await this.stripe.createToken("bank_account",{country:e.getIso2(),currency:this.shop.getSupportedCurrencies()[0],account_number:this.bankAccount.get(o.Fields.IBAN)});return this._handleResponse(t)}async _getMpoUrl(){return(await e.fetchPromise({backend:"mpordering"})).rootUrl}_handleResponse(e){if(e&&e.token)return e.token.client_ip&&(this.clientIp=e.token.client_ip),e.token.id;{const t=e&&e.error&&e.error.message||"Token creation failed";throw new Error(t)}}_returnIdOrThrowError(e){if(e&&e.id)return e.id;throw new Error("Token creation failed")}_getCompanyAccountInfo(){const e=this.company.addresses.first();return{name:this.company.getName(),vat_id:this.company.getTaxRegistrationId(),tax_id:this.company.getRegistrationId(),phone:this.shop.getPhoneNumber(),address:{line1:e.getLine1(),city:e.getCity(),state:e.getCountry(),postal_code:e.getPostalCode()}}}}}),define("DS/MPFKycComponent/KycCompanyNameAndAddress",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressCollection","DS/MPFCountryModel/CountryCollection","DS/MPFView/FieldTextInput","DS/MPFAddressFormComponent/AddressFormComponentV2","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r){"use strict";return e.extend({className:"mpf-kyc-company-name-address",setup:function(e={}){t.requiredOfPrototype(e.company,n,"options.company must be a CompanyModel"),t.requiredOfPrototype(e.companyAddresses,o,"options.companyAddresses must be an AddressCollection"),t.requiredOfPrototype(e.countries,s,"options.countries must be a CountryCollection"),this.company=e.company,this.companyAddresses=e.companyAddresses,this.countries=e.countries,this.companyNameField=this._createCompanyNameField(),this.companyAddressForm=this._createAddressForm()},render:function(){return this.container.setContent([this.companyNameField.render(),this.companyAddressForm.render()]),this},destroy:function(){this.company=null,this.companyAddresses=null,this.companyNameField.destroy(),this.companyAddressForm.destroy(),this._parent()},_createCompanyNameField:function(){return new i({model:this.company,fieldName:n.Fields.NAME,fieldLabel:r.get("companyName"),readOnly:!0,required:!0})},_createAddressForm:function(){return new a({addressModel:this.companyAddresses.first(),addressConstraints:this.companyAddresses.constraints,countries:this.countries,horizontalLayout:!0,countryReadOnly:!0,readOnly:!0})}})}),define("DS/MPFKycComponent/KycUploadButton",["UWA/Core","UWA/String","UWA/Class/View","DS/UIKIT/Input/File","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/MPFKycComponent/KycStatus","DS/MPFKYCDocumentModel/KycDocumentModel","DS/MPFKYCDocumentModel/KycDocumentService","i18n!DS/MPFKycComponent/assets/nls/KycComponent","css!DS/MPFUI/MPFUI"],function(e,t,n,o,s,i,a,r,c,d){"use strict";const l=["image/jpeg","image/png","application/pdf"],p=["image/jpeg","image/png"];return n.extend({className:"mpf-entry",setup:function(e){e||(e={}),this._parent(e),this.company=e.company,this.psp=e.psp,this.kycId=e.kycId,this.stripeTokenHandler=e.stripeTokenHandler,this.label=e.label||d.get("uploadDocument"),this.isReadOnly=!0===e.isReadOnly,this.input=this._createInput(),this.modal=this._createModal(this.kycId),this.doBeforeUpload=e.doBeforeUpload},render:function(){const e=this.model.get(this.kycId);return(!e||c.isEditable(e))&&!this.isReadOnly?this.input.enable():this.input.disable(),this.container.setContent([this.input,this.modal]),this},setButtonText:function(e){this.label=e,this.input=this._createInput()},setReadOnly:function(e){this.isReadOnly=e,this.input.setDisabled(this.isReadOnly)},_createInput:function(){return new o({input:!1,buttonClassName:"btn-default mpf-kyc-button mpf-kyc-upload",buttonText:this.label,events:{onChange:this._onFileChange.bind(this)}})},_createModal:function(n){const o=d.get("uploadDocumentTitle"),a=t.format(o,this._getDocumentName(n));return new s({className:"mpf-kyc-document-modal",header:e.createElement("h4",{text:a}),body:[e.createElement("p",{class:"mpf-kyc-document-message"})],footer:[new i({className:"primary",value:d.get("continue"),events:{onClick:this._onSave.bind(this)}}),new i({value:d.get("cancel"),events:{onClick:this._cancel.bind(this)}})]})},_getDocumentName:function(e){let t;return e===r.DocumentTypes.id?t=d.get("identificationDocument"):e===r.DocumentTypes.idPro?t=d.get("legalRepresentativeIdDocument"):e===r.DocumentTypes.address?t=d.get("addressProofDocument"):e===r.DocumentTypes.statutes?t=d.get("statutesDocument"):e===r.DocumentTypes.bank?t=d.get("bankAccountDocument"):e===r.DocumentTypes.kbis?t=d.get("companyRegistrationDocument"):e===r.DocumentTypes.tax?t=d.get("taxDocument"):e===r.DocumentTypes.kyc_ubo1_id||e===r.DocumentTypes.kyc_ubo2_id||e===r.DocumentTypes.kyc_ubo3_id||e===r.DocumentTypes.kyc_ubo4_id?t=d.get("passportOrIdCard"):e!==r.DocumentTypes.kyc_ubo1_address&&e!==r.DocumentTypes.kyc_ubo2_address&&e!==r.DocumentTypes.kyc_ubo3_address&&e!==r.DocumentTypes.kyc_ubo4_address||(t=d.get("proofOfAddress")),t},_onFileChange:function(e){const n=e.currentTarget.files;if(n.length>0)if(this._validateFile(n[0])){const e=d.get("youAreAboutToUploadFile"),n=t.format(e,this.input.getValue());this.modal.getBody().getElement(".mpf-kyc-document-message").setText(n),this.modal.show()}else{const e=this.psp.isStripe()?d.get("kycSupportedFilesStripe"):d.get("kycSupportedFilesHiPay");this.dispatchEvent("onError",e)}},_validateFile:function(e){let t,n;return this.psp.isStripe()?(t=-1!==p.indexOf(e.type),n=e.size<=2e6):(t=-1!==l.indexOf(e.type),n=e.size<=2e6),t&&n},_cancel:function(){this.input.setValue(""),this.modal.hide()},_onSave:function(){let e;return e="function"==typeof this.doBeforeUpload?this.doBeforeUpload().then(this._uploadFile.bind(this)):this._uploadFile()},async _uploadFile(){this.dispatchEvent("onLoading");const e=this.model.get(this.kycId);if(e&&a.fromHipayStatus(e.getStatus())!==a.REJECTED)this.dispatchEvent("onError");else{const e=this.input.getContent().getElement("input").files[0];let t,n;this.stripeTokenHandler&&this.stripeTokenHandler.isUsingStripeTokens()&&(n=await this.stripeTokenHandler.uploadFileToStripe(e),t=await this.stripeTokenHandler.createCompanyAccountToken({stripeFileToken:n})),this.model.uploadDocument(this.kycId,e,{stripeAccountToken:t,stripeFileToken:n}).then(e=>{this.dispatchEvent("onSave",e),this.render()}).catch(()=>{this.model.remove(this.kycId),this.dispatchEvent("onError",d.get("fileUploadFailure")),console.error(arguments)}),this.modal.hide()}}})}),define("DS/MPFKycComponent/KycItem",["UWA/Core","UWA/String","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFKycComponent/KycStatus","DS/UIKIT/Spinner","DS/MPFKycComponent/KycUploadButton","DS/MPFTooltip/Tooltip","i18n!DS/MPFKycComponent/assets/nls/KycComponent","css!DS/MPFUI/MPFUI"],function(e,t,n,o,s,i,a,r,c){"use strict";const d=Object.freeze({ON_SAVE:"onSave",ON_ERROR:"onError"}),l={};l[s.EMPTY]=[s.PENDING,s.VALIDATED,s.REJECTED],l[s.PENDING]=[s.VALIDATED,s.REJECTED],l[s.VALIDATED]=[],l[s.REJECTED]=[s.PENDING,s.VALIDATED];const p=n.extend({className:"mpf-kyc-item",setup:function(e={}){o.requiredOfType(e.kycComponent,"object","options.kycComponent must be an object"),this.status=e.status||s.EMPTY,this.label=e.label,this.subLabel=e.subLabel||this._createSubLabel(),this.spinner=new i,this.kycComponent=e.kycComponent,e.tooltip&&(this.tooltip=new r({body:e.tooltip})),this.listenTo(this.kycComponent,"onLoading",this.setLoading.bind(this,!0)),this.listenTo(this.kycComponent,"onSave",this._onSave.bind(this)),this.listenTo(this.kycComponent,"onError",this._onError.bind(this)),e.itemClassName&&this.container.addClassName(e.itemClassName),this.container.addClassName(this.status)},render:function(){const t=[this.label];this.tooltip&&t.push(this.tooltip.render());const n=e.createElement("div",{class:"mpf-kyc-item-label",html:[{tag:"div",class:"mpf-label",html:t},{tag:"div",class:"mpf-sub-label",html:[this._createStatusIcon(),{tag:"span",class:"mpf-sub-label-text",text:this.subLabel}]},this.spinner]});return this.container.setContent([n,this.kycComponent.render()]),this},updateStatus:function(t){if(-1!==l[this.status].indexOf(t)){const n=e.is(this.status,"object")?this.status.status:this.status,o=e.is(t,"object")?t.status:t;this.container.removeClassName(n),this.container.addClassName(o),this.status=t}},setLoading:function(e){const t=this.container.getElement(".mpf-sub-label");e?(t.hide(),this.spinner.show()):(this.spinner.hide(),t.show())},setReadOnly:function(e){this.kycComponent.setReadOnly(e)},_createStatusIcon:function(){if(this.status!==s.EMPTY)return e.createElement("div",{class:"mpf-kyc-validation-icon"})},_createSubLabel:function(){let e;return this.status===s.EMPTY?e=c.get("noDocument"):this.status===s.PENDING?e=t.ucfirst(c.get("pendingValidation")):this.status===s.VALIDATED?e=t.ucfirst(c.get("validated")):this.status===s.REJECTED&&(e=t.ucfirst(c.get("invalid"))),e},_onSave:function(e){this.setLoading(!1);let t=e.get("kycStatus");t&&(t=s.fromHipayStatus(t),this.updateStatus(t)),this.subLabel=this._createSubLabel(),this.render(),this.dispatchEvent(d.ON_SAVE)},_onError:function(e){this.setLoading(!1),this.updateStatus(s.REJECTED),this.subLabel=e||this._createSubLabel(),this.render(e),this.dispatchEvent(d.ON_ERROR)}});return p.create=function(e){let t;const n=e.kycDocuments.get(e.kycId);return t=n?s.fromHipayStatus(n.get("kycStatus")):s.EMPTY,new p({label:e.label,status:t,tooltip:e.tooltip,itemClassName:e.itemClassName,kycComponent:new a({kycId:e.kycId,model:e.kycDocuments,company:e.company,psp:e.psp,stripeTokenHandler:e.stripeTokenHandler,doBeforeUpload:e.doBeforeUpload})})},p.Events=d,p}),define("DS/MPFKycComponent/KycBankAccountInformationStripe",["UWA/Class/View","UWA/String","DS/MPFServices/ObjectService","DS/MPFBankAccountModel/BankAccountModel","DS/MPFBankAccountFormComponent/BankAccountFormComponentV2","DS/MPFKycComponent/KycItem","DS/MPFKycComponent/KycUploadButton","DS/MPFKycComponent/KycStatus","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c){"use strict";return e.extend({className:"mpf-kyc-bank-account-information mpf-kyc-stripe",setup:function(e){n.requiredOfPrototype(e.bankAccount,o,"options.bankAccount must be an BankAccountModel"),this.bankAccount=e.bankAccount,this.kycDocuments=e.kycDocuments,this.psp=e.psp,this.stripeTokenHandler=e.stripeTokenHandler,this.bankAccountNumberComponent=this._createBankAccountNumberComponent(),this.bankAccountDocument=this._createBankAccountDocumentsComponents()},render:function(e){return this.container.setContent(this.bankAccountDocument.render(),this.bankAccountNumberComponent.render()),this},setReadOnly:function(e){this.bankAccountNumberComponent.setReadOnly(e)},_createBankAccountNumberComponent:function(e){return new s({bankAccount:this.bankAccount,psp:this.psp,stripeTokenHandler:this.stripeTokenHandler,readOnly:!this.bankAccount.isNew()})},_createBankAccountDocumentsComponents:function(){let e,n;const o=this.kycDocuments.get("kyc_bank");return(e=o?r.fromHipayStatus(o.get("kycStatus")):r.EMPTY)===r.EMPTY?n=c.get("noDocument"):e===r.PENDING&&(n=t.ucfirst(c.get("pendingValidation"))),new i({label:c.get("bankAccountDocument"),subLabel:n,status:e,tooltip:c.get("companyBankingInformationDocument"),kycComponent:new a({kycId:"kyc_bank",model:this.kycDocuments,company:this.company,stripeTokenHandler:this.stripeTokenHandler,psp:this.psp})})}})}),define("DS/MPFKycComponent/KycCompanyActivityForm",["UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFCompanyModel/CompanyIndustryListModel","DS/MPFView/FieldSelectInputV2","DS/MPFKycComponent/CompanyActivityInput","i18n!DS/MPFKycComponent/assets/nls/KycCompanyActivityForm"],function(e,t,n,o,s,i,a){"use strict";return e.extend({className:"mpf-kyc-company-activity mpf-horizontal",setup:function(e){t.requiredOfPrototype(e.company,n,"options.company must be a CompanyModel"),t.requiredOfPrototype(e.companyIndustries,o,"options.companyIndustries must be a CompanyIndustryListModel"),this.company=e.company,this.companyIndustries=e.companyIndustries,this.isReadOnly=!0===e.isReadOnly,this.businessTypeInput=this._createBusinessTypeInput(),this.industryInput=this._createIndustryInput(),this.activityInput=this._createActivityInput()},render:function(){return this.container.setContent([this.businessTypeInput.render(),this.industryInput.render(),this.activityInput.render()]),this},destroy:function(){this.company=null,this._parent(),this.container=null},_createBusinessTypeInput:function(){return new s({model:this.company,fieldName:n.Fields.BUSINESS_TYPE,fieldLabel:a.get("businessType"),required:!0,placeholder:!1,dynamicValidation:!0,saveOnChange:!0,readOnly:this.isReadOnly,silent:!1,selectableOptions:[{value:n.BusinessTypes.COMPANY,label:a.get("company"),selected:!0},{value:n.BusinessTypes.NON_PROFIT,label:a.get("nonProfitAndEducation"),disabled:!0}]})},_createIndustryInput:function(){return new s({model:this.company,fieldName:n.Fields.INDUSTRY,fieldLabel:a.get("industry"),placeholder:a.get("select"),required:!0,dynamicValidation:!0,saveOnChange:!0,readOnly:this.isReadOnly,silent:!1,selectableOptions:this._createIndustryOptions()})},_createIndustryOptions:function(){const e=[],t=this.companyIndustries.keys(),o=this.company.get(n.Fields.INDUSTRY);for(var s=0;s<t.length;s++){var i=t[s];e.push({value:i,label:this.companyIndustries.get(i),selected:i===o})}return e},_createActivityInput:function(){return new i({company:this.company,isReadOnly:this.isReadOnly})}})}),define("DS/MPFKycComponent/KycCompanyUboShareInformationForm",["UWA/Event","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFKYCDocumentModel/UboDocumentCollection","DS/MPFPspModel/PspModel","DS/MPFView/FieldSelectInput","DS/MPFView/FieldNumberInputV2","DS/MPFView/FieldToggleInput","DS/MPFKycComponent/KycCompanyUboDocumentsFormV2","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l){"use strict";return t.extend({tagName:"form",className:"mpf-kyc-ubo-form-share clearfix",setup:function(t={}){n.requiredOfPrototype(t.companyUbo,o,"options.companyUbo must be a CompanyUboModel"),n.requiredOfPrototype(t.uboDocuments,s,"options.uboDocuments must be a UboDocumentCollection"),n.requiredOfPrototype(t.psp,i,"options.psp must be a PspModel"),n.requiredOfType(t.totalShareholderPercentage,"number","options.totalShareholderPercentage must be a number"),this.companyUbo=t.companyUbo,this.uboDocuments=t.uboDocuments,this.psp=t.psp,this.totalShareholderPercentage=t.totalShareholderPercentage,this.acceptedFileTypes=t.acceptedFileTypes,this.jobTitleField=this._createJobTitleField(),this.sharpercentageField=this._createSharePercentageField(),this.isDecisionMakerField=this._createIsDecisionMakerField(),this.isPoliticallyExposed=this._createIsPoliticallyExposed(),this.uboDocumentsForm=this._createUboDocumentsForm(),this.container.addEvent("submit",function(t){e.stop(t)})},render:function(){return this.container.setContent([this.jobTitleField.render(),this.sharpercentageField.render(),this.isDecisionMakerField.render(),this.isPoliticallyExposed.render(),this.uboDocumentsForm.render()]),this},validate:function(){const e=void 0===this.jobTitleField.validate(),t=this.uboDocumentsForm.validate();return e&&t},validateRoles:function(){return!0},_createJobTitleField:function(){return new a({model:this.companyUbo,fieldName:o.Fields.JOB_TITLE,fieldLabel:l.get("jobTitle"),placeholder:l.get("selectJobTitle"),required:!0,selectableOptions:[{value:"ceo",label:l.get("ceo")},{value:"cfo",label:l.get("cfo")},{value:"coo",label:l.get("coo")},{value:"shareholder",label:l.get("shareholder")},{value:"administrator",label:l.get("administrator")},{value:"companyManager",label:l.get("companyManager")},{value:"other",label:l.get("other")}]})},_createSharePercentageField:function(){let e;const t=100-(e=this.companyUbo.isNew()?this.totalShareholderPercentage:this.totalShareholderPercentage-this.companyUbo.getSharePercentage()),n=Math.max(25,t);return new r({model:this.companyUbo,fieldName:o.Fields.SHARE_PERCENTAGE,fieldLabel:l.get("sharePercentage"),min:25,max:n,step:.1,required:!0})},_createIsDecisionMakerField:function(){return new c({model:this.companyUbo,fieldName:o.Fields.IS_DECISION_MAKER,fieldLabel:l.get("isDecisionMaker"),useStringValue:!0})},_createIsPoliticallyExposed:function(){return new c({model:this.companyUbo,fieldName:o.Fields.IS_POLITICALLY_EXPOSED,fieldLabel:l.get("isPoliticallyExposed"),useStringValue:!0})},_createUboDocumentsForm:function(){return new d({ubo:this.companyUbo,uboDocs:this.uboDocuments,acceptedFileTypes:this.acceptedFileTypes,psp:this.psp})}})}),define("DS/MPFKycComponent/KycCompanyLegalRepresentativeStripe",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFKYCDocumentModel/KycDocumentCollection","DS/MPFView/FieldTextInput","DS/MPFView/FieldDateInput","DS/MPFKycComponent/KycItem","DS/MPFKYCDocumentModel/KycDocumentModel","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d){"use strict";return t.extend({className:"mpf-kyc-legal-representative mpf-stripe",setup:function(e){n.requiredOfPrototype(e.company,o,"options.company must be a CompanyModel"),n.requiredOfPrototype(e.kycDocuments,s,"options.kycDocuments must be a KycDocumentCollection"),this.company=e.company,this.kycDocuments=e.kycDocuments,this.firstNameField=this._createFirstNameField(),this.lastNameField=this._createLastNameField(),this.dateOfBirthField=this._createDateOfBirthField(),this.personalIdNumberField=this._createPersonalIdNumberField(),this.verificationDocument=this._createVerificationDocument(),this.listenTo(this.firstNameField,"update",this.onFirstNameChange.bind(this)),this.listenTo(this.lastNameField,"update",this.onLastNameChange.bind(this)),this.listenTo(this.dateOfBirthField,"update",this.onDateOfBirthChange.bind(this)),this.listenTo(this.personalIdNumberField,"update",this.onPersonalIdNumberChange.bind(this)),this.listenTo(this.kycDocuments,"onAdd",this.onKycDocumentAdded.bind(this))},render:function(){return this.container.setContent([this.firstNameField.render(),this.lastNameField.render(),this.dateOfBirthField.render(),this.personalIdNumberField.render(),this.verificationDocument.render()]),this},destroy:function(){this.stopListening(),this.company=null,this.kycDocuments=null,this.firstNameField.destroy(),this.lastNameField.destroy(),this.dateOfBirthField.destroy(),this.personalIdNumberField.destroy(),this.verificationDocument.destroy(),this._parent()},onFirstNameChange:function(){const e=this._isCompanyFieldReadOnly(o.Fields.CEO_FIRST_NAME,this.firstNameField.getValue());this.firstNameField.setDisabled(e)},onLastNameChange:function(){const e=this._isCompanyFieldReadOnly(o.Fields.CEO_LAST_NAME,this.lastNameField.getValue());this.lastNameField.setDisabled(e)},onDateOfBirthChange:function(){const e=this._isCompanyFieldReadOnly(o.Fields.CEO_DATE_OF_BIRTH);this.dateOfBirthField.setReadOnly(e)},onPersonalIdNumberChange:function(){const t=this._isCompanyFieldReadOnly(o.Fields.CEO_PERSONAL_ID_NUMBER,!!e.is(this.personalIdNumberField.getValue,"function")&&this.personalIdNumberField.getValue());this.personalIdNumberField.setDisabled(t)},onKycDocumentAdded:function(){this.onLastNameChange(),this.onFirstNameChange(),this.onDateOfBirthChange(),this.onPersonalIdNumberChange()},setReadOnly:function(e){this.firstNameField.setDisabled(e),this.lastNameField.setDisabled(e),this.dateOfBirthField.setReadOnly(e),this.personalIdNumberField.setDisabled(e),this.verificationDocument.setReadOnly(e)},_createFirstNameField:function(){return new i({model:this.company,fieldName:o.Fields.CEO_FIRST_NAME,fieldLabel:d.get("legalRepresentativeFirstName"),required:!0,dynamicValidation:!0,saveOnChange:!0,readOnly:this._isCompanyFieldReadOnly(o.Fields.CEO_FIRST_NAME)})},_createLastNameField:function(){return new i({model:this.company,fieldName:o.Fields.CEO_LAST_NAME,fieldLabel:d.get("legalRepresentativeLastName"),required:!0,dynamicValidation:!0,saveOnChange:!0,readOnly:this._isCompanyFieldReadOnly(o.Fields.CEO_LAST_NAME)})},_createDateOfBirthField:function(){const e=new Date;return e.setFullYear(e.getFullYear()-13),new a({model:this.company,fieldName:o.Fields.CEO_DATE_OF_BIRTH,fieldLabel:d.get("legalRepresentativeDateOfBirth"),max:e,required:!0,dynamicValidation:!0,saveOnChange:!0,readOnly:this._isCompanyFieldReadOnly(o.Fields.CEO_DATE_OF_BIRTH),renderDatePickerInside:!0})},_createPersonalIdNumberField:function(){return new i({model:this.company,fieldName:o.Fields.CEO_PERSONAL_ID_NUMBER,fieldLabel:d.get("legalRepresentativePersonalIdNumber"),required:!0,dynamicValidation:!0,saveOnChange:!0,readOnly:this._isCompanyFieldReadOnly(o.Fields.CEO_PERSONAL_ID_NUMBER),tooltip:d.get("stripePersonalIdNumberTooltip")})},_createVerificationDocument:function(){return r.create({kycDocuments:this.kycDocuments,kycId:c.DocumentTypes.idPro,label:d.get("legalRepresentativeIdDocument")+' <em class="mpf-required">*</em>',tooltip:d.get("passportOrIdCardOrDrivingLicence"),psp:this.psp})},_isCompanyFieldReadOnly:function(t,n){const o=this.company.get(t),s=e.is(o)&&o.length>0,i=!e.is(n)||o===n,a=!this.kycDocuments.isEmpty();return s&&i&&a}})}),define("DS/MPFKycComponent/KycCompanyLegalRepresentativeStripeGB",["DS/MPFKycComponent/KycCompanyLegalRepresentativeStripe","DS/MPFView/EmptyView"],function(e,t){"use strict";return e.extend({setup:function(e){this._parent(e),this.stopListening(this.personalIdNumberField),this.personalIdNumberField=new t}})}),define("DS/MPFKycComponent/KycCompanyRegistrationInformationStripeEUV2",["UWA/Core","UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Input/Toggle","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFKYCDocumentModel/KycDocumentCollection","DS/MPFKYCDocumentModel/KycDocumentModel","DS/MPFKycComponent/KycStripeTokenHandler","DS/MPFView/FieldTextInputV2","DS/MPFKycComponent/KycItem","DS/MPFCompanyComponent/CompanyIsDueToOnlineTaxInput","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m){"use strict";const y=Object.freeze({ON_SAVE:"onSave",ON_VALIDATION_ERROR:"onValidationError",ON_SAVE_ERROR:"onSaveError"}),b=t.extend({className:"mpf-kyc-company-registration mpf-stripe mpf-stripe-eu mpf-horizontal",setup:function({company:e,psp:t,kycDocuments:n,stripeTokenHandler:o}){a.requiredOfPrototype(e,r,"options.company must be a CompanyModel"),a.requiredOfPrototype(n,c,"options.kycDocuments must be a KycDocumentCollection"),a.requiredOfPrototype(o,l,"options.stripeTokenHandler must be a KycStripeTokenHandler"),this.company=e,this.psp=t,this.kycDocuments=n,this.stripeTokenHandler=o,this.isReadOnly=this._isInfoComplete(),this.alert=this._createAlert(),this.registrationIdInput=this._createRegistrationIdInput(),this.registrationDocButton=this._createRegistrationDocButton(),this.vatIdInput=this._createVatIdInput(),this.onlineTaxToggle=this._createOnlineTaxToggle(),this.saveButton=this._createSaveButton(),this.listenTo(this.company,"onChange:"+r.Fields.BUSINESS_TYPE,this._onBusinessTypeChange.bind(this)),this.listenTo(this.registrationIdInput,p.Events.UPDATE,this._onChange.bind(this)),this.listenTo(this.vatIdInput,p.Events.UPDATE,this._onChange.bind(this)),this.listenTo(this.registrationDocButton,h.Events.ON_SAVE,this._onChange.bind(this))},render:function(){return this.container.setContent([this.alert,this.registrationIdInput.render(),this.registrationDocButton.render(),this.vatIdInput.render(),this.onlineTaxToggle.render(),this._createButtonContainer(this.saveButton)]),this},destroy:function(){this.stopListening(),this.registrationIdInput.destroy(),this.registrationDocButton.destroy(),this.vatIdInput.destroy(),this.registrationIdInput=null,this.registrationDocButton=null,this.vatIdInput=null,this.company=null,this.kycDocuments=null,this._parent(),this.container=null},setReadOnly:function(e=!0){this.isReadOnly=e,this.registrationIdInput.setDisabled(e),this.vatIdInput.setDisabled(e),this.saveButton.setDisabled(e),this.render()},_onChange:function(){this._isInfoComplete()?this.saveButton.enable():this.saveButton.disable()},async _onSave(){if(this._isInfoComplete()&&this._validate()){const e={[r.Fields.REGISTRATION_ID]:this.registrationIdInput.getValue(),[r.Fields.TAX_REGISTRATION_ID]:this.vatIdInput.getValue(),[r.Fields.IS_SELLER_DUE_TO_ONLINE_TAX]:this.onlineTaxToggle.getValue()};let t;n.mask(this.container),this.stripeTokenHandler&&this.stripeTokenHandler.isUsingStripeTokens()&&(t=await this.stripeTokenHandler.createCompanyAccountToken()),this.company.savePromise({...e,accountToken:t},{patch:!0}).then(()=>{this.setReadOnly(!0),n.unmask(this.container),this.dispatchEvent(y.ON_SAVE)}).catch(e=>{n.unmask(this.container),console.error(e),this.alert.add({className:"error",message:m.get("errorOccured")}).show(),this.dispatchEvent(y.ON_SAVE_ERROR)})}else this.dispatchEvent(y.ON_VALIDATION_ERROR)},_validate:function(){const e=this.registrationIdInput.validate().isValid,t=this.vatIdInput.validate().isValid;return e&&t},_isInfoComplete:function(){const e=!!this.company.getRegistrationId()&&!this.company.validate(r.Fields.REGISTRATION_ID),t=this.company.isNonProfit()?!this.company.validate(r.Fields.TAX_REGISTRATION_ID):!!this.company.getTaxRegistrationId()&&!this.company.validate(r.Fields.TAX_REGISTRATION_ID);return e&&t},_onBusinessTypeChange:function(){this.vatIdInput=this._createVatIdInput(),this.render()},_createAlert:function(){return new i({visible:!1,autoHide:!0})},_createRegistrationIdInput:function(){return new p({model:this.company,fieldName:r.Fields.REGISTRATION_ID,fieldLabel:m.get("registrationNumber"),required:!0,dynamicValidation:!0,saveOnChange:!1,readOnly:this.isReadOnly})},_createRegistrationDocButton:function(){return h.create({itemClassName:"mpf-registration",company:this.company,psp:this.psp,kycDocuments:this.kycDocuments,stripeTokenHandler:this.stripeTokenHandler,kycId:d.DocumentTypes.kbis,label:m.get("companyRegistrationDocument")})},_createVatIdInput:function(){return new p({model:this.company,fieldName:r.Fields.TAX_REGISTRATION_ID,fieldLabel:m.get("vatId"),required:!this.company.isNonProfit(),dynamicValidation:!0,saveOnChange:!1,readOnly:this.isReadOnly})},_createOnlineTaxToggle:function(){return new u({model:this.company,psp:this.psp,saveOnChange:!0,stripeTokenHandler:this.stripeTokenHandler,className:"mpf-online-tax-toggle"})},_createSaveButton:function(){return new o({className:"primary",value:m.get("save"),disabled:!0,events:{onClick:this._onSave.bind(this)}})},_createButtonContainer:function(t){return e.createElement("div",{class:"mpf-button-container",html:this.isReadOnly?[]:[t]})}});return b.Events=y,b}),define("DS/MPFKycComponent/KycCompanyUboList",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboCollection","DS/MPFShopModel/ShopModel","DS/MPFKycComponent/KycCompanyUboListEntry","DS/MPFPspModel/PspModel","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r){"use strict";return t.extend({className:"mpf-kyc-ubo-list-container",setup:function(e={}){n.requiredOfPrototype(e.companyUbos,o,"options.companyUbos must be a CompanyUboCollection"),n.requiredOfPrototype(e.shop,s,"options.shop must be a ShopModel"),this.companyUbos=e.companyUbos,this.shop=e.shop,this.psp=e.psp,this.informationBox=this._createInformationBox(),this.entries=this.companyUbos.map(this._toRenderedUboListEntry.bind(this)),this.entries.forEach(this._listenToEditCompanyUboEvent.bind(this))},render:function(){const t=this.informationBox?[this.informationBox]:[];return this.companyUbos.isEmpty()||t.push(e.createElement("table",{class:"mpf-kyc-ubo-list",html:this.entries.map(function(e){return e.render()})})),this.container.setContent(t),this},onCompanyUboEdit:function(e){this.dispatchEvent("editCompanyUbo",e)},addUbo:function(e){var t;t=this._toRenderedUboListEntry(e),this.entries.push(t),this._listenToEditCompanyUboEvent(t)},setReadOnly:function(e){for(var t=0;t<this.entries.length;t++)this.entries[t].setReadOnly(e)},_toRenderedUboListEntry:function(e){return new i({companyUbo:e,shop:this.shop})},_listenToEditCompanyUboEvent:function(e){this.listenTo(e,"editCompanyUbo",this.onCompanyUboEdit)},_createInformationBox:function(){let t;if(this.psp.getPsp()===a.Psp.STRIPE){const n=this.psp.isStripeEU()?r.get("companyManagementAndOwnershipInfoEU"):r.get("companyManagementAndOwnershipInfoUS");t=e.createElement("p",{class:"mpf-info",html:[{tag:"span",class:"fonticon fonticon-info"},{tag:"span",text:n}]})}return t}})}),define("DS/MPFKycComponent/ShopMigrationSection",["UWA/Class/View","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Spinner","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFPspModel/PspModel","DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFBankAccountModel/BankAccountModel","DS/MPFKYCDocumentModel/KycDocumentModel","DS/MPFKYCDocumentModel/UboDocumentModel","DS/MPFCompanyUboModel/CompanyUboCollection","DS/MPFKYCDocumentModel/KycDocumentCollection","DS/MPFAddressModel/AddressFactory","DS/MPFKYCDocumentModel/UboDocumentFactory","DS/MPFKycComponent/KycStripeTokenHandler","DS/MPFKycComponent/DocumentMigrationLine","DS/MPFKycComponent/ShopMigrationHelper","i18n!DS/MPFKycComponent/assets/nls/ShopMigrationSection"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m,y,b,f,F,D){"use strict";const S=Object.freeze({}),C=Object.freeze({START:0,LOAD:1,DOCUMENTS:2,WAITING:3,COMPLETE:4,FAILURE:5}),g=e.extend({className:"mpf-shop-migration-section",setup({stripeTokenHandler:e,psp:t,company:n,shop:s,bankAccount:l,companyUbos:p,kycDocuments:f,addressFactory:D,kycDocumentFactory:S,uboDocumentFactory:g}={}){switch(i.requiredOfPrototype(e,b,"options.stripeTokenHandler must be a KycStripeTokenHandler"),i.requiredOfPrototype(t,a,"options.psp must be a PspModel"),i.requiredOfPrototype(n,r,"options.company must be a CompanyModel"),i.requiredOfPrototype(s,c,"options.shop must be a ShopModel"),i.requiredOfPrototype(l,d,"options.bankAccount must be a BankAccountModel"),i.requiredOfPrototype(p,h,"options.companyUbos must be a CompanyUboCollection"),i.requiredOfPrototype(f,u,"options.kycDocuments must be a KycDocumentCollection"),i.requiredOfPrototype(D,m,"options.addressFactory must be a AddressFactory"),i.requiredOfPrototype(g,y,"options.uboDocumentFactory must be a UboDocumentFactory"),this.stripeTokenHandler=e,this.psp=t,this.company=n,this.shop=s,this.bankAccount=l,this.companyUbos=p,this.kycDocuments=f,this.addressFactory=D,this.kycDocumentFactory=S,this.uboDocumentFactory=g,this.spinner=new o,this.alert=this._createAlert(),this.migrationHelper=new F({stripeTokenHandler:e,psp:t,company:n,shop:s,bankAccount:l,companyUbos:p,kycDocuments:f,addressFactory:D,kycDocumentFactory:S,uboDocumentFactory:g}),this.shop.getMigrationStatus()){case"PENDING_VALIDATION":this.step=C.WAITING;break;case"MIGRATION_OK":this.step=C.COMPLETE;break;case"MIGRATION_NOK":this.step=C.FAILURE;break;default:this.step=C.LOAD}},render(){let e;switch(this.step){case C.LOAD:e=this.spinner.show();break;case C.START:e=this._renderMigrationStart();break;case C.DOCUMENTS:e=this._renderDocumentMigration();break;case C.COMPLETE:e=this._renderCompleteState();break;case C.WAITING:e=this._renderWaitingState();break;case C.FAILURE:e=this._renderMigrationFailure()}return this.container.setContent(e),this.step===C.LOAD&&this._load(),this},destroy(){this._destroyDocumentLines(),this.startButton=null,this.documentLines=null,this.stripeTokenHandler=null,this.company=null,this.shop=null,this.psp=null,this.bankAccount=null,this._parent(),this.container=null},async _load(){await Promise.all([this.psp.fetchPromise({forcePsp:"FR"}),this.migrationHelper.loadUboData()]),this._createComponents(),this.step=this.shop.isMigrationComplete()?C.COMPLETE:C.START,this.render()},async _refresh(){await this.migrationHelper.fetchData(),this._createComponents(),this.shop.isMigrationComplete()?this.step=C.COMPLETE:this.migrationHelper.areAllDocumentsUploaded()?(await this.migrationHelper.patchPersonCompletion(),await this.migrationHelper.fetchData(),this.shop.isMigrationComplete()?this.step=C.COMPLETE:this.shop.hasMigrationFailed()?this.step=C.FAILURE:this.step=C.WAITING):this.step=C.DOCUMENTS,this.render()},_fetchData(){return Promise.all([this.migrationHelper.loadUboData(),this.kycDocuments.fetchPromise(),this.shop.fetchPromise({expand:[]})])},_createComponents(){this.startButton&&this.startButton.destroy(),this.startButton=this._createStartButton(),this._destroyDocumentLines(),this.documentLines=this._createDocumentLines()},_destroyDocumentLines(){this.documentLines&&this.documentLines.forEach(e=>{this.stopListening(e),e.destroy()}),this.documentLines=null},async _onMigrationStart(){n.mask(this.container,D.get("startingMigration"));try{await this.migrationHelper.migrateShop(),await this._refresh()}catch(e){console.error(e&&e.response||e),this.alert.add({message:D.get("migrationFailedMsg"),className:"error"}).show()}n.unmask(this.container)},_renderMigrationStart(){return[this.alert,{tag:"div",class:"mpf-migration-start",html:[{tag:"div",text:D.get("migrationExplanation")},this.startButton]}]},_renderDocumentMigration(){return[this.alert,{tag:"div",class:"mpf-document-migration",html:[{tag:"div",text:D.get("documentsExplanation")},{tag:"div",class:"mpf-document-list",html:this.documentLines.map(e=>e.render())}]}]},_renderCompleteState(){return this._renderInfoPanel("status-ok",D.get("migrationCompleted"))},_renderWaitingState(){return this._renderInfoPanel("hourglass",D.get("waitingForMigrationConfirmation"))},_renderMigrationFailure(){return this._renderInfoPanel("error ",D.get("migrationFailed"))},_renderInfoPanel(e,t){return[this.alert,{tag:"div",class:"mpf-confirmation-panel",html:[{tag:"span",class:`fonticon fonticon-${e}`},{tag:"span",class:"mpf-confirmation-message",text:t}]}]},_createAlert:()=>new s({visible:!1,autoHide:!0,hideDelay:4e3}),_createStartButton(){return new t({className:"primary",value:D.get("startStripeFrConversion"),events:{onClick:this._onMigrationStart.bind(this)}})},_createDocumentLines(){const e=this.kycDocuments.filter(e=>!!e.getKycType()).map(e=>{const t=this.kycDocumentFactory.createModel("shop",{[l.Fields.KYC_TYPE]:e.getKycType()},{parentResourceId:this.kycDocuments.parentResourceId});return new f({oldDocument:e,newDocument:t,stripeTokenHandler:this.stripeTokenHandler})});return this.migrationHelper.getUboData().forEach(({ubo:t,uboAddress:n,documents:o})=>{o.forEach(o=>{const s=this.uboDocumentFactory.createModel({[p.Fields.KYC_TYPE]:o.getKycType()},{parentResourceId:t.get("id")});e.push(new f({oldDocument:o,newDocument:s,ubo:t,uboAddress:n,stripeTokenHandler:this.stripeTokenHandler}))})}),e.forEach(e=>{this.listenTo(e,f.Events.ON_ERROR,e=>{this.alert.add({message:e,className:"error"}).show()}),this.listenTo(e,f.Events.LOAD,e=>{e?n.mask(this.container):n.unmask(this.container)}),this.listenTo(e,f.Events.ON_FILE_UPLOAD,async()=>{n.mask(this.container,D.get("updating"));try{await this._refresh()}catch(e){console.error(e),this.alert.add({message:D.get("unableToUpdateData"),className:"error"}).show()}n.unmask(this.container)})}),e}});return g.Events=S,g}),define("DS/MPFKycComponent/KycEmptySection",["DS/MPFKycComponent/KycSection","DS/MPFUtils/MPFUtils","DS/MPFView/EmptyView"],function(e,t,n){"use strict";const o=e.extend({className:"mpf-kyc-section mpf-empty",setup:t.doNothing,render:function(){return this},getBody:n.getInstance,setReadOnly:t.doNothing});let s;return o.getInstance=function(){return s||(s=new o),s},Object.freeze(o),o}),define("DS/MPFKycComponent/KycBankAccountInformationStripeEU",["DS/MPFKycComponent/KycBankAccountInformationStripe"],function(e){"use strict";return e}),define("DS/MPFKycComponent/KycCompanyUboShareInformationFormStripe",["UWA/Core","UWA/Event","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFKYCDocumentModel/UboDocumentCollection","DS/MPFPspModel/PspModel","DS/MPFView/FieldNumberInputV2","DS/MPFView/FieldToggleInput","DS/MPFView/FieldTextInputV2","DS/MPFKycComponent/KycCompanyUboDocumentsFormV2","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p){"use strict";return n.extend({tagName:"form",className:"mpf-kyc-ubo-form-share clearfix",setup:function(e={}){o.requiredOfPrototype(e.companyUbo,s,"options.companyUbo must be a CompanyUboModel"),o.requiredOfPrototype(e.uboDocuments,i,"options.uboDocuments must be a UboDocumentCollection"),o.requiredOfPrototype(e.psp,a,"options.psp must be a PspModel"),o.requiredOfType(e.totalShareholderPercentage,"number","options.totalShareholderPercentage must be a number"),this.companyUbo=e.companyUbo,this.address=e.address,this.uboDocuments=e.uboDocuments,this.psp=e.psp,this.company=e.company,this.totalShareholderPercentage=e.totalShareholderPercentage,this.acceptedFileTypes=e.acceptedFileTypes,this.alreadyHaveRepresentative=e.alreadyHaveRepresentative,this.stripeTokenHandler=e.stripeTokenHandler,this.roleFormTitle=this._createRoleFormTitle(),this.documentsFormTitle=this._createDocumentsTitle(),this.informationBox=this._createInformationBox(),this.jobTitleField=this._createJobTitleField(),this.sharePercentageField=this._createSharePercentageField(),this.representativeRoleField=this._createRepresentativeRoleField(),this.executiveRoleField=this._createExecutiveRoleField(),this.directorRoleField=this._createDirectorRoleField(),this.ownerRoleField=this._createOwnerRoleField(),this.uboDocumentsForm=this._createUboDocumentsForm(),this.container.addEvent("submit",function(e){t.stop(e)}),this.listenTo(this.directorRoleField,c.Events.UPDATE,this.onIsDirectorUpdate.bind(this)),this.listenTo(this.ownerRoleField,c.Events.UPDATE,this.onIsOwnerUpdate.bind(this)),this.listenTo(this.companyUbo,"onChange",this.validateRoles.bind(this))},render:function(){return this.container.setContent([this.roleFormTitle,this.informationBox,this.representativeRoleField.render(),this.executiveRoleField.render(),this.directorRoleField.render(),this.jobTitleField.render(),this.ownerRoleField.render(),this.sharePercentageField.render(),this.documentsFormTitle,this.uboDocumentsForm.render()]),this.onIsDirectorUpdate(),this.onIsOwnerUpdate(),this},destroy:function(){return this.stopListening(this.directorRoleField),this.stopListening(this.ownerRoleField),this.stopListening(this.companyUbo),this._parent()},validate:function(){const e=this.uboDocumentsForm.validate();return this.validateRoles()&&this.validateDirector()&&e},validateRoles:function(){const e=this.directorRoleField.isChecked(),t=""!==this.jobTitleField.getValue(),n=this.ownerRoleField.isChecked(),o=parseFloat(this.sharePercentageField.getValue())>=25,s=(!e||e&&t)&&(!n||n&&o)&&this.validateRepresentativeMustBeOwnerOrExecutive()&&this.validateAtLeastOneRole();return s?(this.documentsFormTitle.show(),this.uboDocumentsForm.container.show()):(this.documentsFormTitle.hide(),this.uboDocumentsForm.container.hide()),s},validateRepresentativeMustBeOwnerOrExecutive:function(){const e=this.representativeRoleField.isChecked(),t=this.executiveRoleField.isChecked(),n=this.ownerRoleField.isChecked(),o=!e||e&&(n||t);return o?(this.representativeRoleField.container.removeClassName("mpf-invalid"),this.ownerRoleField.container.removeClassName("mpf-invalid"),this.executiveRoleField.container.removeClassName("mpf-invalid")):(this.representativeRoleField.container.addClassName("mpf-invalid"),this.ownerRoleField.container.addClassName("mpf-invalid"),this.executiveRoleField.container.addClassName("mpf-invalid")),o},validateAtLeastOneRole:function(){const e=this.representativeRoleField.isChecked(),t=this.executiveRoleField.isChecked(),n=this.ownerRoleField.isChecked(),o=this.directorRoleField.isChecked();return e||t||n||o},validateDirector:function(){const e=this.directorRoleField.isChecked(),t=this.jobTitleField.validate().isValid;return!e||e&&t},onIsDirectorUpdate:function(){this.directorRoleField.isChecked()?this.jobTitleField.container.show():this.jobTitleField.container.hide()},onIsOwnerUpdate:function(){this.ownerRoleField.isChecked()?(0===this.companyUbo.getSharePercentage()&&this.sharePercentageField.setValue(25),this.sharePercentageField.container.show()):(this.sharePercentageField.container.hide(),this.companyUbo.setSharePercentage(0))},_createRoleFormTitle:function(){return e.createElement("h4",{class:"mpf-form-title",text:p.get("role")})},_createDocumentsTitle:function(){return e.createElement("h4",{class:"mpf-form-title",text:p.get("documents")})},_createInformationBox:function(){let t;if(this.psp.getPsp()===a.Psp.STRIPE){const n=this.psp.isStripeEU()?p.get("companyManagementAndOwnershipInfoEU"):p.get("companyManagementAndOwnershipInfoUS");t=e.createElement("p",{class:"mpf-info",html:[{tag:"span",class:"fonticon fonticon-info"},{tag:"span",text:n}]})}return t},_createJobTitleField:function(){return new d({className:"mpf-entry-v2 mpf-one-line",model:this.companyUbo,fieldName:s.Fields.JOB_TITLE,fieldLabel:p.get("jobTitle"),required:!0,dynamicValidation:!0,silent:!1})},_createSharePercentageField:function(){let e;const t=100-(e=this.companyUbo.isNew()?this.totalShareholderPercentage:this.totalShareholderPercentage-this.companyUbo.getSharePercentage()),n=Math.max(25,t);return new r({className:"mpf-number-input-v2 mpf-one-line",model:this.companyUbo,fieldName:s.Fields.SHARE_PERCENTAGE,fieldLabel:p.get("sharePercentage"),min:25,max:n,step:.1,required:!0})},_createRepresentativeRoleField:function(){return new c({model:this.companyUbo,fieldName:s.Fields.IS_REPRESENTATIVE,fieldLabel:p.get("representative"),useStringValue:!0,readOnly:this.alreadyHaveRepresentative})},_createExecutiveRoleField:function(){return new c({model:this.companyUbo,fieldName:s.Fields.IS_EXECUTIVE,fieldLabel:p.get("executive"),useStringValue:!0})},_createDirectorRoleField:function(){return new c({model:this.companyUbo,fieldName:s.Fields.IS_DIRECTOR,fieldLabel:p.get("director"),useStringValue:!0})},_createOwnerRoleField:function(){return new c({model:this.companyUbo,fieldName:s.Fields.IS_OWNER,fieldLabel:p.get("owner")+" ("+p.get("above25%OfShares")+")",useStringValue:!0,readOnly:!this.companyUbo.isOwner()&&this.totalShareholderPercentage>75})},_createUboDocumentsForm:function(){return new l({ubo:this.companyUbo,address:this.address,uboDocs:this.uboDocuments,acceptedFileTypes:this.acceptedFileTypes,psp:this.psp,company:this.company,stripeTokenHandler:this.stripeTokenHandler})}})}),define("DS/MPFKycComponent/KycOperatorEditButton",["UWA/Class/View","DS/UIKIT/Input/Toggle","DS/MPFKycComponent/KycSection","DS/MPFServices/ObjectService","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s){"use strict";return e.extend({className:"mpf-kyc-operator-edit-button",setup:function(e){o.requiredOfPrototype(e.bankAccountDetailsSection,n,"options.bankAccountDetailsSection must be a KycSection"),o.requiredOfPrototype(e.legalRepresentativeSection,n,"options.legalRepresentativeSection must be a KycSection"),o.requiredOfPrototype(e.companyRegistrationInformationSection,n,"options.companyRegistrationInformationSection must be a KycSection"),o.requiredOfPrototype(e.companyUboSection,n,"options.companyUboSection must be a KycSection"),this.bankAccountDetailsSection=e.bankAccountDetailsSection,this.legalRepresentativeSection=e.legalRepresentativeSection,this.companyRegistrationInformationSection=e.companyRegistrationInformationSection,this.companyUboSection=e.companyUboSection,this.setReadOnly(!0===e.isReadOnly),this.editButton=this._createOperatorEditButton()},render:function(){return this.container.setContent(this.editButton),this},setReadOnly:function(e){this.isReadOnly=e,this.bankAccountDetailsSection.setReadOnly(this.isReadOnly),this.legalRepresentativeSection.setReadOnly(this.isReadOnly),this.companyRegistrationInformationSection.setReadOnly(this.isReadOnly),this.companyUboSection.setReadOnly(this.isReadOnly)},toggleEdit:function(){this.setReadOnly(!this.editButton.isChecked())},_createOperatorEditButton:function(){return new t({type:"switch",value:s.get("editAsASeller"),events:{onChange:this.toggleEdit.bind(this)}})}})}),define("DS/MPFKycComponent/KycCompanyUboFormModal",["UWA/Core","UWA/Class/View","UWA/Promise","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFAddressModel/AddressModel","DS/MPFAddressConstraintsModel/AddressConstraintsCollection","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFKYCDocumentModel/UboDocumentModel","DS/MPFPspModel/PspModel","DS/MPFKYCDocumentModel/UboDocumentCollection","DS/MPFCountryModel/CountryCollection","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFKycComponent/KycCompanyUboPersonalInfoForm","DS/MPFKycComponent/KycCompanyUboShareInformationForm","DS/MPFKycComponent/KycCompanyUboShareInformationFormStripe","DS/MPFError/ValidationError","DS/MPFAddressModel/AddressSaveError","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/UIKIT/Alert","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m,y,b,f,F,D,S,C){"use strict";const g=Object.freeze({ON_HIDE:"onHide",UBO_UPDATE:"uboUpdate"}),P=Object.freeze({PAGE_1:"page1",PAGE_2:"page_2"}),_=t.extend({className:"mpf-kyc-ubo-form",setup:function(e={}){o.requiredOfPrototype(e.company,s,"options.company must be a CompanyModel"),o.requiredOfPrototype(e.companyUbo,r,"options.companyUbo must be a CompanyUboModel"),o.requiredOfPrototype(e.address,i,"options.address must be an AddressModel"),o.requiredOfPrototype(e.addressConstraints,a,"options.addressConstraints must be an AddressConstraintsCollection"),o.requiredOfPrototype(e.countries,p,"options.countries must be an CountryCollection"),o.requiredOfPrototype(e.uboDocuments,l,"options.uboDocuments must be an UboDocumentCollection"),o.requiredOfPrototype(e.psp,d,"options.psp must be a PspModel"),o.requiredOfType(e.totalShareholderPercentage,"number","options.totalShareholderPercentage must be a number"),this.company=e.company,this.companyUbo=e.companyUbo,this.address=e.address,this.addressConstraints=e.addressConstraints,this.countries=e.countries,this.uboDocuments=e.uboDocuments,this.psp=e.psp,this.totalShareholderPercentage=e.totalShareholderPercentage,this.acceptedFileTypes=e.acceptedFileTypes,this.alreadyHaveRepresentative=e.alreadyHaveRepresentative,this.stripeTokenHandler=e.stripeTokenHandler,this.stateMachine=this._createStateMachine(),this.pages=this._createPages(),this.modal=this._createModal(),this.alert=this._createAlert()},render:function(){const e=this.stateMachine.getState(),t=this.pages[e];return this.modal.setBody([this.alert,t.render()]),this.container.setContent(this.modal),this},show:function(){this.modal.show()},hide:function(){this.modal.hide()},next:function(){let e;return this.pages[P.PAGE_1].validate(),e=this.pages[P.PAGE_1].canGoNext()?n.resolve(this._goToPage(P.PAGE_2)):n.reject(new b("validation failed to go to next page"))},previous:function(){this._goToPage(P.PAGE_1)},save:function(){const e=this.pages[P.PAGE_2].validate();this._showLoading(!0),this.pages[P.PAGE_2].validateRoles()?this._saveUbo().then(this._saveAddress.bind(this)).then(this._saveUboDocuments.bind(this)).then(this._checkIfUboComplete.bind(this)).then(this._dispatchUboUpdate.bind(this)).then(this._showLoading.bind(this,!1)).then(e?this.hide.bind(this):"").catch(this._onSaveUboError.bind(this)):(this.pages[P.PAGE_2].validateDirector(),this._showLoading(!1))},cancel:function(){this.companyUbo.isNew()||this._dispatchUboUpdate(),this.hide()},async _saveUbo(){if(this.companyUbo.validate())throw new Error("ubo invalid");this.companyUbo.isNew()?(await this._setUboStripeTokens(),await this.companyUbo.savePromise(null,{uboV2:!0})):this.companyUbo.hasPendingChanges()&&(await this._setUboStripeTokens(),await this.companyUbo.savePromise(this.companyUbo.getPendingChanges(),{patch:!0,uboV2:!0}))},async _setUboStripeTokens(){if(this.psp.isStripeEU()){const e=await this.stripeTokenHandler.createPersonToken({person:this.companyUbo,address:this.address});if(this.companyUbo.set(r.Fields.PERSON_TOKEN,e),!this.stripeTokenHandler.doesCompanyExistInMpo()){const e=await this.stripeTokenHandler.createCompanyAccountToken();this.companyUbo.set(r.Fields.ACCOUNT_TOKEN,e)}}},_saveUboDocuments(){return this.uboDocuments.setParentResourceId(this.companyUbo.get("id")),Promise.all([this.pages[P.PAGE_2].uboDocumentsForm.saveIdFile(),this.pages[P.PAGE_2].uboDocumentsForm.saveAddressFile()])},_checkIfUboComplete:function(){let e,t;t=this.psp.getPsp()===d.Psp.HIPAY?this.uboDocuments.hasDocument(c.DocumentTypes.KYC_PERSON_ID)&&this.uboDocuments.hasDocument(c.DocumentTypes.KYC_PERSON_ADDRESS):this.psp.getCountryPlatform()===d.Platform.STRIPE_EU?this.uboDocuments.hasDocument(c.DocumentTypes.KYC_PERSON_ID)&&(!(this.companyUbo.isRepresentative()||this.companyUbo.isExecutive())||this.uboDocuments.hasDocument(c.DocumentTypes.KYC_PERSON_ADDRESS)):this.uboDocuments.hasDocument(c.DocumentTypes.KYC_PERSON_ID);const o=void 0===this.address.validate(),s=this.companyUbo.getMissingFields(),i=0===s.length,a=1===s.length&&s[0]===r.Fields.POSTAL_ADDRESS_ID;if(t&&o&&(i||a)){const t={};t[r.Fields.STATE]=r.States.COMPLETE,e=this.companyUbo.savePromise(t,{patch:!0,uboV2:!0})}else e=n.resolve(this.companyUbo);return e},destroy:function(){this.pages[P.PAGE_1].destroy(),this.pages[P.PAGE_1]=null,this.pages[P.PAGE_2].destroy(),this.pages[P.PAGE_2]=null,this.pages=null,this.modal=null,this.companyUbo=null,this.uboDocuments=null,this.address=null,this.addressConstraints=null,this.countries=null,this.psp=null,this.stateMachine=null,this._parent()},_dispatchUboUpdate:function(){this.dispatchEvent(g.UBO_UPDATE,this.companyUbo.id)},_goToPage:function(e){e=e===P.PAGE_2?P.PAGE_2:P.PAGE_1,this.stateMachine.changeState(e),this._updateAvailableCommands(),this.render()},_onSaveUboError:function(e){let t;console.error(e),this._showLoading(!1);const n=this.psp.getPsp()===d.Psp.HIPAY;t=Object.prototype.isPrototypeOf.call(f.prototype,e)?n?C.get("errorSaveUboAddress"):C.get("errorSavePersonAddress"):n?C.get("errorSaveUBO"):C.get("errorSavePerson"),this.alert.add({className:"error",message:t}).show()},_showLoading:function(e){this.saveButton.load(e)},_createAlert:function(){return new S({closable:!0,closeOnClick:!0})},_createStateMachine:function(){return new h({states:[P.PAGE_1,P.PAGE_2],state:P.PAGE_1,transitions:[{from:P.PAGE_1,to:P.PAGE_2},{from:P.PAGE_2,to:P.PAGE_1}]})},_createPages:function(){const e={};return e[P.PAGE_1]=new u({companyUbo:this.companyUbo,address:this.address,addressConstraints:this.addressConstraints,countries:this.countries,psp:this.psp,company:this.company}),this.psp.getPsp()===d.Psp.STRIPE?e[P.PAGE_2]=new y({company:this.company,companyUbo:this.companyUbo,address:this.address,uboDocuments:this.uboDocuments,kycDocuments:this.kycDocuments,totalShareholderPercentage:this.totalShareholderPercentage,acceptedFileTypes:this.acceptedFileTypes,psp:this.psp,stripeTokenHandler:this.stripeTokenHandler,alreadyHaveRepresentative:this.alreadyHaveRepresentative}):e[P.PAGE_2]=new m({companyUbo:this.companyUbo,uboDocuments:this.uboDocuments,kycDocuments:this.kycDocuments,totalShareholderPercentage:this.totalShareholderPercentage,acceptedFileTypes:this.acceptedFileTypes,psp:this.psp}),e},_createModal:function(){const t=e.createElement("h4",{text:C.get("addPerson")}),n=this._createModalCommands();return new F({header:t,footer:n,events:{onHide:this.dispatchEvent.bind(this,g.ON_HIDE)}})},_createModalCommands:function(){return this.previousButton=this._createPreviousButton(),this.nextButton=this._createNextButton(),this.saveButton=this._createSaveButton(),this.cancelButton=this._createCancelButton(),this._updateAvailableCommands(),e.createElement("div",{class:"mpf-commands",html:[this.previousButton,this.nextButton,this.saveButton,this.cancelButton]})},_updateAvailableCommands:function(){const e=this.stateMachine.getState();e===P.PAGE_1?(this.previousButton.hide(),this.nextButton.show(),this.saveButton.hide()):e===P.PAGE_2&&(this.previousButton.show(),this.nextButton.hide(),this.saveButton.show())},_createPreviousButton:function(){return new D({value:C.get("previous"),className:"default previous",events:{onClick:this.previous.bind(this)}})},_createNextButton:function(){return new D({value:C.get("next"),className:"primary next",events:{onClick:this.next.bind(this)}})},_createSaveButton:function(){return new D({value:C.get("save"),className:"primary save",events:{onClick:this.save.bind(this)}})},_createCancelButton:function(){return new D({value:C.get("cancel"),className:"default cancel",events:{onClick:this.cancel.bind(this)}})},async _saveAddress(){const e=this.address.hasPendingChanges(),t=void 0===this.address.validate();if(e)if(t){if(this.psp.isStripeEU()){const e=await this.stripeTokenHandler.createPersonToken({person:this.companyUbo,address:this.address});this.address.set("personToken",e)}this.address.setParentResourceId(this.companyUbo.get("id")),await this.address.savePromise()}else if(!this.address.isEmpty())throw new f}});return _.Events=g,_.States=P,_}),define("DS/MPFKycComponent/KycCompanyUbo",["UWA/Core","UWA/Class/View","UWA/Promise","DS/UIKIT/Alert","DS/MPFServices/ObjectService","DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFPspModel/PspModel","DS/MPFCountryModel/CountryCollection","DS/MPFCompanyUboModel/CompanyUboModel","DS/MPFCompanyUboModel/CompanyUboCollection","DS/MPFCompanyUboModel/CompanyUboFactory","DS/MPFAddressModel/AddressFactory","DS/MPFKYCDocumentModel/UboDocumentFactory","DS/MPFKycComponent/KycCompanyUboList","DS/MPFKycComponent/KycCompanyUboFormModal","DS/MPFView/FieldToggleInput","DS/UIKIT/Input/Button","DS/UIKIT/Mask","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m,y,b,f,F,D){"use strict";const S=Object.freeze({ON_CHANGE:"onChange"}),C=t.extend({className:"mpf-kyc-ubo",setup:function(e={}){s.requiredOfPrototype(e.company,i,"options.company must be a CompanyModel"),s.requiredOfPrototype(e.companyUbos,l,"options.companyUbos must be a CompanyUboCollection"),s.requiredOfPrototype(e.companyUboFactory,p,"options.companyUboFactory must be a CompanyUboFactory"),s.requiredOfPrototype(e.uboDocumentFactory,u,"options.uboDocumentFactory must be a UboDocumentFactory"),s.requiredOfPrototype(e.addressFactory,h,"options.addressFactory must be an AddressFactory"),s.requiredOfPrototype(e.countries,c,"options.countries must be an CountryCollection"),s.requiredOfPrototype(e.shop,a,"options.shop must be a ShopModel"),s.requiredOfPrototype(e.psp,r,"options.psp must be a PspModel"),this.company=e.company,this.shop=e.shop,this.companyUbos=e.companyUbos,this.psp=e.psp,this.acceptedFileTypes=e.acceptedFileTypes,this.companyUboFactory=e.companyUboFactory,this.uboDocumentFactory=e.uboDocumentFactory,this.addressFactory=e.addressFactory,this.countries=e.countries,this.isDSOperator=e.isDSOperator,this.readOnly=!0===e.readOnly,this.stripeTokenHandler=e.stripeTokenHandler,this.alert=this._createAlert(),this.companyUboList=this._createUboList(),this.addCompanyUboButton=this._createAddCompanyUboButton(),this.noShareHolderCheckbox=this._createNoShareHolderCheckbox(),this.saveButton=this._createSaveButton(),this.buttonContainer=this._createButtoncontainer(),this.warningContainer=this._createWarningContainer(),this.listenTo(this.companyUboList,"editCompanyUbo",e=>{this.onEditCompanyUbo(e).catch(e=>console.error(e))}),this.listenTo(this.company,"onChange:"+i.Fields.NO_SHAREHOLDER,this.render.bind(this)),this.psp.getPsp()===r.Psp.STRIPE&&this.container.addClassName("mpf-stripe")},render:function(){const e=[];return e.push(this.alert),e.push(this.companyUboList.render()),this.noShareHolderCheckbox&&(this.company.getNoShareHolder()||this.companyUbos.isEmpty())&&e.push(this.noShareHolderCheckbox.render()),e.push(this._createFooter(this.warningContainer,this.buttonContainer)),this.companyUboForm&&e.push(this.companyUboForm.render()),this._checkSaveAvailibility(),this.container.setContent(e),this},destroy:function(){this.stopListening(this.companyUboList),this.companyUboForm&&this._destroyCompanyUboForm(),this.companyUboList.destroy(),this.addCompanyUboButton.destroy(),this.noShareHolderCheckbox&&this.noShareHolderCheckbox.destroy(),this.stopListening(this.company),this.company=null,this.shop=null,this.psp=null,this.companyUbos=null,this.companyUboFactory=null,this.uboDocumentFactory=null,this.addressFactory=null,this.countries=null,this._parent(),this.container=null},setReadOnly:function(e){this.readOnly=!1!==e,this.addCompanyUboButton.setDisabled(this.readOnly||!this._canAddPersons()),this.saveButton&&this.saveButton.setDisabled(this.readOnly||!this._hasRequiredRoles()),this.noShareHolderCheckbox&&this.noShareHolderCheckbox.setReadOnly(this.readOnly),this.companyUboList.setReadOnly(this.readOnly)},onEditCompanyUbo:function(e){F.mask(e.entry.container);const t=this.companyUboFactory.createModel(p.Types.COMPANY_UBO,{id:e.id});return this._fetchData(t,e).then(n=>{const o=n[0],s=n[1];this._createCompanyUboForm(t,o,s),F.unmask(e.entry.container),this.render(),this.companyUboForm.show()})},_fetchData:function(e,t){return n.all([this._fetchUboAndAddress(e),this._fetchUboDocuments(t.id)]).catch(e=>(F.unmask(t.entry.container),this.alert.add({message:D.get("failedToLoadUbo"),className:"error"}).show(),n.reject(e)))},_fetchUboAndAddress:function(e){return e.fetchPromise().then(e=>{const t=e.getPostalAddressId();return t?this.addressFactory.createModel(h.Types.ADDRESS,{id:t}).fetchPromise():this.addressFactory.createModel(h.Types.PERSON)})},_fetchUboDocuments:function(e){const t=this.uboDocumentFactory.createCollection();return t.setParentResourceId(e),t.fetchPromise()},onCreateCompanyUbo:function(){this._createNewCompanyUboForm(),this.render(),this.companyUboForm.show()},async onSave(){const e={[i.Fields.EXECUTIVES_PROVIDED]:"TRUE",[i.Fields.DIRECTORS_PROVIDED]:"TRUE",[i.Fields.OWNERS_PROVIDED]:"TRUE"};let t;if(this.saveButton&&this.saveButton.load(!0),this.psp.isStripeEU()){const e={executives_provided:!0,directors_provided:!0,owners_provided:!0};if("GBR"===this.company.getCountry()){let t=this.stripeTokenHandler.getClientIp();t||(await this.stripeTokenHandler.createCompanyAccountToken(),t=this.stripeTokenHandler.getClientIp()),e.ownership_declaration={date:Date.now()+"",ip:t}}t=await this.stripeTokenHandler.createCompanyAccountToken({attributes:e})}try{await this.company.savePromise({...e,accountToken:t},{patch:!0})}catch(e){this.alert.add({message:D.get("failedToSaveUbos"),className:"error"}).show()}this.saveButton&&this.saveButton.load(!1)},_createCompanyUboForm:function(e,t,n){this.companyUboForm=new y({company:this.company,companyUbo:e,uboDocuments:n,kycDocuments:this.kycDocuments,psp:this.psp,address:t,addressConstraints:this.addressFactory.getConstraints(),countries:this.countries,totalShareholderPercentage:this._getTotalShareholderPercentage(),acceptedFileTypes:this.acceptedFileTypes,alreadyHaveRepresentative:this.companyUbos.hasRepresentative(),stripeTokenHandler:this.stripeTokenHandler}),this.listenTo(this.companyUboForm,y.Events.UBO_UPDATE,this._onUboUpdate.bind(this)),this.listenTo(this.companyUboForm,y.Events.ON_HIDE,this._destroyCompanyUboForm.bind(this))},_onUboUpdate:function(e){this._refreshUboList(e).then(this.dispatchEvent.bind(this,S.ON_CHANGE))},_destroyCompanyUboForm:function(){this.stopListening(this.companyUboForm),this.companyUboForm.destroy(),this.companyUboForm=null},_refreshUboList:function(e){let t,n;return t=(n=this.companyUbos.get(e))?n.fetchPromise().then(this.companyUboList.render.bind(this.companyUboList)).then(this._checkTotalShareHolderPercentage.bind(this)).then(this._hideNoShareHolderCheckbox.bind(this)).then(this._checkSaveAvailibility.bind(this)):(n=this.companyUboFactory.createModel(p.Types.COMPANY_UBO,{id:e})).fetchPromise().then(this.companyUbos.add.bind(this.companyUbos,n)).then(this.companyUboList.addUbo.bind(this.companyUboList,n)).then(this.companyUboList.render.bind(this.companyUboList)).then(this._checkTotalShareHolderPercentage.bind(this)).then(this._hideNoShareHolderCheckbox.bind(this)).then(this._checkSaveAvailibility.bind(this))},_createUboList:function(){return new m({companyUbos:this.companyUbos,shop:this.shop,psp:this.psp})},_createAddCompanyUboButton:function(){return new f({value:D.get("addPerson"),icon:"user-add",disabled:this.readOnly||!this._canAddPersons(),events:{onClick:this.onCreateCompanyUbo.bind(this)}})},_createSaveButton:function(){let e;return this.psp.getPsp()!==r.Psp.HIPAY&&(e=new f({className:"primary",value:D.get("save"),disabled:this.readOnly,events:{onClick:this.onSave.bind(this)}})),e},_createFooter:function(t,n){return e.createElement("div",{class:"mpf-ubo-footer",html:[t,n]})},_createButtoncontainer:function(){const t=[this.addCompanyUboButton];return this.saveButton&&t.push(this.saveButton),e.createElement("div",{class:"mpf-button-container",html:t})},_createWarningContainer:function(){return e.createElement("div",{class:"mpf-warning-container"})},_createNewCompanyUboForm:function(){const e=this.companyUboFactory.createModel(p.Types.COMPANY_COMPANY_UBO);e.setTitle("mr"),e.setSharePercentage(25),e.setParentResourceId(this.company.id),e.setUboNumber(this.companyUbos.size()+1),this.psp.getPsp()===r.Psp.HIPAY&&e.set(d.Fields.IS_OWNER,"TRUE");const t=this.addressFactory.createModel(h.Types.PERSON),n=this.uboDocumentFactory.createCollection();this._createCompanyUboForm(e,t,n)},_createNoShareHolderCheckbox:function(){let e;return this.psp.getPsp()===r.Psp.HIPAY&&(e=new b({model:this.company,fieldName:i.Fields.NO_SHAREHOLDER,fieldLabel:D.get("noShareHolder"),saveOnChange:!0,readOnly:this.readOnly||this.shop.getState()===a.States.SUBMITTED||this.shop.getState()===a.States.ACTIVE}),this.listenTo(e,b.Events.UPDATE,this._onToggleNoShareHolder.bind(this)),this.listenTo(e,b.Events.ERROR,()=>{this.alert.add({className:"error",message:D.get("errorOccured")}).show()})),e},_onToggleNoShareHolder:function(){this.noShareHolderCheckbox.isChecked()?this.buttonContainer.hide():this.buttonContainer.show(),this.dispatchEvent(S.ON_CHANGE)},_checkTotalShareHolderPercentage:function(){!this.readOnly&&this._canAddPersons()?this.addCompanyUboButton.enable():this.addCompanyUboButton.disable()},_canAddPersons:function(){return this.psp.getPsp()!==r.Psp.HIPAY||this._getTotalShareholderPercentage()<=75&&this.shop.getState()!==a.States.SUBMITTED&&this.shop.getState()!==a.States.ACTIVE},_getTotalShareholderPercentage:function(){return this.companyUbos.reduce((e,t)=>t.isOwner()?e+parseFloat(t.getSharePercentage(),10):e,0)},_hideNoShareHolderCheckbox:function(){this.noShareHolderCheckbox&&this.noShareHolderCheckbox.container.setStyle("display","none")},_createAlert:function(){return new o({visible:!1,autoHide:!0,closeOnClick:!0})},_checkSaveAvailibility:function(){const e=this.companyUbos.hasRequiredRoles(this.psp);if(this._clearWarning(),e.ok)this.saveButton&&this.saveButton.enable();else if(this.saveButton&&this.saveButton.disable(),this.psp.isStripeEU()){if(this.companyUbos.size()>0){let t;t=e.hasRepresentative?D.get("executiveOrOwnerMissing"):e.hasExecutive||e.hasOwner?D.get("representativeMissing"):D.get("representativeAndExecutiveOrOwnerMissing"),this._showWarning(t)}}else this.psp.isStripeUS()?this.companyUbos.size()>0&&this._showWarning(D.get("representativeMissing")):this.saveButton&&this.saveButton.enable()},_hasRequiredRoles:function(){return this.companyUbos.hasRequiredRoles(this.psp).ok},_showWarning:function(e){this.warningContainer.setContent([{tag:"span",class:"fonticon fonticon-attention"},{tag:"span",text:e}])},_clearWarning:function(){this.warningContainer.empty()}});return C.Events=S,C}),define("DS/MPFKycComponent/KycSectionFactory",["UWA/Class","DS/MPFAddressModel/AddressFactory","DS/MPFAddressModel/AddressCollection","DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFKYCDocumentModel/KycDocumentCollection","DS/MPFKYCDocumentModel/KycDocumentModel","DS/MPFBankAccountModel/BankAccountModel","DS/MPFCompanyUboModel/CompanyUboCollection","DS/MPFCompanyUboModel/CompanyUboFactory","DS/MPFKYCDocumentModel/UboDocumentFactory","DS/MPFCountryModel/CountryCollection","DS/MPFPspModel/PspModel","DS/MPFServices/ObjectService","DS/MPFUtils/MPFUtils","DS/MPFKycComponent/KycSection","DS/MPFKycComponent/ShopMigrationSection","DS/MPFKycComponent/KycBankAccountInformationStripe","DS/MPFKycComponent/KycBankAccountInformationStripeEU","DS/MPFKycComponent/KycCompanyRegistrationInformationStripeUS","DS/MPFKycComponent/KycCompanyRegistrationInformationStripeCAN","DS/MPFKycComponent/KycCompanyRegistrationInformationStripeEUV2","DS/MPFKycComponent/KycCompanyActivityForm","DS/MPFKycComponent/KycCompanyUbo","DS/MPFKycComponent/KycEmptySection","i18n!DS/MPFKycComponent/assets/nls/KycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m,y,b,f,F,D,S,C,g,P,_,I){"use strict";return e.extend({init:function(e={}){this._checkRequiredParameters(e),this.company=e.company,this.companyAddresses=e.companyAddresses,this.shop=e.shop,this.bankAccount=e.bankAccount,this.kycDocuments=e.kycDocuments,this.companyUbos=e.companyUbos,this.companyUboFactory=e.companyUboFactory,this.kycDocumentFactory=e.kycDocumentFactory,this.uboDocumentFactory=e.uboDocumentFactory,this.addressFactory=e.addressFactory,this.countries=e.countries,this.psp=e.psp,this.companyIndustries=e.companyIndustries,this.mpEventTopic=e.mpEventTopic,this.isDSOperator=e.isDSOperator,this.stripeTokenHandler=e.stripeTokenHandler,this.companyCountry=this.company.getAddresses().first().getCountry()},createShopMigrationSection(){return this.isDSOperator&&this.psp.isStripe()&&this.shop.hasStripeMigrationStatus()?new y({title:I.get("stripeFrMigration"),body:new b({stripeTokenHandler:this.stripeTokenHandler,psp:this.psp,company:this.company,shop:this.shop,bankAccount:this.bankAccount,companyUbos:this.companyUbos,kycDocuments:this.kycDocuments,addressFactory:this.addressFactory,kycDocumentFactory:this.kycDocumentFactory,uboDocumentFactory:this.uboDocumentFactory})}):_.getInstance()},createCompanyActivitySection:function(){const e=new g({company:this.company,companyIndustries:this.companyIndustries});return new y({title:I.get("companyActivity"),body:e})},createCompanyLegalRepresentativeSection:function(){return _.getInstance()},createBankAccountDetailsSection:function(){let e;return this.bankAccount.set({country:this.companyCountry}),e=this.psp.isStripeEU()||this.psp.isStripeGB()?new F({bankAccount:this.bankAccount,kycDocuments:this.kycDocuments,stripeTokenHandler:this.stripeTokenHandler,psp:this.psp}):new f({bankAccount:this.bankAccount,kycDocuments:this.kycDocuments,stripeTokenHandler:this.stripeTokenHandler,psp:this.psp}),new y({title:I.get("bankAccountDetails"),body:e})},createCompanyRegistrationInformation:function(){let e;return e=this.psp.isStripeEU()||this.psp.isStripeGB()?new C({company:this.company,psp:this.psp,kycDocuments:this.kycDocuments,stripeTokenHandler:this.stripeTokenHandler}):"CAN"===this.company.getCountry()?new S({company:this.company,kycDocuments:this.kycDocuments}):new D({company:this.company,kycDocuments:this.kycDocuments}),new y({title:I.get("companyRegistrationInformation"),body:e})},createCompanyNameAndAddressSection:function(){return _.getInstance()},createCompanyUboSection:function(){const e=new P({company:this.company,companyUbos:this.companyUbos,companyUboFactory:this.companyUboFactory,uboDocumentFactory:this.uboDocumentFactory,addressFactory:this.addressFactory,countries:this.countries,isDSOperator:this.isDSOperator,shop:this.shop,psp:this.psp,stripeTokenHandler:this.stripeTokenHandler,acceptedFileTypes:["image/png","image/jpeg"]});return new y({title:I.get("companyManagementAndOwnership"),body:e})},_checkRequiredParameters:function(e){u.requiredOfPrototype(e.company,o,"options.company must be a ComapnyModel"),u.requiredOfPrototype(e.companyAddresses,n,"options.companyAddresses must be an AddressCollection"),u.requiredOfPrototype(e.shop,s,"options.shop must be a ShopModel"),u.requiredOfPrototype(e.bankAccount,r,"options.bankAccount must be an BankAccountModel"),u.requiredOfPrototype(e.kycDocuments,i,"options.kycDocuments must be a KycDocumentCollection"),u.requiredOfPrototype(e.companyUbos,c,"options.companyUbos must be a CompanyUboCollection"),u.requiredOfPrototype(e.companyUboFactory,d,"options.companyUboFactory must be a CompanyUboFactory"),u.requiredOfPrototype(e.uboDocumentFactory,l,"options.uboDocumentFactory must be a UboDocumentFactory"),u.requiredOfPrototype(e.addressFactory,t,"options.addressFactory must be an AddressFactory"),u.requiredOfPrototype(e.countries,p,"options.countries must be a CountryCollection"),u.requiredOfPrototype(e.psp,h,"options.psp must be a PspModel"),u.requiredOfPrototype(e.uboDocumentFactory,l,"options.uboDocumentFactory must be a UboDocumentFactory")}})}),define("DS/MPFKycComponent/KycPage",["UWA/Class/View","DS/PlatformAPI/PlatformAPI","DS/MPFKycComponent/KycPageCompletion","DS/MPFAddressModel/AddressFactory","DS/MPFAddressModel/AddressCollection","DS/MPFCompanyModel/CompanyModel","DS/MPFShopModel/ShopModel","DS/MPFKYCDocumentModel/KycDocumentCollection","DS/MPFBankAccountModel/BankAccountModel","DS/MPFCompanyUboModel/CompanyUboCollection","DS/MPFCompanyUboModel/CompanyUboFactory","DS/MPFKYCDocumentModel/UboDocumentFactory","DS/MPFCountryModel/CountryCollection","DS/MPFPspModel/PspModel","DS/MPFCompanyModel/CompanyIndustryListModel","DS/MPFServices/ObjectService","DS/MPFKycComponent/KycSectionFactory","DS/MPFKycComponent/KycPageInformation","DS/MPFKycComponent/KycOperatorEditButton","DS/MPFKycComponent/KycStripeTokenHandler","css!DS/MPFUI/MPFUI","css!DS/MPFKycComponent/MPFKycComponent"],function(e,t,n,o,s,i,a,r,c,d,l,p,h,u,m,y,b,f,F,D){"use strict";const S=e.extend({className:"mpf-kyc-page",setup:function(e={}){this._checkRequiredParameters(e),this.company=e.company,this.companyAddresses=e.companyAddresses,this.bankAccount=e.bankAccount,this.kycDocuments=e.kycDocuments,this.companyUbos=e.companyUbos,this.companyUboFactory=e.companyUboFactory,this.kycDocumentFactory=e.kycDocumentFactory,this.uboDocumentFactory=e.uboDocumentFactory,this.addressFactory=e.addressFactory,this.countries=e.countries,this.mpEventTopic=e.mpEventTopic,this.isDSOperator=e.isDSOperator,this.shop=e.shop,this.psp=e.psp,this.companyIndustries=e.companyIndustries,this.stripeTokenHandler=this._createStripeTokenHandler(),this.sectionFactory=this._createKycSectionFactory(),this.informationSection=this._createPageInformationSection(),this.shopMigrationSection=this.sectionFactory.createShopMigrationSection(),this.companyActivitySection=this.sectionFactory.createCompanyActivitySection(),this.companyNameAndAddressSection=this.sectionFactory.createCompanyNameAndAddressSection(),this.bankAccountDetailsSection=this.sectionFactory.createBankAccountDetailsSection(),this.legalRepresentativeSection=this.sectionFactory.createCompanyLegalRepresentativeSection(),this.companyRegistrationInformationSection=this.sectionFactory.createCompanyRegistrationInformation(),this.companyUboSection=this.sectionFactory.createCompanyUboSection(),this.listenTo(this.company,"onChange",this.checkCompleted.bind(this)),this.listenTo(this.bankAccount,"onChange",this.checkCompleted.bind(this)),this.listenTo(this.kycDocuments,"onChange",this.checkCompleted.bind(this)),this.listenTo(this.companyUbos,"onChange",this.checkCompleted.bind(this)),this.listenTo(this.companyUboSection.getBody(),"onChange",this.checkCompleted.bind(this)),this.checkCompleted(),this.isDSOperator&&(this.operatorEditButton=new F({bankAccountDetailsSection:this.bankAccountDetailsSection,legalRepresentativeSection:this.legalRepresentativeSection,companyRegistrationInformationSection:this.companyRegistrationInformationSection,companyUboSection:this.companyUboSection,isReadOnly:!0}))},render:function(){return this.container.setContent([this.stripeTokenHandler&&!this.stripeTokenHandler.isStripeInDom()&&this.stripeTokenHandler.createStripeTag(),this.informationSection.render(),this.shopMigrationSection.render(),this.companyActivitySection.render(),this.companyNameAndAddressSection.render(),this.bankAccountDetailsSection.render(),this.legalRepresentativeSection.render(),this.companyRegistrationInformationSection.render(),this.companyUboSection.render()]),this.isDSOperator&&this.operatorEditButton.render().inject(this.container,"top"),this},checkCompleted:function(){const e=n.isCompleted({psp:this.psp,company:this.company,kycDocuments:this.kycDocuments,bankAccount:this.bankAccount,companyUbos:this.companyUbos});if(this.mpEventTopic){const n=e?"complete":"inactive";t.publish(this.mpEventTopic,{event:"updateMenu",id:"kyc",status:n})}return e},destroy:function(){this.stopListening(),this.informationSection.destroy(),this.companyNameAndAddressSection.destroy(),this.bankAccountDetailsSection.destroy(),this.legalRepresentativeSection.destroy(),this.companyRegistrationInformationSection.destroy(),this.companyUboSection.destroy(),this.company=null,this.bankAccount=null,this.kycDocuments=null,this.companyUbos=null,this.companyAddresses=null,this.companyUboFactory=null,this.uboDocumentFactory=null,this.addressFactory=null,this.countries=null,this.shop=null,this.psp=null,this.companyIndustries=null,this._parent(),this.container=null},_checkRequiredParameters:function(e){y.requiredOfPrototype(e.company,i,"options.company must be a ComapnyModel"),y.requiredOfPrototype(e.companyAddresses,s,"options.companyAddresses must be an AddressCollection"),y.requiredOfPrototype(e.bankAccount,c,"options.bankAccount must be an BankAccountModel"),y.requiredOfPrototype(e.kycDocuments,r,"options.kycDocuments must be a KycDocumentCollection"),y.requiredOfPrototype(e.companyUbos,d,"options.companyUbos must be a CompanyUboCollection"),y.requiredOfPrototype(e.companyUboFactory,l,"options.companyUboFactory must be a CompanyUboFactory"),y.requiredOfPrototype(e.addressFactory,o,"options.addressFactory must be an AddressFactory"),y.requiredOfPrototype(e.countries,h,"options.countries must be a CountryCollection"),y.requiredOfPrototype(e.shop,a,"options.shop must be a ShopModel"),y.requiredOfPrototype(e.psp,u,"options.psp must be a PspModel"),y.requiredOfPrototype(e.uboDocumentFactory,p,"options.uboDocumentFactory must be a UboDocumentFactory"),y.requiredOfPrototype(e.companyIndustries,m,"options.companyIndustries must be a CompanyIndustryListModel")},_createKycSectionFactory:function(){return new b({company:this.company,companyAddresses:this.companyAddresses,shop:this.shop,bankAccount:this.bankAccount,kycDocuments:this.kycDocuments,companyUbos:this.companyUbos,companyUboFactory:this.companyUboFactory,kycDocumentFactory:this.kycDocumentFactory,uboDocumentFactory:this.uboDocumentFactory,addressFactory:this.addressFactory,countries:this.countries,psp:this.psp,companyIndustries:this.companyIndustries,isDSOperator:this.isDSOperator,stripeTokenHandler:this.stripeTokenHandler})},_createPageInformationSection:function(){return new f({company:this.company,psp:this.psp})},_createStripeTokenHandler(){return new D({psp:this.psp,company:this.company,shop:this.shop,bankAccount:this.bankAccount,countries:this.countries})}});return S.isCompleted=n.isCompleted,S}),define("DS/MPFKycComponent/KycPageFactory",["UWA/Core","UWA/Promise","DS/MPFKycComponent/KycPage","DS/MPFConnector/Connector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFPersonModel/PersonFactory","DS/MPFShopModel/ShopFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyUboModel/CompanyUboFactory","DS/MPFPspModel/PspFactory","DS/MPFServices/ObjectService"],function(e,t,n,o,s,i,a,r,c,d,l){"use strict";return e.Class.extend({init:function(e){l.requiredOfPrototype(e.connector,o,"options.connector must be a Connector"),this.connector=e.connector,this.mpEventTopic=e.mpEventTopic,this.factories=s.getInstance(this.connector)},fromMe:function(){return this._initFactories().then(()=>Promise.all([this._fetchMeThenCompanyThenUbos(),this._fetchShopsThenPspAndKycDocs(),this._fetchCountries(),this._fetchCompanyIndustries()])).then(()=>Promise.all([this._getCompanyAddressesAsCollection(),this._assignCountrytoBankAccount()])).then(this._buildKycPage.bind(this))},fromShopId:function(e){return this._initFactories().then(()=>Promise.all([this._fetchPsp(e),this._fetchShopThenCompanyThenUbos(e),this._fetchShopDocuments(e),this._fetchMe(),this._fetchCountries(),this._fetchCompanyIndustries()])).then(()=>Promise.all([this._getCompanyAddressesAsCollection(),this._assignCountrytoBankAccount()])).then(this._buildKycPage.bind(this))},_fetchMeThenCompanyThenUbos:function(){return this._fetchMe().then(this._fetchMyCompany.bind(this)).then(this._fetchCompanyUbos.bind(this))},_fetchShopsThenPspAndKycDocs:function(){return this._fetchMyShops().then(this._fetchMyShop.bind(this)).then(()=>Promise.all([this._fetchPsp(),this._fetchShopDocuments()]))},_fetchShopThenCompanyThenUbos:function(e){return this._fetchShop(e).then(this._fetchCompanyFromShop.bind(this)).then(this._fetchCompanyUbos.bind(this))},_initFactories:function(){return Promise.all([this.factories.getFactory(s.Types.PERSON),this.factories.getFactory(s.Types.COMPANY),this.factories.getFactory(s.Types.SHOP),this.factories.getFactory(s.Types.KYC_DOCUMENT),this.factories.getFactory(s.Types.BANK_ACCOUNT),this.factories.getFactory(s.Types.ADDRESS),this.factories.getFactory(s.Types.COMPANY_UBO),this.factories.getFactory(s.Types.UBO_DOCUMENT),this.factories.getFactory(s.Types.COUNTRY),this.factories.getFactory(s.Types.PSP),this.factories.getFactory(s.Types.COMPANY_INDUSTRY_LIST)]).then(e=>{this.personFactory=e[0],this.companyFactory=e[1],this.shopFactory=e[2],this.kycDocumentFactory=e[3],this.bankAccountFactory=e[4],this.addressFactory=e[5],this.companyUboFactory=e[6],this.uboDocumentFactory=e[7],this.countryFactory=e[8],this.pspFactory=e[9],this.companyIndustryFactory=e[10]})},_fetchMe:function(){return this.me=this.personFactory.createModel(i.Types.ME),this.me.fetchPromise()},_fetchMyCompany:function(){const e=this.me.getCompany();return this._fetchCompanyFromRef(e)},_fetchCompanyFromRef:function(e){const t=(e.match(/[A-Z0-9]{32}$/)||[]).pop();return this.company=this.companyFactory.createModel(null,{id:t},{addressFactory:this.addressFactory}),this.company.fetchPromise({expand:["addresses","registrations","uboPersons"]})},_fetchMyShops:function(){return this.shops=this.shopFactory.createCollection(a.Types.ME),this.shops.fetchPromise({expand:[]})},_fetchMyShop:function(){return this.shop=this.shops.first(),t.resolve(this.shop)},_fetchCountries:function(){return this.countries=this.countryFactory.createCollection("buyer"),this.countries.fetchPromise()},_fetchCompanyIndustries:function(){return this.companyIndustries=this.companyIndustryFactory.createModel(),this.companyIndustries.fetchPromise()},_fetchShopDocuments:function(n){const o=e.is(n,"string")?n:this.shop.id;return this.kycDocuments=this.kycDocumentFactory.createCollection("shop"),this.kycDocuments.parentResourceId=o,this.bankAccount=this.bankAccountFactory.createModel(),this.bankAccount.parentResourceId=o,this.bankAccountConstraints=this.bankAccountFactory.getConstraints(),t.all([this.kycDocuments.fetchPromise(),this.bankAccount.fetchPromise()])},_getCompanyAddressesAsCollection:function(){this.companyAddresses=this.addressFactory.createCollection(r.Types.COMPANY,this.company.addresses.toArray()),this.companyAddresses.parentResourceId=this.company.id},_assignCountrytoBankAccount:function(){const e=this.company.addresses.first();this.bankAccount.set("country",e.get("country"))},_fetchShop:function(e){return this.shop=this.shopFactory.createModel(a.Types.SHOP,{id:e}),this.shop.fetchPromise({expand:[]})},_fetchCompanyFromShop:function(){const e=this.shop.getOwner();return this._fetchCompanyFromRef(e)},_fetchCompanyUbos:function(e){return this.companyUbos=this.companyUboFactory.createCollection(c.Types.COMPANY_COMPANY_UBO,this.company.getUboPersons()),this.companyUbos.setParentResourceId(this.company.id),this.companyUbos},_fetchPsp:function(t){this.psp=this.pspFactory.createModel(d.Types.SHOP_PSP);const n=e.is(t,"string")?t:this.shop.id;return this.psp.setParentResourceId(n),this.psp.fetchPromise()},_buildKycPage:function(){return new n({mpEventTopic:this.mpEventTopic,company:this.company,companyAddresses:this.companyAddresses,kycDocuments:this.kycDocuments,bankAccount:this.bankAccount,bankAccountConstraints:this.bankAccountConstraints,companyUbos:this.companyUbos,companyUboFactory:this.companyUboFactory,kycDocumentFactory:this.kycDocumentFactory,uboDocumentFactory:this.uboDocumentFactory,addressFactory:this.addressFactory,countries:this.countries,shop:this.shop,isDSOperator:this.me.isDSOperator(),psp:this.psp,companyIndustries:this.companyIndustries})}})});