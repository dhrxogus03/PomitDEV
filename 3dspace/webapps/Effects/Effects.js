define("DS/Effects/SaveAsHDR",[],function(){"use strict";return{writeHDRHeader:function(e,s){var t=function(e,s,t){for(var i=0;i<s.length;i++)e[t++]=s.charCodeAt(i);return t},i="# Made with Dassault Systemes HDR mipmap roughness generator - TZW",r="-Y "+s+" +X "+e,a=new Uint8Array("#?RADIANCE".length+1+i.length+1+"FORMAT=32-bit_rle_rgbe".length+2+r.length+1+e*s*4),n=0;return n=t(a,"#?RADIANCE",n),a[n++]=10,n=t(a,i,n),a[n++]=10,n=t(a,"FORMAT=32-bit_rle_rgbe",n),a[n++]=10,a[n++]=10,n=t(a,r,n),a[n++]=10,{buffer:a,offset:n,width:e,height:s}},writeTexture:function(e,s,t,i){for(var r=4*s.width*i,a=4*t,n=e.height-1,o=0;o<e.height;o++){for(var h=e.width-1,l=0;l<e.width;l++){for(var p=0;p<4;p++)s.buffer[s.offset+r+a+4*l+p]=255*e.buffer[4*(e.width*n+h)+p];h--}r+=4*s.width,n--}},compressHDR:function(e){for(var s=function(e){for(var s=new Uint8Array(2*e.length),t=0;t<e.length;t++)s[t]=e[t];return s},t=e.offset,i=t,r=new Uint8Array(e.buffer.length),a=0;a<t;a++)r[a]=e.buffer[a];for(var n=new Uint8Array(4+5*e.width),o=0;o<e.height;o++){var h=0;n[h++]=2,n[h++]=2,n[h++]=e.width>>8,n[h++]=255&e.width;for(var l=0;l<4;l++){var p=[];for(a=0;a<e.width;){for(var c=0,m=e.buffer[t+4*(o*e.width+a)+l],d=m;a<e.width&&d===m&&c<127;)c++,a++,m=d,d=e.buffer[t+4*(o*e.width+a)+l];if(c>3){if(p.length){n[h++]=p.length;for(var u=0;u<p.length;u++)n[h++]=p[u];p=[]}n[h++]=128+c,n[h++]=m}else{if(p.length+c>127){n[h++]=p.length;for(u=0;u<p.length;u++)n[h++]=p[u];p=[]}p.push(m),c>1&&p.push(m),c>2&&p.push(m)}}if(p.length){n[h++]=p.length;for(u=0;u<p.length;u++)n[h++]=p[u]}}i+h>=r.length&&(r=s(r));for(var f=0;f<h;f++)r[i++]=n[f]}var g=new Uint8Array(i);for(a=0;a<i;a++)g[a]=r[a];e.buffer=g}}}),define("DS/Effects/PreHighlightMobileNonEffect",["DS/Visualization/ThreeJS_DS","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,s,t,i){"use strict";return class{constructor(e){this.preHighlightSinglePass=null,this.Canvas2DpreHighlightSinglePass=null,this.renderer=e,this.enabled=!0,this._initPasses()}_initPasses(){var t=this.renderer.mainComposer;this.preHighlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"preHighlightSinglePass"),this.preHighlightSinglePass.setRenderPluginsPre(!1),this.preHighlightSinglePass.setRenderPluginsPost(!1),this.preHighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.preHighlightSinglePass.setDisableBackFaceCulling(!0),this.preHighlightSinglePass.setDisableDepthTest(!0),this.preHighlightSinglePass.setDisableDepthWrite(!0),this.preHighlightSinglePass.lockScene=!0,t.addPass(this.preHighlightSinglePass),this.Canvas2DpreHighlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"Canvas2DpreHighlightSinglePass"),this.Canvas2DpreHighlightSinglePass.setRenderPluginsPre(!1),this.Canvas2DpreHighlightSinglePass.setRenderPluginsPost(!1),this.Canvas2DpreHighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.Canvas2DpreHighlightSinglePass.setDisableBackFaceCulling(!0),this.Canvas2DpreHighlightSinglePass.setDisableDepthTest(!0),this.Canvas2DpreHighlightSinglePass.setDisableDepthWrite(!0),this.Canvas2DpreHighlightSinglePass.lockScene=!0,this.Canvas2DpreHighlightSinglePass.idString="canvas2D",t.addPass(this.Canvas2DpreHighlightSinglePass)}setEnabled(e){this.enabled&&e||(this.enabled||e)&&(this.renderer.__enablePassOnAllComposerContexts(this.preHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DpreHighlightSinglePass,!1),this.renderer.compForwardComposerContext&&(this.renderer.compForwardComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e)),this.renderer.auxiliaryViewpointComposerContext&&(this.renderer.auxiliaryViewpointComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.auxiliaryViewpointComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e)))}disableOnComposer(e){e.enablePass(this.preHighlightSinglePass,!1),e.enablePass(this.Canvas2DpreHighlightSinglePass,!1)}_sortScenes(e){this._scenesToRender=[],e.selectionPreHL.enabled&&this._scenesToRender.push(e.selectionPreHL.sceneHL);var s=this;this.preHighlightSinglePass.setMultiRenderCB(function(e,t){return t<s._scenesToRender.length&&(e.scene=s._scenesToRender[t],!0)}),this.Canvas2DpreHighlightSinglePass.setMultiRenderCB(function(e,t){return t<s._scenesToRender.length&&(e.scene=s._scenesToRender[t],!0)})}_setRenderModes(){var e=this.renderer.renderer,[s,t,i]=e.getRenderMode().getMasks();this.preHighlightSinglePass.renderFaceMode=s,this.preHighlightSinglePass.renderLineMode=t,this.preHighlightSinglePass.renderPointMode=i,this.Canvas2DpreHighlightSinglePass.renderFaceMode=s,this.Canvas2DpreHighlightSinglePass.renderLineMode=t,this.Canvas2DpreHighlightSinglePass.renderPointMode=i}_updateScene(e){this.preHighlightSinglePass.scene=e.selectionPreHL.sceneHL,this.Canvas2DpreHighlightSinglePass.scene=e.selectionPreHL.sceneHL}_checkPolite(e){var s=this.renderer.renderer,t=e.selectionPreHL.sceneHL;t.highlightData._needsDepth&&t.getNbAllWebGLObjects()+t.__objectsAdded.size>0&&s.requestPoliteDepthBuffer()}update(e){e.selectionPreHL._updateScene(e.scene),this._sortScenes(e),this._setRenderModes(),this._updateScene(e),this._checkPolite(e)}}}),define("DS/Effects/HighlightMobileNonEffect",["DS/Visualization/ThreeJS_DS","DS/Plugins/RenderPass","DS/Plugins/ClearPass","DS/Visualization/PickingMode"],function(e,s,t,i){"use strict";return class{constructor(e){this.highlightSinglePass=null,this.Canvas2DhighlightSinglePass=null,this.scenes=[],this._scenesToRender=[],this.renderer=e,this.enabled=!0,this._initPasses()}_initPasses(){var i=this.renderer.mainComposer;this.highlightClearPass=new t("highlightClearPass"),i.addPass(this.highlightClearPass),this.highlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"highlightSinglePass"),this.highlightSinglePass.setRenderPluginsPre(!1),this.highlightSinglePass.setRenderPluginsPost(!1),this.highlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.highlightSinglePass.setDisableBackFaceCulling(!0),this.highlightSinglePass.setDisableDepthTest(!0),this.highlightSinglePass.setDisableDepthWrite(!0),this.highlightSinglePass.lockScene=!0,i.addPass(this.highlightSinglePass),this.Canvas2DhighlightClearPass=new t("Canvas2DhighlightClearPass"),i.addPass(this.Canvas2DhighlightClearPass),this.Canvas2DhighlightSinglePass=new s(null,null,null,void 0,void 0,void 0,"Canvas2DhighlightSinglePass"),this.Canvas2DhighlightSinglePass.setRenderPluginsPre(!1),this.Canvas2DhighlightSinglePass.setRenderPluginsPost(!1),this.Canvas2DhighlightSinglePass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.Canvas2DhighlightSinglePass.setDisableBackFaceCulling(!0),this.Canvas2DhighlightSinglePass.setDisableDepthTest(!0),this.Canvas2DhighlightSinglePass.setDisableDepthWrite(!0),this.Canvas2DhighlightSinglePass.idString="canvas2D",this.Canvas2DhighlightSinglePass.lockScene=!0,i.addPass(this.Canvas2DhighlightSinglePass)}setEnabled(e){this.enabled&&e||(this.enabled||e)&&(this.renderer.__enablePassOnAllComposerContexts(this.preHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DpreHighlightSinglePass,!1),this.renderer.__enablePassOnAllComposerContexts(this.Canvas2DhighlightClearPass,!1),this.renderer.__enablePassOnAllComposerContexts(this.highlightClearPass,!1),this.renderer.compForwardComposerContext&&(this.renderer.compForwardComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e),this.renderer.compForwardComposerContext.enablePass(this.Canvas2DhighlightClearPass,e),this.renderer.compForwardComposerContext.enablePass(this.highlightClearPass,e)),this.renderer.auxiliaryViewpointComposerContext&&(this.renderer.auxiliaryViewpointComposerContext.enablePass(this.preHighlightSinglePass,e),this.renderer.auxiliaryViewpointComposerContext.enablePass(this.Canvas2DpreHighlightSinglePass,e),this.renderer.auxiliaryViewpointComposerContext.enablePass(this.Canvas2DhighlightClearPass,e),this.renderer.auxiliaryViewpointComposerContext.enablePass(this.highlightClearPass,e)))}hide(e){if(this.enabled){var s=this.renderer;s.compForwardComposerContext.enablePass(this.highlightSinglePass,!e),s.compForwardComposerContext.enablePass(this.Canvas2DhighlightSinglePass,!e),s.auxiliaryViewpointComposerContext&&(s.auxiliaryViewpointComposerContext.enablePass(this.highlightSinglePass,!e),s.auxiliaryViewpointComposerContext.enablePass(this.Canvas2DhighlightSinglePass,!e))}}disableOnComposer(e){e.enablePass(this.highlightClearPass,!1),e.enablePass(this.highlightSinglePass,!1),e.enablePass(this.Canvas2DhighlightClearPass,!1),e.enablePass(this.Canvas2DhighlightSinglePass,!1)}_sortScenes(e){this._scenesToRender=[],e.selectionHL.enabled&&this._scenesToRender.push(e.selectionHL.sceneHL);for(var s=0;s<this.scenes.length;s++){var t=this.scenes[s];t.enabled&&this._scenesToRender.push(t.sceneHL)}var i=this._scenesToRender.length;this._scenesToRender.sort(function(e,s){return e.highlightData.priority-s.highlightData.priority});var r=this;this.highlightSinglePass.setMultiRenderCB(function(e,s){return s<r._scenesToRender.length&&(e.scene=r._scenesToRender[s],!0)}),this.Canvas2DhighlightSinglePass.setMultiRenderCB(function(e,s){return s<r._scenesToRender.length&&(e.scene=r._scenesToRender[s],!0)}),this.highlightSinglePass.stateSortingResults.nbScenes()>i&&this.highlightSinglePass.stateSortingResults.cleanCache(),this.Canvas2DhighlightSinglePass.stateSortingResults.nbScenes()>i&&this.Canvas2DhighlightSinglePass.stateSortingResults.cleanCache()}_setRenderModes(){var e=this.renderer.renderer,[s,t,i]=e.getRenderMode().getMasks();this.highlightSinglePass.renderFaceMode=s,this.highlightSinglePass.renderLineMode=t,this.highlightSinglePass.renderPointMode=i,this.Canvas2DhighlightSinglePass.renderFaceMode=s,this.Canvas2DhighlightSinglePass.renderLineMode=t,this.Canvas2DhighlightSinglePass.renderPointMode=i}_updateScene(s){var t=this.renderer;t.renderer,t.compForwardComposerContext.setPassClear(this.highlightClearPass,!1,new e.Color(0),0),t.compForwardComposerContext.setPassClearDepth(this.highlightClearPass,!0),this.highlightSinglePass.scene=s.selectionHL.sceneHL,t.compForwardComposerContext.setPassClear(this.Canvas2DhighlightClearPass,!1,new e.Color(0),0),t.compForwardComposerContext.setPassClearDepth(this.Canvas2DhighlightClearPass,!0),this.Canvas2DhighlightSinglePass.scene=s.selectionHL.sceneHL,this.auxiliaryViewpointComposerContext&&(t.auxiliaryViewpointComposerContext.setPassClear(this.highlightClearPass,!1,new e.Color(0),0),t.auxiliaryViewpointComposerContext.setPassClearDepth(this.highlightClearPass,!0),t.auxiliaryViewpointComposerContext.setPassClear(this.Canvas2DhighlightClearPass,!1,new e.Color(0),0),t.auxiliaryViewpointComposerContext.setPassClearDepth(this.Canvas2DhighlightClearPass,!0))}_checkPolite(e){var s=this.renderer.renderer,t=e.selectionHL.sceneHL,i=t.highlightData;if(i._needsDepth&&t.getNbAllWebGLObjects()+t.__objectsAdded.size>0&&s.requestPoliteDepthBuffer(),this.scenes&&!s._politeDBufferNextFrame)for(var r=0;r<this.scenes.length;r++)(i=(t=this.scenes[r].sceneHL).highlightData)._needsDepth&&t.getNbAllWebGLObjects()+t.__objectsAdded.size>0&&s.requestPoliteDepthBuffer()}update(e){e.selectionHL._updateScene(e.scene);for(var s=0;s<this.scenes.length;s++)this.scenes[s]._updateScene(e.scene);this._sortScenes(e),this._setRenderModes(),this._updateScene(e),this._checkPolite(e)}addScene(e){return this.scenes.push(e),!0}removeScene(e){for(var s=e.highlightData,t=0;t<this.scenes.length;t++)if(this.scenes[t].highlightData.isEqual(s))return this.scenes.splice(t,1),!0;return!1}}}),define("DS/Effects/BasicEffect",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,s){"use strict";return e.extend({init:function(e){return this.enabled=!0,this._enabledInternal=!0,this.composers=[],this.mixPass=null,this.width=2,this.height=2,this.renderer=e,this},initEffect:function(e,s){},update:function(e,s,t){},setSize:function(e,s){return(this.width!==e||this.height!==s)&&(this.width=Math.max(2,e),this.height=Math.max(2,s),!0)},updateComposersName:function(e){var s;for(s=0;s<this.composers.length;s++)this.composers[s].composerContext.name||(this.composers[s].composerContext.name=e+"#"+s)},_setEnabledInternal(e){this._enabledInternal=e,this._setEnabledComposers(this.enabled&&this._enabledInternal)},setEnabled:function(e){this.enabled=e,this._setEnabledComposers(this.enabled&&this._enabledInternal)},_setEnabledComposers:function(e){for(var s=0;s<this.composers.length;s++)this.composers[s].enabled=e;if(null!==this.mixPass){var t=this.mixPass.composer;t&&t.contexts.length&&t.contexts[0].enablePass(this.mixPass,e)}},getMaxIteration:function(){return 0},dispose:function(){var e;for(e=0;e<this.composers.length;e++)this.composers[e].composerContext&&this.composers[e].composerContext.dispose(),this.composers[e].dispose()}})}),define("Effects/BasicEffect",["DS/Effects/BasicEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/BasicEffect"),e}),define("DS/Effects/ExtractLightFromIBL",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/ConvertShaderBuilders"],function(e,s,t,i,r){"use strict";var a=function(e,s,t){for(var i=new Float32Array(e*s),r=function(e,t){return e<0||t<0?0:i[e*s+t]},a=0;a<e;a++)for(var n=0;n<s;n++){var o=s*a+n,h=t[4*o+3];i[o]=h+r(a-1,n)+r(a,n-1)-r(a-1,n-1)}this.sum=function(e,s,t,i,a,n,o,h){return r(a,n)+r(e,s)-r(t,i)-r(o,h)}},n=function(e,s,t){if(e.width<2||e.height<2||0==s){if(0==e.width||0==e.height)return;t.push(e)}else{var i=new o,r=new o;e.width>e.height?e.split2V(i,r):e.split2H(i,r),n(i,s-1,t),n(r,s-1,t)}},o=function(){};return o.prototype.set=function(e,s,t,i,r,a){this.yStart=s,this.xStart=e,this.width=t,this.height=i,this.summedATable=r,this.sum=a>-1?a:r.sum(e,s,e+(t-1),s,e+(t-1),s+(i-1),e,s+(i-1))},o.prototype.splitV=function(e){for(var s=1;s<=this.width&&(e.set(this.xStart,this.yStart,s,this.height,this.summedATable,-1),!(2*e.sum>=this.sum));++s);},o.prototype.split2V=function(e,s){this.splitV(e),s.set(this.xStart+(e.width-1),this.yStart,this.width-e.width,this.height,this.summedATable,this.sum-e.sum)},o.prototype.splitH=function(e){for(var s=1;s<=this.height&&(e.set(this.xStart,this.yStart,this.width,s,this.summedATable,-1),!(2*e.sum>=this.sum));++s);},o.prototype.split2H=function(e,s){this.splitH(e),s.set(this.xStart,this.yStart+(e.height-1),this.width,this.height-e.height,this.summedATable,this.sum-e.sum)},o.prototype.getCentroid=function(s,t){var i=new o;this.splitV(i);var r=i.xStart+(i.width-1);this.splitH(i);var a=i.yStart+(i.height-1),n=2*(r/s-.5)*Math.PI,h=-(a/t-1)*Math.PI;return new e.Vector3(Math.cos(h)*Math.sin(n),Math.sin(h)*Math.sin(n),Math.cos(n))},s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.texture=null,this.passIntensity=null,this},setEnvMap:function(s){this.texture=s;var a=s.composerContext&&s.composerContext.width,n=s.composerContext&&s.composerContext.height;if(s instanceof e.Texture?(a=s.image.width,n=s.image.height):s instanceof e.WebGLRenderTarget&&(a=s.width,n=s.height),this.width=parseInt(a),this.height=parseInt(n),this.composers.length)this.composers[0].setSize(this.width,this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"halfLinear");o.generateMipmaps=!1,this.composers[0]=new t(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0,this.passIntensity=new i(r.ToRGBLuminance,"IBL Intensity"),this.texture instanceof t||this.texture.rgbHdr||(this.passIntensity.material.defines.RGBE_INPUT=1),this.composers[0].addPass(this.passIntensity)}this.texture instanceof e.Texture||this.texture instanceof e.WebGLRenderTarget?this.passIntensity.setLinkedInput(this.texture):this.texture.linkToShaderPassUniform(this.passIntensity,this.passIntensity.getInput()),this.passIntensity.material.setUniform("size",new e.Vector2(this.width,this.height))},execute:function(s){if(s||!this.renderer.supportsFloatTextures()&&!this.renderer.supportsHalfFloatTextures())return(u=new e.DirectionalIBLLight(new e.Color,0)).castShadow=!1,{light:u,dirLight:new e.Vector3(1,1,1)};this.composers[0].render();var t=new Float32Array(4*this.width*this.height);this.gl.readPixels(0,0,this.width,this.height,this.gl.RGBA,this.gl.FLOAT,t);for(var i=0,r=1e20,h=0;h<this.width;h++)for(var l=0;l<this.height;l++){var p=t[4*(this.height*h+l)+3];p>i&&(i=p,h,l),p<r&&(r=p)}if(0===i||1e20===r||(i-r)/i<.025)return(u=new e.DirectionalIBLLight(new e.Color,0)).castShadow=!1,{light:u,dirLight:new e.Vector3(1,1,1)};var c=new a(this.width,this.height,t),m=new o;m.set(0,0,this.width,this.height,c,-1);var d=[];n(m,9,d),d.sort(function(e,s){return e.sum<s.sum?1:-1});var u,f=d[0].getCentroid(this.width,this.height);return(u=new e.DirectionalIBLLight(new e.Color(16777215),1)).shadowMapWidth=2048,u.shadowMapHeight=2048,{light:u,dirLight:f}}})}),define("DS/Effects/ComputeSDFFontMergeTiles",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders","DS/ShaderBuilders/PostPro/SDFFontIterativeShaderBuilders"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(s,t){return this._parent(s),this.renderer=s,this.rtPool=t,this.width=512,this.height=512,this.tileMin=new e.Vector2,this.tileMax=new e.Vector2,this.realTileMax=new e.Vector2,this.map=null,this.passMergeTile=null,this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setTileInfos:function(e,s,t,i,r,a){this.tileMin.set(e/this.width,s/this.height),this.tileMax.set((e+t)/this.width,(s+i)/this.height),this.realTileMax.set((e+r)/this.width,(s+a)/this.height),this.passMergeTile&&(this.passMergeTile.material.setUniform("tileMin",this.tileMin),this.passMergeTile.material.setUniform("tileMax",this.tileMax),this.passMergeTile.material.setUniform("realTileMax",this.realTileMax))},setInput:function(s){if(s){if(this.map=s,this.composers[0])this.composers[0].setSize(this.width,this.height);else{var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new t(this.renderer,n,this.rtPool),this.composers[0].composerContext.keepResult=!0,this.passMergeTile=new i(a.SDFFontMergeTiles),this.passMergeTile.renderToScreen=!1;var o=new i(r.CopyBlend);this.composers[0].addPass(this.passMergeTile),this.composers[0].addPass(o)}this.map.linkToShaderPassUniform(this.passMergeTile,this.passMergeTile.getInput())}},execute:function(){this.composers[0].render()}})}),define("DS/Effects/AutoPerformanceSuiteEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders","DS/ShaderBuilders/PostPro/GraphicsOptimizerShaderBuilders","DS/QualityManager/QMScoreHandler"],function(e,s,t,i,r,a,n){"use strict";const o={TEXTURE:0,PIXEL:1};var h=s.extend({init:function(s,t,a){this._parent(s),this.renderTargetPool=t,this.done=!1,this.firstRun=0,this.run=0,this.previousFrameTime=0,this.frameTime=0,this.mode=a,this.mixPass=new i(r.CopyBlend,a===o.TEXTURE?"TexturePerformance":"PixelShaderPerformance"),this.mixPass.compileShader(s),this.passes=[];var h=this;let l=new Uint8Array(4),p=!1;if(this.mixPass.beforeRenderCB=function(e){p=h.firstRun<n.heatFrames/2;for(var s=0;s<h.passes.length;s++)h.passes[s].material.setUniform("empty",p?1:0);n.useNonBlockingGO||(h.previousFrameTime=performance.now())},this.mixPass.afterRenderCB=function(e){if(!n.useNonBlockingGO){const e=h.renderer.gl;p||e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,l),h.addFrame(performance.now())}},this.textureSize=1024,this.texturesToFetch=[],this.mode===o.TEXTURE)for(var c=0;c<8;c++){for(var m=new Uint8Array(this.textureSize*this.textureSize*4),d=0;d<this.textureSize*this.textureSize*4;d++)m[d]=255*Math.random();this.texturesToFetch.push(new e.DataTexture(m,this.textureSize,this.textureSize,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.RepeatWrapping,e.RepeatWrapping,e.LinearFilter,e.LinearFilter))}return this.pixelSize=null,this},resetScore:function(){this.frameTime=0,this.previousFrameTime=0,this.run=0,this.done=!1,this.firstRun=0},addFrame:function(e=0){var s=e||Date.now();if(n._setGOFrame(this.firstRun+this.run),this.firstRun<n.heatFrames)return this.firstRun++,void(this.previousFrameTime=s);if(this.previousFrameTime>0){this.run++;var t=s-this.previousFrameTime;console.log(t),this.frameTime+=t}this.previousFrameTime=s,this.frameTime>n.GODuration&&(console.log("bench too slow "+this.run),this.done=!0)},getScore:function(){if(0===this.frameTime)return 0;console.log("Total time: "+this.frameTime),console.log("Total frame: "+this.run);var e=this.frameTime/this.run;console.log("Average: "+e);for(var s=Math.log(1+e/(1e3/60))/Math.log(2),t=0;t<this.texturesToFetch.length;t++)this.texturesToFetch[t].dispose();return Math.min(Math.max(Math.floor(1e3/s)/10,0),100)},initEffect:function(s,r){if(r.insertComposer(this.composers[0],this.mixPass),this.passes.length)return;const h=n.GOWidth,l=n.GOHeight;var p=new e.WebGLRenderTargetProperties(h,l,"uint");if(p.generateMipmaps=!1,this.mode===o.TEXTURE)for(var c=0;c<a.Textures.length;c++){(d=new t(this.renderer,p,this.renderTargetPool)).composerContext.keepResult=!0,this.composers.push(d),this.mixPass.addRequiredComposer(d);var m=new i(a.Textures[c]);this.passes.push(m);for(c=0;c<8;c++)m.setLinkedInput(this.texturesToFetch[c],c);m.material.setUniform("texelSize",new e.Vector2(1/this.textureSize,1/this.textureSize)),m.disabledByDefault=!0,d.addPass(m),d.enablePass(m,!0)}else for(c=0;c<a.Pixels.length;c++){var d;(d=new t(this.renderer,p,this.renderTargetPool)).composerContext.keepResult=!0,this.composers.push(d),this.mixPass.addRequiredComposer(d);var u=new i(a.Pixels[c]);this.passes.push(u),u.disabledByDefault=!0,d.addPass(u),d.enablePass(u,!0)}}});return h.MODE=o,h}),define("DS/Effects/BloomsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BloomShaderBuilders","DS/ShaderBuilders/PostPro/ImageOperationShaderBuilders","DS/ShaderBuilders/PostPro/BlurShaderBuilders"],function(e,s,t,i,r,a,n){"use strict";return s.extend({init:function(s,t,a){this._parent(s),this.renderer=s,this.rtPool=t,this._initBloom=0,this.useOldBloom=!!a,this.nbIterations=a?5:4,this.nbBlurs=2,this.nbBlurSamples=6,this.bloomFactor=a?.9:.4,this.threshold=a?.626:.9,this.kernels=[],this.kernels[0]=[.02275,.9545,.02275],this.kernels[1]=[.00135,.157305,.68269,.157305,.00135],this.kernels[2]=[428e-6,.022321,.229743,.495016,.229743,.022321,428e-6],this.kernels[3]=[229e-6,.005977,.060598,.241732,.382928,.241732,.060598,.005977,229e-6],this.kernels[4]=[154e-6,.002396,.020195,.092321,.229511,.310847,.229511,.092321,.020195,.002396,154e-6],this.kernels[5]=[116e-6,.001227,.008466,.037976,.110867,.210789,.261121,.210789,.110867,.037976,.008466,.001227,116e-6],this.kernels[6]=[93e-6,735e-6,.004228,.017686,.053815,.119121,.191869,.224907,.191869,.119121,.053815,.017686,.004228,735e-6,93e-6],this.kernels[7]=[78e-6,489e-6,.002403,.009245,.027835,.065592,.12098,.17467,.197417,.17467,.12098,.065592,.027835,.009245,.002403,489e-6,78e-6],this.kernels[8]=[67e-6,35e-5,.001504,.005321,.015497,.037158,.073355,.119235,.159582,.175863,.159582,.119235,.073355,.037158,.015497,.005321,.001504,35e-5,67e-6],this.mixPass=new i(r.Mix,"bloomPass"),this.mixPass.material.blending=e.NoBlending,this.mixPass.gammaCorrectionPass=!0,this.passBlurH=null,this.passBlurV=null,this.passDownScale=null,this.passUpScale=null,this.finalBloomPass=null,this.passThreshold=null,this.sharedRTParams=[],this.sharedRT=[];var n=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear");return this.mixPass.changeRenderTargetProperties=n,this.defines={USE_BLOOM:1},this.mixPass.material.defines=this.defines,this._buildBloomRT(),this.updateRequiredComposers(),this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold),this},initEffect:function(e,s){s.insertComposer(null,this.mixPass)},update:function(e,s,t){},updateRequiredComposers:function(){this.mixPass.requiredComposers=[],this.useOldBloom?this.mixPass.addRequiredComposer(this.composers[5]):this.mixPass.addRequiredComposer(this.composers[2*this.nbIterations])},setBeforeRenderCallback:function(){var e,s=this;e=function(e){s.passThreshold.setLinkedInput(e)},this.mixPass.beforeRenderCB=e},setOldBloomUse:function(e){this.useOldBloom!=e&&(this.useOldBloom=e,this.nbIterations=this.useOldBloom?5:4,this.bloomFactor=this.useOldBloom?.9:.4,this.threshold=this.useOldBloom?.626:.9,this.defines.USE_BLOOM=this.useOldBloom?2:1,this.mixPass.material.defines=this.defines,this.mixPass.material.needsUpdate=!0,this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold),this._buildBloomRT(),this.updateRequiredComposers())},_setBloom:function(e){var s=e.nbIterations?e.nbIterations:4;this.nbIterations!=s&&(this.nbIterations=s,this._initBloom&&(this._initBloom=0,this._buildBloomRT(),this.updateRequiredComposers())),this.bloomFactor=e.bloomFactor?e.bloomFactor:.4,this.threshold=e.threshold?e.threshold:.9,this.setBloomFactor(this.bloomFactor),this.setBloomThreshold(this.threshold)},setBloomFactor:function(e){this.bloomFactor=e,this.useOldBloom?this.mixPass.material.setUniform("bloomFactor",e):this.mixPass.material.setUniform("bloomFactor",this.bloomFactor/(this.nbIterations+1))},setBloomThreshold:function(e){this.useOldBloom&&(e=Math.min(e,1)),this.passThreshold&&this.passThreshold.material.setUniform("threshold",e),this.threshold=e},setSize:function(s,t,i){if(this._parent(s,t)){var r,a=.5,n=Math.max(1,a*this.width),o=Math.max(1,a*this.height);if(this.useOldBloom)for(this.composers[0].setSize(n,o,i),r=1;r<=this.nbIterations;r++){this.composers[r].setSize(n,o,i);var h=new e.Vector2(1/n,1/o);this.passBlurH[r].material.setUniform("invSize",h),this.passBlurV[r].material.setUniform("invSize",h),a*=.5,n=Math.max(1,a*this.width),o=Math.max(1,a*this.height)}else for(this.composers[0].setSize(this.width,this.height,i),this.composers[2*this.nbIterations].setSize(this.width,this.height,i),this.passThreshold.material.setUniform("invSize",new e.Vector2(1/this.width,1/this.height)),this.finalBloomPass.material.setUniform("invSize",new e.Vector2(1/n,1/o)),r=1;r<=this.nbIterations;r++){if(r!=this.nbIterations){var l=this.sharedRTParams[r-1];l.width=n,l.height=o}else this.composers[r].setSize(n,o,i);if(this.passDownScale[r-1].material.setUniform("invSize",new e.Vector2(1/(2*n),1/(2*o))),a*=.5,n=Math.max(1,a*this.width),o=Math.max(1,a*this.height),r!=this.nbIterations&&this.passUpScale[this.nbIterations-r-1].material.setUniform("invSize",new e.Vector2(1/n,1/o)),r==this.nbIterations)for(var p=0;p<this.nbBlurs;p++)this.passBlurH[p].material.setUniform("ratio",this.width>this.height?this.height/this.width:1),this.passBlurV[p].material.setUniform("ratio",this.width>this.height?1:this.width/this.height)}}},_buildBloomRT:function(s){if(!(this._initBloom>0&&(2==this._initBloom&&this.useOldBloom||1==this._initBloom&&!this.useOldBloom))){if(this._initBloom=this.useOldBloom?2:1,this.useOldBloom){var r=.5;this.passBlurH=[],this.passBlurV=[];var o=Math.max(1,r*this.width),h=Math.max(1,r*this.height),l=new e.WebGLRenderTargetProperties(o,h,"uint");this.composers[0]=new t(this.renderer,l,this.rtPool),this.composers[0].composerContext.name="ThresholdComposerContext",this.passThreshold=new i(a.Threshold,"Threshold"),this.passThreshold.material.setUniform("threshold",this.threshold),this.passThreshold.material.defines.FIREFLY=0,this.composers[0].addPass(this.passThreshold);for(var p=1;p<=this.nbIterations;p++){l=new e.WebGLRenderTargetProperties(o,r*this.height,"uint");this.composers[p]=new t(this.renderer,l,this.rtPool),this.composers[p].composerContext.name="Blur"+p+"ComposerContext",this.passBlurH[p]=new i(n.BlurH,"BlurH"+p),this.passBlurV[p]=new i(n.BlurV,"BlurV"+p),this.passBlurH[p].material.defines.LEVEL=p,this.passBlurV[p].material.defines.LEVEL=p;var c=new e.Vector2(1/o,1/h);this.passBlurH[p].material.setUniform("invSize",c),this.passBlurV[p].material.setUniform("invSize",c),this.passBlurH[p].material.needsUpdate=!0,this.passBlurV[p].material.needsUpdate=!0,this.composers[p].addPass(this.passBlurH[p]),this.composers[p].addPass(this.passBlurV[p]),r*=.5,o=Math.max(1,r*this.width),h=Math.max(1,r*this.height)}this.passBlurH[1].addRequiredComposer(this.composers[0]),this.passBlurH[2].addRequiredComposer(this.composers[1]),this.passBlurH[3].addRequiredComposer(this.composers[2]),this.passBlurH[4].addRequiredComposer(this.composers[3]),this.passBlurH[5].addRequiredComposer(this.composers[4]),this.composers[0].linkToShaderPassUniform(this.passBlurH[1],this.passBlurH[1].getInput()),this.composers[1].linkToShaderPassUniform(this.passBlurH[2],this.passBlurH[2].getInput()),this.composers[2].linkToShaderPassUniform(this.passBlurH[3],this.passBlurH[3].getInput()),this.composers[3].linkToShaderPassUniform(this.passBlurH[4],this.passBlurH[4].getInput()),this.composers[4].linkToShaderPassUniform(this.passBlurH[5],this.passBlurH[5].getInput()),this.composers[1].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.composers[2].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(2)),this.composers[3].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(3)),this.composers[4].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(4)),this.composers[5].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(5))}else{r=.5,o=Math.max(1,r*this.width),h=Math.max(1,r*this.height);var m=2*this.nbIterations;this.passDownScale=[],this.passBlurH=[],this.passBlurV=[],this.passUpScale=[];l=new e.WebGLRenderTargetProperties(this.width,this.height,"halfLinear");this.composers[0]=new t(this.renderer,l,this.rtPool),this.composers[0].composerContext.name="ThresholdComposerContext",this.passThreshold=new i(a.Threshold,"Threshold"),this.passThreshold.material.setUniform("threshold",this.threshold),this.passThreshold.material.setUniform("invSize",new e.Vector2(1/this.width,1/this.height)),this.passThreshold.material.defines.FIREFLY=1,this.composers[0].addPass(this.passThreshold),this.composers[m]=new t(this.renderer,l,this.rtPool),this.composers[m].composerContext.name="UpReplaceComposerContext",this.finalBloomPass=new i(a.Up,"UpReplace"),this.finalBloomPass.material.setUniform("invSize",new e.Vector2(1/o,1/h)),this.composers[m].addPass(this.finalBloomPass);var d=function(e,s,t){e.composers[s].composerContext.setBeforeRenderCB(function(e){e.writeBuffer=x.sharedRT[t]})},u=function(e,s,t){e.composers[s].composerContext.setBeforeRenderCB(function(s){var i=e.sharedRTParams[t];e.sharedRT[t]=e.rtPool.buildRenderTarget(i.width,i.height,i.options),s.writeBuffer=x.sharedRT[t]})};for(p=1;p<=this.nbIterations;p++){var f=p,g=p-1,S=m-p,P=this.nbIterations-p-1;this.passDownScale[g]=new i(a.Down,"Downscale"+g),this.passDownScale[g].material.setUniform("invSize",new e.Vector2(1/(2*o),1/(2*h)));l=new e.WebGLRenderTargetProperties(o,h,"halfLinear");this.sharedRTParams[g]=l,this.composers[f]=new t(this.renderer,l,this.rtPool),this.composers[f].composerContext.name="Downscale"+g+"ComposerContext";var x=this;if(f!=this.nbIterations&&(this.composers[f].composerContext.renderTargetProperties=null,this.composers[f].composerContext.originalRenderTargetProperties=null,d(this,f,g)),this.composers[f].addPass(this.passDownScale[g]),f==this.nbIterations)for(var C=0;C<this.nbBlurs;C++)this.passBlurH[C]=new i(n.Blur,"BlurH"+C),this.passBlurV[C]=new i(n.Blur,"BlurV"+C),this.passBlurH[C].material.defines.LEVEL=this.nbBlurSamples-1,this.passBlurV[C].material.defines.LEVEL=this.nbBlurSamples-1,this.passBlurH[C].material.setUniform("ratio",this.width>this.height?this.height/this.width:1),this.passBlurV[C].material.setUniform("ratio",this.width>this.height?1:this.width/this.height),this.passBlurH[C].material.setUniform("blurSize",.1),this.passBlurV[C].material.setUniform("blurSize",.1),this.passBlurH[C].material.setUniform("direction",new e.Vector2(1,0)),this.passBlurV[C].material.setUniform("direction",new e.Vector2(0,1)),this.passBlurH[C].material.setUniform("kernel",this.kernels[this.nbBlurSamples-2]),this.passBlurV[C].material.setUniform("kernel",this.kernels[this.nbBlurSamples-2]),this.passBlurH[C].material.needsUpdate=!0,this.passBlurV[C].material.needsUpdate=!0,this.composers[f].addPass(this.passBlurH[C]),this.composers[f].addPass(this.passBlurV[C]);else r*=.5,o=Math.max(1,r*this.width),h=Math.max(1,r*this.height),this.passUpScale[P]=new i(a.Up,"UpReplace"+P),this.passUpScale[P].material.blending=e.CustomBlending,this.passUpScale[P].material.blendEquation=e.AddEquation,this.passUpScale[P].material.blendSrc=e.OneFactor,this.passUpScale[P].material.blendDst=e.OneFactor,this.passUpScale[P].material.useBlending=!0,this.passUpScale[P].material.setUniform("invSize",new e.Vector2(1/o,1/h)),this.composers[S]=new t(this.renderer,l,this.rtPool),this.composers[S].composerContext.renderTargetProperties=null,this.composers[S].composerContext.originalRenderTargetProperties=null,this.composers[S].composerContext.name="UpReplace"+P+"ComposerContext",u(this,S,g),this.composers[S].addPass(this.passUpScale[P]);this.passDownScale[g].addRequiredComposer(this.composers[f-1]),this.composers[f-1].linkToShaderPassUniform(this.passDownScale[g],this.passDownScale[g].getInput())}for(p=1;p<this.nbIterations;p++){S=m-p,P=this.nbIterations-p-1;this.passUpScale[P].addRequiredComposer(this.composers[S-1]),this.composers[S-1].linkToShaderPassUniform(this.passUpScale[P],this.passUpScale[P].getInput())}this.finalBloomPass.addRequiredComposer(this.composers[m-1]),this.composers[m-1].linkToShaderPassUniform(this.finalBloomPass,this.finalBloomPass.getInput()),this.composers[m].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1))}this.setBeforeRenderCallback()}}})}),define("DS/Effects/ConvertLatLongToDualParaboloid",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/Plugins/ShaderPass","DS/ShaderBuilders/PostPro/ConvertShaderBuilders"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passConvert=null,this.texture=null,this.passDualParaboloidMap=null,this},setSize:function(e,s){this.width="string"==typeof e?parseInt(e):e,this.height="string"==typeof s?parseInt(s):s},setEnvMap:function(s){if(this.texture=s,this.texture instanceof e.Texture){var r=parseInt(this.texture.image.width),n=parseInt(this.texture.image.height);this.width=r,this.height=n}if(this.composers[0])this.composers[0].setSize(this.width,this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"maxPrecisionLinearNoStencilHFMobile");o.generateMipmaps=!1,o.mapping=e.LatLongReflectionMapping,this.composers[0]=new t(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0,this.passConvert=new i(a.LatlongToDualParaboloid,"Convert"),this.texture.sRGB&&(this.passConvert.material.defines.SRGB_INPUT=1),this.texture instanceof t||this.texture.rgbHdr||(this.passConvert.material.defines.RGBE_INPUT=1),this.composers[0].addPass(this.passConvert)}this.texture instanceof e.Texture||this.texture instanceof e.WebGLRenderTarget?this.passConvert.setLinkedInput(this.texture):this.texture.linkToShaderPassUniform(this.passConvert,this.passConvert.getInput()),this.passConvert.material.setUniform("size",new e.Vector2(this.width,this.height))},execute:function(){this.composers[0].render()}})}),define("DS/Effects/MergeMainMipsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/MergeShaderBuilders"],function(e,s,t,i,r){"use strict";const a="true"===localStorage.getItem("__WebVisu_LinearFilter_IBL__");return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passMerge=null,this},setTextures:function(s,n,o,h){var l=n.composerContext&&n.composerContext.width,p=n.composerContext&&n.composerContext.height;if(n instanceof e.Texture?(l=n.image.width,p=n.image.height):n instanceof e.WebGLRenderTarget&&(l=n.width,p=n.height),this.width=parseInt(l),this.height=parseInt(p),this.composers.length)this.composers[0].setSize(this.width,2*this.height);else{var c=new e.WebGLRenderTargetProperties(this.width,2*this.height,a?"iblUintLinear":"iblUintNearest");c.generateMipmaps=!1,this.composers[0]=new t(this.renderer,c,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0,this.passMerge=new i(r.RoughnessCustomMipsMerge,"Merge Main Roughness Map"),this.passMerge.material.setUniform("offset0",new e.Vector2(0,0)),this.passMerge.material.setUniform("scale0",new e.Vector2(-1,-1)),this.passMerge.material.setUniform("offset1",new e.Vector2(0,.5)),this.passMerge.material.setUniform("scale1",new e.Vector2(1,.5)),this.passMerge.material.setUniform("offset2",new e.Vector2(0,.25)),this.passMerge.material.setUniform("scale2",new e.Vector2(.5,.25)),this.passMerge.material.setUniform("offset3",new e.Vector2(.5,.25)),this.passMerge.material.setUniform("scale3",new e.Vector2(.5,.25)),this.passMerge.material.setUniform("offset4",new e.Vector2(0,.125)),this.passMerge.material.setUniform("scale4",new e.Vector2(.25,.125)),this.passMerge.material.setUniform("offset5",new e.Vector2(.25,.125)),this.passMerge.material.setUniform("scale5",new e.Vector2(.25,.125)),this.passMerge.material.setUniform("offset6",new e.Vector2(.5,.125)),this.passMerge.material.setUniform("scale6",new e.Vector2(.25,.125)),this.passMerge.material.setUniform("offset7",new e.Vector2(.75,.125)),this.passMerge.material.setUniform("scale7",new e.Vector2(.25,.125)),this.composers[0].addPass(this.passMerge)}this.passMerge.material.setUniform("size0",new e.Vector2(this.width,this.height)),this.passMerge.setLinkedInput(n,0);for(var m=0;m<s.length;m++)this.passMerge.setLinkedInput(s[m],m+1),this.passMerge.material.setUniform("size"+(m+1),new e.Vector2(parseInt(s[m].image.width),parseInt(s[m].image.height)));this.passMerge.material.defines.MIP_OFFSET=o?0:1,this.passMerge.material.defines.ZERO_RBGE=n instanceof t||n.rgbHdr?0:1,"LINEAR"===h&&(this.passMerge.material.defines.MAPPING=0),"NON_LINEAR"===h&&(this.passMerge.material.defines.MAPPING=1),"INVERSE_LINEAR"===h&&(this.passMerge.material.defines.MAPPING=2),"INVERSE_NON_LINEAR"===h&&(this.passMerge.material.defines.MAPPING=3),this.passMerge.material.needsUpdate=!0},execute:function(){this.composers[0].render();var s=this.composers[0].composerContext.getResult(void 0,!0);return s.hdr=!0,s.hasDiffuse=!0,s.mapping=new e.LatLongReflectionMapping,s}})}),define("DS/Effects/BlurShadowEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlurShaderBuilders","DS/ShaderBuilders/PostPro/GroundShadowShaderBuilders","DS/Plugins/ClearPass"],function(e,s,t,i,r,a,n){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.map=null,this.intensity=.5,this.passShadow=null,this.passBlurH=null,this.passBlurV=null,this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setIntensity:function(e){this.intensity=1-e,this.passShadow.material.setUniform("intensity",this.intensity)},setInput:function(s,o){if(s){this.map=s;var h=new e.Vector2(1/this.width,1/this.height);if(this.composers[0])this.composers[0].setSize(this.width,this.height);else{var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composers[0]=new t(this.renderer,l,this.rtPool),this.composers[0].composerContext.keepResult=!1,this.clearPass=new n("groundShadowClearPass"),this.passShadow=new i(a.GroundShadow,"GroundShadowEffect");var p=this;this.passShadow.beforeRenderCB=function(e){p.passShadow.setInput(p.map)},this.passBlurH=new i(r.BlurH,"GroundShadowEffectBlurH"),this.passBlurV=new i(r.BlurV,"GroundShadowEffectBlurV"),this.passBlurH.material.defines.LEVEL=5,this.passBlurV.material.defines.LEVEL=5,this.passBlurH.material.needsUpdate=!0,this.passBlurV.material.needsUpdate=!0,this.passBlurH.renderToScreen=!1,this.passBlurV.renderToScreen=!1,this.composers[0].addPass(this.clearPass),this.composers[0].addPass(this.passShadow),this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.setPassClear(this.clearPass,!0,new e.Color(16777215),1)}this.passShadow.material.setUniform("shadowMatrix",o),this.passBlurH.material.setUniform("invSize",h),this.passBlurV.material.setUniform("invSize",h)}},execute:function(){var s=this.renderer.shadowMapType===e.ESMShadowMap||this.renderer.shadowMapType===e.ESMImprovedShadowMap;s&&1!=this.passShadow.material.defines.IS_ESM&&(this.passShadow.material.defines.IS_ESM=1,this.passShadow.material.needsUpdate=!0),s||1!=this.passShadow.material.defines.IS_ESM||(this.passShadow.material.defines.IS_ESM=0,this.passShadow.material.needsUpdate=!0),this.composers[0].render(0,void 0,void 0,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}})}),define("DS/Effects/DownSamplingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders"],function(e,s,t,i,r){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.inputComposerContext=null,this.nbIterations=3,this.passDownsampling=[],this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setInput:function(s){if(s){this.inputComposerContext=s;var a=.5;if(this.composers[0])for(var n=0;n<this.nbIterations;n++)this.composers[n].setSize(a*this.width,a*this.height),a*=.5;else{for(n=0;n<this.nbIterations;n++){var o=new e.WebGLRenderTargetProperties(a*this.width,a*this.height,"uint");this.composers[n]=new t(this.renderer,o,this.rtPool),this.composers[n].composerContext.keepResult=!1,this.passDownsampling[n]=new i(r.CopyBlend,"BasicDownSampling"),this.passDownsampling[n].renderToScreen=!1,this.composers[n].addPass(this.passDownsampling[n]),a*=.5}this.composers[this.nbIterations-1].composerContext.keepResult=!1;for(n=1;n<this.nbIterations;n++)this.passDownsampling[n].addRequiredComposer(this.composers[n-1]),this.composers[n-1].linkToShaderPassUniform(this.passDownsampling[n],this.passDownsampling[n].getInput())}this.inputComposerContext.linkToShaderPassUniform(this.passDownsampling[0],this.passDownsampling[0].getInput())}},execute:function(){this.composers[this.nbIterations-1].render()}})}),define("DS/Effects/ComputeSkyScattering",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/SkyScatteringShaderBuilders"],function(e,s,t,i,r,a){"use strict";return t.extend({init:function(s,t){this._parent(s),this.renderer=s,this.rtPool=t,this.transmittanceWidth=256,this.transmittanceHeight=64,this.IrradianceWidth=1024,this.IrradianceHeight=1024,this.envmapWidth=2048,this.envmapHeight=1024,this.atmParams=null,this.loadTextureCallBacks=[],this.skyTransmittanceMap=null,this.skyScatteringMap=null,this.skyIrradianceMap=null,this.allTexturesReady=0,this.passTransmittance=null,this.passScattering=null,this.skyPass=null,this.mixPass=null;var n=new e.WebGLRenderTargetProperties(this.transmittanceWidth,this.transmittanceHeight,"linear");this.composers[0]=new i(this.renderer,n,this.rtPool),this.composers[0].composerContext.keepResult=!0;var o=new e.WebGLRenderTargetProperties(this.IrradianceWidth,this.IrradianceHeight,"linear");this.composers[1]=new i(this.renderer,o,this.rtPool),this.composers[1].composerContext.keepResult=!0;var h=new e.WebGLRenderTargetProperties(this.envmapWidth,this.envmapHeight,"linear");return this.composers[2]=new i(this.renderer,h,this.rtPool),this.composers[2].composerContext.keepResult=!0,this.composers[2].composerContext.beforeRenderCB=function(e){e.writeBuffer.minFilter=1003,e.writeBuffer.magFilter=1003,e.writeBuffer.wrapS=1001,e.writeBuffer.wrapT=1001},this.passTransmittance=new r(a.ComputeTransmittance),this.passTransmittance.material.needsUpdate=!0,this.passTransmittance.renderToScreen=!1,this.passScattering=new r(a.ComputeScattering),this.passScattering.material.needsUpdate=!0,this.passScattering.renderToScreen=!1,this.skyPass=new r(a.RenderSky),this.skyPass.material.needsUpdate=!0,this.skyPass.renderToScreen=!1,this.mixPass=new r(a.PostProcessScattering,"skyScatteringPass"),this.mixPass.material.needsUpdate=!0,this.mixPass.renderToScreen=!1,this.mixPass.changeRenderTargetProperties=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"linear"),this.composers[0].addPass(this.passTransmittance),this.composers[1].addPass(this.passScattering),this.composers[2].addPass(this.skyPass),this.composers[0].linkToShaderPassUniform(this.passScattering,this.passScattering.getInput(2)),this.composers[0].linkToShaderPassUniform(this.skyPass,this.skyPass.getInput(2)),this.composers[1].linkToShaderPassUniform(this.skyPass,this.skyPass.getInput(4)),this},initEffect:function(e,s){this.loadTextureCallBacks.push(function(e){e.skyPass.material.setLinkedInput(e.skyTransmittanceMap,2),e.mixPass.material.setLinkedInput(e.skyTransmittanceMap,2),e.skyPass.material.setLinkedInput(e.skyScatteringMap,4),e.mixPass.material.setLinkedInput(e.skyScatteringMap,4),e.skyPass.material.setLinkedInput(e.skyIrradianceMap,3),e.mixPass.material.setLinkedInput(e.skyIrradianceMap,3),e.executeWaiting&&e.execute(!0,e.executeWaiting)}),this.loadTextures(),s.insertComposer(null,this.mixPass)},update:function(s,t,i){var r=i.camera;this.mixPass.material.setUniform("near",r.near),this.mixPass.material.setUniform("far",r.far),this.mixPass.material.setUniform("invView",r.matrixWorld),this.mixPass.material.setUniform("texturesLoaded",this.allTexturesReady);var a=new e.Vector4,n=new e.Frustum;n.setFromMatrix(r.projectionMatrix);var o=r.near*Math.abs(n.planes[0].normal.z)/n.planes[0].normal.x,h=r.near*Math.abs(n.planes[1].normal.z)/n.planes[1].normal.x,l=-r.near*Math.abs(n.planes[2].normal.z)/n.planes[2].normal.y,p=-r.near*Math.abs(n.planes[3].normal.z)/n.planes[3].normal.y;a.x=o,a.y=l,a.z=h-o,a.w=p-l,this.mixPass.material.setUniform("screenToView",a),this.mixPass.setLinkedInput(this.renderer.dBuffer,1)},setSize:function(e,s){this._parent(e,s)},setGenerationInput:function(e){if(e){if(this.atmParams=e,null!=e.viewAltitude){var s=Math.max(e.viewAltitude,.001);this.skyPass.material.setUniform("viewAltitude",s),this.mixPass.material.setUniform("viewAltitude",s)}null!=e.sunDirection&&(this.skyPass.material.setUniform("sunDirection",e.sunDirection),this.mixPass.material.setUniform("sunDirection",e.sunDirection))}},_downloadTexture:function(e,s,t){var i=new Float32Array(s*t*4);this.renderer.context.readPixels(0,0,s,t,this.renderer.context.RGBA,this.renderer.context.FLOAT,i);var r=i,a=document.createElement("canvas");a.width=s,a.height=t;for(var n=a.getContext("2d"),o=n.createImageData(s,t),h=0;h<o.height;h++)for(var l=0;l<o.width;l++)o.data[4*(h*o.width+l)]=Math.round(255*r[4*(h*o.width+l)]),o.data[4*(h*o.width+l)+1]=Math.round(255*r[4*(h*o.width+l)+1]),o.data[4*(h*o.width+l)+2]=Math.round(255*r[4*(h*o.width+l)+2]),o.data[4*(h*o.width+l)+3]=Math.round(255*r[4*(h*o.width+l)+3]);n.putImageData(o,0,0);var p=document.createElement("a");p.download=e+".png",n.canvas.toBlob(function(e){p.href=URL.createObjectURL(e),p.click()})},loadTextures:function(){var t=0,i=this,r=function(){if(3==++t){for(var e=0;e<i.loadTextureCallBacks.length;e++)i.loadTextureCallBacks[e](i);i.allTexturesReady=1,i.loadTextureCallBacks=[]}},a=s.getWebappsAssetUrl("Ambiances","");if(this.skyTransmittanceMap||(this.skyTransmittanceMap=e.ImageUtils.loadCompressedTexture(a+"Sky/SkyTransmittance.dds",null,r,null,!1),this.skyTransmittanceMap.minFilter=e.LinearFilter,this.skyTransmittanceMap.magFilter=e.LinearFilter),this.skyIrradianceMap||(this.skyIrradianceMap=e.ImageUtils.loadCompressedTexture(a+"Sky/SkyIrradiance.dds",null,r,null,!1),this.skyIrradianceMap.minFilter=e.LinearFilter,this.skyIrradianceMap.magFilter=e.LinearFilter),this.skyScatteringMap||(this.skyScatteringMap=e.ImageUtils.loadCompressedTexture(a+"Sky/SkyInscatter.dds",null,r,null,!1),this.skyScatteringMap.minFilter=e.LinearFilter,this.skyScatteringMap.magFilter=e.LinearFilter),this.skyTransmittanceMap.loadEndStatus==e.AssetLoadingStatus.READY&&this.skyIrradianceMap.loadEndStatus==e.AssetLoadingStatus.READY&&this.skyScatteringMap.loadEndStatus==e.AssetLoadingStatus.READY){for(var n=0;n<this.loadTextureCallBacks.length;n++)this.loadTextureCallBacks[n](this);i.allTexturesReady=1,this.loadTextureCallBacks=[]}},execute:function(s,t,i,r,a){var n=function(s){s.renderer.materialToUse=e.MaterialToUse.originalMaterial,s.skyTransmittanceMap?(s.passScattering.material.setLinkedInput(s.skyTransmittanceMap,2),s.skyPass.material.setLinkedInput(s.skyTransmittanceMap,2)):(s.composers[0].render(),i&&s._downloadTexture("transmittance",s.transmittanceWidth,s.transmittanceHeight)),s.skyScatteringMap?s.skyPass.material.setLinkedInput(s.skyScatteringMap,4):(s.composers[1].render(),r&&s._downloadTexture("scattering",s.IrradianceWidth,s.IrradianceHeight)),s.skyPass.material.setLinkedInput(s.skyIrradianceMap,3),s.composers[2].render(),a&&s._downloadTexture("envmap",s.envmapWidth,s.envmapHeight);var n=s.composers[2].composerContext.getResult(void 0,!1);t&&t(n)};s?(this.loadTextureCallBacks.push(n),this.loadTextures()):n(this)}})}),define("DS/Effects/ESMEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/ESMBlurShaderBuilders","DS/Plugins/ClearPass"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.map=null,this.passBlurH=null,this.passBlurV=null,this},setSize:function(e,s){this.width=parseInt(e),this.height=parseInt(s)},setInput:function(s){if(s){if(this.map=s,this.composers[0])this.composers[0].setSize(this.width,this.height);else{var a=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers[0]=new t(this.renderer,a,this.rtPool),this.composers[0].composerContext.keepResult=!0,this.passBlurH=new i(r.BlurH),this.passBlurH.material.defines.LEVEL=3,this.passBlurH.material.needsUpdate=!0,this.passBlurH.renderToScreen=!1;var n=this;this.passBlurH.beforeRenderCB=function(e){n.passBlurH.setInput(n.map)},this.passBlurV=new i(r.BlurV),this.passBlurV.material.defines.LEVEL=3,this.passBlurV.material.needsUpdate=!0,this.passBlurV.renderToScreen=!1,this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV)}var o=new e.Vector2(1/this.width,1/this.height);this.passBlurH.material.setUniform("invSize",o),this.passBlurV.material.setUniform("invSize",o)}},execute:function(){this.composers[0].render(0,void 0,void 0,"toto")},getResult:function(){return this.composers[0].getRenderResult("toto")}})}),define("DS/Effects/ComputeSDFFontIterative",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders","DS/ShaderBuilders/PostPro/SDFFontIterativeShaderBuilders"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.__renderer=e,this.passComputeSDFFontSeed=null,this.passComputeSDFFontFlood=null,this.passComputeSDFFontMerge=null,this.OutputRatio=.25,this.texture=null,this.passDisplayMap=null,this},setMap:function(s,n){if(this.texture=s,this.width=parseInt(s.image.width),this.height=parseInt(s.image.height),this.composers[1])this.composers[1].setSize(this.width,this.height),this.passComputeSDFFontSeed.setLinkedInput(this.texture);else{(h=new e.WebGLRenderTargetProperties(this.width,this.height,"maxPrecisionNearest")).generateMipmaps=!1,h.mapping=this.texture.mapping,this.composers[1]=new t(this.renderer,h,this.renderTargetPool),this.composers[1].composerContext.keepResult=!0,this.passComputeSDFFontSeed=new i(a.SDFFontSeed),this.passComputeSDFFontSeed.compileShader(this.__renderer),this.passComputeSDFFontSeed.setLinkedInput(this.texture),this.passComputeSDFFontFlood=new i(a.SDFFontFlood),this.passComputeSDFFontMerge=new i(a.SDFFontMerge);var o=new i(r.CopyBlend);this.composers[1].addPass(this.passComputeSDFFontSeed),this.composers[1].addPass(this.passComputeSDFFontFlood),this.composers[1].addPass(this.passComputeSDFFontMerge),this.composers[1].addPass(o)}var h,l=this.getOutputSize();this.composers[0]?this.composers[0].setSize(l.width,l.height):((h=new e.WebGLRenderTargetProperties(l.width,l.height,"uint")).generateMipmaps=!1,h.mapping=this.texture.mapping,this.composers[0]=new t(this.renderer,h,this.renderTargetPool),this.composers[0].composerContext.keepResult=!1,this.passDisplayMap=new i(a.SDFFontDisplay),this.passDisplayMap.renderToScreen=!1,this.composers[0].addPass(this.passDisplayMap),this.composers[1].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.getInput()));this.passComputeSDFFontFlood.material.setUniform("invSize",new e.Vector2(1/this.width,1/this.height))},executeStep:function(s,t){var i=null;if(t)this.composers[1].enablePass(this.passComputeSDFFontSeed,!1),this.composers[1].enablePass(this.passComputeSDFFontFlood,!1),this.composers[1].enablePass(this.passComputeSDFFontMerge,!0),i=this.composers[1].composerContext.getResult(void 0,!0),this.passComputeSDFFontMerge.setLinkedInput(i);else if(s>0){this.composers[1].enablePass(this.passComputeSDFFontSeed,!1),this.composers[1].enablePass(this.passComputeSDFFontFlood,!0),this.composers[1].enablePass(this.passComputeSDFFontMerge,!1),i=this.composers[1].composerContext.getResult(void 0,!0),this.passComputeSDFFontFlood.setLinkedInput(i);this.passComputeSDFFontFlood.material.setUniform("invSize",new e.Vector2(1/this.width,1/this.height))}else this.composers[1].enablePass(this.passComputeSDFFontSeed,!0),this.composers[1].enablePass(this.passComputeSDFFontFlood,!1),this.composers[1].enablePass(this.passComputeSDFFontMerge,!1),this.passComputeSDFFontFlood.setLinkedInput(this.texture);this.__renderer.materialToUse=e.MaterialToUse.originalMaterial,this.composers[1].render(),i&&(this.renderTargetPool.pushRenderTarget(i),i=null)},renderToScreen:function(){this.passDisplayMap.renderToScreen=!0,this.composers[0].render()},renderOffscreen:function(){this.passDisplayMap.renderToScreen=!1,this.composers[0].render()},getOutputSize:function(){return{width:Math.floor(this.width*this.OutputRatio),height:Math.floor(this.height*this.OutputRatio)}}})}),define("DS/Effects/TAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/TAAShaderBuilders"],function(e,s,t,i,r,a){"use strict";return t.extend({init:function(s,t){this._parent(s);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");n.generateMipmaps=!1,this.composers[0]=new i(s,n,t),this.composers[0].composerContext.keepResult=!0,this.passTAA=new r(a.TAA,"TAACompute"),this.composers[0].addPass(this.passTAA),this.mixPass=new r(a.Transfer,"TAAEffect"),this.tmpResult=null,this.renderTargetPool=t,this.maxIteration=128,this.msaaOffset=[];for(var o=0;o<this.maxIteration;o++){var h=e.RandomLib.LowDiscrepancy2D(o);this.msaaOffset.push({x:h.x-.5,y:h.y-.5})}return this.previousViewProjectionMatrix=null,this.currentViewProjectionMatrix=null,this.currentProjectionMatrixInverse=null,this.currentViewMatrixInverse=null,this},initEffect:function(e,s){s.getComposer("normalDepth").linkToShaderPassUniform(this.passTAA,this.passTAA.getInput(1)),s.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.mixPass.addRequiredComposer(this.composers[0])},update:function(s,t,i,r){var a=i._renderedCamera;a.projectionMatrixInverse.getInverse(a.projectionMatrix),a.matrixWorldInverse.getInverse(a.matrixWorld),this.previousViewProjectionMatrix?(this.currentViewMatrixInverse.copy(a.matrixWorld),this.currentProjectionMatrixInverse.copy(a.projectionMatrixInverse),this.currentViewProjectionMatrix.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse)):(this.previousViewProjectionMatrix=new e.Matrix4,this.previousViewProjectionMatrix.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse),this.currentProjectionMatrixInverse=new e.Matrix4,this.currentProjectionMatrixInverse.copy(a.projectionMatrixInverse),this.currentViewMatrixInverse=new e.Matrix4,this.currentViewMatrixInverse.copy(a.matrixWorld),this.currentViewProjectionMatrix=new e.Matrix4,this.currentViewProjectionMatrix.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse)),this.passTAA.material.setUniform("screenSize",new e.Vector2(this.width,this.height)),this.passTAA.material.setUniform("numIteration",r),this.passTAA.material.setUniform("previousViewProjectionMatrix",this.previousViewProjectionMatrix),this.passTAA.material.setUniform("currentViewProjectionMatrix",this.currentViewProjectionMatrix),this.passTAA.material.setUniform("currentProjectionMatrixInverse",this.currentProjectionMatrixInverse),this.passTAA.material.setUniform("currentViewMatrixInverse",this.currentViewMatrixInverse);var n=this;this.mixPass.beforeRenderCB=function(e){n.tmpResult=n.composers[0].composerContext.getResult("main",!0),n.tmpResult||(n.tmpResult=null),n.passTAA.material.setUniform("prevMap",n.tmpResult)},this.mixPass.afterRenderCB=function(){n.tmpResult&&(n.renderTargetPool.pushRenderTarget(n.tmpResult),n.tmpResult=null,n.previousViewProjectionMatrix.copy(n.currentViewProjectionMatrix))},r>=this.getMaxIteration()||this.mixPass.requiredComposers.length||this.mixPass.addRequiredComposer(this.composers[0])},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(e,s){var t=e.clone();t._renderingRole=e._renderingRole;var i=Math.min(this.getMaxIteration()-1,s);return t.updateProjectionMatrix(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height),t},computeJitterValues:function(s,t){var i=Math.min(this.getMaxIteration()-1,t);return new e.Vector2(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height)},setSize:function(e,s,t){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height,t)}})}),define("DS/Effects/ConvertCubemapToLatlong",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/ConvertShaderBuilders","DS/ShaderBuilders/PostPro/MergeShaderBuilders","DS/ShaderBuilders/PostPro/EncodingShaderBuilders"],function(e,s,t,i,r,a,n){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passConvert=null,this.texture=null,this.passDisplayLatlongMap=null,this.saveComposer=null,this.passEncodeHDR=null,this},setEnvMap:function(s,n){this.texture=s;var o;(this.width=2048,this.height=1024,this.composers[1])?this.composers[1].setSize(2048,1024):((o=new e.WebGLRenderTargetProperties(2048,1024,"linear")).generateMipmaps=!1,o.mapping=this.texture.mapping,this.composers[1]=new t(this.renderer,o,this.renderTargetPool),this.composers[1].composerContext.keepResult=!0,this.passConvert=new i(r.CubemapToLatlong),this.passConvert.material.defines.ORIENTATION=n,this.composers[1].addPass(this.passConvert));(this.passConvert.setLinkedInput(this.texture),this.composers[0])?this.composers[0].setSize(this.width,this.height):((o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint")).generateMipmaps=!1,o.mapping=this.texture.mapping,this.composers[0]=new t(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!1,this.passDisplayLatlongMap=new i(a.IrradianceMerge1),this.passDisplayLatlongMap.material.setUniform("offset0",new e.Vector2(0,.5)),this.passDisplayLatlongMap.material.setUniform("scale0",new e.Vector2(.5,.5)),this.composers[0].composerContext.setPassRenderToCanvas(this.passDisplayLatlongMap,!0),this.composers[0].addPass(this.passDisplayLatlongMap),this.composers[1].linkToShaderPassUniform(this.passDisplayLatlongMap,this.passDisplayLatlongMap.getInput(0)))},execute:function(){this.composers[1].render()},getResult:function(s){var t=this.composers[1].composerContext.getResult(void 0,s);return t.hdr=!0,t.mapping=new e.LatLongReflectionMapping,t},getResultRGBE:function(s){this.encodeRGBE();var t=this.saveComposer.composerContext.getResult(void 0,s);return t.hdr=!0,t.mapping=new e.LatLongReflectionMapping,t},encodeRGBE:function(){var s=this.composers[1],r=s.composerContext.renderTargetProperties.width,a=s.composerContext.renderTargetProperties.height;if(this.saveComposer)this.saveComposer.setSize(r,a);else{var o=new e.WebGLRenderTargetProperties(r,a,"uintNearest");o.generateMipmaps=!1,o.mapping=this.texture.mapping,this.saveComposer=new t(this.renderer,o,this.renderTargetPool),this.saveComposer.composerContext.keepResult=!0,this.passEncodeHDR=new i(n.EncodeHDR),this.saveComposer.composerContext.setPassRenderToCanvas(this.passEncodeHDR,!1),this.saveComposer.addPass(this.passEncodeHDR)}this.passEncodeHDR.setLinkedInput(s.composerContext.getResult()),this.saveComposer.render()}})}),define("DS/Effects/NativeOnTopEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/RenderPass","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/EncodingShaderBuilders"],function(e,s,t,i,r){"use strict";return s.extend({init:function(s,a,n){return this._parent(s),this.v6Renderer=null,this.idString="onTop",e.supportedExtensions&&e.supportedExtensions.fragDepth?(this.mixPass=new i(r.DecodeDepth,"onTopDepthSetPass"),this.mixPass.disableDepthTest=!1,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.onTopPass=new t(null,null,null,void 0,void 0,void 0,"onTopPass"),this.onTopPass.idString=this.idString):(this.fallBackPass=new t(null,null,null,void 0,void 0,void 0,"fallBackOnTopPass"),this.fallBackPass.idString=this.idString),this},initEffect:function(e,s){this.v6Renderer=s,this.fallBackPass?(s.mainComposer.addPass(this.fallBackPass),s.compForwardComposerContext.enablePass(this.fallBackPass,!0)):(this.mixPass.needsSwap=!1,s.mainComposer.addPass(this.mixPass),s.__enablePassOnAllComposerContexts(this.mixPass,!1),s.compForwardComposerContext.enablePass(this.mixPass,!0),s.mainComposer.addPass(this.onTopPass),s.__enablePassOnAllComposerContexts(this.onTopPass,!1),s.compForwardComposerContext.enablePass(this.onTopPass,!0))},update:function(e,s,t,i){var r=this.v6Renderer;this.fallBackPass||(s.scene.getNbWebGLObjects(this.idString)?(this.renderer.requestPoliteDepthBuffer(),r.compForwardComposerContext.enablePass(this.mixPass,!0),this.mixPass.setLinkedInput(this.renderer.politeDepthBuffer)):(this.mixPass.setLinkedInput(null),r.compForwardComposerContext.enablePass(this.mixPass,!1)))},disablePasses:function(e){this.fallBackPass?e.enablePass(this.fallBackPass,!1):(e.enablePass(this.mixPass,!1),e.enablePass(this.onTopPass,!1))},setSize:function(e,s){this._parent(e,s)},setEnabled:function(e){var s=this.v6Renderer;this.fallBackPass?s.compForwardComposerContext.enablePass(this.fallBackPass,e):(s.compForwardComposerContext.enablePass(this.mixPass,e),s.compForwardComposerContext.enablePass(this.onTopPass,e)),e&&this._parent(e)}})}),define("DS/Effects/NoPowerOfTwoEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders"],function(e,s,t,i,r){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.gl=this.renderer.context,this.renderTargetPool=s,this.passMerge=null,this},setTextures:function(s){var a=s.image.width,n=s.image.height;if(this.width=a,this.height=n,e.ImageUtils.is_pow2(a)||(this.width=e.ImageUtils.nearest_pow2(a)),e.ImageUtils.is_pow2(n)||(this.height=e.ImageUtils.nearest_pow2(n)),this.composers.length)this.composers[0].setSize(this.width,2*this.height);else{var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");o.generateMipmaps=!1,this.composers[0]=new t(this.renderer,o,this.renderTargetPool),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.noIdCheck=!0,this.passMerge=new i(r.CopyBlend,"Resize texture"),this.composers[0].addPass(this.passMerge)}this.passMerge.setLinkedInput(s),this.passMerge.material.needsUpdate=!0},copyToDataTexture:function(e,s){this.composers[0].render();var t=this.composers[0].composerContext.getResult(void 0,!0),i=new Uint8Array(4*this.width*this.height);return e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,i),s.mipmaps.length&&(s.mipmaps=[],s.generateMipmaps=!0),s.image.data=i,s.image.height=this.height,s.image.width=this.width,t}})}),define("DS/Effects/ToneMappingEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/CompositeShaderBuilders","DS/ShaderBuilders/PostPro/ImageOperationShaderBuilders","DS/ShaderBuilders/PostPro/ExposureShaderBuilders"],function(e,s,t,i,r,a,n){"use strict";const o=r.ToneMapEnum,h=r.ColorCorrectionEnum;return s.extend({init:function(s,t){this._parent(s),this.renderer=s,this.rtPool=t,this.tonemapping=1,this.gamma=2.2,this.brightness=0,this._AEfinalRTSize=2,this._AEsumPasses=2,this._AEinit=!1,this._autoExposure=!1,this._AEregionOfInterestTexture=null,this._AEclampMin=-10,this._AEclampMax=20,this._AEComposers=[],this._AEWeightedLuminancePass=null,this._AEPixelSumPasses=[],this.colorGrading=null,this.mixPass=new i(r.CompositingShader,"compositePass"),this.mixPass.material.blending=e.NoBlending,this.mixPass.gammaCorrectionPass=!0;var a=new e.WebGLRenderTargetProperties(this.viewportWidth,this.viewportHeight,"uint");return this.mixPass.changeRenderTargetProperties=a,this.defines=this.mixPass.material.defines,this.autoExposureParams=null,this},initEffect:function(e,s){s.insertComposer(null,this.mixPass)},update:function(s,t,i){var r=24,a=38.6;i.camera instanceof e.PerspectiveCamera&&(r=i.camera.sensorSizeHeight,a=i.camera.focalLength),this.mixPass.material.setUniform("sensorSize",r),this.mixPass.material.setUniform("screenRatio",1/i.camera.aspect),this.mixPass.material.setUniform("focalLength",a)},updateRequiredComposers:function(){this.mixPass.requiredComposers=[],this._autoExposure&&this.mixPass.addRequiredComposer(this._AEComposers[this._AEsumPasses])},setBeforeRenderCallback:function(){var e=null,s=this;this._autoExposure&&(e=function(e){s._AEWeightedLuminancePass.setLinkedInput(e,0)}),this.mixPass.beforeRenderCB=e,this._autoExposure},setVignettingPower:function(e){this.power=e||0,this.mixPass.material.setUniform("power",this.power)},setToneMapping:function(e,s){var t=this.defines;switch(t.COLOR_GRADING=!1,t.COLOR_CORRECTION=h.NONE,t.COLOR_TONEMAP=o.NONE,this._autoExposure?t.USE_AUTO_EXPOSURE=this._AEfinalRTSize:t.USE_AUTO_EXPOSURE=0,this.tonemapping=e,this.renderer._setToneMapping(this.tonemapping),e>1&&(2.2==this.gamma?t.COLOR_CORRECTION=h.SRGB:t.COLOR_CORRECTION=h.GAMMA),e){case 1:t.COLOR_CORRECTION=h.GAMMA_SIMPLE;break;case 2:break;case 3:t.COLOR_TONEMAP=o.REINHARD;break;case 4:t.COLOR_TONEMAP=o.FILMIC;break;case 5:t.COLOR_TONEMAP=o.UNCHARTED;break;case 6:t.COLOR_TONEMAP=o.PHOTOGRAPHIC,t.TONEMAP_PHOTOGRAPHIC=!0,s&&(null!=s.crushblacks&&this.mixPass.material.setUniform("crushblacks",s.crushblacks),null!=s.burnhighlights&&this.mixPass.material.setUniform("burnhighlights",s.burnhighlights),null!=s.saturation&&this.mixPass.material.setUniform("saturation",s.saturation),s.colorCorrection&&this.mixPass.material.setUniform("colorCorrection",s.colorCorrection))}this.mixPass.material.needsUpdate=!0},setGamma:function(e){this.gamma=e,this.mixPass.material.setUniform("gamma",e),this.setToneMapping(this.tonemapping)},setBrightness:function(e){this.brightness=e,this.mixPass.material.setUniform("brightness",e)},setAutoExposure:function(e,s,t,i){this.autoExposureParams={isActive:e,weightTexture:s,clampMin:t,clampMax:i};var r=this.renderer.supportsFloatTextures();this._autoExposure!=e&&r&&(this._autoExposure=e,this._AEregionOfInterestTexture=s,this._AEclampMin=null!=t?t:-10,this._AEclampMax=null!=i?i:20,this._autoExposure?(this.defines.USE_AUTO_EXPOSURE=this._AEfinalRTSize,this._buildAutoExposureRT(),this._updateAutoExposureUniforms()):this.defines.USE_AUTO_EXPOSURE=0,this.updateRequiredComposers(),this.mixPass.material.needsUpdate=!0)},setColorGrading:function(e){e?(this.colorGrading=e,this.mixPass.material.setUniform("gradingMap",this.colorGrading),this.mixPass.material.setUniform("gradingDepth",this.colorGrading.image.width/this.colorGrading.image.height)):this.colorGrading=null,this.defines.COLOR_GRADING=!!this.colorGrading,this.mixPass.material.needsUpdate=!0},_getQAParams:function(){return{tonemapping:this.tonemapping,gamma:this.gamma,brightness:this.brightness,autoExposure:this.autoExposureParams,colorGrading:this.colorGrading,power:this.power}},_applyQAParams:function(e){this.setToneMapping(e.tonemapping),this.setGamma(e.gamma),this.setBrightness(e.brightness),e.autoExposure?this.setAutoExposure(e.autoExposure.isActive,e.autoExposure.weightTexture,e.autoExposure.clampMin,e.autoExposure.clampMax):this.setAutoExposure(!1),this.setColorGrading(e.colorGrading),this.setVignettingPower(this.power)},setSize:function(s,t,i){if(this._parent(s,t)&&this._AEinit){this._AEComposers[0].setSize(this.width,this.height,i),this._AEPixelSumPasses[0].material.setUniform("tInputSize",new e.Vector2(this.width,this.height));var r=this._AEPixelSumPasses[0].material.getUniform("currentSize"),a=Math.ceil(this.width/r.x),n=Math.ceil(this.height/r.y);this._AEPixelSumPasses[0].material.defines={LOOP_SIZE_X:a,LOOP_SIZE_Y:n,LOOP_SIZE_X_FINAL:this.width-a*(r.x-1),LOOP_SIZE_Y_FINAL:this.height-n*(r.y-1)},this._AEPixelSumPasses[0].material.needsUpdate=!0}},_updateAutoExposureUniforms:function(){this._AEinit&&(this._AEWeightedLuminancePass.material.setUniform("clampMin",this._AEclampMin),this._AEWeightedLuminancePass.material.setUniform("clampMax",this._AEclampMax),this._AEregionOfInterestTexture?(this._AEWeightedLuminancePass.setLinkedInput(this._AEregionOfInterestTexture,1),this._AEWeightedLuminancePass.material.defines.USE_WEIGHT_TEXTURE=1,this._AEWeightedLuminancePass.material.needsUpdate=!0):(this._AEWeightedLuminancePass.setLinkedInput(null,1),this._AEWeightedLuminancePass.material.defines.USE_WEIGHT_TEXTURE=0,this._AEWeightedLuminancePass.material.needsUpdate=!0))},_buildAutoExposureRT:function(){if(!this._AEinit){this._AEinit=!0;var s=new e.WebGLRenderTargetProperties(this.width,this.height,"nearest");this._AEComposers[0]=new t(this.renderer,s,this.rtPool),this._AEWeightedLuminancePass=new i(n.WeightedLuminance),this._AEPixelSumPasses=[],this._AEComposers[0].addPass(this._AEWeightedLuminancePass);for(var r=this.width,o=this.height,h=[256,this._AEfinalRTSize],l=0;l<this._AEsumPasses;l++){var p=h[l],c=new e.WebGLRenderTargetProperties(p,p,"nearest");this._AEComposers[l+1]=new t(this.renderer,c,this.rtPool),this._AEPixelSumPasses[l]=new i(a.PixelSum),this._AEPixelSumPasses[l].material.setUniform("currentSize",new e.Vector2(p,p)),this._AEPixelSumPasses[l].material.setUniform("tInputSize",new e.Vector2(r,o));var m=Math.ceil(r/p),d=Math.ceil(o/p);this._AEPixelSumPasses[l].material.defines={LOOP_SIZE_X:m,LOOP_SIZE_Y:d,LOOP_SIZE_X_FINAL:r-m*(p-1),LOOP_SIZE_Y_FINAL:o-d*(p-1)};r=p,o=p;this._AEPixelSumPasses[l].material.needsUpdate=!0,this._AEComposers[l+1].addPass(this._AEPixelSumPasses[l]),this._AEPixelSumPasses[l].addRequiredComposer(this._AEComposers[l]),this._AEComposers[l].linkToShaderPassUniform(this._AEPixelSumPasses[l],this._AEPixelSumPasses[l].getInput())}this.setBeforeRenderCallback(),this._AEComposers[this._AEsumPasses].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1))}}})}),define("DS/Effects/MSAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/MSAAShaderBuilders"],function(e,s,t,i,r,a){"use strict";return t.extend({init:function(s,t){this._parent(s),this.mode=1;var n=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");n.generateMipmaps=!1,this.composers[0]=new i(s,n,t),this.composers[0].composerContext.keepResult=!0,this.passBlend=new r(a.Blending,"MSAABlending"),this.composers[0].addPass(this.passBlend),this.mixPass=new r(a.Transfer,"MSAAEffect"),this.tmpResult=null,this.renderTargetPool=t;for(var o=new Uint8Array(16),h=0;h<4;h++)o[4*h]=0,o[4*h+1]=0,o[4*h+2]=0,o[4*h+3]=255;this.initTexture=new e.DataTexture(o,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this.maxIteration=128,this.msaaOffset=[];for(var l=0;l<this.maxIteration;l++){var p=e.RandomLib.LowDiscrepancy2D(l);this.msaaOffset.push({x:p.x-.5,y:p.y-.5})}return this},initEffect:function(e,s){s.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t,i){this.mode?i-=1:i=0,this.passBlend.material.setUniform("numIteration",i);var r=this;this.mixPass.beforeRenderCB=function(e){0===i?r.passBlend.material.setUniform("prevMap",r.initTexture):i>0&&(r.tmpResult=r.composers[0].composerContext.getResult("main",!0),r.passBlend.material.setUniform("prevMap",r.tmpResult))},this.mixPass.afterRenderCB=function(){r.tmpResult&&(r.renderTargetPool.pushRenderTarget(r.tmpResult),r.tmpResult=null)},i>=this.getMaxIteration()?this.mixPass.requiredComposers=[]:this.mixPass.requiredComposers.length||this.mixPass.addRequiredComposer(this.composers[0])},getMaxIteration:function(){return this.mode?this.maxIteration:1},computeJitterCamera:function(e,s){var t=e.clone();t._renderingRole=e._renderingRole;var i=Math.min(this.getMaxIteration()-1,s);return t.updateProjectionMatrix(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height),t},computeJitterValues:function(s,t){var i=Math.min(this.getMaxIteration()-1,t);return new e.Vector2(this.msaaOffset[i].x/this.width,this.msaaOffset[i].y/this.height)},setSize:function(e,s,t){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height,t)}})}),define("DS/Effects/GenerateMipMaps",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/DownSamplingShaderBuilders","DS/ShaderBuilders/PostPro/MergeShaderBuilders"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.renderer=e,this.rtPool=s,this.inputComposer=null,this.nbIterations=9,this.passMip=[],this.passMergeMips=null,this.passDisplayMap=null,this},setSize:function(s,t){this.width="string"==typeof s?parseInt(s):s,this.height="string"==typeof t?parseInt(t):t,this.nbIterations=Math.min(Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2)),e.supportedExtensions.fragmentTextureUnits)-1},setInput:function(s){if(s){this.inputComposer=s;var n=.5;if(this.composers[0]){for(var o=0;o<this.nbIterations;o++)this.composers[o].setSize(n*this.width,n*this.height),this.passMip[o].material.setUniform("invSize",new e.Vector2(1/(n*this.width),1/(n*this.height))),n*=.5;this.composers[this.nbIterations].setSize(this.width,2*this.height)}else{for(o=0;o<this.nbIterations;o++){var h=new e.WebGLRenderTargetProperties(n*this.width,n*this.height,"maxPrecisionLinearNoStencilHFMobile");this.composers[o]=new t(this.renderer,h,this.rtPool),this.composers[o].composerContext.keepResult=!1,this.composers[o].composerContext.noIdCheck=!0,this.passMip[o]=new i(r.DownSamplingBlur,"GenerateMips"+o),this.passMip[o].material.setUniform("invSize",new e.Vector2(1/(n*this.width),1/(n*this.height))),this.passMip[o].material.needsUpdate=!0,this.passMip[o].renderToScreen=!1,this.composers[o].addPass(this.passMip[o]),n*=.5}var l=new e.WebGLRenderTargetProperties(this.width,2*this.height,"maxPrecisionLinearNoStencilHFMobile");this.composers[this.nbIterations]=new t(this.renderer,l,this.rtPool),this.composers[this.nbIterations].composerContext.keepResult=!1,this.composers[this.nbIterations].composerContext.noIdCheck=!0,this.passMergeMips=new i(r.MergeMips(this.nbIterations),"MergeMips"),this.passMergeMips.renderToScreen=!1,this.composers[this.nbIterations].addPass(this.passMergeMips);for(o=1;o<this.nbIterations;o++)this.passMip[o].addRequiredComposer(this.composers[o-1]),this.composers[o-1].linkToShaderPassUniform(this.passMip[o],this.passMip[o].getInput());this.passMergeMips.addRequiredComposer(this.composers[this.nbIterations-1]),this.inputComposer.linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.getInput(0));for(o=0;o<this.nbIterations;o++)this.composers[o].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.getInput(o+1))}this.inputComposer.linkToShaderPassUniform(this.passMip[0],this.passMip[0].getInput());var p=this.nbIterations+1;if(this.composers[p])this.composers[p].setSize(this.width,2*this.height);else{var c=new e.WebGLRenderTargetProperties(this.width,2*this.height,"uint");c.generateMipmaps=!1,this.composers[p]=new t(this.renderer,c,this.rtPool),this.composers[p].composerContext.keepResult=!1,this.composers[p].composerContext.noIdCheck=!0,this.passDisplayMap=new i(a.IrradianceMerge1,"DisplayMips"),this.passDisplayMap.material.setUniform("offset0",new e.Vector2(0,.5)),this.passDisplayMap.material.setUniform("scale0",new e.Vector2(.5,.5)),this.composers[p].composerContext.setPassRenderToCanvas(this.passDisplayMap,!0),this.composers[p].addPass(this.passDisplayMap),this.composers[this.nbIterations].linkToShaderPassUniform(this.passDisplayMap,this.passDisplayMap.getInput(0))}}},execute:function(){this.composers[this.nbIterations].render()},getResult:function(){return this.composers[this.nbIterations]},renderToScreen:function(){this.composers[this.nbIterations+1].render()}})}),define("DS/Effects/VolumeRenderingEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/VolumeRenderingShaderBuilders"],function(e,s,t,i,r,a){"use strict";var n=function(e,s){for(var t=s||1;t<e;)t*=2;return t},o=function(s,t){for(var i=new Uint8Array(16),r=0;r<4;r++)i[4*r]=0,i[4*r+1]=0,i[4*r+2]=0,i[4*r+3]=t?0:255;var a=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter);return a.generateMipmaps=!1,a.needsUpdate=!0,s.setTexture(a,0),a};return t.extend({init:function(s,t,n){this._parent(s);this.debugInfos=!1,this.renderIsoSurface=!1,this.viewMatrix=new e.Matrix4,this.viewpoint=null;var h=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");return this.composers.push(new i(s,h,t)),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.name="VolumeRenderingComposer",this.initShaderPasses(n),this.mixPass=new r(a.Transfer,"VolumeRenderingEffect"),this.initTexture=o(this.renderer,!1),this.initTextureIso=o(this.renderer,!0),this.volumeManager=null,this.tmpResult=null,this.renderTargetPool=t,this.debugChunkBox=!1,this.debugChunkRepartition=[0,0,0,0,0,0,0],this.minDensity=0,this.maxDensity=0,this.avgDensity=0,this.costScore=0,this},initShaderPasses:function(e){var s=4;this.effectVolumePasses=[];for(var t=0;t<7;t++){var i=s*n(Math.ceil(Math.sqrt(s))),o=new r(a.RenderChunk,"VolumeRender"+t),h=o.material.defines;h.MAX_STEPS=Math.min(4*s,256),h.CHUNK_SIZE=s+".0",h.MAP_INVSIZE=1/i,h.USE_CLIP_PLANE=!1,h.RANDOM_STEP=!e,o.compileShader(this.renderer),this.effectVolumePasses.push(o),this.composers[0].addPass(o),s*=2}},initEffect:function(e,s){for(var t=s.getComposer("normalDepth"),i=0;i<this.effectVolumePasses.length;i++){var r=this.effectVolumePasses[i];t.linkToShaderPassUniform(r,r.getInput(1))}s.insertComposer(null,this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1))},setRenderType:function(e){if(e!==this.renderIsoSurface){this.renderIsoSurface=e;for(var s=0;s<7;s++){var t=this.effectVolumePasses[s];t.material.defines.ISO_SURFACE=e?1:0,t.compileShader(this.renderer)}this.mixPass.material.defines.ISO_SURFACE=e?1:0,this.mixPass.compileShader(this.renderer)}},update:function(s,t,i,r){this.volumeManager.update(i),this.viewpoint=i,i._renderedCamera.matrixWorldInverse.getInverse(i._renderedCamera.matrixWorld),i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix);for(var a=r%2<.5?r/2:(-r-1)/2,n=0;n<this.effectVolumePasses.length;n++){var o=this.effectVolumePasses[n];if(o.material.setUniform("realProjectionMatrixInverse",i._renderedCamera.projectionMatrixInverse),this.viewMatrix.copy(i._renderedCamera.matrixWorldInverse),o.material.setUniform("colorMap",this.volumeManager.colorMap),o.material.setUniform("transferFctMap",this.volumeManager.transferFunctionMap),o.material.setUniform("renderIteration",a),null!==this.volumeManager.clipPlane){var h=(new e.Plane).copy(this.volumeManager.clipPlane);h.applyMatrix4(i._renderedCamera.matrixWorldInverse),o.material.setUniform("clipPlaneEquation",new e.Vector4(h.normal.x,h.normal.y,h.normal.z,h.constant))}}},setAttenuation:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){this.effectVolumePasses[s].material.setUniform("attenuationCoeff",e)}},setAttenuationScale:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){this.effectVolumePasses[s].material.setUniform("attenuationScale",e)}},setIsoValue:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){this.effectVolumePasses[s].material.setUniform("isoValue",e)}},setDebugInfos:function(e){this.debugInfos=e},addChunkToRepartition:function(e){this.volumeManager.updateBinnedValues(e);for(var s=0,t=4;e.data.mapDim.x>t||e.data.mapDim.y>t||e.data.mapDim.z>t;)s++,t*=2;this.debugChunkRepartition[s]++;var i=0;if(this.volumeManager.camera){var r=this.volumeManager.computeChunkVoxelDensity(this.volumeManager.camera,e);i=Math.PI*r*r}1/e.data._voxelDensity>this.maxDensity&&(this.maxDensity=1/e.data._voxelDensity),1/e.data._voxelDensity<this.minDensity&&(this.minDensity=1/e.data._voxelDensity),this.avgDensity+=1/e.data._voxelDensity;var a=e.data.chunkSize;Math.log2(a);this.costScore+=i*Math.min(256,4*e.data.chunkSize)},execute:function(){var s=new e.Matrix4;if(this.debugChunkRepartition=[0,0,0,0,0,0,0],this.minDensity=1/0,this.maxDensity=-1/0,this.avgDensity=0,this.costScore=0,this.debugInfos&&this.volumeManager){for(var t=0;t<256;t++)this.volumeManager.binnedValues[t]=0;this.volumeManager.binnedMaxValue=0}var i=this.viewpoint?this.viewpoint._renderedCamera:null;if(i){var r=new e.Frustum,a=new e.Matrix4;a.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),r.setFromMatrix(a);for(t=0;t<this.volumeManager.volumeChunks.length;t++){this.composers[0].composerContext.name="VolumeRenderingComposer-Chunk"+t;var n=this.volumeManager.volumeChunks[t],o=n.data;if(o)if(r.performFrustumCullingNoNearFar(o.radius,o.position)){this.debugInfos&&this.addChunkToRepartition(n);var h=n.data.chunkSize,l=(n.lod,o.modelMatrix),p=Math.log2(h)-2,c=this.effectVolumePasses[p];if(c.name="VolumeRender"+p+"-Chunk"+t,c.material.setUniform("gridSize",o.gridSize),s.multiplyMatrices(this.viewMatrix,l),c.material.setUniform("realModelViewMatrix",s),c.material.setUniform("realModelViewMatrixInverse",(new e.Matrix4).getInverse(s)),o.map||(o.map=this.volumeManager.getFreeTexture(n),o.map.image=o.mapData,o.map.needsUpdate=!0),c.material.setUniform("map0",o.map),c.material.setUniform("minDisplayValue",this.volumeManager.minValue),c.material.setUniform("maxDisplayValue",this.volumeManager.maxValue),c.material.setUniform("rangeDisplayValue",this.volumeManager.maxValue-this.volumeManager.minValue),c.material.setUniform("minTileValue",n.data.tileSetRange.min),c.material.setUniform("maxTileValue",n.data.tileSetRange.max),c.material.setUniform("rangeTileValue",n.data.tileSetRange.max-n.data.tileSetRange.min),c.material.setUniform("mapDim",o.mapDim),c.material.setUniform("nbCol",o.nbCol),this.debugChunkBox){c.material.setUniform("debugChunkBox",new e.Vector4(.01,.01,.01,.05))}else c.material.setUniform("debugChunkBox",new e.Vector4(0,0,0,0));t?(this.tmpResult=this.composers[0].composerContext.getResult("main",!0),c.setLinkedInput(this.tmpResult,0)):c.setLinkedInput(this.renderIsoSurface?this.initTextureIso:this.initTexture,0),this.activatePass(c),this.composers[0].render(void 0,void 0,void 0,"main"),this.tmpResult&&(this.renderTargetPool.pushRenderTarget(this.tmpResult),this.tmpResult=null)}}this.avgDensity/=this.volumeManager.volumeChunks.length,this.debugInfos&&this.volumeManager&&this.volumeManager.updateBinnedMap()}},activatePass:function(e){for(var s=0;s<this.effectVolumePasses.length;s++){var t=this.effectVolumePasses[s];this.composers[0].enablePass(t,t===e)}},setSize:function(e,s,t){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height,t)}})}),define("DS/Effects/ComputeMipMapRoughness",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/PreConvolutionShaderBuilders","DS/ShaderBuilders/PostPro/MergeShaderBuilders","DS/ShaderBuilders/PostPro/ImageOperationShaderBuilders"],function(e,s,t,i,r,a,n){"use strict";const o="true"===localStorage.getItem("__WebVisu_LinearFilter_IBL__");var h=s.extend({init:function(s,t){return this._parent(s),this.gl=this.renderer.context,this.renderTargetPool=t,this.nbSamples=64,this.nbIterations=32,this._nbSamplerPerIteration=e._mobileDevice?4:e.IsIE11?2:32,this._sizeRatio=e._mobileDevice?.5:1,this.passFilterEnvMap=[],this.passMergeMips=null,this.passFlipX=null,this.modeValue=0,this.shader=null,this.texture=null,this.nbMipMaps=7,this.inputLods=10,this},setSize:function(s,t){this.width="string"==typeof s?parseInt(s):s,this.height="string"==typeof t?parseInt(t):t,this.inputLods=Math.min(Math.round(Math.log(Math.min(this.width,this.height))/Math.log(2)),e.supportedExtensions.fragmentTextureUnits)},_updatePassFilter:function(e){var s=this.getCoeff(e+1);const t=this.passFilterEnvMap[e];t.setLinkedInput(this.texture,0);const i=t.material;i.defines.NB_SAMPLES=s*this.nbSamples,i.defines.NB_SAMPLES_IT=s*this._nbSamplerPerIteration,i.defines.MAX_LOD=this.inputLods,i.defines.MODE=6===e?3:this.modeValue,i.defines.LOD_CST=(.5*Math.log(this.width*this.height/(s*this.nbSamples))/Math.log(2)).toFixed(8),i.needsUpdate=!0,i.setUniform("roughness",this.getRoughness(e+1))},setNbSamples:function(e){this.nbSamples=e,this.nbIterations=this.nbSamples/this._nbSamplerPerIteration;for(var s=1;s<=this.nbMipMaps;s++)this._updatePassFilter(s-1)},getCoeff:function(e){return 1===this.modeValue||4===this.modeValue?e<3?3:2:e>3?4:1},getRoughness:function(e){var s=0;switch(this.modeValue){case 0:case 3:s=Math.pow(2,(e-6)/1.15);break;case 1:case 4:s=1-(e-1)/5;break;case 2:s=(e-1)/5;break;default:throw"invalid mode in compute mip map roughness effect"}return s},setMode:function(s){switch(this.modeValue=0,s){case e._BRDFS.ASHIKMIN:this.modeValue=1;break;case e._BRDFS.BECKMANN:this.modeValue=2;break;case e._BRDFS.ESTEVEZKULLA:this.modeValue=4}for(var t=1;t<=this.nbMipMaps;t++)this._updatePassFilter(t-1)},setInput:function(s){if(!this.texture){this.texture=s,this.hasOwnProperty("iter")&&(this.iter=0);for(var r=[1,1,.5,.5,.25,.25,.25,.25],a=1;a<=this.nbMipMaps;a++){var n=a-1,o=this._sizeRatio*r[a]*this.width,h=this._sizeRatio*r[a]*this.height;if(this.composers[n])this.composers[n].setSize(o,h);else{var l=new e.WebGLRenderTargetProperties(o,h,"maxPrecisionLinearNoStencilHFMobile");l.generateMipmaps=!1,l.mapping=this.texture.mapping,this.composers[n]=new t(this.renderer,l,this.renderTargetPool),this.composers[n].composerContext.keepResult=!0,this.composers[n].composerContext.noIdCheck=!0,this.passFilterEnvMap[n]=new i(this.shader),this.composers[n].addPass(this.passFilterEnvMap[n])}this._updatePassFilter(n)}this.setComposers()}},setComposers:function(){var s=this.nbMipMaps;if(this.composers[s])this.composers[s].setSize(this._sizeRatio*this.width,2*this._sizeRatio*this.height);else{var r=new e.WebGLRenderTargetProperties(this._sizeRatio*this.width,2*this._sizeRatio*this.height,o?"iblUintLinear":"iblUintNearest");r.generateMipmaps=!1,this.composers[s]=new t(this.renderer,r,this.renderTargetPool),this.composers[s].composerContext.keepResult=!0,this.composers[s].composerContext.noIdCheck=!0,this.passMergeMips=new i(a.RoughnessMipsMerge),this.passMergeMips.material.setUniform("offset0",new e.Vector2(0,.5)),this.passMergeMips.material.setUniform("scale0",new e.Vector2(1,.5)),this.passMergeMips.material.setUniform("offset1",new e.Vector2(0,.25)),this.passMergeMips.material.setUniform("scale1",new e.Vector2(.5,.25)),this.passMergeMips.material.setUniform("offset2",new e.Vector2(.5,.25)),this.passMergeMips.material.setUniform("scale2",new e.Vector2(.5,.25)),this.passMergeMips.material.setUniform("offset3",new e.Vector2(0,.125)),this.passMergeMips.material.setUniform("scale3",new e.Vector2(.25,.125)),this.passMergeMips.material.setUniform("offset4",new e.Vector2(.25,.125)),this.passMergeMips.material.setUniform("scale4",new e.Vector2(.25,.125)),this.passMergeMips.material.setUniform("offset5",new e.Vector2(.5,.125)),this.passMergeMips.material.setUniform("scale5",new e.Vector2(.25,.125)),this.passMergeMips.material.setUniform("offset6",new e.Vector2(.75,.125)),this.passMergeMips.material.setUniform("scale6",new e.Vector2(.25,.125)),this.passMergeMips.renderToScreen=!1,this.passFlipX=new i(n.FlipX),this.composers[s].addPass(this.passMergeMips),this.composers[s].addPass(this.passFlipX);for(var h=1;h<=this.nbMipMaps;h++){var l=h-1;this.composers[l].linkToShaderPassUniform(this.passMergeMips,this.passMergeMips.getInput(l))}}},dispose:function(){s.prototype.dispose.call(this),this.texture&&this.texture.dispose()},_saveResult:function(){var s=this._sizeRatio*this.width,t=2*this._sizeRatio*this.height,i=new Uint8Array(s*t*4);this.gl.readPixels(0,0,s,t,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i);var r=e.ImageUtils.streamHDRFormat(i,s,t),a=URL.createObjectURL(r),n=document.createElement("a");n.download="generated_rmips.hdr",n.href=a,e._DownloadGeneratedRoughnessMaps&&n.click()}});return{ComputeMipMapRoughnessFIS:h.extend({init:function(e,s){return this._parent(e,s),this.shader=r.FIS,this},execute:function(e){if(void 0!==e)this.composers[e].render();else{for(var s=0;s<this.nbMipMaps;s++)this.modeValue>0&&6===s||this.execute(s);this.composers[this.nbMipMaps].render()}}}),ComputeMipMapRoughnessIterative:h.extend({init:function(s,t){this._parent(s,t),this.iter=0,this.shader=r.Iterative;for(var i=new Uint8Array(16),a=0;a<16;a++)i[a]=0;return this.initTexture=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this},execute:function(e){if(!(this.iter>=this.nbIterations)){var s=this.iter;if(void 0!==e){var t=this.composers[e].composerContext.getResult(void 0,!0);const i=this.passFilterEnvMap[e];i.setLinkedInput(s?t:this.initTexture,1);const r=s*i.material.defines.NB_SAMPLES_IT;i.material.setUniform("firstSample",r),this.composers[e].render(),t&&(s===this.nbIterations-1?t.dispose():this.renderTargetPool.pushRenderTarget(t))}else{for(var i=0;i<this.nbMipMaps;i++)this.modeValue>0&&6===i||this.execute(i);this.iter++,this.composers[this.nbMipMaps].render()}}}})}}),define("DS/Effects/AbstractSSAOEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/SSAOShaderBuilders","DS/ShaderBuilders/PostPro/BlurShaderBuilders"],function(e,s,t,i,r,a,n){"use strict";return t.extend({init:function(s,t,r,a){this._parent(s);this.__renderer=s,this._randomTexture=null,this._samplingPoints=null,this.shaderName=r,this.effectName=a,this.effectSSAO=null,this.effectSSAOBlurH=null,this.effectSSAOBlurV=null;var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uintRGBLinearNoStencil"),o=new i(s,n,t);return o.composerContext.keepResult=!0,o.composerContext.name=r+a+"ComposerContext",this.composers.push(o),this.isDynamicRadius=!0,this.isAdaptativeRadius=!0,this.influenceRadius=.04,this.minPixelRadius=14,this.maxPixelRadius=400,this.minRadius=.01,this.maxRadius=.12,this.slotAngle=1.35,this.attenuation=1,this.nbSamples=-1,this._initPasses(),this.setStrength(.95),this.influenceRadius=.2,this.setNbSamples(16),this.setSize(this.width,this.height,!0),this},getRandomTexture:function(){return this._randomTexture},getSamplingPoints:function(){return this._samplingPoints},initEffect:function(e,s){var t=s.getComposer("normalDepth");t.linkToShaderPassUniform(this.effectSSAO,this.effectSSAO.getInput()),t.linkToShaderPassUniform(this.effectSSAOBlurH,this.effectSSAOBlurH.getInput(1)),t.linkToShaderPassUniform(this.effectSSAOBlurV,this.effectSSAOBlurV.getInput(1))},update:function(e,s,t,i,r,a){var n=t._renderedCamera;n.projectionMatrixInverse.getInverse(n.projectionMatrix);var o=s.getBoundingSphere(),h=this.isDynamicRadius?this.influenceRadius*o.radius:this.influenceRadius,l=Math.max(this.minPixelRadius/this.width,this.minRadius),p=Math.min(this.maxPixelRadius/this.width,this.maxRadius);this.effectSSAO.material.setUniform("realProjectionMatrix",n.projectionMatrix),this.effectSSAO.material.setUniform("realProjectionMatrixInverse",n.projectionMatrixInverse),this.effectSSAO.material.setUniform("radius",h),this.effectSSAO.material.setUniform("minRadius",l),this.effectSSAO.material.setUniform("maxRadius",p),this.effectSSAO.material.setUniform("attenuation",this.attenuation)},setDynamicRadius:function(e){this.isDynamicRadius=e},setAdaptativeRadius:function(e){this.isAdaptativeRadius!==e&&(this.isAdaptativeRadius=e,this.effectSSAO.material.defines.ADAPTATIVE_RADIUS=e,this.effectSSAO.material.needsUpdate=!0)},setRadius:function(e){this.influenceRadius=Math.max(0,e)},setRadiusRange:function(e,s){this.minRadius=Math.min(Math.max(0,e),1),this.maxRadius=Math.min(Math.max(0,s),1)},setMinPixelRadius:function(e){this.minPixelRadius=Math.max(0,e)},setAttenuation:function(e){this.effectSSAO&&(this.attenuation=Math.max(0,e),this.effectSSAO.material.setUniform("attenuation",this.attenuation))},setContrast:function(e){},setStrength:function(e){},setPower:function(e){},setThresholdAngle:function(e){this.slotAngle=e,this.effectSSAO.material.setUniform("thresholdAngle",Math.cos(e))},setNbSamples:function(e){e!==this.nbSamples&&(this.nbSamples=e,this.effectSSAO.material.setUniform("nbSamples",Math.min(e,32)))},setSize:function(s,t,i,r){if(this._parent(s,t)||i){this.composers[0].setSize(this.width,this.height,r);var a=new e.Vector2(1/this.width,1/this.height);this.effectSSAO.material.setUniform("invSize",a),this.effectSSAOBlurH.material.setUniform("invSize",a),this.effectSSAOBlurV.material.setUniform("invSize",a)}},_initPasses:function(){if(!this.effectSSAO){this.effectSSAO=new r(a[this.shaderName],void 0,this.shaderName+this.effectName),this.effectSSAO.order=10,this.effectSSAO.material.setUniform("tRandomTexture",this.getRandomTexture());var e=this.getSamplingPoints();e&&this.effectSSAO.material.setUniform("samplingPoints",e),this.composers[0].addPass(this.effectSSAO)}this.effectSSAOBlurH||(this.effectSSAOBlurH=new r(n.BlurAdaptativeH,this.shaderName+this.effectName+"BlurH"),this.effectSSAOBlurH.material.defines.NB_SAMPLES=3,this.effectSSAOBlurH.material.defines.STEP="1.5",this.effectSSAOBlurH.order=100,this.effectSSAOBlurV=new r(n.BlurAdaptativeV,this.shaderName+this.effectName+"BlurV"),this.effectSSAOBlurV.material.defines.NB_SAMPLES=3,this.effectSSAOBlurV.material.defines.STEP="1.5",this.effectSSAOBlurV.order=110,this.composers[0].addPass(this.effectSSAOBlurH),this.composers[0].addPass(this.effectSSAOBlurV)),this.composers[0].enablePass(this.effectSSAOBlurH,!0),this.composers[0].enablePass(this.effectSSAOBlurV,!0),this.composers[0].enablePass(this.effectSSAO,!0)},getMaxIteration:function(){return 0},execute:function(e){return this.composers[0].render(void 0,void 0,e,"SSAO"),this.composers[0].composerContext}})}),define("Effects/AbstractSSAOEffect",["DS/Effects/AbstractSSAOEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/AbstractSSAOEffect"),e}),define("DS/Effects/SSAOIterativeEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractSSAOEffect"],function(e,s){"use strict";return s.extend({init:function(s,t){this._parent(s,t,"Iterative","SSAOIterativeEffect");this.tmpResult=null,this.renderTargetPool=t;for(var i=new Uint8Array(16),r=0;r<4;r++)i[4*r]=255,i[4*r+1]=255,i[4*r+2]=255,i[4*r+3]=255;return this.initTexture=new e.DataTexture(i,2,2,e.RGBAFormat,e.UnsignedByteType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearFilter),this.initTexture.generateMipmaps=!1,this.initTexture.needsUpdate=!0,this.renderer.setTexture(this.initTexture,0),this},getRandomTexture:function(){if(!this._randomTexture){var s=e.RandomLib.computeHaltonSequence4D(64);s.minFilter=e.NearestFilter,s.magFilter=e.NearestFilter,s.needsUpdate=!0,this._randomTexture=s}return this._randomTexture},update:function(e,s,t,i,r,a){this._parent(e,s,t,i,r,a);var n=--i<(this.nbSamples>8?this.nbSamples>16?20:40:80);this.composers[0].enablePass(this.effectSSAO,i>=0),this.composers[0].enablePass(this.effectSSAOBlurH,n),this.composers[0].enablePass(this.effectSSAOBlurV,n),this.effectSSAO.material.setUniform("firstSample",this.nbSamples*i)},getMaxIteration:function(){return 128}})}),define("DS/Effects/AbstractHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New"],function(e,s,t,i){"use strict";return s.extend({init:function(s,r,a,n,o,h){this._parent(s),this.sceneGraphSelection=null,this.idString=n||"main",this.prefix=o;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.effectComp=new t(s,l,r),this.effectComp.keepResult=!0,this.effectComp.composerContext.name=a+"ComposerContext",this.composers.push(this.effectComp),this.hlClearPass=null,this.hlRenderPass=null,this.mixPass=new i(h,a);var p=[];return p[0]=-.326212,p[1]=-.405805,p[2]=-.840144,p[3]=-.07358,p[4]=-.695914,p[5]=.457137,p[6]=-.203345,p[7]=.620716,p[8]=.96234,p[9]=-.194983,p[10]=.473434,p[11]=-.480026,p[12]=.519456,p[13]=.767022,p[14]=.185461,p[15]=-.893124,p[16]=.507431,p[17]=.064425,p[18]=.530992,p[19]=.412458,p[20]=-.32194,p[21]=-.871945,p[22]=-.791559,p[23]=.597705,this.mixPass.material.setUniform("poisson",p),this},initEffect:function(e,s){e&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.mixPass.addRequiredComposer(this.composers[0]),this.v6Renderer=s},updateUniforms:function(e){var s=new Array(e.length+1),t=s.length;s[0]=this.sceneGraphSelection.sceneHL;for(var i=1;i<t;i++)s[i]=e[i-1].sceneHL;var r=this.mixPass.material.defines,a=this.mixPass.material,n=r.NB_CONFIG,o=r.HALO_THICKNESS,h=r.HAS_POLITE,l=this.composers[0].renderer,p=l.isQAAutomationMode()?1:0,c=r.QA_AUTOMATION,m=0;t!==n&&(this._updateMixPassShader(t),a.setUniform("iHaloColors",new Array(4*t)),a.setUniform("iLineicHaloColors",new Array(4*t)),a.setUniform("iColors",new Array(4*t)),a.setUniform("iOutlineColors",new Array(4*t)),a.setUniform("iLineicOutlineColors",new Array(4*t)));for(i=0;i<t;i++){var d=s[i],u=d.highlightData,f=d.getNbWebGLObjects(this.idString)+d.__objectsAdded.size;m+=f,u._needsDepth&&f>0&&l.requestPoliteDepthBuffer(),r.HALO_THICKNESS=Math.max(Math.ceil(l._renderScale*l._renderScale*u.haloThickness),1),u._updateMixPassUniforms(a,i+1)}r.NB_CONFIG=t,r.QA_AUTOMATION=p,r.HAS_POLITE=l._politeDBufferNextFrame&&"true"===localStorage.getItem("__WEBVISU_NEWHL_POC__")&&!p?1:0,a.setUniform("empty",m>0?1:0),(r.NB_CONFIG!==n||r.HALO_THICKNESS!==o||r.HAS_POLITE!==h||r.QA_AUTOMATION!==c)&&this.mixPass.compileShader(l),(this.v6Renderer.isBridge||"Canvas2DHighlightEffect"!==this.mixPass.name)&&this._setEnabledInternal(m>0)},_updateMixPassShader:function(e){},setSize:function(e,s,t){this._parent(e,s)&&(this.composers[0].setSize(this.width,this.height,t),this.mixPass.material.setUniform("h",1/this.width),this.mixPass.material.setUniform("v",1/this.height))},setEnabled:function(e){this.composers[0].composerContext.enablePass(this.hlRenderPass,e),e&&this._parent(e)}})}),define("Effects/AbstractHighlightEffect",["DS/Effects/AbstractHighlightEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/AbstractHighlightEffect"),e}),define("DS/Effects/AbstractSSRayMarchingEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/SSLRShaderBuilders","DS/ShaderBuilders/PostPro/DownSamplingShaderBuilders"],function(e,s,t,i,r,a,n){"use strict";return t.extend({init:function(s,t,o,h){this._parent(s);this.nbMips=7;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"linear");this.composers.push(new i(s,l,t)),this.composers[0].composerContext.keepResult=!0,this.composers[0].composerContext.name=o+"RayMarchingComposerContext",this.passRayMarching=new r(a[o],o+"RayMarching"),this.composers[0].addPass(this.passRayMarching);var p=.5;this.passMip=new Array(this.nbMips);for(var c=0;c<this.nbMips;c++){var m=new e.WebGLRenderTargetProperties(p*this.width,p*this.height,"linear");this.composers[c+1]=new i(s,m,t),this.composers[c+1].composerContext.keepResult=!1,this.composers[c+1].composerContext.name=o+"GenerateMips"+c+"ComposerContext",this.composers[c+1].composerContext.noIdCheck=!0,this.passMip[c]=new r(n.DownSamplingBlurWithAlpha,o+"GenerateMips"+c),this.passMip[c].material.setUniform("invSize",new e.Vector2(1/(p*this.width),1/(p*this.height))),this.passMip[c].material.needsUpdate=!0,this.passMip[c].renderToScreen=!1,this.composers[c+1].addPass(this.passMip[c]),p*=.5}this.composers[this.nbMips+1]=new i(this.renderer,l,t),this.composers[this.nbMips+1].composerContext.keepResult=!0,this.composers[this.nbMips+1].composerContext.name=o+"SolverComposerContext",this.passSolver=new r(a[h],o+"Solver"),this.composers[this.nbMips+1].addPass(this.passSolver),this.passMip[0].addRequiredComposer(this.composers[0]),this.composers[0].linkToShaderPassUniform(this.passMip[0],this.passMip[0].getInput());for(c=1;c<this.nbMips;c++)this.passMip[c].addRequiredComposer(this.composers[c]),this.composers[c].linkToShaderPassUniform(this.passMip[c],this.passMip[c].getInput());this.passSolver.addRequiredComposer(this.composers[this.nbMips]),this.composers[0].linkToShaderPassUniform(this.passSolver,this.passSolver.getInput(0));for(c=0;c<this.nbMips;c++)this.composers[c+1].linkToShaderPassUniform(this.passSolver,this.passSolver.getInput(c+1));return this},update:function(s,t,i,r){i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix),this.passRayMarching.material.setUniform("realProjectionMatrixInverse",i._renderedCamera.projectionMatrixInverse),this.passSolver.material.setUniform("realProjectionMatrixInverse",i._renderedCamera.projectionMatrixInverse),this.passRayMarching.material.setUniform("realProjectionMatrix",i._renderedCamera.projectionMatrix),this.passRayMarching.material.setUniform("renderIteration",r),this.passSolver.material.setUniform("renderIteration",r);var a=t.getBoundingSphere();this.passRayMarching.material.setUniform("sceneSize",a.radius),this.passSolver.material.setUniform("sceneSize",a.radius);var n=new e.Frustum;n.setFromMatrix(i._renderedCamera.projectionMatrix);for(var o=[],h=0;h<6;h++){var l=n.planes[h],p=l.normal;o[4*h]=p.x,o[4*h+1]=p.y,o[4*h+2]=p.z,o[4*h+3]=l.constant}this.passRayMarching.material.setUniform("frustumPlanes",o)},execute:function(){return this.composers[this.nbMips+1].render(void 0,void 0,null,"RayMarching"),this.composers[this.nbMips+1].composerContext},setSize:function(s,t,i){if(this._parent(s,t,i)){this.composers[0].setSize(this.width,this.height,i),this.passRayMarching.material.setUniform("screenSize",new e.Vector2(this.width,this.height));for(var r=.5,a=0;a<this.nbMips;a++)this.composers[a+1].setSize(r*this.width,r*this.height,i),this.passMip[a].material.setUniform("invSize",new e.Vector2(1/(r*this.width),1/(r*this.height))),r*=.5;this.composers[this.nbMips+1].setSize(this.width,this.height,i)}}})}),define("DS/Effects/SSLReflectionEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/AbstractSSRayMarchingEffect"],function(e,s,t){"use strict";return t.extend({init:function(e,s){return this._parent(e,s,"SSLReflection","SSLReflectionMipSolver"),this},initEffect:function(e,s){s.getComposer("color").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.getInput(0));var t=s.getComposer("normalDepthIoRRoughness");t.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.getInput(1)),t.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.getInput(2)),t.linkToShaderPassUniform(this.passSolver,this.passSolver.getInput(8))}})}),define("DS/Effects/SSLRefractionEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/AbstractSSRayMarchingEffect"],function(e,s,t){"use strict";return t.extend({init:function(e,s){return this._parent(e,s,"SSLRefraction","SSLRefractionMipSolver"),this},initEffect:function(e,s){s.getComposer("opaque").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.getInput(0)),s.getComposer("normalDepth").linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.getInput(1));var t=s.getComposer("normalDepthIoRRoughness");t.linkToShaderPassUniform(this.passRayMarching,this.passRayMarching.getInput(2)),t.linkToShaderPassUniform(this.passSolver,this.passSolver.getInput(8))},update:function(e,s,t,i){this._parent(e,s,t,i)}})}),define("DS/Effects/HighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractHighlightEffect","DS/Plugins/RenderPass","DS/ShaderBuilders/PostPro/HighlightShaderBuilders","DS/Plugins/ClearPass"],function(e,s,t,i,r){"use strict";var a=function(e){e.clear(!1,!0,!1)};return s.extend({init:function(e,s,t,r,a=null){return a=a||null,this._parent(e,s,r+"HighlightEffect",t,r,a||i.FinalBlending),this.scenes=[],this.mixPass.enableWarmStart=null===t,this},update:function(s,i,n,o,h){var l=this.composers[0].renderer;this.sceneGraphSelection=i.selectionHL,null===this.hlRenderPass&&(this.hlClearPass=new r(this.prefix+"hlClearPass"),this.hlRenderPass=new t(i.selectionHL.sceneHL,null,null,void 0,void 0,void 0,this.prefix+"hlRenderPass"),this.hlRenderPass.setDisableBackFaceCulling(!0),this.hlRenderPass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.hlRenderPass.cameraName="mainNoJittering",this.hlRenderPass.idString=this.idString,this.composers[0].addPass(this.hlClearPass),this.composers[0].addPass(this.hlRenderPass),this.composers[0].composerContext.setPassClear(this.hlClearPass,!0,new e.Color(0),0));var p=l.isQAAutomationMode(),c=this.scenes,m=[];this.sceneGraphSelection._updateScene(i.scene),this.sceneGraphSelection.enabled&&m.push(this.sceneGraphSelection.sceneHL);for(var d=0;d<c.length;d++){var u=c[d];u._updateScene(i.scene),u.enabled&&m.push(u.sceneHL)}var f=m.length;m.sort(function(e,s){return e.highlightData.priority-s.highlightData.priority}),this.hlRenderPass.setMultiRenderCB(function(e,s){if(s<f){e.scene=m[s];var t=e.scene.highlightData;return e._postRenderCB=null,e._preRenderCB=null,t.clearDepth&&!p&&(t.priority>0&&(e._preRenderCB=a),t.priority<0&&(e._postRenderCB=a)),!0}return!1}),this.hlRenderPass.stateSortingResults.nbScenes()>f&&this.hlRenderPass.stateSortingResults.cleanCache();var[g,S,P]=l.getRenderMode().getMasks();this.hlRenderPass.renderFaceMode=g,this.hlRenderPass.renderLineMode=S,this.hlRenderPass.renderPointMode=P,this.composers[0].composerContext.needsUpdate=0===o||h,this.updateUniforms(c)},addScene:function(e){this.scenes.push(e)},removeScene:function(e){for(var s=[],t=0;t<this.scenes.length;t++)this.scenes[t]!==e?s.push(this.scenes[t]):this.scenes[t].clearAll();this.scenes=s}})}),define("Effects/HighlightEffect",["DS/Effects/HighlightEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/HighlightEffect"),e}),define("DS/Effects/FlareEffect",["WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/ImageOperationShaderBuilders","DS/Shaders/FlareShaders","DS/ShaderBuilders/PostPro/BlurShaderBuilders"],function(e,s,t,i,r,a,n,o,h){"use strict";return t.extend({init:function(t,l){this._parent(t),this.threshold=1,this.passThreshold,this.passBlurH,this.passBlurV,this.passThreshold=new a(n.Threshold);var p;p=new s.WebGLRenderTargetProperties(.5*this.width,.5*this.height,"uint"),this.composers[0]=new i(t,p,l),this.passBlurH=new a(h.BlurH),this.passBlurV=new a(h.BlurV),this.composers[0].addPass(this.passThreshold),this.composers[0].addPass(this.passBlurH),this.composers[0].addPass(this.passBlurV),this.passThreshold.material.setUniform("threshold",this.threshold),this.mixPass=new r(o.FinalBlending,void 0,"FlareEffect");var c=e.getWebappsAssetUrl("Effects",""),m=new s.ImageUtils.loadTexture(c+"lenscolor.png",void 0,null,null,s.ImageUtils.crossOriginPolicy);m.minFilter=s.LinearFilter,m.magFilter=s.LinearFilter;var d=new s.ImageUtils.loadTexture(c+"lensdirt.png",void 0,null,null,s.ImageUtils.crossOriginPolicy);return d.minFilter=s.LinearFilter,d.magFilter=s.LinearFilter,this.mixPass.uniforms.tLensColor.value=m,this.mixPass.uniforms.tLensDirt.value=d,this},initEffect:function(e,s){s.getComposer("result").linkToShaderPassUniform(this.passThreshold,this.passThreshold.getInput()),s.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.uniforms.tBlur),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){},setSize:function(e,t,i){if(this._parent(e,t)){this.composers[0].setSize(.5*this.width,.5*this.height,i);var r=new s.Vector2(1/(.5*this.width),1/(.5*this.height));this.passBlurH.material.setUniform("invSize",r),this.passBlurV.material.setUniform("invSize",r),this.mixPass.uniforms.invSize.value.set(r.x,r.y)}}})}),define("Effects/FlareEffect",["DS/Effects/FlareEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/FlareEffect"),e}),define("DS/Effects/SSAOEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractSSAOEffect"],function(e,s){"use strict";return s.extend({init:function(e,s){this._parent(e,s,"Direct","SSAOEffect");return this},getRandomTexture:function(){if(!this._randomTexture){for(var s=[.960296,.274776,-.0482711,0,-.0217867,.999033,-.0381943,0,-.0281167,.280583,.959418,0,-.0622982,-.0498126,-.996814,0,.762197,.178997,.622106,0,-.610721,.38519,-.691844,0,.209116,-.106236,-.972103,0,-.971866,.0766489,-.222714,0,-.321656,.280776,-.904269,0,.836284,-.48659,.252705,0,-.924106,-.109391,-.366145,0,.110424,.149603,.982561,0,.92149,-.376162,.0967352,0,-.592781,-.0588162,.803213,0,.238876,-.0463654,.969942,0,.728274,-.299609,-.61632,0,-.389309,-.215351,.895579,0,.775002,-.220267,-.59233,0,-.681002,-.359332,-.638056,0,-.13823,-.980038,.142888,0,.860016,-.165527,-.482673,0,-.599353,-.659337,.453928,0,.416823,-.908951,-.00818423,0,-.793046,-.0722135,.604866,0,-.188499,.945449,.265696,0],t=new Float32Array(100),i=0;i<100;i++)t[i]=s[i];this._randomTexture=new e.DataTexture(t,5,5,e.RGBAFormat,e.FloatType,new e.LatLongReflectionMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._randomTexture.generateMipmaps=!1,this._randomTexture.needsUpdate=!0}return this._randomTexture},getSamplingPoints:function(){return this._samplingPoints||(this._samplingPoints=[.334033,-.00485205,-.00401396,0,-.453196,-.267136,.16953,0,-.147833,.413971,-.106289,0,.0909656,-.10026,-.646145,0,.150717,.422825,.407178,0,-.141224,-.0126533,.671199,0,-.568417,.123185,-.109986,0,-.0231788,-.733836,.0740228,0,-.00159637,-498002e-9,.00229559,0,.411656,-.16241,.505242,0,-.373892,.115395,-.594764,0,.236072,.72466,.0524527,0,-.0849139,-.231345,-.121562,0,-.0492975,-.409624,.508015,0,.363041,-.233737,-.358279,0,.209588,.103554,-.290493,0,.401735,-.318318,.174997,0,-.436293,.0988326,.230372,0,-.00129735,-.00939224,-.102806,0,.0474442,.094537,-.0300616,0,-.180245,.307443,.33575,0,.0280045,.00316191,.201276,0,-.487838,-.48419,-.148956,0,-.207171,-.0813871,-.133753,0,.43206,.435895,-.210157,0,-.333923,-.35392,-.450399,0,.314904,-.343625,-.0974952,0,.0534175,-.0530132,-.0137891,0,-.0964412,.115755,.0301087,0,.659795,-.251509,-.00948616,0,.284603,-.679033,.192659,0,-.594049,-.128511,-.149513,0]),this._samplingPoints}})}),define("Effects/SSAOEffect",["DS/Effects/SSAOEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SSAOEffect"),e}),define("DS/Effects/SMAAEffect",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/SMAAShaderBuilders"],function(e,s,t,i,r,a){"use strict";return t.extend({init:function(t,n){this._parent(t);var o=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");this.composer=new i(t,o,n),this.composer.composerContext.name="SMAAEffect",this.composers.push(this.composer),this.edgeDetectionPass=new r(a.EdgeDetection,"SMAA_Edges"),this.edgeDetectionPass.compileShader(t),this.weightComputePass=new r(a.BlendingWeights,"SMAA_Weights"),this.weightComputePass.compileShader(t),this.mixPass=new r(a.FinalBlending,"SMAAEffect"),this.mixPass.compileShader(t),this.composer.addPass(this.edgeDetectionPass),this.composer.addPass(this.weightComputePass);var h=s.getWebappsAssetUrl("Effects",""),l=new e.ImageUtils.loadTexture(h+"AreaTexSMAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);l.minFilter=e.LinearFilter,l.magFilter=e.LinearFilter,this.weightComputePass.material.setUniform("areaTex",l);var p=new e.ImageUtils.loadTexture(h+"SearchTexSMAA.png",void 0,null,null,e.ImageUtils.crossOriginPolicy);return p.minFilter=e.NearestFilter,p.magFilter=e.NearestFilter,this.weightComputePass.material.setUniform("searchTex",p),this.areaTexture=l,this.searchTexture=p,this},initEffect:function(e,s){s.insertComposer(this.composer,this.mixPass),this.composer.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.mixPass.addRequiredComposer(this.composer)},update:function(e,s,t){},setSize:function(e,s,t){this._parent(e,s)&&(this.composer.setSize(this.width,this.height,t),this.edgeDetectionPass.material.setUniform("screenWidth",this.width),this.edgeDetectionPass.material.setUniform("screenHeight",this.height),this.weightComputePass.material.setUniform("screenWidth",this.width),this.weightComputePass.material.setUniform("screenHeight",this.height),this.mixPass.material.setUniform("screenWidth",this.width),this.mixPass.material.setUniform("screenHeight",this.height))},dispose:function(){this._parent(),this.areaTexture.dispose(),this.searchTexture.dispose()}})}),define("Effects/SMAAEffect",["DS/Effects/SMAAEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SMAAEffect"),e}),define("DS/Effects/CompareModelsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/CompareShaderBuilders","DS/Visualization/RenderMode"],function(e,s,t,i,r,a,n,o){"use strict";return s.extend({init:function(e,s){return this._parent(e),this.mixPass=new a(n,"compareModelPass"),this.mixPass.compileShader(e),this.tolerance=.02,this.composerEffects=[],this.forwardContext=null,this.passClearOld=null,this.passColorOld=null,this.passDepthOld=null,this.passDepthNew=null,this.passAll=null,this.passSectionCappingFrontFaces1=null,this.passSectionCappingFrontFaces2=null,this.passSectionCappingFrontFaces3=null,this.v6renderer=null,this.forwardPass=null,this},initEffect:function(s,a){a.compareSettings&&(this.tolerance=a.compareSettings.tolerance);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");n.generateMipmaps=!1;var h=new t(n,a.mainComposer,"colorOldComposerContext");h.keepResult=!0;var l=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");l.generateMipmaps=!1;var p=new t(l,a.mainComposer,"depthOldComposerContext");p.keepResult=!0;var c=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");c.generateMipmaps=!1;var m=new t(c,a.mainComposer,"depthNewComposerContext");m.keepResult=!0,this.composerEffects.push(h),this.composerEffects.push(p),this.composerEffects.push(m),a.customComposerContexts=[],a.customComposerContexts[0]=h,a.customComposerContexts[1]=p,a.customComposerContexts[2]=m;var d=new i("depth_clear_old");d.clearColor=new e.Color(0),d.clearAlpha=0,d.disabledByDefault=!0,this.passClearOld=d;var u=new r(null,null,null,o.facesMask,!1,!1,"color_old");u.idString="compareOld",u.disabledByDefault=!0,this.passColorOld=u;var f=new r(null,null,null,o.facesMask,!1,!1,"depth_old");f.idString="compareOld",f.disabledByDefault=!0,f.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passDepthOld=f;var g=new r(null,null,null,o.facesMask,!1,!1,"depth_new");g.idString="compareNew",g.disabledByDefault=!0,g.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passDepthNew=g;var S=new r(null,null,null,o.facesMask,!1,!1,"all_models");S.disabledByDefault=!0,this.passAll=S,this.passSectionCappingFrontFaces1=new r(null,null,null,o.facesMask,!1,!1,"colorOldCapping"),this.passSectionCappingFrontFaces1.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces1.idString="compareOld",this.passSectionCappingFrontFaces1.setEnableStencilTest(!0),this.passSectionCappingFrontFaces1.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces1.setDisableColorWrite(!0),this.passSectionCappingFrontFaces1.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces1.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces1.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces1.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces1.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces1.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces1.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces1.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces1.ignoreNoZ=!0,this.passSectionCappingFrontFaces1.scene=a.scene,this.passSectionCappingFrontFaces1.disabledByDefault=!0,this.passSectionCappingFrontFaces2=new r(null,null,null,o.facesMask,!1,!1,"depthOldCapping"),this.passSectionCappingFrontFaces2.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces2.idString="compareOld",this.passSectionCappingFrontFaces2.setEnableStencilTest(!0),this.passSectionCappingFrontFaces2.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces2.setDisableColorWrite(!0),this.passSectionCappingFrontFaces2.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces2.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces2.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces2.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces2.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces2.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces2.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces2.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces2.ignoreNoZ=!0,this.passSectionCappingFrontFaces2.scene=a.scene,this.passSectionCappingFrontFaces2.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passSectionCappingFrontFaces2.disabledByDefault=!0,this.passSectionCappingFrontFaces3=new r(null,null,null,o.facesMask,!1,!1,"depthNewCapping"),this.passSectionCappingFrontFaces3.setRenderCuttingElements(!0),this.passSectionCappingFrontFaces3.idString="compareNew",this.passSectionCappingFrontFaces3.setEnableStencilTest(!0),this.passSectionCappingFrontFaces3.setEnableStencilWrite(!0),this.passSectionCappingFrontFaces3.setDisableColorWrite(!0),this.passSectionCappingFrontFaces3.setDisableDepthWrite(!0),this.passSectionCappingFrontFaces3.setStencilFunc("ALWAYS"),this.passSectionCappingFrontFaces3.setStencilOps("INCR_WRAP","DECR_WRAP"),this.passSectionCappingFrontFaces3.setDisableBackFaceCulling(!0),this.passSectionCappingFrontFaces3.setHideSurfacesAndUnclippedMeshes(!0),this.passSectionCappingFrontFaces3.setDisableBackFaceClipPlanes(1),this.passSectionCappingFrontFaces3.setRenderPluginsPre(!1),this.passSectionCappingFrontFaces3.setRenderPluginsPost(!1),this.passSectionCappingFrontFaces3.ignoreNoZ=!0,this.passSectionCappingFrontFaces3.scene=a.scene,this.passSectionCappingFrontFaces3.setMaterialToUse(e.MaterialToUse.depthRGBAMaterial),this.passSectionCappingFrontFaces3.disabledByDefault=!0,a.mainComposer.insertCustomPassAfterPass(d,null),a.mainComposer.insertCustomPassAfterPass(u,d),a.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces1,u),a.mainComposer.insertCustomPassAfterPass(f,this.passSectionCappingFrontFaces1),a.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces2,f),a.mainComposer.insertCustomPassAfterPass(g,this.passSectionCappingFrontFaces2),a.mainComposer.insertCustomPassAfterPass(this.passSectionCappingFrontFaces3,g),a.mainComposer.insertCustomPassAfterPass(S,this.passSectionCappingFrontFaces3),this.v6renderer=a,this.forwardContext=a.compForwardComposerContext,this.forwardPass=a.forwardPass,s&&(this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0),a.insertComposer(null,this.mixPass),h.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),p.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(2)),m.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(3))},update:function(e,s,t){var i=!!this.v6renderer.clippingScene;this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,i),this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,i),this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,i);var r=t._renderedCamera;r.projectionMatrixInverse.getInverse(r.projectionMatrix),this.mixPass.material.setUniform("realProjectionMatrixInverse",r.projectionMatrixInverse),this.mixPass.material.setUniform("tolerance",this.tolerance)},setTolerance:function(e){this.tolerance=e},set2DMode:function(e){e!==this.is2DMode&&(this.is2DMode=e,this.mixPass.material.defines.MODE=this.is2DMode?1:0,this.mixPass.compileShader(this.renderer))},setSize:function(e,s,t){if(this._parent(e,s))for(var i=0;i<this.composerEffects.length;i++)this.composerEffects[i].setSize(e,s,t)},setEnabled:function(e){this._parent(e);var s=!!this.v6renderer.clippingScene;this.composerEffects[0].setPassClear(this.passClearOld,e),this.composerEffects[0].setPassClearDepth(this.passClearOld,e),this.composerEffects[0].enablePass(this.passClearOld,e),this.composerEffects[0].enablePass(this.passColorOld,e),this.composerEffects[0].enablePass(this.passSectionCappingFrontFaces1,s&&e),this.composerEffects[1].setPassClear(this.passClearOld,e),this.composerEffects[1].setPassClearDepth(this.passClearOld,e),this.composerEffects[1].enablePass(this.passClearOld,e),this.composerEffects[1].enablePass(this.passDepthOld,e),this.composerEffects[1].enablePass(this.passSectionCappingFrontFaces2,s&&e),this.composerEffects[2].setPassClear(this.passClearOld,e),this.composerEffects[2].setPassClearDepth(this.passClearOld,e),this.composerEffects[2].enablePass(this.passClearOld,e),this.composerEffects[2].enablePass(this.passDepthNew,e),this.composerEffects[2].enablePass(this.passSectionCappingFrontFaces3,s&&e);for(var t=0;t<3;t++)this.composerEffects[t].enablePass(this.forwardPass,!1),this.composerEffects[t].needsUpdate=e,this.composerEffects[t].enablePass(this.v6renderer.infPlanePass,!1),this.composerEffects[t].enablePass(this.v6renderer.mirrorBlendPass,!1)}})}),define("Effects/CompareModelsEffect",["DS/Effects/CompareModelsEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/CompareModelsEffect"),e}),define("DS/Effects/HighlightMobileEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/HighlightEffect","DS/ShaderBuilders/PostPro/HighlightShaderBuilders"],function(e,s,t){"use strict";return s.extend({init:function(e,s,i,r){return this._parent(e,s,i,r,t.FinalMobileBlending),this}})}),define("Effects/HighlightMobileEffect",["DS/Effects/HighlightMobileEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/HighlightMobileEffect"),e}),define("DS/Effects/BokehDOFEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/DOFShaderBuilders"],function(e,s,t,i){"use strict";return s.extend({init:function(s,r){var a;this._parent(s),this.behaviour=0,this.useCameraInfo=!1,this.mixPass=new t(i.Bokeh,"BokehDOFEffect"),this.defines=this.mixPass.material.defines,this.autofocus=!0,this.distanceToTarget=100,this.lensRadius=1,this.sceneScale=1,this.maxCoC=1,this.iterative=!1,this.maxIteration=128,this.dofOffset=[];var n=0;for(a=0;a<this.maxIteration;a++){var o;do{(o=e.RandomLib.LowDiscrepancy2D(n)).x=2*o.x-1,o.y=2*o.y-1,n++}while(o.length()>1);this.dofOffset.push({x:o.x,y:o.y})}return this.dofOffset.sort(function(e,s){return e.x*e.x+e.y*e.y<s.x*s.x+s.y*s.y?-1:1}),this},initEffect:function(e,s){s.insertComposer(null,this.mixPass),s.getComposer("normalDepth").linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1))},update:function(s,t,i){if(i._renderedCamera.projectionMatrixInverse.getInverse(i._renderedCamera.projectionMatrix),this.mixPass.material.setUniform("realProjectionMatrixInverse",i._renderedCamera.projectionMatrixInverse),this.useCameraInfo){var r=i.camera;if(r instanceof e.PerspectiveCamera){var a=r.focalLength;this.mixPass.material.setUniform("focalLength",a),this.lensRadius=a,this.mixPass.material.setUniform("fstop",r.aperture),this.mixPass.material.setUniform("sensorSize",r.sensorSizeHeight)}}this.autofocus&&(this.distanceToTarget=i.getTargetDistance(),this.mixPass.material.setUniform("focalDepth",this.distanceToTarget*this.sceneScale))},updateFocalPlane:function(e){this.distanceToTarget=e,this.mixPass.material.setUniform("focalDepth",e)},updateFocalLength:function(e){this.mixPass.material.setUniform("focalLength",e),this.lensRadius=e},updateFStop:function(e){this.mixPass.material.setUniform("fstop",e)},updateAperture:function(e){0==e?this.mixPass.material.setUniform("fstop",999999999):this.mixPass.material.setUniform("fstop",this.mixPass.material.getUniform("focalLength")/e)},setSceneScale:function(e){this.sceneScale=e,this.mixPass.material.setUniform("sceneScale",e)},setMaximumCircleOfConfusion:function(e){this.maxCoC=Math.max(Math.min(e,1),0),this.mixPass.material.setUniform("maxCoC",this.maxCoC)},setAutoFocus:function(e){this.autofocus=e},setSize:function(e,s){this._parent(e,s)&&(this.mixPass.material.setUniform("textureWidth",e),this.mixPass.material.setUniform("textureHeight",s))},setIterative:function(e){if(e!==this.iterative&&(this.iterative=e,this.mixPass)){var s=this.mixPass.composer;s&&s.contexts.length&&s.contexts[0].enablePass(this.mixPass,this.enabled&&!this.iterative)}},getMaxIteration:function(){return this.maxIteration},computeJitterCamera:function(s,t,i){var r=this.width/this.height,a=s.clone();a._renderingRole=s._renderingRole;var n=a.near*Math.tan(e.Math.degToRad(.5*a.fov)),o=r*n,h=Math.min(this.getMaxIteration()-1,t),l=this.mixPass.material.getUniform("focalDepth"),p=a.near*this.lensRadius*this.dofOffset[h].x/l,c=a.near*this.lensRadius*this.dofOffset[h].y/l,m=o-p,d=-(o+p),u=n-c,f=-(n+c);i&&(i.x*=2*Math.abs(o),i.y*=2*Math.abs(n),d+=i.x,m+=i.x,f+=i.y,u+=i.y);var g=a.getLookAt().cross(a.up);return a.position.add(a.up.clone().multiplyScalar(this.lensRadius*this.dofOffset[h].y)),a.position.add(g.clone().multiplyScalar(this.lensRadius*this.dofOffset[h].x)),a.projectionMatrix.makeFrustum(d,m,f,u,a.near,a.far),a.updateMatrix(),a},Behaviours:{LOW:0,MEDIUM:1,HIGH:2,ARTISTIC:3},setBehaviour:function(e){null!=e&&this.behaviour!=e&&(this.behaviour=e,this.defines.DOF_BEHAVIOUR=this.behaviour,this.defines.RINGS=0==this.behaviour?3:5,this.defines.SAMPLES=0==this.behaviour?8:15,this.mixPass.material.needsUpdate=!0)}})}),define("Effects/BokehDOFEffect",["DS/Effects/BokehDOFEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/BokehDOFEffect"),e}),define("DS/Effects/XRevealStructureEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders"],function(e,s,t,i){"use strict";return s.extend({init:function(s,t){return this._parent(s),this.Stages={back:0,midle:1,front:2},this.rtPool=t,this.name="remoteImage",this._mixPasses=[],this._position=2,this._texture=new e.DataTexture(new Uint8Array([0,0,0,0]),1,1,e.RGBAFormat,e.UnsignedByteType),this._defaultTexture=this._texture,this._texture.needsUpdate=!0,this._textures=new Map,this.mixPass=null,this},setPosition(e){this._position=e;var s=this.mixPass.composer;s&&s.contexts.length&&s.contexts[0].enablePass(this.mixPass,!1),this.mixPass=this._mixPasses[e],this.mixPass.setInput(this._texture,1),s&&s.contexts.length&&s.contexts[0].enablePass(this.mixPass,this.enabled)},_buildMixPass(e,s,r){e?(this.mixPass=new t(i.TextureAlphaBlend,r),this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.mixPass.material.depthTest=!1):this.mixPass=new t(i.TextureAlphaBlend,r),s.insertComposer(null,this.mixPass);var a=this.mixPass.composer;a&&a.contexts.length&&a.contexts[0].enablePass(this.mixPass,!1)},initEffect:function(e,s){for(var t=this.name,i=0;i<3;i++)this._buildMixPass(e,s,t+"_"+i),this._mixPasses[i]=this.mixPass;this.setPosition(this.Stages.front)},update:function(s,t,i){if(i.camera.fullWidth){var r=-i.camera.x/i.camera.width,a=-(i.camera.fullHeight-i.camera.height-i.camera.y)/i.camera.height;this.mixPass.material.setUniform("offset",new e.Vector2(r,a));var n=i.camera.width/i.camera.fullWidth,o=i.camera.height/i.camera.fullHeight;this.mixPass.material.setUniform("invSize",new e.Vector2(n,o))}else this.mixPass.material.setUniform("offset",new e.Vector2(0,0)),this.mixPass.material.setUniform("invSize",new e.Vector2(1,1));let h;h=null!=i.getCsiUID()&&this._textures.has(i.getCsiUID())?this._textures.get(i.getCsiUID()):this._texture,this.mixPass.setInput(h,1)},getTexture:function(e){return null!=e&&null!=e?this._textures.get(e):this._texture},updateTexture:function(e,s){this.mixPass&&(null==e&&(e=this._defaultTexture),null!=s&&null!=s?this._textures.set(s,e):(this._texture=e,this.mixPass.setInput(this._texture,1)))},clearTextures:function(){this._textures=new Map},setSize:function(e,s,t){this._parent(e,s,t)}})}),define("Effects/XRevealStructureEffect",["DS/Effects/XRevealStructureEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/XRevealStructureEffect"),e}),define("DS/Effects/SpatialOccupationEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/RenderPass","DS/Plugins/ClearPass"],function(e,s,t,i,r){"use strict";return s.extend({init:function(s,a){var n;switch(this._parent(s.renderer.renderer),a.filtering){case"linear":n="uint";break;case"nearest":default:n="uintNearest"}var o=a.name?a.name:"offScreenPass";this.viewer=s,this.renderer=s.renderer.renderer;var h=s.renderer.renderTargetPool;return this.sceneGraph=s.internalSceneGraph,this.viewpoint=s.viewpoints[0],this.width=a.targetWidth?a.targetWidth:s.SCREEN_WIDTH,this.height=a.targetHeight?a.targetHeight:s.SCREEN_HEIGHT,this.renderTarget=new e.WebGLRenderTargetProperties(this.width,this.height,n),this.composers.push(new t(this.renderer,this.renderTarget,h)),this.composers[0].composerContext.keepResult=!1,this.renderPass=new i(null,null,null,void 0,void 0,void 0,o),this.renderPass.idString=o,this.renderPass.setMaterialToUse(e.MaterialToUse.pickingMaterial),this.clearPass=new r("customClearPass"),this.composers[0].addPass(this.clearPass),this.composers[0].addPass(this.renderPass),this.composers[0].composerContext.enablePass(this.renderPass,!0),this.renderPass.setScene(this.sceneGraph.scene),this.composers[0].composerContext.setPassClear(this.clearPass,!0,new e.Color(0),1),this.renderPass.renderFaceMode=this.renderer.renderFaceMode,this.renderPass.renderLineMode=this.renderer.renderLineMode,this.renderPass.renderPointMode=this.renderer.renderPointMode,this.renderPass.renderSurfacicPoints=this.renderer.renderSurfacicPoints,this},renderResult:function(e){this._setSize(this.width,this.height),this.composers[0].updateScene(this.sceneGraph.scene);var s=this.renderer.context,t={main:this.viewpoint._renderedCamera,connectedRobotCamera:this.viewpoint.connectedRobotCamera,robotCameraOrtho:this.viewpoint.robotCameraOrtho},i=this.viewpoint._renderedCamera.pixelCulling;this.viewpoint.setPixelCulling(i*Math.min(this.width/this.viewer.SCREEN_WIDTH,this.height/this.viewer.SCREEN_HEIGHT)),this.composers[0].render(void 0,void 0,t,"main"),this.viewpoint.setPixelCulling(i);var r=new Uint8Array(4*this.width*this.height);if(s.readPixels(0,0,this.width,this.height,s.RGBA,s.UNSIGNED_BYTE,r),e.flipImage){for(var a=this.width,n=this.height,o=new Array,h=0;h<n;h++)for(var l=0;l<a;l++)for(var p=0;p<4;p++)o.push(r[4*a*(n-1-h)+4*l+p]);return{data:o,width:a,height:n}}return{data:r,width:this.width,height:this.height}},_setSize:function(e,s,t){this._parent(e,s),this.composers[0].setSize(e,s,t),this.width=e,this.height=s}})}),define("Effects/SpatialOccupationEffect",["DS/Effects/SpatialOccupationEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/SpatialOccupationEffect"),e}),define("DS/Effects/OITEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ComposerContext","DS/Plugins/EffectComposer","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/OITShaderBuilders","DS/ShaderBuilders/PostPro/FXAAShaderBuilders"],function(e,s,t,i,r,a,n,o,h){"use strict";return s.extend({init:function(s,t,r,a){this._parent(s),this.stateSortingResultFrom=r,this.rtPool=t,this.name=a;var n=new e.WebGLRenderTargetProperties(this.width,this.height,"oitAccumLinear");n.generateMipmaps=!1;var o=new e.WebGLRenderTargetProperties(this.width,this.height,"oitRevealLinear");return o.generateMipmaps=!1,this.composerAccum=new i(s,n,t),this.composerAccum.needsCameraUpdate=!0,this.composerAccum.composerContext.name=a+"AccumComposerContext",this.composers.push(this.composerAccum),this.composerReveal=new i(s,o,t),this.composerReveal.needsCameraUpdate=!0,this.composerReveal.composerContext.name=a+"RevealComposerContext",this.composers.push(this.composerReveal),this.mixPass=null,this.clearAccumPass=null,this.accumPass=null,this.clearRevealPass=null,this.revealPass=null,this.fxaaPass=null,this.idString=null,this},initEffect:function(s,t){var i=function(e){return!e.canOIT},h=this.name;this.rtPool;s?(this.mixPass=new n(o.SolveAndBlendIfPostProShader,h),this.mixPass.disabledByDefault=!0,this.mixPass.needsSwap=!1,this.mixPass.material.defines.POSTPRO=0,this.mixPass.material.transparent=!0,this.mixPass.material.needsUpdate=!0,this.mixPass.material.depthTest=!1,this.mixPass.compileShader(this.renderer),this.composerAccum.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.composerReveal.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(2)),this.mixPass.addRequiredComposer(this.composerAccum),this.mixPass.addRequiredComposer(this.composerReveal),i=null):(this.mixPass=new n(o.SolveAndBlendIfPostProShader,h),this.mixPass.compileShader(this.renderer),this.composerAccum.bShareDepth=!0,this.composerReveal.bShareDepth=!0,this.composerAccum.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.composerReveal.linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(2)),this.mixPass.addRequiredComposer(this.composerAccum),this.mixPass.addRequiredComposer(this.composerReveal)),this.clearAccumPass=new r(h+"ClearAccum"),this.clearAccumPass.clearColor=new e.Color(0),this.clearAccumPass.clearbColor=!0,this.clearAccumPass.clear=!1,this.clearAccumPass.clearDepth=s,this.clearAccumPass.defaults.clear=!1,this.clearAccumPass.defaults.doClearDepth=s,this.clearAccumPass.clearAlpha=0,this.clearAccumPass.disabledByDefault=!0,this.clearAccumPass.idString=this.idString,this.accumPass=new a(t.scene,null,null,null,null,null,h+"Accum"),this.accumPass.setStateSortingResultFrom(this.stateSortingResultFrom,!1),this.accumPass.isOITPass=!0,this.accumPass.setMaterialToUse(e.MaterialToUse.oitAccumMaterial),this.accumPass.setDLsToDisableFunc(i),this.accumPass.disabledByDefault=!0,this.accumPass.setDisableBackFaceCulling(!1),this.accumPass.idString=this.idString,this.composerAccum.addPass(this.clearAccumPass),this.composerAccum.addPass(this.accumPass),this.composerAccum.enablePass(this.clearAccumPass,!0),this.composerAccum.enablePass(this.accumPass,!0),this.clearRevealPass=new r(h+"ClearReveal"),this.clearRevealPass.clearColor=new e.Color(16711680),this.clearRevealPass.clear=!1,this.clearRevealPass.clearbColor=!0,this.clearRevealPass.clearDepth=s,this.clearRevealPass.defaults.clear=!1,this.clearRevealPass.defaults.doClearDepth=s,this.clearRevealPass.clearAlpha=0,this.clearRevealPass.disabledByDefault=!0,this.clearRevealPass.idString=this.idString,this.revealPass=new a(t.scene,null,null,null,null,null,h+"Reveal"),this.revealPass.setStateSortingResultFrom(this.stateSortingResultFrom,!1),this.revealPass.setMaterialToUse(e.MaterialToUse.oitRevealMaterial),this.revealPass.isOITPass=!0,this.revealPass.setDLsToDisableFunc(i),this.revealPass.disabledByDefault=!0,this.revealPass.setDisableBackFaceCulling(!1),this.revealPass.idString=this.idString,this.composerReveal.addPass(this.clearRevealPass),this.composerReveal.addPass(this.revealPass),this.composerReveal.enablePass(this.clearRevealPass,!0),this.composerReveal.enablePass(this.revealPass,!0),t.insertComposer(null,this.mixPass)},update:function(e,s,t){},setSize:function(s,t,i){if(this._parent(s,t)){for(var r=0;r<this.composers.length;r++)this.composers[r].setSize(s,t,i);this.fxaaPass&&this.fxaaPass.material.setUniform(new e.Vector2(1/s,1/t))}}})}),define("Effects/OITEffect",["DS/Effects/OITEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/OITEffect"),e}),define("DS/Effects/DebugShadowMapsEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders","DS/ShaderBuilders/PostPro/MergeShaderBuilders"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(s,a){this._parent(s);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");return this.composers.push(new t(s,n,a)),this.debugPass=null,this.mixPass=new i(r.TextureAlphaBlend,"DebugShadowMapsEffect"),this.mixPass.material.setUniform("alphaMul",0),this.mixPass.material.setUniform("alphaAdd",1),this.nbLights=0,this},initEffect:function(s,t){null===this.debugPass&&(this.debugPass=new i(a.ShadowMerge4),this.debugPass.material.setUniform("offset0",new e.Vector2(.505,.01)),this.debugPass.material.setUniform("scale0",new e.Vector2(.485,.485)),this.debugPass.material.setUniform("offset1",new e.Vector2(.01,.01)),this.debugPass.material.setUniform("scale1",new e.Vector2(.485,.485)),this.debugPass.material.setUniform("offset2",new e.Vector2(.505,.505)),this.debugPass.material.setUniform("scale2",new e.Vector2(.485,.485)),this.debugPass.material.setUniform("offset3",new e.Vector2(.01,.505)),this.debugPass.material.setUniform("scale3",new e.Vector2(.485,.485)),this.composers[0].addPass(this.debugPass)),t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){var i=s.scene,r=i.__lights.length;if(r!==this.nbLights)for(var a=0,n=0;n<r;n++){var o=i.__lights[n];o.shadowMap&&(this.debugPass.material.setLinkedInput(o.shadowMap,a),a++)}},setSize:function(e,s,t){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height,t)}})}),define("Effects/DebugShadowMapsEffect",["DS/Effects/DebugShadowMapsEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/DebugShadowMapsEffect"),e}),define("DS/Effects/DebugPassEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/EffectComposer","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/BlendingShaderBuilders","DS/ShaderBuilders/PostPro/MergeShaderBuilders"],function(e,s,t,i,r,a){"use strict";return s.extend({init:function(s,a){this._parent(s);var n=new e.WebGLRenderTargetProperties(this.width,this.height,"uint");return this.composers.push(new t(s,n,a)),this.debugPass=null,this.mixPass=new i(r.TextureAlphaBlend,"DebugPassEffect"),this.mixPass.material.setUniform("alphaMul",0),this.mixPass.material.setUniform("alphaAdd",1),this},initEffect:function(s,t){if(null===this.debugPass){this.debugPass=new i(a.DisplayMerge4),this.debugPass.material.setUniform("offset0",new e.Vector2(.505,.01)),this.debugPass.material.setUniform("scale0",new e.Vector2(.485,.485)),this.debugPass.material.setUniform("offset1",new e.Vector2(.01,.01)),this.debugPass.material.setUniform("scale1",new e.Vector2(.485,.485)),this.debugPass.material.setUniform("offset2",new e.Vector2(.505,.505)),this.debugPass.material.setUniform("scale2",new e.Vector2(.485,.485)),this.debugPass.material.setUniform("offset3",new e.Vector2(.01,.505)),this.debugPass.material.setUniform("scale3",new e.Vector2(.485,.485)),this.composers[0].addPass(this.debugPass),null!==t.HighlightEffect?t.HighlightEffect.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.getInput(0)):t.composers[0]&&t.composers[0].linkToShaderPassUniform(this.debugPass,this.debugPass.getInput(0)),t.pickingGPUComposerContext||t.initComposer("PickingGPU"),t.pickingGPUComposerContext.linkToShaderPassUniform(this.debugPass,this.debugPass.getInput(1));var r=t.getComposer("normalDepth");r.linkToShaderPassUniform(this.debugPass,this.debugPass.getInput(2)),r.linkToShaderPassUniform(this.debugPass,this.debugPass.getInput(3))}t.insertComposer(this.composers[0],this.mixPass),this.composers[0].linkToShaderPassUniform(this.mixPass,this.mixPass.getInput(1)),this.mixPass.addRequiredComposer(this.composers[0])},update:function(e,s,t){},setSize:function(e,s,t){this._parent(e,s)&&this.composers[0].setSize(this.width,this.height,t)}})}),define("Effects/DebugPassEffect",["DS/Effects/DebugPassEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/DebugPassEffect"),e}),define("DS/Effects/PreHighlightEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/AbstractHighlightEffect","DS/Plugins/RenderPass","DS/ShaderBuilders/PostPro/HighlightShaderBuilders","DS/Plugins/ClearPass"],function(e,s,t,i,r){"use strict";return s.extend({init:function(e,s,t,r){return this._parent(e,s,r+"PreHighlightEffect",t,r,i.FinalBlending),this},update:function(s,i,a,n,o){var h=this.composers[0].renderer;this.sceneGraphSelection=i.selectionPreHL,null===this.hlRenderPass&&(this.hlClearPass=new r(this.prefix+"prehlClearPass"),this.hlRenderPass=new t(i.selectionPreHL.sceneHL,a._renderedCamera,this.prefix+"prehlRenderPass"),this.hlRenderPass.setDisableBackFaceCulling(!0),this.hlRenderPass.setMaterialToUse(e.MaterialToUse.highlightMaterial),this.hlRenderPass.cameraName="mainNoJittering",this.hlRenderPass.idString=this.idString,this.composers[0].composerContext.setPassClear(this.hlClearPass,!0,new e.Color(0),0),this.composers[0].addPass(this.hlClearPass),this.composers[0].addPass(this.hlRenderPass));var l=[];this.sceneGraphSelection._updateScene(i.scene),this.sceneGraphSelection.enabled&&l.push(this.sceneGraphSelection.sceneHL);var p=l.length;this.hlRenderPass.setMultiRenderCB(function(e,s){return s<p&&(e.scene=l[s],!0)});var[c,m,d]=h.getRenderMode().getMasks();this.hlRenderPass.renderFaceMode=c,this.hlRenderPass.renderLineMode=m,this.hlRenderPass.renderPointMode=d,this.composers[0].composerContext.needsUpdate=!0,this.updateUniforms([])}})}),define("Effects/PreHighlightEffect",["DS/Effects/PreHighlightEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/PreHighlightEffect"),e}),define("DS/Effects/FXAAEffect",["DS/Visualization/ThreeJS_DS","DS/Effects/BasicEffect","DS/Plugins/ShaderPass_New","DS/ShaderBuilders/PostPro/FXAAShaderBuilders"],function(e,s,t,i){"use strict";return s.extend({init:function(e){return this._parent(e),this.mixPass=new t(i.FXAAShader,"FXAAEffect"),this},initEffect:function(e,s){s.insertComposer(null,this.mixPass)},update:function(e,s,t){},setSize:function(s,t){this._parent(s,t)&&this.mixPass.material.setUniform("resolution",new e.Vector2(1/s,1/t))}})}),define("Effects/FXAAEffect",["DS/Effects/FXAAEffect","DS/DSMigration/DSMigration"],function(e,s){return s.deprecateModule("Effects/FXAAEffect"),e});