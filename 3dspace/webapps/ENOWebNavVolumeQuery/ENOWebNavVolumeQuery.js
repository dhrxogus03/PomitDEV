/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryRobot",["UWA/Class","DS/Robot/FreeRobot","DS/Ruler/Ruler","DS/Visualization/ThreeJS_DS","DS/Selection/HSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/ContextualBar","DS/RuntimeView/NLSManager","DS/LevelSelector/LevelSelector","DS/ApplicationFrame/CommandsManager","DS/Visualization/PathElement"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p,m){"use strict";return e.extend({init:function(e){var n=this;this._window=e.window,this._sceneGraph=e.sceneGraph,this._viewer=e.viewer,this._modelEvent=new o,this._robot=new t("robotVolumeQuery",this._viewer,!0);var a=new m([this._sceneGraph,e.target]);this._robot.setTarget(a),this._sceneGraph.addChild(this._robot),this._ruler=new i(this._window,{offset:95}),this._ruler.subscribe("RulerManipulate",function(e){onRulerValueModified(e)}),this._onLocalTransfo=function(e){n.onLocalTransoEvents(e)},l.addEvent(this._viewer.canvas,"onMiddleMouseUp",this._onLocalTransfo),l.addEvent(this._viewer.canvas,"onMiddleMouseDown",this._onLocalTransfo)},setTarget:function(e){this._robot.setTarget(e)},onLocalTransoEvents:function(e){"@onMiddleMouseUpEvent"==e.eventType?this.displayRobotAndRuler():"@onMiddleMouseDownEvent"==e.eventType&&this.hideRobotAndRuler(),this._viewer.render()},hideRobotAndRuler:function(){this._robot.isConnected&&this._robot.setVisibility(!1),this._rulerWasVisibleBeforeLocalTransfo=this._ruler.getVisibleFlag(),this._ruler.setVisibleFlag(!1)},displayRobotAndRuler:function(){this._robot.isConnected&&this._robot.setVisibility(!0),this._rulerWasVisibleBeforeLocalTransfo&&(this._ruler.refresh(),this._ruler.setVisibleFlag(!0))},updateRobotFromMatrix:function(e){this._ruler.initOrigin=(new n.Vector3).getPositionFromMatrix(e),this._ruler.origin=this._ruler.initOrigin,this._robot.updateCenterPosition(this._ruler.initOrigin);var t=new n.Vector3(e.elements[0],e.elements[1],e.elements[2]).normalize(),i=new n.Vector3(e.elements[4],e.elements[5],e.elements[6]).normalize(),a=new n.Vector3(e.elements[8],e.elements[9],e.elements[10]).normalize();this._robot.updateAxis(t,i,a),this._robot.setMatrix(e),this._ruler.direction=null,this._ruler.value=0},setVisibility:function(e){this._robot.setVisibility(e),1==e?(l.addEvent(this._viewer.canvas,"onMiddleMouseUp",this._onLocalTransfo),l.addEvent(this._viewer.canvas,"onMiddleMouseDown",this._onLocalTransfo)):(this._ruler.setVisibleFlag(!1),l.removeEvent(this._viewer.canvas,"onMiddleMouseUp",this._onLocalTransfo),l.removeEvent(this._viewer.canvas,"onMiddleMouseDown",this._onLocalTransfo))}})}),define("DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryPanel",["css!DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQuery","i18n!DS/ENOWebNavVolumeQuery/assets/nls/ENOWebNavVolumeQuery.json","DS/PADUtils/PADSettingsMgt","DS/PADServices/utils/GlobalUtils","UWA/Core","UWA/Class","DS/Windows/Dialog","DS/Windows/Panel","DS/Controls/Button","DS/Controls/Toggle","DS/Controls/ButtonGroup","DS/Controls/LineEditor","DS/Controls/Expander","DS/Controls/TooltipModel","DS/Controls/SpinBox","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p,m,v){"use strict";var x=8,b=!1,y=12;return r.extend({init:function(e){var r=this;this._controller=e.controller,this._currentUnit=e.currentUnit;var s=localStorage.getItem("CATWebUXPreferences_Units");s&&s.length&&(s=JSON.parse(s)),this._decimals=s&&s.Length.decimalPlaceRO?s.Length.decimalPlaceRO:v.Types.Length.defaultDecimalPlaceRO,this._parameters={minX:!1,minY:!1,minZ:!1,maxX:!1,maxY:!1,maxZ:!1,centerX:!1,centerY:!1,centerZ:!1,radius:!1,offset:!1,startObject:!1,space:!1},"enopad_odt_wgd"==widget.id&&(x=1,y=15,!0!==widget.volumeFilter&&i.setSetting("activateVolumeFilter",!1)),this._table=new a.Element("table",{class:"panelTable"}),this._tbody=new a.Element("tbody",{class:"paneltBody"});var f=new a.Element("tr",{}).inject(this._table);new a.Element("td",{text:t.shapeTypeLabel,class:"panelTdSeparator"}).inject(f);var w=new a.Element("tr",{}).inject(this._table),g=new a.Element("td",{class:"panelTd"}).inject(w),S=new h({touchMode:!1});S.inject(g),this._boxStarter=new l({label:t.boxShape,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_Box.png"),displayStyle:"icon",type:"radio",checkFlag:0===e.defaultShape,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller._context.getRoots().length?r._controller.switchVolumeQueryShape("Box"):r._controller.displayBoxHandleFilter(),r.displayShapeParams(0,r._table)}}),this._boxStarter.tooltipInfos=new _({shortHelp:t.boxShape,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._sphereStarter=new l({label:t.sphereShape,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_Sphere.png"),displayStyle:"icon",type:"radio",checkFlag:1===e.defaultShape,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller._context.getRoots().length?r._controller.switchVolumeQueryShape("Sphere"):r._controller.displaySphereHandleFilter(),r.displayShapeParams(1,r._table)}}),this._sphereStarter.tooltipInfos=new _({shortHelp:t.sphereShape,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._proximityStarter=new l({label:t.proximityShape,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_Proximity.png"),displayStyle:"icon",type:"radio",checkFlag:2===e.defaultShape,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryShape("Proximity"),r.displayShapeParams(2,r._table)}}),this._proximityStarter.tooltipInfos=new _({shortHelp:t.proximityShape,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._spaceStarter=new l({label:t.spaceShape,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_Space.png"),displayStyle:"icon",type:"radio",checkFlag:3===e.defaultShape,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryShape("Space"),r.displayShapeParams(3,r._table)}}),this._spaceStarter.tooltipInfos=new _({shortHelp:t.spaceShape,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),S.addChild(this._boxStarter),S.addChild(this._sphereStarter),this._controller._proximityAvailable?S.addChild(this._proximityStarter):2===e.defaultShape&&(e.defaultShape=0,this._boxStarter.checkFlag=!0),S.addChild(this._spaceStarter);var V=new a.Element("tr",{}).inject(this._table);new a.Element("td",{text:t.intersectionModeLabel,class:"panelTdSeparator"}).inject(V);var C=new a.Element("tr",{}).inject(this._table),M=new a.Element("td",{class:"panelTd"}).inject(C);this._intersectionGroup=new h({touchMode:!1}),this._intersectionGroup.inject(M),this._fullyInStarter=new l({label:t.fullyInMode,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_FullyIn.png"),displayStyle:"icon",type:"radio",checkFlag:1===e.defaultIntersection,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryInOutRule("FullIn")}}),this._fullyInStarter.tooltipInfos=new _({shortHelp:t.fullyInMode,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._partlyInStarter=new l({label:t.partlyInMode,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_PartlyIn.png"),displayStyle:"icon",type:"radio",checkFlag:0===e.defaultIntersection,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryInOutRule("PartlyIn")}}),this._partlyInStarter.tooltipInfos=new _({shortHelp:t.partlyInMode,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._acrossStarter=new l({label:t.acrossMode,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_Across.png"),displayStyle:"icon",type:"radio",checkFlag:4===e.defaultIntersection,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryInOutRule("Across")}}),this._acrossStarter.tooltipInfos=new _({shortHelp:t.acrossMode,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._partlyOutStarter=new l({label:t.partlyOutMode,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_PartlyOut.png"),displayStyle:"icon",type:"radio",checkFlag:2===e.defaultIntersection,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryInOutRule("PartlyOut")}}),this._partlyOutStarter.tooltipInfos=new _({shortHelp:t.partlyOutMode,mouseRelativePosition:!0}),this._fullyOutStarter=new l({label:t.fullyOutMode,showLabelFlag:!1,icon:m.getWebappsAssetUrl("ENOWebNavVolumeQuery","icons/32/I_ENOWebNavVolumeQuery_FullyOut.png"),displayStyle:"icon",type:"radio",checkFlag:3===e.defaultIntersection,touchMode:!1,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.switchVolumeQueryInOutRule("FullOut")}}),this._fullyOutStarter.tooltipInfos=new _({shortHelp:t.fullyOutMode,mouseRelativePosition:!0,allowUnsafeHTMLLabel:!1}),this._intersectionGroup.addChild(this._fullyInStarter),this._intersectionGroup.addChild(this._partlyInStarter),this._intersectionGroup.addChild(this._partlyOutStarter),this._intersectionGroup.addChild(this._fullyOutStarter);var P=new a.Element("tr",{}).inject(this._table),A=new a.Element("td",{}).inject(P);let E=a.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question panelShapeParamsHelp"});this._shapeExpander=new d({style:"simple",header:t.shapeParametersLabel,expandedFlag:b,allowUnsafeHTMLHeader:!1,body:this._tbody,customHeader:E,customHeaderPosition:"near"}).inject(A),E.addEventListener("click",function(){n.launchURL({kind:"documentation",topics:{WebHelp:"SharedUserMap/cfg-t-Filter-Volume-Query.htm"}})}),this._shapeExpander.addEventListener("expand",function(e){b=!b});var B=new a.Element("tr",{}).inject(this._table);if(new a.Element("td",{class:"panelBottomTdSeparator"}).inject(B),this._minLine=new a.Element("tr",{id:"minLine"}).inject(this._tbody),this._minLine=new a.Element("tr",{id:"minLineTD"}).inject(this._tbody),this._maxLine=new a.Element("tr",{id:"maxLine"}).inject(this._tbody),this._maxLine=new a.Element("tr",{id:"maxLineTD"}).inject(this._tbody),this._minX=new p({value:1,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._minY=new p({value:2,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._minZ=new p({value:3,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._maxX=new p({value:4,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._maxY=new p({value:5,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._maxZ=new p({value:6,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._centerX=new p({value:1,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._centerY=new p({value:2,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._centerZ=new p({value:3,stepValue:1,decimals:this._decimals,units:this._currentUnit.nls}),this._radius=new p({value:4,stepValue:1,decimals:this._decimals,minValue:.01,units:this._currentUnit.nls}),this._offset=new p({value:0,stepValue:1,minValue:0,decimals:this._decimals,units:this._currentUnit.nls}),this._startObject=new u({placeholder:t.proximityPlaceholder,displayClearFieldButtonFlag:!0}),this._space=new u({placeholder:t.spacePlaceholder,displayClearFieldButtonFlag:!0}),this.displayShapeParams(e.defaultShape,this._table),!0===i.getSetting("activateVolumeFilter")){this._filterBody=new h,this._updateFilter=new c({type:"radio",class:"panelTd",label:t.updateFilter,allowUnsafeHTMLLabel:!1}),this._addFilter=new c({type:"radio",class:"panelTd",label:t.addFilter,checkFlag:!0,allowUnsafeHTMLLabel:!1}),this._filterBody.addChild(this._updateFilter),this._filterBody.addChild(this._addFilter);var N=new a.Element("tr",{}).inject(this._table),D=new a.Element("td",{}).inject(N);this._filterExpander=new d({style:"simple",header:t.FilterTitle,allowUnsafeHTMLHeader:!1,body:this._filterBody}).inject(D)}var O=new a.Element("tr",{}).inject(this._table);new a.Element("td",{class:"panelBottomTdSeparator"}).inject(O);var F=new a.Element("tr",{}).inject(this._table),T=new a.Element("td",{class:"panelBottomTd"}).inject(F),L=new h;L.inject(T),this._filterButton=new l({label:t.filterButton,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.updateVolumeQuery()}}),this.okButton=new l({label:!0===i.getSetting("activateVolumeFilter")?t.selectButton:t.okButton,emphasize:"primary",allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.applyVolumeQuery()}}),this.cancelButton=new l({label:!0===i.getSetting("activateVolumeFilter")?t.closeButton:t.cancelButton,allowUnsafeHTMLLabel:!1,onClick:function(){r._controller.displayNotification("cancel"),r._controller.end(),!0===i.getSetting("activateVolumeFilter")&&r._controller.updateVolumeQuery({action:"cancel"})}}),L.addChild(this._filterButton),L.addChild(this.okButton),L.addChild(this.cancelButton),this._panelMain=new o({title:t.panelTitle,immersiveFrame:e.immersiveFrame,content:this._table,width:285,minWidth:285,height:"auto",maxHeight:660,position:{offsetX:e.immersiveFrame.elements.container.offsetWidth/2-100,offsetY:e.immersiveFrame.elements.container.offsetHeight/2-115},allowedDockAreas:y,collapsibleFlag:!1,verticallyStretchableFlag:!0,closeButtonFlag:!1}),this._panelMain.immersiveFrame.dockWindow(this._panelMain,x,{attachToOtherDockedWindow:!0}),this._panelMain.addEventListener("stopWindowDrag",function(e){x=r._panelMain.currentDockArea}),document.body.addEventListener("keyUp",function(e){27==e.keyCode&&(this._panelMain.close(),this._panelMain.destroy())}),this._parent(e)},destroy:function(){this._panelMain&&(this._parent(),this._panelMain.close(),this._panelMain.destroy(),delete this._panelMain),this._controller._panelCreation=0},hide:function(){this._panelMain&&this._panelMain.hide()},show:function(){this._panelMain&&this._panelMain.show()},displayShapeParams:function(e,n){var r=this;switch(e){case 0:-1!==this._intersectionGroup.getButtonIndex(this._acrossStarter)&&this._intersectionGroup.removeChild(this._acrossStarter);for(var s=this._tbody.rows.minLine;s.cells.length>0;)s.deleteCell(0);new a.Element("td",{text:t.minValueLabel}).inject(s);for(var o=this._tbody.rows.minLineTD;o.cells.length>0;)o.deleteCell(0);var l=new a.Element("td",{class:"panelTd"}).inject(o),c=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(l);new a.Element("div",{text:"X:",class:"vqPanelCoordinateInput-title"}).inject(c),this._minX.inject(c),this._xMinCoordinateAlert=new a.Element("div",{class:"vqPanelCoordinateInput-alertIcon not-visible"}).inject(c),new a.Element("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(this._xMinCoordinateAlert),this._xMinCoordinateAlert.tooltipInfos=new _({title:t.minValueAlertTooltipTitle,shortHelp:t.minValueAlertTooltipHelp});var h=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(l);new a.Element("div",{text:"Y: ",class:"vqPanelCoordinateInput-title"}).inject(h),this._minY.inject(h),this._yMinCoordinateAlert=new a.Element("div",{class:"vqPanelCoordinateInput-alertIcon not-visible"}).inject(h),new a.Element("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(this._yMinCoordinateAlert),this._yMinCoordinateAlert.tooltipInfos=new _({title:t.minValueAlertTooltipTitle,shortHelp:t.minValueAlertTooltipHelp});var u=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(l);new a.Element("div",{text:"Z:",class:"vqPanelCoordinateInput-title"}).inject(u),this._minZ.inject(u),this._zMinCoordinateAlert=new a.Element("div",{class:"vqPanelCoordinateInput-alertIcon not-visible"}).inject(u),new a.Element("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(this._zMinCoordinateAlert),this._zMinCoordinateAlert.tooltipInfos=new _({title:t.minValueAlertTooltipTitle,shortHelp:t.minValueAlertTooltipHelp}),this._minXListener||(this._minXListener=(e=>{const t={direction:"min",minX:e.dsModel.value,minY:this._minY.value,minZ:this._minZ.value,maxX:this._maxX.value,maxY:this._maxY.value,maxZ:this._maxZ.value};this.validateBoxInputs("min","x"),this._controller.updateBox3D(t,this._parameters.minX,"minX",e)})),this._minX.removeEventListener("change",this._minXListener),this._minX.addEventListener("change",this._minXListener),this._minYListener||(this._minYListener=(e=>{const t={direction:"min",minX:this._minX.value,minY:e.dsModel.value,minZ:this._minZ.value,maxX:this._maxX.value,maxY:this._maxY.value,maxZ:this._maxZ.value};this.validateBoxInputs("min","y"),this._controller.updateBox3D(t,this._parameters.minY,"minY",e)})),this._minY.removeEventListener("change",this._minYListener),this._minY.addEventListener("change",this._minYListener),this._minZListener||(this._minZListener=(e=>{const t={direction:"min",minX:this._minX.value,minY:this._minY.value,minZ:e.dsModel.value,maxX:this._maxX.value,maxY:this._maxY.value,maxZ:this._maxZ.value};this.validateBoxInputs("min","z"),this._controller.updateBox3D(t,this._parameters.minZ,"minZ",e)})),this._minZ.removeEventListener("change",this._minZListener),this._minZ.addEventListener("change",this._minZListener);for(var d=this._tbody.rows.maxLine;d.cells.length>0;)d.deleteCell(0);new a.Element("td",{text:t.maxValueLabel}).inject(d);for(var p=this._tbody.rows.maxLineTD;p.cells.length>0;)p.deleteCell(0);var m=new a.Element("td",{class:"panelTd"}).inject(p),v=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(m);new a.Element("div",{text:"X:",class:"vqPanelCoordinateInput-title"}).inject(v),this._maxX.inject(v),this._xMaxCoordinateAlert=new a.Element("div",{class:"vqPanelCoordinateInput-alertIcon not-visible"}).inject(v),new a.Element("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(this._xMaxCoordinateAlert),this._xMaxCoordinateAlert.tooltipInfos=new _({title:t.maxValueAlertTooltipTitle,shortHelp:t.maxValueAlertTooltipHelp});var x=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(m);new a.Element("div",{text:"Y:",class:"vqPanelCoordinateInput-title"}).inject(x),this._maxY.inject(x),this._yMaxCoordinateAlert=new a.Element("div",{class:"vqPanelCoordinateInput-alertIcon not-visible"}).inject(x),new a.Element("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(this._yMaxCoordinateAlert),this._yMaxCoordinateAlert.tooltipInfos=new _({title:t.maxValueAlertTooltipTitle,shortHelp:t.maxValueAlertTooltipHelp});var b=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(m);new a.Element("div",{text:"Z:",class:"vqPanelCoordinateInput-title"}).inject(b),this._maxZ.inject(b),this._zMaxCoordinateAlert=new a.Element("div",{class:"vqPanelCoordinateInput-alertIcon not-visible"}).inject(b),new a.Element("span",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention"}).inject(this._zMaxCoordinateAlert),this._zMaxCoordinateAlert.tooltipInfos=new _({title:t.maxValueAlertTooltipTitle,shortHelp:t.maxValueAlertTooltipHelp}),this._maxXListener||(this._maxXListener=(e=>{const t={direction:"max",minX:this._minX.value,minY:this._minY.value,minZ:this._minZ.value,maxX:e.dsModel.value,maxY:this._maxY.value,maxZ:this._maxZ.value};this.validateBoxInputs("max","x"),this._controller.updateBox3D(t,this._parameters.maxX,"maxX",e)})),this._maxX.removeEventListener("change",this._maxXListener),this._maxX.addEventListener("change",this._maxXListener),this._maxYListener||(this._maxYListener=(e=>{const t={direction:"max",minX:this._minX.value,minY:this._minY.value,minZ:this._minZ.value,maxX:this._maxX.value,maxY:e.dsModel.value,maxZ:this._maxZ.value};this.validateBoxInputs("max","y"),this._controller.updateBox3D(t,this._parameters.maxY,"maxY",e)})),this._maxY.removeEventListener("change",this._maxYListener),this._maxY.addEventListener("change",this._maxYListener),this._maxZListener||(this._maxZListener=(e=>{const t={direction:"max",minX:this._minX.value,minY:this._minY.value,minZ:this._minZ.value,maxX:this._maxX.value,maxY:this._maxY.value,maxZ:e.dsModel.value};this.validateBoxInputs("max","z"),this._controller.updateBox3D(t,this._parameters.maxZ,"maxZ",e)})),this._maxZ.removeEventListener("change",this._maxZListener),this._maxZ.addEventListener("change",this._maxZListener);break;case 1:-1!==this._intersectionGroup.getButtonIndex(this._acrossStarter)&&this._intersectionGroup.removeChild(this._acrossStarter);for(s=this._tbody.rows.minLine;s.cells.length>0;)s.deleteCell(0);new a.Element("td",{text:t.centerValueLabel}).inject(s);for(o=this._tbody.rows.minLineTD;o.cells.length>0;)o.deleteCell(0);l=new a.Element("td",{class:"panelTd"}).inject(o);var y=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(l);new a.Element("div",{text:"X:",class:"vqPanelCoordinateInput-title"}).inject(y),this._centerX.inject(y),this._centerX.addEventListener("change",function(e){var t={centerX:e.dsModel.value,centerY:r._centerY.value,centerZ:r._centerZ.value};r._controller.updateSphere3D(t,r._parameters.centerX,"centerX")});var f=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(l);new a.Element("span",{text:"Y:",class:"vqPanelCoordinateInput-title"}).inject(f),this._centerY.inject(f),this._centerY.addEventListener("change",function(e){var t={centerX:r._centerX.value,centerY:e.dsModel.value,centerZ:r._centerZ.value};r._controller.updateSphere3D(t,r._parameters.centerY,"centerY")});var w=new a.Element("div",{class:"vqPanelCoordinateInput"}).inject(l);new a.Element("div",{text:"Z:",class:"vqPanelCoordinateInput-title"}).inject(w),this._centerZ.inject(w),this._centerZ.addEventListener("change",function(e){var t={centerX:r._centerX.value,centerY:r._centerY.value,centerZ:e.dsModel.value};r._controller.updateSphere3D(t,r._parameters.centerZ,"centerZ")});for(d=this._tbody.rows.maxLine;d.cells.length>0;)d.deleteCell(0);new a.Element("td",{text:t.radiusValueLabel}).inject(d);for(p=this._tbody.rows.maxLineTD;p.cells.length>0;)p.deleteCell(0);m=new a.Element("td",{class:"panelTd"}).inject(p);this._radius.inject(m),this._radius.addEventListener("change",function(e){var t={radius:e.dsModel.value};e.dsModel.value>=r._radius.minValue&&r._controller.updateSphere3D(t,r._parameters.radius,"radius")});break;case 2:-1===this._intersectionGroup.getButtonIndex(this._acrossStarter)&&this._intersectionGroup.addChild(this._acrossStarter,2);for(s=this._tbody.rows.minLine;s.cells.length>0;)s.deleteCell(0);new a.Element("td",{text:t.offsetValueLabel}).inject(s);for(o=this._tbody.rows.minLineTD;o.cells.length>0;)o.deleteCell(0);l=new a.Element("td",{class:"panelTd"}).inject(o);this._offset.inject(l),this._offset.addEventListener("change",function(e){e.dsModel.value>0&&r._controller.updateProximity3D(e.dsModel.value,r._parameters.offset,"offset")});for(d=this._tbody.rows.maxLine;d.cells.length>0;)d.deleteCell(0);for(p=this._tbody.rows.maxLineTD;p.cells.length>0;)p.deleteCell(0);if(1==i.getSetting("proximityEvolution")){new a.Element("td",{text:t.startObject}).inject(d);m=new a.Element("td",{class:"panelTdProximity"}).inject(p);this._startObject.inject(m),this._startObject.addEventListener("change",function(e){""===r._startObject.value&&(e.stopPropagation(),0===r._controller._pickCount&&(r._controller._pickCount++,r._startObject.value="",r._controller.changePickableobject({type:"proximity"})))})}break;case 3:-1===this._intersectionGroup.getButtonIndex(this._acrossStarter)&&this._intersectionGroup.addChild(this._acrossStarter,2);for(s=this._tbody.rows.minLine;s.cells.length>0;)s.deleteCell(0);new a.Element("td",{text:t.space}).inject(s);for(o=this._tbody.rows.minLineTD;o.cells.length>0;)o.deleteCell(0);l=new a.Element("td",{class:"panelTd"}).inject(o);this._space.inject(l),this._space.addEventListener("change",function(e){""===r._space.value&&(e.stopPropagation(),0===r._controller._pickCount&&(r._controller._pickCount++,r._space.value="",r._controller.changePickableobject({type:"space"})))});for(d=this._tbody.rows.maxLine;d.cells.length>0;)d.deleteCell(0);for(p=this._tbody.rows.maxLineTD;p.cells.length>0;)p.deleteCell(0)}},setShapeParameters:function(e,t){t&&"number"==typeof t&&(this._minX.decimals=t,this._minY.decimals=t,this._minZ.decimals=t,this._maxX.decimals=t,this._maxY.decimals=t,this._maxZ.decimals=t,this._centerX.decimals=t,this._centerY.decimals=t,this._centerZ.decimals=t,this._radius.decimals=t,this._offset.decimals=t),e.box&&(e.filterDrop?1==e.filterDrop&&(this._parameters.minX=!1,this._minX.value=0,this._parameters.minY=!1,this._minY.value=0,this._parameters.minZ=!1,this._minZ.value=0,this._parameters.maxX=!1,this._maxX.value=100,this._parameters.maxY=!1,this._maxY.value=100,this._parameters.maxZ=!1,this._maxZ.value=100):(this._minX.value!==e.box.min.x&&(this._parameters.minX=!0),this._minY.value!==e.box.min.y&&(this._parameters.minY=!0),this._minZ.value!==e.box.min.z&&(this._parameters.minZ=!0),this._maxX.value!==e.box.max.x&&(this._parameters.maxX=!0),this._maxY.value!==e.box.max.y&&(this._parameters.maxY=!0),this._maxZ.value!==e.box.max.z&&(this._parameters.maxZ=!0),this._minX.value=isFinite(e.box.min.x)?v.convert(e.box.min.x,"length","mm",this._currentUnit.unit):1,this._minY.value=isFinite(e.box.min.y)?v.convert(e.box.min.y,"length","mm",this._currentUnit.unit):2,this._minZ.value=isFinite(e.box.min.z)?v.convert(e.box.min.z,"length","mm",this._currentUnit.unit):3,this._maxX.value=isFinite(e.box.max.x)?v.convert(e.box.max.x,"length","mm",this._currentUnit.unit):4,this._maxY.value=isFinite(e.box.max.y)?v.convert(e.box.max.y,"length","mm",this._currentUnit.unit):5,this._maxZ.value=isFinite(e.box.max.z)?v.convert(e.box.max.z,"length","mm",this._currentUnit.unit):6)),e.center&&e.radius&&(e.filterDrop?1==e.filterDrop&&(this._parameters.centerX=!1,this._centerX.value=0,this._parameters.centerY=!1,this._centerY.value=0,this._parameters.centerZ=!1,this._centerZ.value=0,this._parameters.radius=!1,this._radius.value=100):(this._centerX.value!==e.center.x&&(this._parameters.centerX=!0),this._centerY.value!==e.center.y&&(this._parameters.centerY=!0),this._centerZ.value!==e.center.z&&(this._parameters.centerZ=!0),this._radius.value!==e.radius&&(this._parameters.radius=!0),this._centerX.value=isFinite(e.center.y)?v.convert(e.center.x,"length","mm",this._currentUnit.unit):1,this._centerY.value=isFinite(e.center.y)?v.convert(e.center.y,"length","mm",this._currentUnit.unit):2,this._centerZ.value=isFinite(e.center.z)?v.convert(e.center.z,"length","mm",this._currentUnit.unit):3,this._radius.value=isFinite(e.radius)?v.convert(e.radius,"length","mm",this._currentUnit.unit):4)),e.offset&&(this._offset.value!==e.offset&&(this._parameters.offset=!0),this._offset.value=isFinite(e.offset)?v.convert(e.offset,"length","mm",this._currentUnit.unit):0)},validateBoxInputs:function(e,t){if("min"===e)switch(t){case"x":this._maxX.elements.container.classList.remove("invalid-value"),this._xMaxCoordinateAlert.classList.add("not-visible"),this._minX.value>=this._maxX.value?(this._minX.elements.container.classList.add("invalid-value"),this._xMinCoordinateAlert.classList.remove("not-visible")):(this._minX.elements.container.classList.remove("invalid-value"),this._xMinCoordinateAlert.classList.add("not-visible"));break;case"y":this._maxY.elements.container.classList.remove("invalid-value"),this._yMaxCoordinateAlert.classList.add("not-visible"),this._minY.value>=this._maxY.value?(this._minY.elements.container.classList.add("invalid-value"),this._yMinCoordinateAlert.classList.remove("not-visible")):(this._minY.elements.container.classList.remove("invalid-value"),this._yMinCoordinateAlert.classList.add("not-visible"));break;case"z":this._maxZ.elements.container.classList.remove("invalid-value"),this._zMaxCoordinateAlert.classList.add("not-visible"),this._minZ.value>=this._maxZ.value?(this._minZ.elements.container.classList.add("invalid-value"),this._zMinCoordinateAlert.classList.remove("not-visible")):(this._minZ.elements.container.classList.remove("invalid-value"),this._zMinCoordinateAlert.classList.add("not-visible"));break;default:console.error("ENOWebNavVolumeQueryPanel.validateBoxInputs : Invalid coordionate value (must be x, y or z)")}else if("max"===e)switch(t){case"x":this._minX.elements.container.classList.remove("invalid-value"),this._xMinCoordinateAlert.classList.add("not-visible"),this._maxX.value<=this._minX.value?(this._maxX.elements.container.classList.add("invalid-value"),this._xMaxCoordinateAlert.classList.remove("not-visible")):(this._maxX.elements.container.classList.remove("invalid-value"),this._xMaxCoordinateAlert.classList.add("not-visible"));break;case"y":this._minY.elements.container.classList.remove("invalid-value"),this._yMinCoordinateAlert.classList.add("not-visible"),this._maxY.value<=this._minY.value?(this._maxY.elements.container.classList.add("invalid-value"),this._yMaxCoordinateAlert.classList.remove("not-visible")):(this._maxY.elements.container.classList.remove("invalid-value"),this._yMaxCoordinateAlert.classList.add("not-visible"));break;case"z":this._minZ.elements.container.classList.remove("invalid-value"),this._zMinCoordinateAlert.classList.add("not-visible"),this._maxZ.value<=this._minZ.value?(this._maxZ.elements.container.classList.add("invalid-value"),this._zMaxCoordinateAlert.classList.remove("not-visible")):(this._maxZ.elements.container.classList.remove("invalid-value"),this._zMaxCoordinateAlert.classList.add("not-visible"));break;default:console.error("ENOWebNavVolumeQueryPanel.validateBoxInputs : Invalid coordionate value (must be x, y or z)")}else console.error("ENOWebNavVolumeQueryPanel.validateBoxInputs : Invalid point value (must be min or max)");this._minX.elements.container.classList.contains("invalid-value")||this._minY.elements.container.classList.contains("invalid-value")||this._minZ.elements.container.classList.contains("invalid-value")||this._maxX.elements.container.classList.contains("invalid-value")||this._maxY.elements.container.classList.contains("invalid-value")||this._maxZ.elements.container.classList.contains("invalid-value")?(this._filterButton.disabled=!0,this.okButton.disabled=!0):(this._filterButton.disabled=!1,this.okButton.disabled=!1)}})}),define("DS/ENOWebNavVolumeQuery/ENOWebNavHandleArrow",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/BillBoardNode3D","DS/Mesh/MeshUtils","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/Visualization/SceneGraphFactory"],function(e,t,i,n,a,r,s,o,l){"use strict";var c=t.extend({init:function(t){this._parent(t.name),this._width=t.width,this._height=95*this._width/60,this._fixedArrowNode=new o({name:"arrowFixedSizeNode3D",ratio:1});var s={width:this._width,height:this._height,fill:!0,fillColor:null,noEdge:!0,layerNb:1},c=(new n).createRectangle(s),h=this,u=function(){h.onAsyncDependancyCompleted()};this.addAsyncDependancies(1);var d=i.getWebappsAssetUrl("ENOWebNavVolumeQuery",""),_=new e.ImageUtils.loadTexture(d+"textures/I_ENOWebNavVolumeQueryTextureArrow.png",void 0,u,u,!0);_.flipY=!1,this.mat=new e.MeshBasicMaterial({map:_,side:e.DoubleSide,transparent:!0,alphaTest:.05,enableClipPlanes:!1}),this.mat.force=!0;var p=l.createMeshNode(c,this.mat);p.setShadow(!1),p.setFrustumCulled(!1),p.excludeFromCSO(!0),p.excludeFromHighlight(!0,!0),p.setMatrix((new e.Matrix4).rotateX(-.5*Math.PI).translate(new e.Vector3(-this._width/2,0,0)));var m={position:new e.Vector3(0,0,0),name:"billBoardNode",type:"Cylindrical",viewpoint:t.viewer.currentViewpoint},v=new a(m);v.add(p),this._fixedArrowNode.add(v),this.add(this._fixedArrowNode),this.setVisibilityInTree(!1),this.exludeFromBounding(!0),v.setPickable(r.PICKTHROUGH),this._fixedArrowNode.setPickable(r.PICKTHROUGH)},getScaledHeight:function(){return this._height*this._fixedArrowNode.scaleFactor}});return UWA.namespace("DS/ENOWebNavVolumeQuery/ENOWebNavHandleArrow",c)}),define("DS/ENOWebNavVolumeQuery/ENOWebNavShapeManipulator",["DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Manipulators/Manipulator"],function(e,t,i){"use strict";var n=i.extend({init:function(t){return this._parent(t),this.projector=new e.Projector,this.setExclusive(!0),this},BeginManipulate:function(t,i,n){this._parent(t,i,n);var a={eventChannel:"BeginManipulate",paths:this.manipulatedPaths,intersection:n};this.publish("BeginManipulate",a),this._initialPositionProjected=i.from[0].getCurrentPosition(this.viewer.canvas),this._initial3dIntersectionPoint=n.position,this._initial3dIntersectionPointTranslated=(new e.Vector3).copy(this._initial3dIntersectionPoint),this._initial3dIntersectionPointTranslated.add(n.normal)},Manipulate:function(t,i,n){this._parent(t,i,n);var a=(new e.Vector2).copy(i.from[0].getCurrentPosition(this.viewer.canvas));a.x=(2*a.x-this.viewer.canvas.width)/this.viewer.canvas.width,a.y=-(2*a.y-this.viewer.canvas.height)/this.viewer.canvas.height;var r=new e.Vector3(a.x,a.y,1);this.projector.unprojectVector(r,this.viewer.currentViewpoint.camera);var s=new e.Ray(this.viewer.currentViewpoint.camera.position,r.sub(this.viewer.currentViewpoint.camera.position).normalize()).computeShortestPointToLine(this._initial3dIntersectionPoint,this._initial3dIntersectionPointTranslated),o=(new e.Vector3).subVectors(s,this._initial3dIntersectionPoint),l={eventChannel:"Manipulate",paths:this.manipulatedPaths,translationVector:o,intersection:n};this.publish("Manipulate",l)},EndManipulate:function(e,t,i){var n={eventChannel:"EndManipulate",paths:this.manipulatedPaths,intersection:i};this.publish("EndManipulate",n),this._parent(e,t,i)},BeginPreactivate:function(e,t,i){var n={eventChannel:"BeginPreactivate",preactivated:this.preactivated,intersection:i};this.publish("BeginPreactivate",n)},Preactivate:function(e,t,i){var n={eventChannel:"Preactivate",preactivated:this.preactivated,intersection:i};this.publish("Preactivate",n)},EndPreactivate:function(e,t,i){var n={eventChannel:"EndPreactivate",preactivated:this.preactivated,intersection:i};this.publish("EndPreactivate",n)}});return UWA.namespace("DS/ENOWebNavVolumeQuery/ENOWebNavShapeManipulator",n)}),define("DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryInternalCmd",["UWA/Core","DS/Core/Core","DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADContext"],function(e,t,i,n,a){"use strict";var r=i.extend({init:function(t){e.log("ENOWebNavVolumeQueryInternalCmd: init"),this._parent(t,{mode:"shared",isAsynchronous:!0}),this.setRepeatMode(!1)},beginExecute:function(){e.log("ENOWebNavVolumeQueryInternalCmd: BeginExecute");var t=n._getCurrent(this.options.context),i=a.get().getCommandContext(),r=n.getCommand("VolumeQueryHdr",i);"ApplyVolumeQueryHdr"==t?r.applyVolumeQuery():"CancelVolumeQueryHdr"==t?setTimeout(function(){r.displayNotification("cancel"),r.end()}):"BoxQueryHdr"==t?r.switchVolumeQueryShape("Box"):"SphereQueryHdr"==t?r.switchVolumeQueryShape("Sphere"):"ProximityQueryHdr"==t?r.switchVolumeQueryShape("Proximity"):"SpaceQueryHdr"==t?r.switchVolumeQueryShape("Space"):"VolumeQueryFullInHdr"==t?r.switchVolumeQueryInOutRule("FullIn"):"VolumeQueryPartlyInHdr"==t?r.switchVolumeQueryInOutRule("PartlyIn"):"VolumeQueryFullOutHdr"==t?r.switchVolumeQueryInOutRule("FullOut"):"VolumeQueryPartlyOutHdr"==t?r.switchVolumeQueryInOutRule("PartlyOut"):"VolumeQueryAcrossHdr"==t?r.switchVolumeQueryInOutRule("Across"):"FilteringModeHdr"==t?r.switchFilteringMode(!0):"SelectionModeHdr"==t&&r.switchFilteringMode(!1),this.end()},endExecute:function(){e.log("ENOWebNavVolumeQueryInternalCmd: endExecute")}});return e.namespace("DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryInternalCmd",r)}),define("DS/ENOWebNavVolumeQuery/ENOWebNavBoxHandle",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/Manipulators/LineTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Selection/HSOManager","DS/ENOWebNavVolumeQuery/ENOWebNavHandleArrow","DS/Ruler/Ruler","DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryRobot","DS/Selection/CSOManager","DS/Manipulators/ScreenPlaneManipulator","DS/Visualization/SceneGraphFactory","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p,m,v,x,b,y,f){"use strict";return t.extend({init:function(e,t,i){this._fstAxis=e.fstAxis,this._sndAxis=e.sndAxis,this._thdAxis=e.thdAxis,this._cornerPoint=e.cornerPoint,this._currentUnit=e.currentUnit,this._matrix=i,this.isModifiedByUser=!1,this._context=y.get(),this._boxUpdate=!0,this._viewer=t.getViewer(),this._sceneGraph=new l("VolumeRoot"),this._sceneGraph.setVisibilityFree(!0),this._context.getDecorationBag().add(this._sceneGraph),this._faceNodes=new Array(6),this._token=new Array(6),this._faceNodeBag=new l("BoxVolumeSelector"),this._sceneGraph.add(this._faceNodeBag),this._manips=new Array(6),this._overManager=null,this._geomHelper=new o,this._previousTranslate=null,this._modelEvent=new h;var a=this;this._robot=new m({window:t,viewer:a._viewer,sceneGraph:a._sceneGraph,target:a._faceNodeBag}),this._tokenRobotRuler=this._robot._ruler.subscribe("RulerManipulate",function(e){a.updateBoxFromRobotRulerValue(e)}),this._robotToken=new Array(13),this._savedCornerPoint=new n.Vector3,this._savedFstAxis=new n.Vector3,this._savedSndAxis=new n.Vector3,this._savedThdAxis=new n.Vector3,this._rotationCenter=new n.Vector3,this._preactivatedFaceId=-1,this._preactivatedFace=new l("preactivatedFace"),this._sceneGraph.addChild(this._preactivatedFace);this._arrow=new _({name:"arrowBoxHandle",sceneGraph:this._sceneGraph,width:60,viewer:this._viewer}),this._sceneGraph.addChild(this._arrow),this._arrow.setVisibility(!1),this._whileManipulation=!1,this._arrowInverted=!1,this._manipulatedFace=0,this._ruler=new p(t,{displayOrigin:!0,hideDuringLocalTransfo:!0,startPoint:0,startValue:0,unit:this._currentUnit.unit}),this._tokenLocalRuler=this._ruler.subscribe("RulerManipulate",function(e){a.updateBoxFromRulerValue(e)})},getBag:function(){return this._faceNodeBag},updateBoxFromRulerValue:function(e){var t=null,i=this.getFaceNormal(this._manipulatedFace);this.colinear(i,this._fstAxis)?t=this._fstAxis:this.colinear(i,this._sndAxis)?t=this._sndAxis:this.colinear(i,this._thdAxis)&&(t=this._thdAxis);var a=e.value,r=(new n.Vector3).copy(t),s=t.length();if(a<0)return this._ruler.value=s,void this._ruler.refresh();var o=a-s;if(o<0?(o*=-1,r.setLength(o).multiplyScalar(-1)):r.setLength(o),this._previousTranslate.add(r),0==this._manipulatedFace){if(0==(l=(new n.Vector3).copy(this._thdAxis).add(r)).length())return;this._thdAxis.copy(l)}else if(1==this._manipulatedFace){if(0==(l=(new n.Vector3).copy(this._fstAxis).add(r)).length())return;this._fstAxis.copy(l)}else if(2==this._manipulatedFace){if(0==(l=(new n.Vector3).copy(this._sndAxis).add(r)).length())return;this._sndAxis.copy(l)}else if(3==this._manipulatedFace){if(0==(l=(new n.Vector3).copy(this._fstAxis).add(r)).length())return;this._fstAxis.copy(l)}else if(4==this._manipulatedFace){if(0==(l=(new n.Vector3).copy(this._sndAxis).add(r)).length())return;this._sndAxis.copy(l)}else if(5==this._manipulatedFace){var l;if(0==(l=(new n.Vector3).copy(this._thdAxis).add(r)).length())return;this._thdAxis.copy(l)}0!=this._manipulatedFace&&1!=this._manipulatedFace&&2!=this._manipulatedFace||this._cornerPoint.sub(r),this.refreshAfterManipulation();var c=(new n.Vector3).copy(this._fstAxis).multiplyScalar(.5),h=(new n.Vector3).copy(this._sndAxis).multiplyScalar(.5),u=(new n.Vector3).copy(this._thdAxis).multiplyScalar(.5),d=(new n.Vector3).copy(this._cornerPoint);d.add(c),d.add(h),d.add(u),this._matrix.setPosition(d),this._robot.updateRobotFromMatrix(this._matrix),this._viewer.render(),this._boxUpdate=!1,this.publish("EndBoxChanged")},getParams:function(){var e=(new n.Matrix4).copy(this._matrix).setPosition(this._cornerPoint),t=this._faceNodeBag.getBoundingBox();return{cornerPoint:this._cornerPoint,fstAxis:this._fstAxis,sndAxis:this._sndAxis,thdAxis:this._thdAxis,box:t,matrix:e}},colinear:function(e,t){var i=(new n.Vector3).copy(e),a=(new n.Vector3).copy(t),r=i.cross(a).length();return 0==Math.round(100*r)},display:function(){if(this.colinear(this._fstAxis,this._sndAxis)||this.colinear(this._fstAxis,this._thdAxis)||this.colinear(this._sndAxis,this._thdAxis))console.warn("Some axis are colinear. Box cannot be created.");else{for(var e=0;e<6;e++)this.createFaceAndEdge(e,9689341,6543615);this._robot.setVisibility(!0);var t=new a;t.setFromArray([this._sceneGraph,this._faceNodeBag]),this._robot.setTarget(t),this._robot.updateRobotFromMatrix(this._matrix),this._viewer.render();var i=this;this._robotToken[0]=this._robot._robot.subscribe("LineTranslationBegin",function(e){i.BeginRobotManipulationCB(e)}),this._robotToken[1]=this._robot._robot.subscribe("RotationBegin",function(e){i.BeginRobotManipulationCB(e)}),this._robotToken[2]=this._robot._robot.subscribe("PlaneTranslationBegin",function(e){i.BeginRobotManipulationCB(e)}),this._robotToken[3]=this._robot._robot.subscribe("ScalingBegin",function(e){i.BeginRobotManipulationCB(e)}),this._robotToken[4]=this._robot._robot.subscribe("LineTranslationManipulation",function(e){i.RobotTranslationManipulationCB(e)}),this._robotToken[5]=this._robot._robot.subscribe("RotationManipulation",function(e){i.RobotRotationManipulationCB(e)}),this._robotToken[6]=this._robot._robot.subscribe("PlaneTranslationManipulation",function(e){i.RobotTranslationManipulationCB(e)}),this._robotToken[7]=this._robot._robot.subscribe("ScalingManipulation",function(e){i.RobotScalingManipulationCB(e)}),this._robotToken[8]=this._robot._robot.subscribe("LineTranslationEnd",function(e){i.RobotEndTranslationManipulationCB(e)}),this._robotToken[9]=this._robot._robot.subscribe("RotationEnd",function(e){i.RobotRotationEndCB(e)}),this._robotToken[10]=this._robot._robot.subscribe("PlaneTranslationEnd",function(e){i.RobotEndTranslationManipulationCB(e)}),this._robotToken[11]=this._robot._robot.subscribe("ScalingEnd",function(e){i.RobotEndScalingManipulationCB(e)})}},BeginRobotManipulationCB:function(e){this._savedCornerPoint.copy(this._cornerPoint),this._savedFstAxis.copy(this._fstAxis),this._savedSndAxis.copy(this._sndAxis),this._savedThdAxis.copy(this._thdAxis),this._preactivatedFace.removeChildren(),this._whileManipulation=!0,this._ruler.setVisibleFlag(!1),this._ruler.clear()},RobotTranslationManipulationCB:function(e){this._cornerPoint.copy(this._savedCornerPoint),this._cornerPoint.add(e.translationVector)},RobotRotationManipulationCB:function(e){this._cornerPoint.copy(this._savedCornerPoint),this._fstAxis.copy(this._savedFstAxis),this._sndAxis.copy(this._savedSndAxis),this._thdAxis.copy(this._savedThdAxis),this._cornerPoint.applyMatrix4(e.rotationMatrix),this._fstAxis.applyMatrix4(e.rotationMatrix),this._sndAxis.applyMatrix4(e.rotationMatrix),this._thdAxis.applyMatrix4(e.rotationMatrix),this._rotationCenter.copy(e.rotationCenter)},RobotRotationEndCB:function(e){var t=(new n.Vector3).copy(this._fstAxis).multiplyScalar(.5),i=(new n.Vector3).copy(this._sndAxis).multiplyScalar(.5),a=(new n.Vector3).copy(this._thdAxis).multiplyScalar(.5),r=(new n.Vector3).copy(this._cornerPoint);r.add(t),r.add(i),r.add(a);var s=(new n.Vector3).copy(r).sub(this._rotationCenter);this._cornerPoint.sub(s),this.refreshAfterManipulation(),this.publish("EndBoxChanged")},RobotScalingManipulationCB:function(e){this._fstAxis.copy(this._savedFstAxis),this._sndAxis.copy(this._savedSndAxis),this._thdAxis.copy(this._savedThdAxis),this._cornerPoint.copy(e.scalingCenter),this._fstAxis.multiplyScalar(e.scalingFactor),this._sndAxis.multiplyScalar(e.scalingFactor),this._thdAxis.multiplyScalar(e.scalingFactor);var t=(new n.Vector3).copy(this._fstAxis).multiplyScalar(.5),i=(new n.Vector3).copy(this._sndAxis).multiplyScalar(.5),a=(new n.Vector3).copy(this._thdAxis).multiplyScalar(.5);this._cornerPoint.sub(t),this._cornerPoint.sub(i),this._cornerPoint.sub(a)},RobotEndScalingManipulationCB:function(e){this.refreshAfterManipulation(),this.publish("EndBoxChanged")},RobotEndTranslationManipulationCB:function(e){this.refreshAfterManipulation(),this.publish("EndBoxChanged")},createFaceAndEdge:function(e,t,i){this._faceNodes[e]&&this._faceNodes[e].removeChildren();var a=null,r=null,s=null;switch(e){case 0:a=this._cornerPoint,r=this._sndAxis,s=this._fstAxis;break;case 1:a=this._cornerPoint,r=this._thdAxis,s=this._sndAxis;break;case 2:a=this._cornerPoint,r=this._fstAxis,s=this._thdAxis;break;case 3:a=(new n.Vector3).copy(this._cornerPoint).add(this._fstAxis),r=this._sndAxis,s=this._thdAxis;break;case 4:a=(new n.Vector3).copy(this._cornerPoint).add(this._sndAxis),r=this._thdAxis,s=this._fstAxis;break;case 5:a=(new n.Vector3).copy(this._cornerPoint).add(this._thdAxis),r=this._fstAxis,s=this._sndAxis}var o=this.createRectangle(a,r,s,t,i),c=b.createMeshNode(o);c.excludeFromCSO(!0),c.excludeFromHighlight(!0),c.setSSAO(!1),c.setShadow(!1,!1),this._faceNodes[e]||(this._faceNodes[e]=new l("Face"+e),this._faceNodeBag.add(this._faceNodes[e])),this._faceNodes[e].add(c),this._manips[e]&&this._manips[e].unlink(this._token[e]),this._manips[e]=null,this._manips[e]||(this._manips[e]=this.createManip(e,(new n.Vector3).copy(r).cross(s).normalize()),this._token[e]=this._manips[e].linkToNode(this._faceNodes[e]));this._overManager=this.createManip(-1,new n.Vector3)},refreshAfterManipulation:function(){this._matrix.copy(this._robot._robot.getMatrix()),this._preactivatedFace.removeChildren(),this._whileManipulation=!1;for(var e=0;e<6;e++)this._manips[e]&&this._manips[e].unlink(this._token[e]),this._manips[e]=null,this._faceNodes[e]&&this._faceNodes[e].removeChildren(),this._faceNodes[e]=null;this._faceNodeBag&&(this._faceNodeBag.removeChildren(),this._sceneGraph.remove(this._faceNodeBag)),this._faceNodes=new Array(6),this._faceNodeBag=new l("BoxVolumeSelector"),this._sceneGraph.addChild(this._faceNodeBag),this._manips=new Array(6);for(e=0;e<6;e++)this.createFaceAndEdge(e,9689341,6543615);var t=new a;t.setFromArray([this._sceneGraph,this._faceNodeBag]),this._robot.setTarget(t),this._robot.updateRobotFromMatrix(this._matrix),this._viewer.render()},createRectangle:function(e,t,i,a,r){var s,o,l,c,h,d,_,p,m,v,x;(s=new u.PrimitiveGroup).fillAttr=new u.FillAttributes,s.lineAttr=new u.LineAttributes,s.pointAttr=new u.PointAttributes,(o=new u.Buffer).size=12,o.component=u.VertexComponentEnum.POSITION,o.format=u.DataTypeEnum.FLOAT,o.dimension=3,o.data=new Float32Array(12),(c=new u.Buffer).indexBuffer=!0,c.size=9,c.format=u.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(9),(l=new u.Buffer).size=3,l.component=u.VertexComponentEnum.NORMAL,l.format=u.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(3),(h=new u.Buffer).indexBuffer=!0,h.size=4,h.format=u.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(4),s.addBuffer(0,o),s.addBuffer(1,c),s.addBuffer(2,l),s.addBuffer(3,h),_=0,(d=o.data)[_++]=e.x,d[_++]=e.y,d[_++]=e.z,x=(new n.Vector3).copy(e).add(t),d[_++]=x.x,d[_++]=x.y,d[_++]=x.z,x=(new n.Vector3).copy(e).add(t).add(i),d[_++]=x.x,d[_++]=x.y,d[_++]=x.z,x=(new n.Vector3).copy(e).add(i),d[_++]=x.x,d[_++]=x.y,d[_++]=x.z,(d=c.data)[0]=0,d[1]=1,d[2]=3,d[3]=2,(d=l.data)[0]=0,d[1]=0,d[2]=1,(d=h.data)[0]=0,d[1]=0,d[2]=0,d[3]=0,(p=new u.Primitive).nbIndices=4,p.connectivity=u.ConnectivityTypeEnum.TRIANGLE_STRIP,p.material=new n.MeshBasicMaterial({side:n.DoubleSide,color:a,opacity:.5,transparent:!0}),(m=new u.VertexComponent).component=u.VertexComponentEnum.POSITION,m.nbVertices=4,m.nbValuesPerVertex=3,m.format=u.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=0,m.indices=new u.IndexArray,m.indices.format=u.DataTypeEnum.UINT,m.indices.bufferId=1,m.indices.offset=0,p.addVertexComponent(m),(v=new u.VertexComponent).component=u.VertexComponentEnum.NORMAL,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=u.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=2,v.indices=new u.IndexArray,v.indices.format=u.DataTypeEnum.UINT,v.indices.bufferId=3,v.indices.offset=0,p.addVertexComponent(v),s.addPrimitive(p),_=4,(d=c.data)[_++]=0,d[_++]=1,d[_++]=2,d[_++]=3,d[_++]=0;var b=new u.Primitive;return b.nbIndices=4,b.connectivity=u.ConnectivityTypeEnum.LINE_STRIP,b.attr={fill:new u.FillAttributes,line:new u.LineAttributes(new u.Color(r)),point:new u.PointAttributes},(m=new u.VertexComponent).component=u.VertexComponentEnum.POSITION,m.nbVertices=5,m.nbValuesPerVertex=3,m.format=u.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=0,m.indices=new u.IndexArray,m.indices.format=u.DataTypeEnum.UINT,m.indices.bufferId=1,m.indices.offset=4,b.addVertexComponent(m),s.addPrimitive(b),s.noz=!1,s},createManip:function(e,t){var i=this,a=new c({axis:(new n.Vector3).copy(t)});return a.setExclusive(!0),e>=0&&(a.subscribe("BeginManipulate",function(t){i.beginManipulateCB(e,t)}),a.subscribe("Manipulate",function(t){i.manipulateCB(e,t)}),a.subscribe("EndManipulate",function(t){i.endManipulateCB(e,t)}),a.subscribe("BeginPreactivate",function(t){i.beginPreactivateCB(e,t)}),a.subscribe("Preactivate",function(t){i.PreactivateCB(e,t)}),a.subscribe("EndPreactivate",function(t){i.endPreactivateCB(e,t)})),a},getFaceNormal:function(e){var t=null,i=null;switch(e){case 0:t=(new n.Vector3).copy(this._sndAxis),i=(new n.Vector3).copy(this._fstAxis);break;case 1:t=(new n.Vector3).copy(this._thdAxis),i=(new n.Vector3).copy(this._sndAxis);break;case 2:t=(new n.Vector3).copy(this._fstAxis),i=(new n.Vector3).copy(this._thdAxis);break;case 3:t=(new n.Vector3).copy(this._sndAxis),i=(new n.Vector3).copy(this._thdAxis);break;case 4:t=(new n.Vector3).copy(this._thdAxis),i=(new n.Vector3).copy(this._fstAxis);break;case 5:t=(new n.Vector3).copy(this._fstAxis),i=(new n.Vector3).copy(this._sndAxis)}return(new n.Vector3).copy(i).cross(t).normalize()},positionArrow:function(e,t){var i=null,a=null,r=null;switch(e){case 0:i=(new n.Vector3).copy(this._cornerPoint),a=(new n.Vector3).copy(this._sndAxis),r=(new n.Vector3).copy(this._fstAxis);break;case 1:i=(new n.Vector3).copy(this._cornerPoint),a=(new n.Vector3).copy(this._thdAxis),r=(new n.Vector3).copy(this._sndAxis);break;case 2:i=(new n.Vector3).copy(this._cornerPoint),a=(new n.Vector3).copy(this._fstAxis),r=(new n.Vector3).copy(this._thdAxis);break;case 3:i=(new n.Vector3).copy(this._cornerPoint).add(this._fstAxis),a=(new n.Vector3).copy(this._sndAxis),r=(new n.Vector3).copy(this._thdAxis);break;case 4:i=(new n.Vector3).copy(this._cornerPoint).add(this._sndAxis),a=(new n.Vector3).copy(this._thdAxis),r=(new n.Vector3).copy(this._fstAxis);break;case 5:i=(new n.Vector3).copy(this._cornerPoint).add(this._thdAxis),a=(new n.Vector3).copy(this._fstAxis),r=(new n.Vector3).copy(this._sndAxis)}this._arrow._width;var s=this._arrow.getScaledHeight(),o=a.length();r.length()>o&&(o=r.length());var l=(new n.Vector3).copy(a).setLength(a.length()/2),c=(new n.Vector3).copy(r).setLength(r.length()/2);i.add(l).add(c);var h=(new n.Vector3).copy(r).cross(a).normalize(),u=new n.Matrix4;a.normalize(),r.normalize();var d=u.elements;if(t){h.applyAxisAngle(a,Math.PI);(new n.Vector3).copy(h).setLength(s)}d[0]=a.x,d[1]=a.y,d[2]=a.z,d[4]=r.x,d[5]=r.y,d[6]=r.z,d[8]=h.x,d[9]=h.y,d[10]=h.z,u.setPosition(i),this._arrow.setMatrix(u),this._arrowInverted=t},beginManipulateCB:function(e,t){this._previousTranslate=new n.Vector3(0,0,0),this.positionArrow(e),this._arrow.setVisibility(!0),this._preactivatedFace.removeChildren(),this._whileManipulation=!0,this.isModifiedByUser=!0,this._ruler.clear();(new n.Vector3).getPositionFromMatrix(this._matrix);var i=this.getFaceNormal(e),a=null;this.colinear(i,this._fstAxis)?a=this._fstAxis:this.colinear(i,this._sndAxis)?a=this._sndAxis:this.colinear(i,this._thdAxis)&&(a=this._thdAxis);var r=null,s=null;switch(e){case 0:r=(new n.Vector3).copy(this._cornerPoint),s=this._fstAxis;break;case 1:r=(new n.Vector3).copy(this._cornerPoint),s=this._sndAxis;break;case 2:r=(new n.Vector3).copy(this._cornerPoint).sub(this._thdAxis),s=this._thdAxis;break;case 3:r=(new n.Vector3).copy(this._cornerPoint).add(this._fstAxis).sub(this._thdAxis),s=this._thdAxis;break;case 4:r=(new n.Vector3).copy(this._cornerPoint).add(this._sndAxis),s=this._fstAxis;break;case 5:r=(new n.Vector3).copy(this._cornerPoint).add(this._thdAxis),s=this._sndAxis}var o=(new n.Vector3).copy(i).setLength(a.length()).add((new n.Vector3).copy(s).setLength(s.length()));this._ruler.origin=(new n.Vector3).copy(r).add(o),this._ruler.initValue=a.length(),this._ruler.value=this._ruler.initValue,this._ruler.direction=i.multiplyScalar(-1),this._ruler.setVisibleFlag(!0),this._ruler.display(),this._ruler.beginManipulation(),this._robot.setVisibility(!1),this._viewer.render()},manipulateCB:function(e,t){if(e<0||e>5)console.warn("Invalid callback index.");else{if(0!==this._ruler.getSnappedTranslationVector(t).returnCode)return null;var i=this._ruler.getSnappedTranslationVector(t).snappedTranslationVector,a=(new n.Vector3).copy(i).sub(this._previousTranslate),r=a.dot(this.getFaceNormal(e));if(!(this._ruler.value+a.length()*(r<0?1:-1)<=0)){if(this._previousTranslate.add(a),0==e){if(0==(s=(new n.Vector3).copy(this._thdAxis).sub(a)).length())return;this._thdAxis.copy(s)}else if(1==e){if(0==(s=(new n.Vector3).copy(this._fstAxis).sub(a)).length())return;this._fstAxis.copy(s)}else if(2==e){if(0==(s=(new n.Vector3).copy(this._sndAxis).sub(a)).length())return;this._sndAxis.copy(s)}else if(3==e){if(0==(s=(new n.Vector3).copy(this._fstAxis).add(a)).length())return;this._fstAxis.copy(s)}else if(4==e){if(0==(s=(new n.Vector3).copy(this._sndAxis).add(a)).length())return;this._sndAxis.copy(s)}else if(5==e){var s;if(0==(s=(new n.Vector3).copy(this._thdAxis).add(a)).length())return;this._thdAxis.copy(s)}var o;0!=e&&1!=e&&2!=e||this._cornerPoint.add(a),o=void 0!==t.paths&&1===t.paths.length?t.paths[0].getMatrix():new n.Matrix4;var l=(new n.Vector3).getPositionFromMatrix(o).add(a);o.setPosition(l),t.paths[0].getLastElement(!0).setMatrix(o),this.refresh(e),r>0&&!this._arrowInverted?this.positionArrow(e,!0):r<0&&this._arrowInverted&&this.positionArrow(e,!1);var c=(new n.Vector3).getPositionFromMatrix(this._arrow.getMatrix()).add(a),h=(new n.Matrix4).copy(this._arrow.getMatrix()).setPosition(c);this._arrow.setMatrix(h),this._viewer.render(),this._ruler.value+=a.length()*(r<0?1:-1),this._ruler.refresh();var u=(new n.Vector3).copy(this._fstAxis).multiplyScalar(.5),d=(new n.Vector3).copy(this._sndAxis).multiplyScalar(.5),_=(new n.Vector3).copy(this._thdAxis).multiplyScalar(.5),p=(new n.Vector3).copy(this._cornerPoint);p.add(u),p.add(d),p.add(_),this._matrix.setPosition(p),this._robot.updateRobotFromMatrix(this._matrix),this.publish("BoxChanged")}}},endManipulateCB:function(e,t){this._arrow&&this._arrow.setVisibility(!1),this._ruler.snapping=!1,this._ruler.endManipulation(),this._ruler.display(),this._robot.setVisibility(!0),this._whileManipulation=!1,this._viewer.render(),this._manipulatedFace=e,this.publish("EndBoxChanged")},beginPreactivateCB:function(e,t){if(this._whileManipulation)return!0;var i=null,a=null,r=null;switch(e){case 0:i=this._cornerPoint,a=this._sndAxis,r=this._fstAxis;break;case 1:i=this._cornerPoint,a=this._thdAxis,r=this._sndAxis;break;case 2:i=this._cornerPoint,a=this._fstAxis,r=this._thdAxis;break;case 3:i=(new n.Vector3).copy(this._cornerPoint).add(this._fstAxis),a=this._sndAxis,r=this._thdAxis;break;case 4:i=(new n.Vector3).copy(this._cornerPoint).add(this._sndAxis),a=this._thdAxis,r=this._fstAxis;break;case 5:i=(new n.Vector3).copy(this._cornerPoint).add(this._thdAxis),a=this._fstAxis,r=this._sndAxis}var s=(new n.Vector3).copy(a);s.cross(r),s.normalize(),s.setLength(.05);var o=(new n.Vector3).copy(i).sub(s),l=this.createRectangle(o,a,r,9689341,6543615),c=b.createMeshNode(l);return c.excludeFromCSO(!0),c.excludeFromHighlight(!0),c.setSSAO(!1),c.setShadow(!1,!1),this._preactivatedFace.removeChildren(),this._preactivatedFace.add(c),this._preactivatedFaceId=e,this.positionArrow(e),this._arrow.setVisibility(!0),this._viewer.render(),this.publish("onPreactivate"),!0},PreactivateCB:function(e,t){if(this._whileManipulation)return!0},endPreactivateCB:function(e,t){return!!this._whileManipulation||(this._arrow.setVisibility(!1),this._preactivatedFace.removeChildren(),this._preactivatedFaceId=-1,this._viewer.render(),this.publish("onEndPreactivate"),!0)},refresh:function(e){for(var t=0;t<6;t++)t!=e&&this.createFaceAndEdge(t,9689341,6543615)},clean:function(){for(var e=0;e<6;e++)this._manips[e]&&this._manips[e].unlink(this._token[e]),this._manips[e]=null,this._faceNodes[e]&&this._faceNodes[e].removeChildren(),this._faceNodes[e]=null;this._faceNodeBag&&(this._faceNodeBag.removeChildren(),this._sceneGraph.remove(this._faceNodeBag)),this._preactivatedFace&&(this._preactivatedFace.removeChildren(),this._sceneGraph.remove(this._preactivatedFace)),this._arrow&&this._sceneGraph.remove(this._arrow),this._context.getDecorationBag().remove(this._sceneGraph),this._arrow=null,this._preactivatedFace=null,this._preactivatedFaceId=-1,this._faceNodeBag=null,this._sceneGraph.remove(this._robot._robot),this._robot.setVisibility(!1),this._robot._ruler.setVisibleFlag(!1),this._robot._ruler.clear(),this._ruler.setVisibleFlag(!1),this._ruler.clear();var t=this;this._robotToken.forEach(function(e){t._robot._robot.unsubscribe(e)}),t._robot._ruler.unsubscribe(this._tokenRobotRuler),t._ruler.unsubscribe(this._tokenLocalRuler),this._viewer.render(),delete this._robot,delete this._ruler,delete this._faceNodes,delete this._token,delete this._faceNodeBag,delete this._manips,delete this._geomHelper,delete this._modelEvent,delete this._tokenRobotRuler,delete this._robotToken,delete this._savedCornerPoint,delete this._savedFstAxis,delete this._savedSndAxis,delete this._savedThdAxis,delete this._rotationCenter,delete this._preactivatedFace,delete this._arrow},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},publish:function(e){return this._modelEvent.publish({event:e,context:this})}})}),define("DS/ENOWebNavVolumeQuery/ENOWebNavProximityHandle",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/CoreEvents/ModelEvents","DS/ENOWebNavVolumeQuery/ENOWebNavShapeManipulator","DS/ENOWebNavVolumeQuery/ENOWebNavHandleArrow","DS/Ruler/Ruler","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphFactory","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p,m){"use strict";return t.extend({init:function(e){this._offset=0,this._node3D=e.node,this._matrix=e.matrix,this._window=e.window,this._initPath=e.initPath,this._currentUnit=e.currentUnit,this._viewer=this._window.getViewer(),this._sceneGraph=new r("VolumeRoot"),this._sceneGraph.setVisibilityFree(!0),this._context=p.get(),this._context.getDecorationBag().add(this._sceneGraph),this._geomHelper=new a,this._topCircleBag=new r("TopCircleBag"),this._sceneGraph.addChild(this._topCircleBag),this._dashedLinesBag=new r("DashedLinesBag"),this._sceneGraph.addChild(this._dashedLinesBag),this._bottomCircleBag=new r("BottomCircleBag"),this._sceneGraph.addChild(this._bottomCircleBag),this._modelEvent=new s,this._manips=null,this._token=0;this._arrow=new l({name:"arrowBoxHandle",sceneGraph:this._sceneGraph,width:60,viewer:this._viewer}),this._sceneGraph.addChild(this._arrow),this._arrow.setVisibility(!1),this._normalVector=null,this._intersectionPosition=null,this._topDiskNode=null,this._previousTranslate=null,this._manipulatorCreated=!1;var t=this;this._ruler=new c(this._window,{displayOrigin:!0,hideDuringLocalTransfo:!0,unit:this._currentUnit.unit}),this._tokenLocalRuler=this._ruler.subscribe("RulerManipulate",function(e){t.updateProximityHandleFromRulerValue(e)})},getParams:function(){return{offset:this._offset,node:this._node3D}},updateProximityHandleFromRulerValue:function(e){var t=e.value;if(t<0)return this._ruler.value=this._previousTranslate.length(),void this._ruler.refresh();var n=new i.Vector3;if(this._previousTranslate){this._offset>t?n.copy(this._previousTranslate).setLength(this._offset-t).multiplyScalar(-1):n.copy(this._previousTranslate).setLength(t-this._offset);var a=n.dot(this._normalVector);this._previousTranslate.add(n),this._offset=t;var r=(new i.Vector3).copy(this._normalVector).setLength(this._offset),s=(new i.Vector3).copy(this._intersectionPosition).add(r);a>0?this.positionArrow(this._normalVector,s,!1):this.positionArrow(this._normalVector,s,!0),this.updateLine(this._intersectionPosition,this._normalVector,this._offset),this.updateGeometryPosition(this._normalVector,s),this.publish("EndBoxChanged"),this._viewer.render()}else this._offset=t},display:function(){this._manip=this.createManip(),this._manip.setExclusive(!0),this._token=this._manip.linkToNode(this._initPath),this._viewer.render(),this._whileManipulation=!1},createProximityBottomCircle:function(e,t){this._bottomCircleBag&&this._bottomCircleBag.removeChildren();var n=this.retrievePositionMatrix(e,t),a=this._node3D.getBoundingSphere().clone(),s=this._geomHelper.createCircle({radius:a.radius/4,segments:32,fill:!0}),o=new i.MeshBasicMaterial({side:i.DoubleSide,color:9689341,opacity:.5,transparent:!0});o.force=!0;var l=u.createMeshNode(s,o);l.excludeFromCSO(!0),l.excludeFromHighlight(!0),l.setSSAO(!1),l.setShadow(!1,!1);var c=new r("BottomDiskNode");c.addChild(l),c.setMatrix(n),this._bottomCircleBag.addChild(c);var h=new i.Vector3(1,0,0).cross(e).setLength(a.radius/10),d=(new i.Vector3).copy(t).add(h),_=(new i.Vector3).copy(t).sub(h),p=[d,_],m=this._geomHelper.createLine({points:p});(o=new i.MeshBasicMaterial({color:0})).force=!0;var v=u.createMeshNode(m,o);v.excludeFromCSO(!0),v.excludeFromHighlight(!0),v.setSSAO(!1),v.setShadow(!1,!1),this._bottomCircleBag.addChild(v);var x=(new i.Vector3).copy(h).cross(e).setLength(a.radius/10);p=[d=(new i.Vector3).copy(t).add(x),_=(new i.Vector3).copy(t).sub(x)],m=this._geomHelper.createLine({points:p}),(o=new i.MeshBasicMaterial({color:0})).force=!0,(v=u.createMeshNode(m,o)).excludeFromCSO(!0),v.excludeFromHighlight(!0),v.setSSAO(!1),v.setShadow(!1,!1),this._bottomCircleBag.addChild(v)},createProximityTopCircle:function(){this._topCircleBag&&this._topCircleBag.removeChildren();var e=this._node3D.getBoundingSphere().clone(),t=this._geomHelper.createCircle({radius:e.radius/2,segments:32,fill:!0}),n=new i.MeshBasicMaterial({side:i.DoubleSide,color:9689341,opacity:.5,transparent:!0});n.force=!0;var a=u.createMeshNode(t,n);a.excludeFromCSO(!0),a.excludeFromHighlight(!0),a.setSSAO(!1),a.setShadow(!1,!1),this._topDiskNode=new r("TopDiskNode"),this._topDiskNode.addChild(a),this._topCircleBag.addChild(this._topDiskNode),this._manipulatorCreated=!0},colinear:function(e,t){var n=(new i.Vector3).copy(e),a=(new i.Vector3).copy(t),r=n.cross(a).length();return 0===Math.round(100*r)},retrievePositionMatrix:function(e,t){var n=new i.Vector3(1,0,0).cross(e).normalize();this.colinear(new i.Vector3(1,0,0),n)&&(n=new i.Vector3(0,1,0).cross(e).normalize());var a=(new i.Vector3).copy(e),r=(new i.Vector3).copy(n).cross(a).normalize();a.applyAxisAngle(r,Math.PI);var s=new i.Matrix4,o=(new i.Vector3).copy(t),l=s.elements;return l[0]=n.x,l[1]=n.y,l[2]=n.z,l[4]=r.x,l[5]=r.y,l[6]=r.z,l[8]=a.x,l[9]=a.y,l[10]=a.z,s.setPosition(o),s},updateGeometryPosition:function(e,t){var i=this.retrievePositionMatrix(e,t);this._topDiskNode.setMatrix(i)},updateLine:function(e,t,n){this._dashedLinesBag&&this._dashedLinesBag.removeChildren();var a=(new i.Vector3).copy(e),r=(new i.Vector3).copy(t).setLength(n),s=[a,(new i.Vector3).copy(a).add(r)],o=this._geomHelper.createLine({points:s}),l=new i.LineBasicMaterial({color:"black",dashSize:7,gapSize:4});l.depthTest=!1,l.force=!0;var c=u.createMeshNode(o,l);this._dashedLinesBag.addChild(c),c.excludeFromCSO(!0),c.excludeFromHighlight(!0),c.setSSAO(!1),c.setShadow(!1,!1)},createManip:function(){var e=this,t=new o(this._viewer);return t.subscribe("BeginManipulate",function(t){e.beginManipulateCB(t)}),t.subscribe("Manipulate",function(t){e.manipulateCB(t)}),t.subscribe("EndManipulate",function(t){e.endManipulateCB(t)}),t.subscribe("BeginPreactivate",function(t){e.beginPreactivateCB(t)}),t.subscribe("Preactivate",function(t){e.preactivateCB(t)}),t.subscribe("EndPreactivate",function(t){e.endPreactivateCB(t)}),t},positionArrow:function(e,t,n){var a=new i.Vector3(0,0,1),r=(new i.Vector3).copy(e).applyAxisAngle(a,Math.PI/2),s=(new i.Vector3).copy(e),o=(new i.Vector3).copy(r).cross(s).normalize();s.applyAxisAngle(o,Math.PI);var l=new i.Matrix4,c=(new i.Vector3).copy(t);if(n){s.applyAxisAngle(o,Math.PI);(new i.Vector3).copy(e).setLength(this._arrow._height)}var h=l.elements;h[0]=r.x,h[1]=r.y,h[2]=r.z,h[4]=o.x,h[5]=o.y,h[6]=o.z,h[8]=s.x,h[9]=s.y,h[10]=s.z,l.setPosition(c),this._arrow.setMatrix(l)},beginManipulateCB:function(e){this._normalVector||(this._normalVector=(new i.Vector3).copy(e.intersection.normal),this._intersectionPosition=(new i.Vector3).copy(e.intersection.position));var t=(new i.Vector3).copy(this._normalVector).setLength(this._offset),n=(new i.Vector3).copy(this._intersectionPosition).add(t);this.positionArrow(e.intersection.normal,n),this._previousTranslate=new i.Vector3(0,0,0),this._manipulatorCreated||(this.createProximityTopCircle(),this.updateGeometryPosition(e.intersection.normal,n),this.createProximityBottomCircle(e.intersection.normal,this._intersectionPosition),this._ruler.clear(),this._ruler.origin=(new i.Vector3).copy(this._intersectionPosition),this._ruler.initValue=0,this._ruler.value=this._offset,this._ruler.direction=this._normalVector),this._ruler.setVisibleFlag(!0),this._ruler.display(),this._ruler.beginManipulation(),this._arrow.setVisibility(!0),this._viewer.render(),this._whileManipulation=!0},manipulateCB:function(e){var t=(new i.Vector3).copy(e.translationVector),n=(new i.Vector3).copy(t).sub(this._previousTranslate);if(0!==n.x||0!==n.y||0!==n.z){if(this._ruler.snapping=!1,e.intersection.path.length){if(!(e.intersection.path[0].externalPath.length>1))return null;if("ruler"==e.intersection.path[0].externalPath[1].name){this._ruler.snapping=!0;var a=this._ruler.initValue+e.translationVector.length()*(this._ruler.direction.dot(e.translationVector)>0?1:-1);a=10*Math.round(a/10),a-=this._ruler.initValue,t=(new i.Vector3).copy(this._ruler.direction).multiplyScalar(a)}}var r=n.dot(this._normalVector);n=(new i.Vector3).copy(t).sub(this._previousTranslate);var s=this._ruler.value+n.length()*(r>0?1:-1);if(!(s<=0)){this._ruler.value=s,this._ruler.refresh(),this._previousTranslate.add(n);var o=(new i.Vector3).copy(this._normalVector).setLength(this._offset).add(n);this._offset=o.length();var l=(new i.Vector3).copy(this._intersectionPosition).add(o);r>0?this.positionArrow(this._normalVector,l,!1):this.positionArrow(this._normalVector,l,!0),this.updateLine(this._intersectionPosition,this._normalVector,this._offset),this.updateGeometryPosition(this._normalVector,l),this._viewer.render(),this.publish("EndBoxChanged")}}},endManipulateCB:function(e){this._manip&&this._manip.unlink(this._token),this._manip=this.createManip(),this._manipulatorCreated?this._token=this._manip.linkToNode(this._topCircleBag):this._token=this._manip.linkToNode(this._initPath),this._arrow.setVisibility(!1),this._ruler.snapping=!1,this._ruler.endManipulation(),this._ruler.display(),this._viewer.render(),this._whileManipulation=!1;var t=this.getParams();this.publish("EndBoxChanged",t)},beginPreactivateCB:function(e){if(this._whileManipulation)return!0;this.publish("onPreactivate")},preactivateCB:function(e){if(!this._whileManipulation){if(this._manipulatorCreated){var t=(new i.Vector3).copy(this._normalVector).setLength(this._offset),n=(new i.Vector3).copy(this._intersectionPosition).add(t);this.positionArrow(this._normalVector,n)}else this.positionArrow(e.intersection.normal,e.intersection.position);return this._arrow.setVisibility(!0),this._viewer.render(),!0}},endPreactivateCB:function(e){if(!this._whileManipulation)return this._arrow.setVisibility(!1),this._viewer.render(),!0},clean:function(){this._ruler.setVisibleFlag(!1),this._ruler.clear(),this._manip&&this._manip.unlink(this._token),this._arrow&&this._sceneGraph.remove(this._arrow),this._arrow=null,this._bottomCircleBag&&this._bottomCircleBag.removeChildren(),this._topCircleBag&&this._topCircleBag.removeChildren(),this._dashedLinesBag&&this._dashedLinesBag.removeChildren(),this._sceneGraph.remove(this._dashedLinesBag),this._sceneGraph.remove(this._topCircleBag),this._sceneGraph.remove(this._bottomCircleBag),this._context.getDecorationBag().remove(this._sceneGraph),this._bottomCircleBag=null,this._topCircleBag=null,this._dashedLinesBag=null;this._ruler.unsubscribe(this._tokenLocalRuler),delete this._geomHelper,delete this._topCircleBag,delete this._dashedLinesBag,delete this._bottomCircleBag,delete this._modelEvent,delete this._arrow,delete this._ruler,delete this._tokenLocalRuler,this._viewer.render()},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},publish:function(e,t){return this._modelEvent.publish({event:e,data:t,context:this})}})}),define("DS/ENOWebNavVolumeQuery/ENOWebNavSphereHandle",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/CoreEvents/Events","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/CoreEvents/ModelEvents","DS/ENOWebNavVolumeQuery/ENOWebNavShapeManipulator","DS/ENOWebNavVolumeQuery/ENOWebNavHandleArrow","DS/Ruler/Ruler","DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryRobot","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p,m,v){"use strict";return t.extend({init:function(e,t,i){this._savedCenter=new n.Vector3,this._savedRadius=new n.Vector3,this._radius=e.radius,this._center=e.center,this._currentUnit=e.currentUnit,this._matrix=(new n.Matrix4).copy(i),this._sceneGraph=new o("VolumeRoot"),this._sceneGraph.setVisibilityFree(!0),this._viewer=t.getViewer(),this._context=m.get(),this._context.getDecorationBag().add(this._sceneGraph),this._sphereNode=null,this._sphereBag=new o,this._sphereBag.name="SphereVolumeSelector",this._sceneGraph.addChild(this._sphereBag),this._geomHelper=new s,this.isModifiedByUser=!1;var a=this;this._robot=new d({window:t,viewer:a._viewer,sceneGraph:a._sceneGraph,target:a._sphereBag}),this._tokenRobotRuler=this._robot._ruler.subscribe("RulerManipulate",function(e){a.updateSphereFromRobotRulerValue(e)}),this._robotToken=new Array(9),this._modelEvent=new l,this._manips=null,this._token=0,this._previousTranslate=null,this._normalVector=null,this._sphere=null;this._arrow=new h({name:"arrowBoxHandle",sceneGraph:this._sceneGraph,width:60,viewer:this._viewer}),this._sceneGraph.addChild(this._arrow),this._arrow.setVisibility(!1),this._ruler=new u(t,{displayOrigin:!0,hideDuringLocalTransfo:!0,startPoint:0,startValue:0,unit:this._currentUnit.unit}),this._tokenLocalRuler=this._ruler.subscribe("RulerManipulate",function(e){a.updateSphereFromRulerValue(e)})},getParams:function(){return{center:this._center,radius:this._radius}},getBag:function(){return this._sphereBag},updateSphereFromRulerValue:function(e){if(e.value<0)return this._ruler.value=this._previousTranslate.length(),void this._ruler.refresh();var t=(new n.Vector3).copy(e.translationVector);0==t.x&&0==t.y&&0==t.z||(this._previousTranslate.add(t),this._radius=e.value,this.createSphere(),this._manip.unlink(this._token),this._manip=this.createManip(),this._token=this._manip.linkToNode(this._sphereBag),this.publish("EndBoxChanged"),this._viewer.render())},display:function(){this.createSphere(),this._manip=this.createManip(),this._token=this._manip.linkToNode(this._sphereBag),this._robot.setVisibility(!0);var e=new a;e.setFromArray([this._sceneGraph,this._sphereBag]),this._robot._robot.target=e,this._robot.updateRobotFromMatrix(this._matrix),this._viewer.render();var t=this;this._robotToken[0]=this._robot._robot.subscribe("LineTranslationBegin",function(e){t.BeginRobotManipulationCB(e)}),this._robotToken[1]=this._robot._robot.subscribe("PlaneTranslationBegin",function(e){t.BeginRobotManipulationCB(e)}),this._robotToken[2]=this._robot._robot.subscribe("ScalingBegin",function(e){t.BeginRobotManipulationCB(e)}),this._robotToken[3]=this._robot._robot.subscribe("LineTranslationManipulation",function(e){t.RobotTranslationManipulationCB(e)}),this._robotToken[4]=this._robot._robot.subscribe("PlaneTranslationManipulation",function(e){t.RobotTranslationManipulationCB(e)}),this._robotToken[5]=this._robot._robot.subscribe("ScalingManipulation",function(e){t.RobotScalingManipulationCB(e)}),this._robotToken[6]=this._robot._robot.subscribe("LineTranslationEnd",function(e){t.RobotEndTranslationManipulationCB(e)}),this._robotToken[7]=this._robot._robot.subscribe("PlaneTranslationEnd",function(e){t.RobotEndTranslationManipulationCB(e)}),this._robotToken[8]=this._robot._robot.subscribe("ScalingEnd",function(e){t.RobotEndScalingManipulationCB(e)})},BeginRobotManipulationCB:function(e){this._savedCenter.copy(this._center),this._savedRadius=this._radius,this._ruler.setVisibleFlag(!1),this._ruler.clear()},RobotTranslationManipulationCB:function(e){this._center.copy(this._savedCenter),this._center.add(e.translationVector)},RobotScalingManipulationCB:function(e){this._radius=this._savedRadius,this._radius*=e.scalingFactor},RobotEndTranslationManipulationCB:function(e){this.refreshAfterManipulation(),this.publish("EndBoxChanged")},RobotEndScalingManipulationCB:function(e){this.refreshAfterManipulation(),this.publish("BoxChanged"),this.publish("EndBoxChanged")},refreshAfterManipulation:function(){this._matrix=(new n.Matrix4).copy(this._robot._robot.getMatrix()),this._sphereNode&&this._sphereNode.removeChildren(),this._sphereNode=null,this._sphereBag&&(this._sphereBag.removeChildren(),this._sceneGraph.remove(this._sphereBag)),this._sphereBag=null,this._sphereBag=new o,this._sceneGraph.addChild(this._sphereBag),this._manip=null,this.createSphere(),this._manip=this.createManip(),this._token=this._manip.linkToNode(this._sphereBag);var e=new a;e.setFromArray([this._sceneGraph,this._sphereBag]),this._robot._robot.target=e,this._viewer.render()},createSphere:function(){this._sphere&&(this._sphere.radius=this._radius),this._sphereNode&&this._sphereNode.removeChildren();var e=(new n.Matrix4).copy(this._matrix);this._sphere=this._geomHelper.CreateVis3DSphere({matrix:e,radius:this._radius});var t=new n.MeshBasicMaterial({side:n.DoubleSide,color:9689341,opacity:.5,transparent:!0});t.force=!0;var i=p.createMeshNode(this._sphere,t);this._sphereNode||(this._sphereNode=new o,this._sphereBag.add(this._sphereNode)),i.excludeFromCSO(!0),i.excludeFromHighlight(!0),i.setSSAO(!1),i.setShadow(!1,!1),this._sphereNode.add(i);var a=this._geomHelper.createCircle({radius:this._radius,segments:64,fill:!1,color:new _.Color(99/255,216/255,1,1)}),r=new n.LineBasicMaterial({color:9689341,linewidth:1,opacity:1}),s=p.createMeshNode(a,r);s.setMatrix(e),s.excludeFromCSO(!0),s.excludeFromHighlight(!0),s.setSSAO(!1),s.setShadow(!1,!1),this._sphereNode.add(s)},createManip:function(){var e=this,t=new c(this._viewer);return t.subscribe("BeginManipulate",function(t){e.beginManipulateCB(t)}),t.subscribe("Manipulate",function(t){e.manipulateCB(t)}),t.subscribe("EndManipulate",function(t){e.endManipulateCB(t)}),t.subscribe("Preactivate",function(t){e.preactivateCB(t)}),t.subscribe("EndPreactivate",function(t){e.endPreactivateCB(t)}),t},positionArrow:function(e,t,i){var a=new n.Vector3(0,0,1),r=(new n.Vector3).copy(e).applyAxisAngle(a,Math.PI/2),s=(new n.Vector3).copy(e),o=(new n.Vector3).copy(r).cross(s).normalize();s.applyAxisAngle(o,Math.PI);var l=new n.Matrix4,c=(new n.Vector3).copy(t);if(i){s.applyAxisAngle(o,Math.PI);var h=(new n.Vector3).copy(e).setLength(this._arrow.getScaledHeight());c.add(h)}var u=l.elements;u[0]=r.x,u[1]=r.y,u[2]=r.z,u[4]=o.x,u[5]=o.y,u[6]=o.z,u[8]=s.x,u[9]=s.y,u[10]=s.z,l.setPosition(c),this._arrow.setMatrix(l),this._arrow.setVisibility(!0)},beginManipulateCB:function(e){this.positionArrow(e.intersection.normal,e.intersection.position),this._previousTranslate=new n.Vector3(0,0,0),this._normalVector=(new n.Vector3).copy(e.intersection.normal),this._ruler.clear(),this._ruler.origin=(new n.Vector3).copy(this._center),this._ruler.initValue=this._radius,this._ruler.value=this._ruler.initValue,this._ruler.direction=e.intersection.normal,this._ruler.setVisibleFlag(!0),this._ruler.display(),this._ruler.beginManipulation(),this._robot.setVisibility(!1),this._viewer.render(),this.isModifiedByUser=!0},manipulateCB:function(e){if(0!==this._ruler.getSnappedTranslationVector(e).returnCode)return null;var t=this._ruler.getSnappedTranslationVector(e).snappedTranslationVector,i=(new n.Vector3).copy(t).sub(this._previousTranslate);if(0!=i.x||0!=i.y||0!=i.z){var a=i.dot(this._normalVector);i=(new n.Vector3).copy(t).sub(this._previousTranslate);var r=this._ruler.value+i.length()*(a>0?1:-1);if(!(r<=0)){this._ruler.value=r,this._ruler.refresh(),this._previousTranslate.add(i);var s=(new n.Vector3).copy(this._normalVector).setLength(this._radius).add(i);this._radius=s.length(),this.createSphere();var o=(new n.Vector3).copy(this._center).add(s);a>0?this.positionArrow(this._normalVector,o,!1):this.positionArrow(this._normalVector,o,!0),this._viewer.render(),this.publish("EndBoxChanged")}}},endManipulateCB:function(e){this._manip.unlink(this._token),this._manip=this.createManip(),this._token=this._manip.linkToNode(this._sphereBag),this._arrow.setVisibility(!1),this._ruler.snapping=!1,this._ruler.endManipulation(),this._ruler.display(),this._robot.setVisibility(!0),this._viewer.render(),this.publish("EndBoxChanged")},preactivateCB:function(e){return this.positionArrow(e.intersection.normal,e.intersection.position),this._arrow.setVisibility(!0),this._viewer.render(),this.publish("onPreactivate"),!0},endPreactivateCB:function(e){return this._arrow.setVisibility(!1),this._viewer.render(),this.publish("onEndPreactivate"),!0},clean:function(){this._sphereNode&&this._sphereNode.removeChildren(),this._sphereNode=null,this._sphereBag&&(this._sphereBag.removeChildren(),this._sceneGraph.remove(this._sphereBag)),this._sphereBag=null,this._sceneGraph.remove(this._robot._robot),this._robot.setVisibility(!1),this._robot._ruler.setVisibleFlag(!1),this._robot._ruler.clear(),this._ruler.setVisibleFlag(!1),this._ruler.clear();var e=this;this._robotToken.forEach(function(t){e._robot._robot.unsubscribe(t)}),e._robot._ruler.unsubscribe(this._tokenRobotRuler),e._ruler.unsubscribe(this._tokenLocalRuler),this._manip.unlink(this._token),this._arrow&&this._sceneGraph.remove(this._arrow),this._context.getDecorationBag().remove(this._sceneGraph),this._arrow=null,delete this._savedCenter,delete this._savedRadius,delete this._matrix,delete this._sphereBag,delete this._geomHelper,delete this._robot,delete this._tokenRobotRuler,delete this._robotToken,delete this._modelEvent,delete this._arrow,delete this._ruler,delete this._tokenLocalRuler,this._viewer.render()},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},publish:function(e){return this._modelEvent.publish({event:e,context:this})}})}),define("DS/ENOWebNavVolumeQuery/ENOWebNavSpaceHandle",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Visualization/GeometryHelper","DS/Visualization/Node3D","DS/CoreEvents/ModelEvents","DS/ENOWebNavVolumeQuery/ENOWebNavShapeManipulator","DS/ENOWebNavVolumeQuery/ENOWebNavHandleArrow","DS/Ruler/Ruler","DS/Visualization/Mesh3D","DS/Visualization/SceneGraphFactory","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p){"use strict";return t.extend({init:function(e){this._node3D=e.node,this._matrix=e.matrix,this._window=e.window,this._initPath=e.initPath,this._viewer=this._window.getViewer(),this._context=p.get(),this._modelEvent=new s},getParams:function(){return{node:this._node3D}},display:function(){},clean:function(){},subscribe:function(e,t){return this._modelEvent.subscribe({event:e},t)},unsubscribe:function(e){this._modelEvent.unsubscribe(e)},publish:function(e,t){return this._modelEvent.publish({event:e,data:t,context:this})}})}),define("DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryCmd",["UWA/Core","DS/Core/Core","DS/CoreEvents/Events","DS/ApplicationFrame/Command","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/ApplicationFrame/ContextualBar","DS/VisuEvents/EventsManager","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert","DS/PADUtils/PADPromise","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryPanel","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/PADUtils/PADUtilsServices","i18n!DS/ENOWebNavVolumeQuery/assets/nls/ENOWebNavVolumeQuery.json"],function(e,t,i,n,a,r,s,o,l,c,h,u,d,_,p,m,v,x,b,y,f){"use strict";const w=e=>b.Length&&b.Length[e]&&b.Length[e].symbol?b.Length[e].symbol:"mm";var g=n.extend({_availableForRole:!0,_prefManager:null,init:function(t){e.log("ENOWebNavVolumeQueryCmd: init");var i=this;this._parent(t,{mode:"exclusive",isAsynchronous:!0}),i._selectedObjsPathElt=[],i._CBTokens=[],i._volumeSelectionShape=null,i._endBoxManipulation=!1,i.setRepeatMode(!1),i._panelCreation=0,i._pickCount=0,i._completionNeeded=!0,i._sceneGraphOverrideSet=null,i._volumeType=0,i._volumeShape=1,i._intersectionMode=0,i._selectionMode=0,i._lockContextBarPosition=!1,i._onlyRepSelected=!0,i._proximityAvailable=!0,i.selectObjName="Please select an Object",i._authoringMode=!1,i._shape=0,i._shapeHdrList=["BoxQueryHdr","SphereQueryHdr","ProximityQueryHdr","SpaceQueryHdr"],i._inOutHdrList=["VolumeQueryPartlyInHdr","VolumeQueryFullInHdr","VolumeQueryPartlyOutHdr","VolumeQueryFullOutHdr","VolumeQueryAcrossHdr"],i._volumeOpenBIData=t.args&&t.args.biData?t.args.biData:null,this._currentUnit={nls:"mm",unit:"Millimeter"},this._decimalRO="3",i._context=h.get(i.options.context),i._context.getViewer().setPickingPriority([{id:"HIGHP2",priority:20},{id:"LOWP",priority:-3},{id:"HIGHP1",priority:12}]),i._window=i._context.getFrameWindow(),void 0!==i._context.getWidget()&&null!==i._context.getWidget()&&i._context.getWidget().widgetDomain&&i._context.getWidget().widgetDomain.indexOf("volume_query_filtering")>0&&(i._selectionModeHdrList=["PADSelectionModeHdr","PADFilteringModeHdr"]),"ENOPAD3DViewer"!==i._context.name&&"ENO3DView"!==i._context.name||(i._CBTokens.push(i._context.subscribe({event:"onIndexAvalabilityChange"},function(e){e.availability?i._authoringMode=!1:i._authoringMode=!0})),i._CBTokens.push(i._context.subscribe({event:"onVolumeOpen"},i._onVolumeOpenFromFilter.bind(i))),t.args&&t.args.changeType&&i._onVolumeOpenFromFilter({changeType:t.args.changeType}),i._CBTokens.push(i._context.subscribe({event:"onAuthoringSwitch"},function(e){i._authoringMode=e.state})),i._CBTokens.push(i._context.subscribe({event:"onRootAdded"},this._checkAvailability.bind(this))),i._CBTokens.push(i._context.subscribe({event:"onRootRemoved"},this._checkAvailability.bind(this))),this._checkAvailability()),i.addToCsoCallback=null,this._loadMePreferences()},_onVolumeOpenFromFilter:function(e){this._context._volumePanel=this._panelCreation,e&&(void 0!==e.changeType?"box"==e.changeType.type?this._volumeType=0:"sphere"==e.changeType.type?this._volumeType=1:"proximity"==e.changeType.type?this._volumeType=2:"space"==e.changeType.type&&(this._volumeType=3):e.biData?this.ngfilterVolumeUpdate(e.biData):!0===e.closePanel&&this._panelCreation>0&&this.end(),1==e.error&&(this.updateVolumeQuery({action:"cancel"}),this.displayNotification("InvalidProximityData")))},_loadMePreferences:function(){return new Promise(function(e,t){b.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay"]}]).then(function(t){t.repositories.length&&t.repositories[0].preferences&&t.repositories[0].preferences.length&&(this._currentUnit={nls:w(t.repositories[0].preferences[0].value),unit:t.repositories[0].preferences[0].value},this._decimalRO=t.repositories[0].preferences[1].value),e()}.bind(this)).catch(t)}.bind(this))},_checkAvailability:function(){var e=this._context.getRoots();if(0!==e.length){for(var t=!1,i=0;i<e.length;i++)if(h.get().getController().isRootSupported(v.getNodeID(e[i]))){t=!0;break}t?this.enable():this.disable()}else this.disable()},_isFilterOpen:function(){var e=this;e._context._controller.isFilterOpen(function(t){if(!0!==t.filterAvailable)e._panel._filterExpander&&(e._panel._filterExpander.disabled=!0,e._panel._filterExpander.close()),e._panel.okButton.label=f.okButton,e._panel.cancelButton.label=f.cancelButton;else{null==e._vfId&&e._panel&&e._panel._updateFilter&&(e._panel._updateFilter.disabled=!0);var i=!1,n=e._context.getController(),a=n.buildArrayFromPath(e._selectedObjsPathElt[0]);e._selectedObjsPathElt.forEach(function(t){var r=n.buildArrayFromPath(t);r[0]!==a[0]&&(i=!0),e._rootIdsArray.push(r)}),e._panel&&e._panel._filterButton&&(e._panel._filterExpander&&1==i||e._panel._addFilter&&e._panel._updateFilter&&e._panel._addFilter.disabled&&e._panel._updateFilter.disabled?(e._panel._filterButton.disabled=!0,e._rootIdsArray=[]):e._panel._filterButton.disabled=!1)}})},ngfilterVolumeUpdate:function(e){var t=this;if(t._setId=e.setId,t._vfId=e.id,t._vfDispName=e.displayName,t._vfFilteredRoot=e.filteredRoot,t._volumeShape=1,"update"==e.action?(t._panel._updateFilter.checkFlag=!0,t._panel._updateFilter.disabled=!1,t._panel._updateFilter.label=f.updateFilter+": "+t._vfDispName):(t._panel._addFilter.checkFlag=!0,t._panel._updateFilter.label=f.updateFilter),t._panel._filterExpander.expandedFlag=!0,e.volume){switch("partly_in"===e.volume.intersection_mode?(t._intersectionMode=0,t._panel._partlyInStarter.checkFlag=!0):"fully_in"==e.volume.intersection_mode?(t._intersectionMode=1,t._panel._fullyInStarter.checkFlag=!0):"partly_out"==e.volume.intersection_mode?(t._intersectionMode=2,t._panel._partlyOutStarter.checkFlag=!0):"fully_out"==e.volume.intersection_mode?(t._intersectionMode=3,t._panel._fullyOutStarter.checkFlag=!0):"across"==e.volume.intersection_mode&&(t._intersectionMode=4,t._panel._acrossStarter.checkFlag=!0),e.volume.type){case"box":0!==t._volumeShape&&(t._panel._boxStarter.onClick(),t._panel._boxStarter.checkFlag=!0);break;case"sphere":0!==t._volumeShape&&(t._panel._sphereStarter.checkFlag=!0,t._panel._sphereStarter.onClick());break;case"proximity":r.empty(),s.empty();var i=[],n=[],a=t._context.unstreamPath(e.volume.root_path_physicalid[0]);i.push({pathElement:a}),n.push(i[0].pathElement),t._selectedObjsPathElt=n,t._panel._proximityStarter.checkFlag=!0,t._panel._proximityStarter.onClick();break;case"space":r.empty(),s.empty();i=[],n=[],a=t._context.unstreamPath(e.volume.root_path_physicalid[0]);i.push({pathElement:a}),n.push(i[0].pathElement),t._selectedObjsPathElt=n,t._panel._spaceStarter.checkFlag=!0,t._panel._spaceStarter.onClick(),t._panel._addFilter.disabled=!0}setTimeout(function(){if("box"==e.volume.type){let i,n;i&&n?(i=t._previousCorners.corner_min,n=t._previousCorners.corner_max):(i=[e.volume.transformation_matrix[9],e.volume.transformation_matrix[10],e.volume.transformation_matrix[11]],n=[Number(e.volume.corner_max[0])+Number(e.volume.transformation_matrix[9]),Number(e.volume.corner_max[1])+Number(e.volume.transformation_matrix[10]),Number(e.volume.corner_max[2])+Number(e.volume.transformation_matrix[11])]),t._panel._minX.value=b.convert(Number(i[0]),"length","mm",t._currentUnit.unit),t._panel._minY.value=b.convert(Number(i[1]),"length","mm",t._currentUnit.unit),t._panel._minZ.value=b.convert(Number(i[2]),"length","mm",t._currentUnit.unit),t._panel._maxX.value=b.convert(Number(n[0]),"length","mm",t._currentUnit.unit),t._panel._maxY.value=b.convert(Number(n[1]),"length","mm",t._currentUnit.unit),t._panel._maxZ.value=b.convert(Number(n[2]),"length","mm",t._currentUnit.unit),t.updateBox3DAfterUpdate(e.volume)}else"sphere"==e.volume.type?(t._panel._centerX.value=b.convert(Number(e.volume.center[0]),"length","mm",t._currentUnit.unit),t._panel._centerY.value=b.convert(Number(e.volume.center[1]),"length","mm",t._currentUnit.unit),t._panel._centerZ.value=b.convert(Number(e.volume.center[2]),"length","mm",t._currentUnit.unit),t._panel._radius.value=b.convert(Number(e.volume.radius),"length","mm",t._currentUnit.unit)):"proximity"==e.volume.type&&(t._panel._offset.value=b.convert(Number(e.volume.distance),"length","mm",t._currentUnit.unit))},200)}},destroy:function(){if(this._context)for(var e=0;e<this._CBTokens.length;e++)this._context.unsubscribe(this._CBTokens[e]);this._panel&&(this._panel.destroy(),delete this._panel),this._CBTokens=null,this._context=null,x.unreferencePreferenceManager(this._prefManager)},_onMouseEvents:function(e){if("@onMouseMoveEvent"===e.eventType){var t=e.from[0],i=this._window.getViewer().getMousePosition(t.getCurrentPosition(this._window.getViewer()));this._mousePosition.x=i.xPix-this._context.elements.container.offsetLeft,this._mousePosition.y=i.yPix-this._context.elements.container.offsetTop}},displayNotification:function(e,t){if("ENOPAD3DViewer"===this._context.name||"ENO3DView"===this._context.name){var i,n,a="";"cancel"===e?(a=f.commandCanceled,n="info"):"wrongInput"===e?(a=f.incorrectInput,n="warning"):"validate"===e?void 0!==t&&1===t?(a=t+" "+f.singleValidSelection,n="info"):void 0!==t&&t>1?(a=t+" "+f.validSelection,n="info"):(a=f.emptySelection,n="info"):"badProximityInput"===e?(a=f.badProximityInput,n="error"):"badProximitySelection"===e?(a=f.badProximitySelection,n="error"):"badSpaceSelection"===e?(a=f.badSpaceSelection,n="error"):"queryFailed"===e?(a=f.queryFailed,n="error"):"multipleRoots"===e?(a=f.multipleRoots,n="warning"):"proximityOnAssembly"===e?(a=f.proximityOnAssembly,n="warning"):"proximityOnMultisel"===e?(a=f.proximityOnMultisel,n="warning"):"InvalidProximityData"===e?(a=f.InvalidProximityData,n="warning"):"wrongSelection"===e?(a=f.wrongSelection,n="warning"):"authoringModeOn"===e?(a=f.authoringModeOn,n="warning"):"VQDisabled"===e&&(i=f.queryFailed_VQDisabled.title,n="warning"),this._context.displayNotification({eventID:n,title:void 0!==i?i:void 0,msg:a})}},beginExecute:function(){if(this._availableForRole){if(e.log("ENOWebNavVolumeQueryCmd: BeginExecute"),this.layoutActivated=!1,!0===this._authoringMode&&!0===u.getSetting("enopad_webapis")&&this.displayNotification("authoringModeOn"),"ENOPAD3DViewer"===this._context.name||"ENO3DView"===this._context.name){this._context.setRobotVisibility(!1);this._context.getRoots();this.layoutActivated=this._context.deactivateCurrentLayout({disableCommand:!0}),this._sceneGraphOverrideSet||(this._sceneGraphOverrideSet=new p(this._context.getController().getRootBagPath().externalPath[0]))}this.defaultContextualBarInitialyDisplayed=this._context.isDefaultContextualBarVisible(),this.defaultContextualBarInitialyDisplayed&&this._context.setDefaultContextualBarVisibility(!1),this.defaultContextualMenuInitialyDisplayed=this._context.isDefaultContextualMenuVisible(),this.defaultContextualMenuInitialyDisplayed&&this._context.setDefaultContextualMenuVisibility(!1);var t=this;t._selectedObjsPathElt=[],t._rootIdsArray=[],t._lockContextBarPosition=!1,t._initialized=!1,t._onlyRepSelected=!0,t._proximityAvailable=!0,t._cleanHandle(),t._onRemoveCB=t._context.subscribe({event:"onRootRemoved"},function(){t._isRunning&&t.end()}),t._mousePosition=new a.Vector2,t._position=new a.Vector2,t._onMouseNotification=function(e){t._onMouseEvents(e)},l.addEvent(t._window.getViewer().canvas,"onMouseMove",t._onMouseNotification),_.createPromise(t._loadMePreferences()),t._prefManager=x.getPreferenceManager({context:t._context.getFrameWindow()}),t._prefManager&&t._prefManager.subscribe("com.ds.mep:onPrefUpdate",function(e){if(3===e.length&&e[1].preferences){const i=JSON.parse(e[1].preferences);for(let e=0;e<i.repositories.length;++e)if("cke"===i.repositories[e].name){const n=i.repositories[e].preferences;for(let e=0;e<n.length;++e)"Length"===n[e].name?t._currentUnit={nls:w(n[e].value),unit:n[e].value}:"LengthCalcDisplay"===n[e].name&&(t._decimalRO=n[e].value)}}if(t._isRunning){var i=t._panel._startObject.value;t._panel.destroy(),t._panel=new m({immersiveFrame:t._context.getFrameWindow().getImmersiveFrame(),defaultShape:t._volumeType,defaultIntersection:t._intersectionMode,controller:t,currentUnit:t._currentUnit}),t.isSpaceLoaded()||(t._panel._spaceStarter.disabled=!0),t._panel._startObject.value=i,t._panel.setShapeParameters(t._volumeSelectionShape.getParams(),parseInt(t._decimalRO)),t._volumeSelectionShape._ruler.unit=t._currentUnit.unit,!0===t._volumeSelectionShape._ruler.getVisibleFlag()&&t._volumeSelectionShape._ruler.display()}}),t._CSOAddCB=function(){n()};var i=_.getPromises().slice();function n(){t._tokenHandle=new Array(2);var e=r.get(),i=[];e.forEach(function(e){if(!e.pathElement.getLastElement(!0)._excludeFromCSO&&v.isAModelPath(e.pathElement)){t._selectedObjsPathElt.push(e.pathElement);var n=e.pathElement.getLastElement(!0);i.push(n),t.event=e.event}}),t._selectedObjsPathElt.length?(t._proximityAvailable=t._onlyRepSelected&&e.length<2,t._onlyRepSelected?e.length>1&&t.displayNotification("proximityOnMultisel"):t.displayNotification("proximityOnAssembly"),0==t._panelCreation&&(t._proximityAvailable=1!=t._context._filterDrop&&t._proximityAvailable,t._panelCreation++,3===t._volumeType&&(t.isSpaceLoaded()||(t._volumeType=0)),t._panel=new m({immersiveFrame:t._context.getFrameWindow().getImmersiveFrame(),defaultShape:t._volumeType,defaultIntersection:t._intersectionMode,controller:t,currentUnit:t._currentUnit}),1==t._context._filterDrop&&(t._panel.okButton.disabled=!0),t.isSpaceLoaded()||(t._panel._spaceStarter.disabled=!0)),r.unsubscribe(t.addToCsoCallback),t.addToCsoCallback=null,0===t._volumeType?t._displayBoxHandle(i):1===t._volumeType?t._displaySphereHandle(i):2===t._volumeType?t._proximityAvailable?t._displayProximityHandle(i):(t._volumeType=0,t._displayBoxHandle(i)):3===t._volumeType&&t._displaySpaceHandle(i),t._volumeOpenBIData&&t._onVolumeOpenFromFilter({biData:t._volumeOpenBIData})):(t.displayNotification("wrongSelection"),t.addToCsoCallback||(t.addToCsoCallback=r.onAdd(t._CSOAddCB))),1==u.getSetting("activateVolumeFilter")&&t._isFilterOpen()}_.createPromise(function(e,a){Promise.all(i).then(function(a){i=null,r.get().length?n():1==t._context._filterDrop?function(){t._tokenHandle=new Array(2),t._proximityAvailable=!1,0==t._panelCreation&&(t._panelCreation++,t._panel=new m({immersiveFrame:t._context.getFrameWindow().getImmersiveFrame(),defaultShape:t._volumeType,defaultIntersection:t._intersectionMode,controller:t,currentUnit:t._currentUnit}),1==t._context._filterDrop&&(t._panel.okButton.disabled=!0));0===t._volumeType||2===t._volumeType||3===t._volumeType?(t._volumeType=0,t.displayBoxHandleFilter()):1===t._volumeType&&t.displaySphereHandleFilter()}():t.addToCsoCallback=r.onAdd(t._CSOAddCB),e()})},"initiateCSO")}else this.end()},displayBoxHandleFilter:function(){var e=this;require(["DS/ENOWebNavVolumeQuery/ENOWebNavBoxHandle"],function(t){e._volumeShape=0,e._volumeType=0;var i=new a.Matrix4;e._cleanHandle(),e._volumeSelectionShape=new t({cornerPoint:null,fstAxis:null,sndAxis:null,thdAxis:null,currentUnit:e._currentUnit},e._window,i),e._tokenHandle[0]=e._volumeSelectionShape.subscribe("EndBoxChanged",function(){e._panel.setShapeParameters(e._volumeSelectionShape.getParams(),parseInt(e._decimalRO))}),e._tokenHandle[1]=e._volumeSelectionShape.subscribe("onPreactivate",function(){!1===o._isShown&&e._displayContextBar()}),e._panel.setShapeParameters({box:!0,filterDrop:!0},parseInt(e._decimalRO))})},displaySphereHandleFilter:function(){var e=this;require(["DS/ENOWebNavVolumeQuery/ENOWebNavSphereHandle"],function(t){e._volumeShape=0,e._volumeType=1;var i=new a.Vector3(0,0,0),n=(new a.Matrix4).identity().setPosition(i);e._cleanHandle(),e._volumeSelectionShape=new t({center:i,radius:0,currentUnit:e._currentUnit},e._window,n),e._tokenHandle[0]=e._volumeSelectionShape.subscribe("EndBoxChanged",function(){e._panel.setShapeParameters(e._volumeSelectionShape.getParams(),parseInt(e._decimalRO))}),e._tokenHandle[1]=e._volumeSelectionShape.subscribe("onPreactivate",function(){!1===o._isShown&&e._displayContextBar()}),e._panel.setShapeParameters({center:!0,radius:!0,filterDrop:!0},parseInt(e._decimalRO))})},retreiveVolumeData:function(e){var t;0===this._intersectionMode?t="partly_in":1==this._intersectionMode?t="fully_in":2==this._intersectionMode?t="partly_out":3==this._intersectionMode?t="fully_out":4==this._intersectionMode&&(t="across");var i,n,o=this._volumeSelectionShape.getParams(),l=this._context.getRoots(),c=this._context.getController(),h=[];if(l.forEach(function(e){h.push([v.getNodeID(e)])}),0===this._volumeType){o.matrix.setPosition(new a.Vector3(0,0,0));var d=(new a.Matrix4).getInverse(o.matrix),_=o.fstAxis.clone().applyMatrix4(d),p=o.sndAxis.clone().applyMatrix4(d),m=o.thdAxis.clone().applyMatrix4(d);o.matrix.setPosition(o.cornerPoint);var x=_.clone();x.add(p),x.add(m),i={root_path_physicalid:h,type:"box",volume_filter:{box:{corner_min:[0,0,0],corner_max:[x.x,x.y,x.z],transformation_matrix:[o.matrix.elements[0],o.matrix.elements[1],o.matrix.elements[2],o.matrix.elements[4],o.matrix.elements[5],o.matrix.elements[6],o.matrix.elements[8],o.matrix.elements[9],o.matrix.elements[10],o.matrix.elements[12],o.matrix.elements[13],o.matrix.elements[14]],intersection_mode:t}},intent:"volumeQuery",fcs_url_mode:u.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0},n={root_path_physicalid:this._rootIdsArray,type:"box",intersection_mode:t,corner_min:i.volume_filter.box.corner_min,corner_max:i.volume_filter.box.corner_max,transformation_matrix:i.volume_filter.box.transformation_matrix}}else if(1==this._volumeType)i={root_path_physicalid:h,type:"sphere",volume_filter:{sphere:{center:[parseFloat(o.center.x),parseFloat(o.center.y),parseFloat(o.center.z)],radius:parseFloat(o.radius),intersection_mode:t}},intent:"volumeQuery",fcs_url_mode:u.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0},n={root_path_physicalid:this._rootIdsArray,type:"sphere",intersection_mode:t,center:i.volume_filter.sphere.center,radius:i.volume_filter.sphere.radius};else if(2==this._volumeType){r.empty(),s.empty(),this._window.getViewer().render(),n={root_path_physicalid:[b=c.buildArrayFromPath(this._selectedObjsPathElt[0])],type:"proximity",intersection_mode:t,distance:(i={root_path_physicalid:h,type:"proximity",volume_filter:{assemblyshape:{root_path_physicalid:[b],distance:parseFloat(o.offset),intersection_mode:t}},intent:"volumeQuery",fcs_url_mode:u.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0}).volume_filter.assemblyshape.distance}}else if(3===this._volumeType){r.empty(),s.empty(),this._window.getViewer().render();var b=c.buildArrayFromPath(this._selectedObjsPathElt[0]);i={root_path_physicalid:h,type:"space",volume_filter:{assemblyshape:{root_path_physicalid:[b],distance:0,intersection_mode:t}},intent:"volumeQuery",fcs_url_mode:u.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":void 0},n={root_path_physicalid:[b],type:"space",intersection_mode:t}}return"filter"===e?n:i},updateVolumeQuery:function(e){var t=this._context.getBIController().getBIProxy(),i={};this._context._filterDrop=!1;var n=1==this._panel._addFilter.checkFlag?"add":"update";if(e&&"cancel"==e.action?i={appId:y.getSharedId(),widgetId:y.getWidgetId(),action:"cancel"}:(i={appId:y.getSharedId(),widgetId:y.getWidgetId(),action:n,setId:this._setId,id:this._vfId,displayName:this._vfDispName,volume:this.retreiveVolumeData("filter"),filteredRoot:this._vfFilteredRoot},this._context.getRoots().length||i.volume.root_path_physicalid.push(this._context._physicalId)),t&&(t.setVolume(i),this._volumeSelectionShape&&this._volumeSelectionShape.getParams())){let e=this._volumeSelectionShape.getParams().box;e&&(this._previousCorners={},this._previousCorners.corner_min=[e.min.x,e.min.y,e.min.z],this._previousCorners.corner_max=[e.max.x,e.max.y,e.max.z])}this._volumeShape=1},applyVolumeQuery:function(){var e=this,t=e.retreiveVolumeData();require(["DS/PADServices/utils/PADTrackerManager","DS/PADUtils/PADUtilsServices"],function(e,t,i){var n=t.getPADTracker({eventCategory:"usage",eventAction:"command-3D"});n.setEventData({eventLabel:"ENOWebNavVolumeQueryCmd"+e}),n.trackPageEvent()}.bind(this,t.type)),delete t.type;var i=Math.random().toString(),n=i.substr(i.indexOf("."));t.root_path_physicalid[0][0];!0!==u.getSetting("activateVolumeFilter")?e._cleanHandle():(r.empty(),s.empty()),e._context.getController().volumeQuery({data:t,completion:e._completionNeeded,callbacks:{onComplete:function(t){if(t.selectedPaths){var i=[];t.selectedPaths.forEach(function(t){var n=e._context.unstreamPath(t);i.push({pathElement:n,event:e.event})}),0==t.querySuccess?(e._context._controller._querySuccess=!0,e.displayNotification("wrongInput")):e.displayNotification("validate",i.length),r.add(i),r.get().forEach(function(e){s.add(e)}),1===e._selectionMode&&e._context.getHideShowController().exclusiveShow(t),setTimeout(function(){!0!==u.getSetting("activateVolumeFilter")&&e.end()})}},onFailure:function(t,i,n){if(t&&t.errors){for(var a=!0,r=0;r<t.errors.length;r++)"VOLUME_QUERIES_DISABLED"===t.errors[r].errorCode&&(e.displayNotification("VQDisabled"),a=!1);a&&e.displayNotification("queryFailed")}else i&&i.indexOf("shape_invalid_rep")>0?e.displayNotification("badProximityInput"):e.displayNotification("queryFailed");e.end()}}})},_cleanHandle:function(){var e=this;e._volumeSelectionShape&&(e._tokenHandle&&e._tokenHandle.forEach(function(t){e._volumeSelectionShape.unsubscribe(t)}),e._volumeSelectionShape.clean(),delete e._volumeSelectionShape)},changePickableobject:function(e){var t=this;r.empty(),s.empty(),t._resetPicking(),t._cleanHandle(),t._panel._filterButton.disabled=!0,t._panel._boxStarter.disabled=!0,t._panel._sphereStarter.disabled=!0,t._panel.okButton.disabled=!0,t._panel._offset.value=0,"space"===e.type?t._panel._proximityStarter.disabled=!0:t._panel._spaceStarter.disabled=!0,t.proximitySpaceSelection=function(){var i=r.get(),n=[];t._selectedObjsPathElt=[],i.forEach(function(e){if(!e.pathElement.getLastElement(!0)._excludeFromCSO&&v.isAModelPath(e.pathElement)){t._selectedObjsPathElt.push(e.pathElement);var i=e.pathElement.getLastElement(!0);n.push(i),t.event=e.event}}),r.unsubscribe(t.wait4CSOSelection),t.wait4CSOSelection=null,t._panel._filterButton.disabled=!1,t._panel._boxStarter.disabled=!1,t._panel._sphereStarter.disabled=!1,t._panel.okButton.disabled=!1,"space"===e.type?(t._panel._proximityStarter.disabled=!1,t._displaySpaceHandle(n)):(t.isSpaceLoaded()&&(t._panel._spaceStarter.disabled=!1),t._displayProximityHandle(n))},t.wait4CSOSelection=r.onAdd(t.proximitySpaceSelection)},_resetPicking:function(){"ENOPAD3DViewer"!==this._context.name&&"ENO3DView"!==this._context.name||!this._sceneGraphOverrideSet||(this._context.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(this._sceneGraphOverrideSet),delete this._sceneGraphOverrideSet,this._sceneGraphOverrideSet=new p(this._context.getController().getRootBagPath().externalPath[0]))},updateSphere3D:function(e,t,i){t?this._panel._parameters[i]=!1:(e.radius=b.convert(e.radius,"length",this._currentUnit.unit,"mm"),e.centerX=b.convert(e.centerX,"length",this._currentUnit.unit,"mm"),e.centerY=b.convert(e.centerY,"length",this._currentUnit.unit,"mm"),e.centerZ=b.convert(e.centerZ,"length",this._currentUnit.unit,"mm"),e.radius?this._volumeSelectionShape._radius=e.radius:(this._volumeSelectionShape._center.x=e.centerX,this._volumeSelectionShape._center.y=e.centerY,this._volumeSelectionShape._center.z=e.centerZ,this._volumeSelectionShape._matrix.setPosition(this._volumeSelectionShape._center),this._volumeSelectionShape._robot.updateRobotFromMatrix(this._volumeSelectionShape._matrix)),this._volumeSelectionShape.refreshAfterManipulation(),this._volumeSelectionShape._ruler.value=e.radius,this._volumeSelectionShape._ruler.refresh())},_displaySphereHandle:function(e,t,i){var n=this;n._panel._addFilter&&(n._panel._addFilter.disabled=!1,n._panel._updateFilter&&!0===n._panel._updateFilter.disabled&&(n._panel._addFilter.checkFlag=!0)),n._panel._addFilter&&n._panel._updateFilter&&n._panel._addFilter.disabled&&n._panel._updateFilter.disabled&&n._panel._filterButton?n._panel._filterButton.disabled=!0:n._panel._filterButton&&(n._panel._filterButton.disabled=!1),require(["DS/ENOWebNavVolumeQuery/ENOWebNavSphereHandle"],function(l){"ENOPAD3DViewer"!==n._context.name&&"ENO3DView"!==n._context.name||n._context.getRoots().forEach(function(e){var t=n._context.getController().buildPathFromArray([v.getNodeID(e)]);if(t&&n._sceneGraphOverrideSet){var i=n._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(t);i||(i=n._sceneGraphOverrideSet.createOverride(t)),i.setPickability("NOT_PICKABLE"),n._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(n._sceneGraphOverrideSet)}}),r.empty(),setTimeout(function(){s.empty(),n._window.getViewer().render()});var c=new a.Vector3(0,0,0),h=0;if(1==e.length){var u=e[0].getBoundingSphere().clone(),d=n._selectedObjsPathElt[0].getWorldMatrix();h=i||u.radius,t?c.copy((new a.Vector3).getPositionFromMatrix(t)):(c.copy(u.center),c.applyMatrix4(d))}else if(e.length>1){var _=new a.Vector3(0,0,0),p=new a.Vector3(0,0,0),m=0;e.forEach(function(e){var t=e.getBoundingBox().clone(),i=n._selectedObjsPathElt[m].getWorldMatrix();t.applyMatrix4(i);var a=t.min,r=t.max;0===m?(_.x=Math.min(a.x,r.x),_.y=Math.min(a.y,r.y),_.z=Math.min(a.z,r.z),p.x=Math.max(a.x,r.x),p.y=Math.max(a.y,r.y),p.z=Math.max(a.z,r.z)):(_.x=Math.min(Math.min(a.x,r.x),_.x),_.y=Math.min(Math.min(a.y,r.y),_.y),_.z=Math.min(Math.min(a.z,r.z),_.z),p.x=Math.max(Math.max(a.x,r.x),p.x),p.y=Math.max(Math.max(a.y,r.y),p.y),p.z=Math.max(Math.max(a.z,r.z),p.z)),m++}),h=Math.sqrt(Math.pow(p.x-_.x,2)+Math.pow(p.y-_.y,2)+Math.pow(p.z-_.z,2))/2,null==t?(c.add(_).add(p),c.divideScalar(2)):c.copy((new a.Vector3).getPositionFromMatrix(t))}var x=(new a.Matrix4).identity().setPosition(c);n._cleanHandle(),n._volumeSelectionShape=new l({center:c,radius:h,currentUnit:n._currentUnit},n._window,x),n._tokenHandle[0]=n._volumeSelectionShape.subscribe("EndBoxChanged",function(){n._panel.setShapeParameters(n._volumeSelectionShape.getParams(),parseInt(n._decimalRO)),n._displayContextBar()}),n._tokenHandle[1]=n._volumeSelectionShape.subscribe("onPreactivate",function(){!1===o._isShown&&n._displayContextBar()}),n._volumeSelectionShape.display(),n._panel.setShapeParameters(n._volumeSelectionShape.getParams(),parseInt(n._decimalRO)),!0===n._context._filterDrop&&n._panel.setShapeParameters({center:!0,radius:!0,filterDrop:!0},parseInt(n._decimalRO))})},updateRulerOrigin:function(e,t){switch(t){case 0:e.origin=new a.Vector3(e.minX,e.maxY,e.minZ);break;case 1:e.origin=new a.Vector3(e.minX,e.minY,e.minZ);break;case 2:e.origin=new a.Vector3(e.maxX,e.minY,e.minZ);break;case 3:e.origin=new a.Vector3(e.maxX,e.maxY,e.minZ);break;case 4:e.origin=new a.Vector3(e.minX,e.maxY,e.minZ);break;case 5:e.origin=new a.Vector3(e.maxX,e.minY,e.maxZ)}},updateBox3DAfterUpdate:function(e){var t=new a.Matrix4;t.elements[0]=b.convert(Number(e.transformation_matrix[0]),"length",this._currentUnit.unit,"mm"),t.elements[1]=b.convert(Number(e.transformation_matrix[1]),"length",this._currentUnit.unit,"mm"),t.elements[2]=b.convert(Number(e.transformation_matrix[2]),"length",this._currentUnit.unit,"mm"),t.elements[4]=b.convert(Number(e.transformation_matrix[3]),"length",this._currentUnit.unit,"mm"),t.elements[5]=b.convert(Number(e.transformation_matrix[4]),"length",this._currentUnit.unit,"mm"),t.elements[6]=b.convert(Number(e.transformation_matrix[5]),"length",this._currentUnit.unit,"mm"),t.elements[8]=b.convert(Number(e.transformation_matrix[6]),"length",this._currentUnit.unit,"mm"),t.elements[9]=b.convert(Number(e.transformation_matrix[7]),"length",this._currentUnit.unit,"mm"),t.elements[10]=b.convert(Number(e.transformation_matrix[8]),"length",this._currentUnit.unit,"mm"),t.elements[12]=0,t.elements[13]=0,t.elements[14]=0;var i=new a.Vector3(b.convert(Number(e.transformation_matrix[9]),"length",this._currentUnit.unit,"mm"),b.convert(Number(e.transformation_matrix[10]),"length",this._currentUnit.unit,"mm"),b.convert(Number(e.transformation_matrix[11]),"length",this._currentUnit.unit,"mm")),n=new a.Vector3(b.convert(Number(e.corner_max[0]),"length",this._currentUnit.unit,"mm")-b.convert(Number(e.corner_min[0]),"length",this._currentUnit.unit,"mm"),b.convert(Number(e.corner_max[1]),"length",this._currentUnit.unit,"mm")-b.convert(Number(e.corner_min[1]),"length",this._currentUnit.unit,"mm"),b.convert(Number(e.corner_max[2]),"length",this._currentUnit.unit,"mm")-b.convert(Number(e.corner_min[2]),"length",this._currentUnit.unit,"mm"));n.add(i);var r=new a.Vector3(n.x,i.y,i.z),s=new a.Vector3(i.x,n.y,i.z),o=new a.Vector3(i.x,i.y,n.z);(new a.Matrix4).getInverse((new a.Matrix4).setPosition(i)).multiply(t),this._volumeSelectionShape._fstAxis=new a.Vector3(r.x-i.x,r.y-i.y,r.z-i.z).applyMatrix4(t),this._volumeSelectionShape._sndAxis=new a.Vector3(s.x-i.x,s.y-i.y,s.z-i.z).applyMatrix4(t),this._volumeSelectionShape._thdAxis=new a.Vector3(o.x-i.x,o.y-i.y,o.z-i.z).applyMatrix4(t),this._volumeSelectionShape._cornerPoint=i;var l=(new a.Matrix4).extractRotation(t),c=(new a.Vector3).copy(this._volumeSelectionShape._fstAxis).multiplyScalar(.5),h=(new a.Vector3).copy(this._volumeSelectionShape._sndAxis).multiplyScalar(.5),u=(new a.Vector3).copy(this._volumeSelectionShape._thdAxis).multiplyScalar(.5),d=(new a.Vector3).copy(i);d.add(c),d.add(h),d.add(u),l.setPosition(d),this._volumeSelectionShape._robot.updateRobotFromMatrix(l),this._volumeSelectionShape.refreshAfterManipulation()},updateBox3D:function(e,t,i,n){if(t)this._panel._parameters[i]=!1;else{e.maxX=b.convert(e.maxX,"length",this._currentUnit.unit,"mm"),e.maxY=b.convert(e.maxY,"length",this._currentUnit.unit,"mm"),e.maxZ=b.convert(e.maxZ,"length",this._currentUnit.unit,"mm"),e.minX=b.convert(e.minX,"length",this._currentUnit.unit,"mm"),e.minY=b.convert(e.minY,"length",this._currentUnit.unit,"mm"),e.minZ=b.convert(e.minZ,"length",this._currentUnit.unit,"mm");e.origin=null;var r=new a.Vector3(e.minX,e.minY,e.minZ),s=new a.Vector3(e.maxX,e.minY,e.minZ),o=new a.Vector3(e.minX,e.maxY,e.minZ),l=new a.Vector3(e.minX,e.minY,e.maxZ);this._volumeSelectionShape._fstAxis=new a.Vector3(s.x-r.x,s.y-r.y,s.z-r.z),this._volumeSelectionShape._sndAxis=new a.Vector3(o.x-r.x,o.y-r.y,o.z-r.z),this._volumeSelectionShape._thdAxis=new a.Vector3(l.x-r.x,l.y-r.y,l.z-r.z),this._volumeSelectionShape._cornerPoint=r;var c=new a.Matrix4,h=(new a.Vector3).copy(this._volumeSelectionShape._fstAxis).multiplyScalar(.5),u=(new a.Vector3).copy(this._volumeSelectionShape._sndAxis).multiplyScalar(.5),d=(new a.Vector3).copy(this._volumeSelectionShape._thdAxis).multiplyScalar(.5),_=(new a.Vector3).copy(r);_.add(h),_.add(u),_.add(d),c.setPosition(_);var p=this._volumeSelectionShape.getFaceNormal(this._volumeSelectionShape._manipulatedFace),m=null;this._volumeSelectionShape.colinear(p,this._volumeSelectionShape._fstAxis)?m=this._volumeSelectionShape._fstAxis:this._volumeSelectionShape.colinear(p,this._volumeSelectionShape._sndAxis)?m=this._volumeSelectionShape._sndAxis:this._volumeSelectionShape.colinear(p,this._volumeSelectionShape._thdAxis)&&(m=this._volumeSelectionShape._thdAxis),"min"==e.direction&&this._volumeSelectionShape._manipulatedFace>2?this._volumeSelectionShape._ruler.clear():"max"==e.direction&&this._volumeSelectionShape._manipulatedFace<=2&&this._volumeSelectionShape._ruler.clear(),this._volumeSelectionShape._ruler.value=m.length(),this._volumeSelectionShape._ruler.direction=p.multiplyScalar(-1),this._volumeSelectionShape._ruler.refresh(),this._volumeSelectionShape._robot.updateRobotFromMatrix(c),this._volumeSelectionShape.refreshAfterManipulation()}},_displayBoxHandle:function(e,t,i,n,l){var c=this;c._panel._addFilter&&(c._panel._addFilter.disabled=!1,c._panel._updateFilter&&!0===c._panel._updateFilter.disabled&&(c._panel._addFilter.checkFlag=!0)),c._panel._addFilter&&c._panel._updateFilter&&c._panel._addFilter.disabled&&c._panel._updateFilter.disabled&&c._panel._filterButton?c._panel._filterButton.disabled=!0:c._panel._filterButton&&(c._panel._filterButton.disabled=!1),require(["DS/ENOWebNavVolumeQuery/ENOWebNavBoxHandle"],function(h){"ENOPAD3DViewer"!==c._context.name&&"ENO3DView"!==c._context.name||c._context.getRoots().forEach(function(e){var t=c._context.getController().buildPathFromArray([v.getNodeID(e)]);if(t&&c._sceneGraphOverrideSet){var i=c._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(t);i||(i=c._sceneGraphOverrideSet.createOverride(t)),i.setPickability("NOT_PICKABLE"),c._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(c._sceneGraphOverrideSet)}}),r.empty(),setTimeout(function(){s.empty(),c._window.getViewer().render()});var u=null,d=null,_=null,p=null,m=new a.Matrix4;if(1==e.length){var x=e[0].getBoundingBox().clone();m=c._selectedObjsPathElt[0].getWorldMatrix(),(u=new a.Vector3(x.min.x,x.min.y,x.min.z)).applyMatrix4(m),(V=new a.Vector3(x.max.x,x.min.y,x.min.z)).applyMatrix4(m),(C=new a.Vector3(x.min.x,x.max.y,x.min.z)).applyMatrix4(m),(M=new a.Vector3(x.min.x,x.min.y,x.max.z)).applyMatrix4(m),i?(d=(new a.Vector3).copy(i)).setLength(i.length()):d=new a.Vector3(V.x-u.x,V.y-u.y,V.z-u.z),n?(_=(new a.Vector3).copy(n)).setLength(n.length()):_=new a.Vector3(C.x-u.x,C.y-u.y,C.z-u.z),l?(p=(new a.Vector3).copy(l)).setLength(l.length()):p=new a.Vector3(M.x-u.x,M.y-u.y,M.z-u.z);var b=(new a.Vector3).copy(d).multiplyScalar(.5),y=(new a.Vector3).copy(_).multiplyScalar(.5),f=(new a.Vector3).copy(p).multiplyScalar(.5);if(t)m.setPosition((new a.Vector3).getPositionFromMatrix(t)),(u=(new a.Vector3).getPositionFromMatrix(t)).sub(b),u.sub(y),u.sub(f);else(A=(new a.Vector3).copy(u)).add(b),A.add(y),A.add(f),m.setPosition(A)}else if(e.length>1){var w=new a.Vector3(0,0,0),g=new a.Vector3(0,0,0),S=0;e.forEach(function(e){var t=e.getBoundingBox().clone();m=c._selectedObjsPathElt[S].getWorldMatrix(),t.applyMatrix4(m);var i=t.min,n=t.max;0===S?(w.x=Math.min(i.x,n.x),w.y=Math.min(i.y,n.y),w.z=Math.min(i.z,n.z),g.x=Math.max(i.x,n.x),g.y=Math.max(i.y,n.y),g.z=Math.max(i.z,n.z)):(w.x=Math.min(Math.min(i.x,n.x),w.x),w.y=Math.min(Math.min(i.y,n.y),w.y),w.z=Math.min(Math.min(i.z,n.z),w.z),g.x=Math.max(Math.max(i.x,n.x),g.x),g.y=Math.max(Math.max(i.y,n.y),g.y),g.z=Math.max(Math.max(i.z,n.z),g.z)),S++});var V,C,M,P=new a.Matrix4;(u=new a.Vector3(w.x,w.y,w.z)).applyMatrix4(P),(V=new a.Vector3(g.x,w.y,w.z)).applyMatrix4(P),(C=new a.Vector3(w.x,g.y,w.z)).applyMatrix4(P),(M=new a.Vector3(w.x,w.y,g.z)).applyMatrix4(P),d=null,i?(d=(new a.Vector3).copy(i)).setLength(i.length()):d=new a.Vector3(V.x-u.x,V.y-u.y,V.z-u.z),_=null,n?(_=(new a.Vector3).copy(n)).setLength(n.length()):_=new a.Vector3(C.x-u.x,C.y-u.y,C.z-u.z),p=null,l?(p=(new a.Vector3).copy(l)).setLength(l.length()):p=new a.Vector3(M.x-u.x,M.y-u.y,M.z-u.z);var A;b=(new a.Vector3).copy(d).multiplyScalar(.5),y=(new a.Vector3).copy(_).multiplyScalar(.5),f=(new a.Vector3).copy(p).multiplyScalar(.5);if(t)P.setPosition((new a.Vector3).getPositionFromMatrix(t)),(u=(new a.Vector3).getPositionFromMatrix(t)).sub(b),u.sub(y),u.sub(f);else(A=(new a.Vector3).copy(u)).add(b),A.add(y),A.add(f),P.setPosition(A);m=P}c._cleanHandle(),c._volumeSelectionShape=new h({cornerPoint:u,fstAxis:d,sndAxis:_,thdAxis:p,currentUnit:c._currentUnit},c._window,m),c._tokenHandle[0]=c._volumeSelectionShape.subscribe("EndBoxChanged",function(){c._panel.setShapeParameters(c._volumeSelectionShape.getParams(),parseInt(c._decimalRO)),c._displayContextBar()}),c._tokenHandle[1]=c._volumeSelectionShape.subscribe("onPreactivate",function(){!1===o._isShown&&c._displayContextBar()}),c._volumeSelectionShape.display(),c._panel.setShapeParameters(c._volumeSelectionShape.getParams(),parseInt(c._decimalRO)),!0===c._context._filterDrop&&c._panel.setShapeParameters({box:!0,filterDrop:!0},parseInt(c._decimalRO))})},updateProximity3D:function(e,t,i){if(t)this._panel._parameters[i]=!1;else{var n={value:e=b.convert(e,"length",this._currentUnit.unit,"mm")};this._volumeSelectionShape.updateProximityHandleFromRulerValue(n),this._volumeSelectionShape._ruler.value=e,this._volumeSelectionShape._ruler.refresh()}},_displayProximityHandle:function(e){var t=this;t._panel._addFilter&&(t._panel._addFilter.disabled=!1,t._panel._updateFilter&&!0===t._panel._updateFilter.disabled&&(t._panel._addFilter.checkFlag=!0)),t._panel._addFilter&&t._panel._updateFilter&&t._panel._addFilter.disabled&&t._panel._updateFilter.disabled&&t._panel._filterButton?t._panel._filterButton.disabled=!0:t._panel._filterButton&&(t._panel._filterButton.disabled=!1),require(["DS/ENOWebNavVolumeQuery/ENOWebNavProximityHandle"],function(i){if("ENOPAD3DViewer"===t._context.name||"ENO3DView"===t._context.name){var n=t._context.getController().buildArrayFromPath(t._selectedObjsPathElt[0])[0];t._context.getRoots().forEach(function(e){var i=v.getNodeID(e),a=t._context.getController().buildPathFromArray([i]);if(a&&(t._sceneGraphOverrideSet||(t._sceneGraphOverrideSet=new p(t._context.getController().getRootBagPath().externalPath[0])),t._sceneGraphOverrideSet)){var r=t._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(a);if(r||(r=t._sceneGraphOverrideSet.createOverride(a)),n!==i?r.setPickability("IGNORED"):r.setPickability("PICKABLE"),t._selectedObjsPathElt[0]){var s=t._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(t._selectedObjsPathElt[0]);s||(s=t._sceneGraphOverrideSet.createOverride(t._selectedObjsPathElt[0])),s.setPickability("PICKABLE")}t._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(t._sceneGraphOverrideSet)}})}if(e.length>0){e[0].setPickingPriorityId("HIGHP2");var a=[],r=[],l={},c={version:"1.1",paths:a,attributes:l};s.add({pathElement:t._selectedObjsPathElt[0]});var h=t._selectedObjsPathElt[0].getWorldMatrix();v.isAModelPath(t._selectedObjsPathElt[0])&&t._context.streamPathWithType(t._selectedObjsPathElt[0],a,l),1==c.paths.length&&c.paths.forEach(function(e){t._selectedObjID=e[e.length-1],r.push(t._selectedObjID)}),t._context.getController().getAttributes({ids:r,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(e){t._panel._startObject.value=e[t._selectedObjID]["ds6w:label"],t._pickCount=0},onFailure:function(){t._pickCount=0,t.displayNotification("badProximitySelection")}}}),t._cleanHandle(),t._volumeSelectionShape=new i({node:e[0],matrix:h,window:t._window,initPath:t._selectedObjsPathElt[0],currentUnit:t._currentUnit}),t._tokenHandle[0]=t._volumeSelectionShape.subscribe("EndBoxChanged",function(){t._panel.setShapeParameters(t._volumeSelectionShape.getParams(),parseInt(t._decimalRO)),t._displayContextBar()}),t._tokenHandle[1]=t._volumeSelectionShape.subscribe("onPreactivate",function(){!1===o._isShown&&t._displayContextBar()}),t._volumeSelectionShape.display(),t._panel.setShapeParameters(t._volumeSelectionShape.getParams(),parseInt(t._decimalRO))}})},updateSpace3D:function(){},_displaySpaceHandle:function(e){var t=this;t._panel._addFilter&&(t._panel._addFilter.disabled=!0),t._panel._addFilter&&t._panel._updateFilter&&t._panel._addFilter.disabled&&t._panel._updateFilter.disabled&&t._panel._filterButton?t._panel._filterButton.disabled=!0:t._panel._filterButton&&(t._panel._filterButton.disabled=!1),t._panel._updateFilter&&(t._panel._updateFilter.checkFlag=!0),require(["DS/ENOWebNavVolumeQuery/ENOWebNavSpaceHandle"],function(i){if("ENOPAD3DViewer"!==t._context.name&&"ENO3DView"!==t._context.name||t._context.getRoots().forEach(function(e){var i=t._context.getController().buildPathFromArray([v.getNodeID(e)]);if(i&&t._sceneGraphOverrideSet){var n=t._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(i);if(n||(n=t._sceneGraphOverrideSet.createOverride(i)),n.setPickability("PICKABLE"),t._selectedObjsPathElt[0]){var a=t._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(t._selectedObjsPathElt[0]);a||(a=t._sceneGraphOverrideSet.createOverride(t._selectedObjsPathElt[0])),a.setPickability("PICKABLE")}t._context.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(t._sceneGraphOverrideSet)}}),e.length>0){var n=[],a=[],r={},o={version:"1.1",paths:n,attributes:r};s.add({pathElement:t._selectedObjsPathElt[0]});var l=t._selectedObjsPathElt[0].getWorldMatrix();if(v.isAModelPath(t._selectedObjsPathElt[0])&&t._context.streamPathWithType(t._selectedObjsPathElt[0],n,r),!t._isSpaceSelected(t._selectedObjsPathElt[0]))return t.displayNotification("badSpaceSelection"),void t.changePickableobject({type:"space"});1==o.paths.length&&o.paths.forEach(function(e){t._selectedObjID=e[e.length-1],a.push(t._selectedObjID)}),t._context.getController().getAttributes({ids:a,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(e){t._panel._space.value=e[t._selectedObjID]["ds6w:label"],t._pickCount=0},onFailure:function(){t._pickCount=0,t.displayNotification("badSpaceSelection")}}}),t._cleanHandle(),t._volumeSelectionShape=new i({node:e[0],matrix:l,window:t._window,initPath:t._selectedObjsPathElt[0]})}})},_displayContextBar:function(){},switchVolumeQueryShape:function(e){var t=[];if(this._resetPicking(),this._panel&&this._panel.okButton&&(this._panel.okButton.disabled=!1),this._volumeSelectionShape){var i=this._volumeSelectionShape.isModifiedByUser;if("Proximity"!==e&&"Space"!==e&&i)t.push(this._volumeSelectionShape.getBag());else for(var n=0;n<this._selectedObjsPathElt.length;n++)t.push(this._selectedObjsPathElt[n].getLastElement(!0));var r=null;if(this._volumeSelectionShape&&2!==this._volumeType&&3!==this._volumeType&&(r=(new a.Matrix4).copy(this._volumeSelectionShape._matrix)),this._lockContextBarPosition=!0,"Box"==e)this._volumeType=0,this._displayBoxHandle(t,r);else if("Sphere"==e){var s=null;if(0===this._volumeType){var o=this._volumeSelectionShape.getParams();s=o.box.max.distanceTo(o.box.min)/2}this._volumeType=1,this._displaySphereHandle(t,r,s)}else"Proximity"==e?(this._volumeType=2,this._displayProximityHandle(t)):"Space"==e&&(this._volumeType=3,this._displaySpaceHandle(t));this._volumeSelectionShape.isModifiedByUser=i,this._displayContextBar(),this._lockContextBarPosition=!1}else"Box"==e?this._volumeType=0:"Sphere"==e?this._volumeType=1:"Proximity"==e?this._volumeType=2:"Space"==e&&(this._volumeType=3)},switchVolumeQueryInOutRule:function(e){this._lockContextBarPosition=!0,"PartlyIn"==e?this._intersectionMode=0:"FullIn"==e?this._intersectionMode=1:"PartlyOut"==e?this._intersectionMode=2:"FullOut"==e?this._intersectionMode=3:"Across"==e&&(this._intersectionMode=4),this._displayContextBar(),this._lockContextBarPosition=!1},switchFilteringMode:function(e){this._lockContextBarPosition=!0,this._selectionMode=e?1:0,this._displayContextBar(),this._lockContextBarPosition=!1},cancelExecute:function(){e.log("ENOWebNavVolumeQueryCmd: cancelExecute"),this.displayNotification("cancel")},endExecute:function(){if(e.log("ENOWebNavVolumeQueryCmd: endExecute"),this._availableForRole){"ENOPAD3DViewer"!==this._context.name&&"ENO3DView"!==this._context.name||this._context.setRobotVisibility(!0);this._context.unsubscribe(this._onRemoveCB),this._resetPicking(),r.unsubscribe(this.addToCsoCallback),this.addToCsoCallback=null,r.unsubscribe(this.wait4CSOSelection),this.wait4CSOSelection=null,this._cleanHandle(),this._panel&&this._panel.destroy(),l.removeEvent(this._window.getViewer().canvas,"onMouseMove",this._onMouseNotification),delete this._savedBoxFstAxis,delete this._savedBoxSndAxis,delete this._savedBoxThdAxis,delete this._tokenHandle,delete this._mousePosition,delete this._position,delete this._vfId,delete this._setId,delete this._vfDispName,"wafr"===u.getSetting("eno3dviewer_infrastructure_version")&&(this._context._volumePanel=this._panelCreation=0),this._context.activateCurrentLayout(),this._context.setDefaultContextualBarVisibility(this.defaultContextualBarInitialyDisplayed),this._context.setDefaultContextualMenuVisibility(this.defaultContextualMenuInitialyDisplayed),this._context.getViewer().render({updateInfinitePlane:!0}),this._context.publish({event:"onVolumeEndExecute"}),this.done&&this.done()}},isSpaceLoaded:function(){for(var e=!1,t=this._context.getRoots(),i=0;i<t.length;i++){var n=v.getNodeType(t[i]);if(n&&-1!==n.toLowerCase().indexOf("space")){e=!0;break}}return e},_isSpaceSelected:function(e){for(var t=!1,i=0;i<e.externalPath.length;i++){var n=v.getNodeType(e.externalPath[i]);if(n&&-1!==n.toLowerCase().indexOf("space")){t=!0;break}}return t}});return e.namespace("DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryCmd",g)}),define("ENOWebNavVolumeQuery/ENOWebNavVolumeQueryCmd",["DS/ENOWebNavVolumeQuery/ENOWebNavVolumeQueryCmd","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("ENOWebNavVolumeQuery/ENOWebNavVolumeQueryCmd"),e});