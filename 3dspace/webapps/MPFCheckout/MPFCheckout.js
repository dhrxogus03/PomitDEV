define("DS/MPFCheckout/PhaseSummarySectionBody",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r){"use strict";return e.extend({className:"mpf-summary-order",setup:function(t={}){a.requiredOfPrototype(t.cart,s,"options.cart must be a CartModel"),a.requiredOfPrototype(t.cartPhase,n,"options.cartPhase must be a CartPhaseModel"),this._parent(t),this.cart=t.cart,this.cartPhase=t.cartPhase,this.locale=t.locale||"fr-FR"},render:function(){return this.container.setContent([this._getDetailAmount(),this._getTotal()]),this},_getTotal:function(){return t.createElement("div",{class:"mpf-order-total",html:[t.createElement("div",{text:r.get("orderTotal")}),t.createElement("div",{text:this._getGrossAmountTotal()})]})},_getDetailAmount:function(){return t.createElement("div",{class:"mpf-order-detail",html:[t.createElement("div",{class:"mpf-order-subtotal",html:[t.createElement("div",{text:r.get("subtotal")}),t.createElement("div",{text:this._getNetAmountTotal()})]}),t.createElement("div",{class:"mpf-order-taxes",html:[t.createElement("div",{text:r.get("taxes")}),t.createElement("div",{text:this._getTaxesAmountTotal()})]})]})},_getGrossAmountTotal:function(){const t=this.cart.getCurrency();return parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"})},_getNetAmountTotal:function(){const t=this.cart.getCurrency();return parseFloat(this.cartPhase.getTotalNetAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"})},_getTaxesAmountTotal:function(){const t=this.cart.getCurrency();return parseFloat(this.cartPhase.getTotalTaxesAmount()).toLocaleString(this.locale,{style:"currency",currency:t,currencyDisplay:"code"})},destroy:function(){this._parent(),this.container=null}})}),define("DS/MPFCheckout/TokenPaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/UIKIT/Mask","DS/MPFServices/ObjectService","DS/MPFPaymentCardTokenModel/PaymentCardTokenModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPspModel/PspModel","DS/MPFOrderComponent/OrderConfirmationSection","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,l){"use strict";const d=Object.freeze({PAYMENT_DONE:"paymentDone"}),u=a.extend({className:"mpf-cbtoken-page",setup:function(t){t||(t={}),n.requiredOfPrototype(t.token,r,"options.token must be a PaymentCardTokenModel"),n.requiredOfPrototype(t.cartPhase,i,"options.cartPhase must be a CartPhaseModel"),n.requiredOfPrototype(t.cartPayment,o,"options.cartPayment must be a CartPaymentModel"),n.requiredOfPrototype(t.cartPsp,c,"options.cartPsp must be a PspModel"),this.token=t.token,this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.waitForPaymentModel=t.waitForPaymentModel,this.locale=t.locale||"fr-FR",this.phaseInfoSection=this._createPhaseInfoSection(),this.tokenSection=this._createTokenSection()},render:function(){return this.container.setContent([this.phaseInfoSection.render(),this.tokenSection.render()]),this},save:function(){return s.mask(this.container,l.get("paymentInProgress")),this._payWithToken().then(()=>{this.dispatchEvent(d.PAYMENT_DONE,{isPaymentOK:!0})}).catch(()=>{this.dispatchEvent(d.PAYMENT_DONE,{isPaymentOK:!1})}).finally(s.unmask.bind(s,this.container))},_payWithToken:function(){return this.cartPsp.getPsp()===c.Psp.STRIPE&&this.cartPsp.isScaEnabled()?this._getStripe().then(this._updateCartPayment.bind(this)).then(this._submitPaymentToStripe.bind(this)).then(function(t){return t.error?e.reject(t.error):e.resolve()}).then(this._waitForPaymentStateUpdate.bind(this)):this._updateCartPayment().then(this._waitForPaymentStateUpdate.bind(this))},_submitPaymentToStripe:function(){const t={payment_method:this.token.getPaymentMethodId()};return this.stripe.handleCardPayment(this.cartPayment.getPaymentIntentSecret(),t)},_waitForPaymentStateUpdate:function(){const t=this;return this.waitForPaymentModel?this.waitForPaymentModel.fetchPromise().catch(function(){return e.resolve()}).then(function(){if(t.waitForPaymentModel.getState()===o.States.PAYMENT_REFUSED)return e.reject("payment refused")}):e.resolve()},_updateCartPayment:function(){const t={[o.Fields.STATE]:o.States.PENDING_PAYMENT,CreditCardTokenId:this.token.getCardId()};return this.cartPayment.savePromise(t,{patch:!0})},_getStripe:function(){const a=this,s=e.deferred(),n=t.createElement("script",{src:"https://js.stripe.com/v3/",events:{load:function(){return a.stripe=Stripe(a.cartPsp.getPublicKey()),a.elements=a.stripe.elements(),s.resolve()}}});return"function"==typeof Stripe?(a.stripe=Stripe(a.cartPsp.getPublicKey()),a.elements=a.stripe.elements(),s.resolve()):document.body.appendChild(n),s.promise},_createTokenSection:function(){const t=[{tag:"table",html:[this._createRow("mpf-cc-owner",l.get("ccOwner"),this.token.getCardName()),this._createRow("mpf-cc-number",l.get("ccNumber"),"xxxx-xxxx-xxxx-"+this.token.getCardNumber()),this._createRow("mpf-cc-expDate",l.get("ccExpDate"),this.token.getCardExpMonth()+"/"+this.token.getCardExpYear()),this._createRow("mpf-cc-type",l.get("ccType"),this.token.getCardType())]}];return new h({title:l.get("titleCBToken"),body:t})},_createPhaseInfoSection:function(){const t=[{tag:"table",html:[this._createRow("mpf-phase-number",l.get("phaseNumber"),this.cartPhase.getNumber()),this._createRow("mpf-phase-start-date",l.get("startDate"),this.cartPhase.getStartDate()),this._createRow("mpf-phase-end-date",l.get("endDate"),this.cartPhase.getEndDate()),this._createRow("mpf-phase-description",l.get("description"),this.cartPhase.getDescription()),this._createRow("mpf-phase-total",l.get("amount"),parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"}))]}];return new h({title:l.get("phaseInfo"),body:t})},_createRow:function(t,e,a){return{tag:"tr",class:t,html:[{tag:"td",class:"mpf-label",text:e},{tag:"td",class:"mpf-value",text:a}]}},destroy:function(){this.phaseInfoSection.destroy(),this.tokenSection.destroy(),this.token=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartPsp=null,this.waitForPaymentModel=null,this.container=null}});return u.Events=d,u}),define("DS/MPFCheckout/CardPaymentPage",["UWA/Class/View","UWA/Promise","UWA/Utils","DS/UIKIT/Mask","DS/WebappsUtils/WebappsUtils","DS/MPFPspModel/PspModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFStripeComponent/StripePhasePaymentPage","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c){"use strict";const h=Object.freeze({RESIZE_MODAL:"resizeModal",PAYMENT_SUCCESS:"onPaymentSuccess",PAYMENT_FAILURE:"onPaymentFailure"}),l=t.extend({className:"mpf-card-payment-page",setup:function(t={}){this.me=t.me,this.service=t.service,this.locale=t.locale,this.cart=t.cart,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.cartPhase=t.cartPhase,this.saveCardInfo=t.saveCardInfo,this.waitForPaymentModel=t.waitForPaymentModel,this._createCardPaymentPage()},render:function(){return this.whenReady.then(()=>{this.container.setContent(this.page.render()),this.cartPsp.getPsp()===r.Psp.STRIPE&&this.page.whenReadyToMount().then(()=>{this.page.mountStripeInputs()})}),this},destroy:function(){this.cartPsp=null,this.page.destroy(),this._parent()},_patchCartPaymentState:function(){const t={currentState:i.States.PENDING_PAYMENT,cartContextUrl:a.isAbsoluteUrl(n.getWebappsAssetUrl("MPFModalConfiguratorComponent",""))?n.getWebappsAssetUrl("MPFModalConfiguratorComponent",""):window.location.origin+n.getWebappsAssetUrl("MPFModalConfiguratorComponent","")};return"1"===this.saveCardInfo&&(t.CreditCardTokenMultiUse="1"),this.cartPayment.savePromise(t,{patch:!0})},_createCardPaymentPage:function(){this.page=new o({me:this.me,cart:this.cart,cartPhase:this.cartPhase,cartPsp:this.cartPsp,cartPayment:this.cartPayment,creditCardTokenMultiUse:this.saveCardInfo,waitForPaymentModel:this.waitForPaymentModel,locale:this.locale,service:this.service}),this.listenTo(this.page,o.Events.PAYMENT_SUCCESS,this.dispatchEvent.bind(this,h.RESIZE_MODAL,{isPaymentOK:!0})),this.listenTo(this.page,o.Events.PAYMENT_FAILURE,this.dispatchEvent.bind(this,h.RESIZE_MODAL,{isPaymentOK:!1})),this.whenReady=e.resolve()},_addListenerForResizingModal:function(){const t=this;window.addEventListener("message",function(e){const a=window.location.host.replace("-ifwe","-apps");e.origin.contains(a)&&e.data.isPaymentDone&&t.dispatchEvent(h.RESIZE_MODAL,e.data)})}});return l.Events=h,l}),define("DS/MPFCheckout/PhaseSummarySectionBodyDetails",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r){"use strict";return e.extend({className:"mpf-order-details table-responsive",setup:function(t){t||(t={}),a.requiredOfPrototype(t.cart,s,"options.cart must be a CartModel"),a.requiredOfPrototype(t.cartPhase,n,"options.cartPhase must be a CartPhaseModel"),this._parent(t),this.cart=t.cart,this.cartPhase=t.cartPhase,this.locale=t.locale||"fr-FR"},render:function(){return this.container.setContent(this._createTable()),this},_createTable:function(){const e=parseFloat(this.cartPhase.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:this.cart.getCurrency(),currencyDisplay:"code"});return t.createElement("table",{class:"table table-condensed",html:[this._createTableHeader(),this._createTableBody(),this._createTableFooter(e)]})},_createPhaseItemEntry:function(e){const a=this.cart.getCurrency(),s=parseFloat(e.getUnitNetAmount()).toLocaleString(this.locale,{style:"currency",currency:a,currencyDisplay:"code"}).replace(a,"").trim(),n=parseFloat(e.getUnitTaxesAmount()).toLocaleString(this.locale,{style:"currency",currency:a,currencyDisplay:"code"}).replace(a,"").trim(),i=parseFloat(e.getTotalGrossAmount()).toLocaleString(this.locale,{style:"currency",currency:a,currencyDisplay:"code"});return t.createElement("tr",{html:[t.createElement("td",{class:"mpf-body-item",text:r.get("phase")}),t.createElement("td",{class:"mpf-body-quantity",text:parseInt(e.getPhaseNumber())}),t.createElement("td",{text:s}),t.createElement("td",{text:n}),t.createElement("td",{text:i})]})},_createTableBody:function(){return t.createElement("tbody",{html:this._createPhaseItemEntry(this.cartPhase)})},_createTableHeader:function(){return t.createElement("thead",{html:t.createElement("tr",{html:[{tag:"th",text:r.get("item"),class:"mpf-header-item"},{tag:"th",text:r.get("number"),class:"mpf-header-quantity"},{tag:"th",text:r.get("unitPrice")},{tag:"th",text:r.get("taxes")},{tag:"th",text:r.get("totalAmountWithTaxes")}]})})},_createTableFooter:function(e){return t.createElement("tfoot",{html:t.createElement("tr",{html:[t.createElement("td"),t.createElement("td"),t.createElement("td"),t.createElement("td",{text:r.get("total")}),t.createElement("td",{text:e})]})})},destroy:function(){this.cart=null,this.cartPhase=null,this.locale=null,this.table=null,this._parent(),this.container=null}})}),define("DS/MPFCheckout/PhasePaymentMethodSection",["UWA/Core","UWA/Class/View","DS/UIKIT/Input/Toggle","DS/UIKIT/Input/Select","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFView/FieldTextInputV2","DS/MPFPspModel/PspModel","DS/MPFBuyer/BuyerType","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c){"use strict";const h=Object.freeze({PAYMENT_CARD_SELECTED:"paymentCardSelected",VALID_SECTION:"validSection",INVALID_SECTION:"invalidSection"}),l=Object.freeze({ADD_NEW_CARD:"addNewCard",USE_CARD_TOKEN:"useCardToken",USE_BANK_TRANSFER:"useBankTransfer"}),d=e.extend({className:"mpf-phase-payment-method-section mpf-section mpf-horizontal",setup:function(t){this.billingAddressHelper=t.billingAddressHelper,this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.paymentCardTokens=t.paymentCardTokens,this.buyerType=t.buyerType,this.paymentCardOption=this._createPaymentCardOption(),this.paymentCardSelector=this._createPaymentCardSelector(),this.paymentCardSave=this._createPaymentCardSave(),this.bankTransferOption=this._createBankTransferOption(),this.purchaseOrderField=this._createPurchaseOrderField(),this.expenseFinancialLineField=this._createExpenseFinancialLineField(),this.listenTo(this.paymentCardTokens,"onSync",this._onTokenUpdate.bind(this))},render:function(){const t=[{tag:"h5",class:"mpf-title",text:c.get("paymentMethod")},{tag:"div",class:"mpf-body",html:[{tag:"div",class:"mpf-payment-cb",html:[this.paymentCardOption,this.paymentCardSelector,this.paymentCardSave,this.purchaseOrderField.render(),this.expenseFinancialLineField.render()]},this._isBankTransferEnabled()&&this.bankTransferOption]}];return this._updatePaymentMethodDetails(),this.container.setContent(t),this},validate:function(){const t=this.bankTransferOption.isChecked(),e=this.paymentCardOption.isChecked(),a=""!==this.paymentCardSelector.getValue()[0];return t||e&&a},getSelection:function(){const t={};if(this.paymentCardOption.isChecked()){const e=this.paymentCardSelector.getValue()[0];e===l.ADD_NEW_CARD?(t.action=l.ADD_NEW_CARD,t.save=this.paymentCardSave.isChecked()?"1":"0"):(t.action=l.USE_CARD_TOKEN,t.token=this.paymentCardTokens.find(function(t){return e===t.getCardId()}))}else t.action=l.USE_BANK_TRANSFER;return t},onPaymentMethodSelection:function(){this.paymentCardOption.isChecked()?(this.onTokenSelection(),this.cartPayment.setPaymentMethod(n.PaymentMethods.BANK_CARD)):(this.cartPayment.setPaymentMethod(n.PaymentMethods.DEFERRED_BANK_TRANSFER),this.dispatchEvent(h.VALID_SECTION)),this.render()},_onTokenUpdate(){const t=this._createPaymentCardOptions();this.paymentCardSelector.remove(),this.paymentCardSelector.add(t),this.paymentCardSelector.setValue(t[t.length-1].value)},_updatePaymentMethodDetails:function(){this.paymentCardOption.isChecked()?(this.paymentCardSelector.enable(),this.purchaseOrderField.container.show(),this.expenseFinancialLineField.container.show(),this._updateTokenMethodDetails()):(this.paymentCardSelector.disable(),this.purchaseOrderField.container.hide(),this.expenseFinancialLineField.container.hide(),this.paymentCardSave.hide())},_updateTokenMethodDetails:function(){this.paymentCardSelector.getValue()[0]===l.ADD_NEW_CARD?this.paymentCardSave.show():this.paymentCardSave.hide()},_createPaymentCardSave:function(){return new a({type:"checkbox",name:"save-CB",value:c.get("saveCB"),className:"primary cb-save",checked:!0})},_createPaymentCardOption:function(){const t=this.cartPayment.getPaymentMethod();return new a({name:"mpfCheckoutV2PaymentMethod",value:c.get("paymentCard"),className:"primary cb",checked:!t||"CC"===t,events:{onChange:this.onPaymentMethodSelection.bind(this)}})},_createPaymentCardSelector:function(){return new s({placeholder:c.get("selectPaymentCard"),options:this._createPaymentCardOptions(),events:{onChange:this.onTokenSelection.bind(this)}})},onTokenSelection:function(){""===this.paymentCardSelector.getValue()[0]?this.dispatchEvent(h.INVALID_SECTION):this.dispatchEvent(h.VALID_SECTION),this.render()},_createPaymentCardOptions:function(){const t=this.cartPsp.getPsp(),e=this.cartPsp.getCountryPlatform(),a=t===i.Psp.HIPAY,s=t===i.Psp.STRIPE,n=this.paymentCardTokens.filter(function(n){return n.getPsp()===t&&(a||s&&n.getPlatform()===e)}).map(function(t){return{value:t.getCardId(),label:"xxxx-xxxx-xxxx-"+t.getCardNumber()+", "+t.getCardExpMonth()+"/"+t.getCardExpYear()}});return n.unshift({value:l.ADD_NEW_CARD,label:c.get("newPaymentCard")}),n[n.length-1].selected=!0,n},_createBankTransferOption:function(){const t=this.cartPsp.getPsp()===i.Psp.STRIPE&&this.cartPsp.getCountryPlatform()===i.Platform.STRIPE_US;let e;if(this._isBankTransferEnabled()){const s=t?c.get("achBankTransfer"):c.get("bankTransfer");e=new a({name:"mpfCheckoutV2PaymentMethod",value:s,className:"primary bank",checked:"DBT"===this.cartPayment.getPaymentMethod(),events:{onChange:this.onPaymentMethodSelection.bind(this)}})}else e={isChecked:function(){}};return e},_createPurchaseOrderField:function(){return new r({model:this.cartPayment,fieldName:n.Fields.PURCHASE_ORDER_NUMBER,fieldLabel:c.get("referenceToMention"),dynamicValidation:!0,maxlength:30})},_createExpenseFinancialLineField:function(){return new r({model:this.cartPayment,fieldName:n.Fields.FINANCIAL_LINE,fieldLabel:c.get("expenseFinancialLine"),dynamicValidation:!0})},_createTitle:function(){return t.createElement("h5",{class:"mpf-title",text:c.get("paymentMethod")})},_createBody:function(){return t.createElement("div",{class:"mpf-body"})},_isBankTransferEnabled:function(){return this.billingAddressHelper.getBuyerType()===o.COMPANY&&this.cartPsp.isBankTransferEnabled()},updatePaymentMethods:function(){this.bankTransferOption=this._createBankTransferOption(),this.render()},destroy:function(){this.stopListening(),this.purchaseOrderField.destroy(),this.expenseFinancialLineField.destroy(),this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartPsp=null,this.paymentCardTokens=null,this.buyerType=null,this._parent(),this.container=null}});return d.Events=Object.freeze(h),d.Actions=Object.freeze(l),d}),define("DS/MPFCheckout/ConfirmationPaymentPage",["DS/MPFModalConfiguratorComponent/ThanksPurchasingPage"],function(t){"use strict";return t}),define("DS/MPFCheckout/BillingAddressCreationPage",["DS/MPFModalConfiguratorComponent/BillingInformationPage"],function(t){"use strict";return t}),define("DS/MPFCheckout/BankTransferPaymentPage",["UWA/Core","UWA/Promise","UWA/Class/View","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFPurchaseOrderComponent/CartPhasePurchaseOrderForm","DS/MPFPurchaseOrderModel/PurchaseOrderFactory","DS/MPFPurchaseOrderModel/PurchaseOrderDocumentFactory","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Alert","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,l,d){"use strict";const u=Object.freeze({CONFIRM_BANK_TRANSFER:"confirmBankTransfer",UPLOAD_PURCHASE_ORDER:"uploadPurchaseOrder"}),P=Object.freeze({UPLOAD_PURCHASE_ORDER_LATER:"uploadPurchaseOrderLater",UPLOAD_PURCHASE_ORDER_NOW:"uploadPurchaseOrderNow",PURCHASE_ORDER_SAVED:"purchaseOrderSaved"}),m=a.extend({className:"mpf-bank-transfer-payment-page",setup:function(t){this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.purchaseOrderFactory=t.purchaseOrderFactory,this.purchaseOrderDocumentFactory=t.purchaseOrderDocumentFactory,this.stateMachine=this._createStateMachine(),this.confirmBankTransfer=this._createConfirmBankTransfer(),this.purchaseOrderForm=this._createPurchaseOrderForm(),this.listenTo(this.purchaseOrderForm,r.Events.PURCHASE_ORDER_UPLOADED,this._onPurchaseOrderSaved.bind(this))},render:function(){switch(this.stateMachine.getState()){case u.CONFIRM_BANK_TRANSFER:this.container.setContent([this.confirmBankTransfer]);break;case u.UPLOAD_PURCHASE_ORDER:this.container.setContent([this.purchaseOrderForm.render()])}return this},save:function(){let t;return t=this.stateMachine.getState()===u.UPLOAD_PURCHASE_ORDER?this.purchaseOrderForm.save():e.reject()},destroy:function(){this.cartPhase=null,this._parent()},_createStateMachine:function(){return new s({state:u.CONFIRM_BANK_TRANSFER,states:[u.CONFIRM_BANK_TRANSFER,u.UPLOAD_PURCHASE_ORDER],transitions:[{from:u.CONFIRM_BANK_TRANSFER,to:u.UPLOAD_PURCHASE_ORDER}]})},_createPurchaseOrderForm:function(){return this.purchaseOrder=this.purchaseOrderFactory.createModel(i.Types.PAYMENT_PURCHASE_ORDER),this.purchaseOrder.setParentResourceId(this.cartPayment.id),this.purchaseOrderDocument=this.purchaseOrderDocumentFactory.createModel(o.Types.PAYMENT_PURCHASE_ORDER_DOCUMENT),this.purchaseOrderDocument.setParentResourceId(this.cartPayment.id),new r({cartPayment:this.cartPayment,purchaseOrder:this.purchaseOrder,purchaseOrderDocument:this.purchaseOrderDocument})},_createConfirmBankTransfer:function(){const e=this._createUploadPurchaseOrderNowButton(),a=this._createUploadPurchaseOrderLaterButton();return t.createElement("div",{html:[{tag:"p",class:"mpf-message",text:d.get("confirmDeferredPaymentMessage")},e,a]})},_createUploadPurchaseOrderNowButton:function(){return new c({className:"primary mpf-uploadPurchaseOrderButton",value:d.get("uploadPurchaseOrder"),events:{onClick:this._onSelectUploadPurchaseOrderNow.bind(this)}})},_onSelectUploadPurchaseOrderNow:function(){this.dispatchEvent(P.UPLOAD_PURCHASE_ORDER_NOW),this.stateMachine.changeState(u.UPLOAD_PURCHASE_ORDER),this.render()},_createUploadPurchaseOrderLaterButton:function(){return new c({className:"primary mpf-uploadLaterButton",value:d.get("uploadPurchaseOrderLater"),events:{onClick:this._onUploadPurchaseOrderLater.bind(this)}})},_onUploadPurchaseOrderLater:function(){const t=this,e={[n.Fields.STATE]:n.States.PENDING_PAYMENT};h.mask(this.container),this.cartPayment.savePromise(e,{patch:!0}).then(function(){h.unmask(t.container),t.dispatchEvent(P.UPLOAD_PURCHASE_ORDER_LATER)}).catch(function(){h.unmask(t.container),new l({messageClassName:"error",closable:!0,visible:!0,messages:d.get("errorUnableToUpdatePayment")}).inject(t.container,"top")})},_onPurchaseOrderSaved:function(){this.dispatchEvent(P.PURCHASE_ORDER_SAVED)}});return m.Events=P,m}),define("DS/MPFCheckout/BillingInformationSection",["DS/MPFModalConfiguratorComponent/BillingInformationSection"],function(t){"use strict";return t}),define("DS/MPFCheckout/PhaseInfoSection",["UWA/Core","UWA/Class/View","DS/MPFServices/ObjectService","DS/MPFCartPhaseModel/CartPhaseModel","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n){"use strict";return e.extend({className:"mpf-order-number",setup:function(t={}){a.requiredOfPrototype(t.cartPhase,s,"options.cartPhase must be a CartPhaseModel"),this.cartPhase=t.cartPhase,this.locale=t.locale||"fr-FR",this.title=this._createTitle(),this.body=this._createBody()},render:function(){return this.container.setContent([this.title,this.body]),this},_createBody:function(){const e=[t.createElement("div",{html:[t.createElement("span",{text:n.get("phaseNumber")})," "+this.cartPhase.getNumber()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("startDate")})," "+this.cartPhase.getStartDate()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("endDate")})," "+this.cartPhase.getEndDate()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("description")})," "+this.cartPhase.getDescription()]}),t.createElement("div",{html:[t.createElement("span",{text:n.get("amount")})," "+this.cartPhase.getTotalGrossAmount()]})];return t.createElement("div",{class:"mpf-body",html:e})},_createTitle:function(){return t.createElement("h5",{text:n.get("phaseInfo")})}})}),define("DS/MPFCheckout/TermsAndConditionsSection",["DS/MPFModalConfiguratorComponent/SalesConditionsBuyerPaymentSectionV2"],function(t){"use strict";return t}),define("DS/MPFCheckout/PhaseSummarySection",["DS/MPFServices/ObjectService","DS/MPFOrderComponent/OrderConfirmationSection","DS/MPFOrderComponent/OrderConfirmationSectionCommand","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCheckout/PhaseSummarySectionBody","DS/MPFCheckout/PhaseSummarySectionBodyDetails","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c){"use strict";const h=Object.freeze({PHASE_DETAILS_DISPLAYED:"orderDetailsDisplayed",PHASE_DETAILS_NOT_DISPLAYED:"orderDetailsNotDisplayed"});return e.extend({setup:function(e){e||(e={}),t.requiredOfPrototype(e.cart,n,"options.cart must be a CartModel"),t.requiredOfPrototype(e.cartPhase,r,"options.cartPhase must be a CartPhaseModel"),this._parent(e),this.cart=e.cart,this.cartPhase=e.cartPhase,this.locale=e.locale||"fr-FR",this.title=c.get("phaseSummary"),this.commands=this._initCommands(),this.stateMachine=this._createStateMachine(),this.bodySummary=this._createBodySummary(),this.bodyDetails=this._createBodyDetails(),this._initListeners(),this._updateBody()},_updateBody:function(){this.stateMachine.getState()===h.PHASE_DETAILS_NOT_DISPLAYED&&(this.body=this.bodySummary.render()),this.stateMachine.getState()===h.PHASE_DETAILS_DISPLAYED&&(this.body=this.bodyDetails.render()),this.render()},_displayDetails:function(){this.stateMachine.changeState(h.PHASE_DETAILS_DISPLAYED),this._updateBody()},_displaySummary:function(){this.stateMachine.changeState(h.PHASE_DETAILS_NOT_DISPLAYED),this._updateBody()},_initListeners:function(){this.listenTo(this.commands[0],"commandOn",this._displayDetails.bind(this)),this.listenTo(this.commands[0],"commandOff",this._displaySummary.bind(this)),this.listenTo(this.cart,"onSync",this._onCartUpdated.bind(this)),this.listenTo(this.cartPhase,"onSync",this._onPhaseUpdated.bind(this))},_onCartUpdated:function(){this.cartPhase.fetchPromise({forceDelegate:!0})},_onPhaseUpdated:function(){this._updateBody()},_createBodyDetails:function(){return new o({cart:this.cart,cartPhase:this.cartPhase,locale:this.locale})},_createBodySummary:function(){return new i({cart:this.cart,cartPhase:this.cartPhase,locale:this.locale})},_initCommands:function(){return[new a({icon:"eye",iconOff:"eye-off",label:c.get("details"),labelOff:c.get("hideDetails")}).render()]},_createStateMachine:function(){return new s({state:h.PHASE_DETAILS_NOT_DISPLAYED,states:[h.PHASE_DETAILS_NOT_DISPLAYED,h.PHASE_DETAILS_DISPLAYED],transitions:[{from:h.PHASE_DETAILS_DISPLAYED,to:h.PHASE_DETAILS_NOT_DISPLAYED},{from:h.PHASE_DETAILS_NOT_DISPLAYED,to:h.PHASE_DETAILS_DISPLAYED}]})},destroy:function(){this.stopListening(),this.bodySummary.destroy(),this.bodyDetails.destroy(),this.cart=null,this.cartPhase=null,this._parent(),this.container=null}})}),define("DS/MPFCheckout/PhaseSummaryPage",["UWA/Class/View","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFCartQuoteComponent/CartQuoteDownloadLink","DS/MPFCheckout/PhaseSummarySection","DS/MPFCheckout/PhasePaymentMethodSection","DS/MPFCheckout/BillingInformationSection","DS/MPFCheckout/TermsAndConditionsSection","i18n!DS/MPFCheckout/assets/nls/CheckoutV2"],function(t,e,a,s,n,r,i,o,c,h,l){"use strict";const d=Object.freeze({ALL_SECTIONS_DISPLAYED:"allSectionsDisplayed",CREATE_BILLING_ADDRESS:"createBillingAddress"}),u=Object.freeze({PAYMENT_BY_TOKEN:"paymentByToken",PAYMENT_BY_CARD:"paymentByCard",PAYMENT_BY_BANK_TRANSFER:"paymentByBankTransfer",VALID_PAGE:"validPage",INVALID_PAGE:"invalidPage",DISPLAY_MASK:"displayMask",REMOVE_MASK:"removeMask",BILLING_ADDRESS_CREATION:"billingAddressCreation"}),P=t.extend({className:"mpf-phase-summary-page mpf-checkout-v2-page mpf-order-confirmation-page",setup:function(t){this.service=t.service,this.billingAddressHelper=t.billingAddressHelper,this.cart=t.cart,this.shop=t.shop,this.cartPhase=t.cartPhase,this.cartPayment=t.cartPayment,this.cartPsp=t.cartPsp,this.cartQuote=t.cartQuote,this.paymentCardTokens=t.paymentCardTokens,this.countries=t.countries,this.locale=t.locale,this.isItFirstPayment=!0===t.isItFirstPayment,this.addressFactory=t.addressFactory,this.tcContractFactory=t.tcContractFactory,this.tcDocumentFactory=t.tcDocumentFactory,this.alert=this._createAlert(),this.cartQuoteLink=this._createCartQuoteLink(),this.summarySection=this._createSummarySection(),this.payementMethodSection=this._createPaymentMethodSection(),this.billingInformationSection=this._createBillingInformationSection(),this.termsAndConditionsSection=this._createTermsAndConditionsSection(),this.stateMachine=this._createStateMachine()},render:function(){const t=[this.alert,this.cartQuoteLink.render(),this.summarySection.render(),this.billingInformationSection.render(),this.payementMethodSection.render(),this.termsAndConditionsSection.render()];return this.container.setContent(t),this},validate:function(){const t=this.payementMethodSection.validate(),e=this.termsAndConditionsSection.isChecked(),a=t&&e;return a?this.dispatchEvent(u.VALID_PAGE):this.dispatchEvent(u.INVALID_PAGE),a},save:function(){const t=this,a=this.payementMethodSection.getSelection();return e.mask(this.container),this.cartPayment.savePromise(this.cartPayment.getPendingChanges(),{patch:!0}).then(this.termsAndConditionsSection.save.bind(this.termsAndConditionsSection)).then(this._acceptQuote.bind(this)).then(function(){let s;const n={};a.action===o.Actions.ADD_NEW_CARD?(s=u.PAYMENT_BY_CARD,n.saveCardInfo=a.save):a.action===o.Actions.USE_CARD_TOKEN?(s=u.PAYMENT_BY_TOKEN,n.token=a.token):a.action===o.Actions.USE_BANK_TRANSFER&&(s=u.PAYMENT_BY_BANK_TRANSFER),e.unmask(t.container),t.dispatchEvent(s,n)})},getState:function(){return this.stateMachine.getState()},async _patchBillingAddress(t){this.dispatchEvent(u.DISPLAY_MASK);try{await this.billingAddressHelper.patchBillingAddress(t)}catch(t){console.error(t),this.alert.add({className:"error",message:l.get("errorUpdateBillingAddress")}).show()}this.payementMethodSection.updatePaymentMethods(),this.dispatchEvent(u.REMOVE_MASK),this.render()},_updatePayment(){return this.cartPayment.hasPendingChanges()?this.cartPayment.savePromise(this.cartPayment.getPendingChanges(),{patch:!0}):Promise.resolve()},_acceptQuote:function(){return this.cartQuote.fetchPromise().then(()=>{this.cartQuote.savePromise({[s.Fields.STATE]:"ACCEPTED"},{patch:!0})})},_createAlert:()=>new a({closable:!0,visible:!1}),_createSummarySection:function(){return new i({cart:this.cart,cartPhase:this.cartPhase,locale:this.locale})},_createCartQuoteLink:function(){const t=new r({quote:this.cartQuote,paymentUpdateCb:this._updatePayment.bind(this)});return this.listenTo(t,r.Events.ERROR,()=>{this.alert.add({className:"error",message:l.get("failedDownloadQuote")}).show()}),t},_createPaymentMethodSection:function(){const t=new o({cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartPsp:this.cartPsp,paymentCardTokens:this.paymentCardTokens,billingAddressHelper:this.billingAddressHelper});return this.listenTo(t,o.Events.VALID_SECTION,this.validate.bind(this)),this.listenTo(t,o.Events.INVALID_SECTION,this.validate.bind(this)),t},_createBillingInformationSection:function(){const t=new c({service:this.service,title:l.get("billingInformation"),billingAddressHelper:this.billingAddressHelper,addressFactory:this.addressFactory,cart:this.cart,cartPsp:this.cartPsp,countries:this.countries,isReadOnly:!this.isItFirstPayment});return this.listenTo(t,c.Events.VALID,this.validate.bind(this)),this.listenTo(t,c.Events.INVALID,this.validate.bind(this)),this.listenTo(t,c.Events.ADDRESS_SELECTION,t=>this._patchBillingAddress(t)),this.listenTo(t,c.Events.NEW_ADDRESS_FORM,this.dispatchEvent.bind(this,u.BILLING_ADDRESS_CREATION)),t},_createTermsAndConditionsSection:function(){const t=new h({service:this.service,shop:this.shop,cart:this.cart,billingAddressHelper:this.billingAddressHelper,tcContractFactory:this.tcContractFactory,tcDocumentFactory:this.tcDocumentFactory});return this.listenTo(t,h.Events.VALID_SECTION,this.validate.bind(this)),this.listenTo(t,h.Events.INVALID_SECTION,this.validate.bind(this)),t},_createStateMachine:function(){return new n({state:d.ALL_SECTIONS_DISPLAYED,states:[d.ALL_SECTIONS_DISPLAYED,d.CREATE_BILLING_ADDRESS],transitions:[{from:d.ALL_SECTIONS_DISPLAYED,to:d.CREATE_BILLING_ADDRESS},{from:d.CREATE_BILLING_ADDRESS,to:d.ALL_SECTIONS_DISPLAYED}]})},destroy:function(){this.stopListening(),this.summarySection.destroy(),this.cartQuoteLink.destroy(),this.payementMethodSection.destroy(),this.billingInformationSection.destroy(),this.termsAndConditionsSection.destroy(),this.service=null,this.billingAddressHelper=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartPsp=null,this.cartQuote=null,this.paymentCardTokens=null,this.addresses=null,this.addressFactory=null,this.countries=null,this.tcContractFactory=null,this.tcDocumentFactory=null,this.shop=null,this._parent(),this.container=null}});return P.Events=u,P.States=d,P}),define("DS/MPFCheckout/CheckoutV2",["UWA/Class/View","UWA/Core","UWA/Promise","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/UIKIT/Alert","DS/MPFBuyer/BuyerType","DS/MPFPersonModel/PersonModel","DS/MPFShopModel/ShopModel","DS/MPFCartModel/CartModel","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFCartPaymentModel/CartPaymentModel","DS/MPFCartQuoteModel/CartQuoteModel","DS/MPFPspModel/PspModel","DS/MPFAddressModel/AddressCollection","DS/MPFAddressModel/AddressFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFCartModel/CartItemFactory","DS/MPFTCContractModel/TCContractFactory","DS/MPFTcDocumentModel/TCDocumentFactory","DS/MPFFiniteStateMachine/FiniteStateMachine","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFCheckout/BillingAddressCreationPage","DS/MPFCheckout/PhaseSummaryPage","DS/MPFCheckout/TokenPaymentPage","DS/MPFCheckout/BankTransferPaymentPage","DS/MPFCheckout/CardPaymentPage","DS/MPFCheckout/ConfirmationPaymentPage","DS/MPFView/EmptyView","DS/MPFView/ManuallyClosedModal","DS/MPFServices/ObjectService","i18n!DS/MPFCheckout/assets/nls/CheckoutV2","css!DS/MPFCheckout/MPFCheckout","css!DS/MPFModalConfiguratorComponent/MPFModalConfiguratorComponent"],function(t,e,a,s,n,r,i,o,c,h,l,d,u,P,m,p,y,S,_,A,C,E,M,D,T,g,f,F,N,I,R,O,b){"use strict";const k=Object.freeze({CREATE_BILLING_ADDRESS:"createBillingAddress",PHASE_SUMMARY:"phaseSummary",ADD_BILLING_ADDRESS:"addBillingAddress",CREDIT_CARD_TOKEN_PAYMENT:"creditCardTokenPayment",BANK_TRANSFER_PAYMENT:"bankTransferPayment",CARD_PAYMENT:"cardPayment",CONFIRMATION_PAYMENT:"confirmationPayment",HIPAY_THANKS_FOR_PURCHASE:"cardThankForPurchase"}),v=Object.freeze({PAYMENT_DONE:"payementDone"}),B=t.extend({className:"mpf-checkout-v2 mpf-configurator-offer",setup:function(t){O.requiredOfPrototype(t.me,c,"options.me must be a PersonModel"),O.requiredOfPrototype(t.cart,l,"options.cart must be a CartModel"),O.requiredOfPrototype(t.cartPhase,d,"options.cartPhase must be a CartPhaseModel"),O.requiredOfPrototype(t.cartPayment,u,"options.cartPayment must be a CartPaymentModel"),O.requiredOfPrototype(t.cartQuote,P,"options.cartQuote must be a CartQuoteModel"),O.requiredOfPrototype(t.cartPsp,m,"options.cartPsp must be a PspModel"),O.requiredOfPrototype(t.shop,h,"options.shop must be a ShopModel"),O.requiredOfPrototype(t.billingAddressHelper,M,"options.billingAddressHelper must be a BillingAddressHelper"),O.requiredOfPrototype(t.personAddresses,p,"options.personAddresses must be an AddressCollection"),O.requiredOfPrototype(t.addressFactory,y,"options.addressFactory must be an AddressFactory"),O.requiredOfPrototype(t.companyFactory,S,"options.companyFactory must be a CompanyFactory"),O.requiredOfPrototype(t.tcDocumentFactory,C,"options.tcDocumentFactory must be a TCDocumentFactory"),O.requiredOfPrototype(t.tcContractFactory,A,"options.tcContractFactory must be a TCContractFactory"),O.requiredOfPrototype(t.cartItemFactory,_,"options.cartItemFactory murt be a CartItemFactory"),this.service=t.service,this.me=t.me,this.company=t.company,this.personAddresses=t.personAddresses,this.companyAddresses=t.companyAddresses,this.shop=t.shop,this.cart=t.cart,this.cartPhase=t.cartPhase,this.cartPsp=t.cartPsp,this.cartPayment=t.cartPayment,this.cartQuote=t.cartQuote,this.countries=t.countries,this.paymentCardTokens=t.paymentCardTokens,this.waitForPaymentModel=t.waitForPaymentModel,this.locale=t.locale,this.isItFirstPayment=!0===t.isItFirstPayment,this.billingAddressHelper=t.billingAddressHelper,this.cartFactory=t.cartFactory,this.cartItemFactory=t.cartItemFactory,this.companyFactory=t.companyFactory,this.addressFactory=t.addressFactory,this.tcContractFactory=t.tcContractFactory,this.tcDocumentFactory=t.tcDocumentFactory,this.purchaseOrderFactory=t.purchaseOrderFactory,this.purchaseOrderDocumentFactory=t.purchaseOrderDocumentFactory,this.stateMachine=this._createStateMachine(),this.alert=this._createAlert(),this.nextButton=this._createNextButton(),this.cancelButton=this._createCancelButton(),this.modal=this._createModal()},render:function(t={}){let e;switch(this.stopListening(this.page),!0!==t.keepPage&&this.page&&this.page.destroy(),this.stateMachine.getState()){case k.CREATE_BILLING_ADDRESS:this._createBillingAddressPage(),this.nextButton.setValue(b.get("saveBillingInfo")),this.nextButton.enable(),e=b.get("enterBillingInfo");break;case k.PHASE_SUMMARY:this._createPhaseSummaryPage(),this.nextButton.setValue(b.get("confirmPhase")),e=b.get("checkout1of2");break;case k.ADD_BILLING_ADDRESS:this._createBillingAddressPage(),this.nextButton.setValue(b.get("save")),this.nextButton.enable();break;case k.CREDIT_CARD_TOKEN_PAYMENT:this._createTokenPaymentPage(t),this.nextButton.enable(),e=b.get("checkout2of2");break;case k.BANK_TRANSFER_PAYMENT:this._createBankTransferPaymentPage(t),this.nextButton.hide(),e=b.get("checkout2of2");break;case k.CARD_PAYMENT:this._createCardPaymentPage(t),this.nextButton.hide(),this.cancelButton.hide(),e=b.get("checkout2of2");break;case k.CONFIRMATION_PAYMENT:this._createConfirmationPaymentPage(t),this.nextButton.hide(),this.cancelButton.show(),this.cancelButton.setValue(b.get("close")),e=this._getPaymentConfirmationTitle(t),this._resizeModal(),this.dispatchEvent(v.PAYMENT_DONE,t);break;case k.HIPAY_THANKS_FOR_PURCHASE:this.cancelButton.show(),this.cancelButton.setValue(b.get("close")),e=this._getPaymentConfirmationTitle(t),this._resizeModal(),this.dispatchEvent(v.PAYMENT_DONE);break;default:this.page=I.getInstance()}return!0!==t.keepPage&&(this.alert.inject(this.modal.getBody()),this._wrapInScroller(this.page.render()).inject(this.modal.getBody()),this.container.setContent(this.modal)),e&&this.setTitle(e),this},save:function(){return s.mask(this.page.container),this.nextButton.disable(),this.page.save().finally(()=>{this.page&&e.is(this.page.container)&&(s.unmask(this.page.container),this.nextButton.enable())})},setTitle(t){this.modal.getHeader().getElement(".mpf-title").setText(t)},show(){this.modal.show()},hide:function(){this.modal.hide(),this.destroy()},_changeState:function(t,e){this.stateMachine.changeState(t),this.render(e)},_createStateMachine:function(){let t=this.billingAddressHelper.hasValidBillingAddress()?k.PHASE_SUMMARY:k.CREATE_BILLING_ADDRESS;const e=this.cartPayment.getPaymentMethod()===u.PaymentMethods.BANK_CARD,a=this.cartPayment.getState(),s=e&&a===u.States.PAYMENT_INITIATED,n=e&&a===u.States.PAYMENT_REFUSED;return(s||n)&&(t=k.CARD_PAYMENT),new E({state:t,states:[k.CREATE_BILLING_ADDRESS,k.PHASE_SUMMARY,k.ADD_BILLING_ADDRESS,k.CREDIT_CARD_TOKEN_PAYMENT,k.BANK_TRANSFER_PAYMENT,k.CARD_PAYMENT,k.CONFIRMATION_PAYMENT,k.HIPAY_THANKS_FOR_PURCHASE],transitions:[{from:k.CREATE_BILLING_ADDRESS,to:k.PHASE_SUMMARY},{from:k.PHASE_SUMMARY,to:k.ADD_BILLING_ADDRESS},{from:k.PHASE_SUMMARY,to:k.CREDIT_CARD_TOKEN_PAYMENT},{from:k.PHASE_SUMMARY,to:k.BANK_TRANSFER_PAYMENT},{from:k.PHASE_SUMMARY,to:k.CARD_PAYMENT},{from:k.ADD_BILLING_ADDRESS,to:k.PHASE_SUMMARY},{from:k.CREDIT_CARD_TOKEN_PAYMENT,to:k.CONFIRMATION_PAYMENT},{from:k.CARD_PAYMENT,to:k.HIPAY_THANKS_FOR_PURCHASE},{from:k.CARD_PAYMENT,to:k.CONFIRMATION_PAYMENT}]})},_resizeModal:function(){const t=this.modal.elements.body.getElement("iframe");e.is(t)&&t.setAttribute("style","height:350px!important;min-height: unset;"),this.modal.elements.content.setStyle("height","490px"),this.cancelButton.setValue(b.get("close"))},_getPaymentConfirmationTitle:function(t){let a;return e.is(t.headerModalMsg,"string")&&t.headerModalMsg.length>0?a=t.headerModalMsg:!0===t.isPaymentOK?a=b.get("purchaseComplete"):!1===t.isPaymentOK&&(a=b.get("purchaseFailure")),a},_createNextButton(){return new n({className:"primary",value:b.get("next"),disabled:!0,events:{onClick:this.save.bind(this)}})},_createCancelButton(){return new n({value:b.get("cancel"),events:{onClick:this._onCancel.bind(this)}})},_wrapInScroller(t){return this.container.getElements(".mpf-scroll").forEach(t=>{t.destroy()}),new r({element:e.createElement("div",{class:"mpf-scroll",html:[t]})})},_createModal:function(){return new R({header:e.createElement("h4",{class:"mpf-title",text:b.get("checkout1of2")}),visible:!1,footer:[this.nextButton,this.cancelButton],events:{[R.Events.ON_CLOSE]:this._onCancel.bind(this)}})},_createAlert:function(){return new i({visible:!0})},_onCancel:function(){if(this.stateMachine.getState()!==k.ADD_BILLING_ADDRESS)return s.mask(this.page.container),this.cartPayment.fetchPromise().then(this._resetPaymentState.bind(this)).then(()=>{s.unmask(this.page.container),this.hide()}).catch(()=>{s.unmask(this.page.container),this.alert.add({className:"error",message:b.get("errorUnableToUpdatePayment")})});this.billingAddressHelper.setBuyerType(this.billingAddressHelper.deduceBuyerType()),this._changeState(k.PHASE_SUMMARY)},_resetPaymentState:function(){const t=this.stateMachine.getState(),e=this.cartPayment.getState(),s=e===u.States.PAYMENT_INITIATED||e===u.States.PENDING_PAYMENT;let n;return t===k.CARD_PAYMENT&&s&&this.cartPayment.setState(u.States.DRAFT),this.cartPayment.hasPendingChanges()||t===k.CREDIT_CARD_TOKEN_PAYMENT?(this.cartPayment.set(u.Fields.PURCHASE_ORDER_NUMBER,""),this.cartPayment.set(u.Fields.FINANCIAL_LINE,""),n=this.cartPayment.savePromise(this.cartPayment.getPendingChanges(),{patch:!0})):n=a.resolve(),n},_paymentDone:function(){this.dispatchEvent(v.PAYMENT_DONE),this.hide()},_createBankTransferPaymentPage:function(t){const e=this;this.page=new f({cartPhase:this.cartPhase,cartPayment:this.cartPayment,purchaseOrderFactory:this.purchaseOrderFactory,purchaseOrderDocumentFactory:this.purchaseOrderDocumentFactory,locale:this.locale}),this.listenTo(this.page,f.Events.UPLOAD_PURCHASE_ORDER_LATER,this._paymentDone.bind(this)),this.listenTo(this.page,f.Events.PURCHASE_ORDER_SAVED,this._paymentDone.bind(this)),this.listenTo(this.page,f.Events.UPLOAD_PURCHASE_ORDER_NOW,function(){e.nextButton.setValue(b.get("save")),e.nextButton.setDisabled(!1),e.nextButton.show()})},_createConfirmationPaymentPage:function(t){this.page=new N({service:this.service}),this.page.setPayment(t.isPaymentOK)},_createCardPaymentPage:function(t={}){this.page=new F({me:this.me,cart:this.cart,cartPsp:this.cartPsp,cartPayment:this.cartPayment,cartPhase:this.cartPhase,saveCardInfo:t.saveCardInfo,waitForPaymentModel:this.waitForPaymentModel,service:this.service,locale:this.locale}),this.listenTo(this.page,F.Events.RESIZE_MODAL,(t={})=>{this.cartPsp.getPsp()===m.Psp.HIPAY?(t.keepPage=!0,this._changeState(k.HIPAY_THANKS_FOR_PURCHASE,t)):this._changeState(k.CONFIRMATION_PAYMENT,t)})},_createTokenPaymentPage:function(t){this.page=new g({token:t.token,cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartPsp:this.cartPsp,locale:this.locale,waitForPaymentModel:this.waitForPaymentModel}),this.listenTo(this.page,g.Events.PAYMENT_DONE,t=>{this._changeState(k.CONFIRMATION_PAYMENT,t)})},_createBillingAddressPage:function(){this.page=new D({service:this.service,billingAddressHelper:this.billingAddressHelper,me:this.me,company:this.company,cart:this.cart,cartPhase:this.cartPhase,cartPsp:this.cartPsp,personAddresses:this.personAddresses,companyAddresses:this.companyAddresses,countries:this.countries,companyFactory:this.companyFactory,addressFactory:this.addressFactory}),this.listenTo(this.page,D.Events.PAGE_SAVED,async()=>{await this.cartPhase.fetchPromise({forceDelegate:!0}),this._changeState(k.PHASE_SUMMARY)})},_createPhaseSummaryPage:function(){this.page=new T({service:this.service,billingAddressHelper:this.billingAddressHelper,cart:this.cart,cartPhase:this.cartPhase,cartPayment:this.cartPayment,cartPsp:this.cartPsp,cartQuote:this.cartQuote,cartFactory:this.cartFactory,paymentCardTokens:this.paymentCardTokens,addressFactory:this.addressFactory,countries:this.countries,tcDocumentFactory:this.tcDocumentFactory,tcContractFactory:this.tcContractFactory,shop:this.shop,cartItemFactory:this.cartItemFactory,isItFirstPayment:this.isItFirstPayment,locale:this.locale}),this.listenTo(this.page,T.Events.PAYMENT_BY_CARD,this._changeState.bind(this,k.CARD_PAYMENT)),this.listenTo(this.page,T.Events.PAYMENT_BY_TOKEN,this._changeState.bind(this,k.CREDIT_CARD_TOKEN_PAYMENT)),this.listenTo(this.page,T.Events.PAYMENT_BY_BANK_TRANSFER,this._changeState.bind(this,k.BANK_TRANSFER_PAYMENT)),this.listenTo(this.page,T.Events.VALID_PAGE,this.nextButton.enable.bind(this.nextButton)),this.listenTo(this.page,T.Events.INVALID_PAGE,this.nextButton.disable.bind(this.nextButton)),this.listenTo(this.page,T.Events.DISPLAY_MASK,s.mask.bind(s,this.modal.getBody())),this.listenTo(this.page,T.Events.REMOVE_MASK,s.unmask.bind(s,this.modal.getBody())),this.listenTo(this.page,T.Events.BILLING_ADDRESS_CREATION,this._changeState.bind(this,k.ADD_BILLING_ADDRESS))},destroy:function(){this.stopListening(),this.page&&this.page.destroy(),this.modal&&this.modal.destroy(),this.page=null,this.modal=null,this.me=null,this.cart=null,this.cartPhase=null,this.cartPayment=null,this.cartFactory=null,this.cartItemFactory=null,this.companyFactory=null,this.buyer=null,this.addresses=null,this.addressFactory=null,this.countries=null,this.cartPsp=null,this.paymentCardTokens=null,this.waitForPaymentModel=null,this.tcContractFactory=null,this.tcDocumentFactory=null,this.shop=null,this.stateMachine=null,this._parent(),this.container=null}});return B.Events=v,B.States=k,B}),define("DS/MPFCheckout/CheckoutV2Factory",["UWA/Utils","DS/MPFConnector/MarketplaceConnector","DS/MPFModelFactory/MPFFactoriesV2","DS/MPFPersonModel/PersonFactory","DS/MPFCompanyModel/CompanyFactory","DS/MPFAddressModel/AddressFactory","DS/MPFCartModel/CartFactory","DS/MPFCountryModel/CountryFactory","DS/MPFCartPhaseModel/CartPhaseFactory","DS/MPFCartPaymentModel/CartPaymentFactory","DS/MPFCartQuoteModel/CartQuoteFactory","DS/MPFPspModel/PspFactory","DS/MPFPaymentCardTokenModel/PaymentCardTokenFactory","DS/MPFCartPaymentModel/WaitForPaymentFactory","DS/MPFShopModel/ShopFactory","DS/MPFCartPhaseModel/CartPhaseModel","DS/MPFModalConfiguratorComponent/BillingAddressHelper","DS/MPFCheckout/CheckoutV2","DS/MPFServices/MarketplaceServices","DS/MPFBuyer/BuyerType"],function(t,e,a,s,n,r,i,o,c,h,l,d,u,P,m,p,y,S,_,A){"use strict";return class{static async from({cartId:n,phaseId:p,service:C,locale:E}){E=E||window.dsLang||t.Client.Locale.lang+"-"+t.Client.Locale.locale;const M=await e.fetchPromise({service:C}),D=a.getInstance(M),[T,g,f,F,N,I,R,O,b,k,v,B,L,U,w,Y,x]=await Promise.all([D.getFactory(a.Types.CART),D.getFactory(a.Types.PERSON),D.getFactory(a.Types.COMPANY),D.getFactory(a.Types.ADDRESS),D.getFactory(a.Types.COUNTRY),D.getFactory(a.Types.CART_PHASE),D.getFactory(a.Types.CART_PAYMENT),D.getFactory(a.Types.PSP),D.getFactory(a.Types.PAYMENT_CARD_TOKEN),D.getFactory(a.Types.TC_DOCUMENT),D.getFactory(a.Types.TC_CONTRACT),D.getFactory(a.Types.SHOP),D.getFactory(a.Types.CART_ITEM),D.getFactory(a.Types.PURCHASE_ORDER),D.getFactory(a.Types.PURCHASE_ORDER_DOCUMENT),D.getFactory(a.Types.CART_QUOTE),D.getFactory(a.Types.WAIT_FOR_PAYMENT)]);f.addressFactory=F;const[H,V,K,W,G,Q]=await Promise.all([g.createModel(s.Types.ME).fetchPromise(),this._createAndFetch(T,!0,i.Types.CART,{id:n},{},{expand:["cart-items"]}),this._createAndFetch(O,!0,d.Types.CART_PSP,null,{parentResourceId:n}),this._createAndFetch(F,!1,r.Types.ME),b.createCollection(u.Types.ME),this._createAndFetch(N,!1,o.Types.BUYER)]),{company:q,companyAddresses:j}=await this._fetchCompanyWithAddresses({service:C,me:H,cart:V,companyFactory:f,addressFactory:F}),z=C!==_.INNOVATE,Z=new y({isBuyerTypeEditable:z,service:C,me:H,cart:V,cartPsp:K,company:q,personAddresses:W,companyAddresses:j,countries:Q,cardTokens:G,paymentCardTokenFactory:b,addressFactory:F,buyerType:C===_.INNOVATE?A.COMPANY:null});await Z.patchDefaultCartBillingAddress();const J=await this._createAndFetch(I,!1,c.Types.CART_CART_PHASE,[],{parentResourceId:n}),X=J.get(p)||this._findCurrentCartPhase(J),[$,tt]=await Promise.all([this._createAndFetch(B,!0,m.Types.SHOP,{id:V.getShopID()}),this._createAndFetch(R,!0,h.Types.CART_PHASE_CART_PAYMENT,null,{parentResourceId:X.get("id")})]),et=Y.createModel(l.Types.CART_QUOTE,null,{parentResourceId:n}),at=x.createModel(P.Types.PAYMENT,null,{parentResourceId:tt.get("id")});return new S({billingAddressHelper:Z,service:C,me:H,cart:V,cartPhase:X,cartPayment:tt,cartQuote:et,cartFactory:T,cartItemFactory:L,companyFactory:f,company:q,personAddresses:W,companyAddresses:j,addressFactory:F,countries:Q,cartPsp:K,paymentCardTokens:G,tcDocumentFactory:k,tcContractFactory:v,shop:$,purchaseOrderFactory:U,purchaseOrderDocumentFactory:w,waitForPaymentModel:at,locale:E,isItFirstPayment:this._isItFirstPayment({cartPhases:J,cartPhase:X})})}static async _createAndFetch(t,e,a,s,n,r){return e?t.createModel(a,s,n).fetchPromise(r):t.createCollection(a,s,n).fetchPromise(r)}static async _fetchCompanyWithAddresses({service:t,me:e,cart:a,companyFactory:s,addressFactory:i}){const o=t===_.INNOVATE?a.getCompanyID():e.getCompanyId(),c=s.createModel(n.Types.COMPANY);let h;return o?(c.set("id",o),await c.fetchPromise(),(h=c.addresses).setParentResourceId(o)):h=i.createCollection(r.Types.COMPANY),{company:c,companyAddresses:h}}static _findCurrentCartPhase(t){return t.find(function(t){const e=t.getState();return e===p.States.ACCEPTED||e===p.States.PAYMENT_REFUSED})}static _isItFirstPayment({cartPhases:t,cartPhase:e}){let a=!0;return t.forEach(t=>{t.getPhaseNumber()<e.getPhaseNumber()&&(a=a&&t.getState()===p.States.DELETED)}),a}}});