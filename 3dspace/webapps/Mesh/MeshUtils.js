define("DS/Mesh/MeshUtils",["DS/Mesh/Mesh","DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/Visualization/GraphicAttributeSet"],function(e,r,a,t){"use strict";return e.convertTo3jsGeometry=function(e,a){if(e.length){for(var t=[],n=null,o=null,l=new r.Sphere,i=new r.Box3,s=0;s<e.length;s++){var u=e[s],v=new r.BufferGeometryDS,y=new r.Vector3(u.AABB.min[0],u.AABB.min[1],u.AABB.min[2]),c=new r.Vector3(u.AABB.max[0],u.AABB.max[1],u.AABB.max[2]);null==n&&(n=y),null==o&&(o=c),y.x<n.x&&(n.x=y.x),y.y<n.y&&(n.y=y.y),y.z<n.z&&(n.z=y.z),c.x>o.x&&(o.x=c.x),c.y>o.y&&(o.y=c.y),c.z>o.z&&(o.z=c.z),i.set(n,o),l.radius=o.clone().sub(n).multiplyScalar(.5).length(),l.center=o.clone().add(n).multiplyScalar(.5);for(var g=0;g<u.drawingGroups.length;g++)u.drawingGroups[g].geometry=v;v.drawingGroups=u.drawingGroups,v.vertexPositionArray=u.vertexPositionArray,null!==u.vertexNormalArray&&(v.vertexNormalArray=u.vertexNormalArray),null!==u.vertexUvArray&&(v.vertexUvArray=u.vertexUvArray),u.vertexUv2Array&&(v.vertexUv2Array=u.vertexUv2Array),u.vertexTangentArray&&(v.vertexTangentArray=u.vertexTangentArray),u.vertexBinormalArray&&(v.vertexBinormalArray=u.vertexBinormalArray),v.vertexIndexArray=u.vertexIndexArray,t.push(v)}return t.boundingSphere=l,t.boundingBox=i,t}},e.convertTo3jsMesh=function(n,o,l,i,s,u){if(n.length){for(var v=window.newMaterialInheritance,y=null,c=[],g=null,A=null,d=new r.Sphere,x=new r.Box3,m=new a,h=!1,p=0;p<n.length;p++){var w=n[p],f=new r.BufferGeometryDS;f.editable=w.editable,void 0!==i&&(f.sharedBuffers=i),void 0!==s&&(f.noMeshInRAM=s);var B=new r.Vector3(w.AABB.min[0],w.AABB.min[1],w.AABB.min[2]),M=new r.Vector3(w.AABB.max[0],w.AABB.max[1],w.AABB.max[2]);null==g&&(g=B),null==A&&(A=M),B.x<g.x&&(g.x=B.x),B.y<g.y&&(g.y=B.y),B.z<g.z&&(g.z=B.z),M.x>A.x&&(A.x=M.x),M.y>A.y&&(A.y=M.y),M.z>A.z&&(A.z=M.z),x.set(g,A),d.radius=A.clone().sub(g).multiplyScalar(.5).length(),d.center=A.clone().add(g).multiplyScalar(.5);for(var S=0;S<w.drawingGroups.length;S++){var T=w.drawingGroups[S];if(h||0!==T._geomType&&(h=!0),T.geometry=f,void 0!==l&&l){var G=null,b=null,C=T.gas,N=T.material;if(N)T.gas=N;else if(null!==C)if(null!=b&&e.areEqualGraphicProperties(b,C))T.gas=G;else{var U=new r.Color;U.setRGB(C.color.r,C.color.g,C.color.b);var z={color:U,opacity:C.opacity};C.linewidth&&(console.warn("DEPRECATED : Use lineWidth (cameCase) instead of linewidth."),C.lineWidth=C.linewidth),C.lineWidth?(z.lineWidth=C.lineWidth,C.pattern&&(z.pattern=C.pattern)):C.pointsize?(z.symbol=0,z.size=C.pointsize):z.solid=C.solid,v?(T.gas=t._createFromGASAttributes(z),T.gas.setParameters({inheritanceCustom:r.GASEnumCustom._TYPE_FROM_PARENT})):T.gas=m.getMaterialFromGAS(z),G=T.gas,b=C}}}f.drawingGroups=w.drawingGroups,u&&(f.decorations=u),f.vertexPositionArray=w.vertexPositionArray,null!==w.vertexNormalArray&&(f.vertexNormalArray=w.vertexNormalArray),null!==w.vertexColorArray&&(f.vertexColorArray=w.vertexColorArray),null!==w.vertexUvArray&&(f.vertexUvArray=w.vertexUvArray),w.vertexUv2Array&&(f.vertexUv2Array=w.vertexUv2Array),w.vertexTangentArray&&(f.vertexTangentArray=w.vertexTangentArray),w.vertexBinormalArray&&(f.vertexBinormalArray=w.vertexBinormalArray),f.vertexIndexArray=w.vertexIndexArray,o&&!o.isCPUPattern&&(o.isDashedLine||o.backMaterial&&o.backMaterial.isDashedLine)&&f.computeLineDistances(n.patternOffsets),c.push(f)}d.radius||(d.radius=.1),x.min.distanceToSquared(x.max)||x.expandByScalar(.1),c.boundingSphere=d,c.boundingBox=x,(y=new r.Mesh(c,o)).matrixAutoUpdate=!1,y.castShadow=!0,y.receiveShadow=!0;var D=new e.SGBag;return D.children.push(n[0].rep),n[0].rep.parents.push(D),y.sceneGraph=D,y.fromLoadedModel=h,y}},e.createEmptyMesh=function(){var e=new r.BufferGeometryDS;e.boundingSphere=new r.Sphere(new r.Vector3,0),e.boundingBox=new r.Box3;var a=r.MaterialUtils.createShinyFaceMaterial();return mesh=new r.Mesh(e,a),mesh.matrixAutoUpdate=!1,mesh.castShadow=!0,mesh.receiveShadow=!0,new THREEDS.Nodes.Mesh(mesh)},e.convertTo3js=function(e,a,t,n){var o,l=null,i=[],s=null,u=null,v=new r.Sphere,y=new r.Box3,c=new THREEDS.MaterialManager;c.cleanResources();for(var g=0;g<e.length;g++){var A=e[g],d=new r.BufferGeometryDS,x=new r.Vector3(A.AABB.min[0],A.AABB.min[1],A.AABB.min[2]),m=new r.Vector3(A.AABB.max[0],A.AABB.max[1],A.AABB.max[2]);null==s&&(s=x),null==u&&(u=m),x.x<s.x&&(s.x=x.x),x.y<s.y&&(s.y=x.y),x.z<s.z&&(s.z=x.z),m.x>u.x&&(u.x=m.x),m.y>u.y&&(u.y=m.y),m.z>u.z&&(u.z=m.z),y.set(s,u),v.radius=u.clone().sub(s).multiplyScalar(.5).length(),v.center=u.clone().add(s).multiplyScalar(.5);for(var h=0;h<A.drawingGroups.length;h++){A.drawingGroups[h].geometry=d;var p=A.drawingGroups[h].gas,w=A.drawingGroups[h].material;if(n&&null!==w&&!w.file&&-1!==w.id)null!=n[w.id]?o=n[w.id]:(o=c.getMaterialCgr(a[w.id],void 0,"CGR",t,A.drawingGroups[h]),n[w.id]=o),A.drawingGroups[h].gas=o;else if(null!==p&&p.color){var f=new r.Color;f.setRGB(p.color.r,p.color.g,p.color.b),A.drawingGroups[h].gas=c.getMaterialFromGAS({color:f,opacity:p.opacity,lineWidth:p.lineWidth?p.lineWidth:p.linewidth,solid:p.solid,symbol:p.symbol,basic:p.basic,resource:t})}}d.drawingGroups=A.drawingGroups,d.vertexPositionArray=A.vertexPositionArray,null!==A.vertexNormalArray&&(d.vertexNormalArray=A.vertexNormalArray),null!==A.vertexUvArray&&(d.vertexUvArray=A.vertexUvArray),A.vertexUv2Array&&(d.vertexUv2Array=A.vertexUv2Array),A.vertexTangentArray&&(d.vertexTangentArray=A.vertexTangentArray),A.vertexBinormalArray&&(d.vertexBinormalArray=A.vertexBinormalArray),d.vertexIndexArray=A.vertexIndexArray,i.push(d)}var B=new r.Color;B.setRGB(e[0].gas.fill.color.r,e[0].gas.fill.color.g,e[0].gas.fill.color.b);var M=new r.Color;return M.setRGB(e[0].gas.line.color.r,e[0].gas.line.color.g,e[0].gas.line.color.b),(w=c.getMaterialFromGAS({color:B,opacity:e[0].gas.fill.opacity,solid:e[0].gas.fill.solid,basic:e[0].gas.fill.basic})).line=c.getMaterialFromGAS({color:M,opacity:e[0].gas.line.opacity,lineWidth:e[0].gas.line.lineWidth?e[0].gas.line.lineWidth:e[0].gas.line.linewidth}),i.boundingSphere=v,i.boundingBox=y,(l=new r.Mesh(i,w)).matrixAutoUpdate=!1,l.castShadow=!0,l.receiveShadow=!0,e.length&&(l.sceneGraph=e[0].sceneGraph),new THREEDS.Nodes.Mesh(l)},e.mergeGeometries=function(r,a){if(!a)throw new"no clone link";r.invalidRatio=r.invalidRatio||0;for(var t=0,n=0,o=[],l=0,i=!1,s=!1,u=!1,v=!1,y=!1,c=!1,g=0;g<r.layers.length;g++){(x=r.layers[g].drawableInterval).layerNum<=0&&(l+=x.count)}for(g=0;g<r.geometries.length;g++){t+=(H=r.geometries[g]).vertexIndexArray.length,n+=H.vertexPositionArray.length,o[g]=H.vertexPositionArray.length,i=null!==H.vertexNormalArray,s=null!==H.vertexUvArray,u=null!==H.vertexUv2Array,v=null!==H.vertexColorArray,y=null!==H.vertexTangentArray,c=null!==H.vertexBinormalArray}if(!l&&!r.force)return null;if(!r.force&&l/t<r.invalidRatio)return null;var A=new e.SGPrimitiveHelper,d=[];for(g=0;g<r.layers.length;g++){var x,m=r.layers[g].drawableGroup;if(a.has(m)||a.set(m,new Map),(x=r.layers[g].drawableInterval).layerNum>0)for(var h=x.primitiveStart;h<x.primitiveStart+x.primitiveCount;h++)A.set(m,h),d.push(A.clone())}d.sort(function(e,r){var a=e.getGroup(),t=r.getGroup();return a.glType<t.glType?-1:a.glType>t.glType?1:a._geomType<t._geomType?-1:a._geomType>t._geomType?1:null===a.gas?-1:null===t.gas?1:a.gas.id<t.gas.id?-1:a.gas.id>t.gas.id?1:0});var p=[];for(g=0;g<o.length;g++){p[g]=new Int32Array(o[g]/3);for(h=0;h<p[g].length;h++)p[g][h]=-1}var w=[],f=[],B=[],M=[],S=[],T=[],G=[],b=[],C=[],N=[],U=Math.min(n,196608),z=Math.min(4*n/3,262144);f[0]=new Float32Array(U),B[0]=i?new Float32Array(U):null,M[0]=s?new Float32Array(U):null,S[0]=u?new Float32Array(U):null,T[0]=v?new Float32Array(z):null,G[0]=y?new Float32Array(U):null,b[0]=c?new Float32Array(U):null,C[0]=new Uint16Array(t);var D=(ee=d[0].getGroup()).glType,F=ee._geomType,_=ee.gas,V=[],P=[],R=[],E=0,I=0,j=0,W=0,k=0;for(g=0;g<d.length;g++){var L=d[g],H=(m=L.getGroup()).geometry,O=r.geometries instanceof Array?r.geometries.indexOf(H):0,q=H.vertexPositionArray,J=H.vertexNormalArray,Y=H.vertexUvArray,K=H.vertexUv2Array,Q=H.vertexColorArray,X=H.vertexTangentArray,Z=H.vertexBinormalArray,$=H.vertexIndexArray;if(I+L.getCount()>=65536){var ee=new e.DrawingGroup(_,_,D,j,k-j,void 0,void 0,F);V.push(ee);for(h=0;h<P.length;h++){var re=R[h];A.set(ee,ee._primitives.length),P[h].group=ee,ee._primitives.push(P[h]),a.get(re.container).set(re.index,A.clone())}P=[],R=[],N[E]=V,w[E]={index:k,data:I},D=m.glType,F=m._geomType,_=m.gas,V=[],I=0,j=0,W=0,k=0,U=196608,z=262144,f[++E]=new Float32Array(U),B[E]=i?new Float32Array(U):null,M[E]=s?new Float32Array(U):null,S[E]=u?new Float32Array(U):null,T[E]=v?new Float32Array(z):null,G[E]=y?new Float32Array(U):null,b[E]=c?new Float32Array(U):null,C[E]=new Uint16Array(t);for(var ae=0;ae<o.length;ae++)for(h=0;h<p[ae].length;h++)p[ae][h]=-1}else if(m.glType!==D||m.gas!==_||m._geomType!==F){ee=new e.DrawingGroup(_,_,D,j,k-j,void 0,void 0,F);D=m.glType,F=m._geomType,_=m.gas,V.push(ee),j=k;for(h=0;h<P.length;h++){re=R[h];A.set(ee,ee._primitives.length),P[h].group=ee,ee._primitives.push(P[h]),a.get(re.container).set(re.index,A.clone())}P=[],R=[]}W=k;for(h=0;h<L.getCount();h++){var te=$[L.getStart()+h],ne=p[O][te];if(-1===ne){for(var oe=0;oe<3;oe++)f[E][3*I+oe]=q[3*te+oe],i&&(B[E][3*I+oe]=J[3*te+oe]),s&&(M[E][3*I+oe]=Y[3*te+oe]),u&&(S[E][3*I+oe]=K[3*te+oe]),y&&(G[E][3*I+oe]=X[3*te+oe]),c&&(b[E][3*I+oe]=Z[3*te+oe]);if(v)for(oe=0;oe<4;oe++)T[E][4*I+oe]=Q[4*te+oe];p[O][te]=I,C[E][k++]=I,I++}else C[E][k++]=ne}var le=L._getSGPrimitive();le.start=W,P.push(le),R.push(L)}if(P.length>0){ee=new e.DrawingGroup(_,_,D,j,k-j,void 0,void 0,F);V.push(ee);for(h=0;h<P.length;h++){re=R[h];A.set(ee,ee._primitives.length),P[h].group=ee,ee._primitives.push(P[h]),a.get(re.container).set(re.index,A.clone())}P=[],R=[],N[E]=V,w[E]={index:k,data:I}}var ie=E+1,se=null;for(g=0;g<ie;g++){U=w[g];var ue=C[g],ve=f[g],ye=B[g],ce=(Y=M[g],K=S[g],T[g]),ge=G[g],Ae=b[g];if(U.index<ue.length){se=new Uint16Array(U.index);for(h=0;h<U.index;h++)se[h]=ue[h];C[g]=se}if(3*U.data<ve.length){var de=3*U.data,xe=4*U.data;se=new Float32Array(de);for(h=0;h<de;h++)se[h]=ve[h];if(f[g]=se,i){se=new Float32Array(de);for(h=0;h<de;h++)se[h]=ye[h];B[g]=se}if(s){se=new Float32Array(de);for(h=0;h<de;h++)se[h]=Y[h];M[g]=se}if(u){se=new Float32Array(de);for(h=0;h<de;h++)se[h]=K[h];S[g]=se}if(v){se=new Float32Array(xe);for(h=0;h<xe;h++)se[h]=ce[h];T[g]=se}if(y){se=new Float32Array(de);for(h=0;h<de;h++)se[h]=ge[h];G[g]=se}if(c){se=new Float32Array(de);for(h=0;h<de;h++)se[h]=Ae[h];b[g]=se}}}var me=[];for(g=0;g<ie;g++){var he=new e.Mesh;he.vertexPositionArray=f[g],he.vertexNormalArray=B[g],he.vertexUvArray=M[g],he.vertexUv2Array=S[g],he.vertexColorArray=T[g],he.vertexTangentArray=G[g],he.vertexBinormalArray=b[g],he.vertexIndexArray=C[g],he.drawingGroups=N[g];var pe=[0,0,0],we=[0,0,0];if(f[g].length>=3){pe=[f[g][0],f[g][1],f[g][2]],we=[f[g][0],f[g][1],f[g][2]];for(var fe=0;fe<f[g].length;fe+=3)f[g][fe]<pe[0]&&(pe[0]=f[g][fe]),f[g][fe+1]<pe[1]&&(pe[1]=f[g][fe+1]),f[g][fe+2]<pe[2]&&(pe[2]=f[g][fe+2]),f[g][fe]>we[0]&&(we[0]=f[g][fe]),f[g][fe+1]>we[1]&&(we[1]=f[g][fe+1]),f[g][fe+2]>we[2]&&(we[2]=f[g][fe+2])}he.AABB={min:pe,max:we},me.push(he)}return e.convertTo3jsGeometry(me,null)},e.createCuboidMesh=function(r,a,t,n,o){var l=e._createCuboidMesh(r.corner,r.firstAxis,r.secondAxis,r.thirdLength,a,null);return e.convertTo3jsMesh([l],t,!1,n,o)},e.createCustomCylinderMesh=function(r,a,t,n,o){var l=new multiTabDecorations,i=e._createCustomCylindricalMesh(r.bottomCenter,r.topCenter,r.bottomRadius,r.topRadius,a,null,r.sag,!1,l);return e.convertTo3jsMesh([i],t,!1,n,o,l.getConcatenatedBlocks())},e.createCustomSphereMesh=function(r,a,t,n,o){var l=new multiTabDecorations,i=e._createCustomSphereMesh(r.parallelStart,r.parallelEnd,r.meridianStart,r.meridianEnd,r.center,r.firstAxis,r.secondAxis,a,null,r.sag,!1,l);return e.convertTo3jsMesh([i],t,!1,n,o,l.getConcatenatedBlocks())},e.createCurvedPipeMesh=function(a,t,n,o,l){for(var i=[],s=[],u=0,v=0;v<a.centers.length/3;v++)s.push(a.radius),i.push(new r.Vector3(a.centers[u++],a.centers[u++],a.centers[u++]));var y=new r.Vector3(a.startN[0],a.startN[1],a.startN[2]),c=new r.Vector3(a.endN[0],a.endN[1],a.endN[2]),g=e._createCurvedPipeMesh(i,s,y,c,!0,t,null,a.sag);return e.convertTo3jsMesh([g],n,!1,o,l)},e.createTorusMesh=function(a,t,n,o,l){var i=new multiTabDecorations,s=new r.Vector3(a.planeNormal[0],a.planeNormal[1],a.planeNormal[2]),u=s.length();s.normalize();var v=new r.Vector3(-a.planeNormal[2],a.planeNormal[0],-a.planeNormal[1]),y=new r.Vector3;y.crossVectors(s,v),y.normalize();var c=new r.Vector3;c.crossVectors(s,y),c.normalize(),y.multiplyScalar(u),c.multiplyScalar(u);for(var g=new r.Vector3(a.center[0],a.center[1],a.center[2]),A=e._buildCurvedPipeDataFromTorus(g,y,c,2*Math.PI,a.sag),d=[],x=[],m=0,h=0;h<A.centers.length/3;h++)x.push(a.minorRadius),d.push(new r.Vector3(A.centers[m++],A.centers[m++],A.centers[m++]));var p=new r.Vector3(A.startNormal[0],A.startNormal[1],A.startNormal[2]),w=e._createTorusMesh(g,d,x,p,t,null,a.sag,!1,i);return e.convertTo3jsMesh([w],n,!1,o,l,i.getConcatenatedBlocks())},e.createPartialTorusMesh=function(a,t,n,o,l){for(var i=new multiTabDecorations,s=new r.Vector3(a.center[0],a.center[1],a.center[2]),u=e._buildCurvedPipeDataFromTorus(s,new r.Vector3(a.firstAxis[0],a.firstAxis[1],a.firstAxis[2]),new r.Vector3(a.secondAxis[0],a.secondAxis[1],a.secondAxis[2]),a.majorAngle,a.sag),v=[],y=[],c=0,g=0;g<u.centers.length/3;g++)y.push(a.minorRadius),v.push(new r.Vector3(u.centers[c++],u.centers[c++],u.centers[c++]));var A=new r.Vector3(u.startNormal[0],u.startNormal[1],u.startNormal[2]),d=new r.Vector3(u.endNormal[0],u.endNormal[1],u.endNormal[2]),x=e._createCurvedPipeMesh(v,y,A,d,!0,t,null,a.sag,!1,i,a);return e.convertTo3jsMesh([x],n,!1,o,l,i.getConcatenatedBlocks())},e}),define("Mesh/MeshUtils",["DS/Mesh/MeshUtils","DS/DSMigration/DSMigration"],function(e,r){return r.deprecateModule("Mesh/MeshUtils"),e});