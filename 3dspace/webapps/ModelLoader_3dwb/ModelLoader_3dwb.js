define("DS/ModelLoader_3dwb/loader",["UWA/Core","DS/Plugins/UserRenderList","DS/ZipJS/zip","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWThreeJsExtender","DS/CAT3DWVisu/CAT3DWNode3DHyperlink","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CAT3DSKExperience/CAT3DSKAnnotationAbbreviationsExperience","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/Usage/TrackerAPI","DS/Visualization/MaterialApplication","DS/CAT3DWVideosUI/CAT3DWVideosController","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/CAT3DWInfraUI/CAT3DWHandleErrors","DS/SVGLoader/SVGLineMaterial","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/Mesh/MeshUtils","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices","DS/CAT3DWInfra/CAT3DWUrlServices","DS/WebappsUtils/WebappsUtils","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DWFileServices","DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils","DS/CAT3DWText/CAT3DWTextCommonConstants","DS/CAT3DWText/CAT3DWTextRenderService","DS/CAT3DWVisu/CAT3DWGeomFactory","DS/CAT3DWRichLinksUI/CAT3DWRichLinkHtmlView","DS/CAT3DWInfraUI/CAT3DWDataModelConverter","DS/CAT3DWInfraUI/CAT3DWCanvasServices","DS/CAT3DWInfraUI/CAT3DWCanvasLimits","DS/ControlsEx/LoadingPanel","DS/CATCreaDesWebUIServices/CATCrDWebUIServices","DS/Visualization/PolygonTessellator","UWA/Utils/Client","DS/Utilities/Color","css!DS/UIKIT/UIKIT"],function(e,t,i,n,o,r,a,s,l,d,c,h,p,m,u,f,g,_,v,w,D,x,y,C,M,S,b,T,P,V,k,A,I,R,E,L,U,N,W){"use strict";return e.Class.extend({init:function(t){this._parent(t),this._3dMediaCounter=0,this._2dMediaCounter=0,this._videoController=new m,this._mapVid=new Map,this._placeHolderMap=new Map;const i=(e,t)=>{this._viewer.div&&t.viewerDiv?t.viewerDiv===this._viewer.div&&e():e()};this._onStartExperience=f.subscribe({event:"CAT3DSKExperienceStart"},i.bind(this,this.startExperience.bind(this))),this._onStopExperience=f.subscribe({event:"CAT3DSKExperienceStop"},i.bind(this,this.stopExperience.bind(this))),this._onExitExperience=f.subscribe({event:"CAT3DSKExperienceExit"},i.bind(this,this.dispose.bind(this))),this._onMuteAllVideos=f.subscribe({event:"CAT3DSKExperienceMuteVideos"},i.bind(this,this.muteAllVideos.bind(this))),this._onUnmuteAllVideos=f.subscribe({event:"CAT3DSKExperienceUnmuteVideos"},i.bind(this,this.unmuteAllVideos.bind(this))),this._isMobileApp=!1,window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(this._isMobileApp=!0,M.setPreferenceValue("M3DEMobile",!0)),this._placeholderUrl=C.getWebappsAssetUrl("CAT3DWInfra","placeholders/xl_thumb_waiting_processing.png"),this._isMobileApp&&(this._placeholderUrl=e.Data.proxifyUrl(this._placeholderUrl,{proxy:"passport"})),this._placeholderSmallView=C.getWebappsAssetUrl("CAT3DWRichLinksUI","LinkPlaceholderView.png"),this._isMobileApp&&(this._placeholderSmallView=e.Data.proxifyUrl(this._placeholderSmallView,{proxy:"passport"})),this._defaultRectangleValue=100,this._textRenderService=new P},dispose:function(){f.unsubscribe(this._onExitExperience),f.unsubscribe(this._onStartExperience),f.unsubscribe(this._onStopExperience),f.unsubscribe(this._onMuteAllVideos),f.unsubscribe(this._onUnmuteAllVideos),this.stopExperience(),this._3DModelsNode.removeChildren(),this._3DModelsNode=null,this._videoModelsNode.removeChildren(),this._videoModelsNode=null,this._annotContainer.removeChildren(),this._annotContainer=null,this._connectionContainer.removeChildren(),this._connectionContainer=null,this._3DSKTContainer.removeChildren(),this._3DSKTContainer=null,this._textRenderService=null,this._swymMediaServices.dispose(),this._swymMediaServices=null,this._beforeMainPass=null,this._viewer=null,this._pickedObject=null,this._onMoveToken=null,this._mapVid.forEach(e=>{this._videoController.removeVideo(e.video)}),this._videoController.dispose(),this._videoController=null,this._mapVid=null},startExperience:function(){this._normal=new a.Vector3(0,0,-1),this._pickedObject=null,this._onDownCB=this._onDown.bind(this),this._onMovePointerCB=this._onMovePointer.bind(this),this._onUpCB=this._onUp.bind(this);const e=this._viewer.div;e.addEventListener(u.POINTERDOWN,this._onDownCB),e.addEventListener(u.POINTERMOVE,this._onMovePointerCB),e.addEventListener(u.POINTERUP,this._onUpCB),this._onMoveToken=this._viewer.currentViewpoint.control.onMove(this._onMove.bind(this))},stopExperience:function(){const e=this._viewer.div;if(e.removeEventListener(u.POINTERDOWN,this._onDownCB),e.removeEventListener(u.POINTERMOVE,this._onMovePointerCB),e.removeEventListener(u.POINTERUP,this._onUpCB),this._viewer.currentViewpoint.control.unsubscribe(this._onMoveToken),this._pickedObject=null,this._normal=null,this._3DModelsNode&&this._3DModelsNode.children)for(let e=0;e<this._3DModelsNode.children.length;e++)this._3DModelsNode.children[e].setMatrix(new a.Matrix4);this._mapVid.forEach(e=>{e.video.pause(),e.video.reset()})},muteAllVideos:function(){this._mapVid.forEach(e=>{e.video.mute()})},unmuteAllVideos:function(){this._mapVid.forEach(e=>{e.video.unmute()})},_onDown:function(t){if(this._pickedObject=this._viewer.pick(this._viewer.getMousePosition(new a.Vector2(t.offsetX,t.offsetY)),"primHybrid",!0),this._pickedObject){this._pickedObject.modelObject=null,this._pickedObject.position&&(this._lastMousePosition=new a.Vector2(t.offsetX,t.offsetY));const i=this._pickedObject.path&&this._pickedObject.path[0]?this._pickedObject.path[0]:null;i&&i.externalPath.some((n,o,r)=>{const s=n.name===this._videoModelsNode.name,l=n.name===this._3DModelsNode.name;let d=n.isURL;if(s||l){const e=r[o+1];if(d=e.isURL,!e)return!1;if(s?this._mapVid.get(e.name)?(this._videoClick(e.name),h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_ExperienceVideoClic",eventLabel:"Clic on an embedded link in 3DWhiteboard",appID:"X3DWHTB_AP"})):this._mapVid.forEach(n=>{i.externalPath.length>o+2&&e===n.video._timeline._mainNode&&i.externalPath[o+2]===n.video._timeline._mainLine?n.video.processtimelineTapInVideo(new a.Vector2(t.offsetX,t.offsetY)):i.externalPath.length>o+2&&e===n.video._timeline._mainNode&&i.externalPath[o+2]===n.video._timeline._volumeButtonNode&&n.video.processPickInVideoVolume(new a.Vector2(t.offsetX,t.offsetY))}):this._pickedObject.modelObject=e,!d)return!0;n=e}if("CAT3DWNode3DHyperlink"===n.getName()||d){let t=function(e){window.open(e),h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_ExperienceLinkClic",eventLabel:"Clic on an embedded link in 3DWhiteboard",appID:"X3DWHTB_AP"})};if(e.Utils.Client.Platform.ios||e.Utils.Client.Platform.ipad){this._goToUrlBtnContainer&&(this._goToUrlBtnContainer.remove(),this._goToUrlBtnContainer=null),this._goToUrlBtnContainer=e.createElement("div",{styles:{width:"42px",height:"42px",cursor:"pointer",borderRadius:"100%",boxShadow:"0 0 3px rgba(0,0,0,.5)",display:"flex",position:"absolute",marginLeft:"-22px",marginTop:"-22px",backgroundColor:"#42a2da"}}).inject(this._viewer.div),e.createElement("div",{class:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-open-in-a-new-window",styles:{fontSize:"18px",margin:"auto",color:"white"}}).inject(this._goToUrlBtnContainer);let i=this._viewer.currentViewpoint.project(n.topLeft),o=this._viewer.currentViewpoint.project(n.topRight),r=i.x-o.x,s=500;if("CAT3DWNode3DHyperlink"===n.getName()){let e=new a.Vector3(n.topLeft.x,n.topLeft.y,n.topLeft.z);e.y=e.y+5;let t=(r=this._viewer.currentViewpoint.project(e).x-i.x)/15;this._goToUrlBtnContainer.style.scale=t}else if(r<s){let e=r/s;e<.7&&(e=.7),this._goToUrlBtnContainer.style.scale=e}this._goToUrlBtnContainer.setStyle("left",i.x),this._goToUrlBtnContainer.setStyle("top",i.y),this._goToUrlBtnContainer.addEvent(u.POINTERDOWN,function(){t(n.url),this._goToUrlBtnContainer&&(this._goToUrlBtnContainer.remove(),this._goToUrlBtnContainer=null)}.bind(this))}else this._pickedObject.position&&"CAT3DWNode3DHyperlink"===n.getName()&&this._pickedObject.position.x<=n.cornerTopLeft.x&&this._pickedObject.position.x>=n.cornerTopLeft.x-5&&t(n.url)}return!1})}},_onMovePointer:function(e){if(this._pickedObject&&this._pickedObject.modelObject){var t=new a.Vector2(e.offsetX,e.offsetY);if(this._lastMouseMoveDistance=this._lastMousePosition.distanceTo(t),isNaN(this._lastMouseMoveDistance))return void(this._lastMouseMoveDistance=0);var i=t.clone().sub(this._lastMousePosition).normalize(),n=this._pickOnPlaneOfObject(new a.Vector2,this._pickedObject.position),o=this._pickOnPlaneOfObject(i,this._pickedObject.position);this._lastMousePosition=t;var r=o.sub(n).normalize().clone().cross(this._normal).normalize(),s=.005*this._lastMouseMoveDistance;s&&this._rotate3DModel(this._pickedObject.modelObject,r,s)}else{var l=this._viewer.pick(this._viewer.getMousePosition(new a.Vector2(e.offsetX,e.offsetY)),"primHybrid",!0);if(l){const t=l.path&&l.path[0]?l.path[0]:null;t?t.externalPath.some((i,n,o)=>{if(i.name===this._videoModelsNode.name){const i=o[n+1];return!!i&&(this._mapVid.forEach(o=>{t.externalPath.length>n+2&&i===o.video._timeline._mainNode&&t.externalPath[n+2]===o.video._timeline._mainLine?o.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!0):o.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)}),!0)}return this._mapVid.forEach(t=>{t.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)}),!1}):this._mapVid.forEach(t=>{t.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)})}else this._mapVid.forEach(t=>{t.video.processtimelineMoveInVideo(new a.Vector2(e.offsetX,e.offsetY),!1)})}},_onUp:function(){this._pickedObject=null},_pickOnPlaneOfObject:function(e,t){var i=new a.Plane;return i.setFromNormalAndCoplanarPoint(this._normal,t).normalize(),this._viewer.currentViewpoint.create3DRayFrom2DPoint(e).intersectPlane(i)},_rotate3DModel:function(e,t,i,n){var o,r,s;n?(o=(new a.Matrix4).makeTranslation(-n.x,-n.y,-n.z),r=(new a.Matrix4).makeTranslation(n.x,n.y,n.z)):"bbox_3D"===e.parents[0].name?(s=e.parents[0].getBoundingBox().center(),o=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),r=(new a.Matrix4).makeTranslation(s.x,s.y,s.z)):"bbox_3D"===e.name?(s=e.getBoundingBox().center(),o=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),r=(new a.Matrix4).makeTranslation(s.x,s.y,s.z)):(s=e.getCenter(),o=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),r=(new a.Matrix4).makeTranslation(s.x,s.y,s.z));var l=(new a.Matrix4).makeRotationAxis(t,i);e.applyMatrix(o),e.applyMatrix(l),e.applyMatrix(r),this._viewer.render()},_videoClick:function(e){var t=this._mapVid.get(e);t&&t.video&&(t.video.isPlaying()?t.video.pause():t.video.play())},_onMove:function(){var e,t;this._mapVid.forEach((i,n)=>{e=i,t=new a.Vector2(this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.topRight)),this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.bottomLeft)));var o={bottomLeft:e.bottomLeft,bottomRight:e.bottomRight,topLeft:e.topLeft,topRight:e.topRight};e.video.updateVideoControls(e.position,t,o,n)}),this._goToUrlBtnContainer&&(this._goToUrlBtnContainer.remove(),this._goToUrlBtnContainer=null)},unzip:function(e){return new Promise(function(t){var n=new i.BlobReader(e);i.createReader(n,function(e){var n=e;n.getEntries(function(e){var o=e.find(function(e){return"sketch.json"===e.filename});o&&o.getData(new i.TextWriter,function(e){var i=e.target.result;n.close(function(){t(i)})})})},function(){console.log("zip error")})})},_convertJSON:function(e){return new Promise(function(t){this._DataModelConverter.convertToLatestVersion(e).then(function(e){t(e)}).catch(function(){t(e)})}.bind(this))},readJsonFile:function(e){return new Promise(function(t,i){var n={proxy:"none",type:"arraybuffer",timeout:6e5,onComplete:function(e){t(new Blob([e],{type:"application/zip"}))},onError:function(e){i(e)}};d.authenticatedRequest(e,n)})},getListPointFromCircle:function(e,t){for(var i=[],n=new a.Vector3(t.x,t.y,t.z),o=new a.Vector3(e.annotStartPoint.x,e.annotStartPoint.y,e.annotStartPoint.z),r=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),s=e.geometry.radius,l=(new a.Vector3).subVectors(o,r).normalize(),d=(new a.Vector3).crossVectors(l,n).normalize(),c=2*Math.PI/e.pointsCount,h=0;h<2*Math.PI;h+=c){var p=r.x+s*Math.cos(h)*l.x+s*Math.sin(h)*d.x,m=r.y+s*Math.cos(h)*l.y+s*Math.sin(h)*d.y,u=r.z+s*Math.cos(h)*l.z+s*Math.sin(h)*d.z;i.push(new a.Vector3(p,m,u))}return i.push(i[0]),i},getListPointFromEllipse:function(e){for(var t=[],i=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),n=new a.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z),o=new a.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z),r=e.geometry.majorAxis.length,s=e.geometry.minorAxis.length,l=2*Math.PI/e.pointsCount,d=0;d<2*Math.PI;d+=l){var c=i.x+r*Math.cos(d)*n.x+s*Math.sin(d)*o.x,h=i.y+r*Math.cos(d)*n.y+s*Math.sin(d)*o.y,p=i.z+r*Math.cos(d)*n.z+s*Math.sin(d)*o.z;t.push(new a.Vector3(c,h,p))}return t.push(t[0]),t},getListPointFromLine:function(e){var t=[],i=new a.Vector3(e.geometry.startPoint.x,e.geometry.startPoint.y,e.geometry.startPoint.z),n=new a.Vector3(e.geometry.endPoint.x,e.geometry.endPoint.y,e.geometry.endPoint.z);return t.push(i,n),t},getListPointFromRectangle:function(e){var t=[],i=new a.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),n=new a.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),o=new a.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z),r=new a.Vector3(e.geometry.vertexD.x,e.geometry.vertexD.y,e.geometry.vertexD.z);return t.push(i,n,o,r,i),t},getListPointFromTriangle:function(e){var t=[],i=new a.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),n=new a.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),o=new a.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z);return t.push(i,n,o,i),t},getListPointFromUnknown:function(e){for(var t=[],i=0;i<e.geometry.points.length;i++){var n=new a.Vector3(e.geometry.points[i].x,e.geometry.points[i].y,e.geometry.points[i].z);t.push(n)}return t},_getLineMaterial:function(e){var t={color:e.color,lineWidth:e.thickness*window.devicePixelRatio,opacity:e.opacity,transparent:!1,force:!0,isCPUPattern:!0,linecap:"round",needsUpdate:!0};return new a.LineBasicMaterial(t)},_getSphereMaterial:function(e){return new a.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!1,force:!0})},_applyOpacityStencilOp:function(e,i){if(i.opacity<1){var n=this._viewer.getUserPassManager(),o=new t("StencilOpacityPass"),r=n.createUserRenderPass("userRenderPass",o);r.setEnableStencilTest(!0),r.setEnableStencilWrite(!0),r._passes[0].stencilRef=100*i.opacity,r.setStencilFunc("NOTEQUAL"),r.setStencilOpsSeparate("REPLACE","REPLACE","KEEP","KEEP");var a=n.getSystemPass("main");n.insertUserPassAfterPass(r,a),e.setRenderPasses([o])}},draw:function(e,t,i,o){var r={points:e};if("point"!==t){var s,l,d;if(i.strokeType&&"brush"===i.strokeType){for(var c=L.createMaterial(new a.Color(i.color),i.opacity,i.thickness,1),h=[],p=0;p<e.length;p++)h.push(new a.Vector3(0,0,1));s=L.createPencilGP(e,h,i.thickness,c)}else r.material=new a.SVGLineMaterial({color:i.color,lineWidth:i.thickness*window.devicePixelRatio,side:a.DoubleSide,opacity:i.opacity,enableClipPlanes:!1,linecap:"round",force:!0,transparent:!1}),s=n.createLineNode(r);if(s.setName("3DSketch_Annot"),this._annotContainer.add(s),!0===this._isClosed(e)&&"NoFill"!==i.fillingType){let t=1,n=1;.7===i.thickness?(t=1,n=1):1.4===i.thickness?(t=2,n=2):3.5===i.thickness?(t=3,n=3):4.9===i.thickness?(t=4,n=4):7===i.thickness&&(t=5,n=5);var m=new U;for(p=0;p<e.length;p++)m.addPointToCurrentPolygonLoop(e[p].x,-1*e[p].y);m.closeCurrentPolygonLoop(),m.endCurrentPolygon(),"Solid"===i.fillingType?((l=m.createNode3D(new a.MeshBasicMaterial({color:i.fillcolor,opacity:i.fillingOpacity,force:!0}),e[0].z)).name="CAT3DSketch-FillNode",this._annotContainer.addChild(l)):"Hatch"===i.fillingType?((l=m.createNode3D(this.createHatchingMaterial({stripesDirection:new a.Vector2(1,1),spaceWidth:t,stripesWidth:n,stripesColor:i.fillcolor,spaceOpacity:.3,stripesOpacity:i.fillingOpacity}),e[0].z)).name="CAT3DSketch-FillNode",this._annotContainer.addChild(l)):"CrossHatch"===i.fillingType&&((l=m.createNode3D(this.createHatchingMaterial({stripesDirection:new a.Vector2(1,1),spaceWidth:t,stripesWidth:n,stripesColor:i.fillcolor,spaceOpacity:.3,stripesOpacity:i.fillingOpacity}),e[0].z)).name="CAT3DSketch-FillNode",this._annotContainer.addChild(l),(d=m.createNode3D(this.createHatchingMaterial({stripesDirection:new a.Vector2(1,-1),spaceWidth:t,stripesWidth:n,stripesColor:i.fillcolor,spaceOpacity:.3,stripesOpacity:i.fillingOpacity}),e[0].z)).name="CAT3DSketch-FillNode-Cross ",this._annotContainer.addChild(d))}this._applyOpacityStencilOp(s,i),void 0!==o&&this.setDepth(o,s,l,d)}else this.drawPoint(e,i,o)},setDepth:function(e,t,i,n){var o=5*e;if(t.setRenderDepth(o),t.mesh3js.material.transparent=!0,t.mesh3js.material.depthTest=!1,i){var r=o-1;i.children[0].setRenderDepth(r),i.children[0].mesh3js.material.transparent=!0,i.children[0].mesh3js.material.depthTest=!1}if(n){r=o-2;n.children[0].setRenderDepth(r),n.children[0].mesh3js.material.transparent=!0,n.children[0].mesh3js.material.depthTest=!1}},createHatchingMaterial:function(e){var t,i,n=new a.MeshBasicMaterial({side:a.FrontSide,vertexColors:a.VertexColorType.RGBA,force:!0});t=e.spaceColor?new a.Color(e.spaceColor):new a.Color(16777215),i=e.stripesColor?new a.Color(e.stripesColor):new a.Color(16777215),n.activatePDSFX();var o={planeU:{type:"v3",value:new a.Vector3(1,0,0)},planeV:{type:"v3",value:new a.Vector3(0,1,0)},hatchingDirection:{type:"v2",value:e.stripesDirection.clone().normalize()},hatchingNormal:{type:"v2",value:new a.Vector2(e.stripesDirection.y,-e.stripesDirection.x).normalize()},hatchingSpaceWidth:{type:"f",value:e.spaceWidth},hatchingSpaceColor:{type:"v4",value:new a.Vector4(t.r,t.g,t.b,e.spaceOpacity)},hatchingLineWidth:{type:"f",value:e.stripesWidth},hatchingLineColor:{type:"v4",value:new a.Vector4(i.r,i.g,i.b,e.stripesOpacity)}};n.setPDSFXUniforms(o);n.setPDSFXVaryings({_uv:{type:"v2"},myPosition:{type:"v4"}});n.setPDSFXGlobalShaderCode("vec4 _mvPosition;","");var r={ProcessViewTangentSpace:"void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) { _mvPosition = vec4(ioWorldViewTS.Position, 0.0); }",ComputeVaryingValues:["void ComputeVaryingValues() {","mat4 VM = vGetViewMatrix();","vec3 mvPlaneU = (VM * vec4(planeU, 0.0)).xyz;","vec3 mvPlaneV = (VM * vec4(planeV, 0.0)).xyz;","_uv = vec2(dot(_mvPosition.xyz, mvPlaneU), dot(_mvPosition.xyz, mvPlaneV))-vec2(dot(VM[3].xyz, mvPlaneU), dot(VM[3].xyz, mvPlaneV));","}"].join("\n")},s={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","float eval = hatchingNormal.x*_uv.x + hatchingNormal.y*_uv.y;","float k = mod(eval, hatchingSpaceWidth);","vec2 fwx = dot(hatchingNormal, dFdx(_uv))*hatchingNormal;","vec2 fwy = dot(hatchingNormal, dFdy(_uv))*hatchingNormal;","vec2 fw = abs(fwx) + abs(fwy);","float fwlen = length(fw);","float tol = min(hatchingLineWidth*fwlen, hatchingSpaceWidth - fwlen);","if (k < tol/2.0 || k > hatchingSpaceWidth - tol/2.0) {","  ioFinalColor = hatchingLineColor;","} else {","  ioFinalColor = hatchingSpaceColor;","}","}"].join("\n")};return n.setPDSFXOverridableFunctions(r,s),n.hatching=!0,n},_isClosed:function(e){return this.isClosedTest(e[0].distanceTo(e[e.length-1]),this._polyPerimeter(e))},_polyPerimeter:function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i].distanceTo(e[(i+1)%e.length]);return t},isClosedTest:function(e,t){return e<Math.min(t/10,40)},drawPoint:function(e,t,i){var o=new a.MeshBasicMaterial({color:t.color,transparent:!1,force:!0,opacity:t.opacity,side:a.DoubleSide}),r=n.createCircleNode({segments:20,radius:.5*t.thickness,fill:!0,material:o});r.name="CAT3DSketch-PointNode",r.setMatrix((new a.Matrix4).setPosition(e[0])),this._annotContainer.addChild(r),this._applyOpacityStencilOp(r,t),void 0!==i&&this.setDepth(i,r)},load3DModel:function(t,i,n){return new Promise(function(o){"3dstory"!==this._appname&&o();var r=new y;i=r.generateUrlWithSuffix(i),this._isMobileApp&&(i=e.Data.proxifyUrl(i,{proxy:"passport"}));var l=new c,d="model3DNode_"+this._3dMediaCounter;this._3dMediaCounter++;var h=new s("bbox_3D"),p=new s(d);h.addChild(p),this._3DModelsNode.addChild(h),l.setOnLoadedCallback(()=>{var e=p.getBoundingBox().center(),t=new a.Matrix4;t.makeTranslation(-e.x,-e.y,-e.z);for(var i=0;i<p.children.length;i++)p.children[i].setMatrix(t);this._viewer.render(),o()}),l.setOnErrorCallback(function(e){console.error(e)}),l.loadModel({filename:i,proxyurl:"none",format:t,withCredentials:!0,viewer:this._viewer},p);var m=new a.Matrix4;m.setFromArray(n),p.setMatrix(m),r.dispose()}.bind(this))},onLoadImageError:function(){},_onTextureLoaded:function(){},apply2Dtexture:function(e,t,i,o,r){var l,d="";if(o?(d="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,l=new s(d),this._videoModelsNode.addChild(l)):(d="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,l=new s(d),this._3DSKTContainer.addChild(l)),e.flipY=!1,e.image.width<=0||e.image.height<=0)return l;let c=e.image.width,h=e.image.height;e.image.originalWidth&&e.image.originalHeight&&(c=e.image.originalWidth,h=e.image.originalHeight);var m={width:-100,height:-100,fill:!0,noEdge:!0},u=n.createRectangleNode(m);u.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0)));var f=(new a.Matrix4).makeRotationX(Math.PI);l.addChild(u),l.setMatrix(t),u.applyMatrix(f);var g=h/c,_=0,v=0;if(e.cropInfo){let t=c/e.cropInfo.cropData.hRatio;(g=h/e.cropInfo.cropData.vRatio/t)>1?(_=this._defaultRectangleValue,v=this._defaultRectangleValue/g):(_=this._defaultRectangleValue*g,v=this._defaultRectangleValue),_*=e.cropInfo.cropData.vRatio,v*=e.cropInfo.cropData.hRatio}else g>1?(_=this._defaultRectangleValue,v=this._defaultRectangleValue/g):(_=this._defaultRectangleValue*g,v=this._defaultRectangleValue);t.scale(new a.Vector3(Math.abs(v/this._defaultRectangleValue),Math.abs(_/this._defaultRectangleValue),1)),l.setMatrix(t);var w=new a.MeshBasicMaterial({map:e,side:a.DoubleSide,force:!0,transparent:!0,depthTest:!1});if(w.color=new a.Color,w.polygonOffset=!0,w.polygonOffsetFactor=.7,o){var D=u.getMatrixWorld(),x=u.mesh3js.geometry[0].vertexPositionArray,y=new a.Vector3(x[0],x[1],x[2]).applyMatrix4(D),C=new a.Vector3(x[3],x[4],x[5]).applyMatrix4(D),M=new a.Vector3(x[9],x[10],x[11]).applyMatrix4(D),S=new a.Vector3(x[6],x[7],x[8]).applyMatrix4(D);this._mapVid.set(l.name,{video:o,position:r,bottomLeft:M,bottomRight:S,topLeft:y,topRight:C});var b=new a.Vector2(this._viewer.currentViewpoint.project(y).distanceTo(this._viewer.currentViewpoint.project(C)),this._viewer.currentViewpoint.project(y).distanceTo(this._viewer.currentViewpoint.project(M))),T={bottomLeft:M,bottomRight:S,topLeft:y,topRight:C};o.updateVideoControls(r,b,T,l.name),l.topLeft=C,l.topRight=y}else{var P=u.getMatrixWorld(),V=u.mesh3js.geometry[0].vertexPositionArray;l.topRight=new a.Vector3(V[0],V[1],V[2]).applyMatrix4(P),l.topLeft=new a.Vector3(V[3],V[4],V[5]).applyMatrix4(P)}var k=new p({faceMaterial:w});return u.setMaterialApplication(k),o?u.setRenderDepth(i-4):u.setRenderDepth(i),this.textureLoaded=!0,l},load2DModel:function(t){return new Promise(function(i){let n=JSON.parse(t.associatedData.matrix).elements,o=5*t.associatedData.renderDepth,r=t.status,s=t.url,l=t.type,d=t.associatedData.cropData;if(r!==S.STATUS_KO&&r!==S.STATUS_PROCESSING){var c=new y;s=c.generateUrlWithSuffix(s)}this._isMobileApp&&(s=e.Data.proxifyUrl(s,{proxy:"passport"}));var h=new a.Matrix4;h.setFromArray(n);var p=null;if(l===S.TYPE_IMAGE||r===S.STATUS_PROCESSING)d?this._canvasServices.getCroppedImageUrl(s,d.cropData,function(e){new Promise(function(t){(p=a.ImageUtils.loadTexture3DWhiteboard(e,void 0,function(){t(p)},this.onLoadImageError,"use-credentials",1)).magFilter=a.LinearMipMapLinearFilter,p.minFilter=a.LinearFilter}.bind(this)).then(function(e){if(e){e.cropInfo=d;let n=this.apply2Dtexture(e,h,o,null);if(t.associatedData.hyperlink&&(n.isURL=!0,n.url=t.associatedData.hyperlink),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,this._viewer.render(),r!==S.STATUS_PROCESSING){this._updateHyperlinkNode(n);let o=this._placeHolderMap.get(t.associatedData.uniqueID);this._3DSKTContainer.removeChild(o),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,i(n)}else i({mediaID:t.associatedData.uniqueID,node:n})}}.bind(this))}.bind(this)):new Promise(function(e){(p=a.ImageUtils.loadTexture3DWhiteboard(s,void 0,function(){e(p)},this.onLoadImageError,"use-credentials",1)).magFilter=a.LinearMipMapLinearFilter,p.minFilter=a.LinearFilter}.bind(this)).then(function(e){let n=this.apply2Dtexture(e,h,o,null);if(t.associatedData.hyperlink&&(n.isURL=!0,n.url=t.associatedData.hyperlink),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,this._viewer.render(),r!==S.STATUS_PROCESSING){this._updateHyperlinkNode(n);let o=this._placeHolderMap.get(t.associatedData.uniqueID);this._3DSKTContainer.removeChild(o),n.id=t.associatedData.id,n.name=t.associatedData.id,n._texture=e,i()}else i({mediaID:t.associatedData.uniqueID,node:n})}.bind(this));else if(l===S.TYPE_VIDEO){var m=new a.Vector3(0,0,0);m.getPositionFromMatrix(h);var u=new a.Vector3(m.x-50,m.y+50,m.z),f=new a.Vector3(m.x+50,m.y+50,m.z),g=new a.Vector3(m.x-50,m.y-50,m.z),_=new a.Vector3(m.x+50,m.y-50,m.z),v={bottomLeft:g,bottomRight:_,topLeft:u,topRight:f};new Promise(function(e){this._videoController.setViewSettings({_beforeMainPass:this._beforeMainPass,getBeforeMainPass:function(){return this._beforeMainPass}}),this._videoController.createVideo({videoNode:this._videoModelsNode,urlOrTexture:s,viewer:this._viewer,controlPosition:m,matrix:h,corners:v,renderDepth:o,thumbnailURL:t.thumbnailURL,videoDimension:new a.Vector2(this._viewer.currentViewpoint.project(u).distanceTo(this._viewer.currentViewpoint.project(f)),this._viewer.currentViewpoint.project(u).distanceTo(this._viewer.currentViewpoint.project(g)))}).then(function(t){e(t)})}.bind(this)).then(function(e){p=e.getTexture();let n=this.apply2Dtexture(p,h,o,e,m);if(t.associatedData.hyperlink&&(n.isURL=!0,n.url=t.associatedData.hyperlink),this._viewer.render(),r!==S.STATUS_PROCESSING){this._updateHyperlinkNode(n);let e=this._placeHolderMap.get(t.associatedData.uniqueID);this._3DSKTContainer.removeChild(e),i()}else i({mediaID:t.associatedData.uniqueID,node:n})}.bind(this))}}.bind(this))},drawSketch:function(e){var t=JSON.parse(e);return this._parsedJSON=t,this._3DModelsNode=new s("3DModels"),this._3DSKTContainer.addChild(this._3DModelsNode),this._videoModelsNode=new s("VideoModels"),this._3DSKTContainer.addChild(this._videoModelsNode),new Promise(function(e){if(t.ver){for(var i=(new l).processJSON(t,"expand"),n=i.explodeStates,o=0;o<n.length;o++)if(0===n[o].id)for(var r=n[o].drawPlanes,s=0;s<r.length;s++){var d=r[s],c=d.annotList.filter(function(e){return e.isVisible});if(c.length)for(var h=null,p=0;p<c.length;p++){switch(c[p].type){case"circle":h=this.getListPointFromCircle(c[p],d.drawPlaneInfo.normal);break;case"ellipse":h=this.getListPointFromEllipse(c[p]);break;case"line":h=this.getListPointFromLine(c[p]);break;case"rectangle":h=this.getListPointFromRectangle(c[p]);break;case"triangle":h=this.getListPointFromTriangle(c[p]);break;case"unknownOpen":case"unknownClosed":h=this.getListPointFromUnknown(c[p]);break;case"point":h=[new a.Vector3(c[p].annotStartPoint.x,c[p].annotStartPoint.y,c[p].annotStartPoint.z)];break;default:h=this.getListPointFromUnknown(c[p])}this.draw(h,c[p].type,c[p].graphicalProp,c[p].renderDepth)}}e(i)}else e(t)}.bind(this))},loadMedia:function(t){var i=t.Textboxes;let n=new e.Element("div",{class:"loading-pannel-parent",styles:{width:"100%",position:"absolute",top:"-8px"}}).inject(this._viewerContainer);this._loadingPanel=new E({value:0}).inject(n,"top"),this._loadingPanel.displayStyle="lite",this._loadingPanel.elements.container.setStyle("max-width","none"),this._loadingPanel.elements.container.setStyle("position","relative"),this._loadingPanel.elements.container.firstChild.setStyle("max-width","none"),this._loadingPanel.on();var o=[],r=[],s=0,l=[];if(t.ExternalRef&&t.ExternalRef.media2D&&t.ExternalRef.media2D.length)for(let e=0;e<t.ExternalRef.media2D.length;e++){let i=t.ExternalRef.media2D[e].matrixV2,n=t.ExternalRef.media2D[e].hyperlink;if(!i){let n=JSON.parse(t.ExternalRef.media2D[e].matrix),o=new a.Matrix4;o.setFromArray(n.elements);let r=new a.Vector3,s=new a.Quaternion,l=new a.Vector3;o.decompose(r,s,l),l.x=l.z,l.y=l.z,o.compose(r,s,l),i=JSON.stringify(o)}let r=t.ExternalRef.media2D[e].mediaId,d={uniqueID:s,matrix:i,renderDepth:t.ExternalRef.media2D[e].renderDepth,cropData:t.ExternalRef.media2D[e].cropData,currentStream:t.ExternalRef.media2D[e].currentStream,hyperlink:n,visible:t.ExternalRef.media2D[e].visible,id:t.ExternalRef.media2D[e].id},c={url:this._placeholderUrl,type:S.TYPE_IMAGE,status:S.STATUS_PROCESSING,associatedData:d};o.push({mediaId:r,associatedData:d}),l.push(this.load2DModel(c).then(e=>{this._placeHolderMap.set(e.mediaID,e.node)})),s+=1}if(t.ExternalRef&&t.ExternalRef.media3D&&t.ExternalRef.media3D.length)for(let e=0;e<t.ExternalRef.media3D.length;e++){let i=t.ExternalRef.media3D[e].hyperlink;if("RepresentationlImage"===t.ExternalRef.media3D[e].viewType){let n={uniqueID:s,id:t.ExternalRef.media3D[e].id,viewType:"RepresentationlImage",matrix:t.ExternalRef.media3D[e].matrix,renderDepth:t.ExternalRef.media3D[e].renderDepth,hyperlink:i},r={uniqueID:s,url:this._placeholderUrl,type:S.TYPE_IMAGE,status:S.STATUS_PROCESSING,associatedData:n};o.push({mediaId:t.ExternalRef.media3D[e].mediaIdImage,associatedData:n}),l.push(this.load2DModel(r).then(e=>{this._placeHolderMap.set(e.mediaID,e.node)})),s+=1}else o.push({mediaId:t.ExternalRef.media3D[e].mediaId,associatedData:{matrix:t.ExternalRef.media3D[e].matrix,hyperlink:i}})}if(i&&i.length>0)for(var d=0;d<i.length;d++)r.push(this.loadText(i[d]));if(t.links&&t.links.length){this._linksMedia=new Map;for(let e=0;e<t.links.length;e++){let i,n;if(t.links[e].smallViewThumbnailSubject6wuri&&"small"===t.links[e].linkData.view_type?(n=this._placeholderSmallView,i=t.links[e].smallViewThumbnailSubject6wuri,o.push({mediaId:i,associatedData:{linkid:t.links[e].id,islink:!0,uniqueID:s}})):t.links[e].fullViewSubject6wuri&&"full"===t.links[e].linkData.view_type&&(n=this._placeholderUrl,i=t.links[e].fullViewSubject6wuri,o.push({mediaId:i,associatedData:{linkid:t.links[e].id,islink:!0,uniqueID:s}})),t.links[e].fullViewSubject6wuri||t.links[e].smallViewThumbnailSubject6wuri){let o={id:i,uniqueID:s,viewType:"RepresentationlImage",matrix:t.links[e].matrix,renderDepth:t.links[e].renderDepth},r={uniqueID:s,url:n,type:S.TYPE_IMAGE,status:S.STATUS_PROCESSING,associatedData:o};l.push(this.load2DModel(r).then(e=>{this._placeHolderMap.set(e.mediaID,e.node)})),s+=1}}}if(!o.length)return Promise.all(r).finally(()=>{this.loadLinks(t),this._viewer.render()}),t;var c="",h=0,p=0;let m=function(){return this._swymMediaServices.getMedias(o,function(e){this._loadingPanel.value=e}.bind(this),function(e){g.initialize();var t=null;e.status===S.STATUS_PROCESSING&&e.type&&(c+=e.title+" ",p++),e.status===S.STATUS_KO&&e.type&&h++,!0!==e.associatedData.islink?e.format===S.FORMAT_2D||e.status===S.STATUS_PROCESSING?r.push(this.load2DModel(e)):e.format===S.FORMAT_3D&&(t=JSON.parse(e.associatedData.matrix),r.push(this.load3DModel(e.extension,e.url,t.elements))):this._linksMedia.set(e.associatedData.linkid,e)}.bind(this)).catch(e=>{e&&console.log(e)}).then(async function(){return g.initialize(),await Promise.all(r).then(()=>{p&&g.setGeneralErrorMessage(p+" media not yet processed. Try reloading when all medias are processed","",c,"warning"),p&&g.setGeneralErrorMessage(p+" media not yet processed. Try reloading when all medias are processed","",c,"warning"),h&&g.setGeneralErrorMessage(h+" media not available. Check your access rights","","","warning"),h&&g.setGeneralErrorMessage(h+" media not available. Check your access rights","","","warning")}),this.loadLinks(t),this.loadComparisons(t),this._loadingPanel.off(),t}.bind(this)).catch(e=>{e&&console.log(e)})}.bind(this);return"3dstory"!==this._appname?(m(),t):m()},loadText:function(e){return new Promise(t=>{let i=null;if(e.matrix){i=new a.Matrix4;let t=JSON.parse(e.matrix);i.setFromArray(t.elements)}var n,o;o="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,n=new s(o),this._3DSKTContainer.addChild(n);var r=this.makeNode(i,n,5*e.renderDepth,e.worldDimensions.width,e.worldDimensions.height);if(e.hyperlink){var l=r.getMatrixWorld(),d=r.mesh3js.geometry[0].vertexPositionArray;r.topRight=new a.Vector3(d[9],d[10],d[11]).applyMatrix4(l),r.topLeft=new a.Vector3(d[6],d[7],d[8]).applyMatrix4(l),r.bottomRight=new a.Vector3(d[0],d[1],d[2]).applyMatrix4(l),r.isURL=!0,r.url=e.hyperlink}this._redrawText(r,e),this._updateHyperlinkNode(r,n),t()})},drawConnections:function(e){return new Promise(function(t){var i=e.connections;i&&0!==i.length||t(e);var n=[];if(e.explodeStates[0].drawPlanes[0]&&(n=e.explodeStates[0].drawPlanes[0].annotList),e.ExternalRef){var o=e.ExternalRef.media2D;o&&o.forEach(e=>n.push(e));var r=e.ExternalRef.media3D;r&&r.forEach(e=>n.push(e))}var s=e.Textboxes;s&&s.forEach(e=>n.push(e));var l=e.links;l&&l.forEach(e=>n.push(e));var d=e.stickers;d&&d.forEach(e=>n.push(e));for(var c=function(e){for(var t=0;t<n.length;t++)if(n[t].id===e)return n[t]},h=0;h<i.length;h++){var p=c(i[h].connectionPointA.pointedObjectID),m=c(i[h].connectionPointB.pointedObjectID);if(!p||!m)continue;const e=i[h].settings,t=i[h].coordinatesPointA,n=i[h].coordinatesPointB,o=new a.Vector2(t.x,t.y),r=new a.Vector2(n.x,n.y),s=i[h].currentViewPortA,l=i[h].currentViewPortB,d=i[h].arrowSizeA,g=i[h].arrowSizeB;if(!(o&&r&&s&&l&&d&&g))continue;let _=[],v=null;if("spline"===e.connectorType){const t=Math.max(d,g),n=i[h].pointANormal,s=i[h].pointBNormal,l=new a.Vector2(n.x,n.y),c=new a.Vector2(s.x,s.y);if(!l||!c)return;var u,f=[];if(i[h].controlPoint)u=new a.Vector2(i[h].controlPoint.x,i[h].controlPoint.y);else{const i=V.GetControlPoint(o,l,r,t),n=V.GetControlPoint(r,c,o,t);u=new a.Vector2((i.x+n.x)/2,(n.y+i.y)/2),"unidirectional"!==e.arrowDirection&&"bidirectional"!==e.arrowDirection||_.push(V.ComputeArrowPoint(r,c,g)),"bidirectional"===e.arrowDirection&&_.push(V.ComputeArrowPoint(o,l,d))}if(!u)continue;f.push(o),f.push(u),f.push(r),v=V.ComputeBezierCurve(f,.01,l,c,t)}else v=V.ComputeLine([o,r]),"unidirectional"!==e.arrowDirection&&"bidirectional"!==e.arrowDirection||_.push(V.ComputeArrowPoint(r,(new a.Vector2).subVectors(o,r).normalize(),g)),"bidirectional"===e.arrowDirection&&_.push(V.ComputeArrowPoint(o,(new a.Vector2).subVectors(r,o).normalize(),d));const w={color:e.color?e.color:"#dcdcc8",opacity:e.opacity?e.opacity:1,thickness:e.thickness?e.thickness:2,lineType:e.lineType?e.lineType:"solid"},D=V.CreateLineNode(v,w);this._connectionContainer.addChild(D),_.forEach(e=>{const t=[];t.push(e[0]),t.push(e[1]);const i=[];i.push(e[2]),i.push(e[3]),w.lineType="solid";const n=V.CreateLineNode(t,w),o=V.CreateLineNode(i,w);this._connectionContainer.addChild(n),this._connectionContainer.addChild(o)})}t(e)}.bind(this))},_redrawText:async function(e,t){let i=1.5;(N.Platform.ios||N.Platform.ipad||N.Platform.android)&&(i=3.5);let n=100*(t.inputDimensions.height/30);if(t.inputDimensions.height>t.inputDimensions.width){let e=Math.floor(Math.sqrt(R.MPLimit/i));n>e&&(n=e)}else{let e=Math.floor(Math.sqrt(R.MPLimit/i))*t.inputDimensions.height/t.inputDimensions.width;n>e&&(n=e)}var o=n/t.inputDimensions.height;let r=null;if(t.stickyNote){let e=W.hexToRgb(t.backgroundColor),i=105,n=105,o=105,a=.25;r="rgb("+(e.r+(i-e.r)*a)+","+(e.g+(n-e.g)*a)+","+(e.b+(o-e.b)*a)+")"}var s=await this._textRenderService.renderTextToCanvas({width:t.inputDimensions.width,height:t.inputDimensions.height,text:t.text,lineHeight:t.lineHeight,fontSize:t.fontSize,padding:t.stickyNote?T.defaultTextWithBackgroundColorPadding:T.defaultTextPadding,color:t.color,borderColor:r,backgroundColor:t.backgroundColor,scale:o,fontStyle:t.fontStyle,fontWeight:t.fontWeight,textAlign:t.textAlign,fontFamily:t.fontFamily});e.currenttexture&&e.currenttexture.dispose();var l=a.ImageUtils.createTexture3DWhiteboard(s,!0);l.magFilter=a.LinearMipMapLinearFilter,l.minFilter=a.LinearFilter;var d=new a.MeshBasicMaterial({map:l,force:!0,side:a.DoubleSide});d.transparent=!0,d.color=new a.Color;var c=new p({faceMaterial:d});e.setMaterialApplication(c),e.currenttexture=l,this._viewer.render()},makeNode:function(e,t,i,o=100,r=100){let s=e.getScaleOnAxisZ(),l=o/s,d=r/s;var c=n.createRectangleNode({width:-l,height:-d,fill:!0,color:new D.Color(255,255,255,0)});return c.setMatrix((new a.Matrix4).setPosition(new a.Vector3(l/2,d/2,0))),null!=i&&c.setRenderDepth(i),t.addChild(c),t.setMatrix(e),c},setTextureFromCanvas:function(e,t){t.currenttexture&&t.currenttexture.dispose();var i=new a.Texture(e,void 0,a.ClampToEdgeWrapping,a.ClampToEdgeWrapping,a.LinearFilter,a.LinearMipMapLinearFilter);i.anisotropy=16,i.needsUpdate=!0;var n=new a.MeshBasicMaterial({map:i,force:!0,side:a.DoubleSide});n.transparent=!0,n.color=new a.Color;var o=new p({faceMaterial:n});t.setMaterialApplication(o),t.currenttexture=i,this._viewer.render()},loadTextboxFont:function(e){return new Promise(function(t){this._textRenderService.loadTextboxFont().then(function(){t(e)})}.bind(this))},loadStickersFont:function(t){return new Promise(function(i){var n=C.getWebappsAssetUrl("UIKIT","fonts/3ds-icon.woff2"),o=null;if(M.getPreferenceValue("M3DEMobile")){var r=e.Data.proxifyUrl(n,{proxy:"passport"});o=new FontFace("Entypo","url("+r+') format("woff2")')}else o=new FontFace("Entypo","url("+n+') format("woff2")');o.load().then(function(){document.fonts.add(o),i(t)})})},loadLinks:function(t){return new Promise(async function(i){var n=t.links;if(!n.length)return void i(t);let o=new y;for(let t=0;t<n.length;t++){let i;if("small"===n[t].linkData.view_type){let r=this._linksMedia.get(n[t].id),a=null;r&&(a=o.generateUrlWithSuffix(r.previewurl),this._isMobileApp&&r.previewurl&&(a=e.Data.proxifyUrl(r.previewurl,{proxy:"passport"})),i=r.associatedData.uniqueID),!a&&n[t].smallViewThumbnailUrl&&(a=n[t].smallViewThumbnailUrl);let s=await this._getSmallViewCanvas(n[t],a);if(this._createLinkNode({canvas:s,matrix:n[t].matrix,renderDepth:5*n[t].renderDepth,id:n[t].id,url:n[t].url}),void 0!==i){let e=this._placeHolderMap.get(i);this._3DSKTContainer.removeChild(e)}}else if("full"===n[t].linkData.view_type){let r=this._linksMedia.get(n[t].id);if(r){if(i=r.associatedData.uniqueID,r){let i=o.generateUrlWithSuffix(r.url);this._isMobileApp&&(i=e.Data.proxifyUrl(i,{proxy:"passport"}));let a=await this._getCanvasFromImageUrl(i);this._createLinkNode({canvas:a,matrix:n[t].matrix,renderDepth:5*n[t].renderDepth,id:n[t].id,url:n[t].url})}let a=this._placeHolderMap.get(i);this._3DSKTContainer.removeChild(a)}}}i(t)}.bind(this))},_getCanvasFromImageUrl:function(e){return new Promise(function(t){var i=new Image;i.onload=function(){var e=this._canvasServices.createCanvas({width:i.width,height:i.height,tag:"linkFullViewCanvas"});e.getContext("2d").drawImage(i,0,0,i.width,i.height),t(e)}.bind(this),i.crossOrigin="use-credentials",i.src=e}.bind(this))},_createLinkNode:function(e){var t=new s("linkNode-"+e.id);this._3DSKTContainer.addChild(t);let i=JSON.parse(e.matrix),o=new a.Matrix4;o.setFromArray(i.elements);var r=e.canvas.height*(100/e.canvas.width),l=n.createRectangleNode({width:-100,height:-r,fill:!0,color:new D.Color(255,255,255,0)});l.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,r/2,0))),void 0!==e.renderDepth&&null!==e.renderDepth&&l.setRenderDepth(e.renderDepth),t.addChild(l),t.setMatrix(o);var d=l.mesh3js.geometry[0].vertexPositionArray;l.topLeft=new a.Vector3(d[9]-50,d[10]+r/2,d[11]).applyMatrix4(o),l.topRight=new a.Vector3(d[6]-50,d[7]+r/2,d[8]).applyMatrix4(o),l.isURL=!0,l.url=e.url,this.setTextureFromCanvas(e.canvas,l),this._updateHyperlinkNode(l,t)},_getSmallViewCanvas:function(e,t){return new Promise(function(i){let n={};if(n.type=e.linkData.content_type,n.linktype=e.linkData.type,n.title=e.linkData.title,n.description=e.linkData.description,n.thumbnail=t,e.linkData.type===b.LINK_EXTERNAL)n.url=e.linkData.hostname?e.linkData.hostname:e.url;else if(e.linkData.type===b.LINK_INTERNAL){var o=e.url,r=new URL(o);n.hash=r.hash,n.url=o,n.author=e.linkData.author,n.community=e.linkData.community,n.mediaType=e.linkData.mediaType,n.swymv3=!0}new k(n).getCanvas().then(function(e){i(e)})})},loadComparisons:function(e){return new Promise(async function(t){let i=e.comparisons;i&&i.length>0&&i.forEach(e=>{this.makeComparisonNode(e),this._2dMediaCounter++}),t(e)}.bind(this))},makeComparisonNode:function(e){let t;this._defaultRectangleValue=100,this._defaultImage1=C.getWebappsAssetUrl("CAT3DWInfra","placeholders/Image_Thumbnail.png"),this._defaultImage2=C.getWebappsAssetUrl("CAT3DWInfra","placeholders/Image_Thumbnail-Greyscale.png");let i=new a.Matrix4,o=JSON.parse(e.matrix);i.setFromArray(o.elements);let r=this._defaultImage1,s=this._defaultImage2;if(e.comparisonInfo.img1&&e.comparisonInfo.img1.id){let t=this._3DSKTContainer.getChildByName(e.comparisonInfo.img1.id);t&&(t.setVisibility(!1),r=t._texture.sourceFile)}if(e.comparisonInfo.img2&&e.comparisonInfo.img2.id){let t=this._3DSKTContainer.getChildByName(e.comparisonInfo.img2.id);t&&(t.setVisibility(!1),s=t._texture.sourceFile)}this._viewer.render();let l=function(e){if(e&&e.mesh3js){let t=e.mesh3js.geometry[0].vertexPositionArray;return{bottomLeft:new a.Vector3(t[0],t[1],t[2]),bottomRight:new a.Vector3(t[3],t[4],t[5]),topLeft:new a.Vector3(t[9],t[10],t[11]),topRight:new a.Vector3(t[6],t[7],t[8])}}},d=function(i,n){if("Slider (vertical)"===e.comparisonType||"Slider (horizontal)"===e.comparisonType){let e=l(i),o=l(t.rectangle),r=e.topLeft.distanceTo(e.topRight)/o.topLeft.distanceTo(o.topRight),a=e.topLeft.distanceTo(e.bottomLeft)/o.topLeft.distanceTo(o.bottomLeft),s=new Image;s.onload=function(){let e={top:0,left:0,width:s.width*r,height:s.height*a};i===t.img2&&(e={top:s.height-s.height*a,left:s.width-s.width*r,width:s.width*r,height:s.height*a}),this._canvasServices._getCroppedImageUrlFromActualImage(s,e,function(e){c(i,e)})}.bind(this),s.crossOrigin="use-credentials",s.src=n}else c(i,n)}.bind(this),c=function(t,i){let n=function(i){let n=t.getMaterial("Line")?t.getMaterial("Line"):new a.LineBasicMaterial({opacity:0});t.removeMaterialApplication();let o=new p({faceMaterial:(r=i,s=!0,l=new a.MeshBasicMaterial({map:r,force:!0,side:a.DoubleSide}),l.transparent=s,l.color=new a.Color,l.polygonOffset=!0,l.polygonOffsetFactor=.7,l),lineMaterial:n});var r,s,l;t.setMaterialApplication(o),t.setRenderDepth(5*e.renderDepth),this._viewer.render()}.bind(this),o=M.getPreferenceValue("UseCredentials")||!1;a.ImageUtils.loadTexture3DWhiteboard(i,void 0,n,function(e){console.log(e)},o,!0)}.bind(this),h=function(e,t,i){e&&e.cropDataForAspectRatio?this._canvasServices.getCroppedImageUrl(t,e.cropDataForAspectRatio,function(t){e.cropDataAfterEdit?this._canvasServices.getCroppedImageUrl(t,e.cropDataAfterEdit,function(e){i(e)}):i(t)}.bind(this)):e&&e.cropDataAfterEdit?this._canvasServices.getCroppedImageUrl(t,e.cropDataAfterEdit,function(e){i(e)}):i(t)}.bind(this),m=function(t){let o=n.createRectangleNode({width:-t._rectangle._3dWidth,height:-t._rectangle._3dHeight,fill:!0,cornerPoint:new a.Vector2(t._rectangle._3dXpos,t._rectangle._3dYpos),noEdge:!0,color:new D.Color(255,255,255,0)});o.name=e.id+"-images-container";let r=n.createRectangleNode({width:-t._image1._3dWidth,height:-t._image1._3dHeight,fill:!0,cornerPoint:new a.Vector2(t._image1._3dXpos,t._image1._3dYpos),noEdge:!0,color:new D.Color(255,255,255,0)});r.name=e.id+"-image-1",o.addChild(r);let s=n.createRectangleNode({width:-t._image2._3dWidth,height:-t._image2._3dHeight,fill:!0,cornerPoint:new a.Vector2(t._image2._3dXpos,t._image2._3dYpos),noEdge:!0,color:new D.Color(255,255,255,0)});return s.name=e.id+"-image-2",o.addChild(s),this._3DSKTContainer.addChild(o),o.setMatrix(i),o.setRenderDepth(5*e.renderDepth),{rectangle:o,img1:r,img2:s}}.bind(this),u=function(t,i){let n,o,r,a,s,l=t/i,d=0,c=0;switch(l>=1?(d=l*this._defaultRectangleValue,c=this._defaultRectangleValue):(d=this._defaultRectangleValue,c=this._defaultRectangleValue/l),e.comparisonType){case"Slider (vertical)":o=e.comparisonInfo&&e.comparisonInfo.img1&&e.comparisonInfo.img1.wRatio?d*f.img1.wRatio:.5*d,r=e.comparisonInfo&&e.comparisonInfo.img2&&e.comparisonInfo.img2.wRatio?d*f.img2.wRatio:.5*d,n=m({_rectangle:{_3dWidth:d,_3dHeight:c,_3dXpos:.5*d,_3dYpos:.5*c},_image1:{_3dWidth:o,_3dHeight:c,_3dXpos:.5*d,_3dYpos:.5*c},_image2:{_3dWidth:r,_3dHeight:c,_3dXpos:.5*d-o,_3dYpos:.5*c}});break;case"Slider (horizontal)":a=e.comparisonInfo&&e.comparisonInfo.img1&&e.comparisonInfo.img1.hRatio?c*f.img1.hRatio:.5*c,s=e.comparisonInfo&&e.comparisonInfo.img2&&e.comparisonInfo.img2.hRatio?c*f.img2.hRatio:.5*c,n=m({_rectangle:{_3dWidth:d,_3dHeight:c,_3dXpos:.5*d,_3dYpos:.5*c},_image1:{_3dWidth:d,_3dHeight:a,_3dXpos:.5*d,_3dYpos:a-.5*c},_image2:{_3dWidth:d,_3dHeight:s,_3dXpos:.5*d,_3dYpos:.5*c}});break;case"Side by Side (vertical)":n=m({_rectangle:{_3dWidth:d,_3dHeight:2*c,_3dXpos:.5*d,_3dYpos:c},_image1:{_3dWidth:d,_3dHeight:c,_3dXpos:.5*d,_3dYpos:0},_image2:{_3dWidth:d,_3dHeight:c,_3dXpos:.5*d,_3dYpos:c}});break;case"Side by Side (horizontal)":n=m({_rectangle:{_3dWidth:2*d,_3dHeight:c,_3dXpos:d,_3dYpos:.5*c},_image1:{_3dWidth:d,_3dHeight:c,_3dXpos:d,_3dYpos:.5*c},_image2:{_3dWidth:d,_3dHeight:c,_3dXpos:0,_3dYpos:.5*c}});break;default:console.error("Invalid comparison type")}return n}.bind(this),f=e.comparisonInfo;if(f.img1){let i=f.img1;if(i.cropDataAfterEdit)t=u(i.cropDataAfterEdit.width,i.cropDataAfterEdit.height),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)});else if(i.cropDataForAspectRatio)t=u(i.cropDataForAspectRatio.width,i.cropDataForAspectRatio.height),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)});else if(i.id){let i=new Image;i.onload=function(){t=u(i.width,i.height),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)})},i.src=r}}else if(f.img2){let i=f.img2;if(i.cropDataAfterEdit)t=u(i.cropDataAfterEdit.width,i.cropDataAfterEdit.height),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)});else if(i.cropDataForAspectRatio)t=u(i.cropDataForAspectRatio.width,i.cropDataForAspectRatio.height),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)});else if(i.id){let i=new Image;i.onload=function(){t=u(i.width,i.height),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)})},i.src=r._texture.sourceFile}}else t=u(this._defaultRectangleValue,this._defaultRectangleValue),h(e.comparisonInfo.img1,r,function(e){d(t.img1,e)}),h(e.comparisonInfo.img2,s,function(e){d(t.img2,e)})},loadStickers:function(e){return new Promise(async function(t){var i=e.stickers;!i||i.length?(i.forEach(e=>{let t=null;if(e.matrix){t=new a.Matrix4;let i=JSON.parse(e.matrix);t.setFromArray(i.elements)}var i=this.makeStickerNode({matrix:t,renderDepth:5*e.renderDepth,id:e.id});this._2dMediaCounter++,this._drawSticker(i,e)}),t(e)):t(e)}.bind(this))},makeStickerNode:function(e){var t=new s("sticker2DNode_"+e.id);this._3DSKTContainer.addChild(t);var i=n.createRectangleNode({width:-100,height:-100,fill:!0,color:new D.Color(255,255,255,0)});return i.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0))),void 0!==e.renderDepth&&null!==e.renderDepth&&i.setRenderDepth(e.renderDepth),t.addChild(i),t.setMatrix(e.matrix),i},_drawSticker:function(e,t){var i=t.value,n=this._canvasServices.createCanvas({width:1e3,height:1e3,tag:"stickerCanvas"});const o=n.width/2,r=n.height/2;var s=n.getContext("2d");s.textBaseline="middle",s.textAlign="center",s.fillStyle="#005685",s.font="700px Entypo",s.fillText(i,o,r,1e3),e.currenttexture&&e.currenttexture.dispose();var l=a.ImageUtils.createTexture3DWhiteboard(n,!0);l.magFilter=a.LinearFilter,l.minFilter=a.LinearMipMapLinearFilter;var d=new a.MeshBasicMaterial({map:l,force:!0,side:a.DoubleSide});d.transparent=!0,d.color=new a.Color;var c=new p({faceMaterial:d});e.setMaterialApplication(c),e.currenttexture=l,this._viewer.render()},_updateHyperlinkNode:function(e,t=null){var i=e.getChildren(),n=null;if(e.isURL){for(var o=0;o<i.length;o++)"CAT3DWNode3DHyperlink"===i[o].getName()&&(n=i[o]);if(null===n){var a={topLeft:e.topRight,topRight:e.topLeft};if(t){var s=new r(a,t.getMatrixWorld(),0);s.url=e.url,t.addChild(s)}else{var l=new r(a,e.getMatrixWorld(),0);l.url=e.url,e.addChild(l)}}}else{i=e.getChildren();for(var d=0;d<i.length;d++)"CAT3DWNode3DHyperlink"===i[d].getName()&&(i[d].deleteNode(),e.removeChild(i[d]))}},load:function(i,n,o,r){this._3DSKTContainer=new s("3DSKTContainer"),this._annotContainer=new s("annotContainer"),this._annotContainer.setPickable(D.PICKTHROUGH),this._3DSKTContainer.addChild(this._annotContainer),this._connectionContainer=new s("connectionContainer"),this._3DSKTContainer.addChild(this._connectionContainer),this._3DSKTContainer.setVisibility(!1),this._viewerContainer=i.viewer.div,this._viewer=i.viewer,this._viewer.renderer&&this._viewer.renderer.renderer&&(this._viewer.renderer.renderer._useRenderDepthDL=!0),this._maskContainer=e.createElement("div",{styles:{opacity:.7,pointerEvents:"none",position:"absolute",top:"0",width:"100%",height:"100%",zIndex:10,display:"none"}}).inject(this._viewerContainer),this._mask=e.createElement("div",{styles:{position:"absolute",top:"0",width:"100%",height:"100%"}}).inject(this._maskContainer),v.mask(this._mask,"Loading");var l={};if(i.requestsOptions&&i.requestsOptions.serverurl)l.platformUrl=i.requestsOptions.serverurl,l.originUrl=i.requestsOptions.hostname;else{l.platformId=w.getTenant();try{!l.platformId&&parent.ds&&parent.ds.swymTenant&&(l.platformId=parent.ds.swymTenant)}catch(e){}}l&&l.platformId&&M.setPreferenceValue("swymTenant",l.platformId),i.requestsOptions&&i.requestsOptions.appname&&(this._appname=i.requestsOptions.appname,document.body.classList.add("story")),"3dstory"!==this._appname&&(this._maskContainer.style.display="block"),this._canvasServices=new I,this._swymMediaServices=new x(l),this._DataModelConverter=new A({version:"5.0",webapp:A.APP_3DWHITEBOARD,platformId:M.getPreferenceValue("swymTenant"),platformUrl:l.platformUrl,originUrl:l.originUrl,appName:this._appname,viewer:this._viewer,viewpoint:this._viewer.currentViewpoint});var d=this._viewer.getUserPassManager();this._beforeMainPass=new t("BeforeMain");var c=d.createUserClearPass("userClearPass",this._beforeMainPass);c.setClearDepth(!0);var p=d.createUserRenderPass("userRenderPass",this._beforeMainPass),m=d.getSystemPass("main");d.insertUserPassBeforePass(c,m),d.insertUserPassBeforePass(p,c),this.readJsonFile(i.filename).then(this.unzip.bind(this)).then(this._convertJSON.bind(this)).then(this.drawSketch.bind(this)).then(this.loadTextboxFont.bind(this)).then(this.loadStickersFont.bind(this)).then(this.loadMedia.bind(this)).then(this.loadStickers.bind(this)).then(this.drawConnections.bind(this)).then(e=>{v.unmask(this._mask),this._3DSKTContainer.setVisibility(!0),n(this._3DSKTContainer),r(this._3DSKTContainer);const t=this._viewer.currentViewpoint;e.viewpoint&&"3dstory"!==this._appname?t.moveTo({eyePosition:(new a.Vector3).copy(e.viewpoint.position),orientation:(new a.Quaternion).copy(e.viewpoint.quaternion),distanceToTarget:e.viewpoint.targetDistance,duration:0}):t.reframe(null,0),this._onMove(),this._viewer.render(),this._viewerContainer.removeChild(this._maskContainer),this._mask=null,this._maskContainer=null,h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_LoadVisu",eventLabel:"Load visu of sketch in other apps",appID:"X3DWHTB_AP"})}).catch(this._error)},_error:function(e){console.error(e)}})});