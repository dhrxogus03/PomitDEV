/*!  Copyright 2019 Dassault Systemes. All rights reserved. */
define("DS/CATWebUXTIC/CATWebUXTICCmdAdapt",["DS/CATWebUXComponents/DMUCommand","DS/PlatformAPI/PlatformAPI"],function(e,t){"use strict";var n,s,i,a,o,r,c,u,l,d,p,m;function C(e){if(c)u.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},u.getTenant=function(){return require("DS/PADUtils/PADUtilsServices").getPlatformId()},e();else{require(["DS/IssueManagementWebInWin/ENOIssueGenerationWebPanel","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueManagementWebInWin/ENOIssueFromTemplateGenerationWebPanel"],function(t,n,s,i,a){r=t,m=a,u=s,l=i,(c=n).add("widget",window.widget),u.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},u.getTenant=function(){return require("DS/PADUtils/PADUtilsServices").getPlatformId()},u.initPlatformServices().then(function(){e()})})}}return require(["i18n!DS/CATWebUXTIC/assets/nls/CATWebUXTICCmdAdapt"],function(e){n=e.caOK,s=e.caKO,i=e.caAttached,a=e.caNotAttached}),e.extend({init:function(e){var c,u=this,g=null,f=null,D=e.pad3DViewer;function I(e){!function e(t){o?(!d.setTenant&&window.enoviaServerCAWidget&&(window.enoviaServerCAWidget.tenant=require("DS/PADUtils/PADUtilsServices").getPlatformId()),t()):require(["DS/WAFData/WAFData","DS/ENOChgActionCMDs/scripts/CAActionBarController","DS/ENOChangeActionUX/scripts/CreateCAForm"],function(n,s,i){o=n,d=s,p=i,e(t)})}(function(){if(e.status&&"ticCancel"===e.status&&u.cancel(),u.isRunning()){var t=e.fromIssue;delete e.fromIssue,d.clearObjects(),d.addTitle(e.title),d.addDescription(e.description),d.addContext(e.contexts),d.addReferential(e.attachments),d.addSeverity&&d.addSeverity(e.priority),d.setTenant&&d.setTenant(require("DS/PADUtils/PADUtilsServices").getPlatformId()),d.setSecurityContext&&d.setSecurityContext(require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")),new Promise(function(n){t?C(function(){l.issues.retrieve({data:{objects:[{physicalId:t}]}}).then(function(e){n(),(e=e.results)&&1===e.length&&e[0]&&e[0].body&&(d.addProposed((e[0].body.reportedAgainst||[]).map(function(e){return e.physicalId})),d.addFollower([e[0].body.owner.user]),d.addAssignee((e[0].body.assignees||[]).map(function(e){return e.user})))})}):(d.addProposed(e.reportedAgainst),e.assignees&&d.addAssignee(e.assignees),n())}).then(function(){p.createCAFromActionBar(d.getJSON(),c,r).then(function(){(f=p.CACreateModal).elements.content.parentElement.parentElement.setStyle("z-index","1000000"),f.options.escapeToClose=!1})})}function r(){e.onCancel&&e.onCancel(),u.cancel()}function c(r){if(D.displayNotification({msg:r.changeaction?n:s,eventID:r.changeaction?"success":"error"}),r.changeaction){var c=r.changeaction.id.replace("pid:",""),d=e.title,p=r.changeaction.attributes;if(p&&p.length)for(let e=0;e<p.length;e++)"attribute_Synopsis"===p[e].name&&(d=p[e].value);e.onComplete&&e.onComplete({attachmentIDs:e.attachments,title:d,ticID:c}),new Promise(function(n){if(t)n([t]);else{var s=require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/navigate",i=require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx"),a="&tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId();o.authenticatedRequest(s+"?SecurityContext="+i+a,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:i},data:JSON.stringify({input_physical_ids:e.attachments,label:"ParentIssue"+Date.now(),primitives:[{navigate_from_rel:{id:1,filter:{bo_type:["Issue"]}}}],patterns:{issue:[{id:1}]},fileAttributes:[],attributes:[],version:3}),onComplete:function(e){var t=e?JSON.parse(e):null;if(t&&t.result&&t.result.length){var s=[];t.result.forEach(function(e){if(e.outputs&&e.outputs.issue&&1===e.outputs.issue.length){var t=e.outputs.issue[0].physicalid;-1===s.indexOf(t)&&s.push(t)}}),n(s)}else n()},onFailure:n,onTimeout:n})}}).then(function(e){e&&0!==e.length&&C(function(){l.related.update({data:{objects:e.map(function(e){return{physicalId:e,resolvedBy:[{physicalId:c}]}})},onComplete:function(){D.displayNotification({msg:i,eventID:"success"})},onFailure:function(){D.displayNotification({msg:a,eventID:"error"})}})})})}u.cancel()}})}this.options=e,e.executionContext?"PIMWebUXGenerateIssueHdr"===e.ID?c="Issue":"PIMWebUXGenerateIssueTemplateHdr"===e.ID?c="IssueTemplate":"PIMWebUXGenerateCAHdr"===e.ID?c="CA":"CATWebUXGenerateIssueHdr"===e.ID?c="Issue":"CATWebUXGenerateIssueTemplateHdr"===e.ID?c="IssueTemplate":"CATWebUXGenerateCAHdr"===e.ID&&(c="CA"):"CATWebUXGenerateIssueHdr"===e.ID?c="Issue":"CATWebUXGenerateIssueTemplateHdr"===e.ID?c="IssueTemplate":"CATWebUXGenerateCAHdr"===e.ID&&(c="CA"),delete e.pad3DViewer,e.mode="exclusive",e.isAsynchronous=!0,this._parent(e),this.getParameters=function(e){e.onFailure("Must be implemented by children")},this.beginExecute=function(){u.getParameters({cmdType:c,onComplete:function(e){var n;"Issue"===c?(require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("command","GenerateIssue")}),n=e,C(function(){if(n.assignees=void 0,delete n.fromIssue,n.status&&"ticCancel"===n.status&&u.cancel(),u.isRunning()){var e=document.getElementsByClassName("wux-windows-modalDialog");e.length&&e[0].setStyles({display:"none"});const t=[],s=n.reportedAgainst.filter(e=>!t.includes(e.physicalId)&&(t.push(e.physicalId),!0));n.reportedAgainst=s,g=new r({data:n,htmlContainer:window.widget.body,onClose:()=>{n.onClose&&n.onClose(),u.cancel()}})}})):"IssueTemplate"===c?(require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("command","GenerateIssueTemplate")}),function(e){C(function(){if(e.assignees=void 0,delete e.fromIssue,e.status&&"ticCancel"===e.status&&u.cancel(),u.isRunning()){var t=document.getElementsByClassName("wux-windows-modalDialog");t.length&&t[0].setStyles({display:"none"}),g=new m({data:e,htmlContainer:window.widget.body,onClose:()=>{e.onCancel&&e.onCancel(),u.cancel()}})}})}(e)):(require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("command","GenerateCA")}),I(e)),u.platFormIssueSubscription=t.subscribe("DS/Object/create",function(t){e.onComplete&&e.onComplete({attachmentIDs:e.attachments,name:e.title,ticID:t.data.paths[0][0],type:"Issue"})})},onCancel:function(e){e&&e.onCancel&&e.onCancel(),u.cancel.bind(u)},onFailure:function(e){window.console.error(e),u.done()}})},this.pauseExecute=function(){this.cancel()},this.cancelExecute=function(){g&&(g.destroy(),g=null),f&&f.hide(),u.platFormIssueSubscription&&t.unsubscribe(u.platFormIssueSubscription);var e=document.getElementsByClassName("wux-windows-modalDialog");e.length&&e[0].destroy(),this.done()},this._destroy=function(){u=D=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)},this.onClose=function(){g=null,this.cancel()},this.disable&&!this.options.executionContext&&this.disable()}})});