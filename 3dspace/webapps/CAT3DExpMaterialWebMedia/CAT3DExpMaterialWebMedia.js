define("DS/CAT3DExpMaterialWebMedia/extensions/CATE3DXMaterialAssetMedia",["UWA/Core","DS/CAT3DExpMaterialWeb/extensions/CATE3DXMaterialAsset","DS/VisuLoaders/ThreeDXLoader","DS/Visualization/Node3D","DS/CAT3DExpModel/XCTExpUint8ArrayAsset","DS/CAT3DExpModel/XCTExpMaterialLibraryAsset","DS/CATCXPModel/interfaces/CATI3DXAssetProperties"],function(e,a,t,i,r,s,n){"use strict";return a.extend({_getMaterialFromAsset:async function(a){return this.QueryInterface("CATI3DXAssetProperties").getAssetStatus()===n.AssetStatus.StatusBroken?e.Promise.reject(new Error("Material asset status is broken "+this.GetObject().GetID())):a instanceof s?this._getMaterialFromMaterialLibraryAsset(a):a instanceof r?this._getMaterialFromUint8ArrayAsset(a):e.Promise.reject(new Error("Cant retrieve material asset for object "+this.GetObject().GetID()))},_getMaterialFromMaterialLibraryAsset:function(e){return e.getMaterial()},_getMaterialFromUint8ArrayAsset:function(a){const r=e.Promise.deferred(),s=e.Promise.deferred(),n=[r.promise,s.promise];let l;const _=a.getBlobUrl(),c=new t;return c.setMode("3dxc"===this._getFileType(a)?"concat":"zipped"),c.load({url:_,destinationNode:new i,doneCallback:e=>{l=e.material,r.resolve()},onTexturesLoadedCallback:()=>{s.resolve()}}),e.Promise.allSettled(n).then(()=>(URL.revokeObjectURL(_),e.Promise.resolve(l)))},_getFileType:function(e){const a=e.getName();for(const e in this._typeExtMap)if(a.endsWith(e))return this._typeExtMap[e]},_typeExtMap:{".3dx":"3dx",".3dxc":"3dxc"}})}),define("DS/CAT3DExpMaterialWebMedia/extensions/CATE3DXMaterialApplicationVisuMedia",["UWA/Core","UWA/Class","UWA/Class/Listener","DS/CAT3DExpMaterialWeb/XCTMaterialHelper"],function(e,a,t,i){"use strict";return a.extend(t,{Build:function(){this._frameVisuChanges={}},Dispose:function(){this.stopListening(),this._applied_material_parameters=null,this._frameVisuChanges=null,this._materialVisu=null},initializeMaterialApplicationVisu:async function(){this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"linktomaterial.CHANGED",this._refreshMaterialVisu),await this._refreshMaterialReference()},_refreshMaterialReference:async function(){this.stopListening(null,"REFERENCE_MATERIAL_VISU_CHANGED"),this.stopListening(null,"REFERENCE_MATERIAL_PARAMETERS_CHANGED");const e=this.QueryInterface("CATICXPMaterialApplication").GetMaterialLink();e&&(this.listenTo(e.QueryInterface("CATI3DXMaterialVisu"),"REFERENCE_MATERIAL_VISU_CHANGED",()=>{this._addFrameVisuChanges("REFRESH_MATERIAL_VISU",this._refreshMaterialVisu)}),this.listenTo(e.QueryInterface("CATI3DXMaterialVisu"),"REFERENCE_MATERIAL_PARAMETERS_CHANGED",()=>{this._addFrameVisuChanges("APPLY_JOP",this._applyJOP)}),await this._refreshMaterialVisu())},_refreshMaterialVisu:async function(){this._materialVisu=null;const e=this.QueryInterface("CATICXPMaterialApplication").GetMaterialLink();if(!e)return;const a=await e.QueryInterface("CATI3DXMaterialVisu").getMaterialVisu();this._materialVisu=a.clone(),this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetOverride().setMaterial(this._materialVisu,!0),this._applyJOP(),this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").forceViewerRefresh()},_getAppliedMaterialParameters:function(){return this._applied_material_parameters||this._initializeAppliedMaterialParameters(),this._applied_material_parameters},_applied_material_parameters_excludeVariables:["_varName","linktomaterial"],_initializeAppliedMaterialParameters:function(){this._applied_material_parameters=[],this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"VARIABLE_CHANGED",this._updateAppliedMaterialParameter),this.QueryInterface("CATI3DExperienceObject").ListVariables().forEach(e=>{this._applied_material_parameters_excludeVariables.includes(e)||this._applied_material_parameters.push(i.getJOPDefinition(e,this))})},_updateAppliedMaterialParameter:function(e){if(this._applied_material_parameters_excludeVariables.includes(e))return;const a=i.getJOPDefinition(e,this),t=this._applied_material_parameters.findIndex(e=>e.name===a.name);-1===t?this._applied_material_parameters.push(a):this._applied_material_parameters[t]=a,this._addFrameVisuChanges("APPLY_JOP",this._applyJOP)},_applyJOP:function(){if(!this._materialVisu)return;const e=this.QueryInterface("CATICXPMaterialApplication").GetMaterialLink();if(!e)return;const a=this.QueryInterface("CATI3DXMaterialApplicationAsset").getMaterialApplicationParameters(),t=e.QueryInterface("CATI3DXMaterialVisu"),r=t.getCacheReferenceMaterialParameters(),s=t.getReferenceMaterialParameters();return i.applyJop(this._materialVisu,{material_appearance:{applied_material_parameters:this._getAppliedMaterialParameters(),reference_material_parameters:s},version:2},{reference_material_parameters:r,applied_material_parameters:a},t._delegateMaterial),!0},_addFrameVisuChanges:function(e,a){this._frameVisuChanges[e]=a,this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").refreshGeoVisu(this)},Refresh:function(){if(!this._frameVisuChanges)return;let e=!1;return Object.keys(this._frameVisuChanges).forEach(a=>{this._frameVisuChanges.hasOwnProperty(a)&&(e=!0===this._frameVisuChanges[a].call(this))}),this._frameVisuChanges={},e}})}),define("DS/CAT3DExpMaterialWebMedia/extensions/CATE3DXMaterialVisuMedia",["UWA/Core","UWA/Class","UWA/Class/Listener","UWA/Class/Events","DS/CAT3DExpMaterialWeb/XCTMaterialHelper"],function(e,a,t,i,r){"use strict";return a.extend(t,i,{Build:function(){this._isMIACInisitalized=!1,this._frameVisuChanges={}},Dispose:function(){this.stopListening(),this._reference_material_parameters=null,this._isMaterialVisuNeeded=!1,this._frameVisuChanges=null},isMIACMaterial:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("appearance").QueryInterface("CATI3DExperienceObject").GetValueByName("_varContextualMaterial")},initializeMIACVisu:async function(){this._isMIACInisitalized=!0,await this._refreshMaterialVisuMIAC()},disposeMIACVisu:async function(){this._isMIACInisitalized=!1;const e=this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetPathElement(),a=await this.QueryInterface("CATI3DXMaterialAsset").getMaterial();e.removeSubstituteMaterial(null,a),this._materialVisuMiac=null},isMiacVisuInitialized:function(){return this._isMIACInisitalized},getReferenceMaterialParameters:function(){return this._reference_material_parameters||(this._isReferenceMaterialParametersNeeded=!0,this._refreshReferenceMaterialParameters()),this._reference_material_parameters},getCacheReferenceMaterialParameters:function(){return this._getDelegateMaterial().QueryInterface("CATI3DXMaterialAsset").getMaterialParameters()},getMaterialVisu:async function(){return this._materialVisu||(this._isMaterialVisuNeeded=!0,await this._refreshMaterialVisu()),this._materialVisu},_refreshMaterialVisu:async function(){if(!this._isMaterialVisuNeeded)return;const e=this._getDelegateMaterial(),a=await e.QueryInterface("CATI3DXMaterialAsset").getMaterial();this._materialVisu!==a&&(this._materialVisu=a,this.dispatchEvent("REFERENCE_MATERIAL_VISU_CHANGED",this._materialVisu),this._addFrameVisuChanges("REFRESH_MATERIAL_VISU_MIAC",this._refreshMaterialVisuMIAC))},_refreshMaterialVisuMIAC:async function(){if(!this.isMiacVisuInitialized())return;const e=await this.getMaterialVisu();this._materialVisuMiac=e.clone();const a=this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetPathElement(),t=await this.QueryInterface("CATI3DXMaterialAsset").getMaterial();a.addSubstituteMaterial(null,t,this._materialVisuMiac),this._applyJOPMiac(),this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").forceViewerRefresh()},_applyJOPMiac:function(){if(!this._materialVisuMiac)return;const e=this.getCacheReferenceMaterialParameters(),a=this.getReferenceMaterialParameters();return r.applyJop(this._materialVisuMiac,{material_appearance:{reference_material_parameters:a},version:2},{reference_material_parameters:e||{}},this._delegateMaterial),!0},_reference_material_parameters_excludeVariables:["_varName","RNDParameterNames","CXPParameterNames","apperance_preset"],_refreshReferenceMaterialParameters:function(){if(!this._isReferenceMaterialParametersNeeded)return;this.stopListening(null,"VARIABLE_CHANGED");const e=this._getDelegateMaterial().QueryInterface("CATI3DExperienceObject").GetValueByName("appearance");this.listenTo(e.QueryInterface("CATI3DExperienceObject"),"VARIABLE_CHANGED",this._updateReferenceMaterialParameter),this._reference_material_parameters=[],e.QueryInterface("CATI3DExperienceObject").ListVariables().forEach(a=>{this._reference_material_parameters_excludeVariables.includes(a)||this._reference_material_parameters.push(r.getJOPDefinition(a,e))}),this.dispatchEvent("REFERENCE_MATERIAL_PARAMETERS_CHANGED",this._reference_material_parameters),this._addFrameVisuChanges("APPLY_JOP_MIAC",this._applyJOPMiac)},_updateReferenceMaterialParameter:function(e){if(this._reference_material_parameters_excludeVariables.includes(e))return;const a=this._getDelegateMaterial().QueryInterface("CATI3DExperienceObject").GetValueByName("appearance"),t=r.getJOPDefinition(e,a),i=this._reference_material_parameters.findIndex(e=>e.name===t.name);-1===i?this._reference_material_parameters.push(t):this._reference_material_parameters[i]=t,this.dispatchEvent("REFERENCE_MATERIAL_PARAMETERS_CHANGED",this._reference_material_parameters),this._addFrameVisuChanges("APPLY_JOP_MIAC",this._applyJOPMiac)},_getDelegateMaterial:function(){return this._delegateMaterial||this._refreshDelegateMaterial(),this._delegateMaterial},_refreshDelegateMaterial:function(){this.stopListening(null,"DELEGATION_CHANGED");let e=this,a=e.QueryInterface("CATI3DExperienceDelegate");for(this.listenTo(a,"DELEGATION_CHANGED",()=>{this._refreshDelegateMaterial()});a.isDelegating();)e=a.getDelegate(),a=e.QueryInterface("CATI3DExperienceDelegate"),this.listenTo(a,"DELEGATION_CHANGED",()=>{this._refreshDelegateMaterial()});this._delegateMaterial=e,this._refreshReferenceMaterialParameters(),this._refreshMaterialVisu()},_addFrameVisuChanges:function(e,a){this._frameVisuChanges[e]=a,this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").refreshGeoVisu(this)},Refresh:function(){let e=!1;return Object.keys(this._frameVisuChanges).forEach(a=>{this._frameVisuChanges.hasOwnProperty(a)&&(e=!0===this._frameVisuChanges[a].call(this))}),this._frameVisuChanges={},e},isVariableTextured:function(e){const a=this.isMIACMaterial()?this._materialVisuMiac:this._materialVisu;return!!a&&r.isVariableTextured(a,e)}})});