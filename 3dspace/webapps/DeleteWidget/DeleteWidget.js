define("DS/DeleteWidget/DeleteWidget",["DS/LifecycleServices/LifecycleObjectList","css!DS/DeleteWidget/DeleteWidget","UWA/Core","UWA/Controls/Abstract","DS/LifecycleServices/LifecycleCommandManager","DS/LifecycleServices/LifecyclePerfTimer","i18n!DS/LifecycleWidget/assets/nls/LifecycleWidgetNls","i18n!DS/LifecycleServices/assets/nls/LifecycleServicesNls","DS/LifecycleServices/LifecycleServices","DS/LifecycleServices/LifecycleServicesSettings","DS/LifecycleControls/CommandDialog","DS/WAFData/WAFData","DS/LifecycleCmd/MessageMediator","DS/ReportingPanel/ReportingPanel","DS/ENOCollabToolsUI/tracker/ENOCollabTracker","DS/LifecycleControls/DataGridViewContainer","DS/LifecycleServices/HTMLTemplating","DS/PlatformAPI/PlatformAPI","DS/LifecycleControls/DelayedMask"],function(e,t,i,s,o,n,r,a,l,c,d,h,p,u,m,f,g,y,v){"use strict";var D=["Workspace","Workspace Vault"],_=null;function S(){return null==_&&(_=y.getUser()),_}function C(){var e=S(),t="";return void 0!==e&&(t=e.firstName+" "+e.lastName),t}return s.extend({physicalid:"",securityContext:null,context:null,tenant:null,operationType:"delete",refreshType:"",_commandResult:!1,_initialSelection:null,_isMultiSelect:!1,_isBookmark:!1,_isconditionalCheckbox:!1,_cmdDlg:null,init:function(e){UWA.is(e,"string")&&(this.operationType=e),this.deleteOptions=[];var t=this;this._perfTimer=n,this._perfTimer.init("Delete"),this._perfTimer.start("CommandUIDurationDelete"),this.commandManager=new o,this.commandManager.addEvent("onModifyOptions",function(e){t.deleteOptions=e.options,t.deleteOptionsObjects=e.objects,e.options&&e.options.length>0&&(!0===e.options[0].value?!1===t._isconditionalCheckbox&&t.conditionalCheckbox(!0):!1===t._isMultiSelect&&!1===t._isBookmark&&t.conditionalCheckbox(!1))}),this.commandManager.addEvent("onModifyConditional",function(e){!0===e.value?t._cmdDlg.updateUI():t._cmdDlg._disableOK()})},conditionalCheckbox:function(e){this._cmdDlg&&(!0===e?(this.commandManager.setDisplayStateConditionalDeleteCheckbox(!0),this._cmdDlg._disableOK()):(this.commandManager.setDisplayStateConditionalDeleteCheckbox(!1),this._cmdDlg.updateUI()))},executeCmd:function(e,t,i){const s=new Set;var o,n,r=0,a=e.length,l=[],c=0;for(r=0;r<a;r++)n=(o=e[r]).physicalid,s.add(n),s.size>c&&(c++,l.push(o));this.addEvent("onReady",function(e){this._initialSelection=l,l.length>1?this._showMultiselUI(l):this._showCommandUI(l)},this),this.addEvent("onComplete",function(e){i()}),this.context=t.context,this.setObjects(l),this.trackAppContent(l)},launchReportingPanel:function(e){if(e.hasOwnProperty("report")&&0!==e.report.length){var t=[];for(var i in e.report){var s=e.report[i],o=s.isinput,n=[],l=s.physicalids[0];n.push(l),n.push(r.deleteFailedShort),n.push("Failed"),null!=(D=s["attribute[PLMEntity.V_Name]"])&&0!==D.length||(D=s.name),n.push(D);var c=s.displaytype;n.push(c);var d=s.revision;n.push(d),n.push(s.stateUserName);var h=void 0,p=s.reserved,m=s.reservedby;if("TRUE"==p?p=!0:"FALSE"!=p&&""!==p||(p=!1),void 0===p)h="";else if(!0===p){var f=(b=void 0,w=void 0,b=S(),w="",void 0!==b&&(w=b.login),w),g=C(),y=!0;m.trim().length>0&&((y=m.toUpperCase().trim()===f.toUpperCase().trim()||!1)||(y=m.toUpperCase().trim()===g.toUpperCase().trim()||!1)),h=y?"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-key lc_dgv_lock":"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-lock lc_dgv_lock_other"}else!1===p&&(h="wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-lock-open lc_dgv_unlock");n.push(h);var v=s.error;n.push(v),"true"==o?n.push(r.deleteSelected):n.push(r.deleteAdded),n.push(r.deleteFailedShort),t.push(n)}if(e.hasOwnProperty("results")&&0!==e.results.length)for(var i in e.results){var D,_=e.results[i],x=_.isinput;n=[],l=_.physicalid;n.push(l),n.push(r.deleteSuccessfulShort),n.push("Success"),null!=(D=_["attribute[PLMEntity.V_Name]"])&&0!==D.length||(D=_.name),n.push(D);c=_.displaytype;n.push(c);d=_.revision;n.push(d),n.push(""),n.push(""),n.push(""),"true"==x?n.push(r.deleteSelected):n.push(r.deleteAdded),n.push(r.deleteSuccessfulShort),t.push(n)}var O=[{text:"ID",dataIndex:"ID",isHidden:!0},{text:"StatusToolTipColumn",dataIndex:"statusTooltip",isHidden:!0,tooltipColumn:"Status"},{text:r.status,dataIndex:"Status",typeRepresentation:"icon"},{text:r.title,dataIndex:"Title"},{text:r.type,dataIndex:"Type"},{text:r.revision,dataIndex:"Revision",width:70,resizableFlag:!1},{text:a.maturitystate,dataIndex:"Current",width:100,resizableFlag:!1},{text:r.Lock,dataIndex:"Reserved",typeRepresentation:"icon",width:50,resizableFlag:!1},{text:r.message,dataIndex:"Message"},{text:r.deleteObjects,dataIndex:"Selected",isHidden:!0,isFilter:!0,filterOptions:[{value:r.deleteSelected,default:"on",tooltip:r.deleteSelectedToolTip},{value:r.deleteAdded,default:"off",tooltip:r.deleteAddedToolTip}]},{text:r.deleteResults,dataIndex:"Results",isHidden:!0,isFilter:!0,filterOptions:[{value:r.deleteSuccessfulShort,default:"on",tooltip:r.deleteSuccessfulShort},{value:r.deleteFailedShort,default:"on",tooltip:r.deleteFailedShort}]}];u.launchReportingPanel(t,O,null)}var b,w},getResult:function(){return this._commandResult},_showMultiselUI:function(e){var t=this,i=!1,s=!1,o=0,n=0;t._isMultiSelect=!0;var l="",h=e.length;for(n=0;n<h;n++){var p=e[n];if(p.type&&D.indexOf(p.type)>=0){if(!1===i&&p.hasOwnProperty("displayName"))if(p.hasOwnProperty("revision")&&null!=p.revision&&p.revision.trimEnd().trimStart().length>0){var u=p.revision;l=p.displayName.concat(" ").concat(u),p.displayName.endsWith(u)&&(l=p.displayName)}else l=p.displayName,p.hasOwnProperty("name")&&l.startsWith(p.name)&&(l=p.name);i=!0,t._isBookmark=!0,o++}if(this.hasOwnProperty("deleteOptionsObjects")&&this.deleteOptionsObjects)for(var m=0;m<this.deleteOptionsObjects.length;m++)if(p.physicalid==this.deleteOptionsObjects[m].physicalid){e[n].preCheckStatus="waiting";break}l=UWA.String.escapeHTML(l)}o>0&&o<e.length&&(s=!0),this.deleteContent=UWA.createElement("div",{class:"lcm-delete-content css_grid_container dlg_cmd_content"});var y=document.createElement("div");y.className="delete-multi-message";var v=document.createElement("div");v.className="delete_popup_warning";var _=UWA.createElement("div",{styles:{height:"100%","padding-right":"5px"}}),S=c.get3DSpaceBaseUrl(widget.getValue("x3dPlatformId"))+"/webapps/IterationsWidget/assets/images/warning.png";_.innerHTML='<img src="'+S+'"></img>',v.appendChild(_);var C=r.doDelete+r.questionMark+"<br>"+r.doDeleteDetails;i&&(C=s?1===o?r.doDeleteSingleBookmarkMixedDetails+"<br>"+a.replace(r.doDeleteSingleBookmarkMixed,{bookmarkName:l}):r.doDeleteMultipleBookmarkMixedDetails+"<br>"+r.doDeleteMultipleBookmarksMixed:r.doDeleteMultipleBookmarkDetails+"<br>"+r.doDeleteMultipleBookmarks),y.innerHTML=C,v.appendChild(y),this.deleteContent.appendChild(v),this.deleteContent.appendChild(this.commandManager.buildConditionalDeletePanel(r.deleteCannotBeRecovered)),this.objectsList=new f({idName:"dgvContainer",clickToShowDGV:!1,showLock:!0,showRowSelect:!0,showPreStatus:!0},e),this.objectsList.inject(this.deleteContent);var x=r.delete_+" - "+e.length+" "+r.deleteObjects;t._cmdDlg=new d;var O=t._cmdDlg.create(this.deleteContent,{title:x,closeButton:!0,resizable:!0,imageUrl:e[0].imageUrl||"",OKBtnText:r.delete_,OKBtnType:"delete",onOk:function(){t._executeDelete(function(){t._perfTimer.start("CommandExecutionDurationDelete"),O.destroy(),t._onComplete(),t._cmdDlg.destroy()})},onClose:function(){t._onComplete()}});this.objectsList.model.getModelEvents().subscribe({event:"nodeModelUpdate"},function(e){if(t._isMultiSelect&&t.objectsList){var i=[];t.objectsList.model.getRoots().forEach((e,t)=>{var s=e.options.grid;if(!s.attrExclude){var o={physicalid:s.id};i.push(o)}}),0==i.length?t._cmdDlg._disableOK():t.commandManager._conditionalInput.checkFlag&&t._cmdDlg._okButton.enable()}}),t._cmdDlg._disableOK(),this._isMultiSelect&&(O.elements.container.addClassName("multiSel"),t._executeCheckAccess(function(e){var i=t.objectsList.model.getRoots();if(e&&e.hasOwnProperty("results"))for(var s=0;s<e.results.length;s++)for(var o=e.results[s].physicalid,n=e.results[s].hasDeleteAccess,r=0;r<i.length;r++){var a=i[r];if(a.options.grid.id==o){var l=!1;n||(l=!0),a.updateOptions({grid:{preCheckStatus:n,attrExclude:l}});break}}})),O.inject(widget.body),O.setNewSize({});var b=O.getModalBodySize(),w=this._isMultiSelect?310:236;w=this._isMultiSelect?w+25*(e.length-2):w,!this._isMultiSelect&&g.isTouchMode()&&(w+=24),O.setNewSize({width:b.width,height:w}),t._perfTimer.stop("CommandUIDurationDelete")},_showCommandUI:function(e){var t=this,i="",s=null;if(e&&UWA.is(e,"array")&&e.length>0&&e[0].hasOwnProperty("revision")&&e[0].hasOwnProperty("displayName")){var o=e[0].revision;null!=o&&o.trimStart().trimEnd().length>0?(i=e[0].displayName.concat(" ").concat(o),e[0].displayName.endsWith(o)&&(i=e[0].displayName)):(i=e[0].displayName,e[0].hasOwnProperty("type")&&D.indexOf(e[0].type)>=0&&e[0].hasOwnProperty("name")&&i.startsWith(e[0].name)&&(i=e[0].name));var n=r.delete_;if(e[0].hasOwnProperty("type")&&(s=e[0].type),""==i){if(e[0].hasOwnProperty("type")&&(n=r.delete_+" - "+s),e[0].hasOwnProperty("typeDisplayName")){var a=e[0].typeDisplayName;n=r.delete_+" - "+a}}else n=r.delete_+" - "+i}i=UWA.String.escapeHTML(i);var l=this._renderDialogContent(i,s);t._cmdDlg=new d;var c=t._cmdDlg.create(l,{title:n,OKBtnText:r.delete_,OKBtnType:"delete",closeButton:!0,imageUrl:e[0].imageUrl||"",onOk:function(){t._executeDelete(function(){t._perfTimer.start("CommandExecutionDurationDelete"),c.destroy(),t._onComplete(),t._cmdDlg.destroy()})},onClose:function(){t._onComplete()}});D.indexOf(s)>=0&&(t._isBookmark=!0,t.conditionalCheckbox(!0)),c.inject(widget.body),c.setNewSize({}),t._perfTimer.stop("CommandUIDurationDelete")},_renderDialogContent:function(e,t){var i=UWA.String.escapeHTML(e),s=document.createElement("div");s.className="delete_popup css_grid_container dlg_cmd_content";var o,n=document.createElement("div");n.className="delete-single-message";var l=document.createElement("div");l.className="delete_popup_warning";var d=UWA.createElement("div",{styles:{height:"100%","padding-right":"5px"}}),h=c.get3DSpaceBaseUrl(widget.getValue("x3dPlatformId"))+"/webapps/IterationsWidget/assets/images/warning.png";return d.innerHTML='<img src="'+h+'"></img>',l.appendChild(d),o=t&&D.indexOf(t)>=0?null==r.doDeleteSingleBookmark?a.replace("Do you want to permanently delete the {bookmarkName} hierarchy? The content is removed",{bookmarkName:e}):r.doDeleteSingleBookmarkDetails+a.replace(r.doDeleteSingleBookmark,{bookmarkName:e}):r.doDeleteMessage+i+r.questionMark+"<br>"+r.doDeleteDetails,n.innerHTML=o,l.appendChild(n),s.appendChild(l),this.deleteOptions&&this.deleteOptions[0]&&this.deleteOptions[0].key&&"wholeStructure"===this.deleteOptions[0].key&&this.deleteOptions[0].type&&"checkbox"===this.deleteOptions[0].type?(this.deleteOptions[0].conditional=!0,this.deleteOptions[0].conditionaltext=r.deleteCannotBeRecovered,s.appendChild(this.commandManager.buildCheckboxOptionPanel(this.deleteOptions))):t&&D.indexOf(t)>=0&&(s.appendChild(this.commandManager.buildConditionalDeletePanel(r.deleteCannotBeRecovered)),s.appendChild(this.commandManager.buildCheckboxOptionPanel(this.deleteOptions))),s},_onComplete:function(){this.dispatchEvent("onComplete",{})},setObjects:function(e){var t=this;if(0===e.length)throw r.noObject;if(1===e.length){var i=[];if((o={}).data=e,(n=e[0]).hasOwnProperty("physicalid")&&""===n.physicalid)throw r.epmtyPhysicalId;this.physicalid=n.physicalid,i.push({physicalid:this.physicalid}),this.dataPIDs=i,this.tenant=n.tenant,this.commandManager.setTenant(this.tenant),this.commandManager.addEvent("onCompleteGetOptions",function(e){document.body.style.cursor="default",this.deleteOptions=e.options,this.deleteOptionsObjects=e.objects,this.refreshType="Delete",this.dispatchEvent("onReady",{})},this);var s={data:[{physicalid:this.physicalid}],command:"Delete"};this._perfTimer.start("Delete: getOptions"),this.commandManager.getOptions(s,function(e,i){t._perfTimer.stop("Delete: getOptions"),t.showError(e),t._refreshInvalidObjects(i),t._onComplete()})}else{var o;(o={}).data=e;for(var n,a=(n=e[0]).tenant,l=[],c=(i=[],0);c<o.data.length;++c){var d=e[c];if(d.hasOwnProperty("physicalid")&&""===d.physicalid)throw r.epmtyPhysicalId;if(d.tenant!=a)throw r.MultipleTenants;l.push(d.physicalid),i.push({physicalid:d.physicalid})}this.pids=l,this.dataPIDs=i,this.tenant=a,this.commandManager.setTenant(this.tenant);let h=new v(widget.body,500,r.loadingText);this.commandManager.addEvent("onCompleteGetOptions",function(e){document.body.style.cursor="default",h.unmask(),this.deleteOptions=e.options,this.deleteOptionsObjects=e.objects,this.refreshType="Delete",this.dispatchEvent("onReady",{})},this);s={data:i,command:"Delete"};this._perfTimer.start("Delete: getOptions"),this.commandManager.getOptions(s,function(e,i){t._perfTimer.stop("Delete: getOptions"),t.showError(e),t._refreshInvalidObjects(i),t._onComplete()})}},_executeCheckAccess:function(e){var t=this,i={};if(this._isMultiSelect&&this.objectsList)for(var s=this.objectsList.model.getRoots(),o=Math.ceil(s.length/20),n=0;n<o;n++){for(var a=[],c=20*n;c<Math.min(20*(n+1),s.length);c++){var d={physicalid:s[c].options.grid.id};a.push(d)}i.data=a,i.notificationTimeout=300,console.log("Prepare CheckAccess Input:"),console.log(i);var h=JSON.stringify(i);if(null!=t.context&&"function"==typeof t.context.getSecurityContext){var p=t.context.getSecurityContext();t.securityContext=p.SecurityContext,t.DeleteCheckAccessRequest(h,e)}else l.getSecurityContextPromise().then(function(i){null==i?(t.showError({errorMsg:r.ErrorSecurityContextEmpty}),e()):(t.securityContext=i,t.DeleteCheckAccessRequest(h,e))}).catch(function(i){t.showError({errorMsg:i}),e()})}},_executeDelete:function(e){var t={},i=this.dataPIDs;this._isMultiSelect&&this.objectsList&&(i=[],this.objectsList.model.getRoots().forEach((e,t)=>{var s=e.options.grid;if(!s.attrExclude){var o={physicalid:s.id};i.push(o)}}));t.data=i,t.notificationTimeout=300,"restore"!=this.operationType&&(t.options=this.deleteOptions),console.log("Prepare Delete/Restore Input:"),console.log(t);var s=JSON.stringify(t);if(t.data.length>0){document.body.style.cursor="wait";var o=function(){document.body.style.cursor="default",e()},n=this;if(null!=n.context&&"function"==typeof n.context.getSecurityContext){var a=n.context.getSecurityContext();n.securityContext=a.SecurityContext,n.DeleteServiceRequest(s,o)}else l.getSecurityContextPromise().then(function(e){null==e?(n.showError({errorMsg:r.ErrorSecurityContextEmpty}),o()):(n.securityContext=e,n.DeleteServiceRequest(s,o))}).catch(function(e){n.showError({errorMsg:e}),o()})}else e(),this.showNotification(r.deleteSuccessful)},_refreshInvalidObjects:function(e){if(e&&UWA.is(e.report,"array")){var t=this._getInvalidObjectIDs(e.report);if(!(t.length<1)){for(var i=[],s=0;s<t.length;++s)i.push({physicalid:t[s]});this._refreshObjects("Delete",i)}}},_getInvalidObjectIDs:function(e){for(var t=[],i=0;i<e.length;++i)if(UWA.is(e[i].errorcode,"number")&&(1===e[i].errorcode||100===e[i].errorcode||101===e[i].errorcode))if(UWA.is(e[i].physicalids,"array"))for(var s=e[i].physicalids,o=0;o<s.length;++o)t.push(s[o]);else UWA.is(e[i].physicalid)&&t.push(e[i].physicalid);return t},showNotification:function(e,t){if("function"==typeof this.context.displayNotification){var i={eventID:"string"==typeof t?t:"primary",msg:e};this.context.displayNotification(i)}else alert(e)},showError:function(e){if(void 0!==this.context&&null!==this.context&&"function"==typeof this.context.displayNotification){var t=e.message||e,i="error";null!=e&&e&&e.hasOwnProperty("isNotificationInfo")&&e.isNotificationInfo&&(i="info");var s=!1;null!=e&&e&&e.hasOwnProperty("sticky")&&(s=e.sticky);var o={eventID:i,msg:t.split?t.split("\n").join("<br>"):t,sticky:s};this.context.displayNotification(o)}else alert(e)},_refreshObjects:function(e,t,i){var s={created:[],deleted:[],modified:[],restored:[]};s.context=this.context;var o=function(e,t,i){e.forEach(function(e){t.push({physicalid:e.physicalid,operation:i,impl:e.impl})})};t&&o(t,s.deleted,e),i&&o(i,s.restored,e),p.dispatchEvent("onModification",s)},_refreshFromSuccessResponse:function(e){var t=[],i=[];e.results.forEach(function(e){"restore"===this.operationType?i.push(e):t.push(e)},this),this._refreshObjects(this.refreshType,t,i)},DeleteCheckAccessRequest:function(e,t){var i=this;this._commandResult=!1;var s=c.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/Delete/checkDeleteAccess",null);h.authenticatedRequest(s,{method:"POST",headers:c.getHeaders(encodeURIComponent(this.securityContext)),timeout:288e5,onComplete:function(e){console.log("delete check access: COMPLETED"),console.log(e),null!=e?(e.hasOwnProperty("results")&&0!==e.results.length&&(i._commandResult=!0),t(e)):t()},data:e,onFailure:function(e,i){t()},onTimeout:function(e){t()},type:"json"})},DeleteServiceRequest:function(e,t){var i=this;this._commandResult=!1;var s=c.get3DSpaceWSUrl(this.tenant,"/resources/lifecycle/Delete/structure",null);i._perfTimer.start("Delete: structure"),h.authenticatedRequest(s,{method:"POST",headers:c.getHeaders(encodeURIComponent(this.securityContext)),timeout:288e5,onComplete:function(e){var s;if(i._perfTimer.stop("Delete: structure"),console.log("delete: COMPLETED"),console.log(e),null!=e)if(e.hasOwnProperty("results")&&0!==e.results.length&&(i._commandResult=!0),i.launchReportingPanel(e),t(),!0===i._commandResult){if(e.hasOwnProperty("report")&&0!==e.report.length){var o=e.report.length;s=r.deletePartialSuccessful+": "+o+" ",s+=1===o?r.deleteIgnoredObject:r.deleteIgnoredObjects}else s=r.deleteSuccessful;i.showNotification(s),i._perfTimer.stop("CommandExecutionDurationDelete");var n=["CommandUIDurationDelete","CommandExecutionDurationDelete","Delete: structure","Delete: getOptions"];e.hasOwnProperty("PerfAndInfo")?i._perfTimer.printTimeShowDialogAndProcess(n,i.securityContext,e.PerfAndInfo):i._perfTimer.printTimeShowDialogAndProcess(n,i.securityContext),i._refreshFromSuccessResponse(e)}else s=e.hasOwnProperty("errormessage")?e.errormessage:r.deleteFailed,"restore"===i.operationType&&(s=r.restoreFailed),i.showError(s),i._perfTimer.stop("CommandExecutionDurationDelete"),n=["CommandUIDurationDelete","CommandExecutionDurationDelete","Delete: structure","Delete: getOptions"],i._perfTimer.printTimeShowDialogAndProcess(n,i.securityContext),i._refreshInvalidObjects(e);else t()},data:e,onFailure:function(e,s){i._perfTimer.stop("Delete: structure");var o=l._parseWebServiceError(e,s,!0,"Delete");void 0!==o&&void 0!==o&&o.hasOwnProperty("message")?(o.errorMsg=o.message,o.type="error",o.hasOwnProperty("isNotificationInfo")&&o.isNotificationInfo&&(o.type="info")):o.errorMsg=l.parseWebServiceError(e,s,!0),o.sticky=!0,i.showError(o),console.log("Failed to retrive data from the server"),t()},onTimeout:function(e){i._perfTimer.stop("Delete: structure"),(e=l._parseWebServiceError(e,null,!0,"Delete")).sticky=!0,i.showError(e),t()},type:"json"})},trackAppContent:function(e){var t={UXName:"Delete",models:e};this.trackerEvent=m.createInitActionEvent(t,this.trackerEvent),m.checkAndTrackPageEvent(this.trackerEvent)}})});