define("DS/FlyWalkUI/CollisionSettingsPanel",["UWA/Class","UWA/Core","DS/WebappsUtils/WebappsUtils","DS/RuntimeView/NLSManager","DS/Windows/Panel","DS/Controls/Button","DS/Controls/LineEditor","DS/Controls/SpinBox","DS/Controls/Toggle","DS/Controls/Expander","DS/FlyWalkInfra/CollisionPrefStorageCtlr","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CoreEvents/Events","DS/Controls/TooltipModel","DS/Visualization/CollisionServices","i18n!DS/FlyWalkUI/assets/nls/translation"],function(t,e,n,i,o,s,a,l,r,c,u,d,h,v,g,p,f){"use strict";var b=t.extend({init:function(t){return this.options=t,this.navigationCtx=this.options.navigCtx,this._userCloseCB=this.options.userCloseCB,this._applyCB=this.options.applyCB,this._verifyPickedPointCB=this.options.verifyPickedPointCB,this._setNodesVisibilityCB=this.options.setNodesVisibilityCB,this._isOnCloud=this.options.isOnCloud,this._isPointCloudMode=this.options.isPointCloudMode,this._initializing=!1,this._thirdPersonModeToggleBtn=null,this._initialPosModeToggleBtn=null,this._onClickToken=null,this._onTapToken=null,this},buildSelf:function(){this.buildPanel(),this._addCallbacks()},buildPanel:function(){var t=this;this._initializing=!0;var e=n.getWebappsBaseUrl(),i=new UWA.Element("div",{class:"wux-container"});this.myPanel=new o({icon:{iconPath:e+"FlyWalkCommand/assets/icons/32/I_CollisionSettings_Small.png",iconSize:{width:"18px",height:"18px"}},immersiveFrame:this.navigationCtx.immersiveFrame,header:f.CollisionPref.PanelTitle.Label,content:i,identifier:"CollisionSettingsPanel-"+this.navigationCtx.immersiveFrame.identifier,position:{my:"top left",at:"top left",offsetX:.6*this.navigationCtx.immersiveFrame.getFreeZone().getDimensions().width,offsetY:.3*this.navigationCtx.immersiveFrame.getFreeZone().getDimensions().height,of:this.navigationCtx.immersiveFrame.getFreeZone()}}),u.initialize(),this.myPanel.addEventListener("close",function(){t.storeAvatarPosition(),t._removeCallbacks(),t._userCloseCB&&t._userCloseCB()});var h=new UWA.Element("div",{class:"wux-container"});h.setStyles({marginLeft:"0px"});new c({header:f.CollisionPref.AvatarManagement.Label,body:h,style:"simple",expandedFlag:!0}).inject(i);var v=new UWA.Element("div",{class:"wux-control-inline-container"}).inject(h),p=new g({shortHelp:f.CollisionPref.InitialPosition.ShortHelp});this._initialPosModeToggleBtn=new r({type:"switch",label:f.CollisionPref.InitialPosition.Label,tooltipInfos:p,value:0,checkFlag:!1}).inject(v),this._initialPosModeToggleBtn.getContent().setStyles({marginLeft:"0px"}),this._initialPosModeToggleBtn.addEventListener("change",function(e){t._initializing||u.setValue("InitialPositionMode",e.dsModel.checkFlag)}),this._initialPosModeToggleBtn.checkFlag=u.getValue("InitialPositionMode"),new UWA.Element("span",{class:"wux-control-inline-container",text:"(X,Y,Z)"}).inject(v).setStyles({marginLeft:"30px"});var b=new UWA.Element("div",{class:"wux-control-inline-container"}).inject(v);this.xPosInput=new a({placeholder:"0.0",pattern:"[+-]?([0-9]*[.])?[0-9]+"}).inject(b),this.xPosInput.sizeInCharNumber=5,this.xPosInput.addEventListener("change",function(e){t._initializing||t.storeAvatarPosition()});var C=new UWA.Element("div",{class:"wux-control-inline-container"}).inject(v);this.yPosInput=new a({placeholder:"0.0",pattern:"[+-]?([0-9]*[.])?[0-9]+"}).inject(C),this.yPosInput.sizeInCharNumber=5,this.yPosInput.addEventListener("change",function(e){t._initializing||t.storeAvatarPosition()});var m=new UWA.Element("div",{class:"wux-control-inline-container"}).inject(v);this.zPosInput=new a({placeholder:"0.0",pattern:"[+-]?([0-9]*[.])?[0-9]+"}).inject(m),this.zPosInput.sizeInCharNumber=5,this.zPosInput.addEventListener("change",function(e){t._initializing||t.storeAvatarPosition()});var k=u.getValue("SavedPosition");this.xPosInput.value=k[0],this.yPosInput.value=k[1],this.zPosInput.value=k[2];var S=new g({shortHelp:f.CollisionPref.Pick.ShortHelp});this.pickButton=new s({label:f.CollisionPref.Pick.Label,tooltipInfos:S,emphasize:"secondary"}).inject(v),this.pickButton.getContent().setStyles({marginLeft:"5px"}),this.pickButton.addEventListener("buttonclick",function(e){t._removePickCB(),t.pickButton.disabled=!0,t._onClickToken=d.addEvent(t.navigationCtx.visViewerFrame,"onLeftClick",function(e){t._onPick(e)}),t._onTapToken=d.addEvent(t.navigationCtx.visViewerFrame,"onTap",function(e){t._onPick(e)})});var _=new UWA.Element("div",{class:"wux-container"}).inject(v);_.setStyles({marginLeft:"0px"}),new UWA.Element("span",{class:"wux-control-inline-container",text:f.CollisionPref.AvatarHeight.Label}).inject(_).setStyles({marginLeft:"0px"});var y=new g({shortHelp:f.CollisionPref.AvatarHeight.ShortHelp}),B=new l({minValue:1e3,maxValue:2500,stepValue:10,tooltipInfos:y}).inject(_);B.getContent().setStyles({width:"50px",marginLeft:"10px"}),B.addEventListener("change",function(e){t._initializing||(u.setValue("AvatarHeight",e.dsModel.value),u.commit(),t._applyCB())}),B.value=u.getValue("AvatarHeight");var P=new g({shortHelp:f.CollisionPref.ThirdPerson.ShortHelp});if(this._thirdPersonModeToggleBtn=new r({type:"switch",label:f.CollisionPref.ThirdPerson.Label,tooltipInfos:P,value:0,checkFlag:!1}).inject(v),this._thirdPersonModeToggleBtn.getContent().setStyles({marginLeft:"0px"}),this._thirdPersonModeToggleBtn.addEventListener("change",function(e){t._initializing||(u.setValue("ThirdPersonMode",e.dsModel.checkFlag),u.commit(),t._applyCB())}),this._thirdPersonModeToggleBtn.checkFlag=u.getValue("ThirdPersonMode"),this._isOnCloud){var x=new UWA.Element("div",{class:"wux-container"});x.setStyles({marginLeft:"0px"});new c({header:f.CollisionPref.Collision.Label,body:x,style:"simple",expandedFlag:!0}).inject(i);var w=new UWA.Element("div",{class:"wux-control-inline-container"}).inject(x),M=new g({shortHelp:f.CollisionPref.Gravity.ShortHelp}),A=new r({type:"switch",label:f.CollisionPref.Gravity.Label,tooltipInfos:M,value:0,checkFlag:!1}).inject(w);A.getContent().setStyles({marginLeft:"0px"}),A.addEventListener("change",function(e){t._initializing||(u.setValue("Gravity",e.dsModel.checkFlag),u.commit(),t._applyCB())}),A.checkFlag=u.getValue("Gravity");var D=new g({shortHelp:f.CollisionPref.EnableTransparent.ShortHelp}),E=new r({type:"switch",label:f.CollisionPref.EnableTransparent.Label,tooltipInfos:D,value:0,checkFlag:!1}).inject(w);E.getContent().setStyles({marginLeft:"0px"}),E.addEventListener("change",function(e){t._initializing||(u.setValue("EnableTransparent",e.dsModel.checkFlag),u.commit(),t._applyCB())}),E.checkFlag=u.getValue("EnableTransparent")}var F=new UWA.Element("div",{class:"wux-container"});F.setStyles({marginLeft:"0px"});new c({header:f.CollisionPref.Navigation.Label,body:F,style:"simple",expandedFlag:!0}).inject(i);var N=new UWA.Element("div",{class:"wux-control-inline-container"}).inject(F),W=new g({shortHelp:f.CollisionPref.PointerLock.ShortHelp}),L=new r({type:"switch",label:f.CollisionPref.PointerLock.Label,tooltipInfos:W,value:0,checkFlag:!1}).inject(N);L.getContent().setStyles({marginLeft:"0px"}),L.addEventListener("change",function(e){t._initializing||(u.setValue("PointerLock",e.dsModel.checkFlag),u.commit(),t._applyCB())}),L.checkFlag=u.getValue("PointerLock"),this._initializing=!1},storeAvatarPosition:function(t){var e=[];e[0]=parseFloat(this.xPosInput.value),e[1]=parseFloat(this.yPosInput.value),e[2]=parseFloat(this.zPosInput.value),u.setValue("SavedPosition",e),u.commit()},pickOnViewer:function(t){var e;this.navigationCtx.visViewer.currentViewpoint.getEyePosition();t.from&&"Touch"===t.from[0].type?e={x:t.from[0].currentPosition.x,y:t.from[0].currentPosition.y}:e=t.from?{x:t.from[0].getJSEvent().pageX,y:t.from[0].getJSEvent().pageY}:{};var n=new THREEDS.Core.Vector2(e.x,e.y),i=this.navigationCtx.visViewer.pick(this.navigationCtx.visViewer.getMousePosition(n),"mesh",!0);return i.path&&i.path.length>0?i:null},pickOnViewer_Precise:function(t){var e;if(!(t.from&&t.from.length>0&&t.from[0]))return null;e={x:t.from[0].currentPosition.x,y:t.from[0].currentPosition.y};var n=new THREEDS.Core.Vector2(e.x,e.y),i=this.navigationCtx.visViewer.getMousePosition(n),o=new THREEDS.Core.Vector3;p.viewer||p.setViewer(this.navigationCtx.visViewer);var s=u.getValue("EnableTransparent");s||(p.skipTransparentItems=!1),this._setNodesVisibilityCB&&this._setNodesVisibilityCB(!1);var a=p.getPrecisePositionAtPick(i,o);return this._setNodesVisibilityCB&&this._setNodesVisibilityCB(!0),s||(p.skipTransparentItems=!0),a?{position:a.clone(),normal:o.clone()}:null},destroy:function(){this.myPanel.destroy()},_addCallbacks:function(t){var e=this;this.onThirdPersonChangeID=v.subscribe({event:"/VisFlyWalk/onThirdPersonModeChange"},function(t){e._initializing=!0,e._thirdPersonModeToggleBtn.checkFlag=u.getValue("ThirdPersonMode"),e._initializing=!1}),this.onInitPosModeChangeID=v.subscribe({event:"/VisFlyWalk/onInitPosModeChange"},function(t){e._initializing=!0,e._initialPosModeToggleBtn.checkFlag=u.getValue("InitialPositionMode"),e._initializing=!1})},_removeCallbacks:function(){v.unsubscribe(this.onThirdPersonChangeID),v.unsubscribe(this.onInitPosModeChangeID),this._removePickCB()},_removePickCB:function(){this._onClickToken&&d.removeEventFromToken(this._onClickToken),this._onClickToken=null,this._onTapToken&&d.removeEventFromToken(this._onTapToken),this._onTapToken=null},_onPick:function(t){if(t.gesture.getEvents().length>0){var e=null;if(e=this._isPointCloudMode?this.pickOnViewer(t):this.pickOnViewer_Precise(t)){var n=e.position;n&&(this.xPosInput.value=n.x.toFixed(2),this.yPosInput.value=n.y.toFixed(2),this.zPosInput.value=n.z.toFixed(2),this.storeAvatarPosition()),this.pickButton.disabled=!1,this._removePickCB(),!this._isPointCloudMode&&this._verifyPickedPointCB&&this._verifyPickedPointCB(e)}}}});return UWA.namespace("DS/FlyWalkUI/CollisionSettingsPanel",b)}),define("DS/FlyWalkUI/WebNlsLoader",["DS/RuntimeView/NLSManager","UWA/Class"],function(t,e){"use strict";return e.singleton({init:function(t){},_setLang:function(t){t&&(this.lang=t)},loadNls:function(e,n){n!==this.lang&&void 0!==n&&(this.lang=n),t.loadResource({resourceFile:e,language:this.lang})},nls:function(e,n,i,o){t.onResourceLoaded({resourceFile:e},function(){if(Array.isArray(n)){for(var t=[],e=0;e<n.length;e++)t[e]=this.getKey({key:n[e]});i(t)}else i(this.getKey({key:n}))}),t._listOfResources[e]||this.loadNls(e,o)}})}),define("DS/FlyWalkUI/WebRscLoader",["DS/RuntimeView/RSCManager","UWA/Class"],function(t,e){"use strict";return e.singleton({init:function(t){},loadRsc:function(e){t.loadResource({resourceFile:e})},rsc:function(e,n,i){t.onResourceLoaded({resourceFile:e},function(){if(Array.isArray(n)){for(var t=[],e=0;e<n.length;e++)t[e]=this.getIcon({key:n[e].iconName,size:n[e].iconSize});i(t)}else i(this.getIcon({key:n.iconName,size:n.iconSize}))}),t._listOfResources&&t._listOfResources[e]||this.loadRsc(e)}})}),define("DS/FlyWalkUI/CollisionAssistanceUI",["UWA/Class","UWA/Core","DS/WebappsUtils/WebappsUtils","DS/RuntimeView/NLSManager","DS/Windows/Panel","DS/Controls/Button","DS/Controls/LineEditor","DS/Controls/SpinBox","DS/Controls/Toggle","i18n!DS/FlyWalkUI/assets/nls/translation","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen"],function(t,e,n,i,o,s,a,l,r,c,u,d){"use strict";var h=t.extend({init:function(t){return this.oldNotifManager=d.getNotificationManager(),d.setNotificationManager(u),this.oldNotifStackingPolocy=d.getStackingPolicy(),d.setStackingPolicy(3),t&&(this._parentView=t),this._assistanceStatusText=null,this._defaultAssistanceText="Info About Collision Mode",this._showMsgTime=6e3,this._currentMode=null,this},destroy:function(){d.setStackingPolicy(this.oldNotifStackingPolocy),d.setNotificationManager(this.oldNotifManager)},getCurrentMode:function(){return this._currentMode},getDisplayMessage:function(t,e){var n=null;switch(t){case h.AssistanceMsg.All_OK:n=c.AssistanceMsg.All_OK.Label;break;case h.AssistanceMsg.Turned_Off:n=c.AssistanceMsg.Turned_Off.Label;break;case h.AssistanceMsg.Completely_Collided:n=c.AssistanceMsg.Completely_Collided.Label;break;case h.AssistanceMsg.Partially_Collided:var i=c.AssistanceMsg.Collided_On.Label,o="";e&&(e.left&&(o+=c.AssistanceMsg.left.Label),e.right&&(o+=c.AssistanceMsg.right.Label),e.front&&(o+=c.AssistanceMsg.front.Label),e.back&&(o+=c.AssistanceMsg.back.Label)),n=i+o+"."+c.AssistanceMsg.Move_To_Other_Dir.Label;break;case h.AssistanceMsg.Stopped_Ahead:n=c.AssistanceMsg.Stopped_Ahead.Label;break;case h.AssistanceMsg.Stuck:n=c.AssistanceMsg.Stuck.Label;break;case h.AssistanceMsg.No_Floor:n=c.AssistanceMsg.No_Floor.Label;break;case h.AssistanceMsg.No_Floor_Collision_Activated:n=c.AssistanceMsg.No_Floor_Collision_Activated.Label;break;case h.AssistanceMsg.No_Floor_No_Collision:n=c.AssistanceMsg.No_Floor_No_Collision.Label;break;case h.AssistanceMsg.Collision_Already:n=c.AssistanceMsg.Collision_Already.Label;break;case h.AssistanceMsg.Select_Correct_Surface:n=c.AssistanceMsg.Select_Correct_Surface.Label;break;case h.AssistanceMsg.Wait_For_Loading:n=c.AssistanceMsg.Wait_For_Loading.Label;break;case h.AssistanceMsg.Crouch:n=c.AssistanceMsg.Crouch.Label;break;case h.AssistanceMsg.Server_Error:n=c.AssistanceMsg.Server_Error.Label;break;case h.AssistanceMsg.Unauthorized_Pod:n=c.AssistanceMsg.Unauthorized_Pod.Label;break;default:n=this._defaultAssistanceText.repeat(1)}return n},updateMessage:function(t,e){if(t!==this._currentMode){this._currentMode=t;n.getWebappsBaseUrl();var i={level:"info",title:"Collision info",message:this.getDisplayMessage(t,e),category:this.getDisplayMessage(t,e)};u.addNotif(i)}}});return h.AssistanceMsg={Default:0,All_OK:1,Turned_Off:2,Partially_Collided:3,Completely_Collided:4,Stuck:5,Stopped_Ahead:6,No_Floor:7,No_Floor_No_Collision:8,Collision_Already:9,Select_Correct_Surface:10,Wait_For_Loading:11,Crouch:12,No_Floor_Collision_Activated:13,Server_Error:14,Unauthorized_Pod:15},UWA.namespace("DS/FlyWalkUI/CollisionAssistanceUI",h)}),define("DS/FlyWalkUI/FlyWalkContextualBar",["UWA/Core","UWA/Class","DS/FlyWalkUI/WebNlsLoader","DS/FlyWalkUI/WebRscLoader","css!FlyWalkUI/FlyWalkContextualBar.css"],function(t,e,n,i,o){"use strict";var s,a=function(t){this.button&&this.button.buttonDiv&&(t?(this.button.buttonDivMAB&&this.button.buttonDivMAB.show(),this.button.buttonDiv&&this.button.buttonDiv.show()):(this.button.buttonDivMAB&&this.button.buttonDivMAB.hide(),this.button.buttonDiv&&this.button.buttonDiv.hide()))},l=function(t){this.buttonDiv&&(t?this.buttonDiv.show():this.buttonDiv.hide())},r=function(e){var o=this,a=e.content;this.id=a.id,this.token=e.token,this.visible=!0,this.btnSelectedStyle=a.btnSelectedStyleSquare?"ContextualBar_IconDiv_On_Square":"ContextualBar_IconDiv_On_Side",this.customSelectorCB=a.customSelectorCB,this.buttonDiv=new t.Element("div",{id:a.id,class:"ContextualBar_Button"}),this.buttonDivMAB=new t.Element("div",{id:a.id,class:"PlayWeb-MAB-cmd",styles:{"z-index":0}}),this.toggleSelected=function(){!0===o.buttonDiv.selected?o.setSelected(!1):!1===o.buttonDiv.selected&&o.setSelected(!0)},this.disable=function(t){this.visible=t,this.visible?o.buttonDivMAB.style.opacity=.5:o.buttonDivMAB.style.opacity=1},this.setSelected=function(t){!0===t?(o.buttonDiv.addClassName(o.btnSelectedStyle),o.buttonDivMAB.addClassName("PlayWeb-MAB-cmd-selected"),o.buttonDiv.selected=!0):(o.buttonDiv.removeClassName(o.btnSelectedStyle),o.buttonDivMAB.removeClassName("PlayWeb-MAB-cmd-selected"),o.buttonDiv.selected=!1),s&&s({id:o.id,token:o.token,state:o.buttonDiv.selected})},this.onClick=function(t){var n,i;t&&(n=t.target.offsetTop+t.target.offsetParent.offsetTop+t.target.offsetParent.offsetParent.offsetTop,i=t.target.offsetLeft+t.target.offsetParent.offsetLeft+t.target.offsetParent.offsetParent.offsetLeft),e.onClickCB({event:t,id:o.id,token:o.token,position:{top:n,left:i}}),t&&t.preventDefault&&t.preventDefault(),t&&t.stopPropagation&&t.stopPropagation()},this.buttonDiv.addEventListener("click",o.onClick),this.buttonDivMAB.addEventListener("click",o.onClick),this.buttonDiv.addEventListener("tap",o.onClick),this.buttonDivMAB.addEventListener("tap",o.onClick),window.__karma__&&(this.buttonDiv.onclick=this.onClick),this.dispose=function(){o.buttonDiv.remove(),o.buttonDivMAB.remove(),o.buttonDiv=void 0,o.buttonDivMAB=void 0,o.navigationCtx=void 0,o=void 0},this.getSelected=function(){return o.buttonDiv?o.buttonDiv.selected:null},this.updateButton=function(t){t&&"function"==typeof t&&(o.buttonDiv&&o.buttonDiv.btnCustomContent&&(o.buttonDiv.btnCustomContent.remove(),o.buttonDiv.btnCustomContent=void 0,o.buttonDivMAB.btnCustomContent.remove(),o.buttonDivMAB.btnCustomContent=void 0),o.buttonDiv.btnCustomContent=t(),o.buttonDivMAB.btnCustomContent=t(),o.buttonDiv.btnCustomContent&&(o.buttonDiv.btnCustomContent.inject(o.buttonDiv),o.buttonDivMAB.btnCustomContent.inject(o.buttonDivMAB)))};var l=a.iconSize||"Normal";i.rsc(a.rsc,{iconName:a.id,iconSize:l},function(i){if(o&&o.buttonDiv){var s=new t.Element("div",{id:"icon_"+a.id,class:e.buttonStyle||"ContextualBar_IconDiv",styles:{backgroundImage:"url("+i+")"},events:{mousemove:function(){s.style.cursor="pointer"},mouseleave:function(){s.style.cursor="default"}}}).inject(o.buttonDiv),l=new t.Element("div",{class:e.buttonStyle||"ContextualBar_IconDiv",styles:{backgroundImage:"url("+i+")"}}).inject(o.buttonDivMAB);void 0===a.selected||!1===a.selected?o.setSelected(!1):o.setSelected(!0),n.nls(a.nls,a.id,function(t){void 0!==t?(s.setAttribute("title",t.Title),l.setAttribute("title",t.Title)):(s.setAttribute("title","undefined"),l.setAttribute("title","undefined"))})}})},c=function(t){var e,n=this,i=t.onclickCB;this.button=new r({content:t,token:t.token,buttonStyle:"ContextualBar_MasterIconDiv",onClickCB:function(t){n.onClick(t)}}),this.onClick=function(t){e=setTimeout(function(){i&&i({id:t.id,token:t.token})},100)},this.dispose=function(){e&&(clearTimeout(e),e=void 0),n.button.dispose(),n=void 0}},u=function(t){var e,n=this,i=t.onclickCB;this.button=new r({content:t,token:t.token,buttonStyle:"ContextualBar_MasterIconDiv",onClickCB:function(t){n.onClick(t)}}),this.onClick=function(t){n.button.toggleSelected(),e=setTimeout(function(){i&&i({id:t.id,token:t.token,state:n.button.getSelected(),position:t.position,uncheck:n.button.toggleSelected})},100)},this.dispose=function(){e&&(clearTimeout(e),e=void 0),n.button.dispose(),n=void 0}},d=function(t){var e,n=this,i=t.onclickCB;this.button=new r({content:t,token:t.token,onClickCB:function(t){n.onClick(t)}}),this.onClick=function(t){n.button.toggleSelected(),e=setTimeout(function(){i&&i({id:t.id,token:t.token,state:n.button.getSelected(),position:t.position,uncheck:n.button.toggleSelected})},100)},this.setSelected=function(t){n.button.setSelected(t.state)},this.dispose=function(){e&&(clearTimeout(e),e=void 0),n.button.dispose(),n=void 0}},h=function(e){var n,i,o=this,s=e.onclickCB;this.buttons=[],this.buttonGroup=new t.Element("div",{id:e.groupName+"_group",class:"ContextualBar_ButtonGroup"}),this.onClick=function(t){for(var e,i=t.id,o=this,a=0;a<o.buttons.length;++a){var l=o.buttons[a];i===l.id?!1===l.getSelected()&&(l.setSelected(!0),e=l.getSelected()):l.setSelected(!1)}null!==e&&(n=setTimeout(function(){s&&s({id:t.id,token:t.token,state:!0,position:t.position,setSelected:o.setSelected})},100))},this.setSelected=function(t){if(o&&o.buttons&&o.buttons.length){for(var e=0;e<o.buttons.length;++e)t.id===o.buttons[e].id?o.buttons[e].setSelected(!0):o.buttons[e].setSelected(!1);return!0}return!1};for(var a=0;a<e.content.length;++a){var l=new r({content:e.content[a],token:e.token,onClickCB:function(t){o.onClick(t)}});!0===l.getSelected()&&(i=this.buttons.length),this.buttons.push(l),this.buttonGroup.appendChild(l.buttonDiv)}void 0===i&&this.buttons[0].setSelected(!0),o.dispose=function(){n&&(clearTimeout(n),n=void 0);for(var t=0;t<o.buttons.length;t++)o.buttons[t].dispose();o.buttonGroup.remove(),o.buttonGroup=void 0,o=void 0}},v=function(e,n){var i,o,s=this,a=e.onclickCB;this._frmWindow=n.frmWindow,this.button=new r({content:e,token:e.token,onClickCB:function(t){s.onClick(t)}}),this.deleteExpandedPanel=function(){if(o&&(clearTimeout(o),o=void 0),s.container){if(document.removeEventListener("click",s.checkOnClickExpandedPanel),document.removeEventListener("tap",s.checkOnClickExpandedPanel),document.removeEventListener("onMouseOut",s.onEventCloseExpandedPanel),document.removeEventListener("onKeyDown",s.onEventCloseExpandedPanel),s.container.buttons)for(var t=0;t<s.container.buttons.length;t++)s.container.buttons[t].dispose();s.container.remove(),s.container=void 0}},this.createExpandedPanel=function(e,n){this.container=new t.Element("div",{class:"ContextualBar_ExpandedContainer ContextualBar_Background"}).inject(s.navigationCtx.UIFrame_V1);var i=document.getElementsByClassName("ContextualBar_MainContainer").item(0);s.container.style.top=2+i.offsetTop+n.offsetTop+"px",s.container.buttons=[],g(e.content,s.container,s._frmWindow),s.checkOnClickExpandedPanel=function(t){var e="ContextualBar_ExpandedContainer ContextualBar_Background";t.target.className!==e&&t.target.parentNode&&t.target.parentNode.parentNode&&t.target.parentNode.parentNode.className!==e&&t.target.parentNode.parentNode.parentNode&&t.target.parentNode.parentNode.parentNode.className!==e&&s.closePanel()},s.onEventCloseExpandedPanel=function(t){var e=t.from[0].event;("BODY"===e.target.tagName||e.target.activeElement&&"BODY"===e.target.activeElement.tagName)&&s.closePanel()},o=setTimeout(function(){document.addEventListener("click",s.checkOnClickExpandedPanel),document.addEventListener("tap",s.checkOnClickExpandedPanel),document.addEventListener("onMouseOut",s.onEventCloseExpandedPanel),document.addEventListener("onKeyDown",s.onEventCloseExpandedPanel)},100)},this.closePanel=function(){this.button.setSelected(!1),this.deleteExpandedPanel()},this.onClick=function(t){!0===this.button.getSelected()?this.closePanel():(this.button.setSelected(!0),i=setTimeout(function(){if(a){var e=a({id:t.id,token:t.token,state:this.button.getSelected(),position:t.position});e&&t.event&&this.createExpandedPanel(e,t.event.target.parentNode)}},100))},this.setSelected=function(){},this.dispose=function(){i&&(clearTimeout(i),i=void 0),s.deleteExpandedPanel(),s.button.dispose(),s=void 0}};function g(t,e,n){for(var i=0;i<t.length;i++){var o,s=t[i];if(1===s.type)o=new h(s),e.buttons.push(o),e.appendChild(o.buttonGroup);else if(3===s.type){o=new c(s),e.masterButton=o;var a=e.querySelector("#ContextualBar_MasterButtonContainer");a.style.display="block",a.appendChild(o.button.buttonDiv),e.querySelector("#ContextualBar_MasterButtonSeparator").style.display="inline-block"}else if(4===s.type){o=new u(s);var l=e.querySelector("#ContextualBar_MasterButtonContainer");l.style.display="block",l.appendChild(o.button.buttonDiv),e.querySelector("#ContextualBar_MasterButtonSeparator").style.display="inline-block"}else if(5===s.type);else{if(0===s.type)o=new d(s);else if(2===s.type){if(0===document.getElementsByClassName("ContextualBar_ExpandedContainer").length)o=new v(s,{frmWindow:n})}o&&(e.buttons.push(o),e.appendChild(o.button.buttonDiv))}}}return e.extend({init:function(t,e){return this.navigationCtx=e.navigCtx,this.custompanelStatus=e.customPanelStatus,this.panel=this._createPanel(t,e),this.flyoutMAB=this._createFlyoutMAB(this.container.buttons,this.container.masterButton,e.mab||{}),s=e.updateSelectedCB,this.panel},_createFlyoutMAB:function(t,e,n){if(!this.navigationCtx.isWAFR_V2){var i=this.navigationCtx.frameWindow.getActionBar();if(i&&i.MAB){var o=i.MAB;if(!0===n.isDispose)o.showFlyout(0);else{var s,a,l=[];for(s=0;s<t.length;s++)if(t[s].buttons)for(a=0;a<t[s].buttons.length;a++)l.push({uxElt:t[s].buttons[a].buttonDivMAB});else t[s].button&&l.push({uxElt:t[s].button.buttonDivMAB});l.backCB=n.backCB||e&&e.button?e.button.onClick:void 0,o.showFlyout(n.flyoutLevel||1,l)}}}},_createPanel:function(e,n){var i=this.navigationCtx.UIFrame_V1,o=new t.Element("div",{class:"ContextualBar_Panel"});this.parentContainer=new t.Element("div",{class:"parentContainer_contextualBar"}).inject(o),this.container=new t.Element("div",{class:"ContextualBar_MainContainer"}).inject(this.parentContainer),this.masterButtonContainer=new t.Element("div",{id:"ContextualBar_MasterButtonContainer",styles:{display:"none"}}).inject(this.container);var s=new t.Element("div",{id:"ContextualBar_MasterButtonSeparator",styles:{display:"none"}}).inject(this.container);new t.Element("span",{class:"fonticon fonticon-menu-dot",styles:{transform:"rotate(90deg)",opacity:"0.4"}}).inject(s),n.showContextBarBackground&&this.addDefaultBackground(),this.container.buttons=[],this.container.masterButton=null,g(e,this.container,this.navigationCtx.frameWindow);var a=new t.Element("div",{id:"ContextualBar_subOptionButtonSeparator",styles:{display:"none"}}).inject(this.container);if(new t.Element("span",{class:"fonticon fonticon-menu-dot",styles:{transform:"rotate(90deg)",opacity:"0.4"}}).inject(a),this.subOptionButtonContainer=new t.Element("div",{id:"ContextualBar_subOptionButtonContainer",styles:{display:"none"}}).inject(this.container),function(t,e,n){for(var i=0;i<t.length;i++){var o,s=t[i];if(5===s.type){o=new u(s);var a=e.querySelector("#ContextualBar_subOptionButtonContainer");a.style.display="block",a.appendChild(o.button.buttonDiv),e.querySelector("#ContextualBar_subOptionButtonSeparator").style.display="inline-block"}}}(e,this.container,this.navigationCtx.frameWindow),!this.navigationCtx.isWAFR_V2){var l=this.navigationCtx.frameWindow.getActionBar();l&&l.MAB&&(l.MAB.state.visible&&(o.style.display="none"),l.MAB.onVisibilityChangeSubscribe("PlayWeb-ContextualBar",function(t){o.style.display="hidden"!==t?"none":""}))}o.inject(i),this.viewerFrame=this.navigationCtx.visViewerFrame,this._setContexualBarMidframe=function(){this.custompanelStatus||(this.container.style.top=this.viewerFrame.offsetHeight/2-this.container.clientHeight/2+"px",this.container.style.transition="top .2s ease-in")}.bind(this),this._setContexualBarMidframe(),this.viewerFrame.addEvent("resize",this._setContexualBarMidframe);var r=this.navigationCtx.immersiveFrame;return this.freeZoneResize=this._updatePanelPosition.bind(this),r.addEventListener("freeZoneResize",this.freeZoneResize),this._updatePanelPosition(),o},getFreeZoneRightOffset:function(){var t=0,e=this.navigationCtx.immersiveFrame.getDockingElement(WUXDockAreaEnum.RightDockArea),n=e.getContainedWindows();if(n&&n.length&&(n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||!n[0].isAWindowGroup())){for(var i=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,o=!1,s=0;s<i.length;s++)i[s].visibleFlag&&(o=!0);t=o&&!e.collapseDockingZoneFlag?e.dockingZoneSize+e._collapserSize:e._collapserSize}else e.interactiveDockAreaVisibleFlag&&(t=e.dockingZoneSize+e._collapserSize);return t},_updatePanelPosition:function(){if(this.container){var t=this.container,e=this.getFreeZoneRightOffset();t.setStyles({right:e+"px"}),t.style.top=this.navigationCtx.visViewerFrame.offsetHeight/2-t.clientHeight/2+"px",t.style.transition="top .2s ease-in"}},remove:function(){if(this.container&&this.container.buttons){for(var t=0;t<this.container.buttons.length;t++)this.container.buttons[t].dispose();this.container.buttons=void 0,this.container.masterButton=null,this.container.remove(),this.container=void 0}if(this.navigationCtx.immersiveFrame.removeEventListener("freeZoneResize",this.freeZoneResize),s=void 0,this.panel.remove(),this.panel=void 0,!this.navigationCtx.isWAFR_V2){var e=this.navigationCtx.frameWindow.getActionBar();e&&e.MAB&&e.MAB.onVisibilityChangeUnsubscribe("PlayWeb-ContextualBar")}this.viewerFrame.removeEvent("resize",this._setContexualBarMidframe),this.viewerFrame=void 0},setSelected:function(t){if(this.container&&this.container.buttons)for(var e=0;e<this.container.buttons.length;++e){var n=this.container.buttons[e];if(n.buttons)for(var i=0;i<n.buttons.length;++i)n.buttons[i].id===t.id&&n.setSelected(t);else n.button&&n.button.id===t.id&&n.setSelected(t)}},getSelected:function(t){if(this.container&&this.container.buttons)for(var e=0;e<this.container.buttons.length;++e){var n=this.container.buttons[e];if(n.buttons)for(var i=0;i<n.buttons.length;++i)n.buttons[i].id===t.id&&(t.state=n.buttons[i].getSelected());else n.button&&n.button.id===t.id&&(t.state=n.button.getSelected())}},updateButton:function(t){if(this.container&&this.container.buttons)for(var e=0;e<this.container.buttons.length;++e){var n=this.container.buttons[e];if(n.buttons)for(var i=0;i<n.buttons.length;++i)n.buttons[i].id===t.id&&n.buttons[i].updateButton(t.getButtonContent);else n.button&&n.button.id===t.id&&n.button.updateButton(t.getButtonContent)}},addDefaultBackground:function(){this.container.addClassName("ContextualBar_Background")},removeBackground:function(){this.container.removeClassName("ContextualBar_Background")},setButtonVisibility:function(t,e){if(this.container&&this.container.buttons)for(var n=0;n<this.container.buttons.length;++n){var i=this.container.buttons[n];if(i.buttons)for(var o=0;o<i.buttons.length;++o)i.buttons[o].id===t&&l.call(i.buttons[o],e);else i.button&&i.button.id===t&&a.call(i,e)}}})}),define("DS/FlyWalkUI/FlyWalkContextualBarManager",["DS/FlyWalkUI/FlyWalkContextualBar","UWA/Class","DS/Windows/Panel","DS/Windows/ImmersiveFrame"],function(t,e,n,i){"use strict";return e.extend({Toolbar:{New:0,Append:1},Button:{Check:0,Radio:1,Expander:2,Master:3,MasterCheck:4,SubOptionCheck:5},init:function(t){this.panelJSON=[],this.token=0,this.panel=null,this.navigationCtx=t.navigCtx,void 0===t.custompanelValue?this.custompanelValue=!1:this.custompanelValue=t.custompanelValue},addButtons:function(t,e){return this.token++,0===this.panelJSON.length?this.panelJSON[0]={}:0===e.barType&&(this.panelJSON[this.panelJSON.length]={}),this.panelJSON[this.panelJSON.length-1][this.token]={token:this.token,content:t},this._deletePanel(),this._rebuildPanel(e),this.token},setSelected:function(t){this.panel.setSelected(t)},getSelected:function(t){this.panel.getSelected(t)},updateButton:function(t){this.panel.updateButton(t)},_rebuildPanel:function(e){var i=this;if(this.panelJSON&&0!==this.panelJSON.length){var o=this.panelJSON.length,s=[];for(var a in this.panelJSON[o-1])for(var l=this.panelJSON[o-1][a].content,r=this.panelJSON[o-1][a].token,c=0;c<l.length;c++)l[c].token=r,s.push(l[c]);if(this.panel=new t(s,{navigCtx:this.navigationCtx,updateSelectedCB:function(t){i._updateSelected(t)},showContextBarBackground:e.showContextBarBackground,mab:e.mab,customPanelStatus:this.custompanelValue}),this.panel.container.buttons[0].buttons[0].setSelected(!0),void 0!==this.custompanelValue&&this.custompanelValue){var u=this.navigationCtx.visViewerFrame,d=this.navigationCtx.immersiveFrame,h=(WUXDockAreaEnum.RightDockArea,this.panel.container),v=this.panel.parentContainer;this.customWindowsPanel=new n({titleBarVisibleFlag:!0,content:v,immersiveFrame:d,allowedDockAreas:0,minWidth:h.offsetWidth+3,maxHeight:h.offsetHeight+22,width:h.offsetWidth+30,height:h.offsetHeight+16,collapsibleFlag:!1,autoCloseFlag:!0,verticallyStretchableFlag:!1,closeButtonFlag:!1,position:{my:"top right",at:"top right",offsetY:u.offsetHeight/2-h.clientHeight/2}})}}},_deletePanel:function(){this.panel&&(this.panel.remove(),this.panel=void 0,this.customWindowsPanel&&this.customWindowsPanel.close())},_deleteToken:function(t){for(var e=!1,n=this.panelJSON.length-1;n>=0;n--){for(var i in this.panelJSON[n]){if(parseInt(i)===t&&this.panelJSON[n][t]){this.panelJSON[n][t]=null,delete this.panelJSON[n][t],0===Object.keys(this.panelJSON[n]).length&&this.panelJSON.splice(n,1),e=!0;break}}if(!0===e)break}},_updateSelected:function(t){for(var e=this.panelJSON.length-1;e>=0;e--)for(var n in this.panelJSON[e]){if(parseInt(n)===t.token){var i=this.panelJSON[e][t.token];if(i){var o=i.content;if(o)for(var s=0;s<o.length;++s){var a=o[s];if(a&&a.type===this.Button.Check&&a.id===t.id)return void(a.selected=t.state);if(a&&a.type===this.Button.Radio&&a.content)for(var l=0;l<a.content.length;++l){var r=a.content[l];if(r&&r.id===t.id)return void(r.selected=t.state)}}}}}},removeButtons:function(t,e){this._deletePanel(),this._deleteToken(t),this._rebuildPanel({showContextBarBackground:!0,mab:{isDispose:e}})},dispose:function(){this._deletePanel(),this.panelJSON=void 0,this.token=void 0,this.navigationCtx=void 0},setButtonVisibility:function(t,e){this.panel&&this.panel.setButtonVisibility(t,e)}})});