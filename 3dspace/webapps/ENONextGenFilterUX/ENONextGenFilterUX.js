define("DS/ENONextGenFilterUX/views/StrDropView",["UWA/Core","UWA/Class/View"],function(e,t){"use strict";return t.extend({name:"Str-drop",_zonesCounter:{add:0,replace:0},className:function(){return this.getClassNames("-container")},setup:function(){this._addContentDiv=e.createElement("div",{class:"drop-zone add-content",html:{tag:"div",html:[{tag:"span",class:"fonticon fonticon-popup"},{tag:"p",html:"dropAddContent"}]}}),this._addContentDiv.addEventListener("drop",this._onDrop.bind(this)),this.container.addEventListener("dragover",this._onDragOver),this.container.setContent(this._addContentDiv)},show:function(e,t){console.log("RCIII show de StrDropView"),"none"===this.container.getStyle("display")&&(this.container.setStyle("width",e+"px"),"extract"===sessionStorage.getItem("ENOStr_currentDrag")||!0===t?this._addContentDiv.addClassName("full"):this._addContentDiv.removeClassName("full")),this.container.show()},hide:function(){console.log("RCIII hide de StrDropView"),this.container.hide(),this._zonesCounter.add=0,this._zonesCounter.replace=0,this.dispatchEvent("ENOStr_hide",[])},updateHeight:function(e){console.log("RCIII updateheight de StrDropView"),this._addContentDiv.setStyle("height",e+"px")},_onDragOver:function(e){console.log("RCIII dragOver de StrDropView"),e.stopPropagation(),e.preventDefault()},_onDrop:function(e){e.stopPropagation(),e.preventDefault(),this.hide();for(var t,i,n,s="function"==typeof e.dataTransfer.types.indexOf?"indexOf":"contains",o="",r=["text/searchitems","text/plain","Text"],a=e.currentTarget.hasClassName("add-content")?"add":"replace",l=0;l<r.length&&""===o;l++)("number"==typeof(n=e.dataTransfer.types[s](r[l]))&&n>=0||"boolean"==typeof n&&!0===n)&&(o=r[l]);(i=e.dataTransfer.getData(o)).length&&(a=(t=JSON.parse(i)).action?t.action:a),this.dispatchEvent("ENOStr_drop",[a,t]),sessionStorage.removeItem("ENOStr_currentDrag")}})}),define("DS/ENONextGenFilterUX/utils/NGFSecurityCtxConverter",["UWA/Class","UWA/Promise"],function(e,t){"use strict";return e.singleton({init:function(){},getSecurityContext:function(e){var t="string"==typeof e?JSON.parse(e):e;return this._prepareForStorage(t)},getPrefixedSecurityContext:function(e){return-1===e.indexOf("ctx::")?"ctx::"+e:e},_prepareForStorage:function(e){var t,i,n,s=e.pid;for(var o in e.preferredcredentials)if(e.preferredcredentials.hasOwnProperty(o)){var r=e.preferredcredentials[o];switch(o){case"collabspace":t=r.name,r.title?r.title:t;break;case"organization":i=r.name;break;case"role":n=r.name}}for(var a=this._buildSecurityContext(t,i,n),l=[],d=0;d<Object.keys(e.collabspaces).length;d++)for(var c=e.collabspaces[d],u=0;u<c.couples.length;u++){var h=this._extractCouple(c.couples[u]);l.push(h.org)}var p=1===(l=l.filter((e,t)=>l.indexOf(e)===t)).length?1:0,_=[];for(var m in e.collabspaces)if(e.collabspaces.hasOwnProperty(m)){c=e.collabspaces[m];for(var f=0;f<c.couples.length;f++){h=this._extractCouple(c.couples[f]);var g=this._buildSecurityContext(c.name,h.org,h.role),v=c.title?c.title:c.name,b={csName:v,label:this._buildDisplayString(v,p?"":h.orgNls,h.roleNls),value:g};a===g&&(b.isDefault=!0),_.push(b)}}return{userId:s,securityContext:a,cspaces:_}},_extractCouple:function(e){var t="",i="",n="",s="";for(var o in e)if(e.hasOwnProperty(o)){var r=e[o];switch(o){case"organization":t=r.name,i=r.title||t;break;case"role":n=r.name,s=r.nls||n}}return{org:t,orgNls:i,role:n,roleNls:s}},_buildSecurityContext:function(e,t,i){return i+"."+t+"."+e},_buildDisplayString:function(e,t,i){return e+" ● "+(t?t+" ● ":"")+i}})}),define("DS/ENONextGenFilterUX/utils/FilterUIService",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","UWA/Date","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/ENONextGenFilterUX/utils/NGFSecurityCtxConverter","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_supportedTypes.json","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/Utilities/TouchUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v,b,C){"use strict";var y=e.singleton(i,{TOUCH_MODE:!0,FILTER_TOUCH_CLASSNAME:"filter-no-touch-mode",MAX_DEEP_ATTRIBUTE_GROUP:4,MAX_FILTER_SPECIFICATION:4,MAX_CAR_FOR_CONFIG:100,MAX_DEEP_VOLUME_GROUP:2,ATTRIBUTE_NOT_VALUATED:"NotValuated",MAX_MRU_VALUE:5,MAX_SELECTION_PATH:50,XSS_NOT_ALLOWED:["<",">","/","@"],NAME_RULES:{notAllowedChars:['"',"#","$","%","*",",","?","\\","[","]","|",":","'",";"],maxLength:127},FILTER_RELATED_TO_ROOT:"toRoot",FILTER_RELATED_TO_ALL_REVISIONS:"toAllRevisions",FILTER_RELATED_TO_ANY_ROOT:"toAnyRoot",FILTER_ANY_OBJECT:"anyObject",init:function(){this.FILTER_TOUCH_CLASS=this.TOUCH_MODE?"":" "+this.FILTER_TOUCH_CLASSNAME,this.NAME_RULES.notAllowedChars=this.XSS_NOT_ALLOWED.concat(this.NAME_RULES.notAllowedChars),this._vocabURL=null,this._nlsNames=[],this._notificationsManager=a,l.setNotificationManager(this._notificationsManager),l.setStackingPolicy(5),this._easyAttributeDisplay=c.isActivated("easyAttribute")},updateTouchMode:function(e){b.setTouchMode(e),y.TOUCH_MODE=e,y.FILTER_TOUCH_CLASS=this.TOUCH_MODE?"":" "+this.FILTER_TOUCH_CLASSNAME},isEasyAttributeDisplayMode:function(){return this._easyAttributeDisplay},setEasyAttributeDisplayMode:function(e){this._easyAttributeDisplay=e?1:0},getPlatformServices:function(e){var t=this;return f.getOption("fromWebInWin")?new n(function(e){e()}):new n(function(i,n){f.getPlatformServices(e).then(function(){t.setOption("str_platformServices",f.getOption("str_platformServices")),i()},function(e){console.debug(" => FilterUIService / Get Platform Services failed!"),console.debug(" Error = "+e),n()})})},getPlatformServiceUrl:function(e,t){var i=this._getPlatformUrlAccordingToTenant(e);return i?i[t||"3DSpace"]:i},_getPlatformUrlAccordingToTenant:function(e){for(var t,i=e||c.getTenant(),n=this.getOption("str_platformServices"),s=0;s<n.length;s++)if(i===n[s].platformId){t=n[s];break}return t},_getURL:function(e,t){if(Array.isArray(y.getOption("str_platformServices")))return this.getPlatformServiceUrl(void 0,e)+t;throw new Error("Platform services not initialize yet")},getExpandUrl:function(e){return this._getURL(e,"/cvservlet/expand")},getFetchUrl:function(e){return this._getURL(e,this.getFetchWebSrv())},getFetchWebSrv:function(){return"/cvservlet/fetch/v2"},getMultiExpandUrl:function(e){return this._getURL(e,"/cvservlet/multiexpand")},getGoodVersionsIdsdUrl:function(e){return this._getURL(e,this.getGoodVersionsIdsWebSrv())},getGoodVersionsIdsWebSrv:function(){return"/resources/FilterInternal/ExplicitMgt/getGoodVersionsIds"},getCRSFTokenUrl:function(e){return this._getURL(e,"/resources/v1/application/E6WFoundation/CSRF")},getPnOUrl:function(e){return this._getURL(e,"/resources/modeler/pno/person/")},getMaturityNextStatesUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/maturity/getNextStates")},getMaturityChangeStateUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/maturity/changeState")},getMaturityStatesAttributesUrl:function(e){return this._getURL(e,"/resources/lifecycle/maturity/getStatesAttributes")},getVersioningUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/version/create")},getOwnershipUrl:function(e){return this._getURL(e,"/resources/v1/modeler/dslc/ownership/transfer")},getVocabularyClassesUrl:function(e){return this._getURL(e,"/resources/6WVocab/access/VocabularyClasses?name=ds6wg")},getAllSecurityContextsUrl:function(e){return this._getURL(e,"/resources/modeler/pno/person?current=true&select=preferredcredentials&select=collabspaces")},getAllSecurityContexts:function(e){return new n(function(t,i){o.authenticatedRequest(y.getAllSecurityContextsUrl(e),{headers:f.getRESTHeaders(),method:"GET",type:"json",proxy:"passport",onComplete:function(e){null!==e&&t(d.getSecurityContext(e))},onFailure:function(e){i(e)}})})},displayNotification:function(e){e.sticky=e.sticky||!1,this._notificationsManager.addNotif(e)},getPlatformId:function(){return this._getPlatformUrlAccordingToTenant().platformId},isFilterCmdHeaderActivated:function(){return c.isDebugActive("extendedCmds")},isDelayedSynthesisActive:function(){return g.getOption("delayedSynthesis")||0},checkAndGetListOfAttributesFromSelectedFilter:function(e){var t=[],i=[],s=c.getFilterUIComponents(e),o=s.length;let r={};for(var a=1;a<o;a++){s[a].toFeedUI.forEach(e=>{if("attribute"===e.criteriaType)r[e.type]||(r[e.type]=[]),"null"!==e.extension&&void 0!==e.extension||(e.extension="",e.nlsExtension=""),e.extension&&r[e.type].push(e.extension);else if("Sequence"===e.criteriaType){if("attribute"===e.sequenceType)e.allAttributes.forEach(e=>{r[e.type]||(r[e.type]=[]),"null"!==e.extension&&void 0!==e.extension||(e.extension="",e.nlsExtension=""),e.extension&&r[e.type].push(e.extension)})}})}var l=function(e,t){return new n(function(i,n){var s=c.getTenant(),o=f.getLanguage().toLowerCase();m.getExtensionsForClass(e,{tenantId:s,lang:o,apiVersion:"R2019x",onComplete:function(r){if(r&&r.extensions&&r.extensions.length){if(r.extensions.find(function(e){var i=e.curi;return i=i.substring(i.indexOf(":")+1),t===i})){var a="ds6wg:"+t;m.getPropertiesForClass(a,{tenantId:s,lang:o,apiVersion:"R2019x",onComplete:function(e){var n=e.length?e[0].properties:[];i({type:t,attributes:n})},onFailure:function(e){n({type:t,error:e})}})}}else n({type:t,error:"Extension not found for "+e})},onFailure:function(e){n({type:t,error:e})}})})},d=function(e){return new n(function(t,i){var n="ds6wg:"+e;m.getPropertiesForClass(n,{tenantId:c.getTenant(),lang:f.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(n){var s=[];n?(n.forEach(e=>{s=s.concat(e.properties)}),t({type:e,attributes:s})):y.FILTER_ANY_OBJECT===e?t({type:e,attributes:[]}):i({type:e,error:"Type Not Found"})},onFailure:function(t){i({type:e,error:t})}})})};for(const e in r)i.push(d(e)),r[e].forEach(t=>{i.push(l(e,t))});return n.allSettled(i).then(function(e){return e.forEach(e=>{"fulfilled"===e.state||"fullfilled"===e.state?t[e.value.type]=e.value.attributes:(console.log("Retrieve attributes for "+e.reason.type+"failed, reason = "+e.reason.error),t[e.reason.type]=[])}),t})},checkForBadCharacters:function(e){var t=!0;if("string"==typeof e){var i="[\\"+y.NAME_RULES.notAllowedChars.join("\\")+"]";t=!e.match(i)}return t},getAttributeButtonStyle:function(e){return{touchMode:y.TOUCH_MODE,displayStyle:"normal",showLabelFlag:!1,icon:this.getIconByName(e)}},getAttributeValidateButtonStyle:function(){var e=y.getAttributeButtonStyle("check");return e.displayStyle="normal",e},getExpandSynthesisInfos:function(e,t){var i=1===g.getOption("ProgressiveSynthesisOn")?1:0;return c.isProgressiveExpandActive()&&i?this._getProgressiveExpandSynthesis(e,t):this._getMultiExpandSynthesis(e,t)},refreshExpandSynthesisInfos:function(e,t){var i=this,s=1===g.getOption("ProgressiveSynthesisOn")?1:0;return c.isProgressiveExpandActive()&&s?new n(function(n,s){i._getProgressiveExpandSynthesis(e,{},t.CVQueryV2).then(function(e){e&&0===e.length&&i.displayNotification({level:"info",message:u.get("ExpandSynthesisWithEmptyResult")}),n(e)},function(e){s(e)})}):new n(function(n,s){i._getMultiExpandSynthesis(e,{},t.CVQuery).then(function(e){e&&0===e.length&&i.displayNotification({level:"info",message:u.get("ExpandSynthesisWithEmptyResult")}),n(e)},function(e){s(e)})})},_getMultiExpandSynthesis:function(e,i,s){var r=y.getMultiExpandUrl(e.pfServiceId);return new n(function(n,a){var l=i||{no_type_filter_bo:["PLMPort","PLMConnection"]},d="NGF_SynthesisV1-"+_.getUser().externalId+"-ENOREFS_AP-"+Date.now(),u={};if(u.label=d,u.synthesis_mode="flat",u.max_count_path="1",s)t.merge(u,s);else{var h={expand_iter:"-1"};h.root_physicalid=e.rootID,t.merge(h,l),u.union={},u.union.expand=[],u.union.expand.push(h)}var p=Date.now(),m="Expand_synthesis_duration",v=function(t,i){var n=Array.isArray(t)?t:[t],s=Array.isArray(i)?i:[i],o={};n.forEach(function(e,t){o[e]=s[t]}),c.setPerformanceTracker(e.widgetId,"NGF-Progressive_Expand_Synthesis","NGFilter_UX",o,1)},b=g.getOption("timeoutExpandSynthesis")||12e4;o.authenticatedRequest(r,{label:d,headers:f.getRESTHeaders(e.securityContext),method:"POST",data:JSON.stringify(u),type:"json",proxy:"passport",timeout:b,onComplete:function(e){var t=e.facets||[];if(0===t.length)if(e.error){var i=e.error.errors;console.log(" ==> Expand synthesis failed : "+d),i.forEach(function(e){console.log("     . "+e)}),v(m,-1),a()}else v(m,Date.now()-p),n([]);else f.getNlsInfosForFacets(t).then(function(e){for(var t=[],i=0;i<e.length;i++){var s=e[i];if(s.sixw){var o=s.sixw.split("/"),r=o.length-1;t[o[r]]||(t[o[r]]=[]),t[o[r]].push({value:s.object,nlsvalue:s.dispValue})}}var a=[];for(var l in t)t.hasOwnProperty(l)&&a.push({property:l,values:t[l].sort(function(e,t){return e&&t?e.nlsvalue<=t.nlsvalue?-1:1:0})});v(m,Date.now()-p),n(a)})},onFailure:function(e){console.log(" ==> Expand synthesis failed : "+d),console.log("     . "+e),v(m,-1),a()}})})},_getProgressiveExpandSynthesis:function(e,t,i){var r=c.getProgressiveExpandUrl(c.getTenant(),e.pfServiceId),a={},l=e.rootID,d=g.getOption("ProgressiveExpandLimitMaxPath");if(d&&-1!==d&&(a.parameters={},a.parameters.limit_max_path=d),a.label="NGF_Synthesis-"+_.getUser().externalId+"-ENOREFS_AP-"+Date.now(),a.root={physical_id:l},a.filter={},a.filter.and_not={},i?a.filter.and_not.left=i.filter:t&&t.filter?a.filter.and_not.left=t.filter:a.filter.and_not.left={all:1},t)a.filter=a.filter.and_not.left;else{a.filter.and_not.right=JSON.parse('{"sequence_filter":{"sequence":[{"uql": "((flattenedtaxonomies:\\"types/PLMPort\\") OR (flattenedtaxonomies:\\"types/PLMConnection\\"))"}]}}')}var u=[],h=g.getOption("ProgressiveSynthesisDepth")||-1;-1!==h&&u.push({truncate:{max_distance_from_prefix:h,prefix_filter:{prefix_path:[{physical_id_path:Array.isArray(l)?l:[l]}]}}}),i&&i.aggregation_processors&&i.aggregation_processors.forEach(e=>{u.push(e)});var p={synthesis:{name:"NGF_ProgressiveExpand_Synthesis",mode:"flat",group_by_facet:1,synthesis_only:1}};1===c.isRootExcludedFromSynthesis()&&(p.synthesis.exclude_root_from_count=!0),u.push(p),a.aggregation_processors=u;var m=c.buildV2GraphProperty(t);m&&(a.graph=m);var v=f.getProgressiveQueryTemplate();v.batch.expands=[a],v.outputs={synthesis:["NGF_ProgressiveExpand_Synthesis"]};var b=1===c.arePredicatesExcludedFromSynthesis()?"exclude_predicates":"facet_name";return v.outputs[b]=c.getPredicatesFacetValue(),new n(function(t,i){var n=Date.now(),a=["Expand_synthesis_duration","Expand_synthesis_count","Expand_synthesis_rootTitle","Expand_synthesis_rootId"],l=function(t,i){var n=Array.isArray(t)?t:[t],s=Array.isArray(i)?i:[i],o={};n.forEach(function(e,t){o[e]=s[t]}),c.setPerformanceTracker(e.widgetId,"NGF-Progressive_Expand_Synthesis","NGFilter_UX",o,1)},d="ProgressiveExpandSynthesis_"+s.strftime(new s,"%Y-%m-%d-%H:%M:%S"),u=g.getOption("timeoutExpandSynthesis")||12e4;o.authenticatedRequest(r,{label:d,headers:f.getRESTHeaders(e.securityContext),method:"POST",data:JSON.stringify(v),type:"json",proxy:"passport",timeout:u,onComplete:function(s){if(s.errors)console.log(" ==> Expand synthesis failed : "+d),s.errors.forEach(function(e){console.log("     . "+e.code+": "+e.reason)}),l(a,[-1,0,0,e.rootTitle,e.rootID]),i();else{var o=s.results.find(function(e){return!!e.synthesis}),r=o?o.synthesis.facets:[],c=o?o.synthesis.value:0;0===(r=r||[]).length?(l(a,[Date.now()-n,0,e.rootTitle,e.rootID]),t([])):f.getNlsInfosForFacets(r).then(function(i){for(var s=function(e){var t={};e.forEach(e=>{var i=e.nlsvalue;t[i]?t[i].values.push(e.value):(t[i]={},t[i].values=[e.value])});var i=[];return Object.keys(t).forEach(function(e){i.push({nlsvalue:e,value:1===t[e].values.length?t[e].values[0]:t[e].values,isAggregate:1===t[e].values.length?0:1})}),i},o={},r=0;r<i.length;r++){var d=i[r];if(d.sixw){var u=d.sixw.split("/"),h=u.length-1;o[u[h]]||(o[u[h]]=[]),o[u[h]].push({value:d.object,nlsvalue:d.dispValue})}}var p=[];for(var _ in o)o.hasOwnProperty(_)&&p.push({property:_,values:s(o[_]).sort(function(e,t){return e&&t?e.nlsvalue<=t.nlsvalue?-1:1:0})});l(a,[Date.now()-n,c,e.rootTitle,e.rootID]),t(p)})}},onFailure:function(t){console.log(" ==> Expand synthesis / Failure : "+d),console.log("   . "+t),l(a,[-1,0,0,e.rootTitle,e.rootID]),i()}})})},getTypesOfSynthesis:function(e){var t=[];if(e)for(var i=0;i<e.length;i++)if("ds6w:type"===e[i].property)for(var n=0;n<e[i].values.length;n++)t.push({name:e[i].values[n].value,nlsName:e[i].values[n].nlsvalue,uri:e[i].property});return t},upgradeAndCompleteQuery:function(e){return c.upgradeAndCompleteQuery(e)},resetSelectedVolumeOf3D:function(e,t,i){if(e&&t){var n={NGFUXId:e,appId:e,widgetId:t,filteredRoot:i};_.publish("NGFilter_Volume",n)}},isModelActivated:function(e){return!(!e||"1"!==e.get("isActivated"))},isCustomizedAttribute:function(e){var t=e.automatic||e.Automatic;return!(!t||"Yes"!==t)},_getRootFilterContainer:function(e){var i=document.getElementById("NGF_"+e)||document.getElementsByClassName(".f-globalFilter-container")[0];return i&&!i.getElement&&t.extendElement(i),i},getGlobalEditContainer:function(e){var t,i=this._getRootFilterContainer(e);return i&&(t=i.getElement("#globalEditContainer_"+e)||i.getElement(".globalEdit-container")),t},showFilterContainer:function(e,i){var n=this._getRootFilterContainer(e);if(n){var s=n.getElement(".globalEdit-container"),o=n.getElement(".filter-Commands"),r=n.getElement(".ActiveCriteriaView-container"),a=n.getElement(".globalFilterView-container");s&&o&&r&&a&&(i?(t.extendElement(s).hide(),t.extendElement(o).show(),t.extendElement(r).show(),t.extendElement(a).show()):(t.extendElement(s).show(),t.extendElement(o).hide(),t.extendElement(r).hide(),t.extendElement(a).hide()))}},executeFetchLogicalID:function(e,t){return this.executeFetch(e,["icon","thumbnail_2d","thumbnail_3d"],["logicalid","type","coretype","ds6w:label","flattenedtaxonomies","ds6wg:revision"],t)},executeFetch:function(e,t,i,s){return new n(function(n,r){var a={headers:f.getRESTHeaders(),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_ExecuteFetch",physicalid:e,select_file:t||[],select_predicate:i||["logicalid","type","coretype","ds6w:label","flattenedtaxonomies"]}),onComplete:function(e){n(e)},onFailure:function(e){r(e)}};o.authenticatedRequest(y.getFetchUrl(s),a)})},isSafe:function(e){var t=1;if("string"==typeof e){var i="[\\"+this.XSS_NOT_ALLOWED.join("\\")+"]";t=e.match(i)?0:1}return t},isTimeInDateActivated:function(){if(void 0===this._displayTimeInDateAttribute){var e=g.getOption("TimeInDateAttribute");this._displayTimeInDateAttribute=!(e||!c.isActivated("timeInDate"))||e}return this._displayTimeInDateAttribute},isSearchEditorActive:function(){return 0<(g.getOption("SearchEditorOn")||0)},isSearchEditorForAllActive:function(){var e=1<=g.getOption("SearchEditorForAll")?1:0;return this.isSearchEditorActive()&&e?1:0},isAsynchronousValidation:function(){if(void 0===this._isAsynchronousValidation){var e=g.getOption("AsynchronousValidation");this._isAsynchronousValidation=1===e?1:0}return this._isAsynchronousValidation},setReferenceTime:function(e){this._referenceTime=e||0},getReferenceTime:function(){return this._referenceTime||0},_setInternalReferenceTime:function(e){this._currentReferenceTime=e||0},_getInternalReferenceTime:function(){return void 0===this._currentReferenceTime?Date.now():this._currentReferenceTime},displayInternalTimeTrace:function(e,t){if(c.isDebugActive("elapsedTime")){var i=Date.now();console.log("=====> "+t+" / elapsed time (ms) = "+(i-y.getReferenceTime())+" ... "+(i-this._getInternalReferenceTime())),e&&this._setInternalReferenceTime(i)}},displayInternalDurationTrace:function(e,t){c.isDebugActive("elapsedTime")&&console.log("=====> "+e+" / elapsed time (ms) = "+t)},computeAttributesFromSynthesis:function(e){return new n(function(t,i){var n=[],s=[];e&&e.forEach(function(e){s.push(e.property)});var o=g.getOption("PredicatesForEasyAttribute",["dsw:label"]);1===c.arePredicatesExcludedFromSynthesis()&&(o=o.concat(g.getOption("PredicatesForEasyAttributeOptions",[]))),s=s.concat(o),s=[...new Set(s)],m.getResourcesInfo(s.toString(),{tenantId:c.getTenant(),lang:f.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(i){n=[],i.forEach(function(e){n.push(e)}),e&&e.length?e.forEach(function(e){var t=n.findIndex(function(t){var i=t.curi||t.uri;return e.property===i}),i=-1!==t?n[t]:void 0;if(i){let t=[];e.values.forEach(e=>{t.push(e.value)}),i.rangeValues={editable:!0,literalInfo:t}}}):n.forEach(function(e){e.rangeValues&&(e.rangeValues=void 0)}),t(n)},onFailure:function(e){i(e)}})})},checkCompatibiltyFilterRules:function(e,i,s,o,r){var a=this;return new n(function(n,l){var d=t.clone(s),u=d.rootPhysicalId;i===u?n({filterSpec:d,result:{error:0}}):y.executeFetch([i],void 0,void 0,r).then(function(t){y.executeFetch([u],void 0,void 0,r).then(function(s){var h={};h.results=(t.results||[]).concat(s.results||[]);var p="",_="";h.results.forEach(e=>{var t=e.attributes,n=t.find(function(e){return"resourceid"===e.name&&i===e.value});n&&(n=t.find(function(e){return"type"===e.name}),p=n.value),(n=t.find(function(e){return"resourceid"===e.name&&u===e.value}))&&(n=t.find(function(e){return"type"===e.name}),_=n.value)});var m=[];c.getFilterUIComponents(d).forEach((e,t)=>{0<t&&e.toFeedUI.forEach(e=>{"config"===e.criteriaType&&m.push(e)})});var f=p===_,g=m.length;if(g){var b=JSON.parse(v).conf;require([b],function(t){var s={rootid:i,tenant:c.getTenant(),url3DSpace:y.getPlatformServiceUrl(void 0,r),securitycontext:e};t.areConfigurationFiltersCompatible(s,m,function(e){var t=Array.isArray(e)?1:0,i=t?1:0,s=t?e:[],r=Array(g).fill(i);s.forEach(e=>{r[e]=0});var c={defined:m,compatibility:r};a._updateFilterWithCompatibilityRules(d,f,c,o).then(function(e){n({filterSpec:d,result:e})},function(){l()})})})}else{a._updateFilterWithCompatibilityRules(d,f,{},o).then(function(e){n({filterSpec:d,result:e})},function(){l()})}})})})},_updateFilterWithCompatibilityRules:function(e,i,s,o){var r=this;return new n(function(n,a){for(var l=c.getFilterUIComponents(e),d=[],h=0,p=l.length-1;p>=1;p--){for(var _=l[p].toFeedUI,m=p-1,f=s.compatibility?s.compatibility[m]:0,g=_.length-1;g>=0;g--){var v=_[g],b=v.criteriaType;if(h++,"attribute"===b&&i);else if("Sequence"===b&&i)v.sequenceType;else if("config"===b&&f);else if("volume"===b&&i){if(r._removeVolumeProximity(v)){0===v.allVolumes.length&&_.splice(g,1);var C=u.get(b)+"("+u.get("proximity")+")";d.push(C)}}else if("tag"===b);else{_.splice(g,1);C=u.get(b);d.push(C)}}0===_.length&&l.splice(p,1)}var F=h===d.length,A={};if(A.error=d.length?F?2:1:0,0<A.error&&(A.notApplied=d),o&&A.error){var I=F?u.get("FilterCanNotBeAppplied")+"<br>":"";I+="<span>"+u.get("ListOfCriteriaIgnored")+"</span>",d.forEach(e=>{I+="<br><span>"+t.String.format(u.get("CriterionNotSupported"),u.get(e))+"</span>"}),y.displayNotification({level:F?"error":"warning",message:I}),n(A)}else n(A)})},_removeVolumeProximity:function(e){for(var t=!1,i=e.allVolumes||[],n=i.length-1;n>=0;n--){var s=i[n];s.allVolumes?(t=this._removeVolumeProximity(s),0===s.allVolumes.length&&i.splice(n,1)):"proximity"===s.parameters.type&&(t=!0,i.splice(n,1))}return t},getRootTitle:function(e,t){var i=e;if(!e.endsWith(t)){var n=c.getDisplaySeparator();i+=t?n+t:""}return i},getIconByName:function(e){return{iconName:e,fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"1x"}},displayAttrNotFoundNotif:function(e){if(e.length){var t=function(e){var t="<span>"+u.get("ListOfAttributeIgnored")+"</span>";e.forEach(e=>{t+="<br><span> - "+(e.label?e.label:e)+"</span>"}),y.displayNotification({level:"warning",message:t})};m.getResourcesInfo(e.toString(),{tenantId:c.getTenant(),lang:f.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(e){t(e)},onFailure:function(i){console.log(i),t(e)}})}},getAliasesFromFetched:function(e,t){var i=[];return e.forEach(e=>{t.results.forEach(t=>{var n=t.attributes,s=n.find(t=>"resourceid"===t.name&&e===t.value);if(s){var o=n.find(e=>"ds6wg:revision"===e.name);(s=n.find(e=>"ds6w:label"===e.name))&&i.push((s.dispValue||s.value)+(o?" - "+o.value:""))}})}),i},openFilterPanel:function(e){_.publish("Frame3DXInfra.Open",{identifier:e})},getLengthUnitPreference:function(){return new n(function(e){let t={unit:"Millimeter",symbol:"mm",decimal:3};let i="";C.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay"]}]).then(n=>{if(n.repositories&&n.repositories.length){if(n.repositories[0].preferences){let e=n.repositories[0].preferences,o=e.find(e=>"Length"===e.name);if(o){var s=o.value;o=e.find(e=>"LengthCalcDisplay"===e.name),i={unit:C.Length[s].name,symbol:C.Length[s].symbol,decimal:o?o.value:t.decimal}}else console.log(" Init Length Unit not found !")}else console.log(" Init Length Unit, preferences not found !")}else console.log(" Init Length Unit, repositories  not found !");e(i||t)},function(i){console.log(" Init Length Unit failed, err = "+i),e(t)})})},setLengthUnit:function(e){this._lengthUnit=e},getLengthUnit:function(){return this._lengthUnit},isMigrateToAutoComplete:function(){return void 0===this._migrateToAutoComplete&&(this._migrateToAutoComplete=!!c.isActivated("UIToAutoComplete")),this._migrateToAutoComplete},getMenuPosition:function(e){return{x:e.left,y:e.bottom}},isLabelCriteriaDisplayed:function(){return 0},isLabelCriterionDisplayed:function(){return 0},getInterfacesUrl:function(e){},getPredicatesUrl:function(e){},cancelValidationAsynchronous:function(){this._isAsynchronousValidation=0}});return y}),define("DS/ENONextGenFilterUX/views/CriteriaAbstractView",["UWA/Core","UWA/Class/View","UWA/Promise","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Menu/Menu"],function(e,t,i,n,s,o){"use strict";return t.extend({isCriterionValidate:function(){return 0===s.isAsynchronousValidation()||new i(function(e){e(!0)})},viewFromMdl:function(e){},isThereCriteria:function(){return!1},setEditable:function(e){this._isEditable=e},_getCallbackToEditCriterion:function(){},isCriterionValid:function(){return!0},_getDOMElementToUpdateOnActivateChange:function(){return[]},updateModelFromRepair:function(e){return!1},buildViewFromRepairModel:function(e){},tagName:"li",setup:function(e){this._childGroupId=e.childGroupId,this._UXId=e.UXId,this._NGFUXId=e.NGFUXId,this._widgetId=e.widgetId,this._viewId="activeSubgroup_"+this._childGroupId,this.container.setAttribute("id",this._viewId),this._isEditable=e.isEditable,this._pfServiceId=e.pfServiceId||"3DSpace",this.listenTo(this.model,"onChange:isActivated",this._onActivateChange.bind(this))},isViewEdited:function(){return"edit"===this.model.get("state")},_getId:function(){return this._viewId},_checkBeforeEdit:function(){if(this._isEditable){if(this.model.get("isParentActivated")){var t=this._getCallbackToEditCriterion();t&&this.dispatchEvent("NGF_Criterion_ValidateEdited",{callback:t})}}else{this.getElement('[class*="-read"]').addClassName("filter-not-editable");var i=e.String.format(n.get("FilterIsNotEditableInContext"),n.get(this.model.get("criteriaType")));s.displayNotification({level:"info",message:i})}},_createCriterionCtxMenuWUX:function(e){if(e&&!this._critContextualMenu){var t={type:"PushItem",recId:"delete-item-DDCtx",title:n.get("deleteCriteria"),icon:s.getIconByName("trash"),action:{this:this,callback:this.destroy}};this._abstractActivateItem={type:"PushItem",recId:"activate-item-DDCtx",title:n.get("activatedCriteria"),icon:s.getIconByName("eye"),action:{this:this,callback:this._switchCriterionState}},this._abstractDeactivateItem={type:"PushItem",recId:"activate-item-DDCtx",title:n.get("deactivatedCriteria"),icon:s.getIconByName("eye-off"),action:{this:this,callback:this._switchCriterionState}},this._abstractCtxMenuRead=[{type:"PushItem",recId:"edit-item-DDCtx",title:n.get("editCriteria"),icon:s.getIconByName("pencil"),action:{this:this,callback:this._checkBeforeEdit}},this._abstractDeactivateItem,t],this._abstractCtxMenuEdit=[{type:"PushItem",recId:"cancel-item-DDCtx",title:n.get("cancelEditCriteria"),icon:s.getIconByName("undo"),action:{this:this,callback:this._cancelEditCriteria}},t],this._critContextualMenu=this._abstractCtxMenuRead;var i=this;e.addEventListener("click",function(e){if(i.model.get("isParentActivated")){e.stopPropagation();var t=e.target.getBoundingClientRect();o.show(i._critContextualMenu,{position:s.getMenuPosition(t)})}})}},_switchCriterionState:function(){var e=s.isModelActivated(this.model)?"0":"1";this.model.set("isActivated",e)},_onActivateChange:function(e,t){var i=s.isModelActivated(this.model);if(this._critContextualMenu){var n=this._critContextualMenu.findIndex(e=>"activate-item-DDCtx"===e.recId);-1!==n&&(this._critContextualMenu[n]=i?this._abstractDeactivateItem:this._abstractActivateItem)}for(var o=this._getDOMElementToUpdateOnActivateChange(),r=o.length,a=0;a<r;a++)o[a]&&(i?o[a].removeClassName("f-criterion-deactivated"):o[a].addClassName("f-criterion-deactivated"));this.dispatchEvent("NGF_Criterion_Activated",{})},_hideFilterContainer:function(){s.showFilterContainer(this._UXId,!1)},_showFilterContainer:function(){s.showFilterContainer(this._UXId,!0)},_setContextualMenu:function(e){this._critContextualMenu&&("read"===e?(this._critContextualMenu=this._abstractCtxMenuRead,this._critContextualMenu[1]=s.isModelActivated(this.model)?this._abstractDeactivateItem:this._abstractActivateItem):"edit"===e&&(this._critContextualMenu=this._abstractCtxMenuEdit))},_onEditAttribute:function(){this.model.get("isParentActivated")&&s.isModelActivated(this.model)&&this._checkBeforeEdit()}})}),define("DS/ENONextGenFilterUX/utils/FilterPersistencyServices",["UWA/Class","UWA/Core","UWA/Class/Options","UWA/Promise","UWA/Date","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,n,s,o,r,a,l,d,c){"use strict";var u=e.singleton(i,{init:function(){},namesRetrievedFiltersOnRoot:[],getCreateFilterUrl:function(){var e;return Array.isArray(a.getOption("str_platformServices"))&&(e=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/createFilter"),e},getUpdateFilterUrl:function(){var e;return Array.isArray(a.getOption("str_platformServices"))&&(e=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/updateFilter"),e},getDefaultFilterNameUrl:function(e){var t;return Array.isArray(a.getOption("str_platformServices"))&&(t=a.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/getDefaultName"),t},saveFilter:function(e,t,i,s,r,a,l,d){var u=this,h={filterName:t,filterDescription:i,rootPhysicalId:r,filterUIComponents:l,filterTitle:s,rootServiceId:d};return new n(function(t,i){o.authenticatedRequest(u.getCreateFilterUrl(),{headers:c.getRESTHeaders(e),method:"POST",data:JSON.stringify(h),type:"json",proxy:"passport",onComplete:function(e){t(e)},onFailure:function(e){t(e)}})})},updateFilter:function(e,t,i,s,r,a,l){var d=this,u={filterName:t,filterDescription:i,filterUIComponents:a,filterTitle:s,filterId:l};return new n(function(t,i){o.authenticatedRequest(d.getUpdateFilterUrl(),{headers:c.getRESTHeaders(e),method:"POST",data:JSON.stringify(u),type:"json",proxy:"passport",onComplete:function(e){t(e)},onFailure:function(e){t(e)}})})},getDefaultFilterName:function(e,t){var i=this;return new n(function(n,s){o.authenticatedRequest(i.getDefaultFilterNameUrl()+"?filterName="+encodeURIComponent(e),{headers:c.getRESTHeaders(t),method:"GET",type:"json",proxy:"passport",onComplete:function(e){n(e.defaultName)},onFailure:function(e){s(e)}})})},keepToFeedConfig:function(e){var t={};return t.criteriaType=e.get("criteriaType"),t.displayExpression=e.get("displayExpression"),t.expression=e.get("expression"),e.has("config_filter_id")?t.config_filter_id=e.get("config_filter_id"):t.config_filter=e.get("config_filter"),a.isModelActivated(e)||(t.isActivated=e.get("isActivated")),t},keepToFeedAttr:function(e,t){var i={};i.criteriaType=e.get("criteriaType"),i.type=e.get("type"),!1===e.get("Keep")&&(i.Keep=e.get("Keep")),a.isModelActivated(e)||(i.isActivated=e.get("isActivated")),""!==e.get("extension")&&(i.extension=e.get("extension"));var n=e.get("allAttributes");if(n&&n.length){var s=this._keepToFeedAttr(n[0],t);i.allAttributes=[],i.allAttributes.push(s)}return i},_keepToFeedAttr:function(e,t){for(var i=e.get("allAttributes")||[],n=i.length,s=[],o=0;o<n;o++){var r,a=i[o];a.get("allAttributes")?r=this._keepToFeedAttr(a,t):a.get("attribute")?(r={type:a.get("attribute").type,uri:a.get("attribute").uri,attrOp:a.get("attrOp")},a.get("attrValue")?r.attrValue=a.get("attrValue"):a.get("attrValue_1")&&(r.attrValue_1=a.get("attrValue_1"),r.attrValue_2=a.get("attrValue_2"))):t&&t.keepEmpty&&(r={}),r&&s.push(r)}return{combination:e.get("combination"),allAttributes:s}},keepToFeedContext:function(e,t){var i={},n=e.get("addedNodesList")&&e.get("addedNodesList").length,s=e.get("excludedNodesList")&&e.get("excludedNodesList").length;return n||s?(i.criteriaType=e.get("criteriaType"),a.isModelActivated(e)||(i.isActivated=e.get("isActivated")),n&&(!1===e.get("AddNodeActivated")&&(i.AddNodeActivated=e.get("AddNodeActivated")),i.addedNodesList=e.get("addedNodesList")),s&&(!1===e.get("ExcludeNodeActivated")&&(i.ExcludeNodeActivated=e.get("ExcludeNodeActivated")),i.excludedNodesList=e.get("excludedNodesList"))):t&&t.keepEmpty&&(i.criteriaType=e.get("criteriaType"),i.AddNodeActivated=e.get("AddNodeActivated"),i.addedNodesList=e.get("addedNodesList"),i.ExcludeNodeActivated=e.get("ExcludeNodeActivated"),i.excludedNodesList=e.get("excludedNodesList")),i},keepToFeedTag:function(e){var t={},i=e.get("tagData")||void 0;if(i){var n=i.allfilters?Object.keys(i.allfilters):[],s=i.localfilters?Object.keys(i.localfilters):[],o=n.length,r=s.length;(o||r)&&(t.criteriaType=e.get("criteriaType"),o&&(t.allfilters={},t.allfilters=i.allfilters),r&&(t.localfilters={},t.localfilters=i.localfilters))}return t},keepToFeedVolume:function(e){var t={};t.criteriaType=e.get("criteriaType"),a.isModelActivated(e)||(t.isActivated=e.get("isActivated"));var i=e.get("allVolumes");if(i&&i.length){var n=this._keepToFeedVolume(i[0]);t.allVolumes=[],t.allVolumes.push(n)}return t},_keepToFeedVolume:function(e){for(var i=d.get("defaultVolumeName"),n=e.get("allVolumes")||[],s=n.length,o=[],r=0;r<s;r++){var l,c=n[r];if(c.get("allVolumes"))l=this._keepToFeedVolume(c);else{let e=(l={parameters:t.clone(c.get("parameters"))}).parameters,n=e.type;"box"===n?(e.corner_min=e.corner_min.map(Number),e.corner_max=e.corner_max.map(Number),e.transformation_matrix=e.transformation_matrix.map(Number)):"sphere"===n?(e.center=e.center.map(Number),e.radius=parseFloat(e.radius)):"proximity"!==n&&"space"!==n||(e.distance=parseFloat(e.distance)),a.isModelActivated(c)||(l.isActivated=c.get("isActivated"));var u=c.get("displayName");-1!==u.startsWith(i+" ")&&(l.displayName=u),l.parameters&&delete l.parameters.root_path_alias}o.push(l)}return{combination:e.get("combination"),allVolumes:o}},keepToFeedSequence:function(e,t){var i={};return"attribute"===e.get("sequenceType")&&(i=this._keepToFeedAttrSeq(e,t)),i},_keepToFeedAttrSeq:function(e,t){var i=[],n=e.get("subGroupCollection")._models;n&&n.forEach(function(e){var n=u.keepToFeedAttr(e,t);i.push(n)});var s={};return s.criteriaType=e.get("criteriaType"),s.sequenceType=e.get("sequenceType"),s.allAttributes=i,s},retrieveAllRoots:function(e){var i={label:"NGF_GetAllRevisions_"+t.Date.strftime(new s,"%Y-%m-%d-%H:%M:%S"),query:"(logicalid:"+e.join(" OR logicalid:")+")",with_indexing_date:!0,with_synthesis:!1,with_nls:!1,tenant:l.getTenant()};return new n(function(e,t){o.authenticatedRequest(l.getFederateSearchUrl(l.getTenant()),{headers:c.getRESTHeaders(),method:"POST",data:JSON.stringify(i),type:"json",proxy:"passport",onComplete:function(t){var i=[];t.infos.nresults&&t.results.forEach(function(e){e.attributes.forEach(function(e){"resourceid"===e.name&&i.push(e.value)})}),e(i)},onFailure:function(e){t(e)}})})},retrieveAllFilters:function(e){var t={relations:["advancedfilter_root_from"],attributes_for_detailview:["physicalid"],countmanagement:!1,debug:!1,ids:e,trueREST:!0,displayTime:!1};return new n(function(e,i){o.authenticatedRequest(l.getGetEcoSystemUrl(l.getTenant()),{headers:c.getRESTHeaders(),method:"POST",data:JSON.stringify(t),type:"json",proxy:"passport",onComplete:function(t){var i=[];t.New.Objects&&t.New.Objects.forEach((e,t)=>{"ENOStrRefinementSpecification"===e.type&&i.push({filterId:e.id,name:e["ds6w:identifier"],filterTitle:e.name})}),e(i)},onFailure:function(e){i(e)}})})}});return u}),define("DS/ENONextGenFilterUX/utils/EditToReadManager",["UWA/Core","UWA/Class","UWA/Class/Options","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/utils/FilterUIService","UWA/Date","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r){"use strict";return t.singleton(i,{init:function(){},toStringAttribute:function(e){var t,i,s=this.getAttributeValues(e),o="";if(s.inSequence||(o=!0===s.Keep?"Keep":"Remove"),!s.nlsType)return e.set("state","edit"),{level:"error",message:n.get("attrNotCompleted"),sticky:!1};t=s.nlsType,s.nlsExtension&&(i=s.nlsExtension);var r=e.get("allAttributes")[0],a=this._buildAttributeString(r),l=n.get(o.toLowerCase())+" "+n.get(t);i&&(l+=" ("+n.get("extension")+" : "+i+") ");var d=[];d.push(l);var c=a.length;if(0<c){if(1<c||1===c&&Array.isArray(a[0]))if(0===this._isSingleGroupOfAttribute(r)){var u=" "+("all"===r.get("combination")?n.get("AllCombination"):n.get("AnyCombination"));u+=" "+n.get("FollowingCombination"),l+=" "+n.get("with")+" "+u}else{u=a[0].shift();var h=[];a[0].forEach(function(e){h.push(e)});for(var p=1;p<a.length;p++)h.push(a[p]);c=(a=h).length,l+=" "+u}else l+=" "+n.get("with")+" :";if(d[0]=l,1!==c||Array.isArray(a[0])){var _=d.concat(a);d=_}else d.push(" "+a[0])}return d},toStringContext:function(t){var i=t.get("addedNodesList"),s=t.get("excludedNodesList"),o=i.length,a=s.length,l="";if(o||a){var d,c;r.isActivated("newSelectionRead")?(d="",c=""):(d='<span class="f-criterion-deactivated">',c="</span>");var u=1===o?"ContextReadViewSingleAdd":"ContextReadViewMultiAdd",h=o+" "+n.get(u);h=t.get("AddNodeActivated")?h:d+h+c;var p=1===a?"ContextReadViewSingleExclude":"ContextReadViewMultiExclude",_=a+" "+n.get(p);_=t.get("ExcludeNodeActivated")?_:d+_+c,o>0&&a>0?l+=h+", "+_:o>0?l+=h:a>0&&(l+=_)}e.createElement("span",{}).addClassName("fonticon fonticon-dropbox");var m=[];return m.push(l),m},_isSingleGroupOfAttribute:function(e){var t=0,i=this.getAttributeValues(e).allAttributes||[];return 1===i.length&&this.getAttributeValues(i[0]).allAttributes&&(t=1),t},configToString:function(e){return e.get("displayExpression")},volumeToString:function(e){var t=e.get("allVolumes")[0],i=this._volumeAsString(t),s=[],o=i.length;if(0<o){var r="";if(1<o||1===o&&Array.isArray(i[0]))if(r=n.get("with"),0===this._isSingleGroupOfVolume(t)){var a=" "+("all"===t.get("combination")?n.get("AllCombination"):n.get("AnyCombination"));r+=a+=" "+n.get("FollowingCombination")}else{o=i[0].length;a=i[0].shift();var l=[];i[0].forEach(function(e){l.push(e)});for(var d=1;d<i.length;d++)l.push(i[d]);i=l,r=a}if(s[0]=r,1!==o||Array.isArray(i[0])){var c=s.concat(i);s=c}else s[0]+=" "+i[0]}return s},_volumeAsString:function(e){for(var t=[],i=e.get("allVolumes")||[],s=0;s<i.length;s++){var o=i[s];if(0,o.get("allVolumes")){var r=n.get("with")+" ";r+="all"===o.get("combination")?n.get("AllCombination"):n.get("AnyCombination"),r+=" "+n.get("FollowingCombination");var a=this._volumeAsString(o);a.unshift(r),t.push(a)}else{var l=o.get("displayName");l&&l.length&&t.push(l)}}return t},_isSingleGroupOfVolume:function(e){var t=0,i=e.get("allVolumes")||[];return 1===i.length&&i[0].get("allVolumes")&&(t=1),t},groupToString:function(e){var t=e.get("subGroupCollection"),i=[];return t.forEach(function(e,t){i.push(e.criterionToHTML())}),i.join("")},_buildAttributeString:function(e){for(var t=[],i=this.getAttributeValues(e),s=i.allAttributes||[],o=0;o<s.length;o++){var r=s[o];if(void 0===(i=this.getAttributeValues(r)).allAttributes){var a=this._buildSingleAttribute(r);a.length&&t.push(a)}else{var l=n.get("with")+" ";l+="all"===i.combination?n.get("AllCombination"):n.get("AnyCombination"),l+=" "+n.get("FollowingCombination");var d=this._buildAttributeString(r);d.unshift(l),t.push(d)}}return t},getAttributeValues:function(e){var t={};return void 0!==e&&(t={Keep:e.get("Keep"),type:e.get("type"),nlsType:e.get("nlsType"),extension:e.get("extension"),nlsExtension:e.get("nlsExtension"),inSequence:e.get("inSequence")},void 0===e.get("combination")?(t.attribute=e.get("attribute"),t.nlsAttribute=e.get("nlsAttribute"),t.attrOp=e.get("attrOp"),t.nlsAttrOp=e.get("nlsAttrOp"),t.attrValue=e.get("attrValue"),t.attrValue_1=e.get("attrValue_1"),t.attrValue_2=e.get("attrValue_2")):(t.combination=e.get("combination"),t.allAttributes=e.get("allAttributes"))),t},setAttributeValues:function(e,t){void 0!==e&&void 0!==t&&(e.set("Keep",t.Keep),e.set("type",t.type),e.set("nlsType",t.nlsType),e.set("extension",t.extension),e.set("nlsExtension",t.nlsExtension),e.set("inSequence",t.inSequence),void 0===t.combination?(e.set("attribute",t.attribute),e.set("nlsAttribute",t.nlsAttribute),e.set("attrOp",t.attrOp),e.set("nlsAttrOp",t.nlsAttrOp),e.set("attrValue",t.attrValue),e.set("attrValue_1",t.attrValue_1),e.set("attrValue_2",t.attrValue_2)):(e.set("combination",t.combination),e.set("allAttributes",t.allAttributes)))},_buildSingleAttribute:function(e){var t="",i=this.getAttributeValues(e),s=i.attribute?i.attribute.type:void 0,o=i.nlsAttribute||"",r=i.attrOp||"",a="";if(void 0!==i.attrValue){a=i.attrValue;var l=i.attribute.rangeValues;a=l?this._buildAttributeValue(s,a,l,r,", "):"boolean"===s?"true"===a?n.get("true"):n.get("false"):this._buildAttributeValue(s,a,l,r,", "),"string"===s&&(a=a.replaceAll?a.replaceAll("<","&lt;"):a.split("<").join("&lt;"))}if(r&&"between"===r&&void 0!==i.attrValue_1){var d=[i.attrValue_1,i.attrValue_2],c=" "+n.get("AND").toLowerCase()+" ";a=this._buildAttributeValue(s,d,i.attribute.rangeValues,r,c)}return void 0!==o&&o.length&&(t=o+" "+n.get(r),-1===["isEmpty","isNotEmpty"].indexOf(r)&&(t+=a?" "+a:"<span class=f-criterion-unset> "+n.get("NoValueEntered")+"</span>")),t},_buildAttributeValue:function(t,i,r,a,l){var d=Array.isArray(i)?i:[i],c=d.length,u=[];if(r)for(var h=r.literalInfo?r.literalInfo:r,p=h.length,_=0;_<c;_++){for(var m=0,f=0;f<p;f++){var g=h[f],v="integer"===t||"real"===t?String(d[_]):d[_];if(g.isAggregate&&Array.isArray(v)?g.value.sort().toString()===v.sort().toString()?1:0:g.value===v?1:0){var b=g.nlsValue||g.nlsvalue;u.push(b||g.value),m=1;break}}s.isSearchEditorActive()&&!m&&u.push(d[_])}if(0===u.length){var C={year:"numeric",month:"short",day:"numeric"};s.isTimeInDateActivated()&&"on"!==a&&(C=e.merge(C,{hour:"2-digit",minute:"2-digit",second:"2-digit"}));for(_=0;_<c;_++){var y=d[_];if("dateTime"===t)y=new o(o.parse(y)).toLocaleString(void 0,C);u.push(y)}}var F=u.join(l);return 1<u.length&&"between"!==a&&(F=n.get("AnyOf")+"  "+F),F}})}),define("DS/ENONextGenFilterUX/utils/CVManager",["UWA/Core","UWA/Class","UWA/Class/Options","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","UWA/Date"],function(e,t,i,n,s,o){"use strict";return t.singleton(i,{init:function(){},buildCVQueryForContext:function(e,t){var i;if("root_path_physicalid"==t){if(i=!1,e.get("AddNodeActivated")){var n=e.get("addedNodesList");if(a=n.length){for(var s="[",o=0;o<a;o++)s+='["'+n[o].toString().split(",").join('","')+'"],';i=s=s.slice(0,-1)+"]"}}}else{i="";var r=[];if(e.get("ExcludeNodeActivated")){var a=(r=e.get("excludedNodesList")).length,l="[";for(o=0;o<a;o++)l+='["'+r[o].toString().split(",").join('","')+'"],';l=l.endsWith(",")?l.slice(0,-1):l,l+="]",r.length>0&&(i='"find_path_filter":[{"option": ["remove"],"path_physicalid":'+l+"}]")}}return i},buildCVQueryForAttribute:function(e,t){var i="";i=e.get("Keep")?!1===t||"false"===t?"seq_cut":"seq_keep":"seq_remove";var n=e.get("type"),s="";e.get("extension")&&(s=e.get("extension"));var o="",r=e.get("allAttributes");r&&r.length&&(o=(o=this._buildAttributeQuery(r[0])).length?o:"#all");var a="";return o.length&&(a='{"option":["'+i+'"],"definition":[{"type_filter_bo":["'+n+'"],"type_filter_rel":["'+n+'"],"q.query":"'+o,s.length&&(a+=" AND [ds6w:kind]:"+s),a+='"}]}'),a},buildCVQueryForConfig:function(e){var t="";return e&&(t='"config_filter":"'+e+'"'),t},buildCVQueryForGroup:function(e,t){var i="",s=e.get("subGroupCollection")._models;if("attribute"===e.get("sequenceType")){var o=s&&s.length?s[0]:void 0;if(o){var r='{"option":["'+(o.get("Keep")?"false"===t?"seq_cut":"seq_keep":"seq_remove")+'"],"definition":[',a=this,l="";s.forEach(function(e){if(n.isModelActivated(e)){var t=e.get("type"),i=e.get("extension")||"",s="",o=e.get("allAttributes");o&&o.length&&(s=(s=a._buildAttributeQuery(o[0])).length?s:"#all"),s.length&&(l+='{"type_filter_bo":["'+t+'"],"type_filter_rel":["'+t+'"],"q.query":"'+s,i.length&&(l+=" AND [ds6w:kind]:"+i),l+='"},')}}),l.length&&(i=r+(l=l.slice(0,-1))+"]}")}}return i},buildCVQueryForVolume:function(e){var t="",i="",n=e.get("allVolumes");return n&&n.length&&(i=this._buildVolumeQuery(n[0])),i.length&&(t='"volume_filter":{'+i+"}"),t},buildCVQueryForTags:function(e){var t=[],i=e.get("tagData")||{allfilters:e.get("allfilters")||void 0};if(Object.keys(i.allfilters).length||Object.keys(i.localfilters).length)for(var n in i.allfilters)if(i.allfilters.hasOwnProperty(n)){var s={option:["seq_keep"],definition:[]},o="",r=Object.keys(i.allfilters[n]).length,a=0;for(var l in i.allfilters[n]){var d;if(i.allfilters[n].hasOwnProperty(l))-1!==n.lastIndexOf("/")&&(d=n.substring(n.lastIndexOf("/")+1)),o+="["+d+"]:"+(Array.isArray(i.allfilters[n][l].object)?i.allfilters[n][l].object.join("/"):i.allfilters[n][l].object),o+=++a<r?" OR ":""}s.definition.push({"q.query":o}),t.push(s)}return t},_buildVolumeQuery:function(e){var t="",i="",s="",o=e.get("combination");o&&(t='"'+("all"===o?"and":"or")+'":[',i="{",s="}");for(var r,a=e.get("allVolumes")||[],l=a.length,d=0;d<l;d++){var c=(h=a[d]).get("parameters");if(c&&void 0!==c.maybe3d&&n.isModelActivated(h)){r=c.maybe3d;break}}var u=0;for(d=0;d<l;d++){var h=a[d];if(n.isModelActivated(h))u++,t+=h.get("allVolumes")?i+this._buildVolumeQuery(h,r)+s:i+this._buildSingleVolumeQuery(h,r)+s,t+=","}return u?(t=t.slice(0,t.length-1),o&&(t+="]")):t="",t},_buildSingleVolumeQuery:function(e,t){var i="",n=e.get("parameters");if(n){var s="";switch(n.type){case"box":s='"box":{',s+='"corner_min":["'+n.corner_min.toString().split(",").join('","')+'"],',s+='"corner_max":["'+n.corner_max.toString().split(",").join('","')+'"],',s+='"transformation_matrix":["'+n.transformation_matrix.toString().split(",").join('","')+'"],';break;case"sphere":s='"sphere":{',s+='"center":["'+n.center.toString().split(",").join('","')+'"],',s+='"radius":"'+n.radius+'",';break;case"proximity":var o=n.root_path_physicalid[0];s='"assemblyshape":{',s+='"root_path_physicalid":[["'+(o=Array.isArray(o)?o:[o]).toString().split(",").join('","')+'"]],',s+='"distance":"'+n.distance+'",';break;case"space":o=n.root_path_physicalid[0];o=Array.isArray(o)?o:[o];var r=n.distance?n.distance:"0.000";s='"assemblyshape":{',s+='"root_path_physicalid":[["'+o.toString().split(",").join('","')+'"]],',s+='"distance":"'+r+'",'}if(""!==s){if(s+='"intersection_mode":"'+n.intersection_mode+'"',void 0!==t)s+=",",s+='"maybe3d":"'+(1===t?"true":"false")+'"';s+="}"}i=s}return i},_buildAttributeQuery:function(e){for(var t=e.get("allAttributes")||[],i=t.length,n="all"===e.get("combination")?" AND ":" OR ",s=i?"":"#all",o=0;o<i;o++){var r,a=t[o];void 0===a.get("allAttributes")?(r=this._buildSingleAttribute(a)).length&&(s+=r):(r=this._buildAttributeQuery(a)).length&&(s+=" ("+r+")"),r.length&&(s+=n)}return s=s.endsWith(n)?s.slice(0,-n.length):s},_buildSingleAttribute:function(e){var t="",i=!0;if(void 0===e.get("attrValue")&&void 0===e.get("attrValue_1")&&void 0===e.get("attrValue_2")&&(i=!1),i)switch(e.get("attribute")?e.get("attribute").type:e.get("type")){case"string":t+=this._buildStringAttr(e);break;case"boolean":t+=this._buildBooleanAttr(e);break;case"number":case"integer":case"real":t+=this._buildNumericalAttr(e);break;case"dateTime":case"timestamp":t+=this._buildDateAttr(e)}return t},_buildDateAttr:function(e){var t="",i=e.get("attribute")?e.get("attribute").uri:e.get("uri"),s=e.get("attrOp"),o=[];if("between"!==s){var r=e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED;o=Array.isArray(r)?r:[r]}else{var a=e.get("attrValue_1")||n.ATTRIBUTE_NOT_VALUATED,l=e.get("attrValue_2")||n.ATTRIBUTE_NOT_VALUATED;o.push(a),o.push(l)}for(var d="",c=o.length,u=0;u<c;u++){var h='\\"'+o[u]+'\\"';switch(d=" OR ",s){case"on":t+="["+i+"] = "+h;break;case"after":t+="["+i+"] >= "+h;break;case"strictlyAfter":t+="["+i+"] > "+h;break;case"before":t+="["+i+"] <= "+h;break;case"strictlyBefore":t+="["+i+"] < "+h;break;case"between":0===u?(t+="["+i+"] >= "+h,d=" AND "):t+="["+i+"] <= "+h}t+=d}return t.length&&(t="("+(t=t.endsWith(d)?t.slice(0,-d.length):t)+")"),t},_buildNumericalAttr:function(e){var t="",i=e.get("attribute")?e.get("attribute").uri:e.get("uri"),s=e.get("attrOp"),o=[];if("between"!==s){var r=e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED;o=Array.isArray(r)?r:[r]}else{var a=e.get("attrValue_1")||n.ATTRIBUTE_NOT_VALUATED,l=e.get("attrValue_2")||n.ATTRIBUTE_NOT_VALUATED;o.push(a),o.push(l)}for(var d="",c=o.length,u=0;u<c;u++){var h=o[u];switch(d=" OR ",s){case"equals":t+="["+i+"] = "+h;break;case"notEqual":t+="["+i+"] != "+h;break;case"lowerThan":t+="["+i+"] <= "+h;break;case"greaterThan":t+="["+i+"] >= "+h;break;case"strictlyLowerThan":t+="["+i+"] < "+h;break;case"strictlyGreaterThan":t+="["+i+"] > "+h;break;case"between":0===u?(t+="["+i+"] >= "+h,d=" AND "):t+="["+i+"] <= "+h}t+=d}return t.length&&(t="("+(t=t.endsWith(d)?t.slice(0,-d.length):t)+")"),t},_buildBooleanAttr:function(e){return"("+("["+(e.get("attribute")?e.get("attribute").uri:e.get("uri"))+"]:"+(e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED))+")"},_buildStringAttr:function(e){for(var t="",i=e.get("attribute")?e.get("attribute").uri:e.get("uri"),s=e.get("attrOp"),o=e.get("attrValue")||n.ATTRIBUTE_NOT_VALUATED,r=Array.isArray(o)?o:[o],a=" OR ",l=r.length,d=0;d<l;d++){var c=r[d];switch(s){case"equals":t+="["+i+']:\\"'+c+'\\"';break;case"notEqual":t+="(NOT ["+i+"]:("+c+"))";break;case"contains":t+="["+i+"]:*"+c+"*";break;case"notContains":t+="(NOT ["+i+"]:(*"+c+"*))";break;case"startsWith":t+="["+i+"]:"+c+"*";break;case"endsWith":t+="["+i+"]:*"+c}t+=a}return t.length&&(t="("+(t=t.endsWith(a)?t.slice(0,-a.length):t)+")"),t}})}),define("DS/ENONextGenFilterUX/models/CriterionModel",["UWA/Core","UWA/Class/Model","DS/ENONextGenFilterUX/utils/CVManager","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/ENONextGenFilterUX/utils/FilterPersistencyServices"],function(e,t,i,n,s){"use strict";return t.extend({defaults:{name:"elementaryCriteria-model",isActivated:"1",isParentActivated:1},setup:function(){},toCVQuery:function(e){var t,n=this.get("criteriaType");return"attribute"===n?t=i.buildCVQueryForAttribute(this,e):"config"===n?t=i.buildCVQueryForConfig(this.get("config_filter")):"context"===n?t=i.buildCVQueryForContext(this,e):"tag"===n?t=i.buildCVQueryForTags(this):"volume"===n?t=i.buildCVQueryForVolume(this,e):console.log(" !! CriterionModel.toCVQuery : non supported case - "+n),t},criterionToString:function(){var e,t=this.get("criteriaType");return"attribute"===t?e=n.toStringAttribute(this):"config"===t?e=n.configToString(this):"context"===t?e=n.toStringContext(this):"volume"===t?e=n.volumeToString(this):console.log(" !! CriterionModel.criterionToString : non supported case - "+t),e},criterionToHTML:function(){var e="",t=this.get("criteriaType");if("attribute"===t){var i=this.criterionToString(this),s=this.get("isActivated"),o="0"===s?"f-criterion-deactivated":"";e+="1"===s?"<li>"+i[0]+'<ul class="attrRead-multi-attr"><div>':'<li><span class="'+o+'">'+i[0]+'</span><ul class="attrRead-multi-attr '+o+'"><div>',1<i.length&&(i.shift(),e+=this._getAttributeHTML(i)),e+="</div></ul></li>"}else"config"===t?e=n.configToString(this):"context"===t?e=n.toStringContext(this):"volume"===t?e=n.volumeToString(this):console.log(" !! CriterionModel.criterionToString : non supported case - "+t);return e},keepComponentsToFeedUI:function(e,t){var i={},n=this.get("criteriaType");return"attribute"===n?i=s.keepToFeedAttr(this,t):"config"===n?i=s.keepToFeedConfig(this):"context"===n?i=s.keepToFeedContext(this,t):"volume"===n?i=s.keepToFeedVolume(this):"tag"===n?i=s.keepToFeedTag(this):console.log(" !! CriterionModel.keepToFeed : non supported case - "+n),i},_getAttributeHTML:function(e){for(var t="",i=0;i<e.length;i++)if(Array.isArray(e[i])){var n=e[i];t+="<li>"+n[0],t+="<ul>",n.shift(),t+=this._getAttributeHTML(n),t+="</ul></li>"}else t+="<li>"+e[i]+"</li>";return t}})}),define("DS/ENONextGenFilterUX/models/GroupModel",["UWA/Class/Model","DS/ENONextGenFilterUX/utils/CVManager","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX"],function(e,t,i,n,s){"use strict";return e.extend({defaults:{state:"edit",isActivated:"1",isParentActivated:1,_name:s.get("defaultGroupName"),_rootId:"",_number:0},setup:function(e){},toCVQuery:function(e){var i="";return"Sequence"===this.get("criteriaType")&&(i=t.buildCVQueryForGroup(this,e)),i},groupToString:function(){return i.groupToString(this)},keepComponentsToFeedUI:function(e,t){var i={};return"Sequence"===this.get("criteriaType")&&(i=n.keepToFeedSequence(this,t)),i},setActivated:function(e){this.set("isActivated",e)},isActivated:function(){return this.get("isActivated")},setFilterSpecificationName:function(e){this.set("_name",e)},getFilterSpecificationName:function(){return this.get("_name")},setFilterSpecificationRoot:function(e){this.set("_rootId",e)},getFilterSpecificationRoot:function(){return this.get("_rootId")},setFilterSpecificationIndex:function(e){this.set("_number",e)},getFilterSpecificationIndex:function(){return this.get("_number")},getFilterSpecificationLabel:function(){var e=this.getFilterSpecificationName(),t=this.getFilterSpecificationIndex();return t&&(e=UWA.String.format(s.get("defaultGroupNameWithValue"),e,t)),e}})}),define("DS/ENONextGenFilterUX/collections/FilterUIGroupCollection",["UWA/Core","UWA/Class/Collection","DS/ENONextGenFilterUX/models/CriterionModel","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX"],function(e,t,i,n){"use strict";return t.extend({model:i,comparator:void 0,setup:function(e,t){this.add(e)}})}),define("DS/ENONextGenFilterUX/models/GlobalFilterModel",["UWA/Class/Model","DS/ENONextGenFilterUX/utils/CVManager"],function(e,t){"use strict";return e.extend({name:"globalFilter-model",defaults:{state:"edit",combinationOfSpecification:"union",minusIndex:void 0},setup:function(){}})}),define("DS/ENONextGenFilterUX/collections/FilterUIGlobalFilterCollection",["UWA/Core","UWA/Class/Collection","UWA/Promise","UWA/Date","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","DS/WAFData/WAFData","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/ExpandV2FormatServices","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/models/GroupModel"],function(e,t,i,n,s,o,r,a,l,d,c,u,h){"use strict";return t.extend({model:h,comparator:void 0,setup:function(e,t){this.add(e),this._widgetId=t.widgetId||null,this._gfvModel=t.model},removeGroupCollection:function(e){this.remove(e,{silent:!0})},getGroupCollectionCount:function(e){return this.size()},getGroupCollectionIndex:function(e){var t=-1;return this.forEach(i=>{if(-1!==i.getFilterSpecificationName().indexOf(e)){var n=i.getFilterSpecificationIndex();t=t<n?n:t}}),-1!==t&&t++,t},getActiveGroupCollection:function(e){var t=[];return this.forEach(e=>{"1"===e.isActivated()&&t.push(e)}),t},buildCVQuery:function(e,t,n,s,r){var a=this;return new i(function(i,l){var d=a.keepComponentsToFeedUI(t,n,s);a.buildCVQueryFromFilterSpec(e,t,n,d,r).then(function(e){if(!o.isProgressiveExpandActive()){var n=c.fromNGFV1ToV2(t,e.CVQuery);e.CVQueryV2=n}var s=JSON.stringify(e);i(s)},function(e){l("")})})},buildCVQueryFromFilterSpec:function(e,t,n,a,l){return new i(function(i,n){var c=Date.now(),u=l&&l.queryFormat?l.queryFormat:o.getQueryFormat();o.isActivated("QueryV2FromModel")&&(l.queryV2FromModel=o.isActivated("QueryV2FromModel")),o.isActivated("MultiRoot")&&(l.multiRoot=o.isActivated("MultiRoot")),r.authenticatedRequest(o.getGetFilterQueryUrl(),{headers:d.getRESTHeaders(e),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({rootID:t,specification:a,options:l}),onComplete:function(e){if(s.displayInternalDurationTrace("buildCVQueryFromFilterSpec.onComplete("+u+")",Date.now()-c),o.isDebugActive("ngf")){let t=e.CVQueryV2mr?JSON.stringify(e.CVQueryV2mr):JSON.stringify(e.CVQueryV2),i=e.CVQueryV2fromV1?JSON.stringify(e.CVQueryV2fromV1):t;i===t?console.log(" CV queries = "+JSON.stringify(e)):(s.displayNotification({level:"error",message:"CVQueryV2(model) and CVQueryV2(V1) are NOT similar (see traces inside console traces)"}),console.log("==============================  CVQueryV2(model) and CVQueryV2(V1) are NOT similar  ==========================================="),console.log("=====  query V2(model) "),console.log(t),console.log("=====  query V2(V1) "),console.log(i),console.log("==============================================================================================================================="))}l.multiRoot&&(l.queryV2FromModel?(e.CVQueryV2=e.CVQueryV2mr,e.CVQueryV2=e.CVQueryV2mr[0]):(e.CVQueryV2=e.CVQueryV2fromV1,e.CVQueryV2=e.CVQueryV2fromV1[0])),delete e.CVQueryV2mr,delete e.CVQueryV2fromV1,i(e)},onFailure:function(e){console.log("=====> Build CVQuery from FilterSpecification failed, error  = "+e),n(e)}})})},keepComponentsToFeedUI:function(e,t,i,n){var s=[];s.push({toFeedUI:{combinationOfSpecification:this._gfvModel.get("combinationOfSpecification"),minusIndex:this._gfvModel.get("minusIndex"),keepChildren:t,specVersion:o.getCurrentSpecificationVersion()}});var r=[],l=a.get("defaultGroupName");this.forEach(e=>{if(e){r.push(e.getFilterSpecificationRoot());let d=e.get("groupCollection");var o=[];d.toArray().forEach(e=>{var s={};if(i?"tag"===e.get("criteriaType")&&(s=e.keepComponentsToFeedUI(t)):s=e.keepComponentsToFeedUI(t,n),Object.keys(s).length)for(var r=Array.isArray(s)?s:[s],a=0;a<r.length;a++)o.push(r[a])});var a={toFeedUI:o};"0"===e.isActivated()&&(a.isActivated="0"),-1===e.getFilterSpecificationName().indexOf(l)&&(a.filterSpecificationName=e.getFilterSpecificationName()),s.push(a)}});var d=[...new Set(r)];return 1===d.length&&e!=r[0]?s[0].toFeedUI.rootIds=r:1<d.length&&(s[0].toFeedUI.rootIds=r),s},_buildCVQuerySync:function(e,t){var i=[],n=0,r=this._gfvModel.get("combinationOfSpecification")||"union",a=0,l=!0,d=this.size();"minus"===r&&"0"===this._gfvModel.get("minusIndex")&&(a=d-1,l=!1);for(var c=!1;0<=a&&!c;){var u=a,h="",p=[],_=[],m=[],f=[],g=[];if("1"===this.at(u).isActivated()){let s=this.at(u).get("groupCollection"),o=s.size();for(var v=0;v<o;v++){var b=s.at(v);if("1"===b.get("isActivated")){var C=b.get("criteriaType");"attribute"===C?p.push(b.toCVQuery(t)):"config"===C?_.push(b.toCVQuery()):"Sequence"===C||"subGroup"===C?p.push(b.toCVQuery(t)):"context"===C?(m.push(b.toCVQuery()),m.push(b.toCVQuery("root_path_physicalid"))):"tag"===C&&b.toCVQuery()?f=b.toCVQuery():"volume"===C&&g.push(b.toCVQuery())}}var y=m.length,F=m[y-1];h+='{"root_path_physicalid":',h+=F&&!1!==F?F:'[["'+e+'"]]',(p.length||f.length)&&(h+=',"sequence_filter": ['+p.toString()+"]"),_.length&&(h+=","+_[_.length-1]),y&&m[y-2]&&(h+=","+m[y-2]);var A=g.length;if(n=n||A,A&&g[0].length&&(h+=","+g[0]),h+="}",f.length){for(var I=JSON.parse(h),S=0;S<f.length;S++)I.sequence_filter.push(f[S]);h=JSON.stringify(I)}i.push(h)}l?a++:a--;c=d===a||-1===a}var E=n?"expand3d":"expand",N="{";N+='"specVersion":"'+o.getCurrentSpecificationVersion()+'"',N+=', "'+r+'":{"'+E+'":['+i.toString()+"]}",N+="}";var w={};w.CVQuery=N;var x=s.upgradeAndCompleteQuery(w);return N=JSON.stringify(x),console.log("CVQuery = "+N),N}})}),define("DS/ENONextGenFilterUX/views/CriteriaContextMgmtView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Promise","DS/Logger/Logger","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/contextMgmtViewTemplate.html","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Controls/Button","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/Controls/Expander","DS/Controls/TooltipModel","DS/Menu/Menu","DS/Utilities/Utils"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g){"use strict";return e.extend({className:"contextCriterion",tagName:"li",domEvents:{"click .contextCriterion-read .contextRead":"_onEditAttribute"},setup:function(e){this._parent(e),this._rootID=e.rootId,this._template=o.compile(r),this.listenTo(this.model,"onChange:state",this._onStateChange.bind(this)),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this._allAddedNodes=[],this._allExcludedNodes=[],this._allAddedNodesLabels=[],this._allExcludedNodesLabels=[],this.model.set("addedNodesList",this._allAddedNodes),this.model.set("excludedNodesList",this._allExcludedNodes),this.model.set("addedNodesLabels",this._allAddedNodesLabels),this.model.set("excludedNodesLabels",this._allExcludedNodesLabels),this.listenTo(this,"updateAddDisplay",this._updateAddDisplay.bind(this)),this.listenTo(this,"updateExcludeDisplay",this._updateExcludeDisplay.bind(this)),this.model.set("AddNodeActivated",!0),this.model.set("ExcludeNodeActivated",!0),this._allSelectedPath=[]},render:function(){this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:a.get("titleContextUX"),titleContextReadUX:a.get("titleContextReadUX"),iconHeader:l.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_SelectionFilter.png"),maxPath:a.get("MaxPathInfoForSelection")}));var e=a.get("SelectNodesOnAppSide");return this.getElement(".nodesAddedList").setContent(e),this.getElement(".nodesExcludedList").setContent(e),this._maxPathContainer=this.getElement("#MaxPathContainer").hide(),this._createContextFilterUI(),this._createHeaderCtxMenu(),this._editContext(),this},destroy:function(){this._saveBeforeEdit={},this._allSelectedPath=[],this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType"),edited:"edit"===this.model.get("state")?1:0}),this._subscribe0&&this._subscribe0.unsubscribe("NGFilter.OccPath"),this._subscribe1&&this._subscribe1.unsubscribe("DS/ENO/select"),this._subscribe2&&this._subscribe2.unsubscribe("DS/PADUtils/PADCommandProxy/select"),this.stopListening(),this.model=null,this._parent(),this.container=null},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},_editContext:function(){this._saveBeforeEdit={},this._saveBeforeEdit.AddNodeActivated=t.clone(this.model.get("AddNodeActivated")),this._saveBeforeEdit.addedNodesList=t.clone(this.model.get("addedNodesList")),this._saveBeforeEdit.addedNodesLabels=t.clone(this.model.get("addedNodesLabels")),this._saveBeforeEdit.ExcludeNodeActivated=t.clone(this.model.get("ExcludeNodeActivated")),this._saveBeforeEdit.excludedNodesList=t.clone(this.model.get("excludedNodesList")),this._saveBeforeEdit.excludedNodesLabels=t.clone(this.model.get("excludedNodesLabels")),this._saveBeforeEdit.asString=JSON.stringify(this.model.keepComponentsToFeedUI(!0)),this.model.set("state","edit"),this._manageExpandCollapseNodes()},_manageExpandCollapseNodes:function(){var e=this._allAddedNodes.length,t=this._allExcludedNodes.length;(e||0===e&&0===t?this._addExpander:this._excludeExpander).expandedFlag=!0},_completeSelection:function(e){return new i(t=>{var i=e.revision&&e.revision.length;if(e.label&&e.label.length&&i)t(e);else{var s=e.serviceId[0],o=[];e.path.forEach(e=>{o=o.concat(e)}),o=[...new Set(o)];var r=[];o.forEach(e=>{r.push({rootId:e,serviceId:s})});var a=p.getOption("displayRoot_AttributesTitle")||["ds6w:label","ds6wg:revision"],l=a.indexOf("ds6wg:revision");-1===l&&a.push("ds6wg:revision"),h.getPredicatesInfosFromIds(r,a,!0).then(function(i){var n=u.getDisplaySeparator(),s=[],o=[];e.path.forEach(e=>{var t=[],r=[];e.forEach(e=>{var s=i.find(t=>e===t.id);if(s){var o=[];if(a.forEach(e=>{var t=s.predicates.find(function(t){return e===t.name});t&&o.push(t.dispValue||t.value)}),t.push(o.join(n)),-1===l){var d=s.predicates.find(function(e){return"ds6wg:revision"===e.name});r.push(d?d.value:"")}}}),s.push(t.length?t[t.length-1]:""),o.push(r.length?r[r.length-1]:"")}),e.label=s,e.revision=o,t(e)},function(e){n.error("Advanced Filter: Error to retrieve labels on selected path !")})}})},_setSelectionFromEvent:g.debounce(function(e){let t=this;if(e.data.paths&&e.data.paths.length){let i=[];e.data.paths.forEach(e=>{this._checkRootAndPath(e)?1<e.length&&i.push(e):s.displayNotification({level:"info",message:a.get("ObjectNotUnderRoot"),sticky:!1})}),i.length&&t._onPathSelect({serviceId:["3DSpace"],path:i})}},500),_onOccPathSelect:function(e){this._setSelectionFromEvent({data:{paths:e.path}})},_onPathSelect:function(e){var t=this;this.model&&"edit"===this.model.get("state")&&this._completeSelection(e).then(e=>{if(t._addExpander.expandedFlag&&t.model.get("AddNodeActivated")){if(t.getElement(".nodesAddedList"))for(var i=1===e.path.length,n=0;n<e.path.length;n++){var o=t._isPathAlreadyAdded(e.path[n],i)||t._isPathAlreadyExcluded(e.path[n],i);if(1<e.path[n].length&&!o){var r=e.label&&e.label.length&&e.label[n].length?e.label[n]:"Added-"+n,a=e.revision&&e.revision.length&&e.revision[n].length?e.revision[n]:"";r=s.getRootTitle(r,a),t._allAddedNodes.push(e.path[n]),t._allAddedNodesLabels.push(r),t._InsertPathInDiv({selectedPath:e.path[n],pathAlias:r})}}}else if(t._excludeExpander.expandedFlag&&t.model.get("ExcludeNodeActivated")){if(t.getElement(".nodesExcludedList"))for(i=1===e.path.length,n=0;n<e.path.length;n++){o=t._isPathAlreadyAdded(e.path[n])||t._isPathAlreadyExcluded(e.path[n],i);if(1<e.path[n].length&&!o){r=e.label&&e.label.length&&e.label[n].length?e.label[n]:"Excluded-"+n,a=e.revision&&e.revision.length&&e.revision[n].length?e.revision[n]:"";r=s.getRootTitle(r,a),t._allExcludedNodes.push(e.path[n]),t._allExcludedNodesLabels.push(r),t._InsertExcludedPathInDiv({selectedPath:e.path[n],pathAlias:r})}}}})},_isPathAlreadyAdded:function(e,t){for(var i=!1,n="string"==typeof e?e.split(","):e,o=!1,r=!1,l=0;l<this._allAddedNodes.length;l++){let e=!0;for(var d=0;d<=n.length;d++)if(n[d]&&n[d]!==this._allAddedNodes[l][d]){e=!1;break}if(e&&n.length<this._allAddedNodes[l].length)o=!0;else if(e){r=!0;break}}return r?this._isPathPresent(this._allSelectedPath,n)&&(i=!0,!1!==t&&s.displayNotification({level:"info",message:a.get("AlreadyAdded"),sticky:!1})):o?i=!1:(i=!1,!this._isPathPresent(this._allSelectedPath,n)&&this._allSelectedPath.push(n)),i},_isPathAlreadyExcluded:function(e,t){for(var i=!1,n="string"==typeof e?e.split(","):e,o=0;o<this._allExcludedNodes.length;o++){let e=!0;for(var r=0;r<=n.length;r++)if(this._allExcludedNodes[o][r]&&n[r]!==this._allExcludedNodes[o][r]){e=!1;break}if(e){if(this._isPathPresent(this._allSelectedPath,n)){i=!0,!1!==t&&s.displayNotification({level:"info",message:a.get("AlreadyExcluded"),sticky:!1});break}}else i=!1,!this._isPathPresent(this._allSelectedPath,n)&&this._allSelectedPath.push(n)}return i},_checkRootAndPath:function(e){return this._rootID===e[0]},_InsertPathInDiv:function(e,t){var i,n=this.getContent();n.querySelector(".context-chip-cell-addlabel")||n.querySelector(".nodesAddedList")&&n.querySelector(".nodesAddedList").empty(),i="InsertAllPathsAtOnce"===t?{addedNodesLabels:e.addedNodesLabels?e.addedNodesLabels:e.get("addedNodesLabels")||[],addedNodesList:e.addedNodesList?e.addedNodesList:e.get("addedNodesList")||[]}:{addedNodesLabels:[e.pathAlias],addedNodesList:[e.selectedPath]};for(var s=this.getElement(".nodesAddedList"),o=0;o<i.addedNodesLabels.length;o++){var r=new UWA.Element("div",{class:"context-chip-cell-container"}),a=new UWA.Element("span",{class:"context-chip-cell-close fonticon fonticon-close","font-family":"DSFontIcon"});a.onclick=this._removePathFromSelectionList.bind(this);var l=new UWA.Element("span",{class:"context-chip-cell-addlabel",html:i.addedNodesLabels[o]});l.setAttribute("occid",i.addedNodesList[o]),l.inject(r),a.inject(r),s.addContent(r),s.removeClassName("nodes-color")}this.dispatchEvent("updateAddDisplay")},_removePathFromSelectionList:function(e){if(this.model.get("AddNodeActivated"))for(var t=e.target.parentElement,i=t.getElement(".context-chip-cell-addlabel").getAttribute("occid").split(","),n=0;n<this._allAddedNodes.length;n++){var s=!0;if(i.length===this._allAddedNodes[n].length){for(var o=0;o<i.length&&!0===s;o++)i[o]!=this._allAddedNodes[n][o]&&(s=!1);s&&(this._allAddedNodes.splice(n,1),this._allAddedNodesLabels.splice(n,1),t.remove(),this.dispatchEvent("updateAddDisplay"))}}},_updateAddDisplay:function(){var e=this._allAddedNodes.length,t=e<=1?"AddSingleNode":"AddMultiNode";if(this._addExpander.header=e+" "+a.get(t),0===e){var i="<i>"+a.get("SelectNodesOnAppSide")+"</i>";this.getElement(".nodesAddedList").setContent(i),this.getElement(".nodesAddedList").addClassName("nodes-color")}var n=this._addExpander.getContent().getElement(".wux-controls-expander-header");s.MAX_SELECTION_PATH<e?n.addClassName("contextCriterion-edit-header-maxPath"):s.MAX_SELECTION_PATH>=e&&n.removeClassName("contextCriterion-edit-header-maxPath"),s.MAX_SELECTION_PATH<e||s.MAX_SELECTION_PATH<this._allExcludedNodes.length?this._maxPathContainer.show():s.MAX_SELECTION_PATH>=e&&s.MAX_SELECTION_PATH>=this._allExcludedNodes.length&&this._maxPathContainer.hide()},_InsertExcludedPathInDiv:function(e,t){var i,n=this.getContent();n.querySelector(".context-chip-cell-excludelabel")||n.querySelector(".nodesExcludedList")&&n.querySelector(".nodesExcludedList").empty(),i="InsertAllPathsAtOnce"===t?{excludedNodesLabels:e.excludedNodesLabels?e.excludedNodesLabels:e.get("excludedNodesLabels")||[],excludedNodesList:e.excludedNodesList?e.excludedNodesList:e.get("excludedNodesList")||[]}:{excludedNodesLabels:[e.pathAlias],excludedNodesList:[e.selectedPath]};for(var s=this.getElement(".nodesExcludedList"),o=0;o<i.excludedNodesLabels.length;o++){var r=new UWA.Element("div",{class:"context-chip-cell-container"}),a=new UWA.Element("span",{class:"context-chip-cell-close fonticon fonticon-close","font-family":"DSFontIcon"});a.onclick=this._removePathFromExcludedList.bind(this);var l=new UWA.Element("span",{class:"context-chip-cell-excludelabel",html:i.excludedNodesLabels[o]});l.setAttribute("occid",i.excludedNodesList[o]),l.inject(r),a.inject(r),s.addContent(r),s.removeClassName("nodes-color")}this.dispatchEvent("updateExcludeDisplay")},_removePathFromExcludedList:function(e){if(this.model.get("ExcludeNodeActivated"))for(var t=e.target.parentElement,i=t.getElement(".context-chip-cell-excludelabel").getAttribute("occid").split(","),n=0;n<this._allExcludedNodes.length;n++){var s=!0;if(i.length===this._allExcludedNodes[n].length){for(var o=0;o<i.length&&!0===s;o++)i[o]!=this._allExcludedNodes[n][o]&&(s=!1);s&&(this._allExcludedNodes.splice(n,1),this._allExcludedNodesLabels.splice(n,1),t.remove(),this.dispatchEvent("updateExcludeDisplay"))}}},_updateExcludeDisplay:function(){var e=this._allExcludedNodes.length,t=e<=1?"ExcludeSingleNode":"ExcludeMultiNode";if(this._excludeExpander.header=e+" "+a.get(t),0===e){var i="<i>"+a.get("SelectNodesOnAppSide")+"</i>";this.getElement(".nodesExcludedList").setContent(i),this.getElement(".nodesExcludedList").addClassName("nodes-color")}var n=this._excludeExpander.getContent().getElement(".wux-controls-expander-header");s.MAX_SELECTION_PATH<e?n.addClassName("contextCriterion-edit-header-maxPath"):s.MAX_SELECTION_PATH>=e&&n.removeClassName("contextCriterion-edit-header-maxPath"),s.MAX_SELECTION_PATH<e||s.MAX_SELECTION_PATH<this._allAddedNodes.length?this._maxPathContainer.show():s.MAX_SELECTION_PATH>=e&&s.MAX_SELECTION_PATH>=this._allAddedNodes.length&&this._maxPathContainer.hide()},_createContextFilterUI:function(){var e=this,i=t.createElement("div",{}),n=new d(s.getAttributeButtonStyle("chevron-down"));n.domId="keepCtxMenu",n.displayStyle="lite",n.inject(i),this._ctxMenuAddWUX=this._createContextualMenuWUX(n.getContent(),"Add");e=this;n.getContent().addEventListener("click",function(t){t.stopPropagation();var i=t.target.getBoundingClientRect();f.show(e._ctxMenuAddWUX,{position:s.getMenuPosition(i)})});var o=e._allAddedNodes.length,r=e._allExcludedNodes.length,l=0>=o&&0>=r||0>=o,c=this.getElement(".contextCriterion-edit .nodesAddDisplay");this._addExpander=new _({domId:"keepExpander",header:a.get("AddNodesTitle"),expandedFlag:l,customHeader:i,style:"filled-separate"}),this._addExpander.inject(c,"before"),this._addExpander.body=c,this._addExpander.addEventListener("expand",function(t){t.stopPropagation(),e._excludeExpander.expandedFlag=!1});var h=t.createElement("div",{}),p=new d(s.getAttributeButtonStyle("chevron-down"));p.domId="excludeCtxMenu",p.displayStyle="lite",p.inject(h),this._ctxMenuExcludeWUX=this._createContextualMenuWUX(p.getContent(),"Exclude");e=this;p.getContent().addEventListener("click",function(t){t.stopPropagation();var i=t.target.getBoundingClientRect();f.show(e._ctxMenuExcludeWUX,{position:s.getMenuPosition(i)})});var g=this.getElement(".contextCriterion-edit .nodesExcludeDisplay");this._excludeExpander=new _({domId:"excludeExpander",header:a.get("ExcludeNodesTitle"),expandedFlag:!l,customHeader:h,style:"filled-separate"}),this._excludeExpander.inject(g,"before"),this._excludeExpander.body=g,this._excludeExpander.addEventListener("expand",function(t){t.stopPropagation(),e._addExpander.expandedFlag=!1}),this.ConfirmCxtFilterButton=new d(s.getAttributeValidateButtonStyle()),this.ConfirmCxtFilterButton.label=a.get("validateCriterionLabel"),this.ConfirmCxtFilterButton.showLabelFlag=s.isLabelCriterionDisplayed();var v="attribute-edit-button-style"+s.FILTER_TOUCH_CLASS;this.ConfirmCxtFilterButton.getContent().addClassName(v),this.ConfirmCxtFilterButton.inject(this.getElement("#"+this._getId()+" .buttonToValidate")),this.ConfirmCxtFilterButton.tooltipInfos=new m({shortHelp:a.get("ValidateCriteriaTooltip"),mouseRelativePosition:!0}),this.ConfirmCxtFilterButton.addEventListener("buttonclick",function(t){var i=e._allAddedNodes.length,n=e._allExcludedNodes.length;0!==i&&u.setUsageTracker(e._widgetId,"NGF-Context-Add",{label:"Nb Added",value:e.model.get("AddNodeActivated")?i:-1}),0!==n&&u.setUsageTracker(e._widgetId,"NGF-Context-Exclude",{label:"Nb Excluded",value:e.model.get("ExcludeNodeActivated")?n:-1}),this._saveBeforeEdit={},e.isThereCriteria()?(s.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState(),e.dispatchEvent("NGF_Criterion_Validation",{criteriaType:e.model.get("criteriaType")})):e.destroy()})},_cancelEditCriteria:function(){this._resetAddedNodes(),this._resetExcludedNodes(),this._allAddedNodes=t.clone(this._saveBeforeEdit.addedNodesList),this._allAddedNodesLabels=t.clone(this._saveBeforeEdit.addedNodesLabels),this._allExcludedNodes=t.clone(this._saveBeforeEdit.excludedNodesList),this._allExcludedNodesLabels=t.clone(this._saveBeforeEdit.excludedNodesLabels),this.model.set("AddNodeActivated",t.clone(this._saveBeforeEdit.AddNodeActivated)),this.model.set("addedNodesList",this._allAddedNodes),this.model.set("addedNodesLabels",this._allAddedNodesLabels),this.model.set("ExcludeNodeActivated",t.clone(this._saveBeforeEdit.ExcludeNodeActivated)),this.model.set("excludedNodesList",this._allExcludedNodes),this.model.set("excludedNodesLabels",this._allExcludedNodesLabels),this._InsertPathInDiv(this._saveBeforeEdit,"InsertAllPathsAtOnce"),this._setStateOfAddNodes(!this._saveBeforeEdit.AddNodeActivated),this._updateContextualmenuFromModel("Add"),this._InsertExcludedPathInDiv(this._saveBeforeEdit,"InsertAllPathsAtOnce"),this._setStateOfExcludeNodes(!this._saveBeforeEdit.ExcludeNodeActivated),this._updateContextualmenuFromModel("Exclude"),this._manageExpandCollapseNodes()},_onStateChange:function(e,i){var n=this.model.criterionToString();if("string"==typeof n||Array.isArray(n)){this.getElement(".f-context-container").setAttribute("class","f-context-container "+i);if("read"===i){this._subscribe0&&this._subscribe0.unsubscribe("NGFilter.OccPath"),delete this._subscribe0,this._subscribe1&&this._subscribe1.unsubscribe("DS/ENO/select"),this._subscribe2&&this._subscribe2.unsubscribe("DS/PADUtils/PADCommandProxy/select"),delete this._subscribe1,delete this._subscribe2;var s=Array.isArray(n)?n:[n];if(u.isActivated("newSelectionRead")){var o=s[0].replace("(","").replace(")","").split(",");this.getElement(".contextRead").setContent([{tag:"span",html:a.get("titleContextUX")}]);var r=this.getElement(".contextCriterion-read");this.getElements(".contextCriterion-read .wux-controls-expander").forEach(e=>{e.destroy()});var l=this,d=function(e,i,n,s){var o=t.createElement("div",{class:"selectablesDivCSSread"});l.model.get(n).forEach(e=>{t.createElement("div",{html:e}).inject(o)});var r=new _({header:i,expandedFlag:!1,style:"simple",body:o});r.inject(e),r.getContent().style.marginLeft="20px",s?r.getContent().removeClassName("f-criterion-deactivated"):r.getContent().addClassName("f-criterion-deactivated")},h="addedNodesLabels",p=0;if(this.model.get(h).length){var m=this.model.get("AddNodeActivated");d(r,a.get(o[p]),h,m),p++}if(h="excludedNodesLabels",this.model.get(h).length){m=this.model.get("ExcludeNodeActivated");d(r,a.get(o[p]),h,m)}}else{this.getElement(".contextRead#value").setContent([{tag:"span",html:s[0]}])}this._setContextualMenu("read")}else this._subscribe0=c.subscribe("NGFilter.OccPath",this._onOccPathSelect.bind(this)),this._subscribe1=c.subscribe("DS/ENO/select",this._setSelectionFromEvent.bind(this)),this._subscribe2=c.subscribe("DS/PADUtils/PADCommandProxy/select",this._setSelectionFromEvent.bind(this)),this._setContextualMenu("edit"),this._manageExpandCollapseNodes(),this.dispatchEvent("NGF_Criterion_SwitchedToEdit",{type:this.model.get("criteriaType"),state:1})}else"object"==typeof n&&console.log("Criteria Selection Error / Invalid expected type on state change")},viewFromMdl:function(e){var t=this,i=e.get("AddNodeActivated")||!0;this._allAddedNodes=e.get("addedNodesList")||[];var n=e.get("ExcludeNodeActivated")||!0;this._allExcludedNodes=e.get("excludedNodesList")||[],this.model.set("AddNodeActivated",i),this.model.set("addedNodesList",this._allAddedNodes),this.model.set("ExcludeNodeActivated",n),this.model.set("excludedNodesList",this._allExcludedNodes);var o=[];this._allAddedNodes.length&&this._allAddedNodes.forEach(e=>{o.push(e[e.length-1])});var r=[];this._allExcludedNodes.length&&this._allExcludedNodes.forEach(e=>{r.push(e[e.length-1])});var a=[...new Set(o.concat(r))];a.length&&s.executeFetch(a,[],["ds6w:label","ds6wg:revision"]).then(function(i){t._allAddedNodesLabels=s.getAliasesFromFetched(o,i),t.model.set("addedNodesLabels",t._allAddedNodesLabels),t._InsertPathInDiv(e,"InsertAllPathsAtOnce"),t._allExcludedNodesLabels=s.getAliasesFromFetched(r,i),t.model.set("excludedNodesLabels",t._allExcludedNodesLabels),t._InsertExcludedPathInDiv(e,"InsertAllPathsAtOnce"),t._setStateOfNodesFromModel(),t._updateContextualmenuFromModel("Add"),t._updateContextualmenuFromModel("Exclude")})},_getDOMElementToUpdateOnActivateChange:function(){var e=[];let t=this.getElement("#"+this._getId()+" .contextCriterion-read");return e.push(t.getElement("#readHeader")),e.push(t.getElement("img")),e},_getCallbackToEditCriterion:function(){return this._editContext.bind(this)},isCriterionValidate:function(){if(0===s.isAsynchronousValidation())return!0;var e=this;return new i(function(t){e.isThereCriteria()?s.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState():e.destroy(),t(!0)})},_isCriterionModified:function(){var e=JSON.stringify(this.model.keepComponentsToFeedUI(!0));return this._saveBeforeEdit.asString!==e},isThereCriteria:function(){var e=this.model.get("addedNodesList")||[],t=this.model.get("excludedNodesList")||[];return!(!e.length&&!t.length)},_resetAddedNodes:function(){this._allAddedNodes.splice(0),this._allAddedNodesLabels.splice(0),this._addExpander.getContent().removeClassName("f-criterion-deactivated"),this.getElement(".nodesAddedList").getElements(".context-chip-cell-container").forEach(function(e){e.remove()}),this.dispatchEvent("updateAddDisplay"),this.model.set("AddNodeActivated",!0),this._updateContextualmenuFromModel("Add")},_resetExcludedNodes:function(){this._allExcludedNodes.splice(0),this._allExcludedNodesLabels.splice(0),this._excludeExpander.getContent().removeClassName("f-criterion-deactivated"),this.getElement(".nodesExcludedList").getElements(".context-chip-cell-container").forEach(function(e){e.remove()}),this.dispatchEvent("updateExcludeDisplay"),this.model.set("ExcludeNodeActivated",!0),this._updateContextualmenuFromModel("Exclude")},_createContextualMenuWUX:function(e,t){var i=function(e){var t,i,n=e.context.action;"Add"===n?(t="AddNodeActivated",i=this._setStateOfAddNodes.bind(this)):(t="ExcludeNodeActivated",i=this._setStateOfExcludeNodes.bind(this));var s=this.model.get(t);i(s),this.model.set(t,!s),this._updateContextualmenuFromModel(n)},n={type:"PushItem",recId:"activate-item-DDCtx",title:a.get("activatedCriteria"),icon:s.getIconByName("eye"),action:{this:this,callback:i,context:{action:t}}},o={type:"PushItem",recId:"activate-item-DDCtx",title:a.get("deactivatedCriteria"),icon:s.getIconByName("eye-off"),action:{this:this,callback:i,context:{action:t}}},r={type:"PushItem",recId:"reset-item-DDCtx",title:a.get("ResetNodes"),icon:s.getIconByName("clear"),action:{this:this,callback:"Add"===t?this._resetAddedNodes:this._resetExcludedNodes}};return"Add"===t?(this._activateAddItem=n,this._deactivateAddItem=o):(this._activateExcludeItem=n,this._deactivateExcludeItem=o),[o,r]},_setStateOfNodesFromModel:function(){var e=this.model.get("AddNodeActivated");this._setStateOfAddNodes(!e),this.dispatchEvent("updateAddDisplay"),e=this.model.get("ExcludeNodeActivated"),this._setStateOfExcludeNodes(!e),this.dispatchEvent("updateExcludeDisplay")},_setStateOfAddNodes:function(e){var t=this._addExpander.getContent().getElement(".headerTitle"),i=this.getElement(".nodesAddedList").getElements(".context-chip-cell-container");i.push(t),i.forEach(function(t){e?t.addClassName("f-criterion-deactivated"):t.removeClassName("f-criterion-deactivated")})},_setStateOfExcludeNodes:function(e){var t=this._excludeExpander.getContent().getElement(".headerTitle"),i=this.getElement(".nodesExcludedList").getElements(".context-chip-cell-container");i.push(t),i.forEach(function(t){e?t.addClassName("f-criterion-deactivated"):t.removeClassName("f-criterion-deactivated")})},_updateContextualmenuFromModel:function(e){if("Add"===e){var t=this.model.get("AddNodeActivated");this._ctxMenuAddWUX[0]=t?this._deactivateAddItem:this._activateAddItem}else if("Exclude"===e){t=this.model.get("ExcludeNodeActivated");this._ctxMenuExcludeWUX[0]=t?this._deactivateExcludeItem:this._activateExcludeItem}},buildViewFromRepairModel:function(e){this.model.set("state","edit");var t=this.getContent(),i=t.querySelector(".nodesAddedList");i&&i.empty();var n=t.querySelector(".nodesExcludedList");n&&n.empty(),this.viewFromMdl(e),this.model.set("state","read");var s=this.model.get("addedNodesList")||[],o=this.model.get("excludedNodesList")||[];0===s.length&&0===o.length&&this.destroy()},updateModelFromRepair:function(e){var t=this,i=e[0],n=[];e[1].length&&e[1].forEach(function(e){e.attributes.forEach(function(e){"logicalid"===e.name&&n.push(e.value)})});var s=this.model.get("repairFilterInfo"),o=function(s,o,r){var a=!1;if(s)for(var l=s.length,d=0;d<l;d++){var c=s[d],u=n.indexOf(c);if(-1===u)a=!0;else{var h=e[1][u].attributes[0].value,p=e[1][u].attributes.findIndex(function(e){return"ds6w:label"===e.name}),_=e[1][u].attributes[p].value;_+=-1===(p=e[1][u].attributes.findIndex(function(e){return"ds6wg:revision"===e.name}))?"":" "+e[1][u].attributes[p].value;for(var m=0;m<i.length;m++)-1!==i[m].indexOf(h)&&!1===t._isPathPresent(o,i[m])&&(o.push(i[m]),r.push(_),a=!0)}}return a},r=[],a=[],l=this.model.get("addedNodesList"),d=this.model.get("addedNodesLabels"),c=o(s.logicalID_OfAddedPaths,r,a);this.model.set("addedNodesList",l.concat(r)),this.model.set("addedNodesLabels",d.concat(a)),r=[],a=[];var u=this.model.get("excludedNodesList"),h=this.model.get("excludedNodesLabels"),p=o(s.logicalID_OfExcludedPaths,r,a);this.model.set("excludedNodesList",u.concat(r)),this.model.set("excludedNodesLabels",h.concat(a));var _=c||p;return{modelUpdated:_,attributes:_?this.model:void 0}},_isPathPresent:function(e,t){let i=!1,n=e.length,s=t.length;for(var o=0;o<n&!i;o++){i=!0;let n=e[o],a=Math.min(n.length,s);for(var r=0;r<a;r++)i=n[r]==t[r]&&i}return i}})}),define("DS/ENONextGenFilterUX/views/CriteriaConfigurationView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Promise","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/configurationViewTemplate.html","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Controls/Button","DS/Controls/TooltipModel"],function(e,t,i,n,s,o,r,a,l,d,c,u){"use strict";return e.extend({className:"configurationCriterion",tagName:"li",domEvents:{"click .configCriterion-read .confRead":"_onEditAttribute","click .configCriterion-read .confReadIcon":"_onEditAttribute"},setup:function(e){this._parent(e),this._configFactory=void 0,this._rootID=e.rootId,this._template=r.compile(a),this._hasConf=!1,this._initWithConfig=e.initWithConfig||!1,this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this))},render:function(){return this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:s.get("titleConfigurationUX"),titleConfigurationReadUX:s.get("titleConfigurationReadUX"),iconHeader:o.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_ConfigurationFilter.png")})),this._createHeaderCtxMenu(),this},onStateChange:function(e,t){this.getElement(".f-configuration-container").setAttribute("class","f-configuration-container "+t);if("read"===t){var i=this.model.criterionToString()||"",n=i,o=d.MAX_CAR_FOR_CONFIG;if(o<n.length){if(!this._extensionText){var r=this.getElement(".confRead#value").hide();r=this.getElement(".confRead#long-value").show(),this._extensionText=new c({touchMode:d.TOUCH_MODE,displayStyle:"lite",label:s.get("ShowLess"),id:"ShowMoreOrLess_"+this._childGroupId,checkFlag:!0}),this._extensionText.inject(r,"after"),this._extensionText.getContent().addClassName("filter-anchor-style");var a=this;this._extensionText.addEventListener("buttonclick",function(e){e.dsModel.checkFlag=!e.dsModel.checkFlag}),this._extensionText.addEventListener("change",function(e){var t=a.model.criterionToString(),i=t;e.dsModel.checkFlag?(e.dsModel.label="("+s.get("ShowLess")+")",i+="  "):(e.dsModel.label="("+s.get("ShowMore")+")",i=i.substr(0,o)+" ... "),a._displayConfigValue(r,i,t)})}this._extensionText.checkFlag=!1,this._extensionText.show()}else{r=this.getElement(".confRead#long-value").hide();r=this.getElement(".confRead#value").show(),this._extensionText&&this._extensionText.hide(),this._displayConfigValue(r,n,i)}this._setContextualMenu("read")}else this._savedBeforeEdit=this.model.keepComponentsToFeedUI(!0),this.dispatchEvent("NGF_Criterion_SwitchedToEdit",{type:this.model.get("criteriaType"),state:1}),this._initWithConfig||this._launchCfgFactory(),this._setContextualMenu("edit")},_displayConfigValue:function(e,t,i){e.setContent([{tag:"span",html:t}]),e.tooltipInfos?e.tooltipInfos.shortHelp=i.unescapeHTML():e.tooltipInfos=new u({shortHelp:i.unescapeHTML(),mouseRelativePosition:!0})},_getDOMElementToUpdateOnActivateChange:function(){var e=[];let t=this.getElement("#"+this._getId()+" .configCriterion-read");return e.push(t.getElement("#readHeader")),e.push(t.getElement("img")),e},destroy:function(){this._hasConf=!1,this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType"),hasConf:this._hasConf,edited:"edit"===this.model.get("state")?1:0}),this.stopListening(),this.model=null,this._parent(),this.container=null},_getCallbackToEditCriterion:function(){return this.editConfiguration.bind(this)},editConfiguration:function(){this.model.set("state","edit")},launchCfgFactoryWithConfig:function(e){var t=this;return t._initWithConfig=!1,new n(function(i,n){var s=JSON.parse(l).conf;require([s],function(n){t._configFactory=n;var s=d.getPlatformId(),o={rootId:t._rootID,callback:function(e){t._onConfigFilterCB(e),i()}.bind(t),expression:t._hasConf?t.model.get("expression"):{},config_filter_id:t.model.has("config_filter_id")?t.model.get("config_filter_id"):"",tenant:s,platformUrl:d.getPlatformServiceUrl(s,t._pfServiceId),renderTo:t.getElement(".configCriterion-edit"),renderToApp:d.getGlobalEditContainer(t._UXId),hideFilter:t._hideFilterContainer.bind(t),showFilter:t._showFilterContainer.bind(t),displayCompactMode:("1"===localStorage.getItem("NGF_DisplayDensity")?0:1)||0,configData:e,securityContext:t.options.securityContext};t._configFactory.begin(o),i()})})},_launchCfgFactory:function(){var e=this,t=JSON.parse(l).conf,i=d.getPlatformId(),n={rootId:e._rootID,callback:e._onConfigFilterCB.bind(e),expression:e._hasConf?e.model.get("expression"):{},config_filter_id:e.model.has("config_filter_id")?e.model.get("config_filter_id"):"",tenant:i,platformUrl:d.getPlatformServiceUrl(i,e._pfServiceId),renderTo:e.getElement(".configCriterion-edit"),renderToApp:d.getGlobalEditContainer(e._UXId),hideFilter:e._hideFilterContainer.bind(e),showFilter:e._showFilterContainer.bind(e),displayCompactMode:("1"===localStorage.getItem("NGF_DisplayDensity")?0:1)||0,securityContext:e.options.securityContext};require([t],function(t){e._configFactory=t,e._configFactory.begin(n)})},_onConfigFilterCB:function(e){if(0===e.length){var t={criteriaType:this.model.get("criteriaType"),action:"remove"};this.dispatchEvent("NGF_Criterion_Config",t)}else{var i=e[0][this._rootID],n=this.model;n.set("displayExpression",i.displayExpression),n.set("expression",i.expression),i.config_filter_id?(n.set("config_filter_id",i.config_filter_id),n.unset("config_filter")):(n.set("config_filter",i.compiledBinary),n.unset("config_filter_id"));this._hasConf=!0;t={criteriaType:n.get("criteriaType"),cfgType:n.get("config_filter_id")?"configId":"binary",action:"update",hasConf:this._hasConf};this.dispatchEvent("NGF_Criterion_Config",t),d.isModelActivated(n)||!0!==this._isCriterionModified()||this._switchCriterionState(),this.dispatchEvent("NGF_Criterion_Validation",{criteriaType:n.get("criteriaType")}),"none"!==d.getGlobalEditContainer(this._UXId).getStyle("display")&&d.showFilterContainer(!0)}},_isCriterionModified:function(){var e=!1;if(this.model){let t=this.model.keepComponentsToFeedUI(!0).displayExpression;e=this._savedBeforeEdit.displayExpression!==t}return e},isCriterionValidate:function(){if(0===d.isAsynchronousValidation())return t=this._configFactory&&this._configFactory.validateConfigurationFilter?"edit"!==this.model.get("state")||this._configFactory.validateConfigurationFilter():"read"===this.model.get("state");var e=this;if(this._configFactory&&this._configFactory.validateConfigurationFilter)return"edit"===this.model.get("state")?new n(t=>{e._configFactory.validateConfigurationFilter().then(function(i){e._savedBeforeEdit=i?void 0:e._savedBeforeEdit,t(i)})}):new n(t=>{e._savedBeforeEdit=void 0,t(!0)});var t="read"===this.model.get("state");return this._savedBeforeEdit=t?void 0:this._savedBeforeEdit,new n(function(e){e(t)})},viewFromMdl:function(e){this.model.set("displayExpression",e.displayExpression),this.model.set("filterName",e.filterName),this.model.set("expression",e.expression),e.config_filter_id?(this.model.set("config_filter_id",e.config_filter_id),this._hasConf=!(!e.config_filter_id||0===Object.keys(e.config_filter_id))):(this.model.set("config_filter",e.config_filter),this._hasConf=!(!e.config_filter||!e.config_filter.length)),"0"===e.isActivated&&this._switchCriterionState()},isThereCriteria:function(){return this._hasConf},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},_cancelEditCriteria:function(){if(!this._hasConf){var e=this.model;e.unset("displayExpression"),e.unset("filterName"),e.unset("expression"),e.unset("config_filter"),e.unset("config_filter_id")}this._launchCfgFactory()},checkConfigFilter:function(e){var t,i=this.model.get("config_filter_id");return i?!(t=-1!==e.indexOf(i.physical_id))&&this.destroy():t=!0,t}})}),define("DS/ENONextGenFilterUX/views/FilterRepairView",["UWA/Core","DS/ENOFilterExplicitWebInWin/views/filterRepairUI","UWA/Promise","UWA/Class/View","DS/WAFData/WAFData","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/models/CriterionModel","text!DS/ENONextGenFilterUX/templates/filterRepairViewTemplate.html","i18n!DS/ENOFilterExplicitWebInWin/assets/nls/ENOStrRefinementUX.json","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d,c,u){"use strict";return n.extend({setup:function(e){this._parent(e),this._template=r.compile(l),this.container.addEvent("click",function(e){return e.stopPropagation(),!1})},render:function(){var e=this;return this._displayFilterPanel(!1),this._isBrokenPathsObject&&(this.container.setContent(this._template({stateClass:"Read"})),this._filterUIObj.render().inject(e.getElement(".filterRepairView-mainContainer")),this.listenTo(this._filterUIObj,"NGF_RepairFilter",function(t){e._repairFilter(t)}),this.listenTo(this._filterUIObj,"NGF_CancelRepairFilter",function(t){this._subscribe0.unsubscribe("Frame3DXInfra.onPanelClose"),"CancelRepair"==t.listOfList&&e._displayFilterPanel(!0),e.dispatchEvent("NGF_CancelRepairFilter",t)}),this._subscribe0=c.subscribe("Frame3DXInfra.onPanelClose",function(t){e._displayFilterPanel(!0),e.dispatchEvent("NGF_CancelRepairFilter",t),e._subscribe0.unsubscribe("Frame3DXInfra.onPanelClose")})),this},logWebServiceOptions:function(e){this._optionsWebservice=e},logBrokenFiltersInfo:function(e){this._toFeedUI=e},fetchRepairedPathsFromWebService:function(e){var n=this;return this._isBrokenPathsObject="object"==typeof e,this._filterUIObj=new t({brokenPaths:e,url:n._optionsWebservice.url,ctx:n._optionsWebservice.ctx,widgetId:n.options.options.widgetId||n.options.options.widget}),this._filterUIObj.RepairFilterInWidget(this.options.options.widget),new i(function(e){n._filterUIObj.fetchData().then(function(t){e(t)})})},checkForBrokenPathsInFilter:function(e){var t,n=this;return t=e.filterUIComponents?e.filterUIComponents:e.filterData[e.filterNames[0]].filterUIComponents,new i(function(i,s){for(var o=[],r=[],a=1;a<t.length;a++)for(var l=a-1,d=t[a].toFeedUI||[],c=d.length,u=0;u<c;u++){var h=d[u].criteriaType;"context"===h?(o.push(d[u]),-1===r.indexOf(l)&&r.push(l)):"volume"===h&&(d[u].proximityPath=n._getProximityPath(d[u]),o.push(d[u]),-1===r.indexOf(l)&&r.push(l))}0===o.length?i("NoContextFilter"):n._checkForBrokenPath(o).then(function(t){if("PathsOK"===t)i(t);else{var n=[];t.results.forEach(function(e){var t=e.attributes.findIndex(function(e){return"resourceid"===e.name});-1!==t&&n.push(e.attributes[t].value)});for(var s=function(e,i){for(var s=[],o=[],r=[],a=0;a<e.length;a++){for(var l=e[a],d=l.length,c=!1,u=-1,h=0;h<d;h++){var p=l[h],_=n.indexOf(p);-1===_?c=!0:u=_}if(c){var m;s.push(l),-1!==u&&(m=t.results[u].attributes.find(function(e){return"logicalid"===e.name})),o.push(m?m.value:"");var f=l[d-1],g=i.physical.findIndex(function(e){return-1!==e.lastIndexOf(f)});-1!==g&&r.push(i.logical[g])}}return{physical:s,logical:o,logicalDB:r}},a=0;a<o.length;a++){var l={};if(o[a].addedNodesList){for(var d=s(o[a].addedNodesList,e.pathDB.added),c=[],u=0;u<d.physical.length;u++){-1!==(h=o[a].addedNodesList.indexOf(d.physical[u]))&&c.push(o[a].addedNodesList.splice(h,1))}c.length&&(l.allPathsInfo=t,l.brokenAddedNodes=c,l.brokenAddedLabels=[],l.logicalID_OfAddedPaths=d.logical,l.brokenAddedLogicalDB=d.logicalDB)}if(o[a].excludedNodesList){for(d=s(o[a].excludedNodesList,e.pathDB.excluded),c=[],u=0;u<d.physical.length;u++){var h;-1!==(h=o[a].excludedNodesList.indexOf(d.physical[u]))&&c.push(o[a].excludedNodesList.splice(h,1))}c.length&&(l.allPathsInfo=t,l.brokenExcludedNodes=c,l.brokenExcludedLabels=[],l.logicalID_OfExcludedPaths=d.logical,l.brokenExcludedLogicalDB=d.logicalDB)}if(o[a].proximityPath){var p=s(o[a].proximityPath,e.pathDB.proximity);if(p.physical.length){var _=[];p.physical.forEach(e=>{_.push([e])}),l.allPathsInfo=t,l.brokenProximity=_,l.brokenLogicalDB=p.logicalDB}}l.allPathsInfo&&(o[a].repairFilterInfo=l)}i({pathsToFeedUI:o,indexOfGroupViewToRepair:r})}})})},_checkForBrokenPath:function(e){var t=this;return new i(function(i){var n=[];e.forEach(function(e){e.addedNodesList&&(n=n.concat(e.addedNodesList.flat())),e.excludedNodesList&&(n=n.concat(e.excludedNodesList.flat())),e.proximityPath&&(n=n.concat(e.proximityPath.flat()))}),n.length?(n=[...new Set(n)],u.executeFetchLogicalID(n,t.options.pfServiceId).then(function(e){e.results.length===n.length?i("PathsOK"):i(e)})):i("PathsOK")})},createJSONForRepairWebservice:function(){for(var e=[],t=function(e,t){for(var i=[],n=0;n<e.length;n++){for(var s=e[n][0],r=[],a=0;a<s.length;a++){for(var l=s[a],d=!1,c={},u=0;u<o.length;u++){var h=o[u].attributes.findIndex(e=>"resourceid"===e.name);if(l===(-1!==h?o[u].attributes[h].value:"")){var p=o[u].attributes,_="",m="",f="",g="",v="",b="",C="";p.forEach(function(e){var t=e.value;"types/PLMCoreReference"===t?_="PLMCoreReference":"reltypes/PLMCoreInstance"===t?_="PLMCoreInstance":"types/3DShape"===t?_="3DShape":"reltypes/PLMCoreRepInstance"===t?_="PLMCoreRepInstance":"types/PLMCoreRepReference"===t&&(_="PLMCoreRepReference");var i=e.name;"resourceid"===i?f=e.value:"logicalid"===i?m=e.value:"ds6w:label"===i?g=e.value:"type_icon_url"===i?v=e.value:"preview_url"===i?C=e.value:"type"===i&&(b=e.value)}),c={coretype:_,logicalid:m,name:g,physicalid:f,type_icon_url:v,preview_url:C,trueType:b},d=!0}}if(!d){var y=t&&t[n]&&t[n].length?t[n][a]:void 0;c={coretype:"PLMCoreInstance",logicalid:y=y||l,name:"",physicalid:y}}r.push(c)}i.push(r)}return i},i=[],n=0;n<this._toFeedUI.length;n++){var s=this._toFeedUI[n].repairFilterInfo,o=s.allPathsInfo.results,r=s.brokenAddedNodes;if(r&&r.length>0){var a=s.brokenAddedLogicalDB;e=e.concat(t(r,a))}var l=s.brokenExcludedNodes;if(l&&l.length>0){var d=s.brokenExcludedLogicalDB;e=e.concat(t(l,d))}var c=s.brokenProximity;if(c&&c.length>0){var u=s.brokenLogicalDB;e=e.concat(t(c,u))}i.push({added:r?r.length:-1,excluded:l?l.length:-1,proximity:c?c.length:-1})}return{paths:e,dispatch:i}},_repairFilter:function(e){var t=this;if("CancelRepair"==e.listOfList)t._displayFilterPanel(!0);else if(t._displayFilterPanel(!0),t._removeInvalidPaths(e.listOfList),e.listOfList.length>0){var i=[];e.listOfList.forEach(function(e){i=i.concat(e.flat())}),1===(i=[...new Set(i)]).length&&"null"===i[0]||u.executeFetchLogicalID(i,t.options.pfServiceId).then(function(i){var n=i.results,s=[];s.push(e.listOfList),s.push(n);var o={data:s};t.dispatchEvent("RepairFilter_UpdatetUI",o)})}else{t.dispatchEvent("RepairFilter_UpdatetUI",{data:[[],[]]})}},_removeInvalidPaths:function(e){for(var t=0;t<e.length;t++){-1==e[t].indexOf("null")&&0!=e[t].length||(e.splice(t,1),t--)}},_displayFilterPanel:function(e){var t=this.options.options?this.options.options.UXId:void 0;u.showFilterContainer(t,e)},_getProximityPath:function(e){for(var t=[],i=e.allVolumes||[],n=i.length,s=0;s<n;s++){var o=i[s];if(o.allVolumes){var r=this._getProximityPath(o);t=t.concat(r)}else o&&o.parameters&&"proximity"===o.parameters.type&&t.push(o.parameters.root_path_physicalid[0])}return t}})}),define("DS/ENONextGenFilterUX/views/WelcomePageFilterView",["UWA/Class","UWA/Class/View","UWA/Core","DS/WebappsUtils/WebappsUtils","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Controls/Button","DS/Controls/TooltipModel","text!DS/ENONextGenFilterUX/templates/welcomePageViewTemplate.html","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d){"use strict";return t.extend({domEvents:{},setup:function(e){this._template=l.compile(a),this._rootID=e.rootID,this._rootAlias=e.rootAlias,this._rootRevision=e.rootRevision,this.render()},render:function(){this.container.setContent(this._template({filterOnRoot:s.get("OpenFilter"),newFilter:s.get("NewFilter"),newFilterFromExisting:s.get("NewFilterFromExisting")}));var e=this.getElement("#WelcomePageNGF-RetrieveFilter");return this._createOpenFilterUI(e),e=this.getElement("#WelcomePageNGF-NewFilter"),this._createAddCriterionUI(e),e=this.getElement("#WelcomePageNGF-NewFilterFromExisting"),this._createFromExistingUI(e),this},_createAddCriterionUI:function(e){var t=e.getElement(".welcomepage-action-container");this.options.contextUsed&&this._createAddCriterionButton("context",t),this.options.attributeUsed&&this._createAddCriterionButton("attribute",t),this.options.configUsed&&this._createAddCriterionButton("config",t),this.options.volumeUsed&&this._createAddCriterionButton("volume",t)},_createAddCriterionButton:function(e,t){var i,a,l,d;switch(e){case"attribute":i="add_attr_criterion",a=s.get("addAttributeCriterionHmPg"),l=s.get("addAttributeCriterionTooltip"),d=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddAttribute.png");break;case"config":i="add_config_criterion",a=s.get("addConfigurationCriterionHmPg"),l=s.get("addConfigurationCriterionTooltip"),d=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddConfiguration.png");break;case"volume":i="add_volume_criterion",a=s.get("addVolumeCriterionHmPg"),l=s.get("addVolumeCriterionTooltip"),d=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddVolume.png");break;case"context":i="add_context_criterion",a=s.get("addContextCriterionHmPg"),l=s.get("addContextCriterionTooltip"),d=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterAddSelection.png")}var c=new o({touchMode:!0,displayStyle:"normal",showLabelFlag:!0,domId:i,label:a,icon:d});c.inject(t),c.getContent().addClassName("welcomepage-button"),c.tooltipInfos=new r({shortHelp:l,mouseRelativePosition:!0});var u=this;return c.addEventListener("click",function(t){u.dispatchEvent("NGF_WLC_AddCriterion",{type:e})}),c},_createOpenFilterUI:function(e){var t=e.getElement(".welcomepage-action-container");this._createSearchButton(d.FILTER_RELATED_TO_ROOT,t)},_createFromExistingUI:function(e){var t=e.getElement(".welcomepage-action-container");this._createSearchButton(d.FILTER_RELATED_TO_ALL_REVISIONS,t).disabled="3DSpace"!==this.options.pfServiceId,this._createSearchButton("AnyFilter",t)},_createSearchButton:function(e,t){var a,l,c,u,h=d.getRootTitle(this._rootAlias,this._rootRevision);switch(e){case d.FILTER_RELATED_TO_ROOT:a="Search_On_Root",l=i.String.format(s.get("SearchOnRoot"),h),c=i.String.format(s.get("SearchOnRootTooltip"),h),u=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterOpenFilter.png");break;case d.FILTER_RELATED_TO_ALL_REVISIONS:a="Search_On_All_Revisions",l=i.String.format(s.get("SearchOnAllRevisions"),h),c=i.String.format(s.get("SearchOnAllRevisionsTooltip"),h),u=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png");break;case"AnyFilter":a="Search_Any",l=s.get("SearchAny"),c=s.get("SearchAnyTooltip"),u=n.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png")}var p=new o({touchMode:!0,displayStyle:"normal",showLabelFlag:!0,domId:a,label:l,value:a,icon:u});p.inject(t),p.getContent().addClassName("welcomepage-button"),p.tooltipInfos=new r({shortHelp:c,mouseRelativePosition:!0});var _=this;return p.addEventListener("buttonclick",function(e){"Search_On_Root"===e.dsModel.value?_.dispatchEvent("NGF_WLC_RetrieveFilter",{type:d.FILTER_RELATED_TO_ROOT,rootIDs:[_._rootID]}):"Search_On_All_Revisions"===e.dsModel.value?_.dispatchEvent("NGF_WLC_RetrieveFilter",{type:d.FILTER_RELATED_TO_ALL_REVISIONS,rootIDs:[_._rootID]}):"Search_Any"===e.dsModel.value&&_.dispatchEvent("NGF_WLC_RetrieveFilter",{type:d.FILTER_RELATED_TO_ANY_ROOT,query:"[ds6w:type]:ENOStrRefinementSpecification"})}),p}})}),define("DS/ENONextGenFilterUX/utils/FilterCollectionServices",["UWA/Class","UWA/Core","UWA/Class/Options","DS/ENOFilterBIUX/NGFServices","DS/ENONextGenFilterUX/collections/FilterUIGlobalFilterCollection","DS/ENONextGenFilterUX/collections/FilterUIGroupCollection","DS/ENONextGenFilterUX/models/GlobalFilterModel","DS/ENONextGenFilterUX/models/GroupModel","DS/ENONextGenFilterUX/models/CriterionModel","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,n,s,o,r,a,l,d){"use strict";return e.singleton(i,{init:function(){},buildCVQueryFromModel:function(e){var t=this._buildCVQueryFromModel(e);return e.filterCVQuery===t?e.filterCVQuery=t:(n.isDebugActive("ngf")&&(console.log("---------------------------------------  buildCVQueryFromModel  ----------------------------------------"),console.log("filterCVQuery = "+e.filterCVQuery),console.log(" "),console.log("Computed filterCVQuery = "+t),console.log("------------------------------------------------------------------------------------------------------")),e.filterCVQuery=t),t},_buildCVQueryFromModel:function(e){var t=this,i=n.getFilterUIComponents(e),d=i.length,c=new r({state:"init"}),u=new s(null,{model:c}),h=i[0];c.set("combinationOfSpecification",h.toFeedUI.combinationOfSpecification),c.set("minusIndex",h.toFeedUI.minusIndex),c.set("keepChildren",h.toFeedUI.keepChildren||!0),c.set("specVersion",h.toFeedUI.specVersion||n.getCurrentSpecificationVersion());for(var p=1;p<d;p++){var _=i[p],m=new o([],{});let e=new a({groupCollection:m});u.add(e),e.setActivated(_.isActivated||"1");for(var f=_.toFeedUI,g=f.length,v=0;v<g;v++){var b,C=f[v],y=C.criteriaType;if("config"===y||"tag"===y)b=new l,Object.keys(C).forEach(function(e){var t="null"===C[e]?"":C[e];b.set(e,t)}),b.get("isActivated")||b.set("isActivated","1");else if("context"===y){b=new l,Object.keys(C).forEach(function(e){var t="null"===C[e]?"":C[e];b.set(e,t)}),void 0===b.get("addedNodesList")&&b.set("addedNodesList",[]),void 0===b.get("excludedNodesList")&&b.set("excludedNodesList",[]),void 0===b.get("AddNodeActivated")&&b.set("AddNodeActivated",!0),void 0===b.get("ExcludeNodeActivated")&&b.set("ExcludeNodeActivated",!0)}else if("attribute"===y){b=new l,Object.keys(C).forEach(function(e){if("allAttributes"===e){var i=t._buildForComplexAttribute(e,C[e]);b.set(e,i)}else{var n="null"===C[e]?"":C[e];b.set(e,n)}}),b.get("isActivated")||b.set("isActivated","1"),void 0===b.get("Keep")&&b.set("Keep",!0),b.get("extension")||b.set("extension","")}else if("volume"===y){b=new l,Object.keys(C).forEach(function(e){if("allVolumes"===e){var i=t._buildForComplexVolume(e,C[e]);b.set(e,i)}else{var n="null"===C[e]?"":C[e];b.set(e,n)}}),b.get("isActivated")||b.set("isActivated","1")}else if("Sequence"===y){var F=new o([],{});if(b=new a({subGroupCollection:F}),"attribute"===C.sequenceType)Object.keys(C).forEach(function(e){if("allAttributes"===e){var i=t._buildForComplexAttribute(e,C[e]);void 0===i[0].get("Keep")&&i[0].set("Keep",!0),b.get("subGroupCollection").add(i)}else{var n="null"===C[e]?"":C[e];b.set(e,n)}})}b&&m.add(b)}}var A=c.get("keepChildren"),I=e.rootPhysicalId;return u._buildCVQuerySync(I,A)},_buildForComplexAttribute:function(e,t){for(var i=[],n=t.length,s=0;s<n;s++){var o=t[s],r=new l,a=Object.keys(t[s]),d=this;a.forEach(function(t){if(e===t){var i=d._buildForComplexAttribute(t,o[t]);r.set(t,i)}else{var n="null"===o[t]?"":o[t];r.set(t,n)}}),i.push(r)}return i},_buildForComplexVolume:function(e,t){for(var i=[],n=t.length,s=0;s<n;s++){var o=t[s],r=new l,a=Object.keys(t[s]),d=this;a.forEach(function(t){if(e===t){var i=d._buildForComplexVolume(t,o[t]);r.set(t,i)}else{var n="null"===o[t]?"":o[t];r.set(t,n),r.get("isActivated")||r.set("isActivated","1")}}),i.push(r)}return i}})}),define("DS/ENONextGenFilterUX/utils/AttributeChecker",["UWA/Class","UWA/Core","UWA/Class/Options","DS/Controls/ComboBox","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENOFilterBIUX/FBISettings","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r){"use strict";var a=s.get("equals"),l=s.get("notEqual"),d=s.get("contains"),c=s.get("notContains"),u=s.get("startsWith"),h=s.get("endsWith"),p=s.get("lowerThan"),_=s.get("greaterThan"),m=s.get("strictlyLowerThan"),f=s.get("strictlyGreaterThan"),g=s.get("between"),v=(s.get("notBetween"),s.get("on")),b=s.get("before"),C=s.get("after"),y=s.get("strictlyBefore"),F=s.get("strictlyAfter"),A=s.get("isEmpty"),I=s.get("isNotEmpty");return e.singleton(i,{init:function(){},getAttributeOperators:function(e,t){var i;switch(t.type){case"string":i={elementsList:[{labelItem:a,valueItem:"equals"},{labelItem:l,valueItem:"notEqual"},{labelItem:d,valueItem:"contains"},{labelItem:c,valueItem:"notContains"},{labelItem:u,valueItem:"startsWith"},{labelItem:h,valueItem:"endsWith"}],selectedIndex:2};break;case"boolean":i={elementsList:[{labelItem:a,valueItem:"equals"}],selectedIndex:0};break;case"real":case"integer":i={elementsList:[{labelItem:a,valueItem:"equals"},{labelItem:p,valueItem:"lowerThan"},{labelItem:_,valueItem:"greaterThan"},{labelItem:m,valueItem:"strictlyLowerThan"},{labelItem:f,valueItem:"strictlyGreaterThan"},{labelItem:g,valueItem:"between"}],placeholder:s.get("selectOp"),selectedIndex:0};break;case"dateTime":case"timestamp":i={elementsList:[{labelItem:v,valueItem:"on"},{labelItem:C,valueItem:"after"},{labelItem:F,valueItem:"strictlyAfter"},{labelItem:b,valueItem:"before"},{labelItem:y,valueItem:"strictlyBefore"},{labelItem:g,valueItem:"between"}],placeholder:s.get("selectOp"),selectedIndex:0};break;case"enumeration":i={elementsList:[{labelItem:a,valueItem:"equals"}],selectedIndex:0}}return 1===(o.getOption("enableEmptyOperator")||0)&&i.elementsList.push({labelItem:A,valueItem:"isEmpty"},{labelItem:I,valueItem:"isNotEmpty"}),i.domId="attrOp",i.touchMode=r.TOUCH_MODE,i.enableSearchFlag=!1,new n(i)},getForbiddenCharacter:function(e,t,i){var n=[];switch(e){case"string":n=['"',"[","]"]}return n},checkOperatorAndValue:function(e,t,i,n){var s=!0,o="",r=this.getForbiddenCharacterAsRegExp(e,t,n);switch(e){case"string":for(var a,l=RegExp(r,"g");null!==(a=l.exec(i));)o+=a[0];s=!o.length}return{isValid:s,forbidden:o}},getForbiddenCharacterAsRegExp:function(e,t,i){var n="\0$",s=this.getForbiddenCharacter(e,t,i);if(s.length){n="[\\"+s.join("\\")+"\\u0000-\\u001F]"}return n}})}),define("DS/ENONextGenFilterUX/views/VolumeView",["UWA/Core","UWA/Class/View","UWA/Class/Model","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Controls/Button","DS/Controls/LineEditor","DS/Controls/TooltipModel","DS/UIKIT/DropdownMenu","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/NGFServices","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p){"use strict";return t.extend({domEvents:{"click .innerVolumeFilterHeader":"_onVolumeSelected","click .innerVolumeFilter":"_onVolumeSelected"},tagName:"div",className:"attr-edit-inputs-Volume-Master",setup:function(t){this._filterSpecId=t.filterSpecId,this._volSetId=t.volSetId||0,this._idVol=t.idVol,this._volumeId="volume_"+this._filterSpecId+"-"+this._volSetId+"-"+this._idVol,this._masterDiv=this.container,this._masterDiv.id=this._volumeId,this._volDiv=e.createElement("div",{class:"attr-edit-inputs-Attribute"}),this._volDiv.inject(this._masterDiv),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this.listenTo(this.model,"onChange:isActivated",this._onActivateChange.bind(this)),this.listenTo(this.model,"onChange:state",this._onStateChange.bind(this)),this.listenTo(this.model,"onChange:displayName",this._onFilterNameChange.bind(this))},render:function(){this._createVolumeUI();var t=e.createElement("div",{class:"volume-edit-command"});return t.inject(this._masterDiv),this._createVolumeCriterionCtxMenuWUX(t),this},getValues:function(){return{filterSpecId:this._filterSpecId,setId:this._volSetId,id:this.model.get("id"),displayName:this.model.get("displayName"),parameters:this.model.get("parameters")}},_createVolumeUI:function(){this.model.set("id",this._volumeId);var t=s.get("defaultVolumeName");t+="-"+(this._idVol+1),this.model.set("displayName",t),this._volumeUL=e.createElement("ul",{}),this._volumeUL.inject(this._volDiv),this._volumeName=e.createElement("label",{class:"innerVolumeFilterHeader",html:this.model.get("displayName"),id:"name_"+this._volumeId}),this._volumeName.inject(this._volumeUL),this._waitingForDiv=e.createElement("div",{class:"volume-edit-WaitingFor",id:"waitngForDiv_"+this._volumeId}),this._waitingForDiv.inject(this._volumeUL);var i=e.createElement("label",{class:"volume-edit-WaitingFor-Label",html:s.get("WaitingForVolumeSpecifications")+" (",id:"labelVolSpec1_"+this._volumeId});i.inject(this._waitingForDiv);var n=new r({touchMode:!0,displayStyle:"lite",label:s.get("CancelVolumeSpecifications"),id:"cancelVolSpec_"+this._volumeId});n.getContent().addClassName("filter-anchor-style"),n.inject(this._waitingForDiv),(i=e.createElement("label",{class:"volume-edit-WaitingFor-Label",html:")",id:"labelVolSpec2_"+this._volumeId})).inject(this._waitingForDiv);var o=this;n.addEventListener("buttonclick",function(e){o._cancelEditVolume()}),this._renameEditor=this._createRenameVolumeUI(this._volumeName),this._renameEditor.hide()},_onStateChange:function(e,t){var i=this;if("read"===t){var s=this.model.get("parameters");if(s){var o=s.type;if("proximity"===o||"space"===o)if(s.root_path_alias)this._displayVolumeSpecification(s);else{var r=s.root_path_physicalid[0];n.executeFetch(r,[],["ds6w:label","ds6wg:revision"]).then(function(e){var t=n.getAliasesFromFetched(r,e);s.root_path_alias=t,i._displayVolumeSpecification(s)})}else this._displayVolumeSpecification(s);n.isModelActivated(this.model)||this._switchCriterionState()}this._waitingForDiv.hide(),this._contextualMenuWUX=[],this._contextualMenuWUX.push(this._ctxMenuRead[0]),this._contextualMenuWUX.push(this._ctxMenuRead[1]),this._contextualMenuWUX.push(n.isModelActivated(this.model)?this._deactivateItem:this._activateItem),this._contextualMenuWUX.push(this._deleteItem)}else{for(var a=this._volumeUL.getElements("li"),l=a.length-1;l>=0;l--)a[l].addClassName("f-group-deactivated");this._waitingForDiv.show(),this._contextualMenuWUX=this._ctxMenuEdit}},redrawVolumeSpecification:function(){var e=this.model.get("parameters");this._displayVolumeSpecification(e)},_displayVolumeSpecification:function(t){for(var i=this._volumeUL.getElements("li"),o=i.length-1;o>=0;o--)i[o].remove(),i[o].removeClassName("f-group-deactivated");if(t){var r=" "+n.getLengthUnit().symbol,a=s.get(t.type)+",  "+s.get(t.intersection_mode),l=e.createElement("li",{class:"innerVolumeFilter",text:a});switch(l.inject(this._waitingForDiv,"before"),t.type){case"box":t.corner_min=t.corner_min.map(Number),t.corner_max=t.corner_max.map(Number),t.transformation_matrix&&(t.transformation_matrix=t.transformation_matrix.map(Number)),t.transformation_matrix=t.transformation_matrix?t.transformation_matrix:[1,0,0,0,1,0,0,0,1,0,0,0];var d=t.transformation_matrix;let i=[];i.push(t.corner_min),i.push(t.corner_max);let n=i[0][0],o=i[0][1],a=i[0][2],_=i[1][0],m=i[1][1],f=i[1][2];i.push([_,o,a]),i.push([_,m,a]),i.push([n,m,a]),i.push([n,o,f]),i.push([_,o,f]),i.push([n,m,f]);let g=[];i.forEach(e=>{var t=[e[0]*d[0]+e[0]*d[1]+e[0]*d[2]+d[9],e[1]*d[3]+e[1]*d[4]+e[1]*d[5]+d[10],e[2]*d[6]+e[2]*d[7]+e[2]*d[8]+d[11]];g.push(t)});let v=[];g.forEach(e=>{v.push(e[0]+e[1]+e[2])});let b=g[v.indexOf(Math.min(...v))],C=g[v.indexOf(Math.max(...v))];(l=e.createElement("li",{class:"innerVolumeFilter",text:s.get("corner_min")+this._convertValue(b).join(r+", ")+r})).inject(this._waitingForDiv,"before"),(l=e.createElement("li",{class:"innerVolumeFilter",text:s.get("corner_max")+this._convertValue(C).join(r+", ")+r})).inject(this._waitingForDiv,"before");break;case"sphere":t.center=t.center.map(Number),t.radius=parseFloat(t.radius);var c=t.center;(l=e.createElement("li",{class:"innerVolumeFilter",text:s.get("center")+this._convertValue(c).join(r+", ")+r})).inject(this._waitingForDiv,"before"),(l=e.createElement("li",{class:"innerVolumeFilter",text:s.get("radius")+this._convertValue(t.radius)+r})).inject(this._waitingForDiv,"before");break;case"proximity":t.distance=parseFloat(t.distance);var u=" ...";if(t.root_path_alias){var h=t.root_path_alias.length;u=t.root_path_alias[h-1]||" ..."}(l=e.createElement("li",{class:"innerVolumeFilter volume-li-reference",text:s.get("reference")})).inject(this._waitingForDiv,"before");var p=e.createElement("div",{});e.createElement("label",{class:"innerVolumeFilter volume-li-reference-alias",html:u}).inject(p),p.inject(l),(l=e.createElement("li",{class:"innerVolumeFilter",text:s.get("distance")+this._convertValue(t.distance)+r})).inject(this._waitingForDiv,"before");break;case"space":t.distance=parseFloat(t.distance);u=" ...";if(t.root_path_alias){h=t.root_path_alias.length;u=t.root_path_alias[h-1]||" ..."}(l=e.createElement("li",{class:"innerVolumeFilter volume-li-reference",text:s.get("reference")})).inject(this._waitingForDiv,"before");p=e.createElement("div",{});e.createElement("label",{class:"innerVolumeFilter volume-li-reference-alias",html:u}).inject(p),p.inject(l),t.maybe3d&&(l=e.createElement("li",{class:"innerVolumeFilter",text:s.get("maybe3d")+t.maybe3d})).inject(this._waitingForDiv,"before")}}},_convertValue:function(e){var t,i=n.getLengthUnit().unit,s=n.getLengthUnit().decimal;if(Array.isArray(e))t=[],e.forEach(function(e){var n=c.convert(Number(e),"Length","mm",i);t.push(n.toFixed(s))});else{var o=c.convert(Number(e),"Length","mm",i);t=o.toFixed(s)}return t},_onVolumeSelected:function(){this.dispatchEvent("NGF_VolumeSelected",{filterSpecId:this._filterSpecId,setId:this._volSetId,id:this.model.get("id"),displayName:this.model.get("displayName"),parameters:this.model.get("parameters")}),this.model.set("state","edit")},isEmpty:function(){return!this.model.get("parameters")},setFocus:function(){},showAddButtons:function(e){},showRemoveButton:function(e){},_createVolumeCriterionCtxMenuWUX:function(t){var i=e.createElement("span",{});i.addClassName("fonticon fonticon-chevron-down volume-ctx-menu"),i.addClassName("attribute-edit-remove-btn"),i.inject(t),this._activateItem={type:"PushItem",recId:"volume-activate-item-DDCtx",title:s.get("activatedCriteria"),icon:n.getIconByName("eye"),action:{this:this,callback:this._switchCriterionState}},this._deactivateItem={type:"PushItem",recId:"volume-activate-item-DDCtx",title:s.get("deactivatedCriteria"),icon:n.getIconByName("eye-off"),action:{this:this,callback:this._switchCriterionState}},this._deleteItem={type:"PushItem",recId:"volume-delete-item-DDCtx",title:s.get("deleteCriteria"),icon:n.getIconByName("close"),action:{this:this,callback:this._removeVolume}},this._ctxMenuRead=[{type:"PushItem",recId:"volume-edit-item-DDCtx",title:s.get("editCriteria"),icon:n.getIconByName("pencil"),action:{this:this,callback:this._onVolumeSelected}},{type:"PushItem",recId:"volume-rename-item-DDCtx",title:s.get("renameVolume"),icon:n.getIconByName("rename"),action:{this:this,callback:this._renameVolume}},this._deactivateItem,this._deleteItem],this._ctxMenuEdit=[{type:"PushItem",recId:"volume-cancel-item-DDCtx",title:s.get("cancelEdit"),icon:n.getIconByName("undo"),action:{this:this,callback:this._cancelEditVolume}},this._deleteItem],this._contextualMenuWUX=this._ctxMenuRead;var o=this;i.addEventListener("click",function(e){var t=e.target.getBoundingClientRect();p.show(o._contextualMenuWUX,{position:n.getMenuPosition(t)})})},_renameVolume:function(){this._volumeName.hide(),this._renameEditor.show(),this._renameEditor._giveFocus()},_cancelEditVolume:function(){this.model.set("state","read"),this.model.get("parameters")||this._removeVolume({volId:this._volumeId})},_removeVolume:function(){this.dispatchEvent("NGF_RemoveVolume",{volId:this._volumeId})},_switchCriterionState:function(){var e=n.isModelActivated(this.model)?"0":"1";this.model.set("isActivated",e)},_onActivateChange:function(e,t){n.isModelActivated(this.model);var i=this._contextualMenuWUX.findIndex(e=>"volume-activate-item-DDCtx"===e.recId);-1!==i&&(this._contextualMenuWUX[i]=n.isModelActivated(this.model)?this._deactivateItem:this._activateItem);var s=this.getContent();"1"===t?s.removeClassName("f-criterion-deactivated"):s.addClassName("f-criterion-deactivated")},_onFilterNameChange:function(){this._volumeName&&this._volumeName.setHTML(this.model.get("displayName"))},_createRenameVolumeUI:function(e){var t=new a({touchMode:!0,class:"innerVolumeFilterHeader",placeholder:s.get("placeHolderVolumeName"),domId:"rename_"+this._volumeId});t.value=this.model.get("displayName"),t.inject(e,"after");var i=this;t.addEventListener("focus",function(e){e.target.value=i.model.get("displayName")});var n=function(e){e.target.hide(),""!==e.dsModel.value&&i.model.set("displayName",e.dsModel.value),i._volumeName.show()};return t.addEventListener("change",n),t.addEventListener("blur",n),t},volumeViewFromMdl:function(e){this.model.set("displayName",e.displayName),e.parameters&&e.parameters.isRepaired&&(delete e.parameters.isRepaired,this.model.set("state","edit")),this.model.set("parameters",e.parameters),this.model.set("state","read"),"0"===e.isActivated&&this._switchCriterionState()}})}),define("DS/ENONextGenFilterUX/views/AttributeView",["UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Date","DS/Controls/DatePicker","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/utils/AttributeChecker","DS/Controls/ComboBox","DS/Controls/LineEditor","DS/Controls/SpinBox","DS/Controls/Button","DS/Controls/TooltipModel","DS/ENOFilterBIUX/FBISettings","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/WUXAutoComplete/AutoComplete","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v){"use strict";return t.extend({domEvents:{},tagName:"div",className:"attr-edit-inputs-Attribute-Master",setup:function(e){this._widgetId=e.widgetId,this.idAttr=e.idAttr,this.selectedType=e.selectedType,this.selectedExtension=e.selectedExtension,this.attributes=e.xAttributes||[],this._synthesisState=e.synthesisState,this.model.set("attrSetId",e.attrSetId),this._isMultiSelActivated=p.getOption("attribute_MultiSelOnValue",0),this._maxSuggestedValue=p.getOption("attribute_MaxSuggestedValue",100),this._maxSuggestedValue=Number.MAX_VALUE,this._displayTimeInDate=!!o.isTimeInDateActivated(),this._isMigrateToAutoComplete=o.isMigrateToAutoComplete(),this._historicIconName="navigation-history",this._custoIconName="pencil",this._updateMRUMode=0,this._mruPropertyAttributes="attributes",this._mruPropertySearchEditor="searchEditor",this._separatorMRU={labelItem:"",iconItem:{iconName:"list"}},this.displayRemoveButton=e.displayRemoveButton,this._disableAddGroupButton=e.disableAddGroupButton,this._lastSelectedIndex=-1,this._attrDiv=this.getContent(),this._attrDiv.id=this._getId(),o.TOUCH_MODE?this._attrDiv.removeClassName(o.FILTER_TOUCH_CLASSNAME):this._attrDiv.addClassName(o.FILTER_TOUCH_CLASSNAME),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this._isAttrBeingEdited=!1,this._isOperatorBeingEdited=!1,this._hierarchicalItems=[],this._isHierachicalTag=0},render:function(){o.isEasyAttributeDisplayMode()&&this.getContent().setAttribute("filter-easy-attribute",""),this._cmdDiv=e.createElement("div",{class:"attribute-edit-command"}),this._cmdDiv.inject(this._attrDiv);var t=this._cmdDiv;return this.selectedType&&this.attributes&&this._createAttributeUI(),o.TOUCH_MODE?t.removeClassName(o.FILTER_TOUCH_CLASSNAME):t.addClassName(o.FILTER_TOUCH_CLASSNAME),this._addAttributeBtn=this._createAddAttributeButton(t),this.displayAddButtons||this._addAttributeBtn.hide(),this._addAttributeGroupBtn=this._createAddAttributeGroupButton(t),this.displayAddGroupButtons||this._addAttributeGroupBtn.hide(),this._addAttributeGroupBtn.disabled=!!this._disableAddGroupButton,this._addAttributeGroupBtn.active=!this._addAttributeGroupBtn.disabled,this._removeAttributeBtn=this._createRemoveAttributeButton(t),this.displayRemoveButton,this},_getId:function(e){return"attribute_"+(void 0===e?this.idAttr:e)},_cleanAttributes:function(){this.attributeCombo&&(this.attributeCombo.elements.container.remove(),delete this.attributeCombo,this._anyObjectAttrType&&this._anyObjectAttrTypeAnchor.setText(""),this._cleanOperator())},_cleanOperator:function(){this.opCombo&&this.opCombo.elements&&(this.opCombo.elements.container.remove(),delete this.opCombo,this._anyObjectAttrOp&&this._anyObjectAttrOpAnchor.setText(""),this._cleanAttrValuation())},_createAttributeUI:function(){this._cleanAttributes(),this.attributeCombo=this._buildAndFeedCombo("attribute",this.attributes,this.idAttr),v.isActivated("easyAttribute")&&!this._anyObjectAttrType&&(this._anyObjectAttrType=this._buildEasyUI("type",this.attributeCombo.label,this.attributeCombo),this._anyObjectAttrTypeAnchor=this._anyObjectAttrType,o.isEasyAttributeDisplayMode()&&!1!==this._isAttrBeingEdited||this._anyObjectAttrType.hide()),this._isMigrateToAutoComplete?this.attributeCombo.addEventListener("change",this._onSelectAttribute.bind(this)):this.attributeCombo.addEventListener("change",this._onSelectAttributeFromCombo.bind(this))},_onSelectAttribute:function(e){var t=this;t._badCharInValue&&(t._badCharInValue.remove(),t._badCharInValue=void 0);var i=e.dsModel.selectedItems;i?[i].forEach(function(i){var n=i.getAttributeValue("label"),s=t.keepAttrInfosFromLabel[n];if(s){if(!t.model.get("attribute")){var r=s.rangeValues?s.rangeValues.literalInfo:void 0,a=r&&r.length?" / enum":"";v.setUsageTracker(t._widgetId,"NGF-Attribute-Type",s.type+a)}t.model.set("attribute",s),t.model.set("nlsAttribute",n),o.isEasyAttributeDisplayMode()&&!1===t._isAttrBeingEdited&&(e.target.hide(),t._anyObjectAttrType&&t._anyObjectAttrTypeAnchor.show()),t._anyObjectAttrType&&t._anyObjectAttrTypeAnchor.setText(n),t.buildAttrOperator(n,s),t.dispatchEvent("NGF_AttributeSelected",{attrSetId:t._attrSetId})}else t._cleanOperator(),t.model.set("attribute",""),t.model.set("nlsAttribute","")}):(t._cleanOperator(),t.model.set("attribute",""),t.model.set("nlsAttribute",""))},_onSelectAttributeFromCombo:function(e){if(this._badCharInValue&&(this._badCharInValue.remove(),this._badCharInValue=void 0),1!==this._getMRUMode()){var t=this.attributeCombo.elementsList[e.dsModel.selectedIndex];if(t&&this._separatorMRU.labelItem===t.labelItem&&this._separatorMRU.iconItem.iconName===t.iconItem.iconName)this._setMRUMode(1),this.attributeCombo.selectedIndex=this._lastSelectedIndex,this._setMRUMode(0);else{this._lastSelectedIndex=e.dsModel.selectedIndex;var i=e.dsModel.label,n=this.keepAttrInfosFromLabel[i];if(n){if(!this.model.get("attribute")){var s=n.rangeValues?n.rangeValues.literalInfo:void 0,r=s&&s.length?" / enum":"";v.setUsageTracker(this._widgetId,"NGF-Attribute-Type",n.type+r)}this.model.set("attribute",n),this.model.set("nlsAttribute",i),o.isEasyAttributeDisplayMode()&&!1===this._isAttrBeingEdited&&(e.target.hide(),this._anyObjectAttrType&&this._anyObjectAttrTypeAnchor.show()),this._anyObjectAttrType&&this._anyObjectAttrTypeAnchor.setText(i),this.buildAttrOperator(i,n),this.dispatchEvent("NGF_AttributeSelected",{attrSetId:this._attrSetId})}else this._cleanOperator(),this.model.set("attribute",""),this.model.set("nlsAttribute",""),this.attributeCombo.selectedIndex=-1}}},buildAttrOperator:function(e,t){var i=this,n=t.type,s=t.rangeValues||[];this._cleanOperator(),this.opCombo=a.getAttributeOperators(this.model,t),this.opCombo.inject(this._cmdDiv,"before"),this.opCombo.getContent().addClassName("filter-anyobject-off");var r=this.opCombo.value,l=this.opCombo.label;(this._anyObjectAttrOp?this._anyObjectAttrOpAnchor.setText(l):v.isActivated("easyAttribute")&&(this._anyObjectAttrOp=this._buildEasyUI("operator",l,this.opCombo),this._anyObjectAttrOpAnchor=this._anyObjectAttrOp,o.isEasyAttributeDisplayMode()||this._anyObjectAttrOp.hide()),o.isEasyAttributeDisplayMode())&&(!0===this._isOperatorBeingEdited?this._anyObjectAttrOp:this.opCombo).hide();return r&&(this.model.set("attrOp",r),this.model.set("nlsAttrOp",l),this._buildAttrValue(n,s,r,!0)),this.opCombo.addEventListener("change",function(e){var t=i.model.get("attrOp"),o=e.dsModel.value,r=e.dsModel.label;i.model.set("attrOp",o),i.model.set("nlsAttrOp",r),i._anyObjectAttrOp&&i._anyObjectAttrOpAnchor.setText(r);var a=!1;"between"!==t&&"between"===o?a=!0:"between"===t&&"between"!==o&&(a=!0),i._buildAttrValue(n,s,o,a,void 0)}),this.opCombo},_cleanAttrValuation:function(){var e=this._attrDiv,t=[];this.attrValuation?t=["attrValue"]:this.attrValuation1&&(t=["attrValue_1","attrValue_2"]);var i=this;t.forEach(function(t){var n="#"+t,s=i.getContent().getElement(n);if(s){try{e.removeChild(s)}catch(t){t.message;try{e.removeChild(s)}catch(e){e.message}}i.model.set(t,void 0)}}),this.attrValuation=null,this.attrValuation1=null,this.attrValuation2=null,this._anyObjectAttrValue&&this._anyObjectAttrValueAnchor.setText("")},_buildAttrValue:function(e,t,i,n,s){var a=this;if(-1!==["isEmpty","isNotEmpty"].indexOf(i))this.attrValuation?this.attrValuation.getContent().hide():this.attrValuation1&&(this.attrValuation1.getContent().hide(),this.attrValuation2.getContent().hide()),this._EmptyOperator=!0;else if(this._EmptyOperator&&(this._EmtyOperator=!1,n=!0),void 0===n||n){switch(this._cleanAttrValuation(),e){case"string":if(0===a._isEnumeration(t,s))if(o.isSearchEditorForAllActive()){var l=t;Array.isArray(t)&&(l={editable:!0,literalInfo:t}),this.attrValuation=this._buildEnumComboBox(e,"attrValue",l,s)}else{this.attrValuation=new d({touchMode:o.TOUCH_MODE,placeholder:r.get("placeHolderAttrValue"),domId:"attrValue"}),this.attrValuation.inject(this._cmdDiv,"before"),s&&(this.attrValuation.value=s,this.model.set("attrValue",s));var c=(l=t.literalInfo?t.literalInfo:t)?l.length:0;this._maxSuggestedValue<c&&this.attrValuation.getContent().addClassName("max-suggested-value"),this.attrValuation.addEventListener("change",function(e){var t=(e.dsModel.value,e.dsModel.value);t=void 0!==t?t:void 0,a.model.set("attrValue",t)}),this.attrValuation.addEventListener("uncommittedChange",function(t){var i=t.dsModel.valueToCommit;if(void 0!==i){var n=a.opCombo.value;a._checkForbiddenCharacter(e,n,i)}})}else this.attrValuation=this._buildEnumComboBox(e,"attrValue",t,s);break;case"boolean":this.attrValuation=this._buildEnumComboBox(e,"attrValue",t,s);break;case"integer":case"real":-1!==i.indexOf("between")?(this.attrValuation1=this._buildNumSection(e,"attrValue_1",t,s?s[0]:void 0),this.attrValuation2=this._buildNumSection(e,"attrValue_2",t,s?s[1]:void 0)):this.attrValuation=this._buildNumSection(e,"attrValue",t,s);break;case"dateTime":case"timestamp":this._displayTimeInDate=!o.isTimeInDateActivated()||"on"!==i,"between"===i?(this.attrValuation1=this._buildDateSection("attrValue_1",i,s?s[0]:void 0),this.attrValuation2=this._buildDateSection("attrValue_2",i,s?s[1]:void 0)):this.attrValuation=this._buildDateSection("attrValue",i,s)}this.attrValuation?(this.attrValuation.getContent().addClassName("filter-anyobject-off"),o.isEasyAttributeDisplayMode()&&this.attrValuation.getContent().focus()):this.attrValuation1&&(this.attrValuation1.getContent().addClassName("filter-anyobject-off"),this.attrValuation2.getContent().addClassName("filter-anyobject-off"),o.isEasyAttributeDisplayMode()&&this.attrValuation1.getContent().focus())}else switch(e){case"string":if(0===a._isEnumeration(t,s)){i=a.opCombo.value;var u=a.attrValuation.value;a._checkForbiddenCharacter(e,i,u)}break;case"dateTime":case"timestamp":this._cleanAttrValuation(),this._displayTimeInDate=!o.isTimeInDateActivated()||"on"!==i,"between"===i?(this.attrValuation1=this._buildDateSection("attrValue_1",i,s?s[0]:this._currentDateTime),this.attrValuation2=this._buildDateSection("attrValue_2",i,s?s[1]:this._currentDateTime)):this.attrValuation=this._buildDateSection("attrValue",i,s||this._currentDateTime)}},_isEnumeration:function(e,t){var i=e.literalInfo?e.literalInfo:e,n=i?i.length:0,s=0;return 0===(this._maxSuggestedValue>=n?0:1)&&(s=0===n?t&&Array.isArray(t)?1:s:1),s},_checkForbiddenCharacter:function(t,i,n){for(var s=a.getForbiddenCharacterAsRegExp(t,i),o=Array.isArray(n)?n:[n||""],l=o.length,d=!1,c=0;c<l;c++)"string"==typeof o[c]&&(d=d||o[c].match(s));if(d){this.attrValuation.getContent().addClassName("attr-edit-inputs-Attribute-Error");var u=a.getForbiddenCharacter(t,i).join(" "),h="<p>"+r.get("BadCharacters")+": "+u+"</p>";this._badCharInValue?(this._badCharInValue.setHTML(h),this._badCharInValue.show()):this._badCharInValue=new e.Element("div",{class:"attr-edit-inputs-Attribute-Error-BadCharacter",html:h}).inject(this.getContent(),"after")}else this.attrValuation&&this.attrValuation.getContent().removeClassName("attr-edit-inputs-Attribute-Error"),this._badCharInValue&&this._badCharInValue.hide();return!!d},_resetTimeOfDate:function(e){var t=new Date(e);return t.setHours(0,0,0,0),t},_buildDateSection:function(e,t,i){var r,a=this;r=i?new n(n.parse(i)):this._resetTimeOfDate(new Date(Date.now()));var l=new s({touchMode:o.TOUCH_MODE,domId:e,timePickerFlag:this._displayTimeInDate,timePickerPrecision:"sec",value:r});function d(t,i){var n;a._currentDateTime=i,n=o.isTimeInDateActivated()&&"on"!==t?(n=a._currentDateTime.toISOString()).substring(0,n.lastIndexOf("."))+"Z":a._currentDateTime.strftime("%F"),a.model.set(e,n)}return l.inject(this._cmdDiv,"before"),d(t,l.value),l.getContent().addEventListener("change",function(e){d(a.opCombo?a.opCombo.value:"on",e.dsModel.value)}),l},_buildNumSection:function(e,t,i,n){var s;if(0===this._isEnumeration(i,n)){(s=new c({touchMode:o.TOUCH_MODE,domId:t,value:0,stepValue:1,decimals:"integer"===e?0:8,pageStepValue:1})).inject(this._cmdDiv,"before");var r=this;s.addEventListener("change",function(e){var i=(e.dsModel.value,e.dsModel.value);i=void 0!==i?i:void 0,r.model.set(t,i)}),n&&(s.value=n),this.model.set(t,s.value)}else s=this._buildEnumComboBox(e,t,i,n);return s},_buildAndFeedCombo:function(e,t,i){var n,s=this._buildAttributesComboItems(t);if(this._isMigrateToAutoComplete){var a=new _({});a.prepareUpdate(),s.items.forEach(e=>{var t=new m({label:e.labelItem,value:e.valueItem,grid:{label:e.labelItem,value:e.valueItem}});e.iconItem&&t.setIcons([e.iconItem.iconName]),a.addChild(t)}),a.pushUpdate();(n=new f({touchMode:o.TOUCH_MODE,domId:"attrType",placeholder:r.get("placeHolderEnterOrSelectAttrValue"),multiSearchMode:!1,elementsTree:a,allowFreeInputFlag:!1,displayCustomNodeInDropDown:!0})).displayLoader=-1===this._synthesisState,n.getContent().addClassName("attributeCriterion-edit-attribute"),n.inject(this._cmdDiv,"before"),o.TOUCH_MODE?n.getContent().removeClassName("filter-no-touch-mode-no-height"):n.getContent().addClassName("filter-no-touch-mode-no-height")}else(n=new l({domId:"attrType",touchMode:o.TOUCH_MODE,elementsList:s.items,preselectedIndex:s.indexToSelect,placeholder:UWA.String.format(r.get("placeHolderSelectEntity"),r.get(e)),autocompleteFlag:!1,generateRegexpString:function(e){return e}})).inject(this._cmdDiv,"before"),n.getContent().addClassName("filter-anyobject-off");return n},_alphabeticSort:function(e,t){var i=0;return void 0!==e&&void 0!==t&&(i=e.labelItem<=t.labelItem?-1:1),i},destroy:function(){this.stopListening(),this.model=null,this._parent(),this.container=null},_buildEnumComboBox:function(e,t,i,n){var s,a=this,d=[],c=!1,u=!1,h=!!o.isSearchEditorActive();"boolean"!==e||void 0!==i&&0!==i.length?(this._isHierachicalTag=0,(V=i.literalInfo?i.literalInfo:i).forEach(t=>{var i;Array.isArray(t.value)&&0===t.isAggregate?(i=t.value.join("/"),this._isHierachicalTag=1):(i=t.value,"integer"!==e&&"real"!==e||(i=Number.isNaN(Number(i))?o.ATTRIBUTE_NOT_VALUATED:Number(i)));var n=t.nlsValue||t.nlsvalue||i,s={valueItem:i,labelItem:Array.isArray(n)?n.join("/"):n};d.push(s)}),c=i.editable||!1,1===this._isMultiSelActivated&&this.opCombo&&"between"!==this.opCombo.value&&(c=!(u=1<d.length)&&c)):(d=[{labelItem:r.get("true"),valueItem:"true"},{labelItem:r.get("false"),valueItem:"false"}],c=!0,h=!1);var p=c?r.get("placeHolderAttrValue"):r.get("placeHolderSelectAttrValue");if(h&&"string"===e||this._isMigrateToAutoComplete&&(u||c)){var g=new _({}),v=[],b=this._getMRUProperty(this._mruPropertySearchEditor);if(b&&(b.reverse(),b.forEach(function(e){var t=new m({label:e.label,value:e.value,icons:[{iconName:a._historicIconName}],grid:{label:e.label,value:e.value}});v.push(t)})),1===a._isHierachicalTag){for(var C=function(e,t,i){for(var n=[],s=0;s<e.children.length;s++){var o=e.children[s].name,r=t+"/"+o;S.push(o),E.push(r),n[s]=new m({label:o,value:r,grid:{label:o,value:r}}),i.addChild(n[s]),a._hierarchicalItems.push(r),C(e.children[s],r,n[s])}},y=[],F=0;F<d.length;F++){var A=d[F].valueItem.split("/");y.push(A)}for(var I=a._arrangeIntoTree(y),S=[],E=[],N=[],w=0;w<I.length;w++){var x=I[w].name;S.push(x),E.push(x),a._hierarchicalItems.push(x),N[w]=new m({label:x,value:x,grid:{label:x,value:x}}),I[w].children.length&&C(I[w],x,N[w]),v.push(N[w])}}else d.forEach(e=>{var t=new m({label:e.labelItem,value:e.valueItem,icons:[],grid:{label:e.labelItem,value:e.valueItem}});v.push(t)});g.prepareUpdate(),v.forEach(e=>{1===a._isHierachicalTag?g.addRoot(e):g.addChild(e)}),g.pushUpdate();p=c?r.get("placeHolderEnterOrSelectAttrValue"):p,(s=new f({touchMode:o.TOUCH_MODE,domId:t,placeholder:p,multiSearchMode:!0,elementsTree:g,displayCustomNodeInDropDown:!0,getChipInfo:e=>{let t,i=e.getIcons();return(a._isHierachicalTag||i&&i.length)&&(t=e.getAttributeValue("label")),{label:t=void 0!==t?t:s.getDefaultChipInfo(e).label}}})).displayLoader=-1===this._synthesisState,1===a._isHierachicalTag&&(s.filterCB=function(e){s.filterItems(e,{filterId:"stringRegexp",filterOptions:{ensureVisible:!0,keepChildren:!0}})}),s.getContent().addClassName("attributeCriterion-edit-attribute-values"),s.inject(this._cmdDiv,"before"),o.TOUCH_MODE?s.getContent().removeClassName("filter-no-touch-mode-no-height"):s.getContent().addClassName("filter-no-touch-mode-no-height"),s.addEventListener("change",function(i){var n=[],s=i.dsModel.elementsTree;if(s){var o=s.getRoots(),r=o.findIndex(function(e){var t=e.getIcons();return!t.length||a._historicIconName!==t[0].iconName});i.dsModel.selectedItems.forEach(function(t){var i=t.getAttributeValue("label"),l=t.getAttributeValue("value");let d=l;i=1===a._isHierachicalTag&&void 0!==d?d:i;var c,u=0;if(a._checkForbiddenCharacter(e,a.opCombo.value,l))(c=t).setAttribute("value",i);else{var h=-1===r?0:r,p=0;if(1!==a._isHierachicalTag){for(var _=p=h;_<o.length;_++)if(o[_].getAttributeValue("label")===i){c=o[_];break}}else for(_=p;_<a._hierarchicalItems.length;_++)if(void 0!==d){if(a._hierarchicalItems[_]===d){c=t,u=1;break}}else if(a._hierarchicalItems[_]===i){c=t;break}if(!c){for(_=0;_<r;_++)if(o[_].getAttributeValue("label")===i){c=o[_];break}var f;if(c)f=c,c=new m({label:i,value:i,icons:[{iconName:a._custoIconName}],grid:{label:i,value:i}});else{(c=t).setIcons([{iconName:a._custoIconName}]);var g=c.getLabel();void 0!==d?(c.setAttribute("label",d),c.setAttribute("value",d)):(c.setAttribute("label",g),c.setAttribute("value",g))}f&&f.unselect(),1===a._isHierachicalTag?a._hierarchicalItems.push(void 0!==d?g:c.getAttributeValue("value")):s.insertBefore(c,o[r]),c.select(!1),delete c.options.customNode}}var v="";v=1===u&&void 0!==d?d:c.getAttributeValue("value"),n.push(v)})}a.model.set(t,n)})}else(s=new l({domId:t,touchMode:o.TOUCH_MODE,placeholder:p,elementsList:d,enableSearchFlag:c,autocompleteFlag:!1,multiSelFlag:u,_validateOnBlurForTMCAndFilterApp:!0})).inject(this._cmdDiv,"before"),c&&(s.generateRegexpString=function(e){return e}),u&&s.getContent().addClassName("attribute-edit-combo-enum"),s.addEventListener("change",function(i){var n=(i.dsModel.value,i.dsModel.value);n=void 0!==n?n:void 0;a._checkForbiddenCharacter(e,a.opCombo.value,n);a.model.set(t,n)});if(n)if(h&&"string"===e){var V=(i=this.model.get("attribute").rangeValues||[]).literalInfo?i.literalInfo:i,T=[];(Array.isArray(n)?n:[n]).forEach(function(e){var t=V.find(function(t){return t.isAggregate&&Array.isArray(e)?e.sort().toString()===t.value.sort().toString():e===t.value});t?T.push(t.nlsValue||t.nlsvalue):T.push(e)});var D=s.elementsTree,O=D.getRoots(),U=O.findIndex(function(e){var t=e.getIcons();return!t.length||a._historicIconName!==t[0].iconName});D.prepareUpdate(),T.forEach(function(e){var t=O.find(function(t,i){return U<=i&&t.getAttributeValue("label")===e});t||(t=O.find(function(t,i){return U>i&&t.getAttributeValue("label")===e}))||(t=new m({label:e,value:e,icons:[{iconName:a._custoIconName}],grid:{label:e,value:e}}),D.insertBefore(t,O[U])),t.select(!1)}),D.pushUpdate()}else s.value=u?Array.isArray(n)?n:[n]:Array.isArray(n)&&n.length?n[0]:n;return s},_setMRUMode:function(e){this._updateMRUMode=e&&0!==e?1:0},_getMRUMode:function(){return this._updateMRUMode},_updateMRU:function(){var e=this.selectedType||"",t=this.model.get("nlsAttribute")||"";if(0!==e.length&&0!==t.length){var i=this.model.get("attribute")?this.model.get("attribute").value:"",n={label:t.length?t:i,value:i};this._updateMRUProperty(this._mruPropertyAttributes,n,o.MAX_MRU_VALUE);var s=this.model.get("attribute"),r=this.attrValuation?this.attrValuation.elementsTree:"";if(o.isSearchEditorActive()&&"string"===s.type&&r){var a=s.rangeValues||[],l=a.literalInfo?a.literalInfo:a,d=this.model.get("attrValue")||[];d=Array.isArray(d)?d:[d];var c=[];d.forEach(function(e){var t=l.find(function(t){let i=t.value?t.value:t;return e.toString()===i.toString()});c.push({label:t?t.nlsvalue||t.nlsValue:e,value:e})}),this._updateMRUProperty(this._mruPropertySearchEditor,c,o.MAX_MRU_VALUE)}}},_updateMRUProperty:function(e,t,i){for(var n=Array.isArray(t)?t:[t],s=this._getMRUProperty(e),o=s,r=n?n.length:0,a=0;a<r;a++){var l=s.findIndex(function(e){var t=n[a].value,i=e.value;return t&&i?t.toString()===i.toString():t===i});if(-1===l){var d={label:n[a].label?n[a].label:n[a].value,value:n[a].value};o.push(d),o.length>i&&o.shift()}else o.push(s[l]),o.splice(l,1)}this._setMRUProperty(e,o)},_getMRUProperty:function(e){var t,i=(JSON.parse(window.localStorage.getItem("NGF_Most-Recent-Used"))||{})[this.selectedType+"_"+(this.selectedExtension?this.selectedExtension:"NoExtension")]||{};if(this._mruPropertyAttributes===e)t=i.attributes||[];else if(this._mruPropertySearchEditor===e){t=(i.searchEditor||{})[this.getAttrParam().name]||[]}return t},_setMRUProperty:function(e,t){var i="NGF_Most-Recent-Used",n=JSON.parse(window.localStorage.getItem(i))||{},s=this.selectedType+"_"+(this.selectedExtension?this.selectedExtension:"NoExtension"),o=n[s]||{};if(this._mruPropertyAttributes===e)o[e]=t;else if(this._mruPropertySearchEditor===e){var r=this.getAttrParam().name;o[e]||(o[e]={});var a=o[e];a[r]||(a[r]={}),a[r]=t}n[s]=o,window.localStorage.setItem(i,JSON.stringify(n))},updateMRUOfAttrCombo:function(){var e=this;if(0!==(this.selectedType||"").length&&this.attributeCombo){if(this._isMigrateToAutoComplete){var t=(g=this.attributeCombo.elementsTree).getRoots();g.prepareUpdate();for(var i=(v=t.findIndex(t=>{var i=t.getIcons();return!i.length||e._historicIconName!==i[0]}))-1;i>=0;i--)g.removeRoot(t[i]);(d=this._getMRUProperty(this._mruPropertyAttributes)).forEach(function(t){var i=new m({label:t.label,value:t.value,icons:[e._historicIconName],grid:{label:t.label,value:t.value}});g.addChild(i,0)}),g.pushUpdate()}else{var n=this.attributeCombo.elementsList.slice(),s=-1!==this.attributeCombo.selectedIndex?n[this.attributeCombo.selectedIndex]:"",r=-1,a=this._separatorMRU.labelItem,l=this._separatorMRU.iconItem.iconName;for(i=0;i<o.MAX_MRU_VALUE+1;i++)if(i<n.length&&a===n[i].labelItem&&l===n[i].iconItem.iconName){r=i;break}var d=this._getMRUProperty(this._mruPropertyAttributes);for(i=0;i<d.length;i++){var c={labelItem:d[i].label,iconItem:{iconName:this._historicIconName}};n.unshift(c)}0<r&&n.splice(d.length,r),this._setMRUMode(1),this.attributeCombo.elementsList=n;var u=-1;for(i=0;i<n.length;i++)if(s.labelItem===n[i].labelItem){u=i;break}this.attributeCombo.selectedIndex=u}var h=this.getAttrParam(),p=this.attrValuation?this.attrValuation.elementsTree:"";if(o.isSearchEditorActive()&&"string"===h.type&&p){var _=this._getMRUProperty(this._mruPropertySearchEditor);if(_){var f=this.model.get("attrValue");f=Array.isArray(f)?f:[f];var g;t=(g=this.attrValuation.elementsTree).getRoots();g.prepareUpdate();var v=-1,b=-1;t.forEach(function(t,i){var n=t.getIcons();v=n.length&&e._historicIconName===n[0].iconName?i:v,b=n.length&&e._custoIconName===n[0].iconName?i:b}),b=v;for(i=Math.max(v,b);i>=0;i--)g.removeRoot(t[i]);this.attrValuation.selectedItems=[],_.forEach(function(t){var i=new m({label:t.label,value:t.value,icons:[{iconName:e._historicIconName}],grid:{label:t.label,value:t.value}});g.addChild(i,0)}),g.unselectAll(),t=g.getRoots(),f.forEach(function(e){var i=t.findIndex(t=>e===t.getAttributeValue("value"));-1!==i&&t[i].select(!1)}),g.pushUpdate()}}}this._setMRUMode(0)},_checkBounds:function(){var e=!0;if(this.model.get("attrValue"));else if(this.model.get("attrValue_1")){var t=this.model.get("attrValue_1")||this.attrValuation1.value,i=this.model.get("attrValue_2")||this.attrValuation2.value;switch(this.model.get("attribute").type){case"string":break;case"integer":case"real":parseFloat(i)<parseFloat(t)&&(e=!1);break;case"dateTime":case"timestamp":new n(i).getTime()<new Date(t).getTime()&&(e=!1)}e||(this.attrValuation1.value=i,this.attrValuation2.value=t,e=!0)}return e},_createAddAttributeButton:function(e){var t=new u(o.getAttributeButtonStyle("plus"));t.inject(e||this._attrDiv),t.tooltipInfos=new h({shortHelp:r.get("AddAttributeTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-add-btn");var n=this;return t.addEventListener("click",function(e){n.dispatchEvent("NGF_AddAttribute",{})}),t},_createAddAttributeGroupButton:function(e){var t=new u(o.getAttributeButtonStyle("group-add"));t.inject(e||this._attrDiv),t.tooltipInfos=new h({shortHelp:r.get("AddAttributeGroupTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-addGroup-btn");var n=this;return t.addEventListener("click",function(e){n._disableAddGroupButton||n.dispatchEvent("NGF_AddAttributeGroup",{})}),t},_createRemoveAttributeButton:function(e){var t=new u(o.getAttributeButtonStyle("close"));t.inject(e||this._attrDiv),t.tooltipInfos=new h({shortHelp:r.get("RemoveAttribute"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-remove-btn");var n=this;return t.addEventListener("click",function(e){n._badCharInValue&&(n._badCharInValue.remove(),n._badCharInValue=void 0),n.dispatchEvent("NGF_RemoveAttribute",{attrId:n._getId(),idx:n.idAttr})}),t},attrViewFromMdl:function(e){var t="";if("object"==typeof e){var i=e.attribute?e.attribute.uri:e.uri;if(this.attributeCombo){var n=this.keepAttrInfosFromName[i];this.attributeCombo.value=n||"",t=n?t:i}this.opCombo&&e.attrOp&&(this.opCombo.value=e.attrOp);var s=o.ATTRIBUTE_NOT_VALUATED;if(this.attrValuation&&e.attrValue){var r=e.attrValue;let t=Array.isArray(r)&&1===r.length&&!Array.isArray(r[0])?r[0]:r;this.attrValuation.value=s===t?void 0:t}else this.attrValuation1&&e.attrValue_1||this.attrValuation2&&e.attrValue_2?void 0===this.attrValuation1.value&&void 0===this.attrValuation2.value||(this.attrValuation1&&e.attrValue_1&&s!==e.attrValue_1&&(this.attrValuation1.value=e.attrValue_1),this.attrValuation2&&e.attrValue_2&&s!==e.attrValue_2&&(this.attrValuation2.value=e.attrValue_2)):!this.opCombo||this.opCombo&&"between"!==this.opCombo.value?this.attrValuation&&(this.attrValuation.value=void 0):this.attrValuation1&&(this.attrValuation1.value=void 0,this.attrValuation2.value=void 0)}return t},isAttrValid:function(){for(var e="",t="",i=this.getAttrParam(),n=!1,s=i.values.length,l=r.get("InvalidCharInLabel"),d=0;d<s;d++){var c=Array.isArray(i.values[d])?i.values[d].join(""):i.values[d],u=a.checkOperatorAndValue(i.type,i.op,c,i.synthesisValue);if(!u.isValid){e="InvalidCharInValue",t="' "+u.forbidden+" '  "+l+"  "+i.nlsName+" "+i.nlsOp+" "+i.values[0],n=!0;break}}var h=this._checkBounds();h||("boolean"===i.type?(e="badValueDefinedForBoolean",t=i.nlsName+" "+i.nlsOp+" "+i.values[0]):(e="badValueDefined",t=i.nlsName+" "+i.nlsOp+" "+i.values[0]+" "+i.values[1]));var p={isValid:!n&&h,errorKey:e,errorMsg:t},_=this.getElement("#attrValue")||this.getElement("#attrValue_2");if(p.isValid){if(this._isAttrBeingEdited=!1,this._isOperatorBeingEdited=!1,this._updateMRU(),_&&(_.removeClassName("attr-edit-inputs-Attribute-Error"),this._badCharInValue&&this._badCharInValue.hide()),v.isActivated("easyAttribute")){o.setEasyAttributeDisplayMode(!0);var m="",f=this.model.get("attribute");if(f){var b=", ",C=this.model.get("attrOp"),y=this.model.get("attrValue");if(C&&"between"===C&&this.attrValuation1&&(y=[this.model.get("attrValue_1"),this.model.get("attrValue_2")],b=" "+r.get("AND").toLowerCase()+" "),y&&(m=g._buildAttributeValue(f.type,y,f.rangeValues,C,b)),this._anyObjectAttrValue);else{var F=this.attrValuation?this.attrValuation:this.attrValuation2;this._anyObjectAttrValue=this._buildEasyUI("value",m,F),this._anyObjectAttrValueAnchor=this._anyObjectAttrValue}this._anyObjectAttrType.show(),this._anyObjectAttrOp.show(),m=""===m?r.get("NoValueEntered"):m,this._anyObjectAttrValueAnchor.setText(m),this._anyObjectAttrValue.hide(),this.attributeCombo.getContent().hide()}this.opCombo&&this.opCombo.getContent().hide()}}else _&&_.addClassName("attr-edit-inputs-Attribute-Error");return p},getAttrParam:function(){var e=[];void 0!==this.model.get("attrValue")?e.push(this.model.get("attrValue")):void 0!==this.model.get("attrValue_1")&&(e.push(this.model.get("attrValue_1")),e.push(this.model.get("attrValue_2")));var t=this.model.get("nlsAttribute")?this.model.get("nlsAttribute"):"",i=this.keepAttrInfosFromLabel[t],n=t.length?i.type:"",s=i&&i.rangeValues?i.rangeValues.editable:void 0;return{type:n,name:this.model.get("attribute")?this.model.get("attribute").value:"",nlsName:t,op:this.model.get("attrOp"),nlsOp:this.model.get("nlsAttrOp"),values:e,synthesisValue:s}},isAttrEmpty:function(){var e=this.model.get("attribute");return void 0===e||""===e},setFocus:function(){!this._isMigrateToAutoComplete&&this.attributeCombo&&this.attributeCombo._getMainElement().focus()},getParams:function(){return{attribute:this.model.get("attribute"),attrOp:this.model.get("attrOp"),attrValue:this.model.get("attrValue"),attrValue1:this.model.get("attrValue_1"),attrValue2:this.model.get("attrValue_2"),attributes:this.attributes,elementsList:this.attributeCombo.elementsList,keepAttrInfosFromLabel:this.keepAttrInfosFromLabel}},setParams:function(e){if(this.attributes=e.attributes,this.keepAttrInfosFromLabel=e.keepAttrInfosFromLabel,this.attributeCombo.elementsList=e.elementsList,void 0===e.attribute)this.attributeCombo.value="";else{for(var t=Object.keys(this.keepAttrInfosFromLabel),i=0;i<t.length;i++)if(e.attribute.label===this.keepAttrInfosFromLabel[t[i]].label){this.attributeCombo.value=t[i];break}this.opCombo&&(this.opCombo.value=e.attrOp),this.attrValuation?(this.attrValuation.value=e.attrValue,this.getElement("#attrValue_1")&&(this.attrEditInputs.removeChild(this.getElement("#attrValue_1")),this.attrEditInputs.removeChild(this.getElement("#attrValue_2")))):void 0!==this.attrValuation1&&(this.attrValuation1.value=e.attrValue1,this.attrValuation2.value=e.attrValue2,this.getElement("#attrValue")&&this.attrEditInputs.removeChild(this.getElement("#attrValue")))}},compareParams:function(e){var t=!1;return t||(e.attribute&&this.model.get("attribute")?this.model.get("attribute").value!==e.attribute.value&&(t=!0):(e.attribute||this.model.get("attribute"))&&(t=!0)),t||(e.attrOp&&this.model.get("attrOp")?this.model.get("attrOp")!==e.attrOp&&(t=!0):(e.attrOp||this.model.get("attrOp"))&&(t=!0)),t||(e.attrValue&&this.model.get("attrValue")?this.model.get("attrValue")!==e.attrValue&&(t=!0):e.attrValue||this.model.get("attrValue")?t=!0:e.attrValue1&&this.model.get("attrValue_1")?this.model.get("attrValue_1")===e.attrValue1&&this.model.get("attrValue_2")===e.attrValue2||(t=!0):(e.attrValue1||this.model.get("attrValue_1"))&&(t=!0)),t},showAddButtons:function(e){e?(this._addAttributeBtn.show(),this._addAttributeGroupBtn.show()):(this._addAttributeBtn.hide(),this._addAttributeGroupBtn.hide())},showRemoveButton:function(e){e?this._removeAttributeBtn.show():this._removeAttributeBtn.hide()},reBuildAttributesInfos:function(e,t){this._synthesisState=t;var i,n,s=this.attributeCombo.value;s&&(i=this.opCombo?this.opCombo.value:i,this.model.get("attrValue")?n=this.model.get("attrValue"):this.model.get("attrValue_1")&&((n=[]).push(this.model.get("attrValue_1")),n.push(this.model.get("attrValue_2"))));var r=this._buildAttributesComboItems(e);if(this._isMigrateToAutoComplete){var a=this.attributeCombo.elementsTree;a.removeRoots(),a.prepareUpdate(),r.items.forEach(e=>{var t=new m({label:e.labelItem,value:e.valueItem,grid:{label:e.labelItem,value:e.valueItem}});e.iconItem&&t.setIcons([e.iconItem.iconName]),a.addChild(t)}),a.pushUpdate(),1===this._synthesisState&&(this.attributeCombo.displayLoader=!1,this.attrValuation&&(this.attrValuation.displayLoader=!1))}else this.attributeCombo.elementsList=r.items;if(s&&s.length){var l=this.keepAttrInfosFromLabel[s];l?(this.attributeCombo.value=s,this.opCombo.value=i,this._buildAttrValue(l.type,l.rangeValues,i,!0,n)):(this.attributeCombo.value="",o.isEasyAttributeDisplayMode()&&(this._anyObjectAttrType.hide(),this.attributeCombo.show()))}},_buildAttributesComboItems:function(e){var t=this,i=this._getMRUProperty(this._mruPropertyAttributes);if(o.FILTER_ANY_OBJECT===this.selectedType&&i){let t=((JSON.parse(window.localStorage.getItem("NGF_Most-Recent-Used"))||{})[this.selectedType+"_NoExtension"]||{}).searchEditor||{};i.forEach(i=>{if(!e.find(e=>e.curi===i.value)){let n=t[i.value]||[];n=Array.isArray(n)?n:[n];let s=[];n.forEach(e=>{s.push({nlsvalue:e.label,value:e.value,isAggregate:0})}),e.push({curi:i.value,label:i.label,rangeValues:{editable:!0,literalInfo:s.length?s:void 0}})}})}var n=this._buildAttributesInfos(e);this.keepAttrInfosFromLabel=n.infosFromLabel||{},this.keepAttrInfosFromName=n.infosFromName||{};var s=n.maxItemLength,r=n.items,a=[];i&&0!==i.length&&(i.reverse(),i.forEach(function(e){var i=t.keepAttrInfosFromName[e.value]||t.keepAttrInfosFromName[e.name];i&&a.push({labelItem:i,iconItem:{iconName:t._historicIconName}})})),this._isMigrateToAutoComplete||(this._separatorMRU.labelItem="-".repeat(s),a.push(this._separatorMRU));var l=1===r.length?0:-1;return{items:a.concat(r.sort(this._alphabeticSort)),indexToSelect:l}},_buildAttributesInfos:function(e){var t=[],i=0,n={},s={};return e.forEach(function(e){var o;o=e.range&&e.range.dataTypes[0]?e.range.dataTypes[0].split("#")[1]:e.dataTypes?e.dataTypes:e.dataType?e.dataType.split("#")[1]||e.dataType:"string";var r=e.label||e.nlsName,a=e.curi||e.uri,l=a,d=1,c=r;if(s[c]){d=0;var u=s[c];if(u&&u.uri!==a){c=u.label+"("+u.uri+")",s[c]={type:u.type,uri:u.uri,label:u.label,value:u.value,rangeValues:u.rangeValues||[]},delete s[r];for(var h=0;h<t.length;h++)if(t[h].labelItem===u.label){t[h].labelItem=c;break}c=r+"("+a+")",d=1}}else s[c]={};1===d&&(s[c]={type:o,uri:a,label:r,value:l,rangeValues:e.rangeValues||[]},n[l]=c,t.push({labelItem:c}),i=Math.max(i,c.length))}),{infosFromLabel:s,infosFromName:n,items:t,maxItemLength:i}},_buildEasyUI:function(t,i,n){var s=this,r=e.createElement("a",{touchMode:o.TOUCH_MODE,class:"innerfiltertypecombo filter-anyobject-on",text:i}),a=r;switch(a.inject(n.getContent(),"after"),t){case"type":r.id="anyObject_attribute",r.addEventListener("click",function(e){a.hide(),s._isAttrBeingEdited=!0,s._isOperatorBeingEdited=!0,s._anyObjectAttrOp&&s._anyObjectAttrOp.hide(),s._anyObjectAttrValue&&s._anyObjectAttrValue.hide(),s.attributeCombo.show(),s.opCombo.show(),s.attrValuation?s.attrValuation.show():(s.attrValuation1.show(),s.attrValuation2.show())});break;case"operator":r.id="anyObject_operator",r.addEventListener("click",function(e){s._isOperatorBeingEdited=!0,a.hide(),s.opCombo.show()});break;case"value":r.id="anyObject_value",r.addEventListener("click",function(e){a.hide(),s.attrValuation?s.attrValuation.show():(s.attrValuation1.show(),s.attrValuation2.show())})}return a},_arrangeIntoTree:function(e){for(var t=function(e,t,i){for(var n=0;n<e.length&&e[n][t]!==i;)n++;return n<e.length&&e[n]},i=[],n=0;n<e.length;n++)for(var s=e[n],o=i,r=0;r<s.length;r++){var a=s[r],l=t(o,"name",a);if(l)o=l.children;else{var d={name:a,children:[]};o.push(d),o=d.children}}return i}})}),define("DS/ENONextGenFilterUX/views/CriteriaTagView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Promise","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Handlebars/Handlebars4","DS/ENONextGenFilterUX/models/CriterionModel","text!DS/ENONextGenFilterUX/templates/configurationViewTemplate.html","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,n,s,o,r,a,l,d,c,u){"use strict";return e.extend({className:"tagCriterion",setup:function(e){this._parent(e)},render:function(){return this},isCriterionValidate:function(){return 0===c.isAsynchronousValidation()||new n(function(e){e(!0)})},viewFromMdl:function(e){var t={};[e.allfilters,e.localfilters].forEach(e=>{if(e)for(var i in e){var n=e[i];if(n.length){var s=i.split("/"),o=s[s.length-1];n.forEach(e=>{t[o]||(t[o]=[]),t[o]=t[o].concat([e.object])})}}}),Object.keys(t).length&&u.getNlsOfPropertiesValues(t).then(function(t){[e.allfilters,e.localfilters].forEach(e=>{if(e)for(var i in e){var n=e[i];if(n.length){var s=i.split("/"),o=s[s.length-1];n.forEach(e=>{e.disptext=t[o][e.object]})}}})},function(e){console.log(" ==> Compute tags Nls failed ! Err  = "+e)})},isThereCriteria:function(){var e=!1,t=this.model.get("tagData");return t&&(Object.keys(t.allfilters).length||Object.keys(t.localfilters).length)&&(e=!0),e}})}),define("DS/ENONextGenFilterUX/views/VolumeCombinationView",["UWA/Core","UWA/Event","UWA/Class/View","UWA/Class/Model","DS/ENONextGenFilterUX/views/VolumeView","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Controls/ComboBox","DS/Controls/Button","DS/Controls/TooltipModel","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/models/CriterionModel","DS/PlatformAPI/PlatformAPI","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h){"use strict";var p=0,_=0,m=i.extend({domEvents:{},tagName:"div",className:"attribute-edit-group",setup:function(e){this._UXId=e.UXId,this._rootId=e.rootId,this._NGFUXId=e.NGFUXId,this._widgetId=e.widgetId,this._filterSpecId=e.filterSpecId,this._volSetId=e.volSetId||0,this._deepGroup=e.deepGroup||0,this._displayMode=e.displayMode||"light",this._sendEvent=e.sendEvent,this._initCombination=e.initCombination||0,this._volEditInputs=e.volEditInputs,this._listOfVolumes=[],this._subscribe0=u.subscribe("NGFilter_VolumeDefined",this._onVolumeDefined.bind(this)),this._subscribe1=u.subscribe("NGFilter_VolumeDefined_Init",this._onVolumeDefinedInit.bind(this)),this._subscribe2=u.subscribe("NGFilter_CancelVolumeDefined",this._onCancelVolumeDefined.bind(this))},render:function(){var t="combinationVolume_"+this._filterSpecId+this._volSetId;this.container.setAttribute("id",t);var i=this.getContent();this._divCombination=e.createElement("div",{class:"attribute-edit-group-Combination"+(d.TOUCH_MODE?"":" filter-no-touch-mode")}),this._divCombination.inject(this._volEditInputs||i);var n="withAttribute";return this._withLabel=this._createCombinationLabel(n,"with"),this._withLabel.inject(this._divCombination),this._combinationCombo=this._createCombinationCombo(this._initCombination),this._combinationCombo.inject(this._divCombination),n="FollowingCombination",this._followingLabel=this._createCombinationLabel(n,"following"),this._followingLabel.inject(this._divCombination),this._removeBtn=this._createRemoveGroupButton(),this._removeBtn.inject(this._divCombination),this._setDisplayMode(this._displayMode||"light"),this._createVolume(),this},destroy:function(){this._divCombination.destroy(),this._removeVolume(),0!==this._deepGroup||this._listOfVolumes.length||(p=0===this._deepGroup?0:p,_=0,this._subscribe0&&(this._subscribe0.unsubscribe("NGFilter_VolumeDefined"),this._subscribe0=void 0),this._subscribe1&&(this._subscribe1.unsubscribe("NGFilter_VolumeDefined_Init"),this._subscribe1=void 0),this._subscribe2&&(this._subscribe2.unsubscribe("NGFilter_CancelVolumeDefined"),this._subscribe2=void 0)),this.stopListening(),this.model=null,this._parent(),this.container=null},_setDisplayMode:function(e){switch(e){case"none":case"light":this._divCombination.hide();break;case"middle":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.show(),this._followingLabel.show(),this._removeBtn.hide();break;case"full":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.show(),this._followingLabel.show()}},_createCombinationLabel:function(t,i){return e.createElement("label",{class:"innerfiltertypecombo",text:o.get(t),id:"combination-"+i+"_"+this._volSetId})},_createCombinationCombo:function(e){var t=[{labelItem:o.get("AllCombination"),valueItem:"all"},{labelItem:o.get("AnyCombination"),valueItem:"any"}],i=new r({touchMode:d.TOUCH_MODE,elementsList:t,enableSearchFlag:!1,domId:"combination-combo_"+this._volSetId}),n=this;return i.addEventListener("change",function(e){var t=e.dsModel.currentValue;n.model.set("combination",t),n._initCombination=e.dsModel.selectedIndex}),this.model.set("combination",t[e].valueItem),i.selectedIndex=e,i},_createRemoveGroupButton:function(){var e=new a(d.getAttributeButtonStyle("group-delete"));e.tooltipInfos=new l({shortHelp:o.get("RemoveVolumeGroup"),mouseRelativePosition:!0}),e.getContent().addClassName("attribute-edit-button-style attribute-edit-group-remove-btn"+(d.TOUCH_MODE?"":" filter-no-touch-mode"));var t=this;return e.addEventListener("click",function(e){t.dispatchEvent("NGF_RemoveVolumeGroup",{volId:t.container.getAttribute("id")})}),e},_createVolume:function(e){var t=1,i=this.getElement("#actions_"+this._volSetId);i||(t=0,i=this.getContent()),0===this._deepGroup&&this._updateVolumeUI("volume");var n=new c,o=this.model.get("allVolumes")||[];o.push(n),this.model.set("allVolumes",o),this.model.set("state","edit");var r=new s({model:n,filterSpecId:this._filterSpecId,volSetId:this._volSetId,idVol:p});p++,r.render().inject(i,t?"before":""),r.setFocus(),this._showAddButtons(!1),this._listOfVolumes.push(r),this._highlightVolumeGroup(),this.listenTo(r,"NGF_RemoveVolume",this._onRemoveVolume.bind(this)),this.listenTo(r,"NGF_VolumeSelected",this._onSelectedVolume.bind(this)),e?(r.model.set("parameters",e.volume),r.model.set("state","read")):this._sendEvent&&(this._onSelectedVolume(r.getValues()),r.model.set("state","edit"))},_highlightVolumeGroup:function(){var e=window.document.body.getElement(".f-volume-container.edit");if(e){var t=e.getElement(".attribute-edit-group-selected");t&&t.removeClassName("attribute-edit-group-selected")}0!==this._deepGroup&&this.getContent().addClassName("attribute-edit-group-selected")},_onAddVolumeGroup:function(){this._onValidateEditedVolume();var t=1,i=this.getElement("#actions_"+this._volSetId);i||(t=0,i=this.getContent()),0===this._deepGroup&&this._updateVolumeUI("group");var s=new n;s.set("isActivated","1"),s.set("state","edit");var o=this.model.get("allVolumes")||[];o.push(s),this.model.set("allVolumes",o),this.model.set("state","read"),_++;var r=new m({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,model:s,volSetId:_,initCombination:this._initCombination?0:1,displayMode:"full",deepGroup:this._deepGroup+1,sendEvent:this._sendEvent,filterSpecId:this._filterSpecId});r.render().inject(i,t?"before":""),this._showAddButtons(!0),r.getContent().addClassName("subgroupdivborder"),r._highlightVolumeGroup();var a=r._listOfVolumes.length;a&&r._listOfVolumes[a-1].setFocus(),this._listOfVolumes.push(r),this.listenTo(r,"NGF_RemoveVolumeGroup",this._onRemoveVolume.bind(this)),this.listenTo(r,"NGF_ValidateEditedVolume",this._onValidateEditedVolume.bind(this)),r._divAction=e.createElement("div",{class:"attr-edit-actions"+d.FILTER_TOUCH_CLASS,id:"actions_"+_}),r._divAction.inject(r.getContent()),r.addVolumeBtn=r._createAddVolumeButton(r),r.addVolumeBtn.inject(r._divAction),r.addVolumeGroupBtn=r._createAddVolumeGroupButton(r),r.addVolumeGroupBtn.inject(r._divAction)},_showAddButtons:function(e){0===this._deepGroup&&this.dispatchEvent("NGF_DisplayAddActions",{display:e})},_onRemoveVolume:function(e){this._onValidateEditedVolume(),this._removeVolumeAndUpdateUI(e),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId)},_removeVolumeAndUpdateUI:function(e){for(var t=e.volId,i=0;i<this._listOfVolumes.length;i++)if(this._listOfVolumes[i].container.id===t){this._removeVolume(i),1>=this._listOfVolumes.length&&0===this._deepGroup&&this._switchToSingleVolume(),0===this._listOfVolumes.length&&(0!==this._deepGroup?this.dispatchEvent("NGF_RemoveVolumeGroup",{volId:this.getContent().id}):(p=0,this._setDisplayMode("none"),this.dispatchEvent("NGF_RemoveCriterion",{})));break}var n=this._listOfVolumes.length;if(1<=n){var s=this._listOfVolumes[n-1];this._isGroup(s)||0===this._deepGroup?this._showAddButtons(!1):(s.showAddButtons(!0),this._highlightVolumeGroup())}},_removeVolume:function(e){for(var t=e||0,i=e+1||this._listOfVolumes.length,n=i-1;n>=t;n--)this._listOfVolumes[n].destroy();this._listOfVolumes.splice(t,i-t);var s=this.model.get("allVolumes");s&&s.splice(t,i-t),this.model.set("allVolumes",s)},_onVolumeDefinedInit:function(e){this._onVolumeDefined(e)},_onCancelVolumeDefined:function(){0===this._deepGroup&&(this.removeEmptyVolume(),this.model&&this.model.set("state","edit"),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId),u.publish("NGF_Criterion_Edition",{}))},_onVolumeDefined:function(e){if(this._UXId===e.UXId){var t=this,i=function(e){h.setUsageTracker(t._widgetId,"NGF-Volume-Type",e)};if("edit"===this.model.get("state")){if(!(void 0!==e.specId&&this._filterSpecId!==e.specId||void 0!==e.setId&&this._volSetId!==e.setId)){var n,s=e.action;if(e.id)for(var o=this._listOfVolumes.length,r=0;r<o;r++){if((c=this._listOfVolumes[r])&&c.model.get("id")===e.id&&(n=c.model,"add"===s&&"edit"===n.get("state")&&c.isEmpty())){s="update";break}}"add"===s?(i(e.volume.type),this._onValidateEditedVolume(),this.createVolume(e),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId)):"update"===s&&(n||1!==this._listOfVolumes.length||(n=this._listOfVolumes[0].model),n.get("parameters")&&n.get("parameters").type===e.volume.type||i(e.volume.type),n.set("state","edit"),n.set("parameters",e.volume),n.set("state","read")),d.openFilterPanel("volume_"+Date.now())}}else if("add"===e.action&&0===this._deepGroup){i(e.volume.type);var a,l=this._listOfVolumes.length;for(r=0;r<l;r++){var c;if((c=this._listOfVolumes[r])&&"edit"===c.model.get("state")){a=c;break}}a||(this.dispatchEvent("NGF_SwitchToEdit",{}),this.createVolume(e),d.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId),d.openFilterPanel("volume_"+Date.now()))}}},_onValidateEditedVolume:function(){if(0===this._deepGroup){var e=function(t){var i=0;if(t){for(var n=t.get("allVolumes")||[],s=n.length,o=0;o<s&&!i;o++){var r=n[o];r.get("allVolumes")?i=e(r):"edit"===r.get("state")&&(r.set("state","read"),i=1)}t.set("state","read")}};e(this.model)}else this.dispatchEvent("NGF_ValidateEditedVolume",{})},_onSelectedVolume:function(e){this._onValidateEditedVolume(),this.model.set("state","edit");var t={NGFUXId:this._NGFUXId,appId:this._NGFUXId,widgetId:this._widgetId,action:"update",id:e.id,displayName:e.displayName,filteredRoot:this._rootId,volume:e.parameters};u.publish("NGFilter_Volume",t)},_updateVolumeUI:function(e){0===this._listOfVolumes.length?"volume"===e?this._setDisplayMode("light"):"group"===e&&(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._setDisplayMode("none"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this})):1!==this._listOfVolumes.length||this._isGroup(this._listOfVolumes[0])?this._setDisplayMode("full"):(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._listOfVolumes[0].showRemoveButton(!0),this._listOfVolumes[0].showAddButtons(!1),this._setDisplayMode("middle"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this}))},_switchToSingleVolume:function(){if(0===this._listOfVolumes.length)this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this});else if(1===this._listOfVolumes.length)if(this._isGroup(this._listOfVolumes[0]))this._setDisplayMode("none");else{this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group");var e=this._listOfVolumes[0];e.showRemoveButton(!0),e.showAddButtons(!1),this._setDisplayMode("light"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this})}},isVolumeValid:function(){for(var e=[],t=this._listOfVolumes.length,i=0;i<t;i++){var n=this._listOfVolumes[i];if(this._isGroup(n))e=n.isVolumeValid();else{var s=n.isVolumeValid();if(!s.isValid){var o=s.errorKey;void 0===e[o]&&(e[o]=""),e[o]+="<br>   "+s.errorMsg}}}return e},_isGroup:function(e){return!!e._listOfVolumes},removeEmptyVolume:function(){var e=this;this._onValidateEditedVolume();var t=function(i){for(var n=i._listOfVolumes.length-1;n>=0;n--){var s=i._listOfVolumes[n];e._isGroup(s)?t(s):s.isEmpty()&&e._removeVolumeAndUpdateUI({volId:i._listOfVolumes[n].getContent().id})}};t(this)},redrawVolumeSpecification:function(){var e=this,t=function(i){i._listOfVolumes.forEach(i=>{e._isGroup(i)?t(i):i.redrawVolumeSpecification()})};t(this)},viewFromMdl:function(e){var t=this._sendEvent;this._sendEvent=0;var i=e.allVolumes;this._buildVolumeFromModel(i[0]),this._sendEvent=t},_buildVolumeFromModel:function(e){var t=e.allVolumes;this._combinationCombo.currentValue=e.combination;for(var i=t.length,n=0;n<i;n++){if(t[n].allVolumes)this._onAddVolumeGroup(),this._listOfVolumes[this._listOfVolumes.length-1]._buildVolumeFromModel(t[n]);else this._listOfVolumes.length<n+1&&this._createVolume(),this._listOfVolumes[n].volumeViewFromMdl(t[n])}},createVolume:function(e){this._createVolume(e)},createVolumeGroup:function(){this._onAddVolumeGroup()},_createAddVolumeButton:function(e){var t=new a(d.getAttributeButtonStyle("plus"));t.tooltipInfos=new l({shortHelp:o.get("AddVolume"),mouseRelativePosition:!0}),t.getContent().addClassName("attribute-edit-button-style attribute-edit-add-btn2"+(d.TOUCH_MODE?"":" filter-no-touch-mode"));var i=e;return t.addEventListener("click",function(e){i._createVolume()}),t},_createAddVolumeGroupButton:function(e){var t=new a(d.getAttributeButtonStyle("group-add"));return t.tooltipInfos=new l({shortHelp:o.get("AddVolumeGroup"),mouseRelativePosition:!0}),t.getContent().addClassName("attribute-edit-button-style attribute-edit-addGroup-btn2"+(d.TOUCH_MODE?"":" filter-no-touch-mode")),d.MAX_DEEP_VOLUME_GROUP==e._deepGroup?(t.disabled=!0,t.active=!1):t.addEventListener("click",function(t){e._onAddVolumeGroup()}),t}});return m}),define("DS/ENONextGenFilterUX/views/AttributeCombinationView",["UWA/Core","UWA/Event","UWA/Class/View","UWA/Class/Model","DS/ENONextGenFilterUX/views/AttributeView","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Controls/ComboBox","DS/Controls/Button","DS/Controls/TooltipModel","DS/ENONextGenFilterUX/utils/FilterUIService"],function(e,t,i,n,s,o,r,a,l,d){"use strict";var c=i.extend({domEvents:{},tagName:"div",className:"attribute-edit-group",setup:function(e){this._widgetId=e.widgetId,this._attrSetId=e.attrSetId||0,this._combinationId=this._attrSetId,this._deepGroup=e.deepGroup||0,this._displayMode=e.displayMode||"light",this._selectedType=e.selectedType,this._selectedSubType=e.selectedExtension,this._attributes=e.attributesUsed,this._initCombination=e.initCombination||0,this._attrEditInputs=e.attrEditInputs,this._synthesisState=e.synthesisState,this._idAttr=0,this._listOfAttributes=[]},render:function(){var t="combinationAttribute_"+this._combinationId;this.container.setAttribute("id",t);var i=this.getContent();this._divCombination=e.createElement("div",{class:"attribute-edit-group-Combination"+(d.TOUCH_MODE?"":" filter-no-touch-mode")}),this._divCombination.inject(this._attrEditInputs||i);var n="withAttribute";return this._withLabel=this._createCombinationLabel(n,"with"),this._withLabel.inject(this._divCombination),this._combinationCombo=this._createCombinationCombo(this._initCombination),this._combinationCombo.inject(this._divCombination),this._anyObjectCombination.inject(this._combinationCombo.getContent(),"after"),n="FollowingCombination",this._followingLabel=this._createCombinationLabel(n,"following"),this._followingLabel.inject(this._divCombination),this._removeBtn=this._createRemoveGroupButton(),this._removeBtn.inject(this._divCombination),this._setCombinationDisplayMode(this._displayMode),this.createAttribute(),this},destroy:function(){this.cleanAttributes(),this.stopListening(),this.model=null,this._parent(),this.container=null},_setCombinationDisplayMode:function(e){switch(this._displayMode=e,e){case"none":this._divCombination.hide();break;case"light":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.getContent().addClassName("filter-anyobject-off-display-off"),d.isEasyAttributeDisplayMode(),this._anyObjectCombination.hide(),this._followingLabel.hide(),this._removeBtn.hide();break;case"middle":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.getContent().removeClassName("filter-anyobject-off-display-off"),d.isEasyAttributeDisplayMode(),this._anyObjectCombination.show(),this._followingLabel.show(),this._removeBtn.hide();break;case"full":this._divCombination.show(),this._withLabel.show(),this._combinationCombo.getContent().removeClassName("filter-anyobject-off-display-off"),d.isEasyAttributeDisplayMode(),this._anyObjectCombination.show(),this._followingLabel.show(),this._removeBtn.show()}},createAttribute:function(){this._onAddAttribute()},createAttributeGroup:function(){this._onAddAttributeGroup()},_createCombinationLabel:function(t,i){return e.createElement("label",{class:"innerfiltertypecombo",text:o.get(t),id:"combination-"+i+"_"+this._combinationId})},_createCombinationCombo:function(t){var i=[{labelItem:o.get("AllCombination"),valueItem:"all"},{labelItem:o.get("AnyCombination"),valueItem:"any"}],n=new r({touchMode:d.TOUCH_MODE,elementsList:i,enableSearchFlag:!1,domId:"combination-combo_"+this._combinationId});n.getContent().addClassName("filter-anyobject-off filter-anyobject-off-display-off");var s=this;return n.addEventListener("change",function(e){var t=e.dsModel.currentValue;s.model.set("combination",t),s._initCombination=e.dsModel.selectedIndex,s._anyObjectCombinationAnchor.setText(o.get("all"===t?"AllCombination":"AnyCombination"))}),this._anyObjectCombination=e.createElement("label",{class:"innerfiltertypecombo filter-anyobject-on"}),this._anyObjectCombinationAnchor=e.createElement("a",{text:n.currentLabel,id:"anyObject_combination"}),this._anyObjectCombinationAnchor.inject(this._anyObjectCombination),this._anyObjectCombinationAnchor.addEventListener("click",function(e){var t="all"===s.model.get("combination")?"any":"all";s.model.set("combination",t),e.target.setText(o.get("all"===t?"AllCombination":"AnyCombination")),n.currentValue=t}),n.getContent().removeClassName("filter-anyobject-off"),n.hide(),this._anyObjectCombination.removeClassName("filter-anyobject-on"),this._anyObjectCombination.show(),this.model.set("combination",i[t].valueItem),n.selectedIndex=t,n},_createRemoveGroupButton:function(){var e=new a(d.getAttributeButtonStyle("group-delete"));e.tooltipInfos=new l({shortHelp:o.get("RemoveAttributeGroup"),mouseRelativePosition:!0});var t="attribute-edit-button-style"+d.FILTER_TOUCH_CLASS;e.getContent().addClassName(t+" attribute-edit-group-remove-btn");var i=this;return e.addEventListener("click",function(e){var t=i.getContent().getAttribute("id");i.dispatchEvent("NGF_Remove_AttributeGroup",{attrId:t})}),e},_createAttribute:function(){var e=this.getContent();0===this._deepGroup&&this._switchDisplayToMultiAttribute("attribute");var t=new n,i=this.model.get("allAttributes")||[];i.push(t),this.model.set("allAttributes",i);var o=new s({model:t,widgetId:this._widgetId,attrSetId:this._attrSetId,idAttr:this._idAttr,selectedType:this._selectedType,selectedExtension:this._selectedSubType,displayRemoveButton:this._attrSetId||this._listOfAttributes.length?1:0,disableAddGroupButton:d.MAX_DEEP_ATTRIBUTE_GROUP===this._deepGroup?1:0,xAttributes:this._attributes,synthesisState:this._synthesisState});this._idAttr+=1,o.render().inject(e),o.setFocus(),this._showAddButtons(!1),this._listOfAttributes.push(o),this._highlightAttributeGroup();var r=this._listOfAttributes.length;if(0!==this._deepGroup){if(2<=r)for(var a=r-2;a>=0;a--)if(!this._isGroup(this._listOfAttributes[a])){this._listOfAttributes[a].showAddButtons(!1);break}this._listOfAttributes[r-1].showAddButtons(!0)}this.listenTo(o,"NGF_AddAttribute",this._onAddAttribute.bind(this)),this.listenTo(o,"NGF_AddAttributeGroup",this._onAddAttributeGroup.bind(this)),this.listenTo(o,"NGF_RemoveAttribute",this._onRemoveAttribute.bind(this)),this.listenTo(o,"NGF_AttributeSelected",this._onSelectedAttribute.bind(this))},_onAddAttribute:function(){this._createAttribute()},_highlightAttributeGroup:function(){var e=window.document.body.getElement(".f-attribute-container.edit");if(e){var t=e.getElement(".attribute-edit-group-selected");t&&t.removeClassName("attribute-edit-group-selected")}0!==this._deepGroup&&this.getContent().addClassName("attribute-edit-group-selected")},_onAddAttributeGroup:function(){var e=this.getContent();0===this._deepGroup&&this._switchDisplayToMultiAttribute("group");var t=new n,i=this.model.get("allAttributes")||[];i.push(t),this.model.set("allAttributes",i),this._attrSetId+=1;var s=new c({model:t,widgetId:this._widgetId,attrSetId:this._attrSetId,selectedType:this._selectedType,selectedExtension:this._selectedSubType,attributesUsed:this._attributes,initCombination:this._initCombination?0:1,displayMode:"full",deepGroup:this._deepGroup+1,synthesisState:this._synthesisState});s.render().inject(e),s._highlightAttributeGroup(),this._showAddButtons(!0),this.listenTo(s,"NGF_Remove_AttributeGroup",this._onRemoveAttribute.bind(this));var o=s._listOfAttributes.length;o&&s._listOfAttributes[o-1].setFocus(),this._listOfAttributes.push(s),0===this._deepGroup&&2===this._listOfAttributes.length&&!this._isGroup(this._listOfAttributes[0])&&this._listOfAttributes[0].isAttrEmpty()&&(this._onRemoveAttribute({attrId:this._listOfAttributes[0].getContent().id}),this._setCombinationDisplayMode("none"))},_showAddButtons:function(e){0===this._deepGroup&&this.dispatchEvent("NGF_DisplayAddActions",{display:e})},_onRemoveAttribute:function(e){for(var t=e.attrId,i=0;i<this._listOfAttributes.length;i++)if(t===this._listOfAttributes[i].container.id){this._removeAttribute(i),1>=this._listOfAttributes.length&&0===this._deepGroup&&this._switchDisplayToSingleAttribute(),0===this._listOfAttributes.length&&(0!==this._deepGroup?this.dispatchEvent("NGF_Remove_AttributeGroup",{attrId:this.getContent().id}):(this._idAttr=0,this._setCombinationDisplayMode("none"),this.createAttribute(),this._switchDisplayToSingleAttribute()));break}var n=this._listOfAttributes.length;if(1<=n){var s=this._listOfAttributes[n-1];this._isGroup(s)||0===this._deepGroup?this._showAddButtons(!1):(s.showAddButtons(!0),this._highlightAttributeGroup())}},_removeAttribute:function(e){for(var t=e||0,i=e+1||this._listOfAttributes.length,n=i-1;n>=t;n--)this._listOfAttributes[n].destroy();this._listOfAttributes.splice(t,i-t);var s=this.model.get("allAttributes");void 0!==s&&s.splice(t,i-t),this.model.set("allAttributes",s)},_onSelectedAttribute:function(e){},_switchDisplayToMultiAttribute:function(e){0===this._listOfAttributes.length?"attribute"===e?this._setCombinationDisplayMode("light"):"group"===e&&(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._setCombinationDisplayMode("none"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this})):1!==this._listOfAttributes.length||this._isGroup(this._listOfAttributes[0])?this._setCombinationDisplayMode("middle"):(this._divCombination.addClassName("attribute-edit-group"),this.getContent().removeClassName("attribute-edit-group"),this._listOfAttributes[0].showRemoveButton(!0),this._listOfAttributes[0].showAddButtons(!1),this._setCombinationDisplayMode("middle"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:1,combination:this._divCombination,view:this}))},_switchDisplayToSingleAttribute:function(){if(0===this._listOfAttributes.length)this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this});else if(1===this._listOfAttributes.length)if(this._isGroup(this._listOfAttributes[0]))this._setCombinationDisplayMode("none");else{this._divCombination.removeClassName("attribute-edit-group"),this.getContent().addClassName("attribute-edit-group");var e=this._listOfAttributes[0];e.showRemoveButton(!0),e.showAddButtons(!1),this._setCombinationDisplayMode("light"),this.dispatchEvent("NGF_SwitchDisplayContext",{context:0,view:this})}},isAttrValid:function(){for(var e=[],t=this._listOfAttributes.length,i=0;i<t;i++){var n=this._listOfAttributes[i];if(this._isGroup(n))e=n.isAttrValid();else{var s=n.isAttrValid();if(!s.isValid){var o=s.errorKey;void 0===e[o]&&(e[o]=""),e[o]+="<br>   "+s.errorMsg}}}return!d.isEasyAttributeDisplayMode()||"middle"!==this._displayMode&&"full"!==this._displayMode||(this._combinationCombo.getContent().hide(),this._anyObjectCombination.show()),e},_isGroup:function(e){return!!e._listOfAttributes},removeEmptyAttribute:function(){this._removeEmptyAttribute()},_removeEmptyAttribute:function(){for(var e=this._listOfAttributes.length-1;e>=0;e--){var t=this._listOfAttributes[e];this._isGroup(t)?t._removeEmptyAttribute():t.isAttrEmpty()&&this._onRemoveAttribute({attrId:this._listOfAttributes[e].getContent().id})}},updateMRUOfAttribute:function(){for(var e=this._listOfAttributes.length,t=0;t<e;t++){var i=this._listOfAttributes[t];this._isGroup(i)?i.updateMRUOfAttribute():i.updateMRUOfAttrCombo()}},cleanAttributes:function(){this._divCombination.destroy(),this._removeAttribute()},viewFromMdl:function(e){var t=e.allAttributes,i=[];if(1<t.length||1===t.length&&void 0===t[0].allAttributes){var n={};n.allAttributes=t,n.combination="all",i=this._buildAttributeFromModel(n)}else i=this._buildAttributeFromModel(t[0]);return i},_buildAttributeFromModel:function(e){var t=e.allAttributes;this._combinationCombo.currentValue=e.combination;var i=[];if(void 0!==t)for(var n=t.length,s=0;s<n;s++){if(void 0===t[s].allAttributes){this._listOfAttributes.length<s+1&&this._createAttribute();var o=this._listOfAttributes[s].attrViewFromMdl(t[s]);o&&i.push(o)}else{this._onAddAttributeGroup(),o=this._listOfAttributes[this._listOfAttributes.length-1]._buildAttributeFromModel(t[s]),i=i.concat(o)}}return i},saveBeforeEdit:function(){return this._saveBeforeEdit(this)},_saveBeforeEdit:function(e){for(var t=[],i=e._listOfAttributes.length,n=0;n<i;n++){var s=e._listOfAttributes[n];if(this._isGroup(s)){var o=this.model.get("combination"),r=this._saveBeforeEdit(s);t.push({combination:o,attributes:r})}else t.push({combination:this.model.get("combination"),attributes:s.getParams()})}return t},restoreBeforeEdit:function(e){this._restoreBeforeEdit(this,e)},_restoreBeforeEdit:function(e,t){if(e._removeAttribute(),void 0===t)e.createAttribute();else{for(var i=0;i<t.length;i++)Array.isArray(t[i].attributes)?e._onAddAttributeGroup():e.createAttribute();var n=e._listOfAttributes.length;for(i=0;i<n;i++){var s=e._listOfAttributes[i];this._isGroup(s)?(this.model.set("combination",t[i].combination),this._restoreBeforeEdit(s,t[i].attributes)):(this.model.set("combination",t[i].combination),s.setParams(t[i].attributes))}}},updateAttributes:function(e,t){var i=this;this._synthesisState=t,this._attributes=e;!function(e,t){i._listOfAttributes.forEach(n=>{i._isGroup(n)?n.updateAttributes(e,t):n.reBuildAttributesInfos(e,t)})}(e,t)},isThereCriteria:function(){return!!this._listOfAttributes.length}});return c}),define("DS/ENONextGenFilterUX/views/AdvFilterIDCard",["UWA/Core","UWA/Class","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/WAFData/WAFData","DS/CoreEvents/ModelEvents","DS/ENOXIDCard/js/IDCard","DS/i3DXCompassPlatformServices/OpenWith","DS/Controls/Button","DS/Controls/ComboBox","DS/ControlsEx/IDCard","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices","DS/PlatformAPI/PlatformAPI","DS/Menu/Menu","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/UIKIT/Mask"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v,b){"use strict";return t.extend({init:function(e){this._container=e.parent,this._pfServiceId=e.serviceId,this._defaultSC=e.securityContext,this._widgetId=e.widgetId,this._isMaturityContainer=!0,this._isFilterModified=0,this._isOwnerContainer=!!h.isDebugActive("ICLifecycleCmd"),this._isReviseActive=this._isOwnerContainer},setContext:function(e){this._pfServiceId=e.serviceId||this._pfServiceId,this._defaultSC=e.securityContext||this._defaultSC},displayUnsavedChangesPanel:function(e){var t=this._container.getElement("#ngf-idcard-unsaved-values");t&&(e?(t.show(),this._isFilterModified=1):(t.hide(),this._isFilterModified=0))},isFilterModified:function(e){return this._isFilterModified},remove:function(e){this._subscriptionRefreshEvent&&this._subscriptionRefreshEvent.unsubscribe("DS/PADUtils/PADCommandProxy/refresh");var t=this._container.getElement(".global-header-idcard");if(t){var i=t.getElement("#ngf-idcard-id");i&&i.remove()}},updateIDCard:function(e,t){var i=this;return this._activeFilter=e||this._activeFilter,new s(function(n){i._computeOpenWithAppsList(i._activeFilter).then(s=>{i._openWithApps=s,i._initMaturityStateGraph(e).then(s=>{(i._maturityStateGraph=s,i._IDCardModel&&i._container.getElement("#ngf-idcard-id"))||(i._container.getElements("#ngf-idcard-unsaved-values").forEach(e=>{e.remove()}),i._createIDCardTemplate());i.displayUnsavedChangesPanel(!1),i._updateIDCard(e,t).then(()=>{n()})})})})},_createIDCardTemplate:function(){var t=this,i=t._container.getElement(".global-header-idcard"),s=new r;s.addEventListener("ngf-open-actions-menu-event",function(e){var n=i.getElement(".xapp-id-card-container .fonticon-open-down").getBoundingClientRect();e&&(e.stopPropagation(),n=e.target.getBoundingClientRect()),m.show(t._idCardActionsSubMenu,{position:f.getMenuPosition(n)})}),s.addEventListener("ngf-show-version-explorer-event",function(e){t._isReviseActive&&t._launchRevise().then(function(e){t._activeFilter=e,t._updateIDCard(t._activeFilter).then(()=>{})})}),s.addEventListener("idcard-minified",function(e){}),s.addEventListener("idcard-expanded",function(e){h.setUsageTracker(t._widgetId,"NGF-IDCard","expand")}),t._IDCardModel=new n({name:"?",version:"?",thumbnail:v.getWebappsAssetUrl("ENONextGenFilterCmd","icons/32/I_DefineFilter.png"),withHomeButton:!1,withExpandCollapseButton:!1,withActionsButton:!0,withInformationButton:!1,withToggleMinifiedButton:!0,modelEvents:s,attributes:t._getAttributes(),minified:!0,customEvents:{versionLabelClick:{event:"ngf-show-version-explorer-event"},actionsMenuClick:{event:"ngf-open-actions-menu-event"}}});var o=new a({id:"ngf-idcard-id",touchMode:f.TOUCH_MODE,model:t._IDCardModel});o.render().inject(i),o.getContent().addClassName("ngf-idcard"),o.attachResizeSensor();var l=e.Element("div",{id:"ngf-idcard-unsaved-values",class:"ngf-idcard-unsaved-changes"}),d=e.createElement("img",{id:"ngf-idcard-unsaved-icon",src:v.getWebappsAssetUrl("ENONextGenFilterUX","icons/20/filterWarning.png")}),c=e.Element("label",{id:"ngf-idcard-unsaved-msg",text:g.get("ChangesNotSaved")});if(d.inject(l),c.inject(l),l.inject(o.getContent(),"after"),l.hide(),!this._isReviseActive){var u=o.getElement(".version");u&&u.addClassName("ngf-idcard-revision")}i.addEventListener("dragstart",function(e){e.target.style.opacity=.5,e.dataTransfer.effectAllowed="copy",e.dataTransfer.setData("text/plain",t._getDraggedFilterData())}),i.addEventListener("dragend",function(e){h.setUsageTracker(t._widgetId,"NGF-IDCard","dragEnd"),e.target.style.opacity="",e.dataTransfer.clearData("text/plain")}),t._subscriptionRefreshEvent=_.subscribe("DS/PADUtils/PADCommandProxy/refresh",e=>{for(var i=e.data&&e.data.authored?e.data.authored.modified:[],n=i.length,s=0;s<n;s++){var o=i[s];if(t._activeFilter===o||t._activeFilter===o.physicalid){h.getFilterBasics(t._activeFilter,t._defaultSC).then(function(e){var i=e[0][t._activeFilter];t._updateIDCard(t._activeFilter,i),f.openFilterPanel("NGF_IDCard_"+Date.now())},function(e){console.log("=> Edit Properties failed, error ="+e)});break}}}),t._buildAttributesAsContainer(t._container)},_getAttributes:function(){return[{id:"ngf-attr-idcard-maturity",name:g.get("maturityStateIDCardAttr"),value:this._isMaturityContainer?'<div id="ngf-idcard-maturity"></div>':"?",displayWhenMinified:!0,editable:!1,container:!!this._isMaturityContainer,classname:this._isMaturityContainer?"ngf-idcard-maturity-container":""},{id:"ngf-attr-idcard-owner",name:g.get("ownerIDCardAttr"),value:this._isOwnerContainer?'<div id="ngf-idcard-owner"></div>':"?",editable:!!this._isOwnerContainer,container:!!this._isOwnerContainer},{id:"ngf-attr-idcard-collab-space",name:g.get("collabSpaceIDCardAttr"),value:"?",type:"type-text",editable:!1}]},_buildAttributesAsContainer:function(t){var i=this;if(i._isMaturityContainer){var n=t.getElements("#ngf-idcard-maturity"),s=n[0],o=n[1];for(s.addClassName("ngf-idcard-maturity"),o.addClassName("ngf-idcard-maturity");s.firstChild;)s.removeChild(s.firstChild);for(;o.firstChild;)o.removeChild(o.firstChild);var r=e.Element("label",{id:"ngf-idcard-maturity-state",text:"?",class:"ngf-idcard-maturity-state"});s.appendChild(r),o.appendChild(r.cloneNode(!0)),(l=e.Element("a",{id:"ngf-idcard-maturity-next-state-anchor",text:"?",class:"ngf-idcard-maturity-next-state"})).inject(o);var a=e.Element("span",{id:"ngf-idcard-maturity-submenu",class:"wux-ui-3ds fonticon fonticon-chevron-down ngf-idcard-maturity-submenu","font-family":WUXManagedFontIcons.Font3DSs});a.inject(o),l.addEventListener("click",function(e){var t=e.target.getText(),n=Object.keys(i._maturityStateGraph).find(e=>-1!==t.indexOf(i._maturityStateGraph[e].label));n&&i._onSetMaturity({context:{url:f.getMaturityChangeStateUrl(),state:i._maturityStateGraph[n].value}})}),a.addEventListener("click",function(e){var t=e.target.getBoundingClientRect();e&&(e.stopPropagation(),t=e.target.getBoundingClientRect());var n=g.get("setMaturityToIDCardItem"),s=i._idCardActionsSubMenu.filter(e=>-1!==e.title.indexOf(n));m.show(s,{position:f.getMenuPosition(t)})})}if(i._isOwnerContainer){var l,d=t.getElement("#ngf-idcard-owner");(l=e.Element("a",{id:"ngf-idcard-owner-value",text:"?"})).inject(d);var u=["Yves","Maïlys","Raphaële","Alexis"],h=[];["ycn","yxy","rci","ajt3"].forEach((e,t)=>{h.push({valueItem:e,labelItem:u[t]})});var p=new c({touchMode:f.TOUCH_MODE,actionOnClickFlag:!0,elementsList:h,preselectedIndex:0,placeholder:"Select a user ...",autocompleteFlag:!1,generateRegexpString:function(e){return e}});p.inject(d),p.hide(),l.addEventListener("click",function(e){l.hide(),p.show()}),p.addEventListener("change",function(e){var t=e.dsModel.value;t?i._changeOwner(t).then(()=>{i._updateIDCard(i._activeFilter),l.show(),p.hide()},function(e){l.show(),p.hide()}):(l.show(),p.hide())})}},_computeOpenWithAppsList:function(e){var t=this;return this._openWithApps=[],new s(function(i){t._openWith=new l,t._openWith.set3DXContent({data:{items:[{serviceId:t._pfServiceId,envId:h.getTenant(),objectId:e,objectType:"ENOStrRefinementSpecification"}]}}),t._openWith.retrieveCompatibleApps(function(e){i(e)})})},_initMaturityStateGraph:function(){var e=this;return new s(function(t,i){o.authenticatedRequest(f.getMaturityStatesAttributesUrl(),{headers:p.getRESTHeaders(e._defaultSC),method:"POST",data:JSON.stringify({objectids:[e._activeFilter]}),type:"json",proxy:"passport",onComplete:function(e){e.policies.policyName;var i=e.policies.states,n=[];i.forEach(e=>{n.push(e.stateSysName)});var s={};p.getNlsOfPropertiesValues({"ds6w:status":n}).then(e=>{i.forEach(t=>{var i=t.stateSysName;s[i]={value:i,label:e["ds6w:status"][t.stateSysName]||i};var n=t.activeColor,o="white",r="";"Obsolete"===i&&(o=r="#BABABA"),s[i].colors={background:n,font:o,border:r}}),t(s)})},onFailure:function(e){console.log(" ==> Get Maturity State Graph failed: "+e),i(e)}})})},_buildIDCardSubmenu:function(e){var t=this,i=[],n=[];this._openWithApps.forEach(function(e){n.push({type:"PushItem",title:e.text,fonticon:e.fonticon&&e.fonticon.length>0?{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+e.fonticon,family:WUXManagedFontIcons.Font3DS}:void 0,icon:e.icon?e.icon:"",action:{this:t,callback:t._onOpenWith,context:{handler:e.handler,name:e.name}}})}),n.length&&i.push({type:"PushItem",title:g.get("openWithIDCardItem"),icon:f.getIconByName("open-menu-dot"),submenu:n});var s=g.get("setMaturityToIDCardItem"),o=e[1];o&&i.push({type:"PushItem",domId:"global-header-idcard-maturity-demote",title:s+this._maturityStateGraph[o].label,icon:v.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/demote_"+o.toLowerCase()+".png")||f.getIconByName("double-chevron-left"),action:{this:t,callback:t._onSetMaturity,context:{url:f.getMaturityChangeStateUrl(),state:o}}});var r=e[0];return r&&i.push({type:"PushItem",domId:"global-header-idcard-maturity-promote",title:s+this._maturityStateGraph[r].label,icon:v.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/promote_"+r.toLowerCase()+".png")||f.getIconByName("double-chevron-right"),action:{this:t,callback:t._onSetMaturity,context:{url:f.getMaturityChangeStateUrl(),state:r}}}),i.push({type:"PushItem",domId:"global-header-idcard-properties",title:g.get("informartionIDCardItem"),icon:f.getIconByName("info-open-in-a-new-window"),action:{this:t,callback:t._launchEditProperties}}),i},_onSetMaturity:function(e){var t=this,i=this._container.getElement("#ngf-idcard-id")||t._container.getContent();b.mask(i),t._getCSRFToken().then(n=>{var s=e.context.state,r=e.context.url,a=p.getRESTHeaders(t._defaultSC);a.ENO_CSRF_TOKEN=n,o.authenticatedRequest(r,{headers:a,method:"POST",data:JSON.stringify({data:[{id:t._activeFilter,nextState:s}]}),type:"json",proxy:"passport",onComplete:function(e){o.authenticatedRequest(f.getMaturityNextStatesUrl(),{headers:a,method:"POST",data:JSON.stringify({data:[{id:t._activeFilter}]}),type:"json",proxy:"passport",onComplete:function(e){b.unmask(i),h.setUsageTracker(t._widgetId,"NGF-IDCard","maturity"),t._updateIDCard(t._activeFilter,{maturity:s})},onFailure:function(e){b.unmask(i),console.log(" ==> _onSetMaturity / Get Next Maturity State failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage)}})},onFailure:function(e){b.unmask(i),console.log(" ==> _onSetMaturity / Change Maturity failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage)}})},function(e){b.unmask(i),console.log(" ==> _onSetMaturity / getCRSFTokenUrl() failed: "+e)})},_updateMaturityUI:function(e){var t=this._getSurroundingMaturityStates(e);this._idCardActionsSubMenu=this._buildIDCardSubmenu(t);var i=this._container.getElement(".global-header-idcard"),n=this._isMaturityContainer?"#ngf-idcard-maturity-state":"#ngf-attr-idcard-maturity",s=i.getElements(n),o=this._maturityStateGraph[e].colors;if(s.forEach(e=>{var t=o.border?"border: 1px solid "+o.border+";":"",i="background-color:"+o.background+";"+t+"color:"+o.font+";";e.setAttribute("style",i)}),this._isMaturityContainer){var r=t[0]||"Obsolete",a=(s=i.getElements("#ngf-idcard-maturity-next-state-anchor"),g.get("setMaturityToIDCardItem")+this._maturityStateGraph[r].label);s.forEach(e=>{e.setText(a)}),void 0===t[0]&&(s&&s[0].hide(),(s=i.getElements("#ngf-idcard-maturity-submenu"))&&s[0].hide())}},_onOpenWith:function(e){e=e.context;h.setUsageTracker(this._widgetId,"NGF-IDCard-OpenWith",e.name),e.handler.call()},_launchEditProperties:function(e){var t=this;try{require(["DS/EditPropWidget/EditPropComponent","DS/EditPropWidget/constants/EditPropConstants","DS/EditPropWidget/models/EditPropModel"],function(e,i,n){var s=new e({typeOfDisplay:i.ALL,selectionType:i.ALL_SELECTION,displayType:i.POPUP,setCloseButton:!0,setEditButton:!0,readOnly:!1,extraNotif:!1,events:{onCancel:function(){t._subscriptionRefreshEvent.unsubscribe("DS/PADUtils/PADCommandProxy/refresh")}}}),o=new n({tenant:h.getTenant(),objectId:t._activeFilter});h.setUsageTracker(t._widgetId,"NGF-IDCard","properties"),s.show([o])}.bind(this))}catch(e){console.error(e)}},_getSurroundingMaturityStates:function(e){var t=[void 0,void 0],i=Object.keys(this._maturityStateGraph),n=i.indexOf(e);if("Obsolete"!==e){var s=0<=n-1?i[n-1]:void 0;s&&"Released"!==e&&(t[1]=s);var o=i.length-1>=n+1?i[n+1]:void 0;o&&(t[0]=o)}return t},_reviseFilter:function(){var e=this,t=this._container.getElement("#ngf-idcard-id")||e._container.getContent();return b.mask(t),new s(function(i,n){e._getCSRFToken().then(s=>{var r=f.getVersioningUrl(),a={data:[{source:"3DSpace",identifier:e._activeFilter,type:"ENOStrRefinementSpecification",relativePath:"/resources/v1/modeler/dsadvfilter/dsadvfilter:AdvFilter/"+e._activeFilter}]},l=p.getRESTHeaders(e._defaultSC);l.ENO_CSRF_TOKEN=s,o.authenticatedRequest(r,{headers:l,method:"POST",data:JSON.stringify(a),type:"json",proxy:"passport",onComplete:function(e){b.unmask(t),i(e.results[0].id)},onFailure:function(e){b.unmask(t),console.log(" ==> _reviseFilter / Versioning failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage),n(e)}})},function(e){b.unmask(t),console.log(" ==> _reviseFilter / getCRSFTokenUrl() failed: "+e),n(e)})})},_changeOwner:function(e){var t=this,i=this._container.getElement("#ngf-idcard-id")||t._container.getContent();return b.mask(i),new s(function(n,s){var r=t._defaultSC.split("."),a={owner:e,organization:r[1],collabspace:r[2],data:[{id:t._activeFilter}]},l=p.getRESTHeaders(t._defaultSC);l.ENO_CSRF_TOKEN=token,t._getCSRFToken().then(e=>{o.authenticatedRequest(f.getOwnershipUrl(),{headers:l,method:"POST",data:JSON.stringify(a),type:"json",proxy:"passport",onComplete:function(e){b.unmask(i),n()},onFailure:function(e){b.unmask(i),e.errorReport&&e.errorReport.length?console.log(" ==> _changeOwner / Change Owner failed: ("+e.errorReport[0].errorCode+") "+e.errorReport[0].errorMessage):console.log(" ==> _changeOwner / Change Owner failed: "+(e.getMessage?e.getMessage():e)),s(e)}})},function(e){b.unmask(i),console.log(" ==> _changeOwner / getCRSFTokenUrl() failed: "+e),s(e)})})},_updateIDCard:function(t,i){var n=this;return new s(function(s,o){var r=n._IDCardModel.get("name")||"?",a=n._IDCardModel.get("version")||"?",l=n._IDCardModel.get("attributes"),d="?",c="?",u="?",p=n._getAttributes(),_=function(){var t=n._maturityStateGraph[d]?n._maturityStateGraph[d].label:d;n._isMaturityContainer||(p[0].value=t),n._isOwnerContainer||(p[1].value=c),p[2].value=u,n._IDCardModel.set({name:r,version:a,attributes:p}),n._buildAttributesAsContainer(n._container),n._isMaturityContainer&&n._container.getElements("#ngf-idcard-maturity-state").forEach(e=>{e.setText(t)}),n._isOwnerContainer&&n._container.getElement("#ngf-idcard-owner-value").setText(c),h.getFilterBasics(n._activeFilter,n._defaultSC).then(function(e){n._updateMaturityUI(d),s()},function(t){var i="<span>"+e.String.format(g.get("NoFilterAccess"),n._IDCardModel.get("name"))+"</span>",s="<span>"+e.String.format(g.get("SpecificationCopied"),n._IDCardModel.get("name"))+"</span>";f.displayNotification({level:"warning",message:"<span>"+i+"<br>"+s+"</span>"}),n.remove(),n._container.dispatchEvent("NGF_OwnerChangedNewSpecification")})};i&&Object.keys(i).length?(d=i.filterMaturity||i.maturity,n._isMaturityContainer||(d=l[0].value),r=i.filterTitle||i.title||n._IDCardModel.get("name"),a=i.filterRevision||i.revision||n._IDCardModel.get("version"),u=i.filterProject||i.project||l[2].value,c=i.filterOwner||i.owner,n._isOwnerContainer?(c=n._container.getElement("#ngf-idcard-owner-value").getText(),_()):i.filterOwner||i.owner?n._getPersonInfo(c).then(function(e){e.firstname&&e.lastname&&(c=e.firstname+" "+e.lastname,_())}):(c=l[1].value,_())):t?h.getFilterBasics(t,n._defaultSC).then(e=>{var i=e[0][t];d=i.maturity,u=i.project,a=i.revision,r=i.filterTitle,c=i.owner,n._getPersonInfo(c).then(function(e){e.firstname&&e.lastname&&(c=e.firstname+" "+e.lastname,_())})},function(e){console.log(" => Refresh Filter IDCard failed / err = "+e)}):_()})},_getDraggedFilterData:function(){return JSON.stringify({protocol:"3DXContent",version:"1.1",source:"ENOREFS_AP",data:{items:[{envId:h.getTenant(),serviceId:this._pfServiceId,contextId:this._defaultSC,objectId:this._activeFilter,objectType:"ENOStrRefinementSpecification",displayName:this._filterTitle}]}})},_getCSRFToken:function(){var e=this;return new s(function(t,i){o.authenticatedRequest(f.getCRSFTokenUrl(),{headers:p.getRESTHeaders(e._defaultSC),method:"GET",type:"json",proxy:"passport",onComplete:function(e){t(e.csrf.value)},onFailure:function(e){console.log(" ==> _getCSRFToken / getCRSFTokenUrl() failed: "+e),i(e)}})})},_getPersonInfo:function(e){var t=this;return new s(function(i,n){o.authenticatedRequest(f.getPnOUrl()+e,{method:"GET",type:"json",headers:{"DS-API-Version":"1.0",Accept:"application/json","Content-Type":"application/json",securitycontext:t._defaultSC},cache:-1,onComplete:e=>{i(e)},onFailure:e=>{n(e)}})})},getContainer:function(){return this._container}})}),define("DS/ENONextGenFilterUX/views/CriteriaAttributeView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/attributeViewTemplate.html","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/ENONextGenFilterUX/utils/EditToReadManager","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/WUXAutoComplete/AutoComplete","DS/Controls/ComboBox","DS/Controls/Button","DS/UIKIT/Mask","DS/Controls/Loader","DS/ENONextGenFilterUX/views/AttributeCombinationView","DS/Controls/TooltipModel","DS/FedDictionaryAccess/FedDictionaryAccessAPI","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/NGFServices"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v,b,C,y,F){"use strict";return e.extend({domEvents:{"click .attributeCriterion-read .attrRead":"_onEditAttribute","click .attributeCriterion-read .attrRead-multi-attr":"_onEditAttribute"},className:"attributeCriterion",tagName:"li",setup:function(e){this._parent(e),this._isMigrateToAutoComplete=o.isMigrateToAutoComplete(),this._loaderContainer=window.document&&window.document.body?window.document.body.getElement(".f-globalFilter-container"):void 0,this.types=e.types,this._synthesisInfos=e.synthesisInfos,this._synthesisState=e.synthesisState||-1,this.customizeCtxMenu=e.customizeCtxMenu,this.sequenceMode=e.sequenceMode,this.keepValue=!1===e.keepValue||0===e.keepValue?0:1,this._template=r.compile(a),this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this)),this.listenTo(this.model,"onChange:Keep",this.onKeepChange.bind(this)),this.listenTo(this.model,"onChange:type",this.onTypeChange.bind(this)),this.container.addEvent("click",function(e){return e.stopPropagation(),!1}),this._selectedType="",this._selectedSubType="",this._needToQueryServer=!0,this.isCancelEditCrteriaActivated=!1,this._attributesOfType=[],this._attributesOfExtension=[],e.listAttrFromType&&(this.subTypes=e.fromCriterionMdl.subTypes,this._attributesOfType=e.listAttrFromType,this._needToQueryServer=!1,this._keepRemoveCombo=e.fromCriterionMdl.Keep,this._selectedType=e.fromCriterionMdl.type,this._selectedSubType=e.fromCriterionMdl.extension,e.listAttrFromSubType&&(this._attributesOfExtension=e.listAttrFromSubType),this.attributes=this._attributesOfType.concat(this._attributesOfExtension),this._updateAttributesWithSynthesis(this.attributes,this._synthesisInfos)),this._savedBeforeEdit={},this._isTrackerOnTypeSet=0,this._mruTypeKey="types",this._mruExtensionKey="extensions",o.setEasyAttributeDisplayMode(F.isActivated("easyAttribute"))},render:function(){return this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:l.get("titleAttributeUX"),touchMode:o.FILTER_TOUCH_CLASS,iconHeader:d.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_AttributeFilter.png")})),this.attrEditInputs=this.getElement(".attributeCriterion-edit .attr-edit-inputs"),this.attrEditInputsAttr=this.getElement(".attributeCriterion-edit .attr-edit-inputs-allAttributes"),this.attrEditActions=this.getElement(".attributeCriterion-edit .attr-edit-actions"),o.TOUCH_MODE?this.attrEditActions.removeClassName(o.FILTER_TOUCH_CLASSNAME):this.attrEditActions.addClassName(o.FILTER_TOUCH_CLASSNAME),this.attrEditInputsAttr.hide(),this._loaderContainer=this._loaderContainer||this.attrEditInputs,this._createHeaderCtxMenu(),this.addAttributeBtn=this._createAddAttributeButton(this.attrEditActions),this.addAttributeGroupBtn=this._createAddAttributeGroupButton(this.attrEditActions),this._addAttributeSequenceBtn=this._createAddAttrSequenceButton(this.attrEditActions),this._validateButton=this._createValidateButton(),this._setEnableButtons(!1),this.sequenceMode&&this._addAttributeSequenceBtn.hide(),this.createKeepRemoveDropDown(this.keepValue),this.setSequenceMode(this.sequenceMode),this},onTypeChange:function(e,t){this._validateButton&&t&&(this._validateButton.disabled=!1)},_createValidateButton:function(){var e=new m(o.getAttributeValidateButtonStyle());e.inject(this.attrEditActions),e.tooltipInfos=new b({shortHelp:l.get("ValidateCriteria"),mouseRelativePosition:!0});var t="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;e.getContent().addClassName(t+" attributeCriterion-edit-validate"+(this.sequenceMode?"":" colorized"));var i=this;return e.addEventListener("buttonclick",function(){0===o.isAsynchronousValidation()?i.isCriterionValidate()&&(i._savedBeforeEdit={},i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")})):i.isCriterionValidate().then(function(e){if(e&&(F.setUsageTracker(i._widgetId,"NGF-Attribute-OnType",i.typeCombo.value),i._isTrackerOnTypeSet=1,i._savedBeforeEdit={},i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")})),i._isMigrateToAutoComplete){var t=i.typeCombo.selectedItems;t&&i._updateMRUProperty(i._mruTypeKey,{label:t.getAttributeValue("label"),value:t.getAttributeValue("value")},o.MAX_MRU_VALUE);var n=i.subTypeCombo.selectedItems;n&&i._updateMRUProperty(i._mruExtensionKey,{label:n.getAttributeValue("label"),value:n.getAttributeValue("value")},o.MAX_MRU_VALUE)}})}),e},_createAddAttrSequenceButton:function(e){var t=new m(o.getAttributeButtonStyle("list-ordered"));t.inject(e),t.tooltipInfos=new b({shortHelp:l.get("AddAttributeSequence"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-addSequence-btn");var n=this;return t.addEventListener("buttonclick",function(e){F.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Sequence"),n.dispatchEvent("NGF_SwitchCriterionToSequence",{type:n.model.get("criteriaType"),idxView:n.cid,attributeKeep:n.model.get("Keep")})}),t},isCriterionValid:function(){var e="read"!==this.model.get("state"),t=!e;if(e){var i=this._attrCombinationView.isAttrValid(),n=Object.keys(i);if(t=!n.length)o.isEasyAttributeDisplayMode()?(this._anyObjectObject.show(),this._anyObjectKeep.show(),this._keepRemoveCombo.getContent().hide(),this.typeCombo.getContent().hide(),o.FILTER_ANY_OBJECT!==this._selectedType&&(this._extensionLabel.show(),this._extensionBtn.show(),this.subTypeCombo.getContent().hide())):(this._anyObjectObject&&this._anyObjectObject.hide(),this.typeCombo.getContent().show());else{for(var s="",r=0;r<n.length;r++){var a=n[r];s+=0===r?l.get(a)+i[a]:"<br><br>"+(r+1)+". "+l.get(a)+i[a]}s.length&&(s=1<n.length?"1. "+s:s,o.displayNotification({level:"error",message:s}))}}return t},isCriterionValidate:function(){var e,t=this;if(0===o.isAsynchronousValidation())return(e="read"===this.model.get("state"))||(e=this.isCriterionValid())&&(t._attrCombinationView.removeEmptyAttribute(),o.isModelActivated(t.model)||!0!==t._isCriterionModified()||t._switchCriterionState()),e;if(e="read"===this.model.get("state"))return new s(function(e){e(!0)});var i=this.isCriterionValid();return new s(i?function(e){t._attrCombinationView.removeEmptyAttribute(),o.isModelActivated(t.model)||!0!==t._isCriterionModified()||t._switchCriterionState(),e(!0)}:function(e){e(!1)})},_getCallbackToEditCriterion:function(){return this.editAttribute.bind(this)},editAttribute:function(){this._savedBeforeEdit=c.getAttributeValues(this.model),this._savedBeforeEdit.types=this.types,this._savedBeforeEdit.subTypes=this.subTypes,this._savedBeforeEdit.attributes=this.attributes,this.subTypeCombo&&(this._savedBeforeEdit.elementsListExtension=this.subTypeCombo.elementsList),this._savedBeforeEdit.typeInfosLabel=this._keepTypeInfosFromLabel,this._savedBeforeEdit.subTypeInfosLabel=this._keepExtensionInfosFromLabel;var e=this._attrCombinationView.saveBeforeEdit();this._savedBeforeEdit.saveAttributes=e,this._savedBeforeEdit.asString=JSON.stringify(this.model.keepComponentsToFeedUI(!0)),this.model.set("state","edit")},_cancelEditCriteria:function(){if(this._isCriterionModified()){if(this.isCancelEditCrteriaActivated=!0,void 0===this._savedBeforeEdit.type){if(F.isActivated("easyAttribute"))this.typeCombo.value="anyObject";else{if(this._isMigrateToAutoComplete){var e=this.subTypeCombo.elementsTree;this.typeCombo.selectedItem=[e.getRoots(0)]}else this.typeCombo.selectedIndex=0;this._extensionBtn.show()}this._keepRemoveCombo.value=!0,this._extensionBtn&&(this.subTypeCombo.value="",this.subTypeCombo.hide()),this._attrCombinationView.restoreBeforeEdit(this._savedBeforeEdit.saveAttributes)}else{this._keepRemoveCombo.value=void 0===this._savedBeforeEdit.Keep||this._savedBeforeEdit.Keep,this.types=this._savedBeforeEdit.types,this._keepTypeInfosFromLabel=this._savedBeforeEdit.typeInfosLabel;for(var t=Object.keys(this._keepTypeInfosFromLabel),i=0;i<t.length;i++)if(this._savedBeforeEdit.type===this._keepTypeInfosFromLabel[t[i]].value){this.typeCombo.value=this._keepTypeInfosFromLabel[t[i]].value;break}if(this.subTypes=this._savedBeforeEdit.subTypes,this._keepExtensionInfosFromLabel=this._savedBeforeEdit.subTypeInfosLabel,this.subTypeCombo.elementsList=this._savedBeforeEdit.elementsListExtension,void 0===this._savedBeforeEdit.extension)this._extensionBtn.show(),this.subTypeCombo.hide(),this.subTypeCombo.value="";else for(t=Object.keys(this._keepExtensionInfosFromLabel),i=0;i<t.length;i++)if(this._savedBeforeEdit.extension===this._keepExtensionInfosFromLabel[t[i]].value){this.subTypeCombo.value=this._keepExtensionInfosFromLabel[t[i]].value;break}this._attrCombinationView.restoreBeforeEdit(this._savedBeforeEdit.saveAttributes),this._savedBeforeEdit&&c.setAttributeValues(this.model,this._savedBeforeEdit)}this.isCancelEditCrteriaActivated=!1}},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},onKeepChange:function(e){!1===e.get("Keep")?this.dispatchEvent("NGF_AttrKeepToRemoveMode"):this.dispatchEvent("NGF_AttrRemoveToKeepMode")},_onDelayedEditAttribute:function(){this.onStateChange(this.model,"edit")},onStateChange:function(e,t){var i=e.criterionToString();if("string"==typeof i||Array.isArray(i)){this._isTrackerOnTypeSet||(F.setUsageTracker(this._widgetId,"NGF-Attribute-OnType",this.typeCombo.value),this._isTrackerOnTypeSet=1);var n=this.getElement(".f-attribute-container");n&&n.setAttribute("class","f-attribute-container "+t);this.customizeCtxMenu;if("read"===t){var s=Array.isArray(i)?i:[i],o=s[0],r=s[1];s.shift(),s.shift();var a=this.getElement(".attrRead#prefix");if(a.setContent([{tag:"span",html:o}]),s.length){s=[r].concat(s);var l=this._getAttributeHTML(s);a=this.getElement(".attrRead#value").hide(),(a=this.getElement(".attrRead-multi-attr").show()).setContent([{html:l}])}else a=this.getElement(".attrRead-multi-attr").hide(),(a=this.getElement(".attrRead#value").show()).setContent([{tag:"span",html:r}]);this._setContextualMenu("read")}else{if(-1===this._synthesisState)this.dispatchEvent("NGF_ComputeSynthesis",{callback:this._onDelayedEditAttribute.bind(this)});else{this.isThereCriteria()&&!this._attrCombinationView.isThereCriteria()&&this._attrCombinationView.createAttribute();var d=this.getElement("#"+this._getId()+" .criteriaIcon");this.sequenceMode?d.hide():d.show(),this._setContextualMenu("edit"),F.isActivated("easyAttribute"),this._attrCombinationView.updateMRUOfAttribute()}this.dispatchEvent("NGF_Criterion_SwitchedToEdit",{type:this.model.get("criteriaType"),state:1})}}else"object"==typeof i&&console.log("Criteria Attribute Error / Invalid expected type on state change")},_getAttributeHTML:function(e){for(var t="",i=0;i<e.length;i++)if(Array.isArray(e[i])){var n=e[i];t+="<li>"+n[0],t+='<ul class="attrRead-multi-attr"><div>',n.shift(),t+=this._getAttributeHTML(n),t+="</div></ul></li>"}else t+="<li>"+e[i]+"</li>";return t},createKeepRemoveDropDown:function(e){var i=[{labelItem:l.get("keep"),valueItem:!0},{labelItem:l.get("remove"),valueItem:!1}];this._keepRemoveCombo=new _({touchMode:o.TOUCH_MODE,elementsList:i,placeholder:l.get("keepRemoveLabel"),enableSearchFlag:!1,selectedIndex:e?0:1}),this._keepRemoveCombo.inject(this.attrEditInputs),this._keepRemoveCombo.getContent().addClassName("filter-anyobject-off"),this.model.set("Keep",!!e);var n=this;this._keepRemoveCombo.addEventListener("change",function(e){n.model.set("Keep",e.dsModel.value),n._anyObjectKeepAnchor&&n._anyObjectKeepAnchor.setText(e.dsModel.label)}),(n=this)._anyObjectKeep=t.createElement("label",{class:"innerfiltertypecombo filter-anyobject-on"}),n._anyObjectKeep.inject(n._keepRemoveCombo.getContent(),"after"),n._anyObjectKeepAnchor=t.createElement("a",{text:l.get(e?"keep":"remove"),id:"anyObject_keep"}),n._anyObjectKeepAnchor.inject(n._anyObjectKeep),n._anyObjectKeepAnchor.addEventListener("click",function(e){if(!e.target.disabled){var t=!n.model.get("Keep");n.model.set("Keep",t),e.target.setText(l.get(t?"keep":"remove")),n._keepRemoveCombo.value=t}});var s=!this.sequenceMode;this.setEnableKeepRemove(s),n._keepRemoveCombo.getContent().removeClassName("filter-anyobject-off"),n._keepRemoveCombo.hide(),n._anyObjectKeep.removeClassName("filter-anyobject-on")},buildFilteredTypeUIAsync:function(e,t){var i=this;return new s(function(n){i.buildFilteredTypeUI(e,t),n()})},buildFilteredTypeUI:function(e,i){if(this.types=e?t.clone(e):void 0,this.types){var n=o.isEasyAttributeDisplayMode(),s=-1;if(n&&-1===(s=this.types.findIndex(e=>o.FILTER_ANY_OBJECT===e.name))&&(this.types.push({nlsName:l.get("anyObject"),name:o.FILTER_ANY_OBJECT}),s=this.types.length-1),this.typeCombo=this._buildAndFeedCombo("type",this.types,this._childGroupId),this.typeCombo.addEventListener("change",this._onSelectType.bind(this)),n&&!this._anyObjectObject&&(this._buildEasyUI(),this._anyObjectObject.show(),this._anyObjectKeep.show(),this._keepRemoveCombo.getContent().hide(),this.typeCombo.getContent().hide()),void 0===i)if(n)i=s;else i=-1===(i=this.types.findIndex(function(e){return!(!e||"VPMReference"!==e.name)}))?0:i;this.typeCombo.value=this.types.length?this.types[i].name:""}},_onSelectType:function(e){var t;if(this._isMigrateToAutoComplete){var i=e.dsModel.selectedItems;t=i?i.getAttributeValue("label"):void 0}else t=e.dsModel.label;var n=e.dsModel.value;if(n){this._keepTypeInfosFromLabel[t]||(this._keepTypeInfosFromLabel[t]={}),this._keepTypeInfosFromLabel[t]={value:n},this._isTrackerOnTypeSet=0;var s=this.model.get("type");if(this._needToQueryServer=!this.isCancelEditCrteriaActivated&&this._selectedType!==n,this._selectedType=n,this.model.set("type",n),this.model.set("nlsType",t),this._anyObjectObject&&this._anyObjectObjectAnchor.setText(t),o.setEasyAttributeDisplayMode(!1),o.FILTER_ANY_OBJECT===n)o.setEasyAttributeDisplayMode(!0),this.getElements(".filter-anyobject-off").forEach(e=>e.hide()),this.getElements(".filter-anyobject-on").forEach(e=>e.show());o.FILTER_ANY_OBJECT===s&&this._switchUIFromObjectsToType(n),this._cleanSubTypes(),F.isActivated("easyAttribute")&&this._buildExtensionUI(),this._selectAttributes(n),this._setEnableButtons(!0)}else this._cleanTypes(),this._setEnableButtons(!1);this._selectedSubType="",this._attributesOfExtension=[],this.model.set("extension",""),this.model.set("nlsExtension","")},_buildEasyUI:function(){var e=this;e.getElements(".filter-anyobject-on").forEach(e=>e.remove()),e._anyObjectObject=t.createElement("label",{class:"innerfiltertypecombo filter-anyobject-on"}),e._anyObjectObject.inject(e.typeCombo.getContent(),"after"),e._anyObjectObjectAnchor=t.createElement("a",{text:l.get("anyObject"),id:"anyObject_object"}),e._anyObjectObjectAnchor.inject(e._anyObjectObject),e._anyObjectObjectAnchor.addEventListener("click",function(t){e._anyObjectObject.hide(),e.typeCombo.show()})},_getAttributesOfType:function(e){return new s(function(t,i){var n=[];n.push("ds6wg:"+e);var s=[];C.getPropertiesForClass(n,{tenantId:F.getTenant(),lang:y.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(e){e.forEach(function(e){var t=e.properties;t.forEach(function(e){e.rangeValues&&(e.rangeValues={literalInfo:e.rangeValues})}),s=s.concat(t)}),t(s)},onFailure:function(e){i(s)}})})},_switchUIFromObjectsToType:function(e){var t=this;this._getAttributesOfType(e).then(function(e){t._attributesOfType=e,t._attributesOfExtension=[],t.attributes=t._attributesOfType,t.updateSynthesis(),t.getElements(".filter-anyobject-on").forEach(e=>e.hide()),t.getElements(".filter-anyobject-off").forEach(e=>e.show()),t.getElements(".filter-anyobject-off-display-off").forEach(e=>e.hide())},function(e){})},_setEnableButtons:function(e){var t=!e;this.addAttributeBtn.disabled=t,this.addAttributeGroupBtn.disabled=t,this._addAttributeSequenceBtn.disabled=t,this._validateButton.disabled=t},_buildExtensionUI:function(){var e=this;void 0===this.subTypeCombo?(this._extensionLabel=t.createElement("label",{class:"innerfiltertypecombo",text:l.get("without"),id:"with_extension_"+this._childGroupId}),this._extensionLabel.inject(this.attrEditInputs),this._extensionLabel.addClassName("filter-anyobject-off"),this._extensionBtn=new m({touchMode:o.TOUCH_MODE,displayStyle:"lite",label:l.get("SelectExtension"),domId:"SelectExtension_"+this._childGroupId}),this._extensionBtn.inject(this.attrEditInputs),this._extensionBtn.getContent().addClassName("attributeCriterion-edit-SelectExtension filter-anyobject-off"),o.isEasyAttributeDisplayMode()&&o.FILTER_ANY_OBJECT===this._selectedType&&(this._extensionLabel.hide(),this._extensionBtn.hide()),this._extensionBtn.addEventListener("buttonclick",function(t){if(t.target.hide(),e.subTypeCombo&&e.subTypeCombo.show("slow"),!e._selectedSubType)if(e._isMigrateToAutoComplete){var i=e.typeCombo.selectedItems.getAttributeValue("label");e._computeExtensionsAndUpdateUI(e._keepTypeInfosFromLabel[i].value)}else e._computeExtensionsAndUpdateUI(e._keepTypeInfosFromLabel[e.typeCombo.label].value)}),this.subTypeCombo=this._buildAndFeedCombo("extension",[],this._childGroupId),this.subTypeCombo.getContent().addClassName("filter-anyobject-off filter-anyobject-off-display-off"),this.subTypeCombo.hide(),this.subTypeCombo.addEventListener("change",function(t){var i,n="",s="";if(e._isMigrateToAutoComplete){var o=t.dsModel.selectedItems;i=o?o.getAttributeValue("label"):void 0}else i=t.dsModel.label;var r=e._keepExtensionInfosFromLabel[i];if(r&&(s=n=r.value,e._needToQueryServer=!e.isCancelEditCrteriaActivated&&e._selectedSubType!==n),e._selectedSubType=n,e.model.set("extension",n),e.model.set("nlsExtension",""===n?n:i),n?e._extensionBtn.label=i:(e._extensionBtn.label=l.get("SelectExtension"),e._extensionLabel.setText(l.get("without"))),!e.isCancelEditCrteriaActivated)if(e._selectedSubType){var a="ds6wg:"+s;C.getPropertiesForClass(a,{tenantId:F.getTenant(),lang:y.getLanguage().toLowerCase(),apiVersion:"R2019x",onComplete:function(t){e._attributesOfExtension=t.length?t[0].properties:[],e.attributes=e._attributesOfType.concat(e._attributesOfExtension),e.updateSynthesis()},onFailure:function(e){}})}else e._attributesOfExtension=[],e.attributes=e._attributesOfType,e.updateSynthesis()})):this._extensionBtn&&0===o.isEasyAttributeDisplayMode()&&(this._extensionLabel.setText(l.get("without")),this._extensionLabel.show(),this._extensionBtn.label=l.get("SelectExtension"),this._extensionBtn.show(),this.subTypeCombo||(this.subTypeCombo=this._buildAndFeedCombo("extension",[],this._childGroupId)),this.subTypeCombo.hide(),this.subTypeCombo.getContent().addClassName("filter-anyobject-off-display-off"))},_computeExtensionsAndUpdateUI:function(e){if(e)if(!1===this._needToQueryServer&&this.subTypes)F.isActivated("easyAttribute")&&this._updateExtensionUI();else{this.subTypeCombo&&f.mask(this._loaderContainer,t.String.format(l.get("LoaderForExtensions"),this.model.get("nlsType")));var i=this,n=e;C.getExtensionsForClass(n,{tenantId:F.getTenant(),lang:y.getLanguage().toLowerCase(),onComplete:function(e){i.subTypes=[];var t=e.extensions;t&&t.length&&(i.subTypes=i._updateExtensionWithSynthesis(t,i._synthesisInfos)),F.isActivated("easyAttribute")&&i._updateExtensionUI(),1===i.subTypes.length&&i.subTypeCombo&&(i.subTypeCombo.value=i.subTypes[0].label)},onFailure:function(e){i.subTypes=[]}})}},_updateExtensionUI:function(){var e=this.getContent().getElement("#No_Extension_Available");if(e&&e.remove(),0===this.subTypes.length){if(this._extensionBtn.hide(),this.subTypeCombo.hide(),e=this.getContent().getElement("#"+this._extensionBtn.domId)){var i=t.createElement("label",{class:"innerfiltertypecombo",text:l.get("SelectExtension"),id:"No_Extension_Available"});e.parentNode.replaceChild(i,e)}o.displayNotification({level:"info",message:l.get("NoExtensionAvailable")}),f.unmask(this._loaderContainer)}else(e=this.getContent().getElement("#with_extension_"+this._childGroupId))&&e.setText(l.get("with")),this.subTypeCombo&&(this._buildAndFeedCombo("extension",this.subTypes,this._childGroupId,this.subTypeCombo),f.unmask(this._loaderContainer)),(e=this.getContent().getElement("#"+this._extensionBtn.domId))&&e.hide()},_cleanTypes:function(){this.typeCombo&&((this._isMigrateToAutoComplete?this.typeCombo.elementsTree:this.typeCombo.elements)&&(this.typeCombo.elements&&(this.typeCombo.value=""),this._cleanSubTypes(),this._attrCombinationView&&this._attrCombinationView.cleanAttributes()))},_cleanSubTypes:function(){this.subTypeCombo&&(this.subTypeCombo.elements&&this.subTypeCombo.elements.container.remove(),delete this.subTypeCombo),this._extensionLabel&&(this._extensionLabel.remove(),delete this._extensionLabel),this._extensionBtn&&(this._extensionBtn.remove(),delete this._extensionBtn)},_displayLoader:function(e){this.loaderAttributes?"on"===e?this.loaderAttributes.on():this.loaderAttributes.off():"on"===e?f.mask(this._loaderContainer,t.String.format(l.get("LoaderForAttributes"),this.model.get("nlsType"))):f.unmask(this._loaderContainer)},_selectAttributes:function(e){var t=this;if(e)if(!1===this._needToQueryServer&&this.attributes)this._createAttributeCombinationView();else{this._displayLoader("on");var i=function(e){t._displayLoader("off"),t._attributesOfType=e,t.attributes=t._attributesOfType,t._needToQueryServer=t.isCancelEditCrteriaActivated,t._updateAttributesWithSynthesis(e,t._synthesisInfos),t._createAttributeCombinationView(),t.subTypeCombo.hide(),o.isEasyAttributeDisplayMode()||t._extensionBtn.show(),t.subTypes=void 0},n=function(e){t._displayLoader("off"),t._updateAttributesWithSynthesis(t.attributes,t._synthesisInfos),t._createAttributeCombinationView()};o.FILTER_ANY_OBJECT===e?o.computeAttributesFromSynthesis(this._synthesisInfos).then(function(e){i(e)},function(e){n()}):this._getAttributesOfType(e).then(function(e){i(e)},function(e){n()})}},_buildAndFeedCombo:function(e,i,n,s){var r=this,a=[],d=0,c="";switch(e){case"type":this._keepTypeInfosFromLabel={},c=this._mruTypeKey;break;case"extension":this._keepExtensionInfosFromLabel={},c=this._mruExtensionKey,d=1}if(i.forEach(function(t){var i,n;switch(e){case"type":i=t.nlsName,n=t.name,r._keepTypeInfosFromLabel[i]||(r._keepTypeInfosFromLabel[i]={}),r._keepTypeInfosFromLabel[i]={value:n};break;case"extension":i=t.label||t.nlsName,n=(n=t.curi||t.name).substring(n.indexOf(":")+1),r._keepExtensionInfosFromLabel[i]||(r._keepExtensionInfosFromLabel[i]={}),r._keepExtensionInfosFromLabel[i]={value:n}}a.push({valueItem:n,labelItem:i})}),!s){var m,f=t.String.format(l.get("placeHolderSelectEntity"),l.get(e));if(this._isMigrateToAutoComplete){var g,v;if((g=new u({})).prepareUpdate(),this._mruTypeKey===c)0!==(v=this._getMRUProperty(c)).length&&(v.reverse(),v.forEach(function(e){var t=new h({label:e.label,value:e.value,icons:[{iconName:"navigation-history"}],grid:{label:e.label,value:e.value}});g.addChild(t)}));(a=d?a.sort(r._alphabeticSort):a).forEach(e=>{var t=new h({label:e.labelItem,value:e.valueItem,grid:{label:e.labelItem,value:e.valueItem}});g.addChild(t)}),g.pushUpdate(),(m=new p({touchMode:o.TOUCH_MODE,domId:"filtered-"+e,placeholder:f,multiSearchMode:!1,elementsTree:g,allowFreeInputFlag:!1})).displayLoader=-1===this._synthesisState}else m=new _({touchMode:o.TOUCH_MODE,actionOnClickFlag:!0,elementsList:d?a.sort(r._alphabeticSort):a,preselectedIndex:1===a.length?0:-1,placeholder:f,autocompleteFlag:!1,generateRegexpString:function(e){return e}});return m.inject(this.attrEditInputs),m.getContent().addClassName("attributeCriterion-edit-"+e+("type"===e?" filter-anyobject-off":"")),m}this._isMigrateToAutoComplete?((g=s.elementsTree).removeRoots(),g.prepareUpdate(),0!==(v=this._getMRUProperty(c)).length&&(v.reverse(),v.forEach(function(e){var t=new h({label:e.label,value:e.value,icons:[{iconName:"navigation-history"}],grid:{label:e.label,value:e.value}});g.addChild(t)})),(a=d?a.sort(this._alphabeticSort):a).forEach(e=>{var t=new h({label:e.labelItem,value:e.valueItem,grid:{label:e.labelItem,value:e.valueItem}});g.addChild(t)}),g.pushUpdate()):s.elementsList=d?a.sort(r._alphabeticSort):a},_alphabeticSort:function(e,t){var i=0;return void 0!==e&&void 0!==t&&(i=e.labelItem<=t.labelItem?-1:1),i},_getDOMElementToUpdateOnActivateChange:function(){var e=[];let t=this.getElement("#"+this._getId()+" .attributeCriterion-read");return e.push(t.getElement("#readHeader")),e.push(t.getElement("img")),e},destroy:function(){this._attrCombinationView&&this._attrCombinationView.destroy(),this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType"),edited:"edit"===this.model.get("state")?1:0}),this.stopListening(),this.model=null,this._parent(),this.container=null},_isCriterionModified:function(){var e=JSON.stringify(this.model.keepComponentsToFeedUI(!0));return this._savedBeforeEdit.asString!==e},viewFromMdl:function(e){void 0===e.Keep&&(e.Keep=this.model.get("Keep")),e.isActivated||(e.isActivated=this.model.get("isActivated")),e.extension||(e.extension=this.model.get("extension")),void 0!==this._keepRemoveCombo&&(this._keepRemoveCombo.value=e.Keep,this._anyObjectKeepAnchor&&this._anyObjectKeepAnchor.setText(l.get(!1===e.Keep?"remove":"keep"))),this.typeCombo.value=e.type,e.extension&&(this._extensionBtn.hide(),this.subTypeCombo.show(),this._computeExtensionsAndUpdateUI(e.type),this.subTypeCombo.value=e.extension);var t=this._attrCombinationView.viewFromMdl(e);return t.length&&this._attrCombinationView.removeEmptyAttribute(),"0"===e.isActivated&&this._switchCriterionState(),o.isEasyAttributeDisplayMode()?(this._anyObjectObject.show(),this._anyObjectKeep.show(),this._keepRemoveCombo.getContent().hide(),this.typeCombo.getContent().hide(),o.FILTER_ANY_OBJECT!==this._selectedType&&(this._extensionLabel.show(),this._extensionBtn.show(),this.subTypeCombo.getContent().hide())):(this._anyObjectObject&&this._anyObjectObject.hide(),this.typeCombo.getContent().show()),t},_createAttributeCombinationView:function(){this._attrCombinationView&&(this._attrCombinationView.destroy(),(e=this.model.get("allAttributes")||[]).splice(0),this.model.set("allAttributes",e));var e,t=new n;(e=this.model.get("allAttributes")||[]).push(t),this.model.set("allAttributes",e),this._attrCombinationView=new v({model:t,widgetId:this._widgetId,selectedType:void 0!==this.model.get("nlsType")&&void 0!==this._keepTypeInfosFromLabel?this._keepTypeInfosFromLabel[this.model.get("nlsType")].value:"",selectedExtension:this._selectedSubType,attributesUsed:this.attributes,attrEditInputs:this.attrEditInputs,attrEditInputsAttr:this.attrEditInputsAttr,synthesisState:this._synthesisState}),this._attrCombinationView.render().inject(this.attrEditInputs);var i=this._attrCombinationView._listOfAttributes.length;i&&this._attrCombinationView._listOfAttributes[i-1].setFocus(),this.listenTo(this._attrCombinationView,"NGF_SwitchDisplayContext",this._onSwitchDisplayContext.bind(this)),this.listenTo(this._attrCombinationView,"NGF_DisplayAddActions",this._onDisplayAddActions.bind(this))},_onSwitchDisplayContext:function(e){1===e.context?(e.combination.inject(this.attrEditInputs),e.view.inject(this.attrEditInputsAttr),this.attrEditInputsAttr.show()):(e.view.inject(this.attrEditInputs),this.attrEditInputsAttr.hide())},_onDisplayAddActions:function(e){var t=this.attrEditActions.getElement(".attribute-edit-add-btn2"),i=this.attrEditActions.getElement(".attribute-edit-addGroup-btn2");t&&i&&e.display&&(t.show(),i.show())},_createAddAttributeButton:function(e){if(this.addAttributeBtn)return this.addAttributeBtn;var t=new m(o.getAttributeButtonStyle("plus"));t.inject(e||this._Div),t.tooltipInfos=new b({shortHelp:l.get("AddAttribute"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-add-btn2");var n=this;return t.addEventListener("buttonclick",function(e){F.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Attribute"),(!o.isEasyAttributeDisplayMode()||n.isCriterionValid())&&(n._cleanSelected(),n._attrCombinationView.createAttribute())}),t},_createAddAttributeGroupButton:function(e){if(this.addAttributeGroupBtn)return this.addAttributeGroupBtn;var t=new m(o.getAttributeButtonStyle("group-add"));t.inject(e||this._Div),t.tooltipInfos=new b({shortHelp:l.get("AddAttributeGroup"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attribute-edit-addGroup-btn2");var n=this;return t.addEventListener("buttonclick",function(e){F.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Group"),(!o.isEasyAttributeDisplayMode()||n.isCriterionValid())&&(n._cleanSelected(),n._attrCombinationView.createAttributeGroup())}),t},_cleanSelected:function(){var e=this.getElement(".attribute-edit-group-selected");e&&e.removeClassName("attribute-edit-group-selected")},reDrawCriterion:function(){"read"===this.model.get("state")?(this.model.set("state","edit"),this.model.set("state","read")):(this.model.set("state","read"),this.model.set("state","edit")),this._validateButton&&this._validateButton.getContent().addClassName("attributeCriterion-edit-validate"+(this.sequenceMode?"":" colorized"))},setSequenceMode:function(e){var t;this.sequenceMode=!!e,this.model.set("inSequence",this.sequenceMode),this.sequenceMode?(this._addAttributeSequenceBtn.hide(),t="close"):(this._addAttributeSequenceBtn.show(),t="trash");var i=this._critContextualMenu.length-1;this._critContextualMenu[i].icon.iconName=t;var n=this.getElement(".criteriaIcon img");n&&(this.sequenceMode?n.hide():n.show())},setEnableKeepRemove:function(e){this._keepRemoveCombo&&(this._keepRemoveCombo.disabled=!e),this._anyObjectKeepAnchor&&(this._anyObjectKeepAnchor.disabled=!e,e?this._anyObjectKeepAnchor.removeClassName("attr-keep-remove-disabled"):this._anyObjectKeepAnchor.addClassName("attr-keep-remove-disabled"))},initKeepRemove:function(e){var t="Keep"===e?0:1;this._keepRemoveCombo.selectedIndex=t,this._anyObjectKeepAnchor&&this._anyObjectKeepAnchor.setText(l.get(0===t?"keep":"remove")),this.reDrawCriterion()},switchCriterionToSequence:function(){this.setSequenceMode(!0),this.setEnableKeepRemove(!0),this.reDrawCriterion()},switchSequenceToCriterion:function(){this.setSequenceMode(!1),this.setEnableKeepRemove(!0),this.reDrawCriterion(),this.model.set("state","edit")},updateSynthesis:function(e){if(e){this._synthesisInfos=e.synthesis||this._synthesisInfos;var t=this._synthesisState!==e.state?1:0;this._synthesisState=e.state||this._synthesisState,o.FILTER_ANY_OBJECT===this._selectedType&&(this._attributesOfType=e.attributes||this._attributesOfType,this.attributes=this._attributesOfType),1===t&&this._reBuildFilteredTypeUI()}this._updateAttributesWithSynthesis(this.attributes,this._synthesisInfos),this._attrCombinationView&&this._attrCombinationView.updateAttributes(this.attributes,this._synthesisState)},updateOnceSynthesisComputed:function(){this.typeCombo.displayLoader=!1,this.subTypeCombo&&(this.subTypeCombo.displayLoader=!1)},_reBuildFilteredTypeUI:function(){var e=this,i=o.getTypesOfSynthesis(this._synthesisInfos).concat(F.isActivated("easyAttribute")?{name:o.FILTER_ANY_OBJECT,nlsName:l.get("anyObject")}:[]),n=this._selectedType,s=-1,r=[];if(this._keepTypeInfosFromLabel=[],i.forEach((t,i)=>{r.push({labelItem:t.nlsName,valueItem:t.name}),e._keepTypeInfosFromLabel[t.nlsName]={value:t.name},s=n===t.name?i:s}),this._isMigrateToAutoComplete){var a=this.typeCombo.elementsTree;a.removeRoots(),a.prepareUpdate();var d=this._getMRUProperty(this._mruTypeKey);0!==d.length&&(d.reverse(),d.forEach(function(e){var t=new h({label:e.label,value:e.value,icons:[{iconName:"navigation-history"}],grid:{label:e.label,value:e.value}});a.addChild(t)})),r.forEach(e=>{var t=new h({label:e.labelItem,value:e.valueItem,grid:{label:e.labelItem,value:e.valueItem}});a.addChild(t)}),a.pushUpdate(),this.typeCombo.value=-1===s?"":r[s].valueItem}else{var c=new _({touchMode:o.TOUCH_MODE,actionOnClickFlag:!0,elementsList:r,preselectedIndex:s,placeholder:t.String.format(l.get("placeHolderSelectEntity"),l.get("type")),autocompleteFlag:!1,generateRegexpString:function(e){return e}});c.getContent().setAttribute("style",this.typeCombo.getContent().getAttribute("style")),c.getContent().addClassName(this.typeCombo.getContent().getAttribute("class")),this.typeCombo.getContent().parentNode.replaceChild(c.getContent(),this.typeCombo.getContent()),this.typeCombo=c,this.typeCombo.value=-1===s?"":r[s].valueItem,this.typeCombo.addEventListener("change",this._onSelectType.bind(this))}},_updateAttributesWithSynthesis:function(e,t){t&&e&&e.length&&(t.length?t.forEach(function(t){var i=e.findIndex(function(e){var i=e.curi||e.uri;return t.property===i}),n=-1!==i?e[i]:void 0;n&&(n.rangeValues={editable:!0,literalInfo:t.values})}):e.forEach(function(e){e.rangeValues&&(e.rangeValues=void 0)}))},_updateExtensionWithSynthesis:function(e,t){var i=[];if(e&&e.length)if(t){var n=t.find(function(e){return"ds6w:kind"===e.property});n&&n.values&&n.values.forEach(function(t){var n=e.find(function(e){var i=e.curi||e.name;return i=i.substring(i.indexOf(":")+1),t.value===i});n&&i.push(n)}),F.isDebugActive("extension")&&(i.splice(0),i=[...e])}else F.isDebugActive("extension")&&(i.splice(0),i=[...e]);return i},isThereCriteria:function(){return!!this._attrCombinationView},_updateMRUProperty:function(e,t,i){for(var n=Array.isArray(t)?t:[t],s=n?n.length:0,o=this._getMRUProperty(e),r=o,a=0;a<s;a++){var l=o.findIndex(function(e){return e.value===n[a].value});-1===l?(r.push(n[a]),r.length>i&&r.shift()):(r.push(o[l]),r.splice(l,1))}this._setMRUProperty(e,r)},_getMRUProperty:function(e){var t,i=JSON.parse(window.localStorage.getItem("NGF_Most-Recent-Used"))||{};if(this._mruTypeKey===e)t=i[this._mruTypeKey]||[];else if(this._mruExtensionKey===e){t=(i[this._mruExtensionKey]||{})[this._selectedType]||[]}return t},_setMRUProperty:function(e,t){var i="NGF_Most-Recent-Used",n=JSON.parse(window.localStorage.getItem(i))||{};if(this._mruTypeKey===e)n[e]=t;else if(this._mruExtensionKey===e){var s=n[this._mruExtensionKey]||{};s[this._selectedType]=t,n[e]=s}window.localStorage.setItem(i,JSON.stringify(n))},selectTypes:function(e,t){this.buildFilteredTypeUI(e,t)}})}),define("DS/ENONextGenFilterUX/views/CriteriaVolumeView",["DS/ENONextGenFilterUX/views/CriteriaAbstractView","UWA/Core","UWA/Class/View","UWA/Class/Model","UWA/Promise","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/WebappsUtils/WebappsUtils","DS/Controls/Button","DS/Controls/TooltipModel","DS/ENONextGenFilterUX/views/VolumeCombinationView","text!DS/ENONextGenFilterUX/templates/volumeViewTemplate.html"],function(e,t,i,n,s,o,r,a,l,d,c,u,h){"use strict";return e.extend({className:"volumeCriterion",tagName:"li",domEvents:{"click .volumeCriterion-read .volumeRead":"_onEditAttribute","click .volumeCriterion-read .volumeRead-multi-attr":"_onEditAttribute"},setup:function(e){this._parent(e),this._filterSpecId=e.filterSpecId,this._rootId=e.rootId,this._template=r.compile(h),this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this)),this._sendEvent=e.sendEvent,this._volumeFilterIcon=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_VolumeFilter.png"),this._volumeTypeIcons=[],this._volumeTypeIcons.box=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Box.png"),this._volumeTypeIcons.sphere=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Sphere.png"),this._volumeTypeIcons.proximity=l.getWebappsAssetUrl("ENONextGenFilterUX","icons/16/Proximity.png")},render:function(){return this.container.setContent(this._template({stateClass:this.model.get("state"),titleClass:a.get("titleVolumeUX"),titleVolumeReadUX:a.get("titleVolumeReadUX"),touchMode:o.FILTER_TOUCH_CLASS,iconHeader:this._volumeFilterIcon})),this._createHeaderCtxMenu(),this._createHeaderIcon(),this.attrEditInputs=this.getElement(".attributeCriterion-edit .attr-edit-inputs"),this.attrEditInputsAttr=this.getElement(".attributeCriterion-edit .attr-edit-inputs-allAttributes"),this.attrEditActions=this.getElement(".attributeCriterion-edit .attr-edit-actions"),this.attrEditInputsAttr.hide(),this.addVolumeBtn=this._createAddVolumeButton(this.attrEditActions),this.addVolumeGroupBtn=this._createAddVolumeGroupButton(this.attrEditActions),this._validateButton=this._createValidateButton(),this._createVolumeCombination(),this.listenTo(this._combinationView,"NGF_RemoveCriterion",this.destroy.bind(this)),this},destroy:function(){o.resetSelectedVolumeOf3D(this._NGFUXId,this._widgetId,this._rootId),this._combinationView&&this._combinationView.destroy(),this.dispatchEvent("NGF_RemoveCriterion",{idxView:this.cid,criteriaType:this.model.get("criteriaType"),edited:"edit"===this.model.get("state")?1:0}),this.stopListening(),this.model=null,this._parent(),this.container=null},_createHeaderIcon:function(){t.createElement("img",{src:this._volumeFilterIcon,height:"22px"}).inject(this.getElement(".attributeCriterion-edit .criteriaIcon"))},_createHeaderCtxMenu:function(){this._createCriterionCtxMenuWUX(this.getElement(".criterionDropDown")),this._setContextualMenu("edit")},_cancelEditCriteria:function(){this._createVolumeCombination(),this.listenTo(this._combinationView,"NGF_RemoveCriterion",this.destroy.bind(this)),this._savedBeforeEdit&&this.viewFromMdl(this._savedBeforeEdit)},onStateChange:function(e,t){var i=this;this.getElement(".f-volume-container").setAttribute("class","f-volume-container "+t);if("read"===t){var n="",s="",r=this._isThereVolumeActivated(this._combinationView.model);if(r){var l=this.model.criterionToString();n=l.shift(),s=this._getVolumeHTML(l)}else n=a.get("noVolumeActivated");if(l&&l.length){this.getElement(".volumeRead#value").hide();this.getElement(".volumeRead-multi-attr").show().setContent([{tag:"span",html:s}])}else{this.getElement(".volumeRead-multi-attr").hide();this.getElement(".volumeRead#value").show().setContent([{tag:"span",html:n}])}this._setContextualMenu("read"),r||this._switchCriterionState()}else{this._savedBeforeEdit=this.model.keepComponentsToFeedUI(!0);var d=o.getLengthUnit();o.getLengthUnitPreference().then(e=>{e&&d.unit!==e.unit&&(o.setLengthUnit(e),i._combinationView.redrawVolumeSpecification()),this._setContextualMenu("edit"),this.dispatchEvent("NGF_Criterion_SwitchedToEdit",{type:i.model.get("criteriaType"),state:1})})}},_isThereVolumeActivated:function(e){for(var t=0,i=e.get("allVolumes")||[],n=i.length,s=0;s<n&&!t;s++){var o=i[s];o.get("allVolumes")?t=this._isThereVolumeActivated(o):"1"===o.get("isActivated")&&(t=1)}return t},_getVolumeHTML:function(e){for(var t="",i=0;i<e.length;i++)if(Array.isArray(e[i])){var n=e[i];t+='<li class="volumeRead-multi-attr-group">'+n[0],t+='<ul class="volumeRead-multi-attr"><div>',n.shift(),t+=this._getVolumeHTML(n),t+="</div></ul></li>"}else{var s=this._getInfosVolumeFromName(e[i],this._combinationView.model),o=s.type?'<img src="'+this._volumeTypeIcons[s.type]+'">':"";t+="<li"+("0"===s.isActivated?' class="f-criterion-deactivated"':"")+">"+o+e[i]+"</li>"}return t},_getInfosVolumeFromName:function(e,t){for(var i={},n=t.get("allVolumes")||[],s=n.length,o=0;o<s&&!i.type;o++){var r=n[o];if(r.get("allVolumes"))i=this._getInfosVolumeFromName(e,r);else if(r.get("displayName")===e){var a=r.get("parameters");i={isActivated:r.get("isActivated"),type:a?a.type:void 0}}}return i},_getDOMElementToUpdateOnActivateChange:function(){var e=[];let t=this.getElement("#"+this._getId()+" .volumeCriterion-read");return e.push(t.getElement("#readHeader")),e.push(t.getElement("img")),e},_getCallbackToEditCriterion:function(){return this._editVolume.bind(this)},_editVolume:function(){this.model.set("state","edit"),this._combinationView.model.set("state","edit")},_isCriterionModified:function(){var e=!1;if(this.model){let t=JSON.stringify(this.model.keepComponentsToFeedUI(!0));e=JSON.stringify(this._savedBeforeEdit)!==t}return e},isCriterionValidate:function(){var e=this;if(0===o.isAsynchronousValidation()){this.model.get("state");return!0,e._combinationView.removeEmptyVolume(),o.resetSelectedVolumeOf3D(e._NGFUXId,e._widgetId,e._rootId),o.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState(),!0}return new s(function(t){e._combinationView.removeEmptyVolume(),o.resetSelectedVolumeOf3D(e._NGFUXId,e._widgetId,e._rootId),o.isModelActivated(e.model)||!0!==e._isCriterionModified()||e._switchCriterionState(),e._savedBeforeEdit=void 0,t(!0)})},viewFromMdl:function(e){this._combinationView.viewFromMdl(e),this._repairInfos=e.repairFilterInfo?{proximityPath:e.proximityPath,repairInfo:e.repairFilterInfo}:{},"0"===e.isActivated&&this._switchCriterionState()},_createVolumeCombination:function(){this._combinationView&&(this._combinationView.destroy(),this.model.set("allVolumes",[]));var e=new n;e.set("isActivated","1"),e.set("state","edit");var t=[];t.push(e),this.model.set("allVolumes",t),this._combinationView=new u({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,rootId:this._rootId,model:e,attrEditInputs:this.attrEditInputs,attrEditInputsAttr:this.attrEditInputsAttr,sendEvent:this._sendEvent,filterSpecId:this._filterSpecId}),this._combinationView.render().inject(this.attrEditInputs),this.listenTo(this._combinationView,"NGF_SwitchDisplayContext",this._onSwitchDisplayContext.bind(this)),this.listenTo(this._combinationView,"NGF_DisplayAddActions",this._onDisplayAddActions.bind(this)),this.listenTo(this._combinationView,"NGF_SwitchToEdit",this._checkBeforeEdit.bind(this)),this._combinationView._sendEvent=1,this._sendEvent=1},_onSwitchDisplayContext:function(e){1===e.context?(e.combination.inject(this.attrEditInputs),e.view.inject(this.attrEditInputsAttr),this.attrEditInputsAttr.show()):(e.view.inject(this.attrEditInputs),this.attrEditInputsAttr.hide());var t=this.getElement(".attribute-edit-add-btn2");t.inject(this.attrEditActions),(t=this.getElement(".attribute-edit-addGroup-btn2")).inject(this.attrEditActions),(t=this.getElement(".attributeCriterion-edit-validate")).inject(this.attrEditActions)},_onDisplayAddActions:function(e){var t=this.attrEditActions.getElement(".attribute-edit-add-btn2"),i=this.attrEditActions.getElement(".attribute-edit-addGroup-btn2");t&&i&&e.display&&(t.show(),i.show())},_createAddVolumeButton:function(e){if(this.addVolumeBtn)return this.addVolumeBtn;var t=new d(o.getAttributeButtonStyle("plus"));t.label=a.get("addCriterionLabel"),t.showLabelFlag=o.isLabelCriterionDisplayed(),t.inject(e),t.tooltipInfos=new c({shortHelp:a.get("AddVolume"),mouseRelativePosition:!0});var i="attribute-edit-button-style attribute-edit-add-btn2"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i);var n=this;return t.addEventListener("click",function(e){n._cleanSelected(),n._combinationView.createVolume()}),t},_createAddVolumeGroupButton:function(e){if(this.addVolumeGroupBtn)return this.addVolumeGroupBtn;var t=new d(o.getAttributeButtonStyle("group-add"));t.label=a.get("addCriterionGroupLabel"),t.showLabelFlag=o.isLabelCriterionDisplayed(),t.inject(e),t.tooltipInfos=new c({shortHelp:a.get("AddVolumeGroup"),mouseRelativePosition:!0});var i="attribute-edit-button-style attribute-edit-addGroup-btn2"+o.FILTER_TOUCH_CLASS;t.getContent().addClassName(i);var n=this;return t.addEventListener("click",function(e){n._cleanSelected(),n._combinationView.createVolumeGroup()}),t},_cleanSelected:function(){var e=this.getElement(".attribute-edit-group-selected");e&&e.removeClassName("attribute-edit-group-selected")},_createValidateButton:function(){var e=new d(o.getAttributeValidateButtonStyle());e.label=a.get("validateCriterionLabel"),e.showLabelFlag=o.isLabelCriterionDisplayed(),e.inject(this.attrEditActions),e.tooltipInfos=new c({shortHelp:a.get("ValidateCriteriaTooltip"),mouseRelativePosition:!0});var t="attribute-edit-button-style  attributeCriterion-edit-validate";t+=(this.sequenceMode?"":" colorized")+o.FILTER_TOUCH_CLASS,e.getContent().addClassName(t);var i=this;return e.addEventListener("buttonclick",function(){0===o.isAsynchronousValidation()?i.isCriterionValidate()&&i.model&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")}):i.isCriterionValidate().then(function(e){e&&i.model&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType")})})}),e},isThereCriteria:function(){var e=function(t){for(var i=0,n=t.get("allVolumes")||[],s=n.length,o=0;o<s&&!i;o++){var r=n[o];i=r.get("allVolumes")?e(r):r.get("parameters")?1:0}return i};return!!this._combinationView&&e(this._combinationView.model)},getEditedVolume:function(){var e=function(t){for(var i,n=t.get("allVolumes")||[],s=n.length,o=0;o<s&&!i;o++){var r=n[o];r.get("allVolumes")?i=e(r):"edit"===r.get("state")&&(i=r)}return i};return e(this._combinationView.model)},setVolumeAsEdited:function(e){this.getElement("#"+e.get("id")+" .innerVolumeFilterHeader").click()},updateModelFromRepair:function(e){e[0];var t=this._repairInfos.repairInfo.brokenProximity,i=this._repairInfos.repairInfo.brokenLogicalDB,n=[],s=[],o=[];e[1].forEach(function(e){e.attributes.forEach(function(t){if("resourceid"===t.name)n.push(t.value);else if("logicalid"===t.name)s.push(t.value);else if("ds6w:label"===t.name){var i=e.attributes.findIndex(e=>"ds6wg:revision"===e.name);o.push(t.dispValue+(-1===i?"":" - "+e.attributes[i].value))}})});var r=function(e,a){for(var l=!1,d=e.get("allVolumes")||[],c=d.length,u=0;u<c;u++){var h=d[u];if(h.get("allVolumes"))l=r(h,a);else{var p=h.get("parameters");if("proximity"===p.type){var _=p.root_path_physicalid,m=(_=_.length?_[0]:[]).toString();t.forEach((e,t)=>{if(m===e[t].toString()){var r=e[t].length;p.root_path_physicalid.splice(0),p.root_path_alias.splice(0);var a=[],d=[];i.forEach(e=>{e.forEach(e=>{var t=s.indexOf(e);-1!==t&&(a.push(n[t]),d.push(o[t]))})}),r===a.length?(p.root_path_physicalid.push(a),p.root_path_alias=d,p.isRepaired=1):h.set("parameters",void 0),l=!0}})}}}return l},a=r(this.model,e);return{modelUpdated:a,attributes:a?this.model:void 0}},buildViewFromRepairModel:function(e){this._combinationView.removeEmptyVolume(),this.model&&(this.model.unset("repairFilterInfo"),this._repairInfos=void 0,this.model.set("state","edit"),this.viewFromMdl(e.keepComponentsToFeedUI()),this.model.set("state","read"))}})}),define("DS/ENONextGenFilterUX/views/GroupView",["UWA/Core","UWA/Class/View","UWA/Class/Model","DS/WAFData/WAFData","UWA/Promise","DS/UIKIT/Mask","DS/ENONextGenFilterUX/utils/FilterUIService","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/groupViewTemplate.html","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/ENONextGenFilterUX/views/CriteriaAttributeView","DS/ENONextGenFilterUX/models/CriterionModel","DS/ENONextGenFilterUX/collections/FilterUIGroupCollection","DS/WebappsUtils/WebappsUtils","DS/ENONextGenFilterUX/views/CriteriaTagView","DS/ENONextGenFilterUX/models/GroupModel","DS/ENONextGenFilterUX/views/CriteriaConfigurationView","DS/Logger/Logger","DS/Controls/Button","DS/Controls/TooltipModel","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/ENONextGenFilterUX/views/CriteriaContextMgmtView","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/views/CriteriaVolumeView","DS/ENOFilterBIUX/NGFServices","DS/Controls/Expander","DS/Menu/Menu"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v,b,C,y,F,A,I,S,E,N){"use strict";var w=t.extend({className:"filtergroup-topdiv",domEvents:{"click .f-group-container .Sequence-read":"_onEditSubGroup","click .f-group-container .group-header2":"_onEditSubGroup"},setup:function(e){r.displayInternalTimeTrace(1,"GroupView"),this._hasConf=!1,this._UXId=e.UXId||"",this._NGFUXId=e.NGFUXId,this._widgetId=e.widgetId,this._groupId=e.groupId||0,this._childGroupId=e.childGroupId||0,this.types=e.types||null,this._synthesisInfos=e.synthesisInfos||null,this._synthesisInfos&&!this.types&&(this.types=r.getTypesOfSynthesis(this._synthesisInfos)),this._synthesisState=e.synthesisState||-1,this._securityContext=e.securityContext,this._rootID=e.rootID||d.get("root"),this._rootAlias=e.rootAlias||"?",this._rootRevision=e.rootRevision||"",this.model.setFilterSpecificationRoot(this._rootID),this.collection=this.model.get("groupCollection"),this._subGroupId=e.subGroup||0,this._savedRootID=e.savedRootID,this._template=a.compile(l),this.listenTo(this.model,"onChange:state",this.onStateChange.bind(this)),this.listenTo(this.model,"onChange:isActivated",this._onActivateChange.bind(this)),this._isConfigurationAvailable=e.configAvailable,this._isVolumeAvailable=e.volumeAvailable,this._isContextAvailable=e.contextAvailable,this._isAttributeAvailable=e.attributeAvailable,this._cfgView=null,this._volumeView=null,this._contextMgmtView=null,this._listView=[],this._listViewId=[],this.filterViewToClone=e.filterViewToClone,this._subGroupKeepRemoveMode=1,this._defaultSpecName=this.model.getFilterSpecificationName(),e.tagData&&0===this._subGroupId&&this.createTagNGF(e.tagData),this._subscribe0=A.subscribe("NGFilter_WidgetRemoved",this._onWidgetRemoved.bind(this)),this._subscribe1=A.subscribe("NGFilter_VolumeDefined",this._onVolumeDefined.bind(this)),this._subscribe2=A.subscribe("NGFilter_ConfigDefined",this._onUpdateFilterWithConfig.bind(this)),this._globalFilterState="New"},render:function(){var t=this;this.container.setAttribute("id","topgroupdiv"+this._getId()),this.container.setContent(this._template({stateClass:this.model.get("state"),filterAppliesTo:d.get("filterAppliesTo"),groupId:this._getId(),subGroup:this._subGroupId?"sequence":"",groupName:0===this._subGroupId?this._defaultSpecName:d.get("headerAttributeSequenceEdit"),iconHeader:0===this._subGroupId?"filter":p.getWebappsAssetUrl("ENONextGenFilterUX","icons/22/I_AttributeFilter.png")}));var i=this.getElement("div.filter-applies"),n=this.options.linkedRoots;if(n){var s=[];n.forEach(e=>{s.push({label:e.alias,value:e.id,description:e.alias})}),this._appliesToCombo=new y({touchMode:r.TOUCH_MODE,elementsList:s,enableSearchFlag:!1,selectedIndex:0}),this._appliesToCombo.inject(i),this._appliesToCombo.getContent().addClassName("filter-applies-combo"),this._dispatchChangeRootEvent=1,this._appliesToCombo.addEventListener("change",e=>{t._dispatchChangeRootEvent?t.dispatchEvent("NGF_ChangeRootOfSpecifcation",{specId:t.cid,rootId:t._rootID,newRootId:e.dsModel.value,callback:t._onChangeRoot.bind(this)}):t._onChangeRoot(e.dsModel.value),t._dispatchChangeRootEvent=1})}else{if(0===this._subGroupId)this._dispatchChangeRootEvent=0,e.createElement("span",{class:"filter-applies-root",id:"multi_root_"+this._groupId,text:r.getRootTitle(this._rootAlias,this._rootRevision)}).inject(i)}if(0===this._subGroupId){var o=e.createElement("div",{}),a=new v(r.getAttributeButtonStyle("chevron-down"));a.displayStyle="lite",a.inject(o),this._SpecExpander=new E({touchMode:r.TOUCH_MODE,domId:"SpecExpander-"+this._groupId,header:this.model.getFilterSpecificationLabel(),expandedFlag:!0,customHeader:o,style:"filled-separate"});var l=this.getElement(".tree-v2");this._SpecExpander.inject(l,"before"),this._SpecExpander.body=l,this._SpecExpander.getContent().getElement(".wux-controls-expander-header").addClassName("group-header"+r.FILTER_TOUCH_CLASS),this._createContextualMenuWUX(a.getContent()),this._createAddCriterionButtons()}else{var c=this.getElement(this._getCSSId()+" .subGroup-edit-actions");!1===r.TOUCH_MODE&&c.addClassName(r.FILTER_TOUCH_CLASSNAME),this.addAttributeButton=this._createAddAttributeSequenceButton(c),this._createValidateButton(c),this._createContextualMenuWUX()}return this._filterSpecNameEditor=this._createRenameFilterSpecLineEditor(),this._filterSpecNameEditor.hide(),0===this._subGroupId&&(r.displayInternalTimeTrace(0,"GroupView(end of render)"),S.setPerformanceTracker(this._widgetId,"NGF-Filter-Render","NGFilter_UX",{Render_duration:Date.now()-r.getReferenceTime()},1)),this},_onChangeRoot:function(e){this.model.setFilterSpecificationRoot(e)},clearCriteria:function(){for(var e=this._listView.length-1;e>=0;e--){var t=this._listView[e];t&&t.destroy()}},_onWidgetRemoved:function(e){this._NGFUXId===e.NGFUXId&&this.updateCriteriaAvailibility({attributeUsed:!1===e.attributeAvailable?e.attributeAvailable:void 0,contextUsed:!1===e.contextAvailable?e.contextAvailable:void 0,volumeUsed:!1===e.volumeAvailable?e.volumeAvailable:void 0})},_getId:function(e){var t="grp_"+this._groupId;return t+=e||0===this._subGroupId?"":this._subGroupId},_getCSSId:function(e){return"#"+this._getId(e)},isThereCriteria:function(){for(var e=!1,t=this._listView.length,i=0;i<t;i++)if(this._listView[i].isThereCriteria()){e=!0;break}return e},_getListCriteriaType:function(){var e=[];return this._listView.forEach(t=>{e.push(t.model.get("criteriaType"))}),e=[...new Set(e)]},getCriteriaViewsByType:function(e){var t=[];return this._listView.forEach(i=>{e===i.model.get("criteriaType")&&t.push(i)}),t},getConfigRevision:function(){var e=this.getCriteriaViewsByType("config"),t=[];return e.forEach(e=>{if(r.isModelActivated(e.model)){var i=e.model.get("expression");i&&i.configurationRevision&&t.push(i.configurationRevision)}}),t},_onEditCriterion:function(e){A.publish("NGF_Criterion_Edition",e),this.switchToEdit(),this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"})},_onComputeSynthesis:function(e){this.dispatchEvent("NGF_ComputeSynthesis",e)},feedViewWithFilter:function(e){var t=this;return new s(function(i){if(e){var n=e.specification.type,s=e.specification.data;"NGFilter_VolumeDefined"===n?(t._onVolumeDefined(s),i()):t._isConfigurationAvailable&&"NGFilter_ConfigDefined"===n&&t._initFilterWithConfig(e.data).then(function(){i()})}else i()})},switchToEdit:function(){"read"===this.model.get("state")?(this.model.set("state","edit"),this.model.set("isActivated","1"),0!==this._subGroupId?this.dispatchEvent("NGF_Criterion_SwitchedToEdit"):this.dispatchEvent("NGF_Group_SwitchedToEdit",{groupId:this.cid})):this.dispatchEvent("NGF_Group_SwitchedToEdit",{groupId:this.cid})},setFilterState:function(e){this._globalFilterState=e},_editReadMgt:function(e){var t;if(this.collection){var i,n=this.collection.findWhere({state:"edit"});void 0!==n&&(i="Sequence"===(t=n.get("criteriaType"))?n.groupToString():n.criterionToString()),"string"==typeof i||Array.isArray(i)?(n.set("state","read"),this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"})):"object"==typeof i&&r.displayNotification(i),this.dispatchEvent("NGF_AddSpecificationState")}A.publish("NGF_Criterion_Edition",{type:t,state:0})},setTypes:function(e){this.types=e},setSynthesisInfos:function(e){e&&e.synthesis?(this._updateSynthesis(e,this),this._setEnableAddCriterionButtons(!0),this._onDelayedCreateAttribute()):(o.unmask(this.container),this._isAttributeBeingCreatedBeforeEndSynthesis=!1)},_updateSynthesis:function(e,t){t._synthesisInfos=e.synthesis||t._synthesisInfos,t._synthesisState=e.state||t._synthesisState,t.types=r.getTypesOfSynthesis(t._synthesisInfos);for(var i=!!t._createAttributeBtn&&t._createAttributeBtn.disabled,n=t._listView.length,s=0;s<n;s++){var a=t._listView[s],l=a.model.get("criteriaType"),d=a.model.get("sequenceType");"attribute"!==l&&"attribute"!==d||("Sequence"===l?this._updateSynthesis(e,a):a.updateSynthesis(e),i&&(a.buildFilteredTypeUI(t.types),o.unmask(a.getElement(".f-attribute-container"))))}},_setEnableAddCriterionButtons:function(e){var t=!1===e,i=!1!==e;this._createAttributeBtn&&(this._createAttributeBtn.disabled=t,this._createAttributeBtn.active=i),this._createConfigBtn&&!this._createConfigBtn.disabled&&(this._createConfigBtn.disabled=t,this._createConfigBtn.active=i),this._createVolumeBtn&&!this._createVolumeBtn.disabled&&(this._createVolumeBtn.disabled=t,this._createVolumeBtn.active=i),this._createContextBtn&&!this._createContextBtn.disabled&&(this._createContextBtn.disabled=t,this._createContextBtn.active=i)},onStateChange:function(e,t){var i=this.getElement(this._getCSSId()),n=" "+t,s=this._subGroupId?" sequence":"",o=i.hasClassName("group-collapse")?" group-collapse":"";if(i.setAttribute("class","f-group-container"+n+s+o),0!==this._subGroupId){var a=this._getCSSId();if(this._GroupContextualMenu=[],"read"===t){var l=this.collection.findWhere({isActivated:"1"}),c=this.getElement(this._getCSSId()+" .Sequence-read .subGroup-read-criterion");c&&(l?c.removeClassName("f-criterion-deactivated"):c.addClassName("f-criterion-deactivated"));var u=this.model.groupToString();this.getElement(a+" .Sequence-read .subGroup-read-criterion").setContent([{html:u}]),this._GroupContextualMenu.push(this._editSequenceItem),this._GroupContextualMenu.push(r.isModelActivated(this.model)?this._deactivateItem:this._activateItem),this._GroupContextualMenu.push(this._deleteItem)}else this._GroupContextualMenu.push(this._deleteItem);var h="";if("read"===t)h=(this._subGroupKeepRemoveMode?d.get("keep"):d.get("remove"))+" "+d.get("headerAttributeSequenceRead");else h=d.get("headerAttributeSequenceEdit");(0===this._subGroupId?this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle"):this.getElement(".group-name")).setContent({tag:"span",html:h})}},createTagNGF:function(e){var t=this.collection.findWhere({criteriaType:"tag"});t&&this._rootID===t.get("rootID")?Object.keys(e.allfilters).length||Object.keys(e.localfilters).length?t.set("tagData",e):this._onRemoveCriterion({criteriaType:"tag",idxView:this.tagView.cid}):(t=new u({criteriaType:"tag",tagData:e,rootID:this._rootID,widget:this._UXId}),this.collection.add(t),this.tagView=new _({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,model:t}),this._listView.push(this.tagView),this._listViewId.push(this.tagView.cid),S.setUsageTracker(this._widgetId,"NGF-Create_Criterion","tag"))},createAttribute:function(e,t,i){var n=this,s=r.isDelayedSynthesisActive();if(0===s&&0===this._subGroupId&&-1===this._synthesisState&&void 0===this._isAttributeBeingCreatedBeforeEndSynthesis)this._attrView=void 0,o.mask(this.container,d.get("LoaderForAttributes")),this._isAttributeBeingCreatedBeforeEndSynthesis=!0;else if(e)if("create"===t){var a=new u({criteriaType:"attribute",state:"edit"});if(this.collection.add(a),this._attrView=new c({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,model:a,types:e||[],fromCriterionMdl:i?i.model:void 0,listAttrFromType:i?i.listAttr:void 0,listAttrFromSubType:i?i.listAttrExtension:void 0,customizeCtxMenu:!1,sequenceMode:0!==this._subGroupId,keepValue:i?i.model.Keep:this._subGroupKeepRemoveMode,synthesisInfos:this._synthesisInfos,synthesisState:this._synthesisState,isEditable:this._isAttributeAvailable}),0===this._subGroupId){var l=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._attrView.render().inject(l,"before"),this.dispatchEvent("NGF_AttributeCommandsState",{enable:1}),this._addCriterionView(this._attrView),1!==s||i||-1!==this._synthesisState?this._attrView.buildFilteredTypeUI(e||[],this._selectedTypeIndex):(this._isAttributeBeingCreatedBeforeEndSynthesis=!0,this._attrView.buildFilteredTypeUIAsync(e||[],this._selectedTypeIndex).then(()=>{n._onComputeSynthesis({callback:n._onDelayedCreateAttribute.bind(n)})}))}else{var h=this.getElement(this._getCSSId()+" .Sequence-edit>ul");this._attrView.render().inject(h),this._attrView.getElement(".criteriaIcon").hide(),this._addCriterionView(this._attrView),this._attrView.buildFilteredTypeUI(e,this._selectedTypeIndex)}}else"update"===t?this._attrView&&this._attrView.buildFilteredTypeUI(e,this._selectedTypeIndex):console.log("RCI - GroupView : unknown status for createAttribute: "+t);else this._attrView=void 0;return this._attrView},_onDelayedCreateAttribute:function(){this._isAttributeBeingCreatedBeforeEndSynthesis&&(o.unmask(this.container),this._isAttributeBeingCreatedBeforeEndSynthesis=!1,this.updateOnceSynthesisComputed())},updateOnceSynthesisComputed:function(){this._attrView&&this._attrView.updateOnceSynthesisComputed()},_createContextMgmtView:function(e){if(!this._contextMgmtView){var t=new u({criteriaType:"context",state:"read"});this.collection.add(t),this._contextMgmtView=new F({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,rootId:this._rootID,model:t,groupView:this,fromModel:e,isEditable:this._isContextAvailable}),this._addCriterionView(this._contextMgmtView);var i=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._contextMgmtView.render().inject(i,"before"),this._createContextBtn&&(this._createContextBtn.disabled=!0,this._createContextBtn.active=!1)}return this._contextMgmtView},_onSwitchCriterionToSequence:function(t){var i=this;0===r.isAsynchronousValidation()?i._onSwitchCriterionToSequenceSync(i,t):this.areCriteriaValidate(t).then(function(n){if(n){var s=i._createSubGroupView(t.type),o=i._listViewId.indexOf(t.idxView),r=i._listView[o],a=r.container,l=a.getElement(".colorized");l&&l.removeClassName("colorized"),s.collection.add(r.model),s._listView[0]=r,s._listViewId[0]=r.cid,s._subGroupKeepRemoveMode=t.attributeKeep?1:0,i.stopListening(r),s._initCriterionViewEvents(r);var d=i.collection.indexOf(r.model);i.collection.remove(r.model),i.collection.add(s.model,{at:d}),i._listView[o]=s,i._listViewId[o]=s.cid,i._listView.pop(),i._listViewId.pop();var c=e.createElement("li").inject(a,"after");s.render().inject(c),a.remove().inject(s.getElement(".Sequence-edit>ul")),"function"==typeof r.switchCriterionToSequence&&r.switchCriterionToSequence(),s._addNewCriterion({type:r.model.get("criteriaType")})}})},_onSwitchSequenceToCriterion:function(e){var t=this._listViewId.indexOf(e.idxView),i=this._listView[t],n=i.container.getParent(),s=i._listView[0];this.stopListening(i),this._initCriterionViewEvents(s);var o=this.collection.indexOf(i.model);this.collection.remove(i.model),this.collection.add(s.model,{at:o}),this._listView[t]=s,this._listViewId[t]=s.cid,s.container.remove().inject(n,"after"),"function"==typeof s.switchSequenceToCriterion&&s.switchSequenceToCriterion(),i.stopListening(),i._listView.splice(0),i._listViewId.splice(0),i.collection.reset(),n.remove()},_createSubGroup:function(t){var i=this._createSubGroupView(t);if(i){var n=e.createElement("li").inject(this.getElement(this._getCSSId(this._groupId)+" .criterionButtonLi"),"before");i.render().inject(n)}return i},_createSubGroupView:function(e){var t,i=this;if(e){this.nbGroup=void 0===this.nbGroup?1:this.nbGroup+1;var n=new h([],{widgetId:this._bodyContainer}),s=new m({subGroupCollection:n,criteriaType:"Sequence",sequenceType:e,subGroupId:this.nbGroup,groupCollection:n});this.collection.add(s),t=new w({appId:this._NGFUXId,widgetId:this.options.widgetId,groupId:this._groupId,childGroupId:this._childGroupId,subGroup:this.nbGroup,model:s,types:this.types,rootID:this._rootID,savedRootID:this._savedRootID,synthesisInfos:this._synthesisInfos,synthesisState:this._synthesisState,securityCtx:this._securityContext,NGFUXId:this.options.NGFUXId,configAvailable:this._isConfigAvailable,volumeAvailable:this._isVolumeAvailable,contextAvailable:this._isContextAvailable,attributeAvailable:this._isAttributeAvailable}),this._addCriterionView(t),this.listenTo(t,"NGF_SwitchSequenceToCriterion",this._onSwitchSequenceToCriterion.bind(this)),this.listenTo(t,"NGF_CheckActivateCriteria",()=>{i.dispatchEvent("NGF_CheckActivateCriteria")})}return t},_onCriterionActivated:function(){0!==this._subGroupId&&"edit"===this.model.get("state")&&(this.collection.findWhere({isActivated:"1"})&&r.isModelActivated(this.model)||this._toggleActivatedState({updateChildren:!1}));this.dispatchEvent("NGF_CheckActivateCriteria")},isThereActiveCriteria:function(){return this.collection.findWhere({isActivated:"1"})?1:0},_createAddCriterionButtons:function(){var t=this.getElement(this._getCSSId(this._groupId)+" .criterionButtonLi"),i=e.createElement("div",{class:"filter-groups-cmd",id:"actions_gv_"+this._groupId});i.inject(t),this._createContextBtn=this._createAddCriterionButton("context",i),!this._isContextAvailable&&this._createContextBtn.hide(),this._createAttributeBtn=this._createAddCriterionButton("attribute",i),!this._isAttributeAvailable&&this._createAttributeBtn.hide(),this._createConfigBtn=this._createAddCriterionButton("config",i),!this._isConfigurationAvailable&&this._createConfigBtn.hide(),this._createVolumeBtn=this._createAddCriterionButton("volume",i),!this._isVolumeAvailable&&this._createVolumeBtn.hide()},_createAddCriterionButton:function(e,t){var i,n,s,o,a,l=r.TOUCH_MODE?"32":"22";switch(e){case"attribute":n="add_attr_criterion",s=d.get("addAttributeCriterion"),a=d.get("addAttributeCriterionTooltip"),o=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/"+l+"/filterAddAttribute.png");break;case"config":n="add_config_criterion",s=d.get("addConfigurationCriterion"),a=d.get("addConfigurationCriterionTooltip"),o=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/"+l+"/filterAddConfiguration.png");break;case"volume":n="add_volume_criterion",s=d.get("addVolumeCriterion"),a=d.get("addVolumeCriterionTooltip"),o=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/"+l+"/filterAddVolume.png");break;case"context":n="add_Context_criterion",s=d.get("addContextCriterion"),a=d.get("addContextCriterionTooltip"),o=p.getWebappsAssetUrl("ENONextGenFilterUX","icons/"+l+"/filterAddSelection.png")}if(void 0!==n){(i=new v({touchMode:r.TOUCH_MODE,domId:n,displayStyle:"normal",showLabelFlag:r.isLabelCriteriaDisplayed(),id:n,icon:o,label:s})).inject(t),i.tooltipInfos=new b({shortHelp:a,mouseRelativePosition:!0});var c=this;i.addEventListener("click",function(t){r.isModelActivated(c.model)&&c._checkBeforeAdd(e)})}return i},_onRenameSpecification:function(e){this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle").hide(),this._filterSpecNameEditor.show(),this._filterSpecNameEditor._giveFocus()},_onEditSubGroup:function(e){e&&e.stopPropagation&&e.stopPropagation(),this._checkBeforeEdit({callback:e.context&&e.context.forceEdit?this._editSubGroupForced.bind(this):this._editSubGroup.bind(this)})},_editSubGroup:function(e){this.model.get("isParentActivated")&&r.isModelActivated(this.model)&&this.switchToEdit()},_editSubGroupForced:function(e){this._setActivatedState(1,{updateChildren:!1}),this.switchToEdit()},_addNewCriterion:function(e){"attribute"===e.type?this.types&&this._savedRootID===this._rootID?this._addAnyCriterion(e):(this._savedRootID=this._rootID,this._addAnyCriterion(e)):this._addAnyCriterion(e)},_onVolumeDefined:function(e){if(!1===(!!this._createVolumeBtn&&this._createVolumeBtn.disabled)&&this._UXId===e.UXId&&!this._volumeView&&(void 0===e.specId||this._groupId===e.specId)){var t=this._volumeView?0:1;this._createVolume(0),e.action=t?"update":e.action,A.publish("NGFilter_VolumeDefined_Init",e),t&&(r.openFilterPanel("First_Volume_Defined_"+this._groupId),this.dispatchEvent("NGF_DisplayGlobalFilterView"))}},_onUpdateFilterWithConfig:function(e){var t=this,i=S.computeUXId(e.NGFUXId,e.rootID);if(this.isViewEdited()&&this._UXId===i){var n=e;this._initFilterWithConfig(n).then(function(){t.dispatchEvent("NGF_EndSetFilterSpecification",{applyFilter:void 0===n.applyFilter?0:n.applyFilter,displayFilter:void 0===n.displayFilter?1:n.displayFilter})})}},_initFilterWithConfig:function(t){var i=this,n=t.specification.data;return new s(function(s,o){var a=i._getListCriteriaType().findIndex(e=>"config"===e);-1===a||t.forceUpdate?i._checkBeforeEdit({callback:function(){-1===a?i._createConfig(!1,!!n):(i._cfgView._initWithConfig=!0,i._cfgView.editConfiguration()),i._cfgView.launchCfgFactoryWithConfig(n).then(function(){s()})}}):(r.displayNotification({level:"info",message:e.String.format(d.get("CriterionNotAppliedAsAlreadyDefined"),d.get("config"))}),o())})},_addAnyCriterion:function(e){var t=this;this.switchToEdit();let i=1,n=e.type;switch(n){case"attribute":this.createAttribute(this.types||[],"create");break;case"config":this._createConfig(!1);break;case"volume":r.getLengthUnitPreference().then(e=>{r.setLengthUnit(e),t._createVolume()});break;case"context":this._createContextMgmtView();break;default:i=0}this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"}),i&&A.publish("NGF_Criterion_Edition",{type:n,state:1}),S.setUsageTracker(this._widgetId,"NGF-Create_Criterion",n)},_checkBeforeAdd:function(e){this._checkBeforeEdit({type:e,callback:this._addNewCriterion.bind(this)})},_checkBeforeEdit:function(e){this.dispatchEvent("NGF_Criterion_ValidateEdited",e)},areCriteriaValidate:function(e){if(0===r.isAsynchronousValidation())return this.areCriteriaValidateSync(this);var t=this._listView?this._listView.length:0,i=!t;if(t){i=!0;for(var n=[],o=[],a=0;a<t&&i;a++){var l=this._listView[a];null!==l&&"edit"===l.model.get("state")&&(n.push(l),void 0===l._subGroupId||0===l._subGroupId?o.push(l.isCriterionValidate()):o.push(this._isSequenceValidate(l)))}return s.all(o).then(function(e){i=!0;for(var t=e.length,s=0;s<t;s++){i=i?e[s]:i;var o=n[s];void 0!==o._subGroupId&&0!==o._subGroupId||e[s]&&o.model&&o.model.set("state","read")}return i&&A.publish("NGF_Criterion_Edition",{}),i})}return new s(function(e){e(i)})},_isSequenceValidate:function(e){return new s(function(t,i){e.areCriteriaValidate().then(function(i){i&&e.dispatchEvent("NGF_Criterion_Validation",{criteriaType:e.model.get("criteriaType"),viewId:e._getCSSId()}),t(i)})})},areCriteriaValid:function(){for(var e=!0,t=this._listView?this._listView.length:0,i=0;i<t&&e;i++){var n=this._listView[i];null!==n&&"edit"===n.model.get("state")&&(void 0===n._subGroupId||0===n._subGroupId?"function"==typeof n.isCriterionValid&&(e=n.isCriterionValid()):e=n.areCriteriaValid())}return e},setDeactivateVisible:function(e){var t=this._GroupContextualMenu.findIndex(e=>"activate-item-DDCtx"===e.recId);e?-1===t&&(this._GroupContextualMenu=[],this._GroupContextualMenu.push(0===this._subGroupId?this._renameItem:this._editSequenceItem),this._duplicateItem&&this._GroupContextualMenu.push(this._duplicateItem),this._GroupContextualMenu.push(this._deactivateItem),this._GroupContextualMenu.push(this._deleteItem)):0===this._subGroupId&&(this._GroupContextualMenu=[],this._GroupContextualMenu.push(this._renameItem),this._duplicateItem&&this._GroupContextualMenu.push(this._duplicateItem),this._GroupContextualMenu.push(this._deleteItem))},_createContextualMenuWUX:function(e){if(e||!this._GroupContextualMenu){this._renameItem={type:"PushItem",recId:"rename-item-DDCtx",title:d.get("renameFilterSpecification"),icon:r.getIconByName("rename"),action:{this:this,callback:this._onRenameSpecification}},this._editSequenceItem={type:"PushItem",recId:"editSequence-item-DDCtx",title:d.get("editCriteria"),icon:r.getIconByName("pencil"),action:{this:this,callback:this._onEditSubGroup,context:{forceEdit:1}}},this._duplicateItem={type:"PushItem",recId:"duplicate-item-DDCtx",title:d.get("duplicateFilterGroup"),icon:r.getIconByName("duplicate"),action:{this:this,callback:this._duplicateSpecification}},this._activateItem={type:"PushItem",recId:"activate-item-DDCtx",title:d.get("activatedCriteria"),icon:r.getIconByName("eye"),action:{this:this,callback:this._checkBeforeChangeState}},this._deactivateItem={type:"PushItem",recId:"activate-item-DDCtx",title:d.get("deactivatedCriteria"),icon:r.getIconByName("eye-off"),action:{this:this,callback:this._checkBeforeChangeState}},this._deleteItem={type:"PushItem",recId:"delete-item-DDCtx",title:d.get("deleteFilterGroup"),icon:r.getIconByName("trash"),action:{this:this,callback:this._removeGroup}},this._GroupContextualMenu=[],0===this._subGroupId&&this._GroupContextualMenu.push(this._renameItem),this._duplicateItem&&0===this._subGroupId&&this._GroupContextualMenu.push(this._duplicateItem),this._GroupContextualMenu.push(this._deleteItem);var t=this;(e||this.getElement(this._getCSSId()+" .ctx-group-menu")).addEventListener("click",function(e){if(e.stopPropagation(),t.model.get("isParentActivated")){var i=e.target.getBoundingClientRect();N.show(t._GroupContextualMenu,{position:r.getMenuPosition(i)})}})}},_createConfig:function(e,t){if(!this._cfgView){var i=new u({criteriaType:"config",state:e?"edit":"read"});this.collection.add(i),this._cfgView=new f({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,childGroupId:this._childGroupId,model:i,rootId:this._rootID,initWithConfig:t||!1,isEditable:this._isConfigurationAvailable,pfServiceId:this.options.pfServiceId,securityContext:this._securityContext}),this.listenTo(this._cfgView,"NGF_Criterion_Config",this._onConfigCriterionCB.bind(this));var n=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._cfgView.render().inject(n,"before"),this._addCriterionView(this._cfgView),e||this._cfgView.editConfiguration(),this._createConfigBtn&&(this._createConfigBtn.disabled=!0,this._createConfigBtn.active=!1)}},_onConfigCriterionCB:function(e){e.displayMode;switch(e.action){case"remove":this._cfgView&&this._cfgView.destroy(),this._hasConf=!1;break;case"update":this._hasConf=e.hasConf;var t=e.cfgType||e.model&&e.model.config_filter_id?"configId":"binary";S.setUsageTracker(this._widgetId,"NGF-Configuration",t)}},_createVolume:function(e){if(!this._volumeView){var t=new u({criteriaType:"volume",state:"edit"});this.collection.add(t),this._volumeView=new I({UXId:this._UXId,NGFUXId:this._NGFUXId,widgetId:this._widgetId,rootId:this._rootID,childGroupId:this._childGroupId,model:t,sendEvent:0!==e?1:0,filterSpecId:this._groupId,isEditable:this._isVolumeAvailable}),this._createVolumeBtn&&(this._createVolumeBtn.disabled=!0,this._createVolumeBtn.active=!1);var i=this._SpecExpander.getContent().getElement(".wux-controls-expander-body>ul>.criterionButtonLi");this._volumeView.render().inject(i,"before"),this._addCriterionView(this._volumeView)}return this._volumeView},_duplicateSpecification:function(){this.dispatchEvent("NGF_DuplicateSpecifcation",{specId:this.cid,rootSpec:this._appliesToCombo?this._appliesToCombo.value:this._rootID,specName:this.model.getFilterSpecificationName()})},updateDuplicatedView:function(e){this._appliesToCombo&&(this._appliesToCombo.value=e.rootSpec,this._dispatchChangeRootEvent=1),this.isThereCriteria()&&this.dispatchEvent("NGF_UpdateApplySaveSaveAsState",{status:"ValidOK"})},setEnableDuplication:function(e){var t=this._GroupContextualMenu.findIndex(e=>"duplicate-item-DDCtx"===e.recId);e?-1===t&&this._GroupContextualMenu.splice(1,0,this._duplicateItem):-1!==t&&this._GroupContextualMenu.splice(t,1)},_removeGroup:function(){0===this._subGroupId?this.dispatchEvent("NGF_RemoveGroup",{groupId:this.cid,initFilterUI:1}):this._onRemoveCriterion({idxView:this.cid,subgGroupId:this._subGroupId})},destroy:function(){for(var e=this._listView.length,t=e-1;t>=0;t--){var i=this._listView[t];null!=i&&i.destroy()}if(0===this._subGroupId){this._listView.splice(0,e),this._listViewId.splice(0,e);var n=this.collection.toArray();this.collection.remove(n),this._subscribe1&&(this._subscribe1.unsubscribe("NGFilter_VolumeDefined"),this._subscribe1=void 0),this._volumeView=void 0,this.stopListening(),this.model=null,this._parent(),this.container=null,this._subscribe0.unsubscribe("NGFilter_WidgetRemoved"),this._subscribe2.unsubscribe("NGFilter_ConfigDefined")}},_onRemoveCriterion:function(e){if(0===this._subGroupId){if(this._listViewId.length,-1!==(s=this._listViewId.indexOf(e.idxView))){var t=this._listView[s].model;this.collection.remove(t),this._listView.splice(s,1),this._listViewId.splice(s,1),1}if(e.criteriaType&&"attribute"===e.criteriaType||"Sequence"===e.criteriaType){var i=this.getCriteriaViewsByType("attribute").concat(this.getCriteriaViewsByType("Sequence"));this.dispatchEvent("NGF_AttributeCommandsState",{enable:i.length?1:0})}if(e.criteriaType&&"config"===e.criteriaType&&(this._hasConf=e.hasConf,!1===this._hasConf&&(this._createConfigBtn&&(this._createConfigBtn.disabled=!1,this._createConfigBtn.active=!0),this._cfgView=void 0)),e.criteriaType&&"context"===e.criteriaType&&(this._contextMgmtView=null,this._createContextBtn&&(this._createContextBtn.disabled=!1,this._createContextBtn.active=!0)),e.criteriaType&&"volume"===e.criteriaType)this.collection.findWhere({criteriaType:"volume"})||(this._volumeView=void 0,this._createVolumeBtn&&(this._createVolumeBtn.disabled=!1,this._createVolumeBtn.active=!0));var n=document.getElementsByClassName(".keepChildren");void 0!==n[0]&&n.hide(),this.dispatchEvent("NGF_AddSpecificationState"),e.edited&&A.publish("NGF_Criterion_Edition",{})}else{var s,o,r,a;if(-1!==(s=this._listViewId.indexOf(e.idxView))?(a=[this._listView[s].model],o=s,r=1):(a=this.collection.toArray(),o=0,r=this._listView.length),this.collection.remove(a),this._listView.splice(o,r),this._listViewId.splice(o,r),0!==this._listView.length){var l=this._listView[0].model.get("criteriaType"),d=this._listView[0].model.get("sequenceType");("attribute"===l||"Sequence"===l&&"attribute"===d)&&this._listView[0].setEnableKeepRemove(!0),1===this._listView.length&&this.dispatchEvent("NGF_SwitchSequenceToCriterion",{idxView:this.cid})}else this.dispatchEvent("NGF_RemoveCriterion",{idxView:e.idxView}),this.stopListening(),this.model=null,this._parent(),this.container.getParent().remove()}},_checkBeforeChangeState:function(){this.dispatchEvent("NGF_Criterion_ValidateEdited",{callback:this._toggleActivatedState.bind(this)})},setActivatedState:function(e,t){this._setActivatedState(e,t)},_toggleActivatedState:function(e){var t=r.isModelActivated(this.model)?0:1;this._setActivatedState(t,e)},_setActivatedState:function(e,t){var i=0===e?"0":"1";if(this.model.setActivated(i),0===this._subGroupId){if(t&&!0===t.updateChildren){this.collection.forEach(function(e){e.set("isActivated",i)})}this.dispatchEvent("NGF_SpecificationActivateChange",{viewId:this._getId()})}else{var n=r.isModelActivated(this.model)?this._deactivateItem:this._activateItem,s=this._GroupContextualMenu.findIndex(e=>n.recId===e.recId);-1===s?this._GroupContextualMenu.splice(2,0,e?this._activateItem:this._deactivateItem):this._GroupContextualMenu[s]=n;var o=this.getElement(this._getCSSId()+" .Sequence-read .subGroup-read-criterion");o&&(e?o.removeClassName("f-criterion-deactivated"):o.addClassName("f-criterion-deactivated"),this.dispatchEvent("NGF_CheckActivateCriteria"))}},_onActivateChange:function(e,t){let i="0"===t;if(0===this._subGroupId){var n=r.isModelActivated(e)?this._deactivateItem:this._activateItem,s=this._GroupContextualMenu.findIndex(e=>n.recId===e.recId);-1===s?this._GroupContextualMenu.splice(2,0,i?this._activateItem:this._deactivateItem):this._GroupContextualMenu[s]=n;var o=this._SpecExpander.getContent().getElement(" .tree-v2"),a=this._SpecExpander.getContent().getElement(".wux-controls-expander-header").getElement(".headerTitle"),l=this.getElement(".filter-applies");let t=i?0:1;this.collection.forEach(function(e){e.set("isParentActivated",t)}),this._createConfigBtn&&(this._createConfigBtn.disabled=i),this._createAttributeBtn&&(this._createAttributeBtn.disabled=i),this._createContextBtn&&(this._createContextBtn.disabled=i),this._createVolumeBtn&&(this._createVolumeBtn.disabled=i),i?(a.addClassName("f-group-deactivated"),l.addClassName("f-group-deactivated"),o.addClassName("f-group-deactivated")):(a.removeClassName("f-group-deactivated"),l.removeClassName("f-group-deactivated"),o.removeClassName("f-group-deactivated"))}else{let e=this._getCSSId(),t=this.getElement(e+" .group-header2");i?t.addClassName("f-group-deactivated"):t.removeClassName("f-group-deactivated"),this.getElements(e+" ol").forEach(function(e){i?e.addClassName("f-group-deactivated"):(e.removeClassName("f-group-deactivated"),e.removeClassName("f-criterion-deactivated"))})}},_addCriterionView:function(e){this._listView.push(e),this._listViewId.push(e.cid),this._childGroupId++,this._initCriterionViewEvents(e)},_initCriterionViewEvents:function(e){this.listenTo(e,"NGF_RemoveCriterion",this._onRemoveCriterion.bind(this)),this.listenTo(e,"NGF_Criterion_SwitchedToEdit",this._onEditCriterion.bind(this)),this.listenTo(e,"NGF_Criterion_Validation",this._editReadMgt.bind(this)),this.listenTo(e,"NGF_Criterion_ValidateEdited",this._checkBeforeEdit.bind(this)),this.listenTo(e,"NGF_Criterion_Activated",this._onCriterionActivated.bind(this));var t=this,i=e.model.get("criteriaType"),n=e.model.get("sequenceType");("attribute"===i||"Sequence"===i&&"attribute"===n)&&(this.listenTo(e,"NGF_AttrKeepToRemoveMode",function(){if(t._subGroupId){t._subGroupKeepRemoveMode=0;for(var e=t._listView.length,i=1;i<e;i++)t._listView[i].initKeepRemove("Remove")}this.dispatchEvent("NGF_AttrKeepToRemoveMode")}),this.listenTo(e,"NGF_AttrRemoveToKeepMode",function(){if(t._subGroupId){t._subGroupKeepRemoveMode=1;for(var e=t._listView.length,i=1;i<e;i++)t._listView[i].initKeepRemove("Keep")}this.dispatchEvent("NGF_AttrRemoveToKeepMode")}),this.listenTo(e,"NGF_ComputeSynthesis",this._onComputeSynthesis.bind(this)),"attribute"===i&&(this.listenTo(e,"NGF_SwitchCriterionToSequence",this._onSwitchCriterionToSequence.bind(this)),0!==this._subGroupId&&this.listenTo(e,"NGF_Criterion_Activated",this._onCriterionActivated.bind(this))))},setTagMdlAsLocal:function(e){if(JSON.stringify(e.allfilters)!==JSON.stringify(e.localfilters)){e.localfilters||(e.localfilters={});for(var t=0;t<Object.keys(e.allfilters).length;t++){var i=Object.keys(e.allfilters)[t];e.allfilters[i].forEach(t=>{if(e.localfilters[i])for(var n=0;n<e.localfilters[i].length;n++)e.localfilters[i][n].object!==t.object&&e.localfilters[i].push(t);else e.localfilters[i]=e.allfilters[i]})}}},filterViewFromModel:function(e,t,i,n){var s=this,o=!1;this._appliesToCombo&&(this._dispatchChangeRootEvent=0,this._appliesToCombo.value=e||this._rootID),this.switchToEdit();var a=[];return t.toFeedUI.forEach(t=>{if(null!==t){var l=t.criteriaType,d=null;if("attribute"===l){s.types=n;var c=[];if(s.types.forEach(e=>{c.push(e.name)}),r.isEasyAttributeDisplayMode()&&r.FILTER_ANY_OBJECT===t.type)s._selectedTypeIndex=void 0;else{let e=c.indexOf(t.type);s._selectedTypeIndex=-1===e?void 0:e}if(d=s.createAttribute(s.types,"create",{model:t,listAttr:i[t.type],listAttrExtension:i[t.extension]})){var u=d.viewFromMdl(t);a=a.concat(u)}else console.log("\n\n ==> filterViewFromModel / attribute = "+s._rootAlias+"\n\n")}else if("config"===l)s._createConfig(!0),(d=s._cfgView).viewFromMdl(t),s._onConfigCriterionCB({hasConf:!0,action:"update",model:t});else if("Sequence"===l){var h=t.sequenceType;if("attribute"===h){var p=t.allAttributes;if(p){var _=[];p.forEach(function(e){_.push(e.isActivated||"1"),e.isActivated="1"}),d=s._createSubGroup(h);var m={filterSpecificationName:s.model.getFilterSpecificationName(),isActivated:"1",toFeedUI:p};d.filterViewFromModel(e,m,i,n),d.collection.forEach(function(e,t){e.set("isActivated",_[t])}),d._subGroupKeepRemoveMode=m.toFeedUI[0].Keep,d._listView[0].setEnableKeepRemove(!0)}}}else if("context"===l){var f=(d=s._createContextMgmtView(!1)).model;Object.keys(t).forEach(function(e){f.set(e,t[e])}),d.viewFromMdl(f)}else if("volume"===l){(d=s._createVolume(0)).viewFromMdl(t)}else"tag"===l&&(o=t,s.setTagMdlAsLocal(t),s.createTagNGF(t),s.tagView&&s.tagView.viewFromMdl(t));d&&d.model&&d.model.set("state","read")}}),t.isActivated&&"0"===t.isActivated&&this._toggleActivatedState({updateChildren:!1}),this.updateFilterSpecificationName(t.filterSpecificationName||this._defaultSpecName),{retrievedTags:o,attrNotFound:a}},checkConfigFilter:function(e){return!this._cfgView||this._cfgView.checkConfigFilter(e)},_createAddAttributeSequenceButton:function(e){var t=new v(r.getAttributeButtonStyle("list-ordered"));t.inject(e),t.tooltipInfos=new b({shortHelp:d.get("addAttributeInSeqenceTooltip"),mouseRelativePosition:!0});var i="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;t.getContent().addClassName(i+" attributeCriterion-edit-addSequence-btn");var n=this;return t.addEventListener("click",function(e){S.setUsageTracker(n._widgetId,"NGF-Attribute","Create_Sequence");var t=n._listView?n._listView.length:0,i=!t;if(t){i=!0;for(var s=0;s<t;s++){var o=n._listView[s];if(null!==o&&"edit"===o.model.get("state")&&(void 0===o._subGroupId||0===o._subGroupId)){if("function"!=typeof o.isCriterionValidate){i=!1,r.displayNotification({level:"error",message:d.get("NeedToValidateCrirerion")});break}(i=o.isCriterionValidate())&&o.model.set("state","read")}}}i&&n._addNewCriterion({type:"attribute"})}),t},_createValidateButton:function(e){if(0===r.isAsynchronousValidation())this._createValidateButtonSync(this,e);else{this._validateButton=new v(r.getAttributeValidateButtonStyle()),this._validateButton.inject(e),this._validateButton.tooltipInfos=new b({shortHelp:d.get("validateAttributeSequenceCriterionTooltip"),mouseRelativePosition:!0});var t="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;this._validateButton.getContent().addClassName(t+" attributeCriterion-edit-validate colorized");var i=this;this._validateButton.addEventListener("buttonclick",function(){i.areCriteriaValidate().then(function(e){e&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType"),viewId:i._getCSSId()})})})}},_createRenameFilterSpecLineEditor:function(){var e,t=new C({touchMode:r.TOUCH_MODE,placeholder:d.get("placeHolderFilterName")});t.value=this.model.getFilterSpecificationName()||d.get("defaultGroupName"),e=0===this._subGroupId?this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle"):this.getElement(".group-name"),t.inject(e,"after");var i=this,n=function(e){var t=e.dsModel.value;i.model.getFilterSpecificationName()===t?i.updateFilterSpecificationName(t):(t=""===t?i._defaultSpecName:t,i.dispatchEvent("NGF_UpdateSpecificationName",{name:t,computeIndexCB:function(e){i.model.setFilterSpecificationIndex(e.index),i.updateFilterSpecificationName(e.name)}}))};return t.addEventListener("focus",function(e){t.value=i.model.getFilterSpecificationName()}),t.addEventListener("change",n),t.addEventListener("blur",n),t},updateFilterSpecificationName:function(e){if(this.model.setFilterSpecificationName(e),this._filterSpecNameEditor.hide(),this._SpecExpander){var t=this._SpecExpander.getContent().getElement(".wux-controls-expander-container").getElement(".headerTitle");t.setText(" "+this.model.getFilterSpecificationLabel()),t.show()}this.dispatchEvent("NGF_UpdateSpecificationName",{name:e})},isViewEdited:function(){var e=this.collection.findWhere({state:"edit"});return!(!("edit"===this.model.get("state")?1:0)&&!e)},buildViewsFromRepairModel:function(e){this._listView.forEach(t=>{t.buildViewFromRepairModel(e)})},updateModelsFromRepair:function(e){var t=[];return this._listView.forEach(i=>{t.push(i.updateModelFromRepair(e))}),t},getEditedCriterion:function(){var e,t=[];this._listView.forEach(e=>{t.push(e)});var i=-1,n=t.findIndex(t=>{var n="edit"===t.model.get("state");return n&&(t._subGroupId&&0!==t._subGroupId?i=t._listView.findIndex(e=>"edit"===e.model.get("state")):"volume"===t.model.get("criteriaType")&&(e=t.getEditedVolume())),n});return-1===n&&-1===i?void 0:{inView:n,inSubView:i,volumeEdited:e}},setCrtierionAsEdited:function(e){if(void 0!==e.inView&&void 0!==e.inSubView){var t=this._listView[e.inView];t.model.set("state","edit"),-1!==e.inSubView?t._listView[e.inSubView].model.set("state","edit"):e.volumeEdited&&t.setVolumeAsEdited(e.volumeEdited)}this.switchToEdit()},checkDisplayKeepChildren:function(){for(var e=!1,t=this.collection.toArray(),i=0;i<t.length;i++)if("attribute"===t[i].get("criteriaType")&&!0===t[i].get("Keep")){e=!0;break}return e},updateCriteriaAvailibility:function(e){void 0!==e.volumeUsed&&(e.volumeUsed?(this._createVolumeBtn.show(),this._volumeView&&this._volumeView.setEditable(!0)):(this._createVolumeBtn.hide(),this._volumeView&&this._volumeView.setEditable(!1))),void 0!==e.contextUsed&&(e.contextUsed?(this._createContextBtn.show(),this._contextMgmtView&&this._contextMgmtView.setEditable(!0)):(this._createContextBtn.hide(),this._contextMgmtView&&this._contextMgmtView.setEditable(!1))),void 0!==e.attributeUsed&&(e.attributeUsed?this._createAttributeBtn.show():this._createVolumeBtn.hide(),this._listView.forEach(t=>{var i=t.model.get("criteriaType"),n=t.model.get("sequenceType");"attribute"!==i&&"attribute"!==n||t.setEditable(!!e.attributeUsed)}))},_onSwitchCriterionToSequenceSync:function(t,i){var n=t;if(n.areCriteriaValidateSync(n)){var s=n._createSubGroupView(i.type),o=n._listViewId.indexOf(i.idxView),r=n._listView[o],a=r.container,l=a.getElement(".colorized");l&&l.removeClassName("colorized"),s.collection.add(r.model),s._listView[0]=r,s._listViewId[0]=r.cid,s._subGroupKeepRemoveMode=i.attributeKeep?1:0,n.stopListening(r),s._initCriterionViewEvents(r);var d=n.collection.indexOf(r.model);n.collection.remove(r.model),n.collection.add(s.model,{at:d}),n._listView[o]=s,n._listViewId[o]=s.cid,n._listView.pop(),n._listViewId.pop();var c=e.createElement("li").inject(a,"after");s.render().inject(c),a.remove().inject(s.getElement(".Sequence-edit>ul")),"function"==typeof r.switchCriterionToSequence&&r.switchCriterionToSequence(),s._addNewCriterion({type:r.model.get("criteriaType")})}},areCriteriaValidateSync:function(e){var t=e,i=t._listView?t._listView.length:0,n=!i;if(i){n=!0;for(var s=0;s<i;s++){var o=t._listView[s];if(null!==o&&"edit"===o.model.get("state"))if(void 0===o._subGroupId||0===o._subGroupId){if("function"!=typeof o.isCriterionValidate){n=!1,r.displayNotification({level:"error",message:d.get("NeedToValidateCrirerion")});break}(n=o.isCriterionValidate())&&o.model&&o.model.set("state","read")}else(n=o.areCriteriaValidateSync(t))&&o.dispatchEvent("NGF_Criterion_Validation",{criteriaType:o.model.get("criteriaType"),viewId:o._getCSSId()})}}return n},_createValidateButtonSync:function(e,t){var i=e;i._validateButton=new v(r.getAttributeValidateButtonStyle()),i._validateButton.inject(t),i._validateButton.tooltipInfos=new b({shortHelp:d.get("validateAttributeSequenceCriterionTooltip"),mouseRelativePosition:!0});var n="attribute-edit-button-style"+r.FILTER_TOUCH_CLASS;i._validateButton.getContent().addClassName(n+" attributeCriterion-edit-validate colorized"),i._validateButton.addEventListener("buttonclick",function(){i.areCriteriaValidateSync(i)&&i.dispatchEvent("NGF_Criterion_Validation",{criteriaType:i.model.get("criteriaType"),viewId:i._getCSSId()})})}});return w}),define("DS/ENONextGenFilterUX/views/GlobalFilterView",["UWA/Class","UWA/Class/View","UWA/Core","UWA/Promise","UWA/Utils/InterCom","DS/WAFData/WAFData","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/globalViewTemplate.html","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","DS/ENONextGenFilterUX/views/GroupView","DS/ENONextGenFilterUX/views/FilterRepairView","DS/ENONextGenFilterUX/collections/FilterUIGlobalFilterCollection","DS/ENONextGenFilterUX/collections/FilterUIGroupCollection","DS/ENONextGenFilterUX/models/GroupModel","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices","DS/ENOFilterBIUX/FBISettings","DS/PlatformAPI/PlatformAPI","DS/TagNavigator/ActiveCriteria","DS/Windows/Dialog","DS/Windows/ImmersiveFrame","DS/Controls/LineEditor","DS/Controls/Button","DS/Controls/ComboBox","DS/UIKIT/Mask","DS/UIKIT/Alert","DS/WebappsUtils/WebappsUtils","DS/Controls/TooltipModel","DS/TreeModel/TreeDocument","DS/TreeModel/TreeNodeModel","DS/ENOFilterBIUX/FBIProxyServices","DS/Controls/Editor","DS/ENONextGenFilterUX/utils/FilterCollectionServices","text!DS/ENONextGenFilterUX/assets/ENOStrRefinementUX_require.json","DS/Utilities/TouchUtils","DS/Menu/Menu","DS/ENONextGenFilterUX/utils/NGFSecurityCtxConverter","DS/ENONextGenFilterUX/views/AdvFilterIDCard","DS/TagNavigatorOpenness/views/ActiveCriteriaView"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v,b,C,y,F,A,I,S,E,N,w,x,V,T,D,O,U,G,M,R,L,k,B){"use strict";var P="",X=1;return t.extend({_wgtActiveCriteriaView:null,domEvents:{"click .global-header-filtername":"_renameFilterCmd"},setup:function(e){d.displayInternalTimeTrace(1,"GlobalFilterView"),this._dialogWidth=350,this._isNewRepairActive=!!f.isActivated("RepairOnDrop"),this._hasToComputeSynthesis=1,this._computeSynthesisOnTimeOut=1e3*f.isDebugActive("SynthesisTimeOut");var t=this;this._currentMenuClass="Filter-menu",this._template=a.compile(l),this._defaultServiceId="3DSpace",this._pfServiceId=e.pfServiceId,this._appId=this.options.NGFUXId,this._widgetId=this.options.widgetId||this.options.widget,this._UXId=this.options.UXId,this._NGFUXId=this.options.NGFUXId,this._appQueryParam=this.options.appQueryParam,this._securityContext=this.options.securityContext,this._queryFormat=this._getQueryFormat(this._NGFUXId),this._expandIntent=this._getExpandIntent(this._NGFUXId),this._lightCB=sessionStorage.getItem("NGFilter_lightCB_"+this._NGFUXId+"-"+this._widgetId),this._appliedFilterTitle="",this._filterName="",this._filterDescription="",this._activeFilter="",this._hasAppliedNGF=!1,this._prdCfgIds=void 0,this._currentFilterSpecification="",this._filterState="New",this._types=null,this._rootID=e.rootID,this._rootAlias=e.rootAlias||"?",this._rootRevision=e.rootRevision||"",this._displayDensity=-1;var n,s=localStorage.getItem("NGF_DisplayDensity");n=null===s?void 0===M.getTouchMode()?1:M.getTouchMode()?1:0:Number(s),this._setDensity(n),this._isConfigAvailable=!1!==e.configUsed,this._isVolumeAvailable=!1!==e.volumeUsed,this._isContextAvailable=!1!==e.contextUsed,this._isAttributeAvailable=!1!==e.attributeUsed,this._filterToApply=e.filterToApply,this._listGroupView=[],this._listGroupViewId=[],this.nbGroupView=0,this.idxGFV=e.idxGFV,this.collection=new p(null,{appId:this._appId,widgetId:this._widgetId,model:e.model}),this._filterRepairView=new h({options:this.options}),this.listenTo(this._filterRepairView,"RepairFilter_UpdatetUI",function(e){t._updateModelFromRepairPanel(e.data),t._isNewRepairActive&&(t._isFilterBroken&&t._buildCVQueryOfSelectedFilter(t._retrievedTags),delete t._retrievedTags)}),this.listenTo(this._filterRepairView,"NGF_CancelRepairFilter",function(e){b.publish("Frame3DXInfra.Close"),t._cancelRepairFilter()}),this._isFilterBroken=!1;var o=f._getFilterSpecification(this.options);if(o&&o.data&&o.data.filterMdl&&o.data.filterMdl.length&&(this._droppedFilterData=[o.data]),this._dropOption=o?o.data.dropOption:this.options.dropOption,this._tagData="dropOnFilter"!==this._dropOption&&o&&o.data?i.clone(o.data.tagData):void 0,this._tagsInMdl=i.clone(this._tagData),this._tagsOnly=!1,this._keepAttributeChildren=!0,this._keepFilters={},E.mask(t.container),!t._rootID&&e.filterToApply&&(t._rootID=e.filterToApply.rootID,t._rootAlias=e.filterToApply.rootAlias||this._rootAlias),null===this._wgtActiveCriteriaView){var c=d._getRootFilterContainer(this._UXId).getElement(".ActiveCriteriaView-container");this._wgtActiveCriteriaView=new B({sections:[{id:"section-additionalFilters",title:r.get("activeFilters"),icon:{fonticon:"filter"}},{id:"section-filters"}]}).render().inject(c),this._wgtActiveCriteriaView.addEvent("onAdditionalCriteriaChange",this.onAddCriteriaChange.bind(this))}this._filterIDCard=new k({parent:this,serviceId:this._defaultServiceId,securityContext:this._securityContext,widgetId:this._widgetId}),this.listenTo(this.model,"onChange:state",this._onStateChange.bind(this)),this.listenTo(this._filterIDCard.getContainer(),"NGF_OwnerChangedNewSpecification",function(e){1===t._isFilterFromModel&&(t._isFilterFromModel=0,t._updateFilterTitle(t._defaultFilterName),t._updateActiveCriteriaView(t._defaultFilterName),t._forcedTitle="",t.getElement(".global-header-name-edit").show())}),this._subscribeRemoveFilter=b.subscribe("NGFilter.RemoveFilter",this._onRemoveFilter.bind(this)),this._subscribeRedraw=b.subscribe("NGFilter.Redraw",this._onRedraw.bind(this)),this._subscribeSecurityContext=b.subscribe("NGFilter.SetDefaultSecurityContext",this._onSetSecurityContext.bind(this)),this._subscribeWidgetRemoved=b.subscribe("NGFilter_WidgetRemoved",this._onWidgetRemoved.bind(this)),this._subscribeRemoveFromTaggerACV=b.subscribe("NGFilter.RemoveFromTaggerACV",this.onAddCriteriaChange.bind(this)),this._subscribeLaunchFilterCmd=b.subscribe("NGFilter_LaunchFilterCmd",this._onLaunchFilterCmd.bind(this)),this._subscribeFocusACV=b.subscribe("NGFilter.addFocusChangeListener",this._onAddFocusChangeListener.bind(this)),this._synthesisState=1===d.isDelayedSynthesisActive()?-1:1,this._isFilteredSynthesis=!1,this.render()},render:function(){var e=this;this.container.setContent(this._template({attributeChildrenHiddenLabel:r.get("AttributeChildrenHidden")})),this._createGlobalBtn(),this._attrFromSynthesis=[];this._initSecurityContext(this._securityContext).then(function(t){e._onSetSecurityContext({NGFUXId:e._NGFUXId,securityContext:t.default}),e._linkedRoots=void 0,function(){if(d.displayInternalTimeTrace(1,"GlobalFilterView Before Expand Synthesis"),e._droppedFilterData)e._getLinkedRootsFromModel(e._droppedFilterData).then(t=>{e._linkedRoots=t;var i=function(t,i){e._synthesisInfos=t,e._initFilterGroup(),e._buildViewFromDroppedFilter(i),e._removeSynthesisAlert(),d.computeAttributesFromSynthesis(t).then(function(t){e._attrFromSynthesis=t},function(t){e._attrFromSynthesis=t}),d.displayInternalTimeTrace(0,"GlobalFilterView After Expand Synthesis")};-1===e._synthesisState?e._computeSynthesisFromModel(e._droppedFilterData[0]).then(t=>{i(t,e._droppedFilterData)}):d.getExpandSynthesisInfos(e._getExpandContext(),e._appQueryParam).then(function(t){i(t,e._droppedFilterData)},function(t){e._synthesisInfos=[],e._synthesisState=-1,e._initFilterGroup(),e._buildViewFromDroppedFilter(e._droppedFilterData),e._displaySynthesisAlert()})});else{var t=function(){var t=function(){sessionStorage.setItem("NGF_isUXBuilt_"+e._UXId,!0),e._initFilterGroup()};return new n(i=>{e._getLinkedRoots().then(n=>{e._linkedRoots=n||void 0,t(),i()},function(e){console.log(" ==> _getLinkedRoots / Retrieve root failed, err = "+e),t(),i()})})};if(-1===e._synthesisState)t().then(()=>{e._removeSynthesisAlert()});else{var i=function(t){e._synthesisInfos=t,d.computeAttributesFromSynthesis(e._synthesisInfos).then(function(t){e._attrFromSynthesis=t},function(t){e._attrFromSynthesis=t}),e.groupView.setSynthesisInfos({synthesis:e._synthesisInfos,state:e._synthesisState}),d.displayInternalTimeTrace(0,"GlobalFilterView After Expand Synthesis")};t().then(()=>{d.getExpandSynthesisInfos(e._getExpandContext(),e._appQueryParam).then(function(t){i(t),e._removeSynthesisAlert()},function(t){e._synthesisState=-1,i([]),e._displaySynthesisAlert()})})}}}()});var t=this.getElement(".global-header-filtername");e._defaultFilterName=e._getVolatileFilterName(),e._updateFilterTitle(e._defaultFilterName),t.tooltipInfos=new x({shortHelp:r.get("ClickToRenameFilter")+" "+this._filterName,mouseRelativePosition:!0});var i=d._getRootFilterContainer(this._UXId);this._cmdsContainer=i.getElement(".global-filter-commands"),this._createRenameFilterUI(),this._createGlobalFilterCommandWUX(),this._createKeepAttributeChildrenUI(),this._updateKeepAttributeChildrenUI(this._keepAttributeChildren),this._divCombination=this._createCombination(),this._divCombination.hide(),this._divSpecificationCmd=this.getElement("#filter-specifications-cmd"),this._addNewSpecBtn=this._createNewSpecificationBtn(this._divSpecificationCmd),this._addExistingSpecBtn=this._createExistingSpecificationBtnWUX(this._divSpecificationCmd),this._divSpecificationCmd.hide();var s=new I({domId:"go-WelcomePage",showLabelFlag:!1,icon:d.getIconByName("home"),displayStyle:"lite"});s.inject(this._cmdsContainer),s.getContent().addClassName("go-WelcomePage"),s.addEventListener("buttonclick",this._onGoBackWelcomePage.bind(this)),s.tooltipInfos=new x({shortHelp:r.get("GoBackWelcomePageTooltip"),mouseRelativePosition:!0});var o=this.options.ghostContainer;return o&&o.remove(),this},onAddCriteriaChange:function(){this._onACCriteria(this._getFilterTitle())},_onAddFocusChangeListener:function(e){this._wgtActiveCriteriaView.updateActiveViewOnFocusChange(e)},_createGlobalBtn:function(){var e=this.getElement(".global-footer");this._applyFilterButton=new I({touchMode:d.TOUCH_MODE,domId:"applyFilterButton",label:r.get("applyFilterButtonLabel"),emphasize:"primary",disabled:!0}),this._applyFilterButton.inject(e),this._applyFilterButton.getContent().addClassName("applyFilterButtonLabel"),this._applyFilterButton.addEventListener("buttonclick",this._onApplyFilterCB.bind(this)),this._saveFilterButton=new I({touchMode:d.TOUCH_MODE,domId:"saveFilterButton",label:r.get("saveFilterButtonLabel"),emphasize:"secondary",disabled:!0}),this._saveFilterButton.inject(e),this._saveFilterButton.getContent().addClassName("saveFilterButtonLabel"),this._saveFilterButton.addEventListener("buttonclick",this._onSaveFilter.bind(this)),this._saveAsFilterButton=new I({touchMode:d.TOUCH_MODE,domId:"saveAsFilterButton",label:r.get("saveAsFilterButtonLabel"),emphasize:"secondary",disabled:!0}),this._saveAsFilterButton.inject(e),this._saveAsFilterButton.getContent().addClassName("saveAsFilterButtonLabel"),this._saveAsFilterButton.addEventListener("buttonclick",this._onSaveAsFilter.bind(this))},_onWidgetRemoved:function(e){this._NGFUXId===e.NGFUXId&&(this._queryFormat=this._getQueryFormat(this._NGFUXId),this._expandIntent=this._getExpandIntent(this._NGFUXId))},_onLaunchFilterCmd:function(){this.groupView.isViewEdited()&&this.validateEditedCriterion().then(e=>{b.publish("NGF_Criterion_Edition",{})})},_getQueryFormat:function(e){for(var t=0,i=sessionStorage.length,n=0;n<i;n++){var s=sessionStorage.key(n);-1!==s.indexOf("NGFilter_ExpandType_"+e)&&(t|=sessionStorage.getItem(s))}var o=1===v.getOption("ProgressiveSynthesisOn")?1:0;return f.isProgressiveExpandActive()&&o?t|=f.EXPAND_SERVICES.progressive:t&f.EXPAND_SERVICES.expand||t&f.EXPAND_SERVICES.expand3d||(t|=f.EXPAND_SERVICES.expand),t},_getExpandIntent:function(e){for(var t=sessionStorage.length,i=0;i<t;i++){var n=sessionStorage.key(i);if(-1!==n.indexOf("NGFilter_ExpandIntent_"+e)&&"1"===sessionStorage.getItem(n))return 1}return 0},_initSecurityContext:function(e){var t=this;return new n(function(i,n){e?i({default:e}):d.getAllSecurityContexts(t._defaultServiceId).then(function(e){var t=e.cspaces.findIndex(e=>e.isDefault);t=-1===t?0:t,i({default:e.cspaces[t].value})})})},_onSetSecurityContext:function(e){this._NGFUXId===e.NGFUXId&&this._defaultSC!==e.securityContext&&(this._defaultSC=e.securityContext,this._scForSaveFilter=L.getPrefixedSecurityContext(this._defaultSC),this._filterIDCard&&this._filterIDCard.setContext({securityContext:this._defaultSC}))},_cancelRepairFilter:function(){this._onResetFilter(),this._onACCriteria(this._getFilterTitle()),this._isNewRepairActive&&(delete this._retrievedTags,this.options.droppedInfos&&b.publish("NGFilter.ApplyDroppedFilters/"+this._UXId,{success:[],failure:[{rootId:this._rootID,evt:"info",msg:i.String.format(r.get("DropBorkenFilterCancelled"),this._droppedFilterData[0].filterTitle)}]}))},setAppQueryParam:function(e){this._appQueryParam=e},_onGoBackWelcomePage:function(){if(f.setUsageTracker(this._widgetId,"NGF-Commands","homePage"),this._isFilterFromModel)if(this._filterIDCard.isFilterModified())this._displaySaveDialogForSavedFilter();else{var e=JSON.stringify(this.getFilterSpecification(this._rootID,this._keepAttributeChildren));!(!this._currentFilterSpecification||this._currentFilterSpecification===e)?this._displaySaveDialogForSavedFilter():this._displaySaveDialogForVolatileFilter()}else this._displaySaveDialogForVolatileFilter()},_displaySaveDialogForSavedFilter:function(){var e=this,t=i.createElement("div",{class:"ngf-save-dialog"});i.createElement("img",{src:w.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterWarning.png")}).inject(t);var n="<span>"+r.get("SaveSavedFilterBeforeGoHome")+"<span>",s="<span>"+r.get("LostModificationsOnSavedFilter")+"<span>";i.createElement("div",{class:"ngf-save-dialog-margin",html:"<span>"+n+"<br>"+s+"<br><span>"}).inject(t);var o=new F({identifier:"NGF_ConfirmRequest"});o.inject(window.document.body);var a=new y({domId:"dialog-goHomePage",touchMode:!0,modalFlag:!0,title:r.get("HomeFilteringTitle")+" - "+this._filterTitle,content:t,immersiveFrame:o,customButtonsDefinition:[{domId:"save-goHomePage",label:r.get("SaveBeforeGoHome"),emphasize:"primary",onClick:function(t){let i=e.getFilterSpecification(e._rootID,e._keepAttributeChildren),n=e._defaultDBFilterName;if(e._keepFilterNames){let t=e._keepFilterNames.length;for(var s=0;s<t;s++){let t=e._keepFilterNames[s];if(e._filterTitle===e._keepFilters[t].filterTitle){n=t;break}}}e._updateFilter(e._scForSaveFilter,n,e._filterDescription,e._filterTitle,"",i,e._activeFilter).then(function(t){t&&(a.close(),e._goToHomePage(e._getFilterTitle()),e._combinationCombo.selectedIndex=1)})}},{domId:"ok-goHomePage",label:r.get("DontSaveBeforeGoHome"),emphasize:"secondary",onClick:function(t){a.close(),e._goToHomePage(e._getFilterTitle()),e._combinationCombo.selectedIndex=1}},{domId:"cancel-goHomePage",label:r.get("CancelSaveUI"),onClick:function(e){a.close()}}]});a.width=this._dialogWidth,this._addMenuClass(e._currentMenuClass),a.addEventListener("close",function(t){e._removeMenuClass(e._currentMenuClass)})},_displaySaveDialogForVolatileFilter:function(){var e=this;if("true"===sessionStorage.getItem("NGF_ToggleHomePage"))this._goToHomePage(this._getFilterTitle());else{var t=i.createElement("div",{class:"ngf-save-dialog"}),n="<span>"+r.get("SaveVolatileFilterBeforeGoHome")+"<span>",s="<span>"+r.get("LostModificationsOnVolatileFilter")+"<span>";i.createElement("div",{html:"<span>"+n+"<br>"+s+"<br><span>"}).inject(t);var o=new F({identifier:"NGF_ConfirmRequest"});o.inject(window.document.body);var a=new y({domId:"dialog-goHomePage",touchMode:!0,modalFlag:!0,title:r.get("HomePageTitle"),content:t,immersiveFrame:o,buttons:{Cancel:new I({domId:"cancel-goHomePage",onClick:function(e){a.close()}}),Ok:new I({domId:"ok-goHomePage",label:r.get("GoToHomePageButton"),emphasize:"primary",onClick:function(t){a.close(),e._goToHomePage(e._getFilterTitle())}})},checkboxInfos:{label:r.get("DoNotShowAgain"),checkFlag:!1}});a.width=this._dialogWidth,this._addMenuClass(e._currentMenuClass),a.addEventListener("close",function(t){sessionStorage.setItem("NGF_ToggleHomePage",a.checkboxInfos.checkFlag),e._removeMenuClass(e._currentMenuClass)})}},_isThereCriteriaDefined:function(){for(var e=!1,t=this._listGroupView.length,i=0;i<t;i++)if(this._listGroupView[i].isThereCriteria()){e=!0;break}return e},_displaySynthesisAlert:function(e,t){var i=this;if(!this._alertSynthesisFailed){this._alertSynthesisFailed=new N({visible:!0,closeOnClick:!1,events:{onRemoveMessage:function(){i._removeSynthesisAlert()}}}),this._alertSynthesisFailed.inject(this.getElement(".global-header"),"before");var n=t||r.get("ExpandSynthesisFailed"),s="<a> ("+r.get("RefreshSynthesis")+")</a>";this._alertSynthesisFailed.add({className:"primary",message:n+" "+s}),this._alertSynthesisFailed.getContent().getElement("a").addEventListener("click",function(t){i._refreshSynthesisInfos(e||!0,!0,n)})}},_removeSynthesisAlert:function(){this._alertSynthesisFailed&&this._alertSynthesisFailed.isVisible&&(this._alertSynthesisFailed.getContent().remove(),this._alertSynthesisFailed=void 0)},_buildViewFromDroppedFilter:function(e){var t=this;this.retrieveFilter=!0,this.droppedFilter=!0;let i=!!(e&&e.length&&e[0].share);this._keepFilters={},this._keepFilterNames=[],this._initFiltersToKeep(e,this.retrieveFilter).then(function(n){t._keepFilters=n.filters,t._keepFilterNames=n.names;var s=t._keepFilters,o=e.length;t._filterDescription=o?e[o-1].filterDescription:"",o=Object.keys(s).length;var r=0;for(var a in s)t._setFilterTitle(s[a].filterTitle),r++,d.checkAndGetListOfAttributesFromSelectedFilter(s[a]).then(function(e){t.groupView.setSynthesisInfos({synthesis:t._synthesisInfos,state:t._synthesisState}),t._buildFilterUIFromSelectedFilter(a,e,d.getTypesOfSynthesis(t._synthesisInfos));var n=t._getFilterTitle();if(t._updateFilterTitle(n),o===r){t._updateCombinationCombo(),t._updateAddSpecificationButton(),t._setGlobalButtonsStatus(i?"ValidOK":"SaveAsOK");let e=t.collection.getActiveGroupCollection();t._setApplySelectable(!!e.length)}}),t._activeFilter=s[a].filterPhysicalId||s[a].filterId,"dropOnFilter"!==t._dropOption&&(t._updateActiveCriteriaView(t._getFilterTitle()),P=t._UXId,t._hasAppliedNGF=!0);t._onDisplayGlobalFilterView()},function(e){t._displayNotifOnActionFilterFailed("FilterCanNotBeRestored",e)})},_getDefaultFilterName:function(){var e=this;return this._defaultFilterName||(this._defaultFilterName=r.get("defaultFilterName")+"-"+this.idxGFV),new n(function(t){c.getDefaultFilterName(e._defaultFilterName,e._defaultSC).then(function(i){e._defaultDBFilterName=i,t(i)})})},_getVolatileFilterName:function(){if(!this._defaultFilterName)return X=this.idxGFV?this.idxGFV++:X++,r.get("defaultFilterName")+"-"+X},_initFilterGroup:function(){this._setGlobalButtonsStatus("New"),this._addGroupView()},_addGroupView:function(e){var t=this,i=new _([],{widgetId:this._bodyContainer});let n=new m({groupCollection:i});var s=e&&e.specName?e.specName:n.getFilterSpecificationName(),o=this.collection.getGroupCollectionIndex(s);-1!==o&&n.setFilterSpecificationIndex(o),this.groupView=new u({NGFUXId:this._NGFUXId,appId:this._appId,widgetId:this._widgetId,groupId:this.nbGroupView,rootID:this._rootID,rootAlias:this._rootAlias,rootRevision:this._rootRevision,model:n,UXId:this._UXId,synthesisInfos:this._synthesisInfos,synthesisState:this._synthesisState,securityContext:this._defaultSC,configAvailable:this._isConfigAvailable,volumeAvailable:this._isVolumeAvailable,contextAvailable:this._isContextAvailable,attributeAvailable:this._isAttributeAvailable,tagData:this._tagData,pfServiceId:this._pfServiceId,linkedRoots:this._linkedRoots}),this.nbGroupView+=1,this.groupView.render().inject(this.getElement("#filter-groups")),this.collection.add(n),this.listenTo(this.groupView,"NGF_AttrKeepToRemoveMode",function(){!1===this._checkDisplayKeepChildren()&&this._updateKeepAttributeChildrenUI()}),this.listenTo(this.groupView,"NGF_AttrRemoveToKeepMode",function(){this._updateKeepAttributeChildrenUI(this._keepAttributeChildren)}),this.listenTo(this.groupView,"NGF_RefreshSynthesis",function(e){e&&e.refresh?t._refreshSynthesisInfos(!1,!0,e.onErrorMsg):d.displayNotification({level:"warning",message:r.get("RefreshOnCriteriaNotValid")})}),this._listGroupView.push(this.groupView),this._listGroupViewId.push(this.groupView.cid),this.listenTo(this.groupView,"NGF_RemoveGroup",this._onRemoveGroup.bind(this)),this.listenTo(this.groupView,"NGF_Criterion_ValidateEdited",this.validateEditedCriterion.bind(this)),this.listenTo(this.groupView,"NGF_Group_SwitchedToEdit",this._onEditGroup.bind(this)),this.listenTo(this.groupView,"NGF_AddSpecificationState",this._updateAddSpecificationButton.bind(this)),this.listenTo(this.groupView,"NGF_AttributeCommandsState",this._onAttributeCommandsState.bind(this)),this.listenTo(this.groupView,"NGF_UpdateSpecificationName",this._onUpdateSpecificationName.bind(this)),this.listenTo(this.groupView,"NGF_UpdateApplySaveSaveAsState",this._updateApplySaveSaveAsState.bind(this)),this.listenTo(this.groupView,"NGF_SpecificationActivateChange",this._onSpecificationStateChange.bind(this)),this.listenTo(this.groupView,"NGF_DisplayGlobalFilterView",this._onDisplayGlobalFilterView.bind(this)),this.listenTo(this.groupView,"NGF_EndSetFilterSpecification",this._onEndSetFilterSpecification.bind(this)),this.listenTo(this.groupView,"NGF_ComputeSynthesis",this._onComputeSynthesis.bind(this)),this.listenTo(this.groupView,"NGF_DuplicateSpecifcation",this._onDuplicateSpecification.bind(this)),this.listenTo(this.groupView,"NGF_ChangeRootOfSpecifcation",this._onChangeRootOfSpecification.bind(this)),this.listenTo(this.groupView,"NGF_CheckActivateCriteria",this._checkActiveCriteria.bind(this)),1<this._listGroupView.length&&(this._listGroupView.forEach(function(e){e.setDeactivateVisible(!0)}),this._divCombination&&this._divCombination.show()),this._filterToApply&&(this._feedViewWithFilter(this._filterToApply),this._filterToApply=void 0)},_feedViewWithFilter:function(e){var t=this,n=(l=e?e.specification:void 0)&&l.type?l.type:"";if("NGFilter_CopyFromAnyFilterToRoots"===n){if(!this._isThereCriteriaDefined()){var s=l.data;this._filterToApply=void 0,this.buildFilterUIFromFilterRelatedToQuery(s.filterData,s.listAttr,s.rootId,s.options).then(function(){t.onApplyFilter()})}}else if("NGFilter_VolumeDefined"===n)b.publish(n,l.data);else if("NGFilter_ConfigDefined"===n)e.NGFUXId=e.NGFUXId||this._NGFUXId,b.publish(n,e);else if("NGFilter_RetrieveFilter"===n||"NGFilter_ShareFilterSpec"===n||"NGFilter_RetrieveRoot"===n)this._dropOption=l.data.dropOption,this._dropedFilterIds=[],this._dropedFilterIds=Array.isArray(l.data.filterId)?l.data.filterId:[l.data.filterId];else if("NGFilter_createFromTag"===n){var o="NGF_tagMgtRunning_"+this._UXId;sessionStorage.setItem(o,!0),this.setTagsDataOnNGF(l.data)}else if("NGFilter_Unlink"===n)t._computeSynthesisFromModel(l.data).then(i=>{t._synthesisInfos=i,d.computeAttributesFromSynthesis(i).then(function(i){var n=d.getTypesOfSynthesis(t._synthesisInfos);t._attrFromSynthesis=i;var s=[];s[d.FILTER_ANY_OBJECT]=t._attrFromSynthesis;t._buildFilterViewFromFilterModel(l.data,s,n);t._onDisplayGlobalFilterView(),e.applyFilter?t.onApplyFilter({dispatchApplyToApp:e.applyFilter}):e._tagsOnly||t._updateActiveCriteriaView(t._getFilterTitle())})});else if("NGFilter_SetPublicFilterSpec"===n){let n=function(t,i){if(e.proxyEvent){var n={status:1};t&&(n.status=0,n.error={level:i?"warning":"error",title:r.get("SetPublicFilterSpecification"),message:t}),b.publish(e.proxyEvent,n)}};if(this._isThereCriteriaDefined()&&!this._tagsOnly)n(r.get("FilteringInProgress"),1);else{let s=l.data?i.clone(l.data):void 0;if(s&&!(s.title||s.referencedObject||s.filter)&&(s={title:this._defaultFilterName,referencedObject:{identifier:this._rootID},filter:l.data}),s&&s.filter){(s.filter.filterSpecifications||[]).forEach(e=>{(e||[]).filterCriteria.forEach(e=>{if(e&&"tag"===e.criteriaType){let t=e.tagsDefinition?e.tagsDefinition:{};Object.keys(t).forEach(e=>{(t[e]?t[e]:{}).forEach(e=>{let t=e?Object.keys(e):[];for(let i=t.length-1;i>=0;i--)"object"!==t[i]&&"type"!==t[i]&&delete e[t[i]]})})}})})}f.convertPublicSpecToFilterSpec(t._securityContext,s).then(function(i){t._resetFilter({initFilterUI:1}),l.data={filterUIComponents:i.filterSpec},l.data.filterUIComponents.forEach(function(e){if("toFeedUI"in e&&Array.isArray(e.toFeedUI)){var i=!1;e.toFeedUI.forEach(function(e){"tag"===e.criteriaType&&(i=!0,f._mergeTagData(e,t._tagsInMdl),delete t._tagsInMdl,t._tagsInMdl=UWA.clone(e),delete t._tagData,t._tagData=UWA.clone(e))}),t._tagsInMdl&&!i&&e.toFeedUI.push({criteriaType:"tag",allfilters:t._tagsInMdl.allfilters,localfilters:t._tagsInMdl.localfilters})}}),t._computeSynthesisFromModel(l.data).then(s=>{t._synthesisInfos=s,d.computeAttributesFromSynthesis(s).then(s=>{t._attrFromSynthesis=s,d.checkAndGetListOfAttributesFromSelectedFilter(l.data).then(o=>{o[d.FILTER_ANY_OBJECT]=s,t._isFilterBroken=!1;var r=d.getTypesOfSynthesis(t._synthesisInfos);t._buildFilterViewFromFilterModel(l.data,o,r);t._isFilterFromModel=0,delete t.options.filterToApply,t._updateFilterTitle(i.title),t._onDisplayGlobalFilterView(),e.applyFilter&&t.onApplyFilter(),e.displayFilter&&(b.publish("Frame3DXInfra.Update",{type:"Filter",display:!0,options:t.options}),d.openFilterPanel("NGFilter_SetPublicFilterSpec-"+Date.now())),n()})})})},function(e){console.log("==> SetPublicFilter / convertToPersistency , err = "+e),n(e.error)})}}else if("NGFilter_GetPublicFilterSpecFromVolatile"===n){var a=e.rootID,l=this.getFilterSpecification(a,this._keepAttributeChildren,void 0,{keepEmpty:!1}),c={rootPhysicalId:a,filterName:this._defaultFilterName,filterTitle:this._getFilterTitle(),filterDescription:this._filterDescription,filterUIComponents:l,rootServiceId:this.options.pfServiceId};f.convertVolatileFilterSpecToPublicSpec(t._securityContext,c).then(t=>{var i={status:1,publicSpec:t};b.publish(e.proxyEvent,i)},function(t){console.log("==> GetPublicFilter / convertToPublic , err = "+t);var i={status:0,error:{level:"error",title:r.get("GetPublicFilterSpecification"),message:t}};b.publish(e.proxyEvent,i)})}else this.groupView&&this.groupView.feedViewWithFilter(e).then(function(){t._updateApplySaveSaveAsState({status:"ValidOK"}),t._onDisplayGlobalFilterView(),e&&e.applyFilter&&t.onApplyFilter(),e&&e.displayFilter&&d.openFilterPanel(t._UXId)})},_onEndSetFilterSpecification:function(e){this._updateApplySaveSaveAsState({status:"ValidOK"}),this._onDisplayGlobalFilterView(),1===e.applyFilter&&this.onApplyFilter(),0!==e.displayFilter&&d.openFilterPanel("NGF_EndSetFilterSpecification_"+Date.now())},_onDuplicateSpecification:function(e){this._onAddNewFilterSpecification(e)},_onChangeRootOfSpecification:function(e){var t=this;this.validateEditedCriterion().then(function(i){if(i){t.groupView.model.set("state","read");var n=t.collection.keepComponentsToFeedUI(t._rootID,t._keepAttributeChildren,void 0,{keepEmpty:!0}),s=t._listGroupViewId.indexOf(e.specId),o=[];o.push(n[0]),o.push(n[s+1]),d.checkCompatibiltyFilterRules(t._securityContext,e.rootId,{rootPhysicalId:e.newRootId,filterUIComponents:o},1,t.options.pfServiceId).then(function(i){i.result.error?d.checkAndGetListOfAttributesFromSelectedFilter(i.filterSpec).then(function(n){n[d.FILTER_ANY_OBJECT]=t._attrFromSynthesis;var o=d.getTypesOfSynthesis(t._synthesisInfos);t._listGroupView[s].clearCriteria(),t._listGroupView[s].filterViewFromModel(e.rootId,i.filterSpec.filterUIComponents[1],n,o),e.callback&&e.callback.call(t,e.newRootId)}):e.callback&&e.callback.call(t,e.newRootId),t._updateCombinationCombo()})}})},_onComputeSynthesis:function(e){var t=this;this._hasToComputeSynthesis&&(this._hasToComputeSynthesis=0,setTimeout(()=>{-1!==this._synthesisState&&E.mask(this.container),d.getExpandSynthesisInfos(this._getExpandContext(),this._appQueryParam).then(function(i){d.computeAttributesFromSynthesis(i).then(function(n){t._hasToComputeSynthesis=1,E.unmask(t.container),t._synthesisInfos=i,t._synthesisState=1,t._attrFromSynthesis=n,t._listGroupView.forEach(function(e){e.setSynthesisInfos({synthesis:t._synthesisInfos,state:t._synthesisState,attributes:t._attrFromSynthesis})}),"function"==typeof e.callback&&e.callback(e.options),t._removeSynthesisAlert()},function(e){console.log("_onComputeSynthesis / computeAttributesFromSynthesis failed, err = "+e),t._listGroupView.forEach(e=>{e.updateOnceSynthesisComputed()}),t._hasToComputeSynthesis=1,E.unmask(t.container),t._displaySynthesisAlert()})},function(e){console.log("_onComputeSynthesis / getExpandSynthesisInfos failed, err = "+e),t._listGroupView.forEach(e=>{e.updateOnceSynthesisComputed()}),t._hasToComputeSynthesis=1,E.unmask(t.container),t._displaySynthesisAlert()})},this._computeSynthesisOnTimeOut))},_refreshSynthesisInfos:function(e,t,i){var n=void 0===t||t;n&&E.mask(this.container);var s=this,o=function(e,t){s._synthesisInfos=e,s._synthesisState=1,s._attrFromSynthesis=t,s._listGroupView.forEach(function(e){e.setSynthesisInfos({synthesis:s._synthesisInfos,state:s._synthesisState,attributes:s._attrFromSynthesis})}),n&&E.unmask(s.container),s._removeSynthesisAlert()},r=function(e,t){t&&E.unmask(s.container),s._displaySynthesisAlert(e,i)};if(e)if(0===g.getCVQueryBuildMode()){var a=this._buildCVQuerySync(),l=D.completeCVQueryWithAppParams(JSON.parse(a),this._appQueryParam,void 0,!1);d.refreshExpandSynthesisInfos(this._getExpandContext(),l).then(function(e){o(e),s._isFilteredSynthesis=!0},function(t){r(e,n)})}else this.buildCVQuery().then(function(t){var i=D.completeCVQueryWithAppParams(JSON.parse(t),s._appQueryParam,void 0,!1);d.refreshExpandSynthesisInfos(s._getExpandContext(),i).then(function(e){d.computeAttributesFromSynthesis(e).then(function(t){o(e,t),s._isFilteredSynthesis=!0})},function(t){r(e,n)})});else d.getExpandSynthesisInfos(this._getExpandContext(),this._appQueryParam).then(function(e){d.computeAttributesFromSynthesis(e).then(function(t){o(e,t)})},function(t){r(e,n)})},_checkDisplayKeepChildren:function(){let e=!1,t=this._listGroupView.length;for(var i=0;i<t&&!e;i++){let t=this._listGroupView[i];d.isModelActivated(t.model)&&(e=t.checkDisplayKeepChildren())}return e},_onSelectObject:function(e){this._rootID=e.rootID,this._rootAlias=e.rootAlias,this.groupView&&(this.groupView._rootID=this._rootID,this.groupView._rootAlias=this._rootAlias),this.getElement(".filter-applies")&&this.getElement(".filter-applies-root").setContent(this._rootAlias)},_onSaveFilter:function(){var e=this;0===d.isAsynchronousValidation()?e._onSaveFilterSync(e):this.validateEditedCriterion().then(function(t){if(t){var i="{}";0===g.getCVQueryBuildMode()&&(i=e._buildCVQuerySync());var n=e.getFilterSpecification(e._rootID,e._keepAttributeChildren);e._isFilterFromModel?e._checkFilterNameAndUpdateFilter(e._defaultFilterName,i,n):e._displayRenameDialogAndCreateFilter("SaveTitle",i,n),e.groupView.switchToEdit()}else e.groupView.switchToEdit()})},_onSaveAsFilter:function(){var e=this;0===d.isAsynchronousValidation()?e._onSaveAsFilterSync(e):this.validateEditedCriterion().then(function(t){if(t){var i="{}";0===g.getCVQueryBuildMode()&&(i=e._buildCVQuerySync());var n=e.getFilterSpecification(e._rootID,e._keepAttributeChildren);e._displayRenameDialogAndCreateFilter("SaveAsTitle",i,n),e.groupView.switchToEdit()}})},_checkFilterNameAndUpdateFilter:function(e,t,n){var s=this;s._invalidFilterName&&(s._invalidFilterName.destroy(),s._invalidFilterName=null),s._invalidFilterDescription&&(s._invalidFilterDescription.destroy(),s._invalidFilterDescription=null);var o=i.createElement("div",{class:"ngf-save-dialog"});i.createElement("img",{src:w.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterWarning.png")}).inject(o);var a=r.get("OverwriteExistingFilter"),l=r.get("ProceedValidation");i.createElement("div",{class:"ngf-save-dialog-margin",html:"<span>"+a+"</span><br><span>"+l+"</span>"}).inject(o);var d=new F({identifier:"NGF_ConfirmRequest"});d.inject(window.document.body);var c=new y({touchMode:!0,modalFlag:!0,title:r.get("SaveTitle")+" - "+s._filterTitle,content:o,immersiveFrame:d,buttons:{Cancel:new I({label:r.get("CancelSaveUI"),emphasize:"secondary",onClick:function(e){c.close()}}),Apply:new I({domId:"saveAsFilterButton",label:r.get("saveAsFilterButtonLabel"),emphasize:"secondary",onClick:function(e){c.close(),s._onSaveAsFilter()}}),Ok:new I({label:r.get("SaveButton"),emphasize:"primary",onClick:function(i){s._updateFilter(s._scForSaveFilter,e,s._filterDescription,s._filterTitle,t,n,s._activeFilter).then(function(e){e&&c.close()})}})}});c.width=this._dialogWidth,this._addMenuClass(s._currentMenuClass),c.addEventListener("close",function(e){s._removeMenuClass(s._currentMenuClass)})},_displayRenameDialogAndCreateFilter:function(e,t,n,s){var o=this,a=new i.Element("div",{class:"ngf-Save-content"}),l=new i.Element("div",{class:"ngf-Save-filterName",html:"<p>"+r.get("FilterNameToSave")+"</p>"}).inject(a,"top"),c=r.get("placeHolderFilterName"),u=new A({touchMode:d.TOUCH_MODE,placeholder:c,domId:"SaveName"});u.inject(l);var h=new i.Element("div",{class:"ngf-Save-filterName",html:"<p>"+i.String.format(r.get("FilterDescriptionToSave"),256)+"</p>"});h.inject(a),c=r.get("FilterDescriptionToSavePlaceHolder");var p=new O({touchMode:d.TOUCH_MODE,nbRows:3,newLineMode:"enter",domId:"SaveDescription",value:this._filterDescription});p.inject(h),p.addEventListener("change",function(e){if(o._isFilterNameAllowed()&&o._isFilterDescriptionAllowed()){var t=e.dsModel.value.slice(0,255),i=e.target;void 0===i.tooltipInfos?i.tooltipInfos=new x({shortHelp:t,mouseRelativePosition:!0}):i.tooltipInfos.shortHelp=t,o._filterDescription=t}}),p.addEventListener("uncommittedChange",function(e){var t=e.dsModel.valueToCommit,n=o.saveUIModal.getContent().getElement("#SaveDescription"),s=t.slice(0,255),a=d.isSafe(s);if(a&&256>=t.length)n.removeClassName("attr-edit-inputs-Attribute-Error"),o._invalidFilterDescription&&o._invalidFilterDescription.hide();else{n.addClassName("attr-edit-inputs-Attribute-Error");var l=a?void 0:r.get("BadCharacters")+": "+d.XSS_NOT_ALLOWED.join(" "),c=256<t.length?i.String.format(r.get("FilterDescriptionTooLong"),256):void 0,u=l?'<p style="margin:0px">'+l+"</p>":"";u+=c?'<p style="margin:0px">'+c+"</p>":"",o._invalidFilterDescription?(o._invalidFilterDescription.setHTML(u),o._invalidFilterDescription.show()):o._invalidFilterDescription=new i.Element("div",{class:"wux-control-inline-saveName",html:u}).inject(n,"bottom")}if(o.saveUIModal){var h=!a||!o._isFilterDescriptionAllowed();o.saveUIModal.getContent().getElement(".wux-ui-state-primary").dsModel.disabled=h}}),this._getDefaultFilterName().then(function(t){E.unmask(b),u.value="SaveAsTitle"===e?o._defaultDBFilterName:s&&s.filterName?s.filterName:o._forcedTitle?o._forcedTitle:o._defaultDBFilterName,g=u.value,u.addEventListener("focus",function(e){}),u.addEventListener("change",function(e){if(o._isFilterNameAllowed()&&o._isFilterDescriptionAllowed()){o.saveUIModal.getContent().getElement("#SaveName");g=e.dsModel.value}}),u.addEventListener("uncommittedChange",function(e){var t=e.dsModel.valueToCommit,n=o.saveUIModal.getContent().getElement("#SaveName"),s=d.checkForBadCharacters(t),a=!t.length;if(!1===s||a){var l="";l=a?'<p style="margin:0px">'+r.get("FilterNameMustBeFeed")+"</p>":'<p style="margin:0px">'+r.get("BadCharacters")+": "+d.NAME_RULES.notAllowedChars.join(" ")+"</p>",n.addClassName("attr-edit-inputs-Attribute-Error"),o._invalidFilterName?(o._invalidFilterName.setHTML(l),o._invalidFilterName.show()):o._invalidFilterName=new i.Element("div",{class:"wux-control-inline-saveName",html:l}).inject(n,"bottom")}else n.removeClassName("attr-edit-inputs-Attribute-Error"),o._invalidFilterName&&o._invalidFilterName.hide();if(o.saveUIModal){var c=!(s&&!a&&o._isFilterDescriptionAllowed());o.saveUIModal.getContent().getElement(".wux-ui-state-primary").dsModel.disabled=c}})});var _=new i.Element("div",{class:"ngf-Save-filterName"}).inject(a,"bottom"),m=new i.Element("p",{}).inject(_);i.createElement("span",{text:r.get("getCurrentSecurityContext")}).inject(m),this._getListSecurityContext().then(function(e){o._securityContextCombo=new S({touchMode:d.TOUCH_MODE,elementsList:e,enableSearchFlag:!1}).inject(_,"bottom"),o._scForSaveFilter=o._securityContextCombo.currentValue,o._securityContextCombo.addEventListener("change",function(e){o._scForSaveFilter=e.dsModel.currentValue});var t=e.findIndex(e=>-1!==e.valueItem.indexOf(o._defaultSC));o._securityContextCombo.selectedIndex=-1===t?0:t;var n=i.createElement("span",{class:"fonticon fonticon-help ngf-Save-SecutiryContext-Help"});n.inject(m),n.tooltipInfos=new x({shortHelp:r.get("SecurityContextTooltip"),mouseRelativePosition:!0})});var g=this._getFilterTitle();this._invalidFilterName&&(this._invalidFilterName.destroy(),this._invalidFilterName=null),this._invalidFilterDescription&&(this._invalidFilterDescription.destroy(),this._invalidFilterDescription=null);var v=new F({identifier:"NGF_ConfirmRequest"});v.inject(window.document.body),this.saveUIModal=new y({touchMode:!0,modalFlag:!0,title:r.get(e),domId:"NGF_SavePanel",content:a,immersiveFrame:v,buttons:{Cancel:new I({label:r.get("CancelSaveUI"),emphasize:"secondary",onClick:function(e){o.saveUIModal.close(),s&&s.onCancel&&s.onCancel.call()}}),Ok:new I({label:r.get("SaveButton"),emphasize:"primary",onClick:function(i){if(g){let i=o._filterState;o._saveFilter(o._scForSaveFilter,o._defaultDBFilterName,o._filterDescription,g,t,n).then(function(t){if(t&&(i="SaveOK",s&&s.onOk&&s.onOk.call(),f.setUsageTracker(o._widgetId,"NGF-Save-Filter",{label:"save",value:"SaveAsTitle"===e?2:1}),f.setUsageTracker(o._widgetId,"NGF-Save-Filter-SpecificationCount",{label:"count",value:o._listGroupView.length}),1<o._listGroupView.length)){var n=o._combinationCombo.currentValue;n="union"===n?"any":"intersection"===n?"all":"except",f.setUsageTracker(o._widgetId,"NGF-Multi-Specification-Combination",n)}o.saveUIModal.close(),o._setGlobalButtonsStatus(i)})}else o.saveUIModal.getContent().getElement("#SaveName").addClassName("attr-edit-inputs-Attribute-Error"),o._removeMenuClass(o._currentMenuClass)}})}}),this.saveUIModal.width=this._dialogWidth;var b=document.body.getElement("#NGF_SavePanel .wux-windows-window-mask-content");return E.mask(b),this._addMenuClass(o._currentMenuClass),this.saveUIModal.addEventListener("close",function(e){o._removeMenuClass(o._currentMenuClass)}),this.saveUIModal},_isFilterNameAllowed:function(){return!!(!this._invalidFilterName||this._invalidFilterName&&this._invalidFilterName.isHidden())},_isFilterDescriptionAllowed:function(){return!!(!this._invalidFilterDescription||this._invalidFilterDescription&&this._invalidFilterDescription.isHidden())},_getListSecurityContext:function(){var e=this;return new n(function(t,i){sessionStorage.removeItem("NGF_listSecurityContext"),e._listSecurityContext?t(e._listSecurityContext):d.getAllSecurityContexts(e._defaultServiceId).then(function(i){var n=[],s=i.cspaces;if(Array.isArray(s)){for(var o=0;o<s.length;o++)n[o]={labelItem:s[o].label,valueItem:L.getPrefixedSecurityContext(s[o].value)};e._listSecurityContext=n}t(n)})})},_onApplyFilterCB:function(e){this.onApplyFilter()},onApplyFilter:function(e){var t=this;0===d.isAsynchronousValidation()?t.onApplyFilterSync(t):this.validateEditedCriterion().then(function(i){if(i)if(1===t._synthesisState&&t._isFilteredSynthesis&&(t._refreshSynthesisInfos(!1,!1),t._isFilteredSynthesis=!1),P=t._UXId,t._hasAppliedNGF=!0,t._appliedFilterTitle=t._getFilterTitle(),t._tagsOnly=!!e&&e.tagsOnly,0===g.getCVQueryBuildMode()){var n=t._buildCVQuerySync(!1);t._applyFilter({CVQuery:n,isEmpty:!!e&&e.empty}),t.groupView.switchToEdit(),t._updateAddSpecificationButton(),t._updateApplySaveSaveAsState({status:"ValidOK"})}else t.buildCVQuery().then(function(i){t._applyFilter({CVQuery:i,isEmpty:!!e&&e.empty,tagsInMdl:t._tagsInMdl,dispatchApplyToApp:e?e.dispatchApplyToApp:void 0,event:e?e.event:void 0}),t.groupView.switchToEdit(),t._updateAddSpecificationButton(),t._updateApplySaveSaveAsState({status:"ValidOK"})},function(e){t._displayNotifOnActionFilterFailed("FilterCanNotBeApplied",e)});else t.groupView.switchToEdit()})},_onRemoveFilter:function(e){var t=e.NGFUXId;if(t){var i=0;if(e.rootIds)for(var n=Array.isArray(e.rootIds)?e.rootIds:[e.rootIds],s=0;s<n.length;s++){if(t+"_"+n[s]===this._UXId){i=1;break}}else i=-1!==this._UXId.indexOf(t)?1:i;i&&(this._resetFilter({initFilterUI:0}),this._updateActiveCriteriaView(""),this._hasAppliedNGF=!1,this.dispatchConfigRevision(!0),this._subscribeRemoveFilter&&this._subscribeRemoveFilter.unsubscribe("NGFilter.RemoveFilter"),this._subscribeRemoveFilter&&this._subscribeRedraw.unsubscribe("NGFilter.Redraw"),this._subscribeSecurityContext&&this._subscribeSecurityContext.unsubscribe("NGFilter.SetDefaultSecurityContext"),this._subscribeLaunchFilterCmd&&this._subscribeLaunchFilterCmd.unsubscribe("NGFilter_LaunchFilterCmd"),this._filterIDCard&&this._filterIDCard.remove())}},_emptyFilter:function(e){var t=this._listGroupView.length;if(0!==t){for(var i=e&&e.initFilterUI?e.initFilterUI:void 0,n=t-1;n>=0;n--){var s=this._listGroupView[n];null!=s&&this._removeGroup({groupId:s.cid},i)}b.publish("NGF_Criterion_Edition",{})}this._divSpecificationCmd.hide(),this._setGlobalButtonsStatus("New")},_saveFilter:function(e,t,s,o,a,l){var u=this;return new n(function(n,h){u._setFilterTitle(o);var p="3DSpace"!==u._pfServiceId?u._pfServiceId:"";c.saveFilter(e,t,s,o,u._rootID,a,l,p).then(function(e){e&&e.filter?(d.displayNotification({level:"success",message:r.get("FilterCreationSuccessfull")}),u._updateFilterTitleAndAC(o),e.filterId&&(u._activeFilter=e.filterId,b.publish("NGFilter_saved",{rootID:u._rootID,filterId:e.filterId})),u._displayFilterIDCard(!0,e.filterId,e.filter[0]),u._isFilterFromModel=1,u._unsavedChangesMsgDisplayed=!1,n(!0)):(d.displayNotification({level:"error",subtitle:i.String.format(r.get("FilterCreationFailed"),"Advanced Filter"),message:"<p>"+r.get("FilterAccessFailed-1")+"<br>"+r.get("FilterAccessFailed-2")+"</p>"}),u._setFilterTitle(u._defaultFilterName),n(!1))})})},_updateFilter:function(e,t,i,s,o,a,l){var u=this;return new n(function(n,h){c.updateFilter(e,t,i,s,o,a,l).then(function(e){e&&e.filter?(d.displayNotification({level:"success",message:r.get("FilterUpdateSuccessfull")}),u._filterIDCard&&u._filterIDCard.displayUnsavedChangesPanel(!1),u._unsavedChangesMsgDisplayed=!1,u._updateFilterTitleAndAC(s),n(!0)):(d.displayNotification({level:"error",subtitle:r.get("FilterUpdateFailed"),message:"<p>"+r.get("FilterAccessFailed-1")+"<br>"+r.get("FilterAccessFailed-2")+"</p>"}),n(!1))})})},_applyFilter:function(e){var t,i,n=e.CVQuery,s=e.isEmpty,o=this._appliedFilterTitle,a=!1;if(s||(t=this.getFilterSpecification(this._rootID,this._keepAttributeChildren),i=JSON.stringify(t),a=!(!this._currentFilterSpecification||this._currentFilterSpecification===i),this._isFilterFromModel?a?(o+=r.get("WithUnsavedChanges"),this._unsavedChangesMsgDisplayed=!0):o+=this._unsavedChangesMsgDisplayed?r.get("WithUnsavedChanges"):"":o+="",a&&this._filterIDCard.displayUnsavedChangesPanel(!0)),this._currentFilterSpecification=i,this._updateActiveCriteriaView(o),e&&e.tagsInMdl&&this._wgtActiveCriteriaView.updateCriteria(e.tagsInMdl),n&&(n="string"==typeof n?JSON.parse(n):n),null==e.dispatchApplyToApp||e.dispatchApplyToApp){var l={empty:s,appId:this._appId,widget:this._widgetId,CVQuery:n.CVQuery,CVQuery3D:n.CVQuery3D,CVQueryV2:n.CVQueryV2,filterMdl:t,filterRootIds:[this._rootID],filterRootAlias:[this._rootAlias],filterTitle:this._filterTitle,filterId:this._activeFilter?this._activeFilter:void 0,tagsInMdl:e.tagsInMdl,event:e.event};this._removeUselessQueries(l),b.publish("onApplyNGFilter/"+this._NGFUXId,l),this.dispatchConfigRevision(s)}sessionStorage.setItem("NGF_isUXBuilt_"+this._UXId,!0)},_removeUselessQueries:function(e){this._queryFormat&f.EXPAND_SERVICES.progressive||delete e.CVQueryV2,this._queryFormat&f.EXPAND_SERVICES.expand||delete e.CVQuery,this._queryFormat&f.EXPAND_SERVICES.expand3d||delete e.CVQuery3D},dispatchConfigRevision:function(e){var t={NGFUXId:this._NGFUXId,widgertId:this._widgetId,rootId:this._rootID},i=[];if(e||this._listGroupView.forEach(e=>{if(d.isModelActivated(e.model)){var t=e.getConfigRevision();i=i.concat(t)}}),i.length){this._filterAppliedWithConfigRevision=1;var n="NGFilter.SetConfigurationRevision_"+this._widgetId;t.configRevision=i,b.publish(n,t)}else if(this._filterAppliedWithConfigRevision){this._filterAppliedWithConfigRevision=0;n="NGFilter.RemoveConfigurationRevision_"+this._widgetId;b.publish(n,t)}},_onRedraw:function(e){this._wgtActiveCriteriaView&&this._UXId===e.filterId&&(this._isFilterBroken&&void 0!==this._isFilterBroken||this._updateActiveCriteriaView(this._hasAppliedNGF?this._getFilterTitle():""),P=this._UXId)},_updateActiveCriteriaView:function(e){if(this._hasAppliedNGF||this._tagsOnly||!this._hasAppliedNGF&&!e){if(null!==this._wgtActiveCriteriaView){var t=[];e&&t.push({displayValue:e,icon:"I_DefineFilter"}),this._wgtActiveCriteriaView.updateAdditionalCriteria(t)}b.publish("NGFilter.onRenameNGFilter/"+this._NGFUXId,e)}},_onACTrash:function(e){P===this._UXId&&(this._taggerMgt=!1,this._hasTag()&&(Object.keys(this._tagsInMdl.allfilters).length&&!Object.keys(this._tagsInMdl.localfilters).length&&this._hasAppliedNGF||(this._taggerMgt=!0)),this._onACEvent())},_onACCriteria:function(e){e&&this._appliedFilterTitle&&-1!==e.indexOf(this._appliedFilterTitle)&&this._onACEvent()},_hasTag:function(){return!(!this._tagsInMdl||!Object.keys(this._tagsInMdl.allfilters).length&&!Object.keys(this._tagsInMdl.localfilters).length)},_onACEvent:function(){if(this._appliedFilterTitle="",this._hasTag()){var e=this;if(this._tagsOnly=!0,0===g.getCVQueryBuildMode()){var t=this._buildCVQuerySync();this._applyFilter({CVQuery:t,isEmpty:!1})}else this.buildCVQuery().then(function(t){e._applyFilter({CVQuery:t,isEmpty:!1})})}else this._applyFilter({CVQuery:f.buildEmptyFilter(this._rootID),isEmpty:!0});P="",this._hasAppliedNGF=!1,sessionStorage.setItem("NGF_tagMgtRunning_"+this._UXID,!1),this._taggerMgt=!1},_onResetFilterCmd:function(e){f.setUsageTracker(this._widgetId,"NGF-Commands","reset"),this._onResetFilter()},_onResetFilter:function(e){this._resetFilter({initFilterUI:1,updateAC:e&&e.context?e.context.updateAC:1}),this._keepAttributeChildren=!0,this._isHideOrShowCmdDisabled=0,this._updateKeepAttributeChildrenUI(this._keepAttributeChildren),this._filterIDCard&&this._filterIDCard.remove(),this._displayFilterIDCard(!1),this._isFilterFromModel=0,this._unsavedChangesMsgDisplayed=!1},_resetFilter:function(e){this._emptyFilter(e),this._updateFilterTitle(this._defaultFilterName),this._updateActiveCriteriaView(this._hasAppliedNGF?this._getFilterTitle():""),this._activeFilter="",this._filterDescription="",this._forcedTitle=""},_onRemoveGroup:function(e){this._removeGroup(e,e.initFilterUI)},_removeGroup:function(e,t){var i=this._listGroupViewId.indexOf(e.groupId);if(-1!==i){var n=this._listGroupView[i];this._listGroupView.splice(i,1),this._listGroupViewId.splice(i,1),this.collection.removeGroupCollection(n.model),n.destroy();var s=this._listGroupView.length;if(0!==s){for(var o=-1,r=s-1;r>=0;r--)if(d.isModelActivated(this._listGroupView[r].model)){this.groupView=this._listGroupView[r],o=r;break}-1===o&&(this.groupView=this._listGroupView[s-1],this.groupView.setActivatedState(1)),this.groupView.setDeactivateVisible(1!==s),this.groupView.switchToEdit(),1===s&&this._divCombination&&(this._divCombination.hide(),this._combinationCombo.selectedIndex=1)}else{var a=this.getElement("#filter-groups");if(null!==a)for(;a.hasChildNodes();)a.removeChild(a.firstChild);delete this.groupView,this.nbGroupView=0,1===t&&(this._updateFilterTitle(this._defaultFilterName),this._setGlobalButtonsStatus("New"),this._synthesisState=-1,this._synthesisInfos=void 0,this._initFilterGroup(),this._removeSynthesisAlert())}this._updateCombinationCombo(),this._updateAddSpecificationButton(),this._updateAttributeCommandsState()}},_renameFilterCmd:function(){f.setUsageTracker(this._widgetId,"NGF-Commands","renameFilter"),"SaveOK"!==this._filterState?this.model.set("state","edit"):d.displayNotification({level:"info",message:r.get("UseSaveAsToRenameExistingFilter")})},_onStateChange:function(e,t){"edit"===t?(this.getElement(".global-header").addClassName("global-header-edit"),null!==this._renameFilterLineEditor&&this._renameFilterLineEditor._giveFocus()):this.getElement(".global-header").removeClassName("global-header-edit")},_createRenameFilterUI:function(){this._renameFilterLineEditor=this._createRenameFilterLineEditor()},_createRenameFilterLineEditor:function(){var e=this,t=new A({touchMode:d.TOUCH_MODE,placeholder:r.get("placeHolderFilterName")});t.value=e._defaultFilterName,t.inject(this.getElement(".global-header-filtername"),"after");var i=function(t){var i=d.checkForBadCharacters(t);return i?e._renameFilterLineEditor.getContent().removeClassName("attr-edit-inputs-Attribute-Error"):(d.displayNotification({level:"error",message:UWA.String.format(r.get("InvalidCharacters"),d.NAME_RULES.notAllowedChars.join(" "))}),e._renameFilterLineEditor.getContent().addClassName("attr-edit-inputs-Attribute-Error")),i};return t.addEventListener("focus",function(t){e._renameFilterLineEditor.getContent().hasClassName("attr-edit-inputs-Attribute-Error")||(e._renameFilterLineEditor.value=e._getFilterTitle())}),t.addEventListener("change",function(t){var n=t.dsModel.value;i(n)&&e._updateFilterTitleAndAC(n)}),t.addEventListener("blur",function(t){var n=t.dsModel.value;i(n)?e._updateFilterTitleAndAC(n):e._renameFilterLineEditor._giveFocus()}),t.addEventListener("uncommittedChange",function(e){var t=e.dsModel.valueToCommit;i(t)}),t},_updateFilterTitleAndAC:function(e){this._forcedTitle=e,this._updateFilterTitle(e),this.model.set("state","read"),this._updateActiveCriteriaView(e)},_updateFilterTitle:function(e){this._setFilterTitle(e),this._appliedFilterTitle&&(this._appliedFilterTitle=e);var t=this.getElement(".global-header-filtername");t.setHTML(this._getFilterTitle()),t.tooltipInfos=new x({shortHelp:r.get("ClickToRenameFilter")+" "+this._getFilterTitle(),mouseRelativePosition:!0})},_setFilterTitle:function(e){this._filterTitle=e},_getFilterTitle:function(){return this._filterTitle?this._filterTitle:this._defaultFilterName},_displayFilterIDCard:function(e,t,i){var n=this;e&&t?this._filterIDCard.updateIDCard(t,i).then(function(){n.getElement(".global-header-name-edit").hide(),n.getElement(".global-header-idcard").show()}):(this.getElement(".global-header-name-edit").show(),this.getElement(".global-header-idcard").hide())},_createGlobalFilterCommandWUX:function(){var e=this,t=this._cmdsContainer;this._densityBtn=new I({domId:"global-density-filter",touchMode:d.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:d.getIconByName(1===e._displayDensity?"view-big-tile":"view-small-tile")}),this._densityBtn.inject(t),this._densityBtn.tooltipInfos=new x({shortHelp:r.get("densityFilterTooltip"),mouseRelativePosition:!0});var i=[{type:"RadioItem",recId:"global-density-comfortable-item2-DDCtx",title:r.get("DisplayDensityComfortableItem"),icon:d.getIconByName("view-big-tile"),action:{this:this,callback:this._setDisplayDensityCmd,context:{density:1}}},{type:"RadioItem",recId:"global-density-compact-item2-DDCtx",title:r.get("DisplayDensityCompactItem"),icon:d.getIconByName("view-small-tile"),action:{this:this,callback:this._setDisplayDensityCmd,context:{density:0}}}];this._densityBtn.addEventListener("buttonclick",function(t){t.stopPropagation();var n=t.target.getBoundingClientRect();i[0].state=1===e._displayDensity?"selected|enabled":"unselected|enabled",i[1].state=0===e._displayDensity?"selected|enabled":"unselected|enabled",R.show(i,{position:d.getMenuPosition(n)})});var n=new I({domId:"global-reset-filter",touchMode:d.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:d.getIconByName("reset")});n.inject(t),n.tooltipInfos=new x({shortHelp:r.get("resetFilterTooltip"),mouseRelativePosition:!0}),n.addEventListener("buttonclick",this._onResetFilterCmd.bind(this)),this._hideAttrChildren=new I({domId:"global-hide-attribute-children",touchMode:d.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:d.getIconByName("flow-children-eye-off")}),this._hideAttrChildren.setOption("isActive",!0),this._hideAttrChildren.inject(t),this._hideAttrChildren.disabled=!0,this._hideAttrChildren.tooltipInfos=new x({shortHelp:r.get("HideAttributeChildrenItem"),mouseRelativePosition:!0}),this._hideAttrChildren.addEventListener("buttonclick",this._onHideAttributeChildrenCmd.bind(this)),this._showAttrChildren=new I({domId:"global-show-attribute-children",touchMode:d.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:d.getIconByName("flow-children-eye")}),this._showAttrChildren.setOption("isActive",!1),this._showAttrChildren.inject(t),this._showAttrChildren.disabled=!0,this._showAttrChildren.tooltipInfos=new x({shortHelp:r.get("ShowAttributeChildrenItem"),mouseRelativePosition:!0}),this._showAttrChildren.addEventListener("buttonclick",this._onShowAttributeChildrenCmd.bind(this)),this._showAttrChildren.hide(),this._refineBtn=new I({domId:"global-refine-suggested-values",touchMode:d.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:d.getIconByName("list-filter")}),this._refineBtn.inject(t),this._refineBtn.tooltipInfos=new x({shortHelp:r.get("RefreshSynthesisInfosTooltip"),mouseRelativePosition:!0}),this._refineBtn.disabled=!0,this._refineBtn.addEventListener("buttonclick",function(t){f.setUsageTracker(e._widgetId,"NGF-Commands","refineAttributes"),e._refreshSynthesisInfos(!0,!0),e._refineBtn.disabled=!0}),this._renameFilterBtn=new I({domId:"global-rename-filter",touchMode:d.TOUCH_MODE,showLabelFlag:!1,displayStyle:"lite",icon:d.getIconByName("rename")}),this._renameFilterBtn.inject(t),this._renameFilterBtn.tooltipInfos=new x({shortHelp:r.get("renameFilterTooltip"),mouseRelativePosition:!0}),this._renameFilterBtn.addEventListener("buttonclick",this._renameFilterCmd.bind(this))},_createKeepAttributeChildrenUI:function(){this._showKeepAttrChildren=new I({touchMode:d.TOUCH_MODE,displayStyle:"lite",label:r.get("ShowAttributeChildren"),id:"ShowKeepAttrChildren"}),this._showKeepAttrChildren.tooltipInfos=new x({shortHelp:r.get("ShowAttributeChildrenItem"),mouseRelativePosition:!0}),this._showKeepAttrChildren.inject(this.getElement("#keepAttributeChildrenMsg")),this._showKeepAttrChildren.getContent().addClassName("keepAttributeChildrenShowButton");var e=this;this._showKeepAttrChildren.addEventListener("buttonclick",function(t){e._onShowAttributeChildrenCmd()})},_onHideAttributeChildrenCmd:function(){f.setUsageTracker(this._widgetId,"NGF-Commands","hideChildren"),this._keepAttributeChildren=!1,this._updateKeepAttributeChildrenUI(this._keepAttributeChildren)},_onShowAttributeChildrenCmd:function(){this._keepAttributeChildren=!0,this._updateKeepAttributeChildrenUI(this._keepAttributeChildren)},_updateKeepAttributeChildrenUI:function(e){let t=this,i=function(e,i){if(e||i)if(t._isHideOrShowCmdDisabled){t._isHideOrShowCmdDisabled=0;let e=t._hideAttrChildren.getOption("isActive")?t._hideAttrChildren:t._showAttrChildren;e.disabled=!1,e.show()}else e?(t._hideAttrChildren.show(),t._hideAttrChildren.setOption("isActive",!0),t._showAttrChildren.hide(),t._showAttrChildren.setOption("isActive",!1)):(t._hideAttrChildren.hide(),t._hideAttrChildren.setOption("isActive",!1),t._showAttrChildren.show(),t._showAttrChildren.setOption("isActive",!0));else{t._isHideOrShowCmdDisabled=1,(t._hideAttrChildren.getOption("isActive")?t._hideAttrChildren:t._showAttrChildren).disabled=!0}};void 0===e?(this.getElement("#keepAttributeChildrenMsg").hide(),i(!1,!1)):!0===e?(this.getElement("#keepAttributeChildrenMsg").hide(),i(!0,!1)):(this.getElement("#keepAttributeChildrenMsg").show(),i(!1,!0))},_buildFilterUIFromSelectedFilter:function(e,t,i,n){var s=this._keepFilters[e];this._setFilterTitle(s.filterTitle);var o=this._buildFilterViewFromFilterModel(s,t,i,n);this._retrievedTags=o,this._isNewRepairActive&&this._isFilterBroken||(this._buildCVQueryOfSelectedFilter(o),delete this._retrievedTags)},_buildCVQueryOfSelectedFilter:function(e){var t=this;if(this._isFilterBroken||"drop"!==t._dropOption||(t._appliedFilterTitle=t._getFilterTitle(),t._hasAppliedNGF=!0,t._updateActiveCriteriaView(t._getFilterTitle()),e&&this._wgtActiveCriteriaView.updateCriteria(e)),e&&0===g.getCVQueryBuildMode()){var i=this._buildCVQuerySync();this._appliedFilterTitle=this._filterTitle,this._applyFilter({CVQuery:i,isEmpty:!1})}else{var n=t.options.droppedInfos;n&&t.buildCVQuery().then(function(i){var s=JSON.parse(i);s&&(s.filterTitle=t._getFilterTitle(),e&&(s.tagsInMdl=e,e.localfilters||(e.localfilters={}))),t._applyDroppedFilters(n.retrieveFilters,n.filterId,s),delete t.options.droppedInfos})}},_buildFilterViewFromFilterModel:function(e,t,n,s){var o=this;this._scForSaveFilter||this._initSecurityContext(this._securityContext).then(function(e){o._onSetSecurityContext({NGFUXId:o._NGFUXId,securityContext:e})});var a,l=f.getFilterUIComponents(e),c=l.length;this._combinationCombo&&s&&1===s.addExisting?a=this._combinationCombo.value:(a=l[0].toFeedUI.combinationOfSpecification||"union",a+="minus"===a?"-"+l[0].toFeedUI.minusIndex:"");var u=["-"].concat(l[0].toFeedUI.rootIds);t[d.FILTER_ANY_OBJECT]=this._attrFromSynthesis;for(var h=[],p={},_=1;_<c;_++){var m=this.groupView.filterViewFromModel(u[_],l[_],t,n);if(h=h.concat(m.attrNotFound),m.retrievedTags&&(p=m.retrievedTags,this._tagsInMdl=this._tagsInMdl?f._mergeTagData(this._tagsInMdl,m.retrievedTags):m.retrievedTags),_!==c-1){var g=this._listGroupView.length-1;this._listGroupView[g].model.set("state","read"),this._addGroupView()}}p&&Object.keys(p).length&&"dropOnFilter"===this._dropOption&&d.displayNotification({level:"info",message:r.get("filterWithNonAppliedTag")}),this._updateCombinationCombo(),this._updateAddSpecificationButton(),this._isFilterInContext?(this._isFilterFromModel=this._isFilterFromModel?1:0,this._isFilterInContext=0,this._updateApplySaveSaveAsState({status:"ValidOK"})):(this._isFilterFromModel=1,this._setGlobalButtonsStatus("SaveAsOK"));let v=this.collection.getActiveGroupCollection();if(this._setApplySelectable(!!v.length),E.unmask(o.container),this._prdCfgIds){let e=[];this._listGroupView.forEach((t,i)=>{if(!t.checkConfigFilter(o._prdCfgIds)){let t=o.collection.at(i)?o.collection.at(i).getFilterSpecificationName():"Specification #"+i;e.push(t)}}),this._prdCfgIds=void 0,e.length&&d.displayNotification({level:"warning",message:r.get("InvalidProdConfFilter")+" "+e.join(", ").toString()})}if(h.length&&(h=[...new Set(h)],d.displayAttrNotFoundNotif(h)),o._isFilterBroken){d.openFilterPanel(),E.mask(o.container);var b=new i.Element("div",{html:"<p>"+r.get("BrokenFilterWarning")+"</p>"}),C=new F({identifier:"NGF_ConfirmRequest"});C.inject(window.document.body);var A=new y({touchMode:!0,modalFlag:!0,title:r.get("RepairFilterTitle"),content:b,immersiveFrame:C,buttons:{Cancel:new I({class:"repair-cancel",label:r.get("CancelSolveUI"),emphasize:"secondary",onClick:function(e){A.close(),function(){E.unmask(o.container),f.setUsageTracker(o.widgetId,"NGF-RepairFilter","stop-repair"),o._onRedraw({filterId:o.options.UXId}),o._cancelRepairFilter()}.call()}}),Ok:new I({class:"repair-solve",label:r.get("SolveButton"),emphasize:"primary",onClick:function(e){A.close(),function(){f.setUsageTracker(o.widgetId,"NGF-RepairFilter","solve-repair");var e=o._filterRepairView.createJSONForRepairWebservice();e.dispatch;delete e.dispatch;var t=d.getGlobalEditContainer(o._UXId);if(null!==t){var i={url:d.getPlatformServiceUrl(),ctx:o._defaultSC};o._filterRepairView.logWebServiceOptions(i),o._filterRepairView.fetchRepairedPathsFromWebService(e).then(function(e){"RepairFilterFetchData_FAILURE"!==e&&(t.empty(),o._filterRepairView.render().getContent().inject(t)),E.unmask(o.container)})}o._onRedraw({filterId:o.options.UXId}),o._onACCriteria(o._getFilterTitle()),o.droppedFilter&&d.openFilterPanel(o.options.UXId)}.call()}})}});A.width=this._dialogWidth,this._addMenuClass(o._currentMenuClass),A.addEventListener("close",function(e){o._removeMenuClass(o._currentMenuClass)})}if(this._combinationCombo&&(this._combinationCombo.currentValue=a),1===this.collection.getGroupCollectionCount()){var S=l[0].toFeedUI.keepChildren;void 0!==S&&this._keepAttributeChildren!==S&&(this._keepAttributeChildren=S,this._updateKeepAttributeChildrenUI(this._keepAttributeChildren))}return this._displayFilterIDCard(!0,this._activeFilter),this._currentFilterSpecification||(this._currentFilterSpecification=JSON.stringify(o.getFilterSpecification(o._rootID,o._keepAttributeChildren))),this._unsavedChangesMsgDisplayed=!1,this._updateAttributeCommandsState(),p},_updateAttributeCommandsState:function(e){for(var t=this._listGroupView.length,i=0;i<t;i++){var n=this._listGroupView[i].getCriteriaViewsByType("attribute").concat(this._listGroupView[i].getCriteriaViewsByType("Sequence"));if(n.length){var s=1===n.length&&n[0].isViewEdited()?0:1;this._onAttributeCommandsState({enable:s});break}}},_cancelSearch:function(e){},_initFiltersToKeep:function(e,t){var s=this;return new n(function(n,o){var r={},a=[],l=function(e){e.forEach(function(e){(e=f._getFilterSpecification(e)?i.clone(f._getFilterSpecification(e).data):e).filterName=e&&e.filterName?e.filterName:s._defaultFilterName;var t=e.filterName;r[t]||(r[t]={}),r[t].rootPhysicalId=e.rootPhysicalId||e.rootID,r[t].filterUIComponents=e.filterUIComponents||e.filterMdl,r[t].filterDescription=e.filterDescription,r[t].filterTitle=e.filterTitle?e.filterTitle:s._defaultFilterName,r[t].filterPhysicalId=e.filterPhysicalId||e.filterId,r[t].pathDB={added:{physical:e.addedNodesList_PhysicalID?JSON.parse(e.addedNodesList_PhysicalID):[],logical:e.addedNodesList_LogicalID?JSON.parse(e.addedNodesList_LogicalID):[]},excluded:{physical:e.excludedNodesList_PhysicalID?JSON.parse(e.excludedNodesList_PhysicalID):[],logical:e.excludedNodesList_LogicalID?JSON.parse(e.excludedNodesList_LogicalID):[]},proximity:{physical:e.proximityNodesList_PhysicalID?JSON.parse(e.proximityNodesList_PhysicalID):[],logical:e.proximityNodesList_LogicalID?JSON.parse(e.proximityNodesList_LogicalID):[]}},a.push(t),0===g.getCVQueryBuildMode()&&U.buildCVQueryFromModel(e),r[t].filterCVQuery=e.filterCVQuery})},d=function(e,t){return new Promise(function(i){t?s._getConfigPCIds(e,t).then(t=>{s._prdCfgIds=t,s._checkAndRepairFilterIfNeeded(e).then(function(){i()})}):i()})};Array.isArray(e)&&"object"==typeof e[0]?(l(e),d(r[a[0]],t).then(()=>{n({filters:r,names:a})})):g.getPlatformServices(f.getTenant()).then(function(){E.mask(s.container),f.getAllDataFromFilterIds("object"==typeof e?e.filterId:e,f.getTenant()).then(function(e){e&&e.success?(l(e.success),d(r[a[0]],t).then(()=>{n({filters:r,names:a})})):(E.unmask(s.container),o({filters:r,names:a,failure:e?e.failure:[]}))})})})},_buildFromSelectedFilterId:function(e,t,i){var n,s,o=this,a=i&&!i.resetFilter?0:1;a&&this._resetFilter({initFilterUI:1});for(var l=0;l<e.length;l++)for(var c=0;c<e[l].length;c++){let i=e[l][c];if(t===i.filterId){n=i.filterId,s=i.name,i.filterTitle;break}}if(void 0===n){var u=t;f.getFilterDataFromFilterId(u,f.getTenant(),this._defaultSC).then(function(e){if(e.success){n=u,s=e.success[0].filterName,e.success[0].filterTitle;var t=e.success[0].rootPhysicalId;o._rootID!==t?d.displayNotification({level:"error",message:r.get("RecentFilterKO")}):o._buildFromSelectedFilterData(n,s,i,a)}else d.displayNotification({level:"warning",message:r.get("invalidFilterId")})},function(e){})}else o._buildFromSelectedFilterData(n,s,i,a)},_buildFromSelectedFilterData:function(e,t,n,s){var o=this;this._keepFilters={},this._keepFilterNames=[],this._initFiltersToKeep(e,this.retrieveFilter).then(function(a){o._keepFilters=a.filters,o._keepFilterNames=a.names,t!==a.names[0]&&(o._keepFilters[t]=a.filters[a.names[0]],o._keepFilterNames=[t]);var l=o._keepFilters[t];o._filterDescription=l.filterDescription;var c=function(a){d.checkAndGetListOfAttributesFromSelectedFilter(a).then(function(l){var c;0===g.getCVQueryBuildMode()&&(c=d.upgradeAndCompleteQuery(JSON.parse(a.filterCVQuery))),c=JSON.parse(a.filterCVQuery),a.filterCVQuery=c;var u=o._listGroupView.length,h=a.filterUIComponents.length-1,p=a.filterUIComponents;p&&1>=p&&!p[1].filterSpecificationName&&h--;var _=u+h-(n?0:1);if(d.MAX_FILTER_SPECIFICATION>=_){var m=p[0].toFeedUI.rootIds||[];if(m.length&&o._linkedRoots){var f=[];o._linkedRoots.forEach(e=>{-1===m.findIndex(t=>e.id===t)&&f.push(e.alias)}),f.length&&d.displayNotification({level:"warning",message:r.get("RestoreFilterWithAnotherLinkedRoot")+f.toString()})}a.filterTitle=n&&n.addExisting?o._getFilterTitle():a.filterTitle;let c=n?{...n}:{};c=i.merge(c,{resetFilter:s,filterTitle:a.filterTitle,nbSpecGlobal:_}),s?-1===o._synthesisState?(o._buildFromSelectedFilter(e,t,l,o._synthesisInfos,c),o._removeSynthesisAlert()):d.getExpandSynthesisInfos(o._getExpandContext(),o._appQueryParam).then(function(i){o._synthesisInfos=i,o._buildFromSelectedFilter(e,t,l,o._synthesisInfos,c),o._removeSynthesisAlert()},function(i){o._buildFromSelectedFilter(e,t,l,o._synthesisInfos,c),o._displaySynthesisAlert()}):o._buildFromSelectedFilter(e,t,l,o._synthesisInfos,c)}else{if(E.unmask(o.container),!s){var v=n.editedModel;v&&v.set("state","edit")}var b=UWA.String.format(r.get("maxFilterSpecOnRetrieveFilter"),d.MAX_FILTER_SPECIFICATION);d.displayNotification({level:"warning",message:b})}})};-1===o._synthesisState?o._computeSynthesisFromModel(l).then(e=>{o._synthesisInfos=e,d.computeAttributesFromSynthesis(o._synthesisInfos).then(function(e){o._attrFromSynthesis=e,c(l)},function(e){o._attrFromSynthesis=e,c(l)})}):c(l)},function(e){o._filterState="New",o._displayNotifOnActionFilterFailed("FilterCanNotBeRestored",e)})},_displayNotifOnActionFilterFailed:function(e,t){var n=[];t&&t.failure&&t.failure.forEach(e=>{e.filterTitle&&n.push(e.filterTitle)}),d.displayNotification({level:"error",message:i.String.format(r.get(e),n.toString())})},_displayMaxFilterSpecDefinedNotif:function(){var e=UWA.String.format(r.get("maxFilterSpecDefined"),d.MAX_FILTER_SPECIFICATION);d.displayNotification({level:"info",message:e})},_buildFromSelectedFilter:function(e,t,i,n,s){let o=s.resetFilter,r=s.nbSpecGlobal,a=s.filterTitle;o||(this._addGroupView(),this._updateCombinationCombo()),this.groupView.setSynthesisInfos({synthesis:n,state:this._synthesisState});var l=this._activeFilter;this._activeFilter=o?e:this._activeFilter,this._buildFilterUIFromSelectedFilter(t,i,d.getTypesOfSynthesis(n),s),o?(this._activeFilter=e,this._updateFilterTitle(a)):this._activeFilter=l,d.MAX_FILTER_SPECIFICATION===r&&this._displayMaxFilterSpecDefinedNotif()},in_apps_search:function(e){var t=this;this._internals={registrationOpts:function(){return{title:r.get("SearchFilters"),mode:"furtive",default_with_precond:!0,show_precond:!1,widget_id:t._widgetId,app_socket_id:"NGFilter_"+t._widgetId,idcard_activated:!1,tenant:f.getTenant(),multiSel:!!f.isDebugActive("extendedCmds")&&(e.multiSel||!0),recent_search:{types:["ENOStrRefinementSpecification"]},UXOptions:{dnD:!1,localActions:!1,searchRecentContent:!0,globalToolbarActions:{saveAsFavorite:!1,export:!1,print:!1}}}}};var n=i.extend(this._internals.registrationOpts(),e),o=new s.Socket(n.app_socket_id,{dispacthRetryInterval:0});!0===e.debug_mode&&o.setDebugMode(!0),e.parent_window?o.subscribeServer("SearchComServer",window):o.subscribeServer("SearchComServer"),o.dispatchEvent("RegisterContext",n),e.context_name&&(n.context_title=e.context_name),n.default_search_criteria=e.fts_value,o.dispatchEvent("InContextSearch",n),o.addListener("Selected_Objects_search",function(i){if(i.length>1)if(f.isDebugActive("extendedCmds")&&e.multiSel){if("function"==typeof e.callback){var n=[];i.forEach(e=>{n.push(e.resourceid_value)}),e.callback.call(t,n)}}else console.log("No MultiSel allowed");else"function"==typeof e.callback&&e.callback.call(t,i[0].resourceid_value);o.removeListener("onCloseTransient"),o.disconnect()}),o.addListener("onCloseTransient",function(t){"function"==typeof e.cancel&&e.cancel(null),o.dispatchEvent("UnregisterContext",n.widget_id),o.removeListener("onCloseTransient"),o.disconnect()})},_onEditGroup:function(e){if(this.groupView.cid!==e.groupId)for(var t=this._listGroupView.length,i=0;i<t;i++)if(this._listGroupView[i].cid===e.groupId){this.groupView.model.set("state","read"),this.groupView=this._listGroupView[i];break}},_isFilterValid:function(){for(var e=!0,t=this._listGroupView?this._listGroupView.length:0,i=0;i<t&&e;i++){var n=this._listGroupView[i];null!==n&&n.isViewEdited()&&"function"==typeof n.areCriteriaValid&&(e=n.areCriteriaValid())}return e},validateEditedCriterion:function(e){if(0===d.isAsynchronousValidation())return this.validateEditedCriterionSync(this,e);var t=this._listGroupView.length,i=!t;if(t){i=!0;for(var s=[],o=0;o<t&&i;o++){var r=this._listGroupView[o];r&&r.isViewEdited()&&s.push(r.areCriteriaValidate(e))}return n.all(s).then(function(t){i=!0;for(var n=t.length,s=0;s<n&&i;s++)i=t[s];return i&&e&&"function"==typeof e.callback&&e.callback(e),i})}return new n(function(e){e(i)})},_onAddNewFilterSpecification:function(e){var t=this;0===d.isAsynchronousValidation()?t._onAddNewFilterSpecificationSync(t):this.validateEditedCriterion().then(function(n){if(n){if(t.groupView.model.set("state","read"),t._addGroupView(e),e){var s=t.collection.keepComponentsToFeedUI(t._rootID,t._keepAttributeChildren,void 0,{keepEmpty:!0}),o=t._listGroupViewId.indexOf(e.specId),r=[];r.push(i.clone(s[0])),r.push(i.clone(s[o+1])),d.checkAndGetListOfAttributesFromSelectedFilter({filterUIComponents:r}).then(function(i){var n=d.getTypesOfSynthesis(t._synthesisInfos);i[d.FILTER_ANY_OBJECT]=t._attrFromSynthesis,t.groupView.filterViewFromModel(e.rootSpec,r[1],i,n),t.groupView.updateDuplicatedView(e),!1===t._checkDisplayKeepChildren()?t._updateKeepAttributeChildrenUI():t._updateKeepAttributeChildrenUI(t._keepAttributeChildren)})}t._updateAddSpecificationButton(t._combinationCombo.value),t._updateCombinationCombo(),d.MAX_FILTER_SPECIFICATION===t._listGroupView.length&&(t._updateAddSpecificationButton(),t._displayMaxFilterSpecDefinedNotif())}})},_onAddExistingFilterSpecificationWUX:function(e){var t=e.context.relatedTo,i=-1;d.FILTER_RELATED_TO_ROOT===t?i=1:d.FILTER_RELATED_TO_ALL_REVISIONS===t?i=2:d.FILTER_RELATED_TO_ANY_ROOT===t&&(i=3),f.setUsageTracker(this._widgetId,"NGF-Multi-Specification",{label:"existing",value:i}),d.setReferenceTime(Date.now()),this._isFilterInContext=1,this._onAddExistingFilterSpecification(t)},_onAddExistingFilterSpecification:function(e){var t=this;if(0===d.isAsynchronousValidation())t._onAddExistingFilterSpecificationSync(t);else{var i=t._listGroupView.find(function(e){return"edit"===e.model.get("state")}),n=i?i.model:void 0;n&&this.validateEditedCriterion().then(function(i){if(i){var s={resetFilter:!1,editedModel:n,addExisting:1};t.retrieveFiltersRelatedTo({type:e,rootIDs:[t._rootID]},s)}})}},_createCombination:function(){var e=i.createElement("div",{class:"filter-groups-Combination"});return e.inject(this.getElement("#filter-groups"),"before"),this._followingLabel=this._createCombinationLabel(),this._combinationCombo=this._createCombinationSpecificationUI(),this._combinationCombo.inject(e),this._followingLabel.inject(e),e},_createCombinationLabel:function(){return i.createElement("label",{class:"innerfiltertypecombo",text:r.get("FollowingCombination"),id:"global-combination-specification-label"})},_createCombinationSpecificationUI:function(){var e=this;let t=[{labelItem:r.get("AllCombination"),valueItem:"intersection"},{labelItem:r.get("AnyCombination"),valueItem:"union"},{labelItem:r.get("MinusCombination"),valueItem:"minus-0"},{labelItem:r.get("MinusCombination"),valueItem:"minus-1"}],i=new V({shouldBeSelected:function(e){return e.options.grid.selectable}});t.forEach((e,t)=>{var n=new T({label:e.labelItem,grid:{valueItem:e.valueItem,selectable:!0},disabled:!1});i.addChild(n)});let n=new S({touchMode:d.TOUCH_MODE,elementsTree:i,selectedIndex:1,enableSearchFlag:!1,domId:"combination-specification"});return n.addEventListener("change",function(t){let i=t.dsModel.currentValue;if(-1===i.indexOf("minus"))e.model.set("combinationOfSpecification",i),e.model.unset("minusIndex"),e._followingLabel.show();else{let t=i.split("-");e.model.set("combinationOfSpecification",t[0]),e.model.set("minusIndex",t[1]),e._followingLabel.hide()}e._updateAddSpecificationButton(i)}),n},_createNewSpecificationBtn:function(e){var t=new I({domId:"addNewSpec",touchMode:d.TOUCH_MODE,displayStyle:"normal",label:r.get("addNewSpecification"),icon:"plus"});t.inject(e),t.tooltipInfos=new x({shortHelp:r.get("addNewSpecificationTooltip"),mouseRelativePosition:!0});var i=this;return t.addEventListener("buttonclick",function(e){f.setUsageTracker(i._widgetId,"NGF-Multi-Specification","new"),d.setReferenceTime(Date.now()),i._onAddNewFilterSpecification()}),t},_createExistingSpecificationBtnWUX:function(e){var t=new I({domId:"addExistingSpec",touchMode:d.TOUCH_MODE,displayStyle:"normal",label:r.get("addExistingSpecification"),icon:"plus"});t.inject(e),t.tooltipInfos=new x({shortHelp:r.get("addExistingSpecificationTooltip"),mouseRelativePosition:!0}),this._ExistingContextualMenu=[{type:"PushItem",title:i.String.format(r.get("SearchOnRoot"),this._rootAlias),tooltip:i.String.format(r.get("SearchOnRootTooltip"),this._rootAlias),icon:w.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterOpenFilter.png"),action:{this:this,callback:this._onAddExistingFilterSpecificationWUX,context:{relatedTo:d.FILTER_RELATED_TO_ROOT}}},{type:"PushItem",title:i.String.format(r.get("SearchOnAllRevisions"),this._rootAlias),tooltip:i.String.format(r.get("SearchOnAllRevisionsTooltip"),this._rootAlias),icon:w.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png"),state:"3DSpace"===this._pfServiceId?"enabled":"disabled",action:{this:this,callback:this._onAddExistingFilterSpecificationWUX,context:{relatedTo:d.FILTER_RELATED_TO_ALL_REVISIONS}}},{type:"PushItem",title:r.get("CopyFromAnyFilters"),tooltip:r.get("SearchAnyTooltip"),icon:w.getWebappsAssetUrl("ENONextGenFilterUX","icons/32/filterCopyFilter.png"),action:{this:this,callback:this._onAddExistingFilterSpecificationWUX,context:{relatedTo:d.FILTER_RELATED_TO_ANY_ROOT}}}];var n=this;return t.addEventListener("buttonclick",function(e){e.stopPropagation();var t=e.target.getBoundingClientRect();R.show(n._ExistingContextualMenu,{position:d.getMenuPosition(t)})}),t},_updateCombinationCombo:function(){if(this._combinationCombo){let t=this._combinationCombo.elementsTree.getRoots(),i=this.collection.getActiveGroupCollection();if(2===i.length){var e=r.get("MinusCombination")+" ";t[2].setLabel(e+i[0].getFilterSpecificationLabel()),t[3].setLabel(e+i[1].getFilterSpecificationLabel()),t[2].show(),t[3].show()}else t[2].hide(),t[3].hide();this._combinationCombo.show()}},_onAttributeCommandsState:function(e){var t=!e||!e.enable;this._refineBtn.disabled=t,this._hideAttrChildren.disabled=t,this._showAttrChildren.disabled=t},_updateAddSpecificationButton:function(e){this._addNewSpecBtn&&this._addExistingSpecBtn&&(this._isThereCriteriaDefined()?this._divSpecificationCmd.show():this._divSpecificationCmd.hide(),2===this._listGroupView.length?e&&-1!==e.indexOf("minus")?(this._addNewSpecBtn.disabled=!0,this._addExistingSpecBtn.disabled=!0):(this._addNewSpecBtn.disabled=!1,this._addExistingSpecBtn.disabled=!1):d.MAX_FILTER_SPECIFICATION===this._listGroupView.length?(this._addNewSpecBtn.disabled=!0,this._addExistingSpecBtn.disabled=!0,this._duplicateSpecDisabled||(this._listGroupView.forEach(e=>{e.setEnableDuplication(!1)}),this._duplicateSpecDisabled=1)):(this._addNewSpecBtn.disabled=!1,this._addExistingSpecBtn.disabled=!1,this._duplicateSpecDisabled&&(this._duplicateSpecDisabled=0,this._listGroupView.forEach(e=>{e.setEnableDuplication(!0)}))))},setTagsDataOnNGF:function(e){if(e&&this._listGroupView){P&&this._hasAppliedNGF||("createFromTag"===e.dropOption?this._tagsOnly=!0:"drop"===e.dropOption?this._tagsOnly=!1:"dropOnFilter"!==e.dropOption?this._tagsOnly=!0:console.log("FilterViewManager.get3DXView, unknown case of dropOption"+options.dropOption)),this._tagsInMdl=i.clone(e.tagData);for(var t=0;t<this._listGroupView.length;t++)this._listGroupView[t].createTagNGF(e.tagData);if("createFromTag"===e.dropOption)if(this._hasAppliedNGF||this._hasTag()){var n=this;if(0===g.getCVQueryBuildMode()){var s=this._buildCVQuerySync();this._applyFilter({CVQuery:s,isEmpty:!1})}else this.buildCVQuery().then(function(e){n._applyFilter({CVQuery:e,isEmpty:!1,tagsInMdl:n._tagsInMdl})})}else this._applyFilter({CVQuery:f.buildEmptyFilter(this._rootID),isEmpty:!0,tagsInMdl:this._tagsInMdl})}else console.log("RCIII GlobalFilterView : should have group view in existing GlobalFilterView")},updateDataOnNGF:function(e){var t={};t.rootID=e.rootID,t.rootAlias=e.rootAlias,this._onSelectObject(t)},_onSpecificationStateChange:function(){!1===this._checkDisplayKeepChildren()?this._updateKeepAttributeChildrenUI():this._updateKeepAttributeChildrenUI(this._keepAttributeChildren);let e=this.collection.getActiveGroupCollection();this._updateCombinationCombo(),this._divCombination&&2>e.length?this._divCombination.hide():this._divCombination.show(),this._checkActiveCriteria()},_checkActiveCriteria:function(){let e=!1,t=this._listGroupView.length;for(let i=0;i<t;i++){let t=this._listGroupView[i];if(d.isModelActivated(t.model)&&t.isThereActiveCriteria()){e=!0;break}}this._setApplySelectable(!!e)},_setGlobalButtonsStatus:function(e){switch(this._filterState=e,this.groupView&&this.groupView.setFilterState(e),this._renameFilterBtn.disabled=!!this._isFilterFromModel,e){case"New":this._setApplySelectable(!1),this._setSaveSelectable(!1),this._setSaveAsSelectable(!1);break;case"ValidOK":this._setApplySelectable(!0),this._setSaveSelectable(!0),this._setSaveAsSelectable(!1);break;case"SaveAsOK":this._setApplySelectable(!0),this._setSaveSelectable(!1),this._setSaveAsSelectable(!0);break;case"SaveOK":this._setApplySelectable(!0),this._setSaveSelectable(!0),this._setSaveAsSelectable(!0)}},_setApplySelectable:function(e){this._applyFilterButton.disabled=0==e},_setSaveSelectable:function(e){this._saveFilterButton.disabled=0==e},_setSaveAsSelectable:function(e){this._saveAsFilterButton.disabled=0==e},_updateApplySaveSaveAsState:function(e){if("SaveOK"!==this._filterState){let t=e.status||this._filterState;t="ValidOK"===t&&"SaveAsOK"===this._filterState?"SaveOK":t,this._filterState=t,this._setGlobalButtonsStatus(this._filterState),this.groupView&&this.groupView.setFilterState(this._filterState)}},_getExpandContext:function(){return{rootID:this._rootID,securityContext:this._defaultSC,tenant:f.getTenant(),widgetId:this._widgetId,pfServiceId:this._pfServiceId,rootTitle:d.getRootTitle(this._rootAlias,this._rootRevision)}},_setDisplayDensityCmd:function(e){f.setUsageTracker(this._widgetId,"NGF-Commands",{label:"density",value:1});var t=e.context.density;this._setDensity(t),this._densityBtn.icon=d.getIconByName(1===this._displayDensity?"view-big-tile":"view-small-tile")},_setDensity:function(e){if(this._displayDensity!==e&&this._isFilterValid()&&(f.setUsageTracker(this._widgetId,"NGF-Density",1===e?"comfortable":"compact"),this._displayDensity=e,localStorage.setItem("NGF_DisplayDensity",e),1===e?this.getContent().removeClassName("compact"):this.getContent().addClassName("compact"),d.updateTouchMode(!!e),this.collection)){var t,i=this._listGroupView.findIndex(e=>!!(t=e.getEditedCriterion()));let e=this._applyFilterButton.disabled,a=this._saveFilterButton.disabled,l=this._saveAsFilterButton.disabled;var n=this.getFilterSpecification(this._rootID,this._keepAttributeChildren,void 0,{keepEmpty:!0}),s={filterUIComponents:n},o=this._divSpecificationCmd;this._addNewSpecBtn.destroy(),this._addExistingSpecBtn.destroy(),this._addNewSpecBtn=this._createNewSpecificationBtn(o),this._addExistingSpecBtn=this._createExistingSpecificationBtnWUX(o),this._applyFilterButton.destroy(),this._saveFilterButton.destroy(),this._saveAsFilterButton.destroy(),this._createGlobalBtn();var r=this;d.checkAndGetListOfAttributesFromSelectedFilter(s).then(function(s){var o=d.getTypesOfSynthesis(r._synthesisInfos);s[d.FILTER_ANY_OBJECT]=r._attrFromSynthesis,r._emptyFilter(),n.shift();var c=n[0].toFeedUI.rootIds||[r._rootID];n.forEach((e,t)=>{r._initFilterGroup(),r.groupView.filterViewFromModel(c[t],e,s,o)}),-1!==i&&r._listGroupView[i].setCrtierionAsEdited(t),r._applyFilterButton.disabled=e,r._saveFilterButton.disabled=a,r._saveAsFilterButton.disabled=l})}},_getConfigPCIds:function(e,t){var i=this;return new Promise(function(n){if(t){let t=[],s=e.filterUIComponents,o=s.length;for(let e=1;e<o;e++){(s[e].toFeedUI||[]).forEach(e=>{if("config"===e.criteriaType){let i=e.config_filter_id;i&&t.push(i.physical_id)}})}t.length?d.executeFetch(t,[],[],i._defaultServiceId).then(function(e){t=[],e&&e.infos.nresults&&(e.results.forEach(e=>{let i=e.attributes.find(e=>"resourceid"===e.name);i&&t.push(i.value)}),t=[...new Set(t)]),n(t)}):n(void 0)}else n(void 0)})},_checkAndRepairFilterIfNeeded:function(e){var t=this;return t._isFilterBroken=!1,new n(function(i){var n;if(e)n={filterUIComponents:e.filterUIComponents,pathDB:e.pathDB};else if(t._keepFilterNames&&t._keepFilterNames.length){var s=t._keepFilterNames[0];n={filterUIComponents:t._keepFilters[s].filterUIComponents,pathDB:t._keepFilters[s].pathDB}}else n={filterUIComponents:t.options.filterUIComponents};t._filterRepairView.checkForBrokenPathsInFilter(n).then(function(e){if(Array.isArray(e.pathsToFeedUI))if("3DSpace"!==t._pfServiceId){var s=r.get("RepairFilterNotAvailableOutOf3DSpace");console.log("==> _checkAndRepairFilterIfNeeded() /  "+s),i()}else e.indexOfGroupViewToRepair.forEach(t=>{(n.filterUIComponents[t+1].toFeedUI||[]).forEach(i=>{var n=i.criteriaType;"context"===n?i=e.pathsToFeedUI[t]:"volume"===n&&(i=e.pathsToFeedUI[t])})}),t._isFilterBroken=!0,t._filterRepairView.logBrokenFiltersInfo(e.pathsToFeedUI),i(n);else"PathsOK"!==e&&"NoContextFilter"!==e||i()})})},_updateModelFromRepairPanel:function(e){for(var t=this,i=!1,n=0;n<this._listGroupView.length;n++){this._listGroupView[n].updateModelsFromRepair(e).forEach(e=>{e.modelUpdated&&(i=i||e.modelUpdated,t._listGroupView[n].buildViewsFromRepairModel(e.attributes))})}i&&t._setGlobalButtonsStatus("SaveOK")},_getBuildCVQueryOptions:function(){return{queryFormat:this._queryFormat,excludeRoot:f.isRootExcludedFromSynthesis()?1:0,partialPath:this._expandIntent}},buildCVQuery:function(){var e=this;return new n(function(t,i){var n=e._getBuildCVQueryOptions();e.collection.buildCVQuery(e._defaultSC,e._rootID,e._keepAttributeChildren.toString(),e._tagsOnly,n).then(function(e){t(e)},function(e){})})},buildCVQueryFromFilterSpec:function(e){var t=this;return new n(function(i,n){var s=t._getBuildCVQueryOptions();t.collection.buildCVQueryFromFilterSpec(t._defaultSC,t._rootID,t._keepAttributeChildren.toString(),e,s).then(function(e){i(e)},function(e){})})},_buildCVQuerySync:function(e){return this.collection._buildCVQuerySync(this._rootID,this._keepAttributeChildren.toString(),e)},_addMenuClass:function(e){if(e){var t=window.document.body;t.addClassName(e);var i=t.querySelector(".column.left");i&&i.addClassName(e)}},_removeMenuClass:function(e){if(e){var t=window.document.body;t.removeClassName(e);var i=t.querySelector(".column.left");i&&i.removeClassName(e)}},addNewCriterion:function(e){!this._cmdsContainer.visibleFlag&&this._cmdsContainer.show(),this.groupView._addNewCriterion(e)},retrieveFiltersRelatedTo:function(e,t){this.retrieveFilter=!0,this.droppedFilter=!1;var i=e.type;if("3DSpace"!==this._pfServiceId&&(d.FILTER_RELATED_TO_ROOT===i||d.FILTER_RELATED_TO_ANY_ROOT===i)){var n=r.get("only3DSpaceResults");console.log("==> retrieveFiltersRelatedTo() /  "+n)}var s=this;g.getPlatformServices(f.getTenant()).then(function(){d.FILTER_RELATED_TO_ROOT===i?s._retrieveFiltersRelatedToRoots(e.rootIDs,t):d.FILTER_RELATED_TO_ALL_REVISIONS===i?(s._isFilterInContext=1,s._retrieveFiltersRelatedToAllRevisions(e.rootIDs,t)):d.FILTER_RELATED_TO_ANY_ROOT===i&&(s._isFilterInContext=1,s._retrieveFiltersRelatedToQuery(e.query,t))})},_retrieveFiltersRelatedToRoots:function(e,t){var i=this,n=Date.now(),s=e||[this._rootID];c.retrieveAllFilters(s).then(function(e){if(f.setPerformanceTracker(i._widgetId,"NGF-Search_Filters","NGFilter_UX",{Retrieve_Filters_duration:Date.now()-n,Retrieved_Filters:e.length},1),e.length>=0){var s=[];e.forEach(function(e){s.push(e.filterId)});var o="(physicalid:"+(s.length?s.join(" OR physicalid:"):"null")+")";i.in_apps_search({precond:o,title:r.get("SearchFilters"),callback:function(n){i.groupView.model.set("state","read"),i._dropOption="dropOnFilter",d.setReferenceTime(Date.now()),i._buildFromSelectedFilterId.call(i,[e],n,t),i._onDisplayGlobalFilterView(),d.openFilterPanel("NGF_Search_"+Date.now())},cancel:function(){i._cancelSearch.call(i,i.options),d.openFilterPanel("NGF_Search_"+Date.now())}})}else d.displayNotification({level:"info",message:r.get("NoFilterFound")})})},_retrieveFiltersRelatedToAllRevisions:function(e,t){var i=this,n=Date.now(),s=e||[this._rootID];s="string"==typeof s?[s]:s;var o=[];d.executeFetch(s).then(function(e){e.results.forEach(e=>{var t=e.attributes.find(function(e){return"logicalid"===e.name});t&&-1===o.indexOf(t.value)&&o.push(t.value)}),c.retrieveAllRoots(o).then(function(e){(e=e.filter(function(e){return-1===s.indexOf(e)})).length?c.retrieveAllFilters(e).then(function(e){if(f.setPerformanceTracker(i._widgetId,"NGF-Search_Filters","NGFilter_UX",{Retrieve_Filters_duration:Date.now()-n,Retrieved_Filters:e.length},1),e.length){var s=[];e.forEach(function(e){s.push(e.filterId)});var o=s.join(" OR physicalid:");o="(physicalid:"+o+")",i._retrieveFiltersRelatedToQuery(o,t)}else d.displayNotification({level:"info",message:r.get("NoFilterFound")})}):d.displayNotification({level:"info",message:r.get("NoRevisonFound")})},function(e){console.log(" Retrieve All Roots failed, error = "+e)})},function(e){console.log("Retrieve logical IDs failed, error = "+e)})},_retrieveFiltersRelatedToQuery:function(e,t){var i=this;(t=t||{}).displayNotif=1,t.resetFilter=void 0===t.resetFilter||t.resetFilter,this.in_apps_search({precond:e||"[ds6w:type]:ENOStrRefinementSpecification",title:r.get("SearchFilters"),callback:function(e){d.setReferenceTime(Date.now()),f.getAllDataFromFilterIds(e,f.getTenant()).then(function(e){if(e&&e.success){var n=e.success[0];d.checkAndGetListOfAttributesFromSelectedFilter(n).then(function(e){i._buildFilterUIFromFilterRelatedToQuery(n,e,i._rootID,t)})}else i._displayNotifOnActionFilterFailed("FilterCanNotBeRestored",e)}),d.openFilterPanel("NGF_Search_"+Date.now())},cancel:function(){i._cancelSearch.call(i,i.options),d.openFilterPanel("NGF_Search_"+Date.now())}})},buildFilterUIFromFilterRelatedToQuery:function(e,t,i,n){this.groupView&&this.groupView.isThereCriteria()&&(this._onACCriteria(this._getFilterTitle()),this._onResetFilter());var s=this;return new Promise(function(o){s._buildFilterUIFromFilterRelatedToQuery(e,t,i,n).then(function(e){o(e)})})},_buildFilterUIFromFilterRelatedToQuery:function(e,t,n,s){var o=this;return new Promise(function(n){var a=o._listGroupView.length,l=e.filterUIComponents.length-1,c=e.filterUIComponents;c&&1>=c&&!c[1].filterSpecificationName&&l--;var u=a+l-(s?0:1),h=s&&!s.resetFilter?0:1;if(d.MAX_FILTER_SPECIFICATION>=u)0===h&&(o.groupView&&o.groupView.model.set("state","read"),o._addGroupView(),o._updateCombinationCombo()),d.checkCompatibiltyFilterRules(o._defaultSC,o._rootID,e,s?s.displayNotif:1,o._pfServiceId).then(function(e){o._dropOption="dropOnFilter";var r=function(e,r){let a=o._isFilterInContext;var l=d.getTypesOfSynthesis(r||o._synthesisInfos);o._buildFilterViewFromFilterModel(e.filterSpec,t,l,s),a&&o._updateApplySaveSaveAsState({status:"ValidOK"}),o._onDisplayGlobalFilterView(),d.MAX_FILTER_SPECIFICATION===u&&o._displayMaxFilterSpecDefinedNotif(),n(i.merge({rootID:o._rootID,rootAlias:o._rootAlias},e.result))};-1===o._synthesisState?o._computeSynthesisFromModel(e.filterSpec).then(i=>{d.computeAttributesFromSynthesis(i).then(function(n){o._attrFromSynthesis=n,t[d.FILTER_ANY_OBJECT]=o._attrFromSynthesis,r(e,i)})}):d.getExpandSynthesisInfos(o._getExpandContext(),o._appQueryParam).then(function(t){r(e,t)})},function(){o._goToHomePage()});else{if(E.unmask(o.container),0===h){var p=s.editedModel;p&&p.set("state","edit")}var _=UWA.String.format(r.get("maxFilterSpecOnRetrieveFilter"),d.MAX_FILTER_SPECIFICATION);d.displayNotification({level:"warning",message:_})}})},_goToHomePage:function(e){e?this._onACCriteria(e):this._onACTrash(),this._onResetFilter(),this._onAttributeCommandsState({enable:0}),this._cmdsContainer.hide(),this.dispatchEvent("NGF_GoToWelcomePage")},_onDisplayGlobalFilterView:function(e){!this._cmdsContainer.visibleFlag&&this._cmdsContainer.show(),this.dispatchEvent("NGF_DisplayGlobalFilterView")},_applyDroppedFilters:function(e,t,n){var s=this,o={success:[],failure:[]};if(e.failure&&o.failure.push(e.failure[0]),e.success){var r=e.success[0];n.appId=s._appId,n.widget=s._widgetId,n.filterRootIds=[r.rootPhysicalId||r.rootID],sessionStorage.setItem("NGF_isUXBuilt_"+s._UXId,!0),this._removeUselessQueries(n);var a=function(e){s.dispatchConfigRevision(!1),b.publish("NGFilter.ApplyDroppedFilters/"+s._UXId,e)};if(this._isFilterBroken)if(0===g.getCVQueryBuildMode()){var l=s._updateDataForAppCB(e);a(l)}else s._updateDataForAppCBAsync(e).then(function(e){a(e)});else{var d=f._getFilterSpecification(r)?i.clone(f._getFilterSpecification(r).data):void 0;o.success.push({rootId:r.rootPhysicalId||r.rootID,rootAlias:r.rootAlias,filterId:t,filterTitle:d?d.filterTitle:void 0,filterMdl:d?d.filterMdl:void 0,filter:n,fromDropOnFilter:"dropOnFilter"===(d?d.dropOption:void 0),tagsInMdl:"dropOnFilter"===(d?d.dropOption:void 0)?void 0:n.tagsInMdl}),a(o)}}},_updateDataForAppCB:function(e){var t={success:[],failure:[]};if(e&&e.success)for(var i=0;i<e.success.length;i++){var n=e.success[i],s=U.buildCVQueryFromModel(n),o=d.upgradeAndCompleteQuery(JSON.parse(s));o.appId=this._appId,o.widget=this._widgetId,o.filterRootIds=[n.rootPhysicalId];var r={rootId:n.rootPhysicalId,filterId:n.filterId,filterName:n.filterName,filter:o,fromDropOnFilter:this.options.fromDropOnFilter};t.success.push(r)}return t},_updateDataForAppCBAsync:function(e){var t=this,i={};if(e&&e.success){i.success=[],i.failure=[];for(var s=[],o=function(e){return new n(function(i,n){var s=t.getFilterSpecification(t._rootID,t._keepAttributeChildren,t._tagsOnly);t.buildCVQueryFromFilterSpec(s).then(function(n){var s=n;s.appId=t._appId,s.widget=t._widgetId,s.filterRootIds=[e.rootPhysicalId||e.rootID],t._removeUselessQueries(s);var o={rootId:e.rootPhysicalId||e.rootID,rootAlias:e.rootAlias,filterId:e.filterId,filterTitle:e.filterTitle,filterName:e.filterName,filterMdl:e.filterMdl,filter:s,fromDropOnFilter:"dropOnFilter"===t.options.dropOption};o.fromDropOnFilter=!1===o.fromDropOnFilter||o.fromDropOnFilter,d.displayNotification({level:"info",message:r.get("filterWithNonAppliedTag")}),i(o)})})},a=0;a<e.success.length;a++){var l=e.success[a];s.push(o(l))}return n.all(s).then(function(e){return e.forEach(function(e){i.success.push(e)}),i})}},updateView:function(e){this._appQueryParam=e.appQueryParam||{};var t=f._getFilterSpecification(e),n=e.dropOption||(t?t.data.dropOption:void 0);if("drop"!==n&&"dropOnFilter"!==n)this._onRedraw({filterId:e.UXId}),t&&t.type&&t.data&&(this._feedViewWithFilter(e.filterToApply),this.options.filterToApply=i.clone(e.filterToApply),e.filterToApply=void 0);else{var s=e.filterId||(t?t.data.filterId:void 0),o=e.filterTitle||(t?t.data.filterTitle:void 0),r={success:[{rootId:e.rootID,filter:"tbd",filterId:Array.isArray(s)?s:[s],filterTitle:o||void 0,fromDropOnFilter:"dropOnFilter"===n}],failure:[]};b.publish("NGFilter.ApplyDroppedFilters/"+e.UXId,r)}},_computeSynthesisFromModel:function(e){for(var t={"ds6w:type":[],"ds6w:kind":[]},i=f.getFilterUIComponents(e),s=i.length,o=function(e){void 0!==e&&e.forEach(e=>{e.criteriaType&&e.type&&-1===t["ds6w:type"].indexOf(e.type)&&t["ds6w:type"].push(e.type);var i=e.allAttributes;if(void 0===i){var n=e.uri;if(t[n]||(t[n]=[]),e.attrValue){var s=Array.isArray(e.attrValue)?e.attrValue.flat():[e.attrValue];t[n]=t[n].concat(s)}}else o(i)})},a=1;a<s;a++){i[a].toFeedUI.forEach(e=>{if(null!==e){var i=e.criteriaType;if("attribute"===i){var n=e.type;n&&(-1===t["ds6w:type"].indexOf(n)&&t["ds6w:type"].push(n),e.extension&&e.extension.length&&-1===t["ds6w:kind"].indexOf(e.extension)&&t["ds6w:kind"].push(e.extension)),o(e.allAttributes)}else"Sequence"===i&&"attribute"===e.sequenceType&&o(e.allAttributes)}})}return new n((e,i)=>{g.getNlsOfPropertiesValues(t).then(function(i){var n,s=[],o=d.FILTER_ANY_OBJECT;for(var a in t)if(t.hasOwnProperty(a)){var l=[];if(i[a])t[a].forEach(e=>{let t=i[a][e]?o===e?r.get(o):i[a][e]:e;t="true"===t||"false"===t?r.get(t):t,l.push({nlsvalue:t,value:e,isAggregate:0})});else{let e=t[a];e&&e.length?e.forEach(e=>{let t=e;t="true"===t||"false"===t?r.get(t):t,l.push({nlsvalue:t,value:e,isAggregate:0})}):l.push({nlsvalue:a,value:d.ATTRIBUTE_NOT_VALUATED,isAggregate:0})}s.push({property:a,values:l})}n=[],s.forEach(e=>{if(e.values){var t={};e.values.forEach(e=>{var i=e.nlsvalue;t[i]?t[i].values.push(e.value):(t[i]={},t[i].values=[e.value])}),e.values.length&&(e.values=[],Object.keys(t).forEach(function(i){var n=t[i].values.length,s=1===n?0:1,o={nlsvalue:i,value:1===n?t[i].values[0]:t[i].values,isAggregate:s};e.values.push(o)}),n.push(e))}}),e(s=n)})})},getFilterSpecification:function(e,t,i,n){var s=e||this._rootID,o=t||this._keepAttributeChildren;return this.collection.keepComponentsToFeedUI(s,o,i,n)},updateOnLinkUnlinkWith:function(e,t){if(this._queryFormat=this._getQueryFormat(t.NGFUXId),this._expandIntent=this._getExpandIntent(t.NGFUXId),this._listGroupView.forEach(e=>{e.updateCriteriaAvailibility(t)}),"NGFilter_Link"===e){if(t.applyFilter)this.onApplyFilter({event:t.eventName,empty:t.empty,tagsOnly:this._tagsOnly});else if(t.eventName){var i={results:"OK"};b.publish(t.eventName,i)}}else if("NGFilter_Unlink"===e&&(this._tagsOnly&&(t._tagsOnly=!0),t.eventName)){i={results:"OK"};b.publish(t.eventName,i)}},_getLinkedRoots:function(){var e=this;return new n(function(t,i){if(0===f.isActivated("MultiRoot"))t();else if(v.getOption("NGF_VDRP_AllowMultirootFilter")||0){var n=[{id:e._rootID,alias:e._rootAlias}],s={relations:["positioningArch_from"],attributes_for_detailview:["physicalid"],countmanagement:!1,debug:!1,ids:[e._rootID],trueREST:!0,displayTime:!1};o.authenticatedRequest(f.getGetEcoSystemUrl(f.getTenant()),{headers:g.getRESTHeaders(),method:"POST",data:JSON.stringify(s),type:"json",proxy:"passport",onComplete:function(i){E.unmask(e.container);var s=[];i.New.Objects&&i.New.Objects.forEach(t=>{e._rootID!==t.id&&s.push({id:t.id,name:t["ds6w:identifier"],alias:t.name})}),s.length?1===s.length?(n.push({id:s[0].id,alias:s[0].alias}),t(n)):(d.displayNotification({level:"error",message:r.get("InvalidLinkedRootsCount")}),t(null)):t(null)},onFailure:function(i){console.log("==> Get Linked roots failed, err = "+i),E.unmask(e.container),t(n)}})}else e._onDebugGetLinkedRoots().then(e=>{t(e)})})},_getLinkedRootsFromModel:function(e){return new n(t=>{if(0===f.isActivated("MultiRoot"))t();else{var i=e[0].filterMdl[0].toFeedUI.rootIds||[];1<[...new Set(i)].length?d.executeFetch(i,[],["ds6w:label","ds6wg:revision"]).then(function(e){var n=d.getAliasesFromFetched(i,e),s=[];i.forEach((e,t)=>{s.push({id:e,alias:n[t]})}),t(s)},function(e){console.log(" ==> _getLinkedRootsFromModel / Retrieve root from model failed, err = "+e);var n=[];i.forEach((e,t)=>{n.push({id:e.id,alias:"Root #"+t})}),t(n)}):t()}})},_onUpdateSpecificationName:function(e){if(e.computeIndexCB&&e.name){var t=this.collection.getGroupCollectionIndex(e.name);e.computeIndexCB({index:-1!==t?t:0,name:e.name})}else this._updateCombinationCombo()},_onDebugGetLinkedRoots:function(){var e=this;return new n(function(t,i){var n=[{id:e._rootID,alias:e._rootAlias}];e.in_apps_search({refine:{"ds6w:what/ds6w:contentStructure":[{type:"string",object:"Root",disptext:"Root",field:["implicit"]}]},multiSel:!0,precond:'flattenedtaxonomies:"types/VPMReference"',title:"Select Root(s) to link to "+e._rootAlias,callback:function(i){var s=[e._rootID,i];d.executeFetch([s,i],[],["ds6w:label","ds6wg:revision"]).then(function(i){var o=d.getAliasesFromFetched(s,i);n=[],s.forEach((e,t)=>{n.push({id:e,alias:o[t]})}),e._combinationCombo.selectedIndex=1,t(n)},function(s){n.push({id:i,alias:"Root #2"}),e._combinationCombo.selectedIndex=1,t(n)})},cancel:function(){e._combinationCombo.selectedIndex=1,t()}})})},_onSaveFilterSync:function(e){var t=e;if(!(t.groupView&&"edit"===t.groupView.model.get("state")?1:0)||t.validateEditedCriterion())if(0===g.getCVQueryBuildMode()){var i=t._buildCVQuerySync(),n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);"ValidOK"===t._filterState?t._displayRenameDialogAndCreateFilter("SaveTitle",i,n):t._checkFilterNameAndUpdateFilter(t._defaultFilterName,i,n),t.groupView.switchToEdit()}else{n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);"ValidOK"===t._filterState?t._displayRenameDialogAndCreateFilter("SaveTitle","{}",n):t._checkFilterNameAndUpdateFilter(t._defaultFilterName,"{}",n),t.groupView.switchToEdit()}else t.groupView.switchToEdit()},_onSaveAsFilterSync:function(e){var t=e;if(!(t.groupView&&"edit"===t.groupView.model.get("state")?1:0)||t.validateEditedCriterion())if(0===g.getCVQueryBuildMode()){var i=t._buildCVQuerySync(),n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);t._displayRenameDialogAndCreateFilter("SaveAsTitle",i,n),t.groupView.switchToEdit()}else{n=t.getFilterSpecification(t._rootID,t._keepAttributeChildren);t._displayRenameDialogAndCreateFilter("SaveAsTitle","{}",n),t.groupView.switchToEdit()}},onApplyFilterSync:function(e){var t=e;if(!(t.groupView&&"edit"===t.groupView.model.get("state")?1:0)||t.validateEditedCriterion())if(1===this._synthesisState&&this._isFilteredSynthesis&&(t._refreshSynthesisInfos(!1,!1),t._isFilteredSynthesis=!1),P=t._UXId,t._hasAppliedNGF=!0,t._appliedFilterTitle=t._getFilterTitle(),0===g.getCVQueryBuildMode()){var i=t._buildCVQuerySync();t._applyFilter({CVQuery:i,isEmpty:!1}),t.groupView.switchToEdit(),t._updateAddSpecificationButton(),t._updateApplySaveSaveAsState({status:"ValidOK"})}else t.buildCVQuery().then(function(e){t._applyFilter({CVQuery:e,isEmpty:!1}),t.groupView.switchToEdit(),t._updateAddSpecificationButton(),t._updateApplySaveSaveAsState({status:"ValidOK"})});else t.groupView.switchToEdit()},validateEditedCriterionSync:function(e,t){var i=e,n=i._listGroupView.length,s=!n;if(n){s=!0;for(var o=0;o<n&&s;o++){var a=i._listGroupView[o];if(null!==a&&a.isViewEdited())if("function"==typeof a.areCriteriaValidate){var l=a.areCriteriaValidate(t);l?a.model.set("state","read"):s=l}else s=!1,d.displayNotification({level:"error",message:r.get("NeedToValidateCrirerion")})}s&&t&&"function"==typeof t.callback&&t.callback(t)}return s},_onAddNewFilterSpecificationSync:function(e){var t=e;t.validateEditedCriterion()&&(t._addGroupView(),t._updateCombinationCombo(),d.MAX_FILTER_SPECIFICATION===t._listGroupView.length&&(t._updateAddSpecificationButton(),t._updateApplySaveSaveAsState({status:"ValidOK"}),t._displayMaxFilterSpecDefinedNotif()))},_onAddExistingFilterSpecificationSync:function(e){for(var t=e,i=void 0,n=0;n<t._listGroupView.length;n++)if("edit"===t._listGroupView[n].model.get("state")){i=t._listGroupView[n].model;break}if(t.validateEditedCriterion()){var s={resetFilter:!1,editedModel:i};t._retrieveFilters(t._rootID,s)}},_retrieveFilters:function(e,t){this.retrieveFilter=!0,this.droppedFilter=!1,this.retrieveFiltersRelatedTo({type:d.FILTER_RELATED_TO_ROOT,rootIDs:e},t)}})}),define("DS/ENONextGenFilterUX/views/ContainerFilterView",["UWA/Class","UWA/Class/View","UWA/Core","UWA/Utils","UWA/Promise","UWA/Date","DS/WAFData/WAFData","DS/ENONextGenFilterUX/views/GlobalFilterView","DS/ENONextGenFilterUX/models/GlobalFilterModel","DS/Handlebars/Handlebars4","text!DS/ENONextGenFilterUX/templates/containerViewTemplate.html","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/ENOFilterBIUX/FBIServices","DS/ENONextGenFilterUX/views/WelcomePageFilterView","DS/Menu/Menu","DS/Controls/Button","DS/Controls/Toggle"],function(e,t,i,n,s,o,r,a,l,d,c,u,h,p,_,m,f,g,v,b,C){"use strict";var y=1;return t.extend({domEvents:{},setup:function(){h.displayInternalTimeTrace(0,"ContainerView"),this._isWebInWin=this.options.isWebInWin,this.appId=this.options.appId,this._widgetId=this.options.widgetId||this.options.widget,this._UXId=this.options.UXId,this.rootID=this.options.rootID,this.rootAlias=this.options.rootAlias||"?",this._NGFUXId=this.options.NGFUXId,this._appQueryParam=this.options.appQueryParam||{},this._template=d.compile(c),this._filterToApply=this.options.filterToApply,this._dropedFilterNames=[],this.options.filterNames&&(this._dropedFilterNames=Array.isArray(this.options.filterNames)?this.options.filterNames:[this.options.filterNames]),this._dropedFilterIds=[];var e,t,i,n=p._getFilterSpecification(this.options)?p._getFilterSpecification(this.options).data.filterId:void 0;n&&(this._dropedFilterIds=Array.isArray(n)?n:[n]),this.options.tagData&&(this._tagData=this.options.tagData),void 0===this.options.configUsed&&(this.options.configUsed="1"===this._isWebInWin?1:0);for(var s=sessionStorage.length,o=0;o<s;o++){var r=sessionStorage.key(o),a=sessionStorage.getItem(r);-1!==r.indexOf("NGFilter_Volume_"+this._NGFUXId)?e="true"===a||(e||!1):-1!==r.indexOf("NGFilter_Context_"+this._NGFUXId)?t="false"!==a||(t||!1):-1!==r.indexOf("NGFilter_Attribute_"+this._NGFUXId)&&(i="false"!==a||(i||!1))}this.options.volumeUsed=void 0!==e&&e,this.options.contextUsed=void 0===t||t,this.options.attributeUsed=void 0===i||i,this.options.configUsed=1,this.render()},destroy:function(){this._subscribe0&&this._subscribe0.unsubscribe("Frame3DXInfra.onPanelClose"),this._subscribe1&&this._subscribe1.unsubscribe("Frame3DXInfra.LeftPanelExpanded"),delete this._subscribe0,delete this._subscribe1,this._parent()},render:function(){var e=this;this.container.setAttribute("id","NGF_"+this.cid),this.container.setAttribute("class","divNGF"),this.container.setContent(this._template({filterId:this._UXId,containerHeightClass:"f-globalFilter-container-height"+("safari"===n.Client.Engine.name?"-Safari":""),otherCmds:h.isFilterCmdHeaderActivated()})),this._subscribe1=u.subscribe("Frame3DXInfra.LeftPanelExpanded",t=>{e._isLeftPanelMaximized=t}),this._toolBar=this.getElement(".filter-Commands"),this._expandLeftPanel3DD=document&&document.querySelector(".left-panel-actions")?1:0,this._expandLeftPanel3DD&&(this._subscribe0=u.subscribe("Frame3DXInfra.onPanelClose",this._onCloseFilterPanel.bind(this))),p.isDebugActive("LeftPanelCmds")&&(this._toolBar.style.marginRight="0px"),p.isDebugActive("extendedCmds")&&this.getElement("#filter-extra-commands").addEventListener("click",this._onDisplayExtraCommands.bind(this));var t=p.getTenant();return h.getPlatformServices(t).then(function(){var t=p._getFilterSpecification(e.options)?p._getFilterSpecification(e.options).data:void 0;if(t&&t.filterMdl&&t.filterMdl.length)e._dropedFilterIds=[],e._dropedFilterIds=t?Array.isArray(t.filterId)?t.filterId:[t.filterId]:void 0,e._fromFilterDataToAppAndUXView({success:[e.options]});else{var i={appId:e.appId,widget:e._widgetId,UXId:e._UXId,rootID:e.rootID,rootAlias:e.rootAlias,rootRevision:e.options.rootRevision,configUsed:e.options.configUsed,volumeUsed:e.options.volumeUsed,contextUsed:e.options.contextUsed,attributeUsed:e.options.attributeUsed,filterToApply:e._filterToApply,idxGFV:y++,fromDropOnFilter:t?t.fromDropOnFilter:void 0,dropOption:t?t.dropOption:void 0,filterMdl:t?t.filterMdl:void 0,NGFUXId:e._NGFUXId,appQueryParam:e._appQueryParam,securityContext:e.options.securityContext,queryFormat:e.options.queryFormat,pfServiceId:e.options.pfServiceId,ghostContainer:e.options.ghostContainer};i.tagData=e._tagData,e._createViews(i),e._filterToApply=void 0}}),this},updateView:function(e){this._appQueryParam=e.appQueryParam||{},this.globalViewFilter&&this.globalViewFilter.updateView(e)},updateViewAsync:function(e){var t=this;return new s(function(i){t.updateView(e),i()})},getFilteringContext:function(){return{NGFUXId:this._NGFUXId,widgetId:this._widgetId}},_fromFilterDataToAppAndUXView:function(e){if(e.success){var t=e.success[0],n={idxGFV:y++,widget:this._widgetId,filterUIComponents:t.filterMdl,droppedInfos:{retrieveFilters:e,filterId:this._dropedFilterIds[0]}},s=i.merge(t,n);this._createViews(s),this._welcomeView.hide()}},_onCloseFilterPanel:function(){"1"===this._isWebInWin&&sendNotificationToWin("NGFClose","Close"),!this._expandLeftPanel3DD&&""!==this._widgetId&&u.publish("Frame3DXInfra.Close",{}),sessionStorage.setItem("NGF_tagMgtRunning_"+this._UXId,!1)},setTagsDataOnNGF:function(e){this.globalViewFilter.setTagsDataOnNGF(e)},updateDataOnNGF:function(e){this.globalViewFilter.updateDataOnNGF(e)},_createViews:function(e){var t=this;e.container=t.getElement(".welcomepage-container"),t._welcomeView=new g(e),e.container=t.getElement(".globalFilterView-container"),e.model=new l({state:"init"}),t.globalViewFilter=new a(e),t.listenTo(t._welcomeView,"NGF_WLC_AddCriterion",function(e){t._welcomeView.hide(),t._toolBar.show(),t.globalViewFilter.show(),t.globalViewFilter.addNewCriterion(e)}),t.listenTo(t._welcomeView,"NGF_WLC_RetrieveFilter",function(e){var i=e.type,n=-1;h.FILTER_RELATED_TO_ROOT===i?n=1:h.FILTER_RELATED_TO_ALL_REVISIONS===i?n=2:h.FILTER_RELATED_TO_ANY_ROOT===i&&(n=3),p.setUsageTracker(this._widgetId,"NGF-Retrieve_Filters_Related_To",{label:i,value:n}),t.globalViewFilter.retrieveFiltersRelatedTo(e)}),t.listenTo(t.globalViewFilter,"NGF_GoToWelcomePage",function(e){t._toolBar.hide(),t.globalViewFilter.hide(),t._welcomeView.show()}),t.listenTo(t.globalViewFilter,"NGF_DisplayGlobalFilterView",function(e){t._welcomeView.hide(),t._toolBar.show(),t.globalViewFilter.show()})},getFilterSpecification:function(){return{filterUIComponents:this.globalViewFilter.getFilterSpecification()}},updateOnLinkUnlinkWith:function(e,t){this.options.queryFormat=t.queryFormat,this.options.volumeUsed=t.volumeUsed,this.options.contextUsed=t.contextUsed,this.options.attributeUsed=t.attributeUsed,this.globalViewFilter.updateOnLinkUnlinkWith(e,t)},_onDisplayExtraCommands:function(){if(!this._debugContextualMenu){this._debugContextualMenu=[{type:"PushItem",recId:"ExtraCommands-CopyFromAnyFilterOnRoots-item",title:"Copy from Any Filter on several Roots",icon:h.getIconByName("list-filter"),action:{this:this,callback:this._onDebugCopyFromAnyFilterOnRoots}},{type:"PushItem",recId:"ExtraCommands-SetConfigFilter-item",title:"Set Config Filter",icon:h.getIconByName("configuration"),action:{this:this,callback:this._onDebugSetConfigFilter}},{type:"PushItem",title:"Change",icon:h.getIconByName("exchange-cog"),submenu:[{type:"PushItem",recId:"ExtraCommands-UpdateTenant-item",title:"Tenant",icon:h.getIconByName("update"),action:{this:this,callback:this._onDebugUpdateTenant}},{type:"PushItem",recId:"ExtraCommands-SetDefaultSecurityContext-item",title:"Default Security-Context",icon:h.getIconByName("lock-open"),action:{this:this,callback:this._onDebugSetDefaultSecurityContext}}]},{type:"PushItem",recId:"ExtraCommands-ExecuteFilter-item",title:"Execute Filter",icon:h.getIconByName("run"),action:{this:this,callback:this._onDebugExecuteFilter}},{type:"PushItem",title:"Link / Unlink",icon:h.getIconByName("link"),submenu:[{type:"PushItem",recId:"ExtraCommands-Link-item",title:"Link",icon:h.getIconByName("link-add"),action:{this:this,callback:this._onDebugLinkUnlink,context:{type:"Link"}}},{type:"PushItem",recId:"ExtraCommands-Unlink-item",title:"Unlink",icon:h.getIconByName("link-delete"),action:{this:this,callback:this._onDebugLinkUnlink,context:{type:"Unlink"}}}]},{type:"PushItem",title:"Public Specification",icon:h.getIconByName("filter"),submenu:[{type:"PushItem",recId:"ExtraCommands-CreateFilter-item",title:"Set Specification",icon:h.getIconByName("import"),action:{this:this,callback:this._onDebugSetPublicFilterSpec,context:{type:"PFS"}}},{type:"PushItem",recId:"ExtraCommands-CreateFilter-item",title:"Set Specification CAA",icon:h.getIconByName("import"),action:{this:this,callback:this._onDebugSetPublicFilterSpec,context:{type:"PFS-CAA"}}},{type:"PushItem",recId:"ExtraCommands-GetPublicSepec-item",title:"Get Volatile Specification",icon:h.getIconByName("export"),action:{this:this,callback:this._onDebugGetPublicFilterSpecFromVolatile}},{type:"PushItem",recId:"ExtraCommands-GetPublicSepec-item",title:"Get Saved Specification",icon:h.getIconByName("export"),action:{this:this,callback:this._onDebugGetPublicFilterSpecFromFilterId}}]}];var e=this.getElement("#filter-extra-commands"),t=this;e.addEventListener("click",function(e){e.stopPropagation();var i=e.target.getBoundingClientRect();v.show(t._debugContextualMenu,{position:h.getMenuPosition(i)})}),e.click()}},_onDebugExpandFilterPanel:function(){var e=this,t=function(t){var i=parent.document.querySelector(".column.left"),n=i.getElement(".column-ctn");if(i&&n)if(t){console.log("===> left panel width = "+i.style.width+", "+n.style.width),e._leftPanelWidth1=i.style.width,e._leftPanelWidth2=n.style.width;var s=-parseInt(i.style.left.replace("px",""));i.style.width=t+s+"px",n.style.width=t+"px"}else i.style.width=e._leftPanelWidth1,n.style.width=e._leftPanelWidth2,delete e._leftPanelWidth1,delete e._leftPanelWidth2},i=this.getElement("#ngf-resize-left-panel");if("resize-full"===(i.hasClassName("fonticon-resize-full")?"resize-full":"resize-small")){i.title="Collapse Filter Panel",i.removeClassName("fonticon-resize-full"),i.addClassName("fonticon-resize-small");var n=parent.document.getElement("#topbar").getSize().width;t(Math.max(450,.95*n))}else i.title="Expand Filter Panel",i.removeClassName("fonticon-resize-small"),i.addClassName("fonticon-resize-full"),t()},_onDebugSetConfigFilter:function(){var e=this;this._welcomeView&&this._welcomeView.hide(),h.showFilterContainer(this._UXId,!1);var t=h.getGlobalEditContainer(this._UXId),n=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Apply Filter",checkFlag:!1}),s=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Display Filter Panel",checkFlag:!0}),o=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Force Update",checkFlag:!1}),r=new b({touchMode:h.TOUCH_MODE,label:"OK"}),a=new b({touchMode:h.TOUCH_MODE,label:"Cancel"}),l=i.createElement("div",{id:"xDiv"});l.inject(t),l.style.marginTop="38px",l.style.border="thin dashed #368ec4",l.style.borderRadius="5px",l.style.padding="10px",n.inject(l),s.inject(l),o.inject(l);var d=i.createElement("div",{id:"xDivCmd"});d.inject(l),d.style.marginTop="38px",d.style.display="inline-block",r.inject(d),a.inject(d),r.addEventListener("buttonclick",function(i){var r={specification:{type:"NGFilter_ConfigDefined",data:{prodConf:e.rootID}},rootID:e.rootID,rootAlias:e.rootAlias,applyFilter:n.checkFlag?1:0,displayFilter:s.checkFlag?1:0,forceUpdate:o.checkFlag?1:0,NGFUXId:e._NGFUXId,widgetId:e._widgetId};u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_SetConfigSpecfication",data:r}),t.removeChild(l),h.showFilterContainer(e._UXId,!0)}),a.addEventListener("buttonclick",function(i){t.removeChild(l),h.showFilterContainer(e._UXId,!0)})},_onDebugCopyFromAnyFilterOnRoots:function(){var e=this,t='flattenedtaxonomies:"types/ENOStrRefinementSpecification"';this.globalViewFilter.in_apps_search({precond:t,title:_.get("SearchFilters"),callback:function(i){var n=i;t='flattenedtaxonomies:"types/VPMReference"',setTimeout(function(){e.globalViewFilter.in_apps_search({multiSel:!0,precond:t,title:_.get("SearchFilters"),callback:function(t){var i={};i.eventName="NGFilter_CopyFromAnyFilterOnRoots_"+e._UXId,t=Array.isArray(t)?t:[t],u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_SetCopyFromAnyFilterOnRoots",data:{appId:e._NGFUXId,widgetId:e._widgetId,filterID:n,rootIDs:t,options:i,NGFUXId:e._NGFUXId}})},cancel:function(){}})},1500)},cancel:function(){}})},_onDebugUpdateTenant:function(){u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_UpdateTenant",data:{NGFUXId:this._NGFUXId,widgetId:this._widgetId,tenant:"xxx"}})},_onDebugSetDefaultSecurityContext:function(){u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_SetDefaultSecurityContext",data:{NGFUXId:this._NGFUXId,widgetId:this._widgetId,sc:"VPLMProjectLeader.MyCompany.3DS Private Collab Space"}})},_onDebugExecuteFilter:function(){var e=this;this.globalViewFilter.in_apps_search({precond:'flattenedtaxonomies:"types/ENOStrRefinementSpecification"',title:_.get("SearchFilters"),callback:function(t){var i=h.getPlatformServiceUrl()+"/resources/FilterBIAPI/Filter/executeFilter";r.authenticatedRequest(i,{headers:f.getRESTHeaders(e.options.securityContext),method:"POST",type:"json",proxy:"passport",data:JSON.stringify({filterId:t,appQueryParam:{select_bo:["ds6w:label"],select_rel:["ds6w:label"],no_type_filter_bo:["PLMPort"],expand_iter:"2"}}),onComplete:function(e){e.filterRoot;var t=e.filtered.results,i=[];t.forEach(e=>{e.path&&i.push(e.path)}),i.forEach((e,i)=>{console.log("---------------------------------  Path("+i+")  ---------------------------------");var n="";e.forEach(e=>{for(var i=0;i<t.length;i++){var s=t[i].attributes,o=void 0;if(s)if(s.find(t=>"did"===t.name&&e===Number(t.value))&&(o=s.find(e=>"ds6w:label"===e.name)),o){console.log(n+o.value),n+="  ";break}}})})},onFailure:function(e){console.log("--------------------------  Execute Filter failed  ---------------------------------"),console.log("error = "+e)}})},cancel:function(){}})},_onDebugLinkUnlink:function(e){var t=this,n="Link"===e.context.type?"NGFilter_Link":"NGFilter_Unlink";this._welcomeView&&this._welcomeView.hide(),h.showFilterContainer(this._UXId,!1);var s=h.getGlobalEditContainer(this._UXId),o=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Apply Filter",checkFlag:!1}),r=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Display Filter Panel",checkFlag:!0}),a=new b({touchMode:h.TOUCH_MODE,label:"OK"}),l=new b({touchMode:h.TOUCH_MODE,label:"Cancel"}),d=i.createElement("div",{id:"xDiv"});d.inject(s),d.style.marginTop="38px",d.style.border="thin dashed #368ec4",d.style.borderRadius="5px",d.style.padding="10px",o.inject(d),r.inject(d);var c=i.createElement("div",{id:"xDivCmd"});c.inject(d),c.style.marginTop="38px",c.style.display="inline-block",a.inject(c),l.inject(c),a.addEventListener("buttonclick",function(e){"NGFilter_Link"===n?(t._savedVolumeUsed=t.options.volumeUsed,t._savedContextUsed=t.options.contextUsed,t._savedAttributeUsed=t.options.attributeUsed,t._savedQueryFormat=t.options.queryFormat):(t.options.volumeUsed=t._savedVolumeUsed,t.options.contextUsed=t._savedContextUsed,t.options.attributeUsed=t._savedAttributeUsed,t.options.queryFormat=t._savedQueryFormat,delete t._savedVolumeUsed,delete t._savedContextUsed,delete t._savedAttributeUsed,delete t._savedQueryFormat);var i={rootID:t.rootID,rootAlias:t.rootAlias,specification:{type:n,data:{NGFUXId:t._NGFUXId,widgetId:t._widgetId,rootID:t.options.rootID,rootAlias:t.options.rootAlias,volumeUsed:t.options.volumeUsed,contextUsed:t.options.contextUsed,attributeUsed:t.options.attributeUsed,queryFormat:t.options.queryFormat}},applyFilter:o.checkFlag?1:0,displayFilter:r.checkFlag?1:0,eventName:n};s.removeChild(d),h.showFilterContainer(t._UXId,!0),u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_LinkUnlink",data:i})}),l.addEventListener("buttonclick",function(e){s.removeChild(d),h.showFilterContainer(t._UXId,!0)})},_onDebugSetPublicFilterSpec:function(e){var t=this;if(this.globalViewFilter._isThereCriteriaDefined()&&!this.globalViewFilter._tagsOnly)h.displayNotification({level:"error",message:_.get("FilteringInProgress")});else{this._welcomeView&&this._welcomeView.hide(),h.showFilterContainer(this._UXId,!1);var n=h.getGlobalEditContainer(this._UXId),s=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Apply Filter",checkFlag:!1}),r=new C({touchMode:h.TOUCH_MODE,type:"switch",label:"Display Filter Panel",checkFlag:!0}),a=i.createElement("input",{id:"fileInput",type:"file"}),l=i.createElement("div",{id:"xDiv"});l.inject(n),l.style.marginTop="38px",l.style.border="thin dashed #368ec4",l.style.borderRadius="5px",l.style.padding="10px",a.inject(l),s.inject(l),r.inject(l);const d=document.querySelector("#fileInput"),c=new FileReader;d.addEventListener("change",i=>{var a=o.strftime(new o,"%H:%M:%S");const p=d.files[0];p?(c.addEventListener("error",e=>{var i=" ==> Error occurred reading file: "+e.message,s=" ==> File : "+e.filename+"(l:"+e.lineno+", c:"+e.colno+")";console.error(i+"\n"+s),alert(i+"\n"+s),n.removeChild(l),h.showFilterContainer(t._UXId,!0)}),c.addEventListener("load",()=>{console.log(" ==> File: "+p.name+" read successfully"),console.log(" ==> File Content = "+c.result);this.globalViewFilter.in_apps_search({precond:'flattenedtaxonomies:"types/VPMReference"',title:_.get("SearchReferences"),callback:function(i){var o,d;o=JSON.parse(c.result),d={NGFUXId:t._NGFUXId,widgetId:t._widgetId,specification:"PFS-CAA"!==e.context.type?o:{title:"publicFilter (CAA)",description:"Description Public Filter ("+a+")",referencedObject:{source:"3DSpace",type:"VPMReference",identifier:i,relativePath:"resource/v1/modeler/dseng/dseng:EngItem/"+i},filter:o},rootId:i,applyFilter:s.checkFlag?1:0,displayFilter:r.checkFlag?1:0,eventName:"NGF_SetPublicFilterSpecfication"},n.removeChild(l),h.showFilterContainer(t._UXId,!0),u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_SetPublicFilterSpecfication",data:d})},cancel:function(){n.removeChild(l),h.showFilterContainer(t._UXId,!0)}})}),c.readAsText(p)):(n.removeChild(l),h.showFilterContainer(t._UXId,!0))})}},_onDebugGetPublicFilterSpecFromVolatile:function(){for(let t=0;t<1;t++){var e={rootId:this.rootID,NGFUXId:this._NGFUXId,widgetId:this._widgetId,eventName:"NGFilter_GetPublicFilterSpecFromVolatile_"+t};u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_GetPublicFilterSpecFromVolatile",data:e})}},_onDebugGetPublicFilterSpecFromFilterId:function(){this.globalViewFilter.in_apps_search({precond:'flattenedtaxonomies:"types/ENOStrRefinementSpecification"',title:_.get("SearchFilters"),callback:function(e){for(let i=0;i<1;i++){var t={NGFUXId:this._NGFUXId,widgetId:this._widgetId,filterId:e,eventName:"NGFilter_GetPublicFilterSpecFromFilterId_"+i};u.publish("NGFilter_Debug",{type:"NGFilter_Dbg_GetPublicFilterSpecFromFilterId",data:t})}},cancel:function(){}})}})}),define("DS/ENONextGenFilterUX/views/FilterViewManager",["UWA/Class","UWA/Core","UWA/Promise","DS/PlatformAPI/PlatformAPI","DS/Logger/Logger","DS/ENONextGenFilterUX/views/ContainerFilterView","DS/ENOFilterBIUX/NGFServices","DS/ENONextGenFilterUX/utils/FilterUIService","i18n!DS/ENONextGenFilterUX/assets/nls/ENONextGenFilterUX"],function(e,t,i,n,s,o,r,a,l){"use strict";var d=null;return e.extend({init:function(e){var t=Date.now();a.setReferenceTime(e.referenceTime||t);var i=t-a.getReferenceTime();a.displayInternalTimeTrace(1,"FilterViewManager Loading"),r.setFilteringContext({tenant:e.widgetTenant||"OnPremise"});var s=e.widgetId||e.widget;r.setPerformanceTracker(s,"NGF-Loading","NGFilter_UX",{Loading_duration:i},1),null===d&&(d=this._initManager()),this._initDisplay=e.display,this._viewChangeData=void 0,n.subscribe("NGFilter.RemoveFilter",this._onRemoveFilter.bind(this)),n.subscribe("NGFilter_ViewChange",this._onViewChange.bind(this)),n.subscribe("Frame3DXInfra.ViewChange",this._onViewChange.bind(this))},get3DXViewAsync:function(e){var t=this;return new i(function(i){let s=function(e){var s;if(e&&e.filterToApply){var o=e.filterToApply,a=o&&o.specification?o.specification.type:"";if("NGFilter_CopyFromAnyFilterToRoots"===a)s=t._onCopyFromAnyFilterToRoots(e),i(s);else if("NGFilter_Link"===a||"NGFilter_Unlink"===a)s=t._onLinkOrUnlinkWith(e),i(s);else if("NGFilter_SetPublicFilterSpec"===a)t._onSetPublicFilterSpecFilter(e).then(e=>{i(s=e)});else if("NGFilter_GetPublicFilterSpecFromVolatile"===a){if(d.get(r.computeUXId(o.NGFUXId,o.rootID)))t._get3DXView(e),i(null);else{var c=o.proxyEvent?o.proxyEvent:"";c&&n.publish(c,{status:0,error:{level:"error",title:l.get("GetPublicFilterSpecification"),message:l.get("NoFilterDefinedOnRoot")}}),i(null)}}else s=t._get3DXView(e),i(s)}else s=t._get3DXView(e),i(s)};if(a.getLengthUnit()){s(e)}else a.getLengthUnitPreference().then(t=>{a.setLengthUnit(t),s(e)})})},_get3DXViewAsync:function(e){let t=this;return new i(function(i,n){i(t._get3DXView(e))})},_get3DXView:function(e){var t;if(void 0===e.createFilterView||e.createFilterView){a.setReferenceTime(Date.now()),a.displayInternalTimeTrace(1,"FilterViewManager 3DXView"),r.updateFilteringContext({tenant:e.widgetTenant||r.getTenant()}),e.NGFUXId=e.NGFUXId||e.appId;var i=e.widgetId||e.widget;e.UXId=e.NGFUXId&&e.rootID?r.computeUXId(e.NGFUXId,e.rootID):e.UXId||i;var n=e.UXId,s="NGF_isUXBuilt_"+n,l="NGF_tagMgtRunning_"+n;if(null===(t=d.get(n))){e.pfServiceId=e.rootServiceId||e.serviceId||"3DSpace",delete e.rootServiceId,sessionStorage.setItem(s,!1),e.tagData&&sessionStorage.setItem(l,!0);var c=new o(e);e.ghostContainer?(c.inject(e.ghostContainer),d.add(n,c)):(d.add(n,c),d.display(n)),t=d.get(n)}else{if("false"===sessionStorage.getItem(s))return;if("true"===sessionStorage.getItem(l))return;t.updateView(e),(void 0===e.display||e.display)&&d.display(n)}}return t},_onViewChange:function(e){if("maximized"===e.type){this._viewChangeData?this._viewChangeData=this._viewChangeData.NGFUXId?this._viewChangeData:e:this._viewChangeData=e;var t=this;setTimeout(function(){t._viewChangeData&&!1===d.isThereViewWithId(t._viewChangeData.NGFUXId,t._viewChangeData.widgetId||t._viewChangeData.id)&&n.publish("Frame3DXInfra.Close",{}),t._viewChangeData=void 0},1e3)}},_onRemoveFilter:function(e){d.isThereViewWithId(e.NGFUXId)&&(d.remove(e.NGFUXId,e.rootIds),n.publish("Frame3DXInfra.Close",{}))},_onCopyFromAnyFilterToRoots:function(e){var s,o=this,l=e.NGFUXId,c=e.widgetTenant||"OnPremise",u=e.securityContext||"OnPremise",h=e.filterToApply.specification.data;r.getAllDataFromFilterIds(h.filterId,c).then(function(c){var p=c.success[0];a.checkAndGetListOfAttributesFromSelectedFilter(p).then(function(c){var _=h.options?h.options.displayNotif:1,m=[],f=e;return h.rootInfos.forEach(function(e){f.rootID=e.id,f.rootAlias=e.alias,f.rootRevision=e.revisions,m.push(function(e,i){var n=e.rootID,s=e.rootAlias;return new Promise(function(e){var o={rootID:n};r.isDebugActive("ngf")&&(o.rootAlias=s);var c=r.computeUXId(l,n);d.get(c)&&!h.options.resetFilter?(o.error=-1,e(o)):a.checkCompatibiltyFilterRules(u,n,p,_,i).then(function(i){o=t.merge(o,i.result),e(o)})})}(f,e.service))}),i.all(m).then(function(e){var a=t.clone(h.options);a.resetFilter=1;var u=[];return h.rootInfos.forEach(function(e){var i=r.computeUXId(l,e.id),n=t.createElement("div",{id:"NGF-CopyFromAnyFilterToRoots_"+i});n.inject(window.document.body),n.hide();var s=d.get(i);(!s||s&&h.options.resetFilter)&&(f.rootID=e.id,f.rootAlias=e.alias,f.rootRevision=e.revision,f.rootServiceId=e.service,f.display=!1,f.ghostContainer=n,f.filterToApply={specification:{type:"NGFilter_CopyFromAnyFilterToRoots",data:{filterData:p,listAttr:c,rootId:e.id,options:a}}},u.push(o._get3DXViewAsync(f)))}),i.all(u).then(t=>{s=t&&t.length?t[t.length-1]:void 0;var i=h.options&&h.options.eventName?h.options.eventName:"";if(i){var o={};o.results=e,n.publish(i,o)}}),s})},function(e){return console.log(" ==> onCopyFromAnyFilterToRoots / Retrieve List Of Attribute,  err = "+e),s})},function(e){return console.log(" ==> onCopyFromAnyFilterToRoots / Retrieve Data Filter,  err = "+e),s})},_onLinkOrUnlinkWith:function(e){var s;if(!(e&&e.filterToApply&&e.filterToApply.specification))return console.log(" => Link / Unlink : No specification defined"),s;var o=e.filterToApply,a=o.specification.type,l=o.specification.data||{},c=[];if(l&&(c=Array.isArray(l.rootID)?l.rootID:[l.rootID]),c.length&&("NGFilter_Link"===a||"NGFilter_Unlink"===a)){var u=Array.isArray(e.rootID)?e.rootID:[e.rootID];if("NGFilter_Link"===a){u.forEach(t=>{d.get(r.computeUXId(e.NGFUXId,t))&&d.remove(e.NGFUXId,t)});var h={};return h.attributeUsed=e.attributeUsed||l.attributeUsed,h.contextUsed=e.contextUsed||l.contextUsed,h.volumeUsed=e.volumeUsed||l.volumeUsed,h.queryFormat=e.queryFormat|Number.parseInt(l.queryFormat),h.NGFUXId=l.NGFUXId,h.applyFilter=o.applyFilter,h.empty=l&&l.empty?l.empty[0]:void 0,h.eventName=l&&l.eventName?l.eventName:"",c.forEach(e=>{var t=d.get(r.computeUXId(l.NGFUXId,e));if(t)t.updateOnLinkUnlinkWith(a,h),s=t;else{var i=l&&l.eventName?l.eventName:"";if(i){var o={results:"OK"};n.publish(i,o)}}}),s}if("NGFilter_Unlink"===a){var p=Array.isArray(e.rootAlias)?e.rootAlias:[e.rootAlias],_=o;delete e.filterToApply;var m=[];u.forEach((i,n)=>{e.rootID=i,e.rootAlias=p[n],e.UXId=r.computeUXId(e.NGFUXId,i);var s=t.createElement("div",{id:"NGF-BuildFilter_"+e.UXId});s.inject(window.document.body),s.hide(),e.ghostContainer=s,m.push(this._get3DXViewAsync(e))}),i.all(m).then(function(t){var i={};return c.forEach(e=>{var t=d.get(r.computeUXId(l.NGFUXId,e));t&&(i[e]=t.getFilterSpecification(),t.updateOnLinkUnlinkWith(a,l)),s=t}),u.forEach((t,n)=>{var s=i[t]||i[c[0]];s&&(e.rootID=t,e.rootAlias=p[n],e.UXId=r.computeUXId(e.NGFUXId,t),_.specification.data=s,e.filterToApply=_,e.filterToApply._tagsOnly=l&&l._tagsOnly?l._tagsOnly:void 0,d.get(e.UXId).updateView(e))}),s})}}},_onSetPublicFilterSpecFilter:function(e){var s=this;return new i(function(o,c){var u=r.getTenant();a.getPlatformServices(u).then(function(){if(e&&e.filterToApply&&e.filterToApply.specification){var c=[e.rootID];a.executeFetch(c).then(u=>{if(u.infos.nresults){var h=a.getAliasesFromFetched(c,u);e.rootAlias=h.length?h[0]:"?",e.filterToApply.rootAlias=e.rootAlias,function(){var n=function(e,t){return new i((n,s)=>{var o=[];e.forEach(e=>{o.push(e.updateViewAsync(t))}),i.all(o).then(function(e){n(e.length?e[0]:void 0)})})},a=e.filterToApply,l=r.computeUXId(e.NGFUXId,e.rootID),c=d.get(l)?[d.get(l)]:[];if(c.length)n(c,e).then(e=>{o(e)});else{var u=t.createElement("div",{id:"NGF-BuildFilter_"+l});u.inject(window.document.body),u.hide(),delete e.filterToApply,e.UXId=l,e.ghostContainer=u;var h=[];h.push(s._get3DXViewAsync(e)),i.all(h).then(function(t){e.filterToApply=a,n(t,e).then(e=>{o(e)})})}}()}else{var p=l.get("InvalidRootIdentifier");if(console.log(" => Set Public Speciifcation, err = "+p),e&&e.filterToApply&&e.filterToApply.eventName){var _={status:0,error:{level:"error",title:l.get("SetPublicFilterSpecification"),message:p}};n.publish(e.filterToApply.eventName,_)}o(null)}})}else{var u=l.get("NoSpecificationDefined");if(console.log(" => Set Public Speciifcation, err = "+u),e&&e.filterToApply&&e.filterToApply.eventName){var h={status:0,error:{level:"error",title:l.get("SetPublicFilterSpecification"),message:u}};n.publish(e.filterToApply.eventName,h)}o(null)}})})},_initManager:function(){return{_listView:{},_currentUXId:"",get:function(e){return e&&this._listView[e]?this._listView[e]:null},getCurrentUXId:function(){return this._currentUXId||""},isThereViewWithId:function(e,t){var i=this,n=Object.keys(this._listView);return!!(e?n.find(function(t){var n=i._listView[t].getFilteringContext();return-1!==e.indexOf(n.NGFUXId)}):n.find(function(e){var n=i._listView[e].getFilteringContext();return-1!==t.indexOf(n.widgetId)}))},add:function(e,t){e&&t&&(this._listView[e]||(this._listView[e]=t))},display:function(e){if(e){var t=this._currentUXId;t!==e&&(""!==t&&this._listView[t]&&this._listView[t].hide(),this._listView[e]&&(this._currentUXId=e,this._listView[e].show()))}},remove:function(e,t){if(e){if(t)for(var i=Array.isArray(t)?t:[t],n=i.length-1;n>=0;n--){var s=r.computeUXId(e,i[n]);this._remove(s)}else{var o=Object.keys(this._listView);for(n=o.length-1;n>=0;n--)-1!==o[n].indexOf(e)&&this._remove(o[n])}0!==Object.keys(this._listView).length&&this._listView[this._currentUXId]||(this._currentUXId="")}},_remove:function(e){var t=d.get(e);t&&(t.remove(),delete this._listView[e])}}}})}),define("DS/ENONextGenFilterUX/ENONextGenFilterUX",["UWA/Core","UWA/Class","DS/PlatformAPI/PlatformAPI","DS/ENONextGenFilterUX/views/FilterViewManager"],function(e,t,i,n){"use strict";return t.extend({init:function(e){i.subscribe("Frame3DXInfra.Update",this._onUpdate.bind(this)),i.subscribe("NGFilter_SessionStorage",this._onSessionStorage.bind(this)),i.subscribe("NGFilter_LocalStorage",this._onLocalStorage.bind(this))},_onUpdate:function(e){let t=this;if("Filter"===e.type){let i=function(e,i){i.display=void 0===i.display||i.display,e.get3DXViewAsync(i).then(e=>{if(e){let i="function"==typeof e.get3DXViewId?e.get3DXViewId():e.cid;if(t._viewId!==i||!i){let n=document.getElementById("NGF_"+t._viewId);n&&n.remove(),widget.body.setContent(e),t._viewId=i}}})},s=e.options;this._filterViewMgr?i(this._filterViewMgr,s):(t._filterViewMgr=new n(s),i(this._filterViewMgr,s))}},_onSessionStorage:function(e){e&&e.removeItems&&e.removeItems.forEach(e=>{sessionStorage.removeItem(e)}),e&&e.setItems&&e.setItems.forEach(e=>{sessionStorage.setItem(e.key,e.value)})},_onLocalStorage:function(e){e&&e.forEach(e=>{localStorage.setItem(e.key,e.value)})}})}),define("DS/ENONextGenFilterUX/utils/FilterAdvServicesWebInWin",["UWA/Core","UWA/Class","UWA/Widget","UWA/Class/Options","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBISettings","DS/ENONextGenFilterUX/views/FilterViewManager","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/FBIServices","DS/PlatformAPI/PlatformAPI"],function(e,t,i,n,s,o,r,a,l,d){"use strict";return t.singleton(n,{initServices:function(e){var t=e.filterSettings.platform_services;l.setOption("fromWebInWin",1),l.setOption("str_platformServices",t),a.setOption("str_platformServices",t)},renderFilterViewInWin:function(){var e=new i,t=e.getValue("X3DContentId")?JSON.parse(e.getValue("X3DContentId")):null,n=(e.getView&&e.getView().type,"[");if(null===t||void 0!==e.getValue("lastRootNodeID")||e.getValue("clearInPreview"))n=null;else{var s=t.data;if(null!==s&&s.items.length>0){for(var o=s.items,a=0;a<o.length;a++)n+='"'+o[a].objectId+'"',n+=o.length-1===a?"]":",";e.setValue("lastRootNodeID",n)}}var l=null;"function"==typeof(l=new r(options)).get3DXViewAsync&&l.get3DXViewAsync(options).then(function(e){e.inject(document.body)})},addRemovePaths:function(e){console.log("In addOrRemovePaths"),d.publish("NGFilter.OccPath",{selectedPath:e.selectedPaths,pathAlias:e.pathAlias})}})}),define("DS/ENONextGenFilterUX/ENONextGenFilterUXWIW",["DS/ENONextGenFilterUX/views/FilterViewManager","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/utils/FilterAdvServicesWebInWin","DS/ENOFilterBIUX/FBIServices","UWA/Class","UWA/Core","UWA/Widget","DS/PlatformAPI/PlatformAPI"],function(e,t,i,n,s,o,r,a){"use strict";return s.extend({init:function(e){this.options=e,i.initServices(e),i.renderFilterViewInWin()},addOrRemovePaths:function(e){console.log("In addOrRemovePaths"),a.publish("NGFilter.OccPath",{selectedPath:e.selectedPaths,pathAlias:e.pathAlias})}})});