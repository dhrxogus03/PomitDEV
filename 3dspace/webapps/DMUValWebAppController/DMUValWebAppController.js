define("DS/DMUValWebAppController/DMUValWebAppController",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/PathElement","DS/CATWebUXComponents/CATWebUXNotification","DS/DMUReviewPersistence/DMUAuthReviewPersistenceServices","DS/DMUReviewCommonWebApp/DMUCommonWebAppController","DS/DMUControls/DMUToolsSave","i18n!DS/DMUValWebAppController/assets/nls/DMUValWebAppController"],function(e,t,n,i,o,r,a,s,c){"use strict";var d=a.extend({init:function(e){this._parent(e,"R3V");let a=this;var d,l=(e||{}).ctxViewer,u={};function v(e){var t=[];return e&&e.externalPath.forEach(function(e){if("RootBag"!==e.name&&(n.isInstance(e)||n.isRepInstance(e))){var i=n.getNodeID(e);i&&n.isPLMNode(e)&&t.push(i)}}),t}function p(e){var n=t.getEventsController({viewer:l.getViewer()});s.tryToSaveData({frameWindow:l.getFrameWindow(),saveFunction:function(){return new Promise(function(t,i){r.setCheckRequirement({checkId:e.checkId,requirementId:e.requirementId,removeReq:e.removeReq,onSetCheckRequirementComplete:async i=>{if(i.removeReq)n.fireEvent("onRequirementRemoved",i);else{let t,o;o=e.requirementTitle?e.requirementTitle:(t=await a.getRequirementData({phyId:i.requirementId}))[0]["attribute[Title]"],n.fireEvent("onRequirementAdded",{checkId:i.checkId,requirementId:i.requirementId,requirementTitle:o})}t()},onSaveFailed:i})})}}).catch(e=>{window.console.error(e)})}function h(e){"ValidationRequirement"===e.type&&p({checkId:e.checkId,removeReq:"true",requirementId:e.objectId})}function m(e){r.removeImpactedCheck({check:e.check,highlight:e.highlight,iCtxViewer:l,onRemoveImpactedCheckComplete:function(){},onRemoveImpactedCheckFailed:function(){var e;e={type:"error",msg:c.remImpactedCheckError},(new o).build({type:e.type,autoHide:!0,message:e.msg,body:l.getFrameWindow().getUIFrame()})}})}function f(e){var n=t.giveEventsController({viewer:l.getViewer()}),o=e.validationId,a=[],s=[e.contextId];a.push(s);var c=function(e){for(var n=[],o=t.getContextViewer({viewer:l.getViewer()}).getController(),r=0;r<e.length;r++){for(var a=[],s=0;s<e[r].length;s++){var c=o.getNode({id:e[r][s]});a.push(c)}var d=new i(a);n.push(v(d))}return n}(a);r.updateValidatedObjectsList({validatedObjects:c,validatedId:o,onSaveCompleted:function(){n.fireEvent("onValidatedSaved")},onSaveFailed:function(){}})}function g(e){var n=[],i=[];if(void 0!==e.status){n.push({iCheckState:e.status});for(let t=0;t<e.objectIds.length;t++)i.push({attributesList:n,objectId:e.objectIds[t]})}else e.name&&n.push({sName:e.name}),e.description&&n.push({sDescription:e.description}),i.push({attributesList:n,objectId:e.objectId});s.tryToSaveData({frameWindow:l.getFrameWindow(),saveFunction:function(){return new Promise(function(e,n){r.updateAttributes({objectsToModify:i,ctxViewer:l,onAttributesSaveCompleted:function(n){var i=t.getReviewContext({viewer:l.getViewer()}),o=t.getEventsController({viewer:l.getViewer()}),r=i.getValidation().getChecks();for(let e=0;e<r.length;e++){var a=n.modifiedObjects;for(let t=0;t<a.length;t++)r[e].getPlmID()===a[t].pId&&(a[t].sName&&r[e].setName(a[t].sName),a[t].sDescription&&r[e].setDescription(a[t].sDescription),void 0!==a[t].iCheckState&&r[e].setStatus(a[t].iCheckState),o.fireEvent("onAttributeSaved",{type:"Check",id:a[t].pId,name:a[t].sName?a[t].sName:void 0,status:a[t].iCheckState?parseInt(a[t].iCheckState):void 0,description:a[t].sDescription?a[t].sDescription:void 0,object:r[e]}))}e()},onSaveFailed:n})})}}).catch(e=>{window.console.error(e)})}function C(e){var n=[],i=[];if(void 0!==e.rating){n.push({iPresentationRating:e.rating});for(let t=0;t<e.objectIds.length;t++)i.push({attributesList:n,objectId:e.objectIds[t]})}else e.name&&n.push({sName:e.name}),e.description&&n.push({sDescription:e.description}),e.slideId&&n.push({sPresentationSlideID:e.slideId}),i.push({attributesList:n,objectId:e.objectId});s.tryToSaveData({frameWindow:l.getFrameWindow(),saveFunction:function(){return new Promise(function(e,n){r.updateAttributes({objectsToModify:i,ctxViewer:l,onAttributesSaveCompleted:function(n){var i=t.getReviewContext({viewer:l.getViewer()}),o=t.getEventsController({viewer:l.getViewer()}),r=i.getValidation().getHighlights();for(let e=0;e<r.length;e++){var a=n.modifiedObjects;for(let t=0;t<a.length;t++)r[e].getPlmID()===a[t].pId&&(a[t].sName&&r[e].setName(a[t].sName),a[t].sDescription&&r[e].setDescription(a[t].sDescription),a[t].iPresentationRating&&r[e].setRating(a[t].iPresentationRating),a[t].sPresentationSlideID&&r[e].setPresentationSlideId(a[t].sPresentationSlideID),o.fireEvent("onAttributeSaved",{type:"Highlight",id:a[t].pId,name:a[t].sName?a[t].sName:void 0,rating:a[t].iPresentationRating?parseInt(a[t].iPresentationRating):void 0,description:a[t].sDescription?a[t].sDescription:void 0}))}e()},onSaveFailed:n})})}}).catch(e=>{window.console.error(e)})}this.setActiveState=async function(e){var n=e;d=t.getEventsController({viewer:l.getViewer()}),n?(u.onCheckAttributeChanged=d.addEvent("onCheckAttributeChanged",g),u.onHighlightAttributeChanged=d.addEvent("onHighlightAttributeChanged",C),u.onRequirementAdded=d.addEvent("requirementAddRequested",p),u.onRequirementRemoveRequested=d.addEvent("onRequirementRemoveRequested",h),u.onRemoveImpactedCheckRequested=d.addEvent("onRemoveImpactedCheckRequested",m),u.onAddContextAsValidated=d.addEvent("addContextAsValidated",f),await this.setControllerActiveState(e)):(u={},this.setControllerActiveState(e))}}}),l=[];return e.singleton({init:function(){},giveController:function(e){if(e&&e.context)for(var t=0;t<l.length;t++)if(l[t].context===e.context)return l[t].controller},getController:function(e){var t;if(e&&e.context&&!(t=this.giveController(e))){var n=new d({ctxViewer:e.context});t=Object.freeze({setActiveState:async function(e){n&&await n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},clearController:function(){n&&(n.clearController(),n=null)},appInitFromTransition:function(e){return n?n.appInitFromTransition(e):Promise.resolve()},loadValidation:function(e){n&&n.loadValidation(e)},refreshContext:function(){n&&n.refreshContext()},loadReviewAfterRefresh:function(e){n&&n.loadReviewAfterRefresh(e)},disableDMUContextualBar:function(){n&&n.disableDMUContextualBar()},enableDMUContextualBar:function(){n&&n.enableDMUContextualBar()},publish:function(e,t){n&&n.publish(e,t)},setappTransition:function(e){n&&n.setappTransition(e)}}),l.push({context:e.context,controller:t})}return t},unreferenceController:function(e){if(e&&e.context)for(var t=0;t<l.length;t++)if(l[t].context===e.context){e.options&&e.options.appInfo&&"X3DPLAW_AP"===e.options.appInfo&&l[t].controller.setappTransition(!0),l[t].controller.clearController(),l.splice(t,1);break}}})});