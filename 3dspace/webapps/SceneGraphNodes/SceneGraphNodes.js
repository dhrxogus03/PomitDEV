define("DS/SceneGraphNodes/FixedSizeArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication"],function(e,t,i,r,a,n,o,s){"use strict";var c=[],d={},h={},l=t.extend({init:function(i){this._parent(i.name),this.matInherit=window.newMaterialInheritance,this._arrowWidth=i.arrowWidth,this._arrowLength=i.arrowLength,this._headLength=i.headLength?i.headLength:this._arrowLength/8,this._headWidth=i.headWidthToHeightRatio?i.headWidthToHeightRatio*this._headLength:this._headLength,this.globalSelection=i.globalSelection,this._color=i.color,this._threeColor=(new e.Color).setRGB(this._color.r,this._color.g,this._color.b),this._head=i.head,this._noZ=!i.removeNoZ,this._pickable=!!i.pickable;new n;var d=new e.Vector3(0,0,1),h=this._noZ?1:0,l=this._arrowLength-this._headLength,u=new t("myFixedSizeNodeG");if(this.globalSelection&&u.setPickParent(!0),this._head){var p=c[this._head],_=r.getWebappsAssetUrl("SceneGraphNodes",""),f=1===this._head?2:1,m=null,g=null,v=function(){};1===this._head?(m=d,g=(new e.Matrix4).rotateX(.5*Math.PI),p||(p=new e.ImageUtils.loadTexture(_+"models/textures/head.png",void 0,v,v,e.ImageUtils.crossOriginPolicy))):3===this._head?p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headSquare.png",void 0,v,v,e.ImageUtils.crossOriginPolicy)):4===this._head?p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headCross.png",void 0,v,v,e.ImageUtils.crossOriginPolicy)):2===this._head&&(p||(p=new e.ImageUtils.loadTexture(_+"models/textures/headDisk.png",void 0,v,v,e.ImageUtils.crossOriginPolicy))),c[this._head]=p,this._updateHeadMaterial();var x={width:this._headWidth,height:this._headLength,fill:!0,color:this._color,noEdge:!0,layerNb:h,material:this._headMaterial,cornerPoint:this._head>=2?new e.Vector2(-this._headWidth/2,-this._headLength/2):new e.Vector2(-this._headWidth/2,0)},w=o.createRectangleNode(x);w.setShadow(!1),w.setFrustumCulled(!1),this.matInherit&&(this._renderableHead=w._occurrences[0].renderable,w.setMaterialApplication(new s({faceMaterial:this._headMaterial,layer:0})),this._headMaterial.useGASColor=!0,w.setMaterialMode(!0)),this._pickable||w.setPickable(a.NOPICKABLE),this.globalSelection&&w.setPickParent(!0),w.name="Arrow's head";var S=new t("billBoardNode");this.globalSelection&&S.setPickParent(!0),S.addChild(w),S._setBillboardData(f,m,g);var b=new t("myFixedSizeNode");this.globalSelection&&b.setPickParent(!0),b.addChild(S),b._setFixedSizeCenter((new e.Vector3).copy(d).multiplyScalar(l/d.length()),1),u.addChild(b)}else l=this._arrowLength;this._updateBodyMaterial();var y={points:[new e.Vector3(0,0,0),new e.Vector3(0,0,l)],color:this._color,material:this._bodyMaterial,layerNb:h,width:this._arrowWidth},M=o.createLineNode(y);return M.setShadow(!1),M.setFrustumCulled(!1),this.globalSelection&&M.setPickParent(!0),this.matInherit&&(this._renderableBody=M._occurrences[0].renderable,M.setMaterialMode(!1)),this._pickable||M.setPickable(a.NOPICKABLE),M.name="Arrow's body",u.addChild(M),u._setRatio(1),this.addChild(u),this},_updateHeadMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head;this._headMaterial=d[t],this._headMaterial||(this._headMaterial=new e.MeshBasicMaterial({map:c[this._head],side:e.DoubleSide,transparent:!0,alphaTest:.05,color:this._threeColor,force:!this.matInherit}),d[t]=this._headMaterial)},_updateBodyMaterial:function(){var t=this._threeColor.getHexString()+"_"+this._head+"_"+this._arrowWidth;this._bodyMaterial=h[t],this._bodyMaterial||(this._bodyMaterial=new e.LineBasicMaterial({side:e.DoubleSide,color:this._threeColor,force:!this.matInherit,linecap:"butt",lineWidth:this._arrowWidth}),h[t]=this._bodyMaterial)},setColor:function(e){this._color.copy(e),this._threeColor.setRGB(e.r,e.g,e.b),this._updateHeadMaterial(),this._updateBodyMaterial(),this.matInherit&&(this._renderableHead.geometry[0].drawingGroups[0].gas.setParameters({colorRGB:this._threeColor}),this._renderableBody.geometry[0].drawingGroups[0].gas.setParameters({colorRGB:this._threeColor}),this._renderableHead._flagAsGSSOInvalidated(),this._renderableBody._flagAsGSSOInvalidated())},setName:function(e){this._name=e},getNodeType:function(){return"FixedSizeArrowNode"}});return l.types={NONE:null,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/FixedSizeArrowNode",l)}),define("SceneGraphNodes/FixedSizeArrowNode",["DS/SceneGraphNodes/FixedSizeArrowNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeArrowNode"),e}),define("DS/SceneGraphNodes/SphereLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.SphereLight(t.color,t.intensity,t.radius,t.mode);return this._radius=r.radius,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SphereLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SphereLight",i)}),define("SceneGraphNodes/SphereLightNode",["DS/SceneGraphNodes/SphereLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/SphereLightNode"),e}),define("DS/SceneGraphNodes/CSSSVGNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SVGLoader/SVGToNode3D","DS/Visualization/GetSVGMode"],function(e,t,i,r,a){"use strict";return t.extend({init:function(e,t,n){if(this._parent(t),this._webGLMode=a.getWebGLMode(),this._webGLMode){var o=new r(e).buildNode3D();this.addChild(o),this._cssSVGNode=!0,this.setPickable(i.PICKTHROUGH)}else{this._gNode=document.createElementNS(n.getSvgNS(),"g"),this._gNode.svgV6Node=this,this._gNode.appendChild(e),this.exludeFromBounding(!0),this.forbidChildren=!0;var s=this._occurrences[0],c=this.createRenderable();s.renderable=c,s.renderable.name=this.name,s.renderable._occurrence=s,this._cssSVGNode=!0,this.viewer=n,this._updateSVGVisibility()}},setVisibility:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisible(!!e),this._updateSVGVisibility()},setVisibilityFree:function(e){if(this._webGLMode)return this._parent.apply(this,arguments);this._setVisibilityFree(!!e),this._updateSVGVisibility()},getNodeType:function(){return this._webGLMode?this._parent.apply(this,arguments):"CSSSVGNode"},createRenderable:function(){if(this._webGLMode)return this._parent.apply(this,arguments);var t=new e.CSSSVGNode(this._gNode);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!1,t},addChild:function(){if(this._webGLMode)return this._parent.apply(this,arguments)},_updateSVGVisibility:function(){var e;this._webGLMode||(e=this._getVisibilityFree()?this._getVisible():this.viewer.visibleSpace?this._getVisible():!this._getVisible(),this._gNode.setAttributeNS(null,"visibility",e?"visible":"hidden"))},_onLinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.appendChild(this._gNode)},_onUnlinkedToSceneGraph:function(){if(this._webGLMode)return this._parent.apply(this,arguments);this.viewer.svgRoot.removeChild(this._gNode)}})}),define("DS/SceneGraphNodes/InstancedSphereImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedSphereImpostorsNode","DS/DSMigration/DSMigration"],function(e,t){return e}),define("DS/SceneGraphNodes/RectangleLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.RectangleLight(t.color,t.intensity,t.width,t.height,t.mode);return this._rectangleWidth=r.width,this._rectangleHeight=r.height,this._parent(r,i),this},attachToViewpoint:function(e){return null},setRectangleSize:function(e,t){e&&(this._rectangleWidth=e),t&&(this._rectangleHeight=t),this._updateRectangleSize()},_updateRectangleSize:function(){var e,t;this.light3js.width=this._rectangleWidth,this.light3js.height=this._rectangleHeight,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.width=this._rectangleWidth,t.renderable.height=this._rectangleHeight},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"RectangleLightNode3D"}});return UWA.namespace("THREEDS/Nodes/RectangleLight",i)}),define("DS/SceneGraphNodes/BillBoardNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r,a,n,o,s,c,d,h=new e.Projector,l=new e.Vector3,u=new e.Matrix4,p=new e.Matrix4,_=new e.Matrix4,f=e.__visibleInCurrentSpace,m=t.extend({init:function(t){this._parent(t.name),this._isDynamic=!0,this.BillBoardType=t.type,this.constraintAxis=null,t.constraintAxis&&(this.constraintAxis=t.constraintAxis.clone()),t.attachedPoint&&(this.attachedPoint=t.attachedPoint.clone());var i=this,r=e.NoOccurrences;return this.cbChange=function(e){var t;if(!r)if(i.isInstance())for(var a=0;a<i._occurrences.length;a++){var n=(h=i._occurrences[a]).parent;if(h.scene3js&&h.matrix){var o=h.scene3js.viewer;if(f(h._getVisible(),h._getVisibilityFree(),o.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)continue;var s=o.currentViewpoint;if(e){if(!e.viewpoint)return;if((o._viewpointManager.getViewpointScenegraph(e.viewpoint)||o.internalSceneGraph).root3js!=h.scene3js)return}s=h._getViewpoint()||s,t=i._getDynamicMatrix(n.matrix,e,s),h.matrix.multiplyMatrices(n.matrix,t);for(var c=0;c<h.children.length;c++)i._updateOccurrences(h,h.children[c],!0)}}}else{var d=i.parents[0];if(d){var h;if(!(h=d._occurrences[0]).scene3js)return;o=h.scene3js.viewer;if(f(h._getVisible(),h._getVisibilityFree(),o.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)return;s=o.currentViewpoint;if(e){if(!e.viewpoint)return;if((o._viewpointManager.getViewpointScenegraph(e.viewpoint)||o.internalSceneGraph).root3js!=h.scene3js)return}s=h._getViewpoint()||s,t=i._getDynamicMatrix(d.getMatrixWorld(),e,s),i.setMatrix(t)}}}},this.tokenChange=null,this},isPointOfViewDependant:function(){return!0},_linkingClone:function(e){return e=e||new m({name:this.name,type:this.BillBoardType,constraintAxis:this.constraintAxis,attachedPoint:this.attachedPoint}),t.prototype._linkingClone.call(this,e),e},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=i.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)})},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},setBillboardType:function(e){this.BillBoardType=e,this.cbChange()},getNodeType:function(){return"BillBoardNode3D"},_getDynamicMatrix:function(e,t,i){e||(u.identity(),e=u);var r=(i||t.viewpoint).camera,a=r.getLookAt();return a.add(r.position),_.identity(),_.extractRotation(e),"Spherical"===this.BillBoardType?(p.identity(),p.lookAt(r.position,a,r.up)):this._ComputeCylindricalTransform(r,r.position,a,e,"PseudoSpherical"===this.BillBoardType),u.getInverse(_),_.multiplyMatrices(u,p),this._matrix&&_.setPosition(l.getPositionFromMatrix(this._matrix)),_},_ComputeCylindricalTransform:(r=new e.Vector3,a=new e.Vector3,n=new e.Vector3,o=new e.Vector3,s=new e.Vector3,c=new e.Vector3,d=new e.Vector3,function(e,t,i,l,u){if(this.constraintAxis?a.copy(this.constraintAxis).transformDirection(l).normalize():a.set(l.elements[8],l.elements[9],l.elements[10]).normalize(),u){d.getPositionFromMatrix(l),r.subVectors(d,t),c.addVectors(d,a);var _=d.clone();h.projectVector(_,e),h.projectVector(c,e),c.z=_.z,h.unprojectVector(c,e),c.sub(d),c.normalize(),a.copy(c)}else r.subVectors(i,t);if(r.normalize(),n.crossVectors(r,a),n.lengthSq()<1e-10){var f=Math.abs(r.z)<.999?s.set(0,0,1):s.set(1,0,0);n.crossVectors(f,r)}return n.normalize(),o.crossVectors(a,n),o.normalize(),p.set(n.x,o.x,a.x,0,n.y,o.y,a.y,0,n.z,o.z,a.z,0,0,0,0,1),p}),setConstraintAxis:function(e){this.constraintAxis=e}});return UWA.namespace("THREEDS/Nodes/BillBoard",m)}),define("SceneGraphNodes/BillBoardNode3D",["DS/SceneGraphNodes/BillBoardNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/BillBoardNode3D"),e}),define("DS/SceneGraphNodes/TubeLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.TubeLight(t.color,t.intensity,t.radius,t.width,t.mode);return this._radius=r.radius,this._width=r.width,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},setWidth:function(e){e&&(this._width=e),this._updateWidth()},_updateWidth:function(){var e;this.light3js.width=this._width,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.width=this._width},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"TubeLightNode3D"}});return UWA.namespace("THREEDS/Nodes/TubeLight",i)}),define("SceneGraphNodes/TubeLightNode",["DS/SceneGraphNodes/TubeLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/TubeLightNode"),e}),define("DS/SceneGraphNodes/CSS2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({defaultOptions:{},init:function(t,i,r,a){var n=null,o=null,s=null,c=null;t.hasOwnProperty("html")?(n=t.html,o=t.position,s=t.name,c=t.offset):(console.warn("DEPRECATED : create your CSS2DNode with a litteral object"),n=t,o=i,s=r,c=a),o||(o=new e.Vector3),this._parent(s),this._element=n;var d=document.createElement("div");d.appendChild(n),d.style.display="none",d.ondragstart=function(){return!1},this.css2DNode=new e.CSS2DNode(d,o,c),this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),1),this.explicitBBox=null,this.css2DNode.matrixAutoUpdate=!1,this.css2DNode.applyMatrix((new e.Matrix4).setPosition(o)),this._alwaysOnTopIndex=null;var h=this._occurrences[0];return h.renderable=this.css2DNode,h.renderable.name=this.name,h.renderable._occurrence=h,document.getElementById("divCss2DElement")&&document.getElementById("divCss2DElement").appendChild(this.css2DNode.element),this.setMatrix(this.css2DNode.matrix),this.rank=0,this.vanish=!1,this},setPickability:function(e){this.css2DNode.element.style.pointerEvents=e?"auto":"none"},getElement:function(){return this._element},add:function(){return!1},getNodeType:function(){return"CSS2DNode"},setOffset:function(t){t instanceof e.Vector2&&(this.css2DNode.offset=t.clone(),this._occurrences[0].node.css2DNode.offset=this.css2DNode.offset)},getOffset:function(){return this.css2DNode.offset},setAlwaysOnTopIndex:function(e){this._alwaysOnTopIndex=e},getAlwaysOnTopIndex:function(){return this._alwaysOnTopIndex},updatePosition:function(){var t=this._getViewer();if(t){var i=this.css2DNode,r=t.canvas,a=t.currentViewpoint.camera,n=new e.Vector3;if(n.copy(this.css2DNode.position),a.getLookAt().dot(a.position.clone().sub(n))<0){(new e.Projector).projectVector(n,a),i.element.style.display="block";var o=e.getDevicePixelRatio()||1,s=i.offset.x/o,c=i.offset.y/o;i.element.style.left=s+.5*(n.x+1)*r.clientWidth+"px",i.element.style.top=c-.5*(n.y-1)*r.clientHeight+"px"}else i.element.style.display="none"}},clone:function(){return new THREEDS.Nodes.CSS2DNode(this.css2DNode.element,this.css2DNode.position,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS2DNode",i)}),define("SceneGraphNodes/CSS2DNode",["DS/SceneGraphNodes/CSS2DNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNode"),e}),define("DS/SceneGraphNodes/FixedSizeNode3D",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events"],function(e,t,i){"use strict";var r=new e.Vector3,a=new e.Matrix4,n=new e.Matrix4,o=e.__visibleInCurrentSpace,s=t.extend({init:function(t){var i;arguments.length>1?(console.error("[WARNING] DEPRECATED FixedSizeNode3D construction: "+(new Error).stack),i={name:arguments[0],ratio:arguments[1],cameraName:arguments[3]}):i=t||{},this._parent(i.name),this.cameraName=i.cameraName||"camera",this._isDynamic=!0,this._autoUpdate=!0,this.invariantPoint=i.invariantPoint||null,this.ratio=i.ratio,this.scaleFactor=1,this.scaleFactorPerOcc=[];var r=this,a=e.NoOccurrences;return this.cbChange=function(e){if(!a)if(r.isInstance())for(var t=0;t<r._occurrences.length;t++){var i=(h=r._occurrences[t]).parent;if(h.scene3js&&i){var n=h.scene3js.viewer;if(o(h._getVisible(),h._getVisibilityFree(),n.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&n!==e.viewpoint.viewer)continue;var s=n.currentViewpoint;if(e){if(!e.viewpoint)return;if((n._viewpointManager.getViewpointScenegraph(e.viewpoint)||n.internalSceneGraph).root3js!=h.scene3js)return}s=h._getViewpoint()||s;var c=r._getDynamicMatrix(i.matrix,e,s,t);h.matrix.multiplyMatrices(i.matrix,c);for(var d=0;d<h.children.length;d++)r._updateOccurrences(h,h.children[d],!0,!0)}}}else{var h,l=r.parents[0];if(!l)return;if(!(h=this._occurrences[0]).scene3js)return;n=h.scene3js.viewer;if(o(h._getVisible(),h._getVisibilityFree(),n.getVisibleSpace(),null,h)){if(e&&e.viewpoint&&e.viewpoint.viewer&&n!==e.viewpoint.viewer)return;s=n.currentViewpoint;if(e){if(!e.viewpoint)return;if((n._viewpointManager.getViewpointScenegraph(e.viewpoint)||n.internalSceneGraph).root3js!=h.scene3js)return}s=h._getViewpoint()||s;c=r._getDynamicMatrix(l.getMatrixWorld(),e,s,0);r.setMatrix(c,!0)}}},this.tokenChange=null,this},_linkingClone:function(e){return e=e||new s({name:this.name,cameraName:this.cameraName,invariantPoint:this.invariantPoint,ratio:this.ratio}),t.prototype._linkingClone.call(this,e),e},setRatio:function(e){e!==this.ratio&&this._invalidateBoundingElements(),this.ratio=e,this.cbChange()},getRatio:function(){return this.ratio},setInvariantPoint:function(e){this.invariantPoint=e,this.cbChange()},getInvariantPoint:function(){return this.invariantPoint},getScaleFactor:function(e){return e>=0?this.scaleFactorPerOcc[e]:this.scaleFactor},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},e=>{this._autoUpdate&&"@onViewpointChange"===e.eventType&&this.cbChange(e)})},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(t,i,o,s){t||(a.identity(),t=a);var c=o||i.viewpoint,d=c[this.cameraName];this._matrix?n.multiplyMatrices(t,this._matrix):n.copy(t);var h=n.getMaxScaleOnAxis();this.invariantPoint?r.copy(this.invariantPoint):r.getPositionFromMatrix(n);var l=h/d.getWorldSizeFromPixelSize(1,r,c.viewer._getDivClientHeight(),1)/this.ratio,u=0!==l?1/l:1;if(u||(u=1),a.makeScale(u,u,u),this.scaleFactor=(this._matrix?this._matrix.getMaxScaleOnAxis():1)*u,this.scaleFactorPerOcc[s||0]=this.scaleFactor,this._matrix)return n.multiplyMatrices(this._matrix,a),n;if(this.invariantPoint){let t=(new e.Vector3).copy(this.invariantPoint);t.multiplyScalar(1-this.scaleFactor),a.setPosition(t)}return a},setCameraName:function(e){this.cameraName=e||"camera"}});return UWA.namespace("THREEDS/Nodes/FixedSizeNode3D",s)}),define("SceneGraphNodes/FixedSizeNode3D",["DS/SceneGraphNodes/FixedSizeNode3D","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/FixedSizeNode3D"),e}),define("DS/SceneGraphNodes/InstancedCurvedPipeManager",["DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils"],function(e,t){"use strict";var i,r,a={maxTextureSize:-1,maxTextureTotalSize:-1,isInit:!1,init:function(){if(!this.isInit){var e=debugWebGLV6Viewer.renderer.renderer.context;this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxTextureTotalSize=this.maxTextureSize*this.maxTextureSize,this.isInit=!0}}},n=function(e,t){for(var i=t||1;i<e;)i*=2;return i},o=(i=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0]),(r=new e.DataTexture(i,3,1,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,r.magFilter=e.NearestFilter,r.generateMipmaps=!1,r.flipY=!1,r.needsUpdate=!0,r),s=function(e){var t=e.x,i=e.y,r=e.z,a=Math.abs(t)+Math.abs(i)+Math.abs(r),n=t/a,o=i/a;if(r<0){var s=(1-Math.abs(o))*(n>=0?1:-1),c=(1-Math.abs(n))*(o>=0?1:-1);n=s,o=c}return 4096*(n=Math.round(4095*(.5*n+.5)))+(o=Math.round(4095*(.5*o+.5)))},c=0,d=1,h=2,l={_VSGlobal:["#define NB_CURVES_MAPS_MAX 2","#define NB_CURVES_MAPS 1","#define NB_MATRICES_MAPS 1","#define PI2 6.28318530718","vec3 cp_objectPosition;","vec3 cp_objectNormal;","vec3 cp_infosUV;","mat4 _curveModelMatrix;","float cp_radius;","vec3 decompressVector(in float iVec) {","return decodeOct24Normal(iVec);","}","vec4 getCurveData(float iId, float iMaxMapTotalSize, float iLAST_CURVES_MAP_SIZE_X, float iLAST_CURVES_MAP_SIZE_Y) {","int texId = int(floor(iId/iMaxMapTotalSize));","float idInTexture = iId - float(texId)*iMaxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_CURVES_MAPS) - 1) {","dx = 1.0 / iLAST_CURVES_MAP_SIZE_X;","dy = 1.0 / iLAST_CURVES_MAP_SIZE_Y;","y = floor(idInTexture/iLAST_CURVES_MAP_SIZE_X);","x = idInTexture - y*iLAST_CURVES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","vec4 curveData;","for (int i = 0; i < NB_CURVES_MAPS; i++) {","if (texId == i) {","curveData = texture2D( curvesMaps[i], xy);","}","}","return curveData;","}","","void computeMatrixAndRadius() {","float _idInMatricesMap = specialMeshIds.x;","float LAST_MATRICES_MAP_SIZE_X = curvesMatricesProperties.x;","float LAST_MATRICES_MAP_SIZE_Y = curvesMatricesProperties.y;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","int texId = int(floor(_idInMatricesMap/maxMapTotalSize));","float idInTexture = _idInMatricesMap - float(texId)*maxMapTotalSize;","float dx, dy, x, y;","if (texId == int(NB_MATRICES_MAPS) - 1) {","dx = 1.0 / LAST_MATRICES_MAP_SIZE_X;","dy = 1.0 / LAST_MATRICES_MAP_SIZE_Y;","y = floor(idInTexture/LAST_MATRICES_MAP_SIZE_X);","x = idInTexture - y*LAST_MATRICES_MAP_SIZE_X;","} else {","dx = 1.0 / MAX_TEXTURE_SIZE;","dy = 1.0 / MAX_TEXTURE_SIZE;","y = floor(idInTexture/MAX_TEXTURE_SIZE);","x = idInTexture - y*MAX_TEXTURE_SIZE;","}","vec2 xy = vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) );","_curveModelMatrix[3].w = 1.0;","for (int i = 0; i < NB_MATRICES_MAPS; i++) {","if (texId == i) {","vec4 tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 0.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[0].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 1.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[1].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 2.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[2].xyz = tmp.xyz;","tmp = texture2D( curvesMatrices[i], vec2( dx * ( x + 3.5 ), dy * ( y + 0.5 ) ));","_curveModelMatrix[3].xyz = tmp.xyz;","cp_radius = tmp.w;","}","}","}"].join("\n"),_VSOverridables:{ComputeCommonValues:["void ComputeCommonValues() {","vec3 infos = vGetAttribPosition();","cp_infosUV = infos;","float LAST_CURVES_MAP_SIZE_X = curvesMapsProperties.x;","float LAST_CURVES_MAP_SIZE_Y = curvesMapsProperties.y;","float _idInCurvesMaps = specialMeshIds.y;","float curvePointId = _idInCurvesMaps + infos.x;","float nextCurvePointId = curvePointId + 1.0;","float precCurvePointId = curvePointId - 1.0;","float maxMapTotalSize = MAX_TEXTURE_SIZE*MAX_TEXTURE_SIZE;","vec4 curveData = getCurveData(curvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 nextCurveData = getCurveData(nextCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec4 precCurveData = getCurveData(precCurvePointId, maxMapTotalSize, LAST_CURVES_MAP_SIZE_X, LAST_CURVES_MAP_SIZE_Y);","vec3 curvePoint = curveData.xyz;","vec3 u = decompressVector(curveData.w);","vec3 nextCurvePoint = nextCurveData.xyz;","vec3 precCurvePoint = precCurveData.xyz;","computeMatrixAndRadius();","float angle = infos.y;","vec3 localPosition = vec3(cos(angle), sin(angle), 0.0);","vec3 t = normalize(nextCurvePoint - precCurvePoint);","vec3 v = cross(t, u);","cp_objectPosition = curvePoint + cp_radius*normalize(localPosition.x*u + localPosition.y*v);","bool isCap = infos.z > 0.3;","float isFirstSign = infos.z > 0.7 ? 1.0 : -1.0;","cp_objectNormal = isCap ? isFirstSign*t : normalize(cp_objectPosition - curvePoint);","}"].join("\n"),ProcessViewTangentSpace:["void ProcessViewTangentSpace(inout TangentSpace ioWorldViewTS) {","mat4 curveMVMatrix = vGetViewMatrix()*_curveModelMatrix;","ioWorldViewTS.Position = vec3(curveMVMatrix*vec4(cp_objectPosition, 1.0));","ioWorldViewTS.Normal = vec3(curveMVMatrix*vec4(cp_objectNormal, 0.0));","}"].join("\n"),ComputeObjectTexCoord0:["vec4 ComputeObjectTexCoord0() {","return vec4(cp_infosUV.x / 16.0, cp_infosUV.y / PI2, 0.0, 0.0);","}"].join("\n")}},u=function(){this._ranges=[]};u.prototype.addID=function(e){if(!(e<0)){var t=this._ranges;if(0!==t.length){for(var i=t.length,r=null,a=0;a<i;){if(e>=(r=t[a]).min&&e<=r.max)return;if(e===r.min-1)return r.min=e,void(a>0&&t[a-1].max===e-1&&(t[a-1].max=r.max,t.splice(a,1)));if(e===r.max+1)return r.max=e,void(a<i-1&&t[a+1].min===e+1&&(r.max=t[a+1].max,t.splice(a+1,1)));a++}if(e<t[0].min)t.splice(0,0,{min:e,max:e});else if(e>t[i-1].max)t.splice(i,0,{min:e,max:e});else for(var n=0;n<i;n++)if(e<(r=t[n]).min)return void t.splice(n,0,{min:e,max:e})}else t.push({min:e,max:e})}},u.prototype.getAvailableID=function(){var e=this._ranges;if(0===e.length)return 0;var t=e[0];return t.min>0?t.min-1:t.max+1},u.prototype.getTotalNumberOfIDs=function(){var e=this._ranges;return 0===e.length?0:e[e.length-1].max+1},u.prototype.getTotalNumberOfIDsNextPowerOfTwo=function(){return n(this.getTotalNumberOfIDs())},u.prototype.removeID=function(e){var t=this._ranges;if(0!==t.length)for(var i=t.length,r=null,a=0;a<i;a++){if(e===(r=t[a]).min)return void(r.min===r.max?t.splice(a,1):r.min++);if(e===r.max)return void r.max--;if(e>r.min&&e<r.max){var n={min:e+1,max:r.max};return r.max=e-1,void t.splice(a+1,0,n)}}},u.prototype.getNbRanges=function(){return this._ranges.length};var p=function(t,i,r,a){this._LODSags=a,this._nbLODs=this._LODSags.length,this._nbCurvePoints=0===t?2:Math.pow(2,t-1)+1,this._nbCurvePointsPlus2=2+this._nbCurvePoints,this._sag=r,this._isCaps=i,this._LODGeometries=[];for(var n=0;n<this._nbLODs;n++)this._LODGeometries.push(this._buildLODGeometry(this._LODSags[n]));var o=Math.random(),s=Math.random(),d=Math.random();this._debugColor=(new e.Color).setRGB(o,s,d),this._nbUsed=0,this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._realMaps=[],this._curvesMapsProperties=new e.Vector3(128,2,1),this._updateCurvesMapsStatus=c,this._idsRanges=new u,this.materials={}};p.prototype._buildLODGeometry=function(i){var r=new e.BufferGeometryDS;r.sharedBuffers=!0;var a=i,n=this._nbCurvePoints;r.drawingGroups=[];for(var o=this._isCaps?6*(a-2):6*a*(n-1),s=this._isCaps?1:0,c=n*a,d=new Float32Array(3*c),h=0,l=1,u=0;u<n;u++){for(var p=0;p<a;p++)d[h++]=l,d[h++]=p/a*2*Math.PI,d[h++]=s?u>0?1:.5:0;l++}r.vertexPositionArray=d;var _=new Uint16Array(o),f=0;if(this._isCaps){for(p=0;p<a-2;p++)_[f++]=0,_[f++]=p+2,_[f++]=p+1;for(p=0;p<a-2;p++)_[f++]=a,_[f++]=a+p+1,_[f++]=a+p+2}else{var m=0,g=0,v=0,x=0,w=0;for(p=0;p<a;p++)for(u=0;u<n-1;u++)m=(w=u*a)+p,g=w+(p+1)%a,v=w+p+a,x=p===a-1?w+a:(w+p+a+1)%c,_[f++]=m,_[f++]=g,_[f++]=v,_[f++]=g,_[f++]=x,_[f++]=v}r.vertexIndexArray=_;var S=new t.DrawingGroup(null,null,4,0,o);return S._geomType=e.GeomTypeEnum.FACE,S.geometry=r,r.drawingGroups.push(S),r};new e.Vector3;var _=new e.Vector3,f=new e.Vector3;new e.Vector3;p.prototype._addCurvedPipe=function(t,i,r,a,n,o,s){var c=e.InstancedCurvedPipeManager;0===a?_.set(r[a+3]+o.x,r[a+4]+o.y,r[a+5]+o.z):_.set(r[a-3],r[a-2],r[a-1]),n===r.length?f.set(r[n-6]+s.x,r[n-5]+s.y,r[n-4]+s.z):f.set(r[n],r[n+1],r[n+2]);var d=this._idsRanges.getAvailableID();this._idsRanges.addID(d);var h=4*d*(2+this._nbCurvePoints),l=this._updateMapSize();this._curvesData[h++]=_.x,this._curvesData[h++]=_.y,this._curvesData[h++]=_.z,this._curvesData[h++]=a>0?c._compressedSideVectors_tmp[(a-3)/3]:0;for(var u=a;u<n;u+=3)this._curvesData[h++]=r[u],this._curvesData[h++]=r[u+1],this._curvesData[h++]=r[u+2],this._curvesData[h++]=c._compressedSideVectors_tmp[u/3];return this._curvesData[h++]=f.x,this._curvesData[h++]=f.y,this._curvesData[h++]=f.z,this._curvesData[h++]=n<r.length?c._compressedSideVectors_tmp[(n+3)/3]:0,this._updateMapData(l),d},p.prototype._removeCurvedPipe=function(e){if(0!==this._idsRanges.getNbRanges()){this._updateCurvesMapsStatus=d;var t=this._idsRanges.getTotalNumberOfIDs();this._idsRanges.removeID(e),t!==this._idsRanges.getTotalNumberOfIDs()&&(this._updateCurvesMapsStatus=c),this._nbUsed--}},p.prototype._resetMapsInfos=function(){this._curvesData=new Float32Array(1024),this._curvesMaps=[],this._curvesMapsProperties.set(128,2,1)},p.prototype._updateMapSize=function(){var e=this._idsRanges.getTotalNumberOfIDs()*(this._nbCurvePoints+2),t=Math.sqrt(e),i=n(t,128),r=n(e/i,2),a=this._reallocateMap(i,r);return this._curvesMapsProperties.x=i,this._curvesMapsProperties.y=r,a},p.prototype._updateMapData=function(t){this._curvesMaps=[],this._curvesMapsProperties.z=1;var i=this._realMaps[0];i?(i.image.width=this._curvesMapsProperties.x,i.image.height=this._curvesMapsProperties.y,t&&(i.image.data=this._curvesData)):((i=new e.DataTexture(this._curvesData,this._curvesMapsProperties.x,this._curvesMapsProperties.y,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,i.magFilter=e.NearestFilter,i.generateMipmaps=!1,i.flipY=!1,this._realMaps.push(i)),this._curvesMaps.push(i),i.needsUpdate=!0;for(var r=2-this._curvesMaps.length,a=0;a<r;a++)this._curvesMaps.push(o)},p.prototype._reallocateMap=function(e,t){if(e>this._curvesMapsProperties.x||t>this._curvesMapsProperties.y){for(var i=4*this._curvesMapsProperties.x*this._curvesMapsProperties.y,r=new Float32Array(4*e*t),a=0;a<i;a++)r[a]=this._curvesData[a];return this._curvesData=r,!0}return!1},p.prototype._initCurvesMaps=function(e){return!0};var m=function(){this._LODSags=[6,8,10,12,14,16],this._nbLODs=this._LODSags.length,this._instancingGroups=[];for(var t=0;t<33;t++)this._instancingGroups.push(null);this._perRenderableData=new Map,this._geometryToInstancingGroup=new Map,this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties=new e.Vector3,this._matrixRanges=new u,this._matricesMaps=[],this._realMaps=[],this._updateMatricesMapsStatus=c,this._compressedSideVectors_tmp=[],this._capsPoints_tmp=new Array(6),this.pipesToRemove=[],this._debugNbPipes=0,this.debugNbCreatedTextures=0};m.prototype._changeMatricesMapStatus=function(e){this._updateMatricesMapsStatus!==c&&(this._updateMatricesMapsStatus=e)},m.prototype._initMatricesMap=function(){if(this._updateMatricesMapsStatus!==h){if(this._updateMatricesMapsStatus===c){a.init(),this._matricesMaps=[];var t=4*this._matrixRanges.getTotalNumberOfIDs(),i=t-Math.floor(t/a.maxTextureTotalSize)*a.maxTextureTotalSize,r=Math.sqrt(i),s=n(r,128),l=n(i/s,2);this._curvesMatricesProperties.x=s,this._curvesMatricesProperties.y=l;var u=Math.max(1,Math.ceil(t/a.maxTextureTotalSize));this._curvesMatricesProperties.z=u;var p=a.maxTextureTotalSize,_=a.maxTextureSize,f=4*((u-1)*p+s*l);this._matricesFloat32Array=new Float32Array(f),this._matricesFloat32Array.set(this._matricesJSArray,0);for(var m,g=this._matricesFloat32Array,v=0,x=0;x<u-1;x++)(m=this._realMaps[v])?(m.image.width=_,m.image.height=_,m.image.data=g.subarray(x*p*4,(x+1)*p*4)):((m=new e.DataTexture(g.subarray(x*p*4,(x+1)*p*4),_,_,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,m.magFilter=e.NearestFilter,m.generateMipmaps=!1,m.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(m)),this._matricesMaps.push(m),m.needsUpdate=!0,v++;(m=this._realMaps[v])?(m.image.width=s,m.image.height=l,m.image.data=g.subarray((u-1)*p*4,f)):((m=new e.DataTexture(g.subarray((u-1)*p*4,f),s,l,e.RGBAFormat,e.FloatType)).minFilter=e.NearestFilter,m.magFilter=e.NearestFilter,m.generateMipmaps=!1,m.flipY=!1,this.debugNbCreatedTextures++,this._realMaps.push(m)),this._matricesMaps.push(m),m.needsUpdate=!0;for(var w=2-this._matricesMaps.length,S=0;S<w;S++)this._matricesMaps.push(o);return this._updateMatricesMapsStatus=h,!0}if(this._updateMatricesMapsStatus===d){this._matricesFloat32Array.set(this._matricesJSArray,0);for(var b=this._matricesFloat32Array,y=this._matricesMaps.length,M=0,T=0;T<y;T++){var P=this._matricesMaps[T].image,D=P.width*P.height;M+D>b.length||P.data.set(b.subarray(M,D),0),M+=D,this._matricesMaps[T].needsUpdate=!0}this._updateMatricesMapsStatus=h}}return!1},m.prototype.addCurvedPipe=function(e,t,i,r,a,n,o){var s=this._LODSags[this._LODSags.length-1],h=e.id+"_"+t;this._debugNbPipes++,this.computeCompressedSideVectors(r,o,n);var l=4*this._matrixRanges.getAvailableID(),u=this._perRenderableData.get(h);u||(u=[],this._perRenderableData.set(h,u));for(var _=this._instancingGroups,f=r.length/3,m=f-1,g=1,v=0,x=this._LODSags.length;0!==m;){if(m%2==1){if(!_[g]){_[g]=new p(g,!1,s,this._LODSags);for(var w=0;w<x;w++)this._geometryToInstancingGroup.set(_[g]._LODGeometries[w].id,_[g])}_[g]._nbUsed++;var S=3*(Math.pow(2,g-1)+1),b=_[g]._addCurvedPipe(h,i,r,v,v+S,a,n);u.push({idInMaps:b,matrixId4:l,bin:g}),v+=S-3}g++,m>>=1}if(!_[g=0]){_[g]=new p(g,!0,s,this._LODSags);for(w=0;w<x;w++)this._geometryToInstancingGroup.set(_[g]._LODGeometries[w].id,_[g])}_[g]._nbUsed++;S=6;this._capsPoints_tmp[0]=r[0],this._capsPoints_tmp[1]=r[1],this._capsPoints_tmp[2]=r[2],this._capsPoints_tmp[3]=r[3*(f-1)],this._capsPoints_tmp[4]=r[3*(f-1)+1],this._capsPoints_tmp[5]=r[3*(f-1)+2],this._compressedSideVectors_tmp[1]=this._compressedSideVectors_tmp[f-1];b=_[g]._addCurvedPipe(h,i,this._capsPoints_tmp,0,S,a,n);u.push({idInMaps:b,matrixId4:l,bin:g});var y=this._matricesJSArray,M=e.matrixWorld.elements,T=4*l;y[T]=M[0],y[T+1]=M[1],y[T+2]=M[2],y[T+3]=0,y[T+4]=M[4],y[T+5]=M[5],y[T+6]=M[6],y[T+7]=0,y[T+8]=M[8],y[T+9]=M[9],y[T+10]=M[10],y[T+11]=0,y[T+12]=M[12],y[T+13]=M[13],y[T+14]=M[14],y[T+15]=i,this._matrixRanges.addID(l/4);var P=this._matrixRanges.getTotalNumberOfIDs();!this._matricesFloat32Array||16*P>this._matricesFloat32Array.length?this._changeMatricesMapStatus(c):this._changeMatricesMapStatus(d)},m.prototype.addLinkedCurvedPipe=function(e,t){for(var i=0;i<t.geometry.drawingGroups.length;i++){var r=this._perRenderableData.get(t.id+"_"+i);r&&this._perRenderableData.set(e.id+"_"+i,r)}},m.prototype.removeCurvedPipe=function(e,t){e&&this.pipesToRemove.push(e);for(var i=[],r=0;r<this.pipesToRemove.length;r++){var a=this.pipesToRemove[r];if(0===Object.keys(a._tokens).length){this._debugNbPipes-=t._pipes.length;for(var n=0;n<a.geometry.drawingGroups.length;n++){var o=a.id+"_"+n,s=this._perRenderableData.get(o);s&&this._removeCurvedPipe(s,o)}a._flagAsGSSOInvalidated()}else i.push(a)}this.pipesToRemove=i},m.prototype._removeCurvedPipe=function(e,t){for(var i=this._instancingGroups,r=this._matrixRanges.getTotalNumberOfIDs(),a=e.length,n=this._nbLODs,o=0;o<a;o++){var s=e[o],h=s.bin;if(i[h]&&(i[h]._removeCurvedPipe(s.idInMaps),0===i[h]._nbUsed)){for(var l=0;l<n;l++)this._geometryToInstancingGroup.delete(i[h]._LODGeometries[l].id);i[h]=null}this._matrixRanges.removeID(s.matrixId4/4)}if(this._perRenderableData.delete(t),this._changeMatricesMapStatus(d),0!==this._matrixRanges.getNbRanges()){var u=this._matrixRanges.getTotalNumberOfIDs();r!==u&&(this._changeMatricesMapStatus(c),this.resetMapsInfos()),this._matricesJSArray.length=16*u}},m.prototype.resetMapsInfos=function(){this._matricesJSArray=[],this._matricesFloat32Array=null,this._curvesMatricesProperties.set(0,0,0),this._matricesMaps=[]},m.prototype.computeCompressedSideVectors=function(t,i,r){var a=0,n=(new e.Vector3).copy(i),o=s(n);this._compressedSideVectors_tmp[a++]=o;for(var c=new e.Vector3,d=new e.Vector3,h=new e.Vector3,l=new e.Vector3,u=t.length/3,p=1;p<u;p++){p===u-1?c.copy(r).normalize():(h.set(t[3*(p-1)],t[3*(p-1)+1],t[3*(p-1)+2]),l.set(t[3*(p+1)],t[3*(p+1)+1],t[3*(p+1)+2]),c.subVectors(l,h).normalize());var _=n.dot(c);c.multiplyScalar(_),d.subVectors(n,c).normalize(),this._compressedSideVectors_tmp[a++]=s(d),n=d}};e.glStates;return m.prototype.setMatrixOnCurvedPipe=function(e){for(var t=0;t<e.geometry.drawingGroups.length;t++){var i=e.id+"_"+t,r=this._perRenderableData.get(i);r&&this._setMatrixOnCurvedPipe(r,e)}},m.prototype._setMatrixOnCurvedPipe=function(e,t){var i=e[0].matrixId4,r=this._matricesJSArray,a=t.matrixWorld.elements,n=4*i;r[n]=a[0],r[n+1]=a[1],r[n+2]=a[2],r[n+4]=a[4],r[n+5]=a[5],r[n+6]=a[6],r[n+8]=a[8],r[n+9]=a[9],r[n+10]=a[10],r[n+12]=a[12],r[n+13]=a[13],r[n+14]=a[14],this._changeMatricesMapStatus(d)},m.prototype.setPDSFXParamsOnMaterial=function(e){e.activatePDSFX(),e.setPDSFXGlobalShaderCode(l._VSGlobal,"");var t={curvesMaps:{type:"t2v",value:null,length:2},curvesMapsProperties:{type:"v3",value:null},curvesMatrices:{type:"t2v",value:null,length:2},curvesMatricesProperties:{type:"v3",value:null}};e.setPDSFXUniforms(t);e.setPDSFXVaryings({debugColor:{type:"v3"}}),e.setPDSFXVaryings,e.setPDSFXAttributes({specialMeshIds:{type:"v2",instancing:!0},specialMeshPicking:{type:"v3",instancing:!0}}),e.setPDSFXOverridableFunctions(l._VSOverridables,{})},e.InstancedCurvedPipeManager=new m,e.InstancedCurvedPipeManager}),define("SceneGraphNodes/InstancedCurvedPipeManager",["DS/SceneGraphNodes/InstancedCurvedPipeManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/InstancedCurvedPipeManager"),e}),define("DS/SceneGraphNodes/DiskLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.DiskLight(t.color,t.intensity,t.radius,t.mode);return this._radius=r.radius,this._parent(r,i),this},setRadius:function(e){e&&(this._radius=e),this._updateRadius()},_updateRadius:function(){var e;this.light3js.radius=this._radius,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.radius=this._radius},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DiskLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DiskLightNode",i)}),define("SceneGraphNodes/DiskLightNode",["DS/SceneGraphNodes/DiskLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/DiskLightNode"),e}),define("DS/SceneGraphNodes/InstancedCylinderImpostorsNode",["DS/AdvancedSceneGraphNodes/InstancedCylinderImpostorsNode","DS/DSMigration/DSMigration"],function(e,t){return e}),define("DS/SceneGraphNodes/CSS3DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i,r){this._parent(r),this.scale=i||1,this.css3DNode=new e.CSS3DNode(t);var a=this.createRenderable(),n=t.style.width;n=n.substring(0,n.length-2);var o=t.style.height;o=o.substring(0,o.length-2);var s=.5*i*Math.sqrt(n*n+o*o);this.hasExplicitBE=!0,this.explicitBSphere=new e.Sphere(new e.Vector3(0,0,0),s),this.explicitBBox=null,a.matrixAutoUpdate=!1,a.visible=this.css3DNode.visible;var c=this._occurrences[0];return c.renderable=a,c.renderable.name=this.name,c.renderable._occurrence=c,c.renderable.scaleCSS=(new e.Matrix4).scale(new e.Vector3(this.scale,this.scale,this.scale)),document.getElementById("camera")&&document.getElementById("camera").appendChild(this.css3DNode.element),this},createRenderable:function(){var t=new e.CSS3DNode(this.css3DNode.element);return t.matrixAutoUpdate=!1,t.matrixWorldNeedsUpdate=!1,t.pickable=!0,t.visible=this.css3DNode.visible,t},setPickability:function(e){this.css3DNode.element.style.pointerEvents=e?"auto":"none"},add:function(){return!1},getNodeType:function(){return"CSS3DNode"},clone:function(){var t=new e.CSS3DNode(this.css3DNode.element);return new THREEDS.Nodes.CSS3DNode(t.element,this.name)}});return UWA.namespace("THREEDS/Nodes/CSS3DNode",i)}),define("SceneGraphNodes/CSS3DNode",["DS/SceneGraphNodes/CSS3DNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS3DNode"),e}),define("DS/SceneGraphNodes/DirectionalLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});let r=null;return(r=t.light?t.light:new e.DirectionalLight(t.color,t.intensity))._sceneShadow=null==t.sceneShadow||t.sceneShadow,t.target?(r.target=new e.Object3D,r.target.position=t.target,r._sceneShadow=t.sceneShadow):r.target=null,this._previousTarget=r.target,this._direction=null,this._parent(r,i,null),this},setShadowOptions:function(e){if(e){var t=this._occurrences.length,i=!1,r=null!=e.sceneShadow?e.sceneShadow:this.light3js._sceneShadow;e.bias&&(this.light3js.shadowBias=e.bias),e.left&&(this.light3js.shadowCameraLeft=e.left,r=!1),e.right&&(this.light3js.shadowCameraRight=e.right,r=!1),e.bottom&&(this.light3js.shadowCameraBottom=e.bottom,r=!1),e.top&&(this.light3js.shadowCameraTop=e.top,r=!1),e.near&&(this.light3js.shadowCameraNear=e.near,r=!1),e.far&&(this.light3js.shadowCameraFar=e.far,r=!1),e.darkness&&(this.light3js.shadowDarkness=e.darkness),e.mapWidth&&(this.light3js.shadowMapWidth=e.mapWidth,i=!0),e.mapHeight&&(this.light3js.shadowMapHeight=e.mapHeight,i=!0),this.light3js._sceneShadow=r,this.light3js.shadowMap&&i&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0);for(var a=0;a<t;a++){var n=this._occurrences[a].renderable;if(e){i=!1;e.bias&&(n.shadowBias=e.bias),e.left&&(n.shadowCameraLeft=e.left),e.right&&(n.shadowCameraRight=e.right),e.bottom&&(n.shadowCameraBottom=e.bottom),e.top&&(n.shadowCameraTop=e.top),e.near&&(n.shadowCameraNear=e.near),e.far&&(n.shadowCameraFar=e.far),e.darkness&&(n.shadowDarkness=e.darkness),e.mapWidth&&(n.shadowMapWidth=e.mapWidth,i=!0),e.mapHeight&&(n.shadowMapHeight=e.mapHeight,i=!0),n._sceneShadow=this.light3js._sceneShadow,n.shadowMap&&i&&(n.shadowMap.dispose(),n.shadowMap=null,n.updateShadowMap=!0)}}}},castShadows:function(e,t){var i=this._occurrences.length;if(e){this.light3js.castShadow=!0;for(var r=0;r<i;r++)this._occurrences[r].renderable.castShadow=!0,this.setShadowOptions(t)}else{this.light3js.castShadow=!1;for(r=0;r<i;r++)this._occurrences[r].renderable.castShadow=!1}},_castGroundShadows:function(e){this.light3js.castGroundShadow=e,this.light3js.onlyShadow=!0;for(var t=0;t<this._occurrences.length;t++)this._occurrences[t].renderable.castGroundShadow=e,this._occurrences[t].renderable.onlyShadow=!0},attachToViewpoint:function(e){if(this._attachedToVpt!=e){var t=this._occurrences.length;if(e){this.light3js.target=null;for(i=0;i<t;i++)this._occurrences[i].renderable.target=null}else{this.light3js.target=this._previousTarget;for(var i=0;i<t;i++)this._occurrences[i].renderable.target=this._previousTarget}}this._attachedToVpt=e},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var r=this._occurrences.length,a=0;a<r;a++)this._occurrences[a].renderable.target=i},setDirection:function(t,i){i=i||new e.Vector3(0,0,1);let r=(new e.Vector3).crossVectors(t,i);r.normalize();let a=t.angleTo(i),n=(new e.Matrix3).makeRotationAxis(r,a),o=this.getMatrix(),s=o.clone();s.setRotation(n.elements),s.equals(o)||this.setMatrix(s)},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"DirectionalLightNode3D"}});return UWA.namespace("THREEDS/Nodes/DirectionalLight",i)}),define("SceneGraphNodes/DirectionalLightNode",["DS/SceneGraphNodes/DirectionalLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/DirectionalLightNode"),e}),define("DS/SceneGraphNodes/PolyLineSectionUtils",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t={makeClosedPolyLine:function(t,i,r){var a=new e.Vector3;a.subVectors(i.center,t.planeOrigin);var o,s,c=new e.Vector2(a.dot(t.planeU),a.dot(t.planeV)),d={xmin:c.x-i.radius,ymin:c.y-i.radius,xmax:c.x+i.radius,ymax:c.y+i.radius};for(o=0;o<t.polyLinePoints.length;o++)(s=t.polyLinePoints[o]).x<d.xmin&&(d.xmin=s.x),s.x>d.xmax&&(d.xmax=s.x),s.y<d.ymin&&(d.ymin=s.y),s.y>d.ymax&&(d.ymax=s.y);return new n(d,t,r).buildPolyLine()}};function i(t,i,r,a){var n=new e.Vector2;n.subVectors(i,t);var o=new e.Vector2;return o.subVectors(r,a),function(t,i,r,a){var n=i.y,o=-i.x,s=i.x*t.y-i.y*t.x,c=a.y,d=-a.x,h=a.x*r.y-a.y*r.x,l=n*d-o*c;if(0===l)return null;var u=(o*h-s*d)/l,p=-(n*h-s*c)/l;return new e.Vector2(u,p)}(t,n,r,o)}function r(t,i,r){var a=new e.Vector2;a.subVectors(i,t);var n=new e.Vector2;return n.subVectors(r,t),a.dot(n)>=0}function a(t,i,r){var a=new e.Vector2;a.subVectors(i,t);var n=new e.Vector2;n.subVectors(r,t);var o=a.dot(n),s=a.lengthSq();return o>=0||o<=s}var n=function(t,i,r){this.bounds=t,this.points=[],this.normalExtrapolation=r,this.center=new e.Vector2((this.bounds.xmin+this.bounds.xmax)/2,(this.bounds.ymin+this.bounds.ymax)/2),this.polyLine=i;var a,n=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin)];for(a=0;a<n.length;a++)this.addPoint(n[a],"corner")};return n.prototype.addPointFromLine=function(t,n,o,s,c){var d=t,h=n;s&&(d=n,h=new e.Vector2(n.x+c*(t.y-n.y),n.y-c*(t.x-n.x)));var l,u=!1,p=null,_=[new e.Vector2(this.bounds.xmin,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymax),new e.Vector2(this.bounds.xmax,this.bounds.ymin),new e.Vector2(this.bounds.xmin,this.bounds.ymin)];for(l=0;l<_.length-1&&!u;l++)(p=i(d,h,_[l],_[l+1]))&&r(d,h,p)&&a(_[l],_[l+1],p)&&(this.addPoint(p,o),u=!0)},n.prototype.addPoint=function(t,i){var r,a,n,o=new e.Vector2;o.subVectors(t,this.center),o.normalize();var s={point:t,angle:r=(o.y>=0?-1:1)*Math.acos(o.x),tag:i};for(a=0;a<this.points.length&&!n;a++)this.points[a].angle<r&&(this.points.splice(a,0,s),n=!0);n||this.points.push(s)},n.prototype.buildPolyLine=function(){var t=this.polyLine;this.addPointFromLine(new e.Vector2(t.polyLinePoints[1].x,t.polyLinePoints[1].y),new e.Vector2(t.polyLinePoints[0].x,t.polyLinePoints[0].y),"start",this.normalExtrapolation,-1);var i=t.polyLinePoints.length;this.addPointFromLine(new e.Vector2(t.polyLinePoints[i-2].x,t.polyLinePoints[i-2].y),new e.Vector2(t.polyLinePoints[i-1].x,t.polyLinePoints[i-1].y),"end",this.normalExtrapolation,1);var r,a=-1,n=-1;for(r=0;r<this.points.length&&(a<0||n<0);r++)"start"===this.points[r].tag&&(a=r),"end"===this.points[r].tag&&(n=r);if(a<0||n<0)return null;var o={polyLinePoints:[],planeOrigin:t.planeOrigin,planeU:t.planeU,planeV:t.planeV};o.polyLinePoints.push(this.points[a].point);var s=this.normalExtrapolation?0:1;for(r=s;r<t.polyLinePoints.length-s;r++)o.polyLinePoints.push(new e.Vector2(t.polyLinePoints[r].x,t.polyLinePoints[r].y));o.polyLinePoints.push(this.points[n].point);var c=a<n?a+this.points.length:a;for(r=n+1;r<c;r++)o.polyLinePoints.push(this.points[r%this.points.length].point);return o},UWA.namespace("THREEDS/Nodes/PolyLineSectionUtils",t)}),define("DS/SceneGraphNodes/PointLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){t||(t={});var r=t.intensity;void 0===r&&(r=t.power?t.power/(4*Math.PI):1);var a=new e.PointLight(t.color,r,t.distance);return t.physicalAttenuation&&(a.isPhysicallyAttenuated=!0,a.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(a,i,null),this},setPower:function(e){var t=e/(4*Math.PI);this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,t){var r=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var a=0;a<i;a++){var n=this._occurrences[a].renderable;if(n.castShadow=!0,t){r=!1;t.bias&&(n.shadowBias=t.bias),t.near&&(n.shadowCameraNear=t.near),t.far&&(n.shadowCameraFar=t.far),t.darkness&&(n.shadowDarkness=t.darkness),t.mapWidth&&(n.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(n.shadowMapHeight=t.mapHeight,r=!0),n.shadowMap&&r&&(n.shadowMap.dispose(),n.shadowMap=null,n.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(a=0;a<i;a++)this._occurrences[a].renderable.castShadow=!1}},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"PointLightNode3D"}});return UWA.namespace("THREEDS/Nodes/PointLight",i)}),define("SceneGraphNodes/PointLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/PointLightNode"),e}),define("DS/SceneGraphNodes/VoxelVolumeNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(e,t){"use strict";return t.extend({init:function(e,t){return this._parent(t),this.debugMode=!0,e&&this.build(e),this},add:function(){return!1},_nextPowerOf2:function(e,t){for(var i=t||1;i<e;)i*=2;return i},build:function(t){var i,r,a=t.voxelRep,n=(performance.now(),[a.width,a.height,a.depth]),o=new e.Vector3(n[0],n[1],n[2]),s=Math.max(o.x,Math.max(o.y,o.z)),c=this._nextPowerOf2(s,4),d=this._nextPowerOf2(Math.ceil(Math.sqrt(c))),h=c*d,l=null,u=a.bufferData,p=n[0]*n[1]*n[2],_=p%8?Math.floor(p/8)+1:p/8,f=_+(4-_%4)%4;i=(r=new Uint8Array(u.buffer,u.byteOffset+f))[0];var m=0,g=null;if(this.debugMode){g=new Uint32Array(256);for(var v=0;v<256;v++)g[v]=0}l=new Uint8Array(h*h);for(var v=0;v<h*h;v++)l[v]=i;var x=0,w=0,S=0,b=0,y=0,M=[1,2,4,8,16,32,64,128],T=i>0?i:Number.MAX_SAFE_INTEGER,P=i>0?i:0;for(v=0;v<_/4;v++)for(var D=3;D>=0;D--)for(var N=u[4*v+D],C=7;C>=0;C--){if(N&M[C]){var V=r[1+y++],A=(Math.floor(S/d)*c+w)*c*d+S%d*c+x;l[A]=V,V>0&&(V<T&&(T=V),V>P&&(P=V)),this.debugMode&&(g[V]++,m++)}if(++b>=p)break;++x>=n[0]&&(x=0,++w>=n[1]&&(w=0,S++))}this.debugMode&&(g[i]+=n[0]*n[1]*n[2]-m),this.volumeData={tileSetRange:{min:0,max:1},valueRange:{min:T/255,max:P/255},voxelRepartition:g,mapData:{type:"uint8",data:l,width:h,height:h},chunkSize:c,nbCol:d,mapDim:o,_voxelDensity:0}},getNodeType:function(){return"VoxelVolumeNode"}})}),define("DS/SceneGraphNodes/CanvasNodeTexture",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";var a=["map","transparent","alphaTest","force","canvasNodeTextureSize","canvasNodeTextureSaveParams"],n=!0,o=t.extend({init:function(e){this.width=e.width,this.height=e.height,this.longestEdge=this.width>=this.height?"width":"height",this.maxZoom=e.maxZoom||null,this.maxPow=this.maxZoom?Math.floor(Math.log(this.maxZoom)/Math.log(2)):null,this.drawCB=e.drawCB,this.rectangleTexture=e.rectangleTexture||!1,this.viewer=e.webGLV6Viewer,this.alphaTest=e.alphaTest,this.depthWrite=e.depthWrite,this.tick=0,this.materials={},this.lastTexture=null,this._canvas2DTexture=null,this._canvas2DCanvas=null,this.setMaterialParams(e.materialParams)},setMaterialParams:function(e){var t;for(t in this.materialParams=e||{},this.materials)this._updateMaterialWithParams(this.materials[t].material,this.materialParams)},requestRedraw:function(){this._requestRedraw()},_updateMaterialWithParams:function(e,t){var i;if(e.canvasNodeTextureSaveParams)for(i in e.canvasNodeTextureSaveParams)e[i]=e.canvasNodeTextureSaveParams[i];for(i in t)-1===a.indexOf(i)&&(e.canvasNodeTextureSaveParams||(e.canvasNodeTextureSaveParams={}),e.canvasNodeTextureSaveParams[i]=e[i],e[i]=t[i])},startAnimation:function(e,t){this.animationDeltaTime=e,this.tick=-1,this._animationStep(t)},_animationStep:function(e){this.tick++,this.requestRedraw(),e&&e.render(),setTimeout(this._animationStep.bind(this,e),this.animationDeltaTime)},_requestRedraw:function(){var e;for(e in this.materials)this.materials[e].redrawRequested=!0;this._canvas2DTexture&&(this._canvas2DTexture.redrawRequested=!0)},_getCanvas2DTexture:function(){if(!this._canvas2DTexture){var t=document.createElement("canvas");t.width=this.width,t.height=this.height,this._canvas2DTexture=new e.Texture(t,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter),this._canvas2DCanvas=t,this._redrawCanvas2DTexture()}return this._canvas2DTexture},_redrawCanvas2DTexture:function(){this._drawToCanvas(this._canvas2DCanvas,this.width,this.height),this._canvas2DTexture.needsUpdate=!0,this._canvas2DTexture.redrawRequested=!1},_buildMaterial:function(t,i,r,a){var n={};return n.canvas=document.createElement("canvas"),n.canvas.width=i,n.canvas.height=r,o.totalAllocatedTextures+=n.canvas.width*n.canvas.height,n.useCount=0,this._drawToCanvas(n.canvas,i,r),n.texture=new e.Texture(n.canvas,void 0,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.LinearFilter,e.LinearMipMapLinearFilter),n.texture.anisotropy=16,n.texture.needsUpdate=!0,a?(a.map=n.texture,e.cleanDeferredCache(a.id),a.updateDeferredMaterials(),n.material=a):n.material=new e.MeshBasicMaterial({transparent:!0,force:!0,map:n.texture}),void 0!==this.alphaTest&&(n.material.alphaTest=this.alphaTest),void 0!==this.depthWrite&&(n.material.depthWrite=this.depthWrite),n.material.canvasNodeTextureSize=t,this._updateMaterialWithParams(n.material,this.materialParams),n.redrawRequested=!1,n},_drawToCanvas:function(e,t,i){var r=e.getContext("2d");r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,t,i),r.globalAlpha=1;var a=Math.max(t,i)/Math.max(this.width,this.height);r.scale(a,a);var n=null;this.viewer&&this.viewer.renderer&&this.viewer.renderer.renderer&&(n=this.viewer.renderer.renderer),this.drawCB(this,r,this.tick,a,n)},_getNewMaterial:function(e,t){var i=t&&t.canvasNodeTextureSize?t:null,r=e,a=11;null!==this.maxPow&&(a=this.maxPow);if(this.rectangleTexture&&(r=e/this[this.longestEdge],null===this.maxPow)){var s=Math.ceil(Math.log(this[this.longestEdge])/Math.log(2)+.01024);a=Math.max(0,a-s)}var c=Math.ceil(Math.log(r)/Math.log(2)+.01024);c=Math.min(c,a);var d=Math.pow(2,c),h=this.rectangleTexture?Math.floor(d*this.width):d,l=this.rectangleTexture?Math.floor(d*this.height):d;0!==h&&0!==l||(h=16,l=16);var u=i?this.materials[i.canvasNodeTextureSize]:null,p=u?u.canvas.width:0,_=u?u.canvas.height:0;!this.materials[d]&&o.totalAllocatedTextures+h*l-p*_>o.maxAllocatedTextures&&(n&&console.warn("CanvasNodeTexture: max amount of allowed texture allocation has been exceeded"),u?(d=i.canvasNodeTextureSize,h=u.canvas.width,l=u.canvas.height):(d=this.rectangleTexture?1:512,h=this.rectangleTexture?this.width:d,l=this.rectangleTexture?this.height:d));var f,m=this.materials[d];return i&&i.canvasNodeTextureSize===d||(i&&(f=this._releaseMaterial(i)),m||(this.materials[d]=this._buildMaterial(d,h,l,f),m=this.materials[d]),m.useCount++,f&&m.material!==f&&f.dispose()),m&&m.redrawRequested&&(this._drawToCanvas(m.canvas,h,l),m.texture.needsUpdate=!0,m.redrawRequested=!1),m?m.material:null},_releaseMaterial:function(e){if(e.canvasNodeTextureSize){var t=e?this.materials[e.canvasNodeTextureSize]:null;if(t)if(t.useCount--,t.useCount<=0)return o.totalAllocatedTextures-=t.canvas.width*t.canvas.height,(e=this.materials[e.canvasNodeTextureSize].material).map&&(e.map.dispose(),e.map=null),delete this.materials[e.canvasNodeTextureSize],e}return null}});return o.totalAllocatedTextures=0,o.maxAllocatedTextures=16777216,o.enableMemoryWarning=function(e){n=e},o}),define("DS/SceneGraphNodes/Canvas2DNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils"],function(e,t,i,r){"use strict";var a=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture;var r=this.canvasNodeTexture._getCanvas2DTexture(),n=new e.MeshBasicMaterial({transparent:!0,side:e.DoubleSide,force:!0});this.canvas2DMaterial=n,n.activatePDSFX();var o={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},canvas2DTexture:{type:"t2",value:r},highlight:{type:"b",value:!1,stage:e.FragmentStage},angle:{type:"f",value:t.angle||0},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};n.setPDSFXUniforms(o);n.setPDSFXVaryings({_uv:{type:"v2"},screenPosition:{type:"v2"}});var s={ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) { ","  _uv = vGetAttribTexCoord0().xy;","  float dx, dy;","  dx = ioPosition.w * (pixelSize.x*(-hotspot.x + _uv.x*size.x));","  dy = ioPosition.w * (pixelSize.y*(-hotspot.y + _uv.y*size.y));;","  float ratio = pixelSize.x / pixelSize.y;","  ioPosition.x += cos(angle)*dx - sin(angle)*dy*ratio;","  ioPosition.y += sin(angle)*dx/ratio + cos(angle)*dy;","}"].join("\n")},c={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","ioFinalColor = texture2D(canvas2DTexture, _uv);","if (highlight) {","  float norm = length(ioFinalColor.xyz);","  ioFinalColor.xyz = (norm/1.73205)*vec3(0.0, 0.6, 1.0);","}","}"].join("\n"),ComputeDiscard:["bool ComputeDiscard() {","  vec4 color = texture2D(canvas2DTexture, _uv);","  return color.a <= alphaTest;","}"].join("\n"),ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0,0.0,1.0); }"};n.setPDSFXOverridableFunctions(s,c),this.rectangle=a._createRectangle(n,i),this.rectangle.setPrimitivePicking(!1);this.rectangle._occurrences[0].renderable;n._refreshPDSFXUniforms_private=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var a=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/a,2/a)}this.updatePDSFXUniform("pixelSize",r)},this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),this.exludeFromBounding(!0);var d=this;return this.rectangle._setBeforeRenderCB(function(e,t){r.redrawRequested&&d.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setHotspot:function(e){e&&this.canvas2DMaterial.updatePDSFXUniform("hotspot",e.clone())},getHotspot:function(){return this.canvas2DMaterial.getPDSFXUniform("hotspot").value.clone()},setAngle:function(e){this.canvas2DMaterial.updatePDSFXUniform("angle",e)},getAngle:function(){return this.canvas2DMaterial.getPDSFXUniform("angle").value}});return a._createRectangle=function(e,t){var i,a,n,o,s,c,d,h,l,u,p,_,f,m,g;for(10,(i=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,i.lineAttr=new r.LineAttributes,i.pointAttr=new r.PointAttributes,(a=new r.Buffer).size=12,a.component=r.VertexComponentEnum.POSITION,a.format=r.DataTypeEnum.FLOAT,a.dimension=3,a.data=new Float32Array(a.size),(n=new r.Buffer).size=3,n.component=r.VertexComponentEnum.NORMAL,n.format=r.DataTypeEnum.FLOAT,n.dimension=3,n.data=new Float32Array(n.size),(o=new r.Buffer).size=12,o.component=r.VertexComponentEnum.TEX_COORD_0,o.format=r.DataTypeEnum.FLOAT,o.dimension=3,o.data=new Float32Array(o.size),(s=new r.Buffer).indexBuffer=!0,s.size=4,s.format=r.DataTypeEnum.UINT,s.dimension=1,s.data=new Uint16Array(s.size),(c=new r.Buffer).indexBuffer=!0,c.size=4,c.format=r.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(c.size),(d=new r.Buffer).indexBuffer=!0,d.size=4,d.format=r.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(d.size),i.addBuffer(0,a),i.addBuffer(1,n),i.addBuffer(2,s),i.addBuffer(3,c),i.addBuffer(4,o),i.addBuffer(5,d),f=0,(g=s.data)[f++]=0,g[f++]=1,g[f++]=3,g[f++]=2,g=c.data,f=0,m=0;m<1;m++)g[f++]=m,g[f++]=m,g[f++]=m,g[f++]=m;for(f=0,(g=d.data)[f++]=0,g[f++]=1,g[f++]=3,g[f++]=2,g=a.data,f=0,f=0;f<12;f++)g[f]=0;for(f=0,(g=n.data)[f++]=0,g[f++]=0,g[f++]=1,f=0,(g=o.data)[f++]=0,g[f++]=0,g[f++]=0,g[f++]=1,g[f++]=0,g[f++]=0,g[f++]=1,g[f++]=1,g[f++]=0,g[f++]=0,g[f++]=1,g[f++]=0,m=0;m<1;m++)(h=new r.Primitive).nbIndices=4,h.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,h.attr={fill:new r.FillAttributes(new r.Color(1-m/6,0,m/6,1),1),line:new r.LineAttributes,point:new r.PointAttributes},(l=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,l.nbVertices=4,l.nbValuesPerVertex=3,l.format=r.DataTypeEnum.FLOAT,l.cardinality=0,l.bufferId=0,l.indices=new r.IndexArray,l.indices.format=r.DataTypeEnum.UINT,l.indices.bufferId=2,l.indices.offset=4*m,(u=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,u.nbVertices=4,u.nbValuesPerVertex=3,u.format=r.DataTypeEnum.FLOAT,u.cardinality=0,u.bufferId=1,u.indices=new r.IndexArray,u.indices.format=r.DataTypeEnum.UINT,u.indices.bufferId=3,u.indices.offset=4*m,(p=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=r.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=4,p.indices=new r.IndexArray,p.indices.format=r.DataTypeEnum.UINT,p.indices.bufferId=5,p.indices.offset=0,h.addVertexComponent(l),h.addVertexComponent(u),h.addVertexComponent(p),i.addPrimitive(h);return(_=t.createMeshNode(i,e)).setShadow(!1),_},UWA.namespace("THREEDS/Nodes/Canvas2DNode",a)}),define("DS/SceneGraphNodes/SpotLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r,a;t||(t={}),r=void 0!==t.outerAngle&&null!==t.outerAngle?Math.max(Math.min(t.outerAngle,Math.PI),0):Math.PI/2,a=void 0!==t.innerAngle&&null!==t.innerAngle?Math.max(Math.min(t.innerAngle,r-.001),0):r-.001,this._outerAngle=r,this._innerAngle=a;var n=t.intensity;void 0===n&&(n=t.power?t.power/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle)))):1);var o=new e.SpotLight(t.color,n,t.distance,r,a);return t.target?(o.target=new e.Object3D,o.target.position=t.target):o.target=null,this._previousTarget=o.target,t.physicalAttenuation&&(o.isPhysicallyAttenuated=!0,o.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._parent(o,i,null),this},attachToViewpoint:function(t){if(this._attachedToVpt!=t){var i=this._occurrences.length;if(t){this.light3js.target=new e.Object3D,this.light3js.target.position=new e.Vector3(0,0,0);for(r=0;r<i;r++)this._occurrences[r].renderable.target=new e.Object3D,this._occurrences[r].renderable.target.position=new e.Vector3(0,0,0)}else{this.light3js.target=this._previousTarget;for(var r=0;r<i;r++)this._occurrences[r].renderable.target=this._previousTarget}}this._attachedToVpt=t},setTarget:function(t){var i=null;t&&((i=new e.Object3D).position=t);if(this.light3js.target=i,this._previousTarget=i,!this._attachedToVpt)for(var r=this._occurrences.length,a=0;a<r;a++)this._occurrences[a].renderable.target=i},castShadows:function(e,t){var i=this._occurrences.length;if(e){if(this.light3js.castShadow=!0,this.light3js.shadowCameraFov=180*this.light3js.angle/Math.PI*2,t){var r=!1;t.bias&&(this.light3js.shadowBias=t.bias),t.near&&(this.light3js.shadowCameraNear=t.near),t.far&&(this.light3js.shadowCameraFar=t.far),t.darkness&&(this.light3js.shadowDarkness=t.darkness),t.mapWidth&&(this.light3js.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(this.light3js.shadowMapHeight=t.mapHeight,r=!0),this.light3js.shadowMap&&r&&(this.light3js.shadowMap.dispose(),this.light3js.shadowMap=null,this.light3js.updateShadowMap=!0)}for(var a=0;a<i;a++){var n=this._occurrences[a].renderable;if(n.castShadow=!0,n.shadowCameraFov=180*n.angle/Math.PI*2,t){r=!1;t.bias&&(n.shadowBias=t.bias),t.near&&(n.shadowCameraNear=t.near),t.far&&(n.shadowCameraFar=t.far),t.darkness&&(n.shadowDarkness=t.darkness),t.mapWidth&&(n.shadowMapWidth=t.mapWidth,r=!0),t.mapHeight&&(n.shadowMapHeight=t.mapHeight,r=!0),n.shadowMap&&r&&(n.shadowMap.dispose(),n.shadowMap=null,n.updateShadowMap=!0)}}}else{this.light3js.castShadow=!1;for(a=0;a<i;a++)this._occurrences[a].renderable.castShadow=!1}},setAngles:function(e,t,i){if(i)var r=this._intensity*(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));e=null!=e?Math.max(Math.min(e,Math.PI/2),0):Math.PI/2,t=null!=t?Math.max(Math.min(t,e-.001),0):e-.001,this._outerAngle=e,this._innerAngle=t,i&&this.setIntensity(r/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))))),this._updateAngles(),this.updateShadowMap()},_updateAngles:function(){var e,t;this.light3js.angle=this._outerAngle,this.light3js.innerAngle=this._innerAngle,e=this._occurrences.length;for(var i=0;i<e;i++)(t=this._occurrences[i]).renderable.angle=this._outerAngle,t.renderable.innerAngle=this._innerAngle},setPower:function(e){var t=e/(Math.PI*(1-Math.cos(this._outerAngle)+(1-Math.cos(this._innerAngle))));this.setIntensity(t)},setPhysicalAttenuation:function(e){this.light3js.isPhysicallyAttenuated=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.isPhysicallyAttenuated=e},setPhysicalAttenuationScale:function(e){this.light3js.attenuationScale=e;for(var t=this._occurrences.length,i=0;i<t;i++)this._occurrences[i].renderable.attenuationScale=e},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"SpotLightNode3D"}});return UWA.namespace("THREEDS/Nodes/SpotLight",i)}),define("SceneGraphNodes/SpotLightNode",["DS/SceneGraphNodes/PointLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/SpotLightNode"),e}),define("DS/SceneGraphNodes/IESLightNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/LightNode3D"],function(e,t){"use strict";var i=t.extend({init:function(t,i){var r=new e.IESLight(t.color,t.intensity,t.distance,t.texture);return t.physicalAttenuation&&(r.isPhysicallyAttenuated=!0,r.attenuationScale=t.attenuationScale?t.attenuationScale:1e-6),this._texture=t.texture,this._parent(r,i),this},setIESTexture:function(e){this._texture=e,this._updateTexture()},_updateTexture:function(){var e;this.light3js.iesTexture=this._texture,e=this._occurrences.length;for(var t=0;t<e;t++)this._occurrences[t].renderable.iesTexture=this._texture},getNodeType:function(){return"LightNode3D"},getLightNodeType:function(){return"IESLightNode3D"}});return UWA.namespace("THREEDS/Nodes/IESLight",i)}),define("SceneGraphNodes/IESLightNode",["DS/SceneGraphNodes/IESLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/IESLightNode"),e}),define("DS/SceneGraphNodes/Canvas2DInstancingNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/Canvas2DNode"],function(e,t,i,r,a){"use strict";var n=t.extend({init:function(t,i){this._parent(t.name),this.hotspot=t.hotspot||new e.Vector2(0,0),this.canvasNodeTexture=t.canvasNodeTexture,this.texture=this.canvasNodeTexture._getCanvas2DTexture(),this.rectangle=a._createRectangle(null,i),this.rectangle.setFrustumCulled(!1),this.rectangle.setMirror(!1),this.rectangle.setShadow(!1,!1),this.setInstancingParams(t,this.texture),this.addChild(this.rectangle),this.rectangle.setRenderPasses(["canvas2D"]),void 0!==t.excludeFromBounding?this.excludeFromBounding=!!t.excludeFromBounding:this.excludeFromBounding=!0,this.excludeFromBounding?this.exludeFromBounding(!0):this._setupBoundingSphere(t.matrices);var r=this;return this.rectangle._setBeforeRenderCB(function(e,t){r.texture.redrawRequested&&r.canvasNodeTexture._redrawCanvas2DTexture()}),this},excludeFromHighlight:function(e,t){this.rectangle.excludeFromHighlight(e,t)},setInstancingParams:function(e){this.material=this._buildInstancingMaterial(this.texture),this.material.force=!0,this.rectangle.setMaterial(this.material),this._setUpMeshInstancingParameters(this.rectangle,e.nbInstances,e.matrices,e.colors),this.excludeFromBounding||this._setupBoundingSphere(e.matrices)},_buildInstancingMaterial:function(t){var i=new e.MeshBasicMaterial({force:!0,transparent:!0,side:e.DoubleSide});i.activatePDSFX();var r={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ProcessClipSpacePosition:["void ProcessClipSpacePosition(inout vec4 ioPosition) {","vec2 myUv = vGetAttribTexCoord0().xy;","ioPosition.x += ioPosition.w * (pixelSize.x*(-hotspot.x + myUv.x*size.x));","ioPosition.y += ioPosition.w * (pixelSize.y*(-hotspot.y + myUv.y*size.y));","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","vTex = vGetAttribTexCoord0().xy;","}"].join("\n")},a={ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) {","vec4 color = texture2D(map, vTex);","ioFinalColor = vec4(color.r*vColor.r, color.g*vColor.g, color.b*vColor.b, color.a);","}"].join("\n"),ComputeViewNormal:"vec3 ComputeViewNormal() { return vec3(0.0,0.0,1.0); }",ComputeDiscard:["bool ComputeDiscard() {","  vec4 color = texture2D(map, vTex);","  return color.a <= alphaTest;","}"].join("\n")},n={hotspot:{type:"v2",value:this.hotspot},pixelSize:{type:"v2",value:new e.Vector2(.005,.005)},size:{type:"v2",value:new e.Vector2(this.canvasNodeTexture.width,this.canvasNodeTexture.height)},map:{type:"t2",value:t},alphaTest:{type:"f",value:this.canvasNodeTexture.alphaTest||-1}};return i.setPDSFXVaryings({vColor:{type:"v3"},vTex:{type:"v2"}}),i.setPDSFXUniforms(n),i.setPDSFXOverridableFunctions(r,a),i.refreshUniforms=function(t,i){var r;if(!t._smallTargetPicking||t.materialToUse!==e.MaterialToUse.pickingMaterial&&t.materialToUse!==e.MaterialToUse.pickingMaterialInstancing&&t.materialToUse!==e.MaterialToUse.normalMaterial&&t.materialToUse!==e.MaterialToUse.depthMaterial)r=new e.Vector2(2/t.domElement.width,2/t.domElement.height);else{var a=2*t._gpuPickingTolerance+1;r=new e.Vector2(2/a,2/a)}this.updatePDSFXUniform("pixelSize",r)},i},_setUpMeshInstancingParameters:function(t,i,r,a){var n,o,s,c,d,h,l=new Float32Array(16*i),u=new Float32Array(3*i),p=new e.Matrix4;for(n=0;n<i;n++){for(o=r[n],p.copy(o),s=16*n,c=o.elements,h=0;h<16;h++)l[s+h]=c[h];s=3*n,d=a[n],u[s]=d.r,u[s+1]=d.g,u[s+2]=d.b}var _={data:l,type:"m4",attribName:"instanceMatrix",isFlattened:!0},f={data:u,type:"v3",attribName:"instanceColor",isFlattened:!0};t.setInstancingParameters(i,[_,f])},_setupBoundingSphere:function(t){var i,r,a,n,o,s=new e.Vector3(-1/0,-1/0,-1/0),c=new e.Vector3(1/0,1/0,1/0),d=new e.Vector3(0,0,0);for(i=0;i<t.length;i++)a=(r=t[i]).elements[12],n=r.elements[13],o=r.elements[14],a<c.x&&(c.x=a),n<c.y&&(c.y=n),o<c.z&&(c.z=o),a>s.x&&(s.x=a),n>s.y&&(s.y=n),o>s.z&&(s.z=o);d.x=(c.x+s.x)/2,d.y=(c.y+s.y)/2,d.z=(c.z+s.z)/2;var h,l=new e.Vector3,u=0;for(i=0;i<t.length;i++)a=(r=t[i]).elements[12],n=r.elements[13],o=r.elements[14],l.set(a,n,o),(h=d.distanceTo(l))>u&&(u=h);var p=new e.Sphere(d,u);this.rectangle.forceBoundingSphere(p)}});return UWA.namespace("THREEDS/Nodes/Canvas2DInstancingNode",n)}),define("DS/SceneGraphNodes/CanvasNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/Mesh/MeshUtils","DS/SceneGraphNodes/CanvasNodeTexture"],function(e,t,i,r,a){"use strict";var n=t.extend({init:function(t,i){this._parent(t.name),this._isDynamic=!0,this.bottomLeftCorner=t.bottomLeftcorner,this.vectors={},this.vectors.width=t.widthVector,this.vectors.height=t.heightVector,this.canvasNodeTexture=t.canvasNodeTexture,this.requestTextureUpdate=!0;var a=t.side?t.side:e.FrontSide,n=t._noZPriority?t._noZPriority:-1;this.rectangle=function(t,i,a,n,o,s,c,d){var h,l,u,p,_,f,m,g,v,x,w,S,b,y,M;for(10,(h=new r.PrimitiveGroup).fillAttr=new r.FillAttributes,h.lineAttr=new r.LineAttributes,h.pointAttr=new r.PointAttributes,(l=new r.Buffer).size=12,l.component=r.VertexComponentEnum.POSITION,l.format=r.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(l.size),(u=new r.Buffer).size=3,u.component=r.VertexComponentEnum.NORMAL,u.format=r.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(u.size),(p=new r.Buffer).size=12,p.component=r.VertexComponentEnum.TEX_COORD_0,p.format=r.DataTypeEnum.FLOAT,p.dimension=3,p.data=new Float32Array(p.size),(_=new r.Buffer).indexBuffer=!0,_.size=4,_.format=r.DataTypeEnum.UINT,_.dimension=1,_.data=new Uint16Array(_.size),(f=new r.Buffer).indexBuffer=!0,f.size=4,f.format=r.DataTypeEnum.UINT,f.dimension=1,f.data=new Uint16Array(f.size),(m=new r.Buffer).indexBuffer=!0,m.size=4,m.format=r.DataTypeEnum.UINT,m.dimension=1,m.data=new Uint16Array(m.size),h.addBuffer(0,l),h.addBuffer(1,u),h.addBuffer(2,_),h.addBuffer(3,f),h.addBuffer(4,p),h.addBuffer(5,m),M=_.data,b=0,M[b++]=0,M[b++]=1,M[b++]=3,M[b++]=2,M=f.data,b=0,y=0;y<1;y++)M[b++]=y,M[b++]=y,M[b++]=y,M[b++]=y;M=m.data,b=0,M[b++]=0,M[b++]=1,M[b++]=3,M[b++]=2,M=l.data,b=0,M[b++]=i.x,M[b++]=i.y,M[b++]=i.z,M[b++]=i.x+a.x,M[b++]=i.y+a.y,M[b++]=i.z+a.z,M[b++]=i.x+a.x+n.x,M[b++]=i.y+a.y+n.y,M[b++]=i.z+a.z+n.z,M[b++]=i.x+n.x,M[b++]=i.y+n.y,M[b++]=i.z+n.z,M=u.data,b=0;var T=(new e.Vector3).crossVectors(a,n).normalize();M[b++]=T.x,M[b++]=T.y,M[b++]=T.z;var P=o?1:n.length()/a.length();M=p.data,b=0,M[b++]=0,M[b++]=1-P,M[b++]=0,M[b++]=1,M[b++]=1-P,M[b++]=0,M[b++]=1,M[b++]=1,M[b++]=0,M[b++]=0,M[b++]=1,M[b++]=0;var D=s==e.DoubleSide?0:1;for(y=0;y<1;y++)(g=new r.Primitive).nbIndices=4,g.connectivity=r.ConnectivityTypeEnum.TRIANGLE_STRIP,g.attr={fill:new r.FillAttributes(new r.Color(1-y/6,0,y/6,1),D),line:new r.LineAttributes,point:new r.PointAttributes},(v=new r.VertexComponent).component=r.VertexComponentEnum.POSITION,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=r.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=0,v.indices=new r.IndexArray,v.indices.format=r.DataTypeEnum.UINT,v.indices.bufferId=2,v.indices.offset=4*y,(x=new r.VertexComponent).component=r.VertexComponentEnum.NORMAL,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=r.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=1,x.indices=new r.IndexArray,x.indices.format=r.DataTypeEnum.UINT,x.indices.bufferId=3,x.indices.offset=4*y,(w=new r.VertexComponent).component=r.VertexComponentEnum.TEX_COORD_0,w.nbVertices=4,w.nbValuesPerVertex=3,w.format=r.DataTypeEnum.FLOAT,w.cardinality=0,w.bufferId=4,w.indices=new r.IndexArray,w.indices.format=r.DataTypeEnum.UINT,w.indices.bufferId=5,w.indices.offset=0,g.addVertexComponent(v),g.addVertexComponent(x),g.addVertexComponent(w),h.addPrimitive(g);return(S=c.createMeshNode(h,t,void 0,void 0,d)).setShadow(!1),S}(null,this.bottomLeftCorner,this.vectors.width,this.vectors.height,t.canvasNodeTexture.rectangleTexture,a,i,n),this.rectangle.name=void 0!==t.name?t.name:"";var o=this;return this.rectangle._setBeforeRenderCB(function(e,t){o.requestTextureUpdate&&t.viewpoint&&o._textureUpdate(e,t.viewpoint,t.camera)}),this.rectangle.setSSAO(!1),this.rectangle.setMirror(!1),this.addChild(this.rectangle),this.cbChange=function(e){"@onViewpointChange"===e.eventType&&o._onViewpointChange()},this.tokenChange=null,this},setFrustumCulled:function(){this.rectangle.setFrustumCulled.apply(this.rectangle,arguments)},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){var e;for(i.unsubscribe(this.tokenInit),i.unsubscribe(this.tokenChange),e=0;e<this.rectangle._occurrences.length;e++){var t=this.rectangle._occurrences[e].renderable;if(t.material){var r;if(this.canvasNodeTexture._releaseMaterial(t.material),t.material=null,t.highlightMeshes)for(r=0;r<t.highlightMeshes.length;r++)t.highlightMeshes[r].renderable.material=null;t.preHighlight&&(t.preHighlight.material=null)}}},_getDynamicMatrix:function(e,t,i){return this._onViewpointChange(),this.getMatrix()},_onViewpointChange:function(){this.requestTextureUpdate=!0},_textureUpdate:function(t,i,r){r.position;var a=this.bottomLeftCorner.clone(),n=this.vectors[this.canvasNodeTexture.longestEdge],o=new e.Vector3(a.x+n.x,a.y+n.y,a.z+n.z),s=t._getMMMatrix();a.applyMatrix4(s),o.applyMatrix4(s);var c=i.project(a,r),d=i.project(o,r),h=c.distanceTo(d),l=t.material,u=this.canvasNodeTexture._getNewMaterial(h,l);if(u){var p;if(t.material=u,t.highlightMeshes)for(p=0;p<t.highlightMeshes.length;p++)t.highlightMeshes[p].renderable.material=u;t.preHighlight&&(t.preHighlight.material=u),t._flagAsGSSOInvalidated()}}});return UWA.namespace("THREEDS/Nodes/CanvasNode",n)}),define("DS/SceneGraphNodes/RefPlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/MaterialApplication","DS/ShaderBuilders/ShaderUtils/FunctionUtils"],function(e,t,i,r,a,n,o,s,c){"use strict";const d="",h=(e,t,i)=>c.FunctionHandler.callFunction(e,t,i),l=.075,u=.8,p=.8,_=.8;var f=new e.MeshBasicMaterial({force:!1}),m=new e.Matrix4,g=new e.Vector3(0,0,1),v=20,x=new e.Vector3,w=new e.Vector3,S=new e.Vector3,b=new e.Vector3,y=new e.Vector3,M=new e.Vector3,T=new e.Vector3,P=new e.Vector3,D=new e.Vector3,N=new e.Vector3,C=new e.Vector3,V=e.__visibleInCurrentSpace,A=function(){this._backBorderMaterial=null,this._frontPlaneMaterial=null,this._backPlaneMaterial=null,this._margin=null,this._frontText=null,this._backText=null,this._frontPlane=null,this._backPlane=null,this._backBorder=null,this._frontTextNode=null,this._backTextNode=null,this._fixedSizeFrontText=null,this._fixedSizeBackText=null,this._xArrowIndicatorFront=null,this._xArrowIndicatorBack=null};class k{constructor(e,t){this.keys=e,this.cache=new Map,this._create=t}get(e){const t=this._getKey(e);let i=this.cache.get(t);return i||this.cache.set(t,i=this._create(e)),i}_getKey(e){let t="";for(let i=0;i<this.keys.length;i++){let r=e[this.keys[i]];r.getHexString&&(r=r.getHexString()),t+="-"+r}return t}}const B=new k(["color","opacity","lineWidth","force"],t=>{const i=new e.LineBasicMaterial({color:t.color,opacity:t.opacity,lineWidth:t.lineWidth,side:2,polite:!0,force:t.force,forceSide:!0,enableClipPlanes:!1});return i.line=i,i}),F=new k(["color","opacity","side","force"],t=>new e.MeshBasicMaterial({color:t.color,opacity:t.opacity,side:t.side,polygonOffset:!0,polygonOffsetFactor:.5,force:t.force,forceSide:!0,enableClipPlanes:!1})),I=new k(["color","force"],t=>new e.MeshBasicMaterial({color:t.color,opacity:_,side:2,force:t.force,forceSide:!0,depthTest:!1,enableClipPlanes:!1}));class z{static retrieveTextTexture(t,i){return""===t?null:o._createTextTexture({text:t,fontFamily:"Trebuchet MS",color:new e.Color(16777215),opacity:1,resolutionCoef:2*(i||64)})}static createGeometry(){let t=new e.BufferGeometryDS;t.vertexPositionArray=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-.3,1,-.25,0,1,-1,.3,1]),t.vertexIndexArray=new Uint16Array([0,1,2,0,2,3,4,5,6,0,1,1,2,2,3,3,0]),t.boundingBox=new e.Box3(new e.Vector3(-1,-1,0),new e.Vector3(1,1,0)),t.computeBoundingSphere();const i=new n.SGRep;function r(e,t){const r=new n.SGPrimitive({start:e,count:t,rep:i});return i._primitives.push(r),r}const a=window.newMaterialInheritance?e.GraphicAttributeSet.DefaultGASs.skin:null,o=window.newMaterialInheritance?e.GraphicAttributeSet.DefaultGASs.edge:null,s=new n.DrawingGroup(a,null,4,0,9,[r(0,9)]);s._primitives[0].group=s,s.geometry=t;const c=new n.DrawingGroup(o,null,1,9,8,[r(9,8)]);return c._primitives[0].group=c,c.geometry=t,t.drawingGroups=[s,c],t}static createMaterial(){const e=z.createPlaneMaterial();return e.line=z.createBorderMaterial({withOpacity:!0}),e.line.politeMaterial=z.createBorderMaterial({withOpacity:!1}),e.line.politeMaterial.depthTest=!1,e.line.politeMaterial.depthWrite=!1,e}static recompileMaterial(e){e.recompileShaders(!0),e.line.recompileShaders(!0),e.line.politeMaterial.recompileShaders(!0)}static getShaderHelpers(){return{VS:{main:function(e){const t=e.variableHandler,i=e.functionHandler,r=e.pdsfxDefines,a=e=>t.float(e),n=e=>t.vec3(e),o=e=>t.vec4(e);return`\n                        ${i.dF("isArrow","b",[])}{\n\t\t\t\t\t\t\treturn ${e.vGetAttribPosition()}.z > 0.0;\n\t\t\t\t\t\t}\n\n                        ${i.dF("transpose","m4",[i.prmM4("m")])}{\n\t\t\t\t\t\t\t${(e=>t.mat4(e))("n")};\n\t\t\t\t\t\t\tn[0] = ${o()}(m[0][0], m[1][0], m[2][0], m[3][0]);\n\t\t\t\t\t\t\tn[1] = ${o()}(m[0][1], m[1][1], m[2][1], m[3][1]);\n\t\t\t\t\t\t\tn[2] = ${o()}(m[0][2], m[1][2], m[2][2], m[3][2]);\n\t\t\t\t\t\t\tn[3] = ${o()}(m[0][3], m[1][3], m[2][3], m[3][3]);\n\t\t\t\t\t\t\treturn n;\n\t\t\t\t\t\t}\n\n                        ${i.dF("computeClipPosition","v4",[i.prmV3("pos")])}{\n\t\t\t\t\t\t\treturn ${e.vGetProjectionMatrix()} * ${h("getModelViewTransformation","v4",[i.prmV3("pos")])};\n\t\t\t\t\t\t}\n\n                        ${i.dF("get_pixel_size_in_model_units","v3",[i.prmV3("pos_model")])}{\n                            ${n("x")} = ${n()}(1.0, 0.0, 0.0);\n                            ${n("y")} = ${n()}(0.0, 1.0, 0.0);\n                            ${n("z")} = ${n()}(0.0, 0.0, 1.0);\n\t\t\t\t\t\t\t${a("Lx")} = length(${h("computeModelViewDirection","v4",[i.prmV3("x")])}.xyz);\n\t\t\t\t\t\t\t${a("Ly")} = length(${h("computeModelViewDirection","v4",[i.prmV3("y")])}.xyz);\n\t\t\t\t\t\t\t${a("Lz")} = length(${h("computeModelViewDirection","v4",[i.prmV3("z")])}.xyz);\n\n\t\t\t\t\t\t\t${a("W")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("pos_model")])}.w;\n\t\t\t\t\t\t\t${n("clip_radius")}  = ${n()}(\n\t\t\t\t\t\t\t\t(${e.vGetProjectionMatrix()} * ${o()}(0.0, Lx, 0.0, 0.0)).y,\n\t\t\t\t\t\t\t\t(${e.vGetProjectionMatrix()} * ${o()}(0.0, Ly, 0.0, 0.0)).y,\n\t\t\t\t\t\t\t\t(${e.vGetProjectionMatrix()} * ${o()}(0.0, Lz, 0.0, 0.0)).y\n\t\t\t\t\t\t\t) / W;\n\n\t\t\t\t\t\t\t${a("clip1px")}  = 2.0 / ${a()}(${e.vGetViewportSize()}.y);\n\t\t\t\t\t\t\t${n("pixel")}  = clip1px / clip_radius;\n                            ${r.fixedSize?"\n                                pixel /= simpleNodeData.fixedSizeScale;\n                                ":d}\n\t\t\t\t\t\t\treturn pixel;\n\t\t\t\t\t\t}\n\n                        ${i.dF("is_front_facing","b",[])}{\n                            ${n("z")} = ${n()}(0.0, 0.0, 1.0);\n\t\t\t\t\t\t\t${o("Z")} = ${h("computeModelViewDirection","v4",[i.prmV3("z")])};\n\t\t\t\t\t\t\tif(${e.vGetProjectionMatrix()}[3][3] > 0.5) {\n\t\t\t\t\t\t\t\treturn Z.z >= 0.0;\n                            } else {\n                                ${n("zeros")} = ${n()}(0.0, 0.0, 0.0);\n\t\t\t\t\t\t\t\t${o("C")} = ${h("computeModelViewPosition","v4",[i.prmV3("zeros")])};\n\t\t\t\t\t\t\t\treturn dot(C.xyz / C.w, Z.xyz) <= 0.0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n                        ${i.dF("compute_body_position","v3",[i.prmV2("pos2D")])}{\n\t\t\t\t\t\t\treturn ${n()}(pos2D, 0.0);\n\t\t\t\t\t\t}\n\n                        ${i.dF("swap","v2",[i.prmV2("p")])}{\n                            ${a("swapped")} = p;\n\t\t\t\t\t\t\t${a("tmp")} = swapped.x;\n\t\t\t\t\t\t\tswapped.x = swapped.y;\n\t\t\t\t\t\t\tswapped.y = tmp;\n\t\t\t\t\t\t\treturn swapped;\n\t\t\t\t\t\t}\n                        `},arrow:function(e){const t=e.variableHandler,i=e.functionHandler,r=e=>t.vec2(e),a=e=>t.vec3(e);return`\n                        ${i.dF("compute_arrow_position","v3",[i.prmV3("pos2D")])}{\n\t\t\t\t\t\t\tif(!${(t=>e.getUniform(t))("RPShowArrow")}) {\n                                return ${a()}(0.0, 0.0, 0.0);\n                            }\n\n\t\t\t\t\t\t\t${a("arrow_pos")}  = ${a()}(1.0, 0.0, 0.0);\n\t\t\t\t\t\t\t${r("arrow1px")}  = ${i.cF("get_pixel_size_in_model_units","v3",[i.prmV3("arrow_pos")])}.xy;\n\t\t\t\t\t\t\t${r("scale")}  = ${v.toFixed(2)} * arrow1px;\n\n\t\t\t\t\t\t\t// Arrow should not take more than a third of the refplane\n\t\t\t\t\t\t\t${(e=>t.float(e))("body_width")}  = 2.0;\n\t\t\t\t\t\t\tif(scale.x * 3.0 > body_width) {\n                                return ${a()}(0.0, 0.0, 0.0);\n                            }\n\n\t\t\t\t\t\t\t// Normal arrow transform\n\t\t\t\t\t\t\treturn ${a()}(arrow_pos.xy + scale * pos2D, 0.0);\n\t\t\t\t\t\t}\n                        `},text:function(e){const t=e.variableHandler,i=e.functionHandler,r=t=>e.getUniform(t),a=e=>t.bool(e),n=e=>t.float(e),o=e=>t.vec2(e),s=e=>t.vec3(e),c=e=>t.vec4(e);return`\n                        ${i.dF("compute_text_placement","v2",[i.prmV2("pos2D")])}{\n\t\t\t\t\t\t\t// Model space\n\t\t\t\t\t\t\t${s("m0")}  = ${s()}(-1.0, -1.0, 0.0);\n\t\t\t\t\t\t\t${s("m1")}  = ${s()}( 1.0, -1.0, 0.0);\n\t\t\t\t\t\t\t${s("m2")}  = ${s()}( 1.0,  1.0, 0.0);\n\t\t\t\t\t\t\t${s("m3")}  = ${s()}(-1.0,  1.0, 0.0);\n\n\t\t\t\t\t\t\t// Clip space\n\t\t\t\t\t\t\t${c("c0")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m0")])};\n\t\t\t\t\t\t\tc0.x /= c0.w;\n\t\t\t\t\t\t\tc0.y /= c0.w;\n\t\t\t\t\t\t\tc0.z /= c0.w;\n\t\t\t\t\t\t\t${c("c1")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m1")])};\n\t\t\t\t\t\t\tc1.x /= c1.w;\n\t\t\t\t\t\t\tc1.y /= c1.w;\n\t\t\t\t\t\t\tc1.z /= c1.w;\n\t\t\t\t\t\t\t${c("c2")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m2")])};\n\t\t\t\t\t\t\tc2.x /= c2.w;\n\t\t\t\t\t\t\tc2.y /= c2.w;\n\t\t\t\t\t\t\tc2.z /= c2.w;\n\t\t\t\t\t\t\t${c("c3")}  = ${i.cF("computeClipPosition","v4",[i.prmV3("m3")])};\n\t\t\t\t\t\t\tc3.x /= c3.w;\n\t\t\t\t\t\t\tc3.y /= c3.w;\n\t\t\t\t\t\t\tc3.z /= c3.w;\n\n\t\t\t\t\t\t\t// Find the appropriate border for text (that is, the one with the most X available)\n\t\t\t\t\t\t\t${n("dx")} = -1.0;\n                            ${n("lx")} = -1.0;\n                            ${a("_front_facing")} = ${i.cF("is_front_facing","b",[])};\n\t\t\t\t\t\t\t${n("side")}  = -1.0;\n                            if (_front_facing) {\n                                side = 1.0;\n                            }\n\t\t\t\t\t\t\t${s("corner")} ;\n\t\t\t\t\t\t\t${o("oriented_uv")} ;\n\t\t\t\t\t\t\t${a("need_swap")} = false;\n\t\t\t\t\t\t\tif( (lx = (c1.x - c0.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m1;\n                                if (_front_facing) {\n                                    corner = m0;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = pos2D;\n\t\t\t\t\t\t\t\tneed_swap = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif( (lx = (c2.x - c1.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m2;\n                                if (_front_facing) {\n                                    corner = m1;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = ${o()}(pos2D.y, -pos2D.x);\n\t\t\t\t\t\t\t\tneed_swap = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif( (lx = (c3.x - c2.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m3;\n                                if (_front_facing) {\n                                    corner = m2;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = ${o()}(-pos2D.x, -pos2D.y);\n\t\t\t\t\t\t\t\tneed_swap = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif( (lx = (c0.x - c3.x) * side) > dx ){\n\t\t\t\t\t\t\t\tdx = lx;\n\t\t\t\t\t\t\t\tcorner = m0;\n                                if (_front_facing) {\n                                    corner = m3;\n                                }\n\t\t\t\t\t\t\t\toriented_uv = ${o()}(-pos2D.y, pos2D.x);\n\t\t\t\t\t\t\t\tneed_swap = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// If not on the front face, vertices will be oriented the other way\n\t\t\t\t\t\t\tif(!_front_facing) {\n\t\t\t\t\t\t\t\toriented_uv.x *= -1.0;\n                            }\n\n\t\t\t\t\t\t\t// Adjustments: half-size -> size, UV in [0,1]^2 instead of [-1,1]^2\n\t\t\t\t\t\t\toriented_uv = 0.5 + 0.5 * oriented_uv;\n\n\t\t\t\t\t\t\t// Text parameters\n\t\t\t\t\t\t\t${o("text_margin")}  = ${r("RPTextBackRect")}.xy;\n\t\t\t\t\t\t\t${o("text_size")}    = ${r("RPTextBackRect")}.zw;\n                            if (_front_facing) {          \n\t\t\t\t\t\t\t    text_margin = ${r("RPTextFrontRect")}.xy;\n\t\t\t\t\t\t\t    text_size   = ${r("RPTextFrontRect")}.zw;\n                            }\n\n\t\t\t\t\t\t\t// Scale\n\t\t\t\t\t\t\t${o("uv_per_px")}  = ${i.cF("get_pixel_size_in_model_units","v3",[i.prmV2("corner")])}.xy / 2.0;\n\t\t\t\t\t\t\tif(need_swap) {\n                                uv_per_px = ${i.cF("swap","v2",[i.prmV2("uv_per_px")])};\n                            }\n\n\t\t\t\t\t\t\t// Is the text too big for the refplane ?\n\t\t\t\t\t\t\tif((text_size.x + 2.0 * text_margin.x) * uv_per_px.x >= 1.0) {\n\t\t\t\t\t\t\t\treturn ${o()}(-1.0, -1.0);\n                            }\n\n\t\t\t\t\t\t\t// Rescale UV to fit [0,1]^2 to the actual size of the text\n\t\t\t\t\t\t\treturn (oriented_uv / (text_size * uv_per_px) - text_margin / text_size);\n\t\t\t\t\t\t}\n                        `}}}}static createPlaneMaterial(){const t={RPShowArrow:{type:"b",value:!0},RPBodyFrontColor:{type:"v4",value:new e.Vector4(1,0,0,l)},RPBodyBackColor:{type:"v4",value:new e.Vector4(0,1,0,l)},RPTextFrontTexture:{type:"t2"},RPTextBackTexture:{type:"t2"},RPTextFrontRect:{type:"v4",value:new e.Vector4(10,10,40,40)},RPTextBackRect:{type:"v4",value:new e.Vector4(10,10,40,40)},RPTextFrontColor:{type:"v4",value:new e.Vector4(1,1,1,p)},RPTextBackColor:{type:"v4",value:new e.Vector4(1,1,1,p)}},i=z.getShaderHelpers(),r=function(e){const t=e.variableHandler,i=e.functionHandler,r=t=>e.getTextureUniform(t),a=t=>e.getUniform(t),n=t=>e.getVarying(t),o=e=>t.vec2(e),s=e=>t.vec4(e);return`             \n                    ${i.dF("isArrow","b",[])}{\n                        return ${n("is_arrow")} > 0.0;\n                    }\n                    ${i.dF("is_front_facing","b",[])}{\n                        return ${n("front_facing")} > 0.0;\n                    }\n                    ${i.dF("is_inside_text","b",[])}{\n                        ${o("uv")} = ${n("text_uv")};\n                        return uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0; \n                    }\n\n                    ${i.dF("get_body_color","v4",[])}{\n                        if (${i.cF("is_front_facing","b",[])}) {\n                            return ${a("RPBodyFrontColor")};\n                        }\n                        return ${a("RPBodyBackColor")};\n                    }\n                    ${i.dF("get_text_color","v4",[])}{\n                        if (${i.cF("is_front_facing","b",[])}) {\n                            return ${a("RPTextFrontColor")};\n                        }\n                        return ${a("RPTextBackColor")};\n                    }\n\n                    ${i.dF("compute_text_color","v4",[])}{\n                        ${s("body")}  = ${i.cF("get_body_color","v4",[])};\n                        ${s("tex")}  = ${i.cF("get_text_color","v4",[])};\n                        ${o("uv")} = ${n("text_uv")};\n                        if(${i.cF("is_front_facing","b",[])}) {\n                            tex *= ${i.sample2DTexture(r("RPTextFrontTexture"),"uv")};\n                        } else {\n                            tex *= ${i.sample2DTexture(r("RPTextBackTexture"),"uv")};\n                        }\n                        ${(e=>t.float(e))("resultA")} = tex.a + body.a * (1.0 - tex.a);\n                        ${(e=>t.vec3(e))("resultRGB")} = (tex.rgb * tex.a + body.rgb * body.a * (1.0 - tex.a)) / result.a;\n                        return ${s()}(resultRGB, resultA);\n                    }\n                `}`
			`,a={ComputeAlbedo:function(e,t){const i=e.variableHandler,r=e.functionHandler;return`\n\t\t\t\t\t${e.vSetFragDepth(`${e.vGetFragCoord()}.z`)};\n                    ${(e=>i.bool(e))("arrow")} = ${r.cF("isArrow","b",[])};\n\t\t\t\t\tif(arrow) {\n                        ${e.vSetFragDepth("-0.002")};\n                    }\n\n\t\t\t\t\tif(arrow) {\n                        return ${r.cF("get_body_color","v4",[])}.rgb;\n                    } else if(!${r.cF("is_inside_text","b",[])}) {\n                        return ${r.cF("get_body_color","v4",[])}.rgb;\n\t\t\t\t\t} else {\n                        return ${r.cF("compute_text_color","v4",[])}.rgb;\n                    }\n                    `},ComputeOpacity:function(e,t){const i=e.functionHandler;return`                 \n\t\t\t\t\tif(${i.cF("isArrow","b",[])}) {\n                        return ${_.toFixed(2)};\n                    } else if(!${i.cF("is_inside_text","b",[])}) {\n                        return ${i.cF("get_body_color","v4",[])}.a;\n                    } else {\n                        return ${i.cF("compute_text_color","v4",[])}.a;\n                    }\n                    `},ComputeDiscard:function(e,t){return e.pdsfxDefines.highlightMaterial?"return true;":"return false;"}};let n=new e.MeshBasicMaterial({side:e.DoubleSide,color:16777215,opacity:.1,force:!0,polygonOffset:!0,polygonOffsetFactor:.5,enableClipPlanes:!1});return n._activatePDSFXMigrated("PDSFXRefPlanePlane"),n.setPDSFXUniforms(t),n.setPDSFXVaryings({is_arrow:{type:"f"},front_facing:{type:"f"},text_uv:{type:"v2"}}),n.setPDSFXGlobalShaderCode(function(e){return`\n                    ${i.VS.main(e)}\n                    ${i.VS.arrow(e)}\n                    ${i.VS.text(e)}\n                `},r),n.setPDSFXOverridableFunctions({ComputeObjectPosition:function(e,t){const i=e.variableHandler,r=e.functionHandler;return`\n                    \n\t\t\t\t\t${(e=>i.vec2(e))("pos2D")}  = ${e.vGetAttribPosition()}.xy;\n\n\t\t\t\t\tif(${r.cF("isArrow","b",[])}) {\n\t\t\t\t\t\treturn ${r.cF("compute_arrow_position","v3",[r.prmV2("pos2D")])};\n                    }else {\n\t\t\t\t\t\treturn ${r.cF("compute_body_position","v3",[r.prmV2("pos2D")])};\n                    }\n                    `},ComputeVaryingValues:function(e,t){const i=e.functionHandler,r=t=>e.getVarying(t);return`\n                        ${r("is_arrow")} = 0.0;\n                        if(${i.cF("isArrow","b",[])}) {\n                            ${r("is_arrow")} = 1.0;;\n                        }\n                        ${r("front_facing")} = -1.0;\n                        if(${i.cF("is_front_facing","b",[])}) {\n                            ${r("front_facing")} = 1.0;;\n                        }\n                        ${r("text_uv")} = ${i.cF("compute_text_placement","v2"[i.prmV2(`${e.vGetAttribPosition()}.xy`)])};\n                    `}},a),n}static createBorderMaterial({withOpacity:t}){const i={RPBorderFrontColor:{type:"v4",value:new e.Vector4(1,1,0,u)},RPBorderBackColor:{type:"v4",value:new e.Vector4(1,0,1,u)},RPBorderHalfWidth:{type:"v2",value:new e.Vector2(1,1)}},r=z.getShaderHelpers(!1),a={ComputeAlbedo:function(e,t){const i=t=>e.getUniform(t);return`\n                        if (${e.functionHandler.cF("is_front_facing","b",[])}) {\n                            return ${i("RPBorderFrontColor")}.xyz;\n                        }\n                        return ${i("RPBorderBackColor")}.xyz;\n                    `},ComputeOpacity:t?function(e){const t=t=>e.getUniform(t);return`           \n                            if (${e.functionHandler.cF("is_front_facing","b",[])}) {\n                                return ${t("RPBorderFrontColor")}.w;\n                            }\n                            return ${t("RPBorderBackColor")}.w;\n                        `}:null};let n=new e.LineBasicMaterial({side:e.DoubleSide,color:16777215,opacity:.3,lineWidth:1,polite:!0,force:!0,enableClipPlanes:!1});return n.defines=n.defines||{},n.defines.PDSFX_REFPLANE_BORDER_WOPACITY=t?1:0,n._activatePDSFXMigrated("PDSFXRefPlaneBorder"),n.setPDSFXUniforms(i),n.setPDSFXVaryings({front_facing:{type:"f"}}),n.setPDSFXGlobalShaderCode(r.VS.main,function(e){return`                \n                    ${e.functionHandler.dF("is_front_facing","b",[])}{\n                        return ${(t=>e.getVarying(t))("front_facing")} > 0.0;\n                    }\n                `}),n.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){const i=e.functionHandler,r=t=>e.getVarying(t);return`              \n                        ${r("front_facing")} = -1.0;\n                        if(${i.cF("is_front_facing","b",[])}) {\n                            ${r("front_facing")} = 1.0;;\n                        }\n                    `},ComputeHalfWidth:function(e,t){const i=t=>e.getUniform(t);return`\n                        if (${e.functionHandler.cF("is_front_facing","b",[])}) {\n                            return ${i("RPBorderHalfWidth")}.x;\n                        }\n                        return ${i("RPBorderHalfWidth")}.y;\n                    `}},a),n}static updateMaterial(e,{wireframe:t,show_arrow:i,plane_front_color:r,plane_back_color:a,border_front_color:n,border_back_color:o,text_front_color:s,text_back_color:c,border_front_width:d,border_back_width:h,text_front_text:l,text_back_text:u,text_front_size:p,text_back_size:_,text_front_margin:f,text_back_margin:m}){const g={},v={};function x(e){return e.x*=e.x,e.y*=e.y,e.z*=e.z,e}t&&(o=n,h=d),void 0!==i&&(g.RPShowArrow=!!i),void 0!==r&&(g.RPBodyFrontColor=x(r)),void 0!==a&&(g.RPBodyBackColor=x(a)),void 0!==s&&(g.RPTextFrontColor=x(s)),void 0!==c&&(g.RPTextBackColor=x(c)),void 0!==n&&(v.RPBorderFrontColor=x(n)),void 0!==o&&(v.RPBorderBackColor=x(o));const w=e.line.getPDSFXUniform("RPBorderHalfWidth").value;void 0!==d&&(w.x=d/2,v.RPBorderHalfWidth=w),void 0!==h&&(w.y=h/2,v.RPBorderHalfWidth=w),g.RPTextFrontRect=e.getPDSFXUniform("RPTextFrontRect").value,g.RPTextBackRect=e.getPDSFXUniform("RPTextBackRect").value,g.RPTextFrontTexture=e.getPDSFXUniform("RPTextFrontTexture").value,g.RPTextBackTexture=e.getPDSFXUniform("RPTextBackTexture").value,void 0!==f&&(g.RPTextFrontRect.x=g.RPTextFrontRect.y=f),void 0!==m&&(g.RPTextBackRect.x=g.RPTextBackRect.y=m),void 0!==l&&(g.RPTextFrontTexture=z.retrieveTextTexture(l,p)),void 0!==u&&(g.RPTextBackTexture=z.retrieveTextTexture(u,_));const S=g.RPTextFrontTexture?g.RPTextFrontTexture.image.width/g.RPTextFrontTexture.image.height:1,b=g.RPTextBackTexture?g.RPTextBackTexture.image.width/g.RPTextBackTexture.image.height:1;g.RPTextFrontRect.w=g.RPTextFrontTexture?g.RPTextFrontTexture.image.height/2:0,g.RPTextFrontRect.z=S*g.RPTextFrontRect.w,g.RPTextBackRect.w=g.RPTextBackTexture?g.RPTextBackTexture.image.height/2:0,g.RPTextBackRect.z=b*g.RPTextBackRect.w;const y=2*Math.max(v.RPBorderHalfWidth.x,v.RPBorderHalfWidth.y);e.line.setLineWidth(y),e.line.politeMaterial.setLineWidth(y);for(let t in g)e.updatePDSFXUniform(t,g[t]);for(let t in v)e.line.updatePDSFXUniform(t,v[t]),e.line.politeMaterial.updatePDSFXUniform(t,v[t])}static retrieveGeometry(){return z.sharedGeometry||(z.sharedGeometry=z.createGeometry()),z.sharedGeometry}static deriveColor(t){const i=t.getHSL(),r=i.h+20/255,a=Math.min(1,1.3*i.l);return(new e.Color).setHSL(r,i.s,a)}}z.sharedGeometry=null;const R=i.extend({init:function(t){this.parameters={show_arrow:!0,wireframe:!1,plane_front_color:new e.Vector4(1,0,0,l),plane_back_color:new e.Vector4(0,1,0,l),border_front_color:new e.Vector4(1,0,0,u),border_front_width:2,border_back_color:new e.Vector4(0,1,0,u),border_back_width:2,text_front_text:"",text_front_size:30,text_front_margin:5,text_front_color:new e.Vector4(1,0,0,p),text_back_text:"",text_back_size:30,text_back_margin:5,text_back_color:new e.Vector4(0,1,0,p)};const i=z.retrieveGeometry(),r=z.createMaterial(),a=new e.Mesh(null,r);return a.addGeometry(i,!0),a.matrixAutoUpdate=!1,a.receiveShadow=!1,a.castShadow=!1,this.refplane_material=r,this._parent(a,t.name),this.setShadow(!1),this.setSSAO(!1),this.setFrustumCulled(!1),this.setPickingPriorityId({faces:"RefPlanePickPriority",edges:"RefPlanePickPriority",points:"RefPlanePickPriority"}),this.setPickingPriorityId({edges:"RefPlaneEdges"}),this.setParameters(t),this},setParameters:function(e){function t(e,t){return e?(t||(t={}),e.color&&!t.color&&(t.color=z.deriveColor(e.color)),t):t}function i(e,t,i){return void 0!==t&&(e.x=t.r,e.y=t.g,e.z=t.b),void 0!==i&&(e.w=i),e}void 0!==e.wireframe&&(this.parameters.wireframe=e.wireframe),void 0!==e.showArrow&&(this.parameters.show_arrow=e.showArrow);const r=e.plane||e.planeAttributes,a=r&&r.front,n=t(a,r&&r.back);a&&i(this.parameters.plane_front_color,a.color,a.opacity),n&&i(this.parameters.plane_back_color,n.color,n.opacity);const o=e.border||e.borderAttributes,s=o&&o.front,c=t(s,o&&o.back);s&&(i(this.parameters.border_front_color,s.color,s.opacity),void 0!==s.width&&(this.parameters.border_front_width=s.width)),c&&(i(this.parameters.border_back_color,c.color,c.opacity),void 0!==c.width&&(this.parameters.border_back_width=c.width));const d=e.text||e.textAttributes,h=d&&d.front,l=d&&d.back;h&&(i(this.parameters.text_front_color,h.color,h.opacity),void 0!==h.data&&(this.parameters.text_front_text=h.data),void 0!==h.size&&(this.parameters.text_front_size=h.size)),l&&(i(this.parameters.text_back_color,l.color,l.opacity),void 0!==l.data&&(this.parameters.text_back_text=l.data),void 0!==l.size&&(this.parameters.text_back_size=l.size)),z.updateMaterial(this.refplane_material,this.parameters);const u=this.mesh3js.geometry[0].drawingGroups[0]._primitives[0];this.parameters.wireframe?this.hide([u]):this.show([u])}});t.extend({init:function(t){return this._enable_refplane_counting=void 0===t.enableRefplaneCounting||t.enableRefplaneCounting,this._enable_refplane_counting&&(this.tokenChange=null),this._parent(t.name),this._main=new R({name:`RefPlane3D-${t.name}`}),this._main.setPickParent(!0),this.addChild(this._main),this._zoomable=!1,this._size=new e.Vector2(2,2),this.setParameters(t),this},setParameters:function(t){void 0!==(t=Object.assign({},t)).fill&&(t.wireframe=!t.fill),void 0!==t.newLook&&(t.wireframe=!t.newLook),void 0!==t.fixedSize&&(t.zoomable=!t.fixedSize),void 0!==t.orientationArrow&&(t.showArrow=!!t.orientationArrow),delete t.fill,delete t.newLook,delete t.fixedSize,delete t.orientationArrow;const i=void 0!==t.zoomable||void 0!==t.size;if(void 0!==t.zoomable&&(this._zoomable=t.zoomable),void 0!==t.size&&this._size.copy(t.size),i){const t=(new e.Matrix4).makeScale(this._size.x/2,this._size.y/2,1);this._main.setMatrix(t);const i=t.getMaxScaleOnAxis();this._main.setRatio(this._zoomable?0:i),z.recompileMaterial(this._main.refplane_material)}delete t.size,delete t.zoomable,this._main.setParameters(t)},setNewLook:function(e){this.setParameters({wireframe:!e})},getNewLook:function(){return!this._main.parameters.wireframe},setFixedSize:function(e){this.setParameters({zoomable:!e})},counter_update:function(e){if(!this._enable_refplane_counting)return;if(this._main.parameters.wireframe)return;const t={};for(let i=0;i<this._occurrences.length;i++){const r=this._occurrences[i],a=r.parent;if(!r.scene3js||!a)continue;const n=r.scene3js.viewer;V(r._getVisible(),r._getVisibilityFree(),n.getVisibleSpace(),null,r)&&(e&&e.viewpoint&&e.viewpoint.viewer&&n!==e.viewpoint.viewer||(t[n.id]||(t[n.id]={viewer:n,count:0}),t[n.id].count++,n._refPlaneCounter>100&&this.setParameters({wireframe:!0})))}for(let e in t){const i=t[e],r=i.viewer._refPlaneMap.get(this.id)||0;i.viewer._refPlaneMap.set(this.id,i.count),i.viewer._refPlaneCounter+=i.count-r}},counter_subscribe:function(){this._enable_refplane_counting&&(this.tokenChange=r.subscribe({event:"/VISU/"},e=>{"@onViewpointChange"===e.eventType&&this.counter_update(e)}),this.counter_update())},counter_unsubscribe:function(){if(!this._enable_refplane_counting)return;r.unsubscribe(this.tokenChange);const e=[];for(let t=0;t<this._occurrences.length;t++){const i=this._occurrences[t],r=i.parent;if(!i.scene3js||!r)continue;const a=i.scene3js.viewer;a&&e.push(a)}for(let t=0;t<e.length;t++){const i=e[t],r=i._refPlaneMap.get(this.id)||0;i._refPlaneMap.set(this.id,0),i._refPlaneCounter+=0-r}},_onLinkedToSceneGraph:function(){this.counter_subscribe()},_onUnlinkedToSceneGraph:function(){this.counter_unsubscribe()}});const E=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this.matInherit=window.newMaterialInheritance,this.fixedSize=i.fixedSize;var r=this;return this.cbChange=function(e){if(this._newLook){for(var t={},i=0;i<r._occurrences.length;i++){var a=r._occurrences[i],n=a.parent;if(a.scene3js&&n){var o=a.scene3js.viewer;if(V(a._getVisible(),a._getVisibilityFree(),o.getVisibleSpace(),null,a)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)continue;if(t[o.id]||(t[o.id]={viewer:o,count:0}),t[o.id].count++,o._refPlaneCounter>100){r.setNewLook(!1);continue}var s=o.currentViewpoint;r._updateNode(a,i,e,s)}}}r._updateViewersCount(t)}},this.tokenChange=null,this._length=new e.Vector2(10,10),this._frontBorderMaterial=this._getBorderMaterial({color:new e.Color("green"),opacity:u,lineWidth:2}),this._frontBorder=this._buildEditableRectangle(!0,this._frontBorderMaterial.color,this._frontBorderMaterial.opacity),this.matInherit&&this._frontBorder.setMaterialMode(!0),this._setMaterial(this._frontBorder,"line",this._frontBorderMaterial),this._frontBorder.setShadow(!1),this._frontBorder.setSSAO(!1),this._frontBorder.setFrustumCulled(!1),this._frontBorder.setPickParent(!0),this._frontBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),this._mainNode=new t("RefPlaneNode"),this._mainNode.setPickParent(!0),this._mainNode.setPickingPriorityId({faces:"RefPlanePickPriority",edges:"RefPlanePickPriority",points:"RefPlanePickPriority"}),this._advanced=null,this._newLook=void 0===i.newLook||i.newLook,this._setNewLook(this._newLook),this._currentParams=null,this.setParameters(i),this._mainNode.addChild(this._frontBorder),this._updateFixedSizeProperties(this._advanced),this.addChild(this._mainNode),this},_createTextNodes:function(e){e._frontTextNode=new t,e._backTextNode=new t,e._fixedSizeFrontText=new a({name:"fixedSizeNodeFrontText",ratio:1}),e._fixedSizeFrontText._autoUpdate=!1,e._fixedSizeBackText=new a({name:"fixedSizeNodeBackText",ratio:1}),e._fixedSizeBackText._autoUpdate=!1,e._fixedSizeFrontText.setPickable(n.NOPICKABLE),e._fixedSizeBackText.setPickable(n.NOPICKABLE),this.fixedSize?(e._subNode=new a({name:"FixedSizeForText",ratio:1}),e._subNode.addChild(e._frontTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._subNode.addChild(e._backTextNode),e._backTextNode.addChild(e._fixedSizeBackText),this._mainNode.addChild(e._subNode)):(this._mainNode.addChild(e._frontTextNode),this._mainNode.addChild(e._backTextNode),e._frontTextNode.addChild(e._fixedSizeFrontText),e._backTextNode.addChild(e._fixedSizeBackText))},_removeTextNodes:function(e){e._frontTextNode&&(this.fixedSize?(e._subNode.removeChild(e._frontTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._subNode.removeChild(e._backTextNode),e._backTextNode.removeChild(e._fixedSizeBackText),this._mainNode.removeChild(e._subNode)):(this._mainNode.removeChild(e._frontTextNode),this._mainNode.removeChild(e._backTextNode),e._frontTextNode.removeChild(e._fixedSizeFrontText),e._backTextNode.removeChild(e._fixedSizeBackText)),e._subNode=null,e._frontTextNode=null,e._backTextNode=null,e._fixedSizeFrontText=null,e._fixedSizeBackText=null)},_initAdvancedNodes:function(e){this._mainNode.addChild(e._frontPlane),this._mainNode.addChild(e._backPlane),this._mainNode.addChild(e._backBorder),this._mainNode.addChild(e._xArrowIndicatorFront),this._mainNode.addChild(e._xArrowIndicatorBack),e._xArrowIndicatorFront.setRatio(v),e._xArrowIndicatorBack.setRatio(v),this._updateFixedSizeProperties(this._advanced)},_initAdvancedParameters:function(t){t._frontPlaneMaterial=this._getPlaneMaterial({color:new e.Color("green"),opacity:l,side:0});var i=t._frontPlaneMaterial.color.getHSL();a=i.h+20/255,n=Math.min(1,1.3*i.l),t._backPlaneMaterial=this._getPlaneMaterial({color:(new e.Color).setHSL(a,i.s,n),opacity:l,side:1});var r=this._frontBorderMaterial.color.getHSL(),a=r.h+20/255,n=Math.min(1,1.3*r.l);t._backBorderMaterial=this._getBorderMaterial({color:(new e.Color).setHSL(a,r.s,n),opacity:u,lineWidth:2}),t._margin=.02,t._frontText={data:"",color:new e.Color("green"),opacity:p,size:.5,token:null},t._backText={data:"",color:new e.Color("green"),opacity:p,size:.5,token:null},t._frontPlane=this._buildEditableRectangle(!1,t._frontPlaneMaterial.color,t._frontPlaneMaterial.opacity),this.matInherit&&t._frontPlane.setMaterialMode(!0),this._setMaterial(t._frontPlane,"face",t._frontPlaneMaterial),t._frontPlane.setShadow(!1),t._frontPlane.setSSAO(!1),t._frontPlane.setFrustumCulled(!1),t._frontPlane.setPickParent(!0),t._frontPlane.excludeFromHighlight(!0,!0),t._backPlane=this._buildEditableRectangle(!1,t._backPlaneMaterial.color,t._backPlaneMaterial.opacity),this.matInherit&&t._backPlane.setMaterialMode(!0),this._setMaterial(t._backPlane,"face",t._backPlaneMaterial),t._backPlane.setShadow(!1),t._backPlane.setSSAO(!1),t._backPlane.setFrustumCulled(!1),t._backPlane.setPickParent(!0),t._backPlane.excludeFromHighlight(!0,!0),t._backBorder=this._buildEditableRectangle(!0,t._backBorderMaterial.color,t._backBorderMaterial.opacity),this.matInherit&&t._backBorder.setMaterialMode(!0),this._setMaterial(t._backBorder,"line",t._backBorderMaterial),t._backBorder.setShadow(!1),t._backBorder.setSSAO(!1),t._backBorder.setFrustumCulled(!1),t._backBorder.setPickParent(!0),t._backBorder.setPickingPriorityId({edges:"RefPlaneEdges"}),t._xArrowIndicatorFront=this._buildXIndicator(),t._xArrowIndicatorFront.setShadow(!1),t._xArrowIndicatorFront.setSSAO(!1),t._xArrowIndicatorFront.excludeFromHighlight(!0,!0),t._xArrowIndicatorBack=this._buildXIndicator(),t._xArrowIndicatorBack.setShadow(!1),t._xArrowIndicatorBack.setSSAO(!1),t._xArrowIndicatorBack.excludeFromHighlight(!0,!0),t._displayArrowOrientation=!0,this.matInherit&&t._xArrowIndicatorFront.setMaterialMode(!0),this._setMaterial(t._xArrowIndicatorFront,"face",this._getXIndicatorMaterial({color:t._frontPlaneMaterial.color})),this.matInherit&&t._xArrowIndicatorBack.setMaterialMode(!0),this._setMaterial(t._xArrowIndicatorBack,"face",this._getXIndicatorMaterial({color:t._backPlaneMaterial.color}))},_updateFixedSizeProperties:function(t){const i=this.fixedSize?1:0;this._frontBorder.setRatio(i),t&&t._backBorder&&t._backBorder.setRatio(i),t&&t._frontPlane&&t._frontPlane.setRatio(i),t&&t._backPlane&&t._backPlane.setRatio(i);const r=new e.Vector3(.5*this._length.x,0,0),a=t=>{t.setMatrix(this.fixedSize?null:(new e.Matrix4).setPosition(r)),t.setFixedSizeCenter(this.fixedSize?r:new e.Vector3)};t&&t._xArrowIndicatorFront&&a(t._xArrowIndicatorFront),t&&t._xArrowIndicatorBack&&a(t._xArrowIndicatorBack)},setFixedSize:function(e){if((e=!!e)===this.fixedSize)return;const t=this._advanced;t&&this._removeTextNodes(t),this.fixedSize=e,t&&(t._frontText&&""!==t._frontText.data||t._backText&&""!==t._backText.data)&&(this._createTextNodes(t),this._createTextTokens(t),this.fixedSize?t._subNode&&t._subNode.setVisibility(this._newLook):(t._frontTextNode&&t._frontTextNode.setVisibility(this._newLook),t._backTextNode&&t._backTextNode.setVisibility(this._newLook),t._xArrowIndicatorFront.setVisibility(this._newLook),t._xArrowIndicatorBack.setVisibility(this._newLook))),this._updateFixedSizeProperties(t)},_setNewLook:function(e){var t=this._advanced;if(e&&!t&&(t=new A,this._advanced=t,this._initAdvancedParameters(t),this._initAdvancedNodes(t)),this._resetOccurrenceVisibility(this._frontBorder),this._frontBorder.setVisibility(!0),t){const i=[t._backBorder,t._frontPlane,t._backPlane,t._frontTextNode,t._backTextNode,t._xArrowIndicatorFront,t._xArrowIndicatorBack];for(let t=0;t<i.length;t++){const r=i[t];if(!r)return;this._resetOccurrenceVisibility(r),r.setVisibility(e)}}this.fixedSize?t&&t._subNode&&t._subNode.setVisibility(e):t&&(t._frontTextNode&&t._frontTextNode.setVisibility(e),t._backTextNode&&t._backTextNode.setVisibility(e),t._xArrowIndicatorFront.setVisibility(e),t._xArrowIndicatorBack.setVisibility(e)),e&&this._currentParams&&(this.setParameters(this._currentParams),this._currentParams=null)},setNewLook:function(e){this._newLook!==e&&(this._newLook=e,this._setNewLook(e))},getNewLook:function(){return this._newLook},_getBorderMaterial:function(e){return B.get({...e,force:!this.matInherit})},_getPlaneMaterial:function(e){return F.get({...e,force:!this.matInherit})},_getXIndicatorMaterial:function(e){return I.get({...e,force:!this.matInherit})},_setMaterial:function(e,t,i){if(e.getMaterial()!==i)if(this.matInherit){const r=new s({layer:0,[`${t}Material`]:i});e.setMaterialApplication(r)}else e.setMaterial(i)},_updateTextPosition:function(e,t,i,r){const a=void 0===t,n=!a&&t;let o=0,s=0;if(e){const t=e.camera;var c=this._advanced._subNode?this._advanced._subNode._occurrences[r].matrix:this._occurrences[r].matrix;c.extractBasis(x,w,S),x.multiplyScalar(.5*this._length.x),w.multiplyScalar(.5*this._length.y),b.getPositionFromMatrix(c),y.addVectors(x,w),y.negate(),y.addVectors(y,b),M.subVectors(x,w),M.addVectors(M,b),T.addVectors(x,w),T.addVectors(T,b),P.subVectors(w,x),P.addVectors(P,b);const i=[e.project(y,t),e.project(M,t),e.project(T,t),e.project(P,t)];for(let e=0;e<i.length;e++){const t=i[e],r=i[(e+1)%i.length].x-t.x;r<=s||(o=e,s=r)}}var d=o%2?this._length.y:this._length.x,h=o%2?this._length.x:this._length.y;if(a||n){m.makeRotationAxis(g,.5*Math.PI*o),m.translate(b.set(-(.5-this._advanced._margin)*d,-(.5-this._advanced._margin)*h,0));var l=this._advanced._frontTextNode._occurrences[r];l._relativeMatrix?l._relativeMatrix.copy(m):l._relativeMatrix=m.clone()}if(a||!n){m.makeRotationAxis(g,Math.PI+.5*Math.PI*o),m.rotateY(Math.PI),m.translate(b.set(-(.5-this._advanced._margin)*d,-(.5-this._advanced._margin)*h,0));var u=this._advanced._backTextNode._occurrences[r];u._relativeMatrix?u._relativeMatrix.copy(m):u._relativeMatrix=m.clone()}return s},_setParametersOld:function(e){e.size&&(this._length.copy(e.size),this._updateRectangleSize(this._frontBorder));var t=e.borderAttributes;if(t&&t.front){var i=void 0!==t.front.color?t.front.color:this._frontBorderMaterial.color,r=void 0!==t.front.opacity?t.front.opacity:this._frontBorderMaterial.opacity,a=void 0!==t.front.width?t.front.width:this._frontBorderMaterial.lineWidth;this._frontBorderMaterial=this._getBorderMaterial({color:i,opacity:r,lineWidth:a}),this._setMaterial(this._frontBorder,"line",this._frontBorderMaterial)}},_createTextTokens:function(e){""!==e._frontText.data&&(e._frontText.token=o.createTextNode({name:"_refplaneitem_",text:e._frontText.data,font:"Trebuchet MS",fontSize:e._frontText.size,color:e._frontText.color,opacity:e._frontText.opacity,depthWrite:!1}),e._frontText.token.children[0].excludeFromHighlight(!0,!0),e._fixedSizeFrontText.addChild(e._frontText.token)),""!==e._backText.data&&(e._backText.token=o.createTextNode({name:"_refplaneitem_",text:e._backText.data,font:"Trebuchet MS",fontSize:e._backText.size,color:e._backText.color,opacity:e._backText.opacity,depthWrite:!1}),e._backText.token.children[0].excludeFromHighlight(!0,!0),e._fixedSizeBackText.addChild(e._backText.token))},setParameters:function(t){if(this._currentParams=t,this.setFixedSize(t.fixedSize),this._newLook){var i=this._advanced;t.size&&(this._length.copy(t.size),this._updateRectangleSize(i._frontPlane),this._updateRectangleSize(i._backPlane),this._updateRectangleSize(this._frontBorder),this._updateRectangleSize(i._backBorder));var r=t.planeAttributes;if(r){if(r.front){var a=void 0!==r.front.color?r.front.color:i._frontPlaneMaterial.color,n=void 0!==r.front.opacity?r.front.opacity:i._frontPlaneMaterial.opacity;if(this._setMaterial(i._xArrowIndicatorFront,"face",this._getXIndicatorMaterial({color:a})),i._frontPlaneMaterial=this._getPlaneMaterial({color:a,opacity:n,side:0}),this._setMaterial(i._frontPlane,"face",i._frontPlaneMaterial),!r.back||!r.back.color){var o=a.getHSL(),s=o.h+20/255,c=Math.min(1,1.3*o.l),d=(new e.Color).setHSL(s,o.s,c);this._setMaterial(i._xArrowIndicatorBack,"face",this._getXIndicatorMaterial({color:d})),i._backPlaneMaterial=this._getPlaneMaterial({color:d,opacity:i._backPlaneMaterial.opacity,side:1}),this._setMaterial(i._backPlane,"face",i._backPlaneMaterial)}}if(r.back){a=void 0!==r.back.color?r.back.color:i._backPlaneMaterial.color,n=void 0!==r.back.opacity?r.back.opacity:i._backPlaneMaterial.opacity;this._setMaterial(i._xArrowIndicatorBack,"face",this._getXIndicatorMaterial({color:a})),i._backPlaneMaterial=this._getPlaneMaterial({color:a,opacity:n,side:1}),this._setMaterial(i._backPlane,"face",i._backPlaneMaterial)}}var h=t.borderAttributes;if(h){if(h.front){a=void 0!==h.front.color?h.front.color:this._frontBorderMaterial.color,n=void 0!==h.front.opacity?h.front.opacity:this._frontBorderMaterial.opacity;var l=void 0!==h.front.width?h.front.width:this._frontBorderMaterial.lineWidth;if(this._frontBorderMaterial=this._getBorderMaterial({color:a,opacity:n,lineWidth:l}),this._setMaterial(this._frontBorder,"line",this._frontBorderMaterial),!h.back||!h.back.color){var u=a.getHSL();s=u.h+20/255,c=Math.min(1,1.3*u.l),d=(new e.Color).setHSL(s,u.s,c);i._backBorderMaterial=this._getBorderMaterial({color:d,opacity:i._backBorderMaterial.opacity,lineWidth:i._backBorderMaterial.lineWidth}),this._setMaterial(i._backBorder,"line",i._backBorderMaterial)}}if(h.back){a=void 0!==h.back.color?h.back.color:i._backBorderMaterial.color,n=void 0!==h.back.opacity?h.back.opacity:i._backBorderMaterial.opacity,l=void 0!==h.back.width?h.back.width:i._backBorderMaterial.lineWidth;i._backBorderMaterial=this._getBorderMaterial({color:a,opacity:n,lineWidth:l}),this._setMaterial(i._backBorder,"line",i._backBorderMaterial)}}var p=""!==i._frontText.data||""!==i._backText.data,_=t.textAttributes;if(_){_.front&&(void 0!==_.front.data&&(i._frontText.data=_.front.data),void 0!==_.front.size&&(i._frontText.size=_.front.size),void 0!==_.front.opacity&&(i._frontText.opacity=_.front.opacity),void 0!==_.front.color&&i._frontText.color.copy(_.front.color)),_.back&&(void 0!==_.back.data&&(i._backText.data=_.back.data),void 0!==_.back.size&&(i._backText.size=_.back.size),void 0!==_.back.opacity&&(i._backText.opacity=_.back.opacity),void 0!==_.back.color&&i._backText.color.copy(_.back.color)),p&&(i._frontText&&i._frontText.token&&i._fixedSizeFrontText.removeChild(i._frontText.token),i._backText&&i._backText.token&&i._fixedSizeBackText.removeChild(i._backText.token));var f=""!==i._frontText.data||""!==i._backText.data;!p&&f&&this._createTextNodes(i),p&&!f&&this._removeTextNodes(i),this._createTextTokens(i)}void 0!==t.orientationArrow&&i._displayArrowOrientation!==t.orientationArrow&&(t.orientationArrow?(this._mainNode.addChild(i._xArrowIndicatorFront),this._mainNode.addChild(i._xArrowIndicatorBack)):(this._mainNode.removeChild(i._xArrowIndicatorFront),this._mainNode.removeChild(i._xArrowIndicatorBack)),i._displayArrowOrientation=t.orientationArrow),this._updateFixedSizeProperties(i)}else this._setParametersOld(t)},_updateViewersCount:function(e){for(var t in e){var i=e[t],r=i.viewer._refPlaneMap.get(this.id);void 0===r&&(r=0),i.viewer._refPlaneMap.set(this.id,i.count),i.viewer._refPlaneCounter+=i.count-r}},_updateCount:function(e){for(var t={},i=0;i<this._occurrences.length;i++){var r=this._occurrences[i],a=r.parent;if(r.scene3js&&a){var n=r.scene3js.viewer;n&&(t[n.id]||(t[n.id]={viewer:n,count:0}),e?t[n.id].count=0:t[n.id].count++)}}this._updateViewersCount(t)},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=r.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)}),this.cbChange()},_onUnlinkedToSceneGraph:function(){r.unsubscribe(this.tokenChange),this._updateCount(!0)},_getDynamicMatrix:function(){return null},_resetOccurrenceVisibility:function(e){for(var t=0;t<e._occurrences.length;t++){var i=e._occurrences[t];i._relativeVisibility=null,i.parent&&this._updateOccurrences(i.parent,i,!0,!0,!0)}},_setOccurrenceVisibility:function(e,t,i,r){var a=t?1:0;if(i||e._relativeVisibility!==a){e._relativeVisibility=a;var n=r||e;this._updateOccurrences(n.parent,n,!0,!0,!0)}},_updateNode:function(e,t,i,r){var a=this._advanced,n=r||i.viewpoint,o=n.getEyePosition(),s=e.matrix.elements;D.set(s[12],s[13],s[14]),N.subVectors(o,D),N.normalize(),C.set(s[8],s[9],s[10]);var c=N.dot(C)>0,d=""!==a._frontText.data||""!==a._backText.data;let h=void 0;d&&(h=this._updateTextPosition(n,c,e,t)),this._setOccurrenceVisibility(this._frontBorder._occurrences[t],c),this._setOccurrenceVisibility(a._backBorder._occurrences[t],!c);var l=!1;if(d){var u=c?a._fixedSizeFrontText:a._fixedSizeBackText,p=c?a._backText.token:a._frontText.token,_=c?a._frontText.token:a._backText.token,f=c?a._backTextNode:a._frontTextNode,m=c?a._frontTextNode:a._backTextNode,g=(p._occurrences[t],_._occurrences[t]),x=f._occurrences[t],w=m._occurrences[t];this._setOccurrenceVisibility(x,!1,!1,x),u.cbChange();var S=!1;if(u._bsShow||u.getBoundingSphere(),this.fixedSize)S=1.414*(u._bsShow?u._bsShow.radius*u.getRatio():0)<=(a._frontPlane.explicitBSphere?a._frontPlane.explicitBSphere.radius*a._frontPlane.getRatio():0);else S=!u._bsShow||2*u._bsShow.radius*u.getScaleFactor(t)<.9*Math.min(this._length.x,this._length.y);w._relativeVisibility=1,this._setOccurrenceVisibility(g,S,!0,w),l=l||S}if(a._displayArrowOrientation){const e=c?a._xArrowIndicatorFront:a._xArrowIndicatorBack,i=c?a._xArrowIndicatorBack:a._xArrowIndicatorFront;var b=1;this.fixedSize||(b=n.camera.getWorldSizeFromPixelSize(1,D,n.viewer._getDivClientHeight(),2));var y=v*b<.3*Math.min(this._length.x,this._length.y);this._setOccurrenceVisibility(e._occurrences[t],y),this._setOccurrenceVisibility(i._occurrences[t],!1)}a._subNode&&a._subNode.setVisibility(l)},_buildXIndicator:function(){var e=new n.PrimitiveGroup;e.fillAttr=new n.FillAttributes;var t=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:new Float32Array(9)}),i=new n.Buffer({component:n.VertexComponentEnum.NORMAL,data:new Float32Array(9)});e.addBuffer(0,t),e.addBuffer(1,i);var r=t.data,a=0;r[a++]=-1,r[a++]=-.3,r[a++]=0,r[a++]=-.25,r[a++]=0,r[a++]=0,r[a++]=-1,r[a++]=.3,r[a++]=0,r=i.data,a=0;for(var s=0;s<3;s++)r[a++]=0,r[a++]=0,r[a++]=1;var c=new n.Primitive({nbIndices:3,connectivity:n.ConnectivityTypeEnum.TRIANGLES,fillGAS:new n.FillAttributes}),d=new n.VertexComponent({nbVertices:3,bufferId:0}),h=new n.VertexComponent({nbVertices:3,bufferId:1});c.addVertexComponent(d),c.addVertexComponent(h),e.addPrimitive(c);var l=o.createMeshNode(e,f);return l.name="_refplaneitem_",l},_buildEditableRectangle:function(e,t,i){var r=new n.PrimitiveGroup;r.editable=!0,r.fillAttr=new n.FillAttributes,r.lineAttr=new n.LineAttributes,r.pointAttr=new n.PointAttributes;var a=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:new Float32Array(12)}),s=new n.Buffer({component:n.VertexComponentEnum.NORMAL,data:new Float32Array(12)}),c=new n.Buffer({indexBuffer:!0,data:new Uint16Array(e?8:6)});r.addBuffer(0,a),r.addBuffer(1,s),r.addBuffer(2,c);var d=c.data,h=0;e?(d[0]=0,d[1]=1,d[2]=1,d[3]=2,d[4]=2,d[5]=3,d[6]=3,d[7]=0):(d[h++]=0,d[h++]=1,d[h++]=2,d[h++]=0,d[h++]=2,d[h++]=3),h=0,(d=a.data)[h++]=.5*this._length.x,d[h++]=-.5*this._length.y,d[h++]=0,d[h++]=.5*this._length.x,d[h++]=.5*this._length.y,d[h++]=0,d[h++]=-.5*this._length.x,d[h++]=.5*this._length.y,d[h++]=0,d[h++]=-.5*this._length.x,d[h++]=-.5*this._length.y,d[h++]=0,d=s.data,h=0;for(var l=0;l<4;l++)d[h++]=0,d[h++]=0,d[h++]=1;var u=new n.Primitive({nbIndices:e?8:6,connectivity:e?n.ConnectivityTypeEnum.LINES:n.ConnectivityTypeEnum.TRIANGLES,fillGAS:new n.FillAttributes(new n.Color(t.r,t.g,t.b,i)),lineGAS:new n.LineAttributes(new n.Color(t.r,t.g,t.b,i))}),p=new n.VertexComponent({nbVertices:4,bufferId:0,indices:new n.IndexArray({bufferId:2,offset:0})}),_=new n.VertexComponent({nbVertices:4,bufferId:1,indices:new n.IndexArray({bufferId:2,offset:0})});u.addVertexComponent(p),u.addVertexComponent(_),r.addPrimitive(u);var m=o.createMeshNode(r,f);return m.name="_refplaneitem_",m},_updateRectangleSize:function(t){var i=t.getBuffer(n.VertexComponentEnum.POSITION);i[0]=.5*this._length.x,i[1]=-.5*this._length.y,i[3]=.5*this._length.x,i[4]=.5*this._length.y,i[6]=-.5*this._length.x,i[7]=.5*this._length.y,i[9]=-.5*this._length.x,i[10]=-.5*this._length.y,t.updateBuffer(n.VertexComponentEnum.POSITION,0,4);var r=Math.sqrt(.25*this._length.x*this._length.x+.25*this._length.x*this._length.x),a=new e.Sphere(new e.Vector3(0,0,0),r),o=new e.Box3(new e.Vector3(-.5*this._length.x,-.5*this._length.y,0),new e.Vector3(.5*this._length.x,.5*this._length.y,0));t.forceBoundingElements(!0,{sphere:a,box:o})}});return UWA.namespace("THREEDS/Nodes/RefPlaneNode",E)}),define("DS/SceneGraphNodes/CurvedPipeBatchDummyNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/InstancedCurvedPipeManager"],function(e,t,i,r){"use strict";var a=t.extend({init:function(t){this._name=t.name||"curvedPipeBatchDummy",this._pipes=[],this._maxRadius=0,this.dummyGeom=new e.BufferGeometryDS;for(var a=0,n=new Map,o=0;o<t.curvedPipes.length;o++){var s=t.curvedPipes[o],c=!!s.material,d=s.gas.id;c&&(d+="_"+s.material.id);var h=n.get(d);if(void 0===h){h=a,n.set(d,a++);var l=new i.DrawingGroup(s.gas,c?s.material:null,4);this.dummyGeom.drawingGroups.push(l)}this._pipes.push({curvePoints:s.curvePoints,radius:s.radius,baseNormal:s.baseNormal.normalize(),endNormal:s.endNormal.normalize(),baseSideVector:s.baseSideVector.normalize(),material:c?s.material:null,gas:s.gas,dgId:h}),s.radius>this._maxRadius&&(this._maxRadius=s.radius)}var u=new e.CurvedPipeMesh(this.dummyGeom);u.castShadow=!0,u._capWorldRadius=this._maxRadius,u._nbLODsMinusOne=r._nbLODs-1,this._parent(u);var p=this._curvedPipeBBox();return this.forceBoundingBox(p),this},createRenderable:function(){var e=this._parent();return e.isCurvedPipe=!0,e},setMaterial:function(e,t){this._parent(t);for(var i=this._occurrences.length,r=0;r<i;r++)this._occurrences[r].renderable.material=t},setMatrix:function(e){this._parent(e);for(var t=this._occurrences.length,i=null,a=0;a<t;a++)i=this._occurrences[a].renderable,r.setMatrixOnCurvedPipe(i),i._capWorldRadius=this._maxRadius*i.matrixWorld.getMaxScaleOnAxis()},_curvedPipeBBox:function(){for(var t=new e.Vector3(1/0,1/0,1/0),i=new e.Vector3(-1/0,-1/0,-1/0),r=new e.Vector3,a=new e.Vector3,n=new e.Vector3,o=new e.Vector3,s=new e.Vector3,c=new e.Vector3,d=new e.Vector3,h=new e.Vector3,l=null,u=0;u<this._pipes.length;u++)for(var p=this._pipes[u].curvePoints,_=this._pipes[u].radius,f=p.length/3-1,m=0;m<f;m++){a.set(p[3*m],p[3*m+1],p[3*m+2]),n.set(p[3*m+3],p[3*m+4],p[3*m+5]),r.subVectors(n,a);var g=r.dot(r);o.set(_*Math.sqrt(1-r.x*r.x/g),_*Math.sqrt(1-r.y*r.y/g),_*Math.sqrt(1-r.z*r.z/g)),s.subVectors(a,o),d.subVectors(n,o),s.min(d),c.addVectors(a,o),h.addVectors(n,o),c.max(h),l=new e.Box3(s,c),t.min(l.min),i.max(l.max)}var v=(new e.Vector3).addVectors(t,i).multiplyScalar(.5),x=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(t,v).multiplyScalar(1.05)),w=(new e.Vector3).addVectors(v,(new e.Vector3).subVectors(i,v).multiplyScalar(1.05));return new e.Box3(x,w)},_onLinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,a=0;a<t;a++){i=e[a].renderable;for(var n=0;n<this._pipes.length;n++){var o=this._pipes[n];r.addCurvedPipe(i,o.dgId,o.radius,o.curvePoints,o.baseNormal,o.endNormal,o.baseSideVector)}}},_onUnlinkedToSceneGraph:function(){this._parent();for(var e=this._occurrences,t=e.length,i=null,a=0;a<t;a++)i=e[a].renderable,r.removeCurvedPipe(i,this)},setName:function(e){this._name=e},getNodeType:function(){return"Mesh3D"}});return UWA.namespace("THREEDS/Nodes/CurvedPipeBatchDummyNode",a)}),define("DS/SceneGraphNodes/ArrowNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,a,n,o,s,c){"use strict";var d=new e.Vector3,h=new e.Matrix4,l=new e.Matrix4,u=new e.Matrix4,p=t.extend({init:function(i){this._parent(i.name),this._isDynamic=!0,this._headLength=i.headLength?i.headLength:20,this.viewpoint=i.viewpoint,this._initialPoint=i.initialPoint,this._finalPoint=i.finalPoint,this._head=i.head?i.head:0,this._noZ=!i.removeNoZ,this.direction=(new e.Vector3).subVectors(this._finalPoint,this._initialPoint),this.constraintAxis=(new e.Vector3).copy(this.direction).normalize(),this.arrowLength=this.direction.length();var r=n.getWebappsAssetUrl("SceneGraphNodes","");this.mapHead=new e.ImageUtils.loadTexture(r+"models/textures/head.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadDisk=new e.ImageUtils.loadTexture(r+"models/textures/headDisk.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadSquare=new e.ImageUtils.loadTexture(r+"models/textures/headSquare.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHeadCross=new e.ImageUtils.loadTexture(r+"models/textures/headCross.png",void 0,null,null,e.ImageUtils.crossOriginPolicy),this.mapHead.anisotropy=8,this.materialArrow=new e.LineBasicMaterial({side:e.DoubleSide,color:i.color,scale:i.arrowScale?i.arrowScale:6.666,lineWidth:i.arrowWidth?i.arrowWidth:1,dashType:i.arrowDashType?i.arrowDashType:"None",linecap:"butt",transparent:!0,isCPUPattern:!0,alphaTest:.05}),this.materialArrow.force=!0,this.materialHead=new e.MeshBasicMaterial({map:null,side:e.DoubleSide,color:i.color,transparent:!0,alphaTest:.05}),this.materialHead.force=!0;var o=new s;this.nodeArrowBody=c.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],material:this.materialArrow,layerNb:this._noZ?1:0}),this.nodeArrowBody.setShadow(!1),this.nodeArrowBody.setFrustumCulled(!1),this.nodeArrowBody.setPickParent(!0),this.nodeArrowBody.name="tronc de la flche";var d={constraintAxis:this.constraintAxis,name:"billBoardNode_body",type:"Cylindrical",viewpoint:this.viewpoint};this.billBoardArrowBody=new a(d),this.billBoardArrowBody.addChild(this.nodeArrowBody),this.billBoardArrowBody.setPickParent(!0),this.addChild(this.billBoardArrowBody);var h=o.createRectangle({width:1,height:1,fill:!0,fillColor:null,noEdge:!0,layerNb:this._noZ?1:0});this.nodeArrowHead=c.createMeshNode(h,this.materialHead),this.nodeArrowHead.setShadow(!1),this.nodeArrowHead.setFrustumCulled(!1),this.nodeArrowHead.setPickParent(!0),this.nodeArrowHead.name="tte de la flche",this.billBoardArrowHead=new a({name:"billBoardNode_head",viewpoint:this.viewpoint}),this.billBoardArrowHead.addChild(this.nodeArrowHead),this.billBoardArrowHead.setPickParent(!0),this.nodeArrowHeadParent=new t,this.nodeArrowHeadParent.setPickParent(!0),this.addChild(this.nodeArrowHeadParent),this.nodeArrowHeadParent.addChild(this.billBoardArrowHead),this._updateData(),this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this.name="CustomizableArrow";var l=this;return this.cbChange=function(e){l.viewpoint&&l.viewpoint!==e.viewpoint||"@onViewpointChange"===e.eventType&&l._CallBackEventHandler(e)},this.tokenChange=null,this},_onLinkedToSceneGraph:function(){this.tokenChange=i.subscribe({event:"/VISU/"},this.cbChange)},_onUnlinkedToSceneGraph:function(){i.unsubscribe(this.tokenChange)},_getDynamicMatrix:function(e,t,i){return this._CallBackEventHandler(t,i),this.getMatrix()},_CallBackEventHandler:function(e,t){var i=this.getMatrixWorld().getMaxScaleOnAxis();d.getPositionFromMatrix(this.nodeArrowHead.getMatrixWorld());var r=t||e.viewpoint,a=1/(i/r.camera.getWorldSizeFromPixelSize(1,d,r.viewer._getDivClientHeight(),2))*(this._head?this._headLength:0),n=this._head>=2?this.arrowLength:this.arrowLength-a;h.makeScale(a,a,a),l.makeScale(1,1,n),1===this._head?(this.nodeArrowHeadParent.setMatrix(u),d.set(-a/2,0,0),this.nodeArrowHead.setMatrix(h.rotateX(.5*Math.PI).setPosition(d)),d.copy(this.constraintAxis).multiplyScalar(n),h.identity(),this.nodeArrowHeadParent.setMatrix(h.setPosition(d))):2!==this._head&&3!==this._head&&4!==this._head||(d.set(-a/2,-a/2,0),this.nodeArrowHead.setMatrix(h.setPosition(d)),d.copy(this.constraintAxis).multiplyScalar(n),h.identity(),this.nodeArrowHeadParent.setMatrix(h.setPosition(d))),this.nodeArrowBody.setMatrix(l),this.billBoardArrowBody.cbChange(e),this.billBoardArrowHead.cbChange(e)},updateInitialPosition:function(t){this._initialPoint=t,this.setMatrix((new e.Matrix4).setPosition(this._initialPoint)),this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateFinalPosition:function(e){this._finalPoint=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},updateColor:function(e){this.materialArrow.color=e,this.materialHead.color=e},setArrowWidth:function(e){this.materialArrow.setLineWidth(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPattern:function(e){this.materialArrow.setDashPatternType(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setArrowPatternScale:function(e){this.materialArrow.setScale(e),this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadSize:function(e){this._headLength=e,this._CallBackEventHandler({viewpoint:this.viewpoint})},setHeadType:function(e){this._head=e,this._updateData(),this._CallBackEventHandler({viewpoint:this.viewpoint})},getNodeType:function(){return"ArrowNode"},_updateData:function(){switch(this.direction.subVectors(this._finalPoint,this._initialPoint),this.constraintAxis.copy(this.direction).normalize(),this.arrowLength=this.direction.length(),this.billBoardArrowBody.setConstraintAxis(this.constraintAxis),this._head){case 0:this.billBoardArrowHead.setVisibility(!1),this.billBoardArrowHead.setVisibilityFree(!0);break;case 1:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setConstraintAxis(this.constraintAxis),this.billBoardArrowHead.setBillboardType("PseudoSpherical"),this.materialHead.map=this.mapHead;break;case 2:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadDisk;break;case 3:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadSquare;break;case 4:this.billBoardArrowHead.setVisibility(!0),this.billBoardArrowHead.setVisibilityFree(!1),this.billBoardArrowHead.setBillboardType("Spherical"),this.materialHead.map=this.mapHeadCross}this.materialHead._invalidateDisplayRangeLists(),this.materialHead.updateDeferredMaterials()}});return p.types={NONE:0,ARROW:1,DISK:2,SQUARE:3,CROSS:4},UWA.namespace("THREEDS/Nodes/ArrowNode",p)}),define("SceneGraphNodes/ArrowNode",["DS/SceneGraphNodes/ArrowNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/ArrowNode"),e}),define("DS/SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/RectangleLightNode"],function(e){"use strict";return console.warn("Deprecated module, please use RectangleLightNode instead"),UWA.namespace("THREEDS/Nodes/AreaLight",e)}),define("SceneGraphNodes/AreaLightNode",["DS/SceneGraphNodes/AreaLightNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AreaLightNode"),e}),define("DS/SceneGraphNodes/AxisSystemNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/ArrowNode"],function(e,t,i,r,a,n,o,s,c,d){"use strict";var h=t.extend({init:function(t){this._parent(t.name),this._sgRep=t.sgRep?t.sgRep:null,this.headLength=t.headLength,this.arrowLength=t.arrowLength,this.arrowWidth=t.arrowWidth,this.sceneGraph=t.sceneGraph,this.viewpoint=t.viewpoint,this.zoomable=t.zoomable||!1,this._colorX=new o.Color(1,0,0),this._colorY=new o.Color(0,1,0),this._colorZ=new o.Color(0,0,1),t.colors&&(this._colorX=t.colors.colorX?t.colors.colorX:this._colorX,this._colorY=t.colors.colorY?t.colors.colorY:this._colorY,this._colorZ=t.colors.colorZ?t.colors.colorZ:this._colorZ),this._nameX="X",this._nameY="Y",this._nameZ="Z",t.names&&(this._nameX=t.names.nameX?t.names.nameX:this._nameX,this._nameY=t.names.nameY?t.names.nameY:this._nameY,this._nameZ=t.names.nameZ?t.names.nameZ:this._nameZ),this.head=t.head;var i={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorZ,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameZ,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},r=null;this.zoomable?(i.initialPoint=new e.Vector3,i.finalPoint=new e.Vector3(0,0,this.arrowLength),r=new d(i)):r=new c(i);var a={sceneGraph:this.sceneGraph,headLength:this.headLength,direction:new e.Vector3(1,0,0),color:this._colorX,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameX,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},n=null;this.zoomable?(a.initialPoint=new e.Vector3,a.finalPoint=new e.Vector3(this.arrowLength,0,0),n=new d(a)):(n=new c(a)).setMatrix((new e.Matrix4).rotateY(Math.PI/2));var s={sceneGraph:this.sceneGraph,headLength:this.headLength,color:this._colorY,arrowLength:this.arrowLength,arrowWidth:this.arrowWidth,head:this.head,name:this._nameY,pickable:!0,viewpoint:this.viewpoint,removeNoZ:!0},h=null;return this.zoomable?(s.initialPoint=new e.Vector3,s.finalPoint=new e.Vector3(0,this.arrowLength,0),h=new d(s)):(h=new c(s)).setMatrix((new e.Matrix4).rotateX(-Math.PI/2)),this.addChild(h),this.addChild(n),this.addChild(r),this.setNoZ(!0),this},getNodeType:function(){return"AxisSystemNode"},getSGRep:function(){return this._sgRep}});return h.types={NONE:null,ARROW:1,DISK:2},UWA.namespace("THREEDS/Nodes/AxisSystemNode",h)}),define("SceneGraphNodes/AxisSystemNode",["DS/SceneGraphNodes/AxisSystemNode","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AxisSystemNode"),e}),define("DS/SceneGraphNodes/CSS2DNodeManager",["UWA/Class","DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/SceneGraphNodes/CSS2DNode"],function(e,t,i,r,a){"use strict";return e.extend({options:{},init:function(e){this.billboards=[],this._divLayers=[],this.mainLayer=document.createElement("div"),this.mainLayer.id="HTMLBillboards",e.divCss2DElement.appendChild(this.mainLayer),this.viewer=e,this.rank=4,this._subscribe(),this.update()},add:function(e,t){if(!(e instanceof a))return error.log("This is not a CSS2DNode");e.rank=t&&t.rank||0,e.vanish=t&&t.vanish||!1,this.billboards.push(e),this._divLayers[e.rank]||(this._divLayers[e.rank]=document.createElement("div"),this._divLayers[e.rank].id="layer-"+e.rank,this.mainLayer.appendChild(this._divLayers[e.rank])),this._divLayers[e.rank].appendChild(e.css2DNode.element),this.update()},remove:function(e){-1!==this.billboards.indexOf(e)&&this.billboards.splice(this.billboards.indexOf(e),1)},update:function(){this.cameraPosition=this.viewer.viewpoints[0].camera.position;var e=this.viewer.getSceneBoundingSphere();this.centerScene=e.center,this.fadingDistance=e.radius;var t=0,i=this.billboards.length;for(t=0;t<i;++t)this._follow3D(this.billboards[t]);this._zIndexManager()},_subscribe:function(){var e=this;t.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.update.call(e)}),t.subscribe({event:"/VISU/onWindowResized"},function(t){e.update.call(e)})},_follow3D:function(e){if(e.css2DNode.visible){if(e.css2DNode.element.style.display="initial",e.rank>this.rank)return void(e.css2DNode.element.style.display="none");if(e.vanish){var t=1-(e.css2DNode.position.clone().distanceTo(this.cameraPosition)-5*this.fadingDistance)/(15*this.fadingDistance-5*this.fadingDistance);t<0?e.css2DNode.element.style.display="none":t<1&&(e.css2DNode.element.style.opacity=t)}}},_zIndexManager:function(){var e=this.cameraPosition;this.billboards.sort(function(t,i){return e.distanceTo(i.css2DNode.position)-e.distanceTo(t.css2DNode.position)});var t=0,i=this.billboards.length;for(t=0;t<i;++t)this.billboards[t].css2DNode.element.style["z-index"]=t}})}),define("SceneGraphNodes/CSS2DNodeManager",["DS/SceneGraphNodes/CSS2DNodeManager","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/CSS2DNodeManager"),e}),define("DS/SceneGraphNodes/AnnotationText",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Viewpoint","DS/Visualization/GeometryHelper","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/GraphicAttributeSet","DS/SceneGraphNodes/BillBoardNode3D","DS/CoreEvents/Events"],function(e,t,i,r,a,n,o,s,c){"use strict";new e.Projector,new e.Vector3,new e.Matrix4,new e.Matrix4,new e.Matrix4;var d=e.__visibleInCurrentSpace,h=function(t,i,r){if(t){var a=0,n=0,o=1,s=0;switch(i){case 0:case 2:n=1,o=0;break;case 1:case 3:a=1,s=e.COLORMAP_INDEX.BACKGROUND,o=1;break;case 4:r?(a=1,s=e.COLORMAP_INDEX.BACKGROUND,o=1):(n=1,o=0)}return{useColorForText:n,useColorForBackground:a,textColorIndex:s,backgroundOpacity:o}}},l=t.extend({init:function(t){this._parent(t.name),this.height=t.height,this.ready=!1,this.initialize=!1,this.mipMaps=[],this.nbTexturesLoaded=0,this.nbTexturesToLoad=0,this.currentRatio=0,this.realTextHeight=0,this.anchor=t.anchor?t.anchor:0,this.point=t.point?new e.Vector3(t.point.x,t.point.y,t.point.z):new e.Vector3;var i=this;this.viewer=t.viewer,this.contour=t.contour,this.billBoardNode=null,this.quadNode=null,this.textPrimitive=null,this.backgroundPrimitive=null,this.textMaterial=null,this.backgroundMaterial=null,this.gasTransition=t.gasTransition;var r=e.NoOccurrences;return this.viewer&&this.viewer.currentViewpoint&&(this.realTextHeight=this._getRealTextHeight(null,this.viewer.currentViewpoint)),this.cbChange=function(e){if(!r&&i._occurrences)for(var t=0;t<i._occurrences.length;t++){var a=i._occurrences[t],n=a.parent;if(a.scene3js){var o=a.scene3js.viewer;if(d(a._getVisible(),a._getVisibilityFree(),o.getVisibleSpace(),void 0,a)){if(e&&e.viewpoint&&e.viewpoint.viewer&&o!==e.viewpoint.viewer)continue;var s=null;if(e){if(!e.viewpoint)return;if((o._viewpointManager.getViewpointScenegraph(e.viewpoint)||o.internalSceneGraph).root3js!=a.scene3js)return;s=e.viewpoint}else o&&(s=a._getViewpoint()||o.currentViewpoint);s&&(i.ready?i.immediateDraw2DAnnotationText(n.matrix,s):this.realTextHeight=this._getRealTextHeight(n.matrix,s))}}}},this.tokenChange=null,this},isPointOfViewDependant:function(){return!0},_onLinkedToSceneGraph:function(){var e=this;this.tokenChange=c.subscribe({event:"/VISU/"},function(t){"@onViewpointChange"===t.eventType&&e.cbChange(t)}),this.cbChange()},_onUnlinkedToSceneGraph:function(){c.unsubscribe(this.tokenChange)},getFontIndex:function(e){if(0===this.height&&this.mipMaps.length>0)return this.mipMaps.length>1?this.mipMaps.length-2:this.mipMaps.length-1;for(var t=0,i=1;i<this.mipMaps.length;i++)e>=this.mipMaps[i].image.height&&(t=i);return t},setMipmaps:function(t){this.nbTexturesToLoad=t.length,this.mipMaps=t,this.nbTexturesLoaded=0;for(var i=this,r=function(){if(i.nbTexturesLoaded++,i.nbTexturesToLoad==i.nbTexturesLoaded){i.ready=!0;var e=i.getFontIndex(i.realTextHeight);e>i.mipMaps.length-1&&(e=i.mipMaps.length-1),e<0&&(e=0),i.currentRatio=e,i.updateMipMaps(),i.viewer&&i.viewer.render()}},a=0;a<t.length;a++)t[a]instanceof e.Texture&&(t[a].loadEndStatus!==e.AssetLoadingStatus.READY?t[a].onLoadCallbacks.push(r):r())},setPosition:function(e){this.point=e},getNodeType:function(){return"AnnotationText"},_createMaterial:function(t,i,r,a){var n=new e.MaterialUtils.createMatteFaceMaterial;n.transparent=!0,n.side=e.DoubleSide,n.force=!0,n.useLighting=!1,n.useGASColor=!0,n.activatePDSFX();n.setPDSFXVaryings({vTexCoord:{type:"v3"}});var o=r?t.useColorForText:t.useColorForBackground,s={annotColor:{type:"v4",value:new e.Vector4(1)},opacityBack:{type:"f",value:a},drawText:{type:"f",value:r},useGASColorAnnot:{type:"f",value:o},textMask:{type:"t2",value:i}};n.setPDSFXUniforms(s);var c={ComputeVaryingValues:["void ComputeVaryingValues() {","vTexCoord = vGetAttribTexCoord0().xyz;","}"].join("\n")},d={ComputeDiscard:["bool ComputeDiscard() { ","vec4 maskValue = texture2D(textMask, vTexCoord.xy);","return ( (drawText == 0.0 && maskValue.r > 0.5) ||  (drawText == 1.0 && maskValue.r < 0.5) || (opacityBack == 0.0));","}"].join("\n"),ProcessFinalColor:["void ProcessFinalColor(inout vec4 ioFinalColor) { ","ioFinalColor.a = 1.0 * opacityBack;","}"].join("\n")};return n.setPDSFXOverridableFunctions(c,d),n.needsUpdate=!0,n.force=!0,n},_createGeometry:function(e,t,i,r){var o=new a.PrimitiveGroup;o.editable=!0,o.fillAttr=new a.FillAttributes,o.lineAttr=new a.LineAttributes,o.pointAttr=new a.PointAttributes;var s=new a.Buffer;s.size=12,s.component=a.VertexComponentEnum.POSITION,s.format=a.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(s.size);var c=new a.Buffer;c.size=12,c.component=a.VertexComponentEnum.NORMAL,c.format=a.DataTypeEnum.FLOAT,c.dimension=3,c.data=new Float32Array(c.size);var d=new a.Buffer;d.indexBuffer=!0,d.size=6,d.format=a.DataTypeEnum.UINT,d.dimension=1,d.data=new Uint16Array(6);var h=new a.Buffer;h.size=12,h.component=a.VertexComponentEnum.TEX_COORD_0,h.format=a.DataTypeEnum.FLOAT,h.dimension=3,h.data=new Float32Array(h.size),o.addBuffer(0,s),o.addBuffer(1,c),o.addBuffer(2,d),o.addBuffer(3,h),d.data[0]=0,d.data[1]=1,d.data[2]=2,d.data[3]=0,d.data[4]=2,d.data[5]=3,s.data[0]=e,s.data[1]=t,s.data[2]=0,s.data[3]=i,s.data[4]=t,s.data[5]=0,s.data[6]=i,s.data[7]=r,s.data[8]=0,s.data[9]=e,s.data[10]=r,s.data[11]=0;var l=c.data,u=0;l[u++]=0,l[u++]=0,l[u++]=1,l[u++]=0,l[u++]=0,l[u++]=1,l[u++]=0,l[u++]=0,l[u++]=1,l[u++]=0,l[u++]=0,l[u++]=1,u=0,(l=h.data)[u++]=0,l[u++]=0,l[u++]=0,l[u++]=1,l[u++]=0,l[u++]=0,l[u++]=1,l[u++]=1,l[u++]=0,l[u++]=0,l[u++]=1,l[u++]=0;var p=new a.Primitive;p.nbIndices=6,p.connectivity=a.ConnectivityTypeEnum.TRIANGLES,p.geomType="FACE",p.material=this.textMaterial;var _=new a.Primitive;_.nbIndices=6,_.connectivity=a.ConnectivityTypeEnum.TRIANGLES,_.geomType="FACE",_.material=this.backgroundMaterial;var f=new a.VertexComponent;f.component=a.VertexComponentEnum.POSITION,f.nbVertices=4,f.nbValuesPerVertex=3,f.format=a.DataTypeEnum.FLOAT,f.cardinality=0,f.bufferId=0,f.indices=new a.IndexArray,f.indices.format=a.DataTypeEnum.UINT,f.indices.bufferId=2,f.indices.offset=0;var m=new a.VertexComponent;m.component=a.VertexComponentEnum.NORMAL,m.nbVertices=4,m.nbValuesPerVertex=3,m.format=a.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=1,m.indices=new a.IndexArray,m.indices.format=a.DataTypeEnum.UINT,m.indices.bufferId=2,m.indices.offset=0;var g=new a.VertexComponent;g.component=a.VertexComponentEnum.TEX_COORD_0,g.nbVertices=4,g.nbValuesPerVertex=3,g.format=a.DataTypeEnum.FLOAT,g.cardinality=0,g.bufferId=3,g.indices=new a.IndexArray,g.indices.format=a.DataTypeEnum.UINT,g.indices.bufferId=2,g.indices.offset=0,p.addVertexComponent(f),p.addVertexComponent(m),p.addVertexComponent(g),_.addVertexComponent(f),_.addVertexComponent(m),_.addVertexComponent(g),o.addPrimitive(p),o.addPrimitive(_),this.quadNode=n.createMeshNode(o);var v=this.quadNode.getPrimitives();v.length&&2!==v.length&&console.warn("Error during initializers of annotation Text"),this.textPrimitive=v[0],this.backgroundPrimitive=v[1],this.quadNode.setRatio(1),this.quadNode.setMaterialMode(!0)},_updateGeometry:function(e,t,i,r){var n=this.quadNode.getBuffer(a.VertexComponentEnum.POSITION);n[0]=i,n[1]=r,n[3]=i+e,n[4]=r,n[6]=i+e,n[7]=r+t,n[9]=i,n[10]=r+t,this.quadNode.updateBuffer(a.VertexComponentEnum.POSITION,0,4)},_getRealTextHeight:function(e,t){if(t.isNative2D()){var r=this.height,a=t.getPixelFromModelRatio();this.realTextHeight=1*r/a}else this.realTextHeight=this.height/function(e,t){var r=1;if(e.getProjectionType()==i.PERSPECTIVE){var a=e.getEyePosition(),n=e.getSightDirection();r=n.x*(t.x-a.x)+n.y*(t.y-a.y)+n.z*(t.z-a.z)}else r=e.control.distanceToTarget;return Math.abs(r)*e.getScaleFactor()}(t,this.point);return this.realTextHeight},updateMipMaps:function(){this.initialize=!0;var t=this.mipMaps[this.currentRatio],i=t.image.height,r=t.image.width,a=(this.point.x,this.point.y,0),n=0,o=this.anchor;void 0!==o&&(o!=e.AnchorPoint.BOTTOM_CENTER&&o!=e.AnchorPoint.BASE_CENTER&&o!=e.AnchorPoint.TOP_CENTER||(a-=.5*r),o!=e.AnchorPoint.BOTTOM_RIGHT&&o!=e.AnchorPoint.BASE_RIGHT&&o!=e.AnchorPoint.TOP_RIGHT||(a-=r),o!=e.AnchorPoint.TOP_LEFT&&o!=e.AnchorPoint.TOP_CENTER&&o!=e.AnchorPoint.TOP_RIGHT||(n-=i));var d=h(this.viewer.getRenderer(),this.contour,this.viewer.currentViewpoint.isNative2D());if(this.backgroundMaterial||this.textMaterial)this._updateMaterials(d,this.mipMaps[this.currentRatio]);else{this.backgroundMaterial=this._createMaterial(d,this.mipMaps[this.currentRatio],0,d.backgroundOpacity),this.textMaterial=this._createMaterial(d,this.mipMaps[this.currentRatio],1,1);var l=this;c.subscribe({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE"},function(e){var t=h(e.parameters.viewer.getRenderer(),l.contour,e.parameters.viewer.currentViewpoint.isNative2D());l._updateMaterials(t,l.mipMaps[l.currentRatio])})}if(this.quadNode)this._updateGeometry(r,i,a,n);else{this._createGeometry(a,n,a+r,n+i);var u=(new e.Matrix4).setPosition(this.point);this.billBoardNode=new s({type:"Spherical"}),this.billBoardNode.setMatrix(u),this.billBoardNode.addChild(this.quadNode),this.quadNode._setGAS(this.gasTransition),this.billBoardNode._setGAS(this.gasTransition),this.addChild(this.billBoardNode)}this._setPrimitivesGas(d)},_setPrimitivesGas:function(t){var i=this.gasTransition,r=this.gasTransition;t.useColorForText||(i=new o({basic:!0,colorIndex:t.textColorIndex,inheritanceCustom:e.GASEnumCustom._TYPE_FROM_PARENT})),this.quadNode._setGAS([this.textPrimitive],i),this.quadNode._setGAS([this.backgroundPrimitive],r)},_updateMaterials:function(e,t){this.backgroundMaterial.updatePDSFXUniform("opacityBack",e.backgroundOpacity),this.backgroundMaterial.updatePDSFXUniform("useGASColorAnnot",e.useColorForBackground),this.backgroundMaterial.updatePDSFXUniform("textMask",t),this.textMaterial.updatePDSFXUniform("useGASColorAnnot",e.useColorForText),this.textMaterial.updatePDSFXUniform("textMask",t),this.backgroundMaterial.needsUpdate=!0,this.textMaterial.needsUpdate=!0},immediateDraw2DAnnotationText:function(e,t){var i=this._getRealTextHeight(e,t),r=this.getFontIndex(i);r>this.mipMaps.length-1&&(r=this.mipMaps.length-1),r<0&&(r=0),this.currentRatio===r&&this.initialize||(this.currentRatio=r,this.updateMipMaps())}});return UWA.namespace("THREEDS/Nodes/AnnotationText",l)}),define("SceneGraphNodes/AnnotationText",["DS/SceneGraphNodes/AnnotationText","DS/DSMigration/DSMigration"],function(e,t){return t.deprecateModule("SceneGraphNodes/AnnotationText"),e}),define("DS/SceneGraphNodes/FixedSizePlaneNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","WebappsUtils/WebappsUtils","DS/Mesh/MeshUtils","DS/Visualization/GeometryHelper","DS/Visualization/SceneGraphFactory"],function(e,t,i,r,a,n,o,s,c){"use strict";var d=t.extend({init:function(i){this._parent(i.name),this.setColor(i.color),this.setName(i.name);var r=i.length1?i.length1:10,a=i.length2?i.length2:10,n=i.origin?i.origin:new e.Vector3,o=i.direction1?i.direction1.normalize():new e.Vector3(0,1,0),s=i.direction2?i.direction2.normalize():new e.Vector3(1,0,0),d=(new e.Vector3).crossVectors(o,s),h=c.createRectangleNode({color:this._color,width:r,height:a,fill:i.fill,sharing:i.sharing,cornerPoint:new e.Vector2(-r/2,-a/2)});h.setShadow(!1),h.setFrustumCulled(!1);var l=new e.Matrix4;l.makeBasis(o,s,d),l.setPosition(n);var u=new t("NodeForPlane");return u.setMatrix(l),u.addChild(h),this.addChild(u),u._setRatio(1),this},setColor:function(e){this._color=e},setName:function(e){this._name=e}});return UWA.namespace("THREEDS/Nodes/FixedSizePlaneNode",d)});