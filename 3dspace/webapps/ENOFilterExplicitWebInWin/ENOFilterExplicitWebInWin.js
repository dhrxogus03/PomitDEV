define("DS/ENOFilterExplicitWebInWin/views/filterRepairUI",["UWA/Core","UWA/Element","UWA/Promise","UWA/Class/View","DS/Tree/TreeListView","DS/TreeModel/TreeNodeModel","DS/Handlebars/Handlebars4","DS/UIKIT/SuperModal","DS/UIKIT/Mask","DS/WAFData/WAFData","DS/Controls/Accordeon","DS/Controls/TooltipModel","DS/Controls/Button","DS/CollectionView/ResponsiveLargeTilesCollectionView","i18n!DS/ENOFilterExplicitWebInWin/assets/nls/ENOStrRefinementUX.json","text!DS/ENOFilterExplicitWebInWin/template/filterRepairUITemplate.html","css!DS/ENOFilterExplicitWebInWin/ENOFilterExplicitWebInWin.css","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENOFilterBIUX/NGFServices","DS/ENOFilterBIUX/FBIServices"],function(e,t,i,r,n,a,l,o,s,c,d,h,p,u,g,v,f,m,b,_){"use strict";return r.extend({setup:function(e){this._isRepairFilterLaunchedInWidget=!1,this._trackerId="isWebInWin",this.securityCtx=e.ctx,this.serverUrl=e.url,this._brokenPathObj="object"==typeof e.brokenPaths?e.brokenPaths:JSON.parse(e.brokenPaths),this._template=l.compile(v),this.container.addEvent("click",function(e){return e.stopPropagation(),!1})},render:function(){var t=this;this.container.setContent(this._template({AppType:this._isRepairFilterLaunchedInWidget?"widget":"webInWin",filterNameToRepair:g.get("RepairPanelHeader")})),this._ListOfTileViewCollection=[],this._myAccordeon=new d({touchMode:!1,style:"filled-separate"}),this._myAccordeon.inject(this.getElement(".repairFilter-list-accordeons"));var i=function(e,i){for(var r=e.getLabel(),n="",a=t._ListOfTileViewCollection.length,l=0;l<a;l++){var o=t._ListOfTileViewCollection[l].model;if(o.length)for(var s=0;s<o.length;s++)if(r===o[s].getLabel()){n=l,t._myAccordeon.getExpanderFromIndex(l).expand();break}}if(n>=0){var c=t.getElement(".statusNum-"+n);c.setText("add"===i?g.get("SolvedCellName"):g.get("IgnoreCellName")),c.setStyle("background-color","add"===i?"limegreen":"darkorange"),(l=t.getElement(".accordeon-"+n)).setText("add"===i?g.get("IgnoreTitle"):g.get("ReactivateTitle"))}};let r=t._brokenPathObj.paths.length;for(var n=0;n<t._responseJsonObj.paths.length;n++){var l=new u({height:"inherit",displayTitleTooltip:!0,displayPropertiesTooltip:!0,useDragAndDrop:!1,toggle:!0});l.selectionBehavior={unselectAllOnEmptyArea:!0,toggle:!0,canMultiSelect:!1,enableShiftSelection:!1,enableListSelection:!1,enableFeedbackForActiveCell:!0};for(var s=[],c=0;c<t._responseJsonObj.paths[n].length;c++){var v=t._responseJsonObj.paths[n][c],f=v.length,m=t._checkForDeletedPathCase(v),_=!!m&&this._checkForReplacedPathCase(v,this._brokenPathObj.paths[n]);if(f>0&&v[f-2].name&&m&&!_){var F=this._buildNodeFromData(v);if(F.label){var I=new a({label:F.label,subLabel:v[f-1].trueType,thumbnail:v[f-1].preview_url,data:F.data});s.push(I)}}}if(s.length>0){l.model=s,this._ListOfTileViewCollection.push(l),l.modelProvider.selectNode(s[0]);var T=e.createElement("div",{class:"tile1 accordeon-node"});T.inject(this.getElement(".repairFilterTiles-test")),l.inject(T);var y=l.model.length,S=125*y+"px";T.setStyle("height",S);var O={header:t._brokenPathObj.paths[n][t._brokenPathObj.paths[n].length-1].name,content:T};this._myAccordeon.addItem(O);var k=e.createElement("span",{class:"ignore-span accordeon-"+n,text:g.get("IgnoreTitle")});k.setAttribute("expander",n);var N=e.createElement("div",{class:"statusOfRepair statusNum-"+n,text:g.get("SolvedCellName")}),C=this.getElements(".wux-controls-expander-header-container")[n];k.inject(C),N.inject(C),C.tooltipInfos=new h({shortHelp:O.header,mouseRelativePosition:!0}),k.addEventListener("click",function(e){var i=e.target.getAttribute("expander"),r=t._ListOfTileViewCollection[i],n=e.target.getText();g.get("IgnoreTitle")===n?(t._ignore=!0,e.target.setText(g.get("ReactivateTitle")),r.modelProvider.unselectAll()):g.get("ReactivateTitle")===n&&(t._reactivate=!0,e.target.setText(g.get("IgnoreTitle")),r.modelProvider.selectNode(r.model[0]))},!1)}else if(n<r){this._ListOfTileViewCollection.push(l);var E=new UWA.Element("div",{text:g.get("ObjectDeleted")});let i=t._brokenPathObj.paths[n];O={header:n<r?i[i.length-1].name:"Unknown("+n+")",content:E};this._myAccordeon.addItem(O);var R=e.createElement("span",{class:"ignore-span deletedPath-span accordeon-"+n,text:g.get("Deleted")});C=this.getElements(".wux-controls-expander-header-container")[n];R.inject(C),C.tooltipInfos=new h({shortHelp:O.header,mouseRelativePosition:!0})}l.onSelectionAdd(function(e){i(e,"add")}),l.onSelectionRemove(function(e){i(e,"remove")})}var w=function(e){e.stopImmediatePropagation();var t=e.options.expanderIndex,i=this._ListOfTileViewCollection[t],r=this.getElement(".statusNum-"+t);this._ignore?(i.modelProvider.unselectAll(),this._ignore=!1,r.setText(g.get("IgnoreCellName")),r.setStyle("background-color","darkorange")):this._reactivate&&(i.modelProvider.selectNode(i.model[0]),this._reactivate=!1,r.setText(g.get("SolvedCellName")),r.setStyle("background-color","limegreen"))};this._myAccordeon.getContent().addEventListener("expand",w.bind(this)),this._myAccordeon.getContent().addEventListener("collapse",w.bind(this));var x=this.getElement(".repairFilter-footer"),D=t._isRepairFilterLaunchedInWidget?"TitleOK":"TitleApply";return this.applyButton=new p({touchMode:!0,domId:"applyButton",label:g.get(D),emphasize:"secondary"}).inject(x),this._isRepairFilterLaunchedInWidget||(this.saveButton=new p({touchMode:!0,domId:"saveButton",label:g.get("TitleSave"),emphasize:"secondary"}).inject(x),this.saveButton.addEventListener("buttonclick",function(){new o({closable:!0,renderTo:document.body,id:"superModaldialog"}).confirm(g.get("SaveWarning"),g.get("SaveWarningTitle"),function(e){if(b.setUsageTracker(t._trackerId,"NGF-RepairFilter","save-solved-repair"),console.log("Confirm result: "+e),e){var i=t._operateModel();t._webInWinNotif("SaveButton",i.listOfList)}})})),this.cancelButton=new p({touchMode:!0,domId:"cancelButton",label:g.get("TitleCancel"),emphasize:"secondary"}).inject(x),this.cancelButton.addEventListener("buttonclick",function(){if(b.setUsageTracker(t._trackerId,"NGF-RepairFilter","cancel-solved-repair"),t._isRepairFilterLaunchedInWidget){t.dispatchEvent("NGF_CancelRepairFilter",{listOfList:"CancelRepair"})}else t._webInWinNotif("CancelButton")}),this.applyButton.addEventListener("buttonclick",function(){b.setUsageTracker(t._trackerId,"NGF-RepairFilter","apply-solved-repair");var e=t._operateModel();t._isRepairFilterLaunchedInWidget?t.dispatchEvent("NGF_RepairFilter",e):t._webInWinNotif("ApplyButton",e.listOfList)}),this},RepairFilterInWidget:function(e){this._isRepairFilterLaunchedInWidget=!0,this._trackerId=e},fetchData:function(){var e=this;return new i(function(t){let i=Date.now();c.authenticatedRequest(e.serverUrl+m.getGoodVersionsIdsWebSrv(),{headers:_.getRESTHeaders(e.securityCtx),method:"POST",data:JSON.stringify(e._brokenPathObj),onComplete:function(r){b.setPerformanceTracker(e._trackerId,"NGF-RepairFilter","NGF_RepairFilter",{Fetch_duration:Date.now()-i},1);var n=JSON.parse(r);"object"==typeof n&&Array.isArray(n.paths)?e._responseJsonObj=n:e._responseJsonObj={paths:[]},e._responseJsonObj?e._getThumbnailAndTypeInfo().then(function(){n.error&&-1==n.error.code&&(e._isRepairFilterLaunchedInWidget?m.displayNotification({level:"warning",title:"Repair Filter",message:n.error.message}):alert(n.error.message)),t("RepairFilterFetchData_SUCCESS")}):t("RepairFilterFetchData_SUCCESS")},onFailure:function(i){console.log(" => Fetch data for Repair Filter failed, error = "+i),alert(g.get("ServerError")),s.unmask(e.container),t("RepairFilterFetchData_FAILURE")}});var r=e._brokenPathObj.paths.length;b.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-count",value:r});var n=0,a=1/0,l=0;e._brokenPathObj.paths.forEach(e=>{n+=e.length,a=Math.min(a,e.length),l=Math.max(l,e.length)}),b.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-min",value:a}),b.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-max",value:l}),b.setUsageTracker(e._trackerId,"NGF-RepairFilter",{label:"broken-path-length-average",value:n/r*1e3})})},_checkForDeletedPathCase:function(e){if(0==e.length)return!1;for(var t=0;t<e.length;t++)if(!e[t].name)return!1;return!0},_checkForReplacedPathCase:function(e,t){if(e[e.length-1].logicalid!=t[t.length-1].logicalid)return!0},_buildNodeFromData:function(e){for(var t=e[e.length-2].name+" - "+e[e.length-1].revision,i=e[e.length-2].coretype,r=[],n=[],a=0;a<e.length;a++)r.push(e[a].physicalid),n.push(e[a].logicalid);return{label:t,subLabel:i,data:{pathOfPhysicalID:r,pathOfLogicalID:n}}},_webInWinNotif:function(e,t){var i=JSON.stringify(t);console.log(i),"undefined"!=typeof CATCefSendString&&dscef.sendString(e+"="+i)},_operateModel:function(){for(var e=[],t=[],i=this._ListOfTileViewCollection.length,r=0;r<i;r++){var n=this._ListOfTileViewCollection[r],a=n.getActiveCellID();if("undefined"!==a&&n.modelProvider.isNodeSelected(n.model[a])){var l=n.getModelAt(a).options.data;e.push(l.pathOfPhysicalID),t.push(l.pathOfLogicalID)}}return{listOfList:e}},_getThumbnailAndTypeInfo:function(){var e=this;return new i(function(t){for(var i=[],r=e._responseJsonObj.paths,n=r.length,a=0;a<n;a++){var l=r[a].length;if(1==l)(s=r[a][0].length)>0&&i.push(r[a][0][s-1].physicalid);else for(var o=0;o<l;o++){var s;(s=r[a][o].length)>0&&i.push(r[a][o][s-1].physicalid)}}i.length>0?e._fetchTypeUrlInfo(i).then(function(r){var n=[];if(r.results=r.results||[],r.results.length<=i.length){for(var a=0;a<r.results.length;a++){for(var l,o,s,c=r.results[a],d=0;d<c.attributes.length;d++){var h=c.attributes[d];"resourceid"==h.name&&(l=h.value),"preview_url"==h.name&&(o=h.value),"type"==h.name&&(s=h.value)}var p={physicalid:l,url:o,type:s};n.push(p)}for(var u=e._responseJsonObj.paths,g=u.length,v=0;v<g;v++){var f=u[v].length;if(1==f){if((_=u[v][0].length)>0)for(var m=u[v][0][_-1].physicalid,b=0;b<n.length;b++)n[b].physicalid==m&&(u[v][0][_-1].preview_url=n[b].url,u[v][0][_-1].trueType=n[b].type)}else for(b=0;b<f;b++){var _;if((_=u[v][b].length)>0){m=u[v][b][_-1].physicalid;for(var F=0;F<n.length;F++)n[F].physicalid==m&&(u[v][b][_-1].preview_url=n[F].url,u[v][b][_-1].trueType=n[F].type)}}}t()}}):t()})},_fetchTypeUrlInfo:function(e){var t=this;return new i(function(i,r){var n={headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",type:"json",proxy:"passport",data:JSON.stringify({label:"NGF_ExecuteFetch",physicalid:e,select_file:["icon","thumbnail_2d"],select_predicate:["type"]}),onComplete:function(e){i(e)},onFailure:function(e){r(e)}};c.authenticatedRequest(t.serverUrl+m.getFetchWebSrv(),n)})}})});