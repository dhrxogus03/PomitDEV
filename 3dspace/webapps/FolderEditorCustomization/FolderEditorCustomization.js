define("DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils",["UWA/Core"],function(e){"use strict";return{splitExtension:function(e){var t=e.split("."),i="";return t.length>1&&(i=t.pop()),{filename:t.join("."),extension:i}},editFileName:function(e,t){var i,o=e.split("."),n="";return o.length>1&&(n="."+o.pop()),i=t<1e3?("00"+t).slice(-3):""+t,o.join(".")+"_"+i+n},checkFolderEditorInvalidCharsWithSlash:function(e){for(var t=['"',"#","$","@","%","*",",","?","\\","<",">","[","]","|",":","/"],i={hasInvalidChar:!1,badChars:""},o=0;o<t.length;o++)if(e.indexOf(t[o])>=0){i.hasInvalidChar=!0,i.badChars=t.join("");break}return i},isExistsInArray:function(e,t){for(var i=0;i<t.length;i++)if(t[i]===e)return!0;return!1},isExistsInArrayUpperCase:function(e,t){for(var i=0;i<t.length;i++)if(t[i].toUpperCase()===e.toUpperCase())return!0;return!1},formatBytes:function(e,t){if(0===e)return"0 Byte";var i=t+1||3,o=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,o)).toPrecision(i)+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][o]},getStringByte4UTF8:function(e){for(var t=[0,1,1,1,2,3,2,3,4,3],i=0,o=0;o<e.length;o++)i+=t[encodeURIComponent(e.charAt(o)).length];return i},Sanitize:{encode:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}},notAllowedChars:['"',"#","$","@","%","*",",","?","\\\\","<",">","\\[","\\]","|",":"],notAllowedCharsForOwner:['"',"#","$","%","*",",","?","\\\\","<",">","\\[","\\]","|",":"],removeControllCode:function(e){return e.replace(/[\t\r\n]/g,"")},escapeControllCode:function(e){return e.replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/\n/g,"\\n")}}}),define("DS/FolderEditorCustomization/BulkDownload/ActionBar_BulkDownloadCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol","i18n!DS/FolderEditor/assets/nls/FolderEditor"],function(e,t,i,o,n){"use strict";return t.extend({labelTopBar:n.Dialog_Title,isInsert:!0,datas:{},init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1})},beginExecute:function(){},execute:function(){require(["DS/FolderEditorCustomization/BulkDownload/BulkDownload"],function(e){function t(e,t,i){for(var o=[],n=0;n<e.length-i;n++)"FolderSection_AllFolders"!==e[n].type&&o.push(e[n].label);return o.join(t)}var o,l,a=i.getSelectedNodes(),s=function(e){for(var t=[],i=[],o=0;o<e.length;o++)i.push(e[o].getID());function n(e,t){for(var i=0;i<t.length;i++)if(t[i]===e)return!0;return!1}for(o=0;o<e.length;o++){for(var l=e[o],a=l.getParents(),s=!1,r=0;r<a.length;r++)if(n(a[r].getID(),i)){s=!0;break}s||t.push(l.getID())}return t}(a),r=i.getCurrentFolder(),d=i.getCurrentFolderPath();1!==a.length||"Folder"!==a[0].plmType&&"RootFolder"!==a[0].plmType?l=n.name_Section_AllFolders+" > "+t(d," > ",0):a[0].getID()===r.getID()?(l=n.name_Section_AllFolders+" > "+t(d," > ",0),o=t(d,"/",1)):(l=n.name_Section_AllFolders+" > "+t(d," > ",0))===n.name_Section_AllFolders+" > "?l+=a[0].getLabel():l+=" > "+a[0].getLabel(),void 0===o&&(o=t(d,"/",0)),new e({ui:!0,renderTo:widget.body,destination:"",parent:l,folderpath:o}).review(s).then(function(e){})})},endExecute:function(){}})}),define("DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/DocumentManagement/DocumentManagement","DS/FolderEditor/service/FolderEditorWebService","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PlatformAPI/PlatformAPI"],function(e,t,i,o,n,l,a,s){"use strict";return{getDocument:function(e){o.getDocuments([e.id],e)},getFolder:function(o){if(!e.is(o,"object"))throw new Error("Invalid inputs for BulkDownload.getFolder");var n=i.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+o.id+"/content?Content=All&FilterChildren=Yes",l={method:"GET",headers:{Accept:"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:12e4};l.onComplete=o.onComplete,l.onFailure=o.onFailure,t.authenticatedRequest(n,l)},getChildren:function(o){if(!e.is(o,"object"))throw new Error("Invalid inputs for BulkDownload.getChildren");var n=i.get3DSpaceUrl()+"/resources/enopad/api/expand",l={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:12e4};l.onComplete=o.onComplete,l.onFailure=o.onFailure,l.data=JSON.stringify({rootids:o.id,level:-1,with_iterations:!0}),t.authenticatedRequest(n,l)},getFileStatus:function(o){if(!e.is(o,"object"))throw new Error("Invalid inputs for BulkDownload.getFileStatus");var n=i.get3DSpaceUrl()+"/resources/enodec/api/getfilestatus",l={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:12e4};l.onComplete=o.onComplete,l.onFailure=o.onFailure,l.data="{inputids: [{id:"+o.id.join("},{id:")+"}]}",t.authenticatedRequest(n,l)},getURLs:function(e){var t={};t.onComplete=e.onComplete,t.onFailure=e.onFailure,o.downloadDocuments(e.id,t)},getUserPreferences:function(e){n.getUserPreferences(e)},setUserPreferences:function(e){n.setUserPreferences(e)},fetch:function(t){var i={intent:"explore_2D",debug:l.getSetting("enopad_webapis_debug")};a.fetch({enopad_webapis:l.getSetting("enopad_webapis"),data:i,pids:t.pids,onComplete:function(i){var o=e.is(i,"string")?JSON.parse(i):i;t.onComplete(o)},onFailure:function(e){t.onFailure(e)},timeout:12e4})},listFolders:function(e){var o=i.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+e.pfolderid+"/folders",n={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(o,n)},roots:function(e){var o=i.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/roots",n={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(o,n)},getProperties:function(e){var o=i.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+e.folderid+"/properties",n={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(o,n)},newFolder:function(e,o){var n={SecurityContext:"ctx::"+e.securityContext,type:"folder"},l=i.get3DSpaceUrl()+"/resources/v1/collabServices/authoring/op/createContent?select=type&select=physicalid&select=cestamp";""!==e.folderid&&(l+="&folderID="+e.folderid);var a={method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+e.securityContext},data:JSON.stringify(n),timeout:12e4};a.onComplete=o.onComplete,a.onFailure=o.onFailure,t.authenticatedRequest(l,a)},updateFolderAttrib:function(e,o){var n=[{op:"replace",path:"description",value:e.description.replace(/\n/g,"\\n")},{op:"replace",path:"name",value:e.name}];if(e.owner&&s.getUser().login!==e.owner){n.push({op:"replace",path:"owner",value:e.owner});var l=e.securityContext.split(".");n.push({op:"replace",path:"organization",value:l[1]}),n.push({op:"replace",path:"project",value:l[2]})}var a={requests:[{queryParams:{select:["physicalid"]},body:n,path:"model/bus/"+o.folderid,method:"PATCH"}]},r=i.get3DSpaceUrl()+"/resources/v1/collabServices/attributes/op/update",d={method:"PUT",type:"json",proxy:"passport",headers:{"Content-Type":"application/json",SecurityContext:"ctx::"+e.securityContext},data:JSON.stringify(a),timeout:12e4};d.onComplete=o.onComplete,d.onFailure=o.onFailure,t.authenticatedRequest(r,d)},personSearch:function(e){var o=i.get3DSpaceUrl()+"/resources/v2/e6w/service/PersonSearch?searchStr="+e.name,n={method:"GET",type:"json",proxy:"passport",timeout:12e4};n.onComplete=e.onComplete,n.onFailure=e.onFailure,t.authenticatedRequest(o,n)},deleteFolder:function(e,o){var n=i.get3DSpaceUrl()+"/resources/lifecycle/Delete/structure",l={method:"POST",type:"json",proxy:"passport",headers:{"Content-Type":"application/json",SecurityContext:e.securityContext},timeout:12e4},a="?";a+="SecurityContext="+e.securityContext;var s={data:[{physicalid:e.folderid}]};l.data=JSON.stringify(s);var r=function(){};l.onComplete=o.onComplete||r,l.onFailure=o.onFailure||r,t.authenticatedRequest(n+a,l)}}}),define("DS/FolderEditorCustomization/BulkDownload/BulkDownload",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/i3DXCompassServices/i3DXCompassPubSub","DS/FolderEditor/utils/FolderAlert","DS/ENOFloatingPanel/ENOFloatingPanel","DS/UIKIT/Scroller","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/UIKIT/Form","DS/Controls/LineEditor","DS/Controls/ProgressBar","DS/UIKIT/Spinner","i18n!DS/FolderEditorCustomization/assets/nls/BulkDownload.json","DS/PADUtils/PADProbes","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(e,t,i,o,n,l,a,s,r,d,c,u,g,p,h,f,_,m,v,w,y){"use strict";var F={dialogBody:'<div class="flip-container"><div class="flipper"><div class="front"><div class="review-files"></div></div><div class="back"><div class="form-settings"></div></div></div></div>'},C=t.extend(o,i,{name:"BulkDownload",_logger:null,defaultOptions:{ui:!0,renderTo:null,id:[],destination:"",folder:"Workspace Vault",rootFolder:"Personal Workspace",document:"Document",product:"CATProduct",part:"CATPart",process:"CATProcess",analysis:"CATAnalysis",analysisResult:"CATAnalysisResults",drawing:"CATDrawing",design:"CATIA Design Table",cgr:"CATIA CGR",analysisComputations:"CATAnalysisComputations",shape:"CATShape"},URLATTR_NOURL:"NOURL",URLATTR_URL:"URL",FILENAMEATTR_EO:"EO-",_id:null,_settingChanged:!1,_loadingReady:!1,_getFileStatusAPIisReady:!1,_warningDisplayisReady:!1,_userCanceled:!1,_downloadFailed:!1,_downloadStarted:!1,_cannotDownload:!1,_folders:{},_foldersForDownload:null,_folderpathForFlatDownload:null,_folderRelation:{_map:{},pushFoldername:function(e,t){void 0===this._map[e.toUpperCase()]&&(this._map[e.toUpperCase()]=[]),null!==t&&this._map[e.toUpperCase()].push(t)},hasParentFoldername:function(e){var t=!1;return e.toUpperCase()in Object.keys(this._map)&&(t=!0),t},getFoldernames:function(e){var t=this._map[e.toUpperCase()];return void 0===t&&(t=[]),t},clearMap:function(){this._map={}}},_files:{},_syncFiles:{_syncFileList:[],_syncFileMap:{},addFile:function(e){var t=!1;return void 0===this._syncFileMap[e]&&(this._syncFileMap[e]=1,this._syncFileList.push(e),t=!0),t},concatFiles:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.addFile(i)}},getList:function(){return this._syncFileList},getLength:function(){return this._syncFileList.length},getItem:function(e){return this._syncFileList[e]},clearList:function(){this._syncFileList=[],this._syncFileMap={}}},_issues:[],_errors:{ERRORID_NOTSYNC:"notUpToDate",ERRORID_INVALID:"IEF035520650",ERRORID_NOTEXIST:"IEF035520649",ERRORID_OTHER:"UNKNOWN",ERRORID_EMBEDED_COMPONENT:"#4000043",_syncErrorMap:{},_errorMap:{},_logger:null,pushError:function(e,t,i){var o=this;o._logger.log("Error happens. fileid=["+e+"], errorId=["+t+"], errorMessage=["+i+"]");var n=function(e){return e===o.ERRORID_NOTSYNC?m.displayMessage_notSync:e===o.ERRORID_INVALID?m.displayMessage_invalid:e===o.ERRORID_NOTEXIST?m.displayMessage_notExist:m.displayMessage_unknown},l=o._errorMap[e];void 0===l?(l={fileid:e,errorid:t,errorMessage:i,displayError:n(t)},o._errorMap[l.fileid]=l,t===o.ERRORID_NOTSYNC&&(o._syncErrorMap[l.fileid]=l)):l.errorid===o.ERRORID_OTHER&&(l.errorid=t,l.displayError=n(t))},getSyncErrorLength:function(){return Object.keys(this._syncErrorMap).length},getFileIdList:function(){return Object.keys(this._errorMap)},getError:function(e){return this._errorMap[e]},init:function(e){this._logger=e,this.clearList()},getErrorIdFromErrorMessage:function(e){var t=this.ERRORID_OTHER;return e.indexOf(this.ERRORID_EMBEDED_COMPONENT)>=0&&(t=this.ERRORID_EMBEDED_COMPONENT),t},clearList:function(){this._errorMap={},this._syncErrorMap={}}},_stats:{folders:0,files:0,size:0,error:0,warning:0,conflictCount:0},_settings:{DOWNLOAD_FLAT_PREFERENCE:{keyname:"BulkDownload_downloadFlat",defaultvalue:"false"},DOWNLOAD_WITH_CSV_PREFERENCE:{keyname:"BulkDownload_downloadWithCSV",defaultvalue:"false"},downloadFlat:!1,downloadWithCSV:!1},_tooltips:{_map:{},_sequence:0,pushTooltip:function(e){return this._sequence++,this._map[this._sequence]=e,this._sequence},clearList:function(){for(var e=Object.keys(this._map),t=0;t<e.length;t++)this.deleteTooltip(e[t]);this._map={},this._sequence=0},deleteTooltip:function(e){this._map[e].destroy(),delete this._map[e]}},_progress:{_progressbar:null,_injectTo:null,_maxValue:0,_currentValue:0,initProgress:function(e,t,i){this._progressbar&&this._progressbar.destroy(),this._progressbar=new f({shape:"circular",statusFlag:!1,emphasize:e,dislpayFlag:!1,displayStyle:"lite"}),this._maxValue=null,this._progressbar.inject(t),this._progressbar.value=0,this._maxValue=void 0!==i?i:4,this._currentValue=0,this._injectTo=t},addCurrentValue:function(){this._currentValue++;var e=this._currentValue/this._maxValue*100;this._progressbar.value=e,this._maxValue===this._currentValue&&this._injectTo.removeClassName("active")},startProgress:function(){this._injectTo.addClassName("active")},setErrorProgress:function(){this._progressbar.emphasize="high-attention"}},init:function(e){var t=v.createProbe("BulkDownload_init");return this._logger=n.getLogger(C),this._logger.log("init"),this._parent(e),this.options.container=this.options.folder+","+this.options.rootFolder,this.options.expandable=this.options.product+","+this.options.part+","+this.options.analysis+","+this.options.process+","+this.options.drawing+","+this.options.shape,this.options.leaf=this.options.document+","+this.options.analysisComputations+","+this.options.cgr+","+this.options.analysisResult+","+this.options.design,this._getFileStatusAPIisReady=!1,this._warningDisplayisReady=!1,this._userCanceled=!1,this._downloadFailed=!1,this._downloadStarted=!1,this._cannotDownload=!1,t.end(),this},closeDialog:function(){this._tooltips.clearList(),this.dialog&&this.dialog.destroy()},displayDialog:function(){var t=v.createProbe("BulkDownload_displayDialog"),i=this;i._logger.log(">>> start displayDialog"),i._logger.log("injecting the modal dialog in widget body");var o=new r({closable:!0,resizable:!0,autocenter:!0,overlay:!0,header:null,className:"bulkDownloadDialog",title:m.dialogTitle,body:F.dialogBody,footer:"",visible:!0,limitParent:!0,events:{onHide:function(){},onClose:function(){i.clickCancelButton()}}}).inject(i.options.renderTo),n=o.getHeader().getElementsByClassName("floatingPanel_title")[2],l=n.getChildren()[0];if(void 0!==i.options.parent){var a=new g({position:"bottom",target:l,body:i.options.parent});i._tooltips.pushTooltip(a)}o.getContent().setStyle("min-width","650px"),o.getContent().setStyle("min-height","300px"),o.getContent().setStyle("height","350px");var s=e.createElement("div",{class:"progressbar-area"}).inject(o.getFooter());i.progressbarArea=s;var p=e.createElement("span",{class:"stats-area-displayCurrentProcess"}).inject(o.getFooter());i.statsArea=p;var h=new u({value:m.download,className:"primary"}).inject(o.getFooter());h.disable(),h.addEvent("onClick",function(){i.clickDownloadButton.call(i)}),new u({value:m.cancel,className:"default"}).inject(o.getFooter()).addEvent("onClick",function(){i.clickCancelButton.call(i)}),o.show();var f=e.createElement("span",{class:"bulk-settings fonticon fonticon-cog"}).inject(n),_=new g({position:"bottom",target:f,body:m.bulkSettings});i._tooltips.pushTooltip(_),f.addEvent("click",function(t){e.Element.getElement.call(o.getBody(),".flip-container").className.indexOf("flipped")>=0?(e.Element.getElement.call(o.getBody(),".flip-container").removeClassName("flipped"),i._settingChanged?(i._settingChanged=!1,i._loadingReady&&!i._downloadFailed&&i.reloadDisplay()):!i._loadingReady||i._downloadStarted||i._cannotDownload||i._downloadFailed||i.downloadButton.enable()):(e.Element.getElement.call(o.getBody(),".flip-container").addClassName("flipped"),i.downloadButton.disable()),void 0!==t.callback&&t.callback(i)});var w=new d({element:e.Element.getElement.call(o.getContent(),".review-files")}).inject(e.Element.getElement.call(o.getBody(),".front")),y=e.createElement("div",{class:"errorfiles-review"}).inject(w.elements.content);return i.dialog=o,i.scroller=w,i.downloadButton=h,i.errorFilesDiv=y,i.displayDialogSettings(),c.mask(e.Element.getElement.call(o.getContent(),".review-files")),i._progress.initProgress("success",i.progressbarArea),i._logger.log("<<< end displayDialog"),t.end(),i},clickDownloadButton:function(){var t=this,i=Object.keys(t._files);function o(t){var i={};return t.attributes.forEach(function(t){if("type"===t.name)t.name="ds6w:type";else if("owner"===t.name)t.name="ds6w:responsible";else{var o=t.name.split("/");t.name=o[o.length-1]}if(e.is(t.value)&&e.is(t.value.replace,"function")&&(t.value=t.value.replace(/\\n/g," ")),"ds6w:created"===t.name||"ds6w:modified"===t.name){var n=Date.parse(t.value);isNaN(n)||(t.value=new Date(n).toLocaleString())}"ds6w:type"===t.name&&(i.type=t.value),"resourceid"===t.name||"physicalid"===t.name?i.resourceid=t.value:"did"===t.name?i.did=t.value:"type_icon_url"===t.name?(i.icons||(i.icons=[]),i.icons.push(t.value)):"preview_url"===t.name||"thumbnail_2d"===t.name?(i.thumbnail=t.value,i.grid||(i.grid={}),i.grid.thumbnail="url("+t.value+")"):"relcount"===t.name?i.relcount=parseInt(t.value):"ds6w:label"===t.name?i.label=t.value:(i.grid||(i.grid={}),i.grid[t.name]=t.value)}),i}if(t._settings.downloadWithCSV){c.mask(e.Element.getElement.call(t.dialog.getContent(),".review-files")),t.downloadButton.disable();var n=[];n.push(new l(function(e,o){t._logger.log("Fetch count = "+i.length),w.fetch({pids:i,onComplete:function(t){void 0!==t.results&&t.results.length===i.length?e({response:t}):o({response:t,errormessage:m.error_index})},onFailure:function(e,t){o({response:e,error:t})}})})),l.all(n).then(function(e){var i,n,l=e[0];if(t._logger.log("Fetch result count = "+l.response.results.length),t._userCanceled)return t;for(var a=0;a<l.response.results.length;a++){var s=o(l.response.results[a]),r=t._files[s.resourceid];n=s,(i=r).attributes={},i.attributes.label=n.label,i.attributes.type=n.type,i.attributes.relcount=n.relcount,i.attributes.resourceid=n.resourceid,i.attributes.created=n.grid["ds6w:created"],i.attributes.modified=n.grid["ds6w:modified"],i.attributes.organizationResponsible=n.grid["ds6w:organizationResponsible"],i.attributes.policy=n.grid["ds6w:policy"],i.attributes.project=n.grid["ds6w:project"],i.attributes.reserved=n.grid["ds6w:reserved"],i.attributes.responsible=n.grid["ds6w:responsible"],i.attributes.revision=n.grid["ds6wg:revision"],i.attributes.description=n.grid["ds6w:description"],i.attributes.isDuplicated=n.grid.isDuplicated,i.attributes.isLastMinorRevision=n.grid.isLastMinorRevision,r=i}t.startDownload(),t.closeDialog()},function(e){e[0];if(t._userCanceled)return t;e.response&&e.response.message&&e.response.message.indexOf("timedout")>-1?t.utils.errorHandling.call(t,"error",m.message_timeout_error):t.utils.errorHandling.call(t,"error",e.errormessage)})}else t.startDownload(),t.closeDialog()},clickCancelButton:function(){this._userCanceled=!0,this.closeDialog()},removeReviews:function(e){function t(e,t){for(var i=0;i<t.length;i++)e.removeChild(t[i])}var i=this.scroller.elements.content,o=i.getElementsByClassName("only-message-div"),n=i.getElementsByClassName("conflictfiles-review");if(null!==n&&t(i,n),null!==o&&t(i,o),this.statsArea.className="stats-area-displayCurrentProcess",t(this.statsArea,this.statsArea.getElementsByClassName("display-conflict-info")),t(this.statsArea,this.statsArea.getElementsByClassName("display-update")),!0===e){var l=i.getElementsByClassName("errorfiles-review");null!==l&&t(i,l);var a=i.getElementsByClassName("errorfiles-review-warning");null!==a&&t(i,a)}},reloadDisplay:function(){var t=v.createProbe("BulkDownload_reloadDisplay");this._logger.log(">>> start reloadDisplay"),this.removeReviews(),c.mask(e.Element.getElement.call(this.dialog.getContent(),".review-files"));for(var i=Object.keys(this._files),o=0;o<i.length;o++){this._files[i[o]].newFileName={}}this.checkAndDisplay(),this._logger.log("<<< end reloadDisplay"),t.end()},checkAndDisplay:function(){var t=v.createProbe("BulkDownload_checkAndDisplay");this._logger.log(">>> start checkAndDisplay");var i=this._folders,o=this._folderRelation;if(this._settings.downloadFlat){(i={})[""]=[];var n=[];o={_map:{"":[]},getFoldernames:function(e){return[]}};for(var l=Object.keys(this._folders),a=0;a<l.length;a++)for(var s=this._folders[l[a]],r=0;r<s.length;r++)i[""].push(s[r]),n.push(l[a]);this._folderpathForFlatDownload=n}if(this._userCanceled)return this;this._foldersForDownload=i;var d=this._checkConflict(i,this._files,o);this._displayReview(i,this._files,d,this._errors,o),this._displayStats(i,this._files,d,this._errors,o),c.unmask(e.Element.getElement.call(this.dialog.getContent(),".review-files")),this._logger.log("<<< end checkAndDisplay"),t.end()},displayDialogSettings:function(){var t=v.createProbe("BulkDownload_displayDialogSettings"),i=this;i._logger.log(">>> start displayDialogSettings");var o="",n="";var a=[];a.push(i._settings.DOWNLOAD_FLAT_PREFERENCE),a.push(i._settings.DOWNLOAD_WITH_CSV_PREFERENCE);for(var s=[],r=0;r<a.length;r++)s.push(new l(function(e,t){var i=a[r];w.getUserPreferences({name:i.keyname,onComplete:function(t){var o=t;""===o&&(w.setUserPreferences({name:i.keyname,value:i.defaultvalue,onComplete:function(e){},onFailure:function(e){}}),o=i.defaultvalue),e({keyname:i.keyname,value:o})},onFailure:function(t){e({keyname:i.keyname,value:i.defaultvalue})}})}));l.all(s).then(function(t){for(var l=0;l<t.length;l++){var a=t[l];a.keyname===i._settings.DOWNLOAD_FLAT_PREFERENCE.keyname?o=a.value:a.keyname===i._settings.DOWNLOAD_WITH_CSV_PREFERENCE.keyname&&(n=a.value)}var s,r;s=o,r=n,new p({fields:[{type:"checkbox",value:m.settingFlat,className:"primary",label:m.settingFlat,checked:"true"===s,events:{onChange:function(e){w.setUserPreferences({name:"BulkDownload_downloadFlat",value:this.isChecked().toString(),onComplete:function(e){},onFailure:function(e){}}),i._settings.downloadFlat=this.isChecked(),i._settingChanged=!0}}},{type:"checkbox",value:m.settingWithCSV,className:"primary",label:m.settingWithCSV,checked:"true"===r,events:{onChange:function(e){w.setUserPreferences({name:"BulkDownload_downloadWithCSV",value:this.isChecked().toString(),onComplete:function(e){},onFailure:function(e){}}),i._settings.downloadWithCSV=this.isChecked()}}}]}).inject(e.Element.getElement.call(i.dialog.getBody(),".form-settings")),i._settings.downloadFlat="true"===s,i._settings.downloadWithCSV="true"===r,i._logger.log("<<< end displayDialogSettings")}),t.end()},review:function(e){var t=v.createProbe("BulkDownload_review"),i=this;if(i._logger.log(">>> start review"),i._id=e,i.utils.reset.call(i),i._logger.log("starts the download review"),"[object Array]"!==Object.prototype.toString.call(e))return i.utils.displayNotification(m.noId,"info"),l.resolve(null);i._logger.log(e.length+" objects selected to be downloaded"),i.displayDialog(),i._progress.startProgress();var o=new l(function(t,o){i.getInfo(e).then(function(e){if(i._progress.addCurrentValue(),!i._userCanceled)return i._getData(e,!0)}).then(function(e){if(i._logger.log(">>> start collect folders and files "),i._progress.addCurrentValue(),!i._userCanceled){i._displayUpdate("");var t={},o=i._files;t[""]=[];var n=function(e){for(var i="",l="",a="",s=0;s<e.length;s++)if(Array.isArray(e[s]))n(e[s]);else if(!0===e[s].resolved){l=e[s].path+e[s].name,a=e[s].originalpath+e[s].originalname;var r=Object.keys(t);i=l;for(var d=0;d<r.length;d++)l.toUpperCase()===r[d].toUpperCase()&&(i=r[d]);void 0===t[i]&&(t[i]=[])}else void 0===o[e[s]]&&(o[e[s]]={}),t[i].push({fileid:e[s],folderpath:l,originalFolderpath:a})};n(e),i._folders=t,i._files=o,i._stats.folders=Object.keys(t).length-1,i._stats.files=Object.keys(o).length,i._logger.log("<<< end collect folders and files ");var a=!1;return i._logger.log(">>> start getURLs API "),new l(function(e,t){var o=v.createProbe("BulkDownload_ForGetURLs");if(i._stats.files>0){for(var n=[],l=Object.keys(i._folders),s=0;s<l.length;s++)for(var r=0;r<i._folders[l[s]].length;r++)n.push(i._folders[l[s]][r].fileid);w.getURLs({id:n,onFailure:function(e,n){o.end(),a?i._logger.log("<<< end getURLs API / got urls but got error"):(n&&n.error.indexOf("timeout error")>-1?i.utils.errorHandling.call(i,e,m.message_timeout_error):i.utils.errorHandling.call(i,e),i._logger.log("<<< end getURLs API / got error"),t(e))},onComplete:function(t){a=!0,i._logger.log("<<< end getURLs API / got urls "),e(t)}})}else i._logger.log("<<< end getURLs API / no file case "),o.end(),e([])})}}).then(function(e){var o=v.createProbe("BulkDownload_ForDisplayReview");if(i._logger.log(">>> start  check download files"),i._progress.addCurrentValue(),i._userCanceled)return i;var n=e;i._displayUpdate();for(var l=0;l<n.length;l++)if(i._files[n[l].id].fileName=n[l].fileName,i._files[n[l].id].newFileName={},void 0===i._files[n[l].id].downloadUrl&&(i._files[n[l].id].downloadUrl=[]),i._files[n[l].id].downloadUrl.push(n[l].downloadUrl),i._files[n[l].id].isDownloadedCurrentStatus={},void 0!==n[l].errorMessage){i._files[n[l].id].isDownloaded=!1,i._files[n[l].id].hasError=!0;var a=i._errors.getErrorIdFromErrorMessage(n[l].errorMessage);a===i._errors.ERRORID_EMBEDED_COMPONENT&&(i._files[n[l].id].isEmbeddedComponent=!0),i._errors.pushError(n[l].id,a,n[l].errorMessage)}else i._files[n[l].id].isUptodate=!0,i._files[n[l].id].isDownloaded=!0,void 0===i._files[n[l].id].fileName&&(i._files[n[l].id].fileName="DocumentsZIPFile.ZIP");i._logger.log("<<< end  check download files"),i._loadingReady=!0,i._getFileStatusAsAsyncronous(),i.checkAndDisplay(),o.end(),t(i)})});return o.catch=function(e){i.utils.errorHandling.call(i,e)},i._logger.log("<<< end review"),t.end(),o},getInfo:function(e){var t=this,i=v.createProbe("BulkDownload_getInfo");t._logger.log("Getting information about the "+e.length+" objects selected");for(var o=[],n=0;n<e.length;n++)o.push(new l(function(o,l){w.getDocument({id:e[n],onComplete:function(e){i.end(),o(e)},onFailure:function(e){i.end(),t.utils.errorHandling.call(t,e),l(e)}})})),o[n].catch=function(e){t.utils.errorHandling.call(t,e)};return l.all(o)},_getData:function(e,t){var i=this,o=v.createProbe("BulkDownload__getData");if(i._logger.log(">>> start _getData"),!i._userCanceled){i._displayUpdate(e);for(var n=[],a=[],s=[],r=null,d=0;d<e.length;d++){var c=e[d],u=c.id=c.id||i.utils.getID(c),g=c.type=c.type||i.utils.getType(c),p=c.name||i.utils.getName(c);c.name=p.replace("/","");switch(c.originalname=p,!0){case i.options.container.indexOf(g)>=0&&!0!==c.resolved:n.push(c);break;case i.options.expandable.indexOf(g)>=0:a.push(u);break;case i.options.leaf.indexOf(g)>=0:s.push(u);break;case i.options.container.indexOf(g)>=0&&!0===c.resolved:r=c}}var h=[];for(d=0;d<n.length;d++)h.push(new l(function(e,t){var o=n[d],l=v.createProbe("BulkDownload__ForGetFolder");i._logger.log(">>> start getFolder API"),w.getFolder({id:o.id,onComplete:function(t){var n=JSON.parse(t).content,a={id:o.id,type:o.type,name:o.name,path:null!==r?r.path+r.name+"/":"",originalname:o.originalname,originalpath:null!==r?r.originalpath+r.originalname+"/":"",resolved:!0};n.unshift(a),i._folderRelation.pushFoldername(null!==r?r.path+r.name:"",o.name),i._logger.log("<<< end getFolder API / got children of oid=["+o.id+"]"),l.end(),e(i._getData(n,!0))},onFailure:function(e){i._logger.log("<<< end getFolder API / fails to get children of oid=["+o.id+"]"),l.end(),i.utils.errorHandling.call(i,e),t(e)}})})),h[d].catch=function(e){i.utils.errorHandling.call(i,e)};if(!0===t&&a.length>0){var f=new l(function(e,t){i._logger.log(">>> start getChildren API");var o=v.createProbe("BulkDownload__ForGetChildren");w.getChildren({id:a,onComplete:function(t){for(var n=JSON.parse(t),l=[],s=i._files,d=null!==r?r.path+r.name:"",c={},u=0;u<n.paths.length;u++)for(var g,p,h=0;h<n.paths[u].length;h+=2){var f=s[n.paths[u][h]];void 0===f&&(f={}),0===h&&(g=n.paths[u][h],p=n.paths[u][h],void 0===f.isTop&&(f.isTop={}),f.isTop[d]=!0);var _=!1;if(0===h)c[h]===n.paths[u][h]||((c={})[h]=n.paths[u][h],_=!0);else if(h>0&&(void 0===c[h]||n.paths[u][h-1]!==c[h])){c[h]=n.paths[u][h-1];for(var m=Object.keys(c),v=0;v<m.length;v++){var w=m[v];w>h&&(c[w]=void 0)}_=!0}_&&(void 0===f.topFileid&&(f.topFileid={}),void 0===f.parentFileid&&(f.parentFileid={}),void 0===f.topFileid[d]&&(f.topFileid[d]=[]),void 0===f.parentFileid[d]&&(f.parentFileid[d]=[]),f.topFileid[d].push(g),f.parentFileid[d].push(p),void 0===f.folderpaths&&(f.folderpaths=[]),y.isExistsInArrayUpperCase(d,f.folderpaths)||f.folderpaths.push(d),s[n.paths[u][h]]=f,l.push(n.paths[u][h])),p=n.paths[u][h]}i._files=s,i._syncFiles.concatFiles(l),null!==r&&l.unshift(r),i._logger.log("<<< end getChildren API / got children of top product oid=["+a.join(",")+"]"),o.end(),e(l)},onFailure:function(e){i._logger.log("<<< end getChildren API / fails to get children of top product oid=["+a.join(",")+"]"),o.end(),i.utils.errorHandling.call(i,e),t(e)}})});h.push(f),f.catch=function(e){i.utils.errorHandling.call(i,e)}}return!0!==t&&a.length>0&&(i._syncFiles.concatFiles(a),s=s.concat(a)),s.length>0&&h.push(new l(function(e,t){null!==r&&s.unshift(r),e(s)})),i._logger.log("<<< end _getData"),o.end(),l.all(h)}},_getFileStatusAsAsyncronous:function(){var t=this,i=v.createProbe("BulkDownload_ForGetFileStatus");t._logger.log(">>> start getFileStatus API"),t._userCanceled||new l(function(e,o){t._syncFiles.getLength()>0?w.getFileStatus({id:t._syncFiles.getList(),onComplete:function(o){i.end(),t._logger.log("<<< end getFileStatus API / got status"),e({syncFiles:JSON.parse(o).results})},onFailure:function(e){i.end(),t._logger.log("<<< end getFileStatus API / got error"),e&&e.message.indexOf("timedout")>-1?t.utils.errorHandling.call(t,e,m.message_timeout_error):t.utils.errorHandling.call(t,e),o(e)}}):(t._logger.log("<<< end getFileStatus API / no file to be checked"),i.end(),e({syncFiles:[]}))}).then(function(i){if(!t._downloadStarted&&!t._userCanceled){for(var o=i.syncFiles,n=0;n<o.length;n++){var l=t._files[o[n].id];void 0!==l&&"false"===o[n].isUptodate&&(t._errors.pushError(o[n].id,t._errors.ERRORID_NOTSYNC,o[n].message),void 0!==l.isEmbeddedComponent&&l.isEmbeddedComponent||(l.isUptodate=!1,l.isDownloaded=!0))}t._getFileStatusAPIisReady=!0;var a=e.Element.getElement.call(t.scroller.elements.content,".errorfiles-review"),s=t.scroller.elements.content.getElementsByClassName("now-loading-file-status-message");a.removeChild(s[0]),0===o.length?a.className="errorfiles-review-nothing":t._errors.getSyncErrorLength()>0?(t._displayErrorFilesInReview(t._errors,t._files),a.className="errorfiles-review-warning"):a.className="errorfiles-review-nothing";var r=e.Element.getElement.call(t.dialog.getFooter(),".display-conflict-info"),d=e.Element.getElement.call(r,".display-stats"),c=d.textContent.replace("...","");c+=t._stats.warning,d.textContent=c,d.title=c,t._progress.addCurrentValue()}})},_displayReview:function(t,i,o,n,l){var a=v.createProbe("BulkDownload__displayReview");this._logger.log(">>> start _displayReview");this._cannotDownload=!1;var s=e.Element.getElement.call(this.dialog.getBody(),".flip-container"),r=Object.keys(o);if(r.sort(),!this._getFileStatusAPIisReady&&!this._warningDisplayisReady){var d=e.createElement("div",{class:"now-loading-file-status-message",html:'<span title="'+m.message_now_loading_file_status+'">'+m.message_now_loading_file_status+'</span><span class="now-loading-icon"></span><div title="'+m.message_now_loading_file_status_warning_message+'" style="margin-top:10px;">'+m.message_now_loading_file_status_warning_message+"</div>"}).inject(this.errorFilesDiv),u=e.Element.getElement.call(d,".now-loading-icon");c.mask(u,""),u.getElementsByClassName("spinner spinning")[0].setStyle("width","50px"),this._warningDisplayisReady=!0}e.Element.getElement.call(this.dialog.getBody(),".review-files").setStyle("height","100%"),e.Element.getElement.call(this.dialog.getBody(),".flip-container").setStyle("height","100%");for(var g=Object.keys(i),p=!0,f=0;f<g.length;f++){if(i[g[f]].isDownloaded){p=!1;break}}if(p)return this._displayNothingToDownload("only-message-div"),this._cannotDownload=!0,this.downloadButton.disable(),this;if(!this._checkFilePathLength(t,i)&&0===r.length)return(k=e.createElement("p",{class:"only-message-div",html:"<span>"+m.message_okToDownload+"</span>"})).inject(this.scroller.elements.content),s.className.indexOf("flipped")<0&&this.downloadButton.enable(),this;var _=0;if(r.length>0)for(var w=m.message_conflict_files_are,F=(d=e.createElement("div",{class:"conflictfiles-review",html:'<div title="'+w+'">'+w+"</div>"}).inject(this.scroller.elements.content),0);F<r.length;F++){if(this._userCanceled)return this;var C=m.currentFolder,D='<span class="fonticon fonticon-folder"></span>';if(this._settings.downloadFlat){C=m.conflictmessage_flatdownload;var E=m.noFolderStructure;D+='<div class="conflict-filename-folder" title="'+C+E+'">'+C+'<span class="conflict-filename-folder-comment">'+E+"</span></div>"}else{var b=""===r[F]?C:r[F];D+='<div class="conflict-filename-folder" title="'+b+'">'+b+"</div>"}(k=e.createElement("span",{class:"folder-review",html:D})).inject(d);for(var S=o[r[F]],R=Object.keys(S),N=0;N<R.length;N++){var k,A=R[N]+" ("+S[R[N]].length+" files)";(k=e.createElement("div",{class:"file-review",html:'<span class="fonticon fonticon-cancel file-review-fonticon-cancel"></span><div class="conflict-filename-review" title="'+A+'">'+A+'</div><div class="file-review-editor"></div>'})).inject(d),_++;for(var P=this._isConflictBetweenFolderAndFile(R[N],r[F],l),I=1;I-P<S[R[N]].length;I++){var T=S[R[N]][I-P],O=r[F],U=i[T].fileName,j=this._renameFileWithCheckConflict(O,U,I,T,t,l,i),x=y.splitExtension(j),B=new h({value:x.filename,sizeInCharNumber:20});if(B.inject(e.Element.getElement.call(k,".file-review-editor")),B.elements.container.className+=" file-review-editor-lineeditor",B._myInput.setStyle("width","calc(100% - 25px)"),1===I){var L="fonticon fonticon-down-open expander-arrow",M=L;S[R[N]].length<=2-P&&(M=L+" disabled");var W=e.createElement("span",{class:M});W.inject(B.getContent()),S[R[N]].length>2-P&&W.addEventListener("click",function(){var e=this.parentElement.parentElement.parentElement;e.className.indexOf("expanded")>=0?(this.className=L,e.removeClassName("expanded")):(this.className="fonticon fonticon-up-open expander-arrow",e.addClassName("expanded"))})}B.options.targetFileid=T,B.options.callListenerFunction=!0,B.options.parentFolder=O,B.options.extension=x.extension,this._addEventListenerToLineEditor(B,t,l,i)}}}this._stats.conflictCount=_,s.className.indexOf("flipped")<0&&this.downloadButton.enable(),this._logger.log("<<< end _displayReview"),a.end()},_displayNothingToDownload:function(t){e.createElement("p",{class:t,html:"<span>"+m.message_nothingToDownload+"</span>"}).inject(this.scroller.elements.content)},_displayErrorFilesInReview:function(t,i){this._logger.log(">>> start _displayErrorFilesInReview");var o=e.Element.getElement.call(this.scroller.elements.content,".errorfiles-review");e.createElement("span",{html:'<span title="'+m.message_files_are_warning_objects+'">'+m.message_files_are_warning_objects+"</span>"}).inject(o);for(var n=t.getFileIdList(),l=0,a=0;a<n.length;a++){var s=t.getError(n[a]);if(s.errorid===this._errors.ERRORID_NOTSYNC){var r=i[s.fileid].fileName+" ( "+s.displayError+" )",d=m.folderpaths;if(void 0!==i[s.fileid].folderpaths){var c=i[s.fileid].folderpaths.concat();c.sort();for(var u=0;u<c.length;u++){var g=c[u];""===g&&(g=m.currentFolder),d+="\n - "+g}}else d+="\n - "+m.currentFolder;e.createElement("div",{class:"file-review",html:'<div title="'+d+'" class="attention-icon fonticon fonticon-attention"></div><span class="error-filename-review" title="'+r+'">'+r+'</span><div class="file-review-editor"></div>'}).inject(o),l++}}this._stats.warning=l,this._logger.log("<<< end _displayErrorFilesInReview")},_isConflictBetweenFolderAndFile:function(e,t,i){for(var o=i.getFoldernames(t),n=0;n<o.length;n++)if(o[n].toUpperCase()===e.toUpperCase())return 1;return 0},_checkConflictInThesameFolder:function(e,t,i,o,n){for(var l=i[e],a=o.getFoldernames(e),s=0;s<l.length;s++){var r=n[l[s].fileid];if(r.isDownloaded){var d=r.fileName;if(void 0!==r.newFileName[e]&&(d=r.newFileName[e]),d.toUpperCase()===t.toUpperCase())return!0}}for(s=0;s<a.length;s++)if(a[s].toUpperCase()===t.toUpperCase())return!0;return!1},_renameFileWithCheckConflict:function(e,t,i,o,n,l,a){var s=y.editFileName(t,i);this._checkConflictInThesameFolder(e,s,n,l,a)?s=this._renameFileWithCheckConflict(e,t,i+1,o,n,l,a):a[o].newFileName[e]=s;return s},_addEventListenerToLineEditor:function(e,t,i,o){var n=this;e.addEventListener("change",function(e){var l=v.createProbe("BulkDownload_lineEditorChange"),a=e.dsModel;if(a.options.callListenerFunction){var s=a.value,r=a.options.targetFileid,d=o[r],c=a.options.extension,u=a.options.parentFolder,p=s;""!==c&&(p+="."+c);var h=y.checkFolderEditorInvalidCharsWithSlash.call(n,s),f=h.hasInvalidChar,_="";if(f&&(_=m.replace(m.message_error_name_badchars,{name:s,badChars:h.badChars})),!f)f=(""===u?s:u+"/"+s).length>256,_=m.replace(m.message_toolong_in_manual_rename,{name:s,chars:256});if(f||(f=""===s.trim(),_=m.message_onlySpaceCharacter_in_manual_rename),f||(f=n._checkConflictInThesameFolder(u,p,t,i,o),_=m.replace(m.message_conflict_in_manual_rename,{name:s})),f){a.options.callListenerFunction=!1;var w=d.fileName;if(void 0!==d.newFileName[u]&&(w=d.newFileName[u]),a.value=y.splitExtension(w).filename,a.options.tooltip)a.options.tooltip.elements.body.textContent=_;else{var F=new g({target:a.getContent(),body:_,position:"right",events:{onPreInject:function(e){this.options.target.getBoundingClientRect().right>parseInt(widget.body.getStyle("width").replace("px",""))-200?(this.options.position="bottom",this.getContent().className="tooltip tooltip-root bottom fade"):(this.options.position="right",this.getContent().className="tooltip tooltip-root right fade")}}});a.options.tooltip=F;var C=n._tooltips.pushTooltip(F);a.options.tooltipid=C}a.options.tooltip.show()}else d.newFileName[u]=p,a.options.tooltip&&(a.options.tooltip.elements.body.remove(),n._tooltips.deleteTooltip(a.options.tooltipid),a.options.tooltip=void 0,a.options.tooltipid=void 0);void 0!==a.options.callback&&a.options.callback(a),l.end()}else a.options.callListenerFunction=!0})},_displayStats:function(t,i,o,n){var l=v.createProbe("BulkDownload__displayStats");this._logger.log(">>> start _displayStats");for(var a=0,s=Object.keys(t),r={},d=0;d<s.length;d++)for(var c=t[s[d]],u={},g=0;g<c.length;g++){var p,h=i[c[g].fileid],f=s[d];if(this._settings.downloadFlat&&(f=this._folderpathForFlatDownload[g]),void 0!==h.topFileid){var _=h.topFileid[f];if(void 0!==_&&0!==_.length)if(void 0===r[c[g].fileid]&&(r[c[g].fileid]={}),void 0===r[c[g].fileid][f]&&(r[c[g].fileid][f]=_.concat()),r[c[g].fileid][f].length>0){var w=r[c[g].fileid][f].shift(),y=this._files[w],F=y.fileName;void 0!==y.newFileName[s[d]]&&(F=y.newFileName[s[d]]),p=F}else p="";else p=""}else p="";var C=h.isDownloadedCurrentStatus;!0===h.isDownloaded&&void 0!==C&&!1!==C[s[d]]&&void 0===u[p+"_"+c[g].fileid]&&(a++,u[p+"_"+c[g].fileid]=1)}this._stats.files=a;var D='<span class="display-issues" style="color:#57B847; float: left;">'+m.noConflict+"</span>";this._cannotDownload?D='<span class="display-issues"></span>':this._stats.conflictCount>0&&(D='<span class="display-issues" style="color:#ff0000; float: left; text-decoration: underline;">'+this._stats.conflictCount+" "+m.conflict+"</span>");var E=m.files+" "+this._stats.files+", "+m.folders+" "+this._stats.folders+", "+m.warningfiles;this._getFileStatusAPIisReady?E+=" "+this._stats.warning:E+=" ...";var b=D+"<br>",S='<span class="display-stats" style="float: left; text-align: left; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;" title="'+E+'">'+E+"</span>";e.createElement("div",{styles:{float:"left",height:""},html:b+S,class:"display-conflict-info"}).inject(this.statsArea);this._logger.log("<<< end _displayStats"),l.end()},_displayUpdate:function(t){try{e.Element.getElement.call(this.dialog.getFooter(),".display-update").remove()}catch(e){}if(void 0===t)return this;if("string"==typeof t)return e.createElement("div",{styles:{float:"left",height:""},html:m.displayFooterMessage_retrievingFileInfo,class:"display-update"}).inject(this.statsArea),this;var i=m.currentFolder,o=!0===t[0].resolved?t[0].name:i;e.createElement("div",{html:m.displayFooterMessage_browsingFolder+o,class:"display-update"}).inject(this.statsArea)},_checkConflict:function(e,t,i){var o={},n=v.createProbe("BulkDownload__checkConflict");function l(e,t,i,o,n){for(var l=Object.create(null),a={},s=0;s<i.length;++s)for(var r=Object.keys(l),d=0;d<r.length;d++)i[s].toUpperCase()!==l[r[d]].toUpperCase()&&(l[i[s]]=null);for(s=0;s<e.length;++s){var c=e[s],u=Object.keys(l),g=c;for(d=0;d<u.length;d++)if(u[d].toUpperCase()===c.toUpperCase()){void 0===a[g=u[d]]&&(a[g]=[],null!==l[g]&&a[g].push(l[g])),a[g].push(t[s]);break}l[g]=t[s]}return a}this._logger.log(">>> start _checkConflict");for(var a=Object.keys(e),s=0;s<a.length;s++){for(var r=e[a[s]].concat(),d=[],c=[],u=0;u<r.length;u++){var g=t[r[u].fileid];if(g.isDownloaded&&!y.isExistsInArray(r[u].fileid,c)){g.isDownloadedCurrentStatus={};var p=t[r[u].fileid].fileName;void 0!==t[r[u].fileid].newFileName[a[s]]&&(p=t[r[u].fileid].newFileName[a[s]]),d.push(p),c.push(r[u].fileid)}else r.splice(u,1),u--}var h=l(d,c,i.getFoldernames(a[s]),0,a[s]);Object.keys(h).length>0&&(o[a[s]]=h)}return this._logger.log("<<< end _checkConflict"),n.end(),o},_checkFilePathLength:function(t,i){var o=[],n=v.createProbe("BulkDownload__checkFilePathLength");this._logger.log(">>> start _checkFilePathLength");for(var l=Object.keys(t),a=0;a<l.length;a++){for(var s=t[l[a]],r=[],d=0;d<s.length;d++){var c=i[s[d].fileid];if(c.isDownloaded&&void 0!==c.isDownloadedCurrentStatus&&!1!==c.isDownloadedCurrentStatus[l[a]]){var u=c.fileName;void 0!==c.newFileName[l[a]]&&(u=c.newFileName[l[a]]),(l[a]+"/"+u).length>256&&r.push(u)}}r.length>0&&o.push({folderpath:l[a],filenames:r})}var g=o.length>0;if(g){var p=m.replace(m.message_there_is_toolong_filepath,{chars:256}),h=e.createElement("div",{class:"only-message-div",html:'<div class="toolong-filepath-willnotbeDownloaded" title="'+m.message_there_is_toolong_filepath_willnot_be_downloaded+'">'+m.message_there_is_toolong_filepath_willnot_be_downloaded+'</div></div><div class="toolong-filepath-mainmessage" title="'+p+'">'+p+"</div>"});h.inject(this.scroller.elements.content,"top");for(var f=0;f<o.length;f++){e.createElement("div",{class:"toolong-filepaths",html:'<span class="fonticon fonticon-folder"></span><div class="toolong-filepath-path" title="'+o[f].folderpath+'">'+o[f].folderpath+"</div>"}).inject(h);for(var _=0;_<o[f].filenames.length;_++){e.createElement("div",{class:"toolong-filepath-filename",title:o[f].filenames[_],html:o[f].filenames[_]}).inject(h)}}}return this._logger.log("<<< end _checkFilePathLength"),n.end(),g},startDownload:function(){var e=0,t=0,i=0,o=0,n=this._getFileStatusAPIisReady;this._downloadStarted=!0;var l=v.createProbe("BulkDownload_startDownload");this._logger.log(">>> start startDownload");for(var a=this._foldersForDownload,s=Object.keys(a),r=[],d=0;d<s.length;d++)for(var c=a[s[d]],u={},g=0;g<c.length;g++){var p=this._files[c[g].fileid],h=s[d];this._settings.downloadFlat&&(h=this._folderpathForFlatDownload[g]);var f=this._getTopFilename(c[g].fileid,h,s[d]),_=this._getParentFilename(c[g].fileid,h,s[d]),w="";if(this._settings.downloadWithCSV){var y="";!1===n?y=m.do_not_get_filestatus:!1===p.isUptodate&&(y=m.displayMessage_notSync);var F="";void 0!==p.attributes.description&&(F=p.attributes.description),w+=' "'+p.attributes.label+'" "'+p.attributes.type+'" "'+p.attributes.revision+'" "'+p.attributes.responsible+'" "'+p.attributes.created+'" "'+p.attributes.modified+'" "'+y+'" "'+encodeURI(F)+'"'}var C="",D="",E=this.URLATTR_NOURL;!0===p.isDownloaded?(C=p.fileName,D=p.fileName,void 0!==p.newFileName[s[d]]&&(D=p.newFileName[s[d]]),void 0!==p.isDownloadedCurrentStatus&&!1!==p.isDownloadedCurrentStatus[s[d]]&&void 0!==p.downloadUrl&&0!==p.downloadUrl.length&&1!==u[f+"_"+c[g].fileid]&&(E=p.downloadUrl.shift(),u[f+"_"+c[g].fileid]=1)):p.isEmbeddedComponent&&(C=this.FILENAMEATTR_EO+c[g].fileid,D=this.FILENAMEATTR_EO+c[g].fileid);var b=c[g].originalFolderpath;""===b||void 0===b?b="":""!==this.options.folderpath&&void 0!==this.options.folderpath&&(b="/"+b),E!==this.URLATTR_NOURL&&(E=this.URLATTR_URL),r.push({downloadUrl:E,path:s[d],fullpath:this.options.folderpath+b,fileName:D,orgFileName:C,topFilename:f,parentFilename:_,fileid:c[g].fileid,attributes:w}),E!==this.URLATTR_NOURL&&(""===f&&""===_?(e++,C!==D&&t++):(i++,C!==D&&o++))}this._logger.log("<<< end startDownload"),this._sendDownloadRequest(r,{documentFileCount:e,documentRenamedFileCount:t,catiaFileCount:i,catiaRenamedFileCount:o}),l.end()},_getTopFilename:function(e,t,i){var o,n=this._files[e];if(void 0!==n.topFileid){var l=n.topFileid[t];if(void 0!==l&&0!==l.length){var a=l.shift(),s=this._files[a],r=s.fileName;void 0!==s.newFileName[i]&&(r=s.newFileName[i]),o=r}else o=""}else o="";return o},_getParentFilename:function(e,t,i){var o,n=this._files[e];if(void 0!==n.parentFileid){var l=n.parentFileid[t];if(void 0!==l&&0!==l.length){var a=l.shift(),s=this._files[a];if(!0===s.isEmbeddedComponent)r=this.FILENAMEATTR_EO+a;else{var r=s.fileName;void 0!==s.newFileName[i]&&(r=s.newFileName[i])}o=r}else o="";void 0===o&&(o="")}else o="";return o},_sendDownloadRequest:function(e,t){var i,o=this,n=t.documentFileCount,l=t.documentRenamedFileCount,s=t.catiaFileCount,r=t.catiaRenamedFileCount;i='{"lang":"'+widget.lang+'", "objects":"'+o._stats.files+'", "documentFileCount":"'+n+'", "documentRenamedFileCount":"'+l+'", "catiaFileCount":"'+s+'", "catiaRenamedFileCount":"'+r+'"}\n';var d=v.createProbe("BulkDownload__sendDownloadRequest");o._logger.log(">>> start _sendDownloadRequest");for(var c=0;c<e.length;c++){var u=e[c].path;""!==u&&(u+="/"),i+=e[c].downloadUrl+' "'+e[c].fileid+'" "'+u+'" "'+e[c].orgFileName+'" "'+e[c].fileName+'" "'+e[c].topFilename+'" "'+e[c].parentFilename+'" "'+e[c].fullpath+'"'+e[c].attributes+"\n"}var g={widgetId:widget.id,appId:"ENOFOLB_AP",fileName:"-d",fileContent:i};if(o._userCanceled)return o;a.subscribe("launchAppCallback",function(e){e&&e.widgetId===widget.id&&("COMPLETE"===e.response?o.utils.displayNotification(m.launched,"success"):o.utils.displayNotification(m.failed,"error"),a.unsubscribe("launchAppCallback"),o._logger.log("<<< end _sendDownloadRequest"))}),a.publish("launchApp",g),o.utils.displayNotification(m.starting,"info"),d.end()},utils:{getID:function(e){return e.data[0].id},getType:function(e){return e.data[0].type},getName:function(e){var t="";try{t=""===(t=e.data[0].dataelements.title)?e.data[0].dataelements.name:t}catch(e){}return t},displayNotification:function(e,t){s.displayNotification({message:e,className:t})},reset:function(){this._folders={},this._folderRelation.clearMap(),this._files={},this._issues=[],this._errors.init(this._logger),this._syncFiles.clearList(),this._stats={folders:0,files:0,error:0,size:0,warning:0,conflictCount:0},this._tooltips.clearList(),this._foldersForDownload=null,this._folderpathForFlatDownload=null},errorHandling:function(t,i){if(this._logger.log(t),!this._downloadFailed){this.removeReviews(!0);var o=m.failed;void 0!==i&&(o=i),c.unmask(e.Element.getElement.call(this.dialog.getContent(),".review-files")),this.downloadButton.disable(),e.createElement("p",{class:"download_failed_message",html:"<span>"+o+"</span>"}).inject(this.scroller.elements.content),this._progress.setErrorProgress(),this._downloadFailed=!0}}}});return C});