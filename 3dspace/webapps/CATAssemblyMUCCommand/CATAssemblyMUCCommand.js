define("DS/CATAssemblyMUCCommand/CAT3DPlayMUCCmd",["UWA/Core","UWA/Utils","DS/ZipJS/inflate","DS/CoreEvents/Events","DS/ApplicationFrame/Command","DS/VCXWebExperienceBase/VCXSceneGraphOverridesServices","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/VisuEvents/EventsManager","DS/CATSolverCDSWeb/CATSolverCDSSolver","DS/WAFData/WAFData","i18n!DS/CATAssemblyMUCCommand/assets/nls/CAT3DPlayMUCSplash","css!DS/CATAssemblyMUCCommand/assets/CAT3DPlayMUCSplash"],function(e,t,i,n,s,o,r,a,l,h,c,d,u){"use strict";return s.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.is3dxml=null,this.pathOfMoving=null,this._boxHandle=null,this._largeSession=null,this._cmdAlreadyActivated=!1,this._loadingFinished=!1,this._experienceBase=null,this._manipulationOverrideSet=null,this._NodeList=[],this._tokenChangeCurrentModel=n.subscribe({event:"Model.changeCurrent"},e=>{this._cmdAlreadyActivated=!1,this._loadingFinished=!1}),this.canvasDiv=document.getElementById("canvas-div"),this.createMUCSplash()},getWidgetMessage:function(t){if(e.is(t,"string")){if(d[t])return d[t];console.error("Unable to find Nls key for :",t)}else console.error("Invalid nls key ",t)},createMUCSplash:function(){if(this.canvasDiv||(this.canvasDiv=document.getElementById("lightbox--content")),this.canvasDiv){if(this.mucSplash=document.getElementById("mucsplash_container"),!this.mucSplash){this.mucSplash=e.createElement("div",{id:"mucsplash_container",class:"mucsplash_container",styles:{display:"none"}}),this.mucSplash.inject(this.canvasDiv);let t=this.getWidgetMessage("MUC_SPLASH_LABEL");this.mucSplash.setContent({tag:"div",class:"mucsplash_container_msg",html:[{tag:"h3",id:"splash_msg",class:"font-3dsregular",html:t}]}),this.mucSplash.addContent({tag:"div",id:"mucsplash_display",class:"mucsplash_display"})}}else console.error("no canvas for MUC splash")},beginExecute:function(){this._parent();let e=this.getFrameWindow();this._experienceBase=e._experienceBase;let t=this._experienceBase.getManager("VCXContextManager");this._viewer=t.getMainViewer();let i=e.experience;this._pad3DViewerController=i&&i.pad3DViewer&&i.pad3DViewer.getController(),this._solver=new h;let n=i.getRootBag();this._solver.initialize(window.cdsJSON),this._solver.load(),this.is3dxml=window.is3dxml,this.mucSplash&&(this.mucSplash.setStyle("display","flex"),setTimeout(()=>{this.mucSplash.setStyle("display","none")},5e3)),n.children[0].traverse(e=>{(e.getID?e.getID():e.id)&&this._NodeList.push(e)}),this._registerCallbacks()},_registerCallbacks:function(){this._tokens||(this._tokens={}),this._tokens.lmdToken||(this._tokens.lmdToken=l.addEvent(this._viewer.canvas,"onLeftMouseDown",this._onPointerDownCB.bind(this))),this._tokens.touchToken||(this._tokens.touchToken=l.addEvent(this._viewer.canvas,"onTouch",this._onPointerDownCB.bind(this))),this._tokens.touchTwoFingerTapToken||(this._tokens.touchTwoFingerTapToken=l.addEvent(this._viewer.canvas,"onTwoFingerTap",this._ResetSceneGraph.bind(this)))},pauseExecute:function(){},resumeExecute:function(){},endExecute:function(){this._parent();let e=this.getFrameWindow();if(!(e&&e.experience))return;n.unsubscribe(this._tokenSceneGraphUpdated),this._tokenSceneGraphUpdated=null,n.unsubscribe(this._tokenChangeCurrentModel),this._tokenChangeCurrentModel=null,this._onSpreadToken&&l.removeEventFromToken(this._onSpreadToken),this._onSpreadToken=null,l.removeEvent(this._viewer.canvas,"onPrimaryPointerDoubleClick",this._doublePointerClickCB);let t=e.experience,i=t.getRootBag(),s=i&&i.children[0];this._pad3DViewerController&&s&&s.modelIdentification&&(this._largeSession?(this._pad3DViewerController.resumeProgressiveLoading(),t.DynamicProgressUI&&t.DynamicProgressUI.play()):this._pad3DViewerController.unlockNodes({ids:this._leavesRefIDS}),this._leavesRefIDS=null,this._largeSession=null,this._pad3DViewerController=null),this._tokens&&(n.unsubscribe(this._tokens.pointerDownToken),this._tokens.pointerDownToken=null,this._tokens.lmdToken&&l.removeEventFromToken(this._tokens.lmdToken),this._tokens.lmdToken=null,this._tokens.touchToken&&l.removeEventFromToken(this._tokens.touchToken),this._tokens.touchToken=null,this._tokens.touchTwoFingerTapToken&&l.removeEventFromToken(this._tokens.touchTwoFingerTapToken),this._tokens.touchTwoFingerTapToken=null),this._tokens=null,this._solver.clean(),this._solver=void 0;let r=this._manipulationOverrideSet;o.removeSceneGraphOverrideSet(this._experienceBase,r,this._viewer),this._updateGroundIfExistsAndRender(),this._manipulationOverrideSet=null},_onPointerDownCB:function(e){let t=e?e.from[0]:null;if(!t||!t.event||!t.event.target||"CANVAS"!==t.event.target.nodeName)return;if(this._tokens.pointerUpToken)return void this._disposeEvents(e);this._tokens.pointerUpToken||(this._tokens.pointerUpToken=l.addEvent(this._viewer.canvas,"onPrimaryPointerUpUnique",this._disposeEvents.bind(this)));let i,n=this._viewer.getMousePosition(t.getCurrentPosition(this._viewer.canvas)),s=this._viewer.pick(n,"mesh",!0);if(s&&s.path&&s.path.length>0&&(i=s.path[0].clone()),!i)return;this._viewer.currentViewpoint.setControlActive({viewpoint:!1}),null===this._manipulationOverrideSet&&(this._viewer.getSceneGraphOverrideSetManager().clear(),this._manipulationOverrideSet=o.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._manipulationOverrideSet.name="MUC ManualManip"),this.viewerPrePicking=this._viewer.pPicking.activated,this._viewer.setPrePicking({activated:!1});let a=i,h=s.position.clone(),c=(new r.Vector3).subVectors(this._viewer.currentViewpoint.target,this._viewer.currentViewpoint.position).normalize(),d=new r.Plane(c,0).setFromNormalAndCoplanarPoint(c,h);this._initInfos={data:e,pickInfo:s,pathElementToMove:a,plane3D:d,mousePos:n},this._isDragging=!1,this._lastPosition=h,this._tokens.pointerDragToken||(this._tokens.pointerDragToken=l.addEvent(this._viewer.canvas,"onPrimaryPointerMoveUnique",this._translateCB.bind(this))),this.pathOfMoving=a;let u=[];for(let e=0;e<a.getLength();e++){let t=a.getElement(e);t&&("Instance3D"===t.productType?u.push(t.persistentId):t.userData&&"VPMInstance"===t.userData.type&&u.push(t.modelIdentification))}this._solver.setMovingEntity(u.join("\\u0005"))},getMovingPath:function(){return this.pathOfMoving},_translateCB:function(e){if(!this._initInfos||!this._lastPosition)return;let t=this._viewer.getMousePosition(e.from[0].getCurrentPosition(this._viewer.canvas));if(!this._isDragging){let e=this._initInfos.mousePos;if(Math.max(Math.abs(t.xPix-e.xPix),Math.abs(t.yPix-e.yPix))<3)return;this._isDragging=!0}let i=this._viewer.pick(t,"mesh",!1).ray.intersectPlane(this._initInfos.plane3D),n=(new r.Vector3).subVectors(i,this._lastPosition).toArray(),s=(new r.Matrix4).makeRotationAxis(this._initInfos.pickInfo.ray.direction,0).elements,o={matrix:[s[0],s[1],s[2],s[4],s[5],s[6],s[8],s[9],s[10],n[0],n[1],n[2]]};this._solver.setMoveType("movebytransfo"),this._solver.setTarget(o);let a=this._solver.run(),l=this.getFrameWindow().experience;for(let e of a.results){let t=e.path.split("\\u0005"),i=this._getPathElementByInstancePath(l.getRootBag(),t);this.translateWithOverrideSet(i,e.transfo,this._manipulationOverrideSet)}this._lastPosition=i.clone()},_disposeEvents:function(){this._tokens.pointerDragToken&&l.removeEventFromToken(this._tokens.pointerDragToken),this._tokens.pointerDragToken=null,this._tokens.pointerUpToken&&l.removeEventFromToken(this._tokens.pointerUpToken),this._tokens.pointerUpToken=null,this._viewer.currentViewpoint.setControlActive({viewpoint:!0}),this.viewerPrePicking&&this._viewer.setPrePicking({activated:this.viewerPrePicking}),delete this.viewerPrePicking,this._initInfos=null,this._isDragging=!1},translateWithOverrideSet:function(e,t,i){let n=e.getWorldMatrix(this._viewer);if(!n)return;let s=(new r.Matrix4).multiplyMatrices(t,n),a=o.getSceneGraphOverride(i,null,e);if(!a)return;let l=e.getParentPath().getWorldMatrix();var h=(new r.Matrix4).getInverse(l);let c=(new r.Matrix4).multiplyMatrices(h,s);a.setPosition(c),this._updateGroundIfExistsAndRender()},_updateGroundIfExistsAndRender:function(){this._experienceBase.getManager("VCXContextManager").renderAll({updateInfinitePlane:!0})},_ResetSceneGraph:function(){let e=this._manipulationOverrideSet;o.removeSceneGraphOverrideSet(this._experienceBase,e,this._viewer),this._updateGroundIfExistsAndRender(),this._manipulationOverrideSet=null,null===this._manipulationOverrideSet&&(this._manipulationOverrideSet=o.createAndPushSceneGraphOverrideSet(this._experienceBase,this._viewer),this._manipulationOverrideSet.name="MUC ManualManip"),this._solver.clean()},_getPathElementByNode:function(e,t){if(!e)return null;if(e===t)return new a([e]);for(const i of e.children){if(i===t)return new a([e,i]);const n=this._getPathElementByNode(i,t);if(n){let t=new a([e]);for(let e=0;e<n.getLength();++e)t.addElement(n.getElement(e));return t}}return null},_getPathElementByInstancePath:function(e,t){let i=e,n=[i];for(const e of t){let t=this._getPathElementById(i,e);if(t){for(let e=1;e<t.getLength();++e)n.push(t.getElement(e));i=t.getLastElement()}}return new a(n)},_getPathElementById:function(e,t){let i=this._getChildByName(e,t);return this._getPathElementByNode(e,i)},_getChildByName:function(e,t,i){let n=t;const s=e=>{for(const t of e.children){if((this.is3dxml?t.persistentId:t.modelIdentification)===n)return t;let e=s(t);if(null!==e)return e}return null},o=e=>{for(const i of e.parents){if(i.persistentId===t)return i;let e=o(i);if(null!==e)return e}return null};return void 0!==i&&i?o(e):s(e)},_onCDSJSONLoaded:function(e){try{this._solver&&(this._solver.initialize(e),this._solver.load())}catch(e){console.error("onCDSJSONLoaded: solver initialization failed")}},_onDataLoaded:function(e){SHARE.Core.Experiences.Default.getRootBag()&&("EV6"===e.loadAssetInfo.provider?(this.is3dxml=!1,this._getJSONFromProduct(e.loadAssetInfo)):(this.is3dxml=!0,this._onCDSJSONLoaded(window.cdsJSON)))},_getJSONFromProduct:function(e){let t=e.contextid?e.contextid:"preferred",i=e.serverurl+"/resources/v1/model/bus/"+e.physicalid+"?select="+encodeURIComponent("attribute[CDSSolverData]"),n={Accept:"application/json","content-type":"application/json"};n["Accept-Language"]=widget.lang,n.SecurityContext=t?encodeURIComponent(t):null;let s={headers:n,method:"GET",type:"json",timeout:36e5,proxy:"passport",onComplete:function(e){let t=this._unzip(e["attribute[CDSSolverData]"]);this._onCDSJSONLoaded(t)}.bind(this),onCancel:function(e){console.error("ERROR: WAFData request failed while opening data.",e)},onFailure:function(e){console.error("ERROR: WAFData request failed while opening data.",e)}};c.authenticatedRequest(i,s)}})});