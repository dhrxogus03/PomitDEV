define("DS/WebVisuParameters/CSICustomNodeHandler",["UWA/Class","DS/Visualization/Node3D"],function(e,t){"use strict";return e.extend({init:function(){},handleMessage:function(e){return t()},handleUpdateMessage:function(e,t){}})}),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i=function(e){this._addedPaths=null,this._keyToPath=null,this._treeKeyToStruct=new Map,this._currentTreeKey=null,this.viewer=e,this._event="",this.highlightColor=null};return i.prototype._setTreeKey=function(e){var t=null;this._currentTreeKey=e,this._treeKeyToStruct.has(e)&&(t=this._treeKeyToStruct.get(e)),t||(t={keyToPath:new Map,addedPaths:new Map},this._treeKeyToStruct.set(e,t)),this._keyToPath=t.keyToPath,this._addedPaths=t.addedPaths},i.prototype.getPathFromKey=function(e){return this._keyToPath.get(e)},i.prototype._add=function(t){e.publish({event:"/VISU/SELECTION/CSI_"+this._event+"_ADD",data:{eventChannel:"/VISU/SELECTION/CSI_"+this._event+"_ADD",eventType:"@CSI_"+this._event+"_ADD",path:t,parameters:{highlightColor:this.highlightColor,viewer:this.viewer}}})},i.prototype.add=function(e){var t=e.hash(),i=this._addedPaths;this._keyToPath.set(t,e),i.has(t)?i.set(t,i.get(t)+1):(i.set(t,1),this._add(e))},i.prototype._remove=function(t){e.publish({event:"/VISU/SELECTION/CSI_"+this._event+"_REMOVE",data:{eventChannel:"/VISU/SELECTION/CSI_"+this._event+"_REMOVE",eventType:"@CSI_"+this._event+"_REMOVE",path:t,parameters:{highlightColor:this.highlightColor,viewer:this.viewer}}})},i.prototype.remove=function(e){var t=e.hash(),i=this._addedPaths;i.has(t)&&(i.set(t,i.get(t)-1),0===i.get(t)&&(i.delete(t),this._keyToPath.delete(t),this._remove(e)))},i.prototype.removeAll=function(){var e=this;this._addedPaths&&this._addedPaths.forEach(function(t,i,r){var n=e.getPathFromKey(i);if(n)for(var a=0;a<t;a++)e.remove(n)})},i}),define("DS/WebVisuParameters/ImagePixelHelper",["DS/Visualization/ThreeJS_DS","DS/Visualization/MaterialManager","DS/SceneGraphNodes/BillBoardNode3D","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Visualization/GraphicAttributeSet"],function(e,t,i,r,n,a){"use strict";let o=new e.Vector2(0,0),s=null,l=0,d=0,c=null;const u={type:"Spherical"};let h=null;return{createFreeTypeText:function(t,i,r,u){const h=t.point;r.magFilter=e.NearestFilter,r.minFilter=e.NearestFilter,r.wrapS=e.ClampToEdgeWrapping,r.wrapT=e.ClampToEdgeWrapping,r.generateMipmaps=!1;let g=function(t,i){(s=e.MaterialUtils.createMatteFaceMaterial({color:16777215,side:e.DoubleSide})).useLighting=!1,s.transparent=!0,s.force=!0,s.useLighting=!1,s.useGASColor=!0,s._activatePDSFXMigrated(),s._PDSFXData._uniqueID="ImagePixelHelperPDSFX",s.setPDSFXVaryings({vTexCoord:{type:"v3"}});let r=new e.Vector2(1/i.x,1/i.y),n=new e.Matrix4;n.set(3/9,3/9,3/9,0,2/9,2/9,2/9,0,1/9,1/9,1/9,0,0,0,0,0);var a={textMask:{type:"t2",value:t},invSize:{type:"v2",value:r},filterWeights:{type:"m4",value:n},gamma:{type:"f",value:1}};return s.setPDSFXUniforms(a),s.setPDSFXOverridableFunctions({ComputeVaryingValues:function(e,t){return`\n                    ${e.getVarying("vTexCoord")} = ${e.vGetAttribTexCoord0()}.xyz;\n                    `}},{ProcessFinalColor:function(e,t){const i=e.variableHandler,r=e.functionHandler,n=(e.pdsfxDefines,e.userDefines,t=>e.getTextureUniform(t)),a=t=>e.getUniform(t),o=e=>i.float(e),s=e=>i.vec2(e),l=e=>i.vec3(e),d=e=>i.vec4(e),c=i.dereference()+t[0],u=a("filterWeights"),h=a("invSize"),g=a("gamma"),p=n("textMask");return`\n                        ${d("alpha")};\n                        ${s("coord")} = ${e.getVarying("vTexCoord")}.xy;\n                        alpha.g = ${r.sample2DTexture(n(p),"coord")}.r;\n\n                        ${s("coordxm1")}  = coord + ${s()}(-${h}.x,0.0);\n                        alpha.r = ${r.sample2DTexture(n(p),"coordxm1")}.r;\n\n                        ${s("coordxp1")}  = coord + ${s()}(${h}.x,0.0);\n                        alpha.b = ${r.sample2DTexture(n(p),"coordxp1")}.r;\n\n                        ${s("coordxm2")}  = coord + ${s()}(-2.0*${h}.x,0.0);\n                        ${o("rp")} = ${r.sample2DTexture(n(p),"coordxm2")}.r;\n\n                        ${s("coordxp2")}  = coord + ${s()}(2.0*${h}.x,0.0);\n                        ${o("bn")}   = ${r.sample2DTexture(n(p),"coordxp2")}.r;\n\n                        ${s("coordxm3")}  = coord + ${s()}(-3.0*${h}.x,0.0);\n                        ${o("rpp")}   = ${r.sample2DTexture(n(p),"coordxm3")}.r;\n\n                        ${s("coordxp3")}  = coord + ${s()}(3.0*${h}.x,0.0);\n                        ${o("bnn")}   = ${r.sample2DTexture(n(p),"coordxp3")}.r;\n\n                        ${d("alpha4")};\n                        alpha4.r = dot(vec3(alpha.r, rp, alpha.g),${u}[0].xyy) + dot(${s()}(rpp,alpha.b),${u}[0].zz);\n                        alpha4.g = dot(vec3(alpha.g,alpha.r,alpha.b),${u}[1].xyy) + dot(${s()}(rp,bn),${u}[1].zz);\n                        alpha4.b = dot(vec3(alpha.b,alpha.g,bn),${u}[2].xyy) + dot(${s()}(alpha.r,bnn),${u}[2].zz);\n                        alpha4.a = (alpha.r + alpha.g + alpha.b) / 3.0;\n\n                        ${l("gamma3")} = vec3(${g});\n\n                        ${l("scolor1")}  = pow(alpha4.rgb * ${c}.a,gamma3);\n\n                        ${c}.r = pow(${c}.r,${g});\n                        ${c}.g = pow(${c}.g,${g});\n                        ${c}.b = pow(${c}.b,${g});\n                        ${c}.a = (scolor1.r + scolor1.g + scolor1.b)/3.0;\n                    `}}),s.needsUpdate=!0,s.force=!0,s}(r,{x:r.image.width,y:r.image.height});g.force=!0,(o=new e.Vector2(0,0)).x=t.freetypeTextGPInfo.min.x,o.y=t.freetypeTextGPInfo.min.y,l=t.freetypeTextGPInfo.max.x-t.freetypeTextGPInfo.min.x,d=t.freetypeTextGPInfo.max.y-t.freetypeTextGPInfo.min.y;var p=n.createRectangleNode({width:l,height:d,cornerPoint:o,fill:!0,material:g});p.setMaterialMode(!0),p.setShadow(!1,!1),p.setMirror(!1);const f=p.getPrimitives();var m=new a({basic:!0,colorIndex:e.COLORMAP_INDEX.FOREGROUND,inheritance:e.GASEnum.COLOR_INHERITANCE_OFF,inheritanceCustom:e.GASEnumCustom._TYPE_FROM_PARENT});return p._setGAS([f[0]],m),c=(new e.Matrix4).setPosition(h),p.setMatrix(c),p},createImagePixel:function(r,a,s){let g=new e.Vector2(0,0),p=1;const f=r.point;g=r.imageGPInfo.offset,p=r.imageGPInfo.alpha;var m=new e.MeshBasicMaterial({color:16777215,map:s,side:e.DoubleSide,alphaTest:.1});if(m.transparent=!0,m.force=!0,a&&a.isNative2D()&&(new t)._setPDSFXDepthPriority(m,4,!1),l=s.image.width,d=s.image.height,o=new e.Vector2(0,0),r.imageGPInfo.is3D?(o.x=-l/2,o.y=-d/2,g&&(o.x+=g.x,o.y+=g.y)):g&&(o.x+=g.x,o.y+=g.y),r.imageGPInfo.zoomQuality&&r.pixelSizes&&r.pixelSizes.length&&r.pixelSizes[0]){const e=r.pixelSizes[0];l*=e[0],d*=e[1]}var v=n.createRectangleNode({width:l,height:d,cornerPoint:o,fill:!0,material:m});return v.setMaterialMode(!0),r.imageGPInfo.zoomQuality||v.setRatio(1),c=(new e.Matrix4).setPosition(f),(h=new i(u)).setMatrix(c),h.addChild(v),h}}}),define("DS/WebVisuParameters/CustomDataParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientCustomDataParameter","DS/Visualization/Node3D"],function(e,t,i){"use strict";return e.extend({init:function(e,t){this.parameter=e,this.onFinishedCB=t},getNode:function(){var e=this,t=new i;return require([this.parameter.getModule()],function(i){if(i){var r=(new i).handleMessage(e.parameter.getData());t.addChild(r),e.onFinishedCB&&e.onFinishedCB()}},this.onModuleError),t},modifyNode:function(e){var t=this;require([this.parameter.getModule()],function(i){if(i){var r=new i,n=null;if(e){n=e.children[0];for(var a=e.getChildren(),o=0;o<a.length;o++)if(!a[o].getModelIdentification()){n=a[o];break}}r.handleUpdateMessage(t.parameter.getData(),n),t.onFinishedCB&&t.onFinishedCB()}},this.onModuleError)},onModuleError:function(e){var t=e.requireModules&&e.requireModules[0];console.log("Module "+t+" is missing.")}})}),define("DS/WebVisuParameters/CSISelectionObject",["DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject"],function(e){return e}),define("DS/WebVisuParameters/GraphicPropertyParameterHelper",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/MaterialApplication","DS/Visualization/GraphicAttributeSet","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/VisuLoaders/ThreeDXLoader","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/CSIViewModelWebInterfaces/CSIViewModelWebEnv","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter","DS/CSIViewModelWebInterfaces/CSIVMClientCustomPropertyParameter","DS/Visualization/PickingMode","DS/Visualization/RenderStyle","DS/Visualization/Filters/GeomTypeFilter","DS/Visualization/Filters/DoNotPickUnderFilter","DS/Visualization/Filters/LookFilter"],function(e,t,i,r,n,a,o,s,l,d,c,u,h,g,p,f,m){"use strict";var v=new a,y=new o,S=-1,_=new Map,w=new Map,I=c.prototype.geomTypeValues,T={};T[I.unknown]=t.GeomTypeEnum.UNKNOWN,void 0!==I.unknown_2D&&(T[I.unknown_2D]=t.GeomTypeEnum.FACE),T[I.edge]=t.GeomTypeEnum.EDGE,T[I.wire_Edge]=t.GeomTypeEnum.WIRE_EDGE,T[I.boundary_Edge]=t.GeomTypeEnum.BOUNDARY_EDGE,T[I.sharp_Edge]=t.GeomTypeEnum.SHARP_EDGE,T[I.smooth_Edge]=t.GeomTypeEnum.SMOOTH_EDGE,T[I.high_curvature_edge]=t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE,T[I.hidden_Seam_Edge]=t.GeomTypeEnum.HIDDEN_SEAM_EDGE,T[I.boundary_Point]=t.GeomTypeEnum.BOUNDARY_POINT,T[I.sharp_Point]=t.GeomTypeEnum.SHARP_POINT,T[I.smooth_Point]=t.GeomTypeEnum.SMOOTH_POINT,T[I.hidden_Seam_Point]=t.GeomTypeEnum.HIDDEN_SEAM_POINT,T[I.surfacic_Point]=t.GeomTypeEnum.SURFACIC_POINT,T[I.free_Point]=t.GeomTypeEnum.FREE_POINT,T[I.infinite_Face]=t.GeomTypeEnum.INFINITE_FACE,T[I.face]=t.GeomTypeEnum.FACE;var D=0,C=1,P=2,E=3,M=4,b=9;return e.extend({init:function(e,t){this.clientManager=t,this.parameter=e},applyMatAppsToElt:function(e,t,i,r,n,a){if(e)for(var o=0;o<t.length;o++)this.applyMatAppToElt(e[t[o]],i,r,n,a)},applyMatAppToElt:function(e,t,i,r,n){if(e){var a=e;if(a.isDecal){if(!a.decal)return;var o=a.decal,s=w.get(a.uid);s||(s=new Set,w.set(a.uid,s)),o.__shareAttachementFrom(s),a.apply&&o.applyOn(i),a.attach&&o.attachTo(i)}else t?(n.length>0&&i._setMaterialOnGeomTypes(n,a),i instanceof l?Array.isArray(r)&&r.length>0&&i.setMaterial(r,a):r.forEach(function(e){e.setMaterial&&e.setMaterial(a)})):(i.removeMaterialApplication(),i.setMaterialApplication(a))}},applyMaterialToElt:function(e,t,i,n,a,o,s,d){if(e&&e[t]){var c=e[t];if(a){var u=new r({geometricalFaceMaterial:c,layer:i,inheritance:n});d.length>0&&o._setMaterialOnGeomTypes(d,u),o instanceof l?Array.isArray(s)&&s.length>0&&o.setMaterial(s,u):s.forEach(function(e){e.setMaterial&&e.setMaterial(u)})}else o.removeMaterialApplication(),o.setMaterialApplication(new r({geometricalFaceMaterial:c,layer:i,inheritance:n}))}},removeTextureFromCache:function(e){v&&v.removeImage(e)},applyGP:function(e,r,a,o){if(void 0!==e&&void 0!==r){var s=this.parameter;if(void 0!==s){var d=this,c=[];Array.isArray(o)&&o.forEach(function(e){c.push(T[e])});var g=Array.isArray(a)&&a.length>0||c.length>0,w=!1,I={},D=s.getGasStruct();void 0!==D&&Object.keys(D).length>0?(w=!0,void 0!==D.colorRGB&&Number.isInteger(D.colorRGB)&&(D.colorRGB=new t.Color(D.colorRGB)),void 0!==D.colorA&&Number.isInteger(D.colorA)&&(D.colorA/=255),void 0!==D.showFree&&(g||(I.showFree=D.showFree)),void 0!==D.noShow&&(g?D.show=!D.noShow:I.show=!D.noShow),void 0!==D.noPick&&(g||(I.pick=D.noPick?i.PICKTHROUGH:i.PICKABLE)),void 0!==s._fill&&function(e,i,r){switch(e){case 5:case 6:i.colorIndex=t.COLORMAP_INDEX.FOREGROUND,i.inheritanceCustom?i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY||i.inheritanceCustom:i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY;break;case 2:i.colorIndex=t.COLORMAP_INDEX.TRUECOLOR,i.colorA=.5,i.transparent=!0,i.inheritanceCustom?i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY||i.inheritanceCustom:i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY;break;case 3:i.colorIndex=t.COLORMAP_INDEX.TRUECOLOR,i.colorA=0,i.transparent=!0,i.inheritanceCustom?i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY||i.inheritanceCustom:i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY;break;case 4:r?(i.colorIndex=t.COLORMAP_INDEX.BACKGROUND,i.colorA=1):(i.colorIndex=t.COLORMAP_INDEX.TRUECOLOR,i.colorA=0,i.transparent=!0),i.inheritanceCustom?i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY||i.inheritanceCustom:i.inheritanceCustom=t.GASEnumCustom._COLOR_INDEX_WITH_OPACITY}}(s._fill,D,e.isViewpoint2D())):D={};var C=s.getCustomProperty();if(C){var P=C.getValue(u.prototype.propertyTypes.InheritanceMode);void 0!==P&&(D.inheritance=P,w=!0);var E=C.getValue(u.prototype.propertyTypes.ViewMode),M=C.getValue(u.prototype.propertyTypes.ViewModeSensitivity);void 0===E&&void 0===M||this.applyRepViewMode(e,r,E,M)}if(w){var b=new n.IncrementalGraphicAttributeSet(D).usingNREInit(!0);g?(c.length>0&&r._setGASOnGeomTypes(c,b),r instanceof l?Array.isArray(a)&&a.length>0&&r._setGAS(a,b):a.forEach(function(e){e._setGAS&&e._setGAS(b)})):r._setGAS(b)}var A=s.getMaterial();if(void 0!==A){var V=A.getMaterialDefinition();if(void 0!==V)if(!0===V.DefaultMaterial)g?(c.length>0&&r._setMaterialOnGeomTypes(c,null),r instanceof l?Array.isArray(a)&&a.length>0&&r.setMaterial(a,null):a.forEach(function(e){e.setMaterial&&e.setMaterial(null)})):r.removeMaterialApplication();else{e.id!==S&&(S=e.id,_.clear());var O=V.JSON,N=_.get(O),G=V.Buffers,x=V.Layer,R=V.Inherit,H=[0];if(V.Index?H=[V.Index]:V.Indices&&(H=V.Indices),N)N.materialApplications?this.applyMatAppsToElt(N.materialApplications,H,g,r,a,c):this.applyMaterialToElt(N.materials,H[0],x,R,g,r,a,c);else{var k=[];Array.isArray(G)&&G.length>0&&G.forEach(function(e){k.push({buffer:e.getData()})}),y.load({resourcesLibrary:v,zipped:!1,json:O,chunks:k,doneCallback:function(e){if(e.materialApplications?(_.set(e.json,{materialApplications:e.materialApplications,materials:null}),d.applyMatAppsToElt(e.materialApplications,H,g,r,a,c)):(_.set(e.json,{materialApplications:null,materials:e.materials}),d.applyMaterialToElt(e.materials,H[0],x,R,g,r,a,c)),d.clientManager){var t=v.getRequestedUids();t.length&&d.clientManager.getTexturesFromUids({node:void 0,serverNodeId:void 0,textureUids:t,onAnswer:function(e){for(var t in e.buffers){var i=v.getImageToRequest(parseInt(t)),r="image/"+i.format;"dds"!==i.format&&"hdr"!==i.format&&"basis"!==i.format||(r="arraybuffer");var n=new Blob([e.buffers[t]._data],{type:r});y._loadGenericTexture(i.format,null,window.URL.createObjectURL(n),!0,function(){console.log("texture map updated")},null,i.map),v.removeImageToRequest(parseInt(t))}}})}}})}}}if(!g&&(void 0!==I.pick&&r.setPickable(I.pick),void 0!==I.show&&r.setVisibility(I.show),void 0!==I.showFree&&r.setVisibilityFree(I.showFree),C)){var F=C.getValue(u.prototype.propertyTypes.PickMode);if(void 0!==F)if(0===F)r.setPickingMode(null);else{var L=new h;L.applyToAll(i.PICK_VISIBLE),1&F&&(L.setPickingMode("Face",i.PICK_ALWAYS),L.setPickingMode("AxisSystem",i.PICK_ALWAYS),L.setPickingMode("InfiniteFace",i.PICK_ALWAYS)),2&F&&(L.setPickingMode("Edge",i.PICK_ALWAYS),L.setPickingMode("InternalSharpEdge",i.PICK_ALWAYS),L.setPickingMode("InternalSmoothEdge",i.PICK_ALWAYS),L.setPickingMode("_HighCurvatureEdge",i.PICK_ALWAYS),L.setPickingMode("BoundaryEdge",i.PICK_ALWAYS)),4&F&&L.applyToAll(i.PICK_NEVER),r.setPickingMode(L)}var U=C.getValue(u.prototype.propertyTypes.StaticPickWithChildrenAsAWhole);if(void 0!==U){var B=!!U;r.setVisuFilters({doNotPickUnderFilter:new f(B)})}let n=C.getValue(u.prototype.propertyTypes.IsIn3DBackGround);void 0!==n&&r.setIsInBackground(!!n);var W=C.getValue(u.prototype.propertyTypes.ExcludeFromBounding);"undefined"!=typeof excludeValue&&r.exludeFromBounding(!!W);var z=C.getValue(u.prototype.propertyTypes.LayerNumber);void 0!==z&&r.setLayerNumber(z);var j=C.getValue(u.prototype.propertyTypes.Filtered);void 0!==j&&r.setFiltered(!!j);var X=C.getValue(u.prototype.propertyTypes.StaticGeomType);if(void 0!==X&&""!==X){var K=t.GeomTypeEnum[X];if(void 0!==K){var $=new p(K);r.setVisuFilters({_staticGeomTypeFilter:$}),r.traverse(function(e,t){if(void 0===e)return!0;if("Mesh3D"===e.getNodeType()){var i=e.mesh3js.geometry;if(!(i&&i.length>0))return!0;i[0].drawingGroups.forEach(function(e){e._geomType!==t&&(e._initialGeomType=e._geomType),e._geomType=t})}return!1},K)}}var J=C.getValue(u.prototype.propertyTypes.StaticPickPriority);void 0!==J&&""!==J&&r.setPickingPriorityId(J);var Y=C.getValue(u.prototype.propertyTypes.StaticMaterial);if(void 0!==Y&&""!==Y)(Q=e.getStaticMaterial(Y))&&r.setVisuFilters({lookFilter:new m(Q)});var Z=C.getValue(u.prototype.propertyTypes.StaticLook);if(void 0!==Z&&""!==Z){var q=e.getStaticLook(Z);if(q){var Q=q.material;r.setVisuFilters({lookFilter:new m(Q).usingShadowReceive(q.shadowReceive).usingShadowCast(q.shadowCast)})}}}}}},applyRepViewMode:function(e,i,r,n){var a=e.viewManager.viewer._getCSIOverrideManager(),o=a.getRepViewModeParams(i,r,n),s=o.repViewMode,l=o.viewModeSensitive;a.deleteRepViewModeOverride(i);var d=a.getRepViewModeOverride(i,l),c=!1;if(s===D)c=!0;else{var u=t.GeomTypeEnum.EDGE|t.GeomTypeEnum.SHARP_EDGE|t.GeomTypeEnum.SMOOTH_EDGE|t.GeomTypeEnum._HIGH_CURVATURE_EDGE|t.GeomTypeEnum.BOUNDARY_EDGE|t.GeomTypeEnum.FACE|t.GeomTypeEnum.INFINITE_FACE,h=new g({faceMode:null});switch(h._displayNothingRenderMode(),h.setReplaceMask(u),s){case C:h.setRenderMode("Face",!0),h.setRenderMode("InfiniteFace",!0);break;case P:h.setRenderMode("@Edge",!0);break;case E:h.setRenderMode("Face",!0),h.setRenderMode("InfiniteFace",!0),h.setRenderMode("@Edge",!0);break;case M:h.setRenderMode("Face",!0),h.setRenderMode("InfiniteFace",!0);break;case b:h.setRepViewNothing(!0);break;default:c=!0}c||d.setRenderStyle(h)}c&&a.deleteRepViewModeOverride(i)}})}),define("DS/WebVisuParameters/BoundingSphereParameterHelper",["DS/CSIViewModelWebInterfaces/CSIVMClientBoundingSphereParameter","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var i={getBoundingSphere:function(e){if(!e)return null;var i=e.getRadius(),r=e.getRadiusMM(),n=new t.Sphere(new t.Vector3(e.getCenterX(),e.getCenterY(),e.getCenterZ()),i);return n.pixelRadius=r*t.getPixelsPerMM(),{sphere:n,isInfinite:e.getState()===e.stateValues.infinite,isEmpty:e.getState()===e.stateValues.empty,isContain:e.getState()===e.stateValues.contain}}};return i}),define("DS/WebVisuParameters/CSIModelIdPathParameter",["UWA/Class","DS/CSICommandBinder/CSICommandBinder"],function(e,t){"use strict";var i={labels:{elementsId:"elems_id",elementsNamingContext:"elems_nc",subElements:"subelems_id"},serialize:function(e,t){var r,n,a=[],o=[];for(r=0;r<t.elements.length;r++)n=t.elements[r],a.push(n.id),o.push(n.namingContext);e.writeUint32Array(i.labels.elementsId,a),e.writeUint8Array(i.labels.elementsNamingContext,o),e.writeUint32Array(i.labels.subElements,t.subElements)},unserialize:function(e){var t,r={elements:[],subElements:[]},n=e.readUint32Array(i.labels.elementsId),a=e.readUint8Array(i.labels.elementsNamingContext),o=e.readUint32Array(i.labels.subElements);for(t=0;t<n.length;t++)r.elements.push({id:n[t],namingContext:a[t]});for(t=0;t<o.length;t++)r.subElements.push(o[t]);return r}};return t.declareType({type:"CATModelIdPath",serialize:i.serialize,unserialize:i.unserialize}),i}),define("DS/WebVisuParameters/PathElementRepNodeUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/Filters/SideFilter"],function(e,t,i,r){function n(e){if(e.parents.length>1)throw"Wrong number of parents on linked node"}const a=new Map;class o{constructor(e,t){this.linkerMap=t,t.set(e,this),this.mainNode3D=e,this.linkedNode3Ds=null}removeMainNode3D(e){const t=this.linkerMap;if(this.linkedNode3Ds&&0!==this.linkedNode3Ds.size){if(e){const e=this;this.linkedNode3Ds.forEach((t,i,r)=>e.removeLinkedNode3D(i)),t.delete(this.mainNode3D)}}else t.delete(this.mainNode3D)}isLinkedNode(e){return this.linkedNode3Ds&&this.linkedNode3Ds.has(e)}isIntermediateLinkedNode(e){return this.isLinkedNode(e)&&this.linkedNode3Ds.get(e)}isFinalLinkedNode(e){return this.isLinkedNode(e)&&!this.linkedNode3Ds.get(e)}createLinkedNode3D(e,t,i){const r=this.linkerMap;if(0!==t.children.length&&t._getForbidHierarchyUpdate())throw"Invalid parent node for node linking";var n=this.mainNode3D._linkingClone(null,i);this.linkedNode3Ds||(this.linkedNode3Ds=new Map),r.set(n,this),this.linkedNode3Ds.set(n,e);const a=t._getForbidHierarchyUpdate();return t._setForbidHierarchyUpdate(!1),t.addChild(n),t._setForbidHierarchyUpdate(a),n._setForbidHierarchyUpdate(!0),e||this.syncChildren(n),n}removeLinkedNode3D(e,t){const i=this.linkerMap;if(this.isLinkedNode(e)){n(e),e._setForbidHierarchyUpdate(!1);const s=e.parents[0],l=s._getForbidHierarchyUpdate();if(s._setForbidHierarchyUpdate(!1),s.removeChild(e),s._setForbidHierarchyUpdate(l),i.delete(e),this.linkedNode3Ds.get(e)||e.removeChildren(),this.linkedNode3Ds.delete(e),t){var r=Array.from(e.children);for(let e=0;e<r.length;e++){var a=r[e];if(i.has(a)){var o=i.get(a);o.removeLinkedNode3D(a,o,!0)}}}this.removeMainNode3D(!1)}}lock(e){this.isLinkedNode(e)&&(n(e),e._setForbidHierarchyUpdate(!0))}toArray(){return this.linkedNode3Ds?Array.from(this.linkedNode3Ds.keys()):[]}syncChildren(e){if(this.isFinalLinkedNode(e)){e._setForbidHierarchyUpdate(!1),e.removeChildren();for(var t=0;t<this.mainNode3D.children.length;t++)e.addChild(this.mainNode3D.children[t]);e._setForbidHierarchyUpdate(!0)}}}function s(e,t){let i=null;return a.has(e)?i=a.get(e):t&&(i=new o(e,a)),i}const l="PathElementRepNode3D";let d=!1;class c extends t{constructor(){super(l),0}_cleanTemp(){if(this.parents.length>0)return;0;const e=this.children[0];if(!e)return;const t=s(e,!1);t&&t.removeLinkedNode3D(e,!0)}_toExternalPathElement(){if(0===this.parents.length)return[];let e=[this.parents[0]],t=this;for(;t;){e.push(t);const i=s(t=t.children[0],!1);if(!i||!i.isLinkedNode(t))break}return e}addChild(e){if(!d)return!1;super.addChild(e)}insertChildAtIndex(e,t){if(!d)return!1;super.insertChildAtIndex(e,t)}}const u={set(e,i,r){if("__isProxy__"===i||"__target__"===i)throw"Do not manipulate private proxy parameters";if("children"===i||"parents"===i)throw"Do not manipulate children and parents of a proxified Node3D directly";if(e[i]instanceof Function&&t.prototype[i])throw"Don't override prototype";"_"===i[0]&&console.error("Unexpected: setting a private property manually, may not work properly in linkage - "+i);const n=s(e,!1);let a=[];n&&(n.isLinkedNode(e)||0===(a=n.toArray()).length&&n.removeMainNode3D(!0)),e[i]=r;for(let e=0;e<a.length;e++){a[e][i]=r}},get(e,i,r){if("__isProxy__"===i)return!0;if("__target__"===i)return e;if("children"===i||"parents"===i)throw"Do not manipulate children and parents of a proxified Node3D directly";i[0];const n=e[i];if(n instanceof Function){const r="addChild"===i||"removeChild"===i||"removeChildren"===i||"insertChildAtIndex"===i,a=s(e,!1);let o=[];return a&&(a.isLinkedNode(e)||0===(o=a.toArray()).length&&a.removeMainNode3D(!0)),function(...i){if(i)for(let e=0;e<i.length;e++)i[e]instanceof t&&i[e].__isProxy__&&(i[e]=i[e].__target__);var s=n.apply(e,i);for(let e=0;e<o.length;e++){const t=o[e];r?a.syncChildren(t):n.apply(t,i)}return s}}return n}};return{buildPathElementRepNode3DFromArray:function(n,a,o){d=!0;const l=new c;a.addChild(l);let u=l;for(let e=0;e<n.length;e++){let i=n[e];if(!(i instanceof t))throw"Unsupported operation, expected an array of Node3D";u=s(i,!0).createLinkedNode3D(e!==n.length-1,u,o)}if(u instanceof i&&o){const t=u.mesh3js;u.setVisuFilters({_sideFilter:new r(e.DoubleSide)}),null===t.layer&&t.initLayers();const i=o.getPrimitives();for(let e=0;e<i.length;e++)i[e]=i[e].clone();t.layer.addPrimitivesToLayers(i,1)}return d=!1,l},getProfixiedNodeIfNecessary:function(e){return e&&e instanceof t&&s(e,!1)&&!e.__isProxy__?new Proxy(e,u):e}}}),define("DS/WebVisuParameters/CSIViewParameterLabels",[],function(){"use strict";return{viewStatus:"viewStatus",idPatterns:"idPatterns",graphicProperties:"GraphicProperties",treeUpdates:"treeUpdates",viewStatusTemporary:"temporary",viewStatusPermanent:"permanent",viewStatusCommit:"commit",viewStatusAbort:"abort",showMode:"ShowMode",staticMaterial:"SetStaticMaterial",staticPickPriority:"SetStaticPickPriority",id:"id",idSpace:"idSpace",idContext:"idContext",shared:"shared",treeKey:"treeKey",tokens:"tokens",appliedGas:"AppliedGraphicProperties",node:"Node",value:"value",localIdInt:"localId_Int",localIdString:"localId_String",idPattern:"idPattern",batchCellIdPattern:"batchCellIdPattern",parent:"parent",batchParent:"batchParent",valueAddNode:"AddNode",valueAddCustomNode:"AddCustomNode",valueModifyCustomNode:"ModifyCustomNode",valueAddExistingNode:"AddExistingNode",valueRemoveExistingNode:"RemoveExistingNode",valueAddBody:"AddBody",valueAddCells:"AddCells",valueRemoveAll:"RemoveAll",valueMesh:"mesh",valueBoundingSphere:"bs",valueBoundingBox:"bbox",valueInitializers:"inits",valueCustomData:"customdata",valueGeometry:"geometry",valueGeometries:"geometries",valueOffset:"offset",valueByteLength:"bytelength",valueBytePerElement:"bpe",valueDrawGroups:"dgs",valueStart:"start",valueCount:"count",valueGeomType:"geomType",valuePrimitives:"primitives",valueBuffer:"buffer",valueBufferPartitions:"bufferPartitions",valueBufferPartition:["vertexPositionArray","vertexIndexArray","vertexColorArray","vertexNormalArray","vertexBinormalArray","vertexTangentArray","vertexUvArray","vertexUv2Array"],valueGeomTypeValue:["EDGE","WIRE_EDGE","BOUNDARY_EDGE","SHARP_EDGE","SMOOTH_EDGE","BOUNDARY_POINT","SHARP_POINT","SMOOTH_POINT","SURFACIC_POINT","FREE_POINT","INFINITE_FACE","FACE"],glTypeFromGeomType:{EDGE:1,WIRE_EDGE:1,BOUNDARY_EDGE:1,SHARP_EDGE:1,SMOOTH_EDGE:1,BOUNDARY_POINT:0,SHARP_POINT:0,SMOOTH_POINT:0,SURFACIC_POINT:0,FREE_POINT:0,INFINITE_FACE:4,FACE:4},valueRadius:"rad",valueState:"state",valueStateValue:["EMPTY","NORMAL","INIFINITE","CONTAIN"],valueX1:"x1",valueY1:"y1",valueZ1:"z1",valueX2:"x2",valueY2:"y2",valueZ2:"z2",shortId:"shortId",idPath:"idPath",valueBinaryFormat:"binaryformat",valueClientModule:"clientmodule",valueData:"Data",valueBinaryFormatValue:["Bin","Cgr"]}}),define("DS/WebVisuParameters/SceneEnvParameterItem",["DS/Visualization/ThreeJS_DS"],function(e){"use strict";var t=function(e){this.container=e};t.prototype={constructor:t,areViewModesManaged:function(){return!1},getViewMode:function(){return null},getViewModeMask:function(){return 0},getViewModeAppearanceStructure:function(e){return null},getCamerasJSON:function(){return null},getCameras2DJSON:function(){return null},getChangeType:function(){return null},getViewpointsInfo:function(){return null},areCamerasManaged:function(){return!1},areLightsManaged:function(){return!1},getLightsJSON:function(){return null},areAmbiancesManaged:function(){return!1},isDefaultAmbiance:function(){return!1},getAmbianceJSON:function(){return null},getGroundGridActivation:function(){return null},getAmbianceBuffers:function(){return null},areSupportParametersManaged:function(){return!1},getHighlightRenderingData:function(){return null},getPrehighlightRenderingData:function(){return null},getColorMap:function(){return null},getFog:function(){return!1},getClippingPlane:function(){return null},getBackground3DViewMode:function(){return null},getMainViewpointUID:function(){return null},getViewerType:function(){return null},get2DMode:function(){return null},getPLMViewMode:function(){return null},getMultiViewSyncMode:function(){return null},getDynamicMode:function(){return!1},areLineTypeDefinitionsManaged:function(){return!1},getLineTypeDefinitions:function(){return null}};var i=function(e){t.call(this,e)};i.prototype=Object.create(t.prototype),Object.assign(i.prototype,{areViewModesManaged:function(){return!!this.getViewMode()},getViewMode:function(){return this.container.getViewmode?this.container.getViewmode():null},getViewModeMask:function(){var e=this.container.getViewmode();return e?e._viewMode:0},getViewModeAppearanceStructure:function(t){if(this.getViewModeMask()&t){var i=this.getViewMode();return{appearanceName:i._appearanceName,customParams:{shininess:i._shininess,opacity:i._opacity,color:(new e.Color).setRGB(i._color[0],i._color[1],i._color[2]),useColorFromGAS:i._useObjectColor}}}return null},getCamerasJSON:function(){var e=this.container.getCamerasJSON();return e?e.getJSON():null},areCamerasManaged:function(){return this.container.AreCamerasManaged&&this.container.AreCamerasManaged()},areLightsManaged:function(){return this.container.AreLightsManaged&&this.container.AreLightsManaged()},getLightsJSON:function(){var e=this.container.getLightsJSON();return e?e.getJSON():null},areAmbiancesManaged:function(){return this.container.AreAmbiancesManaged&&this.container.AreAmbiancesManaged()},isDefaultAmbiance:function(){return this.container.getIsDefaultAmbiance()},getAmbianceJSON:function(){var e=this.container.getAmbianceJSON();return e?e.getJSON():null},getAmbianceBuffers:function(){return this.container.getAmbianceBuffers()}});var r=function(i){e.__tmpIsA2X=!0,t.call(this,i)};return r.prototype=Object.create(t.prototype),Object.assign(r.prototype,{areViewModesManaged:function(){return!!this.getViewMode()},getViewMode:function(){return this.container.getViewMode()},getViewModeMask:function(){var e=this.container.getViewMode();return e?e.getViewMode():0},getViewModeAppearanceStructure:function(t){if(this.getViewModeMask()&t){var i=this.getViewMode(),r=i.getColor();return{appearanceName:i.getAppearance(),customParams:{shininess:i.getShininess(),opacity:i.getOpacity(),color:(new e.Color).setRGB(r[0],r[1],r[2]),useColorFromGAS:i.getUseObjectColor()}}}return null},getViewpoints:function(){return this.container.getViewpoints()},getCameras2DJSON:function(){if(!this.areCamerasManaged())return null;var e=this.getViewpoints().getCameras2DJSON();return e?e.getJSON():null},getCamerasJSON:function(){if(!this.areCamerasManaged())return null;var e=this.getViewpoints().getCamerasJSON();return e?e.getJSON():null},getChangeType:function(){return this.areCamerasManaged()?this.getViewpoints().getChangeType():null},getViewpointsInfo:function(){return this.areCamerasManaged()?this.getViewpoints().getViewpointsInfo():null},areCamerasManaged:function(){return!!this.getViewpoints()},areLightsManaged:function(){return!1},getLightsJSON:function(){return null},getAmbiance:function(){return this.container.getAmbiance()},areAmbiancesManaged:function(){return!!this.getAmbiance()},isDefaultAmbiance:function(){return!this.getAmbianceJSON()},getAmbianceJSON:function(){if(!this.areAmbiancesManaged())return null;var e=this.getAmbiance().getAmbianceJSON();return e?e.getJSON():null},getGroundGridActivation:function(){return this.areAmbiancesManaged()?this.getAmbiance().getGroundGridActivation():null},getAmbianceBuffers:function(){return this.areAmbiancesManaged()?this.getAmbiance().getAmbianceBuffers():null},getSupportParameters:function(){return this.container.getSupportParameters()},areSupportParametersManaged:function(){return!!this.getSupportParameters()},getHighlightRenderingData:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getHighlightRenderingData():null},getPrehighlightRenderingData:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getPrehighlightRenderingData():null},getColorMap:function(){return this.areSupportParametersManaged()&&this.getSupportParameters().getColorMap?this.getSupportParameters().getColorMap():null},getFog:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getFog():null},getClippingPlane:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getSupportClippingPlane():null},getBackground3DViewMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getBackground3DViewMode():null},getMainViewpointUID:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getMainViewpointUID():null},getViewerType:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getViewerType():null},get2DMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().get2DMode():null},getPLMViewMode:function(){return this.container&&this.container.getPLMViewMode()},getMultiViewSyncMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getMultiviewSyncMode():null},getDynamicMode:function(){return this.areSupportParametersManaged()?this.getSupportParameters().getDynamicMode():null},areLineTypeDefinitionsManaged:function(){return void 0!==this.container.getLineDefinitions()},getLineTypeDefinitions:function(){return this.container.getLineDefinitions()}}),{VisuContextData:r,SceneEnvData:i}}),define("DS/WebVisuParameters/AbstractWebVisuUpdateTransaction",["DS/CSIViewModelWebInterfaces/CSIVMClientTransaction","DS/WebVisuParameters/PathElementRepNodeUtils"],function(e,t){"use strict";var i=function(e,t,i){if(window.newMaterialInheritance=!0,this.clientManager=i,this.viewManager=e,this.treeKeyID=t.getUUID?t.getUUID():null,this.view=null,e)if(t.getViewpointUID&&0!==t.getViewpointUID()){let i=e._viewpointMap.get(t.getViewpointUID());if(i){let t=e.viewer._viewpointManager.getViewpointScenegraph(i);this.view=t?e.addView(this.treeKeyID,t.userRoot):e.getView(this.treeKeyID)}else console.error("no viewpoint correspond to this uid : "+t.getViewpointUID())}else this.view=e.getView(this.treeKeyID)};return(i.prototype=Object.create(e.prototype)).getOperatedObject=function(e){var i=e.getOperatedObject();return t.getProfixiedNodeIfNecessary(i)},i.prototype.getOperandObject=function(e){return e.getOperandObject()},i.prototype.doOperation=function(e){throw"Not implemented"},i.prototype.commit=function(){throw"Not implemented"},i.prototype.abort=function(){throw"Not implemented"},i.prototype.executeEnd=function(){throw"Not implemented"},i.prototype.executeInverse=function(){throw"Not implemented"},i}),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionHSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO"],function(e,t,i){"use strict";var r=new Map,n=function(e,n){if(i.call(this,n),r.has(n)||r.set(n,{nonColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},defaultSlotColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},highlightType:"AdvancedPoliteness",advanced:!0}),this.enabled=!0,this.highlightColor=r.get(n).advanced?new t.AdvancedPoliteHighlightData(t.DefaultHighlightData.advancedpolite):new t.HaloHighlightData(t.DefaultHighlightData.halo),this.highlightColor.priority=8192,e)this.highlightColor._setData(e);else{var a=r.get(n).currentHighlightType;this.highlightColor._setData(r.get(n).defaultSlotColorParameters[a])}this._event="HIGHLIGHT",this._setData(this.highlightColor)};(n.prototype=Object.create(i.prototype))._setData=function(i){if(i){var n=this.viewer,a=r.get(n).advanced?new t.AdvancedPoliteHighlightData(this.highlightColor):new t.HaloHighlightData(this.highlightColor);a._setData(i);var o=r.get(n).currentHighlightType;a._setData(r.get(n).nonColorParameters[o]),e.publish({event:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_HIGHLIGHT_UPDATE",eventType:"@CSI_HIGHLIGHT_UPDATE",parameters:{highlightColor:this.highlightColor,newColor:a,viewer:n,advanced:r.get(n).advanced}}}),this.highlightColor=a}};var a=new Map,o=null;return e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE"},function(e){var t=e.parameters.slot+1,i=e.parameters.color,r=e.parameters.viewer,s=i,l=i.clone().multiplyScalar(1.142);l.r=Math.max(Math.min(l.r,1),0),l.g=Math.max(Math.min(l.g,1),0),l.b=Math.max(Math.min(l.b,1),0);var d={color:i,haloColor:s,outlineColor:l,priority:4095+t};(o=a.get(r))||(o=[new n(null,r)],a.set(r,o)),o[t]?o[t]._setData(d):o[t]=new n(d,r)}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION"},function(e){var t=e.parameters.enabled,i=e.parameters.viewer;(o=a.get(i))||(o=[new n(null,i)],a.set(i,o));for(var s=1;s<o.length;s++){o[s]||(o[s]=new n({},i)),o[s].enabled=t;var l=i._getHighlightSet(o[s].highlightColor,!1,!!r.get(i).advanced);l&&l.enable(t)}}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION"},function(e){var t=e.parameters.enabled,i=e.parameters.viewer;(o=a.get(i))||(o=[new n(null,i)],a.set(i,o)),o[0]||(o[0]=new n({},i)),o[0].enabled=t;var s=i._getHighlightSet(o[0].highlightColor,!1,!!r.get(i).advanced);s&&s.enable(t)}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_HIGHLIGHT_UPDATE"},function(e){var t=e.parameters.viewer;(o=a.get(t))||(o=[new n(null,t)],a.set(t,o));var i=e.parameters.highlightType,s=r.get(t).currentHighlightType;Object.assign(r.get(t).defaultSlotColorParameters[i],e.parameters.colorParameters),o[0]._setData(r.get(t).defaultSlotColorParameters[s])}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_NON_COLOR_UPDATE"},function(e){var t=e.parameters.viewer;(o=a.get(t))||(o=[new n(null,t)],a.set(t,o));var i=e.parameters.highlightType;Object.assign(r.get(t).nonColorParameters[i],e.parameters.nonColorParameters);for(var s=0;s<o.length;s++)o[s]&&o[s]._setData({})}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_TYPE_UPDATE"},function(e){var t=e.parameters.viewer;(o=a.get(t))||(o=[new n(null,t)],a.set(t,o));var i=e.parameters.highlightType;"AdvancedPoliteness"===i||"Halo"===i?(r.get(t).currentHighlightType=i,r.get(t).advanced="AdvancedPoliteness"===i):i=r.get(t).currentHighlightType;for(var s=0;s<o.length;s++)o[s]&&o[s]._setData(0===s?r.get(t).defaultSlotColorParameters[i]:{})}),e.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;if(a.has(t))for(var i=a.get(t),n=0;n<i.length;n++){var o=i[n];if(o){o._treeKeyToStruct.forEach(function(e,t,i){o._setTreeKey(t),o.removeAll()});var s=t._getHighlightSet(o.highlightColor,!1,!!r.get(t).advanced);s&&t.removeHighlightSet(s)}}a.delete(t),r.delete(t)}),{getXSO:function(e,t,i){if((o=a.get(t))||(o=[new n(null,t)],a.set(t,o)),e>o.length||e<0)throw"Invalid slot";var s=o[e];if(!s)throw"Missing slot";return t.createHighlightSet(s.highlightColor,!1,!!r.get(t).advanced).enable(s.enabled),s._setTreeKey(i),s},clearMultiHighlightColorSlot:function(e){for(var t=1;t<o.length;t++){var i=o[t];i&&(i._setTreeKey(e),i.removeAll())}}}}),define("DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionPSO",["DS/CoreEvents/Events","DS/Visualization/ThreeJS_DS","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionXSO"],function(e,t,i){"use strict";var r=new Map,n=function(e){i.call(this,e),r.has(e)||r.set(e,{nonColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},defaultSlotColorParameters:{Basic:{},Halo:{},Politeness:{},AdvancedPoliteness:{}},currentHighlightType:"AdvancedPoliteness",advanced:!0});var n=r.get(e).currentHighlightType;this.highlightColor=r.get(e).advanced?new t.AdvancedPoliteHighlightData(t.DefaultPreHighlightData.advancedpolite):new t.HaloHighlightData(t.DefaultPreHighlightData.halo),this.highlightColor._setData(r.get(e).defaultSlotColorParameters[n]),this._event="PREHIGHLIGHT",this._setData(this.highlightColor)};(n.prototype=Object.create(i.prototype))._setData=function(i){if(i){var n=this.viewer,a=r.get(n).advanced?new t.AdvancedPoliteHighlightData(this.highlightColor):new t.HaloHighlightData(this.highlightColor);a._setData(i);var o=r.get(n).currentHighlightType;a._setData(r.get(n).nonColorParameters[o]),e.publish({event:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_PREHIGHLIGHT_UPDATE",eventType:"@CSI_PREHIGHLIGHT_UPDATE",parameters:{newColor:a,viewer:n,advanced:r.get(n).advanced}}}),this.highlightColor=a}};var a=new Map,o=null;return e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_PREHIGHLIGHT_UPDATE"},function(e){var t=e.parameters.viewer;(o=a.get(t))||(o=[new n(t)],a.set(t,o));var i=e.parameters.highlightType,s=r.get(t).currentHighlightType;Object.assign(r.get(t).defaultSlotColorParameters[i],e.parameters.colorParameters),o[0]._setData(r.get(t).defaultSlotColorParameters[s])}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_PREHIGHLIGHT_NON_COLOR_UPDATE"},function(e){var t=e.parameters.viewer;(o=a.get(t))||(o=[new n(t)],a.set(t,o));var i=e.parameters.highlightType;Object.assign(r.get(t).nonColorParameters[i],e.parameters.nonColorParameters);for(var s=0;s<o.length;s++)o[s]&&o[s]._setData({})}),e.subscribe({event:"/VISU/SELECTION/CSI_CONTEXT_PREHIGHLIGHT_TYPE_UPDATE"},function(e){var t=e.parameters.viewer;(o=a.get(t))||(o=[new n(t)],a.set(t,o));var i=e.parameters.highlightType;"AdvancedPoliteness"===i||"Halo"===i?(r.get(t).currentHighlightType=i,r.get(t).advanced="AdvancedPoliteness"===i):i=r.get(t).currentHighlightType;for(var s=0;s<o.length;s++)o[s]&&o[s]._setData(0===s?r.get(t).defaultSlotColorParameters[i]:{})}),e.subscribe({event:"/VISU/VIEWER/VIEWER_DISPOSED"},function(e){var t=e.parameters.viewer;if(a.has(t))for(var i=a.get(t),n=0;n<i.length;n++)i[n]&&i[n]._treeKeyToStruct.forEach(function(e,t,r){i[n]._setTreeKey(t),i[n].removeAll()});a.delete(t),r.delete(t)}),{getXSO:function(e,t,i){if((o=a.get(t))||(o=[new n(t)],a.set(t,o)),e>o.length||e<0)throw"Invalid slot";var r=o[e];if(!r)throw"Missing slot";return r._setTreeKey(i),r}}}),define("DS/WebVisuParameters/SceneEnvParameterHelper",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/WebVisuParameters/SceneEnvParameterItem","DS/Visualization/MaterialManager"],function(e,t,i,r,n){"use strict";var a=r.SceneEnvData,o=(r.VisuContextData,["WhiteDesign","BlueDesign","DarkDesign","Studio","PureWhite","WhiteMirror","WhiteReview","DarkMirror","DarkReview","Outdoor","Indoor","City","Road","NeoPureWhite"]),s={VIEW_NO_DISPLAY:0,VIEW_MESH:1,VIEW_EDGE:2,VIEW_OUTLINE:4,VIEW_MATERIAL:8,VIEW_HLR:16,VIEW_HRD:32,VIEW_HIDDEN_EDGE:64,VIEW_POLYGON:128,VIEW_ISOPARS:256,VIEW_TOON:512,VIEW_TRANSPARENT:1024,VIEW_REP_OVERLOAD:2048,VIEW_WITH_HALF_SMOOTH_EDGE:4096,VIEW_WITHOUT_SMOOTH_EDGE:8192,VIEW_LINEONLINE:16384,VIEW_WITHOUT_VERTEX:32768,VIEW_COLORED_EDGES_FROM_FACES:65536,VIEW_WITHOUT_WIRES:131072,VIEW_WITHOUT_AXIS:262144,VIEW_WITHOUT_POINTS:524288,VIEW_WITHOUT_CONSTRAINTS:1048576,VIEW_RAYTRACING:2097152,VIEW_WITHOUT_SMALL_CURVATURE_STEP_EDGE:536870912,VIEW_APPEARANCE:1073741824};e.__ViewModeType__=s;var l={Basic:e.DefaultAppearanceMode.BASIC,GASLook:e.DefaultAppearanceMode.GASLOOK,Transparent:e.DefaultAppearanceMode._TRANSPARENT,Clay:e.DefaultAppearanceMode.CLAY,WhiteMatPlaster:e.DefaultAppearanceMode.WHITE_MAT_PLASTER,GreyShinyPlastic:e.DefaultAppearanceMode.GREY_SHINY_PLASTIC,CastAluminum:e.DefaultAppearanceMode.CAST_ALUMINUM,MachinedAluminum:e.DefaultAppearanceMode.MACHINED_ALUMINUM,CastSteel:e.DefaultAppearanceMode.CAST_STEEL,BrushedSteel:e.DefaultAppearanceMode.BRUSHED_STEEL,MachinedStainlessSteel:e.DefaultAppearanceMode.MACHINED_STAINLESS_STEEL,Copper:e.DefaultAppearanceMode.COPPER,Brass:e.DefaultAppearanceMode.BRASS,GenericPlastic:e.DefaultAppearanceMode.GENERIC_PLASTIC,GenericMetal:e.DefaultAppearanceMode.GENERIC_METAL,QAAutomation:null,Count:null};e.__ViewAppearanceMap__=l;var d=new Uint32Array(1),c=new Uint8Array(d.buffer),u=1;function h(t,r,n,a,o){var s=!1,l="Halo";t.getStandardActivation()&&(l="AdvancedPoliteness",s=!0);var u=t.getHaloData();d[0]=u.color,n.Halo.haloEnabled=!!u.activation,s=s||!!u.activation,n.Halo.haloIntensity=u.intensity,n.Halo.haloThickness=u.size,a.Halo.haloColor=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255);var h=t.getScanData();d[0]=h.color,n.Halo.colorEnabled=!!h.activation,s=s||!!h.activation,n.Halo.intensity=h.intensity,a.Halo.color=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255);var g=t.getOutlineData();d[0]=g.color,n.Halo.outlineEnabled=!!g.activation,s=s||!!g.activation,a.Halo.outlineColor=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"Halo",nonColorParameters:n.Halo}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"Halo",colorParameters:a.Halo}}});var p=t.getAdvancedPolitnessData(),f=t.getPolitnessData();return p.activation?(l="AdvancedPoliteness",s=!0,n.AdvancedPoliteness.haloIntensity=p.haloIntensity,n.AdvancedPoliteness.outlineThickness=p.faceThickness,n.AdvancedPoliteness.visibleAlpha=p.visibleFaceAlpha/255,n.AdvancedPoliteness.occludedAlpha=p.occludedFaceAlpha/255,d[0]=p.color,a.AdvancedPoliteness.color=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255),d[0]=p.haloColor,a.AdvancedPoliteness.haloColor=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255),d[0]=p.outlineColor,a.AdvancedPoliteness.outlineColor=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255)):f.activation&&(l="AdvancedPoliteness",s=!0,n.AdvancedPoliteness.haloIntensity=2,n.AdvancedPoliteness.outlineThickness=1,n.AdvancedPoliteness.visibleAlpha=f.meshAlpha/255,n.AdvancedPoliteness.occludedAlpha=f.occludedMeshAlpha/255,d[0]=f.color,a.AdvancedPoliteness.color=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255),a.AdvancedPoliteness.haloColor=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255),a.AdvancedPoliteness.haloColor=a.AdvancedPoliteness.haloColor.clone().multiplyScalar(1/1.142),a.AdvancedPoliteness.outlineColor=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255),n.AdvancedPoliteness.haloEnabled=!1),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_NON_COLOR_UPDATE",parameters:{viewer:r,highlightType:"AdvancedPoliteness",nonColorParameters:n.AdvancedPoliteness}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",eventType:"@CSI_CONTEXT_DEFAULT_"+o+"_UPDATE",parameters:{viewer:r,highlightType:"AdvancedPoliteness",colorParameters:a.AdvancedPoliteness}}}),i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_TYPE_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_"+o+"_TYPE_UPDATE",eventType:"@CSI_CONTEXT_"+o+"_TYPE_UPDATE",parameters:{viewer:r,highlightType:l}}}),r.render(),s}var g=function(e,t){this.viewManager=e,this.viewer=this.viewManager?this.viewManager.viewer:null,this.loader=t};return g.prototype={constructor:g,getSceneEnvRootForLights:function(){var e=this.viewManager._sceneEnvRootForLights;return 0===e.parents.length&&this.viewer.addNode(e),e},setViewManager:function(e){this.viewManager=e,this.viewer=this.viewManager?this.viewManager.viewer:null},getSceneEnvRootForAmbiances:function(){var e=this.viewManager._sceneEnvRootForAmbiance;return 0===e.parents.length&&this.viewer.addNode(e),e},tryUpdateAmbiance:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areAmbiancesManaged())return Promise.resolve(!1);if(this.getSceneEnvRootForAmbiances().removeChildren(),e.isDefaultAmbiance())return this.viewer.removeAmbience(),this.viewer.setVisuEnv("None"),Promise.resolve(!0);var t=e.getGroundGridActivation(),i=e.getAmbianceJSON();if(!i)return null!=t&&this.viewer.setGrid(t),Promise.resolve(!1);if(!i.ambiance)return this.viewer.setVisuEnvOCA("Basic"),Promise.resolve(!0);if(i.ambiance.name&&-1!==o.indexOf(i.ambiance.name))return this.viewer.setVisuEnvOCA(i.ambiance.name),Promise.resolve(!0);var r=e.getAmbianceBuffers(),n=[];return Array.isArray(r)&&r.length>0&&r.forEach(function(e){n.push({buffer:e.getData()})}),new Promise(e=>{if(this.viewer.removeAmbience(),this.loader.load({zipped:!1,json:i,chunks:n,destinationNode:this.getSceneEnvRootForAmbiances(),doneCallback:e.bind(null,!0)}))return Promise.resolve(!0)}).then(()=>(null!=t&&this.viewer.setGrid(t),Promise.resolve(!0)))},tryUpdateLights:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areLightsManaged())return Promise.resolve(!1);var t=e.getLightsJSON();if(!t)return Promise.resolve(!1);this.viewer.useDefaultLights=!1,this.getSceneEnvRootForLights().removeChildren();return this.loader.applyLights({json:t,data:{},destinationNode:this.getSceneEnvRootForLights()}),Promise.resolve(!0)},_mergeCreatedvps(e,t,i){let r=[],n=0,a=0;for(let o=0;o<e.length;o++){let s=e[o];"Main3D"==s.getType()||"3D"==s.getType()?(r.push(t[n]),n++):(r.push(i[a]),a++)}return r},_manageViewpointInfo(e,t,i){let r=null;var n=this.viewManager._viewpointMap;n.has(e.getUID())?r=n.get(e.getUID()):((r=t).createDivCSS(),r.setCsiUID(e.getUID()),n.set(e.getUID(),r),"Main3D"==e.getType()||"Main2D"==e.getType()&&"3DViewer"!=i.getViewerType()?this.viewer.currentViewpoint&&null!==this.viewer.currentViewpoint.getCsiUID()?this.viewer._viewpointManager.addMainViewpoint(r,!1):(r._setNode(this.viewer.internalSceneGraph.root),this.viewer.selectViewpoint(null,r)):this.viewer._viewpointManager.addViewpoint(r,!1)),"Main3D"!=e.getType()&&"Main2D"!=e.getType()||this.viewer.getVisibleSpace()!=e.isShowSpace()&&this.viewer.swapVisibleSpace();let a=e.getViewport();if(!a||0==a[0]&&0==a[1]&&0==a[2]&&0==a[3]?this.viewer._viewpointManager.setViewpointViewport(r,!1,0,0,1,1):this.viewer._viewpointManager.setViewpointViewport(r,!0,a[0],a[1],a[2],a[3]),this.viewer._viewpointManager.setCSIInfos(r,{hasEditor:e.hasVpEditor(),locks:e.getTransformationLocks(),isMultiView:e.isMultiview(),useNativeBehaviorOnMouseMiddleTriggers:!0}),r.setNative2DZoomLimits(e.getMinZoom(),e.getMaxZoom()),e.AaMode,e.IsStretched,e.PLMViewMode,e.IsMainDialog,e.IsV3D,"Main3D"==e.getType()||"3D"==e.getType()){let t=e.getViewpoint3DInfo();r.getControl()&&r.getControl().setNativeGravity(t.areGravityMode(),t.getGravityDirection(),t.getGravityLocked()),t.ClippingMode,t.NearValue,t.FarValue}else{let t=e.getViewpoint2DInfo();r.setNative2DClip(t.getClip(),t.getBottomLeft(),t.getTopRight()),r.setNative2DAnchor(t.getAnchor()),t.areTranslationBoundsDefined()&&r.setNative2DTranslationBounds(t.getBoundsX(),t.getBoundsY()),r.setNative2DDepthMode(t.getDepth())}},tryUpdateCameras:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areCamerasManaged())return Promise.resolve(!1);var t=e.getCamerasJSON();if(!t)return Promise.resolve(!1);if(e instanceof a)this.loader.applyCamera({json:t,destinationNode:this.viewer.getRootNode()});else{var i=this.viewManager._viewpointMap;let r=t,n=this.loader.retrieveViewpoints({json:r},this.viewer,!0,!0),a=e.getCameras2DJSON(),o=this.loader.retrieveViewpoints({json:a},this.viewer,!0,!0),s=e.getChangeType(),l=e.getViewpointsInfo();n=this._mergeCreatedvps(l,n,o);for(let t=0;t<l.length;t++){let r=n[t],a=null;this._manageViewpointInfo(l[t],r,e),r!=(a=i.get(l[t].getUID()))?(a._nativeTranslationOffset=r._nativeTranslationOffset,a.moveTo({eyePosition:r.position,orientation:r.control.orientation,distanceToTarget:r.control.distanceToTarget}),a.control.update(),a.camera.fov=r.camera.fov,a.setProjectionType(r.getProjectionType(),null,!0),a._nativeZoomType==r._nativeZoomType&&a._nativeZoomRatio==r._nativeZoomRatio||a.setNativeZoom(r._nativeZoomType,r._nativeZoomRatio),a._nativeZoom=r._nativeZoom,r.dispose()):a.control.update()}"ViewpointListChanged"==s&&(i.size>l.length&&i.forEach((e,t,i)=>{let r=!1;for(let e=0;e<l.length;e++)if(l[e].getUID()==t){r=!0;break}r||(this.viewer._viewpointManager.removeViewpoint(e),e.dispose(),i.delete(t))}),this.viewer._viewpointManager.setOrderCSIViewpoints(l))}return Promise.resolve(!0)},tryUpdateViewModes:function(t){if(this.viewer){if(!t)return Promise.reject(new Error("Missing data"));if(!t.areViewModesManaged())return Promise.resolve(!1);var i=t.getViewModeMask(),r="Wireframe";i&s.VIEW_HRD?r="ShadingIllustration":i&s.VIEW_MESH&&(r="Shading",i&s.VIEW_MATERIAL&&(r+="Material"),i&s.VIEW_EDGE&&(r+="Edges",i&s.VIEW_WITHOUT_SMOOTH_EDGE?r+="NoSmoothEdges":i&s.VIEW_WITH_HALF_SMOOTH_EDGE&&(r+="HalfSmoothEdges"),i&s.VIEW_HIDDEN_EDGE&&(r+="HiddenEdges")));var n=i&s.VIEW_REP_OVERLOAD;this.viewer._getCSIOverrideManager().setRepViewMode(n),this.viewer.setVisuShadingMode(r),this.viewer._setVisuOutlineMode((i&s.VIEW_OUTLINE)>0),this.viewer.setLinesFilter(!(i&s.VIEW_WITHOUT_WIRES)),this.viewer.setVerticesFilter(!(i&s.VIEW_WITHOUT_VERTEX)),this.viewer.setPointsFilter(!(i&s.VIEW_WITHOUT_POINTS)),this.viewer.setAxisFilter(!(i&s.VIEW_WITHOUT_AXIS)),this.viewer.setSmallCurvatureEdgesFilter(!(i&s.VIEW_WITHOUT_SMALL_CURVATURE_STEP_EDGE));var a=t.getViewModeAppearanceStructure(s.VIEW_APPEARANCE);if(a){var o=l[a.appearanceName];void 0!==o&&(this.viewer.setVisuAppearanceMode(o),o!==e.DefaultAppearanceMode.GENERIC_PLASTIC&&o!==e.DefaultAppearanceMode.GENERIC_METAL||this.viewer.setCustomMaterialModeParameters(a.customParams))}else this.viewer.setVisuAppearanceMode(l.Basic);return Promise.resolve(!0)}},tryUpdateSupportParameters:function(t,r){var n=Promise.resolve(!0);if(!t)return Promise.reject(new Error("Missing data"));if(!t.areSupportParametersManaged())return Promise.resolve(!1);var a=t.getHighlightRenderingData();a&&function(t,r){for(var n=t.getMultiColorData(),a=n.highlightSlots,o=0;o<a.length;o++){d[0]=a[o];var s=(new e.Color).setRGB(c[3]/255,c[2]/255,c[1]/255);i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",eventType:"@CSI_CONTEXT_MULTI_HIGHLIGHT_UPDATE",parameters:{slot:o,color:s,viewer:r}}})}i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",eventType:"@CSI_CONTEXT_MULTI_HIGHLIGHT_ACTIVATION",parameters:{viewer:r,enabled:!!n.activation}}});var l=h(t,r,{Halo:{colorEnabled:e.DefaultHighlightData.halo.colorEnabled,intensity:e.DefaultHighlightData.halo.intensity,haloEnabled:e.DefaultHighlightData.halo.haloEnabled,haloIntensity:e.DefaultHighlightData.halo.haloIntensity,haloThickness:e.DefaultHighlightData.halo.haloThickness,outlineEnabled:e.DefaultHighlightData.halo.outlineEnabled,outlineAlpha:e.DefaultHighlightData.halo.outlineAlpha,outlineThickness:e.DefaultHighlightData.halo.outlineThickness},AdvancedPoliteness:{colorEnabled:e.DefaultHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultHighlightData.advancedpolite.outlineThickness}},{Halo:{color:e.DefaultHighlightData.halo.color,outlineColor:e.DefaultHighlightData.halo.outlineColor,haloColor:e.DefaultHighlightData.halo.haloColor},AdvancedPoliteness:{color:e.DefaultHighlightData.advancedpolite.color,outlineColor:e.DefaultHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultHighlightData.advancedpolite.haloColor}},"HIGHLIGHT");i.publish({event:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION",data:{eventChannel:"/VISU/SELECTION/CSI_CONTEXT_HIGHLIGHT_ACTIVATION",eventType:"@CSI_CONTEXT_HIGHLIGHT_ACTIVATION",parameters:{viewer:r,enabled:l}}}),r.internalSceneGraph.selectionHL.enable(l)}(a,this.viewer);var o=t.getPrehighlightRenderingData();o&&function(t,i){var r={Halo:{colorEnabled:e.DefaultPreHighlightData.halo.colorEnabled,intensity:e.DefaultPreHighlightData.halo.intensity,haloEnabled:e.DefaultPreHighlightData.halo.haloEnabled,haloIntensity:e.DefaultPreHighlightData.halo.haloIntensity,haloThickness:e.DefaultPreHighlightData.halo.haloThickness,outlineEnabled:e.DefaultPreHighlightData.halo.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.halo.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.halo.outlineThickness},AdvancedPoliteness:{colorEnabled:e.DefaultPreHighlightData.advancedpolite.colorEnabled,visibleAlpha:e.DefaultPreHighlightData.advancedpolite.visibleAlpha,occludedAlpha:e.DefaultPreHighlightData.advancedpolite.occludedAlpha,haloEnabled:e.DefaultPreHighlightData.advancedpolite.haloEnabled,haloIntensity:e.DefaultPreHighlightData.advancedpolite.haloIntensity,haloThickness:e.DefaultPreHighlightData.advancedpolite.haloThickness,outlineEnabled:e.DefaultPreHighlightData.advancedpolite.outlineEnabled,outlineAlpha:e.DefaultPreHighlightData.advancedpolite.outlineAlpha,outlineThickness:e.DefaultPreHighlightData.advancedpolite.outlineThickness}},n={Halo:{color:e.DefaultPreHighlightData.halo.color,outlineColor:e.DefaultPreHighlightData.halo.outlineColor,haloColor:e.DefaultPreHighlightData.halo.haloColor},AdvancedPoliteness:{color:e.DefaultPreHighlightData.advancedpolite.color,outlineColor:e.DefaultPreHighlightData.advancedpolite.outlineColor,haloColor:e.DefaultPreHighlightData.advancedpolite.haloColor}};i.internalSceneGraph.selectionPreHL.enable(h(t,i,r,n,"PREHIGHLIGHT"))}(o,this.viewer);var s=t.getColorMap();if(s){for(var l=[],u=0;u<s.length;u+=3){var g=(new e.Color).setRGB(s[u],s[u+1],s[u+2]);l.push(g)}i.publish({event:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",data:{eventChannel:"/VISU/GRAPHIC_ATTRIBUTE_SET/COLOR_MAP_UPDATE",eventType:"@COLOR_MAP_UPDATE",parameters:{colorMap:l,viewer:this.viewer}}}),n=this.viewer._refreshPLMViewMode(r),this.viewer.renderer.resetGSSOCache(),this.viewer.render()}const p=t.getBackground3DViewMode();if(null!==p){const t=(1&p)>0,i=(2&p)>0,r=(4&p)>0,n=(8&p)>0,a=(16&p)>0,o=(32&p)>0;this.viewer.setBackgroundViewMode(i?e.BackgroundViewMode.NO_DISPLAY:a?e.BackgroundViewMode.GHOST:t?e.BackgroundViewMode.LOWLIGHT:n?e.BackgroundViewMode.FOG:e.BackgroundViewMode.NORMAL),this.viewer.invertNodeBackgroundView(o),this.viewer.pickNodeBackgroundView(!r),this.viewer.render()}const f=t.get2DMode();if(f){let t,i;if(f._plane){const i=(new e.Vector3).copy(f._plane._firstDirection),r=(new e.Vector3).copy(f._plane._secondDirection),n=i.cross(r);t=new e.Plane(n,-n.dot(f._plane._origin))}switch(f._mode){case 1:i=e.PlaneViewMode.NO_DISPLAY;break;case 2:i=e.PlaneViewMode.LOWLIGHT;break;case 3:i=e.PlaneViewMode.NO_PICK;break;case 4:i=e.PlaneViewMode.LOWLIGHT_NO_PICK;break;default:i=e.PlaneViewMode.NORMAL}this.viewer.setPlaneViewMode({mode:i,plane:t})}else this.viewer.setPlaneViewMode({mode:e.PlaneViewMode.NORMAL});var m=t.getClippingPlane();m&&this.updateClippingPlane(m);let v=t.getMainViewpointUID();if(null==v);else{let e=this.viewManager._viewpointMap.get(v);e?this.viewer._viewpointManager.setManipulatedViewpoint(e):console.error("no viewpoint with provided UID exists")}let y=t.getMultiViewSyncMode();return null!=y&&this.viewer._viewpointManager.setMultiViewSyncMode(y),this.viewer._forcedDynamicModeFromServer=!!t.getDynamicMode(),n},tryUpdatePLMViewMode:function(e,t){var i,r=e.getViewpointsInfo();if(r)for(i=0;i<r.length;i++)this.viewer._setViewpointPLMViewMode(r[i]._uid,r[i]._plmViewMode);var n=e.getPLMViewMode();return n?this.viewer._updatePLMViewMode(n,t):Promise.resolve(!0)},updateClippingPlane:function(t){var i,r,n=this.viewer.getRootNode();if(n){var a=n.clippingContext,o=a&&a.planes.concat([]);if(o)for(i=0;i<o.length;i++)n.enableClippingPlane(o[i],!1)}var s,l,d,c=t._normal,h=t._point,g=0;for(i=0;i<t._nbPlanes;i++)(s=new e.Vector3(c[g],c[g+1],c[g+2])).normalize(),l=new e.Vector3(h[g],h[g+1],h[g+2]),(r=new e.Plane).setFromNormalAndCoplanarPoint(s,l),n.enableClippingPlane(r,!0),d=t._flags[i],n.clippingContext.setPlaneParams(r,{capping:!!(d&u)}),g+=3},tryUpdateContextData:function(t){if(!t)return Promise.reject(new Error("Missing data"));var r=t.container&&t.container.getVisContextData&&t.container.getVisContextData();if(!r)return Promise.resolve(!1);if(r.VisuStreaming){this.viewer.setupRemoteRender(),this.vpSubscriptionToken&&(i.unsubscribe(this.vpSubscriptionToken),this.vpSubscriptionToken=null),this.streamingInterface&&(this.streamingInterface.destroy(),this.streamingInterface=null);let t=r.VisuStreaming._commonData,n=r.VisuStreaming._objectsData;if(0==Object.keys(t).length||0==Object.keys(n).length)return Promise.resolve(!0);{let n=this;return new Promise(function(a){require(["DS/VisuStreamingA2X/VisuStreamingInterface","DS/VisuStreamingTypes/VisCSICamera","DS/VisuStreamingTypes/VisCSIVector3"],function(o,s,l){n.viewer.setupRemoteRender(!0);n.streamingInterface=new o(r.VisuStreaming,function(e,i,r){if("JPEG"==t.streamProtocol){var a=e.readBuffer("colorImgBuffer"),o=new Uint8Array(a),s=new Blob([o],{type:"image/jpeg"});n.viewer._onRemoteImageReceived({data:s,format:"blob"},r)}else if("A2X"==t.streamProtocol){let e=!1;n.viewer.setRemoteVideo(i,r,e)}else console.warn("unsupported streaming protocol : "+t.streamProtocol)},function(e){console.log(e)});let d=n.viewManager._viewpointMap,c=function(e){return new l({x:e.x,y:e.y,z:e.z})};n.vpSubscriptionToken=i.subscribe({event:"/VISU/"},function(t){if("@onViewpointChange"===t.eventType){let i=t.viewpoint,r=n.streamingInterface.connections.get(i.getCsiUID());if(r){let n=(new e.Vector3).subVectors(t.cameraTarget,t.cameraEye),a=n.length(),o=new s({orthogonal:1==i.projectionType,position:c(t.cameraEye),direction:c(n.normalize()),upDirection:c(t.cameraUp),focusDistance:a,angle:i.camera.fov/2,aperture:i.camera.aperture});r.connection.updateCamera(o)}}});for(let[e,t]of n.streamingInterface.connections.entries()){d.get(e)}a.bind(null,!0)})})}}return Promise.resolve(!1)},tryUpdateLineDefinitions:function(e){if(!e)return Promise.reject(new Error("Missing data"));if(!e.areLineTypeDefinitionsManaged())return Promise.resolve(!1);var t=new n,i=e.getLineTypeDefinitions();i&&(i=JSON.parse(i),t.setLineTypes(i),this.viewer.renderer.resetGSSOCache(),this.viewer.render())},tryUpdateSceneEnv:function(e,t){var i=this.tryUpdateAmbiance(e),r=this.tryUpdateLights(e),n=this.tryUpdateCameras(e),a=this.tryUpdateViewModes(e),o=this.tryUpdateSupportParameters(e),s=this.tryUpdatePLMViewMode(e,t),l=this.tryUpdateContextData(e),d=this.tryUpdateLineDefinitions(e);return Promise.all([i,r,n,a,o,s,l,d]).then(function(e){return Promise.resolve({ambianceUpdated:e[0],lightsUpdated:e[1],cameraUpdated:e[2],viewModesUpdated:e[3],supportParametersUpdated:e[4],lineDefinitionsUpdated:e[7]})})}},g}),define("DS/WebVisuParameters/GeometryParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientDrawGroupParameter","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/Visualization/GraphicAttributeSet","DS/GPUFormats/VertexAttribute","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/Visualization/Node3D"],function(e,t,i,r,n,a,o,s,l){"use strict";var d=i.prototype.geomTypeValues,c=[0];const u={[d.unknown]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[d.unknown_0D]:{glType:0,geomType:r.GeomTypeEnum.UNKNOWN},[d.unknown_1D]:{glType:1,geomType:r.GeomTypeEnum.UNKNOWN},[d.unknown_2D]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[d.unknown_3D]:{glType:4,geomType:r.GeomTypeEnum.UNKNOWN},[d.edge]:{glType:1,geomType:r.GeomTypeEnum.EDGE},[d.wire_Edge]:{glType:1,geomType:r.GeomTypeEnum.WIRE_EDGE},[d.boundary_Edge]:{glType:1,geomType:r.GeomTypeEnum.BOUNDARY_EDGE},[d.sharp_Edge]:{glType:1,geomType:r.GeomTypeEnum.SHARP_EDGE},[d.smooth_Edge]:{glType:1,geomType:r.GeomTypeEnum.SMOOTH_EDGE},[d.high_curvature_edge]:{glType:1,geomType:r.GeomTypeEnum.SMOOTH_EDGE|r.GeomTypeEnum._HIGH_CURVATURE_EDGE},[d.hidden_Seam_Edge]:{glType:1,geomType:r.GeomTypeEnum.HIDDEN_SEAM_EDGE},[d.boundary_Point]:{glType:0,geomType:r.GeomTypeEnum.BOUNDARY_POINT},[d.sharp_Point]:{glType:0,geomType:r.GeomTypeEnum.SHARP_POINT},[d.smooth_Point]:{glType:0,geomType:r.GeomTypeEnum.SMOOTH_POINT},[d.hidden_Seam_Point]:{glType:0,geomType:r.GeomTypeEnum.HIDDEN_SEAM_POINT},[d.surfacic_Point]:{glType:0,geomType:r.GeomTypeEnum.SURFACIC_POINT},[d.free_Point]:{glType:0,geomType:r.GeomTypeEnum.FREE_POINT},[d.infinite_Face]:{glType:4,geomType:r.GeomTypeEnum.INFINITE_FACE},[d.face]:{glType:4,geomType:r.GeomTypeEnum.FACE}};var h=a.DefaultGASs.defaultGAS,g=a.DefaultGASs.transition;function p(e,t,i,r){const n=new Uint32Array(t,e.getOffset(),e.getByteLength()/e.getBytePerElement()),a=4+(i?1:0)+(r?1:0),o=[];for(let e=0;e<n.length;e+=a)o.push({offset:n[e],count:n[e+1],cgmId:n[e+2],csiId:n[e+3],isIndexed:!i||n[e+4],deco:r?n[e+(i?5:4)]:void 0});return o}class f{constructor(e,t){this.parameter=e,this.version=t.version,this.hasGeomDecorations=t.hasGeomDecorations}getGeometry(e,t,i){var a=e.getDefaultMaterials(),o=(a.volume,a.surface,a.line,a.point,new r.BufferGeometryDS),s=!1;let l=!1;var f,m=[],v=0;for(var y in this.parameter.bufferPartitionValues){var S=this.parameter.bufferPartitionValues[y],_=this.parameter.getBufferPartition(S);if(_)if(S===this.parameter.bufferPartitionValues.vertexIndexArray){l=4===_.getBytePerElement();const e=_.getByteLength()/_.getBytePerElement();f=l?new Uint32Array(this.parameter.getBuffer(),_.getOffset(),e):new Uint16Array(this.parameter.getBuffer(),_.getOffset(),e),1===this.version&&(o[y]=f)}else if(S===this.parameter.bufferPartitionValues.primitiveDecorationArray)this.hasGeomDecorations&&(o.decorations=new Uint8Array(this.parameter.getBuffer(),_.getOffset(),_.getByteLength()));else{var w=new Float32Array(this.parameter.getBuffer(),_.getOffset(),_.getByteLength()/_.getBytePerElement());if(S===this.parameter.bufferPartitionValues.vertexUv2Array){for(var I=new Float32Array(3*w.length/2),T=0;T<w.length/2;T++)I[3*T]=w[2*T],I[3*T+1]=w[2*T+1],I[3*T+2]=0;w=I}o[y]=w}}var D=new n.SGRep({solid:t}),C=this.parameter.getDrawGroups(),P=[];for(T=0;T<C.length;T++){var E=C[T],M=E.getPrimitives();M=new Uint32Array(this.parameter.getBuffer(),M.getOffset(),M.getByteLength()/M.getBytePerElement());var b=u[E.getGeomType()],A=b.glType,V=b.geomType;E.getGeomType()===d.unknown_2D&&(s=!0);var O=[],N=[],G=new n.DrawingGroup(i?g:h,null,A,2===this.version?v:E.getStart(),E.getCount(),O,void 0,V,0);if(G.geometry=o,o.drawingGroups.push(G),2===this.version){var x=E.isEdge(),R=4+(x?1:0)+(k=this.hasGeomDecorations?1:0);const e=p(E.getPrimitives(),this.parameter.getBuffer(),x,this.hasGeomDecorations);for(let t=0;t<e.length;t++){const i=e[t],r=v;if(i.isIndexed)for(var H=i.offset;H<i.offset+i.count;H++)m[v]=f[H],m[v]>65535&&(l=!0),v++;else for(H=0;H<i.count-1;H++)m[v]=i.offset+H,m[v+1]=i.offset+H+1,(m[v]>65535||m[v+1]>65535)&&(l=!0),v+=2;const a=i.count>0?2*(i.count-1):0,o=new n.SGPrimitive({start:r,count:i.isIndexed?i.count:a,cgmId:i.cgmId,rep:D,group:G});void 0!==i.deco&&(4294967294===i.deco?o.decoration=c:4294967295!==i.deco&&(o.decoration=i.deco)),O.push(o),N.push(i.csiId),D._primitives.push(o)}}else{R=4+(k=this.hasGeomDecorations?1:0);for(var k,F=0;F<M.length;F+=R){var L=new n.SGPrimitive({start:M[F],count:M[F+1],cgmId:M[F+2],rep:D,group:G});if(k){var U=M[F+3+k];4294967294===U?L.decoration=c:4294967295!==U&&(L.decoration=U)}O.push(L),N.push(M[F+3]),D._primitives.push(L)}}P.push(N)}if(2===this.version&&(o.vertexIndexArray=l?new Uint32Array(m):new Uint16Array(m)),!o.boundingBox){var B=[0,0,0],W=[0,0,0],z=o.vertexPositionArray;if(z){var j=z.length;if(j>=3){B=[z[0],z[1],z[2]],W=[z[0],z[1],z[2]];for(var X=0;X<j;X+=3)z[X]<B[0]&&(B[0]=z[X]),z[X+1]<B[1]&&(B[1]=z[X+1]),z[X+2]<B[2]&&(B[2]=z[X+2]),z[X]>W[0]&&(W[0]=z[X]),z[X+1]>W[1]&&(W[1]=z[X+1]),z[X+2]>W[2]&&(W[2]=z[X+2])}}B=new r.Vector3(B[0],B[1],B[2]),W=new r.Vector3(W[0],W[1],W[2]),o.boundingBox=new r.Box3(B,W),o.boundingSphere=new r.Sphere(W.clone().add(B).multiplyScalar(.5),W.clone().sub(B).multiplyScalar(.5).length())}return{geometry:o,primitiveIDs:P,is2Din3D:s}}updateGeometry(e){if(e){var t=e.getPrimitives();if(Array.isArray(t)&&0!==t.length){var i,r={},n=0;t.forEach(function(e){(i=e.getIdentificationObject())&&void 0!==(n=i.getLocalId())&&(r[n]=e)});for(var a=e._occurrences[0].renderable.geometry,o=0;o<a.length;o++)a[o].needsUpdate=!0;var s=a[0],l=s.vertexIndexArray,d=s.vertexPositionArray;if(l&&d){var c,u,h,g={};for(var p in this.parameter.bufferPartitionValues)if(u=this.parameter.bufferPartitionValues[p],(c=this.parameter.getBufferPartition(u))&&u!==this.parameter.bufferPartitionValues.vertexIndexArray){h=new Float32Array(this.parameter.getBuffer(),c.getOffset(),c.getByteLength()/c.getBytePerElement()),g[p]=h;for(o=0;o<a.length;o++){var f=a[o];(d=f.vertexPositionArray)&&!f[p]&&(f[p]=new Float32Array(d.length))}}var m,v=this.parameter.getDrawGroups();if(Array.isArray(v)&&1===v.length&&(m=v[0]),m){var y=m.getPrimitives();if(y){var S,_,w,I,T,D,C,P,E,M;y=new Uint32Array(this.parameter.getBuffer(),y.getOffset(),y.getByteLength()/y.getBytePerElement());for(var b=0;b<y.length;b+=3)if(n=y[b],_=y[b+1],w=y[b+2],(S=r[n])&&S.sgNode){l=(M=S.sgNode.getGroup().geometry).vertexIndexArray,d=M.vertexPositionArray;I=S.sgNode.getStart(),T=S.sgNode.getCount(),P=C=l[I];for(o=1;o<T;++o)(D=l[o+I])<C?C=D:D>P&&(P=D);if(E=3*(P-C+1),w&&w!==d.length||(w=E),E&&E===w)for(var p in g)for(o=0;o<w;++o)M[p][o+3*C]=g[p][o+_]}}}}}}}}const m={vis_vertex_components:{0:"position",1:"normal",2:"color",3:"uv",4:"uv2",5:"texcoord3",6:"texcoord4",7:"texcoord5",8:"texcoord6",9:"texcoord7",10:"texcoord8",11:"user0"},vis_data_type:{0:"uint8",1:"uint16",2:"uint32",3:"sint8",4:"sint16",5:"sint32",6:"float32",7:"float64",8:"uint8x2",9:"uint16x2",10:"uint32x2",11:"sint8x2",12:"sint16x2",13:"sint32x2",14:"float32x2",15:"float64x2",16:"uint8x3",17:"uint16x3",18:"uint32x3",19:"sint8x3",20:"sint16x3",21:"sint32x3",22:"float32x3",23:"float64x3",24:"uint8x4",25:"uint16x4",26:"uint32x4",27:"sint8x4",28:"sint16x4",29:"sint32x4",30:"float32x4",31:"float64x4",32:"<unsupported FLOAT_9>",33:"<unsupported DOUBLE_9>",34:"<unsupported MATRIX_3x3>",35:"<unsupported FLOAT_16>",36:"<unsupported DOUBLE_16>",37:"<unsupported MATRIX_4x4>",38:"<unsupported RAWBUFFER_PTR>"},vis_connectivity_type:{1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:2,256:3,512:5,1024:6},type_mapping_simple:{1:1,2:2,4:2,8:2,16:16,32:16,64:16,128:2,256:2,512:16,1024:16},rawbuffers_by_id(e){if(!e)return{};const t={};for(let i=0;i<e.length;i++){const r=e[i];t[r.getId()]={data:r.getData(),type:null}}return t},check_same_vertex_number(e){const t=e.map(e=>e.getNbVertices());1!==new Set(t).size&&console.error(`SGV6: components have different number of vertices: [${t.join(", ")}]`)},compute_vertex_layout(e){const t={};for(let i=0;i<e.length;i++){const r=e[i],n=m.vis_data_type[r.getType()];if(void 0===n)throw new Error("Malformed vertex components description: unknown component type");let a=m.vis_vertex_components[r.getComponentType()];if(void 0===a)throw new Error("Malformed vertex components description: unknown component name");t[a]={name:a,type:n,offset:r.getOffset(),stride:r.getStride()||o[n].size,bufferId:r.getRawBufferId(),num_vertices:r.getNbVertices()}}return t},get_num_vertices(e){for(let t in e)return e[t].num_vertices;return 0},compute_vertex_buffer_views(e,t){let i=[];for(let t in e){const r=e[t],n=r.offset,a=r.offset+r.stride*(r.num_vertices-1)+o[r.type].size;i.push([n,a,r.bufferId])}i.sort((e,t)=>e[2]===t[2]?e[0]-t[0]:e[2]-t[2]);let r=0;for(let e=1;e<i.length;e++)i[e][0]<i[r][1]&&i[e][2]===i[r][2]?i[r][1]=Math.max(i[r][1],i[e][1]):++r!==e&&(i[r]=i[e]);i.length=r+1;const n=[];for(let e=0;e<i.length;e++){const[r,a,o]=i[e];n[e]=new Uint8Array(t[o].data,r,a-r)}for(let t in e){const r=e[t],n=r.offset,a=r.offset+r.stride*(r.num_vertices-1)+o[r.type].size;for(let e=0;e<i.length;e++)if(i[e][2]===r.bufferId&&!(i[e][0]>n||a>i[e][1])){r.bufferId=e;break}r.offset=n-i[r.bufferId][0]}return{layout:e,vertices:n}},compute_vertex_buffers(e){m.check_same_vertex_number(e.getComponents());const t=m.rawbuffers_by_id(e.getRawBuffer()),i=m.compute_vertex_layout(e.getComponents());return m.compute_vertex_buffer_views(i,t)},split_indice_descriptions(e){let t=[];for(let i=0;i<e.length;i++){const r=e[i],n=r.getRawBuffer(),a=m.vis_data_type[r.getType()];let s=null;for(let e=0;e<t.length;e++)if(t[e].rawbuffer===n&&t[e].itype===a){s=t[e];break}s||(s={rawbuffer:n,itype:a,descriptions:[],stride:o[a].size,offset:0},t.push(s)),s.descriptions.push(r)}return t},compute_indices_view(e,t){var i=e.descriptions?e.descriptions.length:0;if(!e.rawbuffer){if(1===i){let i=e.descriptions[0],r=i.getConnectivityType();if(1===r||2===r||16===r)return null;let n=0,a=0;switch(r){case 4:a=2*(t-1);break;case 8:a=2*t;break;case 32:case 64:a=3*(t-2)}let o=a>65536?new Uint32Array(a):new Uint16Array(a);switch(r){case 4:for(let e=1;e<t;e++)o[n++]=e-1,o[n++]=e;break;case 8:for(let e=1;e<t;e++)o[n++]=e-1,o[n++]=e;o[n++]=t-1,o[n++]=0;break;case 32:for(let e=0;e<t-2;e++)e%2?(o[n++]=e,o[n++]=e+1,o[n++]=e+2):(o[n++]=e,o[n++]=e+2,o[n++]=e+1);break;case 64:for(let e=0;e<t-2;e++)o[n++]=0,o[n++]=e+1,o[n++]=e+2}return e.rawbuffer=o,i._rawbuffer=o,i._connectivityType=m.type_mapping_simple[r],i._nbIndices=a,o}return null}const r=2===e.stride?Uint16Array:4===e.stride?Uint32Array:null;if(!r)return console.warn(`SGV6: unsupported ${e.itype} indices`),null;let n=!0;for(let t=0;t<e.descriptions.length;t++){const i=e.descriptions[t].getConnectivityType();if(1!==i&&2!==i&&16!==i){n=!1;break}}if(!n){let t=[];let i=new r(e.rawbuffer.getData()),n=0;for(let r=0;r<e.descriptions.length;r++){const a=e.descriptions[r];let o=a.getOffset()/e.stride,s=a.getNbIndices(),l=0;const d=a.getConnectivityType();switch(a._offset=n*e.stride,d){case 1:case 2:case 16:for(let e=0;e<s;e++)t[n++]=i[o++];break;case 4:for(let e=1;e<s;e++)t[n++]=i[o+e-1],t[n++]=i[o+e],l+=2;break;case 8:for(let e=1;e<s;e++)t[n++]=i[o+e-1],t[n++]=i[o+e],l+=2;t[n++]=i[o+s-1],t[n++]=i[o],l+=2;break;case 32:for(let e=0;e<s-2;e++)e%2?(t[n++]=i[o+e],t[n++]=i[o+e+1],t[n++]=i[o+e+2]):(t[n++]=i[o+e],t[n++]=i[o+e+2],t[n++]=i[o+e+1]),l+=3;break;case 64:for(let e=0;e<s-2;e++)t[n++]=i[o],t[n++]=i[o+e+1],t[n++]=i[o+e+2],l+=3;break;case 128:if(s<2||4294967295===i[o])break;for(let e=1;e<s;e++){let r=i[o+e];4294967295!==r?(t[n++]=i[o+e-1],t[n++]=r,l+=2):e++}break;case 256:if(s<2||4294967295===i[o])break;for(let e=1;e<s;e++){let r=i[o+e];4294967295!==r?(t[n++]=i[o+e-1],t[n++]=r,l+=2):e++}t[n++]=i[o+s-1],t[n++]=i[o],l+=2;break;case 512:if(s<3||4294967295===i[o]||4294967295===i[o+1]||4294967295===i[o+2])break;let r=0;for(let e=0;e<s-2;e++){let a=i[o+e+2];4294967295!==a?(r%2?(t[n++]=i[o+e],t[n++]=i[o+e+1],t[n++]=a):(t[n++]=i[o+e],t[n++]=a,t[n++]=i[o+e+1]),r++,l+=3):(e+=2,r=0)}break;case 1024:if(s<3||4294967295===i[o]||4294967295===i[o+1]||4294967295===i[o+2])break;let c=i[o];for(let e=0;e<s-2;e++){let r=i[o+e+2];4294967295!==r?(t[n++]=c,t[n++]=i[o+e+1],t[n++]=r,l+=3):(c=i[o+e+3],e+=2)}}a._connectivityType=m.type_mapping_simple[d],a._nbIndices=l}let a=new r(n);for(let e=0;e<n;e++)a[e]=t[e];return a}let a=1/0,o=-1/0;for(let t=0;t<e.descriptions.length;t++){const i=e.descriptions[t],r=i.getOffset(),n=i.getNbIndices()*e.stride;a=Math.min(a,r),o=Math.max(o,r+n)}return e.offset=a,new r(e.rawbuffer.getData(),a,(o-a)/e.stride)},create_drawing_groups(e,t){const i=[];for(let a=0;a<e.descriptions.length;a++){const o=!!e.rawbuffer,s=e.descriptions[a];let l=s.getNbIndices();o||(l=l||t);let d=s.getOffset();o&&(d=(s.getOffset()-e.offset)/e.stride);const c=new n.SGPrimitive({start:d,count:l}),u=m.vis_connectivity_type[s.getConnectivityType()],h=r.GeomTypeEnum.UNKNOWN,g=i[a]=new n.DrawingGroup(null,null,u,d,l,[c],void 0,h);g.nonIndexed=!o,c.group=g}return i},create_geometry({layout:e,vertices:t,indices:i}){const n=new r.BufferGeometryDS;let a=m.get_num_vertices(e);return n.vertexIndexArray=m.compute_indices_view(i,a),n.buffers=t,n.layout.set(e),n._updateAccessors(),n.drawingGroups=m.create_drawing_groups(i,a),n.drawingGroups.forEach(e=>e.geometry=n),n},create_primitive_geometries(e,t,i){let{layout:r,vertices:n}=m.compute_vertex_buffers(e,i),a=m.split_indice_descriptions(t);if(i)for(var o in i)n.push(i[o]),r[o]={name:o,type:"float32x4",offset:r.position.offset,stride:16,bufferId:n.length-1,num_vertices:r.position.num_vertices};let s=[];for(let e=0;e<a.length;e++){const t=m.create_geometry({layout:r,vertices:n,indices:a[e]});s.push(t)}return s},compute_gas(e,t){if(!e)return h;const i=new l;new s(e,null).applyGP(t,i);const r=i._gas;return r._inheritanceInternal=0,r},resolve_gas(e,t,i){const r=Object.assign({},e,t),n=(m.compute_gas(e.GAS,i),m.compute_gas(t.GAS,i));return void 0!==r.POINT_TYPE&&(n._symbolType=r.POINT_TYPE),void 0!==r.POINT_SIZE&&(n._lineWidth=r.POINT_SIZE),n},resolve_instancing(e,t){const i=void 0!==t.NUM_INSTANCES?t.NUM_INSTANCES:e.NUM_INSTANCES,r=void 0!==t.INSTANCES_RAWBUFFERPTR?t.INSTANCES_RAWBUFFERPTR:e.INSTANCES_RAWBUFFERPTR;return void 0!==i&&void 0!==r?{count:i,buffer:r}:null},createSkinningPosture(e,t){let i=new r.SkinningTransformations;return i.setSkinningMatrices(e,t),i}},v={updateBuffers(e,t){const i=e._buffersMap;let r=null;for(var n=0;n<t.length;n++){let e=i[t[n].getId()];if(!e)continue;let o=e.data;if("skinTransfo"===e.type&&(r=e),o){let e=new Uint8Array(o),i=new Uint8Array(t[n].getData());for(var a=0;a<i.length;a++)e[a]=i[a]}}return r},addSkeleton(e,t,i,r){const n=m.rawbuffers_by_id(r);if(e._buffersMap)for(var a in n)e._buffersMap[a]=n[a];let o=t?new Float32Array(n[t].data):null,s=i?new Float32Array(n[i].data):null;for(var l=0;l<e.length;l++){const r=e[l].layout;let n=e[l].buffers,a=r.clone(),d=r.getNames();if(t)if(d.includes("skinIndex")){n[r.get("skinIndex").bufferId]=o}else n.push(o),a.setAttribute({name:"skinIndex",type:"float32x4",offset:r.get("position").offset,stride:16,bufferId:n.length-1,num_vertices:r.get("position").num_vertices});if(i)if(d.includes("skinWeight")){n[r.get("skinWeight").bufferId]=s}else n.push(s),a.setAttribute({name:"skinWeight",type:"float32x4",offset:r.get("position").offset,stride:16,bufferId:n.length-1,num_vertices:r.get("position").num_vertices});e[l].layout=a,e[l].needsUpdate=!0}},removeSkeleton(e){for(var t=0;t<e.length;t++){const n=e[t].layout;let a=e[t].buffers,o=n.clone(),s=n.getNames();if(s.includes("skinIndex")){a[n.get("skinIndex").bufferId]=null,o.remove("skinIndex")}if(s.includes("skinWeight")){a[n.get("skinWeight").bufferId]=null,o.remove("skinWeight")}for(var i=[],r=0;r<a.length;r++)a[r]&&i.push(a[r]);e[t].buffers=i,e[t].layout=o,e[t].needsUpdate=!0}},createSkinningPosture(e,t,i,r){const n=m.rawbuffers_by_id(r);if(e._buffersMap)for(var a in n)e._buffersMap[a]=n[a];return n[t].type="skinTransfo",m.createSkinningPosture(new Float32Array(n[t].data),i)},createGeometryBuffersV6(e,t){const i=t.getVisPrimitiveGroupRep();if(!i)return null;const r=m.rawbuffers_by_id(i._rawbuffers),a=i.getVisPrimitives(),o=i.getVisAttribute().asProperties(),s=a.map(e=>e.getAttribute().asProperties());let l=null,d=null;const c=i._skeletonSkinning;if(c){l={};const e=c.getBoneIdsBufferId(),t=c.getBoneWeightsBufferId(),i=c.getBoneMatricesBufferId();if(e){let t=new Int32Array(r[e].data);l.skinIndex=new Float32Array(t.length);for(let e=0;e<t.length;e++)l.skinIndex[e]=t[e]}t&&(l.skinWeight=new Uint8Array(r[t].data)),i&&(d=m.createSkinningPosture(new Float32Array(r[i].data),c.getNbBones()))}const u=a.map((t,i)=>m.resolve_gas(o,s[i],e)),h=a.map(e=>m.create_primitive_geometries(e.getVerticesDescription(),e.getIndicesDescription(),l)),g=new n.SGRep,p=[],f=new Map,v=[];for(let e=0;e<a.length;e++){const t=h[e],i=u[e],l=a[e].getId(),d=m.resolve_instancing(o,s),c=new n.SelectionGroup;let y=0;for(let e of t){for(let t of e.drawingGroups){if(d){let e="f",i=r[d.buffer].data;if(i&&(i=i.getData()),i){const t=i.byteLength/d.count;t%64==0?e="m4":t%16==0?e="v4":t%12==0?e="v3":t%8==0&&(e="v2")}t.setInstancingParameters(d.count,{isFlattened:!1,type:e,data:i,attribName:"sgv6"},"mesh")}t.gas=i,t._primitives[0].rep=g,y++,c.addPrimitive(t._primitives[0]),f.set(l,t._primitives[0])}p.push(e)}y>1&&v.push(c)}return p._buffersMap=r,{geometry:p,ids:f,selection_groups:v,skinningPosture:d}}};return Object.assign(f,v),f}),define("DS/WebVisuParameters/WebVisuUpdateTransactionHighlight",["DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CoreEvents/Events","DS/EKEventsWeb/EKEvents","DS/Visualization/ThreeJS_DS","DS/CSIViewModelWebInterfaces/CSIVMClientCATVizBasePathElementRep","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteDrawGroupParameter","DS/WebVisuParameters/PathElementRepNodeUtils","DS/Visualization/PathElement"],function(e,t,i,r,n,a,o,s,l){"use strict";var d=o.prototype.infiniteGeomTypeValues,c=new Map,u=null,h=function(){this._idObject=null,this._pathes=[],this._order=0};h.prototype.setIdentificationObject=function(e){this._idObject=e},h.prototype.getIdentificationObject=function(){return this._idObject},h.prototype._addPath=function(e,t,i){this._pathes.push({key:e,slot:t,linkedRoot:i})};var g=function(t,i,r,n,a){e.call(this,t,i,r),this.multiSelection=!!n,this._transientHighlightRoot=t._sceneEnvRootForTransientHighlight,0===this._transientHighlightRoot.parents.length&&this.viewManager.viewer.addNode(this._transientHighlightRoot),this.transactionUtils=a};return(g.prototype=Object.create(e.prototype))._getCSISelection=function(e){this.multiSelection||(e=0);var t=this.viewManager.viewer;(u=c.get(t))||(u=new Map,c.set(t,u)),this._csiXSO=this.transactionUtils.getXSO(e,t,this.treeKeyID)},g.prototype._updateOrder=function(){var e=this;u.forEach(function(t,i,r){if(t.length){t.sort((e,t)=>e.node._order-t.node.order);for(var n=0;n<t.length;n++){var a=t[n].slot;e._getCSISelection(a),(o=e._csiXSO.getPathFromKey(i))&&e._csiXSO._remove(o)}var o,s=t[t.length-1].slot;e._getCSISelection(s),(o=e._csiXSO.getPathFromKey(i))&&e._csiXSO._add(o)}else r.delete(i)})},g.prototype._insertPathElement=function(e,t,i,r){this._csiXSO.add(t),e._addPath(t.hash(),i,r),this.multiSelection&&(u.has(t.hash())?u.get(t.hash()).push({slot:i,node:e}):u.set(t.hash(),[{slot:i,node:e}]),this._updateOrder())},g.prototype.doOperation=function(e){if(this.transactionUtils){r._NREGASOnNodeInit=!0;var t=i.Trace.traceStart("techno_webvisu","message_to_highlight"),a=e.getType();switch(a){case e.OperationType.RemoveAll:this.multiSelection?this.transactionUtils.clearMultiHighlightColorSlot(this.treeKeyID):this._csiXSO.removeAll(),u.clear();break;case e.OperationType.CreateRoot:case e.OperationType.AddNode:case e.OperationType.AddBody:var o=new h;e.setCreatedObject(o);break;case e.OperationType.AddCells:if(!(o=this.getOperatedObject(e)))return;var c=e.getGeometricalData(),g=!!c&&c.hasInfiniteGeometry(),p=c?c.getGeometries():null;if(!g||!p){i.Log.error("Unexpected or missing data in Highlight transaction AddCells");break}for(var f=0;f<p.length;f++){var m=p[f],v=m.getInfiniteDrawGroups();if(v&&v.length){if(v[0].getInfiniteGeomType()===d.path_element){const e=m.getAdditionalDataAsUint8Array(),t=new n(e);if(!t.isValid())continue;const i=this.multiSelection?t.multiColorHighlightSlot+1:0;this._getCSISelection(i);const r=t.createIteratorOverPathElements();if(t.haveTransient){const e=this._transientHighlightRoot,n=t.createIteratorOverPathElementsTransient();let a=!1;for(const t of r){let r=t.externalPath;a=!0;for(const t of n){r=r.concat(t.externalPath);const n=s.buildPathElementRepNode3DFromArray(r,e,null),a=new l;a.setFromArray(n._toExternalPathElement(),t.internalPath),this._insertPathElement(o,a,i,n);break}}if(!a)for(const t of n){const r=t.externalPath,n=s.buildPathElementRepNode3DFromArray(r,e,null),a=new l;a.setFromArray(n._toExternalPathElement(),t.internalPath),this._insertPathElement(o,a,i,n)}}else for(const e of r)this._insertPathElement(o,e,i,null)}}else i.Log.error("Missing getInfiniteDrawGroups in Highlight transaction AddCells")}break;case e.OperationType.RemoveExistingNode:if(!(o=this.getOperandObject(e)))return;for(f=0;f<o._pathes.length;f++){var y=o._pathes[f];this._getCSISelection(y.slot);var S=this._csiXSO.getPathFromKey(y.key);if(S&&(this._csiXSO.remove(S),y.linkedRoot&&this._transientHighlightRoot.removeChild(y.linkedRoot),u.has(S.hash())&&this.multiSelection)){var _=u.get(S.hash()),w=_.findLastIndex(e=>e.node===o&&e.slot===y.slot);-1!==w&&(_.splice(w,1),this._updateOrder())}}o._pathes=[];break;case e.OperationType.ApplyGP:break;default:i.Log.error("Unexpected operation token in Highlight transaction "+a)}r._NREGASOnNodeInit=!1,this.viewManager.viewer.render(),t.End()}},g.prototype.commit=function(){},g.prototype.abort=function(){},g.prototype.executeEnd=function(){},g.prototype.executeInverse=function(){},g}),define("DS/WebVisuParameters/InfiniteGeometryParameterHelper",["UWA/Class","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteGeometryParameter","DS/CSIViewModelWebInterfaces/CSIVMClientInfiniteDrawGroupParameter","DS/CSIViewModelWebInterfaces/CSIVMClientGraphicPropertyParameter","DS/CSIViewModelWebInterfaces/CSIVMClientImagePixel","DS/CSIViewModelWebInterfaces/CSIVMClientLight","DS/SceneGraphNodes/FixedSizeArrowNode","DS/SceneGraphNodes/FixedSizePlaneNode","DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/GeometryHelper","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/TextNode","DS/SceneGraphNodes/RefPlaneNode","DS/Visualization/GraphicAttributeSet","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/Visualization/FontUtils","DS/Visualization/Filters/GASInheritFilter","DS/SceneGraphNodes/AnnotationText","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/CSIViewModelWebInterfaces/CSIVMClientSelectionObject","DS/CSIViewModelWebInterfaces/CSIVMClientCATVizBasePathElementRep","DS/Visualization/MaterialManager","DS/WebVisuParameters/PathElementRepNodeUtils","DS/WebVisuParameters/ImagePixelHelper"],function(e,t,i,r,n,a,o,s,l,d,c,u,h,g,p,f,m,v,y,S,_,w,I,T,D,C,P,E,M){"use strict";var b=i.prototype.infiniteGeomTypeValues,A=1/d.getPixelsPerMM(),V=y.DefaultGASs.transition,O=y.DefaultGASs.edge.clone().setParameters({colorIndex:d.COLORMAP_INDEX.BLACK});let N=new S;var G=new d.Color(0),x=new d.Vector3(1,0,0),R=new d.Vector3(0,0,1),H=new Map;function k(e,t,i){for(var r=0;r<e.children.length;r++){var n=e.children[r];n._setGAS(t),k(n,t,i)}e.mesh3js&&i&&e.mesh3js.geometry[0].drawingGroups.forEach(function(e){var t=i.triangle;0===e.glType?t=i.point:1===e.glType&&(t=i.line),e.gas=t})}function F(e,t){e.traverse(function(e){if(void 0===e)return!0;if("Mesh3D"===e.getNodeType()){const i=e.mesh3js.geometry[0];i.drawingGroups.forEach(e=>e._geomType=t)}return!1},t)}const L={json_additional:(e,t)=>({properties:JSON.parse(new TextDecoder("utf-8").decode(t)),itemReadAdditional:t.length}),light_deserializer:(e,t)=>new a(t,0),reference_plane(e,t){let i=0,r=0;const n=e[i++],a=e[i++],o=new d.Vector3(e[i++],e[i++],e[i++]),s=new d.Vector3(e[i++],e[i++],e[i++]),l=new d.Vector3(e[i++],e[i++],e[i++]),c=1===t[r++],u=1===t[r++],h=t[r++];let g="";const p=t[r++];if(p>0){const e=[];for(let i=0;i<p;++i)e.push(String.fromCharCode(t[r++]));g=e.join("")}const f=t[r++];let m=null;if(f){m=function(e){const t={},i=e[0];i>>3==0&&(t._wireframeMode=!!(4&i),t._labelVisibility=!!(2&i),t._orientationVisibility=!!(1&i),t._frontColorR=e[1],t._frontColorG=e[2],t._frontColorB=e[3],t._backColorR=e[4],t._backColorG=e[5],t._backColorB=e[6],t._opacity=e[7]);return t}(t.subarray(r,r+=f))}return{properties:{lengthU:n,lengthV:a,origin:o,dirU:s,dirV:l,fixedSize:c,label:g,rendering:m,incLengthBy5PercentIfZoomable:u,rangeScale:h},itemReadGeom:11,itemReadAdditional:r}},canonical_cuboid(e,t){let i=0;return{properties:{corner:[e[i++],e[i++],e[i++]],firstAxis:[e[i++],e[i++],e[i++]],secondAxis:[e[i++],e[i++],e[i++]],thirdLength:e[i++]},itemReadGeom:10}},canonical_sphere(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],radius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:5,itemReadAdditional:1}},canonical_partialsphere(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],firstAxis:[e[i++],e[i++],e[i++]],secondAxis:[e[i++],e[i++],e[i++]],meridianStartAngle:e[i++],meridianEndAngle:e[i++],parallelStartAngle:e[i++],parallelEndAngle:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:14,itemReadAdditional:1}},canonical_cylinder(e,t){let i=0,r=0;return{properties:{bottomCenter:[e[i++],e[i++],e[i++]],topCenter:[e[i++],e[i++],e[i++]],radius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:8,itemReadAdditional:1}},canonical_cone(e,t){let i=0,r=0;return{properties:{bottomCenter:[e[i++],e[i++],e[i++]],topCenter:[e[i++],e[i++],e[i++]],bottomRadius:e[i++],topRadius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:9,itemReadAdditional:1}},canonical_torus(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],planeNormal:[e[i++],e[i++],e[i++]],minorRadius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:8,itemReadAdditional:1}},canonical_partialtorus(e,t){let i=0,r=0;return{properties:{center:[e[i++],e[i++],e[i++]],firstAxis:[e[i++],e[i++],e[i++]],secondAxis:[e[i++],e[i++],e[i++]],minorRadius:e[i++],majorAngle:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:12,itemReadAdditional:1}},canonical_curvedpipe(e,t){let i=0,r=0;const n=e[i++],a=[];for(let t=0;t<3*n;t++)a.push(e[i++]);return{properties:{centers:a,startNormal:[e[i++],e[i++],e[i++]],endNormal:[e[i++],e[i++],e[i++]],radius:e[i++],sag:e[i++],sagMode:t[r++]},itemReadGeom:i,itemReadAdditional:1}}};class U{static create(e,t,i){throw new Error("Not implemented")}static update(e,t,i){throw new Error("Not implemented")}}class B extends U{static create(e,t,i){const{params:r,matrix:n}=B.getParams(t),a=new h;let o=B.getNode(r);return a.addChild(o),a.setMatrix(n),F(a,d.GeomTypeEnum.INFINITE_FACE),e.addChild(a),o.cbChange&&o.cbChange(),{CSINode:a,noZ:!1,alreadyAdded:!0}}static update(e,t,i){const{params:r,matrix:n}=B.getParams(t);let a=e.children[0];if(e.setMatrix(n),a.parents.length>1)e.removeChild(a),a=B.getNode(r),e.addChild(a),F(e,d.GeomTypeEnum.INFINITE_FACE);else{const e=B.refPlaneHash.get(a),t=B.getHash(r);B.refPlaneMap.get(e)===a&&B.refPlaneMap.delete(e),void 0===B.refPlaneMap.get(t)&&B.refPlaneMap.set(t,a),B.refPlaneHash.set(a,t),a.setNewLook(r.newLook),a.setParameters(r)}a.cbChange&&a.cbChange()}static getParams(e){let{lengthU:t,lengthV:i}=e;const{origin:r,dirU:n,dirV:a,fixedSize:o,label:s,incLengthBy5PercentIfZoomable:l,rangeScale:c}=e,u=e.rendering||{};0===t&&0!==i&&(t=i),0===i&&0!==t&&(i=t),0===t&&0===i&&(t=i=35),o&&(t*=1/A,i*=1/A),!o&&l&&(t*=1.1,i*=1.1);const h=(new d.Vector3).crossVectors(n,a),g=new d.Matrix4;g.makeBasis(n,a,h),g.setPosition(r);const p=!u||!u._wireframeMode,f=!!u&&u._orientationVisibility,m=!u||u._labelVisibility,v=u?u._opacity/255:.075,y=u?(new d.Color).setRGB(u._frontColorR/255,u._frontColorG/255,u._frontColorB/255):new d.Color("#005686"),S=u?(new d.Color).setRGB(u._backColorR/255,u._backColorG/255,u._backColorB/255):new d.Color("#a3c8dc");return{params:{name:"refPlane",fill:!0,newLook:p,orientationArrow:f,fixedSize:o,size:new d.Vector2(t,i),planeAttributes:{front:{color:y,opacity:v},back:{color:S,opacity:v}},borderAttributes:{front:{color:y,opacity:.8,width:1},back:{color:S,opacity:.8,width:1}},textAttributes:{front:{data:m?s:"",color:y,opacity:.8,size:14},back:{data:m?s:"",color:S,opacity:.8,size:14}}},matrix:g}}static getHash(e){let t=e.newLook?"NL_":"";e.orientationArrow&&(t+="OA_"),e.fixedSize&&(t+="FS_"),t+=e.size.x.toFixed(3)+"_",t+=e.size.y.toFixed(3)+"_";let i=e.planeAttributes;return i&&(i.front&&(i.front.opacity&&(t+="O_",t+=i.front.opacity.toFixed(3)),i.front.color&&(t+="FC_",t+=i.front.color.getHexString())),i.back&&i.back.color&&(t+="BC_",t+=i.back.color.getHexString())),e.textAttributes&&e.textAttributes.front&&(t+="T_",t+=e.textAttributes.front.data),t}static getNode(e){const t=B.getHash(e);let i=B.refPlaneMap.get(t);return i||(k(i=new v(e),new y.IncrementalGraphicAttributeSet({type:d.GASTypeEnum._SKIN}).usingNREInit(!0),null),i.setPickParent(!0),B.refPlaneMap.set(t,i),B.refPlaneHash.set(i,t)),i}}B.refPlaneMap=new Map,B.refPlaneHash=new WeakMap;class W{static create(e,t,i){const r={lights:[]};i.threeDXLoader.applyLights({json:t.lightJson,chunks:t.lightBuffers,data:t.lightJson,destinationNode:e},!0);const n=0!==r.lights.length;return{CSINode:n?r.lights[0]:null,alreadyAdded:!!n||void 0}}}function z(e){const t=new g(e);return k(t,V,{triangle:V,line:O,point:V}),{CSINode:t,noZ:!1}}class j{static create(e,t,i){return z(u.createCuboidMesh({corner:t.corner,firstAxis:t.firstAxis,secondAxis:t.secondAxis,thirdLength:t.thirdLength},V))}}class X{static create(e,t,i){return z(u.createCustomSphereMesh({parallelStart:-Math.PI/2,parallelEnd:Math.PI/2,meridianStart:0,meridianEnd:2*Math.PI,center:t.center,firstAxis:[t.radius,0,0],secondAxis:[0,1,0],sag:{sag:t.sag,sagMode:t.sagMode}},V))}}class K{static create(e,t,i){return z(u.createCustomSphereMesh({parallelStart:t.parallelStartAngle,parallelEnd:t.parallelEndAngle,meridianStart:t.meridianStartAngle,meridianEnd:t.meridianEndAngle,center:t.center,firstAxis:t.firstAxis,secondAxis:t.secondAxis,sag:{sag:t.sag,sagMode:t.sagMode}},V))}}class ${static create(e,t,i){return z(u.createCustomCylinderMesh({bottomCenter:t.bottomCenter,topCenter:t.topCenter,bottomRadius:t.radius,topRadius:t.radius,sag:{sag:t.sag,sagMode:t.sagMode}},V))}}class J{static create(e,t,i){return z(u.createCustomCylinderMesh({bottomCenter:t.bottomCenter,topCenter:t.topCenter,bottomRadius:t.bottomRadius,topRadius:t.topRadius,sag:{sag:t.sag,sagMode:t.sagMode}},V))}}class Y{static create(e,t,i){return z(u.createTorusMesh({center:t.center,planeNormal:t.planeNormal,minorRadius:t.minorRadius,sag:{sag:t.sag,sagMode:t.sagMode}},V))}}class Z{static create(e,t,i){return z(u.createPartialTorusMesh({center:t.center,firstAxis:t.firstAxis,secondAxis:t.secondAxis,minorRadius:t.minorRadius,majorAngle:t.majorAngle,sag:{sag:t.sag,sagMode:t.sagMode}},V))}}class q{static create(e,t,i){return z(u.createCurvedPipeMesh({centers:t.centers,radius:t.radius,startN:t.startNormal,endN:t.endNormal,sag:{sag:t.sag,sagMode:t.sagMode}},V))}}function Q(e){switch(e){case b.reference_plane:return B;case b.light:return W;case b.canonical_cuboid:return j;case b.canonical_sphere:return X;case b.canonical_partialsphere:return K;case b.canonical_cylinder:return $;case b.canonical_cone:return J;case b.canonical_torus:return Y;case b.canonical_partialtorus:return Z;case b.canonical_curvedpipe:return q;default:return null}}function ee(e){switch(e){case b.reference_plane:return L.reference_plane;case b.light:return L.light_deserializer;case b.canonical_cuboid:return L.canonical_cuboid;case b.canonical_sphere:return L.canonical_sphere;case b.canonical_partialsphere:return L.canonical_partialsphere;case b.canonical_cylinder:return L.canonical_cylinder;case b.canonical_cone:return L.canonical_cone;case b.canonical_torus:return L.canonical_torus;case b.canonical_partialtorus:return L.canonical_partialtorus;case b.canonical_curvedpipe:return L.canonical_curvedpipe;default:return null}}return e.extend({init:function(e,t){this.parameter=e,this._threeDXLoader=t,this._sagInfos={sag:.2,sagMode:1},this._options={threeDXLoader:t}},updateInfiniteGeometry:function(e,t){const i=this.parameter.getInfiniteDrawGroups(),r=this.parameter.getInfiniteGeometryAsFloat32Array(),n=this.parameter.getAdditionalDataAsUint8Array();if(r)for(let e=0;e<i.length;e++){const a=i[e],o=a.getInfiniteGeomType(),s=new Uint32Array(this.parameter.getBuffer(),a.getStart(),3*a.getCount());for(let e=0;e<a.getCount();++e){const i=s[3*e];let a=s[3*e+1],l=s[3*e+2];const d=t.getChildById(i),c=Q(o),u=ee(o);if(!u||!c)continue;const{properties:h,itemReadGeom:g,itemReadAdditional:p}=u(r.subarray(a),n.subarray(l));c.update(d,h)}}},getInfiniteGeometry:function(e,t){var i=this.parameter.getInfiniteDrawGroups(),a=[],s=[],c=this.parameter.getInfiniteGeometryAsFloat32Array();if(!c)return{geometry:[],primitiveIDs:[]};for(var g=this.parameter.getAdditionalDataAsUint8Array(),S=!1,D=0;D<i.length;D++){var P=i[D],O=P.getInfiniteGeomType();if(O===b.path_element){const e=new C(g);if(!e.isValid())continue;const i=e.createIteratorOverPathElements();if(e.haveTransient){const r=e.createIteratorOverPathElementsTransient();let n=!1;for(const e of i){n=!0;let i=e.externalPath;for(const e of r){const r=e.getLastElement(!1,!0);i=i.concat(e.externalPath);const n=E.buildPathElementRepNode3DFromArray(i,t,r);s.push(n),a.push(n.name+n.id);break}}if(!n)for(const e of r){const i=e.getLastElement(!1,!0),r=e.externalPath,n=E.buildPathElementRepNode3DFromArray(r,t,i);s.push(n),a.push(n.name+n.id)}}else for(const e of i){const i=e.getLastElement(!1,!0),r=e.externalPath,n=E.buildPathElementRepNode3DFromArray(r,t,i);s.push(n),a.push(n.name+n.id)}}else for(var H=new Uint32Array(this.parameter.getBuffer(),P.getStart(),3*P.getCount()),F=0;F<P.getCount();++F){var L,U=H[3*F],B=H[3*F+1],W=H[3*F+2],z=!0;switch(O){case b.origin:var j=[c[B++],c[B++],c[B++]];(q=g[W++])>8&&(q=u.PointSymbolEnum.UNKNOWN);var X={positions:j,number:1,color:G};L=new h;var K=l.createPointsNode(X),$=new d.Sphere(new d.Vector3(j[0],j[1],j[2]));$.pixelRadius=1,K.forceBoundingSphere($),K.setPickParent(!0),L.addChild(K),L.traverse(this._CBOnTraversal,d.GeomTypeEnum.FREE_POINT),k(L,V,{triangle:V,line:V,point:V.clone().setParameters({symbolType:q})});break;case b.points:for(var J=c[B++],Y=[],Z=0;Z<3*J;++Z)Y.push(c[B++]);var q;(q=g[W++])>8&&(q=u.PointSymbolEnum.UNKNOWN);X={positions:Y,number:J,color:new d.Color("black")};L=new h,(K=l.createPointsNode(X)).setPickParent(!0),L.addChild(K),L.traverse(this._CBOnTraversal,d.GeomTypeEnum.FREE_POINT),k(L,V,{triangle:V,line:V,point:V.clone().setParameters({symbolType:q})});break;case b.axis:var te=c[B++];te*=1/A;j=new d.Vector3(c[B++],c[B++],c[B++]);var ie=new d.Vector3(c[B++],c[B++],c[B++]),re=c[B++];re*=1/A;var ne=c[B++];(ne<0||ne>.5*Math.PI)&&(ne=.1974),0===ne&&(re=0);var ae="",oe=g[W++];if(oe>0){var se=[];for(Z=0;Z<oe;++Z)se.push(String.fromCharCode(g[W++]));ae=se.join("")}L=new h;var le=Math.abs(ie.z)<.999?R:x,de=(new d.Vector3).crossVectors(le,ie);de.normalize();var ce=(new d.Vector3).crossVectors(ie,de),ue=new d.Matrix4;ue.makeBasis(de,ce,ie),ue.setPosition(j),L.setMatrix(ue);X={name:"arrow",pickable:!0,color:new d.Color("black"),head:re>0?o.types.ARROW:o.types.NONE,arrowLength:te,arrowWidth:1,headLength:re,headWidthToHeightRatio:2*Math.tan(ne),globalSelection:!0};var he=this.getAxisNode(X,{text:ae,length:oe});L.addChild(he.axis),L.addChild(he.label),L.traverse(this._CBOnTraversal,d.GeomTypeEnum.AXIS_SYSTEM),k(L,V,{triangle:V,line:V,point:V});break;case b.infinite_plane:var ge=c[B++];ge*=1/A;j=new d.Vector3(c[B++],c[B++],c[B++]);var pe=new d.Vector3(c[B++],c[B++],c[B++]),fe=new d.Vector3(c[B++],c[B++],c[B++]);if(g[W++]){(L=l.createFixedSizeNode({name:"CSIFixedSizeHalfPlaneNode",ratio:1})).setMatrix((new d.Matrix4).setPosition(j));var me=pe.clone().add(fe).normalize().multiplyScalar(1.4142136*ge/2),ve=j.clone().add(me),ye=ve.clone().add(pe.multiplyScalar(ge/2)),Se=ve.clone().add(fe.multiplyScalar(ge/2)),_e=l.createLineNode({points:[ye,ve,Se],color:new d.Color("black")});_e.setMaterialMode(!1),_e.setPickParent(!0),_e.setMatrix((new d.Matrix4).setPosition(j.negate())),L.addChild(_e),k(L,V,{triangle:V,line:V,point:V})}else{var we=(new d.Vector3).crossVectors(pe,fe);(Ce=new d.Matrix4).makeBasis(pe,fe,we),Ce.setPosition(j);X={name:"refPlane",fill:!0,fixedSize:!0,size:new d.Vector2(ge,ge),planeAttributes:{front:{color:new d.Color("#005686"),opacity:.075},back:{color:new d.Color("#a3c8dc"),opacity:.075}},borderAttributes:{front:{color:new d.Color("#005686"),opacity:.8,width:1},back:{color:new d.Color("#a3c8dc"),opacity:.8,width:1}},textAttributes:{fixedSize:!0,front:{data:"",color:new d.Color("#005686"),opacity:1,size:30},back:{data:"",color:new d.Color("#a3c8dc"),opacity:1,size:30}}};z=!1,k(L=new v(X),new y.IncrementalGraphicAttributeSet({type:d.GASTypeEnum._SKIN}).usingNREInit(!0),null),L.setMatrix(Ce)}L.traverse(this._CBOnTraversal,d.GeomTypeEnum.INFINITE_FACE);break;case b.text:j=new d.Vector3(c[B++],c[B++],c[B++]);var Ie=c[B++],Te=[];for(Z=0;Z<4;++Z)Te.push(g[W++]);ae="";if((ge=function(e){if(Array.isArray(e)){var t=new ArrayBuffer(e.length),i=new DataView(t);return e.forEach(function(e,t){i.setUint8(t,e)}),i}}(Te.reverse()).getUint32(0))>0){for(se=[],Z=0;Z<ge;++Z)se.push(String.fromCharCode(g[W++]));ae=se.join("")}var De=new m("CSIText");De.setPrimitivePicking(!1),De.textMaterial.side=2,De.addText({string:ae,anchor:new d.Vector3(j.x,j.y,0),color:new d.Color(0),size:Ie,lineLength:500,up:new d.Vector3(0,1,0),right:new d.Vector3(1,0,0)}),De.setPickParent(!0),(L=new h).addChild(De),k(L,V,{triangle:V,line:V,point:V});break;case b.path_element:break;case b.annotation_text:const i=JSON.parse(new TextDecoder("utf-8").decode(g)),a=i.anchor;if(!i.box)break;const s=i.point,D=i.box.height,C=i.box.width,P=i.box.descent;let E=D,H=s.x,F=s.y,U=0,Pe=0;void 0!==a&&(a!=d.AnchorPoint.BOTTOM_CENTER&&a!=d.AnchorPoint.BASE_CENTER&&a!=d.AnchorPoint.TOP_CENTER||(U-=.5*C),a!=d.AnchorPoint.BOTTOM_RIGHT&&a!=d.AnchorPoint.BASE_RIGHT&&a!=d.AnchorPoint.TOP_RIGHT||(U-=C),a!=d.AnchorPoint.BOTTOM_LEFT&&a!=d.AnchorPoint.BOTTOM_CENTER&&a!=d.AnchorPoint.BOTTOM_RIGHT||(Pe+=P),a!=d.AnchorPoint.TOP_LEFT&&a!=d.AnchorPoint.TOP_CENTER&&a!=d.AnchorPoint.TOP_RIGHT||(Pe+=P-D)),H+=U,F+=Pe-=P;const Ee=i.font;let Me,be=0,Ae=!0;Ee&&(be=Ee.font),L=new h;const Ve={type:"Spherical"};(Me=Ae?new p({ratio:3.8}):new h).setVisuFilters({gasInheritFilter:(new w).usingColorInherit(null,!1).usingASMColorInherit(null,!1)});let Oe=new f(Ve);Oe.addChild(Me);var Ce=(new d.Matrix4).setPosition({x:s.x,y:s.y,z:0});Oe.setMatrix(Ce),L.addChild(Oe);const Ne=function(e){for(var t=0;t<e.length;++t){var i=e[t];Me.addChild(i),i.setPickParent(!0)}};let Ge=l.createRectangleNode({width:C,height:E,delta:new d.Vector2(U,Pe),fill:!0,color:new u.Color(.5,.5,.2,1)});if(i.contour){const t=i.contour1;if(t&&t.set&&t.rgba){let i=new r(t.set,t.rgba),n=l.createLineNode({points:[new d.Vector3(U,Pe,0),new d.Vector3(U,Pe+E,0),new d.Vector3(U+C,Pe+E,0)]});new T(i,e.clientManager).applyGP(this,n),n.setPickParent(!0),Me.addChild(n)}const n=i.contour2;if(n&&n.set&&n.rgba){let t=new r(n.set,n.rgba),i=l.createLineNode({points:[new d.Vector3(U,Pe,0),new d.Vector3(U+C,Pe,0),new d.Vector3(U+C,Pe+E,0)]});new T(t,e.clientManager).applyGP(this,i),i.setPickParent(!0),Me.addChild(i)}}Ge.setGAS(new y({basic:!0,colorIndex:d.COLORMAP_INDEX.FOREGROUND,inheritance:d.GASEnum.COLOR_INHERITANCE_ON})),Ge.setPickParent(!0),Me.addChild(Ge);const xe=3==be||4==be,Re=2==be||4==be;let He={text:i.text,bbox:[U,U+C,Pe,Pe+E],fontName:"3ds Regular.ttf",color:{r:0,g:0,b:0},colorIndex:d.COLORMAP_INDEX.BACKGROUND,bold:Re,italic:xe,width:C,orientationAngle:0,_noZPriority:4,viewer:e.viewManager.viewer};_.createTexts([He],{},Ne);break;case b.image_pixel:const ke=new n(g,W);if(0===ke.nbImages)break;const Fe=e.viewManager.viewer;if(z=!1,ke.imageGPInfo||ke.freetypeTextGPInfo){const t=new h;L=t;const i=ke.textureJson,r=ke.imagesBuffer;new Promise((e,n)=>{this._threeDXLoader.load({zipped:!1,json:i,chunks:r,destinationNode:t,doneCallback:e,resourcesLibrary:N,forcePowerOfTwo:!1})}).then(()=>{const i=function(i){if(ke.imageGPInfo){let e=Fe&&Fe.currentViewpoint&&Fe.currentViewpoint,r=M.createImagePixel(ke,e,i);t.addChild(r)}if(ke.freetypeTextGPInfo){let r=Fe&&Fe.currentViewpoint&&Fe.currentViewpoint,n=M.createFreeTypeText(ke,r,i,e.isViewpoint2D());t.addChild(n)}k(t,V,{triangle:V,line:V,point:V})};Object.values(N.refImages)[0].values().next().value;if(ke.textureJson&&ke.textureJson.images&&ke.textureJson.images[0]){const e=ke.textureJson.images[0].uid,t=N.refImages[e].values().next().value;if(t instanceof d.Texture){if(t.loadEndStatus!==d.AssetLoadingStatus.READY)return void t.onLoadCallbacks.push(i);i(t)}}})}else if(ke.annotationGPInfo){const t=new I({point:ke.point,anchor:ke.annotationGPInfo.anchor,isDepthTestEnabled:ke.annotationGPInfo.isDepthTestEnabled,height:ke.annotationGPInfo.height,contour:ke.annotationGPInfo.contour,contour1:ke.annotationGPInfo.contour1,contour2:ke.annotationGPInfo.contour2,viewer:e.viewManager.viewer,gasTransition:V});k(t,V,{triangle:V,line:V,point:V}),L=t;const i=ke.textureJson,r=ke.imagesBuffer;new Promise((e,n)=>{this._threeDXLoader.load({zipped:!1,json:i,chunks:r,destinationNode:t,doneCallback:e,resourcesLibrary:N,forcePowerOfTwo:!1})}).then(()=>{let e=[];for(var i=0;i<ke.textureJson.images.length;i++){var r=ke.textureJson.images[i].uid;const t=N.refImages[r].values().next();e.push(t.value)}t.setMipmaps(e)})}break;default:const Le=ee(O),Ue=Q(O),Be=Le(c.subarray(B),g?g.subarray(W):null);B+=Be.itemReadGeom,W+=Be.itemReadAdditional;const We=Ue.create(t,Be.properties,this._options);L=We.CSINode,void 0!==We.noZ&&(z=We.noZ),void 0!==We.alreadyAdded&&(S=We.alreadyAdded)}L&&(z&&L.setNoZ(!0),S||t.addChild(L),s.push(L),L.persistentId=U,a.push(U))}}return{geometry:s,primitiveIDs:a}},_CBOnTraversal:function(e,t){if(void 0===e)return!0;"Mesh3D"===e.getNodeType()&&e.mesh3js.geometry[0].drawingGroups.forEach(function(e){e._geomType=t});return!1},getAxisNode:function(e,t){var i="AL_"+e.arrowLength;i+="HL_"+e.arrowHeadLength,i+="SA_"+e.headWidthToHeightRatio,i+="T_"+t.text;var r=H.get(i);if(!r){var n=new o(e);n.setPickParent(!0);var a=new m("myText",!0,{billboard:!0,billboardAxis:!1,fixedSize:!0,allocSize:t.length});a.setPickParent(!0),a.textMaterial.refreshUniforms=function(e,t,i){this.updatePDSFXUniform("invSize",new d.Vector2(1/e.getViewportSize().width,1/e.getViewportSize().height))},a.addText({string:t.text,anchor:new d.Vector3,offset:new d.Vector3(-5,-5,0),color:new d.Color(16777215),size:20*(d.getDevicePixelRatio()||1),lineLength:500,up:new d.Vector3(0,0,1),right:new d.Vector3(0,1,0)}),a.setPrimitivePicking(!1),a.setRatio(1),a.setFixedSizeCenter(new d.Vector3(0,0,8+e.arrowLength),1),r={axis:n,label:a},H.set(i,r)}return r}})}),define("DS/WebVisuParameters/WebVisuUpdateTransaction",["DS/WebVisuParameters/AbstractWebVisuUpdateTransaction","DS/CSIViewModelWebInterfaces/CSIVMClientOperation","DS/CSIViewModelWebInterfaces/CSIVMClientVisRepViewModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisClippingFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisAnnotation","DS/CSIViewModelWebInterfaces/CSIVMClientVisAnnotationValue","DS/CSIViewModelWebInterfaces/CSIVMClientVisCircularScissorFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisLayerFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisGASInheritFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPolygonOffsetFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisPolygonalScissorFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisCurveClippingFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisZModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisFurtiveFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisDynamicModeFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVisHighlightFilter","DS/CSIViewModelWebInterfaces/CSIVMClientVis2DModeFilter","DS/Visualization/MaterialManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/CGRNode","DS/Visualization/SceneGraphFactory","DS/Visualization/PathElement","DS/VisuLoaders/ThreeDXLoader","DS/WebVisuParameters/BoundingSphereParameterHelper","DS/WebVisuParameters/CustomDataParameterHelper","DS/WebVisuParameters/GeometryParameterHelper","DS/WebVisuParameters/InfiniteGeometryParameterHelper","DS/WebVisuParameters/GraphicPropertyParameterHelper","DS/WebVisuParameters/SceneEnvParameterHelper","DS/WebVisuParameters/SceneEnvParameterItem","DS/Mesh/MeshUtils","DS/Visualization/GraphicAttributeSet","DS/Visualization/ClippingContext","DS/Visualization/RenderStyle","DS/EKEventsWeb/EKEvents","DS/Visualization/Filters/GeomTypeFilter","DS/Visualization/Filters/GASInheritFilter","DS/Visualization/Filters/PolygonOffsetFilter","DS/Visualization/Filters/ZModeFilter","DS/Visualization/Filters/DynamicModeFilter","DS/Visualization/Filters/NoHighlightFilter","DS/Visualization/Filters/FurtiveFilter","DS/Visualization/Filters/LODNodeFilter","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CoreEvents/Events","DS/Visualization/RenderMode","DS/SceneGraphOverrides/GenericOverride","DS/WebVisuParameters/PathElementRepNodeUtils","DS/VisualizationProfiler/VisuProfiler"],function(e,t,r,n,a,o,s,l,d,c,u,h,g,p,f,m,v,y,S,_,w,I,T,D,C,P,E,M,b,A,V,O,N,G,x,R,H,k,F,L,U,B,W,z,j,X,K,$,J,Y,Z,q,Q){"use strict";var ee=null,te=null,ie={volume:S.MaterialUtils.createShinyFaceMaterial({side:S.FrontSide,color:new S.Color(16777215)}),surface:S.MaterialUtils.createShinyFaceMaterial({side:S.DoubleSide,color:new S.Color(16777215)}),line:new S.LineBasicMaterial({color:new S.Color(0)}),point:new S.ParticleBasicMaterial({size:1,color:new S.Color(0),blending:S.NormalBlending,depthTest:!1,sizeAttenuation:!1,transparent:!1})};ie.volume.line=ie.line,ie.volume.point=ie.point,ie.surface.line=ie.line,ie.surface.point=ie.point;var re=new E,ne=new N(null,re),ae=1,oe=2,se=4,le=8,de=32,ce=64,ue=4096,he=8192,ge=32768,pe=131072,fe=262144,me=524288,ve=536870912;const ye=536870912,Se=536870913,_e=536870914,we=[0,0],Ie=[1,1.1],Te=[3,2.2],De=0,Ce=1,Pe=2;class Ee{constructor(e,t){this.prim=e,this.isMixedGP=!0,this.mesh=t.__isProxy__?t.__target__:t}setIdentificationObject(e){this.prim.setIdentificationObject(e)}getIdentificationObject(){return this.prim.getIdentificationObject()}_setGAS(e){q.getProfixiedNodeIfNecessary(this.mesh)._setGAS([this.prim],e)}setMaterial(e){q.getProfixiedNodeIfNecessary(this.mesh).setMaterial([this.prim],e)}}var Me=function(e,t){if(t)for(var i=0;i<e.meshList.length;i++){var r=e.meshList[i]._occurrence.node;if(r&&2===r._bodyDim)return}for(i=0;i<e.drawingGroups.length;i++){var n=e.drawingGroups[i];n.gas,n.material;4===n.glType&&(n.getPrimitivesCount()&&(n.getPrimitiveRep(0).solid=t))}},be=function(e){return e?e.children[0]instanceof w?e.children[0]:e.children[1]:null},Ae=function(e){return e?e.children[0]instanceof w?e.children[1]:e.children[0]:null},Ve=function(e){var t=null;if(e)switch(e.getType()){case 1:case 2:t=new L(-1);break;case 3:t=new L(S.GeomTypeEnum.AXIS_SYSTEM);break;case 4:t=new L(S.GeomTypeEnum.WIRE_EDGE);break;case 5:t=new L(S.GeomTypeEnum.FREE_POINT);break;default:t=new L(-1)}return t};function Oe(e,t){for(let i of e){const e=i.layout.get("uv");if(!e)continue;const r=i.getVertexCount(),n=new DataView(i.buffers[e.bufferId].buffer,e.offset),a=new S.Vector4(0,0,0,1);let o=0;switch(e.type){case"float32":o=1;break;case"float32x2":o=2;break;case"float32x3":o=3;break;case"float32x4":o=4}for(let i=0;i<r;i++){const r=i*e.stride;a.set(0,0,0,1);for(let e=0;e<o;e++)a.setComponent(e,n.getFloat32(r+4*e,!0));a.applyMatrix4(t);for(let e=0;e<o;e++)n.setFloat32(r+4*e,a.getComponent(e),!0)}}}var Ne=function(t,i,r){e.call(this,t,i,r),this._dialogBag=null,this._onTopBag=null,this._furtiveBag=null,this._transientBag=null,this.annotationFilters=[],this.nodesToRemove=[],this.renderingModeToApply=[],this.nodesToOptimize={},this.inverseAction={adds:[],removes:[],overrides:{}},this.commitAction={adds:[],removes:[]}};function Ge(e,t,i){function r(e){e&&e.hasInfiniteGeometry()?i(e):t(e)}const n=e.getGeometricalData(),a=e.getInfiniteGeometricalData();a?(r(n),r(a)):r(n)}(Ne.prototype=Object.create(e.prototype)).getParentNode=function(e){var t=this.getOperatedObject(e);let i=e.getTreeKey();if(!t&&i){switch(i.getView3DType()){case i.View3DType.View3D_Dialog:this._dialogBag||(this._dialogBag=new _,this.view.addChild(this._dialogBag),this._dialogBag.setAsNativeDialog(!0)),t=this._dialogBag;break;case i.View3DType.View3D_OnTop:this._onTopBag||(this._onTopBag=new _,this.view.addChild(this._onTopBag),this._onTopBag.setAsNativeOnTop(!0)),t=this._onTopBag;break;case i.View3DType.View3D_Furtive:this._furtiveBag||(this._furtiveBag=new _,this.view.addChild(this._furtiveBag),this._furtiveBag.setAsNativeFurtive(!0)),t=this._furtiveBag;break;case i.View3DType.View3D_Transient:this._transientBag||(this._transientBag=new _),t=this._transientBag;break;case i.View3DType.View3D_Highlight:case i.View3DType.View3D_MultiColorHighlight:case i.View3DType.View3D_PreHighlight:t=this.view;break;case i.View3DType.View3D_Unknown:case i.View3DType.View3D_Main:default:t=this.view}}return t},Ne.prototype.doOperation=function(e){S._NREGASOnNodeInit=!0;var t=F.Trace.traceStart("techno_webvisu","message_to_scenegraph");Q.begin("WebVisuParameters::WebVisuUpdateTransaction"),this.setDefaultMaterials(this.viewManager.getDefaultMaterials()),te!==this&&(te&&te.executeInverse(),te=this);var i=this,r=e.getType();switch(r){case e.OperationType.RemoveTextureFromCache:var n=e.getTextureUids();if(n.length>0)for(var a=new O(void 0,this.clientManager),o=0;o<n.length;o++)a.removeTextureFromCache(n[o]);break;case e.OperationType.RemoveAll:this.view&&this.view.removeChildren();break;case e.OperationType.AddNode:case e.OperationType.AddBody:case e.OperationType.CreateRoot:var s=null,l=null,d=e.getAttributes(),c=null;let t=null;var u=null,h=(z=this.getParentNode(e))instanceof _,g=z instanceof THREEDS.Nodes.CGRNode,p=h&&!g,f=e.getGeometricalData(),m=e.getInfiniteGeometricalData();const F=e.getVisData();var v=null,y=null;let Q=null,te=null,Fe=null,Le=null,Ue=null,Be=null;if(this.viewManager.viewer._sgOrder&&(Be=e.getIndex()),d){let e=d.getISOData();y=d.get2DTo3DData(),e&&(v=e.getDrawLayer()),c=d.getPositionMatrix(),c=this.unstreamMatrix(c),u=d.getFilters&&d.getFilters(),Q=d.getFixedSizeData(),te=d.getBillboardData(),l={matrix:c||void 0},Fe=Ve(d.getSemanticData()),Ue=(Ue=d.getLodData())&&Ue.getLodData()&&Ue.getLodData().length?Ue.getLodData():null,(Le=d.getVis3DGroupeNodeRepData())&&(Q=Le.getFixedSizeData())}if(r===e.OperationType.AddNode||r===e.OperationType.CreateRoot)if(p)s=Q?this.nodeFromFixedSizeData(Q):y?this.createNodeFromData2Dto3D(y):te?this.nodeFromBillboardData(te):new _,Fe&&s.setVisuFilters({geomTypeFilter:Fe}),Ue&&s.setVisuFilters({LOD:new K(Ue)}),Le&&void 0!==Le.getRenderingMode()&&this.renderingModeToApply.push([s,Le.getRenderingMode()]);else{s=new x.SGBag(l);var I=g?z.internalSceneGraph:z;s.parents.push(I),I.children.push(s)}else if(p)m||f&&f.hasInfiniteGeometry()?s=new _:(!0,(s=new w).setShadow(!0,!0),s.mesh3js.fromLoadedModel=!0,s._occurrences[0].renderable.fromLoadedModel=!0,s.mesh3js.geometry=s._occurrences[0].renderable.geometry);else{s=f&&f.hasInfiniteGeometry()?new x.SGBag(l):new x.SGRep(l);I=g?z.internalSceneGraph:z;s.parents.push(I),I.children.push(s)}if(!s)break;if(e.setCreatedObject(s),Le){t=new S.Matrix4;let e=Le.getTextureMatrix();e&&e.length&&(t.setFromArray(e),s._textureMatrix=t)}var T=null;if(p&&(d&&c&&s.setMatrix(c),T=f?M.getBoundingSphere(f.getBoundingSphere()):null,this.applyBEToBody(s,T),null!=v&&s.setAsNativeIsoBag(v),y&&this.apply2DTo3DData(s,y),null!=Be?z.insertChildAtIndex(s,Be):z.addChild(s),u&&this.setFilters(s,u),f)){if(f.getDimension){s._bodyDim=f.getDimension();for(var C=0;C<s._occurrences.length;C++){(L=s._occurrences[C].renderable)&&(L._bodyDim=s._bodyDim)}}f.getTerminalRepWithPrimitivesWithoutGas()&&s._setNoGASOnPrimitives(!!f.getTerminalRepWithPrimitivesWithoutGas()),f.getUseParentForPixelCulling()&&s._setPixelCullingFromParent(!!f.getUseParentForPixelCulling())}if(F){const t=s.mesh3js.geometry.boundingBox,i=s.mesh3js.geometry.boundingSphere,{geometry:r,ids:n,selection_groups:a,skinningPosture:l}=A.createGeometryBuffersV6(this,F);for(o=0;o<r.length;o++)r[o].layout&&r[o].layout.get("color")&&s.setVertexColors(S.VertexColorType.RGBA);s.mesh3js.geometry=r,s.mesh3js.geometry.boundingBox=t,s.mesh3js.geometry.boundingSphere=i,a.forEach(e=>s.mesh3js.addSelectionGroup(e)),n.forEach((t,i)=>e.addCreatedObjectWithID(t,i)),l&&s.mesh3js.setSkinningTransformations(l);{let e=s,t=e._textureMatrix;for(;!t&&e;)t=e._textureMatrix,e=e.parents[0];Oe(s.mesh3js.geometry,t)}}var P=f?f.getInitializers():null;if(P&&P.length)for(o=0;o<P.length;o++){var E=P[o];if(E instanceof w){if(!E||!E._occurrences[0].renderable){console.warn("Error during initializers of AddBody operation");continue}for(var N=E._occurrences[0].renderable,R=0;R<N.geometry.length;R++){var H=N.geometry[R],k=N.layer?N.layer.getIntervals(H,null,!0):null;for(C=0;C<s._occurrences.length;C++)s._occurrences[C].renderable.addGeometry(H,!T,k);s._bodyDim&&Me(H,3===s._bodyDim)}if(pe=N.selectionGroups)for(C=0;C<s._occurrences.length;C++)for(var L=s._occurrences[C].renderable,U=0;U<pe.length;U++)L.addSelectionGroup(pe[U].clone())}else if(E instanceof _){var B=E.getChildren();for(R=0;R<B.length;R++)s.addChild(B[R])}}if(T)for(C=0;C<s._occurrences.length;C++){var W=s._occurrences[C].renderable;this.applyBEToRenderable(W,s)}this.inverseAction.removes.push({parentNode:z,node:s}),s&&d&&d._PLMData&&this.viewManager.viewer._setNodePLMViewMode(s,d._PLMData,e.getTreeKey().getViewpointUID());break;case e.OperationType.AddCustomNode:s=null;if((j=new b(e.getCustomData(),function(){i.viewManager._publishVisuAnswer(!1)}))&&(s=j.getNode()),!s)break;if(e.setCreatedObject(s),d=e.getAttributes()){c=d.getPositionMatrix();(c=this.unstreamMatrix(c))&&s.setMatrix(c)}var z=this.getParentNode(e);let We=null;this.viewManager.viewer._sgOrder&&(We=e.getIndex()),null!=We?z.insertChildAtIndex(s,We):z.addChild(s),this.inverseAction.removes.push({parentNode:z,node:s});break;case e.OperationType.ModifyCustomNode:s=this.getOperatedObject(e);var j=new b(e.getCustomData(),function(){i.viewManager._publishVisuAnswer(!1)});s&&j.modifyNode(s);break;case e.OperationType.AddExistingNode:case e.OperationType.RemoveExistingNode:if(!(s=this.getOperandObject(e)))break;(g=(z=this.getParentNode(e))instanceof THREEDS.Nodes.CGRNode)&&(z=z.internalSceneGraph);var X=e.getBatchParentObject(),$=e.getBatchParentSharedObject();if(z instanceof x.SGBag){if(!X)break;this.addExistingNode($,X,z,s)}else{if(r===e.OperationType.AddExistingNode){let t=null;this.viewManager.viewer._sgOrder&&(t=e.getIndex()),null!=t?z.insertChildAtIndex(s,t):z.addChild(s)}else this.nodesToRemove.push({parentNode:z,node:s});r===e.OperationType.AddExistingNode?this.inverseAction.removes.push({parentNode:z,node:s}):this.inverseAction.adds.push({parentNode:z,node:s})}break;case e.OperationType.AddExistingCells:var J=this.getOperatedObject(e),Y=(X=e.getBatchParentObject(),e.getBatchParentCellObject()),Z=e._ExistingCells._noContext;if(void 0===e.getOperandSubElements)break;var q=e.getOperandSubElements(),ee=this.addExistingCells(X,Y,Z,J,q);(J instanceof w||J instanceof _)&&ee&&J.show(q);break;case e.OperationType.RemoveExistingCells:J=this.getOperatedObject(e);if(void 0===e.getOperandSubElements)break;q=e.getOperandSubElements();this.removeExistingCells(J,q);break;case e.OperationType.RemoveExistingCell:J=this.getOperatedObject(e);if(void 0===(xe=this.getOperandObject(e)))break;this.removeExistingCell(J,xe);break;case e.OperationType.AddCells:this.AddCells(e);break;case e.OperationType.ApplyGP:var ie=e.getGraphicProperties();if(!ie)break;s=this.getOperatedObject(e),X=e.getBatchParentObject();if(!s&&!X)break;var ae=s&&s instanceof x.SGBag,oe=s&&s instanceof x.SGRep,se=function(e){var t=[];if(e instanceof x.SGRep)return t.push(e),t;for(var i=0;i<e.children.length;i++)for(var r=se(e.children[i]),n=0;n<r.length;n++)t.push(r[n]);return t};if(!s||(oe||ae)){var le=Ae(X),de=be(X),ce=e.getOperatedSubElements(),ue=ce&&ce.length?ce.slice():[];if(ae){var he=se(s);for(o=0;o<he.length;o++)ue.push(he[o])}else oe&&ue.push(s);var ge=function(e,t){for(var i=e.children.length,r=[],n=[],a=0;a<t.length;a++){var o=t[a];if(o instanceof x.SGPrimitiveHelper)n.push(o);else if(o instanceof x.SGRep){var s,l=o.getIdentificationObject().getLocalId();for(s=0;s<i;s++){var d=e.children[s];if(l===d.persistentId){r.push(d);break}}if(s===i)for(var c=0;c<o.getPrimitivesCount();c++){var u=new x.SGPrimitiveHelper;u.set(o,c),n.push(u)}}}return{finiteSubElements:n,infiniteSubElements:r}}(le,ue);a=new O(ie,this.clientManager);ge.finiteSubElements.length>0&&a.applyGP(this,de,ge.finiteSubElements,e.getOperatedGeomTypes&&e.getOperatedGeomTypes()),ge.infiniteSubElements.length>0&&a.applyGP(this,le,ge.infiniteSubElements,e.getOperatedGeomTypes&&e.getOperatedGeomTypes())}else{(a=new O(ie,this.clientManager)).applyGP(this,s,e.getOperatedSubElements(),e.getOperatedGeomTypes&&e.getOperatedGeomTypes())}break;case e.OperationType.ApplyAttributes:if(!((s=this.getOperatedObject(e))&&s instanceof _))break;if(d=e.getAttributes()){let e=d.getISOData();e&&(v=e.getDrawLayer(),s.setAsNativeIsoBag(v)),(c=d.getPositionMatrix())&&(c=this.unstreamMatrix(c))&&s.setMatrix(c),(u=d.getFilters&&d.getFilters())&&this.setFilters(s,u),(y=d.get2DTo3DData())&&this.apply2DTo3DData(s,y),d.getFixedSizeData()&&this.nodeFromFixedSizeData(Q,s);const t=d.getBillboardData();t&&this.nodeFromBillboardData(t,s);let i=Ve(d.getSemanticData());i&&s.setVisuFilters({geomTypeFilter:i});let r=d.getLodData();(r=r&&r.getLodData()&&r.getLodData().length?r.getLodData():null)&&s.setVisuFilters({LOD:new K(r)});let n=d.getVis3DGroupeNodeRepData();if(n){let e=new S.Matrix4,t=n.getTextureMatrix();t&&16===t.length&&e.setFromArray(t),s.traverse(t=>!!(t&&t.mesh3js&&t.mesh3js.geometry)&&(Oe(t.mesh3js.geometry,e),!0)),void 0!==n.getRenderingMode()&&this.renderingModeToApply.push([s,n.getRenderingMode()])}}break;case e.OperationType.AddGroups:if(!(s=this.getOperatedObject(e)))break;if(s instanceof D||s instanceof x.SGRep)(X=e.getBatchParentObject())&&2===X.children.length&&(s=be(X));if(!(s instanceof w))break;f=e.getGeometricalData();var pe=e._Groups;for(o=0;o<pe.length;o++){var fe=pe[o].getGroupedElements(),me=new x.SelectionGroup;for(R=0;R<fe.length;R++)me.addPrimitive(fe[R]);for(R=0;R<s._occurrences.length;R++){(W=s._occurrences[R].renderable).addSelectionGroup(me)}}break;case e.OperationType.ModifyBody:this.ModifyBody(e);break;case e.OperationType.ModifyBatch:if(!((s=this.getOperatedObject(e))&&s instanceof D))break;if(!(f=e.getGeometricalData()))break;var ve={version:Ie};if(Ce=f?f.getGeometries():void 0){var ye=be(s);for(o=0;o<Ce.length;o++){var Se=new A(Ce[o],ve);H=Se.getGeometry(this,!0,ye&&ye._getNoGASOnPrimitives());Se.updateGeometry(ye)}}break;case e.OperationType.AddBatchNode:case e.OperationType.CreateRootBatch:c=null,l=null;if(d=e.getAttributes()){c=d.getPositionMatrix();l={matrix:(c=this.unstreamMatrix(c))||void 0}}var _e=new x.SGBag(l);(s=new THREEDS.Nodes.CGRNode(_e)).productType="3DSyncBatch";f=e.getGeometricalData(),m=e.getInfiniteGeometricalData();var we=!!f&&f.hasGeomDecorations(),Ie=f?f.getVersion():null,Te=new w;Te.setShadow(!0,!0),Te.mesh3js.fromLoadedModel=!0,Te._occurrences[0].renderable.fromLoadedModel=!0,Te.mesh3js.geometry=Te._occurrences[0].renderable.geometry;T=f?M.getBoundingSphere(f.getBoundingSphere()):null;if(this.applyBEToBody(Te,T),f&&f.getDimension)Te._bodyDim=f.getDimension(),(L=Te._occurrences[0].renderable)&&(L._bodyDim=Te._bodyDim);var De=new _;d&&c&&s.setMatrix(c),e.setCreatedObject(s);z=this.getParentNode(e);var Ce=f?f.getGeometries():void 0,Pe=m?m.getGeometries():void 0;ve={version:Ie,hasGeomDecorations:we};if(Ce)for(o=0;o<Ce.length;o++){var Ee=(He=new A(Ce[o],ve).getGeometry(this,!0,Te._getNoGASOnPrimitives())).geometry,Ne=He.primitiveIDs;(W=Te._occurrences[0].renderable).addGeometry(Ee,!1),W.geometry.boundingSphere.copy(Ee.boundingSphere),W.geometry.boundingBox.copy(Ee.boundingBox);var Ge=Ee.drawingGroups;for(R=0;R<Ge.length;R++)for(C=0;C<Ge[R].getPrimitivesCount();C++){var xe;(xe=new x.SGPrimitiveHelper).set(Ge[R],C),e.addCreatedObjectWithID(xe,Ne[R][C])}}if(T){W=Te._occurrences[0].renderable;this.applyBEToRenderable(W,Te)}if(Pe){var Re=function(e){var t=[];if(e instanceof w)t=e.getPrimitives();else if(e instanceof _)for(var i=0;i<e.children.length;i++)for(var r=Re(e.children[i]),n=0;n<r.length;n++)t.push(r[n]);return t};for(o=0;o<Pe.length;o++){var He;for(Ee=(He=new V(Pe[o],re).getInfiniteGeometry(this,De)).geometry,Ne=He.primitiveIDs,R=0;R<Ee.length;R++){for(q=Re(Ee[R]),C=0;C<q.length;C++)q[C]=q[C].sgNode._getSGPrimitive(!0);if(q.length){var ke=new x.SGRep({primitives:q});for(C=0;C<q.length;C++)q[C].rep=ke;e.addCreatedObjectWithID(ke,Ne[R])}else{ke=new x.SGRep({});e.addCreatedObjectWithID(ke,Ne[R])}}}}s.addChild(Te),s.addChild(De);let ze=null;this.viewManager.viewer._sgOrder&&(ze=e.getIndex()),null!=ze?z.insertChildAtIndex(s,ze):z.addChild(s),this.inverseAction.removes.push({parentNode:z,node:s});break;case e.OperationType.ModifySceneEnv:ne.setViewManager(this.viewManager);ne.tryUpdateSceneEnv(new G.SceneEnvData(e.getSceneEnvData()),this.clientManager);break;case e.OperationType.VisuContextUpdate:ne.setViewManager(this.viewManager);ne.tryUpdateSceneEnv(new G.VisuContextData(e.getVisuContext()),this.clientManager);break;case e.OperationType.ModifyBoundingElement:s=this.getOperatedObject(e),T=(f=e.getGeometricalData())?M.getBoundingSphere(f.getBoundingSphere()):null,this.applyBEToBody(s,T)}S._NREGASOnNodeInit=!1,Q.end("WebVisuParameters::WebVisuUpdateTransaction"),t.End()},Ne.prototype.commit=function(){this.executeInverse({commits:!0,overrides:!0,optimize:!0}),te=null,this.executeEnd()},Ne.prototype.abort=function(){this.executeInverse({inverses:!0,overrides:!0}),te=null,this.executeEnd()},Ne.prototype.executeEnd=function(){this.setAnnotationFilters(),this.annotationFilters=[];for(let[e,t]of this.renderingModeToApply)this.addViewModeFilter(e,t,!0);this.renderingModeToApply=[];for(var e=0;e<this.nodesToRemove.length;e++){var t=this.nodesToRemove[e];t.parentNode.removeChild(t.node)}this.nodesToRemove=[],this.optimizeMeshes(),this.viewManager._publishVisuAnswer(!0)},Ne.prototype.executeInverse=function(e){if(e){if(e.inverses){for(var t=0;t<this.inverseAction.adds.length;t++){(o=this.inverseAction.adds[t]).parentNode.addChild(o.node)}for(t=0;t<this.inverseAction.removes.length;t++){var i=(o=this.inverseAction.removes[t]).parentNode,r=o.node;if(i instanceof _)i.removeChild(r);else{var n=i instanceof D?i.internalSceneGraph:i,a=n.children.indexOf(r);-1!==a&&n.children.splice(a,1)}}}if(e.commits)for(t=0;t<this.commitAction.removes.length;t++){var o;(o=this.commitAction.removes[t]).parentNode.removeChild(o.node)}if(e.optimize&&this.optimizeMeshes(),e.overrides){var s=this.getDefaultMaterials();for(var l in this.inverseAction.overrides){var d=this.inverseAction.overrides[l];d.node.setMaterial(s.face),d.node.setPickable(x.PICKTHROUGH),d.node.setNoZ(!1)}}}},Ne.prototype.optimizeMeshes=function(){for(var e in this.nodesToOptimize)this.nodesToOptimize[e];this.nodesToOptimize={}},Ne.prototype.applyBEToBody=function(e,t){e&&t&&(t.isInfinite||t.isEmpty?(e.exludeFromBounding(!0),e._setNoCullingBE(!0)):t.isContain?(e.exludeFromBounding(!1),e._setNoCullingBE(!0)):(e.exludeFromBounding(!1),e._setNoCullingBE(!1)),e.forceBoundingElements(!0,{sphere:t.sphere,box:t.sphere.getBoundingBox()},null))},Ne.prototype.applyBEToRenderable=function(e,t){e&&(e.boundingSphere.copy(t.bSphere),e.boundingBox.copy(t.bBox),e.geometry&&(e.geometry.boundingSphere=e.boundingSphere,e.geometry.boundingBox=e.boundingBox))},Ne.prototype.unstreamMatrix=function(e){if(!e)return null;var t=e.getArray(1);if(!t)return null;var i=new S.Matrix4;return i.set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],0,0,0,1),i},Ne.prototype.getStaticMaterial=function(e){return this.viewManager?this.viewManager.getStaticMaterial(e):null},Ne.prototype.getStaticLook=function(e){return this.viewManager?this.viewManager.getStaticLook(e):null},Ne.prototype.isViewpoint2D=function(){return this.viewManager?this.viewManager.viewer.currentViewpoint.isNative2D():null},Ne.prototype.setDefaultMaterials=function(e){if(e.surface||e.face){var t=e.surface?e.surface:e.face;ie.surface=t}e.volume?ie.volume=e.volume:e.face&&(ie.volume=e.face),e.line&&(ie.line=e.line,ie.surface.line=ie.surface.line,ie.volume.line=ie.volume.line),e.point&&(ie.point=e.point,ie.surface.point=ie.surface.point,ie.volume.point=ie.volume.point)},Ne.prototype.getDefaultMaterials=function(){return ie},Ne.prototype.getMaterialManager=function(){return ee||(ee=new y),ee},Ne.prototype.findAssociatedInfiniteNode3D=function(e,t){var i=e.persistentId;if(i&&i===t)return e;for(var r=e.children,n=0;n<r.length;n++){var a=this.findAssociatedInfiniteNode3D(r[n],t);if(a)return a}return null},Ne.prototype.addExistingNode=function(e,t,i,r){if(i.children.push(r),r.parents.push(i),!e||t===e)return!0;var n=be(e),a=function(e){var t=[];if(e instanceof x.SGRep){for(var i=0;i<e.getPrimitivesCount();i++){var r=new x.SGPrimitiveHelper;r.set(e,i),t.push(r)}return t}for(i=0;i<e.children.length;i++)for(var n=a(e.children[i]),o=0;o<n.length;o++)t.push(n[o]);return t},o=a(r);this.addPrimitivesToMesh3D(o,n,e)&&n.show(o)},Ne.prototype.AddCells=function(e){const t=this.getOperatedObject(e);if(!t)return;this.nodesToOptimize[t.id]=t;const i=this;Ge(e,function(r){const n=r&&r.getGeometries();if(!n)return;let a=t,o=!1;if(!(a instanceof w)){let e=!1;const t=a.getChildren();for(let i=0;i<t.length;i++){let r=t[i];if(r instanceof w){a=q.getProfixiedNodeIfNecessary(r),e=!0;break}}if(!e){const e=new w;e.setShadow(!0,!0),e.setFrustumCulled(!a._getNoCullingBE()),e._setPixelCullingFromParent(!0),e._setNoGASOnPrimitives(a._getNoGASOnPrimitives()),a.addChild(e),e._setGAS(R.DefaultGASs.transition),e._bodyDim=a._bodyDim,a=e}o=!0}const s=3===a._bodyDim,l={version:r.getVersion(),hasGeomDecorations:r.hasGeomDecorations()};for(let t=0;t<n.length;t++){const r=new A(n[t],l).getGeometry(i,s,a._getNoGASOnPrimitives()),d=r.geometry,c=r.primitiveIDs;if(!d)continue;a.__applyOnOccurrences(function(e){const t=e.renderable;if(t.addGeometry(d,!1),r.is2Din3D&&(t.fromLoadedModel=!1),a.bSphere){const e=t.geometry;e.boundingSphere||(e.boundingSphere=new S.Sphere,e.boundingBox=new S.Box3),e.boundingSphere.copy(a.bSphere),e.boundingBox.copy(a.bBox)}});const u=d.drawingGroups;for(let t=0;t<u.length;t++)for(let i=0;i<u[t].getPrimitivesCount();i++){const r=new x.SGPrimitiveHelper;r.set(u[t],i),e.addCreatedObjectWithID(o?new Ee(r,a):r,c[t][i])}}},function(r){const n=r&&r.getGeometries();if(!n)return;for(let r=0;r<n.length;r++){const a=new V(n[r],re).getInfiniteGeometry(i,t),o=a.geometry,s=a.primitiveIDs;for(let t=0;t<o.length;t++)e.addCreatedObjectWithID(o[t],s[t])}})},Ne.prototype.ModifyBody=function(e){const t=this.getOperatedObject(e);if(!t)return;const i=e.getVisDataUpdate(),r=t.mesh3js;if(i&&r){const e=i.getRawbuffers(),t=i.getSkeletonSkinning();if(t){if(t.getIsRemoveSkeleton())A.removeSkeleton(r.geometry);else if(t.getIsRemoveAnimation())r.setSkinningTransformations(null);else if(t.getBoneIdsBufferId()&&t.getBoneWeightsBufferId())A.addSkeleton(r.geometry,t.getBoneIdsBufferId(),t.getBoneWeightsBufferId(),e);else if(t.getBoneMatricesBufferId()){let i=A.createSkinningPosture(r.geometry,t.getBoneMatricesBufferId(),t.getNbBones(),e);r.setSkinningTransformations(i)}}else{const t=A.updateBuffers(r.geometry,e);if(t&&r._skinning)r._skinning.setSkinningMatrices(new Float32Array(t.data)),r.setSkinningTransformations(r._skinning);else for(var n=0;n<r.geometry.length;n++)r.geometry[n].needsUpdate=!0}return}const a=this;Ge(e,function(e){const i=e&&e.getGeometries();if(!i)return;let r=t;if(!(r instanceof w)){let e=!1;for(let t=0;t<r.children.length;t++){let i=r.children[t];if(i instanceof w){r=i,e=!0;break}}if(!e)return}const n={version:e.getVersion()};for(let e=0;e<i.length;e++){const t=new A(i[e],n);t.updateGeometry(r)}},function(e){const i=e&&e.getGeometries();if(!i)return;for(let e=0;e<i.length;e++)new V(i[e],re).updateInfiniteGeometry(a,t)})},Ne.prototype.addExistingCells=function(e,t,i,r,n){if(!r)return!1;if(r instanceof x.SGRep){for(var a=0;a<n.length;a++)if(n[a]instanceof x.SGPrimitiveHelper){var o=n[a]._getSGPrimitive(),s=n[a].index;n[a].container._primitives[s].rep=r,r._primitives.push(o)}if(i)return!0;if(e===t)return!0;r=be(e)}else if(r instanceof x.SGBag){for(a=0;a<n.length;a++){if(n[a]instanceof _&&!i)return console.warn("Primitives can't come from a non batched body"),!1;n[a]instanceof x.SGRep&&(n[a].parents.push(r),r.children.push(n[a]))}if(i)return!0;if(e===t)return!0;var l=Ae(e),d=Ae(t);for(a=0;a<n.length;a++){null!=(c=this.findAssociatedInfiniteNode3D(d,n[a].modelIdentification.getLocalId()))&&l.addChild(c)}return!0}if(!r.getNodeType||"Mesh3D"!==r.getNodeType()){for(a=0;a<n.length;a++)if(n[a])if(n[a]instanceof _)r.addChild(n[a]);else{var c;d=Ae(t);(c=this.findAssociatedInfiniteNode3D(d,n[a].getIdentificationObject().getLocalId()))&&r.addChild(c)}return!1}return this.addPrimitivesToMesh3D(n,r,e)},Ne.prototype.addPrimitivesToMesh3D=function(e,t,i){for(var r=[],n=0;n<e.length;n++)e[n]instanceof x.SGPrimitiveHelper&&r.push(e[n]);if(!r.length)return!1;var a={},o=[];for(n=0;n<r.length;n++){var s=r[n].getGroup(),l=s.geometry;if(l){var d=a[l.id];if(d)d.hasFace=d.hasFace||4===s.glType;else{var c={geometry:l,hasFace:4===s.glType};o.push(c),a[l.id]=c}}}this.nodesToOptimize[t.id]=t;for(var u=t._occurrences[0].renderable,h=[],g=0;g<o.length;g++){var p=!0,f=o[g].geometry;for(n=0;n<u.geometry.length;n++)if(f===u.geometry[n]){p=!1;break}p&&h.push(o[g])}var m=3===t._bodyDim;for(n=0;n<h.length;n++)h[n].hasFace&&Me(h[n].geometry,m);if(h.length)for(var v=0;v<t._occurrences.length;v++){(u=t._occurrences[v].renderable).initLayers(1);for(g=0;g<h.length;g++)u.addGeometry(h[g].geometry,!!i),u._initLayersForGeometry(0,h[g].geometry);i&&(t.bSphere.copy(u.geometry.boundingSphere),t.bBox.copy(u.geometry.boundingBox))}return!0},Ne.prototype.addExistingCell=function(e,t){if(!e)return!1;if(!t)return!1;if(e instanceof _&&t instanceof _)return e.addChild(t),!1;if(!(e instanceof w&&t instanceof x.SGPrimitiveHelper))return!1;var i=t.getGroup().geometry;if(!i)return!1;this.nodesToOptimize[e.id]=e;for(var r=e._occurrences[0].renderable,n=!0,a=0;a<r.geometry.length;a++)if(i===r.geometry[a]){n=!1;break}if(t.getGroup()&&4===t.getGroup().glType){var o=3===e._bodyDim;Me(i,o)}if(n)for(var s=0;s<e._occurrences.length;s++)(r=e._occurrences[s].renderable).initLayers(1),r.addGeometry(i),r._initLayersForGeometry(0,i);return!0},Ne.prototype.removeExistingCells=function(e,t){if(!e)return!1;if("Mesh3D"!==e.getNodeType()){for(let i=0;i<t.length;i++){let r=t[i];r&&(r.isMixedGP&&(e=(r=r.prim).mesh),r instanceof _?parent.removeChild(r):this.removeExistingCell(e,r))}return!1}for(var i=[],r=0;r<t.length;r++)t[r]instanceof x.SGPrimitiveHelper&&i.push(t[r]);if(!i.length)return!1;this.nodesToOptimize[e.id]=e;for(var n=0;n<e._occurrences.length;n++){var a=e._occurrences[n].renderable;a.initLayers(1),a.layer.addPrimitivesToLayers(i,0);for(var o=0;o<i.length;o++)a.removeSelectionGroup(i[o])}return!0},Ne.prototype.removeExistingCell=function(e,t){if(!e)return!1;if(!t)return!1;if(t.isMixedGP&&(t.prim instanceof x.SGPrimitiveHelper&&(e=t.mesh),t=t.prim),e instanceof _&&t instanceof _)return e.removeChild(t),!1;if(!(e instanceof w&&t instanceof x.SGPrimitiveHelper))return!1;this.nodesToOptimize[e.id]=e;for(var i=0;i<e._occurrences.length;i++){var r=e._occurrences[i].renderable;r.initLayers(1),r.layer.addPrimitivesToLayers([t],0),r.removeSelectionGroup(t)}return!0},Ne.prototype.nodeFromFixedSizeData=function(e,t=null){const i=this.viewManager.viewer.currentViewpoint.getMMInSupportUnit(),r=.5*(e.getMinSize()+e.getMaxSize())*i,n=e.getInvariantPoint();return t?(t.setRatio&&t.setRatio(r),t.setInvariantPoint&&t.setInvariantPoint(n)):t=new I({ratio:r,invariantPoint:n}),t},Ne.prototype.nodeFromBillboardData=function(e,t=null){const i=e.getType(),r=i===e.BillboardTypes.Cylindrical?"Cylindrical":(e.BillboardTypes.Spherical,"Spherical");return t?t.setBillboardType&&t.setBillboardType(r):t=new T({type:r,constraintAxis:new S.Vector3(0,1,0)}),t},Ne.prototype.createNodeFromData2Dto3D=function(e){if(e.getStaticMode()){var t=e.getAttachPoint(),i=e.getSphericalMode(),r=new T({type:i?"Spherical":"cylindrical"});if(void 0!==t){var n=(new S.Matrix4).setPosition(t);r.applyMatrix(n)}return r}return new _},Ne.prototype.apply2DTo3DData=function(e,t){var i=t.getAdvancedPriority(),r=t.getZDepthMode();i&&e.setAdvancedPriority(i),r&&e.setZDepthMode(r)},Ne.prototype.setFilters=function(e,t){if(t){this.removeAllFilters(e);for(let i=0;i<t.length;i++){const o=t[i];if(o instanceof n){const t=o.getClippingPlane(),i=t.getFlags(),r=t.getSectionning(),n=t.getPoint(),a=t.getNormal();this.addClippingPlaneFilter(e,n,a,i,r)}else if(o instanceof r){const t=o.getRepViewMode();this.addViewModeFilter(e,t)}else if(o instanceof a)this.annotationFilters.push({filter:o,node:e});else if(o instanceof s){const t=o.getRadius(),i=o._origin,r=o.getDirectionX(),n=o.getDirectionY(),a=o.getCenter(),s=o.getBoundariesVisible(),l=o.getGas();this.addScissorFilter(e,t,a,i,r,n,s,l)}else if(o instanceof l){const t=o.getMode();e.setLayerFilter(o._layers,t)}else if(o instanceof d){const t=new U,i=(o.getColorInheritance()&S.GASEnum.COLOR_INHERITANCE_ON)>0||!((o.getColorInheritance()&S.GASEnum.COLOR_INHERITANCE_OFF)>0)&&null,r=(o.getAsmInheritance()&S.GASEnum.ASMCOLOR_INHERITANCE_ON)>0||!((o.getColorInheritance()&S.GASEnum.COLOR_INHERITANCE_OFF)>0)&&null,n=o.getGas();let a=null;if(n){let e=new _;new O(n,this.clientManager).applyGP(this,e),(a=e._gas)._inheritanceInternal=0}e.setVisuFilters({gasInheritFilter:t.usingColorInherit(a,i).usingASMColorInherit(a,r)})}else if(o instanceof c){let t=1,i=1;switch(o.getPolygonOffsetMode()){case ye:[t,i]=we;break;case Se:[t,i]=Ie;break;case _e:[t,i]=Te;break;default:continue}e.setVisuFilters({polygonOffsetFilter:new B(i,t)})}else if(o instanceof u)this.addPolygonalScissorFilter(e,o);else if(o instanceof h)this.addCurveClippingFilter(e,o);else if(o instanceof g)e.setVisuFilters({zModeFilter:new W(!!o.getZMode())});else if(o instanceof p)o._skipDrawFurtive?e.setVisuFilters({furtiveFilter:new X(!0)}):e.setVisuFilters({furtiveFilter:null});else if(o instanceof f){let t=null;switch(o.getWebDynamicMode()){case De:t=new z(!0,!0);break;case Ce:t=new z(!0,!1);break;case Pe:t=new z(!1,!1)}t&&e.setVisuFilters({dynamicModeFilter:t})}else if(o instanceof m){const t=o.getSkipDrawHighlight()>0,i=o.getSkipDrawPreHighlight()>0;e.setVisuFilters({noHighlightFilter:new j(t,i)})}else if(o instanceof v){let t,i;if(o._plane){const e=(new S.Vector3).copy(o._plane._firstDirection),i=(new S.Vector3).copy(o._plane._secondDirection),r=e.cross(i);t=new S.Plane(r,-r.dot(o._plane._origin))}switch(o._mode){case 1:i=S.PlaneViewMode.NO_DISPLAY;break;case 2:i=S.PlaneViewMode.LOWLIGHT;break;case 3:i=S.PlaneViewMode.NO_PICK;break;case 4:i=S.PlaneViewMode.LOWLIGHT_NO_PICK;break;default:i=S.PlaneViewMode.NORMAL}e.setPvmFilter({mode:i,plane:t})}}}},Ne.prototype.removeAllFilters=function(e){e.setVisuFilters({gasInheritFilter:null,polygonOffsetFilter:null,zModeFilter:null,furtiveFilter:null,dynamicModeFilter:null,noHightlightFilter:null,planeViewModeFilter:null}),this.viewManager.viewer._getCSIOverrideManager().deleteViewModeFilterOverride(e),e.setClippingCylinder(null),e.setScissoringPolyLine(null),this.viewManager.viewer._setOutlineNode(e,!1,null),e.setClippingProfile(null);var t=e.getDirectChildByName("__ScissorBoundary__");t&&e.removeChild(t);var r=e.getOverrideSetManager();if(r){var n=r.getSceneGraphOverrideSetsByPrefix("__3DSyncFilters__");for(i=0;i<n.length;i++)r.removeSceneGraphOverrideSet(n[i])}},Ne.prototype.setAnnotationFilters=function(){if(0!==this.annotationFilters.length)for(var e=0;e<this.annotationFilters.length;e++){var t=this.annotationFilters[e].filter,i=this.annotationFilters[e].node,r=t.getMode(),n=t.getAnnotationPaths();if(n)if(n.length>0)for(var o=0;o<n.length;o++){var s=n[o].getPaths(),l=n[o].getValue(),d=this.truncatePaths(s,i);this.addAnnotationFilter(i,d,l,e,r)}else r!==a.Mode.ModeInvertInvisibilityAndNoPick&&r!==a.Mode.ModeInvertNoPick||this.addAnnotationFilter(i,[],null,e,r)}},Ne.prototype.truncatePath=function(e,t){var i=!1,r=[t];if(void 0!==e&&(e.externalPath.forEach(function(e){i&&r.push(e),e===t&&(i=!0)}),1!==r.length))return e.externalPath=r,e},Ne.prototype.truncatePaths=function(e,t){var i=[];return e.forEach(e=>{if(void 0===e||0===e.getLength())console.warn("[Annotation] A path is not valid");else{e.getElement(0)!==t&&e.concatenatePathes(new P([t]),e),i.push(e)}}),i},Ne.prototype._createOverride=function(e,t,i,r){var n=e.createOverrideSetManager();if(n){var o=null;o=t?"__3DSyncFilters__annot"+i:"__3DSyncFilters__";var s=n.getSceneGraphOverrideSetByName(o);if(!s){var l=null;r&&(r===a.Mode.ModeNormal?l=$.normal:r===a.Mode.ModeForceShow?l=$.forceShow:r===a.Mode.ModeInvertInvisibilityAndNoPick?l=$.invert:r===a.Mode.ModeInvertNoPick&&(l=$.invertPick)),s=n.createSceneGraphOverrideSet({name:o,mode:l,asmInherit:!1,materialModeSensitive:!0,noOpacityOnLines:!0}),n.pushSceneGraphOverrideSet(s)}return t?s.createOverride({pathes:t,depthPriority:!0}):s.createOverride({pathes:[new P([e])],depthPriority:!0})}},Ne.prototype.addAnnotationFilter=function(e,t,i,r,n){var s=this._createOverride(e,t,r,n);if(i){if(i.isRGBOverloaded()){var l=i.GetRGBA(),d=I(i.getRGBInheritance()),c=(new S.Color).setRGB(l.R/255,l.G/255,l.B/255);s.setColorAttribute({value:c,inheritance:d})}if(i.isAlphaOverloaded()){l=i.GetRGBA(),d=I(i.getAlphaInheritance());s.setOpacityAttribute({value:l.A/255,inheritance:d})}if(i.isInvisibilityOverloaded()){var u=!i.isInvisible();s.setVisibility(u)}else n!==a.Mode.ModeForceShow&&n!==a.Mode.ModeInvertInvisibilityAndNoPick||s.setVisibility(!0);if(i.isNoPickOverloaded()){var h=!i.isNotPickable();s.setPickability(h?"PICKABLE":"IGNORED")}if(i.isUncutOverloaded()){i.isUncutEnabled(),d=i.getUncutInheritance()===o.InheritanceMode.ModeForceInherit;var g=new H;s.setClippingContext(g)}if(i.isViewModeOverloaded()){d=I(i.getViewModeInheritance());var p=new k({combineRenderMode:"REPLACE",faceMode:null});p.setRenderMode("Face",i.isViewMeshEnabled()),p.setRenderMode("@Edge",i.isViewEdgeEnabled()),p.setRenderMode("WireEdge",!i.isViewWithoutWiresEnabled()),p.setRenderMode("AxisSystem",!i.isViewWithoutAxisEnabled());var f=!i.isViewWithoutPointsEnabled();p.setRenderMode("BoundaryPoint",f),p.setRenderMode("SharpPoint",f),p.setRenderMode("SmoothPoint",f),p.setRenderMode("Outline",!i.isViewWithoutOutlineEnabled()),s.setRenderStyleAttribute({value:p,inheritance:d})}if(i.isMaterialOverloaded()&&i.getMaterial()){var m=i.getMaterial(),v=m.getMaterialJSON()._json,y=m.getMaterialBuffers(),_=(d=I(i.getMaterialInheritance()),new E),w=[];Array.isArray(y)&&y.length>0&&y.forEach(function(e){w.push({buffer:e.getData()})}),_.load({json:v,zipped:!1,chunks:w,doneCallback:e=>{var t=e.materialApplications[0];s.setMaterialAttribute({value:t,inheritance:d})}})}}function I(e){var t=[Z.InheritMode.INHERIT,Z.InheritMode.FORCE_INHERIT,Z.InheritMode.GRAPH_SCENE];return t[e]||t[0]}},Ne.prototype.addViewModeFilter=function(e,t,i){var r=this.viewManager.viewer._getCSIOverrideManager();if(t){var n=i?r.getVisRenderingModeOverride(e):r.getViewModeFilterOverride(e),a=new k({combineRenderMode:"REPLACE",faceMode:null});a.setFaceMode("COLOR"),a.setMaterialMode(t&le),a.setRenderMode("Face",t&ae),a.setRenderMode("Outline",t&se),t&de&&(a.setRenderMode("Face",!0),a.setRenderMode("Outline",!0),a.setFaceMode("BACKGROUND")),a.setRenderMode("@Edge",t&oe),a.setRenderMode("InternalSmoothEdge",!(t&he)),a.setRenderMode("_HighCurvatureEdge",!(t&he)),t&ve&&a.setRenderMode("InternalSmoothEdge",!1),a.setRenderMode("WireEdge",!(t&pe));var o=!(t&ge);a.setRenderMode("BoundaryPoint",o),a.setRenderMode("SharpPoint",o),a.setRenderMode("SmoothPoint",o),a.setRenderMode("FreePoint",!(t&me));var s=t&ue;a.setHalfVisibleSmoothEdges(s?1:0);var l=t&ce;a.setHiddenEdges(l?1:0);var d=!(t&fe);a.setRenderMode("AxisSystem",d),a.setRenderMode("InfiniteFace",d),n.setRenderStyle(a,!0)}else i?r.deleteVisRenderingModeOverride(e):r.deleteViewModeFilterOverride(e)},Ne.prototype.addClippingPlaneFilter=function(e,t,i,r,n){for(var a=this._createOverride(e),o=[],s=0;s<t.length/3;s++){var l=new S.Plane;l.setFromNormalAndCoplanarPoint(new S.Vector3(i[3*s],i[3*s+1],i[3*s+2]),new S.Vector3(t[3*s],t[3*s+1],t[3*s+2])),o.push(l)}var d=new H;d.setPlanes(o),d._setUseLocalCoordinates();for(s=0;s<o.length;s++)d.setPlaneParams(o[s],{capping:!!(r[s]&xe.fCapping),sectionLines:!!n[s]});a.setClippingContext(d)},Ne.prototype.addScissorFilter=function(e,t,i,r,n,a,o,s){var l=new S.Vector3(r.x,r.y,r.z);if(i&&(l.x+=i.x*n.x+i.y*a.x,l.y+=i.x*n.y+i.y*a.y,l.z+=i.x*n.z+i.y*a.z),e.setClippingCylinder({center:l,axisU:new S.Vector3(t*n.x,t*n.y,t*n.z),axisV:new S.Vector3(t*a.x,t*a.y,t*a.z),clipOutside:!0}),o){var d=C.createCircleNode({radius:t,segments:32,fill:!1});d.name="__ScissorBoundary__";var c=new S.Vector3(n.x,n.y,n.z),u=new S.Vector3(a.x,a.y,a.z);c.normalize(),u.normalize();var h=new S.Vector3;h.crossVectors(c,u);var g=(new S.Matrix4).makeBasis(c,u,h);g.setPosition(l),d.setMatrix(g),e.addChild(d),new O(s,this.clientManager).applyGP(this,d),d.setGAS(new R.IncrementalGraphicAttributeSet({inheritance:S.GASEnum.RGBA_INHERITANCE_ON|S.GASEnum.LINEWIDTH_INHERIT|S.GASEnum.LINETYPE_INHERIT}))}},Ne.prototype.addPolygonalScissorFilter=function(e,t){var i,r=[],n=[],a=t.getNbVertex(),o=t.getVertices();for(i=0;i<a.length;i++)r.push(a[i]);for(i=0;i<o.length;i++)n.push(o[i]);e.setScissoringPolyLine({nbPolygon:t.getNbPolygon(),nbVertices:r,vertices:n,point:new S.Vector3(t.getPoint().x,t.getPoint().y,t.getPoint().z),dirX:new S.Vector3(t.getDirectionX().x,t.getDirectionX().y,t.getDirectionX().z),dirY:new S.Vector3(t.getDirectionY().x,t.getDirectionY().y,t.getDirectionY().z)});var s=null;if(t.getBoundariesVisible()){var l,d,c,u=t.getGas(),h=[],g=0,p=e.clippingContext._scissor.polyLines[0].points3D;for(l=0;l<t.getNbPolygon();l++){for(c=g,d=0;d<r[l]-1;d++)h.push(p[g]),h.push(p[g+1]),g++;h.push(p[g]),h.push(p[c])}var f=(s=C.createLineNode({points:h})).createOverrideSetManager(),m=f.createSceneGraphOverrideSet();f.pushSceneGraphOverrideSet(m);var v=m.createOverride(new P([s])),y=new H([]);y.setUncut(!0),v.setClippingContext(y),s.setNoZ(!0),s.name="outlineNode",new O(u,this.clientManager).applyGP(this,s),s.setGAS(new R.IncrementalGraphicAttributeSet({inheritance:S.GASEnum.RGBA_INHERITANCE_ON|S.GASEnum.LINEWIDTH_INHERIT|S.GASEnum.LINETYPE_INHERIT}))}this.viewManager.viewer._setOutlineNode(e,t.getBoundariesVisible(),s)},Ne.prototype.addCurveClippingFilter=function(e,t){e.setClippingProfile({csiParams:{curveCount:t.getCurveCount(),vertexCounts:t.getVertexCounts(),vertices:t.getVertices(),normals:t.getNormals(),transform:t.getTransformFromVertices()}})};var xe={fCapping:1,fHiddenElements:4,fPriority:8,fNonZParticipants:16,fFurtive:32,fUncutting:64,fDefault:0},Re=null;return J.subscribe({event:"/VISU/AFTER_GRAPHIC_ATTRIBUTE_SET/AFTER_COLOR_MAP_UPDATE"},e=>{var t=e.viewer.getRenderer(),i=Re?Re.get(t):null;if(i){var r,n=R.getLowLightColor(t);for(r=0;r<i.length;r++)i.setColor(n,!1)}}),Ne}),define("DS/WebVisuParameters/WebVisuSceneGraphUpdater",["DS/CSIViewModelWebInterfaces/CSIVMClientDelegateInterface","DS/CSIViewModelWebInterfaces/CSIVMClientTreeKey","DS/WebVisuParameters/WebVisuUpdateTransaction","DS/WebVisuParameters/WebVisuUpdateTransactionHighlight","DS/Visualization/ViewManager","DS/Mesh/MeshUtils","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/PathElement","DS/Visualization/SubElement","DS/Visualization/CGRNode","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionHSO","DS/WebVisuParameters/HighlightTransactionUtils/HighlightTransactionPSO"],function(e,t,i,r,n,a,o,s,l,d,c,u,h){"use strict";var g=function(e){this.viewManager=new n(e)};return(g.prototype=Object.create(e.prototype)).createTransaction=function(e){if(e.getViewType()!=t.prototype.ViewType.View3D)return console.warn("Unsupported view type"),new i(this.viewManager,e,this.getManager&&this.getManager());switch(e.getView3DType()){case t.prototype.View3DType.View3D_Highlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!1,u);case t.prototype.View3DType.View3D_MultiColorHighlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!0,u);case t.prototype.View3DType.View3D_PreHighlight:return new r(this.viewManager,e,this.getManager&&this.getManager(),!1,h);default:return new i(this.viewManager,e,this.getManager&&this.getManager())}},g.prototype.createPathElement=function(e,t){if(!e||!e.length)return null;var i=e[0];if(!(i instanceof o))return null;var r,n=i,c=!1,u=n instanceof THREEDS.Nodes.CGRNode,h=u?n:void 0,g=[n],p=[];if(!t){if(n.parents.length>1){for(var f=0;f<n.parents.length;f++)if(!n.parents[f].notAllowedInPathElement)return null;c=!0}if(!c)for(var m=n.parents[0];m&&!(n=m).notAllowedInPathElement;){if(g.unshift(n),n.parents.length>1){for(f=0;f<n.parents.length;f++)if(!n.parents[f].notAllowedInPathElement)return null;break}m=n.parents[0]}}var v=null;for(r=1;r<e.length&&((n=e[r])instanceof THREEDS.Nodes.CGRNode&&(u=!0,h=n),n instanceof o);r++)g.push(n),n instanceof s&&(v=n._occurrences[0].renderable);for(var y=r;y<e.length;y++){var S=e[y];if(S instanceof a.SGPrimitiveHelper){var _=S;if(v){var w=v.getSelectionGroup(S);w&&(_=w)}p.push(d.getFromSGNode(_))}else u&&(S instanceof a.SGBag||S instanceof a.SGRep)&&p.push(d.getFromSGNode(S))}if(u&&p.length>0){var I=p[p.length-1].sgNode,T=!1;if(I instanceof a.SGRep&&(T=!0),I instanceof a.SGBag){var D=I.children;1===D.length&&D[0]instanceof a.SGRep&&(I=D[0],T=!0)}if(T){var C=function e(t,i){var r,n=t.persistentId;if(n&&n===i&&(r=[t]),!r)for(var a=t.children,o=0;o<a.length;o++){var s=e(a[o],i);if(s){(r=s).unshift(t);break}}return r}(h.children[1]instanceof o?h.children[1]:h.children[0],I.modelIdentification.getLocalId());C&&(g=g.concat(C))}}var P=new l;return P.setFromArray(g,p),P},g.prototype.createIdentifiedObjectsArray=function(e){if(!e)return null;for(var t=[],i=0;i<e.externalPath.length;i++){var r=e.externalPath[i];r&&r.getIdentificationObject()&&t.push(r)}for(i=0;i<e.internalPath.length;i++){var n=e.internalPath[i];n&&n.sgNode&&n.sgNode.getIdentificationObject()&&t.push(n.sgNode)}return t},g});